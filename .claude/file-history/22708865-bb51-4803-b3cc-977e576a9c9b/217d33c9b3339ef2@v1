# VibeLife 支付系统文档

## 📚 文档导航

### 🔧 运营配置
- **[运营配置手册](./运营配置手册.md)** - Stripe 配置完整指南
- **[第三方服务密钥清单](./第三方服务密钥清单.md)** - 快速查找配置项和密钥状态

### 🏗️ 技术实现
- **[Stripe 集成文档](./STRIPE_INTEGRATION.md)** - API 和前端集成详情
- **[双轨制设计](./双轨制设计.md)** - 海外订阅 vs 大陆预付方案
- 后端服务：`apps/api/services/billing/stripe_service.py`
- 前端页面：`apps/web/src/app/payment/`
- API 路由：`apps/web/src/app/api/payment/`

---

## 🎯 快速开始

### 场景 1️⃣：配置 Stripe 基础
1. 注册 [Stripe 账号](https://dashboard.stripe.com/register)
2. 获取 API 密钥（测试 / 生产）
3. 配置环境变量
4. 安装 Stripe Python SDK

### 场景 2️⃣：配置产品和价格
1. 在 Stripe Dashboard 创建产品
2. 为每个产品创建价格（月付 / 年付）
3. 记录 Price ID 到环境变量

### 场景 3️⃣：配置 Webhook
1. 在 Stripe Dashboard 创建 Webhook 端点
2. 配置监听的事件类型
3. 获取 Webhook Secret

---

## ⚡ 当前配置状态

| 服务 | 状态 | 功能影响 |
|------|------|---------|
| Stripe API | ⚠️ 待配置 | 支付功能不可用 |
| Webhook | ⚠️ 待配置 | 无法接收支付回调 |
| 产品/价格 | ⚠️ 待配置 | 无订阅计划 |

**结论：** 支付系统代码已就绪，需要配置 Stripe 账号和环境变量。

---

## 💳 支付方式支持

| 支付方式 | 状态 | 适用地区 |
|---------|------|---------|
| 信用卡/借记卡 | ✅ 支持 | 全球 |
| Alipay | ✅ 支持 | 中国大陆 |
| WeChat Pay | ✅ 支持 | 中国大陆 |
| Apple Pay | 🔧 可启用 | 海外 |
| Google Pay | 🔧 可启用 | 海外 |

---

## 🔐 支付流程概览

### 订阅流程（海外用户）
```
用户选择订阅计划 → 创建 Checkout Session → 跳转 Stripe 托管页面 → 支付成功 → Webhook 通知 → 更新用户权益
```

### 预付流程（大陆用户）
```
用户选择预付套餐 → 创建 PaymentIntent → 前端确认支付 → 支付成功 → Webhook 通知 → 增加用户时长
```

### 管理订阅
```
用户访问账户页面 → 创建 Billing Portal Session → 跳转 Stripe 门户 → 管理/取消订阅
```

---

## 🛡️ 安全特性

- ✅ **服务端金额计算**：防止客户端篡改价格
- ✅ **Webhook 签名验证**：防止伪造回调
- ✅ **幂等处理**：防止重复扣款
- ✅ **PCI DSS 合规**：敏感数据不经过自有服务器

---

## 📞 技术支持

### 配置问题排查
1. 检查 Stripe Dashboard 的事件日志
2. 查看后端日志：`apps/api/logs/`
3. 验证 Webhook 签名配置

### 常见错误
- `No such price`: Price ID 配置错误
- `Invalid signature`: Webhook Secret 不匹配
- `Card declined`: 用户卡片问题

### 文档更新日志
- 2026-01-25: 初始版本创建
