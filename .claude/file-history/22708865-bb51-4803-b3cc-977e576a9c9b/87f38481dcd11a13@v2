# VibeLife 认证系统配置手册

## 概述

VibeLife 认证系统支持多种登录方式：
- ✉️ **邮箱验证码登录**（需要配置 Cloudflare Turnstile + Resend）
- 🔐 **邮箱密码登录**（需要配置 Cloudflare Turnstile）
- 🌐 **Google OAuth**（需要配置 Google Cloud）
- 🍎 **Apple OAuth**（需要配置 Apple Developer）

---

## 第三方服务配置

### 1. Cloudflare Turnstile（防机器人验证）

**用途：** 在用户注册/登录时防止机器人攻击

**配置步骤：**

1. 访问 [Cloudflare Turnstile 控制台](https://dash.cloudflare.com/?to=/:account/turnstile)
2. 点击 **Add Site** 创建新站点
3. 填写配置：
   - **Site Name**: `vibelife-auth`
   - **Domain**: `vibelife.app`（或你的实际域名）
   - **Widget Mode**: 选择 `Managed`（推荐）或 `Invisible`
4. 创建后获取两个密钥：
   - **Site Key**（公开密钥）→ 配置到前端
   - **Secret Key**（私密密钥）→ 配置到后端

**环境变量配置：**

```bash
# 后端配置：apps/api/.env
CF_SECRET_KEY=你的_Secret_Key

# 前端配置：apps/web/.env.local
NEXT_PUBLIC_CF_SITE_KEY=你的_Site_Key
```

**文档参考：** https://developers.cloudflare.com/turnstile/

---

### 2. Resend（邮件验证码服务）

**用途：** 发送邮箱验证码

**配置步骤：**

1. 访问 [Resend 官网](https://resend.com) 注册账号
2. 进入 **API Keys** 页面，创建新的 API Key
3. 复制生成的 API Key（格式：`re_xxxxxxxxxx`）
4. （可选）配置自定义发件域名：
   - 进入 **Domains** 页面
   - 添加你的域名（如 `vibelife.app`）
   - 按照提示添加 DNS 记录验证域名

**环境变量配置：**

```bash
# 后端配置：apps/api/.env
RESEND_API_KEY=re_你的API密钥
RESEND_FROM=noreply@vibelife.app  # 发件邮箱地址
```

**测试发送：**

```bash
# 测试邮件发送是否正常
curl -X POST https://api.resend.com/emails \
  -H "Authorization: Bearer re_你的API密钥" \
  -H "Content-Type: application/json" \
  -d '{
    "from": "noreply@vibelife.app",
    "to": "test@example.com",
    "subject": "测试邮件",
    "html": "<p>这是一封测试邮件</p>"
  }'
```

**免费额度：** 每月 3,000 封邮件（足够初期使用）

**文档参考：** https://resend.com/docs/introduction

---

### 3. Google OAuth（Google 账号登录）

**配置步骤：**

1. 访问 [Google Cloud Console](https://console.cloud.google.com)
2. 创建新项目或选择现有项目
3. 启用 **Google+ API**：
   - 导航到 **APIs & Services** > **Library**
   - 搜索 `Google+ API`
   - 点击 **Enable**
4. 创建 OAuth 凭据：
   - 导航到 **APIs & Services** > **Credentials**
   - 点击 **Create Credentials** > **OAuth client ID**
   - 应用类型选择 **Web application**
   - 配置授权回调 URL：
     - `https://vibelife.app/api/auth/oauth/google/callback`
     - `http://localhost:3000/api/auth/oauth/google/callback`（开发环境）
5. 获取凭据：
   - **Client ID**: `xxxxxxx.apps.googleusercontent.com`
   - **Client Secret**: `GOCSPX-xxxxxxxxx`

**环境变量配置：**

```bash
# 后端配置：apps/api/.env
GOOGLE_CLIENT_ID=你的_Client_ID.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=GOCSPX-你的_Client_Secret
```

**回调 URL 配置：**

确保在 Google Cloud Console 中添加以下回调 URL：
- 生产环境：`https://vibelife.app/api/auth/oauth/google/callback`
- 测试环境：`http://localhost:3000/api/auth/oauth/google/callback`

**文档参考：** https://developers.google.com/identity/protocols/oauth2

---

### 4. Apple Sign In（Apple 账号登录）

**配置步骤（较复杂）：**

#### 4.1 注册 Apple Developer 账号
- 访问 [Apple Developer](https://developer.apple.com)
- 付费加入开发者计划（$99/年）

#### 4.2 创建 App ID
1. 登录 [Apple Developer Console](https://developer.apple.com/account)
2. 进入 **Certificates, Identifiers & Profiles**
3. 点击 **Identifiers** > **+** 创建新的 App ID
4. 选择 **App IDs**，点击 **Continue**
5. 填写信息：
   - **Description**: `VibeLife Web`
   - **Bundle ID**: `com.vibelife.web`（反向域名格式）
6. 勾选 **Sign in with Apple** 能力
7. 点击 **Continue** > **Register**

#### 4.3 创建 Service ID
1. 在 **Identifiers** 页面，点击 **+** 创建新标识符
2. 选择 **Services IDs**，点击 **Continue**
3. 填写信息：
   - **Description**: `VibeLife Sign In`
   - **Identifier**: `com.vibelife.signin`
4. 勾选 **Sign in with Apple**，点击 **Configure**
5. 配置域名和回调 URL：
   - **Domains**: `vibelife.app`
   - **Return URLs**: `https://vibelife.app/api/auth/oauth/apple/callback`
6. 点击 **Continue** > **Register**

#### 4.4 创建私钥
1. 进入 **Keys** 页面，点击 **+**
2. 填写 **Key Name**: `VibeLife Sign In Key`
3. 勾选 **Sign in with Apple**，点击 **Configure**
4. 选择之前创建的 **Primary App ID**
5. 点击 **Continue** > **Register**
6. **下载 .p8 私钥文件**（只能下载一次，务必保存好）
7. 记录 **Key ID**（10 位字符）

#### 4.5 获取 Team ID
1. 在 Apple Developer Console 右上角，点击账号名称
2. 查看 **Membership** 页面
3. 复制 **Team ID**（10 位字符）

**环境变量配置：**

```bash
# 后端配置：apps/api/.env
APPLE_CLIENT_ID=com.vibelife.signin        # Service ID
APPLE_TEAM_ID=你的_Team_ID                 # 10位字符
APPLE_KEY_ID=你的_Key_ID                   # 10位字符
APPLE_PRIVATE_KEY_PATH=/path/to/AuthKey_XXXX.p8  # .p8文件路径
```

**注意事项：**
- .p8 私钥文件务必妥善保管，泄露后需要重新创建
- 回调 URL 必须使用 HTTPS（本地开发除外）
- Service ID 和 App ID 的 Bundle ID 必须不同

**文档参考：** https://developer.apple.com/sign-in-with-apple/get-started/

---

### 5. 微信开放平台（微信扫码登录）

**配置步骤：**

#### 5.1 注册微信开放平台账号
1. 访问 [微信开放平台](https://open.weixin.qq.com/)
2. 注册账号并完成开发者认证（需要企业资质）

#### 5.2 创建网站应用
1. 登录微信开放平台
2. 进入 **管理中心** > **网站应用** > **创建网站应用**
3. 填写应用信息：
   - **应用名称**: `VibeLife`
   - **应用简介**: 应用描述
   - **应用官网**: `https://vibelife.app`
4. 提交审核（通常 1-3 个工作日）

#### 5.3 配置授权回调域名
1. 应用审核通过后，进入应用详情
2. 在 **开发信息** 中配置：
   - **授权回调域**: `vibelife.app`（不要加 https://）

#### 5.4 获取凭据
- **AppID**: `wx...`（应用详情页查看）
- **AppSecret**: `...`（应用详情页查看，只显示一次）

**环境变量配置：**

```bash
# 后端配置：apps/api/.env
WECHAT_APP_ID=wx你的AppID
WECHAT_APP_SECRET=你的AppSecret
```

**回调 URL 配置：**
- 生产环境：`https://vibelife.app/api/auth/wechat/callback`

**注意事项：**
- 微信开放平台需要企业认证（年费 300 元）
- AppSecret 只显示一次，请妥善保存
- 授权回调域需要备案域名

**文档参考：** https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html

---

## 配置检查清单

部署前请确认以下配置已完成：

### 必需配置（邮箱登录）
- [ ] Cloudflare Turnstile Site Key - `NEXT_PUBLIC_CF_SITE_KEY`（前端）
- [ ] Cloudflare Turnstile Secret Key - `CF_SECRET_KEY`（后端）
- [ ] Resend API Key - `RESEND_API_KEY`（后端）
- [ ] Resend 发件邮箱地址 - `RESEND_FROM`（后端）
- [ ] JWT Secret - `VIBELIFE_JWT_SECRET`（已配置）

### 可选配置（Google 登录）
- [ ] Google Client ID - `GOOGLE_CLIENT_ID`（后端）
- [ ] Google Client Secret - `GOOGLE_CLIENT_SECRET`（后端）
- [ ] Google Client ID - `NEXT_PUBLIC_GOOGLE_CLIENT_ID`（前端）
- [ ] Google 回调 URL（Google Cloud Console）

### 可选配置（Apple 登录）
- [ ] Apple Client ID / Service ID - `APPLE_CLIENT_ID`（后端）
- [ ] Apple Team ID - `APPLE_TEAM_ID`（后端）
- [ ] Apple Key ID - `APPLE_KEY_ID`（后端）
- [ ] Apple 私钥文件 - `APPLE_PRIVATE_KEY_PATH`（后端）
- [ ] Apple Client ID - `NEXT_PUBLIC_APPLE_CLIENT_ID`（前端）
- [ ] Apple 回调 URL（Apple Developer Console）

### 可选配置（微信登录）
- [ ] 微信 AppID - `WECHAT_APP_ID`（后端）
- [ ] 微信 AppSecret - `WECHAT_APP_SECRET`（后端）
- [ ] 微信授权回调域（微信开放平台）

---

## 环境变量文件位置

```
vibelife/
├── apps/
│   ├── api/
│   │   └── .env          ← 后端环境变量（Resend, Turnstile, OAuth）
│   └── web/
│       └── .env.local    ← 前端环境变量（Turnstile Site Key）
└── .env                  ← 根目录环境变量（JWT Secret）
```

---

## 测试验证

### 1. 测试邮箱注册
1. 打开 `https://vibelife.app/auth/login`
2. 切换到"Create one"注册模式
3. 输入邮箱和密码（8+字符），完成 Turnstile 验证
4. 点击"Create Account"
5. 检查邮箱是否收到验证码
6. 输入验证码完成注册

### 2. 测试邮箱密码登录
1. 打开 `https://vibelife.app/auth/login`
2. 输入已注册的邮箱和密码
3. 完成 Turnstile 验证
4. 点击"Sign In"完成登录

### 3. 测试 Google OAuth
1. 打开 `https://vibelife.app/auth/login`
2. 点击"Continue with Google"
3. 弹出 Google 授权窗口
4. 授权后应自动登录成功

### 4. 测试 Apple Sign In
1. 打开 `https://vibelife.app/auth/login`
2. 点击"Continue with Apple"
3. 弹出 Apple 授权窗口
4. 授权后应自动登录成功

### 5. 测试微信扫码登录
1. 打开 `https://vibelife.app/auth/login`
2. 点击"Continue with WeChat"
3. 弹出二维码窗口
4. 使用微信扫描二维码
5. 在手机上确认授权
6. 等待页面自动跳转完成登录

---

## 常见问题

### Q1: Turnstile 验证一直失败？
**A:** 检查前端 Site Key 和后端 Secret Key 是否匹配，且域名配置正确。

### Q2: 邮件发送失败？
**A:** 检查 Resend API Key 是否有效，发件邮箱地址是否已验证域名。

### Q3: Google OAuth 回调失败？
**A:** 检查 Google Cloud Console 中的回调 URL 配置是否与实际一致。

### Q4: Apple Sign In 报错 `invalid_client`？
**A:** 检查 Service ID、Team ID、Key ID 是否正确，私钥文件路径是否有效。

### Q5: 同一邮箱能否使用多种登录方式？
**A:** 不能。VibeLife 采用"单一认证方法"策略，每个邮箱只能使用一种登录方式（防止账户冲突）。

---

## 技术支持

如遇配置问题，请检查：
1. 后端日志：`apps/api/logs/`
2. 前端控制台错误信息
3. 第三方服务控制台的调用日志

技术文档：
- 认证 API 文档：`/docs/api/auth.md`
- 后端服务文档：`/apps/api/README.md`
