# VibeLife 认证系统文档

## 📚 文档导航

### 🔧 运营配置
- **[运营配置手册](./运营配置手册.md)** - 第三方服务完整配置指南（含详细步骤）
- **[第三方服务密钥清单](./第三方服务密钥清单.md)** - 快速查找配置项和密钥状态

### 🏗️ 技术实现
- **[邮箱认证详情](./EMAIL_AUTH.md)** - 邮箱登录/注册 API 文档
- **[微信登录详情](./WECHAT_AUTH.md)** - 微信扫码登录 API 文档
- 认证 API 端点：`apps/web/src/app/api/auth/`
- 后端服务逻辑：`apps/api/services/identity/`
- 前端认证组件：`apps/web/src/components/auth/`

---

## 🎯 快速开始

### 场景 1️⃣：配置邮箱登录（必需）
1. 配置 [Cloudflare Turnstile](./运营配置手册.md#1-cloudflare-turnstile防机器人验证)
2. 配置 [Resend 邮件服务](./运营配置手册.md#2-resend邮件验证码服务)
3. 验证 JWT Secret 已设置
4. 测试登录流程

### 场景 2️⃣：启用 Google 登录（可选）
1. 按照 [Google OAuth 配置](./运营配置手册.md#3-google-oauthgoogle-账号登录) 步骤操作
2. 在 Google Cloud Console 添加回调 URL
3. 配置环境变量（后端 + 前端）
4. 测试 OAuth 流程

### 场景 3️⃣：启用 Apple 登录（可选）
1. 按照 [Apple Sign In 配置](./运营配置手册.md#4-apple-sign-inapple-账号登录) 步骤操作
2. 在 Apple Developer Console 创建 Service ID 和私钥
3. 配置环境变量和私钥文件
4. 测试 OAuth 流程

### 场景 4️⃣：启用微信登录（中国区可选）
1. 按照 [微信开放平台配置](./运营配置手册.md#5-微信开放平台微信扫码登录) 步骤操作
2. 创建网站应用并配置回调域名
3. 配置环境变量
4. 测试扫码登录流程

---

## ⚡ 当前配置状态

| 服务 | 状态 | 功能影响 |
|------|------|---------|
| Cloudflare Turnstile | ✅ 已配置 | 防机器人验证 |
| Resend | ✅ 已配置 | 邮箱验证码发送 |
| JWT | ✅ 已配置 | 用户会话管理 |
| Google OAuth | ⚠️ 未配置 | Google 登录不可用 |
| Apple Sign In | ⚠️ 未配置 | Apple 登录不可用 |
| 微信开放平台 | ⚠️ 未配置 | 微信扫码登录不可用 |

**结论：** 当前支持邮箱登录（验证码注册 + 密码登录），第三方登录需额外配置。

---

## 🔐 认证流程概览

### 邮箱注册（验证码）
```
用户输入邮箱+密码 → Turnstile 验证 → 发送验证码（Resend）→ 用户输入验证码 → 创建账户 → 生成 JWT Token → 登录成功
```

### 邮箱密码登录
```
用户输入邮箱+密码 → Turnstile 验证 → 验证密码（bcrypt）→ 生成 JWT Token → 登录成功
```

### OAuth 登录（Google/Apple）
```
用户点击第三方登录 → 弹出授权窗口 → 用户授权 → 获取 ID Token → 验证 Token → 创建/关联账户 → 生成 JWT Token → 登录成功
```

### 微信扫码登录
```
生成二维码 → 用户扫码 → 轮询状态 → 用户确认授权 → 回调处理 → 创建/关联账户 → 生成 JWT Token → 登录成功
```

---

## 🛡️ 安全特性

- ✅ **密码加密**：使用 bcrypt 哈希存储
- ✅ **Token 机制**：Access Token (60分钟) + Refresh Token (30天)
- ✅ **防机器人**：Cloudflare Turnstile 验证
- ✅ **单一认证方法**：防止同一邮箱使用多种登录方式冲突
- ✅ **账户复活**：标记删除的账户可在登录时自动恢复
- ✅ **验证码防护**：最多 5 次尝试，10 分钟过期

---

## 📁 前端组件

| 组件 | 文件 | 用途 |
|-----|------|-----|
| EmailAuthForm | `components/auth/EmailAuthForm.tsx` | 邮箱登录/注册表单 |
| OAuthButtons | `components/auth/OAuthButtons.tsx` | Google/Apple 登录按钮 |
| WechatLoginButton | `components/auth/WechatLoginButton.tsx` | 微信登录按钮 |
| WechatQRModal | `components/auth/WechatQRModal.tsx` | 微信扫码弹窗 |
| AuthLayout | `components/auth/AuthLayout.tsx` | 认证页面布局 |

---

## 📞 技术支持

### 配置问题排查
1. 查看后端日志：`apps/api/logs/`
2. 检查环境变量：`apps/api/.env` 和 `apps/web/.env.local`
3. 验证第三方服务控制台状态

### 常见错误码
- `Bot verification failed`: Turnstile 验证失败
- `Invalid code. N attempts remaining.`: 验证码错误
- `Verification code expired`: 验证码过期
- `Invalid email or password`: 邮箱或密码错误
- `This email is already registered`: 邮箱已注册

### 文档更新日志
- 2026-01-25: 修正 API 端点路径，增加微信登录文档，更新环境变量名称
- 2026-01-24: 初始版本创建
