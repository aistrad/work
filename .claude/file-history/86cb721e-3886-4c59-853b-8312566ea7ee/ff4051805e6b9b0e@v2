"""
Zodiac Skill Tool Handlers - 星座工具执行器

使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
"""
import logging
from datetime import datetime
from typing import Dict, Any

from services.agent.tool_registry import tool_handler, ToolContext

logger = logging.getLogger(__name__)


@tool_handler("collect_zodiac_info")
async def execute_collect_zodiac_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """收集用户出生信息用于星盘分析"""
    fields = [
        {"id": "birthDate", "label": "出生日期", "type": "date", "required": True, "placeholder": ""},
        {"id": "birthTime", "label": "出生时间", "type": "time", "required": True, "placeholder": ""},
        {"id": "birthPlace", "label": "出生地点", "type": "location", "required": True, "placeholder": "城市名"},
    ]

    return {
        "status": "collecting",
        "cardType": "collect_form",
        "formType": "birth_info",
        "title": "请填写出生信息",
        "description": "准确的出生时间和地点对于星盘分析至关重要",
        "fields": fields,
    }


@tool_handler("show_zodiac_chart")
async def execute_show_zodiac_chart(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示星盘"""
    profile = context.profile or {}
    skill_data = context.skill_data or {}
    basic = profile.get("basic", {})

    # 优先从 skill_data 读取完整星盘
    zodiac_data = skill_data.get("zodiac", {})
    if zodiac_data:
        chart = zodiac_data.get("chart", {})
        return {
            "status": "success",
            "cardType": "zodiac_chart",
            "userId": context.user_id,
            "birthInfo": {
                "date": basic.get("birth_date", "1990-05-15"),
                "time": basic.get("birth_time", "08:00"),
                "place": basic.get("birth_place", "Shanghai"),
            },
            "sunSign": chart.get("sun_sign", "金牛座"),
            "moonSign": chart.get("moon_sign", "巨蟹座"),
            "risingSign": chart.get("rising_sign", "处女座"),
            "planets": chart.get("planets", []),
            "aspects": chart.get("aspects", []),
            "dominantElement": chart.get("dominant_element", "土"),
            "dominantModality": chart.get("dominant_modality", "固定"),
        }

    # 回退到 profile.basic（兼容旧数据）
    return {
        "status": "success",
        "cardType": "zodiac_chart",
        "userId": context.user_id,
        "birthInfo": {
            "date": basic.get("birth_date", "1990-05-15"),
            "time": basic.get("birth_time", "08:00"),
            "place": basic.get("birth_place", "Shanghai"),
        },
        "sunSign": basic.get("sun_sign", "金牛座"),
        "moonSign": basic.get("moon_sign", "巨蟹座"),
        "risingSign": basic.get("rising_sign", "处女座"),
        "planets": [
            {"planet": "Sun", "sign": "金牛座", "degree": 12, "house": 9},
            {"planet": "Moon", "sign": "巨蟹座", "degree": 3, "house": 11},
            {"planet": "Mercury", "sign": "金牛座", "degree": 25, "house": 9},
            {"planet": "Venus", "sign": "双子座", "degree": 5, "house": 10},
            {"planet": "Mars", "sign": "狮子座", "degree": 18, "house": 12},
        ],
        "aspects": [],
        "dominantElement": "土",
        "dominantModality": "固定",
    }


@tool_handler("show_zodiac_transit")
async def execute_show_zodiac_transit(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示行运分析"""
    date = args.get("date") or datetime.now().strftime("%Y-%m-%d")

    return {
        "status": "success",
        "cardType": "zodiac_transit",
        "date": date,
        "transits": [
            {
                "planet": "Mercury",
                "sign": "摩羯座",
                "aspect": "合相",
                "natalPlanet": "Sun",
                "influence": "neutral",
                "description": "适合复盘与校对细节，沟通更重逻辑。",
                "startDate": date,
                "endDate": date,
                "isActive": True,
            },
        ],
        "majorEvents": [],
        "overallEnergy": "稳中求进，适合做计划与结构化整理。",
        "advice": "把复杂问题拆成 3 个可执行步骤，先完成最容易的一步。",
    }


@tool_handler("show_zodiac_synastry")
async def execute_show_zodiac_synastry(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示合盘分析"""
    return {
        "status": "success",
        "cardType": "zodiac_synastry",
        "person1": {"name": "你", "sunSign": "金牛座"},
        "person2": {"name": "TA", "sunSign": "狮子座"},
        "overallScore": 82,
        "categories": [
            {"name": "沟通", "score": 78, "description": "表达方式不同但可互补。"},
            {"name": "价值观", "score": 84, "description": "目标一致，节奏需协调。"},
            {"name": "情绪", "score": 80, "description": "需要更多安全感的表达。"},
        ],
        "strengths": ["踏实可靠", "愿意长期投入"],
        "challenges": ["固执时容易僵持", "情绪表达风格不同"],
        "advice": "明确边界与期待，用具体行动替代猜测。",
    }
