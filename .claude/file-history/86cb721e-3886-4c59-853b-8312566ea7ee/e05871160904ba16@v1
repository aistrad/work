#!/usr/bin/env python3
"""
Test Tool Registry - éªŒè¯å·¥å…·æ³¨å†Œç³»ç»Ÿ

æµ‹è¯•å†…å®¹ï¼š
1. å·¥å…·å®šä¹‰ä» YAML åŠ è½½
2. @tool_handler è£…é¥°å™¨æ³¨å†Œ
3. å·¥å…·æ‰§è¡Œ
4. Schema API è¿”å›æ­£ç¡®æ•°æ®
"""
import asyncio
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from services.agent.tool_registry import ToolRegistry, ToolContext, tool_handler
from services.agent.tool_schema import load_skill_tools, GLOBAL_TOOLS


def test_yaml_loading():
    """æµ‹è¯• YAML å·¥å…·å®šä¹‰åŠ è½½"""
    print("\n=== Test 1: YAML Loading ===")

    # æµ‹è¯• bazi skill
    bazi_tools = load_skill_tools("bazi")
    print(f"Bazi tools loaded: {len(bazi_tools)}")
    for tool in bazi_tools:
        print(f"  - {tool.name} ({tool.tool_type}) -> {tool.card_type}")

    # æµ‹è¯• zodiac skill
    zodiac_tools = load_skill_tools("zodiac")
    print(f"Zodiac tools loaded: {len(zodiac_tools)}")

    # æµ‹è¯• tarot skill
    tarot_tools = load_skill_tools("tarot")
    print(f"Tarot tools loaded: {len(tarot_tools)}")

    # å…¨å±€å·¥å…·
    print(f"Global tools: {len(GLOBAL_TOOLS)}")
    for tool in GLOBAL_TOOLS:
        print(f"  - {tool.name} ({tool.tool_type})")

    assert len(bazi_tools) > 0, "Bazi tools should be loaded"
    print("âœ… YAML loading test passed")


def test_handler_registration():
    """æµ‹è¯• @tool_handler è£…é¥°å™¨æ³¨å†Œ"""
    print("\n=== Test 2: Handler Registration ===")

    # æ¸…é™¤ä¹‹å‰çš„æ³¨å†Œ
    ToolRegistry.clear()

    # å¯¼å…¥å…¨å±€å¤„ç†å™¨
    import services.agent.global_handlers  # noqa: F401

    # åˆå§‹åŒ–
    ToolRegistry.initialize()

    print(f"Registered handlers: {len(ToolRegistry._handlers)}")
    for name in sorted(ToolRegistry._handlers.keys()):
        print(f"  - {name}")

    # éªŒè¯å…¨å±€å·¥å…·å¤„ç†å™¨
    assert ToolRegistry.has_handler("search_db"), "search_db handler should be registered"
    assert ToolRegistry.has_handler("ask_user_question"), "ask_user_question handler should be registered"
    assert ToolRegistry.has_handler("show_insight"), "show_insight handler should be registered"

    print("âœ… Handler registration test passed")


async def test_tool_execution():
    """æµ‹è¯•å·¥å…·æ‰§è¡Œ"""
    print("\n=== Test 3: Tool Execution ===")

    # ç¡®ä¿åˆå§‹åŒ–
    ToolRegistry.initialize()

    context = ToolContext(
        user_id="test-user",
        user_tier="free",
        profile={},
        skill_data={},
        skill_id="bazi"
    )

    # æµ‹è¯• show_insight å·¥å…·
    result = await ToolRegistry.execute(
        "show_insight",
        {"insight_type": "career", "title": "æµ‹è¯•æ´å¯Ÿ", "content": "è¿™æ˜¯æµ‹è¯•å†…å®¹"},
        context
    )

    print(f"show_insight result: {result}")
    assert result.get("status") == "success", "show_insight should succeed"
    assert result.get("cardType") == "insight_card", "card_type should be insight_card"

    # æµ‹è¯• ask_user_question å·¥å…·
    result = await ToolRegistry.execute(
        "ask_user_question",
        {"question": "ä½ å¥½å—ï¼Ÿ", "options": ["å¥½", "ä¸å¥½"]},
        context
    )

    print(f"ask_user_question result: {result}")
    assert result.get("status") == "question", "ask_user_question should return question status"

    print("âœ… Tool execution test passed")


def test_tools_for_skill():
    """æµ‹è¯•è·å– Skill å·¥å…·åˆ—è¡¨"""
    print("\n=== Test 4: Get Tools for Skill ===")

    ToolRegistry.initialize()

    # è·å– bazi skill çš„å·¥å…·
    tools = ToolRegistry.get_tools_for_skill("bazi")
    print(f"Bazi skill tools: {len(tools)}")

    tool_names = [t["function"]["name"] for t in tools]
    print(f"Tool names: {tool_names}")

    # åº”è¯¥åŒ…å«å…¨å±€å·¥å…·
    assert "search_db" in tool_names, "Should include global tool search_db"
    assert "show_insight" in tool_names, "Should include global tool show_insight"

    # åº”è¯¥åŒ…å« skill ä¸“å±å·¥å…·ï¼ˆå¦‚æœ YAML ä¸­å®šä¹‰äº†ï¼‰
    # æ³¨æ„ï¼šç”±äº handler æ˜¯é€šè¿‡ import åŠ è½½çš„ï¼Œéœ€è¦ç¡®ä¿ handlers.py è¢«å¯¼å…¥

    print("âœ… Get tools for skill test passed")


def test_schema_api():
    """æµ‹è¯• Schema API è¿”å›"""
    print("\n=== Test 5: Schema API ===")

    ToolRegistry.initialize()

    # è·å–æ‰€æœ‰å·¥å…·çš„ schema
    schema = ToolRegistry.get_schema()
    print(f"Schema version: {schema.get('version')}")
    print(f"Total tools: {len(schema.get('tools', []))}")

    # è·å–ç‰¹å®š skill çš„ schema
    bazi_schema = ToolRegistry.get_schema("bazi")
    print(f"Bazi schema tools: {len(bazi_schema.get('tools', []))}")

    assert schema.get("version") == "6.0", "Version should be 6.0"
    assert len(schema.get("tools", [])) > 0, "Should have tools"

    print("âœ… Schema API test passed")


async def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("=" * 60)
    print("Tool Registry Test Suite")
    print("=" * 60)

    try:
        test_yaml_loading()
        test_handler_registration()
        await test_tool_execution()
        test_tools_for_skill()
        test_schema_api()

        print("\n" + "=" * 60)
        print("ğŸ‰ All tests passed!")
        print("=" * 60)
        return 0

    except AssertionError as e:
        print(f"\nâŒ Test failed: {e}")
        return 1
    except Exception as e:
        print(f"\nâŒ Error: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
