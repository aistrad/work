"""
Tools API - 工具 Schema 端点

提供前端获取工具定义的 API，实现前后端工具 Schema 同步。
"""
import logging
from typing import Optional

from fastapi import APIRouter, Query

from services.agent import ToolRegistry

router = APIRouter(prefix="/tools", tags=["Tools"])
logger = logging.getLogger(__name__)


@router.get("/schema")
async def get_tool_schema(
    skill_id: Optional[str] = Query(None, description="Skill ID (可选，不传则返回所有工具)")
):
    """
    获取工具 Schema

    返回工具定义供前端使用，实现前后端工具定义同步。

    Response:
    ```json
    {
        "version": "6.0",
        "skill_id": "bazi",
        "tools": [
            {
                "name": "show_bazi_chart",
                "description": "展示八字命盘",
                "tool_type": "display",
                "card_type": "bazi_chart",
                "parameters": [...]
            }
        ]
    }
    ```
    """
    return ToolRegistry.get_schema(skill_id)


@router.get("/list")
async def list_tools(
    skill_id: Optional[str] = Query(None, description="Skill ID")
):
    """
    列出所有工具（OpenAI 格式）

    返回 OpenAI 工具格式，可直接用于 LLM 调用。
    """
    if skill_id:
        tools = ToolRegistry.get_tools_for_skill(skill_id)
    else:
        tools = ToolRegistry.get_all_tools()

    return {
        "count": len(tools),
        "tools": tools
    }


@router.get("/card-type/{tool_name}")
async def get_card_type(tool_name: str):
    """
    获取工具对应的卡片类型

    前端可根据 card_type 选择对应的渲染组件。
    """
    card_type = ToolRegistry.get_card_type(tool_name)
    return {
        "tool_name": tool_name,
        "card_type": card_type
    }
