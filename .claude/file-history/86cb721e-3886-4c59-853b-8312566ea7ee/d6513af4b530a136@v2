"""
Bazi Skill Tool Handlers - 八字工具执行器

使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
"""
import logging
from datetime import datetime
from typing import Dict, Any, Optional
from uuid import UUID

from services.agent.tool_registry import tool_handler, ToolContext

logger = logging.getLogger(__name__)


@tool_handler("collect_bazi_info")
async def execute_collect_bazi_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """收集用户出生信息"""
    include_question = args.get("include_question", True)

    fields = [
        {"id": "birthDate", "label": "出生日期", "type": "date", "required": True, "placeholder": ""},
        {"id": "birthTime", "label": "出生时间", "type": "time", "required": True, "placeholder": ""},
        {"id": "birthPlace", "label": "出生地点", "type": "text", "required": False, "placeholder": "城市名（可选）"},
        {"id": "gender", "label": "性别", "type": "select", "required": True, "options": [
            {"value": "male", "label": "男"},
            {"value": "female", "label": "女"},
        ]},
    ]

    if include_question:
        fields.append({
            "id": "question",
            "label": "你想了解什么",
            "type": "textarea",
            "required": False,
            "placeholder": "描述你当前的困惑或想了解的问题..."
        })

    return {
        "status": "collecting",
        "cardType": "collect_form",
        "formType": "birth_info",
        "title": "请填写出生信息",
        "description": "准确的出生时间有助于更精确的命盘分析",
        "fields": fields,
    }


@tool_handler("calculate_bazi")
async def execute_calculate_bazi(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """计算八字命盘"""
    from services.bazi import calculate_bazi

    profile = context.profile or {}
    birth_info = profile.get("birth_info", {})

    # 从 args 或 profile 获取出生信息
    birth_date = (args.get("birth_date") or args.get("birthDate") or
                  birth_info.get("date") or birth_info.get("birth_date"))
    birth_time = (args.get("birth_time") or args.get("birthTime") or
                  birth_info.get("time") or birth_info.get("birth_time") or "12:00")
    gender = args.get("gender") or birth_info.get("gender") or "unknown"

    if not birth_date:
        return {
            "status": "error",
            "error": "缺少出生日期，请先提供出生信息",
            "need_info": "birth",
        }

    try:
        chart = calculate_bazi(birth_date, birth_time, gender)
        return {
            "status": "success",
            "chart": chart,
            "message": "八字命盘计算完成",
        }
    except Exception as e:
        logger.error(f"calculate_bazi failed: {e}")
        return {
            "status": "error",
            "error": f"命盘计算失败: {str(e)}",
        }


@tool_handler("show_bazi_chart")
async def execute_show_bazi_chart(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示八字命盘图"""
    profile = context.profile or {}
    skill_data = context.skill_data or {}
    basic = profile.get("basic", {})

    # 优先从 skill_data 读取完整命盘
    bazi_data = skill_data.get("bazi", {})
    if bazi_data:
        chart = bazi_data.get("chart", {})
        return {
            "status": "success",
            "cardType": "bazi_chart",
            "userId": context.user_id,
            "birthInfo": {
                "date": basic.get("birth_date", "1990-05-15"),
                "time": basic.get("birth_time", "08:00"),
                "gender": basic.get("gender", "unknown"),
            },
            "fourPillars": chart.get("four_pillars", {}),
            "dayMaster": chart.get("day_master", {}),
            "fiveElements": chart.get("five_elements", {}),
            "tenGods": chart.get("ten_gods", []),
            "pattern": chart.get("pattern", {}),
        }

    # 回退到 profile.basic（兼容旧数据）
    return {
        "status": "success",
        "cardType": "bazi_chart",
        "userId": context.user_id,
        "birthInfo": {
            "date": basic.get("birth_date", "1990-05-15"),
            "time": basic.get("birth_time", "08:00"),
            "gender": basic.get("gender", "unknown"),
        },
        "fourPillars": basic.get("four_pillars", {
            "year": {"stem": "庚", "branch": "午"},
            "month": {"stem": "戊", "branch": "子"},
            "day": {"stem": "甲", "branch": "辰"},
            "hour": {"stem": "甲", "branch": "寅"},
        }),
        "dayMaster": {
            "element": basic.get("day_master_element", "wood"),
            "stem": basic.get("day_master", "甲"),
            "description": f"{basic.get('day_master', '甲')}木日主",
        },
        "fiveElements": basic.get("five_elements", {
            "wood": 3, "fire": 2, "earth": 2, "metal": 1, "water": 2
        }),
        "tenGods": basic.get("ten_gods", []),
        "pattern": basic.get("pattern_info", {
            "name": "正印格",
            "description": "偏向学习与积累。"
        }),
    }


@tool_handler("show_bazi_fortune")
async def execute_show_bazi_fortune(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示大运流年分析"""
    from services.fortune import calculate_major_cycles, calculate_annual_fortune

    profile = context.profile or {}
    skill_data = context.skill_data or {}
    basic = profile.get("basic", {})
    year = args.get("year") or datetime.now().year

    # 优先从 skill_data 读取命盘数据
    bazi_data = skill_data.get("bazi", {})
    if bazi_data:
        chart = bazi_data.get("chart", {})
        day_master = chart.get("day_master", {})
        day_master_element = day_master.get("element", "wood")
        birth_year = basic.get("birth_year", 1990)
    else:
        day_master_element = basic.get("day_master_element", "wood")
        birth_year = basic.get("birth_year", 1990)

    gender = basic.get("gender", "unknown")

    try:
        cycles = calculate_major_cycles(
            birth_year=birth_year,
            day_master_element=day_master_element,
            gender=gender,
        )
        annual = calculate_annual_fortune(
            day_master_element=day_master_element,
            year=year,
        )
        return {
            "status": "success",
            "cardType": "bazi_fortune",
            "userId": context.user_id,
            "year": year,
            "cycles": [c.to_dict() for c in cycles],
            "annual": annual.to_dict(),
        }
    except Exception as e:
        logger.error(f"show_bazi_fortune failed: {e}")
        return {
            "status": "error",
            "cardType": "bazi_fortune",
            "userId": context.user_id,
            "year": year,
            "cycles": [],
            "annual": None,
            "error": str(e),
        }


@tool_handler("show_bazi_kline")
async def execute_show_bazi_kline(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示运势 K 线图"""
    from services.fortune import get_kline_service

    start_year = args.get("startYear") or args.get("start_year")
    end_year = args.get("endYear") or args.get("end_year")
    profile = context.profile or {}

    try:
        kline_service = get_kline_service()
        year_range = None
        if start_year and end_year:
            year_range = (int(start_year), int(end_year))

        user_id = None
        if context.user_id and context.user_id != "guest":
            try:
                user_id = UUID(context.user_id)
            except ValueError:
                pass

        kline_data = await kline_service.generate_kline(
            user_id=user_id,
            profile=profile,
            year_range=year_range,
        )

        result = kline_data.to_dict()
        result["status"] = "success"
        result["cardType"] = "bazi_kline"
        return result
    except Exception as e:
        logger.error(f"show_bazi_kline failed: {e}")
        return _get_demo_kline_data()


def _get_demo_kline_data() -> Dict[str, Any]:
    """返回演示 K 线数据"""
    current_year = datetime.now().year
    return {
        "status": "success",
        "cardType": "bazi_kline",
        "years": list(range(current_year - 10, current_year + 20)),
        "values": [60, 65, 55, 70, 75, 68, 72, 80, 75, 70,
                   65, 70, 75, 80, 85, 78, 82, 88, 85, 80,
                   75, 78, 82, 85, 88, 90, 85, 82, 80, 78],
        "currentYear": current_year,
        "keyNodes": [
            {"year": current_year, "label": "当前", "type": "current"},
            {"year": current_year + 5, "label": "转折期", "type": "turning"},
        ],
    }
