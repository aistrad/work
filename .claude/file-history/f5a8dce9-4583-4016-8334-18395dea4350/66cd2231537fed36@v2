#!/usr/bin/env python3
"""
Lifecoach Tools æµ‹è¯•è„šæœ¬

æµ‹è¯• read_lifecoach_state å’Œ write_lifecoach_state å·¥å…·
éªŒè¯æ•°æ®ç»“æ„ä¸ DATA-STRUCTURE.md çš„ä¸€è‡´æ€§
"""

import asyncio
import sys
import os
from uuid import UUID
from datetime import date, datetime

# æ·»åŠ  apps/api åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from stores.unified_profile_repo import UnifiedProfileRepository


# æµ‹è¯•ç”¨æˆ· ID (ä½¿ç”¨å·²æœ‰çš„æµ‹è¯•ç”¨æˆ·)
TEST_USER_ID = UUID("00000000-0000-0000-0000-000000000001")  # æ›¿æ¢ä¸ºçœŸå®æµ‹è¯•ç”¨æˆ·


async def test_read_empty():
    """æµ‹è¯•è¯»å–ç©ºæ•°æ®"""
    print("\n=== æµ‹è¯• 1: è¯»å–ç©ºæ•°æ® ===")

    data = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    if not data:
        print("âœ“ ç©ºç”¨æˆ·è¿”å› Noneï¼ˆç¬¦åˆé¢„æœŸï¼‰")
    else:
        print(f"  ç°æœ‰æ•°æ®: {data.content.keys() if data.content else 'ç©º'}")

    return True


async def test_write_north_star():
    """æµ‹è¯•å†™å…¥åŒ—ææ˜Ÿæ„¿æ™¯"""
    print("\n=== æµ‹è¯• 2: å†™å…¥åŒ—ææ˜Ÿæ„¿æ™¯ ===")

    # è¯»å–ç°æœ‰æ•°æ®
    existing = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    content = existing.content if existing else {}

    # å†™å…¥åŒ—ææ˜Ÿæ•°æ®ï¼ˆç¬¦åˆ DATA-STRUCTURE.mdï¼‰
    north_star = {
        "vision_scene": "ä¸‰å¹´åï¼Œæˆ‘ç«™åœ¨è‡ªå·±åˆ›åŠçš„å…¬å¸åŠå…¬å®¤é‡Œï¼Œå›¢é˜Ÿå……æ»¡æ´»åŠ›...",
        "vision_timeframe": "3å¹´",
        "anti_vision": "å¦‚æœç»§ç»­ç°åœ¨çš„æ¨¡å¼ï¼Œä¸‰å¹´åæˆ‘å¯èƒ½è¿˜åœ¨æŠ±æ€¨åŒæ ·çš„é—®é¢˜...",
        "mission": "å¸®åŠ©äººä»¬æ‰¾åˆ°äººç”Ÿæ–¹å‘",
        "principles": ["ä¸“æ³¨", "è¯šå®", "è¡ŒåŠ¨"],
        "identity_statement": "æˆ‘æ˜¯é‚£ç§æŠŠæƒ³æ³•å˜æˆç°å®çš„äºº"
    }

    content["north_star"] = north_star
    content["_last_updated"] = datetime.utcnow().isoformat()

    result = await UnifiedProfileRepository.write_life_context_path(
        TEST_USER_ID,
        "lifecoach",
        content
    )

    print(f"âœ“ åŒ—ææ˜Ÿå·²å†™å…¥ (version: {result.version})")

    # éªŒè¯
    verify = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    if verify and verify.content.get("north_star", {}).get("vision_scene"):
        print("âœ“ éªŒè¯æˆåŠŸ: åŒ—ææ˜Ÿæ•°æ®å­˜åœ¨")
    else:
        print("âœ— éªŒè¯å¤±è´¥: åŒ—ææ˜Ÿæ•°æ®ä¸¢å¤±")
        return False

    return True


async def test_write_goals():
    """æµ‹è¯•å†™å…¥æ ¸å¿ƒç›®æ ‡"""
    print("\n=== æµ‹è¯• 3: å†™å…¥æ ¸å¿ƒç›®æ ‡ (goals[]) ===")

    existing = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    content = existing.content if existing else {}

    # å†™å…¥æ ¸å¿ƒç›®æ ‡ï¼ˆç¬¦åˆ DATA-STRUCTURE.mdï¼‰
    goals = [
        {
            "id": "goal_career",
            "name": "èŒä¸šå‘å±•",
            "icon": "ğŸ’¼",
            "year_target": "æ™‹å‡ä¸ºæŠ€æœ¯æ€»ç›‘",
            "progress": 30,
            "focus_areas": ["æŠ€æœ¯æ·±åº¦", "å›¢é˜Ÿç®¡ç†", "ä¸šåŠ¡ç†è§£"]
        },
        {
            "id": "goal_health",
            "name": "èº«ä½“å¥åº·",
            "icon": "ğŸ’ª",
            "year_target": "æ¯å‘¨è¿åŠ¨5æ¬¡ï¼Œå‡é‡10kg",
            "progress": 20,
            "focus_areas": ["è§„å¾‹è¿åŠ¨", "å¥åº·é¥®é£Ÿ", "å……è¶³ç¡çœ "]
        },
        {
            "id": "goal_family",
            "name": "å®¶åº­å…³ç³»",
            "icon": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§",
            "year_target": "æ¯å‘¨é«˜è´¨é‡å®¶åº­æ—¶é—´8å°æ—¶",
            "progress": 40,
            "focus_areas": ["äº²å­æ´»åŠ¨", "å®¶åº­æ—…è¡Œ", "æ²Ÿé€šè´¨é‡"]
        }
    ]

    content["goals"] = goals
    content["_last_updated"] = datetime.utcnow().isoformat()

    result = await UnifiedProfileRepository.write_life_context_path(
        TEST_USER_ID,
        "lifecoach",
        content
    )

    print(f"âœ“ æ ¸å¿ƒç›®æ ‡å·²å†™å…¥ (version: {result.version})")
    print(f"  ç›®æ ‡æ•°: {len(goals)}")

    return True


async def test_write_current_nested():
    """æµ‹è¯•å†™å…¥åµŒå¥—çš„ current ç»“æ„"""
    print("\n=== æµ‹è¯• 4: å†™å…¥åµŒå¥—çš„ current ç»“æ„ ===")

    existing = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    content = existing.content if existing else {}

    today = date.today().isoformat()

    # å†™å…¥ currentï¼ˆç¬¦åˆ DATA-STRUCTURE.md çš„åµŒå¥—ç»“æ„ï¼‰
    current = {
        "month": {
            "project": "å®Œæˆ Q1 äº§å“å‘å¸ƒ",
            "deadline": "2026-02-28",
            "progress": 60
        },
        "week": {
            "week_start": "2026-01-13",
            "theme": "å†²åˆºä¸Šçº¿",
            "energy_budget": 8,
            "rocks": [
                {
                    "id": "rock1",
                    "title": "å®Œæˆæ ¸å¿ƒåŠŸèƒ½å¼€å‘",
                    "goal_id": "goal_career",
                    "status": "in_progress",
                    "progress": 70
                },
                {
                    "id": "rock2",
                    "title": "æ¯å¤©è¿åŠ¨30åˆ†é’Ÿ",
                    "goal_id": "goal_health",
                    "status": "pending",
                    "progress": 40
                },
                {
                    "id": "rock3",
                    "title": "å‘¨æœ«å¸¦å­©å­å»åšç‰©é¦†",
                    "goal_id": "goal_family",
                    "status": "pending",
                    "progress": 0
                }
            ]
        },
        "daily": {
            "date": today,
            "energy": 7,
            "intention": "ä»Šå¤©ä¸“æ³¨äºæ ¸å¿ƒåŠŸèƒ½çš„æ”¶å°¾",
            "levers": [
                {"id": "lever1", "title": "å®ŒæˆAPIæ¥å£", "rock_id": "rock1", "status": "completed", "time_block": "æ—©æ™¨"},
                {"id": "lever2", "title": "åˆä¼‘è·‘æ­¥20åˆ†é’Ÿ", "rock_id": "rock2", "status": "pending", "time_block": "ä¸‹åˆ"},
                {"id": "lever3", "title": "ä¸å­©å­è§†é¢‘é€šè¯", "rock_id": "rock3", "status": "pending", "time_block": "æ™šä¸Š"}
            ]
        }
    }

    content["current"] = current
    content["_last_updated"] = datetime.utcnow().isoformat()

    result = await UnifiedProfileRepository.write_life_context_path(
        TEST_USER_ID,
        "lifecoach",
        content
    )

    print(f"âœ“ current ç»“æ„å·²å†™å…¥ (version: {result.version})")
    print(f"  - month.project: {current['month']['project']}")
    print(f"  - week.rocks: {len(current['week']['rocks'])} ä¸ª")
    print(f"  - daily.levers: {len(current['daily']['levers'])} ä¸ª")

    return True


async def test_write_progress():
    """æµ‹è¯•å†™å…¥è¿›åº¦æ•°æ®"""
    print("\n=== æµ‹è¯• 5: å†™å…¥è¿›åº¦æ•°æ® ===")

    existing = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    content = existing.content if existing else {}

    # å†™å…¥ progressï¼ˆç¬¦åˆ DATA-STRUCTURE.mdï¼‰
    progress = {
        "current_streak": 7,
        "longest_streak": 21,
        "total_checkins": 45,
        "last_checkin_date": date.today().isoformat(),
        "checkin_history": [
            {"date": "2026-01-19", "energy": 7},
            {"date": "2026-01-18", "energy": 6},
            {"date": "2026-01-17", "energy": 8}
        ]
    }

    content["progress"] = progress
    content["_last_updated"] = datetime.utcnow().isoformat()

    result = await UnifiedProfileRepository.write_life_context_path(
        TEST_USER_ID,
        "lifecoach",
        content
    )

    print(f"âœ“ è¿›åº¦å·²å†™å…¥ (version: {result.version})")
    print(f"  - current_streak: {progress['current_streak']}")
    print(f"  - total_checkins: {progress['total_checkins']}")

    return True


async def test_write_journal():
    """æµ‹è¯•å†™å…¥æ—¥å¿—ï¼ˆæ•°ç»„ç»“æ„ï¼‰"""
    print("\n=== æµ‹è¯• 6: å†™å…¥æ—¥å¿— (journal[]) ===")

    existing = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    content = existing.content if existing else {}

    # å†™å…¥ journalï¼ˆæ•°ç»„ç»“æ„ï¼Œç¬¦åˆ DATA-STRUCTURE.mdï¼‰
    journal = [
        {
            "date": "2026-01-19",
            "type": "daily",
            "mood": 7,
            "energy": 7,
            "rocks_completed": 2,
            "rocks_total": 3,
            "wins": ["å®Œæˆäº†æ ¸å¿ƒåŠŸèƒ½", "åšæŒè¿åŠ¨"],
            "struggles": ["ä¸‹åˆæ³¨æ„åŠ›ä¸é›†ä¸­"],
            "insight": "å‘ç°ä¸‹åˆå–å’–å•¡åæ•ˆç‡æ›´é«˜",
            "gratitude": "æ„Ÿè°¢å›¢é˜Ÿçš„æ”¯æŒ"
        },
        {
            "date": "2026-01-18",
            "type": "daily",
            "mood": 6,
            "energy": 6,
            "wins": ["å®Œæˆäº†æ–‡æ¡£"],
            "struggles": ["ä¼šè®®å¤ªå¤š"]
        }
    ]

    content["journal"] = journal
    content["_last_updated"] = datetime.utcnow().isoformat()

    result = await UnifiedProfileRepository.write_life_context_path(
        TEST_USER_ID,
        "lifecoach",
        content
    )

    print(f"âœ“ æ—¥å¿—å·²å†™å…¥ (version: {result.version})")
    print(f"  - æ¡ç›®æ•°: {len(journal)}")

    return True


async def test_read_full():
    """æµ‹è¯•è¯»å–å®Œæ•´æ•°æ®"""
    print("\n=== æµ‹è¯• 7: è¯»å–å®Œæ•´æ•°æ® ===")

    data = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    if not data:
        print("âœ— è¯»å–å¤±è´¥: æ— æ•°æ®")
        return False

    content = data.content
    print(f"âœ“ æ•°æ®è¯»å–æˆåŠŸ (version: {data.version})")
    print(f"  sections: {list(content.keys())}")

    # éªŒè¯åµŒå¥—ç»“æ„
    if "current" in content:
        current = content["current"]
        print(f"  current å­ç»“æ„:")
        print(f"    - month: {'âœ“' if 'month' in current else 'âœ—'}")
        print(f"    - week: {'âœ“' if 'week' in current else 'âœ—'}")
        print(f"    - daily: {'âœ“' if 'daily' in current else 'âœ—'}")

        if "week" in current and "rocks" in current["week"]:
            print(f"    - week.rocks æ•°é‡: {len(current['week']['rocks'])}")
        if "daily" in current and "levers" in current["daily"]:
            print(f"    - daily.levers æ•°é‡: {len(current['daily']['levers'])}")

    # éªŒè¯ journal æ˜¯æ•°ç»„
    if "journal" in content:
        journal = content["journal"]
        if isinstance(journal, list):
            print(f"  journal: âœ“ æ•°ç»„ç»“æ„ ({len(journal)} æ¡)")
        else:
            print(f"  journal: âœ— ä¸æ˜¯æ•°ç»„ç»“æ„")
            return False

    return True


async def test_deep_merge():
    """æµ‹è¯•æ·±åº¦åˆå¹¶åŠŸèƒ½"""
    print("\n=== æµ‹è¯• 8: æ·±åº¦åˆå¹¶ current.daily ===")

    # å…ˆè¯»å–ç°æœ‰æ•°æ®
    existing = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    content = existing.content if existing else {}

    # åªæ›´æ–° current.dailyï¼Œä¸å½±å“ current.week å’Œ current.month
    original_week = content.get("current", {}).get("week", {}).copy() if content.get("current") else {}

    # æ¨¡æ‹Ÿ handlers.py çš„ deep_merge
    def deep_merge(base, update):
        result = base.copy()
        for key, value in update.items():
            if key in result and isinstance(result[key], dict) and isinstance(value, dict):
                result[key] = deep_merge(result[key], value)
            elif value is not None:
                result[key] = value
        return result

    # æ›´æ–° daily
    new_daily = {
        "daily": {
            "energy": 9,
            "intention": "æ›´æ–°åçš„æ„å›¾"
        }
    }

    if "current" in content:
        content["current"] = deep_merge(content["current"], new_daily)
    else:
        content["current"] = new_daily

    content["_last_updated"] = datetime.utcnow().isoformat()

    result = await UnifiedProfileRepository.write_life_context_path(
        TEST_USER_ID,
        "lifecoach",
        content
    )

    # éªŒè¯ week æ²¡æœ‰è¢«è¦†ç›–
    verify = await UnifiedProfileRepository.read_life_context_path(
        TEST_USER_ID,
        "lifecoach"
    )

    verify_week = verify.content.get("current", {}).get("week", {})

    if original_week and verify_week.get("rocks"):
        print(f"âœ“ æ·±åº¦åˆå¹¶æˆåŠŸ: week.rocks ä¿ç•™ ({len(verify_week['rocks'])} ä¸ª)")
        print(f"  daily.energy æ›´æ–°ä¸º: {verify.content['current']['daily']['energy']}")
    else:
        if not original_week:
            print("  æ³¨æ„: åŸå§‹ week æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡éªŒè¯")
        else:
            print("âœ— æ·±åº¦åˆå¹¶å¤±è´¥: week.rocks ä¸¢å¤±")
            return False

    return True


async def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("=" * 60)
    print("Lifecoach Tools æµ‹è¯•")
    print("=" * 60)

    tests = [
        ("è¯»å–ç©ºæ•°æ®", test_read_empty),
        ("å†™å…¥åŒ—ææ˜Ÿæ„¿æ™¯", test_write_north_star),
        ("å†™å…¥æ ¸å¿ƒç›®æ ‡", test_write_goals),
        ("å†™å…¥åµŒå¥— current", test_write_current_nested),
        ("å†™å…¥è¿›åº¦", test_write_progress),
        ("å†™å…¥æ—¥å¿—", test_write_journal),
        ("è¯»å–å®Œæ•´æ•°æ®", test_read_full),
        ("æ·±åº¦åˆå¹¶", test_deep_merge),
    ]

    passed = 0
    failed = 0

    for name, test_func in tests:
        try:
            result = await test_func()
            if result:
                passed += 1
            else:
                failed += 1
        except Exception as e:
            print(f"âœ— {name} å¼‚å¸¸: {e}")
            failed += 1

    print("\n" + "=" * 60)
    print(f"æµ‹è¯•ç»“æœ: {passed} é€šè¿‡, {failed} å¤±è´¥")
    print("=" * 60)

    return failed == 0


if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
