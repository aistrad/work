"use client";

/**
 * Chat Page - v7.1 ç»Ÿä¸€å¯¹è¯å…¥å£
 *
 * v7.1 ä¼˜åŒ–:
 * - ç§»é™¤åŒæ¸²æŸ“æ¨¡å¼ï¼Œä½¿ç”¨ CSS åª’ä½“æŸ¥è¯¢ç»Ÿä¸€å“åº”å¼
 * - PC ä¸‰æ : Chat + SidePanel (VibeID/ä»Šæ—¥Vibe/å¿«æ·æ“ä½œ)
 * - Mobile: å•æ  + Skill Tabs + Bottom Nav
 * - Suspense è¾¹ç•Œ (Vercel rule: async-suspense-boundaries)
 * - memo ç»„ä»¶ (Vercel rule: rerender-memo)
 * - åŠ¨æ€åŠ è½½ SidePanel (Vercel rule: bundle-dynamic-imports)
 */

import { useMemo, Suspense, memo, useCallback, useEffect, useState } from "react";
import dynamic from "next/dynamic";
import { useRouter, useSearchParams } from "next/navigation";
import { useSkill } from "@/providers";
import { AppShell, useAppShell } from "@/components/layout";
import { ChatPanel, ChartPanel, JourneyPanel, MePanel } from "@/components/layout/panels";
import { ChatContainer } from "@/components/chat/ChatContainer";
import { LuminousPaper, BreathAura } from "@/components/core";
import { Card } from "@/components/ui/Card";
import { Skeleton } from "@/components/ui/Skeleton";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Loading Fallbacks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ChatLoadingFallback = memo(function ChatLoadingFallback() {
  return (
    <div className="flex-1 flex items-center justify-center bg-bg-primary">
      <div className="flex flex-col items-center gap-3">
        <div className="w-12 h-12 rounded-full bg-accent-primary/10 animate-pulse flex items-center justify-center">
          <span className="text-2xl">ğŸ’¬</span>
        </div>
        <p className="text-text-secondary text-sm">åŠ è½½å¯¹è¯...</p>
      </div>
    </div>
  );
});

const PanelLoadingFallback = memo(function PanelLoadingFallback() {
  return (
    <div className="p-4 space-y-4">
      <Skeleton className="h-8 w-1/2 rounded-lg" />
      <Skeleton className="h-32 w-full rounded-xl" />
      <Skeleton className="h-24 w-full rounded-xl" />
    </div>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Side Panel Quick Actions - v7.1 æ ·å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface QuickAction {
  id: string;
  icon: string;
  label: string;
  description: string;
  onClick: () => void;
}

const QuickActionsCard = memo(function QuickActionsCard({ actions }: { actions: QuickAction[] }) {
  return (
    <Card variant="default" padding="md" hover={false} className="mb-4">
      <h3 className="text-sm font-semibold text-text-primary mb-3">å¿«æ·æ“ä½œ</h3>
      <div className="space-y-2">
        {actions.map((action) => (
          <button
            key={action.id}
            onClick={action.onClick}
            className="w-full flex items-center gap-3 p-2.5 rounded-lg text-left hover:bg-bg-secondary transition-colors duration-fast"
          >
            <span className="text-lg">{action.icon}</span>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-text-primary truncate">{action.label}</p>
              <p className="text-xs text-text-tertiary truncate">{action.description}</p>
            </div>
            <span className="text-text-disabled">â†’</span>
          </button>
        ))}
      </div>
    </Card>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Today's Vibe Card - v7.1 æ ·å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TodayVibeCard = memo(function TodayVibeCard({ skill }: { skill: string }) {
  const vibeData = useMemo(() => {
    if (skill === "bazi") {
      return {
        title: "ä»Šæ—¥è¿åŠ¿",
        icon: "ğŸŒŸ",
        summary: "ç”²å­æ—¥ï¼Œæ°´æ°”æ—ºç››",
        advice: "é€‚åˆå¤„ç†æ²Ÿé€šã€å­¦ä¹ ç›¸å…³äº‹åŠ¡",
        score: 78,
      };
    }
    return {
      title: "ä»Šæ—¥æ˜Ÿè±¡",
      icon: "ğŸ”®",
      summary: "æœˆäº®è¿›å…¥å¤©èåº§",
      advice: "é€‚åˆæ·±åº¦æ€è€ƒä¸å†…çœ",
      score: 72,
    };
  }, [skill]);

  return (
    <Card variant="default" padding="md" hover={false} className="mb-4">
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-xl">{vibeData.icon}</span>
          <h3 className="text-sm font-semibold text-text-primary">{vibeData.title}</h3>
        </div>
        <div className="flex items-center gap-1 px-2 py-0.5 rounded-full bg-accent-primary/10">
          <span className="text-xs font-medium text-accent-primary">{vibeData.score}</span>
          <span className="text-xs text-text-tertiary">åˆ†</span>
        </div>
      </div>
      <p className="text-sm text-text-primary mb-1">{vibeData.summary}</p>
      <p className="text-xs text-text-secondary">{vibeData.advice}</p>
    </Card>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VibeID Preview Card - v7.1 æ ·å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const VibeIDPreviewCard = memo(function VibeIDPreviewCard({ onClick }: { onClick: () => void }) {
  return (
    <Card
      variant="elevated"
      padding="md"
      hover
      className="mb-4 cursor-pointer"
      onClick={onClick}
    >
      <div className="flex items-center gap-3 mb-3">
        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-mystic-400 to-mystic-600 flex items-center justify-center">
          <span className="text-xl">ğŸ’</span>
        </div>
        <div>
          <h3 className="text-sm font-semibold text-text-primary">æˆ‘çš„ VibeID</h3>
          <p className="text-xs text-text-secondary">å››ç»´åŸå‹ç”»åƒ</p>
        </div>
      </div>
      <div className="flex items-center justify-between">
        <div className="flex -space-x-1">
          {["ğŸŒ¸", "ğŸ§­", "ğŸ­", "ğŸ”¥"].map((emoji, i) => (
            <span
              key={i}
              className="w-6 h-6 rounded-full bg-bg-secondary flex items-center justify-center text-xs border-2 border-bg-card"
            >
              {emoji}
            </span>
          ))}
        </div>
        <span className="text-xs text-accent-primary font-medium">æŸ¥çœ‹è¯¦æƒ… â†’</span>
      </div>
    </Card>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Panel Content - æ ¹æ® Tab åˆ‡æ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PanelContent = memo(function PanelContent() {
  const router = useRouter();
  const { activeTab } = useAppShell();
  const { skill } = useSkill();

  const handleOpenRelationship = useCallback(() => {
    router.push("/relationship");
  }, [router]);

  const handleGenerateReport = useCallback(() => {
    router.push("/interview?returnTo=/report");
  }, [router]);

  const handleViewKLine = useCallback(() => {
    router.push("/chat?view=kline");
  }, [router]);

  const handleViewIdentity = useCallback(() => {
    router.push("/identity");
  }, [router]);

  const demoProfile = useMemo(() =>
    skill === "bazi"
      ? { dayMaster: "ç”²æœ¨", pattern: "æ­£å°æ ¼", currentLuck: "å£¬å¯…å¤§è¿" }
      : { sunSign: "åŒå­åº§", moonSign: "å¤©èåº§", risingSign: "ç‹®å­åº§" }
  , [skill]);

  const demoNowNext = useMemo(() => ({
    now: { theme: skill === "bazi" ? "ç§¯ç´¯æœŸ - é€‚åˆæ²‰æ·€å­¦ä¹ " : "æ°´æ˜Ÿé€†è¡ŒæœŸ - é€‚åˆå›é¡¾åæ€" },
    next: { startDate: "2026å¹´ä¸‹åŠå¹´", theme: "çªç ´æœŸ" },
  }), [skill]);

  const quickActions = useMemo<QuickAction[]>(() => [
    {
      id: "relationship",
      icon: "ğŸ’‘",
      label: "å…³ç³»åŒ¹é…",
      description: "æŸ¥çœ‹ä¸ä»–äººçš„å¥‘åˆåº¦",
      onClick: handleOpenRelationship,
    },
    {
      id: "report",
      icon: "ğŸ“Š",
      label: "ç”ŸæˆæŠ¥å‘Š",
      description: "è·å–è¯¦ç»†åˆ†ææŠ¥å‘Š",
      onClick: handleGenerateReport,
    },
    {
      id: "kline",
      icon: "ğŸ“ˆ",
      label: "è¿åŠ¿æ›²çº¿",
      description: "æŸ¥çœ‹è¿åŠ¿èµ°åŠ¿å›¾",
      onClick: handleViewKLine,
    },
  ], [handleOpenRelationship, handleGenerateReport, handleViewKLine]);

  switch (activeTab) {
    case "chat":
      return (
        <div className="h-full overflow-y-auto p-4">
          <VibeIDPreviewCard onClick={handleViewIdentity} />
          <TodayVibeCard skill={skill} />
          <QuickActionsCard actions={quickActions} />
        </div>
      );
    case "chart":
      return (
        <ChartPanel
          skill={skill}
          nowNextData={demoNowNext}
          klinePreview={{ currentScore: 72, trend: "up", period: "2026å¹´" }}
          onViewKLine={handleViewKLine}
          onGenerateReport={handleGenerateReport}
        />
      );
    case "journey":
      return (
        <JourneyPanel
          skill={skill}
          totalConversations={12}
          totalInsights={5}
          memberSince="2025å¹´12æœˆ"
          timeline={[
            { id: "1", date: "ä»Šå¤©", title: "å…³äºäº‹ä¸šæ–¹å‘çš„å¯¹è¯", summary: "æ¢è®¨äº†æœªæ¥3å¹´çš„èŒä¸šè§„åˆ’", type: "conversation" },
            { id: "2", date: "æ˜¨å¤©", title: "ä½ çš„æ ¸å¿ƒä¼˜åŠ¿", summary: "åˆ†æäº†ä½ çš„æ€§æ ¼ç‰¹ç‚¹", type: "insight" },
          ]}
        />
      );
    case "me":
      return (
        <MePanel
          skill={skill}
          user={{ name: "ç”¨æˆ·", email: "user@vibelife.app", isPro: false }}
          onLogout={() => console.log("Logout")}
        />
      );
    default:
      return null;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Chat Content - ä¸»èŠå¤©åŒºåŸŸ
// æ”¯æŒ URL å‚æ•°ï¼š?skill=xxx&prompt=xxx (ç”¨äºä»é€šçŸ¥è·³è½¬å¼€å§‹å¯¹è¯)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ChatContent = memo(function ChatContent() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { voiceMode } = useAppShell();
  const { skill, setSkill } = useSkill();

  // ä» URL å‚æ•°è·å– skill å’Œ prompt
  const urlSkill = searchParams.get("skill");
  const urlPrompt = searchParams.get("prompt");
  const [initialPrompt, setInitialPrompt] = useState<string | null>(null);

  // å¤„ç† URL å‚æ•°
  useEffect(() => {
    // å¦‚æœ URL æŒ‡å®šäº† skillï¼Œåˆ‡æ¢åˆ°è¯¥ skill
    if (urlSkill && urlSkill !== skill) {
      setSkill(urlSkill as typeof skill);
    }

    // å¦‚æœ URL æŒ‡å®šäº† promptï¼Œè®¾ç½®åˆå§‹æ¶ˆæ¯
    if (urlPrompt) {
      const decoded = decodeURIComponent(urlPrompt);
      setInitialPrompt(decoded);

      // æ¸…ç† URL å‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤å‘é€
      const newUrl = window.location.pathname;
      router.replace(newUrl, { scroll: false });
    }
  }, [urlSkill, urlPrompt, skill, setSkill, router]);

  return (
    <LuminousPaper skill={skill} variant="default" className="h-full relative">
      <BreathAura skill={skill} size="xl" position="top" intensity="low" className="opacity-20" />
      {/*
        v7.2: è‡ªåŠ¨è·¯ç”±æ¨¡å¼
        - ä¸ä¼  skillIdï¼Œè®©åç«¯ CoreAgent é€šè¿‡ LLM è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾
        - skill ä»…ç”¨äº UI å±•ç¤ºï¼ˆä¸»é¢˜ã€ç©ºçŠ¶æ€ç­‰ï¼‰
        - ç”¨æˆ·è¯´"æ˜Ÿåº§åˆ†æ"ä¼šè‡ªåŠ¨è·¯ç”±åˆ° zodiacï¼Œè¯´"å…«å­—"ä¼šè·¯ç”±åˆ° bazi
        - initialPrompt: ä»é€šçŸ¥è·³è½¬æ—¶çš„é¢„è®¾æ¶ˆæ¯
      */}
      <ChatContainer
        skill={skill}
        voiceMode={voiceMode}
        initialPrompt={initialPrompt}
        onInitialPromptSent={() => setInitialPrompt(null)}
      />
    </LuminousPaper>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Chat Page - ä¸»ç»„ä»¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default function ChatPage() {
  const { skill } = useSkill();

  return (
    <AppShell
      skill={skill}
      panelContent={
        <Suspense fallback={<PanelLoadingFallback />}>
          <PanelContent />
        </Suspense>
      }
    >
      <Suspense fallback={<ChatLoadingFallback />}>
        <ChatContent />
      </Suspense>
    </AppShell>
  );
}
