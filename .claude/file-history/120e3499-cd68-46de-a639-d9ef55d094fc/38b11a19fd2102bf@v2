'use client';

/**
 * SkillList - Skill 列表组件
 *
 * 支持网格/列表布局，按分类分组，带筛选功能
 */

import React, { useMemo, useState } from 'react';
import { cn } from '@/lib/utils';
import { SkillCard } from './SkillCard';
import type { SkillListProps, SkillCategory, SkillUserStatus, SkillMetadata } from '@/types/skill';

// ═══════════════════════════════════════════════════════════════════════════
// 常量
// ═══════════════════════════════════════════════════════════════════════════

const FILTER_LABELS: Record<string, string> = {
  all: '全部',
  professional: '专业技能',
  default: '基础功能',
  core: '核心能力',
  subscribed: '已订阅',
};

const CATEGORY_LABELS: Record<string, string> = {
  core: '核心能力',
  default: '基础功能',
  professional: '专业技能',
};

const CATEGORY_ORDER: SkillCategory[] = ['professional', 'default', 'core'];

// ═══════════════════════════════════════════════════════════════════════════
// 辅助函数
// ═══════════════════════════════════════════════════════════════════════════

function groupByCategory(skills: SkillMetadata[]): Record<string, SkillMetadata[]> {
  const groups: Record<string, SkillMetadata[]> = {
    professional: [],
    default: [],
    core: [],
  };

  for (const skill of skills) {
    if (groups[skill.category]) {
      groups[skill.category].push(skill);
    }
  }

  return groups;
}

function filterMatch(
  skill: SkillMetadata,
  filter: string,
  userStatus?: SkillUserStatus
): boolean {
  if (filter === 'all') return true;
  if (filter === 'subscribed') return userStatus?.subscribed ?? false;
  return skill.category === filter;
}

// ═══════════════════════════════════════════════════════════════════════════
// SkillList 组件
// ═══════════════════════════════════════════════════════════════════════════

export function SkillList({
  skills,
  userStatuses = {},
  layout = 'grid',
  groupBy = 'category',
  showFilters = true,
  onSkillClick,
  onSubscribe,
  onUnsubscribe,
  onTogglePush,
}: SkillListProps) {
  const [filter, setFilter] = useState<string>('all');

  // 分组逻辑
  const grouped = useMemo(() => {
    if (groupBy === 'none') {
      return { all: skills };
    }
    return groupByCategory(skills);
  }, [skills, groupBy]);

  // 过滤后的分组
  const filteredGroups = useMemo(() => {
    const result: Record<string, SkillMetadata[]> = {};

    for (const [group, groupSkills] of Object.entries(grouped)) {
      const filtered = groupSkills.filter((s) =>
        filterMatch(s, filter, userStatuses[s.id])
      );
      if (filtered.length > 0) {
        result[group] = filtered;
      }
    }

    return result;
  }, [grouped, filter, userStatuses]);

  // 确定显示顺序
  const orderedGroups = groupBy === 'category'
    ? CATEGORY_ORDER.filter((c) => filteredGroups[c])
    : Object.keys(filteredGroups);

  return (
    <div className="space-y-6">
      {/* Filters */}
      {showFilters && (
        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
          {Object.entries(FILTER_LABELS).map(([key, label]) => (
            <button
              key={key}
              onClick={() => setFilter(key)}
              className={cn(
                'px-4 py-1.5 text-sm rounded-full whitespace-nowrap transition-colors',
                filter === key
                  ? 'bg-accent text-white'
                  : 'bg-white/5 text-text-secondary hover:bg-white/10'
              )}
            >
              {label}
            </button>
          ))}
        </div>
      )}

      {/* Groups */}
      {orderedGroups.length === 0 ? (
        <div className="text-center py-12 text-text-secondary">
          暂无 Skill
        </div>
      ) : (
        orderedGroups.map((group) => {
          const groupSkills = filteredGroups[group];
          if (!groupSkills || groupSkills.length === 0) return null;

          return (
            <div key={group}>
              {groupBy !== 'none' && (
                <h2 className="text-lg font-semibold text-text-primary mb-3">
                  {CATEGORY_LABELS[group] || group}
                </h2>
              )}

              <div
                className={cn(
                  layout === 'grid'
                    ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4'
                    : 'space-y-2'
                )}
              >
                {groupSkills.map((skill) => (
                  <SkillCard
                    key={skill.id}
                    skill={skill}
                    variant={layout === 'grid' ? 'card' : 'compact'}
                    userStatus={userStatuses[skill.id]}
                    onClick={() => onSkillClick?.(skill.id)}
                    onSubscribe={() => onSubscribe?.(skill.id)}
                    onUnsubscribe={() => onUnsubscribe?.(skill.id)}
                    onTogglePush={(enabled) => onTogglePush?.(skill.id, enabled)}
                    onTry={() => onSubscribe?.(skill.id)}
                    onLearnMore={() => onSkillClick?.(skill.id)}
                  />
                ))}
              </div>
            </div>
          );
        })
      )}
    </div>
  );
}

export default SkillList;
