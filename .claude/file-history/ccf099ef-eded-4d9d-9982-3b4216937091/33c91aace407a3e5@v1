'use client'

/**
 * Persona Step - Stage 4
 *
 * 人格选择：温暖向导 / 犀利挚友 / 智慧导师
 * 目标：让用户选择对话风格，增加参与感
 */

import { useState } from 'react'
import { motion } from 'framer-motion'
import { ArrowRight } from 'lucide-react'
import { useOnboarding } from '../context'
import { PERSONAS, type PersonaType } from '../types'

const PERSONA_LIST: PersonaType[] = ['warm', 'sharp', 'wise']

export default function PersonaStep() {
  const { setPersona, nextStep } = useOnboarding()
  const [selected, setSelected] = useState<PersonaType | null>(null)

  const handleSelect = (persona: PersonaType) => {
    setSelected(persona)
  }

  const handleContinue = () => {
    if (selected) {
      setPersona(selected)
      nextStep()
    }
  }

  // Emotion value bar color
  const getEmotionBarColor = (value: number) => {
    if (value > 50) return 'bg-green-500'
    if (value > 0) return 'bg-blue-500'
    return 'bg-orange-500'
  }

  // Emotion value display width
  const getEmotionBarWidth = (value: number) => {
    // Map -100~100 to 0~100
    return Math.abs(value)
  }

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="w-full max-w-2xl"
    >
      {/* Title */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        className="text-center mb-8"
      >
        <h2 className="font-serif text-2xl font-bold text-foreground mb-2">
          选择你喜欢的对话风格
        </h2>
        <p className="text-muted-foreground">
          这会影响我和你对话的方式，以及「来自未来的信」的语气
        </p>
      </motion.div>

      {/* Persona Cards */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        {PERSONA_LIST.map((personaId, index) => {
          const persona = PERSONAS[personaId]
          const isSelected = selected === personaId

          return (
            <motion.button
              key={personaId}
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.1 + index * 0.1 }}
              whileHover={{ scale: 1.02, y: -4 }}
              whileTap={{ scale: 0.98 }}
              onClick={() => handleSelect(personaId)}
              className={`
                relative p-5 rounded-2xl text-left transition-all duration-300
                ${isSelected
                  ? 'bg-skill-primary/10 border-2 border-skill-primary shadow-lg'
                  : 'bg-card border-2 border-border hover:border-skill-primary/50'
                }
              `}
            >
              {/* Selected indicator */}
              {isSelected && (
                <motion.div
                  layoutId="selected-indicator"
                  className="absolute top-3 right-3 w-6 h-6 bg-skill-primary rounded-full flex items-center justify-center"
                >
                  <svg className="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" />
                  </svg>
                </motion.div>
              )}

              {/* Icon */}
              <div className="text-4xl mb-3">{persona.icon}</div>

              {/* Name */}
              <h3 className="font-serif text-lg font-semibold text-foreground mb-0.5">
                {persona.name}
              </h3>
              <p className="text-xs text-muted-foreground mb-3">
                {persona.nameEn}
              </p>

              {/* Description */}
              <p className="text-sm text-muted-foreground mb-4">
                {persona.description}
              </p>

              {/* Sample Text */}
              <div className="bg-background/60 rounded-xl p-3 mb-4">
                <p className="text-sm text-foreground italic leading-relaxed">
                  "{persona.sampleText}"
                </p>
              </div>

              {/* Emotion Value Bar */}
              <div className="space-y-1.5">
                <div className="flex items-center justify-between text-xs">
                  <span className="text-muted-foreground">情绪价值</span>
                  <span className={`font-medium ${
                    persona.emotionValue > 50
                      ? 'text-green-600'
                      : persona.emotionValue > 0
                        ? 'text-blue-600'
                        : 'text-orange-600'
                  }`}>
                    {persona.emotionValue > 0 ? '+' : ''}{persona.emotionValue}%
                  </span>
                </div>
                <div className="h-2 bg-muted/30 rounded-full overflow-hidden">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${getEmotionBarWidth(persona.emotionValue)}%` }}
                    transition={{ delay: 0.3 + index * 0.1, duration: 0.5 }}
                    className={`h-full rounded-full ${getEmotionBarColor(persona.emotionValue)}`}
                  />
                </div>
              </div>
            </motion.button>
          )
        })}
      </div>

      {/* Continue Button */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.5 }}
        className="text-center"
      >
        <motion.button
          whileHover={{ scale: selected ? 1.02 : 1 }}
          whileTap={{ scale: selected ? 0.98 : 1 }}
          onClick={handleContinue}
          disabled={!selected}
          className={`
            px-8 py-4 rounded-xl font-medium text-lg flex items-center justify-center gap-2 mx-auto transition-all duration-300
            ${selected
              ? 'bg-skill-primary text-white shadow-lg hover:shadow-xl'
              : 'bg-muted text-muted-foreground cursor-not-allowed'
            }
          `}
        >
          继续
          <ArrowRight className="w-5 h-5" />
        </motion.button>

        <p className="mt-4 text-xs text-muted-foreground">
          之后可以在设置中随时更改
        </p>
      </motion.div>
    </motion.div>
  )
}
