'use client'

/**
 * Aha Step - Stage 3
 *
 * 30秒 Aha Moment：命盘可视化 + 今日运势 + 核心洞察
 * 目标：让用户感到「被看见」，Time to Aha < 30秒
 */

import { motion } from 'framer-motion'
import { ArrowRight, Star } from 'lucide-react'
import { useOnboarding } from '../context'

export default function AhaStep() {
  const { state, nextStep } = useOnboarding()
  const { baziData } = state

  if (!baziData) {
    return null
  }

  // 生成星星评分
  const renderStars = (score: number) => {
    return Array.from({ length: 5 }).map((_, i) => (
      <Star
        key={i}
        className={`w-4 h-4 ${i < score ? 'text-yellow-500 fill-yellow-500' : 'text-muted-foreground/30'}`}
      />
    ))
  }

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="w-full max-w-md"
    >
      {/* Day Master Card */}
      <motion.div
        initial={{ opacity: 0, y: 20, scale: 0.95 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        transition={{ delay: 0.1 }}
        className="bg-gradient-to-br from-skill-primary/10 to-skill-primary/5 border border-skill-primary/20 rounded-2xl p-6 mb-4 text-center relative overflow-hidden"
      >
        {/* Decorative glow */}
        <div className="absolute inset-0 bg-gradient-radial from-skill-primary/10 via-transparent to-transparent" />

        <div className="relative z-10">
          {/* Day Master Symbol */}
          <motion.div
            initial={{ scale: 0, rotate: -180 }}
            animate={{ scale: 1, rotate: 0 }}
            transition={{ delay: 0.3, type: 'spring', stiffness: 200 }}
            className="w-20 h-20 mx-auto mb-4 rounded-full bg-skill-primary text-white flex items-center justify-center text-3xl font-serif font-bold shadow-lg"
          >
            {baziData.dayMaster}
          </motion.div>

          <motion.p
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.5 }}
            className="text-lg font-serif font-semibold text-foreground mb-2"
          >
            {baziData.dayMaster}{baziData.dayMasterElement}日主
          </motion.p>

          <motion.p
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.6 }}
            className="text-muted-foreground leading-relaxed whitespace-pre-line"
          >
            {baziData.insight}
          </motion.p>
        </div>
      </motion.div>

      {/* Today's Fortune Card */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.7 }}
        className="bg-card/80 backdrop-blur-sm border border-border rounded-2xl p-6 mb-6"
      >
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-medium text-foreground">今日运势</h3>
          <div className="flex items-center gap-0.5">
            {renderStars(baziData.fortune.score)}
          </div>
        </div>

        {/* Fortune Details */}
        <div className="flex items-center justify-between text-sm text-muted-foreground mb-4 pb-4 border-b border-border/50">
          <span>
            幸运色：
            <span className="text-foreground font-medium">{baziData.fortune.luckyColor}</span>
          </span>
          <span className="text-border">|</span>
          <span>
            幸运数：
            <span className="text-foreground font-medium">{baziData.fortune.luckyNumber}</span>
          </span>
          <span className="text-border">|</span>
          <span>
            宜：
            <span className="text-foreground font-medium">主动出击</span>
          </span>
        </div>

        {/* Fortune Advice */}
        <motion.p
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.9 }}
          className="text-foreground leading-relaxed"
        >
          "今天{baziData.dayMasterElement}气旺盛，适合开拓新领域，
          <br />
          但要注意不要过于急躁。"
        </motion.p>
      </motion.div>

      {/* CTA Section */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 1.0 }}
        className="text-center"
      >
        <p className="text-muted-foreground mb-4">
          想更深入了解自己？
          <br />
          只需 2-3 个问题，我就能给你一封来自未来的信。
        </p>

        <motion.button
          whileHover={{ scale: 1.02 }}
          whileTap={{ scale: 0.98 }}
          onClick={() => nextStep()}
          className="w-full py-4 bg-skill-primary text-white rounded-xl font-medium text-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2"
        >
          继续探索
          <ArrowRight className="w-5 h-5" />
        </motion.button>
      </motion.div>

      {/* Four Pillars Mini Display */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 1.2 }}
        className="mt-8 flex justify-center gap-2"
      >
        {[baziData.yearPillar, baziData.monthPillar, baziData.dayPillar, baziData.hourPillar].map((pillar, i) => (
          <div key={i} className="text-center">
            <div className="text-xs text-muted-foreground/60 mb-1">
              {['年', '月', '日', '时'][i]}
            </div>
            <div className="w-8 h-8 bg-card border border-border rounded text-xs flex items-center justify-center text-muted-foreground">
              {pillar ? `${pillar.stem}${pillar.branch}` : '--'}
            </div>
          </div>
        ))}
      </motion.div>
    </motion.div>
  )
}
