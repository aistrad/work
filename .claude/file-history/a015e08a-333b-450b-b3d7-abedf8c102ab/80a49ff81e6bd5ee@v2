"""
Agent Framework - V10 Architecture (Context Engineering)

V10 Changes:
- Context Engineering: 文件/JSONB 持久化状态，断点续传
- 模块化: ContextManager, SessionManager, PromptBuilder, ToolExecutor
- 会话恢复: 自动检测未完成会话，支持断点续传
- 跨 Skill 共享: profile.extracted + identity

V9 Features (retained):
- Phase 1 提供所有路由工具，LLM 一次性决策
- 移除 Python 硬编码决策逻辑
- 工具即行为：activate_skill, show_protocol_invitation, show_skill_intro

V6 Features (retained):
- CoreAgent replaces Orchestrator + SkillAgents
- LLM-based skill selection (no keyword matching)
- SkillLoader loads SKILL.md files
- Unified tool schema from YAML
- Skill validation for CI
"""

# Core Agent
from .core import CoreAgent, AgentContext, AgentEvent, AgentState, create_agent
from .skill_loader import load_skill, build_system_prompt, get_available_skills, SkillConfig
from .subagent import SkillSubAgent

# Tier limits (简化版，完整配额管理使用 model_router.quota)
TIER_LIMITS = {
    "free": {"calls": 50, "tokens": 100000},
    "paid": {"calls": 500, "tokens": 1000000},
    "vip": {"calls": -1, "tokens": -1},
}


class QuotaTracker:
    """简化配额追踪 - 委托到 UsageService"""

    @classmethod
    async def check(cls, user_id: str, tier: str):
        """检查配额"""
        if tier == "vip":
            return True, ""

        from services.usage import UsageService
        from uuid import UUID

        try:
            usage = await UsageService.get_monthly_usage(UUID(user_id))
            limits = TIER_LIMITS.get(tier, TIER_LIMITS["free"])

            if limits["calls"] > 0 and usage["llm_calls"] >= limits["calls"]:
                return False, "本月对话次数已用完"
            return True, ""
        except Exception:
            return True, ""

    @classmethod
    async def record(cls, user_id: str, usage: dict):
        """记录用量 - 已由 UsageService 处理"""
        pass

# Stream Adapters
from .stream_adapter import (
    BaseStreamAdapter,
    AISDKv6Adapter,
    LegacySSEAdapter,
    StreamConfig,
    get_adapter,
)

# V6 新增: 统一工具定义
from .tool_schema import (
    ToolDef,
    ToolParam,
    load_skill_tools,
    get_skill_tools_openai,
    get_global_tools_openai,
    get_all_tools_for_skill,
    get_tool_card_type,
)

# V6 新增: 统一工具注册表
from .tool_registry import (
    ToolRegistry,
    ToolContext,
    tool_handler,
)

# V10 新增: Context Engineering
from .context_manager import (
    ContextManager,
    SessionContext,
    Checkpoint,
    Finding,
    get_context_manager,
)
from .session_manager import (
    SessionManager,
    ActiveSession,
    SessionStatus,
    get_session_manager,
)
from .prompt_builder import PromptBuilder, get_prompt_builder
from .tool_executor import ToolExecutor, get_tool_executor

# V6 新增: Skill 校验
from .skill_validator import (
    validate_skill,
    validate_all_skills,
    ValidationResult,
    ValidationError,
)

__all__ = [
    # Core Agent
    "CoreAgent",
    "AgentContext",
    "AgentEvent",
    "AgentState",
    "SkillConfig",
    "SkillSubAgent",
    "QuotaTracker",
    "TIER_LIMITS",
    "create_agent",
    "load_skill",
    "build_system_prompt",
    "get_available_skills",
    # Stream Adapters
    "BaseStreamAdapter",
    "AISDKv6Adapter",
    "LegacySSEAdapter",
    "StreamConfig",
    "get_adapter",
    # Tool Schema
    "ToolDef",
    "ToolParam",
    "load_skill_tools",
    "get_skill_tools_openai",
    "get_global_tools_openai",
    "get_all_tools_for_skill",
    "get_tool_card_type",
    # Tool Registry
    "ToolRegistry",
    "ToolContext",
    "tool_handler",
    # Context Engineering (v10)
    "ContextManager",
    "SessionContext",
    "Checkpoint",
    "Finding",
    "get_context_manager",
    "SessionManager",
    "ActiveSession",
    "SessionStatus",
    "get_session_manager",
    "PromptBuilder",
    "get_prompt_builder",
    "ToolExecutor",
    "get_tool_executor",
    # Skill Validator
    "validate_skill",
    "validate_all_skills",
    "ValidationResult",
    "ValidationError",
]
