/**
 * useVibeID Hook
 *
 * 基于前端规范 v7.1
 * 提供 VibeID 数据获取和状态管理
 */

'use client'

import { useCallback } from 'react'
import useSWR from 'swr'
import { create } from 'zustand'
import { persist } from 'zustand/middleware'
import type {
  VibeIDProfile,
  VibeIDDisplay,
  ArchetypeType,
  ArchetypeScores,
} from '@/types/vibe-id'
import { getArchetypeMeta, profileToDisplay } from '@/types/vibe-id'

// ============================================================================
// API Configuration
// ============================================================================

const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1'

// ============================================================================
// Store - 客户端状态管理
// ============================================================================

interface VibeIDState {
  // 缓存的 profile
  cachedProfile: VibeIDProfile | null
  cachedDisplay: VibeIDDisplay | null

  // Actions
  setProfile: (profile: VibeIDProfile) => void
  setDisplay: (display: VibeIDDisplay) => void
  clearCache: () => void
}

export const useVibeIDStore = create<VibeIDState>()(
  persist(
    (set) => ({
      cachedProfile: null,
      cachedDisplay: null,

      setProfile: (profile) =>
        set({
          cachedProfile: profile,
          cachedDisplay: profileToDisplay(profile),
        }),

      setDisplay: (display) => set({ cachedDisplay: display }),

      clearCache: () => set({ cachedProfile: null, cachedDisplay: null }),
    }),
    {
      name: 'vibelife-vibe-id',
      partialize: (state) => ({
        cachedDisplay: state.cachedDisplay,
      }),
    }
  )
)

// ============================================================================
// API Fetcher
// ============================================================================

interface VibeIDAPIResponse {
  primary_archetype: string
  primary_emoji: string
  primary_tagline: string
  secondary_archetype: string | null
  core: {
    primary: string
    primary_cn: string
    primary_emoji: string
    primary_nickname: string
    secondary: string | null
    confidence: string
  }
  inner: {
    primary: string
    primary_cn: string
    primary_emoji: string
    primary_nickname: string
    confidence: string
  }
  outer: {
    primary: string
    primary_cn: string
    primary_emoji: string
    primary_nickname: string
    confidence: string
  }
  shadow: {
    primary: string
    primary_cn: string
    primary_emoji: string
    primary_nickname: string
    confidence: string
  }
  bazi_brief: string
  zodiac_brief: string
  explanation: {
    summary: string
    bazi_insight: string
    zodiac_insight: string
    integration_insight: string
    growth_direction: string
  }
  archetype_scores: Record<string, number>
}

/**
 * 将 API 响应转换为 VibeIDDisplay
 */
function apiResponseToDisplay(response: VibeIDAPIResponse): VibeIDDisplay {
  const primaryMeta = getArchetypeMeta(response.primary_archetype as ArchetypeType)
  const shadowMeta = getArchetypeMeta(response.shadow.primary as ArchetypeType)

  return {
    primaryArchetype: response.primary_archetype as ArchetypeType,
    primaryEmoji: response.primary_emoji,
    primaryName: primaryMeta.name,
    primaryNickname: primaryMeta.nickname,
    primarySlogan: primaryMeta.slogan,

    secondaryArchetype: response.secondary_archetype as ArchetypeType | null,
    secondaryEmoji: response.secondary_archetype
      ? getArchetypeMeta(response.secondary_archetype as ArchetypeType).emoji
      : null,

    coreSummary: `${response.core.primary_emoji} ${response.core.primary_cn} / ${response.core.primary_nickname}`,
    innerSummary: `${response.inner.primary_emoji} ${response.inner.primary_cn}`,
    outerSummary: `${response.outer.primary_emoji} ${response.outer.primary_cn}`,
    shadowSummary: `${response.shadow.primary_emoji} ${response.shadow.primary_cn}`,
    shadowTension: shadowMeta ? `${primaryMeta.name} vs ${shadowMeta.name}` : '',

    summary: response.explanation.summary,
    growthTip: response.explanation.growth_direction,

    baziBrief: response.bazi_brief,
    zodiacBrief: response.zodiac_brief,

    confidence: response.core.confidence as 'high' | 'medium' | 'low',
    consistencyType: 'similar', // API 需要返回这个字段
  }
}

const fetcher = async (url: string): Promise<VibeIDDisplay> => {
  const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null

  const res = await fetch(url, {
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
      ...(token ? { Authorization: `Bearer ${token}` } : {}),
    },
  })

  if (!res.ok) {
    if (res.status === 404) {
      throw new Error('VibeID not found')
    }
    throw new Error('Failed to fetch VibeID')
  }

  const data: VibeIDAPIResponse = await res.json()
  return apiResponseToDisplay(data)
}

// ============================================================================
// Main Hook
// ============================================================================

interface UseVibeIDOptions {
  /** 是否自动获取数据 */
  autoFetch?: boolean
  /** 使用缓存数据 */
  useCache?: boolean
}

interface UseVibeIDReturn {
  // Data
  display: VibeIDDisplay | null
  scores: ArchetypeScores | null
  isLoading: boolean
  error: Error | null
  isNotFound: boolean

  // Computed
  coreArchetype: ReturnType<typeof getArchetypeMeta> | null
  innerArchetype: ReturnType<typeof getArchetypeMeta> | null
  outerArchetype: ReturnType<typeof getArchetypeMeta> | null
  shadowArchetype: ReturnType<typeof getArchetypeMeta> | null

  // Actions
  refresh: () => Promise<void>
  calculate: (birthData: {
    birthDate: string
    birthTime?: string
    birthPlace?: string
    gender?: string
  }) => Promise<VibeIDDisplay>
}

export function useVibeID(options: UseVibeIDOptions = {}): UseVibeIDReturn {
  const { autoFetch = true, useCache = true } = options
  const { cachedDisplay, setDisplay, clearCache } = useVibeIDStore()

  // SWR for data fetching with automatic deduplication
  const {
    data,
    error,
    isLoading,
    mutate,
  } = useSWR<VibeIDDisplay>(
    autoFetch ? `${API_BASE}/vibe-id` : null,
    fetcher,
    {
      revalidateOnFocus: false,
      revalidateOnReconnect: false,
      dedupingInterval: 60000, // 1 minute deduplication
      onSuccess: (data) => setDisplay(data),
      fallbackData: useCache ? cachedDisplay ?? undefined : undefined,
    }
  )

  const display = data || (useCache ? cachedDisplay : null)
  const isNotFound = error?.message === 'VibeID not found'

  // Get archetype metadata helpers
  const getArchetype = useCallback(
    (type: 'core' | 'inner' | 'outer' | 'shadow') => {
      if (!display) return null
      const archetypeId = type === 'core' ? display.primaryArchetype : null
      return archetypeId ? getArchetypeMeta(archetypeId) : null
    },
    [display]
  )

  // Refresh data
  const refresh = useCallback(async () => {
    clearCache()
    await mutate()
  }, [mutate, clearCache])

  // Calculate VibeID
  const calculate = useCallback(
    async (birthData: {
      birthDate: string
      birthTime?: string
      birthPlace?: string
      gender?: string
    }): Promise<VibeIDDisplay> => {
      const token = typeof window !== 'undefined' ? localStorage.getItem('token') : null

      const res = await fetch(`${API_BASE}/vibe-id/calculate`, {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          ...(token ? { Authorization: `Bearer ${token}` } : {}),
        },
        body: JSON.stringify({
          birth_date: birthData.birthDate,
          birth_time: birthData.birthTime || '12:00',
          birth_place: birthData.birthPlace || '北京',
          gender: birthData.gender || 'unknown',
        }),
      })

      if (!res.ok) {
        throw new Error('Failed to calculate VibeID')
      }

      const data: VibeIDAPIResponse = await res.json()
      const displayData = apiResponseToDisplay(data)
      setDisplay(displayData)
      await mutate(displayData, false)
      return displayData
    },
    [mutate, setDisplay]
  )

  return {
    display,
    scores: null, // TODO: Parse from API response
    isLoading,
    error: error || null,
    isNotFound,

    coreArchetype: display ? getArchetypeMeta(display.primaryArchetype) : null,
    innerArchetype: getArchetype('inner'),
    outerArchetype: getArchetype('outer'),
    shadowArchetype: getArchetype('shadow'),

    refresh,
    calculate,
  }
}

export default useVibeID
