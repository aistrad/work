#!/bin/bash
# Claude Code 进程检查工具
# 在启动新的 Claude Code 前运行此脚本，避免多进程冲突

CURRENT_DIR=$(pwd)
DIR_NAME=$(basename "$CURRENT_DIR")

echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║         Claude Code 进程检查工具                                 ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
echo ""
echo "当前目录: $CURRENT_DIR"
echo ""

# 查找所有 Claude Code 进程
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "所有运行中的 Claude Code 进程:"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

FOUND=0
while IFS= read -r pid; do
    FOUND=1
    cwd=$(readlink /proc/$pid/cwd 2>/dev/null || echo "未知")
    cpu=$(ps -p $pid -o %cpu= 2>/dev/null || echo "0")
    start=$(ps -p $pid -o lstart= 2>/dev/null || echo "未知")

    if [[ "$cwd" == "$CURRENT_DIR" ]]; then
        echo "⚠️  PID $pid: $cwd (CPU: $cpu%)"
        echo "   启动时间: $start"
        echo "   ⚠️  与当前目录冲突！"
    else
        echo "✓  PID $pid: $cwd (CPU: $cpu%)"
        echo "   启动时间: $start"
    fi
    echo ""
done < <(pgrep -f "/home/aiscend/.local/bin/claude")

if [ $FOUND -eq 0 ]; then
    echo "✅ 没有运行中的 Claude Code 进程"
    echo "✅ 可以安全启动 Claude Code"
else
    # 检查是否有进程在当前目录
    CONFLICTS=$(pgrep -f "/home/aiscend/.local/bin/claude" | while read pid; do
        cwd=$(readlink /proc/$pid/cwd 2>/dev/null)
        if [[ "$cwd" == "$CURRENT_DIR" ]]; then
            echo "$pid"
        fi
    done)

    if [ -n "$CONFLICTS" ]; then
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo "❌ 警告：检测到进程冲突！"
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo ""
        echo "以下进程已在当前目录运行："
        echo "$CONFLICTS"
        echo ""
        echo "建议操作："
        echo "1. 关闭冲突的进程: kill $CONFLICTS"
        echo "2. 或者使用: pkill -f 'claude.*$DIR_NAME'"
        echo "3. 然后重新启动 Claude Code"
        echo ""

        # 询问是否自动关闭
        read -p "是否自动关闭这些进程？(y/N) " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            for pid in $CONFLICTS; do
                echo "关闭进程 $pid..."
                kill "$pid" 2>/dev/null
            done
            sleep 1
            echo "✅ 进程已关闭，现在可以启动 Claude Code"
        fi
    else
        echo "✅ 当前目录没有冲突进程"
        echo "✅ 可以安全启动 Claude Code"
    fi
fi

echo ""
echo "╔══════════════════════════════════════════════════════════════════╗"
echo "║  使用方法: 在启动 Claude 前运行 claude-check                    ║"
echo "╚══════════════════════════════════════════════════════════════════╝"
