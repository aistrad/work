# VibeLife V8 系统架构文档

> Version: 8.0 | 2026-01-19
> 核心理念：AI 原生的个人成长陪伴平台

---

## 1. 产品定位

VibeLife 是一个 AI 原生的个人成长陪伴平台，通过多个专业 Skill 提供深度理解和主动关怀。

### 1.1 三大差异化

| 差异化 | 说明 |
|--------|------|
| **Deep Understanding** | 理解你这个人，而非只是问题 |
| **Proactive Agency** | 主动关心，而非等你开口 |
| **Infinite Extensibility** | 通过 Skills 无限扩展能力 |

### 1.2 设计原则

| 原则 | 说明 |
|------|------|
| **Simplicity** | 保持简单，避免过度工程 |
| **Config-Driven** | Skill 层配置驱动，平台层代码驱动 |
| **Single Source of Truth** | 工具定义、模型配置等只有一个数据源 |
| **DDD** | 领域驱动设计，每个 Skill 独立管理自己的服务 |

---

## 2. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         VibeLife V8 Architecture                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐          │
│   │   Browser    │─────▶│   Next.js    │─────▶│  Python API  │          │
│   │  (AI SDK 4)  │      │   (Proxy)    │      │  (FastAPI)   │          │
│   └──────────────┘      └──────────────┘      └──────────────┘          │
│                                                      │                   │
│                         ┌────────────────────────────┼────────────────┐  │
│                         │                            ▼                │  │
│                         │   ┌────────────────────────────────────┐    │  │
│                         │   │            CoreAgent               │    │  │
│                         │   │     (Agentic Loop + Tool Calling)  │    │  │
│                         │   └────────────────────────────────────┘    │  │
│                         │              │              │               │  │
│                         │    ┌─────────┴──────┐      │               │  │
│                         │    ▼                ▼      ▼               │  │
│                         │ ┌────────┐  ┌────────────┐ ┌────────────┐  │  │
│                         │ │  Tool  │  │   Skill    │ │  Knowledge │  │  │
│                         │ │Registry│  │  Loader    │ │  (Cases)   │  │  │
│                         │ └────────┘  └────────────┘ └────────────┘  │  │
│                         │                    │                       │  │
│                         │    ┌───────────────┼───────────────┐       │  │
│                         │    ▼               ▼               ▼       │  │
│                         │ ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐    │  │
│                         │ │ Bazi │  │Zodiac│  │Tarot │  │Career│    │  │
│                         │ │Skill │  │Skill │  │Skill │  │Skill │    │  │
│                         │ └──────┘  └──────┘  └──────┘  └──────┘    │  │
│                         └────────────────────────────────────────────┘  │
│                                                                          │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                      Supporting Services                          │  │
│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │  │
│   │  │  Proactive │  │   Skill    │  │  Identity  │  │  Commerce  │  │  │
│   │  │   Engine   │  │ Management │  │  Service   │  │  Service   │  │  │
│   │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                         Data Layer                                │  │
│   │   PostgreSQL (users, profiles, messages, cases, subscriptions)   │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心引擎

### 3.1 CoreAgent

基于 Anthropic Agent 设计原则的对话引擎，是系统的核心。

**核心流程**：
```
用户消息 → CoreAgent.run()
    │
    ├─ 1. Skill 路由（LLM 自动选择或前端指定）
    │
    ├─ 2. 构建 System Prompt
    │      ├─ Skill 专家身份
    │      ├─ SOP 规则（配置驱动）
    │      ├─ 相关 Cases（倒排索引匹配）
    │      └─ 用户上下文（Profile + Skill Data）
    │
    ├─ 3. LLM 调用（支持 Tool Calling）
    │
    ├─ 4. 工具执行（ToolRegistry）
    │
    └─ 5. 流式输出（AI SDK Data Stream Protocol）
```

**关键特性**：
- **LLM 自动路由**：通过 `use_skill` 工具让 LLM 决定使用哪个 Skill
- **SOP 配置驱动**：从 SKILL.md 读取 `requires_birth_info`、`requires_compute` 等配置
- **Case 匹配**：使用倒排索引匹配相似案例，注入 System Prompt

### 3.2 Skill System

配置驱动的技能系统，支持自动发现。

**Skill 分类**：
```
┌─────────────────────────────────────────────────────────────┐
│  Core Layer (始终激活，不可取消)                              │
│  └─ core: 生命对话者 - AI 的灵魂                             │
├─────────────────────────────────────────────────────────────┤
│  Default Layer (默认激活，免费，可取消)                       │
│  ├─ mindfulness: 正念导师                                    │
│  └─ lifecoach: 人生教练                                      │
├─────────────────────────────────────────────────────────────┤
│  Professional Layer (需订阅，付费)                           │
│  ├─ bazi: 八字命理                                          │
│  ├─ zodiac: 西方占星                                        │
│  ├─ tarot: 塔罗占卜                                         │
│  ├─ jungastro: 荣格占星                                     │
│  └─ career: 职业规划                                        │
└─────────────────────────────────────────────────────────────┘
```

**Skill 目录结构**：
```
skills/{skill_id}/
├── SKILL.md              # Skill 定义（专家身份、触发词、配置）
├── rules/                # 规则文件（分析要点、输出要求）
│   ├── basic-reading.md
│   └── career.md
├── tools/                # 工具定义
│   ├── tools.yaml        # 工具 Schema
│   └── handlers.py       # 工具执行器
├── services/             # 领域服务
│   └── api.py            # API 服务（@skill_service 装饰器）
├── scenarios/            # 场景文件（旧架构兼容）
└── reminders.yaml        # 主动推送配置
```

### 3.3 Tool Registry

统一的工具注册表，支持自动发现。

**工具类型**：
| 类型 | 说明 | 示例 |
|------|------|------|
| collect | 收集用户信息 | request_info |
| calculate | 计算/排盘 | calculate_bazi |
| display | 展示结果 | show_bazi_chart |
| search | 知识检索 | search_db |
| action | 执行操作 | write_user_data |

**工具定义**（tools.yaml）：
```yaml
- name: show_bazi_chart
  description: 展示八字命盘
  tool_type: display
  card_type: BaziChart
  parameters:
    - name: chart
      type: object
      required: true
```

**工具执行器**（handlers.py）：
```python
@tool_handler("show_bazi_chart")
async def execute_show_bazi_chart(args: Dict, context: ToolContext) -> Dict:
    return {"cardType": "bazi_chart", **args}
```

---

## 4. 知识系统

### 4.1 Knowledge Base v2

基于 Case 倒排索引的知识检索系统，替代传统向量检索。

**核心概念**：
- **Cases**：从原文 LLM 抽取的结构化案例，存储在数据库中
- **倒排索引**：基于 tags 的内存索引，快速匹配相似案例
- **Rule 关联**：Cases 通过 `rule_ids` 关联到规则文件

**数据流**：
```
原文 (PDF/MD)
    │
    ▼ LLM 抽取
数据库: skill_cases 表
    │
    ▼ tags
Case 倒排索引（内存缓存）
    │
    ▼ 用户命盘特征匹配
System Prompt 注入
```

**Case 数据模型**：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | string | 案例 ID |
| skill_id | string | 所属 Skill |
| name | string | 案例名称 |
| tags | string[] | 特征标签（用于匹配） |
| rule_ids | string[] | 关联的规则 ID |
| content | text | 案例正文（Markdown） |

---

## 5. 主动模块

### 5.1 Proactive Engine

主动触达用户，增强粘性和业务转化。

**架构**：
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Scheduler  │───▶│   Engine    │───▶│  Delivery   │
│  (Cron)     │    │             │    │  (Push)     │
└─────────────┘    └──────┬──────┘    └─────────────┘
                          │
          ┌───────────────┼───────────────┐
          ▼               ▼               ▼
   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
   │  Trigger    │ │  Content    │ │ Subscription│
   │  Detector   │ │  Generator  │ │   Checker   │
   └─────────────┘ └─────────────┘ └─────────────┘
```

**触发器类型**：
| 类型 | 说明 | 示例 |
|------|------|------|
| time_based | 定时触发 | 每日运势 |
| event_based | 事件触发 | 生日、节气 |
| threshold_based | 阈值触发 | 运势低于 40 分 |
| emotion_based | 情绪触发 | 检测到焦虑 |
| skill_completion | 完成触发 | 深度对话后推荐 |

**配置示例**（reminders.yaml）：
```yaml
skill_id: bazi
enabled: true

reminders:
  - id: daily_fortune
    name: 每日运势
    trigger:
      type: time_based
      schedule: "0 4 * * *"
    content:
      generator: rules/daily-fortune.md
      suggested_prompt: "想了解今天的运势详情？"
      quick_actions:
        - label: "今日宜忌"
          prompt: "今天适合做什么？"
```

### 5.2 Skill Management

让用户发现、订阅、管理 Skill 的完整系统。

**发现入口**：
| 入口 | 位置 | 触发时机 |
|------|------|----------|
| Skill 市场 | /skills 页面 | 用户主动访问 |
| 对话推荐 | 对话流中 | AI 检测到相关意图 |
| 设置管理 | 设置页面 | 用户管理订阅 |
| 首页卡片 | 主页侧边栏 | 每次进入首页 |

**订阅状态与推送关系**：
| Skill 类别 | 订阅状态 | push_enabled | 是否推送 |
|-----------|---------|--------------|---------|
| core | - | - | 始终推送 |
| default | subscribed | true | 推送 |
| default | unsubscribed | - | 不推送 |
| professional | subscribed | true | 推送 |
| professional | 无/unsubscribed | - | 不推送 |

---

## 6. 用户体验

### 6.1 对话体验

**Core Skill 人格**：
- 温暖但不粘腻
- 智慧但不说教
- 好奇但不窥探
- 诚实但不伤害

**能力层次**：
1. **倾听与共情**：深度倾听、情绪感知、不评判
2. **记忆与累积**：跨对话记忆、模式识别、变化觉察
3. **引导探索**：苏格拉底式提问、重框架、联结
4. **适度引导**：知道边界、轻推、播种、庆祝

### 6.2 新用户流程

```
Landing → Loading → Aha Moment → Conversion
   │          │          │           │
   │          │          │           └─ 付费转化
   │          │          └─ 日主洞察 + 今日运势
   │          └─ 命盘渐进绘制 + 计算步骤展示
   └─ 零摩擦入口（键盘直接输入生辰）
```

### 6.3 ShowCard Fallback 机制

"专用优先，通用兜底"的卡片渲染策略：
1. 优先使用注册的专用组件
2. 不存在时根据 `fallbackType` 降级到通用视图
3. 智能推断：根据 data/items/nodes 等属性自动选择

**通用视图类型**：list, tree, table, timeline, form, select, chart, progress, counter, modal, toast, custom

---

## 7. 技术栈

### 7.1 后端

| 组件 | 技术 |
|------|------|
| 框架 | FastAPI (Python 3.11+) |
| 数据库 | PostgreSQL 16 + pgvector |
| LLM | DeepSeek / GLM / Claude (Anthropic 兼容 API) |
| 向量嵌入 | BAAI/bge-m3 (1024维，本地 CUDA) |

### 7.2 前端

| 组件 | 技术 |
|------|------|
| 框架 | Next.js 14 (App Router) |
| 语言 | TypeScript 5.3+ |
| 样式 | Tailwind CSS 3.4 |
| 动画 | Framer Motion |
| AI SDK | Vercel AI SDK 4.x |

### 7.3 LLM 模型配置

**唯一配置源**：`config/models.yaml`

```yaml
providers:
  deepseek:
    base_url: https://api.deepseek.com/anthropic
    is_anthropic_compatible: true
  glm:
    base_url: https://open.bigmodel.cn/api/anthropic/v1
    is_anthropic_compatible: true

routing:
  chat:
    free: deepseek-chat
    paid: deepseek-chat
    fallback: [glm-4.7]
```

---

## 8. API 架构

### 8.1 路由结构

```
routes/ (7 个核心路由文件)
├── health.py           # 健康检查
├── chat_v5.py          # CoreAgent 对话入口
├── tools.py            # 工具 Schema API
├── skills.py           # Skill Gateway（配置驱动）
├── account.py          # 用户域（认证、用户、访客、身份）
├── commerce.py         # 支付域（支付、订阅、权益）
└── notifications.py    # 通知域
```

### 8.2 核心端点

| 域 | 端点前缀 | 说明 |
|----|----------|------|
| Chat | `/api/v1/chat/v5/*` | CoreAgent 对话 |
| Skills | `/api/v1/skills/{skill}/{action}` | 统一 Skill Gateway |
| Account | `/api/v1/account/*` | 认证、用户、访客、身份 |
| Commerce | `/api/v1/commerce/*` | 支付、订阅、权益 |
| Tools | `/api/v1/tools/*` | 工具 Schema |
| Notifications | `/api/v1/notifications/*` | 通知管理 |

---

## 9. 数据模型

### 9.1 UserDataSpace - 数据空间划分

VibeLife 采用 UserDataSpace 统一管理用户数据，区分 **WHO**（画像）和 **WHAT**（操作）：

```
┌─────────────────────────────────────────────────────────────────┐
│                        UserDataSpace                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   VibeProfile (WHO)              Operational (WHAT)              │
│   ─────────────────              ──────────────────              │
│   用户是谁                       用户做了什么                    │
│   • unified_profiles             • conversations                 │
│                                  • messages                      │
│                                  • reports                       │
│                                  • notifications                 │
│                                  • subscriptions                 │
│                                  • payments                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 9.2 核心表

| 表 | 说明 | 数据类型 |
|----|------|----------|
| **VibeProfile (WHO)** | | |
| unified_profiles | 用户画像（JSONB） | WHO |
| vibe_profile_insights | AI 洞察（Cold Layer） | WHO |
| vibe_profile_timeline | 重要事件时间线 | WHO |
| **Operational (WHAT)** | | |
| vibe_users | 用户基本信息 | WHAT |
| conversations | 对话会话 | WHAT |
| messages | 对话消息 | WHAT |
| notifications | 通知记录 | WHAT |
| skill_cases | 知识案例（Case 系统） | WHAT |
| **Billing (WHAT)** | | |
| subscriptions | 付费订阅记录 | WHAT |
| payments | 支付记录 | WHAT |

### 9.3 VibeProfile 数据结构

**统一画像存储**（unified_profiles.profile JSONB）：

```yaml
profile:
  # 账户信息（从 vibe_users 同步）
  account:
    vibe_id: "VB-A1B2C3D4"
    display_name: "用户昵称"
    email: "user@example.com"
    tier: "free"                    # free | premium
    status: "active"

  # 身份信息
  identity:
    birth_info:
      date: "1990-05-15"
      time: "14:30"
      place: "北京"
      timezone: "Asia/Shanghai"
      gender: "male"

  # 当前状态
  state:
    emotion: "neutral"              # anxious | sad | neutral | content | excited
    focus: ["career"]               # 当前关注的话题
    life_stage: "career_growth"

  # 偏好设置
  preferences:
    voice_mode: "warm"
    language: "zh-CN"

    # Skill 订阅（整合 user_skill_subscriptions）
    subscribed_skills:
      bazi:
        status: "subscribed"        # subscribed | unsubscribed | not_subscribed
        push_enabled: true
        subscribed_at: "2026-01-01T00:00:00Z"
        trial_messages_used: 0
      zodiac:
        status: "subscribed"
        push_enabled: true
        subscribed_at: "2026-01-15T00:00:00Z"
        trial_messages_used: 0

    # 推送设置（整合 user_push_preferences）
    push_settings:
      default_push_hour: 8
      max_daily_pushes: 5
      quiet_start_hour: 22
      quiet_end_hour: 7

    # 数据保留策略
    data_retention:
      conversations: "1y"           # "1y" | "3y" | "forever"

    # Skill 推荐屏蔽
    blocked_skills: ["skill_id_1"]

  # Skill 数据
  skill_data:
    bazi:
      chart: { ... }
      features: { daymaster, strength, pattern }
      current_dayun: { ... }
      current_liunian: { ... }
    zodiac:
      chart: { ... }
      current_transits: { ... }
    tarot:
      last_reading: { ... }
    career:
      assessment: { ... }

  # 从对话抽取
  extracted:
    facts: ["在互联网公司工作", "有升职压力"]
    goals: ["年底升职"]             # 当前活跃目标摘要
    concerns: ["工作压力"]
    pain_points: ["工作生活平衡"]
    life_events: [...]
    patterns: [...]

  # 生活上下文（整合 user_data_store）
  life_context:
    # 基础信息
    occupation:
      title: "产品经理"
      industry: "互联网"
    focus_areas: ["career", "health"]

    # 目标管理
    goals:
      - id: "uuid-1"
        title: "年底升职到高级产品经理"
        category: "career"
        status: "active"            # active | completed | abandoned
        progress: 0.3
        deadline: "2026-12-31"
        created_at: "2026-01-01"

    # 任务管理
    tasks:
      - id: "uuid-a"
        title: "准备季度汇报"
        status: "pending"           # pending | done | cancelled
        due_date: "2026-01-25"
        goal_id: "uuid-1"

    # 打卡记录（只保留 30 天）
    checkins:
      "2026-01-19": { mood: 7, energy: 6, notes: "状态不错" }
      "2026-01-18": { mood: 5, energy: 4, notes: "有点累" }

    # 提醒
    reminders:
      - id: "uuid-r1"
        type: "goal_checkin"        # goal_checkin | daily_plan | custom
        title: "目标打卡提醒"
        schedule_type: "daily"      # once | daily | weekly
        trigger_hour: 20
        status: "active"            # active | paused
        goal_id: "uuid-1"

    # 追踪统计
    tracking:
      last_checkin: "2026-01-19"
      streak_days: 5
```

### 9.4 数据访问层

**UnifiedProfileRepository** 提供统一的 Profile 访问接口：

```python
class UnifiedProfileRepository:
    # 读取操作
    async def get_profile(user_id: UUID) -> Optional[Dict[str, Any]]
    async def get_birth_info(user_id: UUID) -> Dict[str, Any]
    async def get_skill_data(user_id: UUID, skill: str) -> Dict[str, Any]
    async def get_preferences(user_id: UUID) -> Dict[str, Any]
    async def get_identity_prism(user_id: UUID) -> Dict[str, Any]
    async def get_life_context(user_id: UUID) -> Dict[str, Any]
    async def get_extracted(user_id: UUID) -> Dict[str, Any]

    # 写入操作（使用 jsonb_set 局部更新）
    async def update_birth_info(user_id: UUID, birth_info: Dict[str, Any])
    async def update_skill_data(user_id: UUID, skill: str, data: Dict[str, Any])
    async def update_preferences(user_id: UUID, preferences: Dict[str, Any])
    async def update_identity_prism(user_id: UUID, identity_prism: Dict[str, Any])
    async def update_life_context(user_id: UUID, life_context: Dict[str, Any])
    async def update_extracted(user_id: UUID, extracted: Dict[str, Any])

    # 生活管理
    async def add_goal(user_id: UUID, goal: Dict)
    async def update_goal(user_id: UUID, goal_id: str, updates: Dict)
    async def add_task(user_id: UUID, task: Dict)
    async def update_task(user_id: UUID, task_id: str, updates: Dict)
    async def add_checkin(user_id: UUID, date: str, checkin: Dict)
    async def add_reminder(user_id: UUID, reminder: Dict)
    async def update_reminder(user_id: UUID, reminder_id: str, updates: Dict)

    # Skill 订阅管理
    async def get_skill_subscription(user_id: UUID, skill_id: str) -> Optional[SkillSubscription]
    async def subscribe(user_id: UUID, skill_id: str, push_enabled: bool) -> SkillSubscription
    async def unsubscribe(user_id: UUID, skill_id: str) -> SkillSubscription
    async def is_subscribed(user_id: UUID, skill_id: str) -> bool
    async def can_use_skill(user_id: UUID, skill_id: str, skill_category: str) -> tuple

    # 推送管理
    async def get_push_settings(user_id: UUID) -> Optional[UserPushPreferences]
    async def is_push_enabled(user_id: UUID, skill_id: str) -> bool
    async def get_users_with_push_enabled(skill_id: str) -> List[UUID]

    # 缓存管理
    async def _invalidate_cache(user_id: UUID, skill: str = None)
```

### 9.5 Skill 访问规则

| Skill | 可读 | 可写 |
|-------|------|------|
| **Core Layer** | | |
| core | 全部 | state, extracted |
| lifecoach | 全部 | state, extracted, life_context |
| mindfulness | 全部 | state |
| **Professional Layer** | | |
| bazi | identity, state | skill_data.bazi |
| zodiac | identity, state | skill_data.zodiac |
| tarot | identity, state | skill_data.tarot |
| career | identity, state, life_context | skill_data.career |

### 9.6 数据生命周期

| 领域 | 默认保留 | 用户可选 | 清理规则 |
|------|---------|---------|---------|
| **VibeProfile** | 永久 | - | checkins 保留 30 天 |
| **Conversations** | 1 年 | 1年 / 3年 / 永久 | 按 data_retention 设置清理 |
| **Content** | 永久 | 可手动删除 | - |
| **Billing** | 7 年 | 不可更改 | 法规要求 |
| **Logs** | 90 天 | - | 滚动清理 |
| **Notifications** | 30 天 | - | 已读 30 天后清理 |

---

## 10. 部署架构

### 10.1 环境配置

| 环境 | API 端口 | Web 端口 | 说明 |
|------|----------|----------|------|
| 开发 | 8000 | 3000 | 本地开发 |
| 测试 | 8100 | 8232 | aiscend 服务器 |
| 生产 | 8231 | 8230 | 分布式部署 |

### 10.2 生产部署

```
用户 (全球)
    │
    ▼
Cloudflare (边缘节点 + DDoS 防护)
    │
    ▼ HTTPS 加密隧道
火山引擎香港 (Nginx + Next.js)
    │
    ▼
北京服务器 (FastAPI + PostgreSQL)
```

---

## 附录

### A. AI SDK Data Stream Protocol

```
0:"text chunk"           # 文本块
9:{"toolCallId":"..."}   # 工具调用开始
a:{"toolCallId":"..."}   # 工具调用结果
e:{"finishReason":"..."}  # 完成
d:{"finishReason":"..."}  # 结束
```

### B. 添加新 Skill 流程

1. 创建目录：`skills/newskill/{SKILL.md, rules/, tools/, services/}`
2. 定义 SKILL.md：专家身份、触发词、配置
3. 创建工具：tools.yaml + handlers.py
4. 创建 API 服务：services/api.py（@skill_service 装饰器）
5. 配置推送：reminders.yaml
6. 重启服务 - 自动发现新 Skill

### C. 版本历史

- **V8.0** (2026-01-19): 整合 Knowledge v2、Skill Management、Proactive 模块
- **V7.1** (2026-01-18): LLM 自动路由、ShowCard Fallback 机制
- **V7.0** (2026-01-15): SkillServiceRegistry、统一 Skill Gateway、路由精简
