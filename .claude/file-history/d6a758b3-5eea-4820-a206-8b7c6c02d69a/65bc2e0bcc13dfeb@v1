#!/usr/bin/env python3
"""
Identity Prism æ¸…ç†è„šæœ¬

åŠŸèƒ½ï¼š
1. åˆ é™¤ prism_generator.py æ–‡ä»¶
2. ä¿®æ”¹ç›¸å…³ä»£ç æ–‡ä»¶ï¼Œç§»é™¤ identity_prism å¼•ç”¨
3. ç”Ÿæˆæ•°æ®åº“æ¸…ç† SQL
4. éªŒè¯æ¸…ç†å®Œæˆ

ä½¿ç”¨æ–¹æ³•ï¼š
    python scripts/cleanup_identity_prism.py --dry-run    # é¢„è§ˆæ›´æ”¹
    python scripts/cleanup_identity_prism.py --execute    # æ‰§è¡Œæ¸…ç†
"""

import os
import re
import sys
from pathlib import Path
from typing import List, Tuple

# é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT = Path(__file__).parent.parent
API_ROOT = PROJECT_ROOT


class IdentityPrismCleaner:
    """Identity Prism æ¸…ç†å™¨"""

    def __init__(self, dry_run: bool = True):
        self.dry_run = dry_run
        self.changes: List[Tuple[str, str]] = []  # (file_path, change_description)

    def run(self):
        """æ‰§è¡Œæ¸…ç†"""
        print("=" * 80)
        print("Identity Prism æ¸…ç†è„šæœ¬")
        print("=" * 80)
        print(f"æ¨¡å¼: {'DRY RUN (é¢„è§ˆ)' if self.dry_run else 'EXECUTE (æ‰§è¡Œ)'}")
        print()

        # Step 1: åˆ é™¤æ–‡ä»¶
        self._delete_prism_generator()

        # Step 2: ä¿®æ”¹ä»£ç æ–‡ä»¶
        self._cleanup_unified_profile_repo()
        self._cleanup_rag_service()
        self._cleanup_report_service()
        self._cleanup_skill_loader()
        self._cleanup_subagent()

        # Step 3: ç”Ÿæˆæ•°æ®åº“æ¸…ç† SQL
        self._generate_migration_sql()

        # Step 4: æ˜¾ç¤ºæ€»ç»“
        self._print_summary()

    def _delete_prism_generator(self):
        """åˆ é™¤ prism_generator.py"""
        file_path = API_ROOT / "services/identity/prism_generator.py"
        if file_path.exists():
            self.changes.append((str(file_path), "DELETE FILE"))
            if not self.dry_run:
                file_path.unlink()
                print(f"âœ… Deleted: {file_path}")
            else:
                print(f"ğŸ” Would delete: {file_path}")
        else:
            print(f"âš ï¸  File not found: {file_path}")

    def _cleanup_unified_profile_repo(self):
        """æ¸…ç† unified_profile_repo.py"""
        file_path = API_ROOT / "stores/unified_profile_repo.py"
        if not file_path.exists():
            print(f"âš ï¸  File not found: {file_path}")
            return

        content = file_path.read_text(encoding='utf-8')
        original = content

        # åˆ é™¤ get_identity_prism æ–¹æ³•
        content = re.sub(
            r'\s+@staticmethod\s+async def get_identity_prism\(.*?\n(?:.*?\n)*?.*?return \{\}',
            '',
            content,
            flags=re.DOTALL
        )

        # åˆ é™¤ update_identity_prism æ–¹æ³•
        content = re.sub(
            r'\s+@staticmethod\s+async def update_identity_prism\(.*?\n(?:.*?\n)*?.*?await UnifiedProfileRepository\._invalidate_cache.*?\n',
            '',
            content,
            flags=re.DOTALL
        )

        if content != original:
            self.changes.append((str(file_path), "REMOVE get_identity_prism(), update_identity_prism()"))
            if not self.dry_run:
                file_path.write_text(content, encoding='utf-8')
                print(f"âœ… Modified: {file_path}")
            else:
                print(f"ğŸ” Would modify: {file_path}")
        else:
            print(f"â„¹ï¸  No changes needed: {file_path}")

    def _cleanup_rag_service(self):
        """æ¸…ç† rag_service.py"""
        file_path = API_ROOT / "services/knowledge/rag_service.py"
        if not file_path.exists():
            print(f"âš ï¸  File not found: {file_path}")
            return

        content = file_path.read_text(encoding='utf-8')
        original = content

        # åˆ é™¤ identity_prism è¯»å–è¡Œ
        content = re.sub(
            r'.*identity\s*=\s*profile\.get\("identity_prism".*\n',
            '',
            content
        )

        if content != original:
            self.changes.append((str(file_path), "REMOVE identity_prism read"))
            if not self.dry_run:
                file_path.write_text(content, encoding='utf-8')
                print(f"âœ… Modified: {file_path}")
            else:
                print(f"ğŸ” Would modify: {file_path}")
        else:
            print(f"â„¹ï¸  No changes needed: {file_path}")

    def _cleanup_report_service(self):
        """æ¸…ç† report_service.py"""
        file_path = API_ROOT / "services/report/report_service.py"
        if not file_path.exists():
            print(f"âš ï¸  File not found: {file_path}")
            return

        content = file_path.read_text(encoding='utf-8')
        original = content

        # åˆ é™¤ identity_prism ç›¸å…³è¡Œï¼ˆåŒ…æ‹¬ TODO æ³¨é‡Šï¼‰
        content = re.sub(
            r'.*# TODO:.*PortraitService.*identity_prism.*\n.*identity_prism\s*=\s*profile\.get\("identity_prism".*\n',
            '',
            content
        )

        if content != original:
            self.changes.append((str(file_path), "REMOVE identity_prism TODO and read"))
            if not self.dry_run:
                file_path.write_text(content, encoding='utf-8')
                print(f"âœ… Modified: {file_path}")
            else:
                print(f"ğŸ” Would modify: {file_path}")
        else:
            print(f"â„¹ï¸  No changes needed: {file_path}")

    def _cleanup_skill_loader(self):
        """æ¸…ç† skill_loader.py"""
        file_path = API_ROOT / "services/agent/skill_loader.py"
        if not file_path.exists():
            print(f"âš ï¸  File not found: {file_path}")
            return

        content = file_path.read_text(encoding='utf-8')
        original = content

        # åˆ é™¤ identity_prism å¤„ç†å—
        content = re.sub(
            r'\s+# ç‰¹æ®Šå¤„ç† identity_prism\s+if user_context\.get\("identity_prism"\):.*?\n(?:.*?\n){0,10}?(?=\n\s+#|\n\s+return|\n\s+async def)',
            '\n',
            content,
            flags=re.DOTALL
        )

        if content != original:
            self.changes.append((str(file_path), "REMOVE identity_prism context handling"))
            if not self.dry_run:
                file_path.write_text(content, encoding='utf-8')
                print(f"âœ… Modified: {file_path}")
            else:
                print(f"ğŸ” Would modify: {file_path}")
        else:
            print(f"â„¹ï¸  No changes needed: {file_path}")

    def _cleanup_subagent(self):
        """æ¸…ç† subagent.py"""
        file_path = API_ROOT / "services/agent/subagent.py"
        if not file_path.exists():
            print(f"âš ï¸  File not found: {file_path}")
            return

        content = file_path.read_text(encoding='utf-8')
        original = content

        # åˆ é™¤ identity prism å¤„ç†å—
        content = re.sub(
            r'\s+# Add identity prism\s+if context\.profile:.*?prism = context\.profile\.get\("identity_prism".*?\n(?:.*?\n){0,5}?(?=\n\s+#|\n\s+return)',
            '\n',
            content,
            flags=re.DOTALL
        )

        if content != original:
            self.changes.append((str(file_path), "REMOVE identity_prism context"))
            if not self.dry_run:
                file_path.write_text(content, encoding='utf-8')
                print(f"âœ… Modified: {file_path}")
            else:
                print(f"ğŸ” Would modify: {file_path}")
        else:
            print(f"â„¹ï¸  No changes needed: {file_path}")

    def _generate_migration_sql(self):
        """ç”Ÿæˆæ•°æ®åº“æ¸…ç† SQL"""
        migration_file = API_ROOT / "stores/migrations/018_remove_identity_prism.sql"

        sql_content = """-- Identity Prism æ¸…ç†è¿ç§»
-- Created: 2026-01-19
-- åˆ é™¤ identity_prism å­—æ®µï¼ˆæœªä½¿ç”¨åŠŸèƒ½ï¼‰

BEGIN;

-- 1. ç»Ÿè®¡æ•°æ®
DO $$
DECLARE
    total_profiles INT;
    profiles_with_prism INT;
BEGIN
    SELECT COUNT(*) INTO total_profiles FROM unified_profiles;
    SELECT COUNT(*) INTO profiles_with_prism
    FROM unified_profiles
    WHERE profile ? 'identity_prism';

    RAISE NOTICE '========================================';
    RAISE NOTICE 'Identity Prism Cleanup Statistics:';
    RAISE NOTICE '  Total profiles: %', total_profiles;
    RAISE NOTICE '  Profiles with identity_prism: %', profiles_with_prism;
    RAISE NOTICE '========================================';
END $$;

-- 2. åˆ é™¤ identity_prism å­—æ®µ
UPDATE unified_profiles
SET profile = profile - 'identity_prism',
    updated_at = NOW()
WHERE profile ? 'identity_prism';

-- 3. éªŒè¯
DO $$
DECLARE
    remaining INT;
BEGIN
    SELECT COUNT(*) INTO remaining
    FROM unified_profiles
    WHERE profile ? 'identity_prism';

    IF remaining > 0 THEN
        RAISE WARNING 'Still % profiles with identity_prism remaining', remaining;
    ELSE
        RAISE NOTICE 'âœ“ All identity_prism fields removed successfully';
    END IF;
END $$;

-- 4. è®°å½•è¿ç§»
INSERT INTO migration_log (migration_name, description)
VALUES (
    '018_remove_identity_prism',
    'Removed identity_prism field from unified_profiles (unused feature replaced by VibeID)'
);

COMMIT;
"""

        self.changes.append((str(migration_file), "GENERATE SQL"))
        if not self.dry_run:
            migration_file.write_text(sql_content, encoding='utf-8')
            print(f"âœ… Generated: {migration_file}")
        else:
            print(f"ğŸ” Would generate: {migration_file}")

    def _print_summary(self):
        """æ‰“å°æ€»ç»“"""
        print()
        print("=" * 80)
        print("æ¸…ç†æ€»ç»“")
        print("=" * 80)
        print(f"æ€»å…±å½±å“æ–‡ä»¶: {len(self.changes)}")
        for file_path, change in self.changes:
            print(f"  - {Path(file_path).relative_to(API_ROOT)}: {change}")
        print()

        if self.dry_run:
            print("âš ï¸  è¿™æ˜¯ DRY RUNï¼Œæœªæ‰§è¡Œä»»ä½•æ›´æ”¹")
            print("æ‰§è¡Œæ¸…ç†è¯·è¿è¡Œ: python scripts/cleanup_identity_prism.py --execute")
        else:
            print("âœ… æ¸…ç†å®Œæˆï¼")
            print()
            print("ä¸‹ä¸€æ­¥:")
            print("  1. è¿è¡Œæµ‹è¯•: pytest apps/api/tests/ -v")
            print("  2. æ£€æŸ¥é—æ¼: grep -r 'identity_prism' apps/api --include='*.py'")
            print("  3. æ‰§è¡Œè¿ç§»: psql -U vibelife -d vibelife -f stores/migrations/018_remove_identity_prism.sql")
        print("=" * 80)


def main():
    """ä¸»å‡½æ•°"""
    if len(sys.argv) < 2:
        print("Usage:")
        print("  python scripts/cleanup_identity_prism.py --dry-run    # é¢„è§ˆæ›´æ”¹")
        print("  python scripts/cleanup_identity_prism.py --execute    # æ‰§è¡Œæ¸…ç†")
        sys.exit(1)

    mode = sys.argv[1]
    if mode == "--dry-run":
        cleaner = IdentityPrismCleaner(dry_run=True)
    elif mode == "--execute":
        response = input("âš ï¸  ç¡®è®¤è¦æ‰§è¡Œæ¸…ç†å—ï¼Ÿè¿™å°†ä¿®æ”¹ä»£ç æ–‡ä»¶ã€‚[y/N]: ")
        if response.lower() != 'y':
            print("å–æ¶ˆæ¸…ç†")
            sys.exit(0)
        cleaner = IdentityPrismCleaner(dry_run=False)
    else:
        print(f"âŒ æœªçŸ¥æ¨¡å¼: {mode}")
        sys.exit(1)

    cleaner.run()


if __name__ == "__main__":
    main()
