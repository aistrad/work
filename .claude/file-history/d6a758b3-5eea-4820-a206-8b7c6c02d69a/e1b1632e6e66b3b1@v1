#!/usr/bin/env python3
"""
æ‰§è¡Œ identity_prism æ¸…ç†è¿ç§»

Usage:
    python scripts/run_migration_018.py
"""

import asyncio
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import init_db, close_db, get_connection


async def run_migration():
    """æ‰§è¡Œè¿ç§»"""
    print("=" * 80)
    print("Identity Prism æ•°æ®åº“æ¸…ç†è¿ç§»")
    print("=" * 80)
    print()

    # åˆå§‹åŒ–æ•°æ®åº“è¿æ¥
    await init_db()

    try:
        # è¯»å–SQLæ–‡ä»¶
        sql_file = Path(__file__).parent.parent / "stores/migrations/018_remove_identity_prism.sql"

        if not sql_file.exists():
            print(f"âŒ è¿ç§»æ–‡ä»¶ä¸å­˜åœ¨: {sql_file}")
            return False

        sql_content = sql_file.read_text(encoding='utf-8')
        print(f"ğŸ“„ è¯»å–è¿ç§»æ–‡ä»¶: {sql_file.name}")
        print()

        # æ‰§è¡ŒSQL
        async with get_connection() as conn:
            print("ğŸ”„ æ‰§è¡Œè¿ç§»...")
            print()

            # ä½¿ç”¨ execute æ–¹æ³•æ‰§è¡Œå®Œæ•´çš„SQLï¼ˆåŒ…æ‹¬äº‹åŠ¡ï¼‰
            # PostgreSQL asyncpg ä¼šè‡ªåŠ¨å¤„ç† NOTICE æ¶ˆæ¯
            await conn.execute(sql_content)

            print()
            print("=" * 80)
            print("âœ… è¿ç§»æ‰§è¡ŒæˆåŠŸï¼")
            print("=" * 80)
            return True

    except Exception as e:
        print()
        print("=" * 80)
        print(f"âŒ è¿ç§»æ‰§è¡Œå¤±è´¥: {e}")
        print("=" * 80)
        import traceback
        traceback.print_exc()
        return False
    finally:
        await close_db()


async def verify_cleanup():
    """éªŒè¯æ¸…ç†ç»“æœ"""
    print()
    print("ğŸ” éªŒè¯æ¸…ç†ç»“æœ...")

    await init_db()

    try:
        async with get_connection() as conn:
            # æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ identity_prism å­—æ®µ
            count = await conn.fetchval("""
                SELECT COUNT(*)
                FROM unified_profiles
                WHERE profile ? 'identity_prism'
            """)

            total = await conn.fetchval("SELECT COUNT(*) FROM unified_profiles")

            print(f"  æ€» Profile æ•°: {total}")
            print(f"  å« identity_prism å­—æ®µ: {count}")

            if count == 0:
                print("  âœ… æ‰€æœ‰ identity_prism å­—æ®µå·²æ¸…é™¤")
                return True
            else:
                print(f"  âš ï¸  ä»æœ‰ {count} ä¸ª Profile åŒ…å« identity_prism")
                return False

    except Exception as e:
        print(f"  âŒ éªŒè¯å¤±è´¥: {e}")
        return False
    finally:
        await close_db()


async def main():
    """ä¸»å‡½æ•°"""
    success = await run_migration()

    if success:
        await verify_cleanup()

    return success


if __name__ == "__main__":
    result = asyncio.run(main())
    sys.exit(0 if result else 1)
