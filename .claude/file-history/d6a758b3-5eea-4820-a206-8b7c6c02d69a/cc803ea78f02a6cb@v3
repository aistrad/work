# VibeProfile å…¨é¢ Review æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´: 2026-01-19
> å®¡æŸ¥èŒƒå›´: è®¾è®¡æ–‡æ¡£ã€ä»£ç å®ç°ã€æ•°æ®è¿ç§»ã€å®é™…ä½¿ç”¨æƒ…å†µ
> å®¡æŸ¥åŸºå‡†: /docs/components/VibeProfile + /docs/archive/v8/ARCHITECTURE.md

---

## æ‰§è¡Œæ‘˜è¦

VibeProfile ä½œä¸º V8 çš„æ ¸å¿ƒé‡æ„ï¼ŒæˆåŠŸå®ç°äº† **WHO/WHAT æ•°æ®åˆ†ç¦»** å’Œ **JSONB ç»Ÿä¸€å­˜å‚¨**ï¼Œæ•´åˆäº† 5 å¼ å†å²è¡¨ï¼Œæ˜¾è‘—ç®€åŒ–äº†æ•°æ®æ¶æ„ã€‚ä½†åœ¨ **æ–‡æ¡£ä¸ä»£ç ä¸€è‡´æ€§**ã€**éƒ¨åˆ†åŠŸèƒ½å®Œæ•´æ€§** æ–¹é¢å­˜åœ¨é—®é¢˜ï¼Œéœ€è¦ä¼˜å…ˆä¿®å¤ã€‚

**æ€»ä½“è¯„åˆ†**: 7.5/10

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| è®¾è®¡åˆç†æ€§ | 8/10 | WHO/WHAT åˆ†ç¦»æ¸…æ™°ï¼ŒJSONB çµæ´»ï¼Œå±€éƒ¨æ›´æ–°ä¼˜åŒ–åˆ°ä½ |
| å®ç°å®Œæ•´æ€§ | 6/10 | æ ¸å¿ƒåŠŸèƒ½å®Œæ•´ï¼Œä½†æ–‡æ¡£æè¿°çš„éƒ¨åˆ†åŠŸèƒ½æœªå®ç° |
| æ–‡æ¡£ä¸€è‡´æ€§ | 5/10 | å¤šå¤„æ–‡æ¡£ä¸ä»£ç ä¸ä¸€è‡´ï¼Œå½±å“ç»´æŠ¤ |
| ä»£ç è´¨é‡ | 8/10 | å®ç°è§„èŒƒï¼Œæµ‹è¯•è¦†ç›–è‰¯å¥½ |
| å¯ç»´æŠ¤æ€§ | 7/10 | ç»“æ„æ¸…æ™°ï¼Œä½†å­˜åœ¨å‘½åæ··ä¹±å’ŒåŒé‡ç»“æ„ |

---

## 1. æ–‡æ¡£ä¸ä»£ç ä¸€è‡´æ€§åˆ†æ

### 1.1 ä¸¥é‡ä¸ä¸€è‡´ (éœ€ä¿®å¤)

#### âŒ Problem 1: `account` å­—æ®µç¼ºå¤±

**SPEC.md å®šä¹‰:**
```yaml
profile:
  account: { vibe_id, display_name, email, tier, status }  # ä» vibe_users åŒæ­¥
```

**ARCHITECTURE.md å®šä¹‰:**
```yaml
account: { vibe_id, display_name, tier, status }  # ä» vibe_users åŒæ­¥
```

**å®é™…ä»£ç :** `unified_profile_repo.py` ä¸­å®Œå…¨æ²¡æœ‰ `account` å­—æ®µ

**å½±å“:**
- éœ€è¦ JOIN `vibe_users` è¡¨æ‰èƒ½è·å– `vibe_id`ã€`tier` ç­‰åŸºæœ¬ä¿¡æ¯
- Proactive Engine æ— æ³•ä» Profile ç›´æ¥è¯»å–ç”¨æˆ·ç­‰çº§ï¼Œå½±å“ä¸ªæ€§åŒ–æ¨é€
- ä¸æ–‡æ¡£æ‰¿è¯ºçš„"ç»Ÿä¸€ç”»åƒ"è®¾è®¡ç†å¿µä¸ç¬¦

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P0**
- åœ¨ Profile åˆ›å»º/æ›´æ–°æ—¶åŒæ­¥ `vibe_users` çš„åŸºæœ¬å­—æ®µ
- æ·»åŠ è§¦å‘å™¨æˆ–å®šæœŸåŒæ­¥æœºåˆ¶

---

#### âŒ Problem 2: `state` å­—æ®µå®Œå…¨ç¼ºå¤±

**SPEC.md å®šä¹‰:**
```yaml
state:
  emotion: "neutral"              # anxious | sad | neutral | content | excited
  focus: ["career"]               # å½“å‰å…³æ³¨çš„è¯é¢˜
  life_stage: "career_growth"
```

**å®é™…ä»£ç :** å®Œå…¨æœªå®ç°

**å½±å“:**
- æ— æ³•å­˜å‚¨ç”¨æˆ·å½“å‰æƒ…ç»ªçŠ¶æ€ã€å…³æ³¨ç‚¹ã€ç”Ÿå‘½é˜¶æ®µ
- Proactive Engine æ— æ³•åŸºäºç”¨æˆ·çŠ¶æ€è¿›è¡Œæƒ…ç»ªåŒ–è§¦å‘ï¼ˆå¦‚ `emotion_based` è§¦å‘å™¨ï¼‰
- Core Skill æ— æ³•è®°å½•å’Œè¿½è¸ªç”¨æˆ·çŠ¶æ€å˜åŒ–

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P1**
- æ·»åŠ  `state` é¡¶å±‚å­—æ®µ
- æä¾› `update_state()` æ–¹æ³•
- åœ¨ CoreAgent å¯¹è¯ä¸­æŠ½å–å¹¶æ›´æ–° `state`

---

#### âŒ Problem 3: `identity` vs `birth_info` å‘½åä¸ä¸€è‡´

**SPEC.md:** `identity.birth_info`
**ARCHITECTURE.md:** `identity.birth_info`
**å®é™…ä»£ç :** `birth_info` (é¡¶å±‚å­—æ®µ)

**å½±å“:**
- æ–‡æ¡£ä¸ä»£ç å‘½åä¸ä¸€è‡´
- å¦‚æœæœªæ¥æ‰©å±• `identity` çš„å…¶ä»–å­å­—æ®µï¼ˆå¦‚èº«ä»½è¯ä¿¡æ¯ï¼‰ï¼Œéœ€è¦é‡æ„

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P2**
- ç»Ÿä¸€å‘½åä¸º `identity.birth_info`
- æä¾›å…¼å®¹å±‚å¤„ç†æ—§æ•°æ®

---

#### âš ï¸ Problem 4: `subscribed_skills` æ•°æ®ç»“æ„ä¸ä¸€è‡´

**SPEC.md å®šä¹‰:** æ•°ç»„
```yaml
subscribed_skills: ["core", "bazi", "zodiac"]
```

**ARCHITECTURE.md å®šä¹‰:** å¯¹è±¡
```yaml
subscribed_skills:
  bazi: { status, push_enabled, subscribed_at, trial_messages_used }
```

**å®é™…ä»£ç :** å¯¹è±¡ï¼ˆä¸ ARCHITECTURE.md ä¸€è‡´ï¼‰
```python
"subscribed_skills": {
    "bazi": {
        "status": "subscribed",
        "push_enabled": true,
        ...
    }
}
```

**å½±å“:**
- SPEC.md è¯¯å¯¼å¼€å‘è€…
- ç®€åŒ–ç‰ˆï¼ˆæ•°ç»„ï¼‰æ— æ³•å­˜å‚¨è®¢é˜…æ—¶é—´ã€æ¨é€å¼€å…³ç­‰å…ƒæ•°æ®

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P1**
- æ›´æ–° SPEC.md ä¸ºå¯¹è±¡ç»“æ„
- ç»Ÿä¸€ä¸¤ä»½æ–‡æ¡£

---

#### âš ï¸ Problem 5: `push_enabled` å’Œ `push_hour` ä½ç½®ä¸ä¸€è‡´

**SPEC.md:** é¡¶å±‚ `preferences` ä¸‹
```yaml
preferences:
  push_enabled: true
  push_hour: 8
```

**å®é™…ä»£ç :** åµŒå¥—åœ¨ `push_settings` å¯¹è±¡å†…
```python
"preferences": {
    "push_settings": {
        "default_push_hour": 8,
        "max_daily_pushes": 5,
        "quiet_start_hour": 22,
        "quiet_end_hour": 7
    }
}
```

**å½±å“:**
- SPEC çš„æ‰å¹³åŒ–è®¾è®¡æ— æ³•æ”¯æŒé™é»˜æ—¶æ®µç­‰é«˜çº§é…ç½®
- ä»£ç å®ç°æ›´åˆç†ï¼Œä½†æ–‡æ¡£éœ€æ›´æ–°

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P1**
- æ›´æ–° SPEC.md ä½¿ç”¨ `push_settings` å¯¹è±¡

---

### 1.2 æ–‡æ¡£ç¼ºå¤± (éœ€è¡¥å……)

#### âœ… Removed: `identity_prism` å­—æ®µå·²æ ‡è®°åˆ é™¤

**åŸè®¾è®¡:** å¤šç»´åº¦èº«ä»½èåˆï¼ˆå…«å­— + æ˜Ÿåº§ï¼‰
```python
# services/identity/prism_generator.py - 197è¡Œï¼Œæœªè¢«è°ƒç”¨
await UnifiedProfileRepository.update_identity_prism(user_id, fused_data)
```

**å®é™…çŠ¶å†µ:**
- âŒ æ— ä»»ä½•è°ƒç”¨å…¥å£ï¼ˆ`update_from_dimension()` ä»æœªè¢«è§¦å‘ï¼‰
- âš ï¸ report_service æ˜ç¡®æ³¨é‡Šï¼š"PortraitService å·²å½’æ¡£ï¼Œidentity_prism å¾…é‡æ„"
- âœ… VibeID å·²å®ç°ç›¸åŒåŠŸèƒ½ï¼ˆ`skill_data.vibe_id`ï¼‰

**æ¸…ç†æ–¹æ¡ˆ:**
- ä¼˜å…ˆçº§: **P1**
- åˆ é™¤æ–‡æ¡£: `/docs/components/VibeProfile/IDENTITY_PRISM_CLEANUP.md`
- æ¸…ç†è„šæœ¬: `/apps/api/scripts/cleanup_identity_prism.py`
- å½±å“: 1ä¸ªæ–‡ä»¶åˆ é™¤ + 5ä¸ªæ–‡ä»¶ä¿®æ”¹ + æ•°æ®åº“å­—æ®µæ¸…ç†

---

#### ğŸ“ Missing 2: `life_context._paths` æœºåˆ¶æ— æ–‡æ¡£

**å®é™…ä»£ç :** ä½¿ç”¨è™šæ‹Ÿè·¯å¾„ç³»ç»Ÿ
```python
await UnifiedProfileRepository.read_life_context_path(user_id, "goals/2026/year")
```

**æ–‡æ¡£:** æœªæåŠè·¯å¾„åŒ–å­˜å‚¨æœºåˆ¶

**å½±å“:**
- å¼€å‘è€…ä¸çŸ¥é“ä½•æ—¶ä½¿ç”¨ `life_context.goals` vs `life_context._paths`
- åŒé‡ç»“æ„å®¹æ˜“æ··æ·†

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P1**
- åœ¨ SPEC.md è¯´æ˜ `_paths` æœºåˆ¶çš„è®¾è®¡ç›®çš„
- æä¾›ä½¿ç”¨æŒ‡å—ï¼ˆä½•æ—¶ç”¨è·¯å¾„ï¼Œä½•æ—¶ç”¨å›ºå®šå­—æ®µï¼‰

---

## 2. å®ç°å®Œæ•´æ€§åˆ†æ

### 2.1 å·²å®Œæ•´å®ç° âœ…

| åŠŸèƒ½æ¨¡å— | å®ç°çŠ¶æ€ | ä»£ç ä½ç½® |
|---------|---------|---------|
| Profile CRUD | âœ… å®Œæ•´ | `unified_profile_repo.py` |
| Skill è®¢é˜…ç®¡ç† | âœ… å®Œæ•´ | `unified_profile_repo.py` L498-826 |
| æ¨é€åå¥½ç®¡ç† | âœ… å®Œæ•´ | `unified_profile_repo.py` L828-929 |
| Skill å±è”½ | âœ… å®Œæ•´ | `unified_profile_repo.py` L931-1005 |
| Life Context è·¯å¾„ | âœ… å®Œæ•´ | `unified_profile_repo.py` L1007-1190 |
| ç¼“å­˜ç³»ç»Ÿ | âœ… å®Œæ•´ | `profile_cache.py` |
| æ•°æ®è¿ç§» | âœ… å®Œæ•´ | `scripts/migrate_to_unified_profile.py` |
| Proactive Engine é›†æˆ | âœ… å®Œæ•´ | `services/proactive/engine.py` |
| Skill API é›†æˆ | âœ… å®Œæ•´ | `skills/{bazi,zodiac,vibe_id}/services/api.py` |

---

### 2.2 éƒ¨åˆ†å®ç° âš ï¸

#### âš ï¸ Partial 1: Goals/Tasks/Checkins/Reminders

**SPEC.md å®šä¹‰:** å®Œæ•´çš„ç”Ÿæ´»ç®¡ç† API
```yaml
life_context:
  goals: [{ id, title, category, status, progress, deadline }]
  tasks: [{ id, title, status, due_date, goal_id }]
  checkins: { "2026-01-19": { mood, energy, notes } }
  reminders: [{ id, type, title, schedule_type, trigger_hour }]
```

**å®é™…å®ç°:**
- âœ… Repository æ–¹æ³•å­˜åœ¨: `add_goal()`, `update_goal()`, `add_task()`, `add_checkin()`, `add_reminder()`
- âŒ HTTP API ç¼ºå¤±: æœªæš´éœ² REST API ç«¯ç‚¹
- âŒ å‰ç«¯é›†æˆç¼ºå¤±: Web ç«¯æ— æ³•è°ƒç”¨

**å½±å“:**
- åŠŸèƒ½å¯ç”¨ä½†æ— å…¥å£
- ç”¨æˆ·æ— æ³•é€šè¿‡ç•Œé¢ç®¡ç†ç›®æ ‡ã€ä»»åŠ¡ã€æ‰“å¡

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P2**
- æ·»åŠ  `/api/v1/profile/goals`, `/api/v1/profile/checkins` ç­‰ç«¯ç‚¹
- å‚è€ƒ SPEC.md Section 8 çš„ API å®šä¹‰

---

#### âš ï¸ Partial 2: Checkins 30å¤©è‡ªåŠ¨æ¸…ç†

**SPEC.md å®šä¹‰:** `checkins` åªä¿ç•™ 30 å¤©

**å®é™…å®ç°:**
- âœ… Repository æ–¹æ³•å­˜åœ¨: `cleanup_old_checkins(user_id, keep_days=30)`
- âŒ Worker æœªè°ƒç”¨: æ— å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ¸…ç†

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P2**
- åœ¨ ProactiveWorker æˆ–æ–°å»º CleanupWorker ä¸­è°ƒç”¨
- æ¯æ—¥å‡Œæ™¨ 05:00 æ‰§è¡Œ

---

### 2.3 å®Œå…¨ç¼ºå¤± âŒ

#### âŒ Missing 1: `vibe_profile_insights` è¡¨æœªä½¿ç”¨

**SPEC.md å®šä¹‰:** Cold Layerï¼Œå­˜å‚¨ AI æ´å¯Ÿ
```sql
CREATE TABLE vibe_profile_insights (
    insight_type VARCHAR(50),  -- discovery | pattern | timing | growth
    content TEXT,
    ...
)
```

**å®é™…æƒ…å†µ:** è¡¨å·²åˆ›å»ºï¼Œä½†å®Œå…¨æœªä½¿ç”¨

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P3**
- å®ç° AI æ´å¯Ÿç”Ÿæˆé€»è¾‘
- åœ¨å¯¹è¯ä¸­æŠ½å–æ·±åº¦æ´å¯Ÿå¹¶å­˜å‚¨

---

#### âŒ Missing 2: `vibe_profile_timeline` è¡¨æœªä½¿ç”¨

**SPEC.md å®šä¹‰:** é‡è¦äº‹ä»¶æ—¶é—´çº¿
```sql
CREATE TABLE vibe_profile_timeline (
    event_type VARCHAR(50),  -- dayun_change | goal_completed | milestone
    ...
)
```

**å®é™…æƒ…å†µ:** è¡¨å·²åˆ›å»ºï¼Œä½†å®Œå…¨æœªä½¿ç”¨

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P3**
- åœ¨å…³é”®äº‹ä»¶ï¼ˆå¤§è¿åˆ‡æ¢ã€ç›®æ ‡å®Œæˆï¼‰æ—¶è®°å½•
- æä¾›æ—¶é—´çº¿ API

---

#### âŒ Missing 3: `data_retention` è‡ªåŠ¨æ¸…ç†

**SPEC.md å®šä¹‰:** ç”¨æˆ·å¯é€‰å¯¹è¯ä¿ç•™ç­–ç•¥
```yaml
data_retention:
  conversations: "1y" | "3y" | "forever"
```

**å®é™…å®ç°:**
- âœ… é…ç½®å­—æ®µå­˜åœ¨
- âŒ æ¸…ç†é€»è¾‘ç¼ºå¤±

**å½±å“:**
- é…ç½®æ— å®é™…ä½œç”¨
- æ•°æ®åº“æŒç»­å¢é•¿

**å»ºè®®:**
- ä¼˜å…ˆçº§: **P2**
- å®ç° `ConversationCleanupWorker`
- æ¯å‘¨æ‰§è¡Œä¸€æ¬¡ï¼ŒæŒ‰ç”¨æˆ· `data_retention` è®¾ç½®å½’æ¡£/åˆ é™¤

---

## 3. è®¾è®¡åˆç†æ€§è¯„ä¼°

### 3.1 ä¼˜ç§€è®¾è®¡ âœ…

#### âœ… Good 1: WHO/WHAT æ•°æ®åˆ†ç¦»

æ¸…æ™°çš„é¢†åŸŸåˆ’åˆ†ï¼š
- VibeProfile (WHO): ç”¨æˆ·ç”»åƒ
- Operational (WHAT): ç”¨æˆ·è¡Œä¸º

**ä¼˜ç‚¹:**
- å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- Profile æ›´æ–°ä¸å½±å“æ“ä½œæ•°æ®

---

#### âœ… Good 2: JSONB å±€éƒ¨æ›´æ–°

ä½¿ç”¨ `jsonb_set()` é¿å…å…¨é‡è¯»å†™ï¼š
```sql
UPDATE unified_profiles
SET profile = jsonb_set(
    profile,
    '{skill_data, bazi}',
    $1::jsonb
)
WHERE user_id = $2
```

**ä¼˜ç‚¹:**
- æ€§èƒ½ä¼˜åŒ–ï¼Œå‡å°‘ DB è´Ÿè½½
- å‡å°‘å¹¶å‘å†²çª

---

#### âœ… Good 3: ç¼“å­˜å¤±æ•ˆç­–ç•¥

```python
await UnifiedProfileRepository._invalidate_cache(user_id, skill)
```

- Skill çº§ç¼“å­˜å¤±æ•ˆï¼šæ›´æ–° `skill_data.bazi` åªå¤±æ•ˆ bazi ç¼“å­˜
- å…¨å±€å¤±æ•ˆï¼šæ›´æ–° `birth_info` å¤±æ•ˆæ‰€æœ‰ç¼“å­˜

**ä¼˜ç‚¹:**
- ç²¾ç»†åŒ–æ§åˆ¶ï¼Œé¿å…è¿‡åº¦å¤±æ•ˆ

---

#### âœ… Good 4: è¯•ç”¨æœºåˆ¶

```python
"trial_messages_used": 3
```

- å†…ç½®è¯•ç”¨æ¬¡æ•°è¿½è¸ª
- æ”¯æŒ Skill çµæ´»è¯•ç”¨ç­–ç•¥

---

#### âœ… Good 5: æ·±åº¦åˆå¹¶

```python
def deep_merge(base: Dict, update: Dict) -> Dict:
    """é€’å½’åˆå¹¶åµŒå¥—å­—å…¸"""
```

- æ”¯æŒéƒ¨åˆ†æ›´æ–°åµŒå¥—æ•°æ®
- ä¿ç•™æœªæ›´æ–°çš„å­—æ®µ

---

### 3.2 æœ‰é—®é¢˜çš„è®¾è®¡ âš ï¸

#### âš ï¸ Issue 1: `life_context` åŒé‡ç»“æ„

åŒæ—¶å­˜åœ¨å›ºå®šå­—æ®µå’Œ `_paths`:
```python
"life_context": {
    "goals": [],           # å›ºå®šå­—æ®µ
    "tasks": [],
    "_paths": {            # è™šæ‹Ÿè·¯å¾„
        "goals/2026/year": {...}
    }
}
```

**é—®é¢˜:**
- ä½•æ—¶ç”¨å›ºå®šå­—æ®µï¼Œä½•æ—¶ç”¨ `_paths`ï¼Ÿ
- ä¸¤è€…æ•°æ®å¯èƒ½é‡å¤

**å»ºè®®:**
- æ˜ç¡®ä½¿ç”¨åœºæ™¯ï¼šå›ºå®šå­—æ®µç”¨äº Proactive å¿«é€Ÿè®¿é—®ï¼Œ`_paths` ç”¨äºçµæ´»æ‰©å±•
- æ·»åŠ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥

---

#### âš ï¸ Issue 2: `account` ç¼ºå¤±å¯¼è‡´é¢å¤– JOIN

```python
# éœ€è¦ JOIN vibe_users è·å– vibe_id
SELECT up.profile, vu.vibe_id, vu.tier
FROM unified_profiles up
JOIN vibe_users vu ON up.user_id = vu.id
```

**é—®é¢˜:**
- è¿èƒŒ"ç»Ÿä¸€ç”»åƒ"è®¾è®¡
- å¢åŠ æŸ¥è¯¢å¤æ‚åº¦

**å»ºè®®:**
- åœ¨ Profile ä¸­å†—ä½™å­˜å‚¨ `account` åŸºæœ¬å­—æ®µ
- ä½¿ç”¨è§¦å‘å™¨ä¿æŒåŒæ­¥

---

#### âš ï¸ Issue 3: `subscribed_skills` vs æ•°ç»„æ€§èƒ½

å½“å‰å®ç°ä¸ºå¯¹è±¡:
```python
"subscribed_skills": {
    "bazi": {...},
    "zodiac": {...}
}
```

**é—®é¢˜:**
- è·å–å·²è®¢é˜…åˆ—è¡¨éœ€éå†å¯¹è±¡
- æ— æ³•ä½¿ç”¨ PostgreSQL JSONB æ•°ç»„æ“ä½œç¬¦

**ä¼˜ç‚¹:**
- æ”¯æŒå…ƒæ•°æ®ï¼ˆ`push_enabled`, `subscribed_at`ï¼‰

**ç»“è®º:** å½“å‰è®¾è®¡åˆç†ï¼ŒSPEC.md éœ€æ›´æ–°

---

## 4. ä»£ç è´¨é‡è¯„ä¼°

### 4.1 ä¼˜ç‚¹ âœ…

- âœ… **ç±»å‹æ³¨è§£å®Œæ•´**: æ‰€æœ‰æ–¹æ³•éƒ½æœ‰ç±»å‹æç¤º
- âœ… **æ–‡æ¡£å­—ç¬¦ä¸²æ¸…æ™°**: Docstring è¯´æ˜å‚æ•°å’Œè¿”å›å€¼
- âœ… **é”™è¯¯å¤„ç†å®Œå–„**: æ•è·å¼‚å¸¸å¹¶è®°å½•æ—¥å¿—
- âœ… **æµ‹è¯•è¦†ç›–**: 200+ è¡Œå•å…ƒæµ‹è¯• (`test_unified_profile_repo.py`)
- âœ… **æ•°æ®ç±»ä½¿ç”¨**: `SkillSubscription`, `UserPushPreferences` æå‡å¯è¯»æ€§

---

### 4.2 æ”¹è¿›ç©ºé—´ âš ï¸

#### âš ï¸ Issue 1: ç¼ºå°‘è®¿é—®æ§åˆ¶

```python
async def update_skill_data(user_id: UUID, skill: str, data: Dict):
    """æ— æƒé™æ£€æŸ¥ï¼Œä»»ä½•è°ƒç”¨æ–¹éƒ½å¯ä¿®æ”¹ä»»æ„ Skill æ•°æ®"""
```

**å»ºè®®:**
- æ·»åŠ  Skill è®¿é—®è§„åˆ™éªŒè¯
- å‚è€ƒ SPEC.md Section 5 çš„è®¿é—®çŸ©é˜µ

---

#### âš ï¸ Issue 2: ç¼ºå°‘æ•°æ®éªŒè¯

```python
async def update_birth_info(user_id: UUID, birth_info: Dict):
    """ä¸éªŒè¯ birth_info å­—æ®µï¼Œå¯èƒ½å†™å…¥éæ³•æ•°æ®"""
```

**å»ºè®®:**
- ä½¿ç”¨ Pydantic Model éªŒè¯è¾“å…¥
- æ£€æŸ¥å¿…å¡«å­—æ®µå’Œæ•°æ®ç±»å‹

---

#### âš ï¸ Issue 3: é­”æ³•æ•°å­—å’Œç¡¬ç¼–ç 

```python
DEFAULT_TTL = 300  # åº”æå–ä¸ºé…ç½®
MAX_GOALS = 20     # åº”åœ¨ SPEC.md ä¸­æ˜ç¡®
```

**å»ºè®®:**
- ç§»å…¥é…ç½®æ–‡ä»¶
- åœ¨æ–‡æ¡£ä¸­è¯´æ˜é™åˆ¶ç†ç”±

---

## 5. è¿ç§»å®Œæ•´æ€§æ£€æŸ¥

### 5.1 è¿ç§»è„šæœ¬åˆ†æ

**æ–‡ä»¶:** `scripts/migrate_to_unified_profile.py`

#### âœ… å·²å®Œæ•´è¿ç§»

| æºè¡¨ | ç›®æ ‡å­—æ®µ | çŠ¶æ€ |
|------|---------|------|
| user_skill_subscriptions | `preferences.subscribed_skills` | âœ… |
| user_push_preferences | `preferences.push_settings` | âœ… |
| user_data_store | `life_context._paths` | âœ… |
| skill_recommendation_blocks | `preferences.blocked_skills` | âœ… |

---

### 5.2 æ¸…ç†è„šæœ¬åˆ†æ

**æ–‡ä»¶:** `stores/migrations/017_drop_legacy_profile_tables.sql`

#### âœ… å®‰å…¨æªæ–½å®Œå–„

1. äº‹åŠ¡åŒ…è£¹
2. æ•°æ®éªŒè¯ï¼ˆæ‰“å°è¡Œæ•°ï¼‰
3. CASCADE åˆ é™¤ä¾èµ–
4. è¿ç§»æ—¥å¿—è®°å½•

---

## 6. Proactive é›†æˆåˆ†æ

### 6.1 é›†æˆç‚¹ âœ…

**æ–‡ä»¶:** `services/proactive/engine.py`

```python
# 1. è·å– Profile
profile = await UnifiedProfileRepository.get_profile(user_id)

# 2. æ£€æŸ¥è®¢é˜…
subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)

# 3. ä¸ªæ€§åŒ–å†…å®¹
content = await self.content_generator.generate(profile=profile, ...)
```

#### âœ… è®¾è®¡åˆç†

- Profile æ˜¯å”¯ä¸€æ•°æ®æº
- æ”¯æŒ Skill çº§æ¨é€å¼€å…³
- æ”¯æŒç”¨æˆ·æœ¬åœ°æ—¶åŒºå’Œæ¨é€åå¥½

---

### 6.2 ç¼ºå¤±åŠŸèƒ½ âš ï¸

#### âš ï¸ Missing: `state` å­—æ®µè§¦å‘å™¨

**ARCHITECTURE.md å®šä¹‰:**
```yaml
è§¦å‘å™¨ç±»å‹:
  emotion_based: æƒ…ç»ªè§¦å‘ - æ£€æµ‹åˆ°ç„¦è™‘
```

**å®é™…æƒ…å†µ:** `state` å­—æ®µä¸å­˜åœ¨ï¼Œæ— æ³•å®ç°

**å»ºè®®:**
- å®ç° `state` å­—æ®µ
- åœ¨ TriggerDetector ä¸­æ·»åŠ æƒ…ç»ªæ£€æµ‹é€»è¾‘

---

#### âš ï¸ Missing: `life_context.reminders` è§¦å‘

**SPEC.md æµç¨‹:**
```python
reminders = profile["life_context"]["reminders"]
for reminder in reminders:
    if should_trigger_today(reminder):
        create_notification(...)
```

**å®é™…æƒ…å†µ:** `reminders` å­—æ®µå­˜åœ¨ä½†æœªé›†æˆåˆ° ProactiveEngine

**å»ºè®®:**
- åœ¨ `_detect_user_triggers()` ä¸­æ£€æŸ¥ `life_context.reminders`
- ç”Ÿæˆç”¨æˆ·è‡ªå®šä¹‰æé†’

---

## 7. æ€§èƒ½è¯„ä¼°

### 7.1 ç¼“å­˜æ€§èƒ½ âœ…

**å®ç°:** `profile_cache.py`

- TTL: 5 åˆ†é’Ÿ
- å‘½ä¸­ç‡ç»Ÿè®¡: `get_stats()`
- æŒ‰å‰ç¼€å¤±æ•ˆ: æ”¯æŒæ‰¹é‡å¤±æ•ˆ

#### âœ… è®¾è®¡åˆç†

- åˆ† Skill ç¼“å­˜ï¼Œå‡å°‘å¤±æ•ˆèŒƒå›´
- å¼‚æ­¥é”ä¿è¯å¹¶å‘å®‰å…¨

---

### 7.2 JSONB æ€§èƒ½ âš ï¸

#### âš ï¸ Concern 1: æ·±å±‚åµŒå¥—è·¯å¾„

```sql
jsonb_set(
    jsonb_set(
        profile,
        '{preferences}',
        ...
    ),
    '{preferences, subscribed_skills}',
    ...
)
```

**æ½œåœ¨é—®é¢˜:**
- å¤šå±‚åµŒå¥—å¯èƒ½å½±å“æ€§èƒ½
- å»ºè®®ç›‘æ§æ…¢æŸ¥è¯¢

---

#### âš ï¸ Concern 2: æ— ç´¢å¼•ä¼˜åŒ–

**å½“å‰ç´¢å¼•:**
```sql
CREATE INDEX idx_unified_profiles_birth_info
ON unified_profiles USING GIN (profile);
```

**é—®é¢˜:** GIN ç´¢å¼•è¦†ç›–æ•´ä¸ª JSONBï¼Œæœªé’ˆå¯¹é«˜é¢‘æŸ¥è¯¢ä¼˜åŒ–

**å»ºè®®:**
- æ·»åŠ ç‰¹å®šå­—æ®µç´¢å¼•ï¼š
```sql
CREATE INDEX idx_profiles_subscribed_skills
ON unified_profiles ((profile -> 'preferences' -> 'subscribed_skills'));
```

---

## 8. æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

### P0 - ç«‹å³ä¿®å¤

1. **è¡¥å…… `account` å­—æ®µ** (å½±å“ç”¨æˆ·ç­‰çº§åˆ¤æ–­)
   - æ·»åŠ å­—æ®µå®šä¹‰
   - å®ç°åŒæ­¥é€»è¾‘
   - æ›´æ–°æ–‡æ¡£

2. **ç»Ÿä¸€æ–‡æ¡£å‘½å** (`identity` vs `birth_info`)
   - ç»Ÿä¸€ä¸º `identity.birth_info`
   - æä¾›è¿ç§»è·¯å¾„

---

### P1 - è¿‘æœŸå®Œæˆ (1-2å‘¨)

3. **å®ç° `state` å­—æ®µ**
   - æ·»åŠ  emotion, focus, life_stage
   - é›†æˆåˆ° CoreAgent å¯¹è¯æŠ½å–
   - æ”¯æŒæƒ…ç»ªåŒ–è§¦å‘å™¨

4. **æ›´æ–° SPEC.md**
   - ä¿®æ­£ `subscribed_skills` ä¸ºå¯¹è±¡
   - ä¿®æ­£ `push_settings` ç»“æ„
   - è¡¥å…… `identity_prism` æ–‡æ¡£
   - è¡¥å…… `life_context._paths` è¯´æ˜

5. **æ¸…ç† `identity_prism` ä»£ç å’Œæ•°æ®**
   - è¿è¡Œæ¸…ç†è„šæœ¬
   - æ‰§è¡Œæ•°æ®åº“è¿ç§»
   - éªŒè¯æ¸…ç†å®Œæˆ

---

### P2 - ä¸­æœŸå®Œæˆ (1ä¸ªæœˆ)

6. **å®ç° Goals/Tasks API**
   - æ·»åŠ  HTTP ç«¯ç‚¹
   - å‰ç«¯é›†æˆ

7. **å®ç°æ•°æ®æ¸…ç† Worker**
   - `data_retention` å¯¹è¯æ¸…ç†
   - `checkins` 30å¤©æ¸…ç†

8. **æ·»åŠ æ•°æ®éªŒè¯**
   - Pydantic Models
   - å­—æ®µç±»å‹å’ŒèŒƒå›´æ£€æŸ¥

---

### P3 - é•¿æœŸä¼˜åŒ– (3ä¸ªæœˆ)

9. **ä½¿ç”¨ `vibe_profile_insights` è¡¨**
   - AI æ´å¯Ÿç”Ÿæˆ
   - å±•ç¤º API

10. **ä½¿ç”¨ `vibe_profile_timeline` è¡¨**
    - å…³é”®äº‹ä»¶è®°å½•
    - æ—¶é—´çº¿ API

11. **æ€§èƒ½ä¼˜åŒ–**
    - æ·»åŠ  JSONB ç‰¹å®šå­—æ®µç´¢å¼•
    - ç›‘æ§æ…¢æŸ¥è¯¢
    - ä¼˜åŒ–æ·±å±‚åµŒå¥—æ›´æ–°

---

## 9. æ€»ç»“

### 9.1 ä¸»è¦æˆå°± âœ…

1. **æˆåŠŸæ•´åˆ 5 å¼ å†å²è¡¨** åˆ°å•ä¸€ JSONB Profile
2. **WHO/WHAT åˆ†ç¦»** è®¾è®¡æ¸…æ™°ï¼Œæ˜“äºç†è§£
3. **å±€éƒ¨æ›´æ–°ä¼˜åŒ–** æ˜¾è‘—æå‡æ€§èƒ½
4. **å®Œæ•´çš„è¿ç§»æ–¹æ¡ˆ** ä¿è¯æ•°æ®å®‰å…¨
5. **Proactive ç³»ç»Ÿé›†æˆ** å®ç°ä¸»åŠ¨æ¨é€

---

### 9.2 å…³é”®é—®é¢˜ âš ï¸

1. **æ–‡æ¡£ä¸ä»£ç ä¸¥é‡ä¸ä¸€è‡´** (5+ å¤„)
2. **æ ¸å¿ƒå­—æ®µç¼ºå¤±** (`account`, `state`)
3. **éƒ¨åˆ†åŠŸèƒ½æœªæš´éœ²** (Goals/Tasks API)
4. **æ•°æ®æ¸…ç†æœªå®ç°** (`data_retention`, `checkins`)

---

### 9.3 è¡ŒåŠ¨è®¡åˆ’

#### æœ¬å‘¨ (Week 1)

- [ ] ä¿®å¤ SPEC.md æ‰€æœ‰ä¸ä¸€è‡´ (P1)
- [ ] è¡¥å…… `account` å­—æ®µè®¾è®¡å’Œå®ç° (P0)
- [ ] ç»Ÿä¸€ `identity` å‘½å (P0)

#### ä¸‹å‘¨ (Week 2)

- [ ] å®ç° `state` å­—æ®µ (P1)
- [ ] æ¸…ç† `identity_prism` ä»£ç å’Œæ•°æ® (P1)
- [ ] è¡¥å…… `life_context._paths` æ–‡æ¡£ (P1)

#### ä¸‹ä¸ªæœˆ (Month 1)

- [ ] å®ç° Goals/Tasks HTTP API (P2)
- [ ] å®ç°æ•°æ®æ¸…ç† Worker (P2)
- [ ] æ·»åŠ æ•°æ®éªŒè¯å±‚ (P2)

---

## é™„å½•

### A. æ–‡æ¡£æ›´æ–° Checklist

- [ ] `/docs/components/VibeProfile/SPEC.md` - ä¿®æ­£ 8 å¤„ä¸ä¸€è‡´
- [ ] `/docs/archive/v8/ARCHITECTURE.md` - è¡¥å…… 3 å¤„ç¼ºå¤±
- [x] `/docs/components/VibeProfile/IDENTITY_PRISM_CLEANUP.md` - æ¸…ç†æ–¹æ¡ˆï¼ˆå·²åˆ›å»ºï¼‰
- [ ] æ–°å»º `/docs/components/VibeProfile/LIFE_CONTEXT_PATHS.md` - è·¯å¾„æœºåˆ¶

### B. ä»£ç æ”¹è¿› Checklist

- [ ] `unified_profile_repo.py` - æ·»åŠ  `account` åŒæ­¥
- [ ] `unified_profile_repo.py` - æ·»åŠ  `state` ç®¡ç†
- [ ] `unified_profile_repo.py` - æ·»åŠ æ•°æ®éªŒè¯
- [x] `scripts/cleanup_identity_prism.py` - æ¸…ç†è„šæœ¬ï¼ˆå·²åˆ›å»ºï¼‰
- [ ] æ‰§è¡Œ identity_prism æ¸…ç†
- [ ] æ–°å»º `routes/profile.py` - Goals/Tasks API
- [ ] æ–°å»º `workers/cleanup_worker.py` - æ•°æ®æ¸…ç†
- [ ] `services/proactive/trigger_detector.py` - æƒ…ç»ªè§¦å‘å™¨

### C. æ€§èƒ½ç›‘æ§ Checklist

- [ ] æ·»åŠ  JSONB æ“ä½œè€—æ—¶æ—¥å¿—
- [ ] ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- [ ] æ·»åŠ æ…¢æŸ¥è¯¢å‘Šè­¦
- [ ] ä¼˜åŒ–é«˜é¢‘æŸ¥è¯¢ç´¢å¼•

---

**å®¡æŸ¥å®Œæˆæ—¶é—´:** 2026-01-19
**ä¸‹æ¬¡å®¡æŸ¥æ—¶é—´:** 2026-02-19 (P0-P1 å®Œæˆå)
