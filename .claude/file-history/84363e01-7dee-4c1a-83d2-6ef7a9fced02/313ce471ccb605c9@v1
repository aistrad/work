# VibeLife Chat æµç¨‹æ–‡æ¡£

> åŸºäº v3 æ¶æ„ä»£ç åˆ†æï¼Œ2026-01-07

## æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FRONTEND (Next.js)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    onSend()    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  ChatInput   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  ChatContainer   â”‚                       â”‚
â”‚  â”‚  (textarea)  â”‚                â”‚   handleSend()   â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                           â”‚                                  â”‚
â”‚                                           â–¼                                  â”‚
â”‚                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                                  â”‚    api.ts        â”‚                       â”‚
â”‚                                  â”‚  sendMessage()   â”‚                       â”‚
â”‚                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                           â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚ POST /api/v1/chat/
                                            â”‚ Authorization: Bearer {token}
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              BACKEND (FastAPI)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚  routes/chat.py  â”‚  POST /chat/                                          â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                         â”‚
â”‚  â”‚  1. parse_skill()                                                        â”‚
â”‚  â”‚  2. get_user_profile()                                                   â”‚
â”‚  â”‚  3. get_conversation_history()                                           â”‚
â”‚  â”‚  4. save_message(user)                                                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚              VIBE ENGINE (services/vibe_engine/)           â”‚             â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚             â”‚
â”‚  â”‚  â”‚  context.py     â”‚      â”‚  llm.py                     â”‚  â”‚             â”‚
â”‚  â”‚  â”‚  ContextBuilder â”‚ â”€â”€â”€â–º â”‚  LLMService                 â”‚  â”‚             â”‚
â”‚  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚  â”‚             â”‚
â”‚  â”‚  â”‚  â€¢ system_promptâ”‚      â”‚  â€¢ Zhipu (primary)         â”‚  â”‚             â”‚
â”‚  â”‚  â”‚  â€¢ topicåˆ†ç±»    â”‚      â”‚  â€¢ Claude (fallback)       â”‚  â”‚             â”‚
â”‚  â”‚  â”‚  â€¢ profileé€‰æ‹©  â”‚      â”‚  â€¢ Gemini (backup)         â”‚  â”‚             â”‚
â”‚  â”‚  â”‚  â€¢ historyæ ¼å¼åŒ–â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚             â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚           â”‚                                                                  â”‚
â”‚           â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚  5. save_message â”‚  (assistant response)                                 â”‚
â”‚  â”‚  6. return JSON  â”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            â”‚
                                            â”‚ ChatResponse JSON
                                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FRONTEND: ChatContainer receives response                                   â”‚
â”‚  â†’ setMessages([...prev, assistantMessage])                                 â”‚
â”‚  â†’ ChatMessage renders assistant bubble                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¯¦ç»†æµç¨‹åˆ†è§£

### 1. å‰ç«¯è¾“å…¥å±‚

```
ChatInput.tsx                         ChatContainer.tsx
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ <textarea>         â”‚   Enteré”®     â”‚ handleSend(content)             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç”¨æˆ·è¾“å…¥æ¶ˆæ¯    â”‚ â”‚               â”‚ â”‚ 1. åˆ›å»º userMessage         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚ â”‚ 2. setMessages(prev+user)   â”‚ â”‚
â”‚ [ğŸ¤] [ğŸ“·] [å‘é€]  â”‚               â”‚ â”‚ 3. setIsLoading(true)       â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â”‚ 4. await sendMessage(...)   â”‚ â”‚
                                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä»£ç **: `apps/web/src/components/chat/ChatContainer.tsx:224-299`

```typescript
const handleSend = async (content: string) => {
  // 1. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°çŠ¶æ€
  const userMessage: Message = {
    id: Date.now().toString(),
    role: "user",
    content,
    timestamp: new Date().toLocaleTimeString(),
  };
  setMessages((prev) => [...prev, userMessage]);
  setIsLoading(true);

  // 2. å‘é€åˆ°åç«¯
  const response: ChatResponse = await sendMessage({
    message: content,
    skill_id: skillId,
    conversation_id: currentConvoId,
  });

  // 3. å¤„ç†æ–°ä¼šè¯åˆ›å»º
  if (!currentConvoId && response.conversation_id) {
    setCurrentConvoId(response.conversation_id);
  }

  // 4. æ˜¾ç¤ºåŠ©æ‰‹å“åº”
  const assistantMessage: Message = {
    id: (Date.now() + 1).toString(),
    role: "assistant",
    content: response.content,
    insight: response.insight,
  };
  setMessages((prev) => [...prev, assistantMessage]);
};
```

---

### 2. API è°ƒç”¨å±‚

**å…³é”®ä»£ç **: `apps/web/src/lib/api.ts:208-220`

```typescript
export async function sendMessage(request: ChatRequest): Promise<ChatResponse> {
  const response = await fetchAPI("/chat/", {
    method: "POST",
    body: JSON.stringify(request),
  });
  return response.json();
}
```

**è¯·æ±‚ç»“æ„**:
```typescript
interface ChatRequest {
  message: string;              // ç”¨æˆ·è¾“å…¥
  skill_id: string;            // "bazi" | "zodiac"
  conversation_id?: string;    // UUIDï¼Œç»­èŠæ—¶æä¾›
}
```

**å“åº”ç»“æ„**:
```typescript
interface ChatResponse {
  content: string;             // åŠ©æ‰‹å“åº”
  conversation_id: string;     // UUID
  intent?: string;
  tools_used?: string[];
  knowledge_used: boolean;
  insight?: {                  // å¯é€‰æ´å¯Ÿå¡ç‰‡
    id: string;
    insight_type: string;
    title: string;
    content: string;
  };
}
```

---

### 3. åç«¯è·¯ç”±å¤„ç†

**å…³é”®ä»£ç **: `apps/api/routes/chat.py:220-273`

```
@router.post("/chat/") å¤„ç†æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                              â”‚
â”‚  ChatRequest                    å¤„ç†æµç¨‹                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ message        â”‚            â”‚ 1. parse_skill()       â”‚   â”‚
â”‚  â”‚ skill          â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚    "bazi" â†’ Skill.BAZI â”‚   â”‚
â”‚  â”‚ conversation_idâ”‚            â”‚                        â”‚   â”‚
â”‚  â”‚ voice_mode     â”‚            â”‚ 2. get_user_profile()  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    ä» profile_repo è·å– â”‚   â”‚
â”‚                                â”‚                        â”‚   â”‚
â”‚                                â”‚ 3. get_conversation_   â”‚   â”‚
â”‚                                â”‚    history() æœ€è¿‘20æ¡   â”‚   â”‚
â”‚                                â”‚                        â”‚   â”‚
â”‚                                â”‚ 4. save_message()      â”‚   â”‚
â”‚                                â”‚    ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° DB    â”‚   â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯·æ±‚æ¨¡å‹** (Python):
```python
class ChatRequest(BaseModel):
    message: str
    skill: str  # "bazi" or "zodiac"
    conversation_id: Optional[UUID] = None
    voice_mode: Optional[str] = "warm"  # warm | sarcastic
```

**å“åº”æ¨¡å‹**:
```python
class ChatResponse(BaseModel):
    content: str
    conversation_id: UUID
    skill: str
    voice_mode: str
    metadata: Optional[dict] = None  # model, usage
```

---

### 4. Vibe Engine - ä¸Šä¸‹æ–‡æ„å»º

**å…³é”®ä»£ç **: `apps/api/services/vibe_engine/context.py:342-394`

```
ContextBuilder.build() å¤„ç†æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  è¾“å…¥                           è¾“å‡º                                   â”‚
â”‚  â”€â”€â”€â”€â”€                          â”€â”€â”€â”€                                   â”‚
â”‚  â€¢ skill (BAZI/ZODIAC)          system_prompt:                        â”‚
â”‚  â€¢ voice_mode (WARM/SARCASTIC)  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â€¢ current_message               â”‚ # Vibe äººè®¾                     â”‚    â”‚
â”‚  â€¢ profile (ç”¨æˆ·ç”»åƒ)            â”‚ ä½ æ˜¯ Vibeï¼Œç”¨æˆ·çš„çŸ¥å·±...        â”‚    â”‚
â”‚  â€¢ history (å¯¹è¯å†å²)            â”‚                                 â”‚    â”‚
â”‚                                  â”‚ # å…«å­—æŠ€èƒ½ä¸Šä¸‹æ–‡                â”‚    â”‚
â”‚  å¤„ç†æ­¥éª¤:                       â”‚ ä½ æ˜¯èµ„æ·±å‘½ç†å¸ˆ...              â”‚    â”‚
â”‚  1. build_system_prompt()        â”‚                                 â”‚    â”‚
â”‚  2. classify_topic() â†’ Topic     â”‚ # è¯­æ°”æ¨¡å¼                     â”‚    â”‚
â”‚     â€¢ CAREER (å·¥ä½œç›¸å…³)          â”‚ å…±æƒ…ã€æ”¯æŒã€é¼“åŠ±...            â”‚    â”‚
â”‚     â€¢ RELATIONSHIP (æ„Ÿæƒ…)        â”‚                                 â”‚    â”‚
â”‚     â€¢ FORTUNE (è¿åŠ¿)             â”‚ # ç”¨æˆ·ç”»åƒ (XML)               â”‚    â”‚
â”‚     â€¢ SELF (æ€§æ ¼)                â”‚ <profile>...</profile>         â”‚    â”‚
â”‚     â€¢ GENERAL (é€šç”¨)             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  3. select_profile_sections()                                          â”‚
â”‚     æŒ‰ topic é€‰æ‹©ç›¸å…³ç”»åƒç‰‡æ®µ    messages[]:                          â”‚
â”‚  4. format_profile_context()     [system, history..., user_msg]       â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯é¢˜åˆ†ç±»è§„åˆ™**:
- CAREER: å·¥ä½œ, èŒä¸š, äº‹ä¸š, åˆ›ä¸š, é¢è¯•
- RELATIONSHIP: æ„Ÿæƒ…, æ‹çˆ±, å©šå§», å®¶äºº
- FORTUNE: è¿åŠ¿, å¤§è¿, æµå¹´, ä»€ä¹ˆæ—¶å€™
- SELF: æ€§æ ¼, ä¼˜ç‚¹, ç¼ºç‚¹, äº†è§£è‡ªå·±
- GENERAL: é»˜è®¤

**æŒ‰è¯é¢˜é€‰æ‹©ç”»åƒç‰‡æ®µ**:
- CAREER â†’ career + growth_areas
- RELATIONSHIP â†’ relationship + relationship_patterns + communication_style
- FORTUNE â†’ current_focus + recent_events
- SELF â†’ all ai_insights
- GENERAL â†’ current_focus + personality_traits

---

### 5. Vibe Engine - LLM è°ƒç”¨

**å…³é”®ä»£ç **: `apps/api/services/vibe_engine/llm.py:304-370`

```
LLMService.chat() è°ƒç”¨æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                          â”‚  Primary: Zhipu â”‚                          â”‚
â”‚  messages[] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚  glm-4-plus     â”‚                          â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                   â”‚                                    â”‚
â”‚                          æˆåŠŸ?    â”‚    å¤±è´¥?                          â”‚
â”‚                            â”‚      â”‚      â”‚                            â”‚
â”‚                            â–¼      â”‚      â–¼                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                     â”‚ è¿”å›å“åº”  â”‚  â”‚  â”‚ Fallback: Claudeâ”‚              â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ claude-sonnet   â”‚              â”‚
â”‚                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                   â”‚           â”‚                        â”‚
â”‚                                   â”‚    å¤±è´¥?  â”‚  æˆåŠŸ?                â”‚
â”‚                                   â”‚      â”‚    â”‚    â”‚                  â”‚
â”‚                                   â”‚      â–¼    â”‚    â–¼                  â”‚
â”‚                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                                   â”‚  â”‚ Raise Exception  â”‚             â”‚
â”‚                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**LLM é…ç½®**:
```python
@dataclass
class LLMConfig:
    zhipu_api_key: str          # Primary: Zhipu GLM-4-Plus
    zhipu_base_url: str         # https://open.bigmodel.cn/api/paas/v4
    zhipu_chat_model: str       # glm-4-plus
    claude_api_key: str         # Backup: Claude
    claude_model: str           # claude-3-5-sonnet-20241022
    default_provider: LLMProvider = LLMProvider.ZHIPU
```

**LLM å“åº”ç»“æ„**:
```python
@dataclass
class LLMResponse:
    content: str                    # ç”Ÿæˆæ–‡æœ¬
    model: str                      # ä½¿ç”¨çš„æ¨¡å‹
    provider: LLMProvider           # ZHIPU | CLAUDE | GEMINI
    usage: Optional[Dict[str, int]] # {input_tokens, output_tokens}
    finish_reason: Optional[str]    # "stop" | "length"
```

---

### 6. å“åº”è¿”å›

```
                    Backend                              Frontend
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  save_message(assistant, resp)   â”‚    â”‚  ChatContainer                   â”‚
â”‚              â”‚                   â”‚    â”‚                                  â”‚
â”‚              â–¼                   â”‚    â”‚  response = await sendMessage()  â”‚
â”‚  return ChatResponse {           â”‚â”€â”€â”€â–ºâ”‚              â”‚                   â”‚
â”‚    content: "æ ¹æ®ä½ çš„å…«å­—...",   â”‚    â”‚              â–¼                   â”‚
â”‚    conversation_id: uuid,        â”‚    â”‚  if (!currentConvoId) {          â”‚
â”‚    skill: "bazi",                â”‚    â”‚    setCurrentConvoId(resp.id)    â”‚
â”‚    voice_mode: "warm",           â”‚    â”‚  }                               â”‚
â”‚    metadata: {model, usage}      â”‚    â”‚              â”‚                   â”‚
â”‚  }                               â”‚    â”‚              â–¼                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  setMessages([...prev, {         â”‚
                                        â”‚    role: "assistant",            â”‚
                                        â”‚    content: resp.content,        â”‚
                                        â”‚    insight: resp.insight         â”‚
                                        â”‚  }])                             â”‚
                                        â”‚              â”‚                   â”‚
                                        â”‚              â–¼                   â”‚
                                        â”‚  ChatMessage renders             â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æµè½¬ç¤ºæ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å®Œæ•´æ•°æ®æµè½¬                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ç”¨æˆ·è¾“å…¥          å‰ç«¯ Request            åç«¯ Request                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€         â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
â”‚  "æˆ‘æ˜¯90å¹´         {                       ChatRequest(                     â”‚
â”‚   5æœˆ15æ—¥           message: "...",         message="...",                  â”‚
â”‚   å‡ºç”Ÿçš„"           skill_id: "bazi",       skill="bazi",                   â”‚
â”‚                     conversation_id:null    conversation_id=None,          â”‚
â”‚                   }                         voice_mode="warm"              â”‚
â”‚                                           )                                 â”‚
â”‚                                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                              â”‚
â”‚  LLM Messages                                                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  [                                                                          â”‚
â”‚    {role: "system", content: "# Vibe äººè®¾\nä½ æ˜¯Vibe..."},                  â”‚
â”‚    {role: "user", content: "[å†å²] ä½ å¥½"},                                  â”‚
â”‚    {role: "assistant", content: "[å†å²] ä½ å¥½å‘€ï¼..."},                      â”‚
â”‚    {role: "user", content: "æˆ‘æ˜¯90å¹´5æœˆ15æ—¥å‡ºç”Ÿçš„"}   â† current            â”‚
â”‚  ]                                                                          â”‚
â”‚                                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                              â”‚
â”‚  åç«¯ Response             å‰ç«¯ Response           UI æ¸²æŸ“                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€            â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚  ChatResponse(             {                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    content="æ ¹æ®...",       content: "æ ¹æ®...",    â”‚ ğŸ‘¤ æˆ‘æ˜¯90å¹´...   â”‚     â”‚
â”‚    conversation_id=uuid,    conversation_id:uuid,  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚    skill="bazi",            skill: "bazi",         â”‚ ğŸ”® æ ¹æ®ä½ çš„      â”‚     â”‚
â”‚    voice_mode="warm",       metadata: {...}        â”‚    å…«å­—...       â”‚     â”‚
â”‚    metadata={...}         }                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  )                                                                          â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®ä»£ç æ–‡ä»¶æ¸…å•

| å±‚çº§ | æ–‡ä»¶è·¯å¾„ | æ ¸å¿ƒåŠŸèƒ½ |
|------|----------|----------|
| å‰ç«¯è¾“å…¥ | `apps/web/src/components/chat/ChatInput.tsx` | æ–‡æœ¬è¾“å…¥æ¡†ç»„ä»¶ |
| å‰ç«¯å®¹å™¨ | `apps/web/src/components/chat/ChatContainer.tsx` | æ¶ˆæ¯çŠ¶æ€ç®¡ç†ã€APIè°ƒç”¨ |
| å‰ç«¯æ¶ˆæ¯ | `apps/web/src/components/chat/ChatMessage.tsx` | æ¶ˆæ¯æ°”æ³¡æ¸²æŸ“ |
| APIå®¢æˆ·ç«¯ | `apps/web/src/lib/api.ts` | HTTPè¯·æ±‚å°è£…ã€tokenç®¡ç† |
| åç«¯è·¯ç”± | `apps/api/routes/chat.py` | `/chat/` ç«¯ç‚¹å¤„ç† |
| ä¸Šä¸‹æ–‡æ„å»º | `apps/api/services/vibe_engine/context.py` | system promptã€è¯é¢˜åˆ†ç±» |
| LLMè°ƒç”¨ | `apps/api/services/vibe_engine/llm.py` | Zhipu/Claude è°ƒç”¨ |
| ç”¨æˆ·ç”»åƒ | `apps/api/services/vibe_engine/portrait.py` | profile æ•°æ®ç»“æ„ |
| ä¼šè¯å­˜å‚¨ | `apps/api/stores/conversation_repo.py` | ä¼šè¯æŒä¹…åŒ– |
| æ¶ˆæ¯å­˜å‚¨ | `apps/api/stores/message_repo.py` | æ¶ˆæ¯æŒä¹…åŒ– |

---

## è¯­æ°”æ¨¡å¼ç³»ç»Ÿ

### WARM æ¨¡å¼ (é»˜è®¤)
- é£æ ¼: å…±æƒ…ã€æ”¯æŒã€é¼“åŠ±
- ç”¨è¯: "æˆ‘æ„Ÿè§‰åˆ°", "ä½ å¯èƒ½", "å€¼å¾—å°è¯•"
- åƒæ¸©æš–çš„æœ‹å‹èŠå¤©

### SARCASTIC æ¨¡å¼
- é£æ ¼: ç›´æ¥ã€çŠ€åˆ©ã€æœ‰è¶£
- ç”¨è¯: "å¾—äº†å§", "è¯´ç™½äº†", "å…¸å‹çš„..."
- åƒæ¯’èˆŒä½†å…³å¿ƒä½ çš„æœ‹å‹

---

## ç”¨æˆ·ç”»åƒç»“æ„

```python
DEFAULT_PROFILE = {
    "version": "1.0",
    "basic": {
        "birth_datetime": None,    # å‡ºç”Ÿæ—¶é—´
        "birth_location": None,    # å‡ºç”Ÿåœ°ç‚¹
        "gender": None,
        "name": None,
        "occupation": None
    },
    "life_context": {
        "career": {...},           # èŒä¸šä¿¡æ¯
        "relationship": {...},     # æ„Ÿæƒ…çŠ¶æ€
        "current_focus": [],       # å½“å‰å…³æ³¨ç‚¹
        "life_stage": None,
        "recent_events": []
    },
    "ai_insights": {
        "personality_traits": [],  # æ€§æ ¼ç‰¹ç‚¹
        "communication_style": None,
        "emotional_patterns": {...},
        "relationship_patterns": {...},
        "growth_areas": []
    },
    "identity_prism": {
        "core": {...},             # æ ¸å¿ƒé©±åŠ¨
        "inner": {...},            # å†…åœ¨å…³æ³¨
        "outer": {...}             # å¤–åœ¨è¡¨ç°
    }
}
```

---

## é…ç½®å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| å†å²æ¶ˆæ¯é™åˆ¶ | 20æ¡ | get_conversation_history limit |
| Profileä¸Šä¸‹æ–‡ | ~1000 tokens | ç”»åƒç‰‡æ®µå¤§å°é™åˆ¶ |
| æ€»Tokené¢„ç®— | 8000 | å®Œæ•´ä¸Šä¸‹æ–‡çª—å£ |
| å“åº”Token | 4096 | max_tokens é»˜è®¤å€¼ |
| Primary LLM | glm-4-plus | Zhipu æ™ºè°± |
| Fallback LLM | claude-sonnet | Anthropic Claude |

---

## å¾…ç¡®è®¤é—®é¢˜

1. **å­—æ®µåæ˜ å°„**: å‰ç«¯å‘é€ `skill_id`ï¼Œåç«¯æ¨¡å‹æ¥æ”¶ `skill`ï¼Œæ˜¯å¦åœ¨æŸå¤„åšäº†æ˜ å°„ï¼Ÿ
2. **æµå¼ç«¯ç‚¹**: `/chat/stream` SSE ç«¯ç‚¹æ˜¯å¦å¯ç”¨ï¼Ÿå½“å‰ ChatContainer ä½¿ç”¨éæµå¼è°ƒç”¨
3. **è®¤è¯æ¨¡å¼**: Guest `/chat/guest` vs Authenticated `/chat/`ï¼Œå½“å‰ä¸»è¦ä½¿ç”¨å“ªç§ï¼Ÿ
