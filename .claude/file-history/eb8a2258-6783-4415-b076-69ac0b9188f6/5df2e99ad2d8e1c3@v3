"use client";

import { useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { cn } from "@/lib/utils";
import { ChevronDown, ChevronUp, Sparkles, RefreshCw, Clock, Sprout } from "lucide-react";
import { VibeGlyph, type SkillType } from "@/components/core";
import { InsightCard, MiniInsightCard, type InsightType } from "./InsightCard";

// ═══════════════════════════════════════════════════════════════════════════
// InsightPanel - LUMINOUS PAPER Design System
// 左侧洞察面板：显示用户命盘/星盘摘要 + 洞察卡片列表
// PC端显示为固定侧边栏，移动端显示为可折叠顶部卡片
// ═══════════════════════════════════════════════════════════════════════════

// Bazi profile summary for demo
interface BaziProfile {
  dayMaster: string;
  pattern: string;
  currentLuck: string;
  pillars: {
    year: { stem: string; branch: string };
    month: { stem: string; branch: string };
    day: { stem: string; branch: string };
    hour?: { stem: string; branch: string };
  };
}

interface ZodiacProfile {
  sunSign: string;
  moonSign?: string;
  risingSign?: string;
  currentTransit?: string;
}

interface MbtiProfile {
  type: string;
  dominantFunction?: string;
  secondaryFunction?: string;
}

// Generic profile type
type ProfileData = BaziProfile | ZodiacProfile | MbtiProfile | null;

interface InsightItem {
  id: string;
  type: InsightType;
  title: string;
  content: string;
}

export interface InsightPanelProps {
  skill: SkillType;
  profile?: ProfileData;
  insights?: InsightItem[];
  onViewFullProfile?: () => void;
  onInsightClick?: (insight: InsightItem) => void;
  className?: string;
}

// Skill-specific profile display
const SKILL_PROFILE_LABELS: Record<SkillType, {
  title: string;
  viewFullLabel: string;
}> = {
  bazi: { title: "你的命盘", viewFullLabel: "查看完整命盘" },
  zodiac: { title: "你的星盘", viewFullLabel: "查看完整星盘" },
  mbti: { title: "你的人格档案", viewFullLabel: "查看完整档案" },
  attach: { title: "你的依恋档案", viewFullLabel: "查看完整档案" },
  career: { title: "你的职业档案", viewFullLabel: "查看完整档案" },
};

// ═══════════════════════════════════════════════════════════════════════════
// BaziProfileCard - 八字命盘摘要卡片
// ═══════════════════════════════════════════════════════════════════════════
function BaziProfileCard({ profile, onViewFull }: { profile: BaziProfile; onViewFull?: () => void }) {
  return (
    <div className="glass-card rounded-xl p-4 space-y-4">
      {/* Pillars */}
      <div className="grid grid-cols-3 gap-2 text-center">
        <div className="space-y-1">
          <span className="text-xs text-muted-foreground">年柱</span>
          <div className="font-serif text-lg text-foreground">{profile.pillars.year.stem}</div>
          <div className="font-serif text-base text-muted-foreground">{profile.pillars.year.branch}</div>
        </div>
        <div className="space-y-1">
          <span className="text-xs text-muted-foreground">月柱</span>
          <div className="font-serif text-lg text-foreground">{profile.pillars.month.stem}</div>
          <div className="font-serif text-base text-muted-foreground">{profile.pillars.month.branch}</div>
        </div>
        <div className="space-y-1">
          <span className="text-xs text-muted-foreground">日柱</span>
          <div className="font-serif text-lg text-foreground">{profile.pillars.day.stem}</div>
          <div className="font-serif text-base text-muted-foreground">{profile.pillars.day.branch}</div>
        </div>
      </div>

      {/* Summary info */}
      <div className="space-y-1.5 text-sm">
        <div className="flex justify-between">
          <span className="text-muted-foreground">日主</span>
          <span className="font-medium text-foreground">{profile.dayMaster}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-muted-foreground">格局</span>
          <span className="font-medium text-foreground">{profile.pattern}</span>
        </div>
        <div className="flex justify-between">
          <span className="text-muted-foreground">当前大运</span>
          <span className="font-medium text-foreground">{profile.currentLuck}</span>
        </div>
      </div>

      {/* View full button */}
      {onViewFull && (
        <button
          onClick={onViewFull}
          className="w-full text-center text-sm text-skill-primary hover:underline py-2"
        >
          查看完整命盘
        </button>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// ZodiacProfileCard - 星盘摘要卡片
// ═══════════════════════════════════════════════════════════════════════════
function ZodiacProfileCard({ profile, onViewFull }: { profile: ZodiacProfile; onViewFull?: () => void }) {
  return (
    <div className="glass-card rounded-xl p-4 space-y-4">
      {/* Main signs */}
      <div className="grid grid-cols-3 gap-2 text-center">
        <div className="space-y-1">
          <span className="text-xs text-muted-foreground">太阳</span>
          <div className="font-serif text-lg text-foreground">{profile.sunSign}</div>
        </div>
        {profile.moonSign && (
          <div className="space-y-1">
            <span className="text-xs text-muted-foreground">月亮</span>
            <div className="font-serif text-lg text-foreground">{profile.moonSign}</div>
          </div>
        )}
        {profile.risingSign && (
          <div className="space-y-1">
            <span className="text-xs text-muted-foreground">上升</span>
            <div className="font-serif text-lg text-foreground">{profile.risingSign}</div>
          </div>
        )}
      </div>

      {/* Current transit */}
      {profile.currentTransit && (
        <div className="text-sm text-center text-muted-foreground">
          当前星象：{profile.currentTransit}
        </div>
      )}

      {/* View full button */}
      {onViewFull && (
        <button
          onClick={onViewFull}
          className="w-full text-center text-sm text-skill-primary hover:underline py-2"
        >
          查看完整星盘
        </button>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// MbtiProfileCard - MBTI 档案摘要卡片
// ═══════════════════════════════════════════════════════════════════════════
function MbtiProfileCard({ profile, onViewFull }: { profile: MbtiProfile; onViewFull?: () => void }) {
  return (
    <div className="glass-card rounded-xl p-4 space-y-4">
      {/* Type display */}
      <div className="text-center">
        <div className="font-serif text-3xl font-bold text-foreground tracking-wider">
          {profile.type}
        </div>
        {profile.dominantFunction && (
          <div className="text-sm text-muted-foreground mt-1">
            主导功能：{profile.dominantFunction}
          </div>
        )}
      </div>

      {/* View full button */}
      {onViewFull && (
        <button
          onClick={onViewFull}
          className="w-full text-center text-sm text-skill-primary hover:underline py-2"
        >
          查看完整档案
        </button>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// ProfileCard - 根据 skill 类型渲染对应的档案卡片
// ═══════════════════════════════════════════════════════════════════════════
function ProfileCard({ skill, profile, onViewFull }: {
  skill: SkillType;
  profile: ProfileData;
  onViewFull?: () => void;
}) {
  if (!profile) return null;

  switch (skill) {
    case "bazi":
      return <BaziProfileCard profile={profile as BaziProfile} onViewFull={onViewFull} />;
    case "zodiac":
      return <ZodiacProfileCard profile={profile as ZodiacProfile} onViewFull={onViewFull} />;
    case "mbti":
      return <MbtiProfileCard profile={profile as MbtiProfile} onViewFull={onViewFull} />;
    default:
      return null;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// InsightPanel - PC 端左侧面板
// ═══════════════════════════════════════════════════════════════════════════
export function InsightPanel({
  skill,
  profile,
  insights = [],
  onViewFullProfile,
  onInsightClick,
  className,
}: InsightPanelProps) {
  const labels = SKILL_PROFILE_LABELS[skill];

  return (
    <div
      className={cn(
        "h-full overflow-y-auto",
        "bg-card border-r border-border shadow-sm",
        "p-5 space-y-6",
        className
      )}
    >
      {/* Profile Section */}
      <div>
        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
          {labels.title}
        </h2>
        {profile ? (
          <ProfileCard skill={skill} profile={profile} onViewFull={onViewFullProfile} />
        ) : (
          <div className="glass-card rounded-xl p-4 text-center">
            <VibeGlyph size="md" skill={skill} className="mx-auto mb-3" />
            <p className="text-sm text-muted-foreground">
              开始对话后，这里会显示你的档案摘要
            </p>
          </div>
        )}
      </div>

      {/* Insights Section */}
      {insights.length > 0 && (
        <div>
          <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
            洞察卡片
          </h2>
          <div className="space-y-3">
            {insights.map((insight) => (
              <MiniInsightCard
                key={insight.id}
                type={insight.type}
                title={insight.title}
                onClick={() => onInsightClick?.(insight)}
              />
            ))}
          </div>
        </div>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// MobileInsightBar - 移动端顶部可折叠栏
// ═══════════════════════════════════════════════════════════════════════════
export function MobileInsightBar({
  skill,
  profile,
  onViewFullProfile,
  className,
}: Omit<InsightPanelProps, "insights" | "onInsightClick">) {
  const [isExpanded, setIsExpanded] = useState(false);
  const labels = SKILL_PROFILE_LABELS[skill];

  // Only show if there's profile data
  if (!profile) return null;

  // Generate summary text based on skill
  const getSummaryText = () => {
    switch (skill) {
      case "bazi": {
        const p = profile as BaziProfile;
        return `日主: ${p.dayMaster} | 格局: ${p.pattern} | 大运: ${p.currentLuck}`;
      }
      case "zodiac": {
        const p = profile as ZodiacProfile;
        return `太阳: ${p.sunSign}${p.moonSign ? ` | 月亮: ${p.moonSign}` : ""}${p.risingSign ? ` | 上升: ${p.risingSign}` : ""}`;
      }
      case "mbti": {
        const p = profile as MbtiProfile;
        return `类型: ${p.type}${p.dominantFunction ? ` | ${p.dominantFunction}` : ""}`;
      }
      default:
        return "";
    }
  };

  return (
    <div className={cn("glass-subtle mx-4 mt-2 rounded-lg overflow-hidden", className)}>
      {/* Collapsed bar */}
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full flex items-center justify-between p-3 text-left"
      >
        <span className="text-xs text-muted-foreground truncate flex-1">
          {getSummaryText()}
        </span>
        {isExpanded ? (
          <ChevronUp className="w-4 h-4 text-muted-foreground flex-shrink-0 ml-2" />
        ) : (
          <ChevronDown className="w-4 h-4 text-muted-foreground flex-shrink-0 ml-2" />
        )}
      </button>

      {/* Expanded content */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: "auto", opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="overflow-hidden"
          >
            <div className="px-3 pb-3">
              <ProfileCard skill={skill} profile={profile} onViewFull={onViewFullProfile} />
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
