"""
Payment Repository - Data access layer for payments
Based on: vibelife spec v3.0
"""
from datetime import datetime
from typing import Optional, Dict, Any
from uuid import UUID

from .db import get_connection


# ═══════════════════════════════════════════════════════════════════════════
# Payment Records
# ═══════════════════════════════════════════════════════════════════════════

async def create_payment(
    user_id: Optional[UUID],
    product_type: str,
    product_id: Optional[UUID],
    amount_cents: int,
    currency: str = "CNY",
    provider: Optional[str] = None,
    provider_payment_id: Optional[str] = None,
    provider_metadata: Optional[Dict[str, Any]] = None
) -> dict:
    """Create a payment record"""
    async with get_connection() as conn:
        row = await conn.fetchrow(
            """
            INSERT INTO payments (
                user_id, product_type, product_id,
                amount_cents, currency, status,
                provider, provider_payment_id, provider_metadata
            )
            VALUES ($1, $2, $3, $4, $5, 'pending', $6, $7, $8)
            RETURNING *
            """,
            user_id, product_type, product_id,
            amount_cents, currency,
            provider, provider_payment_id, provider_metadata
        )
        return dict(row) if row else None


async def get_payment(payment_id: UUID) -> Optional[dict]:
    """Get payment by ID"""
    async with get_connection() as conn:
        row = await conn.fetchrow(
            "SELECT * FROM payments WHERE id = $1",
            payment_id
        )
        return dict(row) if row else None


async def get_payment_by_provider_id(provider: str, provider_payment_id: str) -> Optional[dict]:
    """Get payment by provider payment ID (e.g., Stripe session ID)"""
    async with get_connection() as conn:
        row = await conn.fetchrow(
            """
            SELECT * FROM payments
            WHERE provider = $1 AND provider_payment_id = $2
            """,
            provider, provider_payment_id
        )
        return dict(row) if row else None


async def update_payment_status(
    payment_id: UUID,
    status: str,
    paid_at: Optional[datetime] = None
) -> Optional[dict]:
    """Update payment status"""
    async with get_connection() as conn:
        row = await conn.fetchrow(
            """
            UPDATE payments
            SET status = $2, paid_at = $3, updated_at = NOW()
            WHERE id = $1
            RETURNING *
            """,
            payment_id, status, paid_at
        )
        return dict(row) if row else None


async def mark_payment_success(
    payment_id: UUID,
    provider_payment_id: Optional[str] = None
) -> Optional[dict]:
    """Mark payment as successful"""
    async with get_connection() as conn:
        row = await conn.fetchrow(
            """
            UPDATE payments
            SET status = 'success', paid_at = NOW(),
                provider_payment_id = COALESCE($2, provider_payment_id),
                updated_at = NOW()
            WHERE id = $1
            RETURNING *
            """,
            payment_id, provider_payment_id
        )
        return dict(row) if row else None


async def get_user_payments(
    user_id: UUID,
    limit: int = 20,
    status: Optional[str] = None
) -> list:
    """Get user's payment history"""
    async with get_connection() as conn:
        if status:
            rows = await conn.fetch(
                """
                SELECT * FROM payments
                WHERE user_id = $1 AND status = $2
                ORDER BY created_at DESC
                LIMIT $3
                """,
                user_id, status, limit
            )
        else:
            rows = await conn.fetch(
                """
                SELECT * FROM payments
                WHERE user_id = $1
                ORDER BY created_at DESC
                LIMIT $2
                """,
                user_id, limit
            )
        return [dict(row) for row in rows]


async def has_paid_for_product(user_id: UUID, product_type: str, product_id: UUID) -> bool:
    """Check if user has paid for a specific product"""
    async with get_connection() as conn:
        row = await conn.fetchrow(
            """
            SELECT id FROM payments
            WHERE user_id = $1
              AND product_type = $2
              AND product_id = $3
              AND status = 'success'
            LIMIT 1
            """,
            user_id, product_type, product_id
        )
        return row is not None
