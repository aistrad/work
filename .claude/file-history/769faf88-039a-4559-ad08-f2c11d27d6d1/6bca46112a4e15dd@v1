"use client";

/**
 * ChartPanel - Chart Tab 的右侧 Panel 内容
 * 显示: Identity Prism + 人生 K 线 + Now/Next 趋势 + 报告入口
 *
 * 注: Bazi/Zodiac/MBTI 各自设计不同的内容
 */

import { useState } from "react";
import { cn } from "@/lib/utils";
import { type SkillType } from "@/components/core";
import { IdentityPrism, type PrismContent } from "@/components/identity/IdentityPrism";
import { LifeKLine, type LifeKLineData } from "@/components/trend/LifeKLine";
import {
  FileText,
  TrendingUp,
  Calendar,
  Sparkles,
  ChevronRight,
  Download,
} from "lucide-react";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface ChartPanelProps {
  skill: SkillType;
  /** Now/Next 数据 */
  nowNextData?: {
    currentPhase: string;
    currentTheme: string;
    nextMilestone: string;
    nextDate: string;
  };
  /** K线简要数据 */
  klinePreview?: {
    currentScore: number;
    trend: "up" | "down" | "stable";
    period: string;
  };
  /** 是否有完整报告 */
  hasReport?: boolean;
  onViewKLine?: () => void;
  onGenerateReport?: () => void;
  onDownloadReport?: () => void;
  className?: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Skill-specific Content
// ═══════════════════════════════════════════════════════════════════════════

const SKILL_CHART_CONFIG: Record<SkillType, {
  klineLabel: string;
  reportLabel: string;
  identityLabel: string;
}> = {
  bazi: {
    klineLabel: "人生 K 线",
    reportLabel: "八字完整报告",
    identityLabel: "命盘身份视角",
  },
  zodiac: {
    klineLabel: "星象周期",
    reportLabel: "星盘完整报告",
    identityLabel: "星盘身份视角",
  },
  mbti: {
    klineLabel: "成长轨迹",
    reportLabel: "人格完整报告",
    identityLabel: "人格身份视角",
  },
  attach: {
    klineLabel: "关系轨迹",
    reportLabel: "依恋模式报告",
    identityLabel: "依恋身份视角",
  },
  career: {
    klineLabel: "职业轨迹",
    reportLabel: "职业发展报告",
    identityLabel: "职业身份视角",
  },
};

// ═══════════════════════════════════════════════════════════════════════════
// Sub-components
// ═══════════════════════════════════════════════════════════════════════════

function NowNextCard({ data }: { data: ChartPanelProps["nowNextData"] }) {
  if (!data) {
    return (
      <div className="glass-card rounded-xl p-4 text-center text-muted-foreground text-sm">
        完成更多对话后，这里会显示你的当前阶段和下一步建议
      </div>
    );
  }

  return (
    <div className="glass-card rounded-xl p-4 space-y-4">
      {/* Now */}
      <div>
        <div className="flex items-center gap-2 mb-2">
          <div className="w-2 h-2 rounded-full bg-emerald-500" />
          <span className="text-xs font-medium text-muted-foreground uppercase tracking-wide">
            Now · 当前阶段
          </span>
        </div>
        <div className="font-serif text-lg font-semibold text-foreground">
          {data.currentPhase}
        </div>
        <p className="text-sm text-muted-foreground mt-1">
          {data.currentTheme}
        </p>
      </div>

      <div className="h-px bg-border" />

      {/* Next */}
      <div>
        <div className="flex items-center gap-2 mb-2">
          <div className="w-2 h-2 rounded-full bg-amber-500" />
          <span className="text-xs font-medium text-muted-foreground uppercase tracking-wide">
            Next · 下一节点
          </span>
        </div>
        <div className="font-serif text-lg font-semibold text-foreground">
          {data.nextMilestone}
        </div>
        <p className="text-sm text-muted-foreground mt-1">
          预计 {data.nextDate}
        </p>
      </div>
    </div>
  );
}

function KLinePreviewCard({
  data,
  label,
  onClick,
}: {
  data?: ChartPanelProps["klinePreview"];
  label: string;
  onClick?: () => void;
}) {
  const getTrendIcon = () => {
    if (!data) return null;
    switch (data.trend) {
      case "up":
        return <TrendingUp className="w-4 h-4 text-emerald-500" />;
      case "down":
        return <TrendingUp className="w-4 h-4 text-red-500 rotate-180" />;
      default:
        return <div className="w-4 h-0.5 bg-muted-foreground" />;
    }
  };

  return (
    <button
      onClick={onClick}
      className="w-full glass-card rounded-xl p-4 text-left hover:shadow-md transition-all group"
    >
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <Calendar className="w-4 h-4 text-skill-primary" />
          <span className="text-sm font-medium text-foreground">{label}</span>
        </div>
        <ChevronRight className="w-4 h-4 text-muted-foreground group-hover:translate-x-1 transition-transform" />
      </div>

      {data ? (
        <div className="flex items-center justify-between">
          <div>
            <div className="text-2xl font-serif font-bold text-foreground">
              {data.currentScore}
            </div>
            <div className="text-xs text-muted-foreground">{data.period}</div>
          </div>
          <div className="flex items-center gap-1">
            {getTrendIcon()}
            <span className={cn(
              "text-sm font-medium",
              data.trend === "up" && "text-emerald-500",
              data.trend === "down" && "text-red-500",
              data.trend === "stable" && "text-muted-foreground"
            )}>
              {data.trend === "up" ? "上升" : data.trend === "down" ? "下降" : "平稳"}
            </span>
          </div>
        </div>
      ) : (
        <p className="text-sm text-muted-foreground">
          查看你的运势走势图
        </p>
      )}
    </button>
  );
}

function ReportCard({
  label,
  hasReport,
  onGenerate,
  onDownload,
}: {
  label: string;
  hasReport?: boolean;
  onGenerate?: () => void;
  onDownload?: () => void;
}) {
  return (
    <div className="glass-card rounded-xl p-4">
      <div className="flex items-center gap-2 mb-3">
        <FileText className="w-4 h-4 text-skill-primary" />
        <span className="text-sm font-medium text-foreground">{label}</span>
      </div>

      {hasReport ? (
        <div className="space-y-2">
          <p className="text-sm text-muted-foreground">
            你的专属报告已生成
          </p>
          <div className="flex gap-2">
            <button
              onClick={onDownload}
              className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-skill-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity"
            >
              <Download className="w-4 h-4" />
              下载报告
            </button>
          </div>
        </div>
      ) : (
        <div className="space-y-2">
          <p className="text-sm text-muted-foreground">
            生成一份专属于你的深度分析报告
          </p>
          <button
            onClick={onGenerate}
            className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-skill-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity"
          >
            <Sparkles className="w-4 h-4" />
            生成报告
          </button>
        </div>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// ChartPanel Component
// ═══════════════════════════════════════════════════════════════════════════

export function ChartPanel({
  skill,
  nowNextData,
  klinePreview,
  hasReport,
  onViewKLine,
  onGenerateReport,
  onDownloadReport,
  className,
}: ChartPanelProps) {
  const config = SKILL_CHART_CONFIG[skill];

  return (
    <div className={cn("h-full overflow-y-auto p-5 space-y-6", className)}>
      {/* Now/Next Section */}
      <section>
        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
          当前与下一步
        </h2>
        <NowNextCard data={nowNextData} />
      </section>

      {/* K-Line Preview */}
      <section>
        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
          {config.klineLabel}
        </h2>
        <KLinePreviewCard
          data={klinePreview}
          label={config.klineLabel}
          onClick={onViewKLine}
        />
      </section>

      {/* Report Section */}
      <section>
        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
          深度报告
        </h2>
        <ReportCard
          label={config.reportLabel}
          hasReport={hasReport}
          onGenerate={onGenerateReport}
          onDownload={onDownloadReport}
        />
      </section>
    </div>
  );
}
