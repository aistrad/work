"use client";

import { useState } from "react";
import { cn } from "@/lib/utils";
import { Copy, Check, Clock, MessageSquare } from "lucide-react";

/**
 * ScriptCard - è¯æœ¯æ¨¡æ¿å¡ç‰‡
 *
 * ç”¨é€”: å…³ç³»åœºæ™¯ä¸­æä¾›å¯å¤åˆ¶çš„è¯æœ¯æ¨¡æ¿
 * åœºæ™¯: å’Œå¥½/è¡¨ç™½/é‚€çº¦/å®‰æ…°
 */

type SceneType = "reconcile" | "confess" | "invite" | "comfort";

interface Script {
  id: string;
  text: string;
}

interface ScriptCardProps {
  scene: SceneType;
  targetDescription?: string; // "å¤„å¥³åº§çš„ TA éœ€è¦: å†·é™æœŸ + çœŸè¯šåæ€"
  scripts: Script[];
  timing?: {
    delay: string; // "2-3å¤©å"
    timeRange: string; // "15:00-17:00"
  };
  onCopy?: (text: string) => void;
  className?: string;
}

const SCENE_CONFIG: Record<
  SceneType,
  { icon: string; title: string; color: string }
> = {
  reconcile: {
    icon: "ğŸ¤",
    title: "å’Œå¥½è¯æœ¯",
    color: "text-green-600",
  },
  confess: {
    icon: "ğŸ’•",
    title: "è¡¨ç™½è¯æœ¯",
    color: "text-pink-600",
  },
  invite: {
    icon: "ğŸ“©",
    title: "é‚€çº¦è¯æœ¯",
    color: "text-blue-600",
  },
  comfort: {
    icon: "ğŸ«‚",
    title: "å®‰æ…°è¯æœ¯",
    color: "text-accent-600",
  },
};

// å•ä¸ªè¯æœ¯é€‰é¡¹
function ScriptOption({
  script,
  index,
  onCopy,
}: {
  script: Script;
  index: number;
  onCopy?: (text: string) => void;
}) {
  const [copied, setCopied] = useState(false);

  const handleCopy = async () => {
    await navigator.clipboard.writeText(script.text);
    setCopied(true);
    onCopy?.(script.text);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div className="relative group">
      <div
        className={cn(
          "p-4 rounded-lg border border-border/50 bg-card",
          "hover:border-antique-gold/30 hover:shadow-sm",
          "transition-all duration-200"
        )}
      >
        <p className="text-xs text-muted-foreground mb-2">
          Option {String.fromCharCode(65 + index)}:
        </p>
        <p className="text-foreground font-serif italic pr-10">
          &ldquo;{script.text}&rdquo;
        </p>

        {/* å¤åˆ¶æŒ‰é’® */}
        <button
          onClick={handleCopy}
          className={cn(
            "absolute right-3 top-1/2 -translate-y-1/2",
            "w-8 h-8 rounded-full flex items-center justify-center",
            "bg-muted/50 hover:bg-antique-gold/10",
            "text-muted-foreground hover:text-antique-gold",
            "transition-all duration-200"
          )}
          title="å¤åˆ¶"
        >
          {copied ? (
            <Check className="w-4 h-4 text-green-600 animate-spring-scale" />
          ) : (
            <Copy className="w-4 h-4" />
          )}
        </button>
      </div>
    </div>
  );
}

export function ScriptCard({
  scene,
  targetDescription,
  scripts,
  timing,
  onCopy,
  className,
}: ScriptCardProps) {
  const config = SCENE_CONFIG[scene];

  return (
    <div
      className={cn(
        "bg-bg-card border border-subtle shadow-soft rounded-xl p-5",
        "animate-fade-in-up",
        className
      )}
    >
      {/* æ ‡é¢˜ */}
      <div className="flex items-center gap-2 mb-4">
        <span className="text-xl">{config.icon}</span>
        <h3 className={cn("font-medium", config.color)}>{config.title}</h3>
      </div>

      {/* ç›®æ ‡æè¿° */}
      {targetDescription && (
        <p className="text-sm text-muted-foreground mb-4 pb-4 border-b border-border/30">
          {targetDescription}
        </p>
      )}

      {/* è¯æœ¯é€‰é¡¹ */}
      <div className="space-y-3 mb-4">
        {scripts.map((script, index) => (
          <ScriptOption
            key={script.id}
            script={script}
            index={index}
            onCopy={onCopy}
          />
        ))}
      </div>

      {/* æœ€ä½³æ—¶æœº */}
      {timing && (
        <div className="flex items-start gap-2 p-3 rounded-lg bg-muted/30 text-sm">
          <Clock className="w-4 h-4 text-muted-foreground mt-0.5" />
          <div>
            <span className="text-muted-foreground">æœ€ä½³æ—¶æœºï¼š</span>
            <span className="text-foreground">
              {timing.delay}ï¼Œ{timing.timeRange}
            </span>
          </div>
        </div>
      )}
    </div>
  );
}

// ç´§å‡‘ç‰ˆæœ¬ (ç”¨äºå¯¹è¯æµä¸­åµŒå…¥)
export function ScriptCardInline({
  script,
  onCopy,
  className,
}: {
  script: string;
  onCopy?: (text: string) => void;
  className?: string;
}) {
  const [copied, setCopied] = useState(false);

  const handleCopy = async () => {
    await navigator.clipboard.writeText(script);
    setCopied(true);
    onCopy?.(script);
    setTimeout(() => setCopied(false), 2000);
  };

  return (
    <div
      className={cn(
        "inline-flex items-center gap-2 px-3 py-2 rounded-lg",
        "bg-muted/30 border border-border/30",
        className
      )}
    >
      <MessageSquare className="w-4 h-4 text-muted-foreground" />
      <span className="text-sm font-serif italic">&ldquo;{script}&rdquo;</span>
      <button
        onClick={handleCopy}
        className="ml-2 p-1 rounded hover:bg-muted/50 transition-colors"
        title="å¤åˆ¶"
      >
        {copied ? (
          <Check className="w-3 h-3 text-green-600" />
        ) : (
          <Copy className="w-3 h-3 text-muted-foreground" />
        )}
      </button>
    </div>
  );
}

export default ScriptCard;
