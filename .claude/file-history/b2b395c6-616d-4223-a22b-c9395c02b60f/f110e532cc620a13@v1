/**
 * CardRegistry v6.2 - 工具-卡片映射注册表 (性能优化版)
 *
 * v6.2 优化:
 * - 支持懒加载卡片组件 (Vercel rule: bundle-dynamic-imports)
 * - 使用 React.lazy 动态导入
 * - 提供 Suspense 包装的渲染方法
 *
 * 每个后端工具通过 card_type 映射到前端组件。
 * 新增 Skill 时，同时注册对应的卡片组件。
 */

import React, { Suspense, lazy } from 'react';

// 卡片组件类型
type CardComponent = React.FC<any>;
type LazyCardLoader = () => Promise<{ default: CardComponent }>;

// 卡片注册表 - 支持直接组件或懒加载器
const cardRegistry = new Map<string, CardComponent>();
const lazyCardRegistry = new Map<string, React.LazyExoticComponent<CardComponent>>();

/**
 * 注册卡片组件 (直接注册)
 */
export function registerCard(cardType: string, component: CardComponent): void {
  cardRegistry.set(cardType, component);
}

/**
 * 注册懒加载卡片组件 (Vercel rule: bundle-dynamic-imports)
 */
export function registerLazyCard(cardType: string, loader: LazyCardLoader): void {
  const LazyComponent = lazy(loader);
  lazyCardRegistry.set(cardType, LazyComponent);
}

/**
 * 获取卡片组件
 */
export function getCard(cardType: string): CardComponent | React.LazyExoticComponent<CardComponent> | undefined {
  // 优先返回直接注册的组件
  const directComponent = cardRegistry.get(cardType);
  if (directComponent) return directComponent;

  // 其次返回懒加载组件
  return lazyCardRegistry.get(cardType);
}

/**
 * 渲染卡片 (支持懒加载)
 */
export function renderCard(cardType: string, props: any): React.ReactNode {
  const Component = getCard(cardType);
  if (!Component) {
    console.warn(`Unknown card type: ${cardType}`);
    return null;
  }

  // 检查是否是懒加载组件
  const isLazy = lazyCardRegistry.has(cardType);

  if (isLazy) {
    // 懒加载组件需要 Suspense 包装
    return React.createElement(
      Suspense,
      { fallback: React.createElement('div', { className: 'animate-pulse bg-gray-100 rounded-lg h-32' }) },
      React.createElement(Component, props)
    );
  }

  return React.createElement(Component, props);
}

/**
 * 检查卡片是否已注册
 */
export function hasCard(cardType: string): boolean {
  return cardRegistry.has(cardType) || lazyCardRegistry.has(cardType);
}

/**
 * 获取所有已注册的卡片类型
 */
export function getRegisteredCardTypes(): string[] {
  const directTypes = Array.from(cardRegistry.keys());
  const lazyTypes = Array.from(lazyCardRegistry.keys());
  return Array.from(new Set([...directTypes, ...lazyTypes]));
}

// ═══════════════════════════════════════════════════════════════════════════
// 卡片类型常量
// ═══════════════════════════════════════════════════════════════════════════

export const CARD_TYPES = {
  // 通用
  COLLECT_FORM: 'collect_form',
  INSIGHT_CARD: 'insight_card',
  REPORT_CARD: 'report_card',
  SKILL_SERVICES: 'skill_services',
  SERVICE_RECOMMENDATION: 'service_recommendation',

  // Bazi
  BAZI_CHART: 'bazi_chart',
  BAZI_FORTUNE: 'bazi_fortune',
  BAZI_KLINE: 'bazi_kline',
  BAZI_DAILY_FORTUNE: 'bazi_daily_fortune',

  // Zodiac
  ZODIAC_CHART: 'zodiac_chart',
  ZODIAC_TRANSIT: 'zodiac_transit',
  ZODIAC_SYNASTRY: 'zodiac_synastry',
  ZODIAC_LUNAR_PHASE: 'zodiac_lunar_phase',

  // Tarot
  TAROT_SPREAD: 'tarot_spread',

  // Career
  CAREER_ANALYSIS: 'career_analysis',

  // VibeID
  VIBE_ID: 'vibe_id',
  VIBE_ID_RADAR: 'vibe_id_radar',
} as const;

export type CardType = typeof CARD_TYPES[keyof typeof CARD_TYPES];

// ═══════════════════════════════════════════════════════════════════════════
// 默认导出
// ═══════════════════════════════════════════════════════════════════════════

export const CardRegistry = {
  register: registerCard,
  registerLazy: registerLazyCard,
  get: getCard,
  render: renderCard,
  has: hasCard,
  getTypes: getRegisteredCardTypes,
  TYPES: CARD_TYPES,
};

export default CardRegistry;
