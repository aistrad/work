/**
 * VibeIDCard - å®Œæ•´çš„ VibeID å¡ç‰‡å±•ç¤ºç»„ä»¶
 *
 * åŸºäºè®¾è®¡æ–‡æ¡£ v5.0 å’Œå‰ç«¯è§„èŒƒ v7.1
 * ä» components/vibe-id è¿ç§»å¹¶å‡çº§
 */

'use client'

import { useState } from 'react'
import { cn } from '@/lib/utils'
import {
  type VibeIDDisplay,
  type ArchetypeType,
  type ConfidenceLevel,
  type ConsistencyType,
  getArchetypeMeta,
  getArchetypeColor,
} from '@/types/vibe-id'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface VibeIDCardProps {
  data: VibeIDDisplay
  variant?: 'full' | 'compact' | 'mini'
  showExplanation?: boolean
  className?: string
  onExplore?: () => void
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub-components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * åŸå‹å›¾æ ‡å±•ç¤º
 */
function ArchetypeIcon({
  archetype,
  size = 'md',
  showName = true,
  showNickname = false,
}: {
  archetype: ArchetypeType
  size?: 'sm' | 'md' | 'lg' | 'xl'
  showName?: boolean
  showNickname?: boolean
}) {
  const meta = getArchetypeMeta(archetype)
  const color = getArchetypeColor(archetype)

  const sizeClasses = {
    sm: 'w-8 h-8 text-lg',
    md: 'w-12 h-12 text-2xl',
    lg: 'w-16 h-16 text-3xl',
    xl: 'w-24 h-24 text-5xl',
  }

  return (
    <div className="flex flex-col items-center gap-1">
      <div
        className={cn(
          'rounded-2xl flex items-center justify-center',
          'shadow-card transition-shadow hover:shadow-card-hover',
          sizeClasses[size]
        )}
        style={{
          background: `linear-gradient(135deg, ${color}15 0%, ${color}05 100%)`,
          border: `2px solid ${color}30`,
        }}
      >
        <span>{meta.emoji}</span>
      </div>
      {showName && (
        <span className="text-sm font-medium text-ink-800">{meta.name}</span>
      )}
      {showNickname && (
        <span className="text-xs text-ink-500">{meta.nickname}</span>
      )}
    </div>
  )
}

/**
 * ç½®ä¿¡åº¦æ ‡ç­¾
 */
function ConfidenceBadge({ level }: { level: ConfidenceLevel }) {
  const config = {
    high: { label: 'é«˜ç½®ä¿¡', color: 'bg-emerald-50 text-emerald-700 border-emerald-200' },
    medium: { label: 'ä¸­ç½®ä¿¡', color: 'bg-amber-50 text-amber-700 border-amber-200' },
    low: { label: 'ä½ç½®ä¿¡', color: 'bg-ink-50 text-ink-600 border-ink-200' },
  }

  const { label, color } = config[level]

  return (
    <span className={cn('px-2 py-0.5 rounded-full text-xs font-medium border', color)}>
      {label}
    </span>
  )
}

/**
 * ä¸€è‡´æ€§æ ‡ç­¾
 */
function ConsistencyBadge({ type }: { type: ConsistencyType }) {
  const config = {
    perfect_match: { label: 'å®Œç¾ä¸€è‡´', color: 'bg-purple-50 text-purple-700 border-purple-200', icon: 'âœ¨' },
    similar: { label: 'ç›¸è¿‘', color: 'bg-blue-50 text-blue-700 border-blue-200', icon: 'ğŸ”—' },
    neutral: { label: 'ä¸­æ€§', color: 'bg-ink-50 text-ink-600 border-ink-200', icon: 'âš–ï¸' },
    conflict: { label: 'å¼ åŠ›', color: 'bg-orange-50 text-orange-700 border-orange-200', icon: 'âš¡' },
  }

  const { label, color, icon } = config[type]

  return (
    <span className={cn('px-2 py-0.5 rounded-full text-xs font-medium border inline-flex items-center gap-1', color)}>
      <span>{icon}</span>
      {label}
    </span>
  )
}

/**
 * å››ç»´åŸå‹å±•ç¤ºåŒº
 */
function FourDimensionsDisplay({
  core,
  inner,
  outer,
  shadow,
  shadowTension,
}: {
  core: string
  inner: string
  outer: string
  shadow: string
  shadowTension: string
}) {
  const dimensions = [
    { key: 'core', label: 'Core çµé­‚æœ¬è´¨', value: core, icon: 'ğŸ¯' },
    { key: 'inner', label: 'Inner å†…åœ¨ä¸–ç•Œ', value: inner, icon: 'ğŸ’«' },
    { key: 'outer', label: 'Outer å¤–åœ¨å‘ˆç°', value: outer, icon: 'ğŸŒŸ' },
    { key: 'shadow', label: 'Shadow é˜´å½±å€¾å‘', value: shadow, icon: 'ğŸŒ‘', extra: shadowTension },
  ]

  return (
    <div className="grid grid-cols-2 gap-3">
      {dimensions.map((dim) => (
        <div
          key={dim.key}
          className={cn(
            'p-3 rounded-xl border transition-all hover:shadow-sm',
            dim.key === 'shadow'
              ? 'col-span-2 bg-ink-50/50 border-ink-200/50'
              : 'bg-vellum-50 border-vellum-200/50'
          )}
        >
          <div className="flex items-center gap-2 mb-1">
            <span className="text-sm">{dim.icon}</span>
            <span className="text-xs text-ink-500">{dim.label}</span>
          </div>
          <p className="text-sm font-medium text-ink-800">{dim.value}</p>
          {dim.extra && (
            <div className="flex items-center gap-1.5 mt-2 pt-2 border-t border-ink-200/50">
              <span className="text-orange-500 text-sm">âš¡</span>
              <span className="text-xs text-ink-600 font-medium">æ ¸å¿ƒå¼ åŠ›ï¼š</span>
              <span className="text-xs text-ink-700">{dim.extra}</span>
            </div>
          )}
        </div>
      ))}
    </div>
  )
}

/**
 * åº•å±‚å¯†ç å±•ç¤º
 */
function UnderlyingCodeDisplay({
  baziBrief,
  zodiacBrief,
}: {
  baziBrief: string
  zodiacBrief: string
}) {
  return (
    <div className="p-4 rounded-xl bg-vellum-100/50 border border-vellum-200/50">
      <div className="flex items-center gap-2 mb-3">
        <span className="text-sm">ğŸ“</span>
        <span className="text-sm font-medium text-ink-800">åº•å±‚å¯†ç </span>
      </div>
      <div className="space-y-2">
        <div className="flex items-start gap-2">
          <span className="text-xs text-ink-500 w-12 flex-shrink-0">å…«å­—</span>
          <span className="text-sm text-ink-700">{baziBrief}</span>
        </div>
        <div className="flex items-start gap-2">
          <span className="text-xs text-ink-500 w-12 flex-shrink-0">æ˜Ÿç›˜</span>
          <span className="text-sm text-ink-700">{zodiacBrief}</span>
        </div>
      </div>
    </div>
  )
}

/**
 * æˆé•¿æ–¹å‘å±•ç¤º
 */
function GrowthDirectionDisplay({ tip }: { tip: string }) {
  return (
    <div className="p-4 rounded-xl bg-accent-muted border border-accent/10">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-sm">âœ¨</span>
        <span className="text-sm font-medium text-ink-800">æˆé•¿æ–¹å‘</span>
      </div>
      <p className="text-sm text-ink-600 leading-relaxed">&ldquo;{tip}&rdquo;</p>
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function VibeIDCard({
  data,
  variant = 'full',
  showExplanation = true,
  className,
  onExplore,
}: VibeIDCardProps) {
  const [expanded, setExpanded] = useState(false)

  // Mini variant - æœ€ç®€å±•ç¤º
  if (variant === 'mini') {
    return (
      <div className={cn('p-4 rounded-xl bg-white shadow-card border border-vellum-200/30', className)}>
        <div className="flex items-center gap-3">
          <ArchetypeIcon archetype={data.primaryArchetype} size="md" showName={false} />
          <div className="flex-1">
            <p className="text-sm font-medium text-ink-800">
              {data.primaryName} / {data.primaryNickname}
            </p>
            <p className="text-xs text-ink-500">&ldquo;{data.primarySlogan}&rdquo;</p>
          </div>
        </div>
      </div>
    )
  }

  // Compact variant - ç´§å‡‘å±•ç¤º
  if (variant === 'compact') {
    return (
      <div className={cn('p-5 rounded-xl bg-white shadow-card border border-vellum-200/30', className)}>
        {/* Header */}
        <div className="text-center mb-4">
          <ArchetypeIcon archetype={data.primaryArchetype} size="lg" showName showNickname />
          <p className="text-sm text-ink-500 mt-2">&ldquo;{data.primarySlogan}&rdquo;</p>
        </div>

        {/* å››ç»´ç®€è¿° */}
        <div className="grid grid-cols-2 gap-2 text-center">
          <div className="p-2 rounded-lg bg-vellum-50">
            <p className="text-xs text-ink-500">Inner</p>
            <p className="text-sm text-ink-700">{data.innerSummary}</p>
          </div>
          <div className="p-2 rounded-lg bg-vellum-50">
            <p className="text-xs text-ink-500">Outer</p>
            <p className="text-sm text-ink-700">{data.outerSummary}</p>
          </div>
        </div>

        {/* åº•å±‚å¯†ç ç®€è¿° */}
        <div className="mt-3 pt-3 border-t border-vellum-200/50">
          <p className="text-xs text-ink-500 text-center">{data.baziBrief}</p>
        </div>

        {onExplore && (
          <button
            onClick={onExplore}
            className="w-full mt-4 py-2 text-sm text-accent hover:underline"
          >
            æ¢ç´¢æˆ‘çš„ VibeID â†’
          </button>
        )}
      </div>
    )
  }

  // Full variant - å®Œæ•´å±•ç¤º
  return (
    <div className={cn('rounded-2xl bg-white shadow-card border border-vellum-200/30 overflow-hidden', className)}>
      {/* Header */}
      <div className="p-6 text-center border-b border-vellum-200/50">
        <h2 className="font-serif text-lg text-ink-500 mb-4">VibeID</h2>

        {/* ä¸»åŸå‹ */}
        <ArchetypeIcon archetype={data.primaryArchetype} size="xl" showName showNickname />
        <p className="text-base text-ink-500 mt-3">&ldquo;{data.primarySlogan}&rdquo;</p>

        {/* å‰¯åŸå‹ */}
        {data.secondaryArchetype && (
          <div className="mt-3 flex items-center justify-center gap-2">
            <span className="text-xs text-ink-500">å‰¯åŸå‹:</span>
            <span className="text-sm text-ink-700">
              {data.secondaryEmoji} {getArchetypeMeta(data.secondaryArchetype).name}
            </span>
          </div>
        )}

        {/* æ ‡ç­¾ */}
        <div className="mt-4 flex items-center justify-center gap-2">
          <ConfidenceBadge level={data.confidence} />
          <ConsistencyBadge type={data.consistencyType} />
        </div>
      </div>

      {/* å››ç»´åŸå‹ */}
      <div className="p-6 border-b border-vellum-200/50">
        <FourDimensionsDisplay
          core={data.coreSummary}
          inner={data.innerSummary}
          outer={data.outerSummary}
          shadow={data.shadowSummary}
          shadowTension={data.shadowTension}
        />
      </div>

      {/* åº•å±‚å¯†ç  */}
      <div className="p-6 border-b border-vellum-200/50">
        <UnderlyingCodeDisplay
          baziBrief={data.baziBrief}
          zodiacBrief={data.zodiacBrief}
        />
      </div>

      {/* æˆé•¿æ–¹å‘ */}
      <div className="p-6">
        <GrowthDirectionDisplay tip={data.growthTip} />
      </div>

      {/* å±•å¼€æ›´å¤š */}
      {showExplanation && (
        <div className="px-6 pb-6">
          <button
            onClick={() => setExpanded(!expanded)}
            className="w-full py-3 text-sm text-accent hover:underline flex items-center justify-center gap-1"
          >
            {expanded ? 'æ”¶èµ·è¯¦æƒ…' : 'æŸ¥çœ‹è¯¦ç»†è§£è¯»'}
            <span className={cn('transition-transform', expanded && 'rotate-180')}>â–¼</span>
          </button>

          {expanded && (
            <div className="mt-4 p-4 rounded-xl bg-vellum-50 space-y-3 animate-fade-in">
              <p className="text-sm text-ink-700">{data.summary}</p>
            </div>
          )}
        </div>
      )}

      {/* CTA */}
      {onExplore && (
        <div className="p-6 pt-0">
          <button
            onClick={onExplore}
            className="w-full py-3 bg-accent text-white rounded-xl text-sm font-medium hover:bg-accent-hover transition-colors"
          >
            æ¢ç´¢æˆ‘çš„ VibeID
          </button>
        </div>
      )}
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Skeleton
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function VibeIDCardSkeleton({
  variant = 'full',
  className,
}: {
  variant?: 'full' | 'compact' | 'mini'
  className?: string
}) {
  if (variant === 'mini') {
    return (
      <div className={cn("p-4 rounded-xl bg-white shadow-card border border-vellum-200/30 animate-pulse", className)}>
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 rounded-2xl bg-vellum-100" />
          <div className="flex-1 space-y-2">
            <div className="h-4 bg-vellum-100 rounded w-3/4" />
            <div className="h-3 bg-vellum-100 rounded w-1/2" />
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className={cn("rounded-2xl bg-white shadow-card border border-vellum-200/30 overflow-hidden animate-pulse", className)}>
      <div className="p-6 text-center border-b border-vellum-200/50">
        <div className="w-24 h-24 rounded-2xl bg-vellum-100 mx-auto mb-4" />
        <div className="h-5 bg-vellum-100 rounded w-1/2 mx-auto mb-2" />
        <div className="h-4 bg-vellum-100 rounded w-2/3 mx-auto" />
      </div>
      <div className="p-6 space-y-3">
        <div className="grid grid-cols-2 gap-3">
          {[1, 2, 3, 4].map((i) => (
            <div key={i} className="h-20 bg-vellum-100 rounded-xl" />
          ))}
        </div>
      </div>
    </div>
  )
}

export default VibeIDCard
