"""
Dashboard API 直接测试（绕过 HTTP 层）
直接调用路由处理函数验证逻辑
"""

import os
import sys

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

os.environ.setdefault("FORTUNE_AI_DB_URL", "postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/fortune_ai")

from unittest.mock import MagicMock, patch


def create_mock_request(user_id: int = 1):
    """创建模拟请求对象"""
    request = MagicMock()
    request.state = MagicMock()
    return request


def mock_auth(user_id: int = 1):
    """返回模拟认证信息"""
    return {"user_id": str(user_id), "phone": "13800138001"}


def test_overview_logic():
    """测试 Overview 逻辑"""
    print("\n=== 测试 Overview 逻辑 ===")
    from services import soul_os

    user_id = 1

    # State Score
    state_score = soul_os.calculate_state_score(user_id)
    print(f"State Score: {state_score.score}")

    # L1 Schema
    l1 = soul_os.get_l1_schema(user_id)
    perma = l1.perma.to_dict()
    print(f"PERMA: {list(perma.keys())}")

    # Tasks
    tasks = soul_os.list_commitments(user_id, status=["suggested", "active"], limit=3)
    print(f"Tasks: {len(tasks)} items")

    # Anti-dependency
    anti_dep = soul_os.check_anti_dependency(user_id)
    print(f"Anti-dependency: should_intervene={anti_dep.should_intervene}")

    return True


def test_status_logic():
    """测试 Status 逻辑"""
    print("\n=== 测试 Status 逻辑 ===")
    from services import soul_os

    user_id = 1

    # L0 Facts
    l0 = soul_os.get_l0_facts(user_id)
    facts = l0.get("facts", {})
    translations = soul_os.translate_bazi_to_psychology(facts)
    print(f"L0 Facts Hash: {l0.get('facts_hash', 'N/A')[:20]}...")
    print(f"Translations: {len(translations)} items")

    # L1 Schema
    l1 = soul_os.get_l1_schema(user_id)
    print(f"L1 Schema: {list(l1.to_dict().keys())}")

    return True


def test_trends_logic():
    """测试 Trends 逻辑"""
    print("\n=== 测试 Trends 逻辑 ===")
    from datetime import datetime, timedelta, timezone
    from stores import fortune_db

    user_id = 1
    days = 7
    window_start = datetime.now(timezone.utc) - timedelta(days=days)

    # Checkin history
    checkins = fortune_db.fetch_all(
        """
        SELECT DATE(created_at) as date, AVG(intensity) as avg_intensity
        FROM fortune_checkin
        WHERE user_id = %s AND created_at >= %s
        GROUP BY DATE(created_at)
        ORDER BY date
        """,
        (user_id, window_start),
    ) or []
    print(f"Checkin Days: {len(checkins)}")

    # Done commitments
    done = fortune_db.fetch_all(
        """
        SELECT DATE(done_at) as date, COUNT(*) as cnt
        FROM fortune_commitment
        WHERE user_id = %s AND status = 'done' AND done_at >= %s
        GROUP BY DATE(done_at)
        """,
        (user_id, window_start),
    ) or []
    print(f"Done Days: {len(done)}")

    return True


def test_tasks_logic():
    """测试 Tasks 逻辑"""
    print("\n=== 测试 Tasks 逻辑 ===")
    from services import soul_os

    user_id = 1

    active = soul_os.list_commitments(user_id, status=["active"], limit=10)
    suggested = soul_os.list_commitments(user_id, status=["suggested"], limit=10)
    completed = soul_os.list_commitments(user_id, status=["done"], limit=5)

    print(f"Active: {len(active)}")
    print(f"Suggested: {len(suggested)}")
    print(f"Completed: {len(completed)}")

    return True


def test_checkin_logic():
    """测试 Checkin 逻辑"""
    print("\n=== 测试 Checkin 逻辑 ===")
    from services import soul_os

    user_id = 1

    # Test JITAI action
    action = soul_os.get_jitai_action("焦虑", 7)
    print(f"JITAI Action: {action[:50]}...")

    # 不实际创建打卡，只验证逻辑
    print("Checkin logic verified (not creating record)")

    return True


def test_full_context_logic():
    """测试完整上下文逻辑"""
    print("\n=== 测试 Full Context 逻辑 ===")
    from services import soul_os

    user_id = 1
    query = "工作压力大怎么办"

    context = soul_os.get_full_context_for_chat(user_id, query)

    print(f"System Prompt: {len(context.get('system_prompt', ''))} chars")
    print(f"Persona Style: {context.get('persona_style')}")
    print(f"User Context Keys: {list(context.get('user_context', {}).keys())}")
    print(f"Evidence Keys: {list(context.get('evidence', {}).keys())}")
    print(f"Anti-dependency: {context.get('anti_dependency', {}).get('should_intervene')}")

    return True


def test_route_handler_import():
    """测试路由处理器导入"""
    print("\n=== 测试路由处理器导入 ===")

    try:
        from api.dashboard_routes import (
            get_overview,
            get_status,
            get_trends,
            get_tasks,
            accept_task,
            complete_task,
            skip_task,
            checkin,
            get_relations,
            get_explore,
        )
        print("All route handlers imported successfully")
        return True
    except Exception as e:
        print(f"Import error: {e}")
        return False


def run_all_tests():
    """运行所有测试"""
    print("=" * 60)
    print("Dashboard 逻辑直接测试")
    print("=" * 60)

    tests = [
        ("Route Handlers Import", test_route_handler_import),
        ("Overview Logic", test_overview_logic),
        ("Status Logic", test_status_logic),
        ("Trends Logic", test_trends_logic),
        ("Tasks Logic", test_tasks_logic),
        ("Checkin Logic", test_checkin_logic),
        ("Full Context Logic", test_full_context_logic),
    ]

    results = []
    for name, test_fn in tests:
        try:
            result = test_fn()
            results.append((name, "PASS" if result else "FAIL"))
        except Exception as e:
            print(f"\n[ERROR] {name}: {e}")
            import traceback
            traceback.print_exc()
            results.append((name, f"ERROR: {str(e)[:40]}"))

    print("\n" + "=" * 60)
    print("测试结果汇总")
    print("=" * 60)

    passed = 0
    failed = 0
    for name, result in results:
        status = "✓" if result == "PASS" else "✗"
        print(f"  {status} {name}: {result}")
        if result == "PASS":
            passed += 1
        else:
            failed += 1

    print("=" * 60)
    print(f"Total: {len(results)} tests, {passed} passed, {failed} failed")
    print("=" * 60)

    return failed == 0


if __name__ == "__main__":
    success = run_all_tests()
    sys.exit(0 if success else 1)
