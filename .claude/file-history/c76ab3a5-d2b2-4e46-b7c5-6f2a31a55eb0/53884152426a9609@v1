"""
Dashboard API 端点测试
测试 Zone B Dashboard 的所有 API 端点
"""

import os
import sys
import json

# Add project root to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# 设置数据库环境变量
os.environ.setdefault("FORTUNE_AI_DB_URL", "postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/fortune_ai")

from fastapi.testclient import TestClient


def get_test_client():
    """获取测试客户端"""
    from api.main import app
    return TestClient(app)


def get_auth_cookies(client):
    """获取认证 Cookie（使用测试账户）"""
    # 首先尝试登录获取 session
    resp = client.post(
        "/api/auth/login",
        json={"phone": "13800138001", "code": "888888"},  # 测试账户
    )
    if resp.status_code == 200:
        return resp.cookies
    return {}


def test_dashboard_overview():
    """测试 GET /api/dashboard/overview"""
    print("\n=== 测试 Dashboard Overview ===")
    client = get_test_client()
    cookies = get_auth_cookies(client)

    resp = client.get("/api/dashboard/overview", cookies=cookies)
    print(f"Status: {resp.status_code}")

    if resp.status_code == 200:
        data = resp.json()
        print(f"OK: {data.get('ok')}")
        if data.get("data"):
            d = data["data"]
            print(f"  - insight: {d.get('insight', 'N/A')[:40]}...")
            print(f"  - state_score: {d.get('state_score', {}).get('score', 'N/A')}")
            print(f"  - today_tasks: {len(d.get('today_tasks', []))} items")
            print(f"  - risk_alerts: {len(d.get('risk_alerts', []))} items")
        return True
    else:
        print(f"Error: {resp.text[:100]}")
        return False


def test_dashboard_status():
    """测试 GET /api/dashboard/status"""
    print("\n=== 测试 Dashboard Status ===")
    client = get_test_client()
    cookies = get_auth_cookies(client)

    resp = client.get("/api/dashboard/status", cookies=cookies)
    print(f"Status: {resp.status_code}")

    if resp.status_code == 200:
        data = resp.json()
        print(f"OK: {data.get('ok')}")
        if data.get("data"):
            d = data["data"]
            l0 = d.get("l0_facts", {})
            print(f"  - day_master: {l0.get('day_master', 'N/A')}")
            print(f"  - translations: {len(l0.get('translations', []))} items")
            print(f"  - l1_schema keys: {list(d.get('l1_schema', {}).keys())}")
        return True
    else:
        print(f"Error: {resp.text[:100]}")
        return False


def test_dashboard_trends():
    """测试 GET /api/dashboard/trends"""
    print("\n=== 测试 Dashboard Trends ===")
    client = get_test_client()
    cookies = get_auth_cookies(client)

    resp = client.get("/api/dashboard/trends?days=7", cookies=cookies)
    print(f"Status: {resp.status_code}")

    if resp.status_code == 200:
        data = resp.json()
        print(f"OK: {data.get('ok')}")
        if data.get("data"):
            d = data["data"]
            print(f"  - score_history: {len(d.get('state_score_history', []))} items")
            print(f"  - events: {len(d.get('events', []))} items")
        return True
    else:
        print(f"Error: {resp.text[:100]}")
        return False


def test_dashboard_tasks():
    """测试 GET /api/dashboard/tasks"""
    print("\n=== 测试 Dashboard Tasks ===")
    client = get_test_client()
    cookies = get_auth_cookies(client)

    resp = client.get("/api/dashboard/tasks", cookies=cookies)
    print(f"Status: {resp.status_code}")

    if resp.status_code == 200:
        data = resp.json()
        print(f"OK: {data.get('ok')}")
        if data.get("data"):
            d = data["data"]
            print(f"  - active: {len(d.get('active', []))} items")
            print(f"  - suggested: {len(d.get('suggested', []))} items")
            print(f"  - completed_recent: {len(d.get('completed_recent', []))} items")
        return True
    else:
        print(f"Error: {resp.text[:100]}")
        return False


def test_dashboard_checkin():
    """测试 POST /api/dashboard/checkin"""
    print("\n=== 测试 Dashboard Checkin ===")
    client = get_test_client()
    cookies = get_auth_cookies(client)

    # 获取 CSRF token
    csrf_token = cookies.get("csrf_token", "")

    resp = client.post(
        "/api/dashboard/checkin",
        json={"mood": "焦虑", "intensity": 6, "note": "工作压力大"},
        cookies=cookies,
        headers={"X-CSRF-Token": csrf_token} if csrf_token else {},
    )
    print(f"Status: {resp.status_code}")

    if resp.status_code == 200:
        data = resp.json()
        print(f"OK: {data.get('ok')}")
        if data.get("data"):
            d = data["data"]
            print(f"  - task_id: {d.get('task_id', 'N/A')[:8]}...")
            print(f"  - recommended_action: {d.get('recommended_action', 'N/A')[:40]}...")
            print(f"  - state_score: {d.get('state_score', {}).get('score', 'N/A')}")
        return True
    else:
        print(f"Error: {resp.text[:100]}")
        return False


def test_dashboard_relations():
    """测试 GET /api/dashboard/relations"""
    print("\n=== 测试 Dashboard Relations ===")
    client = get_test_client()
    cookies = get_auth_cookies(client)

    resp = client.get("/api/dashboard/relations", cookies=cookies)
    print(f"Status: {resp.status_code}")

    if resp.status_code == 200:
        data = resp.json()
        print(f"OK: {data.get('ok')}")
        if data.get("data"):
            d = data["data"]
            print(f"  - relations: {len(d.get('relations', []))} items")
            print(f"  - social_features: {len(d.get('social_features', []))} items")
        return True
    else:
        print(f"Error: {resp.text[:100]}")
        return False


def test_dashboard_explore():
    """测试 GET /api/dashboard/explore"""
    print("\n=== 测试 Dashboard Explore ===")
    client = get_test_client()
    cookies = get_auth_cookies(client)

    resp = client.get("/api/dashboard/explore", cookies=cookies)
    print(f"Status: {resp.status_code}")

    if resp.status_code == 200:
        data = resp.json()
        print(f"OK: {data.get('ok')}")
        if data.get("data"):
            d = data["data"]
            print(f"  - mystic_entries: {len(d.get('mystic_entries', []))} items")
            print(f"  - courses: {len(d.get('courses', []))} items")
        return True
    else:
        print(f"Error: {resp.text[:100]}")
        return False


def run_all_tests():
    """运行所有 API 测试"""
    print("=" * 60)
    print("Dashboard API 端点测试")
    print("=" * 60)

    tests = [
        ("GET /api/dashboard/overview", test_dashboard_overview),
        ("GET /api/dashboard/status", test_dashboard_status),
        ("GET /api/dashboard/trends", test_dashboard_trends),
        ("GET /api/dashboard/tasks", test_dashboard_tasks),
        ("POST /api/dashboard/checkin", test_dashboard_checkin),
        ("GET /api/dashboard/relations", test_dashboard_relations),
        ("GET /api/dashboard/explore", test_dashboard_explore),
    ]

    results = []
    for name, test_fn in tests:
        try:
            result = test_fn()
            results.append((name, "PASS" if result else "FAIL"))
        except Exception as e:
            print(f"\n[ERROR] {name}: {e}")
            results.append((name, f"ERROR: {str(e)[:40]}"))

    print("\n" + "=" * 60)
    print("API 测试结果汇总")
    print("=" * 60)

    passed = 0
    failed = 0
    for name, result in results:
        status = "✓" if result == "PASS" else "✗"
        print(f"  {status} {name}: {result}")
        if result == "PASS":
            passed += 1
        else:
            failed += 1

    print("=" * 60)
    print(f"Total: {len(results)} tests, {passed} passed, {failed} failed")
    print("=" * 60)

    return failed == 0


if __name__ == "__main__":
    success = run_all_tests()
    sys.exit(0 if success else 1)
