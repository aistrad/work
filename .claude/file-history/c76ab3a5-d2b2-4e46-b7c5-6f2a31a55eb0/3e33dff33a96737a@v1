"""
Soul OS 功能测试
验证 os_design_claude_mvp.md 中定义的所有核心功能
"""

import os
import sys

# Add project root to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import json
from datetime import datetime, timezone

# 设置测试数据库
os.environ.setdefault("DB_URL", "postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/fortune_ai")


def test_l0_firmware():
    """测试 L0 Firmware 层 - 八字事实快照"""
    print("\n=== 测试 L0 Firmware 层 ===")
    from services import soul_os

    # 使用已存在的用户（user_id=1）
    user_id = 1

    # 测试获取八字事实
    facts = soul_os.get_l0_facts(user_id)
    print(f"L0 Facts: facts_hash={facts.get('facts_hash', 'N/A')[:20]}...")

    # 测试心理学翻译
    translations = soul_os.translate_bazi_to_psychology(facts.get("facts", {}))
    print(f"Psychology Translations: {len(translations)} items")
    for t in translations[:2]:
        print(f"  - {t.get('concept')}: {t.get('translation', '')[:50]}...")

    return len(facts) > 0


def test_l1_schema():
    """测试 L1 Schema 层 - PERMA + 行为证据"""
    print("\n=== 测试 L1 Schema 层 ===")
    from services import soul_os

    user_id = 1

    schema = soul_os.get_l1_schema(user_id)
    schema_dict = schema.to_dict()

    print(f"PERMA Snapshot:")
    perma = schema_dict.get("perma_snapshot", {})
    print(f"  - Positive Emotion: {perma.get('positive_emotion', {})}")
    print(f"  - Engagement: {perma.get('engagement', {})}")
    print(f"  - Accomplishment: {perma.get('accomplishment', {})}")

    print(f"Preferences: {schema_dict.get('preferences', {})}")

    return schema is not None


def test_state_score():
    """测试 State Score 计算"""
    print("\n=== 测试 State Score ===")
    from services import soul_os

    user_id = 1

    score = soul_os.calculate_state_score(user_id)
    score_dict = score.to_dict()

    print(f"Score: {score_dict.get('score')}/100")
    print(f"Breakdown: {score_dict.get('breakdown')}")
    print(f"Recovery Action: {score_dict.get('recovery_action', '')[:60]}...")

    return score.score >= 0


def test_jitai_actions():
    """测试 JITAI 调节动作库"""
    print("\n=== 测试 JITAI 调节动作库 ===")
    from services import soul_os

    test_cases = [
        ("焦虑", 8),
        ("焦虑", 5),
        ("低落", 9),
        ("低落", 4),
        ("愤怒", 7),
        ("困惑", 6),
        ("兴奋", 8),
        ("平静", 3),
    ]

    all_passed = True
    for mood, intensity in test_cases:
        action = soul_os.get_jitai_action(mood, intensity)
        if not action:
            print(f"  [FAIL] 情绪={mood}, 强度={intensity} -> 无动作")
            all_passed = False
        else:
            print(f"  [OK] 情绪={mood}, 强度={intensity} -> {action[:40]}...")

    return all_passed


def test_anti_dependency():
    """测试反依赖机制"""
    print("\n=== 测试反依赖机制 ===")
    from services import soul_os

    user_id = 1

    # 测试正常情况
    state = soul_os.check_anti_dependency(user_id, "今天运势如何？")
    print(f"Daily Consult Count: {state.daily_consult_count}")
    print(f"Last Action Days: {state.last_action_days}")
    print(f"Should Intervene: {state.should_intervene}")
    if state.should_intervene:
        print(f"Intervention Type: {state.intervention_type}")
        print(f"Message: {state.intervention_message[:50]}...")

    return True


def test_l2_knowledge_base():
    """测试 L2 知识库检索"""
    print("\n=== 测试 L2 知识库检索 ===")
    from services import soul_os

    # 测试检索
    results = soul_os.search_knowledge_base("八字日主", top_k=5)
    print(f"KB Results: {len(results)} items")
    for r in results[:3]:
        print(f"  - {r.get('kb_ref', 'N/A')}: {r.get('content', '')[:40]}...")

    return True


def test_l3_synthesis():
    """测试 L3 Synthesis 层"""
    print("\n=== 测试 L3 Synthesis 层 ===")
    from services import soul_os

    user_id = 1

    # 测试 System Prompt 构建
    prompt = soul_os.build_system_prompt(user_id, "warm")
    print(f"System Prompt Length: {len(prompt)} chars")
    print(f"Contains persona_style: {'persona_style' in prompt}")

    # 测试 User Context 构建
    context = soul_os.build_user_context(user_id)
    print(f"User Context Keys: {list(context.keys())}")

    # 测试 Evidence 构建
    evidence = soul_os.build_evidence(user_id, "职业发展")
    print(f"Evidence Keys: {list(evidence.keys())}")
    print(f"  - facts_hash: {evidence.get('facts_hash', 'N/A')[:20]}...")
    print(f"  - kb_refs: {len(evidence.get('kb_refs', []))} items")

    return len(prompt) > 0


def test_guidance_card_a2ui():
    """测试 Guidance Card 到 A2UI 转换"""
    print("\n=== 测试 Guidance Card -> A2UI ===")
    from services import soul_os

    card = {
        "card_id": "test-001",
        "type": "daily_guidance",
        "conclusion": "今天适合稳扎稳打，避免冲动决策",
        "why": "根据你的八字特质和当前状态，今天的能量更适合内省和规划。",
        "prescriptions": [
            {"content": "早起做 5 分钟冥想", "if_then": "如果没时间→先做 1 分钟深呼吸"},
            {"content": "列出今天最重要的 3 件事", "if_then": "如果想不出→先写 1 件"},
        ],
        "time_window": {"type": "intervention", "value": "今日", "confidence": "high"},
        "risk_boundary": "不替代医疗/法律/投资建议",
        "commitment_ask": "你愿意先做哪一个？",
        "actions": [
            {"type": "start_task", "task_id": "uuid-1", "label": "开始冥想"},
            {"type": "schedule_task", "task_id": "uuid-2", "label": "加入计划"},
            {"type": "opt_out", "label": "暂不执行"},
        ],
    }

    a2ui = soul_os.guidance_card_to_a2ui(card)
    print(f"A2UI Meta Summary: {a2ui.get('meta', {}).get('summary', 'N/A')[:50]}...")
    print(f"UI Components: {len(a2ui.get('ui_components', []))}")

    for comp in a2ui.get("ui_components", []):
        print(f"  - Type: {comp.get('type')}, Title: {comp.get('title')}")

    return len(a2ui.get("ui_components", [])) >= 2


def test_commitment_crud():
    """测试 Commitment CRUD 操作"""
    print("\n=== 测试 Commitment CRUD ===")
    from services import soul_os

    user_id = 1

    # 列出现有任务
    commitments = soul_os.list_commitments(user_id, status=["suggested", "active", "done"], limit=5)
    print(f"Existing Commitments: {len(commitments)}")
    for c in commitments[:3]:
        print(f"  - [{c['status']}] {c['title'][:30]}...")

    return True


def test_full_context():
    """测试完整上下文获取"""
    print("\n=== 测试 Full Context for Chat ===")
    from services import soul_os

    user_id = 1
    query = "我最近工作压力很大，该怎么办？"

    context = soul_os.get_full_context_for_chat(user_id, query)

    print(f"Context Keys: {list(context.keys())}")
    print(f"Persona Style: {context.get('persona_style')}")
    print(f"System Prompt Length: {len(context.get('system_prompt', ''))}")
    print(f"Anti-dependency: {context.get('anti_dependency', {})}")

    user_ctx = context.get("user_context", {})
    print(f"User Context Keys: {list(user_ctx.keys())}")

    evidence = context.get("evidence", {})
    print(f"Evidence KB Refs: {len(evidence.get('kb_refs', []))}")

    return "system_prompt" in context


def test_dashboard_routes():
    """测试 Dashboard API 路由（语法检查）"""
    print("\n=== 测试 Dashboard Routes 语法 ===")
    try:
        from api import dashboard_routes
        print(f"Dashboard Router Prefix: {dashboard_routes.router.prefix}")
        print(f"Routes Count: {len(dashboard_routes.router.routes)}")
        return True
    except Exception as e:
        print(f"[FAIL] Import error: {e}")
        return False


def test_chat_routes_integration():
    """测试 Chat Routes 集成（语法检查）"""
    print("\n=== 测试 Chat Routes 集成 ===")
    try:
        from api import chat_routes
        print(f"Chat Router Prefix: {chat_routes.router.prefix}")
        # 检查 soul_os 导入
        print(f"soul_os imported in chat_routes: {hasattr(chat_routes, 'soul_os')}")
        return True
    except Exception as e:
        print(f"[FAIL] Import error: {e}")
        return False


def run_all_tests():
    """运行所有测试"""
    print("=" * 60)
    print("Soul OS 功能测试")
    print("基于 os_design_claude_mvp.md 设计文档")
    print("=" * 60)

    tests = [
        ("L0 Firmware Layer", test_l0_firmware),
        ("L1 Schema Layer", test_l1_schema),
        ("State Score", test_state_score),
        ("JITAI Actions", test_jitai_actions),
        ("Anti-dependency", test_anti_dependency),
        ("L2 Knowledge Base", test_l2_knowledge_base),
        ("L3 Synthesis", test_l3_synthesis),
        ("Guidance Card A2UI", test_guidance_card_a2ui),
        ("Commitment CRUD", test_commitment_crud),
        ("Full Context", test_full_context),
        ("Dashboard Routes", test_dashboard_routes),
        ("Chat Routes Integration", test_chat_routes_integration),
    ]

    results = []
    for name, test_fn in tests:
        try:
            result = test_fn()
            results.append((name, "PASS" if result else "FAIL"))
        except Exception as e:
            print(f"\n[ERROR] {name}: {e}")
            results.append((name, f"ERROR: {str(e)[:50]}"))

    print("\n" + "=" * 60)
    print("测试结果汇总")
    print("=" * 60)

    passed = 0
    failed = 0
    for name, result in results:
        status = "✓" if result == "PASS" else "✗"
        print(f"  {status} {name}: {result}")
        if result == "PASS":
            passed += 1
        else:
            failed += 1

    print("=" * 60)
    print(f"Total: {len(results)} tests, {passed} passed, {failed} failed")
    print("=" * 60)

    return failed == 0


if __name__ == "__main__":
    success = run_all_tests()
    sys.exit(0 if success else 1)
