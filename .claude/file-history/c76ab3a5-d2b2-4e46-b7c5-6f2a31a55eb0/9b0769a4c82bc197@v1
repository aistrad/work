/**
 * Dashboard.js - Zone B 6 Tabs Dashboard
 * Integrates with Soul OS backend APIs
 */

(function() {
  'use strict';

  const $ = (s, r = document) => r.querySelector(s);
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

  // ========== API Helpers ==========
  function getCookie(name) {
    const m = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/[-.]/g, "\\$&") + "=([^;]*)"));
    return m ? decodeURIComponent(m[1]) : "";
  }

  function csrfHeaders() {
    const csrf = getCookie("fortune_csrf");
    return csrf ? { "X-CSRF-Token": csrf } : {};
  }

  async function apiJson(url, opts = {}) {
    const headers = { "Content-Type": "application/json", ...csrfHeaders(), ...opts.headers };
    const res = await fetch(url, { ...opts, headers });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      if (res.status === 401 || res.status === 403) {
        location.href = '/login';
        return;
      }
      throw new Error(data?.error?.message || data?.detail || 'Request failed');
    }
    return data?.data ?? data;
  }

  function escapeHtml(s) {
    return String(s ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function showToast(msg, duration = 2000) {
    const toast = $('#toast');
    if (!toast) return;
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), duration);
  }

  // ========== Tab Switching ==========
  function initTabs() {
    const tabs = $$('.ui-tabs--dashboard .ui-tab');
    const panels = $$('.ui-tab-panel');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const targetId = `panel-${tab.dataset.tab}`;

        // Update tabs
        tabs.forEach(t => t.classList.remove('ui-tab--active'));
        tab.classList.add('ui-tab--active');

        // Update panels
        panels.forEach(p => p.classList.remove('ui-tab-panel--active'));
        const targetPanel = $(`#${targetId}`);
        if (targetPanel) {
          targetPanel.classList.add('ui-tab-panel--active');
          // Load data for this tab
          loadTabData(tab.dataset.tab);
        }
      });
    });

    // Load initial tab
    loadTabData('overview');
  }

  // ========== Data Loading ==========
  const loadedTabs = new Set();

  async function loadTabData(tabName) {
    // Avoid reloading if already loaded (can be refreshed manually)
    if (loadedTabs.has(tabName)) return;

    switch (tabName) {
      case 'overview':
        await loadOverview();
        break;
      case 'status':
        await loadStatus();
        break;
      case 'trends':
        await loadTrends();
        break;
      case 'tasks':
        await loadTasks();
        break;
      case 'relations':
        await loadRelations();
        break;
      case 'explore':
        await loadExplore();
        break;
    }
    loadedTabs.add(tabName);
  }

  // ========== Tab 1: Overview ==========
  async function loadOverview() {
    try {
      const data = await apiJson('/api/dashboard/overview');

      // Insight
      $('#insight-content').innerHTML = data.insight
        ? `<div class="dash-insight">${escapeHtml(data.insight)}</div>`
        : renderEmpty('æš‚æ— ä»Šæ—¥æ´å¯Ÿ');

      // State Score
      const score = data.state_score || {};
      $('#state-score-content').innerHTML = renderStateScore(score);

      // Today Tasks
      const tasks = data.today_tasks || [];
      $('#today-tasks-content').innerHTML = tasks.length
        ? renderTaskList(tasks.slice(0, 3), 'suggested')
        : renderEmpty('æš‚æ— ä»Šæ—¥ä»»åŠ¡');

      // Risk Alerts
      const alerts = data.risk_alerts || [];
      $('#risk-alerts-content').innerHTML = alerts.length
        ? alerts.map(a => renderRiskAlert(a)).join('')
        : renderEmpty('æš‚æ— é£é™©æç¤º', 'ä¸€åˆ‡æ­£å¸¸');

    } catch (e) {
      console.error('Load overview error:', e);
      $('#insight-content').innerHTML = renderError('åŠ è½½å¤±è´¥');
    }
  }

  function renderStateScore(score) {
    const total = score.score ?? 50;
    const emotion = score.emotion_signal ?? 20;
    const action = score.action_signal ?? 20;
    const streak = score.streak_signal ?? 10;
    const recovery = score.recovery_action || '';

    return `
      <div class="state-score-card">
        <div class="state-score-value">${total}</div>
        <div class="state-score-signals">
          <div class="state-score-signal">
            <span class="state-score-signal__label">æƒ…ç»ª</span>
            <div class="state-score-signal__bar">
              <div class="state-score-signal__fill" style="width: ${(emotion / 40) * 100}%"></div>
            </div>
            <span class="state-score-signal__value">${emotion}/40</span>
          </div>
          <div class="state-score-signal">
            <span class="state-score-signal__label">è¡ŒåŠ¨</span>
            <div class="state-score-signal__bar">
              <div class="state-score-signal__fill" style="width: ${(action / 40) * 100}%"></div>
            </div>
            <span class="state-score-signal__value">${action}/40</span>
          </div>
          <div class="state-score-signal">
            <span class="state-score-signal__label">è¿ç»­</span>
            <div class="state-score-signal__bar">
              <div class="state-score-signal__fill" style="width: ${(streak / 20) * 100}%"></div>
            </div>
            <span class="state-score-signal__value">${streak}/20</span>
          </div>
        </div>
      </div>
      ${recovery ? `<div class="state-score-recovery">${escapeHtml(recovery)}</div>` : ''}
    `;
  }

  function renderRiskAlert(alert) {
    return `
      <div class="risk-alert">
        <div class="risk-alert__title">${escapeHtml(alert.type || 'é£é™©')}</div>
        <div class="risk-alert__text">${escapeHtml(alert.message || alert)}</div>
      </div>
    `;
  }

  // ========== Tab 2: Status ==========
  async function loadStatus() {
    try {
      const data = await apiJson('/api/dashboard/status');

      // L0 Facts
      const l0 = data.l0_facts || {};
      $('#l0-facts-content').innerHTML = renderL0Facts(l0);

      // L1 Schema (PERMA)
      const l1 = data.l1_schema || {};
      $('#l1-schema-content').innerHTML = renderPERMA(l1.perma_snapshot || {});

      // Translations
      const translations = l0.translations || [];
      $('#translations-content').innerHTML = translations.length
        ? renderTranslations(translations)
        : renderEmpty('æš‚æ— å¿ƒç†å­¦ç¿»è¯‘');

    } catch (e) {
      console.error('Load status error:', e);
      $('#l0-facts-content').innerHTML = renderError('åŠ è½½å¤±è´¥');
    }
  }

  function renderL0Facts(l0) {
    const dayMaster = l0.day_master || 'æœªçŸ¥';
    const strength = l0.strength || 'æœªçŸ¥';
    const shensha = l0.shensha || [];

    return `
      <div class="a2ui-kv">
        <div class="a2ui-kv-row">
          <span class="a2ui-kv-key">æ—¥ä¸»</span>
          <span class="a2ui-kv-value">${escapeHtml(dayMaster)}</span>
        </div>
        <div class="a2ui-kv-row">
          <span class="a2ui-kv-key">èº«å¼ºå¼±</span>
          <span class="a2ui-kv-value">${escapeHtml(strength)}</span>
        </div>
        ${shensha.length ? `
        <div class="a2ui-kv-row">
          <span class="a2ui-kv-key">ç¥ç…</span>
          <span class="a2ui-kv-value">${shensha.map(s => escapeHtml(s)).join(', ')}</span>
        </div>
        ` : ''}
      </div>
    `;
  }

  function renderPERMA(perma) {
    const dims = [
      { key: 'positive_emotion', label: 'P', name: 'ç§¯ææƒ…ç»ª' },
      { key: 'engagement', label: 'E', name: 'æŠ•å…¥' },
      { key: 'relationships', label: 'R', name: 'å…³ç³»' },
      { key: 'meaning', label: 'M', name: 'æ„ä¹‰' },
      { key: 'accomplishment', label: 'A', name: 'æˆå°±' },
    ];

    return `
      <div class="perma-grid">
        ${dims.map(d => `
          <div class="perma-item" title="${d.name}">
            <div class="perma-item__value">${perma[d.key]?.score ?? '-'}</div>
            <div class="perma-item__label">${d.label}</div>
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderTranslations(translations) {
    return `
      <div class="translation-list">
        ${translations.map(t => `
          <div class="translation-item">
            <div class="translation-item__concept">${escapeHtml(t.concept || '')}</div>
            <div class="translation-item__text">${escapeHtml(t.translation || '')}</div>
            ${t.action ? `<div class="translation-item__action">${escapeHtml(t.action)}</div>` : ''}
          </div>
        `).join('')}
      </div>
    `;
  }

  // ========== Tab 3: Trends ==========
  async function loadTrends() {
    try {
      const data = await apiJson('/api/dashboard/trends?days=7');

      // Score History
      const history = data.state_score_history || [];
      $('#score-history-content').innerHTML = history.length
        ? renderTrendChart(history)
        : renderEmpty('æš‚æ— å†å²æ•°æ®');

      // Events
      const events = data.events || [];
      $('#events-content').innerHTML = events.length
        ? renderEventTimeline(events)
        : renderEmpty('æš‚æ— å…³é”®äº‹ä»¶');

    } catch (e) {
      console.error('Load trends error:', e);
      $('#score-history-content').innerHTML = renderError('åŠ è½½å¤±è´¥');
    }
  }

  function renderTrendChart(history) {
    const max = Math.max(...history.map(h => h.score || 0), 100);
    return `
      <div class="trend-chart">
        ${history.map(h => `
          <div class="trend-bar"
               style="height: ${((h.score || 0) / max) * 100}%"
               data-value="${h.date}: ${h.score}">
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderEventTimeline(events) {
    return `
      <div class="event-timeline">
        ${events.map(e => `
          <div class="event-item">
            <div class="event-item__dot"></div>
            <div class="event-item__content">
              <div class="event-item__date">${escapeHtml(e.date || '')}</div>
              <div class="event-item__text">${escapeHtml(e.description || e.text || '')}</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  // ========== Tab 4: Tasks ==========
  async function loadTasks() {
    try {
      const data = await apiJson('/api/dashboard/tasks');

      // Active
      const active = data.active || [];
      $('#active-tasks-content').innerHTML = active.length
        ? renderTaskList(active, 'active')
        : renderEmpty('æš‚æ— è¿›è¡Œä¸­ä»»åŠ¡');

      // Suggested
      const suggested = data.suggested || [];
      $('#suggested-tasks-content').innerHTML = suggested.length
        ? renderTaskList(suggested, 'suggested')
        : renderEmpty('æš‚æ— æ¨èä»»åŠ¡');

      // Completed
      const completed = data.completed_recent || [];
      $('#completed-tasks-content').innerHTML = completed.length
        ? renderTaskList(completed, 'done')
        : renderEmpty('æš‚æ— å·²å®Œæˆä»»åŠ¡');

    } catch (e) {
      console.error('Load tasks error:', e);
      $('#active-tasks-content').innerHTML = renderError('åŠ è½½å¤±è´¥');
    }
  }

  function renderTaskList(tasks, status) {
    return `
      <div class="task-list">
        ${tasks.map(t => renderTaskItem(t, status)).join('')}
      </div>
    `;
  }

  function renderTaskItem(task, status) {
    const isDone = status === 'done';
    const taskId = task.id || task.task_id || '';

    let actions = '';
    if (status === 'suggested') {
      actions = `
        <button class="task-action-btn task-action-btn--primary" data-action="accept" data-task-id="${taskId}">æ¥å—</button>
        <button class="task-action-btn" data-action="skip" data-task-id="${taskId}">è·³è¿‡</button>
      `;
    } else if (status === 'active') {
      actions = `
        <button class="task-action-btn task-action-btn--primary" data-action="done" data-task-id="${taskId}">å®Œæˆ</button>
        <button class="task-action-btn" data-action="skip" data-task-id="${taskId}">è·³è¿‡</button>
      `;
    }

    return `
      <div class="task-item ${isDone ? 'task-item--done' : ''}" data-task-id="${taskId}">
        <div class="task-item__checkbox">${isDone ? 'âœ“' : ''}</div>
        <div class="task-item__content">
          <div class="task-item__title">${escapeHtml(task.title || task.content || '')}</div>
          <div class="task-item__meta">${escapeHtml(task.duration || task.meta || '')}</div>
        </div>
        <div class="task-item__actions">${actions}</div>
      </div>
    `;
  }

  // ========== Tab 5: Relations ==========
  async function loadRelations() {
    try {
      const data = await apiJson('/api/dashboard/relations');

      // Relations list
      const relations = data.relations || [];
      $('#relations-list-content').innerHTML = relations.length
        ? renderRelationList(relations)
        : renderEmpty('æš‚æ— å…³ç³»', 'æ·»åŠ é‡è¦å…³ç³»ä»¥è·å¾—æ›´ç²¾å‡†çš„å»ºè®®');

      // Social features
      const features = data.social_features || [
        { icon: 'ğŸ', title: 'èƒ½é‡æ‰“èµ', desc: 'ç»™æœ‹å‹é€å»å¥½è¿' },
        { icon: 'ğŸ”—', title: 'å¥½è¿æ¥é¾™', desc: 'åˆ†äº«ä½ çš„å¥½è¿' },
        { icon: 'ğŸ’¬', title: 'åæ§½æ¥é¾™', desc: 'é‡Šæ”¾è´Ÿèƒ½é‡' },
      ];
      $('#social-features-content').innerHTML = renderSocialFeatures(features);

    } catch (e) {
      console.error('Load relations error:', e);
      $('#relations-list-content').innerHTML = renderError('åŠ è½½å¤±è´¥');
    }
  }

  function renderRelationList(relations) {
    return `
      <div class="relation-list">
        ${relations.map(r => `
          <div class="relation-card" data-relation-id="${r.id || ''}">
            <div class="relation-card__avatar">${(r.name || '?')[0]}</div>
            <div class="relation-card__name">${escapeHtml(r.name || '')}</div>
            <div class="relation-card__type">${escapeHtml(r.type || r.relation_type || '')}</div>
          </div>
        `).join('')}
      </div>
    `;
  }

  function renderSocialFeatures(features) {
    return `
      <div class="social-feature-list">
        ${features.map(f => `
          <div class="social-feature-item" data-feature="${f.id || f.title}">
            <div class="social-feature-item__icon">${f.icon || 'âœ¨'}</div>
            <div class="social-feature-item__text">
              <div class="social-feature-item__title">${escapeHtml(f.title || '')}</div>
              <div class="social-feature-item__desc">${escapeHtml(f.desc || f.description || '')}</div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  // ========== Tab 6: Explore ==========
  async function loadExplore() {
    try {
      const data = await apiJson('/api/dashboard/explore');

      // Mystic entries
      const mystic = data.mystic_entries || [
        { icon: 'ğŸ”®', title: 'å¡”ç½—å åœ' },
        { icon: 'â­', title: 'æ˜Ÿç›˜è§£è¯»' },
        { icon: 'ğŸ“¿', title: 'é“æ¿ç¥ç®—' },
        { icon: 'ğŸ´', title: 'æ¢…èŠ±æ˜“æ•°' },
      ];
      $('#mystic-content').innerHTML = renderExploreGrid(mystic);

      // Courses
      const courses = data.courses || [
        { icon: 'ğŸ“š', title: 'è®¤çŸ¥å‡çº§' },
        { icon: 'ğŸ’ª', title: 'æƒ…ç»ªç®¡ç†' },
        { icon: 'ğŸ§˜', title: 'æ­£å¿µå…¥é—¨' },
      ];
      $('#courses-content').innerHTML = renderExploreGrid(courses);

    } catch (e) {
      console.error('Load explore error:', e);
      $('#mystic-content').innerHTML = renderError('åŠ è½½å¤±è´¥');
    }
  }

  function renderExploreGrid(items) {
    return `
      <div class="explore-grid">
        ${items.map(item => `
          <div class="explore-card" data-item-id="${item.id || item.title}">
            <div class="explore-card__icon">${item.icon || 'âœ¨'}</div>
            <div class="explore-card__title">${escapeHtml(item.title || '')}</div>
          </div>
        `).join('')}
      </div>
    `;
  }

  // ========== Helpers ==========
  function renderEmpty(title, subtitle = '') {
    return `
      <div class="dash-empty">
        <div class="dash-empty__icon">ğŸ“­</div>
        <div class="dash-empty__text">${escapeHtml(title)}</div>
        ${subtitle ? `<div class="dash-empty__text" style="font-size:11px;margin-top:4px">${escapeHtml(subtitle)}</div>` : ''}
      </div>
    `;
  }

  function renderError(msg) {
    return `
      <div class="dash-empty" style="color:var(--warn)">
        <div class="dash-empty__icon">âš ï¸</div>
        <div class="dash-empty__text">${escapeHtml(msg)}</div>
      </div>
    `;
  }

  // ========== Task Actions ==========
  function initTaskActions() {
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-action]');
      if (!btn) return;

      const action = btn.dataset.action;
      const taskId = btn.dataset.taskId;
      if (!taskId) return;

      btn.disabled = true;
      try {
        let endpoint = '';
        if (action === 'accept') endpoint = '/api/dashboard/task/accept';
        else if (action === 'done') endpoint = '/api/dashboard/task/done';
        else if (action === 'skip') endpoint = '/api/dashboard/task/skip';

        if (!endpoint) return;

        await apiJson(endpoint, {
          method: 'POST',
          body: JSON.stringify({ task_id: taskId }),
        });

        showToast(action === 'done' ? 'ä»»åŠ¡å®Œæˆï¼' : action === 'accept' ? 'å·²æ¥å—ä»»åŠ¡' : 'å·²è·³è¿‡');

        // Reload tasks
        loadedTabs.delete('tasks');
        loadedTabs.delete('overview');
        await loadTasks();

      } catch (e) {
        console.error('Task action error:', e);
        showToast('æ“ä½œå¤±è´¥');
      } finally {
        btn.disabled = false;
      }
    });
  }

  // ========== Checkin ==========
  function initCheckin() {
    const toggleBtn = $('#checkin-toggle');
    const closeBtn = $('#checkin-close');
    const card = $('#checkin-card');
    const form = $('#checkin-form');

    if (toggleBtn && card) {
      toggleBtn.addEventListener('click', () => {
        card.style.display = card.style.display === 'none' ? 'block' : 'none';
      });
    }

    if (closeBtn && card) {
      closeBtn.addEventListener('click', () => {
        card.style.display = 'none';
      });
    }

    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const data = {
          mood: fd.get('mood'),
          intensity: parseInt(fd.get('intensity')) || 5,
          note: fd.get('note') || '',
        };

        try {
          await apiJson('/api/dashboard/checkin', {
            method: 'POST',
            body: JSON.stringify(data),
          });
          showToast('æ‰“å¡æˆåŠŸï¼');
          card.style.display = 'none';
          form.reset();

          // Reload overview
          loadedTabs.delete('overview');
          await loadOverview();

        } catch (e) {
          console.error('Checkin error:', e);
          showToast('æ‰“å¡å¤±è´¥');
        }
      });
    }
  }

  // ========== Resizer ==========
  function initResizer() {
    const resizer = $('#resizer');
    const layout = $('.ui-layout--dashboard');
    const chatZone = $('.ui-chat');
    const dashboard = $('.ui-dashboard');

    if (!resizer || !layout || !chatZone || !dashboard) return;

    let isResizing = false;
    let startX = 0;
    let startChatWidth = 0;

    // Load saved width
    const savedRatio = localStorage.getItem('dashboard_ratio');
    if (savedRatio) {
      const ratio = parseFloat(savedRatio);
      layout.style.gridTemplateColumns = `minmax(320px, ${ratio}fr) 4px minmax(280px, ${1 - ratio}fr)`;
    }

    resizer.addEventListener('mousedown', (e) => {
      isResizing = true;
      startX = e.clientX;
      startChatWidth = chatZone.offsetWidth;
      resizer.classList.add('dragging');
      document.body.style.cursor = 'col-resize';
      e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
      if (!isResizing) return;

      const diff = e.clientX - startX;
      const newChatWidth = startChatWidth + diff;
      const totalWidth = layout.offsetWidth;
      const minChat = 320;
      const minDash = 280;

      if (newChatWidth < minChat || totalWidth - newChatWidth - 4 < minDash) return;

      const ratio = newChatWidth / totalWidth;
      layout.style.gridTemplateColumns = `minmax(320px, ${ratio}fr) 4px minmax(280px, ${1 - ratio}fr)`;
    });

    document.addEventListener('mouseup', () => {
      if (!isResizing) return;
      isResizing = false;
      resizer.classList.remove('dragging');
      document.body.style.cursor = '';

      // Save ratio
      const chatWidth = chatZone.offsetWidth;
      const totalWidth = layout.offsetWidth;
      const ratio = chatWidth / totalWidth;
      localStorage.setItem('dashboard_ratio', ratio.toString());
    });

    // Double click to reset
    resizer.addEventListener('dblclick', () => {
      layout.style.gridTemplateColumns = 'minmax(320px, 1.618fr) 4px minmax(280px, 1fr)';
      localStorage.removeItem('dashboard_ratio');
    });
  }

  // ========== Mobile Tabs ==========
  function initMobileTabs() {
    const chatTab = $('#mobile-tab-chat');
    const dashTab = $('#mobile-tab-dashboard');

    if (chatTab) {
      chatTab.addEventListener('click', () => {
        document.body.setAttribute('data-mobile-tab', 'chat');
        chatTab.classList.add('ui-mobile-tab--active');
        dashTab?.classList.remove('ui-mobile-tab--active');
      });
    }

    if (dashTab) {
      dashTab.addEventListener('click', () => {
        document.body.setAttribute('data-mobile-tab', 'dashboard');
        dashTab.classList.add('ui-mobile-tab--active');
        chatTab?.classList.remove('ui-mobile-tab--active');
      });
    }
  }

  // ========== Init ==========
  function init() {
    initTabs();
    initTaskActions();
    initCheckin();
    initResizer();
    initMobileTabs();
  }

  // Run on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Expose for debugging
  window.Dashboard = {
    loadOverview,
    loadStatus,
    loadTrends,
    loadTasks,
    loadRelations,
    loadExplore,
    refresh: () => {
      loadedTabs.clear();
      const activeTab = $('.ui-tab--active')?.dataset?.tab || 'overview';
      loadTabData(activeTab);
    }
  };

})();
