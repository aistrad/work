"use client";

import { useState, useEffect, Suspense } from "react";
import { useSearchParams } from "next/navigation";
import Link from "next/link";
import { ArrowRight, Target, Calendar, Lightbulb, MessageCircle } from "lucide-react";
import { LuminousPaper, VibeGlyph, BreathAura, InsightSeal } from "@/components/core";
import { Button } from "@/components/ui/Button";
import { Card, CardContent, CardHeader, CardTitle, GlassCard } from "@/components/ui/Card";
import { BirthDateInputs } from "@/components/ui/Input";
import { invokeGuestTool } from "@/lib/api";

// ═══════════════════════════════════════════════════════════════════════════
// BaZi Landing Page - LUMINOUS PAPER Design System
// 八字命理技能页面：光纸背景 + 五行木色 glow
// ═══════════════════════════════════════════════════════════════════════════

interface ToolResult {
  rawResult: string;
  interpretation: string;
  chartData?: Record<string, unknown>;
}

function BaziContent() {
  const searchParams = useSearchParams();

  // Initialize from URL params
  const [year, setYear] = useState(searchParams.get("year") || "");
  const [month, setMonth] = useState(searchParams.get("month") || "");
  const [day, setDay] = useState(searchParams.get("day") || "");
  const [hour, setHour] = useState(searchParams.get("hour") || "unknown");

  const [result, setResult] = useState<ToolResult | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  // Auto-analyze if URL has complete params
  useEffect(() => {
    if (searchParams.get("year") && searchParams.get("month") && searchParams.get("day")) {
      handleAnalysis();
    }
  }, []);

  const handleAnalysis = async () => {
    if (!year || !month || !day) return;

    setIsLoading(true);
    setError(null);
    setResult(null);

    try {
      const birthDate = `${year}-${month}-${day}`;
      const response = await invokeGuestTool({
        skill_id: "bazi",
        tool: "bazi_chart",
        birth_date: birthDate,
        birth_time: hour !== "unknown" ? hour : undefined,
      });

      if (response.success) {
        setResult({
          rawResult: response.raw_result || "",
          interpretation: response.interpretation || "",
          chartData: response.chart_data,
        });
      } else {
        setError(response.error || "分析失败");
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : "分析失败，请稍后再试");
    } finally {
      setIsLoading(false);
    }
  };

  const isFormValid = year && month && day;

  return (
    <LuminousPaper skill="bazi" variant="hero" className="min-h-screen">
      {/* Background aura */}
      <BreathAura skill="bazi" size="xl" position="top" intensity="low" className="opacity-50" />

      {/* Navigation */}
      <nav className="nav">
        <div className="nav-container">
          <Link href="/" className="flex items-center gap-2">
            <VibeGlyph size="sm" skill="bazi" showAura={false} animate={false} />
            <span className="nav-logo text-bazi-primary">八字命理</span>
          </Link>
          <div className="nav-links">
            <Link href="/bazi/chat" className="nav-link">
              深度对话
            </Link>
            <Link href="/auth/login">
              <Button variant="primary" size="sm">
                登录
              </Button>
            </Link>
          </div>
        </div>
      </nav>

      {/* Hero Section */}
      <section className="pt-32 pb-16 px-4">
        <div className="max-w-3xl mx-auto text-center">
          <h1 className="hero-title text-bazi-primary mb-4">
            知命 · 造命
          </h1>
          <p className="hero-subtitle mb-10">
            通过八字了解你的天赋与人生节奏
          </p>

          {/* Quick Analysis Form */}
          <GlassCard className="max-w-md mx-auto p-6 md:p-8">
            <div className="flex items-center justify-between mb-6">
              <h3 className="font-serif font-semibold text-foreground">
                快速体验
              </h3>
              <InsightSeal skill="bazi" size="sm" label="BZ" />
            </div>

            <BirthDateInputs
              year={year}
              month={month}
              day={day}
              hour={hour}
              onYearChange={setYear}
              onMonthChange={setMonth}
              onDayChange={setDay}
              onHourChange={setHour}
              showHour
              className="mb-6"
            />

            <Button
              onClick={handleAnalysis}
              disabled={!isFormValid}
              isLoading={isLoading}
              className="w-full bg-bazi-primary hover:bg-bazi-primary/90"
            >
              查看命盘
              <ArrowRight className="w-5 h-5" />
            </Button>
          </GlassCard>

          {/* Error */}
          {error && (
            <Card variant="bordered" className="mt-6 p-4 border-red-200 bg-red-50 dark:bg-red-900/20">
              <p className="text-red-600 dark:text-red-400">{error}</p>
            </Card>
          )}

          {/* Result */}
          {result && (
            <div className="mt-8 space-y-6 animate-fade-in-up">
              {/* Chart Data */}
              <Card variant="default" className="text-left">
                <CardHeader>
                  <CardTitle className="text-bazi-primary">八字命盘</CardTitle>
                </CardHeader>
                <CardContent>
                  <pre className="whitespace-pre-wrap text-sm text-muted-foreground font-mono bg-muted/30 p-4 rounded-lg overflow-x-auto">
                    {result.rawResult}
                  </pre>
                </CardContent>
              </Card>

              {/* Interpretation */}
              {result.interpretation && (
                <Card variant="insight" className="text-left border-l-bazi-primary">
                  <CardHeader>
                    <CardTitle className="text-bazi-primary">AI 解读</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-muted-foreground leading-relaxed">
                      {result.interpretation}
                    </p>
                  </CardContent>
                </Card>
              )}

              {/* CTA */}
              <GlassCard className="p-6 text-center">
                <p className="text-foreground mb-4">
                  想要了解更多？注册后可获得：
                </p>
                <ul className="text-sm text-muted-foreground mb-6 space-y-2">
                  <li className="flex items-center justify-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-bazi-primary" />
                    大运流年详细分析
                  </li>
                  <li className="flex items-center justify-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-bazi-primary" />
                    十神格局深度解读
                  </li>
                  <li className="flex items-center justify-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-bazi-primary" />
                    事业/感情/健康个性化建议
                  </li>
                  <li className="flex items-center justify-center gap-2">
                    <span className="w-1.5 h-1.5 rounded-full bg-bazi-primary" />
                    无限次深度对话咨询
                  </li>
                </ul>
                <div className="flex flex-col sm:flex-row gap-3 justify-center">
                  <Link href="/auth/register">
                    <Button className="bg-bazi-primary hover:bg-bazi-primary/90">
                      注册获取完整解读
                    </Button>
                  </Link>
                  <Link href="/bazi/chat">
                    <Button variant="outline">
                      <MessageCircle className="w-4 h-4" />
                      开始对话
                    </Button>
                  </Link>
                </div>
              </GlassCard>
            </div>
          )}
        </div>
      </section>

      {/* Features Section */}
      <section className="py-16 px-4 bg-card/50">
        <div className="max-w-4xl mx-auto">
          <h2 className="section-title text-center text-bazi-primary mb-8">
            八字能告诉你什么？
          </h2>

          <div className="grid md:grid-cols-3 gap-6">
            <Card variant="bordered" className="p-6 text-center">
              <div className="w-12 h-12 rounded-full bg-bazi-glow flex items-center justify-center mx-auto mb-4">
                <Target className="w-6 h-6 text-bazi-primary" />
              </div>
              <h3 className="font-serif font-semibold mb-2">性格天赋</h3>
              <p className="text-sm text-muted-foreground">
                了解你的天性、优势和潜在挑战
              </p>
            </Card>

            <Card variant="bordered" className="p-6 text-center">
              <div className="w-12 h-12 rounded-full bg-bazi-glow flex items-center justify-center mx-auto mb-4">
                <Calendar className="w-6 h-6 text-bazi-primary" />
              </div>
              <h3 className="font-serif font-semibold mb-2">运势节奏</h3>
              <p className="text-sm text-muted-foreground">
                把握大运流年，顺势而为
              </p>
            </Card>

            <Card variant="bordered" className="p-6 text-center">
              <div className="w-12 h-12 rounded-full bg-bazi-glow flex items-center justify-center mx-auto mb-4">
                <Lightbulb className="w-6 h-6 text-bazi-primary" />
              </div>
              <h3 className="font-serif font-semibold mb-2">人生指引</h3>
              <p className="text-sm text-muted-foreground">
                事业、感情、健康的方向建议
              </p>
            </Card>
          </div>
        </div>
      </section>

      {/* Footer */}
      <footer className="py-8 text-center border-t border-border/50">
        <p className="text-sm text-muted-foreground">
          © 2026 VibeLife · 八字命理
        </p>
        <Link href="/" className="text-sm text-bazi-primary hover:underline mt-1 inline-block">
          返回 VibeLife
        </Link>
      </footer>
    </LuminousPaper>
  );
}

export default function BaziLandingPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen bg-vellum flex items-center justify-center">
        <VibeGlyph size="lg" skill="bazi" animate />
      </div>
    }>
      <BaziContent />
    </Suspense>
  );
}
