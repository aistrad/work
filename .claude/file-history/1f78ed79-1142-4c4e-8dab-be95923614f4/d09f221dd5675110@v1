"use client";

import { useState } from "react";
import Link from "next/link";
import { Button } from "@/components/ui/Button";
import { Card } from "@/components/ui/Card";
import { invokeGuestTool, GuestToolResponse } from "@/lib/api";

interface ToolResult {
  rawResult: string;
  interpretation: string;
  chartData?: Record<string, unknown>;
}

export default function BaziLandingPage() {
  const [birthDate, setBirthDate] = useState("");
  const [birthTime, setBirthTime] = useState("");
  const [result, setResult] = useState<ToolResult | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleQuickAnalysis = async () => {
    if (!birthDate) return;

    setIsLoading(true);
    setError(null);
    setResult(null);

    try {
      const response = await invokeGuestTool({
        skill_id: "bazi",
        tool: "bazi_chart",
        birth_date: birthDate,
        birth_time: birthTime || undefined,
      });

      if (response.success) {
        setResult({
          rawResult: response.raw_result || "",
          interpretation: response.interpretation || "",
          chartData: response.chart_data,
        });
      } else {
        setError(response.error || "åˆ†æå¤±è´¥");
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : "åˆ†æå¤±è´¥ï¼Œè¯·ç¨åå†è¯•");
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <main className="min-h-screen bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-gray-900 dark:to-amber-950">
      {/* Header */}
      <header className="fixed top-0 left-0 right-0 z-50 bg-white/80 dark:bg-gray-900/80 backdrop-blur border-b border-amber-200 dark:border-amber-900">
        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
          <Link href="/" className="flex items-center gap-2">
            <span className="text-2xl">â˜¯ï¸</span>
            <span className="font-bold text-amber-800 dark:text-amber-200">å…«å­—å‘½ç†</span>
          </Link>
          <div className="flex items-center gap-4">
            <Link href="/bazi/chat" className="text-amber-700 dark:text-amber-300 hover:underline">
              æ·±åº¦å¯¹è¯
            </Link>
            <Link href="/auth/login">
              <Button size="sm">ç™»å½•</Button>
            </Link>
          </div>
        </div>
      </header>

      {/* Hero */}
      <section className="pt-32 pb-16 px-4">
        <div className="max-w-3xl mx-auto text-center animate-fade-in">
          <h1 className="text-5xl font-bold mb-4 text-amber-900 dark:text-amber-100">
            çŸ¥å‘½ Â· é€ å‘½
          </h1>
          <p className="text-xl text-amber-700 dark:text-amber-300 mb-8">
            é€šè¿‡å…«å­—äº†è§£ä½ çš„å¤©èµ‹ä¸äººç”ŸèŠ‚å¥
          </p>

          {/* Quick Analysis Form */}
          <Card className="max-w-md mx-auto bg-white/80 dark:bg-gray-800/80">
            <h3 className="font-semibold mb-4 text-amber-800 dark:text-amber-200">
              å¿«é€Ÿä½“éªŒ
            </h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                  å‡ºç”Ÿæ—¥æœŸ
                </label>
                <input
                  type="date"
                  value={birthDate}
                  onChange={(e) => setBirthDate(e.target.value)}
                  className="w-full px-4 py-2 rounded-lg border border-amber-200 dark:border-amber-800 bg-white dark:bg-gray-900"
                />
              </div>
              <div>
                <label className="block text-sm text-gray-600 dark:text-gray-400 mb-1">
                  å‡ºç”Ÿæ—¶è¾°ï¼ˆå¯é€‰ï¼‰
                </label>
                <select
                  value={birthTime}
                  onChange={(e) => setBirthTime(e.target.value)}
                  className="w-full px-4 py-2 rounded-lg border border-amber-200 dark:border-amber-800 bg-white dark:bg-gray-900"
                >
                  <option value="">ä¸ç¡®å®š</option>
                  <option value="å­æ—¶(23:00-01:00)">å­æ—¶ (23:00-01:00)</option>
                  <option value="ä¸‘æ—¶(01:00-03:00)">ä¸‘æ—¶ (01:00-03:00)</option>
                  <option value="å¯…æ—¶(03:00-05:00)">å¯…æ—¶ (03:00-05:00)</option>
                  <option value="å¯æ—¶(05:00-07:00)">å¯æ—¶ (05:00-07:00)</option>
                  <option value="è¾°æ—¶(07:00-09:00)">è¾°æ—¶ (07:00-09:00)</option>
                  <option value="å·³æ—¶(09:00-11:00)">å·³æ—¶ (09:00-11:00)</option>
                  <option value="åˆæ—¶(11:00-13:00)">åˆæ—¶ (11:00-13:00)</option>
                  <option value="æœªæ—¶(13:00-15:00)">æœªæ—¶ (13:00-15:00)</option>
                  <option value="ç”³æ—¶(15:00-17:00)">ç”³æ—¶ (15:00-17:00)</option>
                  <option value="é…‰æ—¶(17:00-19:00)">é…‰æ—¶ (17:00-19:00)</option>
                  <option value="æˆŒæ—¶(19:00-21:00)">æˆŒæ—¶ (19:00-21:00)</option>
                  <option value="äº¥æ—¶(21:00-23:00)">äº¥æ—¶ (21:00-23:00)</option>
                </select>
              </div>
              <Button
                onClick={handleQuickAnalysis}
                className="w-full bg-amber-600 hover:bg-amber-700"
                isLoading={isLoading}
                disabled={!birthDate}
              >
                æŸ¥çœ‹å‘½ç›˜
              </Button>
            </div>
          </Card>

          {/* Error */}
          {error && (
            <div className="mt-6 p-4 bg-red-50 dark:bg-red-900/30 rounded-lg text-red-700 dark:text-red-300">
              {error}
            </div>
          )}

          {/* Result */}
          {result && (
            <div className="mt-8 animate-slide-up space-y-6">
              {/* Chart Data Display */}
              <Card className="text-left bg-white/90 dark:bg-gray-800/90">
                <h4 className="font-semibold text-amber-800 dark:text-amber-200 mb-4">
                  å…«å­—å‘½ç›˜
                </h4>
                <pre className="whitespace-pre-wrap text-sm text-gray-700 dark:text-gray-300 font-mono bg-amber-50 dark:bg-gray-900 p-4 rounded-lg overflow-x-auto">
                  {result.rawResult}
                </pre>
              </Card>

              {/* Interpretation */}
              {result.interpretation && (
                <Card className="text-left bg-gradient-to-br from-amber-50 to-yellow-50 dark:from-amber-900/30 dark:to-yellow-900/30">
                  <h4 className="font-semibold text-amber-800 dark:text-amber-200 mb-3">
                    AI è§£è¯»
                  </h4>
                  <p className="text-gray-700 dark:text-gray-300 leading-relaxed">
                    {result.interpretation}
                  </p>
                </Card>
              )}

              {/* CTA */}
              <Card className="bg-white/90 dark:bg-gray-800/90">
                <div className="text-center">
                  <p className="text-amber-700 dark:text-amber-300 mb-4">
                    æƒ³è¦äº†è§£æ›´å¤šï¼Ÿæ³¨å†Œåå¯è·å¾—ï¼š
                  </p>
                  <ul className="text-sm text-gray-600 dark:text-gray-400 mb-6 space-y-1">
                    <li>âœ“ å¤§è¿æµå¹´è¯¦ç»†åˆ†æ</li>
                    <li>âœ“ åç¥æ ¼å±€æ·±åº¦è§£è¯»</li>
                    <li>âœ“ äº‹ä¸š/æ„Ÿæƒ…/å¥åº·ä¸ªæ€§åŒ–å»ºè®®</li>
                    <li>âœ“ æ— é™æ¬¡å¯¹è¯å’¨è¯¢</li>
                  </ul>
                  <Link href="/auth/register">
                    <Button className="bg-amber-600 hover:bg-amber-700">
                      æ³¨å†Œè·å–å®Œæ•´è§£è¯»
                    </Button>
                  </Link>
                </div>
              </Card>
            </div>
          )}
        </div>
      </section>

      {/* Features */}
      <section className="py-16 px-4 bg-white/50 dark:bg-gray-800/50">
        <div className="max-w-4xl mx-auto">
          <h2 className="text-2xl font-bold text-center mb-8 text-amber-800 dark:text-amber-200">
            å…«å­—èƒ½å‘Šè¯‰ä½ ä»€ä¹ˆï¼Ÿ
          </h2>
          <div className="grid md:grid-cols-3 gap-6">
            <Card variant="bordered">
              <div className="text-3xl mb-3">ğŸ¯</div>
              <h3 className="font-semibold mb-2">æ€§æ ¼å¤©èµ‹</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                äº†è§£ä½ çš„å¤©æ€§ã€ä¼˜åŠ¿å’Œæ½œåœ¨æŒ‘æˆ˜
              </p>
            </Card>
            <Card variant="bordered">
              <div className="text-3xl mb-3">ğŸ“…</div>
              <h3 className="font-semibold mb-2">è¿åŠ¿èŠ‚å¥</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                æŠŠæ¡å¤§è¿æµå¹´ï¼Œé¡ºåŠ¿è€Œä¸º
              </p>
            </Card>
            <Card variant="bordered">
              <div className="text-3xl mb-3">ğŸ’¡</div>
              <h3 className="font-semibold mb-2">äººç”ŸæŒ‡å¼•</h3>
              <p className="text-sm text-gray-600 dark:text-gray-400">
                äº‹ä¸šã€æ„Ÿæƒ…ã€å¥åº·çš„æ–¹å‘å»ºè®®
              </p>
            </Card>
          </div>
        </div>
      </section>

      {/* Footer */}
      <footer className="py-8 text-center text-amber-700 dark:text-amber-400 text-sm">
        <p>Â© 2026 VibeLife Â· å…«å­—å‘½ç†</p>
        <p className="mt-1">
          <Link href="/" className="hover:underline">è¿”å› VibeLife</Link>
        </p>
      </footer>
    </main>
  );
}
