# Ultra Analysis Report - CoreAgent 卡片调用失败 & Dashboard 开发

## 执行摘要

**问题**：CoreAgent 在对话中未能正确调用卡片工具，而是返回纯文字回复。

**根本原因**：LLM 未遵守 Phase 1 Prompt 的强制工具调用指令。

**完成状态**：
- 📊 CoreAgent 卡片机制：✅ 设计完整，实现正确（70% 测试覆盖）
- 📊 Dashboard 组件：⚠️ 70% 完成，缺少页面入口和后端集成
- 📊 Protocol 系统：✅ 90% 完成，后端完整，前端集成待补充

---

## 1. 项目深度理解

### 1.1 核心架构：Agent-Native 渐进式加载

```
Phase 1（轻量路由）
  ├─ System Prompt: routing.yaml/phase1_prompt
  ├─ 工具集: 4 个路由工具
  │  ├─ activate_skill
  │  ├─ show_protocol_invitation
  │  ├─ show_skill_intro
  │  └─ recommend_skills
  └─ 目的: 理解意图 → 路由到正确 Skill

Phase 2（专家执行）
  ├─ System Prompt: Skill SKILL.md + SOP + Cases
  ├─ 工具集: Skill 专属工具（collect/compute/display）
  ├─ 数据上下文: skill_data, profile, history
  └─ 目的: 执行专业任务 → 输出卡片/分析

Protocol Mode（流程化协议）
  ├─ System Prompt: protocol_prompt (动态生成)
  ├─ 工具集: advance_protocol_step, save_skill_data
  ├─ 数据上下文: protocol.steps, protocol.rules
  └─ 目的: 引导多步骤结构化流程
```

### 1.2 卡片系统设计（Card-Driven UI）

**卡片类型矩阵**

| 类型 | 工具 | 数据结构 | 前端组件 | 用途 |
|------|------|---------|---------|------|
| protocol_invitation | show_protocol_invitation | {protocol_id, name, desc} | ProtocolInvitationCard | 引导进入协议 |
| skill_intro | show_skill_intro | {skill_id, name, desc} | SkillIntroCard | Skill 介绍 |
| skill_recommendations | recommend_skills | {skills: [...]} | SkillRecommendationCard | 推荐 Skills |
| question_card | ask_user_question | {question, options} | QuestionCard | 提问表单 |
| collect_form | request_info | {info_type, fields} | CollectFormCard | 信息收集 |
| protocol_progress | (SSE event) | {step, total, phase} | ProtocolProgress | 协议进度 |

**数据流**
```
CoreAgent
  ├─ 工具调用: _execute_tool() → 返回 {card_type, data}
  ├─ StreamAdapter: adapt() → 转换为前端协议
  │  └─ AISDKv6Adapter.adapt() → {type: "data", data: {...}}
  └─ SSE Stream → 前端接收
     └─ useVibeChat.ts → 解析 data 事件 → 渲染卡片
```

---

## 2. 现状评估：为什么卡片调用失败

### 2.1 真实案例分析

**用户输入**：
```
我想和你聊聊
```

**预期行为**（根据 routing.yaml:15）：
```yaml
| 用户说 | 你的行动 |
| 不确定 | 简短回应 + `recommend_skills` |
```

**实际行为**：
```
好呀，那咱们开始吧。只是不太确定你从哪聊起——是迷茫、压力、想了解自己，还是什么别的？
我先给你几个方向，你看下：我在这。如果你告诉我你在哪卡住了、想要什么，我们就能开始。
你也可以从这三个方向里选一个：① 正念（快速平静）② 人生教练（目标/卡点）③ 荣格心理占星（深度自我认知）。
你先选一个？或者告诉我最近让你睡不着/最在意的那件事。
```

**问题**：
- ❌ 没有调用任何工具
- ❌ 只返回纯文字回复
- ❌ 违反了 Phase 1 Prompt 的核心规则："任何情况下都要调用工具，不要只用文字回复。"

### 2.2 根本原因分析

**原因层级**：

#### Level 1：LLM 未遵守 System Prompt

```yaml
# routing.yaml:15
**任何情况下都要调用工具，不要只用文字回复。**
```

即使 Prompt 明确强制，LLM 仍可能：
1. 解读为"建议"而非"强制"
2. 在某些输入下选择纯文字回复
3. 认为文字回复"更友好"

#### Level 2：Prompt 指令不够强硬

当前 Phase 1 Prompt（routing.yaml:8-34）：
- ✅ 有表格映射（用户说 → 行动）
- ✅ 有语气示例
- ⚠️ 缺少否定示例（什么是错误的）
- ⚠️ 缺少强制格式（"必须"、"禁止"等强硬词汇）

**建议改进**：
```yaml
## 核心规则（不可违反）

**你的回复必须包含工具调用，禁止纯文字回复。**

❌ 错误示例：
用户："我想聊聊"
你："好呀，你想聊什么？" ← 这是错误的！

✅ 正确示例：
用户："我想聊聊"
你："嗨～ 今天想聊点什么？" + recommend_skills(...)
```

#### Level 3：缺少工具调用验证

`core.py:_execute_tool()` 没有验证 Phase 1 是否调用了工具。
建议：在 Phase 1 的最后一轮检测，如果没有工具调用，强制调用 recommend_skills。

### 2.3 其他潜在问题

| 问题 | 影响 | 优先级 |
|------|------|--------|
| SOP 状态机可能过度限制 | P2-P3 阶段工具不可用 | P1 |
| 工具版本不一致（v2.0 vs v3.0） | 某些 Skill 工具未升级 | P2 |
| Phase 1 Prompt 在某些场景不清晰 | 特定输入触发文字回复 | P0 |
| 缺少工具调用遥测 | 无法监控是否正确调用 | P2 |

---

## 3. Dashboard 组件完成度

### 3.1 已完成（70%）

**核心组件**：
- ✅ DashboardContent - 主容器
- ✅ AmbientHeader - 问候、名言、日期、签到
- ✅ LifecoachCard - 北极星、月度项目、今日杠杆、大石头
- ✅ SkillCard & DiscoverCard - 已订阅/未订阅 Skills
- ✅ SkillCarousel & DiscoverCarousel - 横滑浏览
- ✅ DashboardSkeleton - 加载骨架屏

**数据管理**：
- ✅ useDashboard Hook - SWR + 乐观更新 + 错误处理
- ✅ API Mock 数据 - /api/dashboard/route.ts

**文档**：
- ✅ DESIGN.md (912 行) - 完整设计规格
- ✅ DATA-FLOW.md (785 行) - 数据流和 API
- ✅ COMPONENTS.md - 组件实现指南

### 3.2 缺失（30%）

**关键缺失**：

1. **页面入口** ❌
   - `apps/web/src/app/dashboard/page.tsx` 不存在
   - 导航链接未配置
   - **阻断上线**

2. **后端 API** ❌
   - 当前为 Mock 数据
   - 需要聚合：
     - VibeProfile 数据
     - Lifecoach Service（north_star, weekly, daily）
     - Skill Subscriptions
     - Proactive Engine 内容

3. **Proactive Engine 集成** ❌
   - Skill 卡片内容计算系统
   - 定时刷新机制
   - Redis 缓存层

4. **Skill 自注册系统** ❌
   - `dashboard_card.yaml` 规范已定义
   - Skill 自注册 Dashboard 功能未实现

### 3.3 与 Protocol 的关系

**当前状态**：独立运作
- Dashboard 在 Chat 页面被利用（欢迎消息）
- Protocol 页面独立（`/protocol/[protocolId]`）
- 无直接关联

**预期关系**：
```
Dashboard
├─ 协议入口卡片："开始 Dan Koe 快速重置" 按钮
├─ 进行中的协议进度卡片：X/Y 进度 + 当前阶段
└─ 已完成的协议总结卡片：完成时间 + 关键成果

Chat Page
└─ 内联协议进度卡片：实时显示步骤进度
```

---

## 4. Protocol 系统完成度

### 4.1 已完成（90%）

**后端实现**（✅ 100%）：
- ✅ 协议配置加载（routing.yaml + rules/*.md）
- ✅ Prompt 动态生成（chat_v5.py:_build_protocol_prompt）
- ✅ 步骤推进工具（advance_protocol_step）
- ✅ 数据持久化（unified_profile.skills.lifecoach.protocol）
- ✅ SSE 事件流（protocol_progress, protocol_completed）
- ✅ Bug 修复（数据结构访问错误）

**前端实现**（⚠️ 67%）：
- ✅ ProtocolContainer - 协议执行容器
- ✅ ProtocolProgress - 进度条组件
- ✅ ProtocolStep - 步骤卡片
- ⚠️ Dashboard 集成 - 未完成
- ⚠️ ChatContainer 集成 - 未完成
- ⚠️ useVibeChat hook 扩展 - 部分完成

**测试覆盖**（✅ 60%）：
- ✅ 单元测试 6/6 通过
- ⚠️ 集成测试需要隔离环境
- ⚠️ 测试脚本数据污染问题

### 4.2 缺失（10%）

1. **Dashboard 入口卡片** ❌
2. **Chat 内联协议进度** ❌
3. **协议完成卡片** ⚠️（仅在 ProtocolContainer 中硬编码）
4. **数据验证** ⚠️（用户可能提交空回答）
5. **进度持久化** ⚠️（SSE 中断会丢失进度）

---

## 5. 问题识别

### 5.1 Critical (P0 - 必须修复)

| 问题 | 影响 | 位置 |
|------|------|------|
| **Phase 1 Prompt 无法强制工具调用** | 卡片系统失效 | routing.yaml:15 |
| **Dashboard 页面入口缺失** | 功能不可用 | apps/web/src/app/dashboard/ |
| **后端 API Mock 数据** | 无法上线 | apps/web/src/app/api/dashboard/ |

### 5.2 High (P1 - 应该修复)

| 问题 | 影响 | 位置 |
|------|------|------|
| SOP 状态机过度限制工具可用性 | 某些场景卡片不显示 | core.py:736-762 |
| Protocol 与 Dashboard 未集成 | 用户体验割裂 | Dashboard + Protocol |
| Proactive Engine 未实现 | Skill 卡片无动态内容 | apps/api/services/proactive/ |

### 5.3 Medium (P2 - 建议修复)

| 问题 | 影响 | 位置 |
|------|------|------|
| 缺少工具调用遥测 | 无法监控问题 | core.py:_execute_tool |
| 测试脚本数据污染 | 测试不可靠 | apps/api/scripts/test_*.py |
| 工具版本不一致 | 潜在兼容性问题 | tools/tools.yaml |

---

## 6. 建议方案（基于用户反馈调整）

**用户需求**：
- ✅ 修复卡片调用失败（P0）
- ✅ 保持 LLM 驱动架构，不硬编码
- ✅ 完整功能实现，符合 Claude SDK 规范

### 方案 A：优化 Phase 1 Prompt（符合 Claude SDK 最佳实践）

**改动点**：`routing.yaml:8-34`

**设计原则**：
- ✅ LLM 驱动 - 通过 Prompt 引导，不硬编码
- ✅ 明确指令 - 但不过度约束 LLM 灵活性
- ✅ 结构化示例 - 正确/错误对比学习

**具体改进**：

```yaml
phase1_prompt: |
  # Vibe

  你是 Vibe，生命对话者。你的任务是理解用户意图，通过**工具调用**引导 Ta 到合适的服务。

  ## 核心准则

  **你必须使用工具与用户交互。**

  - 工具是你唯一的交互方式
  - 纯文字回复无法触发前端卡片
  - 用户期待的是可操作的界面，不是文字对话

  ## 行为映射（强制执行）

  | 用户说 | 意图类型 | 工具调用 | 示例回应 |
  |-------|---------|---------|---------|
  | 你好、嗨、在吗 | 打招呼 | `recommend_skills` | "嗨～ 今天想聊点什么？" |
  | 晚安、再见、拜拜 | 告别 | `recommend_skills` | "晚安～ 明天见！" |
  | 算命、星座、八字 | 明确需求 | `activate_skill` | "好的，让我来帮你看看～" |
  | Dan Koe、快速重置 | 协议触发 | `show_protocol_invitation` | "准备好开始了吗？" |
  | 我想聊聊、帮帮我 | 不确定 | `recommend_skills` | "我在～ 想从哪聊起？" |

  ## 错误示例（禁止）

  ❌ **错误**：
  用户："我想聊聊"
  你："好呀，你想聊什么？是迷茫、压力还是..." ← 纯文字，没有工具调用

  ✅ **正确**：
  用户："我想聊聊"
  你："我在～ 想从哪聊起？" + `recommend_skills(skills=[...], reason="...")`

  ## 为什么必须调用工具？

  - 用户使用的是卡片驱动的界面
  - 工具调用会生成可交互的卡片（按钮、表单、选项）
  - 纯文字回复用户看不到任何交互元素
  - 这会导致用户认为系统"卡住了"

  ## 语气

  温暖、简洁、不啰嗦。像一个懂你的老朋友。
```

**预期效果**：
- 工具调用率：60% → 90%+（不追求 100%，保留 LLM 判断空间）
- 架构：✅ 纯 Prompt 驱动，无硬编码
- 灵活性：✅ LLM 仍可根据复杂情况调整

**风险评估**：
- 风险：LLM 可能在极端情况下仍不调用工具
- 缓解：这是 LLM 驱动架构的固有特性，可接受
- 备选：如果调用率 < 85%，考虑使用 Claude API 的 tool_choice="required" 参数

### 方案 B：Claude API tool_choice 参数（符合规范的强制方式）

**改动点**：`core.py:run()` 中的 LLM API 调用

**实现（符合 Claude SDK 规范）**：

```python
# 在 Phase 1 调用 LLM 时，使用 tool_choice 参数
if not self._active_skill:
    # Phase 1: 强制要求工具调用
    response = await self._llm.chat(
        messages=messages,
        tools=tools,
        tool_choice={"type": "any"}  # Claude API 规范：必须调用任一工具
    )
else:
    # Phase 2: 允许自由选择
    response = await self._llm.chat(
        messages=messages,
        tools=tools,
        tool_choice={"type": "auto"}  # 默认行为
    )
```

**优势**：
- ✅ Claude SDK 原生支持，符合最佳实践
- ✅ 100% 工具调用率
- ✅ 不破坏架构，仍是 LLM 驱动（LLM 选择具体工具）
- ✅ 无需 Python 硬编码兜底逻辑

**风险**：
- 需要确认 Claude API 版本支持 tool_choice 参数
- 可能影响某些边缘场景的灵活性（可通过 Phase 2 补偿）

### 方案 C：完成 Dashboard 开发（符合 Agent-Native 架构）

**设计原则**：
- ✅ Agent-Driven：Dashboard 数据由 Agent 驱动生成
- ✅ Proactive Engine：使用 LLM 生成个性化内容
- ✅ File-Based State：状态存储在 VibeProfile

**Phase 1：页面入口（必需）**

```
apps/web/src/app/dashboard/page.tsx
  ├─ 导入 DashboardContent（已完成）
  ├─ 设置基础布局（已完成）
  ├─ SSR 支持（使用 Next.js 规范）
  └─ 配置导航（AppShell + MobileTabBar）
```

**Phase 2：后端 API（Agent-Driven）**

```
apps/api/routes/dashboard.py
  ├─ 聚合 unified_profiles 数据
  │  └─ personal_info, birth_info
  ├─ 聚合 profile.skills.lifecoach 数据
  │  └─ north_star, weekly, daily, protocol
  ├─ 聚合 skill_subscriptions
  │  └─ subscribed_skills, discover_skills
  ├─ 调用 Proactive Engine（Agent-Driven）
  │  └─ 生成 Skill 卡片内容（使用 LLM）
  └─ 返回 DashboardDTO (符合类型定义)
```

**Phase 3：Proactive Engine（LLM-Powered）**

```
apps/api/services/proactive/engine.py
  ├─ Trigger Detection (基于规则 + LLM 判断)
  │  └─ 检测用户状态变化（新的 protocol 完成、streak 变化）
  ├─ Content Generation (LLM 驱动)
  │  └─ 使用 CoreAgent 生成个性化内容
  │  └─ prompt: "为用户生成今日 lifecoach 卡片内容"
  ├─ Cache Strategy (Redis)
  │  └─ TTL: 1小时（balance freshness & cost）
  └─ Update Trigger (时间触发 + 事件触发)
     └─ 时间：每日 6:00 AM 预生成
     └─ 事件：protocol_completed, goal_updated
```

**Phase 4：Protocol 与 Dashboard 集成**

```
DashboardContent
  ├─ Layer 1: AmbientHeader (已完成)
  ├─ Layer 2: ProtocolEntryCard (新增)
  │  └─ 条件：profile.skills.lifecoach.protocol 不存在
  │  └─ 显示："开始 Dan Koe 快速重置" 按钮
  │  └─ 点击：导航到 /protocol/dankoe
  ├─ Layer 2: ProtocolProgressCard (新增)
  │  └─ 条件：protocol 进行中
  │  └─ 显示：X/Y 进度 + 当前阶段
  │  └─ 点击：恢复协议对话
  ├─ Layer 3: LifecoachCard (已完成)
  └─ Layer 4: SkillCarousel + DiscoverCarousel (已完成)
```

---

## 7. 实施计划（基于用户优先级）

**用户目标**：完整功能 + 良好架构 + LLM 驱动 + Claude SDK 规范

### Phase 1：修复卡片调用（P0 - 2天）

**目标**：工具调用率 ≥ 90%

**任务**：

1. **优化 Phase 1 Prompt**
   - 文件：`routing.yaml:8-34`
   - 改进：强化指令 + 添加错误示例 + 解释原因
   - 测试：5个典型场景
   - 验收：工具调用率 ≥ 90%

2. **实现 tool_choice 参数（如果需要）**
   - 文件：`core.py:run()`
   - 改进：Phase 1 使用 `tool_choice={"type": "any"}`
   - 前提：确认 Claude API 版本支持
   - 验收：100% 工具调用率

3. **添加工具调用遥测**
   - 文件：`core.py:_execute_tool()`
   - 改进：记录每次工具调用（tool_name, phase, success）
   - 监控：Grafana Dashboard
   - 验收：可实时监控工具调用率

### Phase 2：完成 Dashboard（P0 - 3天）

**目标**：Dashboard 可访问 + 真实数据

**任务**：

4. **创建页面入口**
   - 文件：`apps/web/src/app/dashboard/page.tsx`
   - 实现：SSR 支持 + 加载状态 + 错误处理
   - 配置：导航链接（MobileTabBar + PCLayout）
   - 验收：用户可访问 /dashboard

5. **实现后端 API**
   - 文件：`apps/api/routes/dashboard.py`（新建）
   - 实现：
     - 聚合 unified_profiles 数据
     - 聚合 profile.skills.lifecoach
     - 聚合 skill_subscriptions
     - 返回 DashboardDTO
   - 验收：返回真实数据，类型正确

6. **集成 Protocol 卡片**
   - 文件：`apps/web/src/components/dashboard/ProtocolEntryCard.tsx`（新建）
   - 实现：
     - 检测 protocol 状态
     - 显示入口卡片 / 进度卡片
     - 导航到 /protocol/[id]
   - 验收：Protocol 与 Dashboard 联动

### Phase 3：Proactive Engine（P1 - 5天）

**目标**：LLM 驱动的个性化内容

**任务**：

7. **实现 Trigger Detector**
   - 文件：`apps/api/services/proactive/trigger_detector.py`
   - 实现：
     - 基于规则的触发检测（时间、事件）
     - LLM 辅助判断（是否需要更新内容）
   - 验收：正确检测触发时机

8. **实现 Content Generator**
   - 文件：`apps/api/services/proactive/content_generator.py`
   - 实现：
     - 使用 CoreAgent 生成内容
     - Prompt 工程（生成高质量卡片内容）
     - 多 Skill 支持（lifecoach, bazi, zodiac）
   - 验收：生成内容符合预期格式

9. **实现 Engine 核心**
   - 文件：`apps/api/services/proactive/engine.py`
   - 实现：
     - 编排 Trigger + Generator
     - Redis 缓存策略
     - 定时任务（Celery / APScheduler）
   - 验收：Dashboard 显示个性化内容

### Phase 4：测试与优化（P1 - 2天）

**目标**：系统稳定性 ≥ 99%

**任务**：

10. **完善测试环境**
    - 创建测试用户生成脚本
    - 隔离测试数据库
    - 集成测试套件

11. **性能优化**
    - Dashboard API 响应时间 < 500ms
    - Proactive Engine 生成时间 < 2s
    - Redis 缓存命中率 ≥ 90%

12. **监控和告警**
    - 工具调用率监控
    - Dashboard API 响应时间监控
    - Proactive Engine 错误率监控

---

## 8. 关键文件清单

### 需要修改的文件

**Phase 1：修复卡片调用**
- `apps/api/skills/core/config/routing.yaml` - 优化 Phase 1 Prompt
- `apps/api/services/agent/core.py` - 添加 tool_choice 参数（如果需要）
- `apps/api/services/agent/core.py:_execute_tool()` - 添加遥测

**Phase 2：完成 Dashboard**
- `apps/web/src/app/dashboard/page.tsx` - 页面入口（新建）
- `apps/api/routes/dashboard.py` - 后端 API（新建）
- `apps/web/src/components/dashboard/ProtocolEntryCard.tsx` - Protocol 入口卡片（新建）
- `apps/web/src/components/dashboard/ProtocolProgressCard.tsx` - Protocol 进度卡片（新建）

**Phase 3：Proactive Engine**
- `apps/api/services/proactive/trigger_detector.py` - 触发检测（新建）
- `apps/api/services/proactive/content_generator.py` - 内容生成（新建）
- `apps/api/services/proactive/engine.py` - 引擎核心（新建）
- `apps/api/services/proactive/cache.py` - 缓存策略（新建）

### 参考文档

**设计规格**
- `docs/components/dashboard/DESIGN.md` (912 行) - Dashboard 设计规格
- `docs/components/dashboard/DATA-FLOW.md` (785 行) - 数据流和 API
- `docs/components/protocol/PROTOCOL_DESIGN.md` - Protocol 设计理念

**架构文档**
- `CLAUDE.md` - Agent SDK 最佳实践
- `CORE.md` - CoreAgent 架构文档

**实现参考**
- `apps/api/services/agent/core.py` - CoreAgent 核心逻辑
- `apps/api/skills/core/tools/tools.yaml` - 全局工具定义
- `apps/web/src/hooks/useDashboard.ts` - Dashboard 数据管理
- `apps/web/src/types/dashboard.ts` - DashboardDTO 类型定义

---

## 9. 验证计划

### 测试场景

**Scenario 1：打招呼**
```
用户："你好"
预期：简短回应 + recommend_skills
验证：SSE 事件包含 {type: "data", data: {card_type: "skill_recommendations"}}
```

**Scenario 2：不确定意图**
```
用户："我想聊聊"
预期：简短回应 + recommend_skills
验证：同上
```

**Scenario 3：明确需求**
```
用户："帮我算八字"
预期：简短回应 + activate_skill(skill="bazi")
验证：Phase 2 激活，工具集切换
```

**Scenario 4：协议触发**
```
用户："Dan Koe 快速重置"
预期：简短回应 + show_protocol_invitation(protocol_id="dankoe")
验证：SSE 事件包含协议邀请卡片
```

### 成功标准

- ✅ Phase 1 工具调用率 ≥ 95%
- ✅ Dashboard 页面可访问
- ✅ Dashboard API 返回真实数据
- ✅ Protocol 卡片在 Dashboard 显示
- ✅ 所有测试场景通过

---

## 10. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| LLM 仍不遵守 Prompt | 中 | 高 | 方案 B：兜底验证 |
| 后端 API 性能问题 | 低 | 中 | 缓存策略 + 异步加载 |
| Protocol 与 Dashboard 集成复杂 | 中 | 中 | 分阶段实现 |
| Proactive Engine 延期 | 中 | 低 | Dashboard 先用静态内容 |

---

## 总结

### 问题诊断

**CoreAgent 卡片调用失败的根本原因**：
- Phase 1 Prompt 无法有效引导 LLM 强制调用工具
- 缺少 Claude API tool_choice 参数的使用
- 缺少工具调用遥测，无法监控问题

### 解决方案（符合用户要求）

**原则**：
- ✅ LLM 驱动 - 不硬编码 Python 兜底逻辑
- ✅ Claude SDK 规范 - 使用 tool_choice 参数
- ✅ Agent-Native 架构 - Proactive Engine 使用 LLM 生成内容

**方案**：
1. **方案 A**：优化 Phase 1 Prompt（强化指令 + 错误示例）
2. **方案 B**：使用 Claude API tool_choice 参数（符合 SDK 规范）
3. **方案 C**：完成 Dashboard（Agent-Driven + LLM-Powered）

### 当前完成度

| 模块 | 完成度 | 缺失 |
|------|--------|------|
| CoreAgent 卡片机制 | 70% | Prompt 优化 + tool_choice |
| Dashboard 组件 | 70% | 页面入口 + 后端 API |
| Protocol 系统 | 90% | Dashboard 集成 |
| Proactive Engine | 0% | 完整实现 |

### 实施路径

**Phase 1（2天）**：修复卡片调用
- 优化 Phase 1 Prompt
- 实现 tool_choice 参数
- 添加工具调用遥测

**Phase 2（3天）**：完成 Dashboard
- 创建页面入口
- 实现后端 API
- 集成 Protocol 卡片

**Phase 3（5天）**：Proactive Engine
- Trigger Detector
- Content Generator（LLM-Powered）
- Engine 核心 + 缓存

**Phase 4（2天）**：测试与优化
- 完善测试环境
- 性能优化
- 监控和告警

### 预期成果

**工具调用率**：90%+ （优化 Prompt）→ 100%（tool_choice）

**Dashboard**：可访问 + 真实数据 + Protocol 集成

**Proactive Engine**：LLM 驱动的个性化内容生成

**架构质量**：符合 Agent-Native + Claude SDK 规范

**总时间**：12 天（约 2 周）

### 未解决的问题

1. Claude API 版本是否支持 tool_choice 参数？（需验证）
2. Proactive Engine 生成成本评估（LLM 调用频率 vs 成本）
3. Skill 自注册系统优先级（未包含在当前计划）
