"""
Synastry Engine - 合盘计算引擎

轻度融合架构：编排各 Skill 的合盘计算，最后 AI 综合解读

支持的维度：
- zodiac: 星座合盘 (Phase 1 - MVP)
- bazi: 八字合婚 (Phase 2)
- jungastro: 荣格关系分析 (Phase 3)
"""

import logging
from dataclasses import dataclass
from datetime import datetime, timezone
from typing import Dict, Any, List, Optional

logger = logging.getLogger(__name__)


@dataclass
class SynastryDimensionResult:
    """单个维度的合盘结果"""
    skill_id: str
    score: int
    summary: str
    data: dict


@dataclass
class SynastryResult:
    """完整合盘结果"""
    person1: dict
    person2: dict
    relationship_type: str
    overall_score: int
    dimensions: List[SynastryDimensionResult]
    strengths: List[str]
    challenges: List[str]
    advice: str
    calculated_at: datetime


class SynastryEngine:
    """
    合盘计算引擎

    设计原则：
    1. 编排层：调用各 Skill 的计算服务，不重复实现算法
    2. MVP 只做星座合盘，后续扩展其他维度
    3. 综合评分取加权平均
    """

    # 关系类型配置：不同关系类型的分析侧重
    RELATIONSHIP_CONFIG = {
        "romantic": {
            "label": "恋人",
            "focus": ["passion", "emotional", "communication"],
            "weight": {"zodiac": 1.0, "bazi": 0.8, "jungastro": 0.9}
        },
        "spouse": {
            "label": "伴侣",
            "focus": ["stability", "growth", "compatibility"],
            "weight": {"zodiac": 0.9, "bazi": 1.0, "jungastro": 0.8}
        },
        "parent_child": {
            "label": "亲子",
            "focus": ["understanding", "communication", "education"],
            "weight": {"zodiac": 0.8, "bazi": 0.9, "jungastro": 1.0}
        },
        "sibling": {
            "label": "兄弟姐妹",
            "focus": ["complementary", "support"],
            "weight": {"zodiac": 1.0, "bazi": 0.7, "jungastro": 0.7}
        },
        "business": {
            "label": "合伙人",
            "focus": ["trust", "complementary", "decision"],
            "weight": {"zodiac": 0.7, "bazi": 1.0, "jungastro": 0.9}
        },
        "friend": {
            "label": "朋友",
            "focus": ["compatibility", "fun", "support"],
            "weight": {"zodiac": 1.0, "bazi": 0.5, "jungastro": 0.6}
        }
    }

    async def calculate(
        self,
        user_birth_info: dict,
        partner_birth_info: dict,
        relationship_type: str,
        subscribed_skills: List[str]
    ) -> SynastryResult:
        """
        计算合盘

        Args:
            user_birth_info: 用户出生信息 {date, time, place, timezone}
            partner_birth_info: 对方出生信息 {date, time, place, timezone}
            relationship_type: 关系类型
            subscribed_skills: 用户已订阅的 Skill 列表

        Returns:
            SynastryResult: 完整合盘结果
        """
        dimensions = []
        total_weighted_score = 0
        total_weight = 0
        all_strengths = []
        all_challenges = []

        config = self.RELATIONSHIP_CONFIG.get(relationship_type, self.RELATIONSHIP_CONFIG["romantic"])

        # 1. 星座合盘 (MVP 核心)
        if "zodiac" in subscribed_skills:
            try:
                result = await self._calc_zodiac_synastry(
                    user_birth_info,
                    partner_birth_info,
                    relationship_type
                )
                if result:
                    dimensions.append(result)
                    weight = config["weight"].get("zodiac", 1.0)
                    total_weighted_score += result.score * weight
                    total_weight += weight
                    all_strengths.extend(result.data.get("strengths", []))
                    all_challenges.extend(result.data.get("challenges", []))
            except Exception as e:
                logger.error(f"星座合盘计算失败: {e}")

        # 2. 八字合婚 (Phase 2)
        # if "bazi" in subscribed_skills:
        #     ...

        # 3. 荣格关系分析 (Phase 3)
        # if "jungastro" in subscribed_skills:
        #     ...

        # 4. 计算综合评分
        overall_score = round(total_weighted_score / total_weight) if total_weight > 0 else 50

        # 5. 合并并去重 strengths/challenges
        strengths = self._dedupe_list(all_strengths)[:3]
        challenges = self._dedupe_list(all_challenges)[:3]

        # 6. 生成综合建议
        advice = self._generate_advice(overall_score, relationship_type, dimensions)

        return SynastryResult(
            person1={"birth_info": user_birth_info},
            person2={"birth_info": partner_birth_info},
            relationship_type=relationship_type,
            overall_score=overall_score,
            dimensions=dimensions,
            strengths=strengths,
            challenges=challenges,
            advice=advice,
            calculated_at=datetime.now(timezone.utc)
        )

    async def _calc_zodiac_synastry(
        self,
        user_birth_info: dict,
        partner_birth_info: dict,
        relationship_type: str
    ) -> Optional[SynastryDimensionResult]:
        """
        计算星座合盘

        调用 zodiac skill 的 calculate_synastry 函数
        """
        from skills.zodiac.services.calculator import calculate_synastry

        try:
            # 调用真实的合盘计算
            result = calculate_synastry(
                person1_birth_date=user_birth_info.get("date", ""),
                person1_birth_time=user_birth_info.get("time", "12:00"),
                person1_birth_place=user_birth_info.get("place", "Shanghai"),
                person2_birth_date=partner_birth_info.get("date", ""),
                person2_birth_time=partner_birth_info.get("time", "12:00"),
                person2_birth_place=partner_birth_info.get("place", "Shanghai"),
            )

            if "error" in result:
                logger.error(f"Zodiac synastry error: {result['error']}")
                return None

            # 构建摘要
            person1 = result.get("person1", {})
            person2 = result.get("person2", {})
            sun1 = person1.get("sun_sign_chinese", "")
            sun2 = person2.get("sun_sign_chinese", "")
            summary = f"太阳{sun1} × 太阳{sun2}"

            return SynastryDimensionResult(
                skill_id="zodiac",
                score=result.get("overall_score", 70),
                summary=summary,
                data={
                    "person1": person1,
                    "person2": person2,
                    "categories": result.get("categories", []),
                    "aspects": result.get("aspects", []),
                    "strengths": result.get("strengths", []),
                    "challenges": result.get("challenges", []),
                    "advice": result.get("advice", "")
                }
            )

        except Exception as e:
            logger.error(f"Zodiac synastry calculation failed: {e}")
            return None

    def _dedupe_list(self, items: List[str]) -> List[str]:
        """去重列表，保持顺序"""
        seen = set()
        result = []
        for item in items:
            if item not in seen:
                seen.add(item)
                result.append(item)
        return result

    def _generate_advice(
        self,
        score: int,
        relationship_type: str,
        dimensions: List[SynastryDimensionResult]
    ) -> str:
        """根据分数和关系类型生成综合建议"""
        config = self.RELATIONSHIP_CONFIG.get(relationship_type, self.RELATIONSHIP_CONFIG["romantic"])
        label = config["label"]

        if score >= 85:
            return f"你们是非常匹配的{label}！珍惜这份缘分，用心经营关系，保持真诚沟通。"
        elif score >= 70:
            return f"你们有很好的{label}基础，多关注彼此的情感需求，用行动表达关心。"
        elif score >= 55:
            return f"你们的关系需要一些磨合。差异是成长的契机，学习对方的优点，用包容化解分歧。"
        else:
            return f"关系需要更多努力经营。专注于共同目标，建立相互理解的桥梁，真诚沟通是关键。"

    def get_score_label(self, score: int) -> str:
        """根据分数获取评价标签"""
        if score >= 85:
            return "天作之合"
        elif score >= 70:
            return "默契组合"
        elif score >= 55:
            return "需要磨合"
        elif score >= 40:
            return "互补成长"
        else:
            return "挑战较多"
