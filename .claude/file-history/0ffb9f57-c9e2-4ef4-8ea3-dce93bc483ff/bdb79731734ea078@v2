'use client';

/**
 * SkillListCard - 聊天中展示所有可用 Skill 的卡片
 *
 * 用于边界控制：当用户问题超出当前 Skill 能力时，
 * 展示所有可用 Skill 供用户选择。
 *
 * 遵循 Vercel React Best Practices:
 * - bundle-barrel-imports: 直接导入，避免 barrel files
 * - rerender-memo: 使用 memo 优化子组件
 * - rendering-conditional-render: 使用三元运算符
 */

import { memo, useCallback } from 'react';
import { cn } from '@/lib/utils';

// ═══════════════════════════════════════════════════════════════════════════
// 类型定义
// ═══════════════════════════════════════════════════════════════════════════

interface SkillItem {
  id: string;
  name: string;
  description: string;
  icon: string;
  color: string;
  category: string;
  triggers?: string[];
  tagline?: string;
}

interface SkillListCardProps {
  message?: string;
  skills: SkillItem[];
  count?: number;
  onSkillSelect?: (skillId: string) => void;
  /** v11: Unified action callback for ChatMessage integration */
  onAction?: (action: string, payload?: any) => void;
  /** v11: SendMessage callback for direct message sending */
  onSendMessage?: (message: string) => void;
}

// ═══════════════════════════════════════════════════════════════════════════
// 子组件 (rerender-memo)
// ══════════════��════════════════════════════════════════════════════════════

const SkillItemCard = memo(function SkillItemCard({
  skill,
  onSelect,
}: {
  skill: SkillItem;
  onSelect?: (skillId: string) => void;
}) {
  const handleClick = useCallback(() => {
    onSelect?.(skill.id);
  }, [skill.id, onSelect]);

  return (
    <button
      onClick={handleClick}
      className={cn(
        'w-full text-left p-3 rounded-xl',
        'bg-white/5 hover:bg-white/10',
        'border border-white/10 hover:border-white/20',
        'transition-all duration-200',
        'focus:outline-none focus:ring-2 focus:ring-accent/50'
      )}
    >
      <div className="flex items-start gap-3">
        {/* Icon */}
        <div
          className="w-10 h-10 rounded-xl flex items-center justify-center text-xl shrink-0"
          style={{ backgroundColor: `${skill.color}20` }}
        >
          {skill.icon}
        </div>

        {/* Content */}
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <h4 className="font-medium text-text-primary truncate">
              {skill.name}
            </h4>
            <CategoryBadge category={skill.category} />
          </div>
          <p className="text-sm text-text-secondary line-clamp-2 mt-0.5">
            {skill.tagline || skill.description}
          </p>
          {/* Triggers */}
          {skill.triggers && skill.triggers.length > 0 ? (
            <div className="flex flex-wrap gap-1 mt-2">
              {skill.triggers.map((trigger) => (
                <span
                  key={trigger}
                  className="px-2 py-0.5 text-xs rounded-full bg-white/5 text-text-tertiary"
                >
                  {trigger}
                </span>
              ))}
            </div>
          ) : null}
        </div>
      </div>
    </button>
  );
});

const CategoryBadge = memo(function CategoryBadge({
  category,
}: {
  category: string;
}) {
  const config: Record<string, { label: string; bg: string; text: string }> = {
    core: { label: '核心', bg: 'bg-indigo-500/20', text: 'text-indigo-300' },
    default: { label: '基础', bg: 'bg-green-500/20', text: 'text-green-300' },
    professional: { label: '专业', bg: 'bg-amber-500/20', text: 'text-amber-300' },
  };
  const c = config[category] || config.professional;

  return (
    <span className={cn('px-1.5 py-0.5 text-xs rounded', c.bg, c.text)}>
      {c.label}
    </span>
  );
});

// ═══════════════════════════════════════════════════════════════════════════
// 主组件
// ═══════════════════════════════════════════════════════════════════════════

export function SkillListCard({
  message,
  skills,
  onSkillSelect,
  onAction,
  onSendMessage,
}: SkillListCardProps) {
  // v11: Unified skill select handler
  const handleSkillSelect = useCallback((skillId: string) => {
    // Priority: onSkillSelect > onAction > onSendMessage
    if (onSkillSelect) {
      onSkillSelect(skillId);
    } else if (onAction) {
      onAction('select', skillId);
    } else if (onSendMessage) {
      // Send a message to activate the skill
      const skill = skills.find(s => s.id === skillId);
      const skillName = skill?.name || skillId;
      onSendMessage(`使用${skillName}`);
    }
  }, [onSkillSelect, onAction, onSendMessage, skills]);
  // 空状态
  if (!skills || skills.length === 0) {
    return (
      <div className="my-3 p-4 rounded-xl bg-white/5 border border-white/10">
        <p className="text-text-secondary text-center">暂无可用的 Skill</p>
      </div>
    );
  }

  return (
    <div className="my-3 rounded-xl bg-white/5 border border-white/10 overflow-hidden">
      {/* Header */}
      {message ? (
        <div className="px-4 py-3 border-b border-white/5">
          <p className="text-sm text-text-secondary">{message}</p>
        </div>
      ) : null}

      {/* Skill Grid */}
      <div className="p-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
        {skills.map((skill) => (
          <SkillItemCard
            key={skill.id}
            skill={skill}
            onSelect={handleSkillSelect}
          />
        ))}
      </div>

      {/* Footer hint */}
      <div className="px-4 py-2 border-t border-white/5 bg-white/2">
        <p className="text-xs text-text-tertiary text-center">
          点击选择你感兴趣的领域
        </p>
      </div>
    </div>
  );
}

export default SkillListCard;
