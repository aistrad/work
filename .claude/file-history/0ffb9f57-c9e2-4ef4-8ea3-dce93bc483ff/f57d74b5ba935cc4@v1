/**
 * ThinkingBlock 和 VibeGlyph 动画 E2E 测试
 * v11.0 新功能验证
 *
 * 测试内容：
 * 1. ThinkingBlock 在 AI 思考时显示
 * 2. VibeGlyph 橙子图标替代旧头像
 * 3. 思考动画效果生效
 * 4. 思考块自动折叠
 * 5. SkillListCard 展示
 */
import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8232';

test.describe('v11 ThinkingBlock 和 VibeGlyph 动画测试', () => {

  test.beforeEach(async ({ page }) => {
    // 访问 chat 页面
    await page.goto(`${BASE_URL}/chat`);
    await page.waitForLoadState('networkidle');
  });

  test('VibeGlyph 橙子图标显示', async ({ page }) => {
    // 检查页面中是否存在 VibeGlyph 组件
    const vibeGlyph = page.locator('.vibe-glyph');

    // 等待组件出现
    await page.waitForTimeout(1000);

    // 截图初始状态
    await page.screenshot({
      path: 'test-results/thinking-01-initial.png',
      fullPage: true
    });

    // 验证 SVG 橙子图标存在
    const orangeIcon = page.locator('.vibe-glyph svg circle[fill="#FBBD6A"]');
    const orangeCount = await orangeIcon.count();
    console.log(`找到 ${orangeCount} 个橙子图标`);

    // 如果首页没有 AI 消息，发送一条消息
    const chatInput = page.locator('textarea').first();
    if (await chatInput.isVisible()) {
      await chatInput.fill('你好');
      const sendButton = page.locator('button[aria-label="发送消息"]').first();
      if (await sendButton.isVisible()) {
        await sendButton.click();

        // 等待 AI 回复
        await page.waitForTimeout(3000);

        // 截图 - 发送后
        await page.screenshot({
          path: 'test-results/thinking-02-after-send.png',
          fullPage: true
        });

        // 验证 VibeGlyph 出现在 AI 消息旁边
        const assistantVibeGlyph = page.locator('article .vibe-glyph');
        await expect(assistantVibeGlyph.first()).toBeVisible({ timeout: 10000 });
        console.log('VibeGlyph 在 AI 消息中显示正常');
      }
    }
  });

  test('思考动画效果验证', async ({ page }) => {
    // 找到输入框并发送消息触发思考
    const chatInput = page.locator('textarea').first();
    await expect(chatInput).toBeVisible({ timeout: 10000 });

    // 发送消息触发 AI 思考
    await chatInput.fill('帮我分析一下荣格原型');
    const sendButton = page.locator('button[aria-label="发送消息"]').first();
    await sendButton.click();

    // 快速截图捕获思考状态
    await page.waitForTimeout(500);
    await page.screenshot({
      path: 'test-results/thinking-03-thinking-start.png',
      fullPage: true
    });

    // 检查思考中状态
    // 1. 检查 ThinkingBlock 是否出现
    const thinkingBlock = page.locator('.thinking-block');
    const thinkingBlockVisible = await thinkingBlock.isVisible().catch(() => false);

    // 2. 检查 VibeGlyph 思考动画
    const thinkingGlyph = page.locator('.vibe-thinking');
    const thinkingAura = page.locator('.vibe-thinking-aura');

    // 等待一下看是否有思考状态
    await page.waitForTimeout(1000);
    await page.screenshot({
      path: 'test-results/thinking-04-thinking-progress.png',
      fullPage: true
    });

    // 检查 CSS 动画类是否存在
    const hasThinkingClass = await page.evaluate(() => {
      const element = document.querySelector('.vibe-thinking-icon');
      if (element) {
        const style = window.getComputedStyle(element);
        return style.animationName !== 'none';
      }
      return false;
    });

    console.log('ThinkingBlock 显示:', thinkingBlockVisible);
    console.log('思考动画生效:', hasThinkingClass);

    // 等待 AI 回复完成
    await page.waitForTimeout(15000);
    await page.screenshot({
      path: 'test-results/thinking-05-response-complete.png',
      fullPage: true
    });

    // 验证思考块折叠（完成后应该折叠）
    const thinkingCollapsed = page.locator('.thinking-content-wrapper.collapsed');
    const isCollapsed = await thinkingCollapsed.isVisible().catch(() => false);
    console.log('思考块完成后折叠:', isCollapsed);
  });

  test('ThinkingBlock 交互测试', async ({ page }) => {
    // 发送消息触发思考
    const chatInput = page.locator('textarea').first();
    await expect(chatInput).toBeVisible({ timeout: 10000 });

    await chatInput.fill('帮我算一下八字');
    const sendButton = page.locator('button[aria-label="发送消息"]').first();
    await sendButton.click();

    // 等待响应完成
    await page.waitForTimeout(20000);

    // 查找 ThinkingBlock
    const thinkingHeader = page.locator('.thinking-header');
    const headerCount = await thinkingHeader.count();

    if (headerCount > 0) {
      // 点击展开/折叠
      await thinkingHeader.first().click();
      await page.waitForTimeout(500);
      await page.screenshot({
        path: 'test-results/thinking-06-toggle-expand.png',
        fullPage: true
      });

      // 再次点击折叠
      await thinkingHeader.first().click();
      await page.waitForTimeout(500);
      await page.screenshot({
        path: 'test-results/thinking-07-toggle-collapse.png',
        fullPage: true
      });

      console.log('ThinkingBlock 展开/折叠交互正常');
    } else {
      console.log('未找到 ThinkingBlock（可能后端未发送 thinking 事件）');
    }
  });

  test('SkillListCard 展示测试', async ({ page }) => {
    // 发送意图不明确的消息
    const chatInput = page.locator('textarea').first();
    await expect(chatInput).toBeVisible({ timeout: 10000 });

    await chatInput.fill('你能帮我做什么');
    const sendButton = page.locator('button[aria-label="发送消息"]').first();
    await sendButton.click();

    // 等待响应
    await page.waitForTimeout(10000);

    // 检查 SkillListCard 是否出现
    const skillListCard = page.locator('.skill-list-card, [class*="skill-list"]');
    const skillListVisible = await skillListCard.isVisible().catch(() => false);

    // 或者检查 skill grid
    const skillGrid = page.locator('text=八字, text=星座, text=塔罗').first();
    const hasSkillOptions = await skillGrid.isVisible().catch(() => false);

    await page.screenshot({
      path: 'test-results/thinking-08-skill-list.png',
      fullPage: true
    });

    console.log('SkillListCard 显示:', skillListVisible || hasSkillOptions);
  });

  test('CSS 动画样式验证', async ({ page }) => {
    // 验证 CSS 变量和动画定义存在
    const cssCheck = await page.evaluate(() => {
      const results = {
        thinkingBlockStyles: false,
        vibeThinkingAura: false,
        vibeThinkingIcon: false,
        pulseDotAnimation: false,
      };

      // 检查 stylesheet 中是否有相关规则
      for (const sheet of document.styleSheets) {
        try {
          for (const rule of sheet.cssRules) {
            const ruleText = rule.cssText || '';
            if (ruleText.includes('.thinking-block')) {
              results.thinkingBlockStyles = true;
            }
            if (ruleText.includes('.vibe-thinking-aura')) {
              results.vibeThinkingAura = true;
            }
            if (ruleText.includes('.vibe-thinking-icon')) {
              results.vibeThinkingIcon = true;
            }
            if (ruleText.includes('pulse-dot') || ruleText.includes('vibe-aura-pulse')) {
              results.pulseDotAnimation = true;
            }
          }
        } catch (e) {
          // 跨域样式表会抛出错误，忽略
        }
      }

      return results;
    });

    console.log('CSS 样式验证结果:', cssCheck);

    // 验证所有必要的样式都存在
    expect(cssCheck.thinkingBlockStyles).toBe(true);
    expect(cssCheck.vibeThinkingAura).toBe(true);
    expect(cssCheck.vibeThinkingIcon).toBe(true);
  });

  test('响应式布局验证 - 移动端', async ({ page }) => {
    // 设置移动端视口
    await page.setViewportSize({ width: 375, height: 812 });
    await page.reload();
    await page.waitForLoadState('networkidle');

    await page.screenshot({
      path: 'test-results/thinking-09-mobile.png',
      fullPage: true
    });

    // 发送消息
    const chatInput = page.locator('textarea').first();
    if (await chatInput.isVisible()) {
      await chatInput.fill('你好');
      const sendButton = page.locator('button[aria-label="发送消息"]').first();
      if (await sendButton.isVisible()) {
        await sendButton.click();
        await page.waitForTimeout(5000);

        await page.screenshot({
          path: 'test-results/thinking-10-mobile-response.png',
          fullPage: true
        });
      }
    }

    console.log('移动端布局验证完成');
  });
});
