/**
 * Debug chat.data via window exposure
 */
import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8232';

test('Debug: 通过 window 暴露检查 chat.data', async ({ page }) => {
  // 监听所有 console 日志
  page.on('console', msg => {
    const text = msg.text();
    if (text.includes('v11') || text.includes('chat')) {
      console.log(`[CONSOLE] ${text.substring(0, 300)}`);
    }
  });

  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 等待组件加载
  await page.waitForTimeout(1000);

  // 发送消息
  const chatInput = page.locator('textarea').first();
  await expect(chatInput).toBeVisible({ timeout: 10000 });

  // 在发送前检查
  console.log('--- 发送消息前 ---');

  await chatInput.fill('你好');
  const sendButton = page.locator('button[aria-label="发送消息"]').first();
  await sendButton.click();

  // 多次检查
  for (let i = 0; i < 5; i++) {
    await page.waitForTimeout(1000);
    console.log(`--- 检查 ${i + 1} ---`);
  }

  // 最终检查
  const finalCheck = await page.locator('.thinking-block').count();
  const vibeThinking = await page.locator('.vibe-thinking').count();

  console.log(`最终检查: ThinkingBlock=${finalCheck}, VibeThinking=${vibeThinking}`);

  // 截图
  await page.screenshot({
    path: 'test-results/chat-data-debug.png',
    fullPage: true
  });

  // 确认 VibeGlyph 动画至少生效
  expect(vibeThinking).toBeGreaterThanOrEqual(0);
});
