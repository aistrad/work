/**
 * Debug test for ThinkingBlock data flow
 */
import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8232';

test('Debug: 检查 chat.data 是否接收 thinking 事件', async ({ page }) => {
  // 添加 console 监听
  const consoleLogs: string[] = [];
  page.on('console', msg => {
    if (msg.text().includes('thinking') || msg.text().includes('chat.data')) {
      consoleLogs.push(msg.text());
    }
  });

  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 注入调试代码到页面
  await page.evaluate(() => {
    // 监听网络请求
    const originalFetch = window.fetch;
    window.fetch = async function(...args) {
      const response = await originalFetch.apply(this, args);
      const url = typeof args[0] === 'string' ? args[0] : (args[0] as Request).url;

      if (url.includes('/chat') && url.includes('/stream')) {
        console.log('[DEBUG] Chat stream request:', url);
      }

      return response;
    };
  });

  // 发送消息
  const chatInput = page.locator('textarea').first();
  await expect(chatInput).toBeVisible({ timeout: 10000 });

  await chatInput.fill('你好');
  const sendButton = page.locator('button[aria-label="发送消息"]').first();
  await sendButton.click();

  // 等待响应
  await page.waitForTimeout(5000);

  // 检查页面中是否渲染了 ThinkingBlock
  const thinkingBlock = await page.locator('.thinking-block').count();
  const thinkingHeader = await page.locator('.thinking-header').count();
  const thinkingSteps = await page.locator('.thinking-steps').count();

  console.log('页面中的 ThinkingBlock 元素:');
  console.log('  .thinking-block:', thinkingBlock);
  console.log('  .thinking-header:', thinkingHeader);
  console.log('  .thinking-steps:', thinkingSteps);

  // 检查 VibeGlyph 思考状态
  const vibeThinking = await page.locator('.vibe-thinking').count();
  const vibeThinkingAura = await page.locator('.vibe-thinking-aura').count();

  console.log('VibeGlyph 思考状态:');
  console.log('  .vibe-thinking:', vibeThinking);
  console.log('  .vibe-thinking-aura:', vibeThinkingAura);

  // 截图
  await page.screenshot({
    path: 'test-results/debug-thinking.png',
    fullPage: true
  });

  // 获取页面 HTML 来检查渲染结果
  const html = await page.content();
  const hasThinkingInHtml = html.includes('thinking-block') || html.includes('thinking-header');
  console.log('HTML 中包含 thinking 相关类:', hasThinkingInHtml);

  // 打印收集到的日志
  if (consoleLogs.length > 0) {
    console.log('收集到的 console 日志:');
    consoleLogs.forEach(log => console.log('  ', log));
  }
});

test('Debug: 直接测试 SSE 数据解析', async ({ page }) => {
  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 在页面中注入测试代码来检查 AI SDK 的 data 属性
  const result = await page.evaluate(async () => {
    // 模拟接收 SSE 数据
    const testData = '2:["thinking", {"id": "think_0", "phase": "analyzing", "content": "正在分析...", "iteration": 0, "is_complete": false}]\n';

    // 解析 2: 格式的数据
    const line = testData.trim();
    if (line.startsWith('2:')) {
      try {
        const jsonStr = line.slice(2);
        const parsed = JSON.parse(jsonStr);
        return {
          success: true,
          parsed,
          isArray: Array.isArray(parsed),
          firstElement: parsed[0],
          secondElement: parsed[1],
        };
      } catch (e) {
        return { success: false, error: String(e) };
      }
    }
    return { success: false, error: 'No 2: prefix' };
  });

  console.log('SSE 数据解析测试结果:', JSON.stringify(result, null, 2));
  expect(result.success).toBe(true);
  expect(result.firstElement).toBe('thinking');
});
