/**
 * Inspect chat.data directly via React DevTools approach
 */
import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8232';

test('直接检查 chat.data 内容', async ({ page }) => {
  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 发送消息
  const chatInput = page.locator('textarea').first();
  await expect(chatInput).toBeVisible({ timeout: 10000 });

  await chatInput.fill('你好');
  const sendButton = page.locator('button[aria-label="发送消息"]').first();
  await sendButton.click();

  // 等待一段时间让数据流动
  await page.waitForTimeout(3000);

  // 通过 React Fiber 查找 chat.data（简化方法：监听 window 上的调试信息）
  const dataInfo = await page.evaluate(() => {
    // 尝试找到包含 useChat 状态的 React fiber
    const findReactFiber = (element: Element): any => {
      const key = Object.keys(element).find(k =>
        k.startsWith('__reactFiber$') || k.startsWith('__reactInternalInstance$')
      );
      return key ? (element as any)[key] : null;
    };

    // 检查所有可能存储 chat data 的地方
    const results: any = {
      foundFibers: 0,
      chatDataFound: false,
      sampleData: null,
    };

    // 遍历 DOM 找到 React 组件
    const elements = document.querySelectorAll('*');
    for (const el of elements) {
      const fiber = findReactFiber(el);
      if (fiber?.memoizedState) {
        results.foundFibers++;

        // 尝试找到包含 data 数组的状态
        let state = fiber.memoizedState;
        while (state) {
          if (state.memoizedState?.data && Array.isArray(state.memoizedState.data)) {
            results.chatDataFound = true;
            results.sampleData = state.memoizedState.data.slice(0, 3);
            break;
          }
          state = state.next;
        }

        if (results.chatDataFound) break;
      }
    }

    return results;
  });

  console.log('React Fiber 检查结果:', JSON.stringify(dataInfo, null, 2));

  // 截图
  await page.screenshot({
    path: 'test-results/thinking-inspect.png',
    fullPage: true
  });
});

test('使用 fetch 模拟检查 SSE 数据', async ({ page }) => {
  await page.goto(`${BASE_URL}/chat`);

  // 直接在页面中发起 fetch 请求并检查响应
  const streamData = await page.evaluate(async () => {
    const response = await fetch('/api/chat/v5/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: [{ role: 'user', content: '你好' }],
      }),
    });

    const reader = response.body?.getReader();
    if (!reader) return { error: 'No reader' };

    const decoder = new TextDecoder();
    const chunks: string[] = [];
    const thinkingLines: string[] = [];

    // 读取前几个 chunks
    for (let i = 0; i < 20; i++) {
      const { value, done } = await reader.read();
      if (done) break;

      const text = decoder.decode(value);
      chunks.push(text);

      // 检查是否包含 thinking 数据
      const lines = text.split('\n');
      for (const line of lines) {
        if (line.startsWith('2:') && line.includes('thinking')) {
          thinkingLines.push(line);
        }
      }
    }

    reader.cancel();

    return {
      chunksCount: chunks.length,
      thinkingLinesCount: thinkingLines.length,
      firstThinkingLine: thinkingLines[0] || null,
      firstChunk: chunks[0]?.substring(0, 200) || null,
    };
  });

  console.log('SSE 数据检查结果:', JSON.stringify(streamData, null, 2));

  expect(streamData.thinkingLinesCount).toBeGreaterThan(0);
});
