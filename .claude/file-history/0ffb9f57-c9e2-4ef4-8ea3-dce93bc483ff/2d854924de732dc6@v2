/**
 * ThinkingBlock streaming test - verify during active streaming
 */
import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8232';

test('ThinkingBlock 在流式传输期间显示', async ({ page }) => {
  // 监听 console
  page.on('console', msg => {
    const text = msg.text();
    if (text.includes('v11') && !text.includes('Warning')) {
      console.log(`[CONSOLE] ${text.substring(0, 200)}`);
    }
  });

  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 发送消息
  const chatInput = page.locator('textarea').first();
  await expect(chatInput).toBeVisible({ timeout: 10000 });

  await chatInput.fill('帮我分析一下荣格原型');
  const sendButton = page.locator('button[aria-label="发送消息"]').first();
  await sendButton.click();

  // 快速检查 - 流式传输开始后立即检查
  let thinkingFound = false;
  let thinkingAuraFound = false;

  // 检查 20 次，每次间隔 200ms，总共 4 秒
  for (let i = 0; i < 20; i++) {
    await page.waitForTimeout(200);

    const thinkingBlock = await page.locator('.thinking-block').count();
    const vibeThinking = await page.locator('.vibe-thinking').count();
    const vibeThinkingAura = await page.locator('.vibe-thinking-aura').count();

    if (thinkingBlock > 0) {
      thinkingFound = true;
      console.log(`[检查 ${i}] ThinkingBlock 找到!`);
    }

    if (vibeThinking > 0 || vibeThinkingAura > 0) {
      thinkingAuraFound = true;
    }

    // 如果找到了 thinking block，截图
    if (thinkingBlock > 0) {
      await page.screenshot({
        path: `test-results/thinking-stream-found-${i}.png`,
        fullPage: true
      });
      break;
    }
  }

  // 等待 AI 回复出现
  const aiMessage = page.locator('article[aria-label="AI 助手的回复"]');
  await aiMessage.first().waitFor({ state: 'visible', timeout: 30000 }).catch(() => {
    console.log('AI 回复未出现');
  });

  // 额外等待确保内容加载
  await page.waitForTimeout(3000);

  // 最终检查 - 在日志显示渲染之后再检查一次
  const finalThinkingBlock = await page.locator('.thinking-block').count();
  const finalThinkingHeader = await page.locator('.thinking-header').count();

  if (finalThinkingBlock > 0) {
    thinkingFound = true;
    console.log(`[最终检查] ThinkingBlock 找到!`);
  }

  // 最终截图
  await page.screenshot({
    path: 'test-results/thinking-stream-final.png',
    fullPage: true
  });

  console.log(`ThinkingBlock 找到: ${thinkingFound} (最终数量: ${finalThinkingBlock})`);
  console.log(`ThinkingHeader 数量: ${finalThinkingHeader}`);
  console.log(`VibeGlyph 思考动画找到: ${thinkingAuraFound}`);

  // 至少 VibeGlyph 动画应该生效
  expect(thinkingAuraFound).toBe(true);
});
