/**
 * Check if chat.data is being populated by AI SDK
 */
import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8232';

test('检查 React 组件中的 chat.data', async ({ page }) => {
  // 收集所有 console 日志
  const logs: string[] = [];
  page.on('console', msg => {
    logs.push(`[${msg.type()}] ${msg.text()}`);
  });

  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 注入全局变量来追踪 useChat 的 data
  await page.evaluate(() => {
    // @ts-ignore
    window.__chatDataLog = [];

    // 拦截 React 状态更新（简化版）
    const observer = new MutationObserver(() => {
      // 查找页面中的 thinking-block
      const blocks = document.querySelectorAll('.thinking-block');
      if (blocks.length > 0) {
        console.log('[Observer] Found thinking-block!', blocks.length);
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  });

  // 发送消息
  const chatInput = page.locator('textarea').first();
  await expect(chatInput).toBeVisible({ timeout: 10000 });

  await chatInput.fill('你好');
  const sendButton = page.locator('button[aria-label="发送消息"]').first();
  await sendButton.click();

  // 快速检查 - 在流式传输期间
  await page.waitForTimeout(500);

  // 检查是否有任何 thinking 相关的元素被渲染
  let checkCount = 0;
  for (let i = 0; i < 10; i++) {
    const thinkingCount = await page.locator('.thinking-block').count();
    const vibeThinkingCount = await page.locator('.vibe-thinking').count();

    if (thinkingCount > 0 || vibeThinkingCount > 0) {
      console.log(`[Check ${i}] thinking-block: ${thinkingCount}, vibe-thinking: ${vibeThinkingCount}`);
      checkCount++;
    }

    await page.waitForTimeout(500);
  }

  console.log(`检测到 thinking 状态的次数: ${checkCount}`);

  // 打印所有收集到的日志
  console.log('\n--- Console Logs ---');
  logs.filter(l => l.includes('chat') || l.includes('thinking') || l.includes('useVibeChat'))
    .forEach(l => console.log(l));

  // 截图最终状态
  await page.screenshot({
    path: 'test-results/thinking-data-check.png',
    fullPage: true
  });
});

test('直接检查 Network 响应中的 thinking 数据', async ({ page }) => {
  // 监听网络响应
  const streamResponses: string[] = [];

  page.on('response', async (response) => {
    const url = response.url();
    if (url.includes('/stream')) {
      try {
        const body = await response.text();
        // 查找 thinking 事件
        const lines = body.split('\n');
        for (const line of lines) {
          if (line.startsWith('2:') && line.includes('thinking')) {
            streamResponses.push(line);
          }
        }
      } catch (e) {
        // 流式响应可能无法获取完整 body
      }
    }
  });

  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 发送消息
  const chatInput = page.locator('textarea').first();
  await expect(chatInput).toBeVisible({ timeout: 10000 });

  await chatInput.fill('你好');
  const sendButton = page.locator('button[aria-label="发送消息"]').first();
  await sendButton.click();

  // 等待响应完成
  await page.waitForTimeout(10000);

  console.log('Stream 响应中的 thinking 数据:');
  streamResponses.forEach(r => console.log('  ', r));

  if (streamResponses.length === 0) {
    console.log('未在 Network 响应中捕获到 thinking 数据（可能因为流式响应）');
  }
});
