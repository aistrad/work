/**
 * Final verification test for ThinkingBlock
 */
import { test, expect } from '@playwright/test';

const BASE_URL = 'http://localhost:8232';

test('最终验证: ThinkingBlock 渲染', async ({ page }) => {
  // 捕获所有 console 并立即打印
  page.on('console', msg => {
    const text = msg.text();
    if (text.includes('v11') || text.includes('data items')) {
      console.log(`[BROWSER] ${text}`);
    }
  });

  await page.goto(`${BASE_URL}/chat`);
  await page.waitForLoadState('networkidle');

  // 使用 page.evaluate 来直接检查 chat.data
  // 首先发送消息
  const chatInput = page.locator('textarea').first();
  await expect(chatInput).toBeVisible({ timeout: 10000 });

  await chatInput.fill('你好');
  const sendButton = page.locator('button[aria-label="发送消息"]').first();
  await sendButton.click();

  // 等待一点时间
  await page.waitForTimeout(2000);

  // 直接在浏览器中查找 __NEXT_DATA__ 或 React 状态
  const reactState = await page.evaluate(() => {
    // 尝试找到 React root
    const root = document.getElementById('__next');
    if (!root) return { error: 'No React root' };

    // 查找 React Fiber
    const keys = Object.keys(root);
    const fiberKey = keys.find(k => k.startsWith('__reactContainer'));

    if (!fiberKey) return { error: 'No React fiber key', keys };

    // 尝试遍历组件树找到 useChat 的状态
    // 这是一个简化的方法，实际上需要深入 fiber 树
    return {
      fiberKey,
      hasReactRoot: true,
    };
  });

  console.log('React 状态检查:', reactState);

  // 检查 ThinkingBlock
  const thinkingBlock = await page.locator('.thinking-block').count();
  const thinkingHeader = await page.locator('.thinking-header').count();

  console.log(`ThinkingBlock: ${thinkingBlock}, ThinkingHeader: ${thinkingHeader}`);

  // 检查 VibeGlyph 思考状态
  const vibeThinking = await page.locator('.vibe-thinking').count();

  console.log(`VibeGlyph 思考状态: ${vibeThinking}`);

  // 截图
  await page.screenshot({
    path: 'test-results/thinking-final.png',
    fullPage: true
  });

  // 验证 VibeGlyph 思考动画生效
  expect(vibeThinking).toBeGreaterThanOrEqual(1);
});

test('验证: 后端 thinking 事件正在发送', async ({ page }) => {
  // 监听所有网络请求的响应
  let thinkingEventFound = false;
  let streamContent = '';

  page.on('response', async (response) => {
    if (response.url().includes('/stream')) {
      const contentType = response.headers()['content-type'] || '';
      console.log(`Stream response: ${response.url()}, type: ${contentType}`);
    }
  });

  await page.goto(`${BASE_URL}/chat`);

  // 直接在浏览器中发起请求
  const result = await page.evaluate(async () => {
    const res = await fetch('/api/chat/v5/stream', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ messages: [{ role: 'user', content: '你好' }] }),
    });

    const reader = res.body?.getReader();
    if (!reader) return { error: 'no reader' };

    const decoder = new TextDecoder();
    let firstChunks = '';

    for (let i = 0; i < 5; i++) {
      const { value, done } = await reader.read();
      if (done) break;
      firstChunks += decoder.decode(value);
    }

    reader.cancel();

    // 解析第一行
    const lines = firstChunks.split('\n').filter(l => l.trim());
    const firstLine = lines[0] || '';

    return {
      firstLine,
      hasThinking: firstLine.includes('thinking'),
      lineCount: lines.length,
    };
  });

  console.log('Stream 首行检查:', result);

  expect(result.hasThinking).toBe(true);
});
