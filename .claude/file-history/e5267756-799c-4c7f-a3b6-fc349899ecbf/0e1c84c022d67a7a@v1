# VibeLife V8 系统架构文档

> Version: 8.3 | 2026-01-23
> 核心理念：AI 原生的个人成长陪伴平台
> 设计哲学：Chat-First + LLM 驱动 + 配置驱动

---

## 1. 产品定位

VibeLife 是一个 AI 原生的个人成长陪伴平台，通过多个专业 Skill 提供深度理解和主动关怀。

### 1.1 三大差异化

| 差异化 | 说明 |
|--------|------|
| **Deep Understanding** | 理解你这个人，而非只是问题 |
| **Proactive Agency** | 主动关心，而非等你开口 |
| **Infinite Extensibility** | 通过 Skills 无限扩展能力 |

### 1.2 设计原则

| 原则 | 说明 |
|------|------|
| **Chat-First** | 对话是唯一核心入口，其他页面只负责展示 |
| **LLM-Driven** | 路由、协议执行、内容生成、数据提取全部由 LLM 驱动 |
| **Config-Driven** | 所有规则在配置文件，零硬编码业务逻辑 |
| **Single Source of Truth** | 工具定义、模型配置、提取规则只有一个数据源 |
| **Simplicity** | 保持简单，避免过度工程 |

---

## 2. 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         VibeLife V8.3 Architecture                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                        Frontend (Next.js 14)                      │  │
│   │                                                                   │  │
│   │   ┌─────────┐    ┌─────────┐    ┌─────────┐                      │  │
│   │   │  Chat   │    │ Journey │    │   Me    │                      │  │
│   │   │ (核心)  │◀───│ (展示)  │    │ (展示)  │                      │  │
│   │   └─────────┘    └─────────┘    └─────────┘                      │  │
│   │        │              │              │                            │  │
│   │        │   跳转+参数   │   跳转+参数   │                            │  │
│   │        ▼              ▼              ▼                            │  │
│   │   /chat?skill=lifecoach&scenario=dankoe&prompt=...               │  │
│   │                                                                   │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                    │                                     │
│                                    ▼                                     │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                        Backend (FastAPI)                          │  │
│   │                                                                   │  │
│   │   ┌────────────────────────────────────────────────────────────┐ │  │
│   │   │                      chat_v5.py                             │ │  │
│   │   │  • 解析 skill + scenario 参数                               │ │  │
│   │   │  • 优先使用前端传参，fallback 到智能路由                    │ │  │
│   │   │  • 构建 AgentContext                                        │ │  │
│   │   │  • 对话结束后触发 VibeExtractor                             │ │  │
│   │   └────────────────────────────────────────────────────────────┘ │  │
│   │                              │                                    │  │
│   │                              ▼                                    │  │
│   │   ┌────────────────────────────────────────────────────────────┐ │  │
│   │   │                      CoreAgent                              │ │  │
│   │   │  • Phase 1: Skill 路由 (use_skill)                         │ │  │
│   │   │  • Phase 2: 加载 Rule 文件到 System Prompt                 │ │  │
│   │   │  • LLM 驱动对话，自己控制协议流程                          │ │  │
│   │   │  • 完成后调用 save_skill_data 保存                         │ │  │
│   │   └────────────────────────────────────────────────────────────┘ │  │
│   │                              │                                    │  │
│   │              ┌───────────────┼───────────────┐                   │  │
│   │              ▼               ▼               ▼                   │  │
│   │         ┌────────┐     ┌────────┐     ┌────────┐                │  │
│   │         │  Bazi  │     │Lifecoach│    │ Zodiac │                │  │
│   │         │ Skill  │     │ Skill  │     │ Skill  │                │  │
│   │         └────────┘     └────────┘     └────────┘                │  │
│   │                              │                                    │  │
│   └──────────────────────────────┼───────────────────────────────────┘  │
│                                  ▼                                      │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                    VibeProfile (PostgreSQL JSONB)                 │  │
│   │                                                                   │  │
│   │   identity:                                                       │  │
│   │   ├── display_name, birth_info                                   │  │
│   │                                                                   │  │
│   │   skills:                                                         │  │
│   │   ├── bazi: { chart, dayun }                                     │  │
│   │   ├── zodiac: { chart }                                          │  │
│   │   ├── lifecoach: { north_star, goals, current, progress }        │  │
│   │                                                                   │  │
│   │   vibe:   ◀── 由 VibeExtractor 根据配置提取                      │  │
│   │   ├── current: { emotion, energy, focus, topics }  ← Hot Layer   │  │
│   │   ├── profile: { identity, goals, people, context } ← Warm Layer │  │
│   │   └── timeline: [ events... ]                       ← Cold Layer │  │
│   │                                                                   │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                    VibeExtractor (配置驱动 + LLM 执行)            │  │
│   │                                                                   │  │
│   │   config/vibe_extract.json                                        │  │
│   │   ├── schema: Vibe 结构定义                                       │  │
│   │   ├── extractors: 提取规则 (realtime, daily, skill_sync)         │  │
│   │   ├── transforms: 转换映射 (bazi→原型, zodiac→原型)              │  │
│   │   └── context_injection: Context 注入模板                        │  │
│   │                                                                   │  │
│   │   执行：LLM 根据配置提取/转换/合并，代码只做 I/O                  │  │
│   │                                                                   │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心设计：Chat-First + LLM 驱动

### 3.1 Chat-First 设计哲学

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Chat-First 设计                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   用户来到 VibeLife，脑子里只需要记住三件事：                             │
│                                                                          │
│   1. 💬 想聊天 → 直接说话                                                │
│   2. 🪞 想了解自己 → 点镜子 (Me 页面)                                    │
│   3. 🧭 想看目标进度 → 点罗盘 (Journey 页面)                             │
│                                                                          │
│   其他一切，VibeLife 会在对话中引导你。                                   │
│                                                                          │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   页面职责划分：                                                          │
│                                                                          │
│   Chat 页面          Journey/Me 页面                                     │
│   ──────────         ────────────────                                    │
│   • 所有深度交互      • 展示数据                                          │
│   • 协议执行          • 勾选完成                                          │
│   • 目标设定          • 快捷入口 → 跳转 Chat                              │
│   • 复盘对话                                                              │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 LLM 驱动的协议执行（方案 D）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    方案 D：纯 Prompt 驱动                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   Protocol 实现 = Rule 文件 + save_skill_data 工具                       │
│                                                                          │
│   需要：                                                                  │
│   ✅ rules/dankoe.md - 完整的协议流程（6 个问题）                        │
│   ✅ save_skill_data - 通用数据保存工具                                  │
│   ✅ show_dankoe - 方法论专属卡片                                        │
│                                                                          │
│   不需要：                                                                │
│   ❌ protocol 状态追踪                                                   │
│   ❌ step 计数器                                                         │
│   ❌ start_protocol / advance_protocol_step 工具                        │
│   ❌ 前端传 protocol 参数                                                │
│                                                                          │
│   LLM 自己驱动对话，从对话历史判断进度                                   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. VibeProfile 三层架构 (v13)

### 4.1 设计原则

```
┌─────────────────────────────────────────────────────────────────────────┐
│                  VibeProfile v13 - 配置驱动 + LLM 执行                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   核心原则：                                                              │
│   1. 配置即规则：所有提取/转换/合并规则在 JSON 配置                       │
│   2. LLM 即引擎：所有执行逻辑由 LLM 完成，无硬编码算法                    │
│   3. 代码只做 I/O：代码只负责读配置、调 LLM、写数据库                     │
│                                                                          │
│   三层存储：                                                              │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  vibe.current (Hot Layer)                                       │   │
│   │  ─────────────────────────                                      │   │
│   │  更新：每轮对话后                                                │   │
│   │  内容：emotion, energy, focus, topics, context                  │   │
│   │  策略：覆盖写入                                                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  vibe.profile (Warm Layer)                                      │   │
│   │  ──────────────────────────                                     │   │
│   │  更新：每日凌晨                                                  │   │
│   │  内容：identity, goals, people, context, preferences            │   │
│   │  策略：增量合并                                                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │  vibe.timeline (Cold Layer)                                     │   │
│   │  ───────────────────────────                                    │   │
│   │  更新：检测到事件时                                              │   │
│   │  内容：goal, relationship, decision, milestone, life_event      │   │
│   │  策略：追加存储                                                  │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    VibeProfile 数据流                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   数据源                      VibeExtractor               存储           │
│   ──────                      ─────────────               ────           │
│                                                                          │
│   messages ─────┐                                                        │
│   tool_calls ───┼───► 读取 vibe_extract.json ──► LLM 执行 ──► vibe.*    │
│   skills.* ─────┤     ├─ schema                                          │
│   usage_events ─┘     ├─ extractors (realtime, daily, skill_sync)       │
│                       ├─ transforms (bazi→原型, zodiac→原型)            │
│                       └─ context_injection                               │
│                                                                          │
│   触发时机：                                                              │
│   • on_conversation_turn → realtime + event_detector                    │
│   • cron:0 4 * * * → daily                                              │
│   • on_skill_update → skill_sync                                        │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.3 配置文件位置

```
config/
└── vibe_extract.json    # 唯一规则来源

services/vibe/
├── __init__.py
└── extractor.py         # 极简执行引擎（~100 行）
```

---

## 5. CoreAgent

### 5.1 核心流程

```
用户消息 + skill + scenario
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ chat_v5.py                                                               │
│                                                                          │
│ 1. 解析参数：skill, scenario, prompt                                     │
│ 2. 优先使用前端传的 scenario                                             │
│ 3. 如果没有，调用 _route_scenario() 智能匹配                             │
│ 4. 构建 AgentContext                                                     │
│ 5. 对话结束后触发 VibeExtractor.execute("on_conversation_turn")         │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│ CoreAgent.run()                                                          │
│                                                                          │
│ Phase 1: Skill 路由（如果 skill 为空）                                   │
│ ├─ 调用 use_skill 工具                                                   │
│ └─ LLM 决定使用哪个 Skill                                                │
│                                                                          │
│ Phase 2: 构建 System Prompt                                              │
│ ├─ 加载 SKILL.md（专家身份）                                             │
│ ├─ 加载 rules/{scenario}.md（协议流程）                                  │
│ ├─ 加载相关 Cases（倒排索引匹配）                                        │
│ └─ 注入用户上下文（通过 VibeExtractor.build_context()）                  │
│                                                                          │
│ Phase 3: LLM 驱动对话                                                    │
│ ├─ LLM 按照 Rule 文件自己控制流程                                        │
│ ├─ 可以追问、跳过、调整节奏                                              │
│ └─ 从对话历史判断进度                                                    │
│                                                                          │
│ Phase 4: 完成后保存                                                      │
│ ├─ 调用 save_skill_data 保存数据                                         │
│ └─ 调用 show_xxx 展示结果卡片                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Skill System

### 6.1 Skill 目录结构

```
skills/{skill_id}/
├── SKILL.md              # Skill 定义（专家身份、触发词、配置）
├── rules/                # 规则文件（协议流程、分析要点）
│   ├── _index.md         # 规则索引
│   ├── dankoe.md         # Dan Koe 快速重置协议
│   └── weekly-review.md  # 周复盘协议
├── tools/                # 工具定义
│   ├── tools.yaml        # 工具 Schema
│   └── handlers.py       # 工具执行器
├── services/             # 领域服务
│   └── api.py            # API 服务
└── reminders.yaml        # 主动推送配置
```

---

## 7. 版本历史

- **V8.3** (2026-01-23):
  - VibeProfile v13：配置驱动 + LLM 执行
  - 三层存储：current (Hot) + profile (Warm) + timeline (Cold)
  - 删除 vibe_sync.yaml，统一用 vibe_extract.json
  - VibeExtractor 极简实现（~100 行代码）

- **V8.2** (2026-01-22):
  - VibeProfile 三层架构：Identity + Skills + Vibe
  - 新增 vibe.insight 和 vibe.target 共享深度信息

- **V8.1** (2026-01-20):
  - Chat-First 设计哲学
  - 方案 D：纯 Prompt 驱动的协议执行
  - 混合路由方案

- **V8.0** (2026-01-19):
  - VibeProfile 整合：WHO/WHAT 数据分离
  - Knowledge v2（Case 倒排索引）
  - Proactive 模块
