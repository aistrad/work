{
  "version": "13.0",
  "description": "Vibe 提取配置 - 配置驱动 + LLM 执行",

  "schema": {
    "vibe": {
      "current": {
        "description": "当前状态（Hot Layer，实时更新）",
        "fields": {
          "emotion": {
            "type": "enum",
            "values": ["anxious", "sad", "neutral", "content", "excited", "focused"],
            "description": "当前情绪"
          },
          "energy": {
            "type": "enum",
            "values": ["low", "medium", "high"],
            "description": "能量水平"
          },
          "focus": {
            "type": "array",
            "items": "string",
            "description": "当前关注领域"
          },
          "topics": {
            "type": "array",
            "items": "string",
            "max_items": 5,
            "description": "进行中的话题"
          },
          "context": {
            "type": "string",
            "description": "当前对话上下文摘要（一句话）"
          }
        }
      },
      "profile": {
        "description": "稳定画像（Warm Layer，每日更新）",
        "fields": {
          "identity": {
            "archetypes": {
              "type": "array",
              "items": "string",
              "max_items": 3,
              "description": "人格原型"
            },
            "traits": {
              "type": "array",
              "items": "string",
              "max_items": 5,
              "description": "核心特质"
            },
            "style": {
              "type": "string",
              "description": "沟通风格"
            },
            "sources": {
              "type": "object",
              "description": "来源数据追溯"
            }
          },
          "goals": {
            "type": "array",
            "items": {
              "id": "string",
              "title": "string",
              "category": "enum:career|health|relationship|wealth|growth",
              "status": "enum:active|paused|completed",
              "progress": "number:0-100",
              "deadline": "date",
              "mentioned_at": "date"
            },
            "max_items": 10,
            "description": "目标列表"
          },
          "people": {
            "type": "array",
            "items": {
              "id": "string",
              "name": "string",
              "relation": "enum:romantic|family|friend|colleague|other",
              "birth_info": "object",
              "notes": "string",
              "mentioned_at": "date"
            },
            "max_items": 20,
            "description": "关键人物"
          },
          "context": {
            "occupation": "string",
            "industry": "string",
            "life_stage": "enum:student|early_career|career_growth|career_peak|transition|retirement",
            "concerns": {
              "type": "array",
              "max_items": 5
            },
            "interests": {
              "type": "array",
              "max_items": 10
            }
          },
          "preferences": {
            "response_style": "string",
            "language": "string",
            "topics_to_avoid": "array"
          }
        }
      },
      "timeline": {
        "description": "重要事件（Cold Layer，追加存储）",
        "type": "array",
        "max_items": 100,
        "items": {
          "id": "string",
          "date": "date",
          "type": "enum:goal|relationship|decision|milestone|life_event",
          "event": "string",
          "data": "object"
        }
      }
    }
  },

  "sources": {
    "messages": {
      "description": "对话消息",
      "query": "SELECT role, content, created_at FROM messages WHERE conversation_id = :conversation_id ORDER BY created_at DESC LIMIT :limit"
    },
    "skills": {
      "description": "Skill 计算数据",
      "path": "unified_profiles.profile.skills"
    },
    "current_vibe": {
      "description": "当前 Vibe 数据",
      "path": "unified_profiles.profile.vibe"
    }
  },

  "extractors": {
    "realtime": {
      "description": "实时提取器 - 每轮对话后执行",
      "trigger": "on_conversation_turn",
      "input": {
        "messages": {
          "source": "messages",
          "params": { "limit": 10 }
        }
      },
      "output": {
        "target": "vibe.current",
        "strategy": "overwrite"
      },
      "instruction": "分析对话消息，提取用户当前状态。根据 schema.vibe.current 的字段定义输出 JSON。只输出有明确依据的字段，不要推测。"
    },

    "daily": {
      "description": "定时提取器 - 每日凌晨执行",
      "trigger": "cron:0 4 * * *",
      "input": {
        "messages": {
          "source": "messages",
          "params": { "limit": 200, "days": 7 }
        },
        "skills": {
          "source": "skills",
          "fields": ["bazi", "zodiac", "lifecoach"]
        },
        "current_profile": {
          "source": "current_vibe",
          "path": "profile"
        }
      },
      "output": {
        "target": "vibe.profile",
        "strategy": "merge",
        "merge_rules": {
          "identity.archetypes": { "strategy": "append_unique", "max_items": 3 },
          "identity.traits": { "strategy": "append_unique", "max_items": 5 },
          "goals": { "strategy": "merge_by_field", "field": "title", "max_items": 10 },
          "people": { "strategy": "merge_by_field", "field": "name", "max_items": 20 },
          "context.concerns": { "strategy": "append_unique", "max_items": 5 },
          "context.interests": { "strategy": "append_unique", "max_items": 10 }
        }
      },
      "instruction": "分析用户过去一周的交互记录和 Skill 数据，更新用户画像。根据 merge_rules 合并到现有 profile。只输出有变化的字段。"
    },

    "event_detector": {
      "description": "事件检测器 - 实时检测重要事件",
      "trigger": "on_conversation_turn",
      "input": {
        "messages": {
          "source": "messages",
          "params": { "limit": 5 }
        }
      },
      "output": {
        "target": "vibe.timeline",
        "strategy": "append",
        "max_items": 100
      },
      "detect_rules": [
        {
          "type": "goal",
          "description": "检测新目标设定",
          "indicators": ["想要", "计划", "目标是", "打算", "希望能", "我要"]
        },
        {
          "type": "relationship",
          "description": "检测关键人物提及",
          "indicators": ["伴侣", "老公", "老婆", "男朋友", "女朋友", "爸", "妈", "父亲", "母亲", "朋友", "同事", "老板"]
        },
        {
          "type": "decision",
          "description": "检测重要决策",
          "indicators": ["纠结", "犹豫", "考虑", "要不要", "是否", "选择", "offer", "机会"]
        },
        {
          "type": "life_event",
          "description": "检测人生事件",
          "indicators": ["结婚", "订婚", "分手", "离婚", "买房", "卖房", "搬家", "怀孕", "生孩子", "升职", "降职", "被裁", "辞职", "生病", "住院"]
        }
      ],
      "instruction": "检测对话中是否有重要事件。根据 detect_rules 的 indicators 判断，如有检测到事件，输出符合 schema.vibe.timeline.items 格式的事件数组。无事件则输出空数组 []。"
    },

    "skill_sync": {
      "description": "Skill 数据同步器 - Skill 数据更新时执行",
      "trigger": "on_skill_update",
      "rules": [
        {
          "skill": "bazi",
          "when": "chart.day_master exists",
          "transform": {
            "description": "从八字日主提取人格原型",
            "input_field": "chart.day_master.element",
            "mapping": {
              "wood": { "archetype": "成长者", "traits": ["创新", "进取", "仁慈"] },
              "fire": { "archetype": "表达者", "traits": ["热情", "领导", "直觉"] },
              "earth": { "archetype": "稳定者", "traits": ["务实", "包容", "信守"] },
              "metal": { "archetype": "完善者", "traits": ["精准", "公正", "坚韧"] },
              "water": { "archetype": "智慧者", "traits": ["灵活", "深思", "洞察"] }
            }
          },
          "output": {
            "target": "vibe.profile.identity",
            "strategy": "merge",
            "also_save_source": {
              "target": "vibe.profile.identity.sources.bazi",
              "fields": ["day_master", "element"]
            }
          }
        },
        {
          "skill": "zodiac",
          "when": "chart.sun_sign exists",
          "transform": {
            "description": "从星座提取人格原型",
            "input_field": "chart.sun_sign",
            "mapping": {
              "aries": { "archetype": "开拓者", "traits": ["勇敢", "主动"] },
              "taurus": { "archetype": "稳定者", "traits": ["稳定", "务实"] },
              "gemini": { "archetype": "沟通者", "traits": ["灵活", "好奇"] },
              "cancer": { "archetype": "守护者", "traits": ["敏感", "关怀"] },
              "leo": { "archetype": "领袖者", "traits": ["自信", "慷慨"] },
              "virgo": { "archetype": "完善者", "traits": ["细致", "分析"] },
              "libra": { "archetype": "和谐者", "traits": ["和谐", "公正"] },
              "scorpio": { "archetype": "洞察者", "traits": ["深度", "洞察"] },
              "sagittarius": { "archetype": "探索者", "traits": ["乐观", "探索"] },
              "capricorn": { "archetype": "成就者", "traits": ["务实", "责任"] },
              "aquarius": { "archetype": "创新者", "traits": ["创新", "独立"] },
              "pisces": { "archetype": "直觉者", "traits": ["直觉", "同情"] }
            }
          },
          "output": {
            "target": "vibe.profile.identity",
            "strategy": "merge",
            "also_save_source": {
              "target": "vibe.profile.identity.sources.zodiac",
              "fields": ["sun_sign", "moon_sign", "rising_sign"]
            }
          }
        },
        {
          "skill": "lifecoach",
          "when": "goals exists",
          "output": {
            "source_path": "goals",
            "target": "vibe.profile.goals",
            "strategy": "merge_by_field",
            "field": "title"
          }
        },
        {
          "skill": "lifecoach",
          "when": "north_star exists",
          "output": {
            "source_path": "north_star",
            "target": "vibe.profile.goals",
            "strategy": "prepend_as_primary",
            "transform_to_goal": {
              "title_from": "vision_scene",
              "category": "growth",
              "status": "active"
            }
          }
        }
      ],
      "instruction": "根据 Skill 数据和转换规则，提取用户身份信息。应用 transform.mapping 进行转换，按 output.strategy 合并到目标位置。同时保存原始数据到 sources。"
    }
  },

  "context_injection": {
    "description": "Context 注入配置 - 用于构建 System Prompt",
    "template": "根据 vibe 数据，生成用于注入 System Prompt 的用户上下文描述。格式要求：\n- 【当前状态】情绪和关注点\n- 【人格原型】核心原型和特质\n- 【当前目标】活跃目标（最多3个）\n- 【职业背景】职业和行业\n- 【关注问题】当前困扰\n\n简洁明了，每项一行，无内容则省略该项。",
    "skill_overrides": {
      "lifecoach": {
        "include": ["current", "profile.goals", "profile.context"],
        "exclude": ["profile.identity.sources"]
      },
      "bazi": {
        "include": ["profile.identity.sources.bazi", "current.focus"]
      },
      "zodiac": {
        "include": ["profile.identity.sources.zodiac", "current.focus"]
      },
      "synastry": {
        "include": ["profile.people", "profile.identity"]
      }
    }
  }
}
