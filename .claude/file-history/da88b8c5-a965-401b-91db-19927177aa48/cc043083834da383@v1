-- ═══════════════════════════════════════════════════════════════════════════
-- Migration: 004_update_model_routes
-- Description: 更新模型路由配置
--   - VIP/Pro 用户改用 Gemini 3 Pro
--   - 全局默认改为 GLM-4.7 Flash
-- Created: 2026-01-09
-- ═══════════════════════════════════════════════════════════════════════════

-- ═══════════════════════════════════════════════════════════════════════════
-- 1. 添加新模型 GLM-4.7 Flash
-- ═══════════════════════════════════════════════════════════════════════════
INSERT INTO models (id, provider_id, model_name, display_name, capabilities, cost_per_1k_input, cost_per_1k_output, max_tokens, context_window)
VALUES ('glm:glm-4.7', 'glm', 'glm-4.7', 'GLM-4.7 Flash', '["chat", "analysis"]', 0.001, 0.001, 4096, 128000)
ON CONFLICT (id) DO UPDATE SET
    model_name = EXCLUDED.model_name,
    display_name = EXCLUDED.display_name,
    capabilities = EXCLUDED.capabilities,
    cost_per_1k_input = EXCLUDED.cost_per_1k_input,
    cost_per_1k_output = EXCLUDED.cost_per_1k_output,
    max_tokens = EXCLUDED.max_tokens,
    context_window = EXCLUDED.context_window,
    updated_at = NOW();

-- ═══════════════════════════════════════════════════════════════════════════
-- 2. 更新路由规则
-- ═══════════════════════════════════════════════════════════════════════════

-- 更新 VIP 用户路由（原 Claude → Gemini 3 Pro）
UPDATE model_routes
SET name = 'VIP用户用Gemini Pro',
    description = 'VIP 用户使用 Gemini 3 Pro',
    model_id = 'gemini:gemini-3-pro',
    fallback_chain = '{"glm:glm-4.7", "glm:glm-4-flash"}',
    updated_at = NOW()
WHERE match_user_tier = 'vip' AND priority = 30;

-- 更新 Pro 用户路由（原 GLM-4 Plus → Gemini 3 Pro）
UPDATE model_routes
SET name = 'Pro用户用Gemini Pro',
    description = 'Pro 用户使用 Gemini 3 Pro',
    model_id = 'gemini:gemini-3-pro',
    fallback_chain = '{"glm:glm-4.7", "glm:glm-4-flash"}',
    updated_at = NOW()
WHERE match_user_tier = 'pro' AND priority = 35;

-- 更新全局默认路由（GLM-4 Flash → GLM-4.7 Flash）
UPDATE model_routes
SET name = '全局默认',
    description = '默认使用 GLM-4.7 Flash',
    model_id = 'glm:glm-4.7',
    fallback_chain = '{"glm:glm-4-flash", "gemini:gemini-3-pro"}',
    updated_at = NOW()
WHERE priority = 100 AND match_user_tier IS NULL AND match_task IS NULL AND match_skill IS NULL AND match_user_id IS NULL;

-- ═══════════════════════════════════════════════════════════════════════════
-- 3. 更新配额规则
-- ═══════════════════════════════════════════════════════════════════════════

-- 添加 Gemini 全局日限
INSERT INTO quota_rules (name, description, scope, scope_provider_id, period, max_calls, on_exceed, downgrade_to_model, enabled)
VALUES ('Gemini 全局日限', '每天最多调用 Gemini 5000 次', 'provider', 'gemini', 'daily', 5000, 'downgrade', 'glm:glm-4.7', TRUE)
ON CONFLICT DO NOTHING;

-- 更新 Claude 配额降级目标（从 glm-4-plus → gemini-3-pro）
UPDATE quota_rules
SET downgrade_to_model = 'gemini:gemini-3-pro',
    updated_at = NOW()
WHERE scope_provider_id = 'claude' AND scope = 'provider';

-- ═══════════════════════════════════════════════════════════════════════════
-- 4. 验证更新结果
-- ═══════════════════════════════════════════════════════════════════════════

-- 查看更新后的路由规则
-- SELECT id, name, priority, match_user_tier, model_id, fallback_chain FROM model_routes WHERE enabled = TRUE ORDER BY priority;

-- 查看更新后的配额规则
-- SELECT id, name, scope, scope_provider_id, downgrade_to_model FROM quota_rules WHERE enabled = TRUE;
