'use client';

/**
 * Discover Content - App Store 风格的 Skill 探索页面
 *
 * 在 AppShell 的 discover tab 中显示
 * 参考 Apple App Store 的设计理念
 */

import React, { useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { AlertCircle, Sparkles } from 'lucide-react';
import { FeaturedSkillBanner } from './FeaturedSkillBanner';
import { CategorySection } from './CategorySection';
import { SkillShowcaseCard } from './SkillShowcaseCard';
import { useSkills, useSkillSubscription, useSkillRecommendations } from '@/hooks/useSkillSubscription';
import { useAuth } from '@/providers/AuthProvider';
import type { SkillMetadata } from '@/types/skill';

export function DiscoverContent() {
  const router = useRouter();
  const { user } = useAuth();
  const { skills, categories, isLoading: skillsLoading, error: skillsError } = useSkills();
  const {
    userStatuses,
    subscribe,
    unsubscribe,
    isLoading: subscriptionsLoading,
  } = useSkillSubscription();
  const { recommendations } = useSkillRecommendations({ limit: 3, enabled: !!user });

  const isLoading = skillsLoading || subscriptionsLoading;

  // 按分类分组 Skills
  const skillsByCategory = useMemo(() => {
    const grouped: Record<string, SkillMetadata[]> = {
      professional: [],
      core: [], // 合并 default 和 core 到这里
    };

    for (const skill of skills) {
      if (skill.category === 'professional') {
        grouped.professional.push(skill);
      } else {
        // default 和 core 都归入 core
        grouped.core.push(skill);
      }
    }

    return grouped;
  }, [skills]);

  // 精选 Skill (选择最有特色的)
  const featuredSkill = useMemo(() => {
    // 优先选择 professional 分类的第一个
    return skillsByCategory.professional[0] || skillsByCategory.core[0] || skills[0];
  }, [skillsByCategory, skills]);

  // 推荐 Skills
  const recommendedSkills = useMemo(() => {
    const recommendedIds = new Set(recommendations.map(r => r.skill_id));
    return skills.filter(s => recommendedIds.has(s.id));
  }, [skills, recommendations]);

  // 处理订阅
  const handleSubscribe = async (skillId: string) => {
    if (!user) {
      router.push('/auth/login?redirect=/chat');
      return;
    }
    try {
      await subscribe(skillId);
    } catch (error: any) {
      // 处理 Premium 要求错误 (402)
      if (error?.response?.status === 402) {
        const detail = error.response.data?.detail;
        if (detail?.code === 'PREMIUM_REQUIRED') {
          router.push(`/membership?reason=skill_subscribe&skill=${skillId}`);
          return;
        }
      }
      console.error('Subscribe failed:', error);
    }
  };

  // 处理取消订阅
  const handleUnsubscribe = async (skillId: string) => {
    if (!user) return;
    try {
      await unsubscribe(skillId);
    } catch (error) {
      console.error('Unsubscribe failed:', error);
    }
  };

  // 处理点击 Skill
  const handleSkillClick = (skillId: string) => {
    router.push(`/skills/${skillId}`);
  };

  // Loading 状态
  if (isLoading) {
    return (
      <div className="h-full overflow-y-auto bg-bg-primary">
        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8 space-y-8">
          {/* Featured 骨架屏 */}
          <div className="h-[400px] lg:h-[480px] rounded-3xl bg-bg-secondary animate-pulse" />

          {/* Section 骨架屏 */}
          {[1, 2, 3].map((i) => (
            <div key={i} className="space-y-4">
              <div className="h-8 w-48 bg-bg-secondary animate-pulse rounded-lg" />
              <div className="flex gap-4 overflow-hidden">
                {[1, 2, 3].map((j) => (
                  <div key={j} className="w-80 h-64 bg-bg-secondary animate-pulse rounded-2xl flex-shrink-0" />
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // 错误状态
  if (skillsError) {
    return (
      <div className="h-full overflow-y-auto bg-bg-primary">
        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8">
          <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
            <div className="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center">
              <AlertCircle className="w-10 h-10 text-red-500" />
            </div>
            <div className="text-center space-y-2">
              <h2 className="text-2xl font-bold text-text-primary">加载失败</h2>
              <p className="text-text-secondary max-w-md">
                无法加载 Skill 列表。请稍后重试或联系支持。
              </p>
            </div>
            <button
              onClick={() => window.location.reload()}
              className="px-6 py-3 rounded-full bg-accent-primary text-text-inverse font-medium hover:bg-accent-primary/90 transition-colors"
            >
              重新加载
            </button>
          </div>
        </div>
      </div>
    );
  }

  // 空状态
  if (!skills || skills.length === 0) {
    return (
      <div className="h-full overflow-y-auto bg-bg-primary">
        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8">
          <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
            <div className="w-20 h-20 rounded-full bg-accent-primary/10 flex items-center justify-center">
              <Sparkles className="w-10 h-10 text-accent-primary" />
            </div>
            <div className="text-center space-y-2">
              <h2 className="text-2xl font-bold text-text-primary">即将推出</h2>
              <p className="text-text-secondary max-w-md">
                我们正在准备更多精彩的 Skills，敬请期待！
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full overflow-y-auto bg-bg-primary">
      <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8 space-y-12">
        {/* 精选横幅 */}
        {featuredSkill && (
          <FeaturedSkillBanner
            skill={featuredSkill}
            campaign={{
              title: '精选推荐',
              subtitle: '开启你的自我探索之旅',
              badge: '编辑推荐',
            }}
            onClick={() => handleSkillClick(featuredSkill.id)}
          />
        )}

        {/* 为你推荐 */}
        {recommendedSkills.length > 0 && (
          <CategorySection
            title="为你推荐"
            subtitle="基于你的使用习惯智能推荐"
            skills={recommendedSkills}
            userStatuses={userStatuses}
            onSkillClick={handleSkillClick}
            onSubscribe={handleSubscribe}
          />
        )}

        {/* 专业技能 */}
        {skillsByCategory.professional.length > 0 && (
          <CategorySection
            title="专业技能"
            subtitle="深度探索，专业洞察"
            skills={skillsByCategory.professional}
            userStatuses={userStatuses}
            onSkillClick={handleSkillClick}
            onSubscribe={handleSubscribe}
          />
        )}

        {/* 核心能力（合并了基础功能和原核心能力）*/}
        {skillsByCategory.core.length > 0 && (
          <CategorySection
            title="核心能力"
            subtitle="人人可用的实用工具，始终激活助你成长"
            skills={skillsByCategory.core}
            userStatuses={userStatuses}
            onSkillClick={handleSkillClick}
            onSubscribe={handleSubscribe}
          />
        )}

        {/* 底部空白 */}
        <div className="h-8" />
      </div>
    </div>
  );
}
