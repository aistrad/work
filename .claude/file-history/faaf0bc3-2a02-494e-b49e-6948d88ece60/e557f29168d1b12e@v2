# Ultra Analysis Report: CoreAgent v10 æ·±åº¦åˆ†æ

## ç”¨æˆ·ç¡®è®¤çš„ä¼˜å…ˆçº§

1. **æœ€ç´§è¿«**ï¼šä¸ªæ€§åŒ–è·¯ç”±ï¼ˆPhase 1 æ— ç”»åƒï¼‰
2. **æ•°æ®èåˆ**ï¼šé€šè¿‡ vibe.insight é—´æ¥èåˆå‘½ç›˜æ•°æ®
3. **Dashboard**ï¼šç›®å‰åœ¨ Chat ç©ºçŠ¶æ€ä¸­å±•ç¤ºï¼Œåç»­å†³å®š

---

## é¡¹ç›®ç†è§£

CoreAgent v10 æ˜¯ VibeLife å¹³å°çš„æ ¸å¿ƒæ™ºèƒ½ä½“å¼•æ“ï¼Œé‡‡ç”¨ **Context Engineering** é©±åŠ¨æ¶æ„ã€‚

**æ ¸å¿ƒè®¾è®¡ç†å¿µ**ï¼š
- LLM é©±åŠ¨è·¯ç”±ï¼ˆç¦æ­¢ Python ç¡¬ç¼–ç ï¼‰
- åˆ†é˜¶æ®µä¸Šä¸‹æ–‡åŠ è½½ï¼ˆPhase 1 è½»é‡ / Phase 2 å®Œæ•´ï¼‰
- æ–­ç‚¹ç»­ä¼ æ”¯æŒï¼ˆSessionContext + Checkpointï¼‰
- ä¸‰å±‚ Profile æ¶æ„ï¼ˆIdentity + Skills + Vibeï¼‰

---

## æ—¶åºå›¾ï¼šå®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·å¯¹è¯æ•°æ®æµ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ¶ˆæ¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  chat_v5.py   â”‚ â”€â”€ Phase 1: skill=None æ—¶ä¸åŠ è½½ Profile
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   CoreAgent   â”‚â”€â”€â”€â”€â–¶â”‚  PromptBuilder.build â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                         â”‚
    â”‚                         â–¼
    â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚ _build_profile_contextâ”‚ â—€â”€â”€ è¯»å– profile.vibe.insight
    â”‚                 â”‚                      â”‚     è¯»å– profile.vibe.target
    â”‚                 â”‚ ã€é—®é¢˜2ã€‘åªåœ¨ Phase 2  â”‚     è¯»å– profile.identity
    â”‚                 â”‚ æ‰æ³¨å…¥ï¼ŒPhase 1 æ— ç”»åƒ â”‚
    â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM è°ƒç”¨å·¥å…·                                                              â”‚
â”‚  â””â”€ activate_skill(skill="lifecoach", rule="dankoe")                      â”‚
â”‚  â””â”€ write_lifecoach_state(section="north_star", data={...})               â”‚
â”‚  â””â”€ show_dankoe({vision, anti_vision, game_elements})                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  write_lifecoach_state â†’ UnifiedProfileRepository.update_skill_data       â”‚
â”‚                                                                            â”‚
â”‚  å†™å…¥è·¯å¾„: profile.skills.lifecoach.{section}                             â”‚
â”‚                                                                            â”‚
â”‚  ã€æ³¨æ„ã€‘æ²¡æœ‰è‡ªåŠ¨åŒæ­¥åˆ° profile.vibe.target                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚  ï¼ˆæ— å®æ—¶åŒæ­¥ï¼‰
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProfileExtractor (å®šæ—¶ä»»åŠ¡ï¼Œæ¯æ—¥ 04:00)                                   â”‚
â”‚                                                                            â”‚
â”‚  è¾“å…¥: messages è¡¨ï¼ˆæœ€è¿‘ 30 å¤©ï¼‰                                           â”‚
â”‚  è¾“å‡º: profile.vibe.insight + profile.vibe.target                         â”‚
â”‚                                                                            â”‚
â”‚  ã€é—®é¢˜3ã€‘æ•°æ®æ»åï¼šæ–°å¯¹è¯å†…å®¹è¦ç­‰åˆ°æ¬¡æ—¥å‡Œæ™¨æ‰èƒ½è¢«æŠ½å–                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚  ï¼ˆéš”å¤©ï¼‰
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯è¯·æ±‚                                                                  â”‚
â”‚                                                                            â”‚
â”‚  /api/journey â†’ /api/v1/skills/lifecoach/state_read                       â”‚
â”‚      â””â”€ è¿”å› skills.lifecoach æ•°æ®ï¼ˆnorth_star, goals ç­‰ï¼‰                â”‚
â”‚                                                                            â”‚
â”‚  /api/dashboard â†’ MOCK_DATAï¼ˆæ— çœŸå®æ•°æ®ï¼ï¼‰                                â”‚
â”‚      â””â”€ ã€é—®é¢˜1ã€‘å‰ç«¯æ— æ³•è·å–èšåˆæ•°æ®                                     â”‚
â”‚                                                                            â”‚
â”‚  /api/profile â†’ /api/v1/account/profile                                   â”‚
â”‚      â””â”€ è¿”å›å®Œæ•´ profileï¼ˆä½†å‰ç«¯æœªå……åˆ†åˆ©ç”¨ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é—®é¢˜è¯†åˆ«

### é—®é¢˜ 1ï¼šå‰ç«¯æ•°æ®è·å–ä¸å®Œæ•´

**ç°çŠ¶**ï¼š
```
/api/journey        â†’ å­˜åœ¨ï¼Œè¯»å– skills.lifecoachï¼ˆå¯ç”¨ï¼‰
/api/dashboard      â†’ å­˜åœ¨ï¼Œä½†è¿”å› MOCK_DATAï¼ˆæ— çœŸå®æ•°æ®ï¼‰
/api/profile        â†’ å­˜åœ¨ï¼Œè¿”å›å®Œæ•´ profileï¼ˆä½†å‰ç«¯æœªè§£æ vibeï¼‰
```

**é—®é¢˜**ï¼š
- Dashboard é¡µé¢è¿”å›ç¡¬ç¼–ç  Mock æ•°æ®ï¼Œç”¨æˆ·æ— æ³•çœ‹åˆ°çœŸå®çš„ lifecoach çŠ¶æ€
- æ²¡æœ‰èšåˆç«¯ç‚¹åŒæ—¶è¿”å› `skills.lifecoach` + `vibe.insight` + `vibe.target`

**ä»£ç è¯æ®** (`apps/web/src/app/api/dashboard/route.ts:27`):
```typescript
const MOCK_DASHBOARD: DashboardDTO = {
  userId: "mock-user",
  // ... å…¨æ˜¯ç¡¬ç¼–ç æ•°æ®
};
```

---

### é—®é¢˜ 2ï¼šCoreAgent ä¸ªæ€§åŒ–ä¸è¶³

**ç°çŠ¶** (`apps/api/services/agent/prompt_builder.py:136-267`):
```python
def _build_profile_context(self, profile, skill_data, skill_id):
    # Layer 1: Identityï¼ˆåŸºç¡€ä¿¡æ¯ï¼‰- âœ… æ­£å¸¸æ³¨å…¥
    # Layer 2: Skillsï¼ˆSkill æ•°æ®ï¼‰- âœ… æ­£å¸¸æ³¨å…¥
    # Layer 3: Vibeï¼ˆç”¨æˆ·ç”»åƒï¼‰- âš ï¸ æœ‰è¯»å–ä½†æ³¨å…¥ä¸å®Œæ•´
```

**é—®é¢˜**ï¼š
1. **Phase 1 æ— ç”»åƒ**ï¼šSkill è·¯ç”±é˜¶æ®µï¼ˆPhase 1ï¼‰å®Œå…¨ä¸åŠ è½½ Profileï¼ŒLLM æ— æ³•åŸºäºç”¨æˆ·ç”»åƒåšæ™ºèƒ½è·¯ç”±
2. **vibe.insight æ³¨å…¥ç®€åŒ–**ï¼šåªæ³¨å…¥äº† archetypeã€traitsã€emotion ç­‰åŸºç¡€å­—æ®µ
3. **lifecoach ä¸èåˆå‘½ç›˜**ï¼šLifecoach Skill æ— æ³•è·å– bazi/zodiac æ•°æ®æ¥ç»™å‡º"å‘½ç†åŒ–"å»ºè®®

**ä»£ç è¯æ®** (`apps/api/routes/chat_v5.py:96-116`):
```python
async def get_user_context(user_id, skill=None):
    if not skill:
        # Phase 1: Skill é€‰æ‹©é˜¶æ®µï¼Œä¸éœ€è¦ profile
        return {}, {}  # â† å®Œå…¨ç©ºçš„ï¼
```

---

### é—®é¢˜ 3ï¼šæ•°æ®åŒæ­¥æ»å

**ç°çŠ¶**ï¼š
```
å¯¹è¯ä¿å­˜åˆ° messages è¡¨
    â†“ ï¼ˆç­‰å¾…ï¼‰
ProfileExtractor å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥ 04:00ï¼‰
    â†“
æŠ½å–åˆ° vibe.insight + vibe.target
    â†“
ä¸‹æ¬¡å¯¹è¯æ‰èƒ½ç”¨åˆ°æ–°ç”»åƒ
```

**é—®é¢˜**ï¼š
- ç”¨æˆ·ä»Šå¤©å®Œæˆ Dan Koe åè®®ï¼Œè®¾å®šäº†åŒ—ææ˜Ÿç›®æ ‡
- ç›´åˆ°æ˜å¤©å‡Œæ™¨ ProfileExtractor è¿è¡Œåï¼Œè¿™ä¸ªç›®æ ‡æ‰ä¼šå‡ºç°åœ¨ vibe.target
- æœŸé—´ CoreAgent æ— æ³•çŸ¥é“ç”¨æˆ·çš„æ–°ç›®æ ‡

**ä»£ç è¯æ®** (`apps/api/workers/profile_extractor.py:332`):
```python
async def run_profile_extraction(days: int = 7, batch_size: int = 10):
    """è¿è¡Œ Profile æŠ½å–ä»»åŠ¡"""
    # è¿™æ˜¯å®šæ—¶ä»»åŠ¡ï¼Œä¸æ˜¯å®æ—¶åŒæ­¥
```

---

## å»ºè®®æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šå®æ—¶ç”»åƒåŒæ­¥ï¼ˆæ¨èï¼‰

```
save_skill_data â†’ Profile æ›´æ–°
                      â†“ ï¼ˆåŒæ­¥ï¼‰
              sync_to_vibe_target
                      â†“
              profile.vibe.target å®æ—¶æ›´æ–°
```

**å®ç°**ï¼š
1. åœ¨ `write_lifecoach_state` å·¥å…·ä¸­æ·»åŠ  `sync_to_vibe` é€»è¾‘
2. å…³é”®æ•°æ®ï¼ˆnorth_star, goalsï¼‰ç«‹å³åŒæ­¥åˆ° vibe.target
3. ProfileExtractor ä½œä¸ºè¡¥å……ï¼Œå¤„ç†éç»“æ„åŒ–å¯¹è¯å†…å®¹

### æ–¹æ¡ˆ Bï¼šPhase 1 è½»é‡ç”»åƒæ³¨å…¥

**å®ç°**ï¼š
1. Phase 1 æ—¶åŠ è½½ vibe.target.focusï¼ˆç”¨æˆ·å½“å‰å…³æ³¨ç‚¹ï¼‰
2. è®© LLM åŸºäºå…³æ³¨ç‚¹åšæ›´æ™ºèƒ½çš„ Skill è·¯ç”±

### æ–¹æ¡ˆ Cï¼šDashboard API çœŸå®æ•°æ®

**å®ç°**ï¼š
1. åˆ›å»º `/api/v1/dashboard` åç«¯ç«¯ç‚¹
2. èšåˆè¿”å›ï¼šskills.lifecoach + vibe.insight + vibe.target + ä»Šæ—¥è¿åŠ¿
3. å‰ç«¯ Dashboard æ”¹ä¸ºè°ƒç”¨çœŸå® API

---

## æœªè§£å†³é—®é¢˜

1. **å®æ—¶åŒæ­¥ vs å®šæ—¶æŠ½å–çš„å–èˆ**ï¼šå®æ—¶åŒæ­¥å¢åŠ å†™å…¥å¤æ‚åº¦ï¼Œå®šæ—¶æŠ½å–æœ‰å»¶è¿Ÿ
2. **Phase 1 ç”»åƒæ³¨å…¥çš„ token æˆæœ¬**ï¼šæ³¨å…¥å¤ªå¤šä¼šå¢åŠ å»¶è¿Ÿ
3. **lifecoach èåˆå‘½ç›˜çš„æ–¹å¼**ï¼šç›´æ¥æ³¨å…¥ bazi.chart è¿˜æ˜¯åªæ³¨å…¥å…³é”®ç‰¹å¾ï¼Ÿ
4. **Dashboard èšåˆé€»è¾‘æ”¾å‰ç«¯è¿˜æ˜¯åç«¯**ï¼šæ€§èƒ½ vs ç»´æŠ¤æˆæœ¬
5. **ç”¨æˆ·æœŸæœ›çš„"ä¸ªæ€§åŒ–"ç¨‹åº¦æ˜¯ä»€ä¹ˆ**ï¼šæ˜¯åŸºäºå‘½ç›˜è¿˜æ˜¯åŸºäºè¡Œä¸ºï¼Ÿ

---

## å®æ–½è®¡åˆ’ï¼ˆåŸºäºç”¨æˆ·ç¡®è®¤ï¼‰

### P0: Phase 1 ä¸ªæ€§åŒ–è·¯ç”±ï¼ˆæ ¸å¿ƒé—®é¢˜ï¼‰

**ç›®æ ‡**ï¼šè®© LLM åœ¨ Skill è·¯ç”±é˜¶æ®µèƒ½åŸºäºç”¨æˆ·ç”»åƒåšæ™ºèƒ½å†³ç­–

**å½“å‰ä»£ç ä½ç½®**ï¼š
- `apps/api/routes/chat_v5.py:96-116` - get_user_context
- `apps/api/services/agent/prompt_builder.py:122-134` - Phase 1 Prompt

**ä¿®æ”¹æ–¹æ¡ˆ**ï¼š

```python
# chat_v5.py ä¿®æ”¹
async def get_user_context(user_id, skill=None):
    if not skill:
        # Phase 1: åŠ è½½å®Œæ•´ vibe.target ç”¨äºæ™ºèƒ½è·¯ç”±
        return await get_vibe_for_routing(user_id)  # æ–°å¢
    # Phase 2 ä¿æŒä¸å˜
```

```python
# æ–°å¢å‡½æ•°ï¼šget_vibe_for_routing
async def get_vibe_for_routing(user_id: UUID) -> tuple:
    """
    Phase 1 è·¯ç”±ç”»åƒï¼ˆ~200 tokensï¼‰

    åŠ è½½å®Œæ•´ vibe.targetï¼Œè®© LLM äº†è§£ç”¨æˆ·çš„ï¼š
    - åŒ—ææ˜Ÿæ„¿æ™¯
    - å½“å‰ç›®æ ‡
    - å…³æ³¨é¢†åŸŸ
    """
    from stores.unified_profile_repo import UnifiedProfileRepository

    profile = await UnifiedProfileRepository.get_profile(user_id)
    if not profile:
        return {}, {}

    vibe = profile.get("vibe", {})

    # è¿”å›å®Œæ•´ vibe.target + insight ç²¾ç®€
    routing_context = {
        "vibe_target": vibe.get("target", {}),  # å®Œæ•´ target
        "vibe_insight_summary": {
            # insight åªå–å…³é”®å­—æ®µ
            "archetype": vibe.get("insight", {}).get("essence", {}).get("archetype", {}),
            "chart_features": vibe.get("insight", {}).get("essence", {}).get("chart_features", {}),
            "emotion": vibe.get("insight", {}).get("dynamic", {}).get("emotion", {}),
        },
        "preferences": profile.get("preferences", {}),
    }
    return {"routing_context": routing_context}, {}
```

```python
# prompt_builder.py ä¿®æ”¹ - Phase 1 æ³¨å…¥å®Œæ•´ç”»åƒ
def build():
    if not skill_id:
        # Phase 1
        core_prompt = get_phase1_prompt()
        parts.append(core_prompt)

        # v10.2: æ³¨å…¥å®Œæ•´ vibe.target
        routing_ctx = profile.get("routing_context") if profile else None
        if routing_ctx:
            parts.append(self._build_routing_context(routing_ctx))
```

```python
def _build_routing_context(self, routing_ctx: Dict) -> str:
    """æ„å»º Phase 1 è·¯ç”±ä¸Šä¸‹æ–‡"""
    lines = ["\n## ç”¨æˆ·ç”»åƒï¼ˆç”¨äºä¸ªæ€§åŒ–è·¯ç”±ï¼‰\n"]

    # vibe.target
    target = routing_ctx.get("vibe_target", {})

    # åŒ—ææ˜Ÿ
    north_star = target.get("north_star", {})
    if north_star.get("vision_scene"):
        vision = north_star["vision_scene"][:100]  # æˆªæ–­
        lines.append(f"**æ„¿æ™¯**ï¼š{vision}")

    # å½“å‰ç›®æ ‡
    goals = target.get("goals", [])
    active_goals = [g for g in goals if g.get("status") == "in_progress"]
    if active_goals:
        goals_text = "ã€".join([g.get("title", "") for g in active_goals[:3]])
        lines.append(f"**å½“å‰ç›®æ ‡**ï¼š{goals_text}")

    # å…³æ³¨é¢†åŸŸ
    focus = target.get("focus", {})
    if focus.get("primary"):
        lines.append(f"**å…³æ³¨é¢†åŸŸ**ï¼š{focus['primary']}")

    # heat_mapï¼ˆå¦‚æœ‰ï¼‰
    heat_map = focus.get("heat_map", {})
    if heat_map:
        sorted_areas = sorted(heat_map.items(), key=lambda x: x[1], reverse=True)[:3]
        areas_text = "ã€".join([f"{k}({int(v*100)}%)" for k, v in sorted_areas])
        lines.append(f"**é¢†åŸŸçƒ­åº¦**ï¼š{areas_text}")

    # insight ç²¾ç®€
    insight = routing_ctx.get("vibe_insight_summary", {})

    # åŸå‹
    archetype = insight.get("archetype", {})
    if archetype.get("primary"):
        lines.append(f"**äººæ ¼åŸå‹**ï¼š{archetype['primary']}")

    # å‘½ç›˜ç‰¹å¾
    chart_features = insight.get("chart_features", {})
    if chart_features:
        if "bazi" in chart_features:
            day_master = chart_features["bazi"].get("day_master", {})
            lines.append(f"**å…«å­—æ—¥ä¸»**ï¼š{day_master.get('stem', '')}æœ¨")
        if "zodiac" in chart_features:
            lines.append(f"**å¤ªé˜³æ˜Ÿåº§**ï¼š{chart_features['zodiac'].get('sun_sign', '')}")

    # å½“å‰æƒ…ç»ª
    emotion = insight.get("emotion", {})
    if emotion.get("current"):
        lines.append(f"**å½“å‰æƒ…ç»ª**ï¼š{emotion['current']}")

    lines.append("\n**è·¯ç”±å»ºè®®**ï¼šåŸºäºä»¥ä¸Šç”»åƒï¼Œé€‰æ‹©æœ€åŒ¹é…ç”¨æˆ·å½“å‰éœ€æ±‚çš„ Skillã€‚")

    return "\n".join(lines)
```

**é¢„æœŸæ•ˆæœ**ï¼š
- ç”¨æˆ·æœ‰åŒ—ææ˜Ÿæ„¿æ™¯ â†’ LLM çŸ¥é“ç”¨æˆ·çš„é•¿æœŸæ–¹å‘
- ç”¨æˆ·å½“å‰ç›®æ ‡æ˜¯"æ‰¾å·¥ä½œ" â†’ LLM ä¼˜å…ˆæ¨è career
- ç”¨æˆ·é¢†åŸŸçƒ­åº¦ career:80%, health:30% â†’ LLM ä¼˜å…ˆæ¨èèŒä¸šç›¸å…³ Skill
- ç”¨æˆ·æ—¥ä¸»ç”²æœ¨ â†’ LLM åœ¨å›å¤ä¸­ä½“ç°æœ¨çš„ç‰¹è´¨
- ç”¨æˆ·æƒ…ç»ªç„¦è™‘ â†’ LLM ç”¨æ›´æ¸©æš–çš„è¯­æ°”

**Token ä¼°ç®—**ï¼š
- vibe.target: ~150 tokens
- insight ç²¾ç®€: ~50 tokens
- æ€»è®¡: ~200 tokensï¼ˆå¯æ¥å—ï¼‰

---

### P1: å‘½ç›˜è®¡ç®—æ—¶ç«‹å³åŒæ­¥åˆ° vibe.insight

**ç›®æ ‡**ï¼šcalculate_bazi/zodiac å®Œæˆåï¼Œç«‹å³å°†å…³é”®ç‰¹å¾å†™å…¥ vibe.insight

**å½“å‰ä»£ç ä½ç½®**ï¼š
- `apps/api/skills/bazi/tools/handlers.py:143-191` - calculate_bazi
- `apps/api/skills/zodiac/tools/handlers.py:15-108` - calculate_zodiac

**å½“å‰æµç¨‹**ï¼š
```
calculate_bazi
    â†“
è¿”å› chart æ•°æ®
    â†“
ï¼ˆç”¨æˆ·å¯èƒ½é€‰æ‹©ä¿å­˜å‡ºç”Ÿä¿¡æ¯ï¼‰
    â†“
chart æ•°æ®åªå­˜åœ¨äºæ¶ˆæ¯ä¸­ï¼ŒæœªæŒä¹…åŒ–ç‰¹å¾
```

**ä¿®æ”¹æ–¹æ¡ˆ**ï¼š

```python
# bazi/tools/handlers.py ä¿®æ”¹

@tool_handler("calculate_bazi")
async def execute_calculate_bazi(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    # ... ç°æœ‰è®¡ç®—é€»è¾‘ ...

    chart = calculate_bazi(birth_info["date"], birth_info["time"], birth_info["gender"])

    # ğŸ†• ç«‹å³åŒæ­¥å…³é”®ç‰¹å¾åˆ° vibe.insight
    if context.user_id and context.user_id != "guest":
        await sync_chart_features_to_insight(
            user_id=UUID(context.user_id),
            chart_type="bazi",
            features={
                "day_master": chart.get("day_master", {}),
                "pattern": chart.get("pattern", {}),
                "five_elements": chart.get("five_elements", {}),
            }
        )

    return result
```

```python
# æ–°å¢å‡½æ•°ï¼šsync_chart_features_to_insight

async def sync_chart_features_to_insight(
    user_id: UUID,
    chart_type: str,  # "bazi" | "zodiac"
    features: Dict[str, Any]
) -> None:
    """
    å°†å‘½ç›˜å…³é”®ç‰¹å¾åŒæ­¥åˆ° vibe.insight.essence.chart_features

    è®¾è®¡åŸåˆ™ï¼š
    1. åªåŒæ­¥"ç‰¹å¾"è€Œéå®Œæ•´å‘½ç›˜ï¼ˆå‡å°‘å†—ä½™ï¼‰
    2. å¤šæ¬¡è®¡ç®—åªä¿ç•™æœ€æ–°ï¼ˆè¦†ç›–æ¨¡å¼ï¼‰
    3. æ”¯æŒå¤šç§å‘½ç›˜å…±å­˜ï¼ˆbazi + zodiacï¼‰
    """
    from stores.unified_profile_repo import UnifiedProfileRepository

    # è¯»å–å½“å‰ insight
    current_insight = await UnifiedProfileRepository.get_vibe_insight(user_id)
    if not current_insight:
        current_insight = {}

    # è·å–æˆ–åˆå§‹åŒ– chart_features
    essence = current_insight.get("essence", {})
    chart_features = essence.get("chart_features", {})

    # åˆå¹¶æ–°ç‰¹å¾
    chart_features[chart_type] = {
        **features,
        "_synced_at": datetime.now(timezone.utc).isoformat()
    }

    # å†™å› insight
    essence["chart_features"] = chart_features
    current_insight["essence"] = essence

    await UnifiedProfileRepository.update_vibe_insight(user_id, current_insight)
    logger.info(f"Synced {chart_type} features to vibe.insight for user {user_id}")
```

**æ–°æ•°æ®æµ**ï¼š
```
calculate_bazi
    â†“
è®¡ç®—å¾—åˆ° chart
    â†“ ï¼ˆç«‹å³åŒæ­¥ï¼‰
sync_chart_features_to_insight
    â†“
vibe.insight.essence.chart_features.bazi = {
    day_master: {...},
    pattern: {...},
    five_elements: {...},
    _synced_at: "2026-01-22T..."
}
    â†“
ä¸‹æ¬¡å¯¹è¯ PromptBuilder è¯»å–
    â†“
Lifecoach è·å¾—å‘½ç›˜ç‰¹å¾
```

**zodiac åŒæ ·å¤„ç†**ï¼š
```python
# zodiac/tools/handlers.py ä¿®æ”¹

@tool_handler("calculate_zodiac")
async def execute_calculate_zodiac(args, context):
    # ... ç°æœ‰é€»è¾‘ ...
    chart = calc_zodiac(birth_date, birth_time, birth_place)

    # ğŸ†• ç«‹å³åŒæ­¥
    if context.user_id and context.user_id != "guest":
        await sync_chart_features_to_insight(
            user_id=UUID(context.user_id),
            chart_type="zodiac",
            features={
                "sun_sign": chart.get("sun_sign"),
                "moon_sign": chart.get("moon_sign"),
                "rising_sign": chart.get("rising_sign"),
                "dominant_element": chart.get("dominant_element"),
            }
        )
```

**vibe.insight.essence.chart_features æœ€ç»ˆç»“æ„**ï¼š
```json
{
  "bazi": {
    "day_master": {"stem": "ç”²", "branch": "å­"},
    "pattern": {"name": "é£Ÿç¥ç”Ÿè´¢", "strength": "strong"},
    "five_elements": {"wood": 3, "fire": 1, "earth": 2, "metal": 1, "water": 1},
    "_synced_at": "2026-01-22T10:30:00Z"
  },
  "zodiac": {
    "sun_sign": "Leo",
    "moon_sign": "Pisces",
    "rising_sign": "Scorpio",
    "dominant_element": "Water",
    "_synced_at": "2026-01-22T10:30:00Z"
  }
}
```

**PromptBuilder å¦‚ä½•ä½¿ç”¨**ï¼š
```python
# prompt_builder.py ä¿®æ”¹

def _build_profile_context(self, profile, skill_data, skill_id):
    # ... ç°æœ‰é€»è¾‘ ...

    # Layer 3: Vibeï¼ˆåŒ…å«å‘½ç›˜ç‰¹å¾ï¼‰
    vibe = profile.get("vibe", {})
    insight = vibe.get("insight", {})
    chart_features = insight.get("essence", {}).get("chart_features", {})

    if chart_features:
        features_text = []
        if "bazi" in chart_features:
            bazi = chart_features["bazi"]
            features_text.append(f"- å…«å­—æ—¥ä¸»ï¼š{bazi.get('day_master', {}).get('stem', '')}æœ¨")
        if "zodiac" in chart_features:
            zodiac = chart_features["zodiac"]
            features_text.append(f"- å¤ªé˜³æ˜Ÿåº§ï¼š{zodiac.get('sun_sign', '')}")
            features_text.append(f"- ä¸Šå‡æ˜Ÿåº§ï¼š{zodiac.get('rising_sign', '')}")

        if features_text:
            parts.append("\n## å‘½ç›˜ç‰¹å¾\n\n" + "\n".join(features_text))
```

---

### P2: å®æ—¶ç”»åƒåŒæ­¥ï¼ˆå¯é€‰ï¼‰

å¦‚æœ P1 çš„å®šæ—¶æŠ½å–å»¶è¿Ÿä»ä¸å¯æ¥å—ï¼š

```python
# lifecoach/tools/handlers.py ä¿®æ”¹

@tool_handler("write_lifecoach_state")
async def write_lifecoach_state(args, context):
    # ... ç°æœ‰å†™å…¥é€»è¾‘ ...

    # æ–°å¢ï¼šå…³é”®æ•°æ®å®æ—¶åŒæ­¥åˆ° vibe.target
    if section in ["north_star", "goals"]:
        await sync_to_vibe_target(user_uuid, section, data)
```

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `apps/api/routes/chat_v5.py` | æ–°å¢ `get_vibe_for_routing` å‡½æ•°ï¼ŒPhase 1 åŠ è½½å®Œæ•´ vibe.target |
| `apps/api/services/agent/prompt_builder.py` | æ–°å¢ `_build_routing_context` æ–¹æ³•ï¼ŒPhase 1 æ³¨å…¥ç”»åƒ |
| `apps/api/skills/bazi/tools/handlers.py` | `calculate_bazi` åè°ƒç”¨ `sync_chart_features_to_insight` |
| `apps/api/skills/zodiac/tools/handlers.py` | `calculate_zodiac` åè°ƒç”¨ `sync_chart_features_to_insight` |
| `apps/api/services/agent/chart_sync.py` | **æ–°å»º**ï¼š`sync_chart_features_to_insight` å‡½æ•° |
| `apps/api/stores/unified_profile_repo.py` | ç¡®è®¤ `update_vibe_insight` æ–¹æ³•å­˜åœ¨ |

---

## éªŒè¯æ–¹æ¡ˆ

### 1. Phase 1 ä¸ªæ€§åŒ–è·¯ç”±æµ‹è¯•

**å‡†å¤‡**ï¼š
```sql
-- è®¾ç½®æµ‹è¯•ç”¨æˆ·çš„ vibe.target
UPDATE unified_profiles
SET profile = jsonb_set(
  profile,
  '{vibe,target}',
  '{"focus": {"primary": "career", "heat_map": {"career": 0.8, "health": 0.3}}, "goals": [{"title": "æ‰¾åˆ°ç†æƒ³å·¥ä½œ", "status": "in_progress"}]}'
)
WHERE user_id = 'test-user-id';
```

**æµ‹è¯•**ï¼š
```bash
# å‘é€æ¨¡ç³Šæ¶ˆæ¯
curl -X POST /api/v1/chat/v5/stream \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"message": "å¸®æˆ‘çœ‹çœ‹"}'

# æœŸæœ›ï¼šLLM è°ƒç”¨ activate_skill(skill="career") æˆ– recommend_skills ä¸­åŒ…å« career
```

### 2. å‘½ç›˜ç‰¹å¾åŒæ­¥æµ‹è¯•

**æµ‹è¯•**ï¼š
```bash
# 1. è®¡ç®—å…«å­—
curl -X POST /api/v1/chat/v5/stream \
  -d '{"message": "å¸®æˆ‘æ’ä¸€ä¸‹å…«å­—", "skill": "bazi"}'

# 2. éªŒè¯ vibe.insight
SELECT profile->'vibe'->'insight'->'essence'->'chart_features'
FROM unified_profiles WHERE user_id = 'test-user-id';

# æœŸæœ›ï¼š{"bazi": {"day_master": {...}, "_synced_at": "..."}}
```

### 3. å‘½ç›˜èåˆå»ºè®®æµ‹è¯•

**æµ‹è¯•**ï¼š
```bash
# åˆ‡æ¢åˆ° lifecoach
curl -X POST /api/v1/chat/v5/stream \
  -d '{"message": "ç»™æˆ‘ä¸€äº›èŒä¸šå»ºè®®", "skill": "lifecoach"}'

# æœŸæœ›ï¼šLLM çš„å›å¤ä¸­ä½“ç°å‘½ç›˜ç‰¹å¾ï¼Œå¦‚"ä½œä¸ºç”²æœ¨æ—¥ä¸»ï¼Œä½ é€‚åˆ..."
```

### 4. ç«¯åˆ°ç«¯æµ‹è¯•è„šæœ¬

```python
# apps/api/scripts/test_phase1_personalization.py

async def test_phase1_routing():
    """æµ‹è¯• Phase 1 ä¸ªæ€§åŒ–è·¯ç”±"""

    # 1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·å¹¶è®¾ç½® vibe.target
    user_id = await create_test_user()
    await set_user_vibe_target(user_id, {
        "focus": {"primary": "career"},
        "goals": [{"title": "è½¬è¡Œ", "status": "in_progress"}]
    })

    # 2. å‘é€æ¨¡ç³Šæ¶ˆæ¯
    response = await send_chat_message(user_id, "æœ€è¿‘æœ‰ç‚¹è¿·èŒ«")

    # 3. éªŒè¯è·¯ç”±ç»“æœ
    assert "career" in response.activated_skill or "lifecoach" in response.activated_skill

    # 4. è®¡ç®—å‘½ç›˜
    await send_chat_message(user_id, "å¸®æˆ‘æ’å…«å­—", skill="bazi")

    # 5. éªŒè¯ chart_features åŒæ­¥
    profile = await get_user_profile(user_id)
    assert profile["vibe"]["insight"]["essence"]["chart_features"]["bazi"] is not None

    # 6. æµ‹è¯•èåˆå»ºè®®
    response = await send_chat_message(user_id, "ç»™æˆ‘èŒä¸šå»ºè®®", skill="lifecoach")
    assert "æ—¥ä¸»" in response.content or "å…«å­—" in response.content

    print("âœ… Phase 1 personalization test passed!")
```

---

## æœªè§£å†³é—®é¢˜ï¼ˆå®æ–½æ—¶ç¡®è®¤ï¼‰

1. ~~Phase 1 ç”»åƒ token æˆæœ¬~~ â†’ å·²ç¡®è®¤ ~200 tokens å¯æ¥å—
2. ~~å‘½ç›˜ç‰¹å¾å†™å…¥æ—¶æœº~~ â†’ å·²ç¡®è®¤ç«‹å³å†™å…¥
3. `sync_chart_features_to_insight` æ˜¯å¦éœ€è¦äº‹åŠ¡ä¿æŠ¤ï¼Ÿï¼ˆåŒæ—¶å†™å…¥ insight å’Œ skills æ—¶ï¼‰
4. æ˜¯å¦éœ€è¦åœ¨ routing.yaml ä¸­é…ç½®"åŸºäºç”»åƒçš„è·¯ç”±è§„åˆ™"ï¼Ÿ
