/**
 * Divine Skills (玄学技能)
 *
 * Tools for metaphysics calculations: Bazi, Tieban, Yunshi, etc.
 * These tools call FastAPI backend for actual computation.
 *
 * Note: These tools run on Next.js server-side, so they can access
 * internal APIs with service token and forward user cookies.
 */
import { tool } from 'ai';
import { z } from 'zod';

const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';
const INTERNAL_SERVICE_TOKEN = process.env.FORTUNE_INTERNAL_SERVICE_TOKEN || '';

// API response wrapper type
interface ApiResponse<T> {
  ok: boolean;
  data?: T;
  error?: { code: string; message: string };
}

// Build headers for authenticated API calls
function buildAuthHeaders(sessionCookie: string): Record<string, string> {
  const headers: Record<string, string> = {
    'Content-Type': 'application/json',
    Cookie: `fortune_session=${sessionCookie}`,
  };
  if (INTERNAL_SERVICE_TOKEN) {
    headers['X-Service-Token'] = INTERNAL_SERVICE_TOKEN;
  }
  return headers;
}

// ============================================================================
// Tool Factory: Creates tools with user context (cookie)
// ============================================================================

export interface SkillContext {
  sessionCookie: string;
}

/**
 * Create divine skills with user context.
 * This allows tools to make authenticated API calls.
 */
export function createDivineSkills(ctx: SkillContext) {
  const authHeaders = buildAuthHeaders(ctx.sessionCookie);

  return {
    // Bazi calculation tool (no auth required)
    calculate_bazi: tool({
      description: '计算用户的八字命盘（四柱八字）。当用户询问八字、命理、生辰相关问题时使用。',
      parameters: z.object({
        birth_datetime: z.string().describe('出生日期时间，格式：YYYY-MM-DD HH:MM'),
        location_name: z.string().optional().describe('出生地点名称'),
        longitude: z.number().optional().describe('出生地经度'),
        latitude: z.number().optional().describe('出生地纬度'),
      }),
      execute: async ({ birth_datetime, location_name, longitude, latitude }, { abortSignal }) => {
        // Parse datetime
        const [date, time] = birth_datetime.split(' ');
        if (!date || !time) {
          return {
            type: 'a2ui_card' as const,
            card_type: 'error',
            data: { message: '日期时间格式错误，请使用 YYYY-MM-DD HH:MM 格式' },
          };
        }

        const [year, month, day] = date.split('-').map(Number);
        const [hour, minute] = time.split(':').map(Number);

        try {
          const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              year,
              month,
              day,
              hour,
              minute,
              location_name,
              longitude,
              latitude,
            }),
            signal: abortSignal,
          });

          if (!res.ok) {
            throw new Error(`Bazi calculation failed: ${res.status}`);
          }

          const json: ApiResponse<Record<string, unknown>> = await res.json();
          if (!json.ok || !json.data) {
            throw new Error(json.error?.message || 'Unknown error');
          }

          const result = json.data;

          return {
            type: 'a2ui_card' as const,
            card_type: 'bazi_pan',
            data: {
              birth_datetime,
              solar_date: `${year}年${month}月${day}日`,
              lunar_date: (result.lunar_date as string) || '',
              four_pillars: {
                year: { gan: result.year_gan, zhi: result.year_zhi },
                month: { gan: result.month_gan, zhi: result.month_zhi },
                day: { gan: result.day_gan, zhi: result.day_zhi },
                hour: { gan: result.hour_gan, zhi: result.hour_zhi },
              },
              wu_xing_summary: (result.wuxing as string) || '',
              day_master: result.day_master || result.day_gan,
              day_master_strength: (result.day_master_strength as string) || 'balanced',
            },
          };
        } catch (error) {
          return {
            type: 'a2ui_card' as const,
            card_type: 'error',
            data: { message: `八字计算失败: ${error instanceof Error ? error.message : '未知错误'}` },
          };
        }
      },
    }),

    // Yunshi (daily fortune) tool - requires auth
    get_yunshi: tool({
      description: '获取用户的每日运势。当用户询问今日运势、今天运气、当日运程时使用。',
      parameters: z.object({
        date: z.string().optional().describe('查询日期，格式：YYYY-MM-DD，默认今天'),
      }),
      execute: async ({ date }, { abortSignal }) => {
        const targetDate = date || new Date().toISOString().split('T')[0];

        try {
          // Use authenticated endpoint with user cookie
          const res = await fetch(
            `${FASTAPI_URL}/api/yunshi/daily?target_date=${targetDate}&include_a2ui=true`,
            {
              headers: authHeaders,
              signal: abortSignal,
            }
          );

          if (!res.ok) {
            if (res.status === 401) {
              throw new Error('需要登录才能查看运势');
            }
            throw new Error(`Yunshi fetch failed: ${res.status}`);
          }

          const json: ApiResponse<Record<string, unknown>> = await res.json();
          if (!json.ok || !json.data) {
            throw new Error(json.error?.message || 'Unknown error');
          }

          const result = json.data;

          return {
            type: 'a2ui_card' as const,
            card_type: 'yunshi_daily',
            data: {
              date: targetDate,
              day_ganzhi: result.day_ganzhi || '',
              summary: result.summary || '',
              score: result.score || 0,
              highlights: result.highlights || [],
              risks: result.risks || [],
              prescriptions: result.prescriptions || [],
            },
          };
        } catch (error) {
          return {
            type: 'a2ui_card' as const,
            card_type: 'error',
            data: { message: `运势获取失败: ${error instanceof Error ? error.message : '未知错误'}` },
          };
        }
      },
    }),

    // Tieban (Iron Plate) divination tool - requires auth
    init_tieban: tool({
      description: '启动铁板神数推演。当用户想要进行精确的命理推算或验证生辰时使用。',
      parameters: z.object({
        birth_datetime: z.string().describe('出生日期时间，格式：YYYY-MM-DD HH:MM'),
        gender: z.enum(['male', 'female']).describe('性别'),
        name: z.string().describe('用户姓名'),
      }),
      execute: async ({ birth_datetime, gender, name }, { abortSignal }) => {
        const [date, time] = birth_datetime.split(' ');
        if (!date || !time) {
          return {
            type: 'a2ui_card' as const,
            card_type: 'error',
            data: { message: '日期时间格式错误' },
          };
        }

        try {
          // Note: tieban endpoint may not exist yet, gracefully handle 404
          const res = await fetch(`${FASTAPI_URL}/api/tieban/init`, {
            method: 'POST',
            headers: authHeaders,
            body: JSON.stringify({
              name,
              gender,
              date,
              time,
            }),
            signal: abortSignal,
          });

          if (res.status === 404) {
            return {
              type: 'a2ui_card' as const,
              card_type: 'error',
              data: { message: '铁板神数功能即将上线，敬请期待' },
            };
          }

          if (!res.ok) {
            throw new Error(`Tieban init failed: ${res.status}`);
          }

          const json: ApiResponse<Record<string, unknown>> = await res.json();
          if (!json.ok || !json.data) {
            throw new Error(json.error?.message || 'Unknown error');
          }

          const result = json.data;

          return {
            type: 'a2ui_card' as const,
            card_type: 'tieban_init',
            data: {
              run_id: result.run_id,
              status: result.status,
              questions: result.questions || [],
              message: '铁板神数推演已启动，请回答验证问题以确认生辰。',
            },
            actions: [
              {
                label: '开始验证',
                action: 'navigate',
                params: { path: `/tieban/${result.run_id}` },
              },
            ],
          };
        } catch (error) {
          return {
            type: 'a2ui_card' as const,
            card_type: 'error',
            data: { message: `铁板推演启动失败: ${error instanceof Error ? error.message : '未知错误'}` },
          };
        }
      },
    }),
  };
}

// ============================================================================
// Static exports for backward compatibility (no auth context)
// ============================================================================

// These are placeholder tools that will return auth errors when called without context
export const divineSkills = createDivineSkills({ sessionCookie: '' });
export const calculateBazi = divineSkills.calculate_bazi;
export const getYunshi = divineSkills.get_yunshi;
export const initTieban = divineSkills.init_tieban;
