"""
Guest Session Service - Business logic for guest session management

v3.0 更新：
- 使用 UnifiedProfileRepository 统一 Profile 数据
- 使用 OnboardingDataRepository 保存 Onboarding 数据
"""
from datetime import datetime
from typing import Optional
from uuid import UUID

from stores.guest_session_repo import GuestSessionRepository
from stores.user_repo import UserRepository
from stores.unified_profile_repo import UnifiedProfileRepository
from stores.onboarding_data_repo import OnboardingDataRepository


class GuestSessionService:
    """Service for managing guest sessions and onboarding data"""

    @classmethod
    async def create_session(cls) -> dict:
        """Create a new guest session"""
        return await GuestSessionRepository.create()

    @classmethod
    async def get_session(cls, session_id: str) -> Optional[dict]:
        """Get a valid guest session"""
        return await GuestSessionRepository.get_by_session_id(session_id)

    @classmethod
    async def save_onboarding_data(
        cls,
        session_id: str,
        birth_datetime: Optional[datetime] = None,
        birth_location: Optional[str] = None,
        gender: Optional[str] = None,
        voice_mode: Optional[str] = None,
        skill: Optional[str] = None,
        interview_responses: Optional[dict] = None,
        focus_areas: Optional[list] = None
    ) -> Optional[dict]:
        """Save onboarding data to a guest session"""
        return await GuestSessionRepository.update_onboarding_data(
            session_id=session_id,
            birth_datetime=birth_datetime,
            birth_location=birth_location,
            gender=gender,
            voice_mode=voice_mode,
            skill=skill,
            interview_responses=interview_responses,
            focus_areas=focus_areas
        )

    @classmethod
    async def link_to_user(cls, session_id: str, user_id: UUID) -> bool:
        """
        Link guest session data to a registered user.
        Called during registration to transfer onboarding data.

        v3.0 更新：
        - 使用 UnifiedProfileRepository 统一存储 birth_info
        - 使用 OnboardingDataRepository 保存 interview_responses 和 focus_areas
        """
        session = await GuestSessionRepository.get_by_session_id(session_id)
        if not session:
            return False

        # 1. 构建 birth_info (统一格式)
        birth_info = {}
        if session.get("birth_datetime"):
            dt = session["birth_datetime"]
            if hasattr(dt, 'date'):
                birth_info["date"] = dt.date().isoformat()
                birth_info["time"] = dt.time().isoformat()
            else:
                # 如果是字符串
                birth_info["date"] = str(dt)[:10] if dt else None

        if session.get("birth_location"):
            birth_info["place"] = session["birth_location"]
        if session.get("gender"):
            birth_info["gender"] = session["gender"]
        birth_info["timezone"] = "Asia/Shanghai"

        # 2. 更新 unified_profiles (统一 Profile)
        profile_updates = {}
        if birth_info:
            profile_updates["birth_info"] = birth_info
        if session.get("voice_mode"):
            profile_updates["preferences"] = {
                "voice_mode": session["voice_mode"]
            }

        if profile_updates:
            await UnifiedProfileRepository.update_profile(user_id, profile_updates)

        # 3. 保存 Onboarding 数据到独立表 (永久保留)
        interview_responses = session.get("interview_responses") or {}
        focus_areas = session.get("focus_areas") or []

        if interview_responses or focus_areas:
            await OnboardingDataRepository.create(
                user_id=user_id,
                session_id=session_id,
                interview_responses=interview_responses,
                focus_areas=focus_areas,
                skill=session.get("skill")
            )

        # 4. 更新业务字段 (trigger auto-syncs to unified_profiles)
        update_data = {}
        if session.get("birth_datetime"):
            update_data["birth_datetime"] = session["birth_datetime"]
        if session.get("birth_location"):
            update_data["birth_location"] = session["birth_location"]
        if session.get("gender"):
            update_data["gender"] = session["gender"]

        if update_data:
            await UserRepository.update(user_id, **update_data)
            # Trigger automatically syncs to unified_profiles

        # 5. 标记 session 已转化
        await GuestSessionRepository.mark_converted(session_id, user_id)
        return True
