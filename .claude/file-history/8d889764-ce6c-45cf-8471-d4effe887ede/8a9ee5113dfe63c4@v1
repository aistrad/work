# Onboarding 架构设计

## 体系结构

```
┌─────────────────────────────────────────────────────────┐
│                  onboarding (协调者)                     │
│  - 流程状态机  - 心理学原则  - 共享 UI 组件              │
└─────────────────────────┬───────────────────────────────┘
                          │
        ┌─────────────────┼─────────────────┐
        ▼                 ▼                 ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│onboarding.bazi│ │onboarding.    │ │onboarding.    │
│               │ │zodiac         │ │dankoe         │
│ 洞察: 格局+   │ │ 洞察: 三星+   │ │ 洞察: 痛点+   │
│   五行+运势   │ │   相位        │ │   愿景        │
└───────┬───────┘ └───────┬───────┘ └───────┬───────┘
        │                 │                 │
        ▼                 ▼                 ▼
┌───────────────┐ ┌───────────────┐ ┌───────────────┐
│  bazi skill   │ │ zodiac skill  │ │lifecoach skill│
└───────────────┘ └───────────────┘ └───────────────┘
```

## 流程状态机

```
landing → loading → insights → feedback → guidance → conversation → promise
```

| 状态 | 说明 | 心理学原则 |
|-----|------|-----------|
| landing | 收集信息 | Activation Energy |
| loading | 计算/准备 | Goal-Gradient |
| insights | 展示洞察 | Reciprocity |
| feedback | 收集反馈 | IKEA Effect |
| guidance | 引导选择 | Commitment |
| conversation | 深入对话 | - |
| promise | 结束承诺 | Zeigarnik + Peak-End |

## 文件结构

```
apps/api/skills/onboarding/
├── SKILL.md                 # 主定义
├── variants.yaml            # 变体配置
├── tools/
│   ├── tools.yaml
│   └── handlers.py
└── rules/
    ├── insights/
    │   ├── bazi.md
    │   ├── zodiac.md
    │   ├── jungastro.md
    │   └── dankoe.md
    ├── feedback-handling.md
    └── promise-ending.md

apps/web/src/app/onboarding/
├── page.tsx                 # 接收 variant 参数
├── context.tsx              # 状态管理
└── steps/
    ├── LandingStep.tsx
    ├── LoadingStep.tsx
    └── ChatStep.tsx

apps/web/src/skills/onboarding/cards/
├── InsightsCard.tsx
├── GuidanceCard.tsx
└── ReminderCard.tsx
```

## 数据流

```
1. 前端 /onboarding?variant=bazi
   ↓
2. 加载变体配置 GET /api/v1/onboarding/variant/bazi
   ↓
3. LandingStep 收集生日
   ↓
4. LoadingStep 调用 bazi/zodiac 计算
   ↓
5. 跳转 /chat，onboarding skill 自动激活
   ↓
6. generate_insights 根据变体规则生成洞察
   ↓
7. 展示 InsightsCard → 收集反馈
   ↓
8. 展示 GuidanceCard → 激活目标 Skill
   ↓
9. 对话结束 → 展示 ReminderCard → 设置提醒
```
