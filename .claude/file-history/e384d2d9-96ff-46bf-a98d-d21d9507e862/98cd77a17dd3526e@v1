'use client'

/**
 * PCLayout - v7.1 PCç«¯ä¸‰æ å¸ƒå±€å®¹å™¨
 *
 * å¸ƒå±€ç»“æ„ (â‰¥1024px):
 * â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚      â”‚           é¡¶éƒ¨æ                â”‚          â”‚
 * â”‚ å·¦ä¾§ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ å¯¼èˆª â”‚           ä¸»å†…å®¹åŒº             â”‚  å³ä¾§æ   â”‚
 * â”‚240px â”‚           flex: 1              â”‚  320px   â”‚
 * â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚      â”‚           åº•éƒ¨å‘½ä»¤æ                       â”‚
 * â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * v7.1 ä¼˜åŒ–:
 * - ä½¿ç”¨ CSS transition æ›¿ä»£ Framer Motion (Vercel rule: rerender-animation-library)
 * - æ— è¾¹æ¡†è®¾è®¡ + å¤šå±‚é˜´å½±
 * - memo åŒ…è£… (Vercel rule: rerender-memo)
 */

import { useState, useEffect, useCallback, ReactNode, memo } from 'react'
import { useRouter, usePathname } from 'next/navigation'
import { cn } from '@/lib/utils'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Navigation Config - v7 æ¶æ„ï¼šæ‰€æœ‰æŠ€èƒ½é€šè¿‡ /chat è®¿é—®
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const NAV_ITEMS = [
  { id: 'home', path: '/', icon: 'ğŸ ', label: 'é¦–é¡µ' },
  { id: 'chat', path: '/chat', icon: 'ğŸ’¬', label: 'å¯¹è¯' },
  { id: 'discover', path: '/chat?tab=discover', icon: 'âœ¨', label: 'æ¢ç´¢' },
  { id: 'identity', path: '/identity', icon: 'ğŸ’', label: 'èº«ä»½ç”»åƒ' },
]

const BOTTOM_NAV_ITEMS = [
  { id: 'settings', path: '/settings', icon: 'âš™ï¸', label: 'è®¾ç½®' },
  { id: 'membership', path: '/membership', icon: 'âœ¨', label: 'å‡çº§Premium', premium: true },
]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Storage helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getStorageValue(key: string): string | null {
  if (typeof window === 'undefined') return null
  try {
    return localStorage.getItem(key)
  } catch {
    return null
  }
}

function setStorageValue(key: string, value: string): void {
  if (typeof window === 'undefined') return
  try {
    localStorage.setItem(key, value)
  } catch {
    // ignore
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PCLayout Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface PCLayoutProps {
  children: ReactNode
  aside?: ReactNode
  breadcrumb?: { label: string; href?: string }[]
  showCommandBar?: boolean
}

export const PCLayout = memo(function PCLayout({
  children,
  aside,
  breadcrumb,
  showCommandBar = true,
}: PCLayoutProps) {
  const router = useRouter()
  const pathname = usePathname()
  const [collapsed, setCollapsed] = useState(false)
  const [commandInput, setCommandInput] = useState('')

  // ä» localStorage æ¢å¤ä¾§è¾¹æ çŠ¶æ€
  useEffect(() => {
    const saved = getStorageValue('pc-sidebar-collapsed')
    if (saved) setCollapsed(saved === 'true')
  }, [])

  const toggleSidebar = useCallback(() => {
    setCollapsed(prev => {
      const newState = !prev
      setStorageValue('pc-sidebar-collapsed', String(newState))
      return newState
    })
  }, [])

  const handleCommand = useCallback(() => {
    if (commandInput.startsWith('/')) {
      const cmd = commandInput.slice(1).toLowerCase()
      if (['bazi', 'zodiac', 'tarot', 'career'].includes(cmd)) {
        router.push(`/chat?skill=${cmd}`)
      } else if (cmd === 'chat') {
        router.push('/chat')
      } else if (cmd === 'upgrade') {
        router.push('/membership')
      }
    } else if (commandInput.trim()) {
      router.push(`/chat?q=${encodeURIComponent(commandInput)}`)
    }
    setCommandInput('')
  }, [commandInput, router])

  const handleNavClick = useCallback((path: string) => {
    router.push(path)
  }, [router])

  // è®¡ç®—å¸ƒå±€å°ºå¯¸
  const sidebarWidth = collapsed ? 72 : 240

  return (
    <div className="hidden lg:block min-h-screen bg-bg-primary">
      {/* å·¦ä¾§å¯¼èˆªæ  - v7.1 æ— è¾¹æ¡†è®¾è®¡ */}
      <aside
        className={cn(
          "fixed left-0 top-0 bottom-0 z-30",
          "bg-bg-card shadow-card",
          "flex flex-col",
          "transition-[width] duration-slow ease-out-expo"
        )}
        style={{ width: sidebarWidth }}
      >
        {/* Logo */}
        <div className="h-16 px-4 flex items-center gap-3 border-b border-subtle/30">
          <span className="text-2xl flex-shrink-0">ğŸŒŸ</span>
          <div
            className={cn(
              "overflow-hidden whitespace-nowrap",
              "transition-all duration-slow ease-out-expo",
              collapsed ? "w-0 opacity-0" : "w-auto opacity-100"
            )}
          >
            <h1 className="font-serif text-lg text-text-primary font-semibold">VibeLife</h1>
            <p className="text-xs text-text-secondary">æ¢ç´¢å†…å¿ƒä¸–ç•Œ</p>
          </div>
        </div>

        {/* ä¸»å¯¼èˆª */}
        <nav className="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
          {NAV_ITEMS.map((item) => {
            const isActive = pathname === item.path
            return (
              <button
                key={item.id}
                onClick={() => handleNavClick(item.path)}
                className={cn(
                  "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg",
                  "text-left transition-all duration-fast ease-out-expo",
                  isActive
                    ? "bg-accent-primary/10 text-text-primary font-medium"
                    : "text-text-secondary hover:bg-bg-secondary hover:text-text-primary"
                )}
                title={collapsed ? item.label : undefined}
              >
                <span className="text-lg flex-shrink-0">{item.icon}</span>
                <span
                  className={cn(
                    "overflow-hidden whitespace-nowrap",
                    "transition-all duration-slow ease-out-expo",
                    collapsed ? "w-0 opacity-0" : "w-auto opacity-100"
                  )}
                >
                  {item.label}
                </span>
              </button>
            )
          })}
        </nav>

        {/* åº•éƒ¨å¯¼èˆª */}
        <div className="px-3 py-4 border-t border-subtle/30 space-y-1">
          {BOTTOM_NAV_ITEMS.map((item) => {
            const isActive = pathname === item.path
            return (
              <button
                key={item.id}
                onClick={() => handleNavClick(item.path)}
                className={cn(
                  "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg",
                  "text-left transition-all duration-fast ease-out-expo",
                  isActive
                    ? "bg-accent-primary/10 text-text-primary font-medium"
                    : "text-text-secondary hover:bg-bg-secondary hover:text-text-primary",
                  item.premium && "text-gold-600"
                )}
                title={collapsed ? item.label : undefined}
              >
                <span className="text-lg flex-shrink-0">{item.icon}</span>
                <span
                  className={cn(
                    "overflow-hidden whitespace-nowrap",
                    "transition-all duration-slow ease-out-expo",
                    collapsed ? "w-0 opacity-0" : "w-auto opacity-100",
                    item.premium && "font-medium"
                  )}
                >
                  {item.label}
                </span>
              </button>
            )
          })}

          {/* æ”¶èµ·/å±•å¼€æŒ‰é’® */}
          <button
            onClick={toggleSidebar}
            className={cn(
              "w-full flex items-center justify-center",
              "p-2.5 mt-2 rounded-lg",
              "text-text-tertiary hover:text-text-primary hover:bg-bg-secondary",
              "transition-colors duration-fast"
            )}
          >
            <span className="text-lg">{collapsed ? 'â–¶' : 'â—€'}</span>
          </button>
        </div>
      </aside>

      {/* é¡¶éƒ¨æ  - v7.1 æ¯›ç»ç’ƒæ•ˆæœ */}
      <header
        className={cn(
          "fixed top-0 right-0 z-20",
          "h-14 px-5 flex items-center justify-between",
          "bg-bg-primary/80 backdrop-blur-md",
          "border-b border-subtle/30",
          "transition-[left] duration-slow ease-out-expo"
        )}
        style={{ left: sidebarWidth }}
      >
        {/* Breadcrumb */}
        <div className="flex items-center gap-2 text-sm">
          {breadcrumb?.map((item, i) => (
            <span key={i} className="flex items-center gap-2">
              {i > 0 && <span className="text-text-disabled">â€º</span>}
              {item.href ? (
                <button
                  onClick={() => router.push(item.href!)}
                  className="text-text-secondary hover:text-text-primary transition-colors"
                >
                  {item.label}
                </button>
              ) : (
                <span className="text-text-primary font-medium">{item.label}</span>
              )}
            </span>
          ))}
        </div>

        {/* Actions */}
        <div className="flex items-center gap-2">
          <button className="p-2 rounded-lg text-text-secondary hover:text-text-primary hover:bg-bg-secondary transition-colors">
            ğŸ”
          </button>
          <button className="p-2 rounded-lg text-text-secondary hover:text-text-primary hover:bg-bg-secondary transition-colors relative">
            ğŸ””
            <span className="absolute -top-0.5 -right-0.5 w-4 h-4 bg-error text-white text-[10px] rounded-full flex items-center justify-center">
              3
            </span>
          </button>
          <button className="p-2 rounded-lg text-text-secondary hover:text-text-primary hover:bg-bg-secondary transition-colors">
            ğŸ‘¤
          </button>
        </div>
      </header>

      {/* ä¸»å†…å®¹åŒº */}
      <main
        className={cn(
          "pt-14 min-h-screen",
          "transition-[margin-left,margin-bottom] duration-slow ease-out-expo",
          showCommandBar && "pb-16"
        )}
        style={{ marginLeft: sidebarWidth }}
      >
        <div className="flex h-[calc(100vh-56px-64px)]">
          {/* ä¸»å†…å®¹ */}
          <div className="flex-1 overflow-y-auto p-6">
            {children}
          </div>

          {/* å³ä¾§æ  */}
          {aside && (
            <aside className="w-80 xl:w-96 border-l border-subtle/30 bg-bg-card/50 overflow-y-auto p-4">
              {aside}
            </aside>
          )}
        </div>
      </main>

      {/* åº•éƒ¨å‘½ä»¤æ  - v7.1 æ ·å¼ */}
      {showCommandBar && (
        <div
          className={cn(
            "fixed bottom-0 right-0 z-20",
            "h-16 px-5 flex items-center justify-center",
            "bg-bg-primary border-t border-subtle/30",
            "transition-[left] duration-slow ease-out-expo"
          )}
          style={{ left: sidebarWidth }}
        >
          <div className="w-full max-w-2xl">
            <div className="flex items-center gap-3 bg-bg-card shadow-card rounded-2xl px-4 py-2">
              <input
                type="text"
                value={commandInput}
                onChange={(e) => setCommandInput(e.target.value)}
                onKeyDown={(e) => e.key === 'Enter' && handleCommand()}
                placeholder="Type '/' for commands, or start chatting..."
                className="flex-1 bg-transparent text-text-primary placeholder:text-text-disabled focus:outline-none"
              />
              <button
                onClick={handleCommand}
                className={cn(
                  "w-9 h-9 rounded-full flex items-center justify-center",
                  "bg-accent-primary text-text-inverse",
                  "hover:bg-accent-hover transition-colors duration-fast",
                  "active:scale-95"
                )}
              >
                â–¶
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
})

export default PCLayout
