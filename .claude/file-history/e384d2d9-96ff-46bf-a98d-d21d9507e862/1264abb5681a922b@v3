'use client';

/**
 * Discover Content - App Store 风格的 Skill 探索页面
 *
 * 在 AppShell 的 discover tab 中显示
 * 参考 Apple App Store 的设计理念
 */

import React, { useMemo } from 'react';
import { useRouter } from 'next/navigation';
import { FeaturedSkillBanner } from './FeaturedSkillBanner';
import { CategorySection } from './CategorySection';
import { SkillShowcaseCard } from './SkillShowcaseCard';
import { useSkills, useSkillSubscription, useSkillRecommendations } from '@/hooks/useSkillSubscription';
import { useAuth } from '@/providers/AuthProvider';
import type { SkillMetadata } from '@/types/skill';

export function DiscoverContent() {
  const router = useRouter();
  const { user } = useAuth();
  const { skills, categories, isLoading: skillsLoading } = useSkills();
  const {
    userStatuses,
    subscribe,
    unsubscribe,
    isLoading: subscriptionsLoading,
  } = useSkillSubscription();
  const { recommendations } = useSkillRecommendations({ limit: 3 });

  const isLoading = skillsLoading || subscriptionsLoading;

  // 按分类分组 Skills
  const skillsByCategory = useMemo(() => {
    const grouped: Record<string, SkillMetadata[]> = {
      professional: [],
      default: [],
      core: [],
    };

    for (const skill of skills) {
      if (grouped[skill.category]) {
        grouped[skill.category].push(skill);
      }
    }

    return grouped;
  }, [skills]);

  // 精选 Skill (选择最有特色的)
  const featuredSkill = useMemo(() => {
    // 优先选择 professional 分类的第一个
    return skillsByCategory.professional[0] || skillsByCategory.default[0] || skills[0];
  }, [skillsByCategory, skills]);

  // 推荐 Skills
  const recommendedSkills = useMemo(() => {
    const recommendedIds = new Set(recommendations.map(r => r.skill_id));
    return skills.filter(s => recommendedIds.has(s.id));
  }, [skills, recommendations]);

  // 处理订阅
  const handleSubscribe = async (skillId: string) => {
    if (!user) {
      router.push('/auth/login?redirect=/chat');
      return;
    }
    try {
      await subscribe(skillId);
    } catch (error: any) {
      // 处理 Premium 要求错误 (402)
      if (error?.response?.status === 402) {
        const detail = error.response.data?.detail;
        if (detail?.code === 'PREMIUM_REQUIRED') {
          router.push(`/membership?reason=skill_subscribe&skill=${skillId}`);
          return;
        }
      }
      console.error('Subscribe failed:', error);
    }
  };

  // 处理取消订阅
  const handleUnsubscribe = async (skillId: string) => {
    if (!user) return;
    try {
      await unsubscribe(skillId);
    } catch (error) {
      console.error('Unsubscribe failed:', error);
    }
  };

  // 处理点击 Skill
  const handleSkillClick = (skillId: string) => {
    router.push(`/skills/${skillId}`);
  };

  // Loading 状态
  if (isLoading) {
    return (
      <div className="h-full overflow-y-auto bg-bg-primary">
        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8 space-y-8">
          {/* Featured 骨架屏 */}
          <div className="h-[400px] lg:h-[480px] rounded-3xl bg-bg-secondary animate-pulse" />

          {/* Section 骨架屏 */}
          {[1, 2, 3].map((i) => (
            <div key={i} className="space-y-4">
              <div className="h-8 w-48 bg-bg-secondary animate-pulse rounded-lg" />
              <div className="flex gap-4 overflow-hidden">
                {[1, 2, 3].map((j) => (
                  <div key={j} className="w-80 h-64 bg-bg-secondary animate-pulse rounded-2xl flex-shrink-0" />
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="h-full overflow-y-auto bg-bg-primary">
      <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8 space-y-12">
        {/* 精选横幅 */}
        {featuredSkill && (
          <FeaturedSkillBanner
            skill={featuredSkill}
            campaign={{
              title: '精选推荐',
              subtitle: '开启你的自我探索之旅',
              badge: '编辑推荐',
            }}
            onClick={() => handleSkillClick(featuredSkill.id)}
          />
        )}

        {/* 为你推荐 */}
        {recommendedSkills.length > 0 && (
          <CategorySection
            title="为你推荐"
            subtitle="基于你的使用习惯智能推荐"
            skills={recommendedSkills}
            userStatuses={userStatuses}
            onSkillClick={handleSkillClick}
            onSubscribe={handleSubscribe}
          />
        )}

        {/* 专业技能 */}
        {skillsByCategory.professional.length > 0 && (
          <CategorySection
            title="专业技能"
            subtitle="深度探索，专业洞察"
            skills={skillsByCategory.professional}
            userStatuses={userStatuses}
            onSkillClick={handleSkillClick}
            onSubscribe={handleSubscribe}
          />
        )}

        {/* 基础功能 */}
        {skillsByCategory.default.length > 0 && (
          <CategorySection
            title="基础功能"
            subtitle="人人可用的实用工具"
            skills={skillsByCategory.default}
            userStatuses={userStatuses}
            onSkillClick={handleSkillClick}
            onSubscribe={handleSubscribe}
          />
        )}

        {/* 核心能力 */}
        {skillsByCategory.core.length > 0 && (
          <CategorySection
            title="核心能力"
            subtitle="始终激活，助你成长"
            skills={skillsByCategory.core}
            userStatuses={userStatuses}
            onSkillClick={handleSkillClick}
            onSubscribe={handleSubscribe}
          />
        )}

        {/* 底部空白 */}
        <div className="h-8" />
      </div>
    </div>
  );
}
