#!/usr/bin/env python3
"""
VibeID 用户分析报告生成脚本

调用完整服务链生成人格分析报告：
BaziCalculator → BaziAnalyzer → ZodiacAnalyzer → FusionEngine → Explainer

Usage:
    cd apps/api
    python scripts/generate_vibe_id_report.py \
        --birth-date 1980-02-11 \
        --birth-time 14:30 \
        --birth-place 北京 \
        --gender male \
        --output ../docs/prd/VibeID/sample_report.md
"""

import argparse
import asyncio
import sys
import os
from datetime import datetime
from pathlib import Path

# 添加项目路径
sys.path.insert(0, str(Path(__file__).parent.parent))

from skills.bazi.services.calculator import BaziCalculator
from services.astrology.calculator import AstrologyCalculator
from skills.vibe_id.services import VibeIDService
from skills.vibe_id.models import (
    get_archetype_info,
    get_archetype_cn_name,
    get_archetype_emoji,
    Archetype,
)


# 城市经纬度映射
CITY_COORDINATES = {
    "北京": (116.4074, 39.9042),
    "上海": (121.4737, 31.2304),
    "广州": (113.2644, 23.1291),
    "深圳": (114.0579, 22.5431),
    "杭州": (120.1551, 30.2741),
    "成都": (104.0657, 30.5723),
    "重庆": (106.5516, 29.5630),
    "西安": (108.9402, 34.3416),
    "南京": (118.7969, 32.0603),
    "武汉": (114.3055, 30.5928),
}


def get_city_coordinates(city: str) -> tuple:
    """获取城市经纬度"""
    return CITY_COORDINATES.get(city, CITY_COORDINATES["北京"])


def format_four_pillars(four_pillars: dict) -> str:
    """格式化四柱信息为表格"""
    lines = []
    lines.append("| 柱位 | 天干 | 地支 | 天干五行 | 地支藏干 |")
    lines.append("|------|------|------|----------|----------|")

    pillar_names = {"year": "年柱", "month": "月柱", "day": "日柱", "hour": "时柱"}

    for key in ["year", "month", "day", "hour"]:
        pillar = four_pillars.get(key, {})
        stem = pillar.get("stem", "-")
        branch = pillar.get("branch", "-")
        stem_element = pillar.get("stem_element", "-")
        hidden_stems = pillar.get("hidden_stems", [])
        hidden_str = "、".join(hidden_stems) if hidden_stems else "-"

        lines.append(f"| {pillar_names[key]} | {stem} | {branch} | {stem_element} | {hidden_str} |")

    return "\n".join(lines)


def format_five_elements(five_elements: dict) -> str:
    """格式化五行统计为表格"""
    lines = []
    lines.append("| 五行 | 数量 |")
    lines.append("|------|------|")

    element_names = {"wood": "木", "fire": "火", "earth": "土", "metal": "金", "water": "水"}

    for elem, name in element_names.items():
        count = five_elements.get(elem, 0)
        lines.append(f"| {name} | {count} |")

    return "\n".join(lines)


def format_ten_gods(ten_gods: list) -> str:
    """格式化十神关系"""
    if not ten_gods:
        return "无详细十神数据"

    lines = []
    lines.append("| 十神 | 天干 | 柱位 |")
    lines.append("|------|------|------|")

    pillar_names = {"year": "年柱", "month": "月柱", "day": "日柱", "hour": "时柱"}

    for god in ten_gods:
        name = god.get("name", "-")
        stem = god.get("stem", "-")
        pillar = pillar_names.get(god.get("pillar", ""), "-")
        lines.append(f"| {name} | {stem} | {pillar} |")

    return "\n".join(lines)


def format_planets(planets: list) -> str:
    """格式化行星信息为表格"""
    lines = []
    lines.append("| 行星 | 星座 | 度数 | 宫位 | 逆行 |")
    lines.append("|------|------|------|------|------|")

    planet_names = {
        "sun": "太阳", "moon": "月亮", "mercury": "水星",
        "venus": "金星", "mars": "火星", "jupiter": "木星",
        "saturn": "土星", "uranus": "天王星", "neptune": "海王星",
        "pluto": "冥王星"
    }

    sign_names = {
        "ari": "白羊座", "tau": "金牛座", "gem": "双子座",
        "can": "巨蟹座", "leo": "狮子座", "vir": "处女座",
        "lib": "天秤座", "sco": "天蝎座", "sag": "射手座",
        "cap": "摩羯座", "aqu": "水瓶座", "pis": "双鱼座"
    }

    for planet in planets:
        name = planet.get("name", "").lower()
        cn_name = planet_names.get(name, name)
        sign = planet.get("sign", "").lower()[:3]
        cn_sign = sign_names.get(sign, planet.get("sign", "-"))
        position = planet.get("position", 0)
        house = planet.get("house", "-")
        retrograde = "是" if planet.get("retrograde") else "否"
        lines.append(f"| {cn_name} | {cn_sign} | {position:.2f}° | {house} | {retrograde} |")

    return "\n".join(lines)


def format_houses(houses: list) -> str:
    """格式化宫位信息"""
    lines = []
    lines.append("| 宫位 | 星座 | 度数 |")
    lines.append("|------|------|------|")

    sign_names = {
        "ari": "白羊座", "tau": "金牛座", "gem": "双子座",
        "can": "巨蟹座", "leo": "狮子座", "vir": "处女座",
        "lib": "天秤座", "sco": "天蝎座", "sag": "射手座",
        "cap": "摩羯座", "aqu": "水瓶座", "pis": "双鱼座"
    }

    for house in houses:
        num = house.get("house", "-")
        sign = house.get("sign", "").lower()[:3]
        cn_sign = sign_names.get(sign, house.get("sign", "-"))
        position = house.get("position", 0)
        lines.append(f"| 第{num}宫 | {cn_sign} | {position:.2f}° |")

    return "\n".join(lines)


def format_archetype_scores(scores: dict) -> str:
    """格式化12原型得分为表格"""
    lines = []
    lines.append("| 原型 | 中文名 | Emoji | 得分 |")
    lines.append("|------|--------|-------|------|")

    # 按得分排序
    sorted_scores = sorted(scores.items(), key=lambda x: x[1], reverse=True)

    for arch_name, score in sorted_scores:
        cn_name = get_archetype_cn_name(arch_name)
        emoji = get_archetype_emoji(arch_name)
        lines.append(f"| {arch_name} | {cn_name} | {emoji} | {score:.1f} |")

    return "\n".join(lines)


def format_four_dimensions(archetypes) -> str:
    """格式化四维原型"""
    lines = []
    lines.append("| 维度 | 含义 | 主原型 | 副原型 | 置信度 |")
    lines.append("|------|------|--------|--------|--------|")

    dimensions = [
        ("Core 核心", "灵魂本质", archetypes.core),
        ("Inner 内在", "情感世界", archetypes.inner),
        ("Outer 外在", "社会面具", archetypes.outer),
        ("Shadow 阴影", "潜意识倾向", archetypes.shadow),
    ]

    for name, meaning, result in dimensions:
        primary = f"{result.primary} ({get_archetype_cn_name(result.primary)})"
        secondary = f"{result.secondary} ({get_archetype_cn_name(result.secondary)})" if result.secondary else "-"
        confidence = result.confidence
        lines.append(f"| {name} | {meaning} | {primary} | {secondary} | {confidence} |")

    return "\n".join(lines)


def format_archetype_detail(archetype_id: str) -> str:
    """格式化原型详细信息"""
    info = get_archetype_info(archetype_id)
    if not info:
        return f"未找到原型 {archetype_id} 的详细信息"

    lines = [
        f"### {info.emoji} {info.name_cn} ({info.name_en})",
        f"",
        f"**昵称**: {info.nickname}",
        f"",
        f"**口号**: {info.slogan}",
        f"",
        f"**核心驱动**: {info.core_drive}",
        f"",
        f"**核心恐惧**: {info.core_fear}",
        f"",
        f"**描述**: {info.description}",
        f"",
        f"**超能力**:",
    ]
    for sp in info.superpowers:
        lines.append(f"- {sp}")

    lines.append("")
    lines.append("**成长点**:")
    for gp in info.growth_points:
        lines.append(f"- {gp}")

    lines.append("")
    lines.append(f"**成长方向**: {info.growth_direction}")
    lines.append("")
    lines.append(f"**最佳匹配**: {info.best_match}")
    lines.append(f"**需谨慎匹配**: {info.caution_match}")
    lines.append(f"**稀有度**: {info.rarity}%")

    return "\n".join(lines)


async def generate_report(
    birth_date: str,
    birth_time: str,
    birth_place: str,
    gender: str,
    output_path: str
) -> str:
    """生成完整的 VibeID 分析报告"""

    print(f"开始生成报告...")
    print(f"出生信息: {birth_date} {birth_time}, {birth_place}, {gender}")

    # 1. 计算八字
    print("\n[Step 1] 计算八字命盘...")
    bazi_calculator = BaziCalculator()
    bazi_chart = bazi_calculator.calculate(birth_date, birth_time, gender)
    bazi_dict = bazi_chart.to_dict()
    print(f"  日主: {bazi_dict['day_master']['stem']} ({bazi_dict['day_master']['element']})")

    # 2. 计算星盘
    print("\n[Step 2] 计算星盘...")
    year, month, day = map(int, birth_date.split("-"))
    hour, minute = map(int, birth_time.split(":"))
    lng, lat = get_city_coordinates(birth_place)

    astro_calculator = AstrologyCalculator()
    subject = astro_calculator.create_chart(
        name="user",
        year=year, month=month, day=day,
        hour=hour, minute=minute,
        lng=lng, lat=lat,
        tz_str="Asia/Shanghai"
    )
    chart_summary = astro_calculator.get_chart_summary(subject)
    print(f"  太阳: {chart_summary['sun']['sign']}")
    print(f"  月亮: {chart_summary['moon']['sign']}")
    print(f"  上升: {chart_summary['ascendant']['sign']}")

    # 3. 调用 VibeID 服务进行完整分析
    print("\n[Step 3] 运行 VibeID 分析...")
    service = VibeIDService()

    # 构建 natal_chart 格式
    natal_chart = {
        "sun_sign": chart_summary["sun"]["sign"].lower(),
        "moon_sign": chart_summary["moon"]["sign"].lower(),
        "rising_sign": chart_summary["ascendant"]["sign"].lower(),
        "planets": chart_summary.get("planets", []),
    }

    # 从 planets 中提取金星和火星
    for planet in chart_summary.get("planets", []):
        if planet.get("name", "").lower() == "venus":
            natal_chart["venus_sign"] = planet.get("sign", "").lower()
        elif planet.get("name", "").lower() == "mars":
            natal_chart["mars_sign"] = planet.get("sign", "").lower()

    profile = await service.calculate(
        birth_date=birth_date,
        birth_time=birth_time,
        birth_place=birth_place,
        gender=gender,
        bazi_chart=bazi_dict,
        natal_chart=natal_chart,
        save=False
    )
    print(f"  核心原型: {profile.archetypes.core.primary}")

    # 4. 生成报告
    print("\n[Step 4] 生成 Markdown 报告...")

    report_lines = [
        f"# VibeID 人格分析报告",
        f"",
        f"> 生成时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
        f"> VibeID 版本: {profile.version}",
        f"",
        f"---",
        f"",
        f"## 用户信息",
        f"",
        f"| 字段 | 值 |",
        f"|------|------|",
        f"| 出生日期 | {birth_date} |",
        f"| 出生时间 | {birth_time} |",
        f"| 出生地点 | {birth_place} |",
        f"| 性别 | {gender} |",
        f"| 农历日期 | {bazi_dict['birth_info'].get('lunar_date', '-')} |",
        f"",
        f"---",
        f"",
        f"## 第一部分: 八字命盘计算",
        f"",
        f"### 1.1 四柱八字",
        f"",
        format_four_pillars(bazi_dict["four_pillars"]),
        f"",
        f"### 1.2 日主信息",
        f"",
        f"| 属性 | 值 |",
        f"|------|------|",
        f"| 日主天干 | {bazi_dict['day_master']['stem']} |",
        f"| 日主五行 | {bazi_dict['day_master']['element']} |",
        f"| 阴阳属性 | {bazi_dict['day_master']['polarity']} |",
        f"| 日主描述 | {bazi_dict['day_master']['description']} |",
        f"",
        f"### 1.3 五行分布",
        f"",
        format_five_elements(bazi_dict["five_elements"]),
        f"",
        f"### 1.4 十神关系",
        f"",
        format_ten_gods(bazi_dict["ten_gods"]),
        f"",
        f"### 1.5 格局判断",
        f"",
        f"| 属性 | 值 |",
        f"|------|------|",
        f"| 格局名称 | {bazi_dict['pattern']['name']} |",
        f"| 格局描述 | {bazi_dict['pattern']['description']} |",
        f"",
        f"---",
        f"",
        f"## 第二部分: 星盘计算",
        f"",
        f"### 2.1 基础星座信息",
        f"",
        f"| 星体 | 星座 | 度数 |",
        f"|------|------|------|",
        f"| 太阳 | {chart_summary['sun']['sign']} | {chart_summary['sun']['position']:.2f}° |",
        f"| 月亮 | {chart_summary['moon']['sign']} | {chart_summary['moon']['position']:.2f}° |",
        f"| 上升点 | {chart_summary['ascendant']['sign']} | {chart_summary['ascendant']['position']:.2f}° |",
        f"",
        f"### 2.2 行星位置",
        f"",
        format_planets(chart_summary["planets"]),
        f"",
        f"### 2.3 宫位系统",
        f"",
        format_houses(chart_summary["houses"]),
        f"",
        f"---",
        f"",
        f"## 第三部分: 八字分析结果",
        f"",
    ]

    if profile.bazi_analysis:
        ba = profile.bazi_analysis
        report_lines.extend([
            f"### 3.1 日主强弱分析",
            f"",
            f"| 属性 | 值 |",
            f"|------|------|",
            f"| 日主 | {ba.day_master} |",
            f"| 日主五行 | {ba.day_master_element} |",
            f"| 日主强弱等级 | {ba.day_master_strength} |",
            f"| 强弱得分 | {ba.day_master_strength_score:.2f} (范围 -1.0 ~ 1.0) |",
            f"",
            f"### 3.2 格局与用神",
            f"",
            f"| 属性 | 值 |",
            f"|------|------|",
            f"| 格局 | {ba.pattern} |",
            f"| 用神 | {ba.useful_god} |",
            f"| 原型驱动 | {ba.archetype_driver} |",
            f"",
            f"### 3.3 八字原型映射",
            f"",
            f"| 属性 | 值 |",
            f"|------|------|",
            f"| 主原型 | {ba.primary_archetype} ({get_archetype_cn_name(ba.primary_archetype)}) |",
            f"| 副原型 | {ba.secondary_archetype or '-'} ({get_archetype_cn_name(ba.secondary_archetype) if ba.secondary_archetype else '-'}) |",
            f"",
        ])

    report_lines.extend([
        f"---",
        f"",
        f"## 第四部分: 星盘分析结果",
        f"",
    ])

    if profile.zodiac_analysis:
        za = profile.zodiac_analysis
        report_lines.extend([
            f"### 4.1 五点星盘",
            f"",
            f"| 星体 | 星座 | 含义 |",
            f"|------|------|------|",
            f"| 太阳 | {za.sun_sign} | 核心自我 (35%) |",
            f"| 月亮 | {za.moon_sign} | 情感需求 (25%) |",
            f"| 上升 | {za.rising_sign} | 社会面具 (20%) |",
            f"| 金星 | {za.venus_sign or '-'} | 爱情风格 (10%) |",
            f"| 火星 | {za.mars_sign or '-'} | 行动风格 (10%) |",
            f"",
            f"### 4.2 星盘原型映射",
            f"",
            f"| 维度 | 原型 |",
            f"|------|------|",
            f"| 主原型 (太阳) | {za.primary_archetype} ({get_archetype_cn_name(za.primary_archetype)}) |",
            f"| 内在原型 (月亮+金星) | {za.inner_archetype} ({get_archetype_cn_name(za.inner_archetype)}) |",
            f"| 外在原型 (上升+火星) | {za.outer_archetype} ({get_archetype_cn_name(za.outer_archetype)}) |",
            f"",
        ])

    report_lines.extend([
        f"---",
        f"",
        f"## 第五部分: 融合计算结果",
        f"",
        f"### 5.1 四维原型",
        f"",
        format_four_dimensions(profile.archetypes),
        f"",
        f"### 5.2 融合计算说明",
        f"",
        f"融合策略:",
        f"- 八字权重: 70%",
        f"- 星座权重: 30%",
        f"- 一致性奖励: +15% (当两者指向同一原型时)",
        f"",
    ])

    if profile.archetypes and profile.archetypes.core.source:
        source = profile.archetypes.core.source
        report_lines.extend([
            f"### 5.3 Core 原型融合详情",
            f"",
            f"| 属性 | 值 |",
            f"|------|------|",
            f"| 八字贡献 | {source.get('bazi_contribution', '-')} |",
            f"| 八字格局 | {source.get('bazi_pattern', '-')} |",
            f"| 八字用神 | {source.get('bazi_useful_god', '-')} |",
            f"| 星盘贡献 | {source.get('zodiac_contribution', '-')} |",
            f"| 一致性类型 | {source.get('consistency_type', '-')} |",
            f"",
        ])

    report_lines.extend([
        f"### 5.4 12原型得分 (归一化后)",
        f"",
        format_archetype_scores(profile.archetype_scores),
        f"",
        f"---",
        f"",
        f"## 第六部分: 可解释性报告",
        f"",
    ])

    if profile.explanation:
        exp = profile.explanation
        report_lines.extend([
            f"### 6.1 总结",
            f"",
            f"> {exp.summary}",
            f"",
            f"### 6.2 八字洞察",
            f"",
            f"{exp.bazi_insight}",
            f"",
            f"### 6.3 星座洞察",
            f"",
            f"{exp.zodiac_insight}",
            f"",
            f"### 6.4 融合洞察",
            f"",
            f"{exp.integration_insight}",
            f"",
            f"### 6.5 成长方向",
            f"",
            f"{exp.growth_direction}",
            f"",
        ])

    report_lines.extend([
        f"---",
        f"",
        f"## 第七部分: 核心原型详情",
        f"",
        format_archetype_detail(profile.archetypes.core.primary),
        f"",
        f"---",
        f"",
        f"## 附录: 计算过程日志",
        f"",
        f"```",
        f"[Step 1] BaziCalculator.calculate()",
        f"  输入: birth_date={birth_date}, birth_time={birth_time}, gender={gender}",
        f"  输出: 四柱八字 {bazi_dict['four_pillars']['year']['stem']}{bazi_dict['four_pillars']['year']['branch']} "
        f"{bazi_dict['four_pillars']['month']['stem']}{bazi_dict['four_pillars']['month']['branch']} "
        f"{bazi_dict['four_pillars']['day']['stem']}{bazi_dict['four_pillars']['day']['branch']} "
        f"{bazi_dict['four_pillars']['hour']['stem']}{bazi_dict['four_pillars']['hour']['branch']}",
        f"",
        f"[Step 2] AstrologyCalculator.create_chart()",
        f"  输入: {year}-{month}-{day} {hour}:{minute}, 经度={lng}, 纬度={lat}",
        f"  输出: 太阳{chart_summary['sun']['sign']}, 月亮{chart_summary['moon']['sign']}, 上升{chart_summary['ascendant']['sign']}",
        f"",
        f"[Step 3] BaziAnalyzer.analyze()",
        f"  日主强弱: {profile.bazi_analysis.day_master_strength} (score={profile.bazi_analysis.day_master_strength_score:.2f})" if profile.bazi_analysis else "",
        f"  格局: {profile.bazi_analysis.pattern}" if profile.bazi_analysis else "",
        f"  用神: {profile.bazi_analysis.useful_god}" if profile.bazi_analysis else "",
        f"  主原型: {profile.bazi_analysis.primary_archetype}" if profile.bazi_analysis else "",
        f"",
        f"[Step 4] ZodiacAnalyzer.analyze()",
        f"  主原型: {profile.zodiac_analysis.primary_archetype}" if profile.zodiac_analysis else "",
        f"  内在原型: {profile.zodiac_analysis.inner_archetype}" if profile.zodiac_analysis else "",
        f"  外在原型: {profile.zodiac_analysis.outer_archetype}" if profile.zodiac_analysis else "",
        f"",
        f"[Step 5] FusionEngine.fuse()",
        f"  一致性检查: {profile.archetypes.core.source.get('consistency_type', '-')}" if profile.archetypes else "",
        f"  最终 Core: {profile.archetypes.core.primary}" if profile.archetypes else "",
        f"  置信度: {profile.archetypes.core.confidence}" if profile.archetypes else "",
        f"",
        f"[Step 6] Explainer.generate()",
        f"  生成解释文本完成",
        f"```",
        f"",
        f"---",
        f"",
        f"*报告生成完成*",
    ])

    report_content = "\n".join(report_lines)

    # 写入文件
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(report_content)

    print(f"\n报告已生成: {output_path}")
    return report_content


def main():
    parser = argparse.ArgumentParser(description="生成 VibeID 人格分析报告")
    parser.add_argument("--birth-date", required=True, help="出生日期 (YYYY-MM-DD)")
    parser.add_argument("--birth-time", default="12:00", help="出生时间 (HH:MM)")
    parser.add_argument("--birth-place", default="北京", help="出生地点")
    parser.add_argument("--gender", default="unknown", choices=["male", "female", "unknown"], help="性别")
    parser.add_argument("--output", required=True, help="输出文件路径")

    args = parser.parse_args()

    asyncio.run(generate_report(
        birth_date=args.birth_date,
        birth_time=args.birth_time,
        birth_place=args.birth_place,
        gender=args.gender,
        output_path=args.output
    ))


if __name__ == "__main__":
    main()
