const $ = (s, r = document) => r.querySelector(s);
const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));

function escapeHtml(s) {
  return String(s ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");
}

function getCookie(name) {
  const m = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/[-.]/g, "\\$&") + "=([^;]*)"));
  return m ? decodeURIComponent(m[1]) : "";
}

function csrfHeaders() {
  const csrf = getCookie("fortune_csrf");
  return csrf ? { "X-CSRF-Token": csrf } : {};
}

// ========== P0: ç»Ÿä¸€çŠ¶æ€æœº ==========
const ComponentState = {
  IDLE: 'idle',
  LOADING: 'loading',
  SUCCESS: 'success',
  EMPTY: 'empty',
  ERROR: 'error',
  RETRY: 'retry',
  DISABLED: 'disabled',
};

// é”™è¯¯ç±»å‹ä¸å¤„ç†ç­–ç•¥
const ERROR_HANDLERS = {
  401: () => { location.href = '/login'; return { handled: true }; },
  403: () => { location.href = '/login'; return { handled: true }; },
  429: (retryAfter) => {
    const delay = parseInt(retryAfter) * 1000 || 60000;
    return { retry: true, delay, message: 'è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•' };
  },
  500: () => ({ retry: true, delay: 3000, message: 'æœåŠ¡å™¨é”™è¯¯ï¼Œæ­£åœ¨é‡è¯•...' }),
  502: () => ({ retry: true, delay: 5000, message: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨' }),
  503: () => ({ retry: true, delay: 5000, message: 'æœåŠ¡ç»´æŠ¤ä¸­' }),
  0: () => ({ offline: true, message: 'ç½‘ç»œè¿æ¥å·²æ–­å¼€' }),
};

// API é”™è¯¯ç±»
class ApiError extends Error {
  constructor(status, code, message, detail = {}) {
    super(message);
    this.name = 'ApiError';
    this.status = status;
    this.code = code;
    this.detail = detail;
  }
}

// å¢å¼ºç‰ˆ apiJson - æ”¯æŒé‡è¯•å’Œé”™è¯¯åˆ†ç±»
async function apiJson(url, opts = {}) {
  const maxRetries = opts._retries ?? 0;
  const currentRetry = opts._currentRetry ?? 0;

  let res;
  try {
    res = await fetch(url, opts);
  } catch (e) {
    // ç½‘ç»œé”™è¯¯
    const handler = ERROR_HANDLERS[0];
    const result = handler();
    if (result.offline) {
      showOfflineBanner(true);
    }
    throw new ApiError(0, 'network_error', result.message || 'ç½‘ç»œé”™è¯¯');
  }

  const data = await res.json().catch(() => ({}));

  if (!res.ok) {
    const handler = ERROR_HANDLERS[res.status];
    if (handler) {
      const result = handler(res.headers.get('Retry-After'));
      if (result.handled) return; // å·²å¤„ç† (å¦‚è·³è½¬ç™»å½•)
      if (result.retry && currentRetry < maxRetries) {
        await new Promise(r => setTimeout(r, result.delay));
        return apiJson(url, { ...opts, _retries: maxRetries, _currentRetry: currentRetry + 1 });
      }
      throw new ApiError(res.status, data?.error?.code || 'server_error', result.message || data?.error?.message || 'æœåŠ¡å™¨é”™è¯¯', data?.error?.detail);
    }
    throw new ApiError(res.status, data?.error?.code || 'unknown', data?.error?.message || data?.detail || 'è¯·æ±‚å¤±è´¥', data?.error?.detail);
  }

  if (data?.ok !== true) {
    throw new ApiError(res.status, data?.error?.code || 'api_error', data?.error?.message || 'æ“ä½œå¤±è´¥', data?.error?.detail);
  }

  // æˆåŠŸæ—¶éšè—ç¦»çº¿æç¤º
  showOfflineBanner(false);
  return data?.data ?? {};
}

// å¸¦è‡ªåŠ¨é‡è¯•çš„ apiJson
function apiJsonWithRetry(url, opts = {}, retries = 1) {
  return apiJson(url, { ...opts, _retries: retries });
}

// ç¦»çº¿çŠ¶æ€ç®¡ç†
let _isOffline = false;
function showOfflineBanner(show) {
  _isOffline = show;
  const banner = $('#offline-banner');
  if (banner) {
    banner.style.display = show ? 'flex' : 'none';
  }
}

// ç½‘ç»œçŠ¶æ€ç›‘å¬
window.addEventListener('online', () => {
  showOfflineBanner(false);
  // è§¦å‘æ•°æ®åˆ·æ–°
  if (typeof refreshAllData === 'function') refreshAllData();
});
window.addEventListener('offline', () => {
  showOfflineBanner(true);
});

// ========== P0: ç»„ä»¶çŠ¶æ€æ¸²æŸ“ ==========
function setSectionState(sectionId, state, content = '') {
  const el = document.getElementById(sectionId);
  if (!el) return;

  // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
  el.classList.remove('state-loading', 'state-empty', 'state-error', 'state-success');

  switch (state) {
    case ComponentState.LOADING:
      el.classList.add('state-loading');
      el.innerHTML = `<div class="loading-skeleton"><div class="skel-line"></div><div class="skel-line short"></div></div>`;
      break;
    case ComponentState.EMPTY:
      el.classList.add('state-empty');
      el.innerHTML = `<div class="empty-state"><span class="empty-icon">ğŸ“­</span><span class="empty-text">${escapeHtml(content) || 'æš‚æ— æ•°æ®'}</span></div>`;
      break;
    case ComponentState.ERROR:
      el.classList.add('state-error');
      el.innerHTML = `<div class="error-state"><span class="error-icon">âš ï¸</span><span class="error-text">${escapeHtml(content) || 'åŠ è½½å¤±è´¥'}</span><button class="ui-btn ui-btn-ghost error-retry" onclick="retrySection('${sectionId}')">é‡è¯•</button></div>`;
      break;
    case ComponentState.SUCCESS:
      el.classList.add('state-success');
      el.innerHTML = content;
      break;
    default:
      el.innerHTML = content;
  }
}

// é‡è¯•å›è°ƒæ³¨å†Œ
const _sectionRetryHandlers = {};
function registerSectionRetry(sectionId, handler) {
  _sectionRetryHandlers[sectionId] = handler;
}
function retrySection(sectionId) {
  const handler = _sectionRetryHandlers[sectionId];
  if (handler) handler();
}

function md(src) {
  let raw = String(src || "");
  const codeBlocks = [];
  raw = raw.replace(/```([a-zA-Z0-9_-]+)?\n([\s\S]*?)```/g, (_m, lang, code) => {
    const token = `__CODE_BLOCK_${codeBlocks.length}__`;
    codeBlocks.push({ lang: String(lang || ""), code: String(code || "") });
    return token;
  });

  let s = raw;
  s = s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  // links
  s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
  // headings / quote / lists
  s = s.replace(/^###\s+(.*)$/gm, "<h3>$1</h3>")
    .replace(/^##\s+(.*)$/gm, "<h2>$1</h2>")
    .replace(/^#\s+(.*)$/gm, "<h1>$1</h1>")
    .replace(/^>\s?(.*)$/gm, "<blockquote>$1</blockquote>")
    .replace(/^\s*[-*]\s+(.*)$/gm, "<li>$1</li>")
    .replace(/^\s*\d+\.\s+(.*)$/gm, "<li>$1</li>");
  s = s.replace(/(?:<li>[\s\S]*?<\/li>\s*)+/g, (m) => "<ul>" + m.replace(/\n/g, "") + "</ul>");
  // emphasis / inline code
  s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>")
    .replace(/\*([^*]+)\*/g, "<em>$1</em>")
    .replace(/`([^`]+)`/g, "<code>$1</code>");

  s = s.replace(/\n\n+/g, "<br/><br/>").replace(/\n/g, "<br/>");

  // restore code blocks
  for (let i = 0; i < codeBlocks.length; i++) {
    const token = `__CODE_BLOCK_${i}__`;
    const b = codeBlocks[i];
    const lang = escapeHtml(b.lang || "");
    const code = escapeHtml(b.code || "");
    const html = `<pre class="md-code"><code${lang ? ` class="language-${lang}"` : ""}>${code}</code></pre>`;
    s = s.replace(token, html);
  }

  return s;
}

function pushMsg(role, html, extraClass) {
  const div = document.createElement("div");
  const baseRole = role === "user" ? "user" : "bot";
  div.className = `msg msg-${baseRole}` + (extraClass ? ` ${extraClass}` : "");
  if (baseRole === "user") {
    div.innerHTML = `<div class="msg__bubble">${html}</div>`;
  } else {
    div.innerHTML = `<div class="msg__icon">âœ¦</div><div class="msg__content">${html}</div>`;
  }
  $("#thread")?.appendChild(div);
  div.scrollIntoView({ behavior: "smooth", block: "end" });
  return div;
}

function setMsgContent(div, html) {
  const el = div.querySelector(".msg__content") || div.querySelector(".msg__bubble") || div;
  el.innerHTML = html;
}

// ========== Result Card System (replaces Viewer) ==========
// å·¥å…·ç»“æœå¡ç‰‡ - è¿›å…¥å³ä¾§ç»“æœåŒº
const resultCards = new Map(); // taskId -> DOM element

function updateResultEmptyState() {
  const stack = $("#result-stack");
  const empty = $("#result-empty");
  if (!stack || !empty) return;
  empty.style.display = stack.children.length ? "none" : "block";
}

function pushResultCard(taskId, title, html, type = "result") {
  // type: "progress" | "result" | "error"
  const existingCard = resultCards.get(taskId);

  if (existingCard) {
    // Update existing card
    const titleEl = existingCard.querySelector(".result-card__title");
    const contentEl = existingCard.querySelector(".result-card__content");
    if (titleEl) titleEl.textContent = title;
    if (contentEl) {
      contentEl.innerHTML = html;
      wireActions(contentEl);
    }
    existingCard.className = `msg msg-bot result-card result-card--${type}`;
    if (isMobile()) setMobileTab("workbench");
    updateResultEmptyState();
    const dockBody = $("#result-dock-body");
    if (dockBody) {
      dockBody.scrollTop = dockBody.scrollHeight;
    } else {
      existingCard.scrollIntoView({ behavior: "smooth", block: "end" });
    }
    return existingCard;
  }

  // Create new card
  const div = document.createElement("div");
  div.className = `msg msg-bot result-card result-card--${type}`;
  div.setAttribute("data-task-id", taskId);
  div.innerHTML = `
    <div class="msg__icon result-card__icon">â—†</div>
    <div class="msg__content result-card__body">
      <div class="result-card__header">
        <span class="result-card__title">${escapeHtml(title)}</span>
        <div class="result-card__actions">
          <button class="ui-btn ui-btn-ghost result-card__copy" title="å¤åˆ¶">ğŸ“‹</button>
          <button class="ui-btn ui-btn-ghost result-card__dismiss" title="å…³é—­">âœ•</button>
        </div>
      </div>
      <div class="result-card__content">${html}</div>
    </div>
  `;

  // Bind actions
  div.querySelector(".result-card__copy")?.addEventListener("click", async () => {
    const content = div.querySelector(".result-card__content")?.innerText || "";
    try {
      await navigator.clipboard.writeText(content);
      const btn = div.querySelector(".result-card__copy");
      if (btn) { btn.textContent = "âœ“"; setTimeout(() => btn.textContent = "ğŸ“‹", 1500); }
    } catch (_e) {}
  });

  div.querySelector(".result-card__dismiss")?.addEventListener("click", () => {
    div.classList.add("result-card--dismissed");
    setTimeout(() => {
      div.remove();
      resultCards.delete(taskId);
    }, 300);
  });

  wireActions(div.querySelector(".result-card__content"));
  const stack = $("#result-stack");
  const target = stack || $("#thread");
  target?.appendChild(div);
  if (isMobile()) setMobileTab("workbench");
  updateResultEmptyState();
  const dockBody = $("#result-dock-body");
  if (dockBody) {
    dockBody.scrollTop = dockBody.scrollHeight;
  } else {
    div.scrollIntoView({ behavior: "smooth", block: "end" });
  }
  resultCards.set(taskId, div);
  return div;
}

function updateResultCard(taskId, title, html, type) {
  return pushResultCard(taskId, title, html, type);
}

function removeResultCard(taskId) {
  const card = resultCards.get(taskId);
  if (card) {
    card.classList.add("result-card--dismissed");
    setTimeout(() => {
      card.remove();
      resultCards.delete(taskId);
      updateResultEmptyState();
    }, 300);
  }
}

// Legacy setViewer functions - now redirect to Result Card system
let _currentViewerTaskId = null;

function setViewer(title, html) {
  if (!_currentViewerTaskId) {
    _currentViewerTaskId = "viewer_" + Date.now();
  }
  pushResultCard(_currentViewerTaskId, title, html, "result");
}

function setViewerMarkdown(title, markdownText) {
  setViewer(title, md(markdownText || ""));
}

function setViewerA2UI(title, a2ui) {
  const rendered = renderA2UI(a2ui || {});
  setViewer(title, rendered.html || "ï¼ˆæ— å†…å®¹ï¼‰");
}

function resetViewer() {
  // No-op in new system - cards persist in chat
  _currentViewerTaskId = null;
}

function isMobile() {
  return window.matchMedia("(max-width: 1080px)").matches;
}

function setMobileTab(tab) {
  if (!isMobile()) {
    delete document.body.dataset.mobileTab;
    return;
  }
  const next = tab === "workbench" ? "workbench" : "chat";
  document.body.dataset.mobileTab = next;
  const chatBtn = $("#mobile-tab-chat");
  const wbBtn = $("#mobile-tab-workbench");
  if (chatBtn) {
    chatBtn.classList.toggle("ui-mobile-tab--active", next === "chat");
    chatBtn.setAttribute("aria-selected", next === "chat" ? "true" : "false");
  }
  if (wbBtn) {
    wbBtn.classList.toggle("ui-mobile-tab--active", next === "workbench");
    wbBtn.setAttribute("aria-selected", next === "workbench" ? "true" : "false");
  }
}

// ========== Progress Bar Utilities ==========
function setViewerProgress(title, steps, currentStep, message) {
  if (!_currentViewerTaskId) {
    _currentViewerTaskId = "viewer_" + Date.now();
  }
  const percent = steps > 0 ? Math.round((currentStep / steps) * 100) : 0;
  const stepsHtml = Array.from({ length: steps }, (_, i) => {
    const isCompleted = i < currentStep;
    const isCurrent = i === currentStep;
    return `<div class="ui-step ${isCompleted ? "completed" : ""} ${isCurrent ? "current" : ""}">${i + 1}</div>`;
  }).join("");

  const html = `
    <div class="ui-progress-wrapper">
      <div class="ui-progress">
        <div class="ui-progress__bar" style="width:${percent}%"></div>
      </div>
      <div class="ui-steps">${stepsHtml}</div>
      <div class="ui-task__meta" style="margin-top:8px">${escapeHtml(message || `æ­¥éª¤ ${currentStep}/${steps}`)}</div>
    </div>
  `;
  pushResultCard(_currentViewerTaskId, title, html, currentStep >= steps ? "result" : "progress");
}

function setViewerIndeterminate(title, message) {
  if (!_currentViewerTaskId) {
    _currentViewerTaskId = "viewer_" + Date.now();
  }
  const html = `
    <div class="ui-progress-wrapper">
      <div class="ui-progress ui-progress--indeterminate">
        <div class="ui-progress__bar"></div>
      </div>
      <div class="ui-task__meta" style="margin-top:8px">${escapeHtml(message || "å¤„ç†ä¸­...")}</div>
    </div>
  `;
  pushResultCard(_currentViewerTaskId, title, html, "progress");
}

// Start new task (resets viewer task id)
function startNewTask() {
  _currentViewerTaskId = "task_" + Date.now();
  return _currentViewerTaskId;
}

function openDrawer() {
  const drawer = $("#session-drawer");
  if (!drawer) return;
  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden", "false");
}

function closeDrawer() {
  const drawer = $("#session-drawer");
  if (!drawer) return;
  drawer.classList.remove("open");
  drawer.setAttribute("aria-hidden", "true");
}

function setActiveTab(panelId) {
  $$(".ui-tab").forEach((b) => b.classList.remove("ui-tab--active"));
  const btn = $(`[data-panel="${panelId}"]`);
  if (btn) btn.classList.add("ui-tab--active");
  $$(".ui-panel").forEach((p) => (p.style.display = "none"));
  const panel = $("#" + panelId);
  if (panel) panel.style.display = "block";
}

function openBento() {
  setActiveTab("panel-bento");
  if (isMobile()) {
    setMobileTab("workbench");
    return;
  }
  document.body.classList.add("show-bento");
}

function openTools() {
  setActiveTab("panel-tools");
  if (isMobile()) {
    setMobileTab("workbench");
    return;
  }
  document.body.classList.add("show-bento");
}

function openSettings() {
  setActiveTab("panel-settings");
  if (isMobile()) {
    setMobileTab("workbench");
    return;
  }
  document.body.classList.add("show-bento");
}

function closeBento() {
  if (isMobile()) {
    setMobileTab("chat");
    return;
  }
  document.body.classList.remove("show-bento", "show-bento-peek");
  if (typeof bottomSheet !== "undefined" && bottomSheet.currentState) {
    bottomSheet.currentState = "closed";
  }
}

// ========== P0: åŠ¨ä½œå¥‘çº¦æ ‡å‡†åŒ– ==========

// è§„èŒƒåŒ–æŒ‰é’®: 1ä¸» + â‰¤2æ¬¡ + æŠ˜å 
function normalizeActionButtons(buttons) {
  if (!Array.isArray(buttons) || buttons.length === 0) {
    return {
      primary: { label: 'å¥½çš„', action: { type: 'opt_out' }, style: 'ghost' },
      secondary: [],
      collapsed: null,
    };
  }

  // æ‰¾ä¸»æŒ‰é’® (æ˜¾å¼ primary æˆ–ç¬¬ä¸€ä¸ª)
  const primaryIdx = buttons.findIndex(b => b.style === 'primary');
  const primary = primaryIdx >= 0 ? buttons[primaryIdx] : buttons[0];

  // å‰©ä½™æŒ‰é’®
  const rest = buttons.filter((b, i) => (primaryIdx >= 0 ? i !== primaryIdx : i !== 0));

  // æ¬¡æŒ‰é’®æœ€å¤š2ä¸ª
  const secondary = rest.slice(0, 2);
  const collapsed = rest.length > 2 ? rest.slice(2) : null;

  return {
    primary: { ...primary, style: 'primary' },
    secondary: secondary.map(b => ({ ...b, style: 'ghost' })),
    collapsed,
  };
}

// æ¸²æŸ“è§„èŒƒåŒ–æŒ‰é’®
function renderNormalizedButtons(normalized) {
  const { primary, secondary, collapsed } = normalized;
  const actionId = `actions_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;

  let html = `<div class="a2ui-actions" data-action-group="${actionId}">`;

  // ä¸»æŒ‰é’®
  const pKey = generateIdempotencyKey(primary.action);
  html += `<button class="ui-btn ui-btn-primary a2ui-btn" data-action="${escapeHtml(JSON.stringify(primary.action))}" data-idempotency-key="${pKey}">${escapeHtml(primary.label)}</button>`;

  // æ¬¡æŒ‰é’®
  for (const btn of secondary) {
    const sKey = generateIdempotencyKey(btn.action);
    html += `<button class="ui-btn ui-btn-ghost a2ui-btn" data-action="${escapeHtml(JSON.stringify(btn.action))}" data-idempotency-key="${sKey}">${escapeHtml(btn.label)}</button>`;
  }

  // æŠ˜å æŒ‰é’®
  if (collapsed && collapsed.length > 0) {
    html += `<div class="a2ui-actions-more">`;
    html += `<button class="ui-btn ui-btn-ghost a2ui-more-toggle" aria-expanded="false">æ›´å¤š â–¾</button>`;
    html += `<div class="a2ui-more-dropdown" hidden>`;
    for (const btn of collapsed) {
      const cKey = generateIdempotencyKey(btn.action);
      html += `<button class="ui-btn ui-btn-ghost a2ui-btn" data-action="${escapeHtml(JSON.stringify(btn.action))}" data-idempotency-key="${cKey}">${escapeHtml(btn.label)}</button>`;
    }
    html += `</div></div>`;
  }

  html += `</div>`;
  return html;
}

// ç”Ÿæˆå¹‚ç­‰é”®
function generateIdempotencyKey(action) {
  if (!action) return '';
  const base = `${action.type || 'unknown'}_${action.task_id || ''}_${Date.now()}`;
  return base.replace(/[^a-zA-Z0-9_-]/g, '');
}

// éœ€è¦äºŒæ¬¡ç¡®è®¤çš„åŠ¨ä½œ
const ACTIONS_REQUIRE_CONFIRM = {
  'delete_account': { title: 'ç¡®è®¤æ³¨é”€', message: 'æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œç¡®å®šè¦æ³¨é”€è´¦æˆ·å—ï¼Ÿ' },
  'delete_session': { title: 'ç¡®è®¤åˆ é™¤', message: 'ç¡®å®šè¦åˆ é™¤æ­¤å¯¹è¯å—ï¼Ÿ' },
};

// Buff é‡‘é¢ç¡®è®¤é˜ˆå€¼
const BUFF_CONFIRM_THRESHOLD = 100;

// æ£€æŸ¥æ˜¯å¦éœ€è¦ç¡®è®¤
async function checkActionConfirm(action) {
  // é¢„è®¾éœ€è¦ç¡®è®¤çš„åŠ¨ä½œ
  if (ACTIONS_REQUIRE_CONFIRM[action.type]) {
    const { title, message } = ACTIONS_REQUIRE_CONFIRM[action.type];
    return confirm(`${title}\n\n${message}`);
  }

  // Buff é‡‘é¢è¶…è¿‡é˜ˆå€¼éœ€ç¡®è®¤
  if (action.type === 'send_buff' && action.amount > BUFF_CONFIRM_THRESHOLD) {
    return confirm(`ç¡®è®¤å‘é€ ${action.amount} èƒ½é‡å—ï¼Ÿ`);
  }

  return true;
}

function renderA2UI(a2ui) {
  const comps = a2ui?.ui_components || [];
  let html = "";

  for (const comp of comps) {
    if (!comp || !comp.type) continue;

    switch (comp.type) {
      case "markdown_text":
        const mdText = typeof comp.data === "string" ? comp.data : "";
        html += md(mdText || "");
        break;

      case "plain_text":
        const plainText = typeof comp.data === "string" ? comp.data : "";
        html += `<p>${escapeHtml(plainText)}</p>`;
        break;

      case "action_buttons":
        if (Array.isArray(comp.data) && comp.data.length) {
          // P0: åŠ¨ä½œå¥‘çº¦æ ‡å‡†åŒ– - 1ä¸» + â‰¤2æ¬¡ + æŠ˜å 
          const normalized = normalizeActionButtons(comp.data);
          html += renderNormalizedButtons(normalized);
        }
        break;

      case "quick_replies":
        if (Array.isArray(comp.data) && comp.data.length) {
          const chips = comp.data
            .map((reply) => {
              const text = escapeHtml(typeof reply === "string" ? reply : reply.text || "");
              return `<button class="ui-chip a2ui-quick-reply" data-reply="${text}">${text}</button>`;
            })
            .join("");
          html += `<div class="a2ui-quick-replies" style="margin-top:10px;display:flex;gap:6px;flex-wrap:wrap">${chips}</div>`;
        }
        break;

      case "stat_card":
        if (Array.isArray(comp.data) && comp.data.length) {
          const stats = comp.data
            .map((s) => {
              const label = escapeHtml(s.label || "");
              const value = escapeHtml(String(s.value || "0"));
              const unit = s.unit ? escapeHtml(s.unit) : "";
              const trend = s.trend || "";
              const trendIcon = trend === "up" ? "â†‘" : trend === "down" ? "â†“" : "";
              const trendClass = trend === "up" ? "trend-up" : trend === "down" ? "trend-down" : "";
              return `<div class="a2ui-stat">
                <div class="a2ui-stat-value ${trendClass}">${value}${unit} ${trendIcon}</div>
                <div class="a2ui-stat-label">${label}</div>
              </div>`;
            })
            .join("");
          const title = comp.title ? `<div class="a2ui-card-title">${escapeHtml(comp.title)}</div>` : "";
          html += `<div class="a2ui-stat-card">${title}<div class="a2ui-stat-grid">${stats}</div></div>`;
        }
        break;

      case "progress_bar":
        if (comp.data && typeof comp.data === "object") {
          const current = Number(comp.data.current) || 0;
          const total = Number(comp.data.total) || 100;
          const pct = Math.min(100, Math.max(0, (current / total) * 100));
          const label = comp.data.label ? escapeHtml(comp.data.label) : `${current}/${total}`;
          const title = comp.title ? `<div class="a2ui-progress-title">${escapeHtml(comp.title)}</div>` : "";
          html += `<div class="a2ui-progress">
            ${title}
            <div class="a2ui-progress-bar">
              <div class="a2ui-progress-fill" style="width:${pct}%"></div>
            </div>
            <div class="a2ui-progress-label">${label}</div>
          </div>`;
        }
        break;

      case "list_view":
        if (Array.isArray(comp.data) && comp.data.length) {
          const items = comp.data
            .map((item) => {
              const icon = item.icon ? `<span class="a2ui-list-icon">${escapeHtml(item.icon)}</span>` : "";
              const title = escapeHtml(item.title || "");
              const subtitle = item.subtitle ? `<div class="a2ui-list-subtitle">${escapeHtml(item.subtitle)}</div>` : "";
              const action = item.action ? `data-action="${escapeHtml(JSON.stringify(item.action))}"` : "";
              const clickable = item.action ? "a2ui-list-item-clickable a2ui-btn" : "";
              return `<div class="a2ui-list-item ${clickable}" ${action}>
                ${icon}
                <div class="a2ui-list-content">
                  <div class="a2ui-list-title">${title}</div>
                  ${subtitle}
                </div>
              </div>`;
            })
            .join("");
          const listTitle = comp.title ? `<div class="a2ui-list-header">${escapeHtml(comp.title)}</div>` : "";
          html += `<div class="a2ui-list">${listTitle}${items}</div>`;
        }
        break;

      case "key_value":
        if (Array.isArray(comp.data) && comp.data.length) {
          const pairs = comp.data
            .map((p) => {
              const key = escapeHtml(p.key || "");
              const value = escapeHtml(String(p.value || ""));
              return `<div class="a2ui-kv-row">
                <span class="a2ui-kv-key">${key}</span>
                <span class="a2ui-kv-value">${value}</span>
              </div>`;
            })
            .join("");
          const kvTitle = comp.title ? `<div class="a2ui-kv-title">${escapeHtml(comp.title)}</div>` : "";
          html += `<div class="a2ui-kv">${kvTitle}${pairs}</div>`;
        }
        break;

      case "divider":
        const dividerText = comp.title ? `<span class="a2ui-divider-text">${escapeHtml(comp.title)}</span>` : "";
        html += `<div class="a2ui-divider">${dividerText}</div>`;
        break;

      case "spacer":
        const height = (comp.data && comp.data.height) || 16;
        html += `<div class="a2ui-spacer" style="height:${height}px"></div>`;
        break;

      default:
        // Unknown component type, try to render as text
        if (typeof comp.data === "string") {
          html += `<p>${escapeHtml(comp.data)}</p>`;
        }
    }
  }

  // Extract first markdown text for backward compatibility
  const first = comps.find((c) => c && c.type === "markdown_text") || comps[0] || {};
  const mdText = typeof first?.data === "string" ? first.data : "";

  return { mdText, html };
}

// ========== P0: å¢å¼ºåŠ¨ä½œæ‰§è¡Œ ==========

// åŸ‹ç‚¹å‡½æ•° (å¯æ›¿æ¢ä¸ºçœŸå®åŸ‹ç‚¹ SDK)
function trackEvent(eventName, data = {}) {
  console.log(`[Track] ${eventName}`, data);
  // TODO: æ¥å…¥çœŸå®åŸ‹ç‚¹ SDK
}

// è·å–åŠ¨ä½œç«¯ç‚¹
function getActionEndpoint(action) {
  switch (action.type) {
    case 'start_task':
    case 'schedule_task':
      return '/api/bento/commitment/accept';
    case 'done_task':
      return '/api/bento/commitment/done';
    case 'send_buff':
      return '/api/social/buff';
    default:
      return null;
  }
}

// è·å–åŠ¨ä½œè¯·æ±‚ä½“
function getActionBody(action) {
  switch (action.type) {
    case 'start_task':
    case 'schedule_task':
      return { task_id: action.task_id, commitment_type: action.type };
    case 'done_task':
      return { task_id: action.task_id };
    case 'send_buff':
      return { to_user_id: action.to_user_id, buff_type: action.buff_type, amount: action.amount };
    default:
      return action;
  }
}

// æ‰§è¡ŒåŠ¨ä½œ (å¸¦ä¹è§‚æ›´æ–°ã€åŸ‹ç‚¹ã€å¥–åŠ±åé¦ˆ)
async function runAction(action, button = null) {
  if (!action || typeof action !== "object") return;

  // åŸ‹ç‚¹: ç‚¹å‡»
  const startTime = Date.now();
  trackEvent('action_click', {
    action_type: action.type,
    task_id: action.task_id,
    source: button?.closest('.msg') ? 'chat' : (button?.closest('.ui-card') ? 'bento' : 'unknown'),
  });

  // äºŒæ¬¡ç¡®è®¤æ£€æŸ¥
  const confirmed = await checkActionConfirm(action);
  if (!confirmed) {
    trackEvent('action_cancelled', { action_type: action.type });
    return;
  }

  // æœ¬åœ°åŠ¨ä½œ (ä¸éœ€è¦ API)
  if (action.type === "open_panel") {
    const panel = action.panel || "bento";
    if (panel === "settings") openSettings();
    else if (panel === "tools") openTools();
    else openBento();
    trackEvent('action_complete', { action_type: action.type, latency_ms: Date.now() - startTime });
    return;
  }

  if (action.type === "opt_out") {
    pushMsg("bot", "å¥½çš„ï¼Œå…ˆä¸æ‰“æ‰°ã€‚");
    trackEvent('action_complete', { action_type: action.type, latency_ms: Date.now() - startTime });
    return;
  }

  if (action.type === "send_message" && action.message) {
    await sendChatWithLoading(action.message);
    trackEvent('action_complete', { action_type: action.type, latency_ms: Date.now() - startTime });
    return;
  }

  // API åŠ¨ä½œ
  const endpoint = getActionEndpoint(action);
  if (!endpoint) {
    console.warn('Unknown action type:', action.type);
    return;
  }

  // ä¹è§‚æ›´æ–°: æŒ‰é’®çŠ¶æ€
  let originalButtonState = null;
  if (button) {
    originalButtonState = {
      text: button.textContent,
      disabled: button.disabled,
      className: button.className,
    };
    button.disabled = true;
    button.classList.add('loading');
  }

  try {
    const idempotencyKey = button?.dataset.idempotencyKey || generateIdempotencyKey(action);
    const result = await apiJson(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Idempotency-Key": idempotencyKey,
        ...csrfHeaders(),
      },
      body: JSON.stringify(getActionBody(action)),
    });

    // åŸ‹ç‚¹: å®Œæˆ
    trackEvent('action_complete', {
      action_type: action.type,
      task_id: action.task_id,
      latency_ms: Date.now() - startTime,
      rewards: result.rewards,
    });

    // å¥–åŠ±åé¦ˆ
    if (result.rewards && (result.rewards.aura_earned || result.rewards.new_streak)) {
      showRewardToast(result.rewards);
    }

    // åˆ·æ–°ç›¸å…³æ•°æ®
    if (['start_task', 'schedule_task', 'done_task'].includes(action.type)) {
      await loadActions();
    }

    return result;

  } catch (err) {
    // å›æ»šæŒ‰é’®çŠ¶æ€
    if (button && originalButtonState) {
      button.textContent = originalButtonState.text;
      button.disabled = originalButtonState.disabled;
      button.className = originalButtonState.className;
    }

    // åŸ‹ç‚¹: é”™è¯¯
    trackEvent('action_error', {
      action_type: action.type,
      task_id: action.task_id,
      error_code: err.code,
      error_message: err.message,
    });

    throw err;
  }
}

// å¥–åŠ± Toast æ˜¾ç¤º
function showRewardToast(rewards) {
  const quietMode = localStorage.getItem('reward_quiet_mode') === 'true';

  if (quietMode) {
    // ç®€æ´æ¨¡å¼
    showMinimalToast(`+${rewards.aura_earned || 0} Aura`);
    return;
  }

  // å®Œæ•´æ¨¡å¼
  const toast = document.getElementById('reward-toast');
  if (!toast) return;

  const detailEl = toast.querySelector('.reward-detail');
  if (detailEl) {
    let text = '';
    if (rewards.aura_earned) text += `+${rewards.aura_earned} Aura`;
    if (rewards.new_streak) text += ` Â· è¿ç»­æˆé•¿ ${rewards.new_streak} å¤©`;
    if (rewards.dimension_changes) {
      // ç»´åº¦å˜åŒ–
      for (const [dim, change] of Object.entries(rewards.dimension_changes)) {
        text += ` Â· ${dim} ${change > 0 ? '+' : ''}${change}`;
      }
    }
    detailEl.textContent = text;
  }

  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// ç®€æ´ Toast
function showMinimalToast(message) {
  const existing = document.querySelector('.minimal-toast');
  if (existing) existing.remove();

  const toast = document.createElement('div');
  toast.className = 'minimal-toast';
  toast.textContent = message;
  document.body.appendChild(toast);

  requestAnimationFrame(() => toast.classList.add('show'));
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

function wireActions(container) {
  // Wire action buttons
  container?.querySelectorAll(".a2ui-btn")?.forEach((btn) => {
    btn.addEventListener("click", async () => {
      try {
        const action = JSON.parse(btn.getAttribute("data-action") || "{}");
        await runAction(action, btn);  // ä¼ é€’ button å¼•ç”¨

        // Mark as processed
        if (btn.classList.contains("a2ui-list-item-clickable")) {
          btn.classList.add("a2ui-list-item-processed");
          btn.classList.remove("a2ui-list-item-clickable");
          const contentDiv = btn.querySelector(".a2ui-list-content");
          if (contentDiv) {
            const checkSpan = document.createElement("span");
            checkSpan.className = "a2ui-list-check";
            checkSpan.textContent = " âœ“";
            contentDiv.appendChild(checkSpan);
          }
        } else {
          btn.textContent = "å·²å¤„ç†";
        }
        btn.disabled = true;
        btn.classList.remove('loading');
      } catch (err) {
        btn.classList.remove('loading');
        pushMsg("bot", "åŠ¨ä½œæ‰§è¡Œå¤±è´¥ï¼š" + String(err?.message || err));
      }
    });
  });

  // Wire quick replies - å¡«å……ä¸å‘é€
  container?.querySelectorAll(".a2ui-quick-reply")?.forEach((chip) => {
    chip.addEventListener("click", () => {
      const reply = chip.getAttribute("data-reply") || "";
      if (reply) {
        const input = document.getElementById("ask-text");
        if (input) {
          input.value = reply;
          input.focus();
        }
      }
    });
  });

  // Wire more toggle
  container?.querySelectorAll(".a2ui-more-toggle")?.forEach((toggle) => {
    toggle.addEventListener("click", () => {
      const dropdown = toggle.nextElementSibling;
      const expanded = toggle.getAttribute("aria-expanded") === "true";
      toggle.setAttribute("aria-expanded", String(!expanded));
      toggle.textContent = expanded ? "æ›´å¤š â–¾" : "æ”¶èµ· â–´";
      if (dropdown) dropdown.hidden = expanded;
    });
  });
}

const chatState = {
  sessionId: null,
};

let userProfile = null;
let userPreferences = null;

async function loadSessions() {
  const list = $("#session-list");
  if (!list) return;
  list.innerHTML = "";
  const q = ($("#session-search")?.value || "").trim();
  let data;
  try {
    data = await apiJson(`/api/session/list?limit=60`);
  } catch (_e) {
    return;
  }
  const sessions = (data.sessions || []).filter((s) => {
    if (!q) return true;
    const t = (s.title || "") + " " + (s.preview || "");
    return t.toLowerCase().includes(q.toLowerCase());
  });
  sessions.forEach((s) => {
    const item = document.createElement("div");
    item.className = "ui-session-item";
    item.innerHTML = `<div class="title">${escapeHtml(s.title || "æ–°å¯¹è¯")}</div><div class="sub">${escapeHtml(
      (s.preview || "").slice(0, 120)
    )}</div>`;
    item.addEventListener("click", async () => {
      try {
        await loadSession(String(s.session_id));
        closeDrawer();
      } catch (err) {
        pushMsg("bot", "åŠ è½½ä¼šè¯å¤±è´¥ï¼š" + String(err?.message || err));
      }
    });
    list.appendChild(item);
  });
}

async function loadSession(sessionId) {
  const data = await apiJson(`/api/session/${encodeURIComponent(sessionId)}?limit=200`);
  const msgs = data.messages || [];
  $("#thread").innerHTML = "";
  chatState.sessionId = sessionId;
  msgs.forEach((m) => {
    if (m.role === "user") {
      pushMsg("user", escapeHtml(m.content || ""));
      return;
    }
    const a2ui = m.a2ui;
    if (a2ui && a2ui.ui_components) {
      const rendered = renderA2UI(a2ui);
      const div = pushMsg("bot", rendered.html, "card");
      wireActions(div);
    } else {
      pushMsg("bot", md(m.content || ""), "card");
    }
  });
}

async function sendChat(text) {
  const q = (text || "").trim();
  if (!q) return;
  pushMsg("user", escapeHtml(q));
  $("#ask-text").value = "";
  const skel = pushMsg("bot", "&nbsp;", "skel");
  try {
    const data = await apiJson("/api/chat/send", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...csrfHeaders() },
      body: JSON.stringify({ session_id: chatState.sessionId, text: q }),
    });
    if (data.session_id) chatState.sessionId = data.session_id;
    const a2ui = data?.assistant_message?.a2ui;
    const rendered = renderA2UI(a2ui);
    skel.classList.remove("skel");
    skel.classList.add("card");
    setMsgContent(skel, rendered.html || "ï¼ˆæ— å†…å®¹ï¼‰");
    wireActions(skel);
    await loadSessions();
  } catch (err) {
    skel.classList.remove("skel");
    setMsgContent(skel, "è¯·æ±‚å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err)));
  }
}

async function loadToday() {
  const box = $("#today-content");
  if (!box) return;
  box.innerHTML = "åŠ è½½ä¸­â€¦";
  try {
    const data = await apiJson("/api/bento/today");
    const a2ui = data.a2ui || {};
    const rendered = renderA2UI(a2ui);
    box.innerHTML = rendered.html;
    wireActions(box);
  } catch (err) {
    box.innerHTML = "åŠ è½½å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err));
  }
}

async function loadActions() {
  const box = $("#actions-content");
  if (!box) return;
  box.innerHTML = "åŠ è½½ä¸­â€¦";
  try {
    const data = await apiJson("/api/bento/actions");
    const tasks = data.tasks || [];
    if (!tasks.length) {
      box.innerHTML = `<div class="ui-task__meta">æš‚æ— ä»»åŠ¡ã€‚ä½ å¯ä»¥å…ˆä»ã€Œä»Šæ—¥æŒ‡å¼•ã€å¼€å§‹ã€‚</div>`;
      return;
    }
    box.innerHTML = tasks
      .map((t) => {
        const title = escapeHtml(t.title || "");
        const status = escapeHtml(t.status || "");
        const id = escapeHtml(t.task_id || "");
        const btns = [];
        if (status === "suggested") {
          btns.push(`<button class="ui-btn ui-btn-ghost mini" data-act='${escapeHtml(
            JSON.stringify({ type: "start_task", task_id: t.task_id })
          )}'>å¼€å§‹</button>`);
          btns.push(`<button class="ui-btn ui-btn-ghost mini" data-act='${escapeHtml(
            JSON.stringify({ type: "schedule_task", task_id: t.task_id })
          )}'>åŠ å…¥ä»Šæ—¥</button>`);
        }
        if (status === "active") {
          btns.push(`<button class="ui-btn ui-btn-ghost mini" data-act='${escapeHtml(
            JSON.stringify({ type: "done_task", task_id: t.task_id })
          )}'>å®Œæˆ</button>`);
        }
        return `<div class="ui-task"><div><div>${title}</div><div class="ui-task__meta">${status} Â· ${id.slice(
          0,
          8
        )}</div></div><div style="display:flex;gap:6px;flex-wrap:wrap">${btns.join("")}</div></div>`;
      })
      .join("");
    box.querySelectorAll("button[data-act]")?.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const act = JSON.parse(btn.getAttribute("data-act") || "{}");
        await runAction(act);
        btn.textContent = "å·²å¤„ç†";
        btn.disabled = true;
      });
    });
  } catch (err) {
    box.innerHTML = "åŠ è½½å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err));
  }
}

async function loadPlan() {
  const box = $("#plan-content");
  if (!box) return;
  box.innerHTML = "åŠ è½½ä¸­â€¦";
  try {
    const data = await apiJson("/api/plan/active");
    const enrollment = data.enrollment;
    if (!enrollment) {
      const list = await apiJson("/api/plan/list");
      const plans = list.plans || [];
      box.innerHTML =
        `<div class="ui-task__meta">è¿˜æ²¡æœ‰åŠ å…¥è®¡åˆ’ã€‚é€‰ä¸€ä¸ªæœ€å°å¯åšæŒçš„ï¼š</div>` +
        plans
          .map(
            (p) =>
              `<div class="ui-task"><div><div><strong>${escapeHtml(p.name)}</strong></div><div class="ui-task__meta">${escapeHtml(
                p.theory
              )} Â· ${escapeHtml(String(p.duration_days))} å¤©</div></div><div><button class="ui-btn ui-btn-ghost mini" data-plan="${escapeHtml(
                p.plan_id
              )}">åŠ å…¥</button></div></div>`
          )
          .join("");
      box.querySelectorAll("button[data-plan]")?.forEach((btn) => {
        btn.addEventListener("click", async () => {
          const pid = btn.getAttribute("data-plan");
          await apiJson("/api/plan/join", {
            method: "POST",
            headers: { "Content-Type": "application/json", ...csrfHeaders() },
            body: JSON.stringify({ plan_id: pid }),
          });
          await loadPlan();
          await loadToday();
        });
      });
      return;
    }
    const today = data.today || {};
    const day = today.day || {};
    const dayNo = today.day_no || enrollment.current_day || 1;
    box.innerHTML = `<div><strong>${escapeHtml(enrollment.name || "")}</strong> Â· Day ${escapeHtml(String(dayNo))}</div>
      <div class="ui-task__meta" style="margin-top:6px">${escapeHtml(day.title || "")}</div>
      <div style="margin-top:10px">${md(day.instruction || "")}</div>
      <div class="actions" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="ui-btn ui-btn-ghost" id="plan-done">æˆ‘å®Œæˆäº†</button>
      </div>`;
    $("#plan-done")?.addEventListener("click", async () => {
      await apiJson("/api/plan/record", {
        method: "POST",
        headers: { "Content-Type": "application/json", ...csrfHeaders() },
        body: JSON.stringify({ enrollment_id: enrollment.enrollment_id, day_no: dayNo, completed: true, note: "" }),
      });
      pushMsg("bot", "å·²è®°å½•å®Œæˆ âœ…", "card");
      await loadPlan();
      await loadActions();
    });
  } catch (err) {
    box.innerHTML = "åŠ è½½å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err));
  }
}

function openReader(title, html) {
  // reader panel removed; reuse viewer
  setViewer(title || "ç»“æœ", html || "");
}

async function pollPush() {
  try {
    if (document.visibilityState !== "visible") return;
    const data = await apiJson("/api/push/inbox?limit=3");
    const events = data.events || [];
    for (const ev of events) {
      const payload = ev.payload || {};
      const a2ui = payload.a2ui;
      if (a2ui && a2ui.ui_components) {
        const rendered = renderA2UI(a2ui);
        const div = pushMsg("bot", rendered.html, "card");
        wireActions(div);
      } else {
        pushMsg("bot", `æé†’ï¼š${escapeHtml(JSON.stringify(payload).slice(0, 240))}`, "card");
      }
    }
  } catch (_e) {}
}

async function initAuthAndProfile() {
  const me = await apiJson("/api/auth/me");
  const profileData = await apiJson("/api/user/profile");
  const profile = profileData.profile || {};
  const prefs = profileData.preferences || {};
  userProfile = profile;
  userPreferences = prefs;

  const b = String(profile.birthday_local || "");
  const [birthDate, birthTime] = b.includes(" ") ? b.split(" ") : [b, ""];
  const pillName = $("#pill-name");
  const pillBirth = $("#pill-birth");
  const pillLoc = $("#pill-loc");
  if (pillName) pillName.textContent = profile.name || me.name || "â€”";
  if (pillBirth) pillBirth.textContent = birthDate ? (birthTime ? `${birthDate} ${birthTime}` : birthDate) : "â€”";
  if (pillLoc) pillLoc.textContent = profile.location?.name || "â€”";

  const persona = prefs.persona_style || me.persona_style || "warm";
  $("#persona-style").value = persona;
  $("#prefs-form select[name=\"persona_style\"]").value = persona;
  $("#prefs-form select[name=\"push_enabled\"]").value = String(prefs.push_enabled ?? true);
  $("#prefs-form input[name=\"push_time\"]").value = prefs.push_time || "08:00:00";
  $("#prefs-form input[name=\"quiet_hours_start\"]").value = prefs.quiet_hours_start || "22:00:00";
  $("#prefs-form input[name=\"quiet_hours_end\"]").value = prefs.quiet_hours_end || "07:00:00";
}

function isoToBirthdayLocal(iso) {
  const s = String(iso || "").trim();
  if (!s.includes("T")) return null;
  const [d, t0] = s.split("T");
  const t = t0.replace(/Z$/, "").replace(/[+-].*$/, "");
  const parts = t.split(":");
  const hh = parts[0] || "00";
  const mm = parts[1] || "00";
  const ss = parts[2] || "00";
  return `${d} ${hh}:${mm}:${ss}`;
}

async function rectifyStream(reqPayload) {
  const res = await fetch("/api/rectify/stream", {
    method: "POST",
    headers: { "Content-Type": "application/json", ...csrfHeaders() },
    body: JSON.stringify(reqPayload),
  });
  if (!res.ok || !res.body) throw new Error("rectify_failed");
  const reader = res.body.getReader();
  const dec = new TextDecoder("utf-8");
  let buf = "";
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    buf += dec.decode(value, { stream: true });
    const parts = buf.split("\n\n");
    buf = parts.pop() || "";
    for (const part of parts) {
      const line = part.split("\n").find((l) => l.startsWith("data:"));
      if (!line) continue;
      const js = line.slice(5).trim();
      if (!js) continue;
      let msg;
      try {
        msg = JSON.parse(js);
      } catch (_e) {
        continue;
      }
      if (msg.type === "progress" || msg.type === "coarse" || msg.type === "refine") {
        setViewer("å‡ºç”Ÿæ ¡å‡†", `<div class="ui-task__meta">æ ¡å‡†è¿›è¡Œä¸­ï¼š${escapeHtml(String(msg.stage || msg.type || ""))}â€¦</div>`);
      }
      if (msg.type === "done") {
        const bestLocal = msg.best_local_time || msg.best?.local_time || msg.best?.local_time || "";
        const bLocal = isoToBirthdayLocal(bestLocal);
        setViewer(
          "å‡ºç”Ÿæ ¡å‡†",
          `<strong>æ ¡å‡†å®Œæˆ</strong><br/>å»ºè®®æœ¬åœ°æ—¶é—´ï¼š<code>${escapeHtml(String(bestLocal || ""))}</code>${
            bLocal ? `<div class="actions" style="margin-top:10px"><button class="ui-btn ui-btn-primary" id="btn-apply-rectify">é‡‡çº³åˆ° Profile</button></div>` : ""
          }`
        );
        $("#btn-apply-rectify")?.addEventListener("click", async () => {
          if (!userProfile) return;
          const payload = {
            name: userProfile.name,
            gender: userProfile.gender,
            birthday_local: bLocal,
            tz_offset_hours: userProfile.tz_offset_hours,
            location: userProfile.location,
          };
          await apiJson("/api/user/profile", {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...csrfHeaders() },
            body: JSON.stringify(payload),
          });
          userProfile = { ...userProfile, birthday_local: bLocal };
          const pillBirth = $("#pill-birth");
          if (pillBirth) pillBirth.textContent = bLocal;
          setViewer("å‡ºç”Ÿæ ¡å‡†", `<strong>å·²é‡‡çº³</strong><div class="ui-task__meta">Profile å·²æ›´æ–°ï¼Œå¹¶é‡ç®—å…«å­— facts âœ…</div>`);
        });
      }
      if (msg.type === "error") {
        setViewer("å‡ºç”Ÿæ ¡å‡†", `æ ¡å‡†å¤±è´¥ï¼š${escapeHtml(String(msg.detail || "rectify_failed"))}`);
      }
    }
  }
}

// Wiring
$("#session-drawer-open")?.addEventListener("click", () => {
  openDrawer();
  loadSessions();
});
$("#session-drawer-close")?.addEventListener("click", closeDrawer);
$("#session-drawer-overlay")?.addEventListener("click", closeDrawer);
$("#session-search")?.addEventListener("input", loadSessions);
$("#session-new")?.addEventListener("click", async () => {
  $("#thread").innerHTML = "";
  chatState.sessionId = null;
  closeDrawer();
  await loadSessions();
  $("#ask-text")?.focus();
});

$$(".ui-tab")?.forEach((btn) =>
  btn.addEventListener("click", () => {
    setActiveTab(btn.dataset.panel);
  })
);

$("#open-bento")?.addEventListener("click", openBento);
$("#open-settings")?.addEventListener("click", openSettings);
$("#mobile-tab-chat")?.addEventListener("click", () => setMobileTab("chat"));
$("#mobile-tab-workbench")?.addEventListener("click", () => setMobileTab("workbench"));

// å…³é—­åŠŸèƒ½åŒºæŒ‰é’®
$("#close-bento")?.addEventListener("click", closeBento);

// ç»“æœåŒºæ¸…ç©º
$("#result-clear")?.addEventListener("click", () => {
  const stack = $("#result-stack");
  if (stack) stack.innerHTML = "";
  resultCards.clear();
  _currentViewerTaskId = null;
  updateResultEmptyState();
});

// ç§»åŠ¨ç«¯æ”¹ä¸º Tabs åˆ‡æ¢ï¼Œä¸å†ä½¿ç”¨é®ç½©å…³é—­

$("#logout")?.addEventListener("click", async () => {
  await apiJson("/api/auth/logout", { method: "POST", headers: { ...csrfHeaders() } }).catch(() => {});
  location.href = "/login";
});

$("#logout-all")?.addEventListener("click", async () => {
  await apiJson("/api/auth/logout-all", { method: "POST", headers: { ...csrfHeaders() } });
  location.href = "/login";
});

$("#delete-account")?.addEventListener("click", async () => {
  const password = prompt("è¯·è¾“å…¥å¯†ç ä»¥ç¡®è®¤æ³¨é”€ï¼š") || "";
  if (!password.trim()) return;
  await apiJson("/api/auth/account", {
    method: "DELETE",
    headers: { "Content-Type": "application/json", ...csrfHeaders() },
    body: JSON.stringify({ password }),
  });
  location.href = "/login";
});

$("#password-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  await apiJson("/api/auth/password", {
    method: "PUT",
    headers: { "Content-Type": "application/json", ...csrfHeaders() },
    body: JSON.stringify({ old_password: fd.get("old_password") || "", new_password: fd.get("new_password") || "" }),
  });
  alert("å¯†ç å·²æ›´æ–°ï¼Œè¯·é‡æ–°ç™»å½•ã€‚");
  location.href = "/login";
});

$("#prefs-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  await apiJson("/api/user/preferences", {
    method: "PUT",
    headers: { "Content-Type": "application/json", ...csrfHeaders() },
    body: JSON.stringify({
      persona_style: fd.get("persona_style"),
      chat_backend: fd.get("chat_backend") || "fastapi",
      push_enabled: String(fd.get("push_enabled")) === "true",
      push_time: fd.get("push_time"),
      quiet_hours_start: fd.get("quiet_hours_start"),
      quiet_hours_end: fd.get("quiet_hours_end"),
    }),
  });
  $("#persona-style").value = String(fd.get("persona_style") || "warm");
  alert("å·²ä¿å­˜");
});

$("#persona-style")?.addEventListener("change", async (e) => {
  const style = e.target.value;
  await apiJson("/api/user/preferences", {
    method: "PUT",
    headers: { "Content-Type": "application/json", ...csrfHeaders() },
    body: JSON.stringify({ persona_style: style }),
  });
  $("#prefs-form select[name=\"persona_style\"]").value = style;
});

// ask-form submit handler moved to bottom after sendChatWithLoading is defined

$("#reload-today")?.addEventListener("click", loadToday);
$("#reload-actions")?.addEventListener("click", loadActions);
$("#reload-plan")?.addEventListener("click", loadPlan);

$("#checkin-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  startNewTask(); // Reset task id for new result card
  const fd = new FormData(e.target);
  try {
    const data = await apiJson("/api/bento/checkin", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...csrfHeaders() },
      body: JSON.stringify({
        mood: fd.get("mood") || "",
        intensity: Number(fd.get("intensity") || 0),
        note: fd.get("note") || "",
      }),
    });
    const a2ui = data.a2ui || {};
    setViewerA2UI("æƒ…ç»ªæ‰“å¡", a2ui);
    e.target.reset();
    await loadActions();
  } catch (err) {
    setViewer("æƒ…ç»ªæ‰“å¡", "æ‰“å¡å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err)));
  }
});

$("#decision-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const question = String(fd.get("question") || "").trim();
  const options = String(fd.get("options") || "").trim();
  const msg = `è¯·ä½ ç”¨ Decision Brief å¸®æˆ‘æŠŠé—®é¢˜å˜æˆå¯æ‰§è¡Œå®éªŒï¼ˆäººç”Ÿå¯¼èˆª/é™ªä¼´/æå‡ï¼‰ã€‚\\n\\nã€é—®é¢˜ã€‘\\n${question}\\n\\nã€é€‰é¡¹ã€‘\\n${options}\\n\\nè¯·è¾“å‡ºï¼šOptions/Constraints/Risks/Next Experimentï¼Œå¹¶ç»™â‰¤3æ¡è¡ŒåŠ¨å¤„æ–¹+æ‰¿è¯ºé‚€è¯·ã€‚`;
  await sendChat(msg);
  openBento();
});

$("#script-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const scene = String(fd.get("scene") || "");
  const target = String(fd.get("target") || "");
  const goal = String(fd.get("goal") || "");
  const msg = `è¯·ä»¥ç§¯æå¿ƒç†å­¦/Performance Coach é£æ ¼ï¼Œå¸®æˆ‘ç”Ÿæˆå¯å¤åˆ¶çš„è¯æœ¯æ¨¡æ¿ã€‚\\n\\nã€åœºæ™¯ã€‘${scene}\\nã€å¯¹è±¡ã€‘${target}\\nã€ç›®æ ‡ã€‘${goal}\\n\\nè¦æ±‚ï¼šå…ˆå…±æƒ…â†’å†ç»™ç»“æ„â†’ç»™ä¸‰æ®µå¼è¯æœ¯ï¼ˆå¼€åœº/è¡¨è¾¾/è¯·æ±‚æˆ–è¾¹ç•Œï¼‰â†’ç»™ä¸€ä¸ªæœ€å°æ‰¿è¯ºåŠ¨ä½œã€‚`;
  await sendChat(msg);
  openBento();
});

$("#report-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  startNewTask(); // Reset task id for new result card
  const fd = new FormData(e.target);
  const backend = String(fd.get("backend") || "cli");
  const model = String(fd.get("model") || "standard");
  const system_prompt = String(fd.get("system_prompt") || "");
  setViewerProgress("å…«å­—æ·±åº¦æŠ¥å‘Š", 4, 1, `æäº¤è¯·æ±‚ (backend=${backend})...`);
  try {
    const data = await apiJson("/api/report/bazi/submit", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...csrfHeaders() },
      body: JSON.stringify({ backend, model, system_prompt }),
    });
    const jobId = data.job_id;
    const usedBackend = data.backend || backend;
    setViewerProgress("å…«å­—æ·±åº¦æŠ¥å‘Š", 4, 2, `ä»»åŠ¡ #${jobId} æ’é˜Ÿä¸­...`);

    let pollCount = 0;
    const poll = async () => {
      const j = await apiJson(`/api/report/bazi/${encodeURIComponent(jobId)}?backend=${encodeURIComponent(usedBackend)}`);
      if (j.status === "processing") {
        pollCount++;
        const step = Math.min(3, 2 + Math.floor(pollCount / 3));
        const messages = ["åˆ†æå‘½ç›˜...", "è®¡ç®—å¤§è¿æµå¹´...", "ç”ŸæˆæŠ¥å‘Šå†…å®¹..."];
        setViewerProgress("å…«å­—æ·±åº¦æŠ¥å‘Š", 4, step, messages[step - 2] || "å¤„ç†ä¸­...");
        setTimeout(poll, 1500);
        return;
      }
      if (j.status === "completed") {
        setViewerProgress("å…«å­—æ·±åº¦æŠ¥å‘Š", 4, 4, "å®Œæˆï¼");
        setTimeout(() => {
          const a2ui = j.a2ui || j.a2ui_data;
          if (a2ui?.ui_components?.length) {
            setViewerA2UI(`æŠ¥å‘Š #${jobId}`, a2ui);
          } else {
            setViewerMarkdown(`æŠ¥å‘Š #${jobId}`, String(j.content || ""));
          }
        }, 500);
        return;
      }
      setViewer("å…«å­—æ·±åº¦æŠ¥å‘Š", `ä»»åŠ¡ #${escapeHtml(String(jobId))} å¼‚å¸¸ï¼š${escapeHtml(String(j.message || j.error || "unknown"))}`);
    };
    poll();
  } catch (err) {
    setViewer("å…«å­—æ·±åº¦æŠ¥å‘Š", "æäº¤å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err)));
  }
});

$("#rectify-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  startNewTask(); // Reset task id for new result card
  if (!userProfile) {
    setViewer("å‡ºç”Ÿæ ¡å‡†", "æœªåŠ è½½åˆ° Profileï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚");
    return;
  }
  const fd = new FormData(e.target);
  const eventsStr = String(fd.get("events") || "");
  const window_start = String(fd.get("window_start") || "00:00:00");
  const window_end = String(fd.get("window_end") || "23:59:59");

  const b = String(userProfile.birthday_local || "");
  const birthDate = b.includes(" ") ? b.split(" ")[0] : b;
  const lines = eventsStr.split("\n").map((l) => l.trim()).filter(Boolean);
  const events = lines.map((line) => {
    const [type, date, impact] = line.split(",");
    const o = { type: (type || "").trim(), date: (date || "").trim() };
    if (impact) o.impact = impact.trim();
    return o;
  });

  const reqPayload = {
    name: userProfile.name || "â€”",
    birthday: birthDate || "1990-01-01",
    window_start,
    window_end,
    tz_offset_hours: userProfile.tz_offset_hours || 8,
    latitude: userProfile.location?.latitude,
    longitude: userProfile.location?.longitude,
    events,
    debug: false,
  };

  setViewerIndeterminate("å‡ºç”Ÿæ ¡å‡†", "æ­£åœ¨åˆ†æäº‹ä»¶ä¸å‘½ç›˜...");
  try {
    await rectifyStream(reqPayload);
  } catch (err) {
    setViewer("å‡ºç”Ÿæ ¡å‡†", "æ ¡å‡†å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err)));
  }
});

$("#tieban-form")?.addEventListener("submit", async (e) => {
  e.preventDefault();
  startNewTask(); // Reset task id for new result card
  if (!userProfile) {
    setViewer("é“æ¿ç¥ç®—", "æœªåŠ è½½åˆ° Profileï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚");
    return;
  }
  const fd = new FormData(e.target);
  const known_facts = Object.fromEntries(fd.entries());

  const b = String(userProfile.birthday_local || "");
  const [birthDate, birthTimeRaw] = b.includes(" ") ? b.split(" ") : [b, ""];
  const birthTime = birthTimeRaw || "00:00:00";

  const initReq = {
    name: userProfile.name || "â€”",
    gender: userProfile.gender || "ç”·",
    date: birthDate || "1990-01-01",
    time: birthTime,
    tz_offset_hours: userProfile.tz_offset_hours || 8,
    location_name: userProfile.location?.name,
    longitude: userProfile.location?.longitude,
    latitude: userProfile.location?.latitude,
    known_facts,
    ruleset_names: ["ppx_v6"],
  };

  setViewerProgress("é“æ¿ç¥ç®—", 3, 1, "æ­£åœ¨ç”Ÿæˆå‘½ä¹¦å€™é€‰...");
  try {
    const res = await fetch("/api/tieban/init", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(initReq) });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.detail || "tieban_init_failed");
    if ((data.candidates || []).length) {
      setViewerProgress("é“æ¿ç¥ç®—", 3, 2, "å·²ç”Ÿæˆå€™é€‰ï¼Œè¯·ç¡®è®¤...");
      const first = data.candidates[0];
      setTimeout(() => {
        setViewer(
          "é“æ¿ç¥ç®—",
          `<strong>å‘½ä¹¦å€™é€‰</strong><br/>base=${escapeHtml(String(first.base))} ke=${escapeHtml(String(first.ke))}ï¼ˆé¢„è§ˆï¼‰<div class="actions" style="margin-top:10px"><button class="ui-btn ui-btn-primary" id="btn-tieban-lock">é”å®šè¯¥å€™é€‰</button></div>`
        );
        $("#btn-tieban-lock")?.addEventListener("click", async () => {
          setViewerProgress("é“æ¿ç¥ç®—", 3, 3, "æ­£åœ¨é”å®šå‘½ä¹¦...");
          try {
            const r = await fetch("/api/tieban/select", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ run_id: data.run_id, candidate_id: first.candidate_id, state_version: data.state_version }),
            });
            const j = await r.json();
            if (!r.ok) throw new Error(j?.detail || "tieban_select_failed");
            if (j.status === "LOCKED" && j.report) {
              const sum = (j.report.sections?.[0]?.content || "").toString();
              setViewer(
                "é“æ¿ç¥ç®—",
                `<strong>å·²é”å®š</strong> Â· base=${escapeHtml(String(j.report.locked_base))} ke=${escapeHtml(String(j.report.true_ke))}<div class="ui-task__meta">context=${escapeHtml(
                  String(j.report.locked_context_id)
                )}</div><div style="margin-top:6px;">${md(sum.slice(0, 360))}â€¦</div>`
              );
            } else {
              setViewer("é“æ¿ç¥ç®—", "é”å®šæˆåŠŸã€‚");
            }
          } catch (err) {
            setViewer("é“æ¿ç¥ç®—", "é”å®šå¤±è´¥ï¼š" + escapeHtml(String(err?.message || err)));
          }
        });
      }, 400);
    } else {
      setViewer("é“æ¿ç¥ç®—", "æœªæ‰¾åˆ°åˆé€‚å€™é€‰ï¼Œè¯·è¡¥å……äº‹å®åé‡è¯•ã€‚");
    }
  } catch (err) {
    setViewer("é“æ¿ç¥ç®—", "ç”Ÿæˆå¤±è´¥ï¼š" + escapeHtml(String(err?.message || err)));
  }
});

// Viewer buttons removed; results now render in the right dock.

// ========== Card Collapse/Expand Toggle ==========
function initCardToggles() {
  $$(".ui-card__toggle").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const card = btn.closest(".ui-card");
      if (!card) return;
      card.classList.toggle("collapsed");
      // Update aria-expanded
      const isExpanded = !card.classList.contains("collapsed");
      btn.setAttribute("aria-expanded", String(isExpanded));
    });
  });
}

// ========== Send Button Loading State ==========
function setSendLoading(loading) {
  const btn = $("#ask-btn");
  if (!btn) return;
  if (loading) {
    btn.classList.add("loading");
    btn.disabled = true;
  } else {
    btn.classList.remove("loading");
    btn.disabled = false;
  }
}

// ========== Mobile Bottom Sheet Gestures ==========
const bottomSheet = {
  el: null,
  startY: 0,
  startTranslate: 0,
  currentTranslate: 0,
  isDragging: false,
  velocity: 0,
  lastY: 0,
  lastTime: 0,
  states: ["closed", "peek", "open"],
  currentState: "closed",

  init() {
    this.el = $(".ui-workbench");
    if (!this.el || window.innerWidth > 1080) return;

    // Add drag handle touch events
    const handle = this.el.querySelector("::before") || this.el;
    this.el.addEventListener("touchstart", this.onTouchStart.bind(this), { passive: true });
    this.el.addEventListener("touchmove", this.onTouchMove.bind(this), { passive: false });
    this.el.addEventListener("touchend", this.onTouchEnd.bind(this), { passive: true });

    // Backdrop click to close
    const backdrop = $(".ui-backdrop");
    if (backdrop) {
      backdrop.addEventListener("click", () => this.setState("closed"));
    }
  },

  onTouchStart(e) {
    if (window.innerWidth > 1080) return;
    const touch = e.touches[0];
    // Only allow drag from top 60px area (handle area)
    const rect = this.el.getBoundingClientRect();
    if (touch.clientY - rect.top > 60) return;

    this.isDragging = true;
    this.startY = touch.clientY;
    this.lastY = touch.clientY;
    this.lastTime = Date.now();
    this.el.style.transition = "none";

    // Calculate current translate from state
    const viewportHeight = window.innerHeight;
    if (this.currentState === "open") {
      this.startTranslate = 0;
    } else if (this.currentState === "peek") {
      this.startTranslate = viewportHeight - 200;
    } else {
      this.startTranslate = viewportHeight;
    }
    this.currentTranslate = this.startTranslate;
  },

  onTouchMove(e) {
    if (!this.isDragging || window.innerWidth > 1080) return;
    const touch = e.touches[0];
    const deltaY = touch.clientY - this.startY;
    const now = Date.now();
    const dt = now - this.lastTime;

    // Calculate velocity
    if (dt > 0) {
      this.velocity = (touch.clientY - this.lastY) / dt;
    }
    this.lastY = touch.clientY;
    this.lastTime = now;

    // Calculate new translate
    const viewportHeight = window.innerHeight;
    this.currentTranslate = Math.max(0, Math.min(viewportHeight, this.startTranslate + deltaY));

    // Apply transform
    this.el.style.transform = `translateY(${this.currentTranslate}px)`;

    // Prevent scroll when dragging
    e.preventDefault();
  },

  onTouchEnd() {
    if (!this.isDragging || window.innerWidth > 1080) return;
    this.isDragging = false;
    this.el.style.transition = "";

    const viewportHeight = window.innerHeight;
    const threshold = viewportHeight * 0.3;
    const peekPosition = viewportHeight - 200;

    // Velocity-based decision
    if (Math.abs(this.velocity) > 0.5) {
      // Fast swipe
      if (this.velocity > 0) {
        // Swipe down
        if (this.currentTranslate > peekPosition * 0.5) {
          this.setState("closed");
        } else {
          this.setState("peek");
        }
      } else {
        // Swipe up
        if (this.currentTranslate < peekPosition) {
          this.setState("open");
        } else {
          this.setState("peek");
        }
      }
    } else {
      // Position-based decision
      if (this.currentTranslate < threshold) {
        this.setState("open");
      } else if (this.currentTranslate < viewportHeight - 100) {
        this.setState("peek");
      } else {
        this.setState("closed");
      }
    }
  },

  setState(state) {
    this.currentState = state;
    this.el.style.transform = "";

    document.body.classList.remove("show-bento", "show-bento-peek");

    if (state === "open") {
      document.body.classList.add("show-bento");
    } else if (state === "peek") {
      document.body.classList.add("show-bento-peek");
    }
  },
};

// Mobile bottom sheet is disabled; use tabs to switch views.

// ========== Enhanced Send Chat with Loading State ==========
const _originalSendChat = sendChat;
async function sendChatWithLoading(text) {
  const q = (text || "").trim();
  if (!q) return;

  setSendLoading(true);
  pushMsg("user", escapeHtml(q));
  $("#ask-text").value = "";
  const skel = pushMsg("bot", "&nbsp;", "skel");

  try {
    const data = await apiJson("/api/chat/send", {
      method: "POST",
      headers: { "Content-Type": "application/json", ...csrfHeaders() },
      body: JSON.stringify({ session_id: chatState.sessionId, text: q }),
    });
    if (data.session_id) chatState.sessionId = data.session_id;
    const a2ui = data?.assistant_message?.a2ui;
    const rendered = renderA2UI(a2ui);
    skel.classList.remove("skel");
    skel.classList.add("card");
    setMsgContent(skel, rendered.html || "ï¼ˆæ— å†…å®¹ï¼‰");
    wireActions(skel);
    await loadSessions();
  } catch (err) {
    skel.classList.remove("skel");
    setMsgContent(skel, "è¯·æ±‚å¤±è´¥ï¼š" + escapeHtml(String(err?.message || err)));
  } finally {
    setSendLoading(false);
  }
}

// ========== P0: æ™ºèƒ½è½®è¯¢å™¨ ==========
class SmartPoller {
  constructor(options) {
    this.baseInterval = options.interval || 60000;
    this.maxInterval = options.maxInterval || 300000;
    this.currentInterval = this.baseInterval;
    this.failCount = 0;
    this.isVisible = true;
    this.timer = null;
    this.fetchFn = null;

    document.addEventListener('visibilitychange', () => {
      this.isVisible = document.visibilityState === 'visible';
      if (this.isVisible) {
        this.resetInterval();
        this.poll();
      }
    });
  }

  async poll() {
    if (!this.isVisible || !this.fetchFn) return;

    try {
      await this.fetchFn();
      this.resetInterval();
    } catch (error) {
      this.backoff();
    }

    this.scheduleNext();
  }

  backoff() {
    this.failCount++;
    this.currentInterval = Math.min(
      this.baseInterval * Math.pow(2, this.failCount),
      this.maxInterval
    );
  }

  resetInterval() {
    this.failCount = 0;
    this.currentInterval = this.baseInterval;
  }

  scheduleNext() {
    if (this.timer) clearTimeout(this.timer);
    this.timer = setTimeout(() => this.poll(), this.currentInterval);
  }

  start(fetchFn) {
    this.fetchFn = fetchFn;
    this.poll();
  }

  stop() {
    if (this.timer) clearTimeout(this.timer);
  }
}

// å…¨å±€è½®è¯¢å™¨å®ä¾‹
const pushPoller = new SmartPoller({ interval: 60000, maxInterval: 300000 });
const jitaiPoller = new SmartPoller({ interval: 300000, maxInterval: 600000 });

// ========== P0: æ¸è¿›å¼åˆå§‹åŒ– ==========
async function initPage() {
  // é˜¶æ®µ1: å…³é”®æ•°æ® (Profile)
  try {
    await initAuthAndProfile();
  } catch (_e) {
    location.href = "/login";
    return;
  }

  // é˜¶æ®µ2: ä¸»è¦æ•°æ® (å¹¶è¡Œä½†ç‹¬ç«‹å¤„ç†é”™è¯¯)
  const mainPromises = [
    { key: 'sessions', fn: loadSessions, section: null },
    { key: 'today', fn: loadToday, section: 'today-content' },
    { key: 'actions', fn: loadActions, section: 'actions-content' },
    { key: 'plan', fn: loadPlan, section: 'plan-content' },
  ];

  // å…ˆè®¾ç½® loading çŠ¶æ€
  mainPromises.forEach(p => {
    if (p.section) setSectionState(p.section, ComponentState.LOADING);
  });

  // æ³¨å†Œé‡è¯•å¤„ç†å™¨
  mainPromises.forEach(p => {
    if (p.section) registerSectionRetry(p.section, p.fn);
  });

  // å¹¶è¡ŒåŠ è½½ï¼Œç‹¬ç«‹å¤„ç†é”™è¯¯
  const results = await Promise.allSettled(mainPromises.map(p => p.fn()));

  results.forEach((result, i) => {
    const { key, section } = mainPromises[i];
    if (result.status === 'rejected') {
      console.warn(`Failed to load ${key}:`, result.reason);
      // é”™è¯¯çŠ¶æ€ç”±å„ load å‡½æ•°å†…éƒ¨å¤„ç†
    }
  });

  // é˜¶æ®µ3: åå°æ•°æ® (é™é»˜å¤±è´¥)
  Promise.allSettled([
    pollPush(),
    loadJitaiInterventions(),
  ]).catch(() => {});

  // åˆå§‹åŒ– UI
  initCardToggles();
  updateResultEmptyState();
  initQuickPrompts();

  // ç§»åŠ¨ç«¯é€‚é…
  setMobileTab("chat");
  window.addEventListener("resize", () => {
    if (isMobile()) {
      if (!document.body.dataset.mobileTab) setMobileTab("chat");
    } else {
      delete document.body.dataset.mobileTab;
    }
  });

  // å¯åŠ¨è½®è¯¢
  pushPoller.start(pollPush);
  jitaiPoller.start(loadJitaiInterventions);
}

// åˆ·æ–°æ‰€æœ‰æ•°æ® (ç½‘ç»œæ¢å¤æ—¶è°ƒç”¨)
async function refreshAllData() {
  await Promise.allSettled([
    loadSessions(),
    loadToday(),
    loadActions(),
    loadPlan(),
  ]);
}

// åŠ è½½ JITAI å¹²é¢„
async function loadJitaiInterventions() {
  try {
    const data = await apiJson('/api/jitai/interventions');
    const interventions = data.interventions || [];

    // æ£€æŸ¥é¢‘æ§
    interventions.forEach(i => {
      if (shouldShowIntervention(i)) {
        showJitaiCard(i);
      }
    });
  } catch (e) {
    // é™é»˜å¤±è´¥
    console.warn('JITAI load failed:', e);
  }
}

// JITAI é¢‘æ§çŠ¶æ€
const _jitaiState = {
  lastShown: 0,
  hourHistory: [],
  dayHistory: [],
  quietUntil: parseInt(localStorage.getItem('jitai_quiet_until') || '0'),
};

const JITAI_LIMITS = {
  maxPerHour: 2,
  maxPerDay: 6,
  minInterval: 30 * 60 * 1000,
};

function shouldShowIntervention(intervention) {
  const now = Date.now();

  if (_jitaiState.quietUntil && now < _jitaiState.quietUntil) return false;
  if (_jitaiState.lastShown && now - _jitaiState.lastShown < JITAI_LIMITS.minInterval) return false;

  const hourCount = _jitaiState.hourHistory.filter(t => now - t < 3600000).length;
  if (hourCount >= JITAI_LIMITS.maxPerHour) return false;

  const dayStart = new Date().setHours(0,0,0,0);
  const dayCount = _jitaiState.dayHistory.filter(t => t >= dayStart).length;
  if (dayCount >= JITAI_LIMITS.maxPerDay) return false;

  return true;
}

function showJitaiCard(intervention) {
  const now = Date.now();
  _jitaiState.lastShown = now;
  _jitaiState.hourHistory.push(now);
  _jitaiState.dayHistory.push(now);

  // æ¸…ç†å†å²
  _jitaiState.hourHistory = _jitaiState.hourHistory.filter(t => now - t < 3600000);

  const card = document.createElement('div');
  card.className = 'jitai-card';
  card.dataset.interventionId = intervention.trigger_id;
  card.innerHTML = `
    <div class="jitai-card__content">
      <span class="jitai-icon">ğŸ’¡</span>
      <div class="jitai-text">
        <span class="jitai-title">${escapeHtml(intervention.content?.title || 'æé†’')}</span>
        <span class="jitai-body">${escapeHtml(intervention.content?.body || '')}</span>
      </div>
    </div>
    <div class="jitai-card__actions">
      <button class="ui-btn ui-btn-ghost jitai-action" data-action="click">æŸ¥çœ‹</button>
      <button class="jitai-control" data-action="snooze" title="ç¨åæé†’">â°</button>
      <button class="jitai-control" data-action="quiet_today" title="ä»Šå¤©ä¸å†æç¤º">ğŸ”•</button>
      <button class="jitai-control" data-action="dismiss" title="å…³é—­">âœ•</button>
    </div>
  `;

  // ç»‘å®šäº‹ä»¶
  card.querySelectorAll('[data-action]').forEach(btn => {
    btn.addEventListener('click', () => handleJitaiAction(intervention.trigger_id, btn.dataset.action, card));
  });

  // æ’å…¥åˆ°å¯¹è¯åŒºé¡¶éƒ¨
  const thread = document.getElementById('thread');
  if (thread) {
    thread.insertBefore(card, thread.firstChild);
  }
}

async function handleJitaiAction(interventionId, action, card) {
  switch (action) {
    case 'snooze':
      await apiJson(`/api/jitai/interventions/${interventionId}/dismiss`, { method: 'POST', headers: csrfHeaders() }).catch(() => {});
      card.remove();
      break;
    case 'quiet_today':
      const endOfDay = new Date().setHours(23, 59, 59, 999);
      _jitaiState.quietUntil = endOfDay;
      localStorage.setItem('jitai_quiet_until', String(endOfDay));
      card.remove();
      showMinimalToast('ä»Šå¤©ä¸å†æ˜¾ç¤ºæç¤º');
      break;
    case 'click':
      await apiJson(`/api/jitai/interventions/${interventionId}/click`, { method: 'POST', headers: csrfHeaders() }).catch(() => {});
      // TODO: æ˜¾ç¤ºè¯¦æƒ…
      card.remove();
      break;
    case 'dismiss':
      await apiJson(`/api/jitai/interventions/${interventionId}/dismiss`, { method: 'POST', headers: csrfHeaders() }).catch(() => {});
      card.remove();
      break;
  }
}

// ========== P1: å¿«æ·å…¥å£æƒ…å¢ƒåŒ– ==========
function initQuickPrompts() {
  const container = document.getElementById('quick-prompts');
  if (!container) return;

  const prompts = getContextualQuickPrompts();
  container.innerHTML = prompts.map(p => {
    if (p.action) {
      return `<button class="quick-prompt-chip" data-action='${escapeHtml(JSON.stringify(p.action))}'>${escapeHtml(p.label)}</button>`;
    }
    return `<button class="quick-prompt-chip" data-prompt="${escapeHtml(p.prompt)}">${escapeHtml(p.label)}</button>`;
  }).join('');

  // ç»‘å®šäº‹ä»¶
  container.querySelectorAll('.quick-prompt-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const action = chip.dataset.action;
      if (action) {
        runAction(JSON.parse(action));
        return;
      }
      const prompt = chip.dataset.prompt;
      if (prompt) {
        const input = document.getElementById('ask-text');
        if (input) {
          input.value = prompt;
          input.focus();
        }
      }
    });
  });
}

function getContextualQuickPrompts() {
  const prompts = [];

  // Profile å®Œæ•´åº¦
  if (userProfile && !userProfile.birthday_local) {
    prompts.push({
      label: 'å®Œå–„ä¿¡æ¯',
      action: { type: 'open_panel', panel: 'settings' },
      priority: 100,
    });
  }

  // é»˜è®¤é€‰é¡¹
  prompts.push(
    { label: 'ä»Šæ—¥è¿åŠ¿', prompt: 'å¸®æˆ‘åˆ†æä»Šå¤©çš„è¿åŠ¿å’Œæ³¨æ„äº‹é¡¹', priority: 50 },
    { label: 'æœ¬å‘¨è§„åˆ’', prompt: 'æ ¹æ®æˆ‘çš„å‘½ç›˜ï¼Œå¸®æˆ‘è§„åˆ’æœ¬å‘¨çš„é‡ç‚¹', priority: 40 },
    { label: 'æˆ‘çš„ä¼˜åŠ¿', prompt: 'åˆ†ææˆ‘çš„æ ¸å¿ƒä¼˜åŠ¿å’Œæœ€ä½³å‘å±•æ–¹å‘', priority: 30 },
    { label: 'æƒ…ç»ªæŒ‡å¼•', prompt: 'æˆ‘ç°åœ¨æƒ…ç»ªæœ‰äº›ä½è½ï¼Œç»™æˆ‘ä¸€äº›å»ºè®®', priority: 20 },
  );

  return prompts.sort((a, b) => (b.priority || 0) - (a.priority || 0)).slice(0, 4);
}

// Init
initPage();

// Send form with loading state
$("#ask-form")?.addEventListener("submit", (e) => {
  e.preventDefault();
  sendChatWithLoading($("#ask-text")?.value || "");
});
