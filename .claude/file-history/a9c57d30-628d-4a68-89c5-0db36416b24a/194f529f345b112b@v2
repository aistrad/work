/**
 * Skill Plugin System - Type Definitions
 *
 * AI SDK Compatible Architecture
 */

import { ComponentType, ReactNode } from "react";
import { LucideIcon } from "lucide-react";
import { z } from "zod";

// ═══════════════════════════════════════════════════════════════════════════
// Skill ID
// ═══════════════════════════════════════════════════════════════════════════

export const SKILL_IDS = ["bazi", "zodiac", "mbti", "tarot", "attach", "career", "lifecoach"] as const;
export type SkillId = (typeof SKILL_IDS)[number];

export function isValidSkillId(id: string): id is SkillId {
  return SKILL_IDS.includes(id as SkillId);
}

// ═══════════════════════════════════════════════════════════════════════════
// Panel Definitions
// ═══════════════════════════════════════════════════════════════════════════

export interface PanelProps {
  skill: SkillId;
  isActive: boolean;
  onClose?: () => void;
}

export interface PanelDefinition {
  /** Unique panel identifier */
  id: string;
  /** Display label */
  label: string;
  /** Panel icon */
  icon: LucideIcon;
  /** Panel component - accepts PanelProps or compatible props */
  component: ComponentType<any>;
  /** Sort order (lower = first) */
  order?: number;
  /** Badge content function */
  badge?: () => string | number | null;
  /** Requires authentication */
  requireAuth?: boolean;
  /** Requires paid subscription */
  requirePaid?: boolean;
}

// ═══════════════════════════════════════════════════════════════════════════
// AI SDK Tool Definitions (Generative UI)
// ═══════════════════════════════════════════════════════════════════════════

export interface ToolExecuteContext {
  skillId: SkillId;
  userId?: string;
  conversationId?: string;
}

export interface ToolDefinition<TParams = any, TResult = any> {
  /** Tool name (used in AI calls) */
  name: string;
  /** Tool description for AI */
  description: string;
  /** Zod schema for parameters - allows input/output type mismatch (e.g., with .default()) */
  parameters: z.ZodType<TParams, any, any>;
  /** Execute function */
  execute: (params: TParams, context: ToolExecuteContext) => Promise<TResult>;
  /** Generative UI: Render function */
  render?: (result: TResult, context: ToolExecuteContext) => ReactNode;
  /** Requires user approval before execution */
  needsApproval?: boolean | ((params: TParams) => boolean);
  /** Transform result before sending back to model (reduce tokens) */
  toModelOutput?: (result: TResult) => string;
}

// Helper type for creating tools with specific types
export type CreateToolDefinition<TParams, TResult> = ToolDefinition<TParams, TResult>;

// ═══════════════════════════════════════════════════════════════════════════
// Theme Configuration
// ═══════════════════════════════════════════════════════════════════════════

export interface SkillTheme {
  /** Primary color (hex) */
  primary: string;
  /** Secondary color (hex) */
  secondary: string;
  /** Glow color (rgba) */
  glow: string;
  /** Gradient background */
  gradient: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Expert Profile - 专家形象配置
// ═══════════════════════════════════════════════════════════════════════════

export interface ExpertProfile {
  /** 专长标签 */
  expertise: string[];
  /** 风格描述 */
  style: string;
  /** 首次问候语 */
  greeting: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Feature Configuration
// ═══════════════════════════════════════════════════════════════════════════

export interface SkillFeatures {
  /** Quick prompt suggestions */
  quickPrompts: string[];
  /** Empty state configuration */
  emptyState: {
    title: string;
    subtitle: string;
    image?: string;
  };
}

export interface SharedFeatureFlags {
  /** Enable report generation */
  report?: boolean;
  /** Enable relationship analysis */
  relationship?: boolean;
  /** Enable daily greeting */
  greeting?: boolean;
  /** Enable AI interview */
  interview?: boolean;
  /** Enable K-line chart */
  kline?: boolean;
}

// ═══════════════════════════════════════════════════════════════════════════
// Input Form Configuration
// ═══════════════════════════════════════════════════════════════════════════

export type FormFieldType = "text" | "date" | "time" | "select" | "location" | "number";

export interface FormFieldDefinition {
  id: string;
  type: FormFieldType;
  label: string;
  placeholder?: string;
  required?: boolean;
  options?: { value: string; label: string }[];
  helperText?: string;
}

export interface InputFormConfig {
  fields: FormFieldDefinition[];
  required: string[];
}

// ═══════════════════════════════════════════════════════════════════════════
// Skill Plugin - Complete Definition
// ═══════════════════════════════════════════════════════════════════════════

export interface SkillPlugin {
  // ─── Basic Info ───────────────────────────────────────────────────────────
  /** Unique skill identifier */
  id: SkillId;
  /** Display name */
  name: string;
  /** Subtitle/tagline */
  subtitle: string;
  /** Skill icon */
  icon: LucideIcon;
  /** Is skill enabled */
  enabled: boolean;
  /** Is skill in beta */
  beta?: boolean;

  // ─── Theme ────────────────────────────────────────────────────────────────
  theme: SkillTheme;

  // ─── Features ─────────────────────────────────────────────────────────────
  features: SkillFeatures;

  // ─── Shared Feature Flags ─────────────────────────────────────────────────
  /** Override shared features (default: all enabled) */
  sharedFeatures?: SharedFeatureFlags;

  // ─── Skill-Specific Extensions ────────────────────────────────────────────
  /** Skill-specific panels */
  panels: PanelDefinition[];
  /** Skill-specific AI tools (Generative UI) */
  tools: ToolDefinition[];

  // ─── Input Configuration ──────────────────────────────────────────────────
  /** Input form configuration */
  inputForm?: InputFormConfig;

  // ─── Expert Profile ────────────────────────────────────────────────────────
  /** Expert profile for avatar and introduction */
  expert?: ExpertProfile;
}

// ═══════════════════════════════════════════════════════════════════════════
// Skill Registry Interface
// ═══════════════════════════════════════════════════════════════════════════

export interface SkillRegistry {
  /** Get all registered skills */
  getAll(): SkillPlugin[];
  /** Get skill by ID */
  get(id: SkillId): SkillPlugin | undefined;
  /** Get all enabled skills */
  getEnabled(): SkillPlugin[];
  /** Check if skill exists and is enabled */
  isEnabled(id: SkillId): boolean;

  // Panel helpers
  /** Get skill-specific panels */
  getSkillPanels(skillId: SkillId): PanelDefinition[];
  /** Get all panels for a skill (shared + skill-specific) */
  getAllPanels(skillId: SkillId): PanelDefinition[];

  // Tool helpers
  /** Get skill-specific tools */
  getSkillTools(skillId: SkillId): ToolDefinition[];
  /** Get all tools for a skill (shared + skill-specific) */
  getAllTools(skillId: SkillId): ToolDefinition[];
  /** Get a specific tool by name */
  getTool(name: string): ToolDefinition | undefined;
}
