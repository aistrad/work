"""
Fortune API Routes - K-Line and Fortune Data
Based on: vibelife spec v3.0, section 2.2.5

Endpoints:
- GET /api/v1/fortune/kline - Get K-Line visualization data
- GET /api/v1/fortune/year/{year} - Get specific year detail
- GET /api/v1/fortune/greeting - Get daily greeting
- GET /api/v1/fortune/cycles - Get major luck cycles
"""

import logging
from typing import Optional
from datetime import date
from uuid import UUID
from fastapi import APIRouter, HTTPException, Query
from pydantic import BaseModel, Field

from services.fortune import (
    get_kline_service,
    calculate_major_cycles,
    calculate_annual_fortune,
)
from services.greeting import (
    get_greeting_service,
)

logger = logging.getLogger(__name__)
router = APIRouter(prefix="/fortune", tags=["fortune"])


# ═══════════════════════════════════════════════════════════════════════════
# Request/Response Models
# ═══════════════════════════════════════════════════════════════════════════

class KLineRequest(BaseModel):
    """Request for K-Line data"""
    user_id: str
    profile: dict
    start_year: Optional[int] = None
    end_year: Optional[int] = None


class KLineResponse(BaseModel):
    """Response for K-Line data"""
    success: bool
    data: Optional[dict] = None
    error: Optional[str] = None


class YearDetailResponse(BaseModel):
    """Response for year detail"""
    success: bool
    data: Optional[dict] = None
    error: Optional[str] = None


class GreetingRequest(BaseModel):
    """Request for daily greeting"""
    profile: dict
    voice_mode: str = Field(default="warm")
    greeting_type: str = Field(default="morning")


class GreetingResponse(BaseModel):
    """Response for daily greeting"""
    success: bool
    greeting: Optional[dict] = None
    error: Optional[str] = None


class CyclesResponse(BaseModel):
    """Response for major cycles"""
    success: bool
    cycles: list = []
    error: Optional[str] = None


# ═══════════════════════════════════════════════════════════════════════════
# Routes
# ═══════════════════════════════════════════════════════════════════════════

@router.post("/kline", response_model=KLineResponse)
async def get_kline(request: KLineRequest):
    """
    Get K-Line visualization data.

    Returns data points, phases, and inflection points
    for rendering the Life K-Line chart.
    """
    try:
        service = get_kline_service()

        year_range = None
        if request.start_year and request.end_year:
            year_range = (request.start_year, request.end_year)

        kline_data = service.generate_kline(
            user_id=UUID(request.user_id),
            profile=request.profile,
            year_range=year_range,
        )

        return KLineResponse(
            success=True,
            data=kline_data.to_dict(),
        )

    except Exception as e:
        logger.error(f"K-Line generation failed: {e}")
        return KLineResponse(
            success=False,
            error=str(e),
        )


@router.post("/year/{year}", response_model=YearDetailResponse)
async def get_year_detail(
    year: int,
    user_id: str = Query(...),
    profile: dict = None,
):
    """
    Get detailed fortune information for a specific year.

    Use this when user clicks on a year in the K-Line chart.
    """
    try:
        service = get_kline_service()

        detail = service.get_year_detail(
            user_id=UUID(user_id),
            profile=profile or {},
            year=year,
        )

        return YearDetailResponse(
            success=True,
            data=detail,
        )

    except Exception as e:
        logger.error(f"Year detail failed: {e}")
        return YearDetailResponse(
            success=False,
            error=str(e),
        )


@router.post("/greeting", response_model=GreetingResponse)
async def get_daily_greeting(request: GreetingRequest):
    """
    Get personalized daily greeting.

    Returns greeting text, fortune hint, and action tip.
    """
    try:
        service = get_greeting_service()

        greeting = await service.generate_greeting(
            profile=request.profile,
            greeting_type=request.greeting_type,
            voice_mode=request.voice_mode,
        )

        return GreetingResponse(
            success=True,
            greeting=greeting.to_dict(),
        )

    except Exception as e:
        logger.error(f"Greeting generation failed: {e}")
        return GreetingResponse(
            success=False,
            error=str(e),
        )


@router.get("/cycles", response_model=CyclesResponse)
async def get_major_cycles(
    birth_year: int = Query(..., description="Year of birth"),
    day_master_element: str = Query("wood", description="Day master element"),
    gender: str = Query("unknown", description="Gender for cycle direction"),
):
    """
    Get major luck cycles (大运).

    Returns list of 10-year cycles with themes and scores.
    """
    try:
        cycles = calculate_major_cycles(
            birth_year=birth_year,
            day_master_element=day_master_element,
            gender=gender,
        )

        return CyclesResponse(
            success=True,
            cycles=[c.to_dict() for c in cycles],
        )

    except Exception as e:
        logger.error(f"Cycles calculation failed: {e}")
        return CyclesResponse(
            success=False,
            error=str(e),
        )


@router.get("/annual/{year}")
async def get_annual_fortune(
    year: int,
    day_master_element: str = Query("wood", description="Day master element"),
):
    """
    Get annual fortune for a specific year.

    Returns theme, highlights, and cautions for the year.
    """
    try:
        fortune = calculate_annual_fortune(
            day_master_element=day_master_element,
            year=year,
        )

        return {
            "success": True,
            "fortune": fortune.to_dict(),
        }

    except Exception as e:
        logger.error(f"Annual fortune failed: {e}")
        return {
            "success": False,
            "error": str(e),
        }
