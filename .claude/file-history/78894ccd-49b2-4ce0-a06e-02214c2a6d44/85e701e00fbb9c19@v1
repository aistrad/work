"use client";

/**
 * ChatWelcomeMessage - å¯¹è¯å¼æ¬¢è¿æ¶ˆæ¯
 *
 * å°† Dashboard æ•°æ®æ•´åˆä¸ºä¸€æ¡ AI æ¶ˆæ¯ï¼ŒåŒ…å«ï¼š
 * 1. ä¸ªæ€§åŒ–é—®å€™ + èŠ‚æ°” + è¿ç»­å¤©æ•°
 * 2. ä»Šæ—¥èƒ½é‡ç›˜ï¼ˆç²¾ç®€ç‰ˆï¼‰
 * 3. Lifecoach è¿›åº¦ï¼ˆå¯¹è¯å¼ï¼‰
 * 4. åŠ¨æ€å¿«æ·æ“ä½œæŒ‰é’®
 */

import { useMemo } from "react";
import { cn } from "@/lib/utils";
import { EnhancedFortuneCard } from "./EnhancedFortuneCard";
import { ConversationalLifecoachCard } from "./ConversationalLifecoachCard";
import { DynamicQuickActions } from "./DynamicQuickActions";

interface WelcomeMessageData {
  greeting: string;           // "æ—©å®‰ï¼Œå°è–‡"
  solarTerm?: string;         // "å¤§å¯’"
  streak: number;             // 7
  fortuneData: {
    headline: string;
    insights: string[];
    rating: {
      overall: number;
      focused_area?: {
        name: string;
        score: number;
        emoji: string;
        tip: string;
      };
    };
  };
  lifecoachData: {
    northStar?: string;
    monthlyProject?: {
      name: string;
      progress: number;
      daysRemaining: number;
    };
    weekRocks: Array<{
      id: string;
      text: string;
      role?: string;
      completed: boolean;
    }>;
    todayLevers: Array<{
      id: string;
      text: string;
      completed: boolean;
    }>;
  };
  status: {
    streak: number;
    checkedIn: boolean;
    energy?: number;
  };
}

interface ChatWelcomeMessageProps {
  data: WelcomeMessageData;
  onCheckIn: () => Promise<void>;
  onSendPrompt?: (prompt: string) => void;
  onShowLifecoachDetail?: () => void;
  className?: string;
}

export function ChatWelcomeMessage({
  data,
  onCheckIn,
  onSendPrompt,
  onShowLifecoachDetail,
  className
}: ChatWelcomeMessageProps) {
  const { greeting, solarTerm, streak, fortuneData, lifecoachData, status } = data;

  // ç”Ÿæˆå¼€åœºé—®å€™è¯­
  const openingMessage = useMemo(() => {
    const parts: string[] = [];

    // åŸºç¡€é—®å€™
    parts.push(`${greeting} ğŸŒŸ`);

    // èŠ‚æ°” + è¿ç»­å¤©æ•°
    if (solarTerm && streak > 0) {
      parts.push(
        `ä»Šå¤©æ˜¯${solarTerm}èŠ‚æ°”ã€‚ä½ å·²ç»è¿ç»­ **${streak} å¤©**å’Œæˆ‘ä¸€èµ·æˆé•¿äº† ğŸ”¥`
      );
    } else if (streak > 0) {
      parts.push(`ä½ å·²ç»è¿ç»­ **${streak} å¤©**å’Œæˆ‘ä¸€èµ·æˆé•¿äº† ğŸ”¥`);
    } else if (solarTerm) {
      parts.push(`ä»Šå¤©æ˜¯${solarTerm}èŠ‚æ°”`);
    }

    return parts.join("\n\n");
  }, [greeting, solarTerm, streak]);

  return (
    <div className={cn("flex gap-3 p-4", className)}>
      {/* AI å¤´åƒ */}
      <div className="flex-shrink-0">
        <div className="w-8 h-8 rounded-full bg-gradient-to-br from-emerald-400 to-green-600 flex items-center justify-center text-white text-sm font-bold">
          V
        </div>
      </div>

      {/* æ¶ˆæ¯æ°”æ³¡ */}
      <div className="flex-1 max-w-xl">
        <div className="bg-gradient-to-br from-card via-card to-muted/30 rounded-2xl p-4 shadow-sm border border-border/50">
          {/* å¼€åœºé—®å€™ */}
          <div className="prose prose-sm mb-3">
            {openingMessage.split("\n\n").map((paragraph, i) => (
              <p key={i} className="text-sm text-foreground leading-relaxed mb-2 last:mb-0">
                {paragraph.split("**").map((part, j) =>
                  j % 2 === 1 ? <strong key={j}>{part}</strong> : part
                )}
              </p>
            ))}
          </div>

          {/* ä»Šæ—¥èƒ½é‡ç›˜ */}
          <EnhancedFortuneCard data={fortuneData} />

          {/* Lifecoach è¿›åº¦ */}
          <ConversationalLifecoachCard
            data={lifecoachData}
            onShowMore={onShowLifecoachDetail}
          />

          {/* å¼•å¯¼æ–‡æ¡ˆ */}
          <p className="text-sm text-muted-foreground mt-3 mb-3">
            å‡†å¤‡å¥½å¼€å§‹ä»Šå¤©äº†å—ï¼Ÿ ğŸ˜Š
          </p>

          {/* åŠ¨æ€å¿«æ·æŒ‰é’® */}
          <DynamicQuickActions
            status={status}
            lifecoach={lifecoachData}
            onCheckIn={onCheckIn}
            onSendPrompt={onSendPrompt}
          />
        </div>

        {/* æ—¶é—´æˆ³ */}
        <div className="mt-1 px-2">
          <span className="text-xs text-muted-foreground">
            {new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit"
            })}
          </span>
        </div>
      </div>
    </div>
  );
}
