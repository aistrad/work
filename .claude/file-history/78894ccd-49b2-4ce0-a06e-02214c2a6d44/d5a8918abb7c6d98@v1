#!/usr/bin/env python3
"""
æµ‹è¯• Bazi Skill ä¼˜åŒ–åçš„æ•°æ®ç”Ÿæˆ

æµ‹è¯•å†…å®¹ï¼š
1. èƒ½é‡æ›²çº¿ç”Ÿæˆ
2. ä¸ªæ€§åŒ–é¢†åŸŸè¯„åˆ†
3. ä¸ªæ€§åŒ– headline
4. è¡ŒåŠ¨å¯¼å‘ insights
"""

import asyncio
import sys
from pathlib import Path
from datetime import date

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° path
sys.path.insert(0, str(Path(__file__).parent.parent))

from skills.bazi.services import BaziComputer
from services.proactive.content_generator import ContentGenerator
from services.proactive.engine import ReminderTask, ReminderPriority


async def test_bazi_optimization():
    """æµ‹è¯• Bazi ä¼˜åŒ–æ•ˆæœ"""
    print("=" * 80)
    print("Bazi Skill æ•°æ®ç”Ÿæˆä¼˜åŒ–æµ‹è¯•")
    print("=" * 80)
    print()

    # æ¨¡æ‹Ÿç”¨æˆ· profile
    mock_profile = {
        "identity": {
            "birth_info": {
                "date": "1990-05-15",
                "time": "10:30",
                "gender": "male",
            }
        },
        "life_context": {
            "current_focus": "career",  # å½“å‰å…³æ³¨äº‹ä¸š
            "concerns": ["å·¥ä½œå‘å±•", "å›¢é˜Ÿåä½œ"],
            "goals": ["å®Œæˆé¡¹ç›®", "æå‡æŠ€èƒ½"],
        },
        "preferences": {
            "voice_mode": "warm",
        },
        "skill_data": {
            "bazi": {
                "chart": {
                    "day_master": {
                        "element": "wood",  # ç”²æœ¨æ—¥ä¸»
                    }
                }
            }
        }
    }

    # 1. æµ‹è¯• BaziComputer
    print("1ï¸âƒ£  æµ‹è¯• BaziComputer.calculate_daily_fortune")
    print("-" * 80)

    computer = BaziComputer()
    daily_fortune = await computer.calculate_daily_fortune(mock_profile)

    print(f"ğŸ“… æ—¥æœŸ: {daily_fortune['date']}")
    print(f"ğŸŒŸ ç»¼åˆåˆ†æ•°: {daily_fortune['score']}")
    print(f"ğŸ”¥ ä»Šæ—¥å…ƒç´ : {daily_fortune['element']}")
    print(f"ğŸ“ˆ å½±å“ç±»å‹: {daily_fortune['influence']}")
    print()

    # æ˜¾ç¤ºèƒ½é‡æ›²çº¿
    print("âš¡ 24å°æ—¶èƒ½é‡æ›²çº¿:")
    energy_curve = daily_fortune.get('energy_curve', [])
    for point in energy_curve:
        hour = point['hour']
        energy = point['energy']
        element = point['element']
        bar = "â–ˆ" * (energy // 5)
        print(f"  {hour:02d}:00 | {bar:20s} {energy:3d}% ({element})")
    print()

    # æ˜¾ç¤ºé¢†åŸŸè¯„åˆ†
    print("ğŸ“Š ä¸ªæ€§åŒ–é¢†åŸŸè¯„åˆ†:")
    area_scores = daily_fortune.get('area_scores', {})
    for area, score in area_scores.items():
        stars = "â­" * (score // 20)
        print(f"  {area:8s}: {stars:5s} {score:3d}/100")
    print()

    # 2. æµ‹è¯• ContentGenerator
    print("2ï¸âƒ£  æµ‹è¯• ContentGenerator._generate_daily_fortune")
    print("-" * 80)

    generator = ContentGenerator()
    task = ReminderTask(
        user_id="test-user-001",
        skill_id="bazi",
        reminder_type="daily_fortune",
        priority=ReminderPriority.MEDIUM,
    )

    config = {
        "content": {
            "templates": {
                "title": "ä»Šæ—¥è¿åŠ¿"
            }
        }
    }

    content = await generator._generate_daily_fortune(task, mock_profile, config)

    print(f"ğŸ“¢ æ ‡é¢˜: {content.title}")
    print(f"ğŸ’¬ æ­£æ–‡: {content.body}")
    print()

    print("ğŸ“ ç”Ÿæˆçš„æ•°æ®:")
    print(f"  headline: {content.data.get('headline')}")
    print(f"  insights:")
    for i, insight in enumerate(content.data.get('insights', []), 1):
        print(f"    {i}. {insight}")
    print()

    print("â­ è¯„åˆ†æ•°æ®:")
    rating = content.data.get('rating', {})
    print(f"  overall: {rating.get('overall')}/5")
    focused_area = rating.get('focused_area', {})
    print(f"  focused_area:")
    print(f"    name: {focused_area.get('name')}")
    print(f"    score: {focused_area.get('score')}/5")
    print(f"    emoji: {focused_area.get('emoji')}")
    print(f"    tip: {focused_area.get('tip')}")
    print()

    details = rating.get('details', {})
    print(f"  details:")
    for area, score in details.items():
        print(f"    {area}: {score}/5")
    print()

    # 3. æµ‹è¯•ä¸åŒå…³æ³¨é¢†åŸŸ
    print("3ï¸âƒ£  æµ‹è¯•ä¸åŒå…³æ³¨é¢†åŸŸçš„ä¸ªæ€§åŒ–æ•ˆæœ")
    print("-" * 80)

    focus_areas = ["career", "wealth", "romance", "health"]
    for focus in focus_areas:
        test_profile = mock_profile.copy()
        test_profile["life_context"] = {"current_focus": focus}

        content = await generator._generate_daily_fortune(task, test_profile, config)

        print(f"ğŸ¯ å…³æ³¨é¢†åŸŸ: {focus}")
        print(f"   headline: {content.data.get('headline')}")
        print(f"   insights: {content.data.get('insights', [])[0] if content.data.get('insights') else 'N/A'}")
        focused = content.data.get('rating', {}).get('focused_area', {})
        print(f"   focused_area: {focused.get('emoji')} {focused.get('name')} {focused.get('score')}/5")
        print()

    print("=" * 80)
    print("âœ… æµ‹è¯•å®Œæˆï¼")
    print("=" * 80)


if __name__ == "__main__":
    asyncio.run(test_bazi_optimization())
