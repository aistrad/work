"use client";

/**
 * useMeData - Me页面数据获取 Hook（v3.0 真实数据连接）
 *
 * 数据来源：
 * - /api/v1/me/dashboard - 后端聚合 API
 * - 支持 Mock 模式用于开发测试
 *
 * 支持三种数据级别：
 * - Level A: 完整数据（八字 + 星座 + 原型 + 今日能量）
 * - Level B: 有对话但无命理数据（显示行为洞察）
 * - Level C: 新用户（显示引导）
 */

import { useState, useEffect, useCallback } from "react";
import { useAuth } from "@/hooks/useAuth";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

export type DataLevel = "A" | "B" | "C";

export interface MeUser {
  display_name: string;
  avatar_url?: string;
  tagline: string;
}

export interface BaziSummary {
  day_master: {
    element: string;
    character: string;
    description: string;
  };
  five_elements: Record<string, number>;
  daily_fortune?: string;
}

export interface ZodiacSummary {
  sun: { sign: string; keywords: string[] };
  moon: { sign: string; keywords: string[] };
  rising: { sign: string; keywords: string[] };
  transit_highlight?: string;
}

export interface ArchetypeData {
  primary: {
    name: string;
    name_cn: string;
    tagline: string;
    weight: number;
  };
  weights: Record<string, number>;
  guidance: string[];
  trend?: {
    rising: string;
    delta: number;
    evidence: string;
  };
  shadow?: {
    name: string;
    warning: string;
  };
}

export interface BehaviorInsight {
  topics: Record<string, number>;
  emotion: {
    current: string;
    trend: number[];
  };
}

export interface TodayEnergy {
  overall_score: number;
  energy_label: string;
  bazi_insight?: {
    score: number;
    headline: string;
    tip?: string;
  };
  zodiac_insight?: {
    score: number;
    headline: string;
    tip?: string;
  };
  action_tip?: string;
  keywords?: string[];
  solar_term?: string;
}

export interface MeDashboardData {
  data_level: DataLevel;
  user: MeUser;
  bazi_summary?: BaziSummary;
  zodiac_summary?: ZodiacSummary;
  archetype?: ArchetypeData;
  behavior_insight?: BehaviorInsight;
  today_energy?: TodayEnergy;
  streak_days?: number;
}

// ═══════════════════════════════════════════════════════════════════════════
// Mock Data
// ═══════════════════════════════════════════════════════════════════════════

const MOCK_DATA_LEVEL_A: MeDashboardData = {
  data_level: "A",
  user: {
    display_name: "云栖",
    avatar_url: undefined,
    tagline: "创造者 · 探索者 · 思考者",
  },
  bazi_summary: {
    day_master: {
      element: "木",
      character: "甲",
      description: "阳木之力，生长·创造·直率",
    },
    five_elements: {
      木: 35,
      火: 22,
      土: 15,
      金: 18,
      水: 10,
    },
    daily_fortune: "利沟通表达，适合社交与创作",
  },
  zodiac_summary: {
    sun: { sign: "双子座", keywords: ["沟通", "好奇"] },
    moon: { sign: "双鱼座", keywords: ["敏感", "直觉"] },
    rising: { sign: "狮子座", keywords: ["自信", "表现"] },
    transit_highlight: "土星回归期 · 人生重要转折",
  },
  archetype: {
    primary: {
      name: "Creator",
      name_cn: "创造者",
      tagline: "将愿景变为现实",
      weight: 35,
    },
    weights: {
      创造者: 35,
      探索者: 30,
      智者: 25,
      英雄: 10,
    },
    guidance: [
      "给自己留出创作时间",
      "用输出倒逼输入",
      "别等完美，先开始",
    ],
    trend: {
      rising: "探索者",
      delta: 5,
      evidence: "近期频繁讨论新领域",
    },
    shadow: {
      name: "统治者",
      warning: "完美主义倾向需要觉察",
    },
  },
  today_energy: {
    overall_score: 78,
    energy_label: "状态良好",
    bazi_insight: {
      score: 85,
      headline: "利沟通表达，适合社交与创作",
      tip: "把握灵感涌现的时刻",
    },
    zodiac_insight: {
      score: 72,
      headline: "土星回归期，人生重要转折",
      tip: "适合深度思考和规划",
    },
    action_tip: "适合创意工作和深度思考，把握灵感涌现的时刻",
    keywords: ["创作", "沟通", "灵感"],
    solar_term: "大寒",
  },
  streak_days: 7,
};

const MOCK_DATA_LEVEL_B: MeDashboardData = {
  data_level: "B",
  user: {
    display_name: "访客用户",
    avatar_url: undefined,
    tagline: "好奇探索者",
  },
  behavior_insight: {
    topics: {
      职业发展: 80,
      个人成长: 40,
      健康: 15,
    },
    emotion: {
      current: "平静稳定 · 偶有焦虑",
      trend: [65, 70, 60, 75, 80, 72, 78],
    },
  },
};

const MOCK_DATA_LEVEL_C: MeDashboardData = {
  data_level: "C",
  user: {
    display_name: "新朋友",
    avatar_url: undefined,
    tagline: "",
  },
};

// ═══════════════════════════════════════════════════════════════════════════
// Hook
// ═══════════════════════════════════════════════════════════════════════════

export interface UseMeDataOptions {
  /** Mock 数据级别（开发测试用）*/
  mockLevel?: DataLevel;
  /** 是否强制使用 Mock 数据 */
  forceMock?: boolean;
}

export interface UseMeDataResult {
  data: MeDashboardData | null;
  isLoading: boolean;
  error: Error | null;
  refresh: () => Promise<void>;
}

export function useMeData(options: UseMeDataOptions = {}): UseMeDataResult {
  const { mockLevel = "A", forceMock = false } = options;
  const { token, isAuthenticated } = useAuth();

  const [data, setData] = useState<MeDashboardData | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  const fetchData = useCallback(async () => {
    setIsLoading(true);
    setError(null);

    try {
      // Use mock data in development or if forced
      const useMock = forceMock || process.env.NODE_ENV === "development";

      if (useMock) {
        // Simulate network delay
        await new Promise((resolve) => setTimeout(resolve, 500));

        // Return mock data based on level
        let mockData: MeDashboardData;
        switch (mockLevel) {
          case "A":
            mockData = MOCK_DATA_LEVEL_A;
            break;
          case "B":
            mockData = MOCK_DATA_LEVEL_B;
            break;
          case "C":
            mockData = MOCK_DATA_LEVEL_C;
            break;
          default:
            mockData = MOCK_DATA_LEVEL_A;
        }

        setData(mockData);
        return;
      }

      // Real API call
      if (!isAuthenticated || !token) {
        // Not authenticated - show Level C
        setData(MOCK_DATA_LEVEL_C);
        return;
      }

      const response = await fetch("/api/me/dashboard", {
        method: "GET",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
      });

      if (!response.ok) {
        throw new Error("Failed to fetch dashboard data");
      }

      const result = await response.json();

      if (result.success && result.data) {
        // Transform backend data to frontend format
        const dashboardData: MeDashboardData = {
          data_level: determineDataLevel(result.data),
          user: {
            display_name: result.data.user?.display_name || "用户",
            avatar_url: result.data.user?.avatar_url,
            tagline: result.data.user?.tagline || "",
          },
          bazi_summary: result.data.bazi_summary,
          zodiac_summary: result.data.zodiac_summary,
          archetype: result.data.archetype,
          behavior_insight: result.data.behavior_insight,
          today_energy: result.data.today_energy,
          streak_days: result.data.streak_days,
        };

        setData(dashboardData);
      } else {
        throw new Error(result.error || "Unknown error");
      }
    } catch (err) {
      setError(err instanceof Error ? err : new Error("Failed to fetch data"));
      // Fallback to mock data on error in development
      if (process.env.NODE_ENV === "development") {
        setData(MOCK_DATA_LEVEL_A);
      }
    } finally {
      setIsLoading(false);
    }
  }, [mockLevel, forceMock, token, isAuthenticated]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  return {
    data,
    isLoading,
    error,
    refresh: fetchData,
  };
}

// Helper to determine data level from backend response
function determineDataLevel(data: Record<string, unknown>): DataLevel {
  if (data.bazi_summary && data.zodiac_summary && data.archetype) {
    return "A";
  }
  if (data.behavior_insight) {
    return "B";
  }
  return "C";
}

export default useMeData;
