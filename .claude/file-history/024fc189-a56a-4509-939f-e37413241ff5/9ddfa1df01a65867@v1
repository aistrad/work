"use client";

/**
 * UserInfoCard - Me页用户信息卡片（v3.0 视觉升级）
 *
 * 设计升级：
 * - 头像边框使用主原型对应的渐变色
 * - Tagline 标签使用 GradientEmojiIcon 风格
 * - 添加能量值/签到状态小型指示器
 * - 整体更紧凑，为 Bento 布局预留空间
 */

import { cn } from "@/lib/utils";
import { User, Flame, Edit3 } from "lucide-react";
import { GradientEmojiIcon } from "@/components/core/GradientEmojiIcon";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

export interface UserInfoCardProps {
  displayName: string;
  avatarUrl?: string;
  tagline?: string;
  /** 主原型（用于决定头像边框颜色）*/
  primaryArchetype?: string;
  /** 连续签到天数 */
  streakDays?: number;
  /** 能量值 (0-100) */
  energyLevel?: number;
  onEditProfile?: () => void;
  className?: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Archetype Colors
// ═══════════════════════════════════════════════════════════════════════════

const ARCHETYPE_GRADIENTS: Record<string, { from: string; to: string; ring: string }> = {
  创造者: { from: "from-amber-400", to: "to-orange-500", ring: "ring-amber-400/50" },
  探索者: { from: "from-teal-400", to: "to-emerald-500", ring: "ring-teal-400/50" },
  智者: { from: "from-indigo-400", to: "to-purple-500", ring: "ring-indigo-400/50" },
  英雄: { from: "from-red-400", to: "to-rose-500", ring: "ring-red-400/50" },
  照顾者: { from: "from-green-400", to: "to-emerald-500", ring: "ring-green-400/50" },
  恋人: { from: "from-pink-400", to: "to-rose-500", ring: "ring-pink-400/50" },
  魔术师: { from: "from-purple-400", to: "to-violet-500", ring: "ring-purple-400/50" },
  统治者: { from: "from-yellow-400", to: "to-amber-500", ring: "ring-yellow-400/50" },
  天真者: { from: "from-sky-400", to: "to-blue-500", ring: "ring-sky-400/50" },
  凡人: { from: "from-slate-400", to: "to-gray-500", ring: "ring-slate-400/50" },
  叛逆者: { from: "from-orange-400", to: "to-red-500", ring: "ring-orange-400/50" },
  愚者: { from: "from-cyan-400", to: "to-teal-500", ring: "ring-cyan-400/50" },
};

const ARCHETYPE_TAG_COLORS: Record<string, { bg: string; text: string }> = {
  创造者: { bg: "bg-amber-100/80", text: "text-amber-700" },
  探索者: { bg: "bg-teal-100/80", text: "text-teal-700" },
  智者: { bg: "bg-indigo-100/80", text: "text-indigo-700" },
  英雄: { bg: "bg-red-100/80", text: "text-red-700" },
  照顾者: { bg: "bg-green-100/80", text: "text-green-700" },
  恋人: { bg: "bg-pink-100/80", text: "text-pink-700" },
  魔术师: { bg: "bg-purple-100/80", text: "text-purple-700" },
  统治者: { bg: "bg-yellow-100/80", text: "text-yellow-700" },
  天真者: { bg: "bg-sky-100/80", text: "text-sky-700" },
  凡人: { bg: "bg-slate-100/80", text: "text-slate-700" },
  叛逆者: { bg: "bg-orange-100/80", text: "text-orange-700" },
  愚者: { bg: "bg-cyan-100/80", text: "text-cyan-700" },
  思考者: { bg: "bg-indigo-100/80", text: "text-indigo-700" },
};

// ═══════════════════════════════════════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════════════════════════════════════

function parseTagline(tagline: string): string[] {
  if (!tagline) return [];
  return tagline.split(/[·、,，]/).map((tag) => tag.trim()).filter(Boolean);
}

function getArchetypeGradient(archetype?: string) {
  return ARCHETYPE_GRADIENTS[archetype || ""] || { from: "from-gold-400", to: "to-gold-500", ring: "ring-gold-400/50" };
}

function getTagColor(tag: string) {
  return ARCHETYPE_TAG_COLORS[tag] || { bg: "bg-vellum-100", text: "text-vellum-700" };
}

// ═══════════════════════════════════════════════════════════════════════════
// Component
// ═══════════════════════════════════════════════════════════════════════════

export function UserInfoCard({
  displayName,
  avatarUrl,
  tagline,
  primaryArchetype,
  streakDays,
  energyLevel,
  onEditProfile,
  className,
}: UserInfoCardProps) {
  const tags = parseTagline(tagline || "");
  const gradient = getArchetypeGradient(primaryArchetype || tags[0]);

  return (
    <div
      className={cn(
        "relative p-5 rounded-2xl overflow-hidden",
        "bg-gradient-to-br from-vellum-50/80 via-white to-gold-50/30",
        "border border-vellum-200/40",
        "shadow-card",
        className
      )}
    >
      {/* Background decoration */}
      <div className="absolute top-0 right-0 w-40 h-40 bg-gradient-to-bl from-gold-200/10 to-transparent rounded-full blur-3xl" />

      <div className="relative flex flex-col items-center text-center">
        {/* Avatar with Archetype Gradient Border */}
        <div className="relative mb-4">
          {/* Gradient ring */}
          <div
            className={cn(
              "absolute inset-0 rounded-full",
              "bg-gradient-to-br",
              gradient.from,
              gradient.to,
              "blur-sm opacity-60"
            )}
            style={{ transform: "scale(1.1)" }}
          />

          {/* Avatar container */}
          <div
            className={cn(
              "relative w-20 h-20 rounded-full",
              "bg-gradient-to-br from-vellum-100 to-vellum-200",
              "ring-[3px] ring-white",
              "flex items-center justify-center overflow-hidden",
              "shadow-lg"
            )}
          >
            {avatarUrl ? (
              <img
                src={avatarUrl}
                alt={displayName}
                className="w-full h-full object-cover"
              />
            ) : (
              <User className="w-10 h-10 text-vellum-500" />
            )}
          </div>

          {/* Streak badge - 如果有签到记录 */}
          {streakDays && streakDays > 0 ? (
            <div
              className={cn(
                "absolute -bottom-1 -right-1",
                "flex items-center gap-0.5 px-2 py-0.5",
                "bg-gradient-to-r from-orange-400 to-red-500",
                "text-white text-xs font-medium",
                "rounded-full shadow-md"
              )}
            >
              <Flame className="w-3 h-3" />
              <span>{streakDays}</span>
            </div>
          ) : null}
        </div>

        {/* Name */}
        <h2 className="font-serif text-xl font-semibold text-text-primary mb-2">
          {displayName}
        </h2>

        {/* Archetype Tags */}
        {tags.length > 0 ? (
          <div className="flex flex-wrap justify-center gap-2 mb-4">
            {tags.slice(0, 3).map((tag, index) => {
              const colors = getTagColor(tag);
              return (
                <span
                  key={index}
                  className={cn(
                    "px-3 py-1 rounded-full text-xs font-medium",
                    "transition-all duration-200 hover:scale-105",
                    colors.bg,
                    colors.text
                  )}
                >
                  {tag}
                </span>
              );
            })}
          </div>
        ) : null}

        {/* Energy Level - 迷你能量条 */}
        {energyLevel !== undefined ? (
          <div className="w-full max-w-[160px] mb-4">
            <div className="flex items-center justify-between mb-1">
              <span className="text-xs text-text-tertiary">今日能量</span>
              <span className="text-xs font-medium text-accent-primary">
                {energyLevel}%
              </span>
            </div>
            <div className="h-1.5 bg-vellum-100 rounded-full overflow-hidden">
              <div
                className={cn(
                  "h-full rounded-full transition-all duration-500",
                  "bg-gradient-to-r from-gold-400 to-accent-primary"
                )}
                style={{ width: `${energyLevel}%` }}
              />
            </div>
          </div>
        ) : null}

        {/* Edit Profile Button */}
        {onEditProfile ? (
          <button
            onClick={onEditProfile}
            className={cn(
              "flex items-center gap-1.5 px-4 py-1.5 rounded-full",
              "text-sm text-vellum-600 hover:text-vellum-800",
              "bg-vellum-100/50 hover:bg-vellum-100",
              "border border-vellum-200/50 hover:border-vellum-300",
              "transition-all duration-200"
            )}
          >
            <Edit3 className="w-3.5 h-3.5" />
            <span>编辑资料</span>
          </button>
        ) : null}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Skeleton
// ═══════════════════════════════════════════════════════════════════════════

export function UserInfoCardSkeleton({ className }: { className?: string }) {
  return (
    <div
      className={cn(
        "p-5 rounded-2xl",
        "bg-gradient-to-br from-vellum-50/80 via-white to-gold-50/30",
        "border border-vellum-200/40",
        "shadow-card animate-pulse",
        className
      )}
    >
      <div className="flex flex-col items-center">
        <div className="w-20 h-20 rounded-full bg-vellum-200 mb-4" />
        <div className="h-6 bg-vellum-200 rounded w-24 mb-2" />
        <div className="flex gap-2 mb-4">
          <div className="h-6 bg-vellum-100 rounded-full w-16" />
          <div className="h-6 bg-vellum-100 rounded-full w-16" />
          <div className="h-6 bg-vellum-100 rounded-full w-16" />
        </div>
        <div className="h-8 bg-vellum-100 rounded-full w-24" />
      </div>
    </div>
  );
}

export default UserInfoCard;
