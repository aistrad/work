"use client";

/**
 * JourneyDailyLeversCard - æ¯æ—¥æ æ†å¡ç‰‡
 *
 * å±•ç¤ºä»Šæ—¥è¡ŒåŠ¨åˆ—è¡¨ï¼Œæ”¯æŒç­¾åˆ°å’Œå®Œæˆæ“ä½œ
 * åŸºäº: Journey Page 4-state ç³»ç»Ÿ
 */

import { motion } from "framer-motion";
import { useState } from "react";
import type { DailyLevers } from "@/types/journey";

interface JourneyDailyLeversCardProps {
  dailyLevers: DailyLevers;
  todayCheckedIn?: boolean;
  currentStreak?: number;
  onToggleLever?: (leverId: string) => void;
  onCheckin?: () => Promise<void>;
  onAdjustLevers?: () => void;
  className?: string;
}

function formatDate(dateStr: string): string {
  try {
    const date = new Date(dateStr);
    const today = new Date();
    const isToday = date.toDateString() === today.toDateString();

    if (isToday) {
      return "ä»Šå¤©";
    }

    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}æœˆ${day}æ—¥`;
  } catch {
    return dateStr;
  }
}

export function JourneyDailyLeversCard({
  dailyLevers,
  todayCheckedIn = false,
  currentStreak = 0,
  onToggleLever,
  onCheckin,
  onAdjustLevers,
  className,
}: JourneyDailyLeversCardProps) {
  const [isCheckinLoading, setIsCheckinLoading] = useState(false);

  const { date, levers, energy_level, intention, stats } = dailyLevers;
  const completedCount = stats?.completed ?? levers.filter((l) => l.status === "completed").length;
  const totalCount = stats?.total ?? levers.length;
  const completionRate = stats?.completion_rate ?? (totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0);

  const handleCheckin = async () => {
    if (!onCheckin || isCheckinLoading || todayCheckedIn) return;

    setIsCheckinLoading(true);
    try {
      await onCheckin();
    } finally {
      setIsCheckinLoading(false);
    }
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className={`bg-card border border-border rounded-2xl p-4 ${className}`}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-xl">âš¡</span>
          <h3 className="font-semibold text-foreground">ä»Šæ—¥æ æ†</h3>
          <span className="text-xs text-muted-foreground">{formatDate(date)}</span>
        </div>
        <div className="flex items-center gap-2">
          <span className="text-sm text-muted-foreground">
            {completedCount}/{totalCount}
          </span>
        </div>
      </div>

      {/* Checkin Section */}
      <div className="mb-4 p-3 bg-muted/50 rounded-lg">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            {/* Streak */}
            <div className="flex items-center gap-1">
              <span className="text-lg">ğŸ”¥</span>
              <span className="text-sm font-medium text-foreground">{currentStreak}</span>
              <span className="text-xs text-muted-foreground">å¤©</span>
            </div>

            {/* Energy Level */}
            {energy_level && (
              <div className="flex items-center gap-1">
                <span className="text-sm">âš¡</span>
                <span className="text-xs text-muted-foreground">èƒ½é‡ {energy_level}/10</span>
              </div>
            )}
          </div>

          {/* Checkin Button */}
          <button
            onClick={handleCheckin}
            disabled={todayCheckedIn || isCheckinLoading}
            className={`px-4 py-1.5 text-sm rounded-lg transition-all ${
              todayCheckedIn
                ? "bg-emerald-500/20 text-emerald-600 dark:text-emerald-400 cursor-default"
                : isCheckinLoading
                ? "bg-muted text-muted-foreground cursor-wait"
                : "bg-primary text-primary-foreground hover:opacity-90"
            }`}
          >
            {todayCheckedIn ? "âœ“ å·²ç­¾åˆ°" : isCheckinLoading ? "ç­¾åˆ°ä¸­â€¦" : "ç­¾åˆ°"}
          </button>
        </div>

        {/* Intention */}
        {intention && (
          <p className="text-xs text-muted-foreground mt-2 italic">
            &quot;{intention}&quot;
          </p>
        )}
      </div>

      {/* Levers List */}
      {totalCount > 0 ? (
        <div className="space-y-2">
          {levers.map((lever, index) => (
            <motion.div
              key={lever.id}
              initial={{ opacity: 0, x: -10 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: index * 0.05 }}
              className={`flex items-center gap-3 p-2 rounded-lg transition-colors ${
                lever.status === "completed"
                  ? "bg-emerald-500/10"
                  : lever.status === "skipped"
                  ? "bg-muted/30"
                  : "bg-muted/50 hover:bg-muted"
              }`}
            >
              {/* Checkbox */}
              <button
                onClick={() => onToggleLever?.(lever.id)}
                disabled={!onToggleLever || lever.status === "skipped"}
                className={`flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                  lever.status === "completed"
                    ? "bg-emerald-500 border-emerald-500 text-white"
                    : lever.status === "skipped"
                    ? "bg-muted border-muted-foreground/20"
                    : "border-muted-foreground/30 hover:border-primary"
                } ${!onToggleLever || lever.status === "skipped" ? "cursor-default" : "cursor-pointer"}`}
              >
                {lever.status === "completed" && (
                  <svg
                    className="w-3 h-3"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      strokeLinecap="round"
                      strokeLinejoin="round"
                      strokeWidth={3}
                      d="M5 13l4 4L19 7"
                    />
                  </svg>
                )}
                {lever.status === "skipped" && (
                  <span className="text-[10px] text-muted-foreground">â€”</span>
                )}
              </button>

              {/* Task Text */}
              <span
                className={`text-sm flex-1 ${
                  lever.status === "completed"
                    ? "text-muted-foreground line-through"
                    : lever.status === "skipped"
                    ? "text-muted-foreground/50 line-through"
                    : "text-foreground"
                }`}
              >
                {lever.task}
              </span>

              {/* Skip reason */}
              {lever.status === "skipped" && lever.skip_reason && (
                <span className="text-[10px] text-muted-foreground">
                  {lever.skip_reason}
                </span>
              )}
            </motion.div>
          ))}
        </div>
      ) : (
        <div className="text-center py-4">
          <p className="text-sm text-muted-foreground">ä»Šæ—¥æš‚æ— æ æ†è¡ŒåŠ¨</p>
        </div>
      )}

      {/* Progress Bar */}
      {totalCount > 0 && (
        <div className="mt-4">
          <div className="h-1.5 bg-muted rounded-full overflow-hidden">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${completionRate}%` }}
              transition={{ duration: 0.5, ease: "easeOut" }}
              className="h-full bg-emerald-500 rounded-full"
            />
          </div>
          <p className="text-xs text-muted-foreground mt-1 text-right">
            {completionRate}% å®Œæˆ
          </p>
        </div>
      )}

      {/* Adjust Button */}
      {onAdjustLevers && (
        <button
          onClick={onAdjustLevers}
          className="w-full mt-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-muted rounded-lg transition-colors"
        >
          è°ƒæ•´ä»Šæ—¥æ æ†
        </button>
      )}
    </motion.div>
  );
}

export default JourneyDailyLeversCard;
