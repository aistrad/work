"use client";

/**
 * BentoDashboard - Bento é£æ ¼çš„ Chat æ¬¢è¿ç•Œé¢
 *
 * è®¾è®¡ç†å¿µï¼š
 * - æœ€è´´å¿ƒçš„åŠ©ç†/æœ‹å‹ï¼Œæå‰å‡†å¤‡å¥½ä¸€åˆ‡
 * - Bento å¡ç‰‡å¸ƒå±€ï¼Œæ¸…æ™°åˆ†éš”ï¼Œè§†è§‰å‘¼å¸æ„Ÿ
 * - æ— ç­¾åˆ°å‹åŠ›ï¼Œè‡ªç„¶å±•ç¤ºè¿›åº¦
 * - æ¸©æš–çš„æ–‡æ¡ˆï¼Œåƒæœ‹å‹ä¸€æ ·è¯´è¯
 *
 * å¸ƒå±€ç»“æ„ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  ä¸»é—®å€™å¡ç‰‡ï¼ˆå…¨å®½å¤§å¡ç‰‡ï¼‰         â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  åŒ—ææ˜Ÿå¡ç‰‡   â”‚  æœ¬å‘¨è¿›åº¦å¡ç‰‡  â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  ä»Šæ—¥è¡ŒåŠ¨å¡ç‰‡ï¼ˆå…¨å®½ï¼‰            â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  æ™ºèƒ½å¿«æ·å…¥å£                    â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

import { useMemo, useCallback } from "react";
import { cn } from "@/lib/utils";
import { motion } from "framer-motion";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface Rock {
  id: string;
  text: string;
  role?: string;
  completed: boolean;
}

interface Lever {
  id: string;
  text: string;
  completed: boolean;
}

interface BentoDashboardData {
  // é—®å€™æ•°æ®
  greeting: string;
  solarTerm?: string;
  fortuneHint?: string;
  // Lifecoach æ•°æ®
  northStar?: string;
  weekRocks: Rock[];
  todayLevers: Lever[];
  // è¿åŠ¿æ•°æ®
  fortuneScore?: number;
  insights?: string[];
}

interface BentoDashboardProps {
  data: BentoDashboardData;
  onSendPrompt?: (prompt: string) => void;
  className?: string;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Animation Variants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.08,
      delayChildren: 0.1,
    },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 12 },
  visible: {
    opacity: 1,
    y: 0,
    transition: {
      duration: 0.4,
      ease: [0.25, 0.46, 0.45, 0.94],
    },
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function BentoDashboard({
  data,
  onSendPrompt,
  className,
}: BentoDashboardProps) {
  const {
    greeting,
    solarTerm,
    fortuneHint,
    northStar,
    weekRocks,
    todayLevers,
    insights,
  } = data;

  // è®¡ç®—æœ¬å‘¨è¿›åº¦
  const weekProgress = useMemo(() => {
    if (weekRocks.length === 0) return { completed: 0, total: 0, percentage: 0 };
    const completed = weekRocks.filter((r) => r.completed).length;
    return {
      completed,
      total: weekRocks.length,
      percentage: Math.round((completed / weekRocks.length) * 100),
    };
  }, [weekRocks]);

  // æœªå®Œæˆçš„ä»Šæ—¥è¡ŒåŠ¨
  const pendingLevers = useMemo(
    () => todayLevers.filter((l) => !l.completed),
    [todayLevers]
  );

  // æ™ºèƒ½å¿«æ·å…¥å£
  const quickActions = useMemo(() => {
    const actions: Array<{ id: string; icon: string; label: string; prompt: string }> = [];

    // æ ¹æ®çŠ¶æ€åŠ¨æ€ç”Ÿæˆ
    if (!northStar) {
      actions.push({
        id: "vision",
        icon: "ğŸŒŸ",
        label: "æ‰¾åˆ°æ–¹å‘",
        prompt: "æˆ‘æƒ³æ‰¾åˆ°äººç”Ÿæ–¹å‘",
      });
    }

    if (pendingLevers.length > 0) {
      actions.push({
        id: "focus",
        icon: "ğŸ¯",
        label: "å¸®æˆ‘ä¸“æ³¨",
        prompt: `å¸®æˆ‘å®Œæˆä»Šå¤©æœ€é‡è¦çš„äº‹ï¼š${pendingLevers[0].text}`,
      });
    }

    actions.push({
      id: "fortune",
      icon: "ğŸ”®",
      label: "ä»Šæ—¥è¿åŠ¿",
      prompt: "å¸®æˆ‘çœ‹çœ‹ä»Šå¤©çš„è¿åŠ¿",
    });

    actions.push({
      id: "chat",
      icon: "ğŸ’¬",
      label: "è‡ªç”±èŠå¤©",
      prompt: "å—¨",
    });

    return actions.slice(0, 4);
  }, [northStar, pendingLevers]);

  const handleQuickAction = useCallback(
    (prompt: string) => {
      onSendPrompt?.(prompt);
    },
    [onSendPrompt]
  );

  return (
    <motion.div
      variants={containerVariants}
      initial="hidden"
      animate="visible"
      className={cn(
        "w-full max-w-lg mx-auto px-4 py-6 space-y-3",
        className
      )}
    >
      {/* ä¸»é—®å€™å¡ç‰‡ */}
      <motion.div variants={itemVariants}>
        <GreetingCard
          greeting={greeting}
          solarTerm={solarTerm}
          fortuneHint={fortuneHint}
          insights={insights}
        />
      </motion.div>

      {/* åŒåˆ—ï¼šåŒ—ææ˜Ÿ + æœ¬å‘¨è¿›åº¦ */}
      <div className="grid grid-cols-2 gap-3">
        <motion.div variants={itemVariants}>
          <NorthStarCard
            northStar={northStar}
            onSetVision={() => handleQuickAction("æˆ‘æƒ³æ‰¾åˆ°äººç”Ÿæ–¹å‘")}
          />
        </motion.div>
        <motion.div variants={itemVariants}>
          <WeekProgressCard
            completed={weekProgress.completed}
            total={weekProgress.total}
            percentage={weekProgress.percentage}
            rocks={weekRocks}
          />
        </motion.div>
      </div>

      {/* ä»Šæ—¥è¡ŒåŠ¨å¡ç‰‡ */}
      {pendingLevers.length > 0 && (
        <motion.div variants={itemVariants}>
          <TodayActionsCard
            levers={pendingLevers}
            onActionClick={(lever) =>
              handleQuickAction(`å¸®æˆ‘å®Œæˆï¼š${lever.text}`)
            }
          />
        </motion.div>
      )}

      {/* æ™ºèƒ½å¿«æ·å…¥å£ */}
      <motion.div variants={itemVariants}>
        <QuickActionsCard
          actions={quickActions}
          onAction={handleQuickAction}
        />
      </motion.div>
    </motion.div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub Components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ä¸»é—®å€™å¡ç‰‡ - æ¸©æš–çš„ä¸ªæ€§åŒ–é—®å€™
 */
function GreetingCard({
  greeting,
  solarTerm,
  fortuneHint,
  insights,
}: {
  greeting: string;
  solarTerm?: string;
  fortuneHint?: string;
  insights?: string[];
}) {
  return (
    <div className="relative overflow-hidden rounded-2xl bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50 dark:from-amber-950/30 dark:via-orange-950/20 dark:to-yellow-950/20 p-5 border border-amber-100/50 dark:border-amber-800/30">
      {/* è£…é¥°æ€§èƒŒæ™¯ */}
      <div className="absolute top-0 right-0 w-32 h-32 bg-gradient-to-bl from-amber-200/30 to-transparent rounded-full -translate-y-1/2 translate-x-1/2" />

      {/* é—®å€™è¯­ */}
      <div className="relative">
        <h2 className="text-xl font-semibold text-amber-900 dark:text-amber-100 mb-1">
          {greeting}
        </h2>

        {/* èŠ‚æ°” + è¿åŠ¿æç¤º */}
        <div className="flex items-center gap-2 text-sm text-amber-700 dark:text-amber-300 mb-3">
          {solarTerm && (
            <>
              <span className="px-2 py-0.5 bg-amber-100 dark:bg-amber-900/50 rounded-full text-xs font-medium">
                {solarTerm}
              </span>
              <span className="text-amber-400">Â·</span>
            </>
          )}
          <span>{fortuneHint || "ä»Šå¤©é€‚åˆç¨³æ­¥å‰è¡Œ"}</span>
        </div>

        {/* æ´å¯Ÿåˆ—è¡¨ */}
        {insights && insights.length > 0 && (
          <div className="space-y-1.5">
            {insights.slice(0, 2).map((insight, i) => (
              <div
                key={i}
                className="flex items-start gap-2 text-sm text-amber-800 dark:text-amber-200"
              >
                <span className="text-amber-500 mt-0.5">â€¢</span>
                <span>{insight}</span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

/**
 * åŒ—ææ˜Ÿå¡ç‰‡ - æ„¿æ™¯æé†’
 */
function NorthStarCard({
  northStar,
  onSetVision,
}: {
  northStar?: string;
  onSetVision: () => void;
}) {
  if (!northStar) {
    return (
      <button
        onClick={onSetVision}
        className="w-full h-full min-h-[120px] rounded-2xl bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-950/30 dark:to-indigo-950/20 p-4 border border-purple-100/50 dark:border-purple-800/30 text-left hover:shadow-md transition-shadow"
      >
        <div className="text-2xl mb-2">â­</div>
        <div className="text-sm font-medium text-purple-900 dark:text-purple-100 mb-1">
          è®¾å®šåŒ—ææ˜Ÿ
        </div>
        <div className="text-xs text-purple-600 dark:text-purple-300">
          æ‰¾åˆ°ä½ çš„äººç”Ÿæ–¹å‘
        </div>
      </button>
    );
  }

  return (
    <div className="h-full min-h-[120px] rounded-2xl bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-950/30 dark:to-indigo-950/20 p-4 border border-purple-100/50 dark:border-purple-800/30">
      <div className="text-2xl mb-2">â­</div>
      <div className="text-xs text-purple-600 dark:text-purple-400 mb-1">
        åŒ—ææ˜Ÿæ„¿æ™¯
      </div>
      <div className="text-sm font-medium text-purple-900 dark:text-purple-100 line-clamp-2">
        {northStar}
      </div>
    </div>
  );
}

/**
 * æœ¬å‘¨è¿›åº¦å¡ç‰‡
 */
function WeekProgressCard({
  completed,
  total,
  percentage,
  rocks,
}: {
  completed: number;
  total: number;
  percentage: number;
  rocks: Rock[];
}) {
  if (total === 0) {
    return (
      <div className="h-full min-h-[120px] rounded-2xl bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-950/30 dark:to-green-950/20 p-4 border border-emerald-100/50 dark:border-emerald-800/30">
        <div className="text-2xl mb-2">ğŸ“Š</div>
        <div className="text-xs text-emerald-600 dark:text-emerald-400 mb-1">
          æœ¬å‘¨é‡ç‚¹
        </div>
        <div className="text-sm text-emerald-700 dark:text-emerald-300">
          è¿˜æ²¡æœ‰è®¾å®šæœ¬å‘¨ç›®æ ‡
        </div>
      </div>
    );
  }

  return (
    <div className="h-full min-h-[120px] rounded-2xl bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-950/30 dark:to-green-950/20 p-4 border border-emerald-100/50 dark:border-emerald-800/30">
      <div className="flex items-center justify-between mb-2">
        <span className="text-2xl">ğŸ“Š</span>
        <span className="text-lg font-bold text-emerald-700 dark:text-emerald-300">
          {completed}/{total}
        </span>
      </div>
      <div className="text-xs text-emerald-600 dark:text-emerald-400 mb-2">
        æœ¬å‘¨è¿›åº¦
      </div>

      {/* è¿›åº¦æ¡ */}
      <div className="h-2 bg-emerald-200 dark:bg-emerald-800 rounded-full overflow-hidden">
        <motion.div
          initial={{ width: 0 }}
          animate={{ width: `${percentage}%` }}
          transition={{ duration: 0.8, delay: 0.3, ease: "easeOut" }}
          className="h-full bg-gradient-to-r from-emerald-400 to-green-500 rounded-full"
        />
      </div>

      {/* æœªå®Œæˆçš„äº‹é¡¹é¢„è§ˆ */}
      {rocks.filter((r) => !r.completed).length > 0 && (
        <div className="mt-2 text-xs text-emerald-700 dark:text-emerald-300 truncate">
          â†’ {rocks.find((r) => !r.completed)?.text}
        </div>
      )}
    </div>
  );
}

/**
 * ä»Šæ—¥è¡ŒåŠ¨å¡ç‰‡
 */
function TodayActionsCard({
  levers,
  onActionClick,
}: {
  levers: Lever[];
  onActionClick: (lever: Lever) => void;
}) {
  return (
    <div className="rounded-2xl bg-gradient-to-br from-sky-50 to-blue-50 dark:from-sky-950/30 dark:to-blue-950/20 p-4 border border-sky-100/50 dark:border-sky-800/30">
      <div className="flex items-center gap-2 mb-3">
        <span className="text-xl">ğŸ¯</span>
        <span className="text-sm font-medium text-sky-900 dark:text-sky-100">
          ä»Šå¤©æœ€é‡è¦çš„äº‹
        </span>
      </div>

      <div className="space-y-2">
        {levers.slice(0, 3).map((lever) => (
          <button
            key={lever.id}
            onClick={() => onActionClick(lever)}
            className="w-full flex items-center gap-3 px-3 py-2.5 rounded-xl bg-white/60 dark:bg-white/5 hover:bg-white dark:hover:bg-white/10 border border-sky-100 dark:border-sky-800/50 text-left transition-colors group"
          >
            <span className="text-sky-500 group-hover:text-sky-600 transition-colors">
              â†’
            </span>
            <span className="flex-1 text-sm text-sky-900 dark:text-sky-100 truncate">
              {lever.text}
            </span>
            <span className="text-xs text-sky-400 opacity-0 group-hover:opacity-100 transition-opacity">
              ç‚¹å‡»èŠèŠ
            </span>
          </button>
        ))}
      </div>
    </div>
  );
}

/**
 * æ™ºèƒ½å¿«æ·å…¥å£
 */
function QuickActionsCard({
  actions,
  onAction,
}: {
  actions: Array<{ id: string; icon: string; label: string; prompt: string }>;
  onAction: (prompt: string) => void;
}) {
  return (
    <div className="rounded-2xl bg-card p-4 border border-border">
      <div className="text-sm text-muted-foreground mb-3">
        æœ‰ä»€ä¹ˆæƒ³èŠçš„ï¼Ÿ
      </div>

      <div className="flex flex-wrap gap-2">
        {actions.map((action) => (
          <button
            key={action.id}
            onClick={() => onAction(action.prompt)}
            className="flex items-center gap-1.5 px-3 py-2 rounded-full bg-muted/50 hover:bg-muted text-sm text-foreground border border-border/50 hover:border-border transition-colors"
          >
            <span>{action.icon}</span>
            <span>{action.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

export default BentoDashboard;
