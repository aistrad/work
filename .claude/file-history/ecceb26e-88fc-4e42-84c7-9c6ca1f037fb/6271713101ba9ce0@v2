"use client";

import { InputHTMLAttributes, SelectHTMLAttributes, TextareaHTMLAttributes, forwardRef, memo } from "react";
import { cn } from "@/lib/utils";

// ═══════════════════════════════════════════════════════════════════════════
// Input - v7.1 Linear 风格设计系统
// 精致输入框 + 无边框设计 + 多层阴影
// Vercel rule: rerender-memo
// ═══════════════════════════════════════════════════════════════════════════

export interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  label?: string;
  error?: string;
  variant?: "default" | "ghost" | "filled";
  inputSize?: "sm" | "md" | "lg";
  icon?: React.ReactNode;
  iconPosition?: "left" | "right";
}

export const Input = memo(forwardRef<HTMLInputElement, InputProps>(
  ({
    className,
    label,
    error,
    type = "text",
    variant = "default",
    inputSize = "md",
    icon,
    iconPosition = "left",
    ...props
  }, ref) => {
    const variants = {
      // Default: v7.1 无边框 + 多层阴影
      default: cn(
        "bg-bg-card",
        "shadow-card",
        "focus:shadow-card-hover focus:ring-2 focus:ring-accent/20"
      ),
      // Ghost: 透明背景 + 边框
      ghost: cn(
        "bg-transparent",
        "border border-subtle",
        "focus:border-accent focus:ring-2 focus:ring-accent/10"
      ),
      // Filled: 填充背景
      filled: cn(
        "bg-bg-secondary",
        "focus:bg-bg-card focus:shadow-card focus:ring-2 focus:ring-accent/20"
      ),
    };

    const sizes = {
      sm: "px-3 py-1.5 text-sm h-8",
      md: "px-4 py-2.5 text-base h-10",
      lg: "px-5 py-3 text-lg h-12",
    };

    const iconPadding = icon ? (iconPosition === "left" ? "pl-10" : "pr-10") : "";

    return (
      <div className="w-full">
        {label && (
          <label className="block text-sm font-medium text-text-secondary mb-1.5">{label}</label>
        )}
        <div className="relative">
          {icon && iconPosition === "left" && (
            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-text-tertiary">
              {icon}
            </span>
          )}
          <input
            ref={ref}
            type={type}
            className={cn(
              "w-full rounded-lg",
              "font-sans text-text-primary",
              "placeholder:text-text-disabled",
              // Web Interface Guidelines: specify properties instead of 'all'
              "transition-[box-shadow,border-color,background-color] duration-fast ease-out-expo",
              "focus:outline-none",
              "disabled:opacity-50 disabled:cursor-not-allowed",
              variants[variant],
              sizes[inputSize],
              iconPadding,
              error && "ring-2 ring-error/50 focus:ring-error",
              className
            )}
            {...props}
          />
          {icon && iconPosition === "right" && (
            <span className="absolute right-3 top-1/2 -translate-y-1/2 text-text-tertiary">
              {icon}
            </span>
          )}
        </div>
        {error && (
          <p className="mt-1.5 text-sm text-error">{error}</p>
        )}
      </div>
    );
  }
));

Input.displayName = "Input";

// ═══════════════════════════════════════════════════════════════════════════
// Select - v7.1 Dropdown select
// ═══════════════════════════════════════════════════════════════════════════

export interface SelectProps extends SelectHTMLAttributes<HTMLSelectElement> {
  label?: string;
  error?: string;
  options: Array<{ value: string; label: string }>;
  placeholder?: string;
  variant?: "default" | "ghost" | "filled";
}

export const Select = memo(forwardRef<HTMLSelectElement, SelectProps>(
  ({ className, label, error, options, placeholder, variant = "default", ...props }, ref) => {
    const variants = {
      default: cn(
        "bg-bg-card",
        "shadow-card",
        "focus:shadow-card-hover focus:ring-2 focus:ring-accent/20"
      ),
      ghost: cn(
        "bg-transparent",
        "border border-subtle",
        "focus:border-accent focus:ring-2 focus:ring-accent/10"
      ),
      filled: cn(
        "bg-bg-secondary",
        "focus:bg-bg-card focus:shadow-card focus:ring-2 focus:ring-accent/20"
      ),
    };

    return (
      <div className="w-full">
        {label && (
          <label className="block text-sm font-medium text-text-secondary mb-1.5">{label}</label>
        )}
        <select
          ref={ref}
          className={cn(
            "w-full rounded-lg px-4 py-2.5 h-10",
            "font-sans text-base text-text-primary",
            // Web Interface Guidelines: specify properties instead of 'all'
            "transition-[box-shadow,border-color,background-color] duration-fast ease-out-expo",
            "focus:outline-none",
            "disabled:opacity-50 disabled:cursor-not-allowed",
            "appearance-none cursor-pointer",
            // Web Interface Guidelines: explicit background-color and color for native selects
            "bg-bg-card text-text-primary",
            "bg-[url('data:image/svg+xml;charset=utf-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%23737373%22%20stroke-width%3D%222%22%3E%3Cpath%20d%3D%22m6%209%206%206%206-6%22%2F%3E%3C%2Fsvg%3E')] bg-no-repeat bg-[right_12px_center]",
            "pr-10",
            variants[variant],
            error && "ring-2 ring-error/50 focus:ring-error",
            className
          )}
          {...props}
        >
          {placeholder && (
            <option value="" disabled>
              {placeholder}
            </option>
          )}
          {options.map((option) => (
            <option key={option.value} value={option.value}>
              {option.label}
            </option>
          ))}
        </select>
        {error && (
          <p className="mt-1.5 text-sm text-error">{error}</p>
        )}
      </div>
    );
  }
));

Select.displayName = "Select";

// ═══════════════════════════════════════════════════════════════════════════
// Textarea - v7.1 Multi-line input
// ═══════════════════════════════════════════════════════════════════════════

export interface TextareaProps extends TextareaHTMLAttributes<HTMLTextAreaElement> {
  label?: string;
  error?: string;
  variant?: "default" | "ghost" | "filled";
}

export const Textarea = memo(forwardRef<HTMLTextAreaElement, TextareaProps>(
  ({ className, label, error, variant = "default", ...props }, ref) => {
    const variants = {
      default: cn(
        "bg-bg-card",
        "shadow-card",
        "focus:shadow-card-hover focus:ring-2 focus:ring-accent/20"
      ),
      ghost: cn(
        "bg-transparent",
        "border border-subtle",
        "focus:border-accent focus:ring-2 focus:ring-accent/10"
      ),
      filled: cn(
        "bg-bg-secondary",
        "focus:bg-bg-card focus:shadow-card focus:ring-2 focus:ring-accent/20"
      ),
    };

    return (
      <div className="w-full">
        {label && (
          <label className="block text-sm font-medium text-text-secondary mb-1.5">{label}</label>
        )}
        <textarea
          ref={ref}
          className={cn(
            "w-full rounded-lg px-4 py-3 min-h-[100px]",
            "font-sans text-base text-text-primary",
            "placeholder:text-text-disabled",
            // Web Interface Guidelines: specify properties instead of 'all'
            "transition-[box-shadow,border-color,background-color] duration-fast ease-out-expo",
            "focus:outline-none",
            "disabled:opacity-50 disabled:cursor-not-allowed",
            "resize-y",
            variants[variant],
            error && "ring-2 ring-error/50 focus:ring-error",
            className
          )}
          {...props}
        />
        {error && (
          <p className="mt-1.5 text-sm text-error">{error}</p>
        )}
      </div>
    );
  }
));

Textarea.displayName = "Textarea";

// ═══════════════════════════════════════════════════════════════════════════
// SearchInput - v7.1 搜索输入框
// ═══════════════════════════════════════════════════════════════════════════

export interface SearchInputProps extends Omit<InputProps, "icon" | "iconPosition" | "variant"> {
  onClear?: () => void;
}

export const SearchInput = memo(forwardRef<HTMLInputElement, SearchInputProps>(
  ({ className, value, onClear, ...props }, ref) => {
    return (
      <div className="relative">
        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-text-tertiary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
        </span>
        <input
          ref={ref}
          type="search"
          value={value}
          className={cn(
            "w-full rounded-lg pl-10 pr-10 py-2.5 h-10",
            "bg-bg-card shadow-card",
            "font-sans text-base text-text-primary",
            "placeholder:text-text-disabled",
            // Web Interface Guidelines: specify properties instead of 'all'
            "transition-[box-shadow,border-color,background-color] duration-fast ease-out-expo",
            "focus:outline-none focus:shadow-card-hover focus:ring-2 focus:ring-accent/20",
            className
          )}
          {...props}
        />
        {value && onClear && (
          <button
            type="button"
            onClick={onClear}
            aria-label="清除搜索内容"
            className="absolute right-3 top-1/2 -translate-y-1/2 text-text-tertiary hover:text-text-secondary transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent rounded"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
              <path d="M18 6 6 18M6 6l12 12" />
            </svg>
          </button>
        )}
      </div>
    );
  }
));

SearchInput.displayName = "SearchInput";

// ═══════════════════════════════════════════════════════════════════════════
// BirthDateInputs - Special inputs for birth date selection
// ═══════════════════════════════════════════════════════════════════════════

interface BirthDateInputsProps {
  year: string;
  month: string;
  day: string;
  hour?: string;
  onYearChange: (value: string) => void;
  onMonthChange: (value: string) => void;
  onDayChange: (value: string) => void;
  onHourChange?: (value: string) => void;
  showHour?: boolean;
  className?: string;
}

// Generate years dynamically to keep current year accurate
const currentYear = new Date().getFullYear();
const years = Array.from({ length: 100 }, (_, i) => ({
  value: String(currentYear - i),
  label: `${currentYear - i}年`,
}));

const months = Array.from({ length: 12 }, (_, i) => ({
  value: String(i + 1).padStart(2, "0"),
  label: `${i + 1}月`,
}));

const days = Array.from({ length: 31 }, (_, i) => ({
  value: String(i + 1).padStart(2, "0"),
  label: `${i + 1}日`,
}));

const hours = [
  { value: "unknown", label: "不确定" },
  { value: "23-01", label: "子时 (23:00-01:00)" },
  { value: "01-03", label: "丑时 (01:00-03:00)" },
  { value: "03-05", label: "寅时 (03:00-05:00)" },
  { value: "05-07", label: "卯时 (05:00-07:00)" },
  { value: "07-09", label: "辰时 (07:00-09:00)" },
  { value: "09-11", label: "巳时 (09:00-11:00)" },
  { value: "11-13", label: "午时 (11:00-13:00)" },
  { value: "13-15", label: "未时 (13:00-15:00)" },
  { value: "15-17", label: "申时 (15:00-17:00)" },
  { value: "17-19", label: "酉时 (17:00-19:00)" },
  { value: "19-21", label: "戌时 (19:00-21:00)" },
  { value: "21-23", label: "亥时 (21:00-23:00)" },
];

export const BirthDateInputs = memo(function BirthDateInputs({
  year,
  month,
  day,
  hour,
  onYearChange,
  onMonthChange,
  onDayChange,
  onHourChange,
  showHour = true,
  className,
}: BirthDateInputsProps) {
  return (
    <div className={cn("grid gap-3", showHour ? "grid-cols-4" : "grid-cols-3", className)}>
      <Select
        value={year}
        onChange={(e) => onYearChange(e.target.value)}
        options={years}
        placeholder="年份"
      />
      <Select
        value={month}
        onChange={(e) => onMonthChange(e.target.value)}
        options={months}
        placeholder="月份"
      />
      <Select
        value={day}
        onChange={(e) => onDayChange(e.target.value)}
        options={days}
        placeholder="日期"
      />
      {showHour && onHourChange && (
        <Select
          value={hour || "unknown"}
          onChange={(e) => onHourChange(e.target.value)}
          options={hours}
          placeholder="时辰"
        />
      )}
    </div>
  );
});
