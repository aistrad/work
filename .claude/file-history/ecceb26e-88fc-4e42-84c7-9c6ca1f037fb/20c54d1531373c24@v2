'use client'

/**
 * Membership Page - v5.2 æ€§èƒ½ä¼˜åŒ–ç‰ˆ
 * ä¼˜åŒ–:
 * 1. ç§»é™¤ framer-motionï¼Œæ·»åŠ  API è¶…æ—¶å¤„ç†
 * 2. æå–å†…è”ç»„ä»¶ä¸º memo ç»„ä»¶ (Vercel rule: rerender-extract-component)
 * 3. ä½¿ç”¨ useCallback ç¨³å®šäº‹ä»¶å¤„ç† (Vercel rule: rerender-stable-callback)
 * 4. ä½¿ç”¨ lazy state initialization (Vercel rule: rerender-functional-setstate)
 */

import { useState, useEffect, useCallback, memo } from 'react'
import { useRouter } from 'next/navigation'
import { PCLayout } from '@/components/layout/PCLayout'
import { getLocalStorageJSON } from '@/utils/storage'

const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1'

const FEATURES = [
  { icon: 'ğŸ“Š', label: 'æ¯æ—¥è¿åŠ¿(å®Œæ•´)' },
  { icon: 'ğŸ’¬', label: '30æ¬¡/å¤© AIå¯¹è¯' },
  { icon: 'ğŸ””', label: 'æ™ºèƒ½è§¦å‘æé†’' },
  { icon: 'ğŸ’', label: 'Identity Prism' },
  { icon: 'ğŸ“ˆ', label: 'å®Œæ•´å¤§è¿/æµå¹´' },
  { icon: 'ğŸ’•', label: 'å…³ç³»é…å¯¹åˆ†æ' },
]

interface Plan {
  id: string
  price: number
  currency: string
  label: string
  unit: string
  save: string | null
  recommended?: boolean
}

const DEFAULT_PLANS: Plan[] = [
  { id: 'monthly', price: 9.90, currency: 'USD', label: 'æœˆä»˜', unit: '/æœˆ', save: null },
  { id: 'quarterly', price: 24.90, currency: 'USD', label: 'å­£ä»˜', unit: '/å­£', save: 'çœ 15%', recommended: true },
  { id: 'yearly', price: 69.90, currency: 'USD', label: 'å¹´ä»˜', unit: '/å¹´', save: 'çœ 36%' },
]

const CN_PLANS: Plan[] = [
  { id: '1m', price: 39, currency: 'HKD', label: 'æœˆä»˜', unit: '/æœˆ', save: null },
  { id: '3m', price: 99, currency: 'HKD', label: 'å­£ä»˜', unit: '/å­£', save: 'çœ~15%', recommended: true },
  { id: '12m', price: 298, currency: 'HKD', label: 'å¹´ä»˜', unit: '/å¹´', save: 'çœ~36%' },
]

// Helper function
function formatPrice(price: number, currency: string): string {
  if (currency === 'HKD') return `HK$${price}`
  return `$${price.toFixed(2)}`
}

// æå–ä¸º memo ç»„ä»¶ (Vercel rule: rerender-extract-component)
interface AsideContentProps {
  region: string
}

const AsideContent = memo(function AsideContent({ region }: AsideContentProps) {
  return (
    <div className="space-y-6">
      <div className="pc-aside-section">
        <h3 className="pc-aside-title">ğŸ ä¼šå‘˜ä¸“å±</h3>
        <div className="space-y-3">
          <div className="p-4 bg-[var(--bg-callout)] rounded-lg">
            <p className="text-sm text-text-secondary">è§£é”å…¨éƒ¨é«˜çº§åŠŸèƒ½ï¼Œè·å¾—æ›´æ·±å…¥çš„å‘½ç†åˆ†æå’Œä¸ªæ€§åŒ–å»ºè®®ã€‚</p>
          </div>
        </div>
      </div>
      <div className="pc-aside-section">
        <h3 className="pc-aside-title">ğŸ›¡ï¸ ä¿éšœ</h3>
        <ul className="space-y-2 text-sm text-text-secondary">
          <li className="flex items-center gap-2"><span className="text-success">âœ“</span> 7å¤©æ— ç†ç”±é€€æ¬¾</li>
          <li className="flex items-center gap-2"><span className="text-success">âœ“</span> éšæ—¶å–æ¶ˆè®¢é˜…</li>
          <li className="flex items-center gap-2"><span className="text-success">âœ“</span> æ•°æ®å®‰å…¨åŠ å¯†</li>
        </ul>
      </div>
      <div className="pc-aside-section">
        <h3 className="pc-aside-title">ğŸ’³ æ”¯ä»˜æ–¹å¼</h3>
        <div className="flex flex-wrap gap-2 text-sm text-text-secondary">
          {region === 'CN' ? (
            <>
              <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded">æ”¯ä»˜å®</span>
              <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded">å¾®ä¿¡æ”¯ä»˜</span>
            </>
          ) : (
            <>
              <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded">Visa/Mastercard</span>
              <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded">Apple Pay</span>
            </>
          )}
        </div>
      </div>
    </div>
  )
})

interface PCContentProps {
  plans: Plan[]
  selectedPlan: string
  loading: boolean
  region: string
  onSelectPlan: (id: string) => void
  onPurchase: (planId?: string) => void
}

const PCContent = memo(function PCContent({ plans, selectedPlan, loading, region, onSelectPlan, onPurchase }: PCContentProps) {
  return (
    <div className="py-8">
      <div className="text-center mb-12">
        <h1 className="font-serif text-3xl text-text-primary mb-3">âœ¨ VibeLife Premium</h1>
        <p className="text-lg text-text-secondary">è§£é”å®Œæ•´çš„å†…å¿ƒæ¢ç´¢ä½“éªŒ</p>
      </div>

      <div className="pc-pricing-grid mb-12">
        {plans.map((plan) => (
          <div
            key={plan.id}
            className={`pc-pricing-card ${plan.recommended ? 'recommended' : ''} ${selectedPlan === plan.id ? 'selected' : ''}`}
            onClick={() => onSelectPlan(plan.id)}
          >
            {plan.recommended && <div className="pc-pricing-badge">âœ¨ æ¨è</div>}
            <div className="pc-pricing-period">{plan.label}</div>
            <div className="pc-pricing-price">{formatPrice(plan.price, plan.currency)}</div>
            <div className="pc-pricing-unit">{plan.unit}</div>
            <div className="pc-pricing-save">{plan.save || '\u00A0'}</div>
            <button
              onClick={(e) => { e.stopPropagation(); onPurchase(plan.id) }}
              disabled={loading}
              className={`pc-pricing-btn ${selectedPlan === plan.id ? 'bg-accent text-white' : 'bg-[var(--bg-secondary)] text-text-primary'}`}
            >
              {loading && selectedPlan === plan.id ? 'å¤„ç†ä¸­â€¦' : 'é€‰æ‹©'}
            </button>
          </div>
        ))}
      </div>

      {region !== 'CN' && (
        <p className="text-center text-sm text-text-secondary mb-8">
          å¤§é™†/é¦™æ¸¯ç”¨æˆ·ç‰¹æƒ ä»·æ ¼ï¼šæœˆä»˜ 39 HKD Â· å­£ä»˜ 99 HKD Â· å¹´ä»˜ 298 HKD
        </p>
      )}

      <div className="max-w-2xl mx-auto">
        <h2 className="font-serif text-xl text-text-primary text-center mb-6">âœ… åŒ…å«å…¨éƒ¨åŠŸèƒ½</h2>
        <div className="pc-feature-grid">
          {FEATURES.map((feature) => (
            <div key={feature.label} className="pc-feature-item">
              <span className="pc-feature-icon">{feature.icon}</span>
              <span>{feature.label}</span>
            </div>
          ))}
        </div>
      </div>

      <p className="text-center text-sm text-text-secondary mt-8">
        ğŸ›¡ï¸ 7å¤©æ— ç†ç”±é€€æ¬¾ä¿éšœ
      </p>
    </div>
  )
})

interface MobileContentProps {
  plans: Plan[]
  selectedPlan: string
  loading: boolean
  region: string
  onBack: () => void
  onSelectPlan: (id: string) => void
  onPurchase: () => void
}

const MobileContent = memo(function MobileContent({ plans, selectedPlan, loading, region, onBack, onSelectPlan, onPurchase }: MobileContentProps) {
  return (
    <div className="min-h-screen bg-bg-primary lg:hidden">
      <nav className="nav">
        <div className="nav-container">
          <button onClick={onBack} className="text-text-secondary">â† è¿”å›</button>
          <h1 className="font-serif text-card-title text-text-primary">å‡çº§ä¼šå‘˜</h1>
          <span className="text-small text-text-secondary">{region === 'CN' ? 'ğŸ‡¨ğŸ‡³' : 'ğŸŒ'}</span>
        </div>
      </nav>

      <main className="max-w-lg mx-auto px-4 py-6">
        <div className="text-center mb-6">
          <h2 className="font-serif text-page text-text-primary mb-2">âœ¨ VibeLife Premium</h2>
          <p className="text-helper text-text-secondary">è§£é”å®Œæ•´çš„å†…å¿ƒæ¢ç´¢ä½“éªŒ</p>
        </div>

        <div className="grid grid-cols-3 gap-3 mb-6">
          {plans.map((plan) => (
            <button
              key={plan.id}
              onClick={() => onSelectPlan(plan.id)}
              className={`card p-4 text-center transition-all relative ${selectedPlan === plan.id ? 'ring-2 ring-amber' : ''}`}
            >
              {plan.recommended && (
                <span className="absolute -top-2 left-1/2 -translate-x-1/2 text-xs bg-premium text-white px-2 py-0.5 rounded-full">æ¨è</span>
              )}
              {plan.save && <span className="text-small text-success block mb-1">{plan.save}</span>}
              <p className="font-serif text-body text-text-primary font-bold">{formatPrice(plan.price, plan.currency)}</p>
              <p className="text-small text-text-secondary">{plan.label}</p>
            </button>
          ))}
        </div>

        <div className="card p-5 mb-6">
          <h3 className="font-serif text-card-title text-text-primary mb-4 flex items-center gap-2">ğŸ‘‘ ä¼šå‘˜æƒç›Š</h3>
          <ul className="space-y-3 mb-5">
            {FEATURES.map((feature) => (
              <li key={feature.label} className="flex items-center gap-2 text-helper text-text-primary">
                <span className="text-accent">âœ“</span>
                {feature.label}
              </li>
            ))}
          </ul>
          <button
            onClick={onPurchase}
            disabled={loading}
            className="w-full bg-accent text-white font-medium py-3 rounded-md hover:bg-accent/90 transition-colors disabled:opacity-50"
          >
            {loading ? 'å¤„ç†ä¸­â€¦' : 'ç«‹å³å¼€é€š'}
          </button>
          <p className="text-small text-text-secondary text-center mt-3">
            {region === 'CN' ? 'ä¸€æ¬¡æ€§è´­ä¹°ï¼Œåˆ°æœŸéœ€æ‰‹åŠ¨ç»­è´¹' : 'è‡ªåŠ¨ç»­è´¹ï¼Œå¯éšæ—¶å–æ¶ˆ'}
          </p>
        </div>

        <div className="flex justify-center gap-4 text-small text-text-secondary">
          {region === 'CN' ? (
            <>
              <span>æ”¯ä»˜å®</span>
              <span>å¾®ä¿¡æ”¯ä»˜</span>
            </>
          ) : (
            <>
              <span>Visa/Mastercard</span>
              <span>Apple Pay</span>
            </>
          )}
        </div>
      </main>
    </div>
  )
})

export default function MembershipPage() {
  const router = useRouter()
  const [loading, setLoading] = useState(false)
  const [selectedPlan, setSelectedPlan] = useState('quarterly')
  const [region, setRegion] = useState('GLOBAL')
  const [plans, setPlans] = useState<Plan[]>(DEFAULT_PLANS)

  useEffect(() => {
    const controller = new AbortController()
    const timeoutId = setTimeout(() => controller.abort(), 3000)

    fetch(`${API_BASE}/payment/detect-region`, { signal: controller.signal })
      .then(res => res.json())
      .then(data => {
        if (data.region === 'CN') {
          setRegion('CN')
          setPlans(CN_PLANS)
          setSelectedPlan('3m')
        }
      })
      .catch(() => {})
      .finally(() => clearTimeout(timeoutId))

    return () => {
      controller.abort()
      clearTimeout(timeoutId)
    }
  }, [])

  // Stable callbacks (Vercel rule: rerender-stable-callback)
  const handleBack = useCallback(() => {
    router.back()
  }, [router])

  const handleSelectPlan = useCallback((id: string) => {
    setSelectedPlan(id)
  }, [])

  const handlePurchase = useCallback(async (planId?: string) => {
    setLoading(true)
    try {
      const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
      const targetPlan = planId || selectedPlan
      const productId = region === 'CN' ? `cn_${targetPlan}` : `global_${targetPlan}`

      const res = await fetch(`${API_BASE}/payment/create-checkout`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: user?.user_id || '',
          product_id: productId,
          metadata: { email: user?.email },
        }),
      })

      if (res.ok) {
        const data = await res.json()
        if (data.checkout_url) window.location.href = data.checkout_url
      }
    } catch (err) {
      console.error('Payment error:', err)
    } finally {
      setLoading(false)
    }
  }, [selectedPlan, region])

  const handleMobilePurchase = useCallback(() => {
    handlePurchase()
  }, [handlePurchase])

  return (
    <>
      {/* PCç«¯: ä½¿ç”¨ PCLayout ä¸‰æ å¸ƒå±€ */}
      <div className="hidden lg:block">
        <PCLayout
          breadcrumb={[
            { label: 'é¦–é¡µ', href: '/' },
            { label: 'å‡çº§ä¼šå‘˜' }
          ]}
          aside={<AsideContent region={region} />}
          showCommandBar={false}
        >
          <PCContent
            plans={plans}
            selectedPlan={selectedPlan}
            loading={loading}
            region={region}
            onSelectPlan={handleSelectPlan}
            onPurchase={handlePurchase}
          />
        </PCLayout>
      </div>

      {/* ç§»åŠ¨ç«¯: ç®€å•å•æ å¸ƒå±€ */}
      <MobileContent
        plans={plans}
        selectedPlan={selectedPlan}
        loading={loading}
        region={region}
        onBack={handleBack}
        onSelectPlan={handleSelectPlan}
        onPurchase={handleMobilePurchase}
      />
    </>
  )
}
