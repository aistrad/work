/**
 * CollectFormCard - 信息收集表单卡片
 * 支持结构化表单 + 自然语言输入双模式
 */

import React, { useState } from 'react';

interface SelectOption {
  value: string;
  label: string;
}

interface FormField {
  id?: string;        // 后端使用 id
  name?: string;      // 兼容旧格式
  type: 'date' | 'time' | 'location' | 'text' | 'select' | 'textarea';
  label: string;
  required?: boolean;
  options?: (string | SelectOption)[];  // 支持字符串或对象格式
  placeholder?: string;
}

interface CollectFormCardProps {
  formFields: FormField[];
  allowTextInput?: boolean;
  textInputPlaceholder?: string;
  onSubmit: (data: Record<string, any>) => void;
  onSkip?: () => void;
}

const CollectFormCard: React.FC<CollectFormCardProps> = ({
  formFields,
  allowTextInput = true,
  textInputPlaceholder = '请描述你的问题...',
  onSubmit,
  onSkip,
}) => {
  const [formData, setFormData] = useState<Record<string, any>>({});
  const [textInput, setTextInput] = useState('');

  const handleFieldChange = (name: string, value: any) => {
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSubmit({
      ...formData,
      ...(textInput && { question: textInput }),
    });
  };

  const renderField = (field: FormField) => {
    // 支持 id 或 name 作为字段标识
    const fieldKey = field.id || field.name || '';
    const baseClass =
      'w-full px-3 py-2 border border-white/20 bg-white/5 rounded-lg focus:ring-2 focus:ring-accent focus:border-transparent text-text-primary';

    switch (field.type) {
      case 'date':
        return (
          <input
            type="date"
            className={baseClass}
            value={formData[fieldKey] || ''}
            onChange={(e) => handleFieldChange(fieldKey, e.target.value)}
            required={field.required}
          />
        );
      case 'time':
        return (
          <input
            type="time"
            className={baseClass}
            value={formData[fieldKey] || ''}
            onChange={(e) => handleFieldChange(fieldKey, e.target.value)}
            required={field.required}
          />
        );
      case 'select':
        return (
          <select
            className={baseClass}
            value={formData[fieldKey] || ''}
            onChange={(e) => handleFieldChange(fieldKey, e.target.value)}
            required={field.required}
          >
            <option value="">请选择</option>
            {field.options?.map((opt) => {
              // 支持字符串或 {value, label} 对象格式
              const optValue = typeof opt === 'string' ? opt : opt.value;
              const optLabel = typeof opt === 'string' ? opt : opt.label;
              return (
                <option key={optValue} value={optValue}>
                  {optLabel}
                </option>
              );
            })}
          </select>
        );
      case 'textarea':
        return (
          <textarea
            className={`${baseClass} resize-none`}
            rows={3}
            placeholder={field.placeholder}
            value={formData[fieldKey] || ''}
            onChange={(e) => handleFieldChange(fieldKey, e.target.value)}
            required={field.required}
          />
        );
      default:
        return (
          <input
            type="text"
            className={baseClass}
            placeholder={field.placeholder}
            value={formData[fieldKey] || ''}
            onChange={(e) => handleFieldChange(fieldKey, e.target.value)}
            required={field.required}
          />
        );
    }
  };

  return (
    <div className="rounded-xl border border-white/10 bg-card/50 backdrop-blur-sm p-4 w-full">
      <form onSubmit={handleSubmit} className="space-y-4">
        {formFields.map((field) => {
          const fieldKey = field.id || field.name || field.label;
          return (
            <div key={fieldKey}>
              <label className="block text-sm font-medium text-text-secondary mb-1">
                {field.label}
                {field.required && <span className="text-red-400 ml-1">*</span>}
              </label>
              {renderField(field)}
            </div>
          );
        })}

        {allowTextInput && (
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              补充说明（可选）
            </label>
            <textarea
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
              rows={3}
              placeholder={textInputPlaceholder}
              value={textInput}
              onChange={(e) => setTextInput(e.target.value)}
            />
          </div>
        )}

        <div className="flex gap-3 pt-2">
          <button
            type="submit"
            className="flex-1 bg-accent text-white py-2 px-4 rounded-lg hover:bg-accent/90 transition-colors font-medium"
          >
            提交
          </button>
          {onSkip && (
            <button
              type="button"
              onClick={onSkip}
              className="px-4 py-2 text-text-secondary hover:text-text-primary transition-colors"
            >
              跳过
            </button>
          )}
        </div>
      </form>
    </div>
  );
};

export default CollectFormCard;
