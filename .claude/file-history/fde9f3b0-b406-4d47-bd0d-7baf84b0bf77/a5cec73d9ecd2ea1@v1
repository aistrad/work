import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

/**
 * Middleware - 子域名路由 + Skill 检测
 *
 * 路由规则:
 * - vibelife.app (无子域名) -> 品牌首页 (www 路由组)
 * - bazi.vibelife.app -> /bazi/* 路由组
 * - zodiac.vibelife.app -> /zodiac/* 路由组
 *
 * URL 重写示例:
 * - bazi.vibelife.app/ -> /bazi
 * - bazi.vibelife.app/chat -> /bazi/chat
 * - zodiac.vibelife.app/chat -> /zodiac/chat
 *
 * 本地开发:
 * - localhost:3000 -> 默认显示品牌首页
 * - localhost:3000/bazi -> bazi 路由
 * - localhost:3000/zodiac -> zodiac 路由
 */

// 支持的 skill 类型
const VALID_SKILLS = ["bazi", "zodiac", "mbti", "attach", "career", "lifecoach"] as const;
type ValidSkill = (typeof VALID_SKILLS)[number];

// 当前已启用的 skills (有对应路由组)
const ENABLED_SKILLS: ValidSkill[] = ["bazi", "zodiac", "lifecoach"];

// 默认 skill
const DEFAULT_SKILL: ValidSkill = "bazi";

// 共享路由（不需要 skill 前缀）
const SHARED_ROUTES = ["/auth", "/payment", "/checkout", "/interview", "/settings"];

// 检查是否是共享路由
function isSharedRoute(pathname: string): boolean {
  return SHARED_ROUTES.some((route) => pathname.startsWith(route));
}

// 检查路径是否已经包含 skill 前缀
function hasSkillPrefix(pathname: string): boolean {
  const firstSegment = pathname.split("/")[1];
  return VALID_SKILLS.includes(firstSegment as ValidSkill);
}

export default function middleware(request: NextRequest) {
  const url = request.nextUrl.clone();
  const hostname = request.headers.get("host") || "";
  const pathname = url.pathname;

  // 提取子域名
  let detectedSkill: ValidSkill | null = null;
  const parts = hostname.split(".");

  // 检测子域名
  // 格式: {skill}.vibelife.app 或 {skill}.localhost:xxxx
  if (parts.length >= 2) {
    const subdomain = parts[0].toLowerCase();
    if (ENABLED_SKILLS.includes(subdomain as ValidSkill)) {
      detectedSkill = subdomain as ValidSkill;
    }
  }

  // 检查 URL 参数 ?skill=xxx
  const urlSkillParam = url.searchParams.get("skill");
  const urlSkill = urlSkillParam && VALID_SKILLS.includes(urlSkillParam as ValidSkill)
    ? (urlSkillParam as ValidSkill)
    : null;

  // 确定最终使用的 skill
  // 优先级: URL 参数 > 子域名 > 路径前缀 > 默认
  let skill: ValidSkill;
  let shouldRewrite = false;

  if (urlSkill) {
    // URL 参数优先级最高
    skill = urlSkill;
  } else if (detectedSkill) {
    // 有子域名，使用子域名对应的 skill
    skill = detectedSkill;

    // 如果路径不是共享路由且没有 skill 前缀，需要重写
    if (!isSharedRoute(pathname) && !hasSkillPrefix(pathname)) {
      shouldRewrite = true;
    }
  } else {
    // 无子域名
    // 检查路径是否已有 skill 前缀
    const firstSegment = pathname.split("/")[1];
    if (ENABLED_SKILLS.includes(firstSegment as ValidSkill)) {
      skill = firstSegment as ValidSkill;
    } else {
      skill = DEFAULT_SKILL;
    }
  }

  // 设置 skill 到请求头
  const requestHeaders = new Headers(request.headers);
  requestHeaders.set("x-vibelife-skill", skill);

  // 处理 URL 重写（仅当有子域名时）
  if (shouldRewrite && detectedSkill) {
    // 重写路径：添加 skill 前缀
    // / -> /bazi
    // /chat -> /bazi/chat
    const newPathname = pathname === "/" ? `/${detectedSkill}` : `/${detectedSkill}${pathname}`;
    url.pathname = newPathname;

    const response = NextResponse.rewrite(url, {
      request: { headers: requestHeaders },
    });

    // 设置 cookie
    response.cookies.set("vibelife-skill", skill, {
      path: "/",
      sameSite: "lax",
      secure: process.env.NODE_ENV === "production",
      maxAge: 60 * 60 * 24 * 365,
    });

    return response;
  }

  // 普通请求（无重写）
  const response = NextResponse.next({
    request: { headers: requestHeaders },
  });

  // 设置 cookie
  response.cookies.set("vibelife-skill", skill, {
    path: "/",
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    maxAge: 60 * 60 * 24 * 365,
  });

  return response;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder files
     * - api routes
     */
    "/((?!_next/static|_next/image|favicon.ico|.*\\..*|api).*)",
  ],
};
