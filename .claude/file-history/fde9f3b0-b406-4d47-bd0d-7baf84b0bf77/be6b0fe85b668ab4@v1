import { NextResponse } from "next/server";
import type { DashboardDTO, DashboardResponse } from "@/types/dashboard";

/**
 * Dashboard API Route - Mock Data
 *
 * TODO: Replace with actual backend proxy when backend endpoint is ready
 */

function getGreeting(): string {
  const hour = new Date().getHours();
  if (hour < 6) return "å¤œæ·±äº†";
  if (hour < 12) return "æ—©ä¸Šå¥½";
  if (hour < 18) return "ä¸‹åˆå¥½";
  return "æ™šä¸Šå¥½";
}

function getTodayDate(): string {
  return new Date().toLocaleDateString("zh-CN", {
    year: "numeric",
    month: "long",
    day: "numeric",
    weekday: "long",
  });
}

const MOCK_DASHBOARD: DashboardDTO = {
  userId: "mock-user",
  generatedAt: new Date().toISOString(),

  ambient: {
    greeting: getGreeting(),
    quote: {
      text: "çŸ¥è¡Œåˆä¸€ï¼Œè‡´è‰¯çŸ¥",
      author: "ç‹é˜³æ˜",
    },
    date: getTodayDate(),
    solarTerm: "å¤§å¯’",
  },

  status: {
    streak: 7,
    checkedIn: false,
    energy: 85,
  },

  lifecoach: {
    northStar: "æˆä¸ºä¸€ä¸ªæœ‰å½±å“åŠ›çš„åˆ›ä½œè€…",
    monthlyProject: {
      name: "å®Œæˆä¸ªäººç½‘ç«™é‡æ„",
      progress: 65,
      daysRemaining: 11,
    },
    todayLevers: [
      { id: "lever-1", text: "å®Œæˆ Dashboard ç»„ä»¶å¼€å‘", completed: false },
      { id: "lever-2", text: "é˜…è¯» 30 åˆ†é’Ÿ", completed: true },
      { id: "lever-3", text: "è¿åŠ¨ 20 åˆ†é’Ÿ", completed: false },
    ],
    weekRocks: [
      { id: "rock-1", text: "å‘å¸ƒæ–°ç‰ˆæœ¬", role: "åˆ›ä½œè€…", completed: false },
      { id: "rock-2", text: "å®¶åº­èšé¤", role: "å®¶äºº", completed: true },
      { id: "rock-3", text: "å®Œæˆé¡¹ç›®ææ¡ˆ", role: "èŒåœºäºº", completed: false },
    ],
  },

  mySkills: [
    {
      skillId: "bazi",
      cardId: "bazi-daily",
      title: "å…«å­—å‘½ç›˜",
      icon: "ğŸŒŸ",
      content: {
        headline: "ä»Šæ—¥è¿åŠ¿ï¼šæœ¨æ°”æ—ºç››",
        insights: [
          "é€‚åˆå¤„ç†åˆ›æ„ç›¸å…³å·¥ä½œ",
          "äººé™…å…³ç³»é¡ºç•…",
          "è´¢è¿å¹³ç¨³",
        ],
        rating: {
          overall: 4,
          label: "å‰",
          details: {
            äº‹ä¸š: 5,
            è´¢è¿: 4,
            æ„Ÿæƒ…: 4,
          },
        },
      },
      computedAt: new Date().toISOString(),
      actionLabel: "æŸ¥çœ‹è¯¦æƒ…",
      actionRoute: "/chat?skill=bazi",
    },
  ],

  discover: [
    {
      skillId: "tarot",
      title: "å¡”ç½—å åœ",
      icon: "ğŸƒ",
      tagline: "æ¢ç´¢å‘½è¿çš„æŒ‡å¼•",
      description: "é€šè¿‡å¡”ç½—ç‰Œè·å–æ™ºæ…§å¯ç¤ºï¼Œæ´å¯Ÿäººç”Ÿæ–¹å‘",
    },
    {
      skillId: "zodiac",
      title: "æ˜Ÿåº§è§£è¯»",
      icon: "ğŸ”®",
      tagline: "æ˜Ÿè±¡æŒ‡å¼•äººç”Ÿ",
      description: "äº†è§£æ˜Ÿåº§è¿åŠ¿ï¼ŒæŠŠæ¡æœºé‡ä¸æŒ‘æˆ˜",
    },
  ],
};

// Performance: ç¼“å­˜ç­–ç•¥ - 60 ç§’å†…é‡ç”¨æ•°æ®
let cachedData: DashboardResponse | null = null;
let cacheTimestamp = 0;
const CACHE_TTL = 60 * 1000; // 60 ç§’

export async function GET() {
  const now = Date.now();

  // æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ
  if (cachedData && now - cacheTimestamp < CACHE_TTL) {
    return NextResponse.json({
      ...cachedData,
      meta: {
        cached: true,
        generatedAt: cachedData.meta?.generatedAt ?? new Date().toISOString(),
        cachedAt: new Date(cacheTimestamp).toISOString(),
      },
    });
  }

  // Simulate network delay (reduced from 300ms to 100ms)
  await new Promise((resolve) => setTimeout(resolve, 100));

  const response: DashboardResponse = {
    success: true,
    data: {
      ...MOCK_DASHBOARD,
      generatedAt: new Date().toISOString(),
      ambient: {
        ...MOCK_DASHBOARD.ambient,
        greeting: getGreeting(),
        date: getTodayDate(),
      },
    },
    meta: {
      cached: false,
      generatedAt: new Date().toISOString(),
    },
  };

  // æ›´æ–°ç¼“å­˜
  cachedData = response;
  cacheTimestamp = now;

  return NextResponse.json(response);
}

// Next.js Route Segment Config - å¯ç”¨åŠ¨æ€æ¸²æŸ“ + çŸ­æœŸç¼“å­˜
export const dynamic = 'force-dynamic';
export const revalidate = 60; // 60 ç§’åé‡æ–°ç”Ÿæˆ
