'use client'

/**
 * Settings Page - v5.1 æ€§èƒ½ä¼˜åŒ–ç‰ˆ
 * è®¾è®¡æ–‡æ¡£: payment-design-pc.md ç¬¬åç« 
 *
 * v5.1 ä¼˜åŒ–:
 * - ç§»é™¤ framer-motionï¼Œä½¿ç”¨ CSS åŠ¨ç”» (Vercel rule: bundle-dynamic-imports)
 * - ä½¿ç”¨ç¼“å­˜çš„ localStorage è¯»å– (Vercel rule: js-cache-storage)
 * - ä½¿ç”¨å‡½æ•°å¼ setState (Vercel rule: rerender-functional-setstate)
 *
 * PCç«¯å¸ƒå±€: å·¦ä¾§è®¾ç½®èœå• + å³ä¾§è®¾ç½®å†…å®¹
 * ç§»åŠ¨ç«¯å¸ƒå±€: å•æ è®¾ç½®åˆ—è¡¨
 */

import { useState, useEffect, useCallback, memo, useMemo } from 'react'
import { useRouter } from 'next/navigation'
import { PCLayout } from '@/components/layout/PCLayout'
import { BirthDateInputs } from '@/components/ui/Input'
import { getLocalStorageJSON, getAccessToken, setLocalStorageJSON } from '@/utils/storage'
import { AccountDeletionSection } from '@/components/settings/AccountDeletionSection'
import { SkillCard } from '@/components/skill'
import { useSkillSubscription, useSkills } from '@/hooks/useSkillSubscription'

// Use Next.js API routes for server communication to avoid exposing backend URL
const API_BASE = '/api'

const SETTINGS_MENU = [
  { id: 'profile', icon: 'ğŸ‘¤', label: 'ä¸ªäººèµ„æ–™' },
  { id: 'skills', icon: 'ğŸ¯', label: 'Skill ç®¡ç†' },
  { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥è®¾ç½®' },
  { id: 'privacy', icon: 'ğŸ”', label: 'éšç§ä¸å®‰å…¨' },
  { id: 'membership', icon: 'ğŸ’', label: 'ä¼šå‘˜ç®¡ç†' },
  { id: 'memory', icon: 'ğŸ§ ', label: 'è®°å¿†ç®¡ç†' },
  { id: 'preferences', icon: 'âš™ï¸', label: 'åå¥½è®¾ç½®' },
  { id: 'account', icon: 'âš ï¸', label: 'è´¦æˆ·ç®¡ç†' },
  { id: 'help', icon: 'â“', label: 'å¸®åŠ©ä¸åé¦ˆ' },
  { id: 'about', icon: 'ğŸ“„', label: 'å…³äº' },
]

interface UserProfile {
  nickname: string
  email: string
  avatar: string
  birthDate: string
  birthTime: string
  timezone: string
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Skill ç®¡ç†åŒºå—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function SkillSettingsSection({ router }: { router: ReturnType<typeof useRouter> }) {
  const { skills } = useSkills()
  const { subscriptions, togglePush, unsubscribe, userStatuses } = useSkillSubscription()

  // åˆ†ç»„
  const { subscribed, available } = useMemo(() => {
    const subscribedIds = new Set(
      subscriptions.filter(s => s.status === 'subscribed').map(s => s.skill_id)
    )
    return {
      subscribed: skills.filter(s => subscribedIds.has(s.id)),
      available: skills.filter(s => !subscribedIds.has(s.id) && s.category !== 'core'),
    }
  }, [skills, subscriptions])

  const handleTogglePush = async (skillId: string, enabled: boolean) => {
    try {
      await togglePush(skillId, enabled)
    } catch (err) {
      console.error('Toggle push failed:', err)
    }
  }

  const handleUnsubscribe = async (skillId: string) => {
    try {
      await unsubscribe(skillId)
    } catch (err) {
      console.error('Unsubscribe failed:', err)
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="font-serif text-xl text-text-primary">Skill ç®¡ç†</h2>
        <button
          onClick={() => router.push('/skills')}
          className="text-sm text-accent hover:underline"
        >
          æ¢ç´¢æ›´å¤š â†’
        </button>
      </div>

      {/* å·²è®¢é˜… */}
      <div>
        <h3 className="text-sm font-medium text-text-secondary mb-3">
          å·²è®¢é˜… ({subscribed.length})
        </h3>
        <div className="space-y-2">
          {subscribed.map((skill) => {
            const sub = subscriptions.find(s => s.skill_id === skill.id)
            const isCore = skill.category === 'core'
            return (
              <div key={skill.id} className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)]">
                <div
                  className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
                  style={{ backgroundColor: `${skill.color}20` }}
                >
                  {skill.icon}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="font-medium text-text-primary">{skill.name}</span>
                    {isCore && (
                      <span className="px-1.5 py-0.5 text-xs rounded bg-accent/10 text-accent">
                        å§‹ç»ˆæ¿€æ´»
                      </span>
                    )}
                  </div>
                  <p className="text-xs text-text-secondary truncate">
                    {skill.features?.slice(0, 2).map(f => f.name).join(' Â· ')}
                  </p>
                </div>
                {!isCore && (
                  <div className="flex items-center gap-3">
                    <div className="flex items-center gap-2">
                      <span className="text-xs text-text-tertiary">æ¨é€</span>
                      <label className="relative inline-flex items-center cursor-pointer">
                        <input
                          type="checkbox"
                          checked={sub?.push_enabled ?? false}
                          onChange={(e) => handleTogglePush(skill.id, e.target.checked)}
                          className="sr-only peer"
                        />
                        <div className="w-9 h-5 bg-[var(--bg-secondary)] peer-focus:ring-2 peer-focus:ring-accent/50 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent" />
                      </label>
                    </div>
                    <button
                      onClick={() => handleUnsubscribe(skill.id)}
                      className="text-xs text-error hover:underline"
                    >
                      å–æ¶ˆ
                    </button>
                  </div>
                )}
              </div>
            )
          })}
        </div>
      </div>

      {/* å¯è®¢é˜… */}
      {available.length > 0 && (
        <div>
          <h3 className="text-sm font-medium text-text-secondary mb-3">
            å¯è®¢é˜… ({available.length})
          </h3>
          <div className="space-y-2">
            {available.slice(0, 3).map((skill) => (
              <div
                key={skill.id}
                onClick={() => router.push(`/skills/${skill.id}`)}
                className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)] cursor-pointer hover:bg-[var(--bg-secondary)] transition-colors"
              >
                <div
                  className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
                  style={{ backgroundColor: `${skill.color}20` }}
                >
                  {skill.icon}
                </div>
                <div className="flex-1 min-w-0">
                  <span className="font-medium text-text-primary">{skill.name}</span>
                  <p className="text-xs text-text-secondary truncate">
                    {skill.showcase?.tagline || skill.description}
                  </p>
                </div>
                <button className="px-3 py-1 text-xs rounded-full bg-accent text-white">
                  è®¢é˜…
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

export default function SettingsPage() {
  const router = useRouter()
  const [activeSection, setActiveSection] = useState('profile')
  const [loading, setLoading] = useState(false)
  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic" | "wise">("warm")
  const [profile, setProfile] = useState<UserProfile>(() => ({
    nickname: 'ç”¨æˆ·',
    email: 'user@example.com',
    avatar: 'ğŸ‘¤',
    // Do not prefill with fake defaults; leave empty until loaded
    birthDate: '',
    birthTime: '',
    timezone: 'Asia/Shanghai',
  }))
  // Local Y/M/D states for better date UX (year select solves typing issue)
  const [birthYear, setBirthYear] = useState('')
  const [birthMonth, setBirthMonth] = useState('')
  const [birthDay, setBirthDay] = useState('')

  useEffect(() => {
    // Prefer authoritative profile from API; fall back to cached localStorage
    const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
    if (user) {
      setProfile(prev => ({
        ...prev,
        nickname: user.nickname || user.display_name || 'ç”¨æˆ·',
        email: user.email || '',
        avatar: user.avatar || 'ğŸ‘¤',
        timezone: user.timezone || 'Asia/Shanghai',
      }))
    }

    const token = getAccessToken()
    if (!token) return

    // Fetch current profile to populate birth date/time accurately
    fetch(`${API_BASE}/profile`, {
      headers: { 'Authorization': `Bearer ${token}` }
    })
      .then(async (res) => {
        if (!res.ok) return null
        return res.json()
      })
      .then((data) => {
        if (!data) return
        // Parse ISO like "YYYY-MM-DDTHH:MM:SS" without TZ shift
        const iso: string | undefined = data.birth_datetime
        let birthDate = ''
        let birthTime = ''
        if (iso && typeof iso === 'string') {
          const [d, t] = iso.split('T')
          birthDate = d || ''
          if (t) birthTime = t.slice(0, 5) // HH:MM
        }

        setProfile(prev => ({
          ...prev,
          nickname: data.display_name ?? prev.nickname,
          avatar: data.avatar_url ? 'ğŸ‘¤' : prev.avatar,
          birthDate,
          birthTime,
          timezone: data.timezone || prev.timezone,
        }))
      })
      .catch(() => {})

    // Load voice mode preference
    fetch(`${API_BASE}/preferences`, {
      headers: { 'Authorization': `Bearer ${token}` }
    })
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data?.voice_mode) {
          setVoiceModeState(data.voice_mode as "warm" | "sarcastic" | "wise")
        }
      })
      .catch(() => {})
  }, [])

  // Save voice mode to API
  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic" | "wise") => {
    setVoiceModeState(mode)
    const token = getAccessToken()
    if (!token) return
    try {
      await fetch(`${API_BASE}/preferences`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ voice_mode: mode })
      })
    } catch (error) {
      console.error('Failed to save voice mode:', error)
    }
  }, [])

  // Keep local Y/M/D in sync when profile.birthDate changes (e.g., loaded from API)
  useEffect(() => {
    const [y, m, d] = (profile.birthDate || '').split('-')
    setBirthYear(y || '')
    setBirthMonth(m || '')
    setBirthDay(d || '')
  }, [profile.birthDate])

  // Use useCallback for stable reference (Vercel rule: rerender-functional-setstate)
  const handleProfileChange = useCallback((field: keyof UserProfile, value: string) => {
    setProfile(prev => ({ ...prev, [field]: value }))
  }, [])

  const handleSaveProfile = useCallback(async () => {
    setLoading(true)
    try {
      const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
      const token = getAccessToken()

      if (user?.user_id && token) {
        const body: any = {
          display_name: profile.nickname,
          timezone: profile.timezone,
        }
        // When both date and time present -> set; otherwise explicitly clear on server
        if (profile.birthDate && profile.birthTime) {
          body.birth_datetime = `${profile.birthDate}T${profile.birthTime}:00`
        } else {
          body.birth_datetime = null
        }

        const res = await fetch(`${API_BASE}/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(body),
        })

        if (res.ok) {
          // Update local cache with normalized values
          setLocalStorageJSON('user', {
            ...user,
            nickname: profile.nickname,
            display_name: profile.nickname,
            birth_date: profile.birthDate || undefined,
            birth_time: profile.birthTime || undefined,
            timezone: profile.timezone,
          })
        }
      }
    } catch (err) {
      console.error('Failed to save profile:', err)
    } finally {
      setLoading(false)
    }
  }, [profile])

  // è®¾ç½®å†…å®¹åŒºåŸŸ
  const SettingsContent = () => {
    switch (activeSection) {
      case 'profile':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">ä¸ªäººèµ„æ–™</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-text-secondary mb-2">å¤´åƒ</label>
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 rounded-full bg-[var(--bg-secondary)] flex items-center justify-center text-3xl">
                    {profile.avatar}
                  </div>
                  <button className="btn btn-secondary">æ›´æ¢å¤´åƒ</button>
                </div>
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">æ˜µç§°</label>
                <input
                  type="text"
                  value={profile.nickname}
                  onChange={(e) => handleProfileChange('nickname', e.target.value)}
                  className="input"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">é‚®ç®±</label>
                <input
                  type="email"
                  value={profile.email}
                  disabled
                  className="input bg-[var(--bg-secondary)]"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¥æœŸ</label>
                <BirthDateInputs
                  year={birthYear}
                  month={birthMonth}
                  day={birthDay}
                  onYearChange={(v) => {
                    setBirthYear(v)
                    const dateStr = v && birthMonth && birthDay ? `${v}-${birthMonth}-${birthDay}` : ''
                    handleProfileChange('birthDate', dateStr)
                  }}
                  onMonthChange={(v) => {
                    setBirthMonth(v)
                    const dateStr = birthYear && v && birthDay ? `${birthYear}-${v}-${birthDay}` : ''
                    handleProfileChange('birthDate', dateStr)
                  }}
                  onDayChange={(v) => {
                    setBirthDay(v)
                    const dateStr = birthYear && birthMonth && v ? `${birthYear}-${birthMonth}-${v}` : ''
                    handleProfileChange('birthDate', dateStr)
                  }}
                  showHour={false}
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¶é—´</label>
                <div className="flex items-center gap-3">
                  <input
                    type="time"
                    step={60}
                    value={profile.birthTime}
                    onChange={(e) => handleProfileChange('birthTime', e.target.value)}
                    className="input"
                    placeholder="--:--"
                  />
                  <label className="inline-flex items-center gap-2 text-sm text-text-secondary">
                    <input
                      type="checkbox"
                      checked={!profile.birthTime}
                      onChange={(e) => handleProfileChange('birthTime', e.target.checked ? '' : '12:00')}
                    />
                    ä¸ç¡®å®š
                  </label>
                </div>
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">æ—¶åŒº</label>
                <select
                  value={profile.timezone}
                  onChange={(e) => handleProfileChange('timezone', e.target.value)}
                  className="input"
                >
                  <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
                  <option value="Asia/Hong_Kong">Asia/Hong_Kong (UTC+8)</option>
                  <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
                  <option value="America/New_York">America/New_York (UTC-5)</option>
                  <option value="America/Los_Angeles">America/Los_Angeles (UTC-8)</option>
                  <option value="Europe/London">Europe/London (UTC+0)</option>
                </select>
              </div>
              <button onClick={handleSaveProfile} disabled={loading} className="btn btn-primary">
                {loading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜æ›´æ”¹'}
              </button>
            </div>
          </div>
        )
      case 'skills':
        return <SkillSettingsSection router={router} />
      case 'notifications':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">é€šçŸ¥è®¾ç½®</h2>
            <div className="space-y-4">
              {[
                { id: 'daily', label: 'æ¯æ—¥è¿åŠ¿æé†’', desc: 'æ¯å¤©æ—©ä¸Šæ¨é€ä»Šæ—¥è¿åŠ¿' },
                { id: 'astro', label: 'æ˜Ÿè±¡äº‹ä»¶æé†’', desc: 'é‡è¦æ˜Ÿè±¡äº‹ä»¶ï¼ˆæ°´é€†ã€æ»¡æœˆç­‰ï¼‰' },
                { id: 'memory', label: 'è®°å¿†æ›´æ–°æé†’', desc: 'å½“ VibeLife æœ‰æ–°çš„æ´å¯Ÿæ—¶' },
                { id: 'promo', label: 'ä¼˜æƒ æ´»åŠ¨é€šçŸ¥', desc: 'ä¼šå‘˜ä¼˜æƒ å’Œæ´»åŠ¨ä¿¡æ¯' },
              ].map((item) => (
                <div key={item.id} className="flex items-center justify-between p-4 bg-[var(--bg-card-alt)] rounded-lg">
                  <div>
                    <p className="text-text-primary font-medium">{item.label}</p>
                    <p className="text-sm text-text-secondary">{item.desc}</p>
                  </div>
                  <label className="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" defaultChecked className="sr-only peer" />
                    <div className="w-11 h-6 bg-[var(--bg-secondary)] peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                  </label>
                </div>
              ))}
            </div>
          </div>
        )
      case 'membership':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">ä¼šå‘˜ç®¡ç†</h2>
            <div className="card p-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <p className="text-text-primary font-medium">å½“å‰çŠ¶æ€</p>
                  <p className="text-sm text-text-secondary">å…è´¹ç”¨æˆ·</p>
                </div>
                <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded-full text-sm text-text-secondary">Free</span>
              </div>
              <button onClick={() => router.push('/membership')} className="btn btn-premium w-full">
                âœ¨ å‡çº§ Premium
              </button>
            </div>
            <div className="space-y-3">
              <p className="text-sm text-text-secondary">Premium ä¼šå‘˜æƒç›Šï¼š</p>
              <ul className="space-y-2 text-sm text-text-secondary">
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´æ¯æ—¥è¿åŠ¿</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> 30æ¬¡/å¤© AIå¯¹è¯</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´å¤§è¿/æµå¹´åˆ†æ</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> Identity Prism æ·±åº¦è§£è¯»</li>
              </ul>
            </div>
          </div>
        )
      case 'memory':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">è®°å¿†ç®¡ç†</h2>
            <p className="text-sm text-text-secondary">VibeLife ä¼šè®°ä½ä½ åˆ†äº«çš„ä¿¡æ¯ï¼Œä»¥æä¾›æ›´ä¸ªæ€§åŒ–çš„ä½“éªŒã€‚</p>
            <div className="space-y-3">
              {[
                { content: 'ä½ æœ€è¿‘å·¥ä½œå‹åŠ›è¾ƒå¤§', date: '2å¤©å‰' },
                { content: 'å…³æ³¨èŒä¸šå‘å±•æ–¹å‘', date: '1å‘¨å‰' },
                { content: 'å¯¹æ„Ÿæƒ…é—®é¢˜æœ‰å›°æ‰°', date: '2å‘¨å‰' },
              ].map((memory, i) => (
                <div key={i} className="flex items-center justify-between p-4 bg-[var(--bg-callout)] rounded-lg">
                  <div>
                    <p className="text-text-primary">{memory.content}</p>
                    <p className="text-xs text-text-secondary mt-1">{memory.date}</p>
                  </div>
                  <button className="text-sm text-error">åˆ é™¤</button>
                </div>
              ))}
            </div>
            <button className="text-sm text-error">æ¸…é™¤æ‰€æœ‰è®°å¿†</button>
          </div>
        )
      case 'account':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">è´¦æˆ·ç®¡ç†</h2>
            <AccountDeletionSection />
          </div>
        )
      case 'preferences':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">åå¥½è®¾ç½®</h2>
            <div className="space-y-4">
              {/* è¯­æ°”æ¨¡å¼ */}
              <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
                <div className="mb-3">
                  <h3 className="text-text-primary font-medium mb-1">è¯­æ°”æ¨¡å¼</h3>
                  <p className="text-sm text-text-secondary">é€‰æ‹© AI çš„å¯¹è¯é£æ ¼</p>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={() => setVoiceMode('warm')}
                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                      voiceMode === 'warm'
                        ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 shadow-sm'
                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
                    }`}
                  >
                    <div className="text-2xl mb-1">ğŸŒ</div>
                    <div>æ¸©æš–æ”¯æŒ</div>
                  </button>
                  <button
                    onClick={() => setVoiceMode('sarcastic')}
                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                      voiceMode === 'sarcastic'
                        ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 shadow-sm'
                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
                    }`}
                  >
                    <div className="text-2xl mb-1">ğŸ˜ˆ</div>
                    <div>ç›´æ¥æŒ‘æˆ˜</div>
                  </button>
                  <button
                    onClick={() => setVoiceMode('wise')}
                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                      voiceMode === 'wise'
                        ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 shadow-sm'
                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
                    }`}
                  >
                    <div className="text-2xl mb-1">ğŸ§™</div>
                    <div>ç¿æ™ºå¯¼å¸ˆ</div>
                  </button>
                </div>
                <div className="mt-3 p-3 bg-[var(--bg-callout)] rounded text-xs text-text-secondary">
                  {voiceMode === 'warm' && 'ğŸ’­ åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿ'}
                  {voiceMode === 'sarcastic' && 'ğŸ’­ ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸'}
                  {voiceMode === 'wise' && 'ğŸ’­ åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒ'}
                </div>
              </div>
            </div>
          </div>
        )
      case 'about':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">å…³äº VibeLife</h2>
            <div className="text-center py-8">
              <span className="text-5xl mb-4 block">ğŸŒŸ</span>
              <h3 className="font-serif text-2xl text-text-primary mb-2">VibeLife</h3>
              <p className="text-text-secondary mb-4">æ¢ç´¢å†…å¿ƒä¸–ç•Œ</p>
              <p className="text-sm text-text-secondary">ç‰ˆæœ¬ 5.0.0</p>
            </div>
            <div className="space-y-2 text-sm text-text-secondary">
              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">ç”¨æˆ·åè®®</button>
              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">éšç§æ”¿ç­–</button>
              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">è”ç³»æˆ‘ä»¬</button>
            </div>
          </div>
        )
      default:
        return (
          <div className="text-center py-8 text-text-secondary">
            <p>è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
          </div>
        )
    }
  }

  // PCç«¯å³ä¾§è¾¹æ  - è®¾ç½®èœå•
  const AsideContent = () => (
    <div className="space-y-2">
      {SETTINGS_MENU.map((item) => (
        <button
          key={item.id}
          onClick={() => setActiveSection(item.id)}
          className={`w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors ${
            activeSection === item.id
              ? 'bg-accent/10 text-accent'
              : 'text-text-secondary hover:bg-[var(--bg-secondary)]'
          }`}
        >
          <span className="text-lg">{item.icon}</span>
          <span className="text-sm">{item.label}</span>
        </button>
      ))}
      <div className="pt-4 mt-4 border-t border-[var(--border-light)]">
        <button className="w-full flex items-center gap-3 p-3 rounded-lg text-left text-error hover:bg-error/5 transition-colors">
          <span className="text-lg">ğŸšª</span>
          <span className="text-sm">é€€å‡ºç™»å½•</span>
        </button>
      </div>
    </div>
  )

  // PCç«¯ä¸»å†…å®¹
  const PCContent = () => (
    <div className="card p-6">
      <SettingsContent />
    </div>
  )

  // ç§»åŠ¨ç«¯å†…å®¹
  const MobileContent = () => (
    <div className="min-h-screen bg-bg-primary lg:hidden">
      <nav className="nav">
        <div className="nav-container">
          <button onClick={() => router.back()} className="text-text-secondary">â† è¿”å›</button>
          <h1 className="font-serif text-card-title text-text-primary">è®¾ç½®</h1>
          <div className="w-8" />
        </div>
      </nav>

      <main className="max-w-lg mx-auto px-4 py-6">
        <div className="space-y-2">
          {SETTINGS_MENU.map((item, index) => (
            <button
              key={item.id}
              onClick={() => {
                if (item.id === 'membership') {
                  router.push('/membership')
                } else {
                  setActiveSection(item.id)
                }
              }}
              className="w-full card p-4 flex items-center gap-3 animate-slide-in-up stagger-item"
              style={{ animationDelay: `${index * 50}ms` }}
            >
              <span className="text-xl">{item.icon}</span>
              <span className="text-text-primary">{item.label}</span>
              <span className="ml-auto text-text-secondary">â€º</span>
            </button>
          ))}
        </div>

        <div className="mt-8">
          <button className="w-full p-4 text-center text-error">é€€å‡ºç™»å½•</button>
        </div>

        <div className="mt-8 text-center text-sm text-text-secondary">
          <p>VibeLife v5.0.0</p>
        </div>
      </main>
    </div>
  )

  return (
    <>
      {/* PCç«¯: ä½¿ç”¨ PCLayout ä¸‰æ å¸ƒå±€ */}
      <div className="hidden lg:block">
        <PCLayout
          breadcrumb={[
            { label: 'é¦–é¡µ', href: '/' },
            { label: 'è®¾ç½®' }
          ]}
          aside={<AsideContent />}
          showCommandBar={false}
        >
          <PCContent />
        </PCLayout>
      </div>

      {/* ç§»åŠ¨ç«¯: ç®€å•å•æ å¸ƒå±€ */}
      <MobileContent />
    </>
  )
}
