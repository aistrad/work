/**
 * CollectFormCard - 信息收集表单卡片
 * 支持结构化表单 + 自然语言输入双模式
 */

import React, { useState } from 'react';

interface SelectOption {
  value: string;
  label: string;
}

interface FormField {
  id?: string;        // 后端使用 id
  name?: string;      // 兼容旧格式
  type: 'date' | 'time' | 'location' | 'text' | 'select' | 'textarea';
  label: string;
  required?: boolean;
  options?: (string | SelectOption)[];  // 支持字符串或对象格式
  placeholder?: string;
}

interface CollectFormCardProps {
  formFields: FormField[];
  allowTextInput?: boolean;
  textInputPlaceholder?: string;
  onSubmit: (data: Record<string, any>) => void;
  onSkip?: () => void;
}

const CollectFormCard: React.FC<CollectFormCardProps> = ({
  formFields,
  allowTextInput = true,
  textInputPlaceholder = '请描述你的问题...',
  onSubmit,
  onSkip,
}) => {
  const [formData, setFormData] = useState<Record<string, any>>({});
  const [textInput, setTextInput] = useState('');

  const handleFieldChange = (name: string, value: any) => {
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    onSubmit({
      ...formData,
      ...(textInput && { question: textInput }),
    });
  };

  const renderField = (field: FormField) => {
    const baseClass =
      'w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent';

    switch (field.type) {
      case 'date':
        return (
          <input
            type="date"
            className={baseClass}
            value={formData[field.name] || ''}
            onChange={(e) => handleFieldChange(field.name, e.target.value)}
            required={field.required}
          />
        );
      case 'time':
        return (
          <input
            type="time"
            className={baseClass}
            value={formData[field.name] || ''}
            onChange={(e) => handleFieldChange(field.name, e.target.value)}
            required={field.required}
          />
        );
      case 'select':
        return (
          <select
            className={baseClass}
            value={formData[field.name] || ''}
            onChange={(e) => handleFieldChange(field.name, e.target.value)}
            required={field.required}
          >
            <option value="">请选择</option>
            {field.options?.map((opt) => (
              <option key={opt} value={opt}>
                {opt}
              </option>
            ))}
          </select>
        );
      default:
        return (
          <input
            type="text"
            className={baseClass}
            placeholder={field.placeholder}
            value={formData[field.name] || ''}
            onChange={(e) => handleFieldChange(field.name, e.target.value)}
            required={field.required}
          />
        );
    }
  };

  return (
    <div className="bg-white rounded-xl shadow-lg p-6 w-full md:max-w-md mx-auto">
      <form onSubmit={handleSubmit} className="space-y-4">
        {formFields.map((field) => (
          <div key={field.name}>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </label>
            {renderField(field)}
          </div>
        ))}

        {allowTextInput && (
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              补充说明（可选）
            </label>
            <textarea
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
              rows={3}
              placeholder={textInputPlaceholder}
              value={textInput}
              onChange={(e) => setTextInput(e.target.value)}
            />
          </div>
        )}

        <div className="flex gap-3 pt-2">
          <button
            type="submit"
            className="flex-1 bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors font-medium"
          >
            提交
          </button>
          {onSkip && (
            <button
              type="button"
              onClick={onSkip}
              className="px-4 py-2 text-gray-600 hover:text-gray-800 transition-colors"
            >
              跳过
            </button>
          )}
        </div>
      </form>
    </div>
  );
};

export default CollectFormCard;
