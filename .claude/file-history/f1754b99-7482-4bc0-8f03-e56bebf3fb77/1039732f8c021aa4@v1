"use client";

/**
 * DynamicQuickActions - åŠ¨æ€å¿«æ·æ“ä½œæŒ‰é’®
 *
 * æ ¹æ®ç”¨æˆ·çŠ¶æ€è‡ªåŠ¨è°ƒæ•´æ˜¾ç¤ºçš„æŒ‰é’®ï¼š
 * 1. æœªç­¾åˆ° â†’ æ˜¾ç¤º"å¼€å§‹ä»Šå¤©"
 * 2. æœ‰æœªå®Œæˆæ æ† â†’ æ˜¾ç¤ºå…·ä½“è¡ŒåŠ¨é¡¹
 * 3. å‘¨äº”/å‘¨å…­/å‘¨æ—¥ â†’ æ˜¾ç¤º"å‘¨å¤ç›˜"
 * 4. æ— åŒ—ææ˜Ÿ â†’ æ˜¾ç¤º"æ‰¾åˆ°æ–¹å‘"
 */

import { useMemo, useCallback } from "react";
import { useRouter } from "next/navigation";
import { cn } from "@/lib/utils";
import { toast } from "sonner";

interface StatusData {
  streak: number;
  checkedIn: boolean;
  energy?: number;
}

interface LifecoachData {
  northStar?: string;
  todayLevers: Array<{ id: string; text: string; completed: boolean }>;
}

interface QuickAction {
  id: string;
  icon: string;
  label: string;
  prompt?: string;      // å‘é€åˆ°å¯¹è¯çš„ prompt
  route?: string;       // æˆ–è·³è½¬åˆ°ç‰¹å®šé¡µé¢
  handler?: () => Promise<void>; // æˆ–æ‰§è¡Œç‰¹å®šæ“ä½œ
}

interface DynamicQuickActionsProps {
  status: StatusData;
  lifecoach: LifecoachData;
  onCheckIn: () => Promise<void>;
  onSendPrompt?: (prompt: string) => void;
  className?: string;
}

export function DynamicQuickActions({
  status,
  lifecoach,
  onCheckIn,
  onSendPrompt,
  className
}: DynamicQuickActionsProps) {
  const router = useRouter();

  // æ ¹æ®ç”¨æˆ·çŠ¶æ€åŠ¨æ€ç”ŸæˆæŒ‰é’®
  const actions = useMemo(() => {
    const list: QuickAction[] = [];

    // 1. ç­¾åˆ°ï¼ˆæœªç­¾åˆ°æ—¶æ˜¾ç¤ºï¼‰
    if (!status.checkedIn) {
      list.push({
        id: "checkin",
        icon: "ğŸŒ…",
        label: "å¼€å§‹ä»Šå¤©",
        handler: async () => {
          await onCheckIn();
          toast.success(`ç­¾åˆ°æˆåŠŸï¼è¿ç»­ ${status.streak + 1} å¤© ğŸ”¥`);
        }
      });
    }

    // 2. ä»Šæ—¥è¡ŒåŠ¨ï¼ˆæœ‰æœªå®Œæˆæ æ†æ—¶ï¼‰
    const uncompletedLevers = lifecoach.todayLevers.filter(l => !l.completed);
    if (uncompletedLevers.length > 0) {
      const firstLever = uncompletedLevers[0];
      // æˆªå–å‰ 8 ä¸ªå­—ç¬¦
      const shortText = firstLever.text.length > 8
        ? firstLever.text.slice(0, 8) + "..."
        : firstLever.text;

      list.push({
        id: "today_action",
        icon: "ğŸ’ª",
        label: shortText,
        prompt: `å¸®æˆ‘å®Œæˆï¼š${firstLever.text}`
      });
    }

    // 3. å‘¨å¤ç›˜ï¼ˆå‘¨äº”/å‘¨å…­/å‘¨æ—¥æ˜¾ç¤ºï¼‰
    const today = new Date().getDay();
    if ([5, 6, 0].includes(today)) {
      list.push({
        id: "weekly_review",
        icon: "ğŸ“",
        label: "å‘¨å¤ç›˜",
        route: "/chat?skill=lifecoach&scenario=weekly-review&prompt=å‘¨å¤ç›˜"
      });
    }

    // 4. è®¾å®šç›®æ ‡ï¼ˆæ²¡æœ‰åŒ—ææ˜Ÿæ—¶ï¼‰
    if (!lifecoach.northStar) {
      list.push({
        id: "set_vision",
        icon: "â­",
        label: "æ‰¾åˆ°æ–¹å‘",
        route: "/chat?skill=lifecoach&scenario=dankoe&prompt=æˆ‘æƒ³æ‰¾åˆ°äººç”Ÿæ–¹å‘"
      });
    }

    // 5. é»˜è®¤ï¼šè‡ªç”±å¯¹è¯ï¼ˆä½œä¸ºå…œåº•ï¼‰
    if (list.length < 3) {
      list.push({
        id: "chat",
        icon: "ğŸ’¬",
        label: "è‡ªç”±å¯¹è¯",
        prompt: "å—¨"
      });
    }

    // æœ€å¤šæ˜¾ç¤º 3 ä¸ªæŒ‰é’®
    return list.slice(0, 3);
  }, [status, lifecoach]);

  const handleAction = useCallback(async (action: QuickAction) => {
    if (action.handler) {
      // æ‰§è¡Œè‡ªå®šä¹‰æ“ä½œï¼ˆå¦‚ç­¾åˆ°ï¼‰
      await action.handler();
    } else if (action.route) {
      // è·³è½¬åˆ°ç‰¹å®šé¡µé¢
      router.push(action.route);
    } else if (action.prompt && onSendPrompt) {
      // å‘é€ prompt åˆ°å¯¹è¯
      onSendPrompt(action.prompt);
    }
  }, [router, onSendPrompt]);

  return (
    <div className={cn("flex gap-2", className)}>
      {actions.map((action) => (
        <button
          key={action.id}
          onClick={() => handleAction(action)}
          className="flex-1 px-3 py-2 rounded-xl bg-gradient-to-r from-emerald-500 to-green-600 text-white text-sm font-medium shadow-sm hover:shadow-md hover:scale-105 transition-all duration-200"
        >
          <span className="mr-1">{action.icon}</span>
          <span>{action.label}</span>
        </button>
      ))}
    </div>
  );
}
