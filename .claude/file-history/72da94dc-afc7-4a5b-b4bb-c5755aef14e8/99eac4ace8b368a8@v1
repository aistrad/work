/**
 * VibeLife API Client
 */

const API_BASE = process.env.NEXT_PUBLIC_API_BASE || "http://localhost:8000/api/v1";

// ─────────────────────────────────────────────────────────────────
// Types
// ─────────────────────────────────────────────────────────────────

export interface TokenResponse {
  access_token: string;
  refresh_token: string;
  token_type: string;
  expires_in: number;
  user: {
    user_id: string;
    vibe_id: string;
    display_name?: string;
  };
}

export interface ChatRequest {
  message: string;
  skill_id: string;
  conversation_id?: string;
}

export interface ChatResponse {
  content: string;
  conversation_id: string;
  intent?: string;
  tools_used?: string[];
  knowledge_used: boolean;
  insight?: {
    id: string;
    insight_type: string;
    title: string;
    content: string;
  };
  suggestions?: string[];
}

// ─────────────────────────────────────────────────────────────────
// Token Management
// ─────────────────────────────────────────────────────────────────

let accessToken: string | null = null;
let refreshToken: string | null = null;

export function setTokens(access: string, refresh: string) {
  accessToken = access;
  refreshToken = refresh;
  if (typeof window !== "undefined") {
    localStorage.setItem("access_token", access);
    localStorage.setItem("refresh_token", refresh);
  }
}

export function getTokens() {
  if (typeof window !== "undefined") {
    accessToken = localStorage.getItem("access_token");
    refreshToken = localStorage.getItem("refresh_token");
  }
  return { accessToken, refreshToken };
}

export function clearTokens() {
  accessToken = null;
  refreshToken = null;
  if (typeof window !== "undefined") {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    localStorage.removeItem("user");
  }
}

// ─────────────────────────────────────────────────────────────────
// API Helpers
// ─────────────────────────────────────────────────────────────────

async function fetchAPI(
  endpoint: string,
  options: RequestInit = {}
): Promise<Response> {
  const { accessToken } = getTokens();

  const headers: Record<string, string> = {
    "Content-Type": "application/json",
    ...options.headers as Record<string, string>,
  };

  if (accessToken) {
    headers["Authorization"] = `Bearer ${accessToken}`;
  }

  const response = await fetch(`${API_BASE}${endpoint}`, {
    ...options,
    headers,
  });

  // Handle 401 - try to refresh token
  if (response.status === 401 && refreshToken) {
    const refreshed = await refreshAccessToken();
    if (refreshed) {
      headers["Authorization"] = `Bearer ${accessToken}`;
      return fetch(`${API_BASE}${endpoint}`, { ...options, headers });
    }
  }

  return response;
}

async function refreshAccessToken(): Promise<boolean> {
  try {
    const response = await fetch(`${API_BASE}/auth/refresh`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: refreshToken }),
    });

    if (response.ok) {
      const data: TokenResponse = await response.json();
      setTokens(data.access_token, data.refresh_token);
      return true;
    }
  } catch (error) {
    console.error("Token refresh failed:", error);
  }

  clearTokens();
  return false;
}

// ─────────────────────────────────────────────────────────────────
// Auth API
// ─────────────────────────────────────────────────────────────────

export async function register(
  email: string,
  password: string,
  displayName?: string
): Promise<TokenResponse> {
  const response = await fetch(`${API_BASE}/auth/register`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password, display_name: displayName }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Registration failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}

export async function login(
  email: string,
  password: string
): Promise<TokenResponse> {
  const response = await fetch(`${API_BASE}/auth/login`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Login failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}

export async function logout(): Promise<void> {
  try {
    await fetchAPI("/auth/logout", { method: "POST" });
  } finally {
    clearTokens();
  }
}

export async function getMe() {
  const response = await fetchAPI("/auth/me");
  if (!response.ok) throw new Error("Failed to get user");
  return response.json();
}

// ─────────────────────────────────────────────────────────────────
// Chat API
// ─────────────────────────────────────────────────────────────────

export async function sendMessage(request: ChatRequest): Promise<ChatResponse> {
  const response = await fetchAPI("/chat/", {
    method: "POST",
    body: JSON.stringify(request),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Chat failed");
  }

  return response.json();
}

export async function sendGuestMessage(
  message: string,
  skillId: string
): Promise<{ content: string; is_guest: boolean; suggestion: string }> {
  const response = await fetch(`${API_BASE}/chat/guest`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message, skill_id: skillId }),
  });

  if (!response.ok) {
    throw new Error("Chat failed");
  }

  return response.json();
}

export function streamChat(
  request: ChatRequest,
  onChunk: (chunk: string) => void,
  onDone: () => void,
  onError: (error: Error) => void
) {
  const { accessToken } = getTokens();

  const eventSource = new EventSource(
    `${API_BASE}/chat/stream?${new URLSearchParams({
      message: request.message,
      skill_id: request.skill_id,
      ...(request.conversation_id && { conversation_id: request.conversation_id }),
    })}`,
  );

  // Note: For POST with EventSource, we'd need a different approach
  // This is a simplified version

  fetch(`${API_BASE}/chat/stream`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
    },
    body: JSON.stringify(request),
  }).then(async (response) => {
    const reader = response.body?.getReader();
    const decoder = new TextDecoder();

    if (!reader) {
      onError(new Error("No response body"));
      return;
    }

    while (true) {
      const { done, value } = await reader.read();
      if (done) {
        onDone();
        break;
      }

      const text = decoder.decode(value);
      const lines = text.split("\n");

      for (const line of lines) {
        if (line.startsWith("data: ")) {
          const data = line.slice(6);
          if (data === "[DONE]") {
            onDone();
            return;
          }
          onChunk(data);
        }
      }
    }
  }).catch(onError);
}

// ─────────────────────────────────────────────────────────────────
// User API
// ─────────────────────────────────────────────────────────────────

export async function getProfile() {
  const response = await fetchAPI("/users/me/profile");
  if (!response.ok) throw new Error("Failed to get profile");
  return response.json();
}

export async function updateProfile(data: Record<string, unknown>) {
  const response = await fetchAPI("/users/me/profile", {
    method: "PUT",
    body: JSON.stringify(data),
  });
  if (!response.ok) throw new Error("Failed to update profile");
  return response.json();
}

export async function getSubscriptionStatus() {
  const response = await fetchAPI("/users/me/subscription");
  if (!response.ok) throw new Error("Failed to get subscription");
  return response.json();
}
