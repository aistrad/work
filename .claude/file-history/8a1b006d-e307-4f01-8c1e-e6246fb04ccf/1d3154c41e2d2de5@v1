#!/usr/bin/env python3
"""调试 longest_streak 问题"""

import asyncio
import sys
import os
from uuid import uuid4
from datetime import date, timedelta
from pathlib import Path

# 加载环境变量
from dotenv import load_dotenv
project_root = Path(__file__).parent.parent.parent.parent
env_file = project_root / ".env"
if env_file.exists():
    load_dotenv(env_file)

# 添加 apps/api 到路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from stores.unified_profile_repo import UnifiedProfileRepository
from skills.lifecoach.tools.handlers import update_progress

class TestContext:
    def __init__(self, user_id):
        self.user_id = user_id

async def main():
    test_user_id = uuid4()
    context = TestContext(test_user_id)
    today = date.today()
    three_days_ago = (today - timedelta(days=3)).isoformat()

    print("=" * 60)
    print("调试 longest_streak 问题")
    print("=" * 60)

    # Step 1: 写入测试数据
    print("\n[Step 1] 写入测试数据...")
    content = {
        "progress": {
            "last_checkin_date": three_days_ago,
            "current_streak": 7,
            "longest_streak": 7,
            "total_checkins": 7
        }
    }
    await UnifiedProfileRepository.write_life_context_path(test_user_id, "lifecoach", content)
    print(f"  写入: current_streak=7, longest_streak=7, last_checkin={three_days_ago}")

    # Step 2: 读取验证
    print("\n[Step 2] 读取验证...")
    existing = await UnifiedProfileRepository.read_life_context_path(test_user_id, "lifecoach")
    progress = existing.content.get("progress", {})
    print(f"  读取: {progress}")
    print(f"  current_streak: {progress.get('current_streak')}")
    print(f"  longest_streak: {progress.get('longest_streak')}")

    # Step 3: 调用 update_progress
    print("\n[Step 3] 调用 update_progress...")
    result = await update_progress({"action_type": "daily_checkin"}, context)
    print(f"  结果: {result}")
    print(f"  status: {result.get('status')}")
    print(f"  current_streak: {result.get('current_streak')}")
    print(f"  longest_streak: {result.get('longest_streak', 'NOT RETURNED')}")

    # Step 4: 再次读取验证
    print("\n[Step 4] 再次读取验证...")
    existing = await UnifiedProfileRepository.read_life_context_path(test_user_id, "lifecoach")
    progress = existing.content.get("progress", {})
    print(f"  读取: {progress}")
    print(f"  current_streak: {progress.get('current_streak')}")
    print(f"  longest_streak: {progress.get('longest_streak')}")

    print("\n" + "=" * 60)

if __name__ == "__main__":
    asyncio.run(main())
