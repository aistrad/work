"""
CoreAgent + Core Skill ç”¨æˆ·åœºæ™¯æµ‹è¯•

æµ‹è¯•åœºæ™¯è¦†ç›–ï¼š
1. ç”¨æˆ·æ•°æ®å·¥å…· (read/write/query/delete)
2. è§¦å‘å™¨å·¥å…· (create/list/cancel)
3. å±•ç¤ºå·¥å…· (show_card)
4. æ”¶é›†å·¥å…· (ask_user_question, request_info)
5. ä¹è§‚é”ç‰ˆæœ¬æ§åˆ¶
6. æ¡ä»¶è§¦å‘å™¨è‡ªåŠ¨æ£€æŸ¥
"""

import pytest
import json
import os
from uuid import uuid4
from unittest.mock import AsyncMock, MagicMock, patch

from services.agent.tool_registry import ToolRegistry, ToolContext
from skills.core.services import (
    TriggerService, CardService, CardTypes, UserData
)
from stores.unified_profile_repo import UnifiedProfileRepository

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Database Fixtures (for real DB testing)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@pytest.fixture(autouse=True)
async def reset_db_pool():
    """Reset database pool before each test to avoid event loop issues"""
    import stores.db as db_module
    # Close existing pool if any
    if db_module._pool is not None:
        try:
            await db_module._pool.close()
        except Exception:
            pass
        db_module._pool = None
    yield
    # Cleanup after test
    if db_module._pool is not None:
        try:
            await db_module._pool.close()
        except Exception:
            pass
        db_module._pool = None


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Fixtures
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# ä½¿ç”¨å›ºå®šçš„æµ‹è¯•ç”¨æˆ· IDï¼ˆéœ€è¦åœ¨æ•°æ®åº“ä¸­å­˜åœ¨ï¼‰
TEST_USER_ID = "550e8400-e29b-41d4-a716-446655440000"

@pytest.fixture
def user_id():
    """æµ‹è¯•ç”¨æˆ· ID - ä½¿ç”¨å›ºå®š ID ä»¥ä¾¿æ•°æ®åº“å¤–é”®çº¦æŸ"""
    return TEST_USER_ID


@pytest.fixture
def tool_context(user_id):
    """å·¥å…·æ‰§è¡Œä¸Šä¸‹æ–‡"""
    return ToolContext(
        user_id=user_id,
        user_tier="premium",
        profile={"name": "æµ‹è¯•ç”¨æˆ·", "birth_info": {"year": 1990, "month": 5, "day": 15}},
        skill_data={},
        skill_id="core",
        scenario_id="goal_tracking"
    )


@pytest.fixture
def unified_profile_repo():
    """UnifiedProfileRepository å•ä¾‹"""
    return UnifiedProfileRepository


@pytest.fixture
def trigger_service():
    """TriggerService å®ä¾‹"""
    return TriggerService()


@pytest.fixture
def card_service():
    """CardService å®ä¾‹"""
    return CardService()


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 1: ç›®æ ‡è®¾å®šä¸è¿½è¸ª
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestGoalTrackingScenario:
    """
    ç”¨æˆ·åœºæ™¯ï¼šè®¾å®šå¹´åº¦ç›®æ ‡å¹¶è¿½è¸ªè¿›åº¦

    ç”¨æˆ·æ•…äº‹ï¼š
    - ç”¨æˆ·æƒ³è®¾å®š 2026 å¹´çš„å¹´åº¦ç›®æ ‡
    - ç”¨æˆ·æƒ³æŸ¥çœ‹è‡ªå·±çš„ç›®æ ‡åˆ—è¡¨
    - ç”¨æˆ·æƒ³æ›´æ–°ç›®æ ‡è¿›åº¦
    - ç”¨æˆ·æƒ³è®¾ç½®æ¯æ—¥æ‰“å¡æé†’
    """

    @pytest.mark.asyncio
    async def test_scenario_1_1_create_year_goal(self, tool_context):
        """åœºæ™¯ 1.1: ç”¨æˆ·è®¾å®šå¹´åº¦ç›®æ ‡"""
        # åˆå§‹åŒ–å·¥å…·æ³¨å†Œè¡¨
        ToolRegistry.initialize()

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"æˆ‘æƒ³è®¾å®šä»Šå¹´çš„ç›®æ ‡ï¼Œå­¦ä¼šå¼¹å‰ä»–"
        args = {
            "path": "goals/2026/year",
            "content": {
                "title": "2026å¹´åº¦ç›®æ ‡",
                "status": "active",
                "items": [
                    {
                        "id": "goal-1",
                        "title": "å­¦ä¼šå¼¹å‰ä»–",
                        "description": "èƒ½å¤Ÿå¼¹å¥ 5 é¦–å®Œæ•´çš„æ­Œæ›²",
                        "deadline": "2026-12-31",
                        "progress": 0,
                        "status": "active"
                    }
                ]
            }
        }

        result = await ToolRegistry.execute("write_user_data", args, tool_context)

        assert result["status"] == "success"
        assert result["version"] == 1
        print(f"âœ… åœºæ™¯ 1.1 é€šè¿‡: åˆ›å»ºå¹´åº¦ç›®æ ‡æˆåŠŸ, version={result['version']}")

    @pytest.mark.asyncio
    async def test_scenario_1_2_read_goals(self, tool_context):
        """åœºæ™¯ 1.2: ç”¨æˆ·æŸ¥çœ‹ç›®æ ‡åˆ—è¡¨"""
        ToolRegistry.initialize()

        # å…ˆåˆ›å»ºç›®æ ‡
        await ToolRegistry.execute("write_user_data", {
            "path": "goals/2026/year",
            "content": {"title": "2026ç›®æ ‡", "items": [{"id": "1", "title": "å­¦å‰ä»–"}]}
        }, tool_context)

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"æˆ‘çš„ç›®æ ‡æœ‰å“ªäº›ï¼Ÿ"
        result = await ToolRegistry.execute("read_user_data", {
            "path": "goals/2026/year"
        }, tool_context)

        assert result["status"] == "success"
        assert result["data"] is not None
        print(f"âœ… åœºæ™¯ 1.2 é€šè¿‡: è¯»å–ç›®æ ‡æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_1_3_update_goal_progress(self, tool_context):
        """åœºæ™¯ 1.3: ç”¨æˆ·æ›´æ–°ç›®æ ‡è¿›åº¦ï¼ˆä¹è§‚é”æµ‹è¯•ï¼‰"""
        ToolRegistry.initialize()

        # åˆ›å»ºåˆå§‹ç›®æ ‡
        create_result = await ToolRegistry.execute("write_user_data", {
            "path": "goals/2026/guitar",
            "content": {"title": "å­¦å‰ä»–", "progress": 0, "status": "active"}
        }, tool_context)

        initial_version = create_result["version"]

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"æˆ‘å·²ç»å­¦ä¼šäº†ç¬¬ä¸€é¦–æ­Œï¼Œæ›´æ–°è¿›åº¦åˆ° 20%"
        update_result = await ToolRegistry.execute("write_user_data", {
            "path": "goals/2026/guitar",
            "content": {"title": "å­¦å‰ä»–", "progress": 20, "status": "active"},
            "expected_version": initial_version
        }, tool_context)

        assert update_result["status"] == "success"
        assert update_result["version"] == initial_version + 1
        print(f"âœ… åœºæ™¯ 1.3 é€šè¿‡: ä¹è§‚é”æ›´æ–°æˆåŠŸ, version={update_result['version']}")

    @pytest.mark.asyncio
    async def test_scenario_1_4_version_conflict(self, tool_context):
        """åœºæ™¯ 1.4: å¹¶å‘æ›´æ–°å¯¼è‡´ç‰ˆæœ¬å†²çª"""
        ToolRegistry.initialize()

        # åˆ›å»ºåˆå§‹ç›®æ ‡
        await ToolRegistry.execute("write_user_data", {
            "path": "goals/2026/conflict_test",
            "content": {"title": "å†²çªæµ‹è¯•", "value": 1}
        }, tool_context)

        # æ¨¡æ‹Ÿå¦ä¸€ä¸ªå®¢æˆ·ç«¯å·²ç»æ›´æ–°äº†æ•°æ®ï¼ˆversion å˜æˆ 2ï¼‰
        await ToolRegistry.execute("write_user_data", {
            "path": "goals/2026/conflict_test",
            "content": {"title": "å†²çªæµ‹è¯•", "value": 2}
        }, tool_context)

        # å½“å‰å®¢æˆ·ç«¯å°è¯•ç”¨æ—§ç‰ˆæœ¬æ›´æ–°
        result = await ToolRegistry.execute("write_user_data", {
            "path": "goals/2026/conflict_test",
            "content": {"title": "å†²çªæµ‹è¯•", "value": 3},
            "expected_version": 1  # æ—§ç‰ˆæœ¬
        }, tool_context)

        assert result["status"] == "conflict"
        print(f"âœ… åœºæ™¯ 1.4 é€šè¿‡: ç‰ˆæœ¬å†²çªæ­£ç¡®æ£€æµ‹")

    @pytest.mark.asyncio
    async def test_scenario_1_5_create_daily_reminder(self, tool_context):
        """åœºæ™¯ 1.5: ç”¨æˆ·è®¾ç½®æ¯æ—¥æ‰“å¡æé†’"""
        ToolRegistry.initialize()

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"å¸®æˆ‘è®¾ç½®æ¯å¤©æ™šä¸Š 9 ç‚¹çš„æ‰“å¡æé†’"
        result = await ToolRegistry.execute("create_trigger", {
            "trigger_type": "reminder",
            "title": "æ¯æ—¥æ‰“å¡æé†’",
            "schedule": "21:00",
            "schedule_type": "daily",
            "trigger_subtype": "goal_checkin",
            "action": {
                "type": "notify",
                "payload": {"title": "æ‰“å¡æ—¶é—´åˆ°", "body": "è®°å¾—å®Œæˆä»Šå¤©çš„ç›®æ ‡æ‰“å¡å“¦ï¼"}
            }
        }, tool_context)

        assert result["status"] == "success"
        # trigger_id åœ¨ result["trigger"]["id"] ä¸­
        assert "trigger" in result
        trigger_id = result["trigger"]["id"]
        print(f"âœ… åœºæ™¯ 1.5 é€šè¿‡: åˆ›å»ºæ¯æ—¥æé†’æˆåŠŸ, trigger_id={trigger_id}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 2: æ¯æ—¥è®¡åˆ’ä¸æ‰“å¡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestDailyPlanScenario:
    """
    ç”¨æˆ·åœºæ™¯ï¼šåˆ¶å®šæ¯æ—¥è®¡åˆ’å¹¶æ‰“å¡

    ç”¨æˆ·æ•…äº‹ï¼š
    - ç”¨æˆ·æƒ³åˆ¶å®šä»Šå¤©çš„è®¡åˆ’
    - ç”¨æˆ·æƒ³æŸ¥çœ‹ä»Šå¤©çš„ä»»åŠ¡
    - ç”¨æˆ·æƒ³å®Œæˆä»»åŠ¡å¹¶æ‰“å¡
    - ç”¨æˆ·æƒ³æŸ¥çœ‹æ‰“å¡è®°å½•
    """

    @pytest.mark.asyncio
    async def test_scenario_2_1_create_daily_plan(self, tool_context):
        """åœºæ™¯ 2.1: ç”¨æˆ·åˆ¶å®šä»Šæ—¥è®¡åˆ’"""
        ToolRegistry.initialize()

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"å¸®æˆ‘åˆ¶å®šä»Šå¤©çš„è®¡åˆ’"
        result = await ToolRegistry.execute("write_user_data", {
            "path": "plans/daily/2026-01-18",
            "content": {
                "date": "2026-01-18",
                "status": "active",
                "tasks": [
                    {"id": "t1", "title": "ç»ƒä¹ å‰ä»– 30 åˆ†é’Ÿ", "done": False},
                    {"id": "t2", "title": "é˜…è¯» 20 é¡µä¹¦", "done": False},
                    {"id": "t3", "title": "è¿åŠ¨ 15 åˆ†é’Ÿ", "done": False}
                ]
            }
        }, tool_context)

        assert result["status"] == "success"
        print(f"âœ… åœºæ™¯ 2.1 é€šè¿‡: åˆ›å»ºæ¯æ—¥è®¡åˆ’æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_2_2_show_daily_tasks(self, tool_context):
        """åœºæ™¯ 2.2: å±•ç¤ºä»Šæ—¥ä»»åŠ¡åˆ—è¡¨"""
        ToolRegistry.initialize()

        # å…ˆåˆ›å»ºè®¡åˆ’
        await ToolRegistry.execute("write_user_data", {
            "path": "plans/daily/2026-01-18",
            "content": {
                "tasks": [
                    {"id": "t1", "title": "ç»ƒä¹ å‰ä»–", "done": False},
                    {"id": "t2", "title": "é˜…è¯»", "done": True}
                ]
            }
        }, tool_context)

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"å±•ç¤ºæˆ‘ä»Šå¤©çš„ä»»åŠ¡"
        result = await ToolRegistry.execute("show_card", {
            "card_type": "list",
            "data_source": {
                "type": "path",
                "path": "plans/daily/2026-01-18"
            },
            "options": {
                "emptyText": "ä»Šå¤©è¿˜æ²¡æœ‰è®¡åˆ’å“¦",
                "showIndex": True
            }
        }, tool_context)

        assert result["status"] == "success"
        assert result["cardType"] == "list"
        print(f"âœ… åœºæ™¯ 2.2 é€šè¿‡: å±•ç¤ºä»»åŠ¡åˆ—è¡¨æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_2_3_checkin(self, tool_context):
        """åœºæ™¯ 2.3: ç”¨æˆ·æ‰“å¡"""
        ToolRegistry.initialize()

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"æˆ‘å®Œæˆäº†ä»Šå¤©çš„å‰ä»–ç»ƒä¹ ï¼Œå¸®æˆ‘æ‰“å¡"
        result = await ToolRegistry.execute("write_user_data", {
            "path": "checkins/2026-01-18",
            "content": {
                "date": "2026-01-18",
                "items": [
                    {
                        "goal_id": "guitar",
                        "task": "ç»ƒä¹ å‰ä»– 30 åˆ†é’Ÿ",
                        "completed": True,
                        "notes": "ä»Šå¤©ç»ƒä¹ äº†ã€Šå°æ˜Ÿæ˜Ÿã€‹",
                        "mood": "happy"
                    }
                ],
                "summary": "å®Œæˆ 1 é¡¹ä»»åŠ¡"
            }
        }, tool_context)

        assert result["status"] == "success"
        print(f"âœ… åœºæ™¯ 2.3 é€šè¿‡: æ‰“å¡è®°å½•æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_2_4_query_checkin_history(self, tool_context):
        """åœºæ™¯ 2.4: æŸ¥è¯¢æ‰“å¡å†å²"""
        ToolRegistry.initialize()

        # åˆ›å»ºå¤šå¤©æ‰“å¡è®°å½•
        for day in range(15, 19):
            await ToolRegistry.execute("write_user_data", {
                "path": f"checkins/2026-01-{day:02d}",
                "content": {"date": f"2026-01-{day:02d}", "completed": True}
            }, tool_context)

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"æŸ¥çœ‹æˆ‘è¿™å‘¨çš„æ‰“å¡è®°å½•"
        result = await ToolRegistry.execute("query_user_data", {
            "path_prefix": "checkins/2026-01",
            "sort_by": "created_at",
            "limit": 7
        }, tool_context)

        assert result["status"] == "success"
        assert result["count"] >= 1
        print(f"âœ… åœºæ™¯ 2.4 é€šè¿‡: æŸ¥è¯¢æ‰“å¡å†å²æˆåŠŸ, count={result['count']}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 3: æ¡ä»¶è§¦å‘å™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestConditionTriggerScenario:
    """
    ç”¨æˆ·åœºæ™¯ï¼šè®¾ç½®æ¡ä»¶è§¦å‘å™¨

    ç”¨æˆ·æ•…äº‹ï¼š
    - ç”¨æˆ·æƒ³åœ¨ç›®æ ‡å®Œæˆæ—¶æ”¶åˆ°é€šçŸ¥
    - ç”¨æˆ·æƒ³åœ¨è¿ç»­æ‰“å¡ 7 å¤©æ—¶æ”¶åˆ°åº†ç¥
    """

    @pytest.mark.asyncio
    async def test_scenario_3_1_goal_completion_trigger(self, tool_context):
        """åœºæ™¯ 3.1: ç›®æ ‡å®Œæˆæ—¶è§¦å‘é€šçŸ¥"""
        ToolRegistry.initialize()

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"å½“æˆ‘çš„å‰ä»–ç›®æ ‡å®Œæˆæ—¶ï¼Œæé†’æˆ‘åº†ç¥"
        result = await ToolRegistry.execute("create_trigger", {
            "trigger_type": "condition",
            "title": "ç›®æ ‡å®Œæˆåº†ç¥",
            "source_path": "goals/2026/guitar",
            "condition": {
                "field": "progress",
                "operator": "gte",
                "value": 100
            },
            "action": {
                "type": "notify",
                "payload": {
                    "title": "ğŸ‰ æ­å–œï¼",
                    "body": "ä½ çš„å‰ä»–å­¦ä¹ ç›®æ ‡å·²å®Œæˆï¼"
                }
            }
        }, tool_context)

        assert result["status"] == "success"
        print(f"âœ… åœºæ™¯ 3.1 é€šè¿‡: åˆ›å»ºæ¡ä»¶è§¦å‘å™¨æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_3_2_list_triggers(self, tool_context):
        """åœºæ™¯ 3.2: æŸ¥çœ‹æ‰€æœ‰è§¦å‘å™¨"""
        ToolRegistry.initialize()

        # å…ˆåˆ›å»ºä¸€äº›è§¦å‘å™¨
        await ToolRegistry.execute("create_trigger", {
            "trigger_type": "reminder",
            "title": "æµ‹è¯•æé†’",
            "schedule": "08:00",
            "schedule_type": "daily"
        }, tool_context)

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"æˆ‘æœ‰å“ªäº›æé†’ï¼Ÿ"
        result = await ToolRegistry.execute("list_triggers", {
            "status": "active"
        }, tool_context)

        assert result["status"] == "success"
        print(f"âœ… åœºæ™¯ 3.2 é€šè¿‡: åˆ—å‡ºè§¦å‘å™¨æˆåŠŸ, count={result['count']}")

    @pytest.mark.asyncio
    async def test_scenario_3_3_cancel_trigger(self, tool_context):
        """åœºæ™¯ 3.3: å–æ¶ˆè§¦å‘å™¨"""
        ToolRegistry.initialize()

        # å…ˆåˆ›å»ºè§¦å‘å™¨
        create_result = await ToolRegistry.execute("create_trigger", {
            "trigger_type": "reminder",
            "title": "è¦å–æ¶ˆçš„æé†’",
            "schedule": "10:00",
            "schedule_type": "daily"
        }, tool_context)

        trigger_id = create_result.get("trigger_id")

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"å–æ¶ˆè¿™ä¸ªæé†’"
        result = await ToolRegistry.execute("cancel_trigger", {
            "trigger_id": trigger_id
        }, tool_context)

        assert result["status"] == "success"
        print(f"âœ… åœºæ™¯ 3.3 é€šè¿‡: å–æ¶ˆè§¦å‘å™¨æˆåŠŸ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 4: å±•ç¤ºå¡ç‰‡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestShowCardScenario:
    """
    ç”¨æˆ·åœºæ™¯ï¼šå„ç§å¡ç‰‡å±•ç¤º

    æµ‹è¯•æ‰€æœ‰ 11 ç§é€šç”¨è§†å›¾ç±»å‹
    """

    @pytest.mark.asyncio
    async def test_scenario_4_1_show_tree(self, tool_context):
        """åœºæ™¯ 4.1: å±•ç¤ºç›®æ ‡æ ‘"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("show_card", {
            "card_type": "tree",
            "data_source": {
                "type": "inline",
                "data": {
                    "id": "root",
                    "title": "2026 å¹´åº¦ç›®æ ‡",
                    "children": [
                        {
                            "id": "health",
                            "title": "å¥åº·",
                            "progress": 30,
                            "children": [
                                {"id": "h1", "title": "æ¯å‘¨è¿åŠ¨ 3 æ¬¡", "progress": 50},
                                {"id": "h2", "title": "æ—©ç¡æ—©èµ·", "progress": 10}
                            ]
                        },
                        {
                            "id": "skill",
                            "title": "æŠ€èƒ½",
                            "progress": 20,
                            "children": [
                                {"id": "s1", "title": "å­¦å‰ä»–", "progress": 20}
                            ]
                        }
                    ]
                }
            },
            "options": {"expandLevel": 2, "showProgress": True}
        }, tool_context)

        assert result["status"] == "success"
        assert result["cardType"] == "tree"
        print(f"âœ… åœºæ™¯ 4.1 é€šè¿‡: å±•ç¤ºç›®æ ‡æ ‘æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_4_2_show_progress(self, tool_context):
        """åœºæ™¯ 4.2: å±•ç¤ºè¿›åº¦æ¡"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("show_card", {
            "card_type": "progress",
            "data_source": {
                "type": "inline",
                "data": {"value": 65, "max": 100, "label": "å¹´åº¦ç›®æ ‡å®Œæˆåº¦"}
            }
        }, tool_context)

        assert result["status"] == "success"
        assert result["cardType"] == "progress"
        print(f"âœ… åœºæ™¯ 4.2 é€šè¿‡: å±•ç¤ºè¿›åº¦æ¡æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_4_3_show_chart(self, tool_context):
        """åœºæ™¯ 4.3: å±•ç¤ºå›¾è¡¨"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("show_card", {
            "card_type": "chart",
            "data_source": {
                "type": "inline",
                "data": [
                    {"month": "1æœˆ", "å®Œæˆ": 5, "ç›®æ ‡": 10},
                    {"month": "2æœˆ", "å®Œæˆ": 8, "ç›®æ ‡": 10},
                    {"month": "3æœˆ", "å®Œæˆ": 12, "ç›®æ ‡": 10}
                ]
            },
            "options": {
                "chartType": "bar",
                "xAxis": {"dataKey": "month"}
            }
        }, tool_context)

        assert result["status"] == "success"
        assert result["cardType"] == "chart"
        print(f"âœ… åœºæ™¯ 4.3 é€šè¿‡: å±•ç¤ºå›¾è¡¨æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_4_4_show_form(self, tool_context):
        """åœºæ™¯ 4.4: å±•ç¤ºæ‰“å¡è¡¨å•"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("show_card", {
            "card_type": "form",
            "data_source": {
                "type": "inline",
                "data": {
                    "fields": [
                        {"name": "task", "label": "å®Œæˆçš„ä»»åŠ¡", "type": "text", "required": True},
                        {"name": "duration", "label": "ç”¨æ—¶(åˆ†é’Ÿ)", "type": "number"},
                        {"name": "mood", "label": "å¿ƒæƒ…", "type": "select", "options": ["å¼€å¿ƒ", "ä¸€èˆ¬", "ç–²æƒ«"]},
                        {"name": "notes", "label": "å¤‡æ³¨", "type": "textarea"}
                    ],
                    "submitLabel": "æäº¤æ‰“å¡"
                }
            }
        }, tool_context)

        assert result["status"] == "success"
        assert result["cardType"] == "form"
        print(f"âœ… åœºæ™¯ 4.4 é€šè¿‡: å±•ç¤ºè¡¨å•æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_4_5_show_timeline(self, tool_context):
        """åœºæ™¯ 4.5: å±•ç¤ºæ—¶é—´çº¿"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("show_card", {
            "card_type": "timeline",
            "data_source": {
                "type": "inline",
                "data": [
                    {"date": "2026-01-15", "title": "å¼€å§‹å­¦å‰ä»–", "description": "è´­ä¹°äº†å‰ä»–"},
                    {"date": "2026-01-16", "title": "ç¬¬ä¸€æ¬¡ç»ƒä¹ ", "description": "å­¦ä¼šäº†åŸºæœ¬å’Œå¼¦"},
                    {"date": "2026-01-17", "title": "ç»ƒä¹ ã€Šå°æ˜Ÿæ˜Ÿã€‹", "description": "èƒ½å¼¹å®Œæ•´é¦–æ­Œäº†"}
                ]
            }
        }, tool_context)

        assert result["status"] == "success"
        assert result["cardType"] == "timeline"
        print(f"âœ… åœºæ™¯ 4.5 é€šè¿‡: å±•ç¤ºæ—¶é—´çº¿æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_4_6_show_toast(self, tool_context):
        """åœºæ™¯ 4.6: å±•ç¤ºè½»æç¤º"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("show_card", {
            "card_type": "toast",
            "data_source": {
                "type": "inline",
                "data": {
                    "message": "æ‰“å¡æˆåŠŸï¼ç»§ç»­åŠ æ²¹ï¼",
                    "type": "success",
                    "duration": 3000
                }
            }
        }, tool_context)

        assert result["status"] == "success"
        assert result["cardType"] == "toast"
        print(f"âœ… åœºæ™¯ 4.6 é€šè¿‡: å±•ç¤ºè½»æç¤ºæˆåŠŸ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 5: æ”¶é›†ä¿¡æ¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestCollectInfoScenario:
    """
    ç”¨æˆ·åœºæ™¯ï¼šæ”¶é›†ç”¨æˆ·ä¿¡æ¯
    """

    @pytest.mark.asyncio
    async def test_scenario_5_1_ask_question(self, tool_context):
        """åœºæ™¯ 5.1: å‘ç”¨æˆ·æé—®"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("ask_user_question", {
            "question": "ä½ æƒ³å…ˆè®¾å®šå“ªä¸ªé¢†åŸŸçš„ç›®æ ‡ï¼Ÿ",
            "options": ["å¥åº·", "äº‹ä¸š", "å­¦ä¹ ", "æ„Ÿæƒ…"]
        }, tool_context)

        assert result["status"] == "asking"
        assert result["cardType"] == "question_card"
        print(f"âœ… åœºæ™¯ 5.1 é€šè¿‡: æé—®æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_5_2_request_birth_info(self, tool_context):
        """åœºæ™¯ 5.2: è¯·æ±‚å‡ºç”Ÿä¿¡æ¯"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("request_info", {
            "info_type": "birth",
            "question": "ä¸ºäº†ç»™ä½ æ›´å‡†ç¡®çš„åˆ†æï¼Œè¯·å‘Šè¯‰æˆ‘ï¿½ï¿½çš„å‡ºç”Ÿä¿¡æ¯"
        }, tool_context)

        assert result["status"] == "collecting"
        assert "fields" in result
        print(f"âœ… åœºæ™¯ 5.2 é€šè¿‡: è¯·æ±‚å‡ºç”Ÿä¿¡æ¯æˆåŠŸ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯ 6: åˆ é™¤æ•°æ®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestDeleteDataScenario:
    """
    ç”¨æˆ·åœºæ™¯ï¼šåˆ é™¤æ•°æ®
    """

    @pytest.mark.asyncio
    async def test_scenario_6_1_delete_goal(self, tool_context):
        """åœºæ™¯ 6.1: åˆ é™¤ç›®æ ‡"""
        ToolRegistry.initialize()

        # å…ˆåˆ›å»ºç›®æ ‡
        await ToolRegistry.execute("write_user_data", {
            "path": "goals/2026/to_delete",
            "content": {"title": "è¦åˆ é™¤çš„ç›®æ ‡"}
        }, tool_context)

        # æ¨¡æ‹Ÿç”¨æˆ·è¯´ï¼š"åˆ é™¤è¿™ä¸ªç›®æ ‡"
        result = await ToolRegistry.execute("delete_user_data", {
            "path": "goals/2026/to_delete"
        }, tool_context)

        assert result["status"] == "success"
        print(f"âœ… åœºæ™¯ 6.1 é€šè¿‡: åˆ é™¤ç›®æ ‡æˆåŠŸ")

    @pytest.mark.asyncio
    async def test_scenario_6_2_delete_nonexistent(self, tool_context):
        """åœºæ™¯ 6.2: åˆ é™¤ä¸å­˜åœ¨çš„æ•°æ®"""
        ToolRegistry.initialize()

        result = await ToolRegistry.execute("delete_user_data", {
            "path": "goals/nonexistent/path"
        }, tool_context)

        assert result["status"] == "not_found"
        print(f"âœ… åœºæ™¯ 6.2 é€šè¿‡: æ­£ç¡®å¤„ç†ä¸å­˜åœ¨çš„æ•°æ®")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# è¿è¡Œæµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if __name__ == "__main__":
    pytest.main([__file__, "-v", "-s", "--tb=short"])
