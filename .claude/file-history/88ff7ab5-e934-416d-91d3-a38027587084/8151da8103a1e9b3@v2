-- Migration 020: Drop deprecated tables after VibeProfile unification (v7.6)
--
-- These tables have been migrated to unified_profiles.profile JSONB:
-- - user_skill_subscriptions → preferences.subscribed_skills
-- - user_push_preferences → preferences.push_settings
-- - user_data_store → life_context._paths
-- - skill_recommendation_blocks → preferences.blocked_skills
-- - skill_usage_log → (removed, not migrated)
--
-- IMPORTANT: Run the migration script BEFORE running this SQL:
--   python scripts/migrate_to_unified_profile.py
--
-- After verifying the migration was successful, run this SQL to drop the tables.

-- Step 1: Drop deprecated tables (in dependency order)

-- Drop skill_usage_log (no dependencies)
DROP TABLE IF EXISTS skill_usage_log CASCADE;

-- Drop skill_recommendation_blocks (no dependencies)
DROP TABLE IF EXISTS skill_recommendation_blocks CASCADE;

-- Drop user_push_preferences (no dependencies)
DROP TABLE IF EXISTS user_push_preferences CASCADE;

-- Drop user_data_store (no dependencies)
DROP TABLE IF EXISTS user_data_store CASCADE;

-- Drop user_skill_subscriptions (no dependencies)
DROP TABLE IF EXISTS user_skill_subscriptions CASCADE;


-- Step 2: Add migration record
INSERT INTO schema_migrations (version, name, applied_at)
VALUES (20, 'drop_deprecated_tables', NOW())
ON CONFLICT (version) DO NOTHING;


-- Verification query (run after migration):
-- SELECT
--     tablename
-- FROM pg_tables
-- WHERE schemaname = 'public'
-- AND tablename IN (
--     'skill_usage_log',
--     'skill_recommendation_blocks',
--     'user_push_preferences',
--     'user_data_store',
--     'user_skill_subscriptions'
-- );
-- Expected: No rows returned
