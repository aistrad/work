"""
CardService - 统一卡片渲染服务 (V7)

职责:
1. 统一卡片渲染接口
2. 支持多种数据源 (path, inline, api)
3. 处理通用视图类型和自定义卡片
"""

import logging
from dataclasses import dataclass
from typing import Any, Dict, List, Optional
from uuid import UUID

logger = logging.getLogger(__name__)


# ═══════════════════════════════════════════════════════════════════════════
# Card Types
# ═══════════════════════════════════════════════════════════════════════════

class CardTypes:
    """卡片类型常量"""
    # 通用视图类型
    LIST = "list"
    TREE = "tree"
    TABLE = "table"
    TIMELINE = "timeline"
    FORM = "form"
    SELECT = "select"
    CHART = "chart"
    PROGRESS = "progress"
    COUNTER = "counter"
    MODAL = "modal"
    TOAST = "toast"
    CUSTOM = "custom"

    # Skill 自定义卡片 (通过 custom + component_id 访问)
    BAZI_CHART = "bazi_chart"
    BAZI_FORTUNE = "bazi_fortune"
    BAZI_KLINE = "bazi_kline"
    BAZI_DAILY_FORTUNE = "bazi_daily_fortune"
    ZODIAC_CHART = "zodiac_chart"
    ZODIAC_TRANSIT = "zodiac_transit"
    ZODIAC_SYNASTRY = "zodiac_synastry"
    ZODIAC_LUNAR_PHASE = "zodiac_lunar_phase"
    TAROT_SPREAD = "tarot_spread"
    CAREER_ANALYSIS = "career_analysis"
    VIBE_ID = "vibe_id"

    @classmethod
    def is_generic(cls, card_type: str) -> bool:
        """检查是否为通用视图类型"""
        return card_type in (
            cls.LIST, cls.TREE, cls.TABLE, cls.TIMELINE,
            cls.FORM, cls.SELECT, cls.CHART, cls.PROGRESS,
            cls.COUNTER, cls.MODAL, cls.TOAST, cls.CUSTOM
        )


# ═══════════════════════════════════════════════════════════════════════════
# Data Source Types
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class DataSource:
    """数据源配置"""
    type: str  # path, inline, api
    path: Optional[str] = None  # user_data_store 路径
    data: Optional[Any] = None  # 内联数据
    endpoint: Optional[str] = None  # API 端点


# ═══════════════════════════════════════════════════════════════════════════
# CardService
# ═══════════════════════════════════════════════════════════════════════════

class CardService:
    """统一卡片渲染服务"""

    async def render(
        self,
        card_type: str,
        data_source: Optional[Dict[str, Any]] = None,
        options: Optional[Dict[str, Any]] = None,
        context: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """
        渲染卡片

        Args:
            card_type: 卡片类型 (list, tree, table, custom, etc.)
            data_source: 数据源配置 {type: "path"|"inline"|"api", path?, data?, endpoint?}
            options: 卡片选项 (视图配置、样式等)
            context: 上下文 (user_id, skill_id 等)

        Returns:
            渲染结果 {cardType, data, options, ...}
        """
        options = options or {}
        context = context or {}
        data_source = data_source or {}

        # 获取数据
        data = await self._resolve_data_source(data_source, context)

        # 根据卡片类型处理
        if CardTypes.is_generic(card_type):
            return self._render_generic(card_type, data, options, context)
        else:
            # 自定义卡片直接返回
            return {
                "status": "success",
                "cardType": card_type,
                "data": data,
                "options": options,
            }

    async def _resolve_data_source(
        self,
        data_source: Dict[str, Any],
        context: Dict[str, Any],
    ) -> Any:
        """
        解析数据源

        Args:
            data_source: 数据源配置
            context: 上下文

        Returns:
            解析后的数据
        """
        source_type = data_source.get("type", "inline")

        if source_type == "inline":
            return data_source.get("data")

        elif source_type == "path":
            path = data_source.get("path")
            if not path:
                return None

            user_id = context.get("user_id")
            if not user_id or user_id == "guest":
                return None

            try:
                from uuid import UUID as UUIDType
                from skills.core.services.user_data import get_user_data_service

                service = get_user_data_service()
                user_uuid = UUIDType(user_id)
                result = await service.read(user_uuid, path)
                return result.content if result else None
            except Exception as e:
                logger.error(f"Failed to resolve path data source: {e}")
                return None

        elif source_type == "api":
            # API 数据源 - 前端处理
            return {
                "_source": "api",
                "endpoint": data_source.get("endpoint"),
            }

        return None

    def _render_generic(
        self,
        card_type: str,
        data: Any,
        options: Dict[str, Any],
        context: Dict[str, Any],
    ) -> Dict[str, Any]:
        """渲染通用视图类型"""

        base_result = {
            "status": "success",
            "cardType": card_type,
            "data": data,
            "options": options,
        }

        # 根据类型添加特定字段
        if card_type == CardTypes.LIST:
            return {
                **base_result,
                "items": data if isinstance(data, list) else [],
                "emptyText": options.get("emptyText", "暂无数据"),
                "showIndex": options.get("showIndex", False),
            }

        elif card_type == CardTypes.TREE:
            return {
                **base_result,
                "nodes": data if isinstance(data, list) else [],
                "expandLevel": options.get("expandLevel", 2),
                "showProgress": options.get("showProgress", True),
            }

        elif card_type == CardTypes.TABLE:
            return {
                **base_result,
                "columns": options.get("columns", []),
                "rows": data if isinstance(data, list) else [],
                "sortable": options.get("sortable", False),
                "pagination": options.get("pagination", False),
            }

        elif card_type == CardTypes.TIMELINE:
            return {
                **base_result,
                "events": data if isinstance(data, list) else [],
                "direction": options.get("direction", "vertical"),
            }

        elif card_type == CardTypes.FORM:
            return {
                **base_result,
                "fields": options.get("fields", []),
                "values": data if isinstance(data, dict) else {},
                "submitLabel": options.get("submitLabel", "提交"),
                "submitAction": options.get("submitAction"),
            }

        elif card_type == CardTypes.SELECT:
            return {
                **base_result,
                "options": data if isinstance(data, list) else [],
                "multiple": options.get("multiple", False),
                "searchable": options.get("searchable", False),
                "placeholder": options.get("placeholder", "请选择"),
            }

        elif card_type == CardTypes.CHART:
            return {
                **base_result,
                "chartType": options.get("chartType", "line"),
                "series": data if isinstance(data, list) else [],
                "xAxis": options.get("xAxis"),
                "yAxis": options.get("yAxis"),
            }

        elif card_type == CardTypes.PROGRESS:
            value = data if isinstance(data, (int, float)) else 0
            return {
                **base_result,
                "value": value,
                "max": options.get("max", 100),
                "label": options.get("label"),
                "showPercentage": options.get("showPercentage", True),
            }

        elif card_type == CardTypes.COUNTER:
            return {
                **base_result,
                "value": data if isinstance(data, (int, float)) else 0,
                "label": options.get("label"),
                "prefix": options.get("prefix"),
                "suffix": options.get("suffix"),
                "trend": options.get("trend"),  # up, down, neutral
            }

        elif card_type == CardTypes.MODAL:
            return {
                **base_result,
                "title": options.get("title", ""),
                "content": data,
                "actions": options.get("actions", []),
                "closable": options.get("closable", True),
            }

        elif card_type == CardTypes.TOAST:
            return {
                **base_result,
                "message": data if isinstance(data, str) else str(data),
                "type": options.get("type", "info"),  # info, success, warning, error
                "duration": options.get("duration", 3000),
            }

        elif card_type == CardTypes.CUSTOM:
            return {
                **base_result,
                "componentId": options.get("componentId"),
                "props": data if isinstance(data, dict) else {},
            }

        return base_result

    def render_list(
        self,
        items: List[Any],
        options: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """快捷方法: 渲染列表"""
        return {
            "status": "success",
            "cardType": CardTypes.LIST,
            "items": items,
            "options": options or {},
        }

    def render_tree(
        self,
        nodes: List[Dict[str, Any]],
        options: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """快捷方法: 渲染树形结构"""
        return {
            "status": "success",
            "cardType": CardTypes.TREE,
            "nodes": nodes,
            "options": options or {},
        }

    def render_form(
        self,
        fields: List[Dict[str, Any]],
        values: Optional[Dict[str, Any]] = None,
        options: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """快捷方法: 渲染表单"""
        return {
            "status": "success",
            "cardType": CardTypes.FORM,
            "fields": fields,
            "values": values or {},
            "options": options or {},
        }

    def render_progress(
        self,
        value: float,
        max_value: float = 100,
        label: Optional[str] = None,
    ) -> Dict[str, Any]:
        """快捷方法: 渲染进度条"""
        return {
            "status": "success",
            "cardType": CardTypes.PROGRESS,
            "value": value,
            "max": max_value,
            "label": label,
        }

    def render_toast(
        self,
        message: str,
        toast_type: str = "info",
        duration: int = 3000,
    ) -> Dict[str, Any]:
        """快捷方法: 渲染轻提示"""
        return {
            "status": "success",
            "cardType": CardTypes.TOAST,
            "message": message,
            "type": toast_type,
            "duration": duration,
        }

    def render_custom(
        self,
        component_id: str,
        props: Optional[Dict[str, Any]] = None,
    ) -> Dict[str, Any]:
        """快捷方法: 渲染自定义组件"""
        return {
            "status": "success",
            "cardType": CardTypes.CUSTOM,
            "componentId": component_id,
            "props": props or {},
        }


# ═══════════════════════════════════════════════════════════════════════════
# Singleton
# ═══════════════════════════════════════════════════════════════════════════

_service: Optional[CardService] = None


def get_card_service() -> CardService:
    """获取单例 CardService"""
    global _service
    if _service is None:
        _service = CardService()
    return _service
