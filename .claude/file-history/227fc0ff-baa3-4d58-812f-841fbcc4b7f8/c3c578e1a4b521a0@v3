"use client"

import { useRef, useEffect, useMemo } from "react"
import { motion } from "framer-motion"
import { cn } from "@/lib/utils"
import type { Message } from "@/types"
import { MessageItem } from "./message-item"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Prompt Card ç»„ä»¶ - å¿«æ·å…¥å£å¡ç‰‡
// è®¾è®¡è§„èŒƒ: ç™½è‰²èƒŒæ™¯ + åœ†è§’ + æŸ”å’Œé˜´å½± + hover ä¸Šæµ®æ•ˆæœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
interface PromptCardProps {
  emoji: string
  title: string
  description: string
  onClick?: () => void
  delay?: number
}

function PromptCard({ emoji, title, description, onClick, delay = 0 }: PromptCardProps) {
  return (
    <motion.button
      type="button"
      onClick={onClick}
      className={cn(
        "group flex flex-col items-start gap-3 p-5",
        "bg-card rounded-xl",
        "border border-border/50",
        "shadow-sm hover:shadow-lg",
        "transition-all duration-300 ease-out",
        "hover:-translate-y-1",
        "text-left w-full",
        "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent/50",
        "focus-visible:ring-offset-2 focus-visible:ring-offset-background"
      )}
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5, delay, ease: [0.16, 1, 0.3, 1] }}
      whileHover={{ scale: 1.02 }}
      whileTap={{ scale: 0.98 }}
      role="button"
      tabIndex={0}
      aria-label={`${title}: ${description}`}
    >
      {/* Emoji Icon - æŸ”å’Œç°åº¦æ•ˆæœï¼Œhover æ¢å¤å½©è‰² */}
      <span
        className="text-3xl grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-300"
        role="img"
        aria-hidden="true"
      >
        {emoji}
      </span>

      {/* Title */}
      <h3 className="text-base font-semibold text-foreground leading-tight">
        {title}
      </h3>

      {/* Description */}
      <p className="text-sm text-foreground-muted leading-relaxed">
        {description}
      </p>
    </motion.button>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Welcome Section ç»„ä»¶ - æ¬¢è¿é¡µä¸»ä½“
// è®¾è®¡è§„èŒƒ: å±…ä¸­å¸ƒå±€ + Serif æ–œä½“æ ‡é¢˜ + Sans å‰¯æ ‡é¢˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function WelcomeSection({ onPromptClick }: { onPromptClick?: (prompt: string) => void }) {
  // æ ¹æ®æ—¶é—´ç”Ÿæˆé—®å€™è¯­
  const greeting = useMemo(() => {
    const hour = new Date().getHours()
    if (hour < 6) return "Good evening"
    if (hour < 12) return "Good morning"
    if (hour < 18) return "Good afternoon"
    return "Good evening"
  }, [])

  // Prompt Cards æ•°æ®
  const promptCards = [
    {
      emoji: "ğŸƒ",
      title: "æ¯æ—¥å¡”ç½—",
      description: "æŠ½å–ä»Šæ—¥æ´å¯Ÿå¡ç‰Œ",
      prompt: "/tarot",
    },
    {
      emoji: "ğŸ“”",
      title: "æˆé•¿æ—¥è®°",
      description: "è®°å½•ä½ çš„æ€ç»ªä¸æ„Ÿæ‚Ÿ",
      prompt: "/journal",
    },
    {
      emoji: "ğŸŒ™",
      title: "è§£æ¢¦å¤§å¸ˆ",
      description: "è§£è¯»æ˜¨å¤œæ¢¦å¢ƒçš„å«ä¹‰",
      prompt: "/dream",
    },
    {
      emoji: "ğŸ§˜",
      title: "æ­£å¿µå†¥æƒ³",
      description: "5åˆ†é’Ÿå‘¼å¸ç»ƒä¹ ",
      prompt: "/breathe",
    },
  ]

  return (
    <div className="flex flex-col items-center justify-center min-h-full px-6 py-12">
      {/* Hero Section */}
      <motion.div
        className="text-center mb-12 max-w-lg"
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ duration: 0.6, ease: [0.16, 1, 0.3, 1] }}
      >
        {/* Main Greeting - Serif Italic */}
        <h1 className="font-serif text-4xl md:text-5xl font-normal italic text-foreground mb-4 leading-tight">
          {greeting}, Traveler.
        </h1>

        {/* Subtitle - Sans Regular */}
        <p className="text-lg text-foreground-muted font-normal">
          ä½ çš„å†…å¿ƒä»Šå¤©å¦‚ä½•ï¼Ÿ
        </p>
      </motion.div>

      {/* Prompt Cards Grid */}
      <div className="grid grid-cols-2 gap-4 w-full max-w-lg">
        {promptCards.map((card, index) => (
          <PromptCard
            key={card.prompt}
            emoji={card.emoji}
            title={card.title}
            description={card.description}
            onClick={() => onPromptClick?.(card.prompt)}
            delay={0.1 + index * 0.08}
          />
        ))}
      </div>

      {/* Command Hint */}
      <motion.p
        className="mt-8 text-sm text-foreground-subtle"
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ duration: 0.5, delay: 0.6 }}
      >
        è¾“å…¥ <kbd className="px-1.5 py-0.5 bg-background-subtle rounded text-xs font-mono border border-border/50">/</kbd> æŸ¥çœ‹æ›´å¤šå‘½ä»¤
      </motion.p>
    </div>
  )
}

interface MessageListProps {
  messages: Message[]
  isStreaming?: boolean
  className?: string
  onPromptClick?: (prompt: string) => void
}

export function MessageList({ messages, isStreaming, className, onPromptClick }: MessageListProps) {
  const bottomRef = useRef<HTMLDivElement>(null)

  // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: "smooth" })
  }, [messages])

  // ç©ºæ¶ˆæ¯æ—¶æ˜¾ç¤ºæ¬¢è¿é¡µ
  if (messages.length === 0) {
    return (
      <div className={cn("flex-1", className)}>
        <WelcomeSection onPromptClick={onPromptClick} />
      </div>
    )
  }

  return (
    <div className={cn("flex-1 overflow-y-auto px-4 py-6", className)}>
      <div className="max-w-2xl mx-auto space-y-6">
        {messages.map((message) => (
          <MessageItem key={message.id} message={message} />
        ))}

        {/* æµå¼è¾“å‡ºå…‰æ ‡ */}
        {isStreaming && (
          <div className="flex items-center gap-2 text-muted-foreground">
            <span className="inline-block w-2 h-5 bg-foreground animate-pulse" />
          </div>
        )}

        <div ref={bottomRef} />
      </div>
    </div>
  )
}
