-- Migration: 020_cold_layer_tables
-- Description: Create Cold Layer tables for AI insights and timeline events
-- Date: 2026-01-19

-- ═══════════════════════════════════════════════════════════════════════════
-- vibe_profile_insights - AI 生成的长期洞察
-- ═══════════════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS vibe_profile_insights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    insight_type VARCHAR(50) NOT NULL,  -- discovery | pattern | timing | growth
    skill_id VARCHAR(50),               -- 关联的 skill (可选)
    content TEXT NOT NULL,              -- 洞察内容
    metadata JSONB DEFAULT '{}',        -- 额外元数据
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_insights_user_id ON vibe_profile_insights(user_id);
CREATE INDEX IF NOT EXISTS idx_insights_type ON vibe_profile_insights(insight_type);
CREATE INDEX IF NOT EXISTS idx_insights_skill ON vibe_profile_insights(skill_id);
CREATE INDEX IF NOT EXISTS idx_insights_created ON vibe_profile_insights(created_at DESC);

-- ═══════════════════════════════════════════════════════════════════════════
-- vibe_profile_timeline - 重要事件时间线
-- ═══════════════════════════════════════════════════════════════════════════
CREATE TABLE IF NOT EXISTS vibe_profile_timeline (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    event_type VARCHAR(50) NOT NULL,    -- dayun_change | goal_completed | milestone | life_event
    event_date DATE NOT NULL,           -- 事件日期
    title VARCHAR(200) NOT NULL,        -- 事件标题
    data JSONB DEFAULT '{}',            -- 事件详情
    skill_id VARCHAR(50),               -- 关联的 skill (可选)
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_timeline_user_id ON vibe_profile_timeline(user_id);
CREATE INDEX IF NOT EXISTS idx_timeline_type ON vibe_profile_timeline(event_type);
CREATE INDEX IF NOT EXISTS idx_timeline_date ON vibe_profile_timeline(event_date DESC);
CREATE INDEX IF NOT EXISTS idx_timeline_user_date ON vibe_profile_timeline(user_id, event_date DESC);

-- 注释
COMMENT ON TABLE vibe_profile_insights IS 'AI 生成的用户洞察 (Cold Layer)';
COMMENT ON TABLE vibe_profile_timeline IS '用户重要事件时间线 (Cold Layer)';
