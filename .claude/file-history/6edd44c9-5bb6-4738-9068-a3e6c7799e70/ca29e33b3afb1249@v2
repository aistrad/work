/**
 * LifeCoach API - V8 人生仪表盘 API 封装
 *
 * 所有 API 调用通过统一的 Skills Gateway 访问
 * 端点: /api/v1/skills/lifecoach/{action}
 */

import { apiClient } from "./api";
import type {
  ReadStateRequest,
  ReadStateResponse,
  CheckinRequest,
  CheckinResponse,
  CompleteLeverRequest,
  CompleteRockRequest,
  UpdateProgressResponse,
  LifeCoachSection,
} from "@/types/lifecoach";

// V8: 使用统一的 Skills Gateway
const SKILLS_API_BASE = "/skills/lifecoach";

// ═══════════════════════════════════════════════════════════════════════════
// Read State
// ═══════════════════════════════════════════════════════════════════════════

/**
 * 读取 LifeCoach 状态
 * @param sections 要读取的数据部分
 */
export async function readState(
  sections: LifeCoachSection[]
): Promise<ReadStateResponse> {
  const { data } = await apiClient.post<ReadStateResponse>(
    `${SKILLS_API_BASE}/state_read`,
    { args: { sections } }
  );
  return data;
}

/**
 * 读取所有 LifeCoach 状态
 */
export async function readAllState(): Promise<ReadStateResponse> {
  return readState([
    "north_star",
    "goals",
    "roles",
    "weekly_rocks",
    "daily_levers",
    "monthly_boss",
    "progress",
  ]);
}

/**
 * 读取 Dashboard 所需的核心状态
 */
export async function readDashboardState(): Promise<ReadStateResponse> {
  return readState([
    "north_star",
    "goals",
    "roles",
    "weekly_rocks",
    "daily_levers",
    "progress",
  ]);
}

// ═══════════════════════════════════════════════════════════════════════════
// Checkin
// ═══════════════════════════════════════════════════════════════════════════

/**
 * 每日签到
 */
export async function checkin(
  params?: CheckinRequest
): Promise<CheckinResponse> {
  const { data } = await apiClient.post<CheckinResponse>(
    `${SKILLS_API_BASE}/checkin`,
    { args: params || {} }
  );
  return data;
}

// ═══════════════════════════════════════════════════════════════════════════
// Progress Updates
// ═══════════════════════════════════════════════════════════════════════════

/**
 * 完成每日杠杆
 */
export async function completeLever(
  params: CompleteLeverRequest
): Promise<UpdateProgressResponse> {
  const { data } = await apiClient.post<UpdateProgressResponse>(
    `${SKILLS_API_BASE}/lever_complete`,
    { args: params }
  );
  return data;
}

/**
 * 完成周大石头
 */
export async function completeRock(
  params: CompleteRockRequest
): Promise<UpdateProgressResponse> {
  const { data } = await apiClient.post<UpdateProgressResponse>(
    `${SKILLS_API_BASE}/rock_complete`,
    { args: params }
  );
  return data;
}

/**
 * 跳过每日杠杆
 */
export async function skipLever(
  leverId: string,
  reason?: string
): Promise<UpdateProgressResponse> {
  const { data } = await apiClient.post<UpdateProgressResponse>(
    `${SKILLS_API_BASE}/lever_skip`,
    { args: { lever_id: leverId, reason } }
  );
  return data;
}

// ═══════════════════════════════════════════════════════════════════════════
// Journal
// ═══════════════════════════════════════════════════════════════════════════

export interface JournalEntry {
  id: string;
  date: string;
  type: "reflection" | "gratitude" | "insight" | "note";
  content: string;
  mood?: string;
  tags?: string[];
  created_at: string;
}

export interface AddJournalEntryRequest {
  type: JournalEntry["type"];
  content: string;
  mood?: string;
  tags?: string[];
}

/**
 * 添加日志条目
 */
export async function addJournalEntry(
  params: AddJournalEntryRequest
): Promise<JournalEntry> {
  const { data } = await apiClient.post<{ success: boolean; entry: JournalEntry }>(
    `${SKILLS_API_BASE}/journal_add`,
    { args: params }
  );
  return data.entry;
}

/**
 * 获取日志列表
 */
export async function getJournalEntries(
  limit = 10,
  offset = 0
): Promise<JournalEntry[]> {
  const { data } = await apiClient.post<{ entries: JournalEntry[]; total: number }>(
    `${SKILLS_API_BASE}/journal_list`,
    { args: { limit, offset } }
  );
  return data.entries;
}

// ═══════════════════════════════════════════════════════════════════════════
// Notifications
// ═══════════════════════════════════════════════════════════════════════════

import type { ProactiveNotification } from "@/types/lifecoach";

/**
 * 获取待处理的主动通知
 * Note: 通知走统一的 notifications 路由
 */
export async function getPendingNotifications(): Promise<ProactiveNotification[]> {
  const { data } = await apiClient.get<ProactiveNotification[]>(
    "/notifications/pending"
  );
  return data;
}

/**
 * 关闭通知
 * Note: 通知走统一的 notifications 路由
 */
export async function dismissNotification(
  notificationId: string
): Promise<void> {
  await apiClient.post(`/notifications/${notificationId}/dismiss`);
}

// ═══════════════════════════════════════════════════════════════════════════
// Weekly Review & Planning
// ═══════════════════════════════════════════════════════════════════════════

export interface WeeklyReviewData {
  week_start: string;
  rocks_completed: number;
  rocks_total: number;
  levers_completed: number;
  levers_total: number;
  highlights?: string[];
  challenges?: string[];
  learnings?: string[];
  next_week_focus?: string;
}

/**
 * 获取周复盘数据
 */
export async function getWeeklyReview(
  weekStart?: string
): Promise<WeeklyReviewData> {
  const { data } = await apiClient.post<WeeklyReviewData>(
    `${SKILLS_API_BASE}/weekly_review`,
    { args: weekStart ? { week_start: weekStart } : {} }
  );
  return data;
}

/**
 * 提交周复盘
 * Note: 周复盘提交通过 journal_add 记录
 */
export async function submitWeeklyReview(
  review: Partial<WeeklyReviewData>
): Promise<{ success: boolean }> {
  const { data } = await apiClient.post<{ success: boolean; entry: JournalEntry }>(
    `${SKILLS_API_BASE}/journal_add`,
    { args: { type: "weekly_review", content: JSON.stringify(review), ...review } }
  );
  return { success: data.success };
}
