"use client";

/**
 * ResizablePanel - 可拖拽调节宽度的面板
 *
 * 功能:
 * - 支持拖拽调节宽度 (320px - 600px)
 * - 双击折叠/展开
 * - 记住用户偏好 (localStorage)
 * - 预设尺寸快捷切换 (S/M/L)
 */

import { useState, useRef, useEffect, useCallback, ReactNode } from "react";
import { cn } from "@/lib/utils";
import { ChevronLeft, ChevronRight, GripVertical } from "lucide-react";

// ═══════════════════════════════════════════════════════════════════════════
// Constants
// ═══════════════════════════════════════════════════════════════════════════

const MIN_WIDTH = 320;
const MAX_WIDTH = 600;
const DEFAULT_WIDTH = 400;
const COLLAPSED_WIDTH = 48;

const PRESETS = {
  S: 320,
  M: 400,
  L: 520,
} as const;

const STORAGE_KEY = "vibelife-panel-width";
const COLLAPSED_KEY = "vibelife-panel-collapsed";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface ResizablePanelProps {
  children: ReactNode;
  className?: string;
  /** 默认宽度 */
  defaultWidth?: number;
  /** 最小宽度 */
  minWidth?: number;
  /** 最大宽度 */
  maxWidth?: number;
  /** 折叠时的内容（图标条） */
  collapsedContent?: ReactNode;
  /** 宽度变化回调 */
  onWidthChange?: (width: number) => void;
  /** 折叠状态变化回调 */
  onCollapsedChange?: (collapsed: boolean) => void;
}

// ═══════════════════════════════════════════════════════════════════════════
// Hook: usePersistentState
// ═══════════════════════════════════════════════════════════════════════════

function usePersistentState<T>(key: string, initialValue: T): [T, (value: T) => void] {
  const [state, setState] = useState<T>(() => {
    if (typeof window === "undefined") return initialValue;
    try {
      const stored = localStorage.getItem(key);
      return stored ? JSON.parse(stored) : initialValue;
    } catch {
      return initialValue;
    }
  });

  const setValue = useCallback((value: T) => {
    setState(value);
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch {
      // Ignore storage errors
    }
  }, [key]);

  return [state, setValue];
}

// ═══════════════════════════════════════════════════════════════════════════
// ResizablePanel Component
// ═══════════════════════════════════════════════════════════════════════════

export function ResizablePanel({
  children,
  className,
  defaultWidth = DEFAULT_WIDTH,
  minWidth = MIN_WIDTH,
  maxWidth = MAX_WIDTH,
  collapsedContent,
  onWidthChange,
  onCollapsedChange,
}: ResizablePanelProps) {
  const [width, setWidth] = usePersistentState(STORAGE_KEY, defaultWidth);
  const [isCollapsed, setIsCollapsed] = usePersistentState(COLLAPSED_KEY, false);
  const [isDragging, setIsDragging] = useState(false);
  const panelRef = useRef<HTMLDivElement>(null);
  const startXRef = useRef(0);
  const startWidthRef = useRef(0);

  // Notify parent of changes
  useEffect(() => {
    onWidthChange?.(isCollapsed ? COLLAPSED_WIDTH : width);
  }, [width, isCollapsed, onWidthChange]);

  useEffect(() => {
    onCollapsedChange?.(isCollapsed);
  }, [isCollapsed, onCollapsedChange]);

  // Handle drag start
  const handleDragStart = useCallback((e: React.MouseEvent) => {
    e.preventDefault();
    setIsDragging(true);
    startXRef.current = e.clientX;
    startWidthRef.current = width;
  }, [width]);

  // Handle drag move
  useEffect(() => {
    if (!isDragging) return;

    const handleMouseMove = (e: MouseEvent) => {
      // Dragging from left edge, so moving left increases width
      const deltaX = startXRef.current - e.clientX;
      const newWidth = Math.min(maxWidth, Math.max(minWidth, startWidthRef.current + deltaX));
      setWidth(newWidth);
    };

    const handleMouseUp = () => {
      setIsDragging(false);
    };

    document.addEventListener("mousemove", handleMouseMove);
    document.addEventListener("mouseup", handleMouseUp);

    return () => {
      document.removeEventListener("mousemove", handleMouseMove);
      document.removeEventListener("mouseup", handleMouseUp);
    };
  }, [isDragging, minWidth, maxWidth, setWidth]);

  // Handle double-click to toggle collapse
  const handleDoubleClick = useCallback(() => {
    setIsCollapsed(!isCollapsed);
  }, [isCollapsed, setIsCollapsed]);

  // Toggle collapse
  const toggleCollapse = useCallback(() => {
    setIsCollapsed(!isCollapsed);
  }, [isCollapsed, setIsCollapsed]);

  // Set preset width
  const setPreset = useCallback((preset: keyof typeof PRESETS) => {
    setWidth(PRESETS[preset]);
    if (isCollapsed) {
      setIsCollapsed(false);
    }
  }, [setWidth, isCollapsed, setIsCollapsed]);

  const currentWidth = isCollapsed ? COLLAPSED_WIDTH : width;

  return (
    <aside
      ref={panelRef}
      className={cn(
        "relative flex-shrink-0 border-l border-border bg-background transition-[width] duration-200",
        isDragging && "select-none",
        className
      )}
      style={{ width: currentWidth }}
    >
      {/* Resize handle */}
      <div
        className={cn(
          "absolute left-0 top-0 bottom-0 w-1 cursor-col-resize z-10",
          "hover:bg-skill-primary/20 transition-colors",
          isDragging && "bg-skill-primary/30"
        )}
        onMouseDown={handleDragStart}
        onDoubleClick={handleDoubleClick}
      >
        {/* Drag indicator */}
        <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1/2 w-4 h-8 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
          <GripVertical className="w-3 h-3 text-muted-foreground" />
        </div>
      </div>

      {/* Panel content */}
      <div className="h-full overflow-hidden">
        {isCollapsed ? (
          // Collapsed state - show icon bar
          <div className="h-full flex flex-col items-center py-4">
            {/* Expand button */}
            <button
              onClick={toggleCollapse}
              className="p-2 rounded-lg hover:bg-foreground/5 transition-colors mb-4"
              title="展开面板"
            >
              <ChevronLeft className="w-5 h-5 text-muted-foreground" />
            </button>

            {/* Collapsed content (icons) */}
            {collapsedContent}
          </div>
        ) : (
          // Expanded state - show full content
          <div className="h-full flex flex-col">
            {/* Header with controls */}
            <div className="flex-shrink-0 px-3 py-2 border-b border-border/50 flex items-center justify-between">
              {/* Preset size buttons */}
              <div className="flex items-center gap-1">
                {(Object.keys(PRESETS) as Array<keyof typeof PRESETS>).map((preset) => (
                  <button
                    key={preset}
                    onClick={() => setPreset(preset)}
                    className={cn(
                      "px-2 py-0.5 text-xs rounded transition-colors",
                      width === PRESETS[preset]
                        ? "bg-skill-primary/10 text-skill-primary font-medium"
                        : "text-muted-foreground hover:text-foreground hover:bg-foreground/5"
                    )}
                    title={`${preset === "S" ? "紧凑" : preset === "M" ? "标准" : "宽松"} (${PRESETS[preset]}px)`}
                  >
                    {preset}
                  </button>
                ))}
              </div>

              {/* Collapse button */}
              <button
                onClick={toggleCollapse}
                className="p-1 rounded hover:bg-foreground/5 transition-colors"
                title="折叠面板"
              >
                <ChevronRight className="w-4 h-4 text-muted-foreground" />
              </button>
            </div>

            {/* Main content */}
            <div className="flex-1 overflow-y-auto">
              {children}
            </div>
          </div>
        )}
      </div>
    </aside>
  );
}

export default ResizablePanel;
