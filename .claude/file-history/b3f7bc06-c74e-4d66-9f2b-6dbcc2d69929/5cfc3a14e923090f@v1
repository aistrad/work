"use client";

/**
 * Bazi Chat Page - 八字命理对话页面（三栏布局）
 */

import { useMemo } from "react";
import { useRouter } from "next/navigation";
import { AppShell, useAppShell } from "@/components/layout";
import { ChatPanel, ChartPanel, JourneyPanel, MePanel } from "@/components/layout/panels";
import { ChatContainer } from "@/components/chat/ChatContainer";
import { LuminousPaper, BreathAura } from "@/components/core";

// ═══════════════════════════════════════════════════════════════════════════
// Panel Content Switcher
// ═══════════════════════════════════════════════════════════════════════════

function PanelContent() {
  const router = useRouter();
  const { activeTab } = useAppShell();
  const skill = "bazi";

  // Navigation handlers
  const handleOpenRelationship = () => {
    router.push("/bazi/relationship");
  };

  const handleGenerateReport = () => {
    router.push("/interview?returnTo=/bazi/report");
  };

  const handleViewKLine = () => {
    console.log("View K-Line");
  };

  // Demo data
  const demoProfile = useMemo(() => ({
    dayMaster: "甲木",
    pattern: "正印格",
    currentLuck: "壬寅大运",
    pillars: {
      year: { stem: "庚", branch: "午" },
      month: { stem: "戊", branch: "子" },
      day: { stem: "甲", branch: "辰" },
    },
  }), []);

  const demoNowNext = useMemo(() => ({
    now: {
      theme: "积累期 - 这是一个适合沉淀学习的阶段，不急于求成",
    },
    next: {
      startDate: "2026年下半年",
      theme: "突破期",
    },
  }), []);

  switch (activeTab) {
    case "chat":
      return (
        <ChatPanel
          skill={skill}
          profile={demoProfile}
          insights={[]}
          onOpenRelationship={handleOpenRelationship}
        />
      );
    case "chart":
      return (
        <ChartPanel
          skill={skill}
          nowNextData={demoNowNext}
          klinePreview={{
            currentScore: 72,
            trend: "up",
            period: "2026年",
          }}
          onViewKLine={handleViewKLine}
          onGenerateReport={handleGenerateReport}
        />
      );
    case "journey":
      return (
        <JourneyPanel
          skill={skill}
          totalConversations={12}
          totalInsights={5}
          memberSince="2025年12月"
          timeline={[
            {
              id: "1",
              date: "今天",
              title: "关于事业方向的对话",
              summary: "探讨了未来3年的职业规划",
              type: "conversation",
            },
            {
              id: "2",
              date: "昨天",
              title: "你的核心优势",
              summary: "甲木日主，天生有领导力和创造力",
              type: "insight",
            },
          ]}
        />
      );
    case "me":
      return (
        <MePanel
          skill={skill}
          user={{
            name: "测试用户",
            email: "test@vibelife.app",
            isPro: false,
          }}
          onLogout={() => console.log("Logout")}
        />
      );
    default:
      return null;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// Chat Content
// ═══════════════════════════════════════════════════════════════════════════

function ChatContent() {
  const { voiceMode } = useAppShell();
  const skill = "bazi";

  return (
    <LuminousPaper skill={skill} variant="default" className="h-full relative">
      <BreathAura
        skill={skill}
        size="xl"
        position="top"
        intensity="low"
        className="opacity-30"
      />
      <ChatContainer
        skillId={skill}
        skill={skill}
        voiceMode={voiceMode}
      />
    </LuminousPaper>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Main Page
// ═══════════════════════════════════════════════════════════════════════════

export default function BaziChatPage() {
  return (
    <AppShell skill="bazi" panelContent={<PanelContent />}>
      <ChatContent />
    </AppShell>
  );
}
