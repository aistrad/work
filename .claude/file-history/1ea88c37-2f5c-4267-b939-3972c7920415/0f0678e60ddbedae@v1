/**
 * 注册所有 Skill 卡片组件 (V7 重构版)
 *
 * v7.0 架构：
 * - 通用视图组件由 ShowCard 直接处理，无需注册
 * - Skill 自定义卡片通过 CardRegistry 注册
 * - 向后兼容旧卡片组件
 *
 * v10.4 性能优化 (Vercel rule: bundle-dynamic-imports):
 * - 使用动态导入延迟加载 Skill 卡片
 * - 只在首次需要时加载对应 Skill 的卡片
 */

import { registerCard, registerLazyCard, getRegisteredCardTypes, CARD_TYPES } from './CardRegistry';

// 通用视图组件 (由 ShowCard 直接处理)
import ShowCard from './shared/ShowCard';

// 向后兼容: 旧卡片组件 - 这些是常用的，保持同步导入
import CollectFormCard from './shared/CollectFormCard';
import InsightCard from './shared/InsightCard';
import SkillListCard from './shared/SkillListCard';

// QuestionCard - 问答卡片 (V10.3) - 常用，同步导入
import './shared/QuestionCard';

// 通用视图类型列表
const GENERIC_VIEW_TYPES = [
  CARD_TYPES.LIST,
  CARD_TYPES.TREE,
  CARD_TYPES.TABLE,
  CARD_TYPES.TIMELINE,
  CARD_TYPES.FORM,
  CARD_TYPES.SELECT,
  CARD_TYPES.CHART,
  CARD_TYPES.PROGRESS,
  CARD_TYPES.COUNTER,
  CARD_TYPES.MODAL,
  CARD_TYPES.TOAST,
  CARD_TYPES.CUSTOM,
] as const;

// 向后兼容卡片映射 - 常用的同步导入
const LEGACY_CARDS: Record<string, React.FC<any>> = {
  [CARD_TYPES.COLLECT_FORM]: CollectFormCard,
  [CARD_TYPES.INSIGHT_CARD]: InsightCard,
  [CARD_TYPES.SKILL_LIST]: SkillListCard,
};

// 延迟加载的卡片 (Vercel rule: bundle-dynamic-imports)
type LazyCardLoader = () => Promise<{ default: React.FC<any> }>;
const LAZY_CARDS: Record<string, LazyCardLoader> = {
  [CARD_TYPES.REPORT_CARD]: () => import('./panels/ReportPanel'),
  [CARD_TYPES.SKILL_SERVICES]: () => import('./shared/SkillServicesCard'),
  [CARD_TYPES.SERVICE_RECOMMENDATION]: () => import('./shared/ServiceRecommendationCard'),
  [CARD_TYPES.SKILL_RECOMMENDATION]: () => import('./shared/SkillRecommendationCard'),
  [CARD_TYPES.SKILL_INTRO]: () => import('./shared/SkillIntroCard'),
};

/**
 * 初始化卡片注册表
 * 在应用启动时调用
 *
 * v10.4: 使用懒加载减少初始 bundle 大小
 */
export function initializeCardRegistry(): void {
  // 注册通用视图组件 (V7)
  for (const type of GENERIC_VIEW_TYPES) {
    registerCard(type, ShowCard);
  }

  // 注册向后兼容卡片 (常用的同步导入)
  for (const [type, component] of Object.entries(LEGACY_CARDS)) {
    registerCard(type, component);
  }

  // 注册延迟加载卡片 (Vercel rule: bundle-dynamic-imports)
  for (const [type, loader] of Object.entries(LAZY_CARDS)) {
    registerLazyCard(type, loader);
  }

  // 注册 VibeID 卡片 - 懒加载
  registerLazyCard(CARD_TYPES.VIBE_ID, () => import('./vibe-id/tools/show-vibe-id').then(m => ({ default: m.ShowVibeID })));
  registerLazyCard(CARD_TYPES.VIBE_ID_RADAR, () => import('./vibe-id/tools/show-vibe-id').then(m => ({ default: m.ShowVibeID })));
  registerLazyCard(CARD_TYPES.VIBE_ID_REVEAL, () => import('./vibe-id/tools/show-vibe-id-reveal').then(m => ({ default: m.ShowVibeIDReveal })));  // v7.0 新增

  // 注册 Skill 卡片 - 懒加载 (Vercel rule: bundle-dynamic-imports)
  // Bazi 卡片
  registerLazyCard(CARD_TYPES.BAZI_CHART, () => import('./bazi/cards/BaziChartCard'));
  registerLazyCard(CARD_TYPES.BAZI_FORTUNE, () => import('./bazi/cards/BaziFortuneCard'));
  registerLazyCard(CARD_TYPES.BAZI_KLINE, () => import('./bazi/cards/BaziKlineCard'));
  registerLazyCard(CARD_TYPES.BAZI_DAILY_FORTUNE, () => import('./bazi/cards/BaziDailyFortuneCard'));

  // Zodiac 卡片
  registerLazyCard(CARD_TYPES.ZODIAC_CHART, () => import('./zodiac/cards/ZodiacChartCard'));
  registerLazyCard(CARD_TYPES.ZODIAC_TRANSIT, () => import('./zodiac/cards/ZodiacTransitCard'));
  registerLazyCard(CARD_TYPES.ZODIAC_SYNASTRY, () => import('./zodiac/cards/ZodiacSynastryCard'));
  registerLazyCard(CARD_TYPES.ZODIAC_LUNAR_PHASE, () => import('./zodiac/cards/ZodiacLunarPhaseCard'));

  // Jungastro 卡片
  registerLazyCard(CARD_TYPES.JUNGASTRO_PORTRAIT, () => import('./jungastro/cards/JungastroPsychologicalPortraitCard'));
  registerLazyCard(CARD_TYPES.JUNGASTRO_SHADOW, () => import('./jungastro/cards/JungastroShadowAnalysisCard'));
  registerLazyCard(CARD_TYPES.JUNGASTRO_INDIVIDUATION, () => import('./jungastro/cards/JungastroIndividuationPathCard'));
  registerLazyCard(CARD_TYPES.JUNGASTRO_FUNCTIONS, () => import('./jungastro/cards/JungastroPsychologicalFunctionsCard'));
  registerLazyCard(CARD_TYPES.JUNGASTRO_RELATIONSHIP, () => import('./jungastro/cards/JungastroRelationshipDynamicsCard'));

  // Tarot 卡片
  registerLazyCard(CARD_TYPES.TAROT_SPREAD, () => import('./tarot/cards/TarotSpreadCard'));

  // Career 卡片
  registerLazyCard(CARD_TYPES.CAREER_ANALYSIS, () => import('./career/cards/CareerAnalysisCard'));

  // Psych 卡片 (心理探索)
  registerLazyCard(CARD_TYPES.PSYCH_ASSESSMENT_FORM, () => import('./psych/cards/AssessmentFormCard'));
  registerLazyCard(CARD_TYPES.PSYCH_ASSESSMENT_RESULT, () => import('./psych/cards/AssessmentResultCard'));
  registerLazyCard(CARD_TYPES.PSYCH_DISTORTION, () => import('./psych/cards/DistortionCard'));
  registerLazyCard(CARD_TYPES.PSYCH_EXERCISE, () => import('./psych/cards/ExerciseCard'));
  registerLazyCard(CARD_TYPES.PSYCH_CRISIS_ALERT, () => import('./psych/cards/CrisisAlertCard'));
  registerLazyCard(CARD_TYPES.PSYCH_WORKSHOP_INTRO, () => import('./psych/cards/WorkshopIntroCard'));

  // Onboarding 卡片 (首次相遇) - 懒加载
  registerLazyCard(CARD_TYPES.INSIGHTS_CARD, () => import('./onboarding/cards/InsightsCard'));
  registerLazyCard(CARD_TYPES.GUIDANCE_CARD, () => import('./onboarding/cards/GuidanceCard'));

  if (process.env.NODE_ENV === 'development') {
    console.log('[CardRegistry] V7 Initialized:', getRegisteredCardTypes());
  }
}

// 导出 ShowCard 供直接使用
export { ShowCard };

// 自动初始化 - 当文件被导入时自动执行
initializeCardRegistry();

export default initializeCardRegistry;
