/**
 * InsightsCard - é¦–æ¬¡ç›¸é‡æ´å¯Ÿå¡ç‰‡
 *
 * å±•ç¤ºä¸‰ä¸ªç²¾å‡†æ´å¯Ÿ + åé¦ˆæŒ‰é’®
 * ç”¨äºé¦–æ¬¡ç›¸é‡ä½“éªŒçš„"æƒŠå–œ"é˜¶æ®µ
 */

'use client';

import React, { useState } from 'react';
import { cn } from '@/lib/utils';
import { registerCard } from '@/skills/CardRegistry';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface Insight {
  type: 'inner_conflict' | 'external_expression' | 'current_state';
  content: string;
  basis?: string;
}

interface FeedbackButton {
  id: string;
  label: string;
  emoji: string;
  message: string;
}

interface InsightsCardProps {
  insights: Insight[];
  pattern_name: string;
  sun_sign: string;
  feedback_buttons?: FeedbackButton[];
  onSendMessage?: (message: string) => void;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const INSIGHT_ICONS: Record<string, string> = {
  inner_conflict: 'ğŸ’­',
  external_expression: 'ğŸ­',
  current_state: 'ğŸŒŠ',
};

const INSIGHT_LABELS: Record<string, string> = {
  inner_conflict: 'å†…åœ¨',
  external_expression: 'å¤–åœ¨',
  current_state: 'å½“ä¸‹',
};

const DEFAULT_FEEDBACK_BUTTONS: FeedbackButton[] = [
  { id: 'accurate', label: 'è¯´å¾—å‡†', emoji: 'ğŸ‘', message: 'å‡†' },
  { id: 'not_accurate', label: 'ä¸å¤ªå‡†', emoji: 'ğŸ‘', message: 'ä¸å‡†' },
  { id: 'want_to_talk', label: 'æœ‰è¯æƒ³è¯´', emoji: 'ğŸ’¬', message: 'æƒ³è¯´è¯' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const InsightsCard: React.FC<InsightsCardProps> = ({
  insights,
  pattern_name,
  sun_sign,
  feedback_buttons = DEFAULT_FEEDBACK_BUTTONS,
  onSendMessage,
}) => {
  const [selectedFeedback, setSelectedFeedback] = useState<string | null>(null);
  const [isAnimating, setIsAnimating] = useState(false);

  // å¤„ç†åé¦ˆç‚¹å‡»
  const handleFeedbackClick = (button: FeedbackButton) => {
    if (selectedFeedback) return; // é˜²æ­¢é‡å¤ç‚¹å‡»

    setSelectedFeedback(button.id);
    setIsAnimating(true);

    // å‘é€åé¦ˆæ¶ˆæ¯
    if (onSendMessage) {
      setTimeout(() => {
        onSendMessage(button.message);
      }, 300); // ç­‰å¾…åŠ¨ç”»
    }
  };

  return (
    <div className="insights-card rounded-2xl bg-[var(--bg-card)] border border-[var(--border-default)] overflow-hidden shadow-[var(--shadow-card)]">
      {/* Header */}
      <div className="px-4 sm:px-6 py-4 border-b border-[var(--border-subtle)]">
        <div className="flex items-center gap-2">
          <span className="text-2xl">âœ¨</span>
          <div>
            <h3 className="font-semibold text-[var(--text-primary)]">
              ä½ æ˜¯ã€{pattern_name}Â·{sun_sign}ã€‘
            </h3>
            <p className="text-sm text-[var(--text-secondary)]">
              è®©æˆ‘çŒœçŒœä½ ...
            </p>
          </div>
        </div>
      </div>

      {/* Insights List */}
      <div className="px-4 sm:px-6 py-4 space-y-4">
        {insights.map((insight, index) => (
          <div
            key={insight.type}
            className={cn(
              "insight-item p-4 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-subtle)]",
              "transition-all duration-300",
              isAnimating && "opacity-80"
            )}
            style={{
              animationDelay: `${index * 100}ms`,
            }}
          >
            <div className="flex items-start gap-3">
              <span className="text-xl flex-shrink-0">
                {INSIGHT_ICONS[insight.type] || 'ğŸ’¡'}
              </span>
              <div className="flex-1">
                <span className="inline-block px-2 py-0.5 text-xs font-medium rounded-full bg-[var(--bg-tertiary)] text-[var(--text-secondary)] mb-2">
                  {INSIGHT_LABELS[insight.type] || 'æ´å¯Ÿ'}
                </span>
                <p className="text-[var(--text-primary)] leading-relaxed">
                  {insight.content}
                </p>
              </div>
            </div>
          </div>
        ))}
      </div>

      {/* Feedback Buttons */}
      <div className="px-4 sm:px-6 py-4 border-t border-[var(--border-subtle)] bg-[var(--bg-secondary)]/50">
        <p className="text-sm text-[var(--text-secondary)] text-center mb-3">
          æˆ‘è¯´å¾—å¯¹å—ï¼Ÿ
        </p>
        <div className="flex justify-center gap-3">
          {feedback_buttons.map((button) => (
            <button
              key={button.id}
              onClick={() => handleFeedbackClick(button)}
              disabled={Boolean(selectedFeedback)}
              className={cn(
                "feedback-btn px-4 py-2 rounded-full text-sm font-medium",
                "border border-[var(--border-default)]",
                "transition-all duration-200",
                "hover:bg-[var(--bg-tertiary)] hover:border-[var(--border-strong)]",
                "focus:outline-none focus:ring-2 focus:ring-[var(--ring-primary)] focus:ring-offset-2",
                "disabled:opacity-50 disabled:cursor-not-allowed",
                selectedFeedback === button.id && "bg-[var(--bg-brand)] border-[var(--border-brand)] text-white"
              )}
            >
              <span className="mr-1.5">{button.emoji}</span>
              {button.label}
            </button>
          ))}
        </div>
      </div>
    </div>
  );
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register Card
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard('insights_card', InsightsCard);

export default InsightsCard;
