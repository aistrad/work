'use client'

/**
 * Home Page - V9 è·¯ç”±åˆ†å‘
 *
 * V9 å˜æ›´:
 * - å·²ç™»å½•ç”¨æˆ·é‡å®šå‘åˆ° Chatï¼ˆDashboard å·²æ•´åˆï¼‰
 * - æœªç™»å½•ç”¨æˆ·æ˜¾ç¤º Landing Page
 */

import { useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { useAuth } from '@/providers'

// Landing page components (lazy loaded for unauthenticated users)
import { useState, useMemo, useCallback, memo } from 'react'
import { PCLayout } from '@/components/layout/PCLayout'
import { Card } from '@/components/ui/Card'
import { Button } from '@/components/ui/Button'
import {
  LandingHero,
  FeatureCard,
  SkillPreview,
  SectionTitle,
  RecentChatCard,
} from '@/components/landing'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const FEATURES = [
  { id: 'bazi', name: 'å…«å­—å‘½ç›˜', subtitle: 'BaZi Chart', icon: 'ğŸŒŸ', available: true, desc: 'æ¢ç´¢ä½ çš„å‘½ç†å¯†ç ï¼Œäº†è§£å¤©èµ‹ä¸è¿åŠ¿' },
  { id: 'zodiac', name: 'æ˜Ÿåº§è§£è¯»', subtitle: 'Zodiac Reading', icon: 'ğŸ”®', available: true, desc: 'æ˜Ÿè±¡æŒ‡å¼•ï¼Œæ´å¯Ÿäººç”Ÿæ–¹å‘ä¸æœºé‡' },
  { id: 'tarot', name: 'å¡”ç½—å åœ', subtitle: 'Tarot Reading', icon: 'ğŸƒ', available: false, desc: 'æ¢ç´¢å‘½è¿çš„æŒ‡å¼•ï¼Œè·å–æ™ºæ…§å¯ç¤º' },
  { id: 'career', name: 'èŒä¸šè§„åˆ’', subtitle: 'Career Planning', icon: 'ğŸ§­', available: false, desc: 'å‘ç°èŒä¸šæ–¹å‘ï¼Œè§„åˆ’æˆé•¿è·¯å¾„' },
]

const RECENT_CHATS = [
  { id: '1', title: 'å…³äºèŒä¸šå‘å±•çš„è®¨è®º', summary: 'æˆ‘ä»¬èŠäº†å…³äºè½¬è¡Œåˆ°ç§‘æŠ€è¡Œä¸šçš„å¯èƒ½æ€§ï¼Œç»“åˆä½ çš„å…«å­—åˆ†æ...', time: '2å°æ—¶å‰' },
  { id: '2', title: 'æœ¬æœˆè¿åŠ¿åˆ†æ', summary: 'æ ¹æ®æµæœˆå¤©å¹²åœ°æ”¯ä¸ä½ æœ¬å‘½ç›˜çš„å…³ç³»ï¼Œè¿™ä¸ªæœˆçš„é‡ç‚¹åœ¨äº...', time: 'æ˜¨å¤©' },
  { id: '3', title: 'æ„Ÿæƒ…å›°æ‰°å’¨è¯¢', summary: 'å…³äºä½ æåˆ°çš„æ„Ÿæƒ…é—®é¢˜ï¼Œä»æ˜Ÿåº§ç›¸ä½æ¥çœ‹...', time: '3å¤©å‰' },
]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper Functions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getGreeting(): string {
  const hour = new Date().getHours()
  if (hour < 6) return 'å¤œæ·±äº†'
  if (hour < 12) return 'æ—©ä¸Šå¥½'
  if (hour < 18) return 'ä¸‹åˆå¥½'
  return 'æ™šä¸Šå¥½'
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Aside Content - PC ç«¯å³ä¾§æ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AsideContentProps {
  isPremium: boolean
  onNavigate: (path: string) => void
}

const AsideContent = memo(function AsideContent({ isPremium, onNavigate }: AsideContentProps) {
  return (
    <div className="space-y-6">
      {/* ä»Šæ—¥è¿åŠ¿ */}
      <Card variant="default" padding="md" hover={false}>
        <div className="flex items-center gap-2 mb-3">
          <span className="text-lg">ğŸŒ…</span>
          <h3 className="text-sm font-semibold text-text-primary">ä»Šæ—¥è¿åŠ¿</h3>
        </div>
        <div className="p-3 rounded-lg bg-gradient-to-br from-vellum-100 to-vellum-200">
          <p className="text-sm text-text-primary mb-1">ç”²å­æ—¥ Â· æ°´æ°”æ—ºç››</p>
          <p className="text-xs text-text-secondary">é€‚åˆå¤„ç†æ²Ÿé€šã€å­¦ä¹ ç›¸å…³äº‹åŠ¡</p>
        </div>
        {!isPremium && (
          <button
            onClick={() => onNavigate('/membership')}
            className="mt-3 w-full text-xs text-accent-primary font-medium hover:underline"
          >
            å‡çº§ Premium è§£é”è¯¦ç»†åˆ†æ â†’
          </button>
        )}
      </Card>

      {/* èº«ä»½ç”»åƒ */}
      <Card
        variant="elevated"
        padding="md"
        hover
        className="cursor-pointer"
        onClick={() => onNavigate('/identity')}
      >
        <div className="flex items-center gap-3 mb-3">
          <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-mystic-400 to-mystic-600 flex items-center justify-center">
            <span className="text-xl">ğŸ’</span>
          </div>
          <div>
            <h3 className="text-sm font-semibold text-text-primary">èº«ä»½ç”»åƒ</h3>
            <p className="text-xs text-text-secondary">Identity Prism</p>
          </div>
        </div>
        <div className="mb-3">
          <div className="text-xs text-text-secondary mb-1.5">å·²äº†è§£ä½ çš„ 68%</div>
          <div className="h-2 bg-bg-secondary rounded-full overflow-hidden">
            <div
              className="h-full bg-gradient-to-r from-accent-primary to-accent-secondary rounded-full transition-all duration-slow"
              style={{ width: '68%' }}
            />
          </div>
        </div>
        <span className="text-xs text-accent-primary font-medium">æŸ¥çœ‹å¤šç»´åº¦èåˆç”»åƒ â†’</span>
      </Card>

      {/* é€šçŸ¥ */}
      <Card variant="flat" padding="md" hover={false}>
        <div className="flex items-center gap-2 mb-3">
          <span className="text-lg">ğŸ””</span>
          <h3 className="text-sm font-semibold text-text-primary">é€šçŸ¥</h3>
        </div>
        <div className="space-y-2">
          <div className="p-2 rounded-lg bg-bg-secondary">
            <p className="text-xs text-text-primary">æ˜æ—¥è¿åŠ¿æé†’å·²å¼€å¯</p>
            <p className="text-xs text-text-tertiary mt-0.5">æ¯æ—¥ 8:00 æ¨é€</p>
          </div>
        </div>
      </Card>
    </div>
  )
})

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Content
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface MainContentProps {
  greeting: string
  userName: string
  today: string
  onNavigate: (path: string) => void
  onFeatureClick: (id: string, available: boolean) => void
  onChatClick: (id: string) => void
}

const MainContent = memo(function MainContent({
  greeting,
  userName,
  today,
  onNavigate,
  onFeatureClick,
  onChatClick,
}: MainContentProps) {
  return (
    <div className="space-y-8">
      {/* Hero Card - v7.1 æ¸å˜èƒŒæ™¯ */}
      <Card
        variant="default"
        padding="lg"
        hover={false}
        className="relative overflow-hidden animate-fade-in"
      >
        {/* Background gradient */}
        <div className="absolute inset-0 bg-gradient-to-br from-vellum-100/80 via-vellum-50/50 to-transparent pointer-events-none" />

        <div className="relative z-10">
          <div className="flex items-start justify-between mb-4">
            <div>
              <h1 className="font-serif text-2xl md:text-3xl text-text-primary mb-1">
                ğŸ‘‹ {greeting}ï¼Œ{userName}
              </h1>
              <p className="text-sm text-text-secondary">{today}</p>
            </div>
          </div>
          <p className="text-base text-text-secondary mb-5 max-w-xl">
            ä»Šå¤©æ˜¯ç”²å­æ—¥ï¼Œæ°´æ°”æ—ºç››ã€‚å¯¹äºæˆŠåœŸæ—¥ä¸»çš„ä½ æ¥è¯´ï¼Œä»Šå¤©é€‚åˆå¤„ç†ä¸æ²Ÿé€šã€å­¦ä¹ ç›¸å…³çš„äº‹åŠ¡ã€‚
          </p>
          <Button
            variant="primary"
            onClick={() => onNavigate('/chat?q=ä»Šæ—¥è¿åŠ¿')}
          >
            æŸ¥çœ‹ä»Šæ—¥è¯¦ç»†è¿åŠ¿
          </Button>
        </div>
      </Card>

      {/* Features Grid */}
      <section>
        <SectionTitle title="æ¢ç´¢åŠŸèƒ½" subtitle="é€‰æ‹©ä½ æ„Ÿå…´è¶£çš„é¢†åŸŸå¼€å§‹æ¢ç´¢" />
        <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
          {FEATURES.map((feature, i) => (
            <FeatureCard
              key={feature.id}
              icon={feature.icon}
              title={feature.name}
              description={feature.desc}
              disabled={!feature.available}
              badge={feature.available ? 'å¯ç”¨' : undefined}
              onClick={() => onFeatureClick(feature.id, feature.available)}
              className="animate-fade-in-up"
              style={{ animationDelay: `${i * 50}ms` } as React.CSSProperties}
            />
          ))}
        </div>
      </section>

      {/* Mobile: Identity Card */}
      <Card
        variant="elevated"
        padding="md"
        hover
        className="lg:hidden cursor-pointer animate-fade-in"
        onClick={() => onNavigate('/identity')}
      >
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-mystic-400 to-mystic-600 flex items-center justify-center">
            <span className="text-2xl">ğŸ’</span>
          </div>
          <div className="flex-1">
            <h3 className="font-serif text-base font-semibold text-text-primary">æˆ‘çš„èº«ä»½ç”»åƒ</h3>
            <p className="text-xs text-text-secondary">æŸ¥çœ‹å¤šç»´åº¦èåˆçš„ä¸“å±ç”»åƒ â†’</p>
          </div>
        </div>
      </Card>

      {/* Recent Chats - PC only */}
      <section className="hidden lg:block">
        <SectionTitle
          title="æœ€è¿‘å¯¹è¯"
          action={{ label: 'æŸ¥çœ‹å…¨éƒ¨', onClick: () => onNavigate('/chat') }}
        />
        <Card variant="default" padding="none" hover={false}>
          <div className="divide-y divide-subtle/50">
            {RECENT_CHATS.map((chat) => (
              <RecentChatCard
                key={chat.id}
                {...chat}
                onClick={() => onChatClick(chat.id)}
              />
            ))}
          </div>
        </Card>
      </section>
    </div>
  )
})

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Mobile Layout
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface MobileLayoutProps {
  children: React.ReactNode
  onOmnibarFocus: () => void
}

const MobileLayout = memo(function MobileLayout({ children, onOmnibarFocus }: MobileLayoutProps) {
  return (
    <div className="min-h-screen bg-bg-primary lg:hidden">
      {/* Header */}
      <header className="sticky top-0 z-40 h-14 px-4 flex items-center justify-between bg-bg-primary/95 backdrop-blur-md border-b border-subtle/30">
        <div className="flex items-center gap-2">
          <span className="text-2xl">ğŸŒŸ</span>
          <div>
            <h1 className="font-serif text-lg font-semibold text-text-primary">VibeLife</h1>
          </div>
        </div>
        <div className="flex items-center gap-2">
          <button className="p-2 rounded-lg text-text-secondary hover:bg-bg-secondary transition-colors">
            ğŸ””
          </button>
          <button className="p-2 rounded-lg text-text-secondary hover:bg-bg-secondary transition-colors">
            â˜°
          </button>
        </div>
      </header>

      {/* Content */}
      <main className="px-4 py-6 pb-24">
        {children}
      </main>

      {/* Bottom Omnibar */}
      <div className="fixed bottom-0 left-0 right-0 p-4 bg-bg-primary border-t border-subtle/30 pb-safe">
        <div className="max-w-lg mx-auto">
          <div className="flex items-center gap-3 bg-bg-card shadow-card rounded-2xl px-4 py-2.5">
            <input
              type="text"
              placeholder="Type '/' for commands..."
              className="flex-1 bg-transparent text-text-primary placeholder:text-text-disabled focus:outline-none"
              onFocus={onOmnibarFocus}
            />
            <button className="w-9 h-9 rounded-full bg-accent-primary text-text-inverse flex items-center justify-center">
              â–¶
            </button>
          </div>
        </div>
      </div>
    </div>
  )
})

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Home Page
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default function HomePage() {
  const router = useRouter()
  const { isSignedIn, isLoaded } = useAuth()
  const [isPremium] = useState(false)
  const [userName] = useState('ç”¨æˆ·')
  const [greeting] = useState(getGreeting)

  // All hooks must be called before any conditional returns
  const today = useMemo(
    () => new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' }),
    []
  )

  const handleNavigate = useCallback((path: string) => {
    router.push(path)
  }, [router])

  const handleFeatureClick = useCallback((id: string, available: boolean) => {
    if (available) {
      router.push(`/chat?skill=${id}`)
    }
  }, [router])

  const handleChatClick = useCallback((id: string) => {
    router.push(`/chat?id=${id}`)
  }, [router])

  const handleOmnibarFocus = useCallback(() => {
    router.push('/chat')
  }, [router])

  // V9: Redirect authenticated users to Chat (Dashboard integrated)
  useEffect(() => {
    if (isLoaded && isSignedIn) {
      router.replace('/chat')
    }
  }, [isSignedIn, isLoaded, router])

  // Show loading while checking auth
  if (!isLoaded) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-background">
        <div className="animate-pulse text-muted-foreground">åŠ è½½ä¸­...</div>
      </div>
    )
  }

  // If authenticated, show nothing while redirecting
  if (isSignedIn) {
    return null
  }

  const mainContent = (
    <MainContent
      greeting={greeting}
      userName={userName}
      today={today}
      onNavigate={handleNavigate}
      onFeatureClick={handleFeatureClick}
      onChatClick={handleChatClick}
    />
  )

  return (
    <>
      {/* PCç«¯: ä½¿ç”¨ PCLayout ä¸‰æ å¸ƒå±€ */}
      <div className="hidden lg:block">
        <PCLayout
          breadcrumb={[{ label: 'é¦–é¡µ' }]}
          aside={<AsideContent isPremium={isPremium} onNavigate={handleNavigate} />}
        >
          {mainContent}
        </PCLayout>
      </div>

      {/* ç§»åŠ¨ç«¯: ç®€å•å•æ å¸ƒå±€ */}
      <MobileLayout onOmnibarFocus={handleOmnibarFocus}>
        {mainContent}
      </MobileLayout>
    </>
  )
}
