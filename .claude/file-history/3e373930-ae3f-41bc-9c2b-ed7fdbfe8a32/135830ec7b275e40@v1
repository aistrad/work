"""
A2UI (Agent-to-UI) Component System.

REQ: REQ-UI-001
Design: §4.1 A2UI Specification

Defines the schema for AI-generated UI components that can be rendered
by the frontend. Supports various component types for rich interactions.
"""

from typing import Any, Dict, List, Optional
from enum import Enum


class ValidationError(Exception):
    pass


class ComponentType(str, Enum):
    """Supported A2UI component types."""
    # Text components
    MARKDOWN_TEXT = "markdown_text"      # Markdown content
    PLAIN_TEXT = "plain_text"            # Plain text

    # Interactive components
    ACTION_BUTTONS = "action_buttons"    # Button group
    QUICK_REPLIES = "quick_replies"      # Quick reply chips

    # Data display components
    STAT_CARD = "stat_card"              # Statistics card
    PROGRESS_BAR = "progress_bar"        # Progress indicator
    LIST_VIEW = "list_view"              # List of items
    KEY_VALUE = "key_value"              # Key-value pairs

    # Media components
    IMAGE = "image"                      # Image display
    CHART = "chart"                      # Simple chart (future)

    # Layout components
    DIVIDER = "divider"                  # Visual separator
    SPACER = "spacer"                    # Vertical space


class ActionType(str, Enum):
    """Supported action types for interactive components."""
    START_TASK = "start_task"
    SCHEDULE_TASK = "schedule_task"
    DONE_TASK = "done_task"
    OPEN_PANEL = "open_panel"
    OPT_OUT = "opt_out"
    CHECKIN = "checkin"
    COMMITMENT = "commitment"
    SHARE = "share"
    READ_MORE = "read_more"
    NAVIGATE = "navigate"
    SEND_MESSAGE = "send_message"
    EXTERNAL_LINK = "external_link"


REQUIRED_ROOT_KEYS = {"meta", "ui_components"}


def validate_a2ui(payload: Dict[str, Any]) -> None:
    """Validate minimal A2UI schema from docs/design v2.md.

    Required:
    - meta: object
    - ui_components: list[ { type, title, data } ]
    """
    if not isinstance(payload, dict):
        raise ValidationError("payload must be object")
    missing = REQUIRED_ROOT_KEYS - payload.keys()
    if missing:
        raise ValidationError(f"missing keys: {sorted(missing)}")

    comps = payload.get("ui_components")
    if not isinstance(comps, list) or not comps:
        raise ValidationError("ui_components must be non-empty list")

    for i, c in enumerate(comps):
        if not isinstance(c, dict):
            raise ValidationError(f"ui_components[{i}] not object")
        for k in ("type", "title", "data"):
            if k not in c:
                raise ValidationError(f"component missing {k}")


def create_component(
    component_type: str,
    title: str,
    data: Any,
    style: Optional[Dict[str, Any]] = None,
) -> Dict[str, Any]:
    """Create a validated A2UI component."""
    component = {
        "type": component_type,
        "title": title,
        "data": data,
    }
    if style:
        component["style"] = style
    return component


def create_markdown_text(content: str, title: str = "") -> Dict[str, Any]:
    """Create a markdown text component."""
    return create_component(ComponentType.MARKDOWN_TEXT.value, title, content)


def create_action_buttons(
    buttons: List[Dict[str, Any]],
    title: str = "下一步",
) -> Dict[str, Any]:
    """
    Create an action buttons component.

    Each button should have:
    - label: str - Button text
    - action: dict - Action to perform {type, ...params}
    - style: str (optional) - "primary", "secondary", "ghost", "danger"
    """
    return create_component(ComponentType.ACTION_BUTTONS.value, title, buttons)


def create_quick_replies(
    replies: List[str],
    title: str = "快捷回复",
) -> Dict[str, Any]:
    """
    Create quick reply chips.

    Each reply is a string that will be sent as a message when clicked.
    """
    return create_component(ComponentType.QUICK_REPLIES.value, title, replies)


def create_stat_card(
    stats: List[Dict[str, Any]],
    title: str = "数据概览",
) -> Dict[str, Any]:
    """
    Create a statistics card component.

    Each stat should have:
    - label: str - Stat label
    - value: str|number - Stat value
    - unit: str (optional) - Unit suffix
    - trend: str (optional) - "up", "down", "neutral"
    - change: str (optional) - Change description
    """
    return create_component(ComponentType.STAT_CARD.value, title, stats)


def create_progress_bar(
    current: int,
    total: int,
    label: str = "",
    title: str = "进度",
) -> Dict[str, Any]:
    """Create a progress bar component."""
    return create_component(
        ComponentType.PROGRESS_BAR.value,
        title,
        {"current": current, "total": total, "label": label},
    )


def create_list_view(
    items: List[Dict[str, Any]],
    title: str = "列表",
) -> Dict[str, Any]:
    """
    Create a list view component.

    Each item should have:
    - title: str - Item title
    - subtitle: str (optional) - Item subtitle
    - icon: str (optional) - Icon name or emoji
    - action: dict (optional) - Action when clicked
    """
    return create_component(ComponentType.LIST_VIEW.value, title, items)


def create_key_value(
    pairs: List[Dict[str, Any]],
    title: str = "详情",
) -> Dict[str, Any]:
    """
    Create a key-value pairs component.

    Each pair should have:
    - key: str - Label
    - value: str - Value
    """
    return create_component(ComponentType.KEY_VALUE.value, title, pairs)


def create_divider(title: str = "") -> Dict[str, Any]:
    """Create a visual divider."""
    return create_component(ComponentType.DIVIDER.value, title, None)


def create_spacer(height: int = 16) -> Dict[str, Any]:
    """Create vertical space."""
    return create_component(ComponentType.SPACER.value, "", {"height": height})


def build_a2ui(
    components: List[Dict[str, Any]],
    summary: str = "",
    score: Optional[float] = None,
) -> Dict[str, Any]:
    """
    Build a complete A2UI payload.

    Args:
        components: List of UI components
        summary: Brief summary for the response
        score: Optional relevance/confidence score

    Returns:
        Complete A2UI payload ready for rendering
    """
    meta = {"summary": summary}
    if score is not None:
        meta["score"] = score

    return {
        "meta": meta,
        "ui_components": components,
    }


def example_payload() -> Dict[str, Any]:
    """保留示例结构用于本地测试，但禁止用于写库。
    注意：任何写入 gemini_task.output_text 的逻辑已从本项目清除。
    """
    return {"meta": {"score": 0, "summary": "(示例) 本地测试结构"}, "ui_components": [{"type": "markdown_text", "title": "示例", "data": "占位结构，禁止写库"}]}
