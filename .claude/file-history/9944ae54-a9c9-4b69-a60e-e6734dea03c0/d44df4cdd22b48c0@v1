/**
 * CareerAnalysisCard - èŒä¸šåˆ†æå¡ç‰‡
 *
 * å±•ç¤ºèŒä¸šæ–¹å‘åˆ†æï¼ŒåŒ…æ‹¬é€‚åˆçš„è¡Œä¸šã€èŒä¸šè·¯å¾„ã€æŠ€èƒ½å»ºè®®ç­‰
 * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "career_analysis" è§¦å‘
 */

"use client";

import { useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface CareerDirection {
  title: string;
  description: string;
  match_score?: number; // 0-100
  industries?: string[];
  key_skills?: string[];
  growth_potential?: "high" | "medium" | "low";
}

interface SkillGap {
  skill: string;
  current_level?: string;
  target_level?: string;
  priority?: "high" | "medium" | "low";
  learning_resources?: string[];
}

interface CareerAnalysisData {
  analysis_type?: "direction" | "industry" | "skills" | "transition";
  primary_direction?: CareerDirection;
  alternative_directions?: CareerDirection[];
  current_strengths?: string[];
  skill_gaps?: SkillGap[];
  industry_trends?: string[];
  recommendations?: string[];
  next_steps?: string[];
  analyzed_at?: string;
}

interface CareerAnalysisCardProps {
  data: CareerAnalysisData;
  cardProps?: Record<string, unknown>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MATCH_SCORE_COLORS = {
  high: "from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30 border-green-200 dark:border-green-800",
  medium: "from-yellow-50 to-amber-50 dark:from-yellow-950/30 dark:to-amber-950/30 border-yellow-200 dark:border-yellow-800",
  low: "from-gray-50 to-slate-50 dark:from-gray-950/30 dark:to-slate-950/30 border-gray-200 dark:border-gray-800",
};

const GROWTH_POTENTIAL_LABELS = {
  high: "ğŸš€ é«˜å¢é•¿",
  medium: "ğŸ“ˆ ç¨³å®šå¢é•¿",
  low: "ğŸ“Š å¹³ç¨³",
};

const PRIORITY_COLORS = {
  high: "bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300",
  medium: "bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300",
  low: "bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getMatchLevel(score: number): "high" | "medium" | "low" {
  if (score >= 75) return "high";
  if (score >= 50) return "medium";
  return "low";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function CareerAnalysisCard({ data }: CareerAnalysisCardProps) {
  const [expandedDirection, setExpandedDirection] = useState<string | null>(null);
  const [showSkillGaps, setShowSkillGaps] = useState(false);

  // V7: é”™è¯¯çŠ¶æ€æ£€æŸ¥
  if ((data as any)?.status === "error" || (data as any)?.need_info) {
    return null;
  }

  const primaryDirection = data.primary_direction;
  const alternatives = data.alternative_directions || [];
  const skillGaps = data.skill_gaps || [];

  // æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
  if (!primaryDirection && alternatives.length === 0) {
    return null;
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      className="career-analysis-card bg-gradient-to-br from-blue-50/80 to-cyan-50/80 dark:from-blue-950/20 dark:to-cyan-950/20 rounded-xl border border-blue-200 dark:border-blue-800 p-4 my-2 overflow-hidden"
    >
      {/* Header */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.2 }}
        className="flex items-center justify-between mb-4"
      >
        <h3 className="text-lg font-semibold text-accent-900 dark:text-accent-100 flex items-center gap-2">
          <span>ğŸ’¼</span>
          <span>èŒä¸šæ–¹å‘åˆ†æ</span>
        </h3>
        {data.analyzed_at && (
          <span className="text-xs text-muted-foreground">
            {new Date(data.analyzed_at).toLocaleString("zh-CN")}
          </span>
        )}
      </motion.div>

      {/* Primary Direction */}
      {primaryDirection && (
        <motion.div
          initial={{ opacity: 0, x: -20 }}
          animate={{ opacity: 1, x: 0 }}
          transition={{ delay: 0.3 }}
          className="mb-4"
        >
          <div className={`bg-gradient-to-br ${
            primaryDirection.match_score
              ? MATCH_SCORE_COLORS[getMatchLevel(primaryDirection.match_score)]
              : MATCH_SCORE_COLORS.medium
          } rounded-lg border p-4`}>
            <div className="flex items-start justify-between mb-2">
              <h4 className="text-base font-semibold text-accent-900 dark:text-accent-100">
                {primaryDirection.title}
              </h4>
              {primaryDirection.match_score !== undefined && (
                <div className="flex flex-col items-end">
                  <span className="text-2xl font-bold text-blue-600 dark:text-blue-400">
                    {primaryDirection.match_score}%
                  </span>
                  <span className="text-xs text-muted-foreground">åŒ¹é…åº¦</span>
                </div>
              )}
            </div>

            <p className="text-sm text-accent-700 dark:text-accent-300 mb-3 leading-relaxed">
              {primaryDirection.description}
            </p>

            {/* Growth Potential */}
            {primaryDirection.growth_potential && (
              <div className="mb-3">
                <span className="inline-block px-2 py-1 bg-white/60 dark:bg-black/30 rounded text-xs font-medium">
                  {GROWTH_POTENTIAL_LABELS[primaryDirection.growth_potential]}
                </span>
              </div>
            )}

            {/* Industries */}
            {primaryDirection.industries && primaryDirection.industries.length > 0 && (
              <div className="mb-3">
                <div className="text-xs font-medium text-blue-700 dark:text-blue-300 mb-1">
                  æ¨èè¡Œä¸š
                </div>
                <div className="flex flex-wrap gap-1.5">
                  {primaryDirection.industries.map((industry, idx) => (
                    <span
                      key={idx}
                      className="px-2 py-0.5 bg-blue-100 dark:bg-blue-900/50 rounded text-xs text-blue-700 dark:text-blue-300"
                    >
                      {industry}
                    </span>
                  ))}
                </div>
              </div>
            )}

            {/* Key Skills */}
            {primaryDirection.key_skills && primaryDirection.key_skills.length > 0 && (
              <div>
                <div className="text-xs font-medium text-blue-700 dark:text-blue-300 mb-1">
                  æ ¸å¿ƒæŠ€èƒ½
                </div>
                <div className="flex flex-wrap gap-1.5">
                  {primaryDirection.key_skills.map((skill, idx) => (
                    <span
                      key={idx}
                      className="px-2 py-0.5 bg-cyan-100 dark:bg-cyan-900/50 rounded text-xs text-cyan-700 dark:text-cyan-300"
                    >
                      {skill}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </div>
        </motion.div>
      )}

      {/* Alternative Directions */}
      {alternatives.length > 0 && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
          className="mb-4"
        >
          <div className="text-sm font-medium text-accent-900 dark:text-accent-100 mb-2">
            å…¶ä»–å¯é€‰æ–¹å‘
          </div>
          <div className="space-y-2">
            {alternatives.map((direction, index) => {
              const isExpanded = expandedDirection === direction.title;
              const matchLevel = direction.match_score
                ? getMatchLevel(direction.match_score)
                : "medium";

              return (
                <motion.div
                  key={index}
                  initial={{ opacity: 0, x: -10 }}
                  animate={{ opacity: 1, x: 0 }}
                  transition={{ delay: 0.6 + index * 0.1 }}
                  onClick={() => setExpandedDirection(isExpanded ? null : direction.title)}
                  className={`bg-gradient-to-br ${MATCH_SCORE_COLORS[matchLevel]} rounded-lg border p-3 cursor-pointer hover:shadow-md transition-shadow ${
                    isExpanded ? "ring-2 ring-blue-400" : ""
                  }`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2">
                        <h5 className="text-sm font-medium text-accent-900 dark:text-accent-100">
                          {direction.title}
                        </h5>
                        {direction.match_score !== undefined && (
                          <span className="text-xs font-semibold text-blue-600 dark:text-blue-400">
                            {direction.match_score}%
                          </span>
                        )}
                      </div>
                      <p className="text-xs text-accent-700 dark:text-accent-300 mt-1 leading-relaxed">
                        {direction.description}
                      </p>
                    </div>
                  </div>

                  <AnimatePresence>
                    {isExpanded && (
                      <motion.div
                        initial={{ height: 0, opacity: 0 }}
                        animate={{ height: "auto", opacity: 1 }}
                        exit={{ height: 0, opacity: 0 }}
                        transition={{ duration: 0.2 }}
                        className="mt-2 pt-2 border-t border-blue-200 dark:border-blue-800 overflow-hidden"
                      >
                        {direction.industries && direction.industries.length > 0 && (
                          <div className="mb-2">
                            <div className="text-xs font-medium text-blue-700 dark:text-blue-300 mb-1">
                              æ¨èè¡Œä¸š
                            </div>
                            <div className="flex flex-wrap gap-1">
                              {direction.industries.map((industry, idx) => (
                                <span
                                  key={idx}
                                  className="px-1.5 py-0.5 bg-blue-100 dark:bg-blue-900/50 rounded text-xs text-blue-700 dark:text-blue-300"
                                >
                                  {industry}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        {direction.key_skills && direction.key_skills.length > 0 && (
                          <div>
                            <div className="text-xs font-medium text-blue-700 dark:text-blue-300 mb-1">
                              æ ¸å¿ƒæŠ€èƒ½
                            </div>
                            <div className="flex flex-wrap gap-1">
                              {direction.key_skills.map((skill, idx) => (
                                <span
                                  key={idx}
                                  className="px-1.5 py-0.5 bg-cyan-100 dark:bg-cyan-900/50 rounded text-xs text-cyan-700 dark:text-cyan-300"
                                >
                                  {skill}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                      </motion.div>
                    )}
                  </AnimatePresence>
                </motion.div>
              );
            })}
          </div>
        </motion.div>
      )}

      {/* Current Strengths */}
      {data.current_strengths && data.current_strengths.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.8 }}
          className="bg-green-50/60 dark:bg-green-950/20 rounded-lg p-3 mb-3"
        >
          <div className="text-sm font-medium text-green-700 dark:text-green-300 mb-2 flex items-center gap-1">
            <span>âœ…</span>
            <span>ä½ çš„ä¼˜åŠ¿</span>
          </div>
          <ul className="space-y-1">
            {data.current_strengths.map((strength, idx) => (
              <li key={idx} className="text-xs text-accent-700 dark:text-accent-300 flex items-start gap-2">
                <span className="text-green-600 dark:text-green-400 mt-0.5">â€¢</span>
                <span>{strength}</span>
              </li>
            ))}
          </ul>
        </motion.div>
      )}

      {/* Skill Gaps */}
      {skillGaps.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.9 }}
          className="mb-3"
        >
          <button
            onClick={() => setShowSkillGaps(!showSkillGaps)}
            className="w-full flex items-center justify-between bg-orange-50/60 dark:bg-orange-950/20 rounded-lg p-3 hover:bg-orange-100/60 dark:hover:bg-orange-950/30 transition-colors"
          >
            <div className="text-sm font-medium text-orange-700 dark:text-orange-300 flex items-center gap-1">
              <span>ğŸ¯</span>
              <span>éœ€è¦æå‡çš„æŠ€èƒ½ ({skillGaps.length})</span>
            </div>
            <span className="text-xs text-orange-600 dark:text-orange-400">
              {showSkillGaps ? "æ”¶èµ·" : "å±•å¼€"}
            </span>
          </button>

          <AnimatePresence>
            {showSkillGaps && (
              <motion.div
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: "auto", opacity: 1 }}
                exit={{ height: 0, opacity: 0 }}
                transition={{ duration: 0.3 }}
                className="mt-2 space-y-2 overflow-hidden"
              >
                {skillGaps.map((gap, idx) => (
                  <div
                    key={idx}
                    className="bg-white/60 dark:bg-black/30 rounded-lg p-3 text-xs"
                  >
                    <div className="flex items-start justify-between mb-1">
                      <span className="font-medium text-accent-900 dark:text-accent-100">
                        {gap.skill}
                      </span>
                      {gap.priority && (
                        <span className={`px-1.5 py-0.5 rounded text-xs ${PRIORITY_COLORS[gap.priority]}`}>
                          {gap.priority === "high" ? "é«˜ä¼˜å…ˆçº§" : gap.priority === "medium" ? "ä¸­ä¼˜å…ˆçº§" : "ä½ä¼˜å…ˆçº§"}
                        </span>
                      )}
                    </div>
                    {gap.current_level && gap.target_level && (
                      <div className="text-xs text-muted-foreground mb-2">
                        {gap.current_level} â†’ {gap.target_level}
                      </div>
                    )}
                    {gap.learning_resources && gap.learning_resources.length > 0 && (
                      <div className="text-xs text-blue-600 dark:text-blue-400">
                        æ¨èå­¦ä¹ ï¼š{gap.learning_resources.join("ã€")}
                      </div>
                    )}
                  </div>
                ))}
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      )}

      {/* Recommendations */}
      {data.recommendations && data.recommendations.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.0 }}
          className="bg-blue-50/60 dark:bg-blue-950/20 rounded-lg p-3 mb-3"
        >
          <div className="text-sm font-medium text-blue-700 dark:text-blue-300 mb-2 flex items-center gap-1">
            <span>ğŸ’¡</span>
            <span>å»ºè®®</span>
          </div>
          <ul className="space-y-1">
            {data.recommendations.map((rec, idx) => (
              <li key={idx} className="text-xs text-accent-700 dark:text-accent-300 flex items-start gap-2">
                <span className="text-blue-600 dark:text-blue-400 mt-0.5">â€¢</span>
                <span>{rec}</span>
              </li>
            ))}
          </ul>
        </motion.div>
      )}

      {/* Next Steps */}
      {data.next_steps && data.next_steps.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.1 }}
          className="bg-gradient-to-r from-cyan-50/60 to-blue-50/60 dark:from-cyan-950/20 dark:to-blue-950/20 rounded-lg p-3"
        >
          <div className="text-sm font-medium text-cyan-700 dark:text-cyan-300 mb-2 flex items-center gap-1">
            <span>ğŸš€</span>
            <span>ä¸‹ä¸€æ­¥è¡ŒåŠ¨</span>
          </div>
          <ol className="space-y-1.5">
            {data.next_steps.map((step, idx) => (
              <li key={idx} className="text-xs text-accent-700 dark:text-accent-300 flex items-start gap-2">
                <span className="font-semibold text-cyan-600 dark:text-cyan-400 mt-0.5">{idx + 1}.</span>
                <span>{step}</span>
              </li>
            ))}
          </ol>
        </motion.div>
      )}

      {/* Hint */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 1.3 }}
        className="mt-3 text-xs text-center text-muted-foreground"
      >
        ğŸ’¡ ç‚¹å‡»å…¶ä»–æ–¹å‘æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
      </motion.div>
    </motion.div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("career_analysis", CareerAnalysisCard);

export default CareerAnalysisCard;
