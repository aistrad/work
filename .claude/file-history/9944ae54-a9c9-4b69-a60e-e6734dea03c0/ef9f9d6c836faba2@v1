/**
 * PersonalityProfileCard - äººæ ¼ç”»åƒå¡ç‰‡
 *
 * å±•ç¤ºäººæ ¼ç±»å‹åˆ†æï¼ŒåŒ…æ‹¬ MBTIã€ä¹å‹äººæ ¼ã€ä¼˜åŠ¿ç­‰
 * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "personality_profile" è§¦å‘
 */

"use client";

import { useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface PersonalityTrait {
  name: string;
  score: number; // 0-100
  description?: string;
}

interface PersonalityStrength {
  title: string;
  description: string;
  examples?: string[];
}

interface PersonalityBlindSpot {
  area: string;
  description: string;
  mitigation?: string;
}

interface PersonalityProfileData {
  profile_type?: "mbti" | "enneagram" | "strengths" | "general";

  // MBTI
  mbti_type?: string; // e.g., "INTJ"
  mbti_full_name?: string; // e.g., "å»ºç­‘å¸ˆ"
  mbti_dimensions?: {
    ei?: { type: "E" | "I"; score: number; label: string };
    sn?: { type: "S" | "N"; score: number; label: string };
    tf?: { type: "T" | "F"; score: number; label: string };
    jp?: { type: "J" | "P"; score: number; label: string };
  };

  // ä¹å‹äººæ ¼
  enneagram_type?: number; // 1-9
  enneagram_name?: string;
  enneagram_wing?: string;

  // æ ¸å¿ƒç‰¹è´¨
  core_traits?: PersonalityTrait[];

  // ä¼˜åŠ¿å’Œç›²ç‚¹
  strengths?: PersonalityStrength[];
  blind_spots?: PersonalityBlindSpot[];

  // èŒä¸šåŒ¹é…
  career_fit?: string[];
  work_style?: string;

  // äººé™…å…³ç³»
  communication_style?: string;
  relationship_patterns?: string[];

  // æˆé•¿å»ºè®®
  growth_areas?: string[];
  development_tips?: string[];

  analyzed_at?: string;
}

interface PersonalityProfileCardProps {
  data: PersonalityProfileData;
  cardProps?: Record<string, unknown>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MBTI_COLORS: Record<string, string> = {
  E: "bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300",
  I: "bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300",
  S: "bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300",
  N: "bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300",
  T: "bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300",
  F: "bg-pink-100 dark:bg-pink-900/50 text-pink-700 dark:text-pink-300",
  J: "bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300",
  P: "bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300",
};

const ENNEAGRAM_EMOJIS: Record<number, string> = {
  1: "âš–ï¸", 2: "â¤ï¸", 3: "â­", 4: "ğŸ¨", 5: "ğŸ”",
  6: "ğŸ›¡ï¸", 7: "ğŸ‰", 8: "ğŸ’ª", 9: "â˜®ï¸",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getScoreColor(score: number): string {
  if (score >= 75) return "bg-green-500";
  if (score >= 50) return "bg-blue-500";
  if (score >= 25) return "bg-yellow-500";
  return "bg-gray-500";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function PersonalityProfileCard({ data }: PersonalityProfileCardProps) {
  const [expandedSection, setExpandedSection] = useState<string | null>(null);

  // V7: é”™è¯¯çŠ¶æ€æ£€æŸ¥
  if ((data as any)?.status === "error" || (data as any)?.need_info) {
    return null;
  }

  const profileType = data.profile_type || "general";
  const hasMBTI = !!data.mbti_type;
  const hasEnneagram = !!data.enneagram_type;

  // æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
  if (!hasMBTI && !hasEnneagram && (!data.core_traits || data.core_traits.length === 0)) {
    return null;
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      className="personality-profile-card bg-gradient-to-br from-violet-50/80 to-purple-50/80 dark:from-violet-950/20 dark:to-purple-950/20 rounded-xl border border-violet-200 dark:border-violet-800 p-4 my-2 overflow-hidden"
    >
      {/* Header */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.2 }}
        className="flex items-center justify-between mb-4"
      >
        <h3 className="text-lg font-semibold text-accent-900 dark:text-accent-100 flex items-center gap-2">
          <span>ğŸ‘¤</span>
          <span>äººæ ¼ç”»åƒ</span>
        </h3>
        {data.analyzed_at && (
          <span className="text-xs text-muted-foreground">
            {new Date(data.analyzed_at).toLocaleString("zh-CN")}
          </span>
        )}
      </motion.div>

      {/* MBTI Type */}
      {hasMBTI && (
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ delay: 0.3 }}
          className="mb-4"
        >
          <div className="bg-gradient-to-br from-purple-100/80 to-pink-100/80 dark:from-purple-900/30 dark:to-pink-900/30 rounded-lg border border-purple-200 dark:border-purple-800 p-4">
            <div className="text-center mb-3">
              <div className="text-3xl font-bold text-purple-700 dark:text-purple-300 mb-1">
                {data.mbti_type}
              </div>
              {data.mbti_full_name && (
                <div className="text-sm text-purple-600 dark:text-purple-400">
                  {data.mbti_full_name}
                </div>
              )}
            </div>

            {/* MBTI Dimensions */}
            {data.mbti_dimensions && (
              <div className="space-y-2">
                {Object.entries(data.mbti_dimensions).map(([key, dim], index) => {
                  if (!dim) return null;
                  return (
                    <motion.div
                      key={key}
                      initial={{ opacity: 0, x: -10 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: 0.4 + index * 0.1 }}
                      className="flex items-center gap-2"
                    >
                      <span className={`px-2 py-1 rounded font-semibold text-xs ${MBTI_COLORS[dim.type]}`}>
                        {dim.type}
                      </span>
                      <div className="flex-1 h-2 bg-white/50 dark:bg-black/20 rounded-full overflow-hidden">
                        <motion.div
                          initial={{ width: 0 }}
                          animate={{ width: `${dim.score}%` }}
                          transition={{ delay: 0.5 + index * 0.1, duration: 0.5 }}
                          className={`h-full ${getScoreColor(dim.score)}`}
                        />
                      </div>
                      <span className="text-xs text-muted-foreground w-8 text-right">
                        {dim.score}%
                      </span>
                    </motion.div>
                  );
                })}
              </div>
            )}
          </div>
        </motion.div>
      )}

      {/* Enneagram Type */}
      {hasEnneagram && (
        <motion.div
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ delay: 0.5 }}
          className="mb-4"
        >
          <div className="bg-gradient-to-br from-indigo-100/80 to-blue-100/80 dark:from-indigo-900/30 dark:to-blue-900/30 rounded-lg border border-indigo-200 dark:border-indigo-800 p-4 text-center">
            <div className="text-4xl mb-2">
              {ENNEAGRAM_EMOJIS[data.enneagram_type || 1]}
            </div>
            <div className="text-lg font-semibold text-indigo-700 dark:text-indigo-300">
              ä¹å‹äººæ ¼ï¼š{data.enneagram_type}å·
            </div>
            {data.enneagram_name && (
              <div className="text-sm text-indigo-600 dark:text-indigo-400 mt-1">
                {data.enneagram_name}
              </div>
            )}
            {data.enneagram_wing && (
              <div className="text-xs text-muted-foreground mt-2">
                ä¾§ç¿¼ï¼š{data.enneagram_wing}
              </div>
            )}
          </div>
        </motion.div>
      )}

      {/* Core Traits */}
      {data.core_traits && data.core_traits.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.6 }}
          className="mb-4"
        >
          <div className="text-sm font-medium text-accent-900 dark:text-accent-100 mb-2">
            æ ¸å¿ƒç‰¹è´¨
          </div>
          <div className="space-y-2">
            {data.core_traits.map((trait, index) => (
              <motion.div
                key={index}
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: 0.7 + index * 0.1 }}
                className="bg-white/60 dark:bg-black/30 rounded-lg p-3"
              >
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm font-medium text-accent-900 dark:text-accent-100">
                    {trait.name}
                  </span>
                  <span className="text-xs font-semibold text-violet-600 dark:text-violet-400">
                    {trait.score}%
                  </span>
                </div>
                <div className="h-1.5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden mb-2">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${trait.score}%` }}
                    transition={{ delay: 0.8 + index * 0.1, duration: 0.5 }}
                    className={`h-full ${getScoreColor(trait.score)}`}
                  />
                </div>
                {trait.description && (
                  <p className="text-xs text-accent-700 dark:text-accent-300 leading-relaxed">
                    {trait.description}
                  </p>
                )}
              </motion.div>
            ))}
          </div>
        </motion.div>
      )}

      {/* Strengths */}
      {data.strengths && data.strengths.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.9 }}
          className="mb-3"
        >
          <button
            onClick={() => setExpandedSection(expandedSection === "strengths" ? null : "strengths")}
            className="w-full flex items-center justify-between bg-green-50/60 dark:bg-green-950/20 rounded-lg p-3 hover:bg-green-100/60 dark:hover:bg-green-950/30 transition-colors"
          >
            <div className="text-sm font-medium text-green-700 dark:text-green-300 flex items-center gap-1">
              <span>âœ¨</span>
              <span>ä½ çš„ä¼˜åŠ¿ ({data.strengths.length})</span>
            </div>
            <span className="text-xs text-green-600 dark:text-green-400">
              {expandedSection === "strengths" ? "æ”¶èµ·" : "å±•å¼€"}
            </span>
          </button>

          <AnimatePresence>
            {expandedSection === "strengths" && (
              <motion.div
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: "auto", opacity: 1 }}
                exit={{ height: 0, opacity: 0 }}
                transition={{ duration: 0.3 }}
                className="mt-2 space-y-2 overflow-hidden"
              >
                {data.strengths.map((strength, idx) => (
                  <div
                    key={idx}
                    className="bg-white/60 dark:bg-black/30 rounded-lg p-3"
                  >
                    <div className="font-medium text-sm text-green-700 dark:text-green-300 mb-1">
                      {strength.title}
                    </div>
                    <p className="text-xs text-accent-700 dark:text-accent-300 mb-2 leading-relaxed">
                      {strength.description}
                    </p>
                    {strength.examples && strength.examples.length > 0 && (
                      <div className="text-xs text-muted-foreground">
                        ä¾‹å¦‚ï¼š{strength.examples.join("ã€")}
                      </div>
                    )}
                  </div>
                ))}
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      )}

      {/* Blind Spots */}
      {data.blind_spots && data.blind_spots.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.0 }}
          className="mb-3"
        >
          <button
            onClick={() => setExpandedSection(expandedSection === "blind_spots" ? null : "blind_spots")}
            className="w-full flex items-center justify-between bg-orange-50/60 dark:bg-orange-950/20 rounded-lg p-3 hover:bg-orange-100/60 dark:hover:bg-orange-950/30 transition-colors"
          >
            <div className="text-sm font-medium text-orange-700 dark:text-orange-300 flex items-center gap-1">
              <span>âš ï¸</span>
              <span>æˆé•¿ç©ºé—´ ({data.blind_spots.length})</span>
            </div>
            <span className="text-xs text-orange-600 dark:text-orange-400">
              {expandedSection === "blind_spots" ? "æ”¶èµ·" : "å±•å¼€"}
            </span>
          </button>

          <AnimatePresence>
            {expandedSection === "blind_spots" && (
              <motion.div
                initial={{ height: 0, opacity: 0 }}
                animate={{ height: "auto", opacity: 1 }}
                exit={{ height: 0, opacity: 0 }}
                transition={{ duration: 0.3 }}
                className="mt-2 space-y-2 overflow-hidden"
              >
                {data.blind_spots.map((spot, idx) => (
                  <div
                    key={idx}
                    className="bg-white/60 dark:bg-black/30 rounded-lg p-3"
                  >
                    <div className="font-medium text-sm text-orange-700 dark:text-orange-300 mb-1">
                      {spot.area}
                    </div>
                    <p className="text-xs text-accent-700 dark:text-accent-300 mb-2 leading-relaxed">
                      {spot.description}
                    </p>
                    {spot.mitigation && (
                      <div className="text-xs text-blue-600 dark:text-blue-400">
                        ğŸ’¡ {spot.mitigation}
                      </div>
                    )}
                  </div>
                ))}
              </motion.div>
            )}
          </AnimatePresence>
        </motion.div>
      )}

      {/* Career Fit */}
      {data.career_fit && data.career_fit.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.1 }}
          className="bg-blue-50/60 dark:bg-blue-950/20 rounded-lg p-3 mb-3"
        >
          <div className="text-sm font-medium text-blue-700 dark:text-blue-300 mb-2">
            é€‚åˆçš„èŒä¸šé¢†åŸŸ
          </div>
          <div className="flex flex-wrap gap-1.5">
            {data.career_fit.map((career, idx) => (
              <span
                key={idx}
                className="px-2 py-1 bg-blue-100 dark:bg-blue-900/50 rounded text-xs text-blue-700 dark:text-blue-300"
              >
                {career}
              </span>
            ))}
          </div>
        </motion.div>
      )}

      {/* Growth Areas */}
      {data.growth_areas && data.growth_areas.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.2 }}
          className="bg-gradient-to-r from-violet-50/60 to-purple-50/60 dark:from-violet-950/20 dark:to-purple-950/20 rounded-lg p-3"
        >
          <div className="text-sm font-medium text-violet-700 dark:text-violet-300 mb-2 flex items-center gap-1">
            <span>ğŸŒ±</span>
            <span>æˆé•¿å»ºè®®</span>
          </div>
          <ul className="space-y-1">
            {data.growth_areas.map((area, idx) => (
              <li key={idx} className="text-xs text-accent-700 dark:text-accent-300 flex items-start gap-2">
                <span className="text-violet-600 dark:text-violet-400 mt-0.5">â€¢</span>
                <span>{area}</span>
              </li>
            ))}
          </ul>
        </motion.div>
      )}

      {/* Hint */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 1.4 }}
        className="mt-3 text-xs text-center text-muted-foreground"
      >
        ğŸ’¡ ç‚¹å‡»ä¼˜åŠ¿å’Œæˆé•¿ç©ºé—´æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
      </motion.div>
    </motion.div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("personality_profile", PersonalityProfileCard);

export default PersonalityProfileCard;
