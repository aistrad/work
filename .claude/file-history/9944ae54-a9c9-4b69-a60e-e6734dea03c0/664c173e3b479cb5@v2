/**
 * TarotSpreadCard - å¡”ç½—ç‰Œé˜µå¡ç‰‡
 *
 * å±•ç¤ºå¡”ç½—å åœç»“æœï¼Œæ”¯æŒå¤šç§ç‰Œé˜µç±»å‹
 * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "tarot_spread" è§¦å‘
 */

"use client";

import { useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface TarotCard {
  name: string;
  position: "upright" | "reversed";
  meaning?: string;
  interpretation?: string;
  position_label?: string; // åœ¨ç‰Œé˜µä¸­çš„ä½ç½®æ ‡ç­¾ï¼ˆå¦‚"è¿‡å»"ã€"ç°åœ¨"ã€"æœªæ¥"ï¼‰
  card_number?: number;
  suit?: string; // å¤§é˜¿å°”å¡çº³æˆ–å°é˜¿å°”å¡çº³ç‰Œç»„
}

interface TarotSpreadData {
  question?: string;
  spread_type?: "single" | "three" | "celtic_cross";
  cards?: TarotCard[];
  summary?: string;
  advice?: string;
  drawn_at?: string;
}

interface TarotSpreadCardProps {
  data: TarotSpreadData;
  cardProps?: Record<string, unknown>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SPREAD_NAMES: Record<string, string> = {
  single: "å•ç‰Œå åœ",
  three: "ä¸‰ç‰Œå åœ",
  celtic_cross: "å‡¯å°”ç‰¹åå­—",
};

const THREE_CARD_LABELS = ["è¿‡å»", "ç°åœ¨", "æœªæ¥"];

const CARD_COLORS = {
  upright: "from-purple-50 to-pink-50 dark:from-purple-950/30 dark:to-pink-950/30 border-purple-200 dark:border-purple-800",
  reversed: "from-indigo-50 to-blue-50 dark:from-indigo-950/30 dark:to-blue-950/30 border-indigo-200 dark:border-indigo-800",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function TarotSpreadCard({ data }: TarotSpreadCardProps) {
  const [expandedCard, setExpandedCard] = useState<number | null>(null);
  const [showAllInterpretations, setShowAllInterpretations] = useState(false);

  // V7: é”™è¯¯çŠ¶æ€æ£€æŸ¥
  if ((data as any)?.status === "error" || (data as any)?.need_info) {
    return null;
  }

  const cards = data.cards || [];
  const spreadType = data.spread_type || "single";
  const question = data.question;

  // æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
  if (cards.length === 0) {
    return null;
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      className="tarot-spread-card bg-gradient-to-br from-purple-50/80 to-pink-50/80 dark:from-purple-950/20 dark:to-pink-950/20 rounded-xl border border-purple-200 dark:border-purple-800 p-4 my-2 overflow-hidden"
    >
      {/* Header */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.2 }}
        className="mb-4"
      >
        <div className="flex items-center justify-between mb-2">
          <h3 className="text-lg font-semibold text-accent-900 dark:text-accent-100 flex items-center gap-2">
            <span>ğŸ”®</span>
            <span>{SPREAD_NAMES[spreadType] || "å¡”ç½—å åœ"}</span>
          </h3>
          {data.drawn_at && (
            <span className="text-xs text-muted-foreground">
              {new Date(data.drawn_at).toLocaleString("zh-CN")}
            </span>
          )}
        </div>

        {question && (
          <motion.div
            initial={{ opacity: 0, x: -10 }}
            animate={{ opacity: 1, x: 0 }}
            transition={{ delay: 0.3 }}
            className="bg-white/60 dark:bg-black/30 rounded-lg p-3 mb-3"
          >
            <div className="text-sm font-medium text-purple-700 dark:text-purple-300 mb-1">
              ä½ çš„é—®é¢˜
            </div>
            <p className="text-sm text-accent-700 dark:text-accent-300 italic">
              &ldquo;{question}&rdquo;
            </p>
          </motion.div>
        )}
      </motion.div>

      {/* Cards Display */}
      <div className={`grid gap-3 mb-4 ${
        cards.length === 1 ? "grid-cols-1" :
        cards.length === 3 ? "grid-cols-3" :
        "grid-cols-2 sm:grid-cols-3"
      }`}>
        {cards.map((card, index) => {
          const isExpanded = expandedCard === index;
          const isReversed = card.position === "reversed";
          const positionLabel = card.position_label ||
            (spreadType === "three" && index < 3 ? THREE_CARD_LABELS[index] : undefined);

          return (
            <motion.div
              key={index}
              initial={{ opacity: 0, scale: 0.8, rotateY: -90 }}
              animate={{ opacity: 1, scale: 1, rotateY: 0 }}
              transition={{ delay: 0.4 + index * 0.15, duration: 0.6 }}
              onClick={() => setExpandedCard(isExpanded ? null : index)}
              className={`relative cursor-pointer transition-all duration-300 ${
                isExpanded ? "col-span-full" : ""
              }`}
            >
              <div className={`bg-gradient-to-br ${
                isReversed ? CARD_COLORS.reversed : CARD_COLORS.upright
              } rounded-lg border p-4 hover:shadow-lg transition-shadow ${
                isExpanded ? "ring-2 ring-purple-400" : ""
              }`}>
                {/* Position Label */}
                {positionLabel && (
                  <div className="text-xs text-center text-purple-600 dark:text-purple-400 font-medium mb-2">
                    {positionLabel}
                  </div>
                )}

                {/* Card Icon/Visual */}
                <motion.div
                  className="text-center mb-3"
                  animate={{ rotateZ: isReversed ? 180 : 0 }}
                  transition={{ duration: 0.5 }}
                >
                  <div className="text-4xl mb-2">
                    {isReversed ? "ğŸƒ" : "ğŸ´"}
                  </div>
                  <div className={`text-sm font-semibold ${
                    isReversed ? "text-indigo-700 dark:text-indigo-300" : "text-purple-700 dark:text-purple-300"
                  }`}>
                    {card.name}
                  </div>
                  {card.suit && (
                    <div className="text-xs text-muted-foreground mt-1">
                      {card.suit}
                    </div>
                  )}
                </motion.div>

                {/* Position Badge */}
                <div className="flex justify-center mb-2">
                  <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                    isReversed
                      ? "bg-indigo-100 dark:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300"
                      : "bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300"
                  }`}>
                    {isReversed ? "é€†ä½ â†“" : "æ­£ä½ â†‘"}
                  </span>
                </div>

                {/* Card Meaning (Always visible if available) */}
                {card.meaning && (
                  <div className="text-xs text-center text-muted-foreground mb-2">
                    {card.meaning}
                  </div>
                )}

                {/* Interpretation (Expandable) */}
                <AnimatePresence>
                  {(isExpanded || showAllInterpretations) && card.interpretation && (
                    <motion.div
                      initial={{ height: 0, opacity: 0 }}
                      animate={{ height: "auto", opacity: 1 }}
                      exit={{ height: 0, opacity: 0 }}
                      transition={{ duration: 0.3 }}
                      className="overflow-hidden"
                    >
                      <div className="mt-3 pt-3 border-t border-purple-200 dark:border-purple-800">
                        <div className="text-xs font-medium text-purple-700 dark:text-purple-300 mb-1">
                          è§£è¯»
                        </div>
                        <p className="text-xs text-accent-700 dark:text-accent-300 leading-relaxed">
                          {card.interpretation}
                        </p>
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            </motion.div>
          );
        })}
      </div>

      {/* Toggle All Interpretations Button */}
      {cards.some(c => c.interpretation) && !expandedCard && (
        <motion.button
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.8 }}
          onClick={() => setShowAllInterpretations(!showAllInterpretations)}
          className="w-full mb-3 px-4 py-2 bg-purple-100 dark:bg-purple-900/30 hover:bg-purple-200 dark:hover:bg-purple-900/50 rounded-lg text-sm font-medium text-purple-700 dark:text-purple-300 transition-colors"
        >
          {showAllInterpretations ? "æ”¶èµ·æ‰€æœ‰è§£è¯»" : "å±•å¼€æ‰€æœ‰è§£è¯»"}
        </motion.button>
      )}

      {/* Summary */}
      {data.summary && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.9 }}
          className="bg-white/60 dark:bg-black/30 rounded-lg p-3 mb-3"
        >
          <div className="text-sm font-medium text-purple-700 dark:text-purple-300 mb-1">
            æ•´ä½“è§£è¯»
          </div>
          <p className="text-sm text-accent-700 dark:text-accent-300 leading-relaxed">
            {data.summary}
          </p>
        </motion.div>
      )}

      {/* Advice */}
      {data.advice && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.0 }}
          className="bg-gradient-to-r from-purple-100/80 to-pink-100/80 dark:from-purple-900/30 dark:to-pink-900/30 rounded-lg p-3"
        >
          <div className="text-sm font-medium text-purple-700 dark:text-purple-300 mb-1 flex items-center gap-1">
            <span>âœ¨</span>
            <span>å»ºè®®</span>
          </div>
          <p className="text-sm text-accent-700 dark:text-accent-300 leading-relaxed">
            {data.advice}
          </p>
        </motion.div>
      )}

      {/* Hint */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 1.2 }}
        className="mt-3 text-xs text-center text-muted-foreground"
      >
        ğŸ’¡ ç‚¹å‡»ç‰Œé¢æŸ¥çœ‹è¯¦ç»†è§£è¯»
      </motion.div>
    </motion.div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("tarot_spread", TarotSpreadCard);

export default TarotSpreadCard;
