#!/usr/bin/env python3
"""测试所有 skill 的 show_skill_intro 工具定义"""
import yaml
import os

skills = ["bazi", "zodiac", "jungastro", "tarot", "career", "mindfulness", "vibe_id"]
base_path = "/home/aiscend/work/vibelife/apps/api/skills"

results = {}

for skill_id in skills:
    tools_file = f"{base_path}/{skill_id}/tools/tools.yaml"

    if not os.path.exists(tools_file):
        results[skill_id] = {"status": "file_not_found"}
        continue

    try:
        with open(tools_file, 'r', encoding='utf-8') as f:
            tools_config = yaml.safe_load(f)

        # 查找 show_skill_intro 工具
        has_intro_tool = False
        intro_tool_details = None

        if 'tools' in tools_config:
            for tool in tools_config['tools']:
                if tool.get('name') == 'show_skill_intro':
                    has_intro_tool = True
                    intro_tool_details = {
                        'card_type': tool.get('card_type'),
                        'when_to_call': tool.get('when_to_call', '').strip()[:50] if tool.get('when_to_call') else None,
                        'parameters': len(tool.get('parameters', []))
                    }
                    break

        if 'display' in tools_config:
            for tool in tools_config['display']:
                if tool.get('name') == 'show_skill_intro':
                    has_intro_tool = True
                    intro_tool_details = {
                        'card_type': tool.get('card_type'),
                        'when_to_call': tool.get('when_to_call', '').strip()[:50] if tool.get('when_to_call') else None,
                        'parameters': len(tool.get('parameters', []))
                    }
                    break

        results[skill_id] = {
            "status": "ok" if has_intro_tool else "missing_tool",
            "details": intro_tool_details
        }

    except Exception as e:
        results[skill_id] = {"status": "error", "error": str(e)}

# 打印结果
print("\n" + "="*70)
print("IntroCard 工具定义测试结果")
print("="*70 + "\n")

success_count = 0
for skill_id, result in results.items():
    status_icon = "✅" if result["status"] == "ok" else "❌"
    print(f"{status_icon} {skill_id:15} - {result['status']}")

    if result["status"] == "ok":
        success_count += 1
        details = result["details"]
        print(f"   - card_type: {details['card_type']}")
        print(f"   - parameters: {details['parameters']}")
        if details['when_to_call']:
            print(f"   - when_to_call: {details['when_to_call']}...")
    elif result["status"] == "error":
        print(f"   - error: {result['error']}")
    print()

print("="*70)
print(f"总计: {success_count}/{len(skills)} skills 定义了 show_skill_intro 工具")
print(f"覆盖率: {success_count/len(skills)*100:.1f}%")
print("="*70 + "\n")
