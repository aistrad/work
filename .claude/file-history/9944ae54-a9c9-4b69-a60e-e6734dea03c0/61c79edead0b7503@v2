/**
 * PracticeGuideCard - æ­£å¿µç»ƒä¹ å¼•å¯¼å¡ç‰‡
 *
 * æä¾›åˆ†æ­¥å¼•å¯¼å’Œè®¡æ—¶å™¨ï¼Œå¸®åŠ©ç”¨æˆ·è¿›è¡Œæ­£å¿µç»ƒä¹ 
 * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "practice_guide" è§¦å‘
 */

"use client";

import { useState, useEffect, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface PracticeStep {
  step_number: number;
  title: string;
  instruction: string;
  duration_seconds?: number;
  breathing_pattern?: string; // e.g., "4-7-8" for å¸æ°”4ç§’-å±æ¯7ç§’-å‘¼æ°”8ç§’
}

interface PracticeGuideData {
  practice_type?: string; // breathing, body_scan, stop, rain, etc.
  practice_name?: string;
  description?: string;
  total_duration_minutes?: number;
  steps?: PracticeStep[];
  benefits?: string[];
  tips?: string[];
  current_step?: number; // å¦‚æœè®¾ç½®ï¼Œä»è¿™ä¸€æ­¥å¼€å§‹
}

interface PracticeGuideCardProps {
  data: PracticeGuideData;
  cardProps?: Record<string, unknown>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PRACTICE_ICONS: Record<string, string> = {
  breathing: "ğŸŒ¬ï¸",
  breathing_478: "ğŸ«",
  stop: "ğŸ›‘",
  body_scan: "ğŸ§˜",
  morning: "ğŸŒ…",
  focus: "ğŸ¯",
  sleep: "ğŸŒ™",
  rain: "ğŸŒ§ï¸",
  integration: "âœ¨",
};

const PRACTICE_COLORS: Record<string, string> = {
  breathing: "from-sky-50 to-blue-50 dark:from-sky-950/30 dark:to-blue-950/30 border-sky-200 dark:border-sky-800",
  body_scan: "from-green-50 to-emerald-50 dark:from-green-950/30 dark:to-emerald-950/30 border-green-200 dark:border-green-800",
  stop: "from-red-50 to-orange-50 dark:from-red-950/30 dark:to-orange-950/30 border-red-200 dark:border-red-800",
  rain: "from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30 border-indigo-200 dark:border-indigo-800",
  default: "from-teal-50 to-cyan-50 dark:from-teal-950/30 dark:to-cyan-950/30 border-teal-200 dark:border-teal-800",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function PracticeGuideCard({ data }: PracticeGuideCardProps) {
  const [currentStep, setCurrentStep] = useState(data.current_step || 0);
  const [isPlaying, setIsPlaying] = useState(false);
  const [timeLeft, setTimeLeft] = useState(0);
  const [showAllSteps, setShowAllSteps] = useState(false);
  const timerRef = useRef<NodeJS.Timeout | null>(null);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const steps = data.steps || [];
  const practiceType = data.practice_type || "default";
  const currentStepData = steps[currentStep];

  // Cleanup timer on unmount
  useEffect(() => {
    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, []);

  // Timer logic
  useEffect(() => {
    if (isPlaying && timeLeft > 0) {
      timerRef.current = setInterval(() => {
        setTimeLeft((prev) => {
          if (prev <= 1) {
            setIsPlaying(false);
            // Auto-advance to next step
            if (currentStep < steps.length - 1) {
              setTimeout(() => {
                setCurrentStep(currentStep + 1);
              }, 1000);
            }
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    } else {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    }

    return () => {
      if (timerRef.current) {
        clearInterval(timerRef.current);
      }
    };
  }, [isPlaying, timeLeft, currentStep, steps.length]);

  // V7: é”™è¯¯çŠ¶æ€æ£€æŸ¥
  if ((data as any)?.status === "error" || (data as any)?.need_info) {
    return null;
  }

  // æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥
  if (steps.length === 0) {
    return null;
  }

  const handleStartPractice = () => {
    if (currentStepData?.duration_seconds) {
      setTimeLeft(currentStepData.duration_seconds);
      setIsPlaying(true);
    }
  };

  const handlePause = () => {
    setIsPlaying(false);
  };

  const handleResume = () => {
    if (timeLeft > 0) {
      setIsPlaying(true);
    }
  };

  const handleNextStep = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1);
      setTimeLeft(0);
      setIsPlaying(false);
    }
  };

  const handlePreviousStep = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
      setTimeLeft(0);
      setIsPlaying(false);
    }
  };

  const formatTime = (seconds: number): string => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2, "0")}`;
  };

  const colorScheme = PRACTICE_COLORS[practiceType] || PRACTICE_COLORS.default;
  const icon = PRACTICE_ICONS[practiceType] || "ğŸ§˜";

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      className={`practice-guide-card bg-gradient-to-br ${colorScheme} rounded-xl border p-4 my-2 overflow-hidden`}
    >
      {/* Header */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.2 }}
        className="text-center mb-4"
      >
        <div className="text-4xl mb-2">{icon}</div>
        <h3 className="text-lg font-semibold text-accent-900 dark:text-accent-100 mb-1">
          {data.practice_name || "æ­£å¿µç»ƒä¹ "}
        </h3>
        {data.description && (
          <p className="text-sm text-accent-700 dark:text-accent-300">
            {data.description}
          </p>
        )}
        {data.total_duration_minutes && (
          <div className="mt-2 text-xs text-muted-foreground">
            æ—¶é•¿çº¦ {data.total_duration_minutes} åˆ†é’Ÿ
          </div>
        )}
      </motion.div>

      {/* Progress Indicator */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.3 }}
        className="mb-4"
      >
        <div className="flex items-center justify-between mb-2">
          <span className="text-xs text-muted-foreground">
            æ­¥éª¤ {currentStep + 1} / {steps.length}
          </span>
          <button
            onClick={() => setShowAllSteps(!showAllSteps)}
            className="text-xs text-blue-600 dark:text-blue-400 hover:underline"
          >
            {showAllSteps ? "æ”¶èµ·æ­¥éª¤" : "æŸ¥çœ‹æ‰€æœ‰æ­¥éª¤"}
          </button>
        </div>
        <div className="h-1.5 bg-white/50 dark:bg-black/20 rounded-full overflow-hidden">
          <motion.div
            initial={{ width: 0 }}
            animate={{ width: `${((currentStep + 1) / steps.length) * 100}%` }}
            transition={{ duration: 0.5 }}
            className="h-full bg-gradient-to-r from-blue-500 to-cyan-500"
          />
        </div>
      </motion.div>

      {/* All Steps (Expandable) */}
      <AnimatePresence>
        {showAllSteps && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: "auto", opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="mb-4 overflow-hidden"
          >
            <div className="bg-white/60 dark:bg-black/30 rounded-lg p-3 space-y-2">
              {steps.map((step, index) => (
                <div
                  key={index}
                  className={`text-xs p-2 rounded ${
                    index === currentStep
                      ? "bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 font-medium"
                      : "bg-gray-50 dark:bg-gray-900/30 text-muted-foreground"
                  }`}
                >
                  <span className="font-semibold">{index + 1}.</span> {step.title}
                </div>
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Current Step */}
      {currentStepData && (
        <motion.div
          key={currentStep}
          initial={{ opacity: 0, scale: 0.95 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ duration: 0.4 }}
          className="bg-white/80 dark:bg-black/40 rounded-lg p-4 mb-4"
        >
          <h4 className="text-base font-semibold text-accent-900 dark:text-accent-100 mb-2">
            {currentStepData.title}
          </h4>
          <p className="text-sm text-accent-700 dark:text-accent-300 leading-relaxed whitespace-pre-line">
            {currentStepData.instruction}
          </p>

          {/* Breathing Pattern */}
          {currentStepData.breathing_pattern && (
            <div className="mt-3 p-2 bg-blue-50/60 dark:bg-blue-950/30 rounded text-center">
              <div className="text-xs text-blue-700 dark:text-blue-300 mb-1">
                å‘¼å¸èŠ‚å¥
              </div>
              <div className="font-mono text-sm font-semibold text-blue-600 dark:text-blue-400">
                {currentStepData.breathing_pattern}
              </div>
            </div>
          )}

          {/* Timer */}
          {currentStepData.duration_seconds && (
            <div className="mt-4">
              <div className="text-center mb-3">
                <div className="text-4xl font-bold text-cyan-600 dark:text-cyan-400 tabular-nums">
                  {timeLeft > 0 ? formatTime(timeLeft) : formatTime(currentStepData.duration_seconds)}
                </div>
              </div>

              <div className="flex justify-center gap-2">
                {!isPlaying && timeLeft === 0 && (
                  <button
                    onClick={handleStartPractice}
                    className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                  >
                    <span>â–¶ï¸</span>
                    <span>å¼€å§‹</span>
                  </button>
                )}
                {isPlaying && (
                  <button
                    onClick={handlePause}
                    className="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                  >
                    <span>â¸ï¸</span>
                    <span>æš‚åœ</span>
                  </button>
                )}
                {!isPlaying && timeLeft > 0 && (
                  <button
                    onClick={handleResume}
                    className="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2"
                  >
                    <span>â–¶ï¸</span>
                    <span>ç»§ç»­</span>
                  </button>
                )}
              </div>
            </div>
          )}
        </motion.div>
      )}

      {/* Navigation Buttons */}
      <div className="flex justify-between items-center">
        <button
          onClick={handlePreviousStep}
          disabled={currentStep === 0}
          className="px-3 py-1.5 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded text-sm font-medium text-accent-900 dark:text-accent-100 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          â† ä¸Šä¸€æ­¥
        </button>

        <div className="text-xs text-muted-foreground">
          {currentStep + 1} / {steps.length}
        </div>

        <button
          onClick={handleNextStep}
          disabled={currentStep === steps.length - 1}
          className="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          ä¸‹ä¸€æ­¥ â†’
        </button>
      </div>

      {/* Benefits (Optional) */}
      {data.benefits && data.benefits.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.5 }}
          className="mt-4 bg-green-50/60 dark:bg-green-950/20 rounded-lg p-3"
        >
          <div className="text-xs font-medium text-green-700 dark:text-green-300 mb-2">
            âœ¨ ç»ƒä¹ ç›Šå¤„
          </div>
          <ul className="space-y-1">
            {data.benefits.map((benefit, idx) => (
              <li key={idx} className="text-xs text-accent-700 dark:text-accent-300 flex items-start gap-2">
                <span className="text-green-600 dark:text-green-400 mt-0.5">â€¢</span>
                <span>{benefit}</span>
              </li>
            ))}
          </ul>
        </motion.div>
      )}

      {/* Tips (Optional) */}
      {data.tips && data.tips.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.6 }}
          className="mt-3 bg-yellow-50/60 dark:bg-yellow-950/20 rounded-lg p-3"
        >
          <div className="text-xs font-medium text-yellow-700 dark:text-yellow-300 mb-2">
            ğŸ’¡ ç»ƒä¹ æç¤º
          </div>
          <ul className="space-y-1">
            {data.tips.map((tip, idx) => (
              <li key={idx} className="text-xs text-accent-700 dark:text-accent-300 flex items-start gap-2">
                <span className="text-yellow-600 dark:text-yellow-400 mt-0.5">â€¢</span>
                <span>{tip}</span>
              </li>
            ))}
          </ul>
        </motion.div>
      )}
    </motion.div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("practice_guide", PracticeGuideCard);

export default PracticeGuideCard;
