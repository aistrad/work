/**
 * Smart Quote System - Dashboard v2.0
 *
 * 名言库 + 智能选择算法
 * 设计原则：触动人心、简洁有力、与用户状态共鸣
 */

import type { Quote, QuoteContext } from "@/types/dashboard";

// ═══════════════════════════════════════════════════════════════════════════
// 1. 愿景与目标
// ═══════════════════════════════════════════════════════════════════════════
const VISION_QUOTES: Quote[] = [
  { text: "你的愿景正在等待你的行动。", author: null },
  { text: "种一棵树最好的时间是十年前，其次是现在。", author: "中国谚语" },
  { text: "不是因为看见了才相信，而是因为相信了才看见。", author: null },
  { text: "你不必看清整个楼梯，只需迈出第一步。", author: "马丁·路德·金" },
  { text: "今天做的每一件小事，都是明天大事的预演。", author: null },
  { text: "目标不是用来达成的，而是用来指引方向的。", author: "布鲁斯·李" },
  { text: "梦想不会逃跑，逃跑的永远是自己。", author: "村上春树" },
  { text: "最慢的步伐不是跬步，而是徘徊。", author: null },
];

// ═══════════════════════════════════════════════════════════════════════════
// 2. 坚持与毅力
// ═══════════════════════════════════════════════════════════════════════════
const PERSISTENCE_QUOTES: Quote[] = [
  { text: "滴水穿石，不是力量大，而是功夫深。", author: null },
  { text: "每一次你想放弃的时候，想想为什么开始。", author: null },
  { text: "成功的秘诀在于坚持。坚持的秘诀在于热爱。", author: null },
  { text: "复利效应：今天的1%进步，一年后是37倍。", author: null },
  { text: "不是强者才能坚持，而是坚持了才会变强。", author: null },
  { text: "你已经走了这么远，不要忘记为什么出发。", author: null },
  { text: "日拱一卒，功不唐捐。", author: "曾国藩" },
];

// ═══════════════════════════════════════════════════════════════════════════
// 3. 自我认知 (荣格相关)
// ═══════════════════════════════════════════════════════════════════════════
const SELF_AWARENESS_QUOTES: Quote[] = [
  { text: "认识你自己。", author: "苏格拉底" },
  { text: "你是谁，比你做什么更重要。", author: null },
  { text: "真正的自由是成为你自己。", author: null },
  { text: "接纳自己，是改变的起点。", author: null },
  { text: "每个人都是自己生命的作者。", author: null },
  { text: "最深的井，往往有最甜的水。", author: "尼采" },
  { text: "你内心的答案，比任何外在的声音都重要。", author: null },
  { text: "向内求，是所有外在成就的起点。", author: null },
  {
    text: "你的任务不是去寻找爱，而是去寻找并拆除你内心所有阻挡爱的障碍。",
    author: "荣格",
  },
  { text: "凡是你所抗拒的，都会持续。", author: "荣格" },
  { text: "往外看的人在做梦，往内看的人正清醒。", author: "荣格" },
];

// ═══════════════════════════════════════════════════════════════════════════
// 4. 行动与当下
// ═══════════════════════════════════════════════════════════════════════════
const ACTION_QUOTES: Quote[] = [
  { text: "千里之行，始于足下。", author: "老子" },
  { text: "想都是问题，做才是答案。", author: null },
  { text: "最好的准备就是立刻开始。", author: null },
  { text: "完成比完美更重要。", author: null },
  { text: "今天是余生中最年轻的一天。", author: null },
  {
    text: "你不需要很厉害才能开始，但需要开始才能很厉害。",
    author: null,
  },
  { text: "行动是治愈恐惧的良药。", author: null },
  { text: "先完成，再完美。", author: null },
];

// ═══════════════════════════════════════════════════════════════════════════
// 5. 成长与变化
// ═══════════════════════════════════════════════════════════════════════════
const GROWTH_QUOTES: Quote[] = [
  { text: "舒适区的边缘，是成长发生的地方。", author: null },
  { text: "蜕变总是伴随着不舒服。", author: null },
  { text: "你不是在变老，而是在变好。", author: null },
  { text: "今天的你比昨天的你更接近目标。", author: null },
  { text: "每一次跌倒，都是在学习如何站得更稳。", author: null },
  {
    text: "不是环境造就人，而是人选择如何回应环境。",
    author: "维克多·弗兰克尔",
  },
  { text: "成长是一个过程，不是一个事件。", author: null },
];

// ═══════════════════════════════════════════════════════════════════════════
// 6. 休息与平衡
// ═══════════════════════════════════════════════════════════════════════════
const REST_QUOTES: Quote[] = [
  { text: "休息不是放弃，而是为了走更远的路。", author: null },
  { text: "张弛有度，方能长久。", author: null },
  { text: "有时候，慢下来才能看清方向。", author: null },
  { text: "照顾好自己，才能照顾好世界。", author: null },
  { text: "留白是为了让重要的事物更突出。", author: null },
  { text: "能量管理比时间管理更重要。", author: null },
];

// ═══════════════════════════════════════════════════════════════════════════
// 7. 困境与突破
// ═══════════════════════════════════════════════════════════════════════════
const BREAKTHROUGH_QUOTES: Quote[] = [
  { text: "山重水复疑无路，柳暗花明又一村。", author: "陆游" },
  { text: "在你准备放弃的那一刻，往往离成功最近。", author: null },
  { text: "困难是化了妆的礼物。", author: null },
  { text: "没有到不了的明天。", author: null },
  { text: "冬天来了，春天还会远吗？", author: "雪莱" },
  { text: "你现在经历的，都会成为你未来的力量。", author: null },
];

// ═══════════════════════════════════════════════════════════════════════════
// 8. 周期性名言（特殊时间点）
// ═══════════════════════════════════════════════════════════════════════════
const PERIODIC_QUOTES: Record<string, Quote[]> = {
  monday: [
    { text: "新的一周，新的可能。", author: null },
    { text: "周一是重新开始的好时机。", author: null },
    { text: "这周，你想成为什么样的人？", author: null },
    { text: "每个周一都是52次重新开始的机会。", author: null },
  ],
  friday: [
    { text: "回顾这周，你离目标更近了一步。", author: null },
    { text: "这周的你，比上周的你更强了。", author: null },
  ],
  weekend: [
    { text: "周末是给灵魂充电的时间。", author: null },
    { text: "休息好，才能走得更远。", author: null },
    { text: "好好休息，也是一种自律。", author: null },
  ],
  month_start: [
    { text: "新的一月，新的篇章。", author: null },
    { text: "这个月，你想完成什么？", author: null },
  ],
  month_end: [
    { text: "月底了，回顾一下这个月的收获。", author: null },
    { text: "无论结果如何，感谢这个月努力的自己。", author: null },
  ],
};

// ═══════════════════════════════════════════════════════════════════════════
// 智能选择算法
// ═══════════════════════════════════════════════════════════════════════════

interface WeightedQuote extends Quote {
  weight: number;
}

function hashCode(str: string): number {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash);
}

/**
 * 智能选择名言
 * 基于用户上下文（时间、状态、订阅的 Skill）选择最合适的名言
 */
export function selectQuote(context: QuoteContext): Quote {
  const {
    hour,
    dayOfWeek,
    dayOfMonth,
    streak,
    checkedIn,
    weekProgress,
    subscribedSkills,
  } = context;

  const candidatePool: WeightedQuote[] = [];

  // 1. 周期性名言优先（特殊时间点）
  if (dayOfWeek === 1) {
    candidatePool.push(
      ...PERIODIC_QUOTES.monday.map((q) => ({ ...q, weight: 10 }))
    );
  } else if (dayOfWeek === 5) {
    candidatePool.push(
      ...PERIODIC_QUOTES.friday.map((q) => ({ ...q, weight: 10 }))
    );
  } else if (dayOfWeek === 0 || dayOfWeek === 6) {
    candidatePool.push(
      ...PERIODIC_QUOTES.weekend.map((q) => ({ ...q, weight: 10 }))
    );
  }

  if (dayOfMonth <= 3) {
    candidatePool.push(
      ...PERIODIC_QUOTES.month_start.map((q) => ({ ...q, weight: 12 }))
    );
  } else if (dayOfMonth >= 28) {
    candidatePool.push(
      ...PERIODIC_QUOTES.month_end.map((q) => ({ ...q, weight: 12 }))
    );
  }

  // 2. 基于用户订阅 Skill 选择
  if (subscribedSkills.includes("jungian")) {
    candidatePool.push(
      ...SELF_AWARENESS_QUOTES.map((q) => ({ ...q, weight: 8 }))
    );
  }

  // 3. 基于用户状态选择
  if (streak >= 7) {
    candidatePool.push(
      ...PERSISTENCE_QUOTES.map((q) => ({ ...q, weight: 8 }))
    );
  }

  if (!checkedIn && hour >= 6 && hour < 12) {
    candidatePool.push(...ACTION_QUOTES.map((q) => ({ ...q, weight: 8 })));
  }

  if (weekProgress >= 0.7) {
    candidatePool.push(...GROWTH_QUOTES.map((q) => ({ ...q, weight: 6 })));
  }

  if (weekProgress < 0.3 && dayOfWeek >= 4) {
    candidatePool.push(
      ...BREAKTHROUGH_QUOTES.map((q) => ({ ...q, weight: 8 }))
    );
  }

  if (hour >= 20 || dayOfWeek === 0 || dayOfWeek === 6) {
    candidatePool.push(...REST_QUOTES.map((q) => ({ ...q, weight: 5 })));
  }

  // 4. 默认池补充
  candidatePool.push(...VISION_QUOTES.map((q) => ({ ...q, weight: 3 })));
  candidatePool.push(
    ...SELF_AWARENESS_QUOTES.map((q) => ({ ...q, weight: 3 }))
  );

  // 5. 加权随机选择（使用日期作为种子，同一天返回相同名言）
  const seed = new Date().toDateString();
  const totalWeight = candidatePool.reduce((sum, q) => sum + q.weight, 0);
  const targetWeight = hashCode(seed) % totalWeight;

  let cumulative = 0;
  for (const quote of candidatePool) {
    cumulative += quote.weight;
    if (cumulative >= targetWeight) {
      return { text: quote.text, author: quote.author };
    }
  }

  return VISION_QUOTES[0];
}

/**
 * 获取默认上下文的名言
 */
export function getDefaultQuote(): Quote {
  const now = new Date();
  return selectQuote({
    hour: now.getHours(),
    dayOfWeek: now.getDay(),
    dayOfMonth: now.getDate(),
    month: now.getMonth(),
    streak: 0,
    checkedIn: false,
    weekProgress: 0,
    subscribedSkills: [],
  });
}
