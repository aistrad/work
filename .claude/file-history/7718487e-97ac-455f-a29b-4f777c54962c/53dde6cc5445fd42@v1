"use client";

import { motion } from "framer-motion";
import { useRouter } from "next/navigation";
import { cn } from "@/lib/utils";
import type { SkillCardContent } from "@/types/dashboard";

interface SkillCardProps {
  skillId: string;
  icon: string;
  title: string;
  content: SkillCardContent;
  actionLabel: string;
  actionRoute: string;
  onClick?: () => void;
  className?: string;
}

/**
 * SkillCard - 已订阅 Skill 的动态内容卡片
 *
 * 支持两种内容类型:
 * 1. 通用型: headline + insights
 * 2. 评分型: rating + suggestions (八字/星座)
 */
export function SkillCard({
  skillId,
  icon,
  title,
  content,
  actionLabel,
  actionRoute,
  onClick,
  className,
}: SkillCardProps) {
  const router = useRouter();

  const handleClick = () => {
    if (onClick) {
      onClick();
    } else {
      router.push(actionRoute);
    }
  };

  const isRatingType = !!content.rating;

  return (
    <motion.div
      whileHover={{ y: -2, boxShadow: "0 8px 30px rgba(0,0,0,0.12)" }}
      className={cn(
        "w-[280px] min-h-[200px] md:w-[280px]",
        "rounded-xl bg-white p-4",
        "border border-gray-100 shadow-sm",
        "cursor-pointer transition-shadow",
        className
      )}
      onClick={handleClick}
    >
      {/* Header */}
      <div className="flex items-center gap-2 mb-3">
        <span className="text-2xl">{icon}</span>
        <h3 className="font-semibold text-gray-900">{title}</h3>
      </div>

      <div className="border-t border-gray-100 pt-3 mb-3">
        {isRatingType ? (
          <RatingContent content={content} />
        ) : (
          <InsightContent content={content} />
        )}
      </div>

      {/* Action Button */}
      <button
        className={cn(
          "w-full py-2 px-3 rounded-lg text-sm font-medium",
          "bg-gray-50 text-gray-700",
          "hover:bg-gray-100 transition-colors",
          "flex items-center justify-center gap-1"
        )}
      >
        {actionLabel}
        <span className="text-gray-400">→</span>
      </button>
    </motion.div>
  );
}

function InsightContent({ content }: { content: SkillCardContent }) {
  const { headline, insights } = content;

  return (
    <div className="space-y-2">
      {/* Headline */}
      <p className="font-medium text-gray-900">{headline}</p>

      {/* Insights */}
      {insights.map((insight, index) => (
        <p key={index} className="text-sm text-gray-600">
          {insight}
        </p>
      ))}
    </div>
  );
}

function RatingContent({ content }: { content: SkillCardContent }) {
  const { rating, suggestions } = content;

  if (!rating) return null;

  // Render stars based on rating (1-5)
  const renderStars = (value: number) => {
    const filled = Math.round(value);
    return (
      <span className="text-amber-500">
        {"★".repeat(filled)}
        {"☆".repeat(5 - filled)}
      </span>
    );
  };

  return (
    <div className="space-y-2">
      {/* Overall Rating */}
      <div className="flex items-center gap-2">
        <span className="text-sm text-gray-600">整体:</span>
        {renderStars(rating.overall)}
        <span className="text-sm font-medium text-gray-700">{rating.label}</span>
      </div>

      {/* Detail Ratings */}
      {rating.details && (
        <div className="space-y-1 border-t border-gray-100 pt-2">
          {Object.entries(rating.details).map(([key, value]) => (
            <div key={key} className="flex items-center gap-2 text-sm">
              <span className="text-gray-500 w-12">{key}:</span>
              {renderStars(value)}
            </div>
          ))}
        </div>
      )}

      {/* Suggestions */}
      {suggestions && (
        <div className="border-t border-gray-100 pt-2 space-y-1">
          {suggestions.do.length > 0 && (
            <p className="text-sm text-green-600">
              宜: {suggestions.do.join("、")}
            </p>
          )}
          {suggestions.avoid.length > 0 && (
            <p className="text-sm text-red-500">
              忌: {suggestions.avoid.join("、")}
            </p>
          )}
        </div>
      )}
    </div>
  );
}

export default SkillCard;
