"use client";

import { useCallback } from "react";
import { motion } from "framer-motion";
import { cn } from "@/lib/utils";
import type { LifecoachData, LeverItem, RockItem } from "@/types/dashboard";

interface LifecoachCardProps {
  data: LifecoachData;
  onToggleLever: (leverId: string) => Promise<void>;
  onToggleRock: (rockId: string) => Promise<void>;
  onClickNorthStar?: () => void;
  className?: string;
}

/**
 * LifecoachCard - Dashboard Layer 1
 *
 * åˆå¹¶çš„ Lifecoach å¡ç‰‡ï¼ŒåŒ…å«ï¼š
 * - åŒ—ææ˜Ÿæ„¿æ™¯
 * - æœˆåº¦é¡¹ç›®è¿›åº¦
 * - ä»Šæ—¥æ æ†
 * - æœ¬å‘¨å¤§çŸ³å¤´
 */
export function LifecoachCard({
  data,
  onToggleLever,
  onToggleRock,
  onClickNorthStar,
  className,
}: LifecoachCardProps) {
  const { northStar, monthlyProject, todayLevers, weekRocks } = data;

  const completedLevers = todayLevers.filter((l) => l.completed).length;
  const completedRocks = weekRocks.filter((r) => r.completed).length;

  return (
    <div
      className={cn(
        "rounded-2xl bg-white/90 backdrop-blur-sm p-6",
        "border border-gray-100 shadow-sm",
        className
      )}
    >
      {/* Header */}
      <div className="flex items-center gap-2 mb-4">
        <span className="text-xl">ğŸ§­</span>
        <h2 className="text-lg font-semibold text-gray-900">LIFECOACH</h2>
      </div>

      {/* North Star */}
      {northStar && (
        <NorthStarSection
          vision={northStar}
          onClick={onClickNorthStar}
        />
      )}

      {/* Main Grid: Monthly Project + Today Levers */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        {/* Monthly Project */}
        {monthlyProject && (
          <MonthlyProgressSection project={monthlyProject} />
        )}

        {/* Today Levers */}
        <TodayLeversSection
          levers={todayLevers}
          completed={completedLevers}
          total={todayLevers.length}
          onToggle={onToggleLever}
        />
      </div>

      {/* Week Rocks */}
      <WeekRocksSection
        rocks={weekRocks}
        completed={completedRocks}
        total={weekRocks.length}
        onToggle={onToggleRock}
      />
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub-components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface NorthStarSectionProps {
  vision: string;
  onClick?: () => void;
}

function NorthStarSection({ vision, onClick }: NorthStarSectionProps) {
  return (
    <button
      onClick={onClick}
      className={cn(
        "w-full text-left mb-4 p-3 rounded-lg",
        "bg-gradient-to-r from-amber-50 to-orange-50",
        "border border-amber-100",
        "hover:border-amber-200 transition-colors",
        "focus:outline-none focus:ring-2 focus:ring-amber-200"
      )}
    >
      <div className="flex items-start gap-2">
        <span className="text-lg">â­</span>
        <div>
          <span className="text-sm text-amber-600 font-medium">åŒ—ææ˜Ÿ</span>
          <p className="text-gray-700 mt-0.5">&ldquo;{vision}&rdquo;</p>
        </div>
      </div>
    </button>
  );
}

interface MonthlyProgressSectionProps {
  project: NonNullable<LifecoachData["monthlyProject"]>;
}

function MonthlyProgressSection({ project }: MonthlyProgressSectionProps) {
  const { name, progress, daysRemaining } = project;

  return (
    <div className="p-4 rounded-lg bg-gray-50 border border-gray-100">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-lg">ğŸ“Š</span>
        <h3 className="text-sm font-medium text-gray-600">æœˆåº¦é¡¹ç›®</h3>
      </div>
      <p className="font-medium text-gray-900 mb-3">{name}</p>

      {/* Progress Bar */}
      <div className="mb-2">
        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
          <motion.div
            initial={{ scaleX: 0 }}
            animate={{ scaleX: 1 }}
            transition={{ duration: 0.8, ease: [0.4, 0, 0.2, 1] }}
            style={{ width: `${progress}%`, transformOrigin: "left" }}
            className={cn(
              "h-full rounded-full",
              progress >= 70
                ? "bg-green-500"
                : progress >= 40
                ? "bg-amber-500"
                : "bg-blue-500"
            )}
          />
        </div>
        <div className="flex justify-between mt-1 text-xs text-gray-500">
          <span>{progress}%</span>
          <span>è¿˜å‰© {daysRemaining} å¤©</span>
        </div>
      </div>
    </div>
  );
}

interface TodayLeversSectionProps {
  levers: LeverItem[];
  completed: number;
  total: number;
  onToggle: (leverId: string) => Promise<void>;
}

function TodayLeversSection({
  levers,
  completed,
  total,
  onToggle,
}: TodayLeversSectionProps) {
  const allCompleted = completed === total && total > 0;

  return (
    <div className="p-4 rounded-lg bg-gray-50 border border-gray-100">
      <div className="flex items-center gap-2 mb-2">
        <span className="text-lg">â˜€ï¸</span>
        <h3 className="text-sm font-medium text-gray-600">ä»Šæ—¥æ æ†</h3>
        {allCompleted && <span className="text-lg">ğŸ‰</span>}
      </div>

      <ul className="space-y-2 mb-3">
        {levers.map((lever) => (
          <LeverItem
            key={lever.id}
            lever={lever}
            onToggle={() => onToggle(lever.id)}
          />
        ))}
      </ul>

      <div className="pt-2 border-t border-gray-200">
        <span className="text-sm text-gray-500">
          è¿›åº¦: {completed}/{total}
        </span>
      </div>
    </div>
  );
}

interface LeverItemProps {
  lever: LeverItem;
  onToggle: () => void;
}

function LeverItem({ lever, onToggle }: LeverItemProps) {
  return (
    <motion.li
      whileTap={{ scale: 0.98 }}
      className="flex items-center gap-2"
    >
      <button
        onClick={onToggle}
        className={cn(
          "flex items-center gap-2 w-full text-left p-1.5 rounded",
          "hover:bg-gray-100 transition-colors",
          "focus:outline-none focus:ring-2 focus:ring-amber-200"
        )}
      >
        <span
          className={cn(
            "w-5 h-5 flex items-center justify-center rounded border",
            lever.completed
              ? "bg-green-500 border-green-500 text-white"
              : "border-gray-300"
          )}
        >
          {lever.completed && "âœ“"}
        </span>
        <span
          className={cn(
            "text-sm",
            lever.completed ? "text-gray-400 line-through" : "text-gray-700"
          )}
        >
          {lever.text}
        </span>
      </button>
    </motion.li>
  );
}

interface WeekRocksSectionProps {
  rocks: RockItem[];
  completed: number;
  total: number;
  onToggle: (rockId: string) => Promise<void>;
}

function WeekRocksSection({
  rocks,
  completed,
  total,
  onToggle,
}: WeekRocksSectionProps) {
  return (
    <div className="pt-4 border-t border-gray-100">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-lg">ğŸ“…</span>
          <h3 className="text-sm font-medium text-gray-600">æœ¬å‘¨å¤§çŸ³å¤´</h3>
        </div>
        <span className="text-sm text-gray-500">
          ({completed}/{total})
        </span>
      </div>

      <div className="flex flex-wrap gap-2">
        {rocks.map((rock) => (
          <RockChip
            key={rock.id}
            rock={rock}
            onToggle={() => onToggle(rock.id)}
          />
        ))}
      </div>
    </div>
  );
}

interface RockChipProps {
  rock: RockItem;
  onToggle: () => void;
}

function RockChip({ rock, onToggle }: RockChipProps) {
  return (
    <motion.button
      onClick={onToggle}
      whileHover={{ scale: 1.02 }}
      whileTap={{ scale: 0.98 }}
      className={cn(
        "px-3 py-2 rounded-lg text-sm",
        "border transition-colors",
        "focus:outline-none focus:ring-2 focus:ring-amber-200",
        rock.completed
          ? "bg-green-50 border-green-200 text-green-700"
          : "bg-white border-gray-200 text-gray-700 hover:border-gray-300"
      )}
    >
      <span className="mr-1.5">
        {rock.completed ? "âœ“" : "â—‹"}
      </span>
      {rock.text}
      <span className="ml-1.5 text-xs text-gray-400">({rock.role})</span>
    </motion.button>
  );
}

export default LifecoachCard;
