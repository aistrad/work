# VibeLife 数据架构图

## 1. 数据库 ER 图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              DATABASE SCHEMA                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

┌──────────────────────┐       ┌───────────────────────────┐
│     vibe_users       │       │    unified_profiles       │
├──────────────────────┤       ├───────────────────────────┤
│ id            UUID PK│◄──────│ user_id      UUID FK,UK   │
│ email         VARCHAR│       │ profile      JSONB        │
│ phone         VARCHAR│       │ ├─ birth_info             │
│ nickname      VARCHAR│       │ │  ├─ date                │
│ avatar_url    VARCHAR│       │ │  ├─ time                │
│ subscription  VARCHAR│       │ │  └─ place               │
│ created_at    TIMESTAMP      │ ├─ bazi_data              │
│ updated_at    TIMESTAMP      │ ├─ zodiac_data            │
└──────────────────────┘       │ ├─ life_context           │
         │                     │ ├─ preferences            │
         │                     │ │  ├─ timezone            │
         │                     │ │  ├─ voice_mode          │
         │                     │ │  └─ enable_fortune_*    │
         │                     │ └─ goal_tracking          │
         │                     │    ├─ last_checkin        │
         │                     │    ├─ streak_days         │
         │                     │    └─ reminder_time       │
         │                     │ created_at    TIMESTAMP   │
         │                     │ updated_at    TIMESTAMP   │
         │                     └───────────────────────────┘
         │
         │  1:N
         ▼
┌──────────────────────────────┐       ┌───────────────────────────┐
│      user_data_store         │       │      user_reminders       │
├──────────────────────────────┤       ├───────────────────────────┤
│ id            UUID PK        │       │ id              UUID PK   │
│ user_id       UUID FK        │◄──────│ user_id         UUID FK   │
│ data_type     VARCHAR        │       │ reminder_type   VARCHAR   │
│ ├─ goals                     │       │ ├─ goal_checkin           │
│ ├─ tasks                     │       │ ├─ daily_plan             │
│ ├─ checkins                  │       │ ├─ milestone              │
│ ├─ plans                     │       │ └─ custom                 │
│ └─ reflections               │       │ title           VARCHAR   │
│ data_path     VARCHAR UK     │       │ description     TEXT      │
│ content       JSONB          │       │ schedule        VARCHAR   │
│ version       INTEGER        │       │ schedule_type   VARCHAR   │
│ created_at    TIMESTAMP      │       │ ├─ once                   │
│ updated_at    TIMESTAMP      │       │ ├─ daily                  │
└──────────────────────────────┘       │ ├─ weekly                 │
                                       │ └─ cron                   │
                                       │ next_trigger_at TIMESTAMP │
                                       │ last_triggered  TIMESTAMP │
                                       │ status          VARCHAR   │
                                       │ metadata        JSONB     │
                                       │ created_at      TIMESTAMP │
                                       └───────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│ 关系说明:                                                                        │
│ • vibe_users 1:1 unified_profiles (用户基础信息 vs 扩展 Profile)                 │
│ • vibe_users 1:N user_data_store (一个用户可有多条数据记录)                       │
│ • vibe_users 1:N user_reminders (一个用户可有多个提醒)                            │
│ • user_data_store.data_path 作为虚拟文件路径，支持层级结构                        │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据分层架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            DATA LAYER ARCHITECTURE                               │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              用户数据分层                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐                │
│  │   身份层        │   │   画像层         │   │   行为层         │                │
│  │  (Identity)     │   │  (Profile)      │   │  (Activity)     │                │
│  ├─────────────────┤   ├─────────────────┤   ├─────────────────┤                │
│  │ • 账号信息      │   │ • 出生信息      │   │ • 目标数据      │                │
│  │ • 认证信息      │   │ • 命理数据      │   │ • 计划数据      │                │
│  │ • 订阅状态      │   │ • 偏好设置      │   │ • 打卡记录      │                │
│  │                 │   │ • 生活上下文    │   │ • 对话历史      │                │
│  └────────┬────────┘   └────────┬────────┘   └────────┬────────┘                │
│           │                     │                     │                          │
│           ▼                     ▼                     ▼                          │
│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐                │
│  │   vibe_users    │   │unified_profiles │   │ user_data_store │                │
│  └─────────────────┘   └─────────────────┘   └─────────────────┘                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                           user_data_store 虚拟文件系统                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   /users/{user_id}/                                                              │
│   │                                                                              │
│   ├── goals/                          # 目标数据                                 │
│   │   ├── 2026/                                                                  │
│   │   │   ├── year                    # data_path: "goals/2026/year"             │
│   │   │   ├── q1                      # data_path: "goals/2026/q1"               │
│   │   │   ├── q2                                                                 │
│   │   │   └── months/                                                            │
│   │   │       ├── 01                  # data_path: "goals/2026/months/01"        │
│   │   │       └── 02                                                             │
│   │   └── 2025/                                                                  │
│   │                                                                              │
│   ├── plans/                          # 计划数据                                 │
│   │   └── daily/                                                                 │
│   │       ├── 2026-01-18              # data_path: "plans/daily/2026-01-18"      │
│   │       └── 2026-01-19                                                         │
│   │                                                                              │
│   ├── checkins/                       # 打卡数据                                 │
│   │   ├── 2026-01-18                  # data_path: "checkins/2026-01-18"         │
│   │   └── 2026-01-19                                                             │
│   │                                                                              │
│   └── reflections/                    # 复盘数据                                 │
│       ├── week_01                     # data_path: "reflections/week_01"         │
│       └── week_02                                                                │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Profile 数据结构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         unified_profiles.profile JSONB 结构                       │
└─────────────────────────────────────────────────────────────────────────────────┘

{
  "birth_info": {                      // 出生信息（命理计算基础）
    "date": "1990-05-15",
    "time": "10:30",
    "place": "北京",
    "timezone": "Asia/Shanghai",
    "solar_date": "1990-05-15",
    "lunar_date": "庚午年四月廿一"
  },

  "bazi_data": {                       // 八字命理数据（计算缓存）
    "pillars": {
      "year": {"stem": "庚", "branch": "午"},
      "month": {"stem": "辛", "branch": "巳"},
      "day": {"stem": "甲", "branch": "子"},
      "hour": {"stem": "己", "branch": "巳"}
    },
    "day_master": "甲木",
    "day_master_strength": "身弱",
    "useful_god": "水",
    "dayun": [...],                    // 大运列表
    "calculated_at": "2026-01-18T..."
  },

  "zodiac_data": {                     // 星座数据（计算缓存）
    "sun_sign": "金牛座",
    "moon_sign": "双子座",
    "rising_sign": "狮子座",
    "chart": {...},                    // 完整星盘
    "calculated_at": "2026-01-18T..."
  },

  "life_context": {                    // 生活上下文（对话提取）
    "current_focus": "职业发展",
    "relationships": {
      "status": "已婚",
      "partner_birth": "1992-03-20"
    },
    "career": {
      "industry": "互联网",
      "role": "产品经理",
      "concerns": ["晋升", "转型"]
    },
    "health": {...},
    "updated_at": "2026-01-18T..."
  },

  "preferences": {                     // 用户偏好
    "timezone": "Asia/Shanghai",
    "voice_mode": "温暖",              // 语气模式
    "enable_fortune_insights": true,   // 命理整合开关
    "notification_time": "08:00",
    "language": "zh-CN"
  },

  "goal_tracking": {                   // 目标追踪状态
    "enabled": true,
    "last_checkin": "2026-01-17",
    "streak_days": 5,
    "reminder_time": "08:00",
    "total_goals": 3,
    "completed_goals": 1
  }
}
```

---

## 4. 数据处理流程图

### 4.1 目标设定流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            目标设定流程 (Goal Setting Flow)                       │
└─────────────────────────────────────────────────────────────────────────────────┘

  用户                    前端                      后端 API                   数据库
   │                       │                          │                         │
   │  "设定2026年目标"     │                          │                         │
   │──────────────────────►│                          │                         │
   │                       │                          │                         │
   │                       │   POST /chat             │                         │
   │                       │──────────────────────────►│                         │
   │                       │                          │                         │
   │                       │                          │  触发 goal_tracking     │
   │                       │                          │  scenario               │
   │                       │                          │─────────┐               │
   │                       │                          │         │               │
   │                       │                          │◄────────┘               │
   │                       │                          │                         │
   │                       │   SSE: 收集目标信息      │                         │
   │◄──────────────────────│◄─────────────────────────│                         │
   │                       │                          │                         │
   │  输入目标详情         │                          │                         │
   │──────────────────────►│──────────────────────────►│                         │
   │                       │                          │                         │
   │                       │                          │  LLM 分解目标           │
   │                       │                          │  调用 write_user_data   │
   │                       │                          │─────────────────────────►│
   │                       │                          │                         │
   │                       │                          │  INSERT INTO            │
   │                       │                          │  user_data_store        │
   │                       │                          │  (goals/2026/year)      │
   │                       │                          │◄─────────────────────────│
   │                       │                          │                         │
   │                       │                          │  调用 schedule_reminder │
   │                       │                          │─────────────────────────►│
   │                       │                          │                         │
   │                       │                          │  INSERT INTO            │
   │                       │                          │  user_reminders         │
   │                       │                          │◄─────────────────────────│
   │                       │                          │                         │
   │                       │   SSE: show_goal_tree    │                         │
   │◄──────────────────────│◄─────────────────────────│                         │
   │                       │                          │                         │
   │  查看目标树卡片       │                          │                         │
   │◄──────────────────────│                          │                         │
   │                       │                          │                         │
```

### 4.2 每日打卡流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            每日打卡流程 (Daily Checkin Flow)                      │
└─────────────────────────────────────────────────────────────────────────────────┘

  推送系统              用户                前端                后端 API          数据库
     │                   │                   │                    │                 │
     │  21:00 触发       │                   │                    │                 │
     │──────────────────►│                   │                    │                 │
     │  "该打卡了"       │                   │                    │                 │
     │                   │                   │                    │                 │
     │                   │  点击通知         │                    │                 │
     │                   │─────────────────►│                    │                 │
     │                   │                   │                    │                 │
     │                   │                   │  POST /chat        │                 │
     │                   │                   │  "打卡"            │                 │
     │                   │                   │───────────────────►│                 │
     │                   │                   │                    │                 │
     │                   │                   │                    │ read_user_data  │
     │                   │                   │                    │ (plans/daily/*) │
     │                   │                   │                    │────────────────►│
     │                   │                   │                    │◄────────────────│
     │                   │                   │                    │                 │
     │                   │                   │  SSE: checkin_form │                 │
     │                   │◄──────────────────│◄───────────────────│                 │
     │                   │                   │                    │                 │
     │                   │  勾选完成项       │                    │                 │
     │                   │  填写反思         │                    │                 │
     │                   │─────────────────►│                    │                 │
     │                   │                   │                    │                 │
     │                   │                   │  提交打卡          │                 │
     │                   │                   │───────────────────►│                 │
     │                   │                   │                    │                 │
     │                   │                   │                    │ write_user_data │
     │                   │                   │                    │ (checkins/*)    │
     │                   │                   │                    │────────────────►│
     │                   │                   │                    │◄────────────────│
     │                   │                   │                    │                 │
     │                   │                   │                    │ 更新 profile    │
     │                   │                   │                    │ streak_days++   │
     │                   │                   │                    │────────────────►│
     │                   │                   │                    │◄────────────────│
     │                   │                   │                    │                 │
     │                   │                   │  SSE: 打卡成功     │                 │
     │                   │◄──────────────────│◄───────────────────│                 │
     │                   │  "连续5天打卡!"   │                    │                 │
     │                   │                   │                    │                 │
```

### 4.3 数据读写流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        数据读写流程 (Data CRUD Flow)                              │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────────┐
                              │      Tool Call      │
                              │  (from LLM Agent)   │
                              └──────────┬──────────┘
                                         │
                    ┌────────────────────┼────────────────────┐
                    │                    │                    │
                    ▼                    ▼                    ▼
        ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
        │  read_user_data   │ │  write_user_data  │ │  query_user_data  │
        │    (handlers.py)  │ │    (handlers.py)  │ │    (handlers.py)  │
        └─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘
                  │                     │                     │
                  ▼                     ▼                     ▼
        ┌─────────────────────────────────────────────────────────────┐
        │                    UserDataService                           │
        │                    (user_data.py)                            │
        ├─────────────────────────────────────────────────────────────┤
        │  • read(user_id, path) → UserData                           │
        │  • write(user_id, path, content) → UserData                 │
        │  • query(user_id, filters) → List[UserData]                 │
        │  • delete(user_id, path) → bool                             │
        │  • list_paths(user_id, prefix) → List[str]                  │
        └─────────────────────────────────────────────────────────────┘
                                         │
                                         ▼
        ┌─────────────────────────────────────────────────────────────┐
        │                    PostgreSQL                                │
        ├─────────────────────────────────────────────────────────────┤
        │                                                              │
        │   ┌─────────────────────────────────────────────────────┐   │
        │   │              user_data_store                         │   │
        │   ├─────────────────────────────────────────────────────┤   │
        │   │ id | user_id | data_type | data_path | content | v  │   │
        │   │────┼─────────┼───────────┼───────────┼─────────┼────│   │
        │   │ .. │ abc-123 │ goals     │ goals/... │ {...}   │ 1  │   │
        │   │ .. │ abc-123 │ plans     │ plans/... │ {...}   │ 2  │   │
        │   │ .. │ abc-123 │ checkins  │ check/... │ {...}   │ 1  │   │
        │   └─────────────────────────────────────────────────────┘   │
        │                                                              │
        │   索引: (user_id, data_path) UNIQUE                          │
        │   索引: (user_id, data_type)                                 │
        │   索引: content GIN (JSONB 查询)                             │
        │                                                              │
        └─────────────────────────────────────────────────────────────┘
```

---

## 5. 提醒系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         提醒系统架构 (Reminder System)                           │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                                                                                  │
│   ┌─────────────┐     ┌─────────────────┐     ┌─────────────────────────────┐   │
│   │   Cron Job  │────►│ ProactiveEngine │────►│     TriggerDetector         │   │
│   │ (每小时跑)  │     │   (engine.py)   │     │   (trigger_detector.py)     │   │
│   └─────────────┘     └────────┬────────┘     └──────────────┬──────────────┘   │
│                                │                              │                  │
│                                │                              │ 检查触发条件     │
│                                │                              ▼                  │
│                                │              ┌─────────────────────────────┐   │
│                                │              │ 系统提醒 (reminders.yaml)   │   │
│                                │              │ • daily_plan (08:00)        │   │
│                                │              │ • daily_checkin (21:00)     │   │
│                                │              │ • weekly_review (周日)      │   │
│                                │              │ • milestone_reminder        │   │
│                                │              │ • streak_celebration        │   │
│                                │              └─────────────────────────────┘   │
│                                │                              │                  │
│                                │                              │                  │
│                                ▼                              ▼                  │
│                    ┌─────────────────────┐    ┌─────────────────────────────┐   │
│                    │  ContentGenerator   │    │ 用户提醒 (user_reminders)   │   │
│                    │(content_generator.py│    │ • 用户自定义提醒            │   │
│                    └──────────┬──────────┘    │ • 通过 schedule_reminder    │   │
│                               │               │   工具创建                   │   │
│                               │               └──────────────┬──────────────┘   │
│                               │                              │                  │
│                               ▼                              ▼                  │
│                    ┌─────────────────────────────────────────────────────────┐  │
│                    │              NotificationService                         │  │
│                    │            (notification.py)                             │  │
│                    ├─────────────────────────────────────────────────────────┤  │
│                    │  • 保存到 notifications 表                               │  │
│                    │  • 推送到 APNs / FCM (移动端)                            │  │
│                    │  • WebSocket 实时推送 (Web端)                            │  │
│                    └─────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│  用户提醒调度流程                                                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   用户说: "每天早上8点提醒我看目标"                                              │
│                    │                                                             │
│                    ▼                                                             │
│   ┌────────────────────────────────────────┐                                    │
│   │  LLM 调用 schedule_reminder            │                                    │
│   │  title: "查看今日目标"                  │                                    │
│   │  schedule: "08:00"                      │                                    │
│   │  schedule_type: "daily"                 │                                    │
│   └────────────────────────────────────────┘                                    │
│                    │                                                             │
│                    ▼                                                             │
│   ┌────────────────────────────────────────┐                                    │
│   │  ReminderService.create()              │                                    │
│   │  • 计算 next_trigger_at (UTC)          │                                    │
│   │  • 写入 user_reminders 表              │                                    │
│   └────────────────────────────────────────┘                                    │
│                    │                                                             │
│                    ▼                                                             │
│   ┌────────────────────────────────────────┐                                    │
│   │  ProactiveWorker 扫描                   │                                    │
│   │  • WHERE next_trigger_at <= NOW()      │                                    │
│   │  • 触发提醒                             │                                    │
│   │  • 更新 next_trigger_at                │                                    │
│   └────────────────────────────────────────┘                                    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 整体数据流向

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          整体数据流向 (Overall Data Flow)                        │
└─────────────────────────────────────────────────────────────────────────────────┘

                                    ┌───────────────┐
                                    │     用户      │
                                    └───────┬───────┘
                                            │
                    ┌───────────────────────┼───────────────────────┐
                    │                       │                       │
                    ▼                       ▼                       ▼
            ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
            │    对话输入    │       │   表单提交    │       │   推送响应    │
            └───────┬───────┘       └───────┬───────┘       └───────┬───────┘
                    │                       │                       │
                    └───────────────────────┼───────────────────────┘
                                            │
                                            ▼
                              ┌─────────────────────────┐
                              │        API Gateway      │
                              │   /api/v1/chat          │
                              │   /api/v1/tools/*       │
                              └───────────┬─────────────┘
                                          │
                                          ▼
                              ┌─────────────────────────┐
                              │     Agent Core          │
                              │  (Skill Router + LLM)   │
                              └───────────┬─────────────┘
                                          │
                    ┌─────────────────────┼─────────────────────┐
                    │                     │                     │
                    ▼                     ▼                     ▼
          ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
          │   Core Skill    │   │   Bazi Skill    │   │  Zodiac Skill   │
          │   Tools         │   │   Tools         │   │   Tools         │
          └────────┬────────┘   └────────┬────────┘   └────────┬────────┘
                   │                     │                     │
                   ▼                     ▼                     ▼
          ┌─────────────────────────────────────────────────────────────┐
          │                      Tool Handlers                           │
          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
          │  │ user_data   │ │  reminder   │ │  display    │            │
          │  │ handlers    │ │  handlers   │ │  handlers   │            │
          │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘            │
          └─────────┼───────────────┼───────────────┼───────────────────┘
                    │               │               │
                    ▼               ▼               ▼
          ┌─────────────────────────────────────────────────────────────┐
          │                      Services Layer                          │
          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
          │  │UserDataSvc  │ │ReminderSvc  │ │ ProfileSvc  │            │
          │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘            │
          └─────────┼───────────────┼───────────────┼───────────────────┘
                    │               │               │
                    └───────────────┼───────────────┘
                                    │
                                    ▼
          ┌─────────────────────────────────────────────────────────────┐
          │                      PostgreSQL                              │
          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
          │  │ vibe_users  │ │ unified_    │ │ user_data_  │            │
          │  │             │ │ profiles    │ │ store       │            │
          │  └─────────────┘ └─────────────┘ └─────────────┘            │
          │                                                              │
          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
          │  │ user_       │ │ knowledge_  │ │ cases       │            │
          │  │ reminders   │ │ chunks      │ │             │            │
          │  └─────────────┘ └─────────────┘ └─────────────┘            │
          └─────────────────────────────────────────────────────────────┘
```

---

## 7. 关键设计决策

| 决策 | 选择 | 原因 |
|------|------|------|
| Profile 存储 | JSONB 单字段 | 灵活扩展，无需频繁 DDL |
| 用户数据存储 | 虚拟文件路径 | 支持层级结构，易于理解和查询 |
| 提醒调度 | cron + 事件驱动 | 兼顾定时和即时触发 |
| 版本控制 | 乐观锁 (version 字段) | 防止并发写入冲突 |
| 数据隔离 | user_id 外键 + 索引 | 确保用户只能访问自己的数据 |
