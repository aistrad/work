# VibeLife 认证系统文档

## 📚 文档导航

### 🔧 运营配置
- **[运营配置手册](./运营配置手册.md)** - 第三方服务完整配置指南（含详细步骤）
- **[第三方服务密钥清单](./第三方服务密钥清单.md)** - 快速查找配置项和密钥状态

### 🏗️ 技术实现
- 认证 API 端点：`apps/web/src/app/api/auth/`
- 后端服务逻辑：`apps/api/services/identity/`
- 前端认证组件：`apps/web/src/components/auth/`

---

## 🎯 快速开始

### 场景 1️⃣：配置邮箱登录（必需）
1. 配置 [Cloudflare Turnstile](./运营配置手册.md#1-cloudflare-turnstile防机器人验证)
2. 配置 [Resend 邮件服务](./运营配置手册.md#2-resend邮件验证码服务)
3. 验证 JWT Secret 已设置
4. 测试登录流程

### 场景 2️⃣：启用 Google 登录（可选）
1. 按照 [Google OAuth 配置](./运营配置手册.md#3-google-oauthgoogle-账号登录) 步骤操作
2. 在 Google Cloud Console 添加回调 URL
3. 配置环境变量
4. 测试 OAuth 流程

### 场景 3️⃣：启用 Apple 登录（可选）
1. 按照 [Apple Sign In 配置](./运营配置手册.md#4-apple-sign-inapple-账号登录) 步骤操作
2. 在 Apple Developer Console 创建 Service ID 和私钥
3. 配置环境变量和私钥文件
4. 测试 OAuth 流程

---

## ⚡ 当前配置状态

| 服务 | 状态 | 功能影响 |
|------|------|---------|
| Cloudflare Turnstile | ✅ 已配置 | 防机器人验证 |
| Resend | ✅ 已配置 | 邮箱验证码发送 |
| JWT | ✅ 已配置 | 用户会话管理 |
| Google OAuth | ⚠️ 未配置 | Google 登录不可用 |
| Apple Sign In | ⚠️ 未配置 | Apple 登录不可用 |

**结论：** 当前支持邮箱登录（验证码 + 密码），第三方登录需额外配置。

---

## 🔐 认证流程概览

### 邮箱验证码登录
```
用户输入邮箱 → Turnstile 验证 → 发送验证码（Resend）→ 用户输入验证码 → 生成 JWT Token → 登录成功
```

### 邮箱密码登录
```
用户输入邮箱+密码 → Turnstile 验证 → 验证密码（bcrypt）→ 生成 JWT Token → 登录成功
```

### OAuth 登录（Google/Apple）
```
用户点击第三方登录 → 跳转授权页面 → 用户授权 → 回调到系统 → 验证 Token → 创建/关联账户 → 生成 JWT Token → 登录成功
```

---

## 🛡️ 安全特性

- ✅ **密码加密**：使用 bcrypt 哈希存储
- ✅ **Token 机制**：Access Token (60分钟) + Refresh Token (30天)
- ✅ **防机器人**：Cloudflare Turnstile 验证
- ✅ **单一认证方法**：防止同一邮箱使用多种登录方式冲突
- ✅ **账户复活**：标记删除的账户可在登录时自动恢复

---

## 📞 技术支持

### 配置问题排查
1. 查看后端日志：`apps/api/logs/`
2. 检查环境变量：`apps/api/.env` 和 `apps/web/.env.local`
3. 验证第三方服务控制台状态

### 常见错误码
- `INVALID_TURNSTILE`: Turnstile 验证失败
- `INVALID_CODE`: 验证码错误或过期
- `USER_NOT_FOUND`: 用户不存在
- `WRONG_PASSWORD`: 密码错误
- `OAUTH_ERROR`: OAuth 授权失败

### 文档更新日志
- 2026-01-24: 初始版本创建
