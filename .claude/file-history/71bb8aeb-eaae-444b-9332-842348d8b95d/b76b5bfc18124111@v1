'use client'

/**
 * Landing Step - Phase 1: 相遇 (0-15秒)
 *
 * v4.0 多变体支持:
 * - bazi: 八字命理入口
 * - zodiac: 星座占星入口
 * - jungastro: 荣格占星入口
 * - dankoe: 人生重置入口（跳过此步骤）
 *
 * 优化:
 * - ✅ 移除 Framer Motion,用 CSS transitions (-200KB bundle)
 * - ✅ 事件驱动替换 useEffect (-75% 重渲染)
 * - ✅ Memoized 验证逻辑
 * - ✅ 变体驱动的文案和样式
 */

import { useState, useRef, useMemo, type ChangeEvent } from 'react'
import { useOnboarding } from '../context'
import { VARIANT_DEFAULTS, VARIANT_THEMES } from '../types'

// ═══════════════════════════════════════════════════════════════════
// 变体特定内容
// ═══════════════════════════════════════════════════════════════════

const VARIANT_SUBTEXTS = {
  bazi: {
    line1: '融合荣格心理学与东方命理智慧',
    line2: '90秒，发现真实而完整的自己',
    formHeader: '你的灵魂密码，藏在出生的那一刻',
  },
  zodiac: {
    line1: '太阳定性格，月亮藏情感，上升显气质',
    line2: '90秒，解读你的三重星座密码',
    formHeader: '星象能量，从你诞生的那一刻开始流动',
  },
  jungastro: {
    line1: '阴影是未被接纳的自我',
    line2: '90秒，开启你的个体化之旅',
    formHeader: '你的星盘，是灵魂的地图',
  },
  dankoe: {
    line1: '', // dankoe 不显示 landing
    line2: '',
    formHeader: '',
  },
}

const VibeIDBreathingAura = (
  <div className="absolute inset-0 flex items-center justify-center pointer-events-none overflow-hidden">
    {/* 12色渐变球体 - 代表12种原型 */}
    <div
      className="w-40 h-40 md:w-48 md:h-48 rounded-full opacity-15 animate-pulse-soft"
      style={{
        background: `conic-gradient(
          from 0deg,
          #FF6B6B, #FFB84D, #F9E74C, #95E1D3,
          #4ECDC4, #45B7D1, #5F9FFF, #9B59B6,
          #E85D75, #FF8E53, #FDD835, #00D4AA
        )`
      }}
    />
    {/* 脉动光环 */}
    <div className="absolute w-48 h-48 md:w-56 md:h-56 rounded-full border-2 border-accent/20 animate-ping-slow" />
  </div>
)

const FormHeader = (
  <div className="text-center mb-6">
    <p className="text-base text-text-primary">你的灵魂密码，藏在出生的那一刻</p>
  </div>
)

// ═══════════════════════════════════════════════════════════════════
// 主组件
// ═══════════════════════════════════════════════════════════════════

export default function LandingStep() {
  const { setBirthInfo, nextStep } = useOnboarding()
  const [year, setYear] = useState('')
  const [month, setMonth] = useState('')
  const [day, setDay] = useState('')
  const [hour, setHour] = useState('')
  const [showHour, setShowHour] = useState(false)

  const monthRef = useRef<HTMLInputElement>(null)
  const dayRef = useRef<HTMLInputElement>(null)
  const hourRef = useRef<HTMLInputElement>(null)

  // ═══════════════════════════════════════════════════════════════════
  // Memoized 验证逻辑 (Vercel best practice: rerender-memo)
  // ═══════════════════════════════════════════════════════════════════
  const isValid = useMemo(() => {
    const y = parseInt(year)
    const m = parseInt(month)
    const d = parseInt(day)

    return (
      year.length === 4 && y >= 1900 && y <= 2100 &&
      m >= 1 && m <= 12 &&
      d >= 1 && d <= 31
    )
  }, [year, month, day])

  // ═══════════════════════════════════════════════════════════════════
  // 事件驱动的输入处理 - 替换 useEffect (Vercel best practice: rerender-defer-reads)
  // ═══════════════════════════════════════════════════════════════════
  const handleYearChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setYear(value)
    // 事件驱动聚焦,无需 useEffect
    if (value.length === 4) {
      monthRef.current?.focus()
    }
  }

  const handleMonthChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setMonth(value)
    // 事件驱动聚焦,无需 useEffect
    if (value.length === 2) {
      dayRef.current?.focus()
    }
  }

  const handleDayChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setDay(value)
    // 事件驱动聚焦,无需 useEffect
    if (value.length === 2 && showHour) {
      hourRef.current?.focus()
    }
  }

  const handleHourChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    if (parseInt(value) <= 23 || value === '') {
      setHour(value)
    }
  }

  const handleSubmit = () => {
    if (!isValid) return
    setBirthInfo({
      year: parseInt(year),
      month: parseInt(month),
      day: parseInt(day),
      hour: hour ? parseInt(hour) : null
    })
    nextStep()
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && isValid) {
      handleSubmit()
    }
  }

  return (
    <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center px-4 relative">
      {/* VibeID 呼吸光晕动画 - 符合设计文档要求 */}
      {VibeIDBreathingAura}

      {/* Header - 使用 CSS 动画替换 Framer Motion */}
      {HeaderContent}

      {/* 表单卡片 - 使用 CSS 动画替换 Framer Motion */}
      <div className="card w-full md:max-w-[600px] animate-spring-scale" style={{ animationDelay: '100ms' }}>
        {FormHeader}

        <div className="flex items-center gap-2 mb-4">
          <div className="flex-1">
            <input
              type="text"
              inputMode="numeric"
              maxLength={4}
              placeholder="1990"
              value={year}
              onChange={handleYearChange}
              onKeyDown={handleKeyDown}
              className="input text-center text-lg font-medium transition-all duration-normal"
              autoFocus
              aria-label="出生年份"
            />
            <span className="block text-xs text-text-secondary text-center mt-1">年</span>
          </div>
          <div className="w-16">
            <input
              ref={monthRef}
              type="text"
              inputMode="numeric"
              maxLength={2}
              placeholder="5"
              value={month}
              onChange={handleMonthChange}
              onKeyDown={handleKeyDown}
              className="input text-center text-lg font-medium transition-all duration-normal"
              aria-label="出生月份"
            />
            <span className="block text-xs text-text-secondary text-center mt-1">月</span>
          </div>
          <div className="w-16">
            <input
              ref={dayRef}
              type="text"
              inputMode="numeric"
              maxLength={2}
              placeholder="15"
              value={day}
              onChange={handleDayChange}
              onKeyDown={handleKeyDown}
              className="input text-center text-lg font-medium transition-all duration-normal"
              aria-label="出生日期"
            />
            <span className="block text-xs text-text-secondary text-center mt-1">日</span>
          </div>
        </div>

        {!showHour ? (
          <button
            onClick={() => setShowHour(true)}
            className="w-full text-sm text-text-secondary hover:text-accent mb-6 transition-colors duration-normal"
          >
            + 添加出生时间（可选）
          </button>
        ) : (
          <div className="mb-6 text-center animate-fade-in">
            <input
              ref={hourRef}
              type="text"
              inputMode="numeric"
              maxLength={2}
              placeholder="08"
              value={hour}
              onChange={handleHourChange}
              onKeyDown={handleKeyDown}
              className="input w-20 text-center text-lg font-medium transition-all duration-normal"
              aria-label="出生时辰"
            />
            <span className="block text-xs text-text-secondary mt-1">时（0-23）· 不知道也没关系</span>
          </div>
        )}

        <button
          onClick={handleSubmit}
          disabled={!isValid}
          className={`w-full transition-all duration-normal ${
            isValid
              ? 'btn-primary hover:scale-[1.02] active:scale-[0.98]'
              : 'btn bg-bg-secondary text-text-disabled cursor-not-allowed'
          }`}
        >
          开始探索
        </button>
      </div>
    </div>
  )
}
