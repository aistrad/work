'use client'

/**
 * Onboarding Page - v6.0
 *
 * 多变体入口：bazi / zodiac / jungastro / dankoe
 *
 * URL 参数：
 * - /onboarding              → 默认 bazi
 * - /onboarding?variant=zodiac
 * - /onboarding?variant=dankoe
 *
 * 优化:
 * - ✅ 动态导入步骤组件 (Vercel best practice: bundle-dynamic-imports)
 * - ✅ Suspense 边界实现流式加载 (Vercel best practice: async-suspense-boundaries)
 * - ✅ 变体驱动的差异化体验
 */

import { Suspense } from 'react'
import dynamic from 'next/dynamic'
import { useSearchParams } from 'next/navigation'
import { useOnboarding } from './context'
import type { VariantId } from './types'

// ═══════════════════════════════════════════════════════════════════
// 动态导入步骤组件 - 减少首屏 bundle (Vercel best practice: bundle-dynamic-imports)
// ═══════════════════════════════════════════════════════════════════

// LandingStep 不动态导入,因为它是首屏必需
import LandingStep from './steps/LandingStep'

// 其他步骤动态导入,只在需要时加载
const LoadingStep = dynamic(() => import('./steps/LoadingStep'), {
  loading: () => <LoadingSkeleton />,
  ssr: false
})

const EmbeddedChatStep = dynamic(() => import('./steps/EmbeddedChatStep'), {
  loading: () => <LoadingSkeleton />,
  ssr: false
})

const ConversionStep = dynamic(() => import('./steps/ConversionStep'), {
  loading: () => <LoadingSkeleton />,
  ssr: false
})

// ═══════════════════════════════════════════════════════════════════
// Loading Skeleton - Suspense fallback
// ═══════════════════════════════════════════════════════════════════

function LoadingSkeleton() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="flex flex-col items-center gap-4">
        <div className="w-16 h-16 rounded-full border-4 border-accent-primary/20 border-t-accent-primary animate-spin" />
        <p className="text-sm text-text-secondary">加载中...</p>
      </div>
    </div>
  )
}

// ═══════════════════════════════════════════════════════════════════
// 主组件 - 使用 Suspense 边界
// ═══════════════════════════════════════════════════════════════════

function OnboardingFlow() {
  const { state } = useOnboarding()

  // dankoe 变体：跳过 landing 和 loading，直接进入 embeddedChat
  // 其他变体：从 landing 开始

  // LandingStep 无需 Suspense,因为它已经在客户端
  if (state.step === 'landing') {
    return <LandingStep />
  }

  // 其他步骤使用 Suspense 边界,实现流式加载
  return (
    <Suspense fallback={<LoadingSkeleton />}>
      {state.step === 'loading' && <LoadingStep />}
      {state.step === 'embeddedChat' && <EmbeddedChatStep />}
      {state.step === 'conversion' && <ConversionStep />}
    </Suspense>
  )
}

// ═══════════════════════════════════════════════════════════════════
// 页面入口 - 读取 variant 参数
// ═══════════════════════════════════════════════════════════════════

export default function OnboardingPage() {
  const searchParams = useSearchParams()
  const variantParam = searchParams.get('variant') as VariantId | null

  // 验证 variant 参数，无效则使用默认值
  const validVariants: VariantId[] = ['bazi', 'zodiac', 'jungastro', 'dankoe']
  const variant: VariantId = variantParam && validVariants.includes(variantParam)
    ? variantParam
    : 'bazi'

  // 注意：OnboardingProvider 在 layout.tsx 中，这里只是 Flow
  // 如果需要在这里传递 variant，需要重构 layout
  return <OnboardingFlow />
}
