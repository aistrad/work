'use client'

/**
 * Onboarding Context - v3.0
 *
 * 管理整个 onboarding 流程的状态
 * 支持多变体入口：bazi / zodiac / jungastro / dankoe
 */

import React, { createContext, useContext, useReducer, useCallback, ReactNode } from 'react'
import type {
  OnboardingStep,
  OnboardingState,
  BirthInfo,
  ConcernType,
  PersonaType,
  BaziData,
  InterviewAnswer,
  VariantId,
  VariantConfig,
} from './types'

// ═══════════════════════════════════════════════════════════════════════════
// State & Actions
// ═══════════════════════════════════════════════════════════════════════════

const createInitialState = (variant: VariantId): OnboardingState => ({
  variant,
  variantConfig: null,
  step: variant === 'dankoe' ? 'embeddedChat' : 'landing', // dankoe 跳过 landing
  birthInfo: null,
  concerns: [],
  gender: null,
  persona: null,
  baziData: null,
  interviewAnswers: [],
  letterContent: null,
})

const initialState: OnboardingState = createInitialState('bazi')

type Action =
  | { type: 'SET_VARIANT'; payload: VariantId }
  | { type: 'SET_VARIANT_CONFIG'; payload: VariantConfig }
  | { type: 'SET_STEP'; payload: OnboardingStep }
  | { type: 'SET_BIRTH_INFO'; payload: BirthInfo }
  | { type: 'SET_CONCERNS'; payload: ConcernType[] }
  | { type: 'SET_GENDER'; payload: string }
  | { type: 'SET_PERSONA'; payload: PersonaType }
  | { type: 'SET_BAZI_DATA'; payload: BaziData }
  | { type: 'ADD_INTERVIEW_ANSWER'; payload: InterviewAnswer }
  | { type: 'SET_LETTER_CONTENT'; payload: string }
  | { type: 'RESET'; payload?: VariantId }

function reducer(state: OnboardingState, action: Action): OnboardingState {
  switch (action.type) {
    case 'SET_VARIANT':
      return { ...state, variant: action.payload }
    case 'SET_VARIANT_CONFIG':
      return { ...state, variantConfig: action.payload }
    case 'SET_STEP':
      return { ...state, step: action.payload }
    case 'SET_BIRTH_INFO':
      return { ...state, birthInfo: action.payload }
    case 'SET_CONCERNS':
      return { ...state, concerns: action.payload }
    case 'SET_GENDER':
      return { ...state, gender: action.payload }
    case 'SET_PERSONA':
      return { ...state, persona: action.payload }
    case 'SET_BAZI_DATA':
      return { ...state, baziData: action.payload }
    case 'ADD_INTERVIEW_ANSWER':
      return {
        ...state,
        interviewAnswers: [...state.interviewAnswers, action.payload],
      }
    case 'SET_LETTER_CONTENT':
      return { ...state, letterContent: action.payload }
    case 'RESET':
      return createInitialState(action.payload || state.variant)
    default:
      return state
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// Context
// ═══════════════════════════════════════════════════════════════════════════

interface OnboardingContextValue {
  state: OnboardingState
  // Navigation
  goToStep: (step: OnboardingStep) => void
  nextStep: () => void
  // Variant
  setVariantConfig: (config: VariantConfig) => void
  // Data setters
  setBirthInfo: (info: BirthInfo) => void
  setConcerns: (concerns: ConcernType[]) => void
  setGender: (gender: string) => void
  setPersona: (persona: PersonaType) => void
  setBaziData: (data: BaziData) => void
  addInterviewAnswer: (answer: InterviewAnswer) => void
  setLetterContent: (content: string) => void
  // Utils
  reset: () => void
}

const OnboardingContext = createContext<OnboardingContextValue | null>(null)

// Step order for nextStep navigation
// dankoe: 跳过 landing 和 loading，直接进入 embeddedChat
const STEP_ORDER: OnboardingStep[] = [
  'landing',       // 0-15秒: 输入生日（dankoe 跳过）
  'loading',       // 15-45秒: 计算（dankoe 跳过）
  'embeddedChat',  // 首次相遇对话
  'conversion',    // 对话结束后: 付费引导
]

// dankoe 变体的步骤顺序
const DANKOE_STEP_ORDER: OnboardingStep[] = [
  'embeddedChat',  // 直接进入对话
  'conversion',    // 对话结束后: 付费引导
]

// ═══════════════════════════════════════════════════════════════════════════
// Provider
// ═══════════════════════════════════════════════════════════════════════════

interface OnboardingProviderProps {
  children: ReactNode
  variant?: VariantId
}

export function OnboardingProvider({ children, variant = 'bazi' }: OnboardingProviderProps) {
  const [state, dispatch] = useReducer(reducer, createInitialState(variant))

  const goToStep = useCallback((step: OnboardingStep) => {
    dispatch({ type: 'SET_STEP', payload: step })
  }, [])

  const nextStep = useCallback(() => {
    // 根据变体选择步骤顺序
    const stepOrder = state.variant === 'dankoe' ? DANKOE_STEP_ORDER : STEP_ORDER
    const currentIndex = stepOrder.indexOf(state.step)
    if (currentIndex < stepOrder.length - 1) {
      dispatch({ type: 'SET_STEP', payload: stepOrder[currentIndex + 1] })
    }
  }, [state.step, state.variant])

  const setVariantConfig = useCallback((config: VariantConfig) => {
    dispatch({ type: 'SET_VARIANT_CONFIG', payload: config })
  }, [])

  const setBirthInfo = useCallback((info: BirthInfo) => {
    dispatch({ type: 'SET_BIRTH_INFO', payload: info })
  }, [])

  const setConcerns = useCallback((concerns: ConcernType[]) => {
    dispatch({ type: 'SET_CONCERNS', payload: concerns })
  }, [])

  const setGender = useCallback((gender: string) => {
    dispatch({ type: 'SET_GENDER', payload: gender })
  }, [])

  const setPersona = useCallback((persona: PersonaType) => {
    dispatch({ type: 'SET_PERSONA', payload: persona })
  }, [])

  const setBaziData = useCallback((data: BaziData) => {
    dispatch({ type: 'SET_BAZI_DATA', payload: data })
  }, [])

  const addInterviewAnswer = useCallback((answer: InterviewAnswer) => {
    dispatch({ type: 'ADD_INTERVIEW_ANSWER', payload: answer })
  }, [])

  const setLetterContent = useCallback((content: string) => {
    dispatch({ type: 'SET_LETTER_CONTENT', payload: content })
  }, [])

  const reset = useCallback(() => {
    dispatch({ type: 'RESET' })
  }, [])

  const value: OnboardingContextValue = {
    state,
    goToStep,
    nextStep,
    setVariantConfig,
    setBirthInfo,
    setConcerns,
    setGender,
    setPersona,
    setBaziData,
    addInterviewAnswer,
    setLetterContent,
    reset,
  }

  return (
    <OnboardingContext.Provider value={value}>
      {children}
    </OnboardingContext.Provider>
  )
}

// ═══════════════════════════════════════════════════════════════════════════
// Hook
// ═══════════════════════════════════════════════════════════════════════════

export function useOnboarding() {
  const context = useContext(OnboardingContext)
  if (!context) {
    throw new Error('useOnboarding must be used within OnboardingProvider')
  }
  return context
}
