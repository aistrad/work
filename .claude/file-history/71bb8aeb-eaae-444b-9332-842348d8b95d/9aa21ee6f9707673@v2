'use client';

/**
 * EmbeddedChatStep - v6.0 首次相遇嵌入式对话
 *
 * 多变体支持:
 * - bazi / zodiac / jungastro: 基于命盘的洞察
 * - dankoe: 对话驱动的洞察收集
 *
 * 设计原则：
 * - 复用 ChatContainer，保持与 /chat 页面完全一致的 UI
 * - 根据 variant 传递不同的 skillId
 * - 检测首次相遇完成后跳转 ConversionStep
 */

import { useEffect, useState, useRef, useCallback, useMemo } from 'react';
import dynamic from 'next/dynamic';
import { useOnboarding } from '../context';
import { LuminousPaper, BreathAura } from '@/components/core';
import { VARIANT_THEMES } from '../types';

// 动态导入 ChatContainer，与 /chat 页面一致
const ChatContainer = dynamic(
  () => import('@/components/chat/ChatContainer').then(mod => ({ default: mod.ChatContainer })),
  { ssr: false, loading: () => <ChatLoadingFallback /> }
);

function ChatLoadingFallback() {
  return (
    <div className="flex-1 flex items-center justify-center">
      <div className="flex flex-col items-center gap-3">
        <div className="w-12 h-12 rounded-full bg-accent-primary/10 animate-pulse flex items-center justify-center">
          <span className="text-2xl">✨</span>
        </div>
        <p className="text-text-secondary text-sm">正在准备首次相遇...</p>
      </div>
    </div>
  );
}

// 首次相遇完成的关键词检测
const COMPLETION_KEYWORDS = [
  '明天早上',
  '每天都会',
  '记住了',
  '期待与你',
  '晚安',
  '明天见',
];

export default function EmbeddedChatStep() {
  const { state, nextStep } = useOnboarding();
  const { variant, baziData } = state;
  const [conversationId, setConversationId] = useState<string | undefined>();
  const hasStartedRef = useRef(false);
  const completionDetectedRef = useRef(false);

  // 获取变体主题
  const theme = useMemo(() => VARIANT_THEMES[variant], [variant]);

  // 处理对话开始
  const handleConversationStart = useCallback((id: string) => {
    setConversationId(id);
  }, []);

  // 初始消息 - 根据变体不同
  // dankoe: 直接开始对话
  // 其他: 触发 onboarding skill
  const initialPrompt = useMemo(() => {
    if (hasStartedRef.current) return undefined;
    return variant === 'dankoe' ? '我准备好了' : '开始';
  }, [variant]);

  useEffect(() => {
    hasStartedRef.current = true;
  }, []);

  // 监听 localStorage 中的 onboarding_completed 标记
  // 后端在承诺消息后会设置此标记
  useEffect(() => {
    const checkComplete = () => {
      if (completionDetectedRef.current) return;

      const completed = localStorage.getItem('vibelife_onboarding_chat_completed');
      if (completed === 'true') {
        completionDetectedRef.current = true;
        localStorage.removeItem('vibelife_onboarding_chat_completed');
        // 延迟跳转，让用户看到最后的承诺消息
        setTimeout(() => nextStep(), 2000);
      }
    };

    // 每秒检查一次
    const interval = setInterval(checkComplete, 1000);
    return () => clearInterval(interval);
  }, [nextStep]);

  // 检测 DOM 中的消息内容是否包含完成关键词
  // 这是一个备用检测机制
  useEffect(() => {
    const checkMessageContent = () => {
      if (completionDetectedRef.current) return;

      // 查找最后一条 assistant 消息
      const messages = document.querySelectorAll('[data-role="assistant"]');
      if (messages.length === 0) return;

      const lastMessage = messages[messages.length - 1];
      const content = lastMessage?.textContent || '';

      // 检查是否包含完成关键词
      const hasCompletionKeyword = COMPLETION_KEYWORDS.some(keyword =>
        content.includes(keyword)
      );

      if (hasCompletionKeyword) {
        completionDetectedRef.current = true;
        // 设置 localStorage 标记
        localStorage.setItem('vibelife_onboarding_chat_completed', 'true');
        // 延迟跳转
        setTimeout(() => nextStep(), 3000);
      }
    };

    // 使用 MutationObserver 监听消息变化
    const observer = new MutationObserver(checkMessageContent);
    const chatContainer = document.querySelector('[role="log"]');

    if (chatContainer) {
      observer.observe(chatContainer, {
        childList: true,
        subtree: true,
        characterData: true,
      });
    }

    return () => observer.disconnect();
  }, [nextStep]);

  // dankoe 不需要命盘数据，其他变体需要
  const needsBaziData = variant !== 'dankoe';
  if (needsBaziData && !baziData) {
    return (
      <LuminousPaper
        skill={theme.skill}
        variant="default"
        className="min-h-screen"
      >
        <div className="flex items-center justify-center h-screen">
          <div className="text-center">
            <p className="text-text-secondary mb-4">数据加载中...</p>
            <button
              onClick={() => window.location.reload()}
              className="text-accent hover:underline"
            >
              刷新页面
            </button>
          </div>
        </div>
      </LuminousPaper>
    );
  }

  return (
    <LuminousPaper
      skill={theme.skill}
      variant="default"
      className="min-h-screen"
    >
      {/* 呼吸光晕背景 - 变体特定主题 */}
      <BreathAura
        skill={theme.skill}
        intensity="low"
        className="fixed inset-0 pointer-events-none"
      />

      {/* 嵌入式 Chat - 传递 variant 到 onboarding skill */}
      <div className="relative z-10 h-screen flex flex-col">
        <ChatContainer
          skillId="onboarding"
          skill={theme.skill}
          initialPrompt={initialPrompt}
          onConversationStart={handleConversationStart}
          onInitialPromptSent={() => {
            // 初始消息已发送
          }}
        />
      </div>
    </LuminousPaper>
  );
}
