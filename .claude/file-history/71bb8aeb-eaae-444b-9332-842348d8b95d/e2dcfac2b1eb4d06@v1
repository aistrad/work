'use client'

/**
 * Onboarding Layout - v4.0
 *
 * 多变体入口布局
 * 根据 ?variant= 参数动态切换主题和 Provider
 */

import { ReactNode, useMemo } from 'react'
import { useSearchParams } from 'next/navigation'
import { OnboardingProvider } from './context'
import { LuminousPaper, BreathAura, VibeGlyph } from '@/components/core'
import { OnboardingErrorBoundary } from './ErrorBoundary'
import type { VariantId } from './types'
import { VARIANT_THEMES } from './types'

export default function OnboardingLayout({ children }: { children: ReactNode }) {
  const searchParams = useSearchParams()
  const variantParam = searchParams.get('variant') as VariantId | null

  // 验证 variant 参数
  const validVariants: VariantId[] = ['bazi', 'zodiac', 'jungastro', 'dankoe']
  const variant: VariantId = variantParam && validVariants.includes(variantParam)
    ? variantParam
    : 'bazi'

  // 根据变体获取主题
  const theme = useMemo(() => VARIANT_THEMES[variant], [variant])

  return (
    <OnboardingErrorBoundary>
      <OnboardingProvider variant={variant}>
        <LuminousPaper
          skill={theme.skill as 'bazi' | 'zodiac' | 'tarot' | 'lifecoach'}
          variant="default"
          className="min-h-screen"
        >
          <BreathAura
            skill={theme.skill as 'bazi' | 'zodiac' | 'tarot' | 'lifecoach'}
            size="xl"
            position="center"
            intensity="medium"
            className="opacity-30"
          />

          <div className="relative z-10 min-h-screen flex flex-col">
            {/* Minimal Header */}
            <header className="py-4 px-6">
              <div className="flex items-center gap-2">
                <VibeGlyph
                  size="sm"
                  skill={theme.skill as 'bazi' | 'zodiac' | 'tarot' | 'lifecoach'}
                  showAura={false}
                />
                <span className="font-serif font-semibold text-foreground">VibeLife</span>
                {/* 变体标识 */}
                <span className="ml-2 text-xs text-text-secondary opacity-60">
                  {theme.icon}
                </span>
              </div>
            </header>

            {/* Main Content */}
            <main id="main-content" className="flex-1 flex items-center justify-center px-4 pb-8">
              {children}
            </main>
          </div>
        </LuminousPaper>
      </OnboardingProvider>
    </OnboardingErrorBoundary>
  )
}
