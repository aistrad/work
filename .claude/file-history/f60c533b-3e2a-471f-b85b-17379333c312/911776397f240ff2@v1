-- Migration: 007_user_data_store
-- Description: Add user_data_store table for composite tools (goals, tasks, reminders)
-- Date: 2026-01-18

-- =============================================================================
-- 1. user_data_store 表（用户数据存储）
-- =============================================================================

CREATE TABLE IF NOT EXISTS user_data_store (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id     UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    data_type   VARCHAR(50) NOT NULL,   -- goals, tasks, checkins, files, reminders
    data_path   VARCHAR(500) NOT NULL,  -- 虚拟路径: goals/2026/year.json
    content     JSONB NOT NULL,         -- JSON 数据
    version     INTEGER DEFAULT 1,
    created_at  TIMESTAMP DEFAULT NOW(),
    updated_at  TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, data_path)
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_user_data_store_user_id
    ON user_data_store(user_id);
CREATE INDEX IF NOT EXISTS idx_user_data_store_type
    ON user_data_store(user_id, data_type);
CREATE INDEX IF NOT EXISTS idx_user_data_store_path
    ON user_data_store(user_id, data_path);
-- GIN 索引支持 JSONB 查询
CREATE INDEX IF NOT EXISTS idx_user_data_store_content
    ON user_data_store USING GIN (content);

-- 注释
COMMENT ON TABLE user_data_store IS '用户数据存储表（支持目标、任务、打卡等）';
COMMENT ON COLUMN user_data_store.data_type IS '数据类型: goals, tasks, checkins, files, reminders';
COMMENT ON COLUMN user_data_store.data_path IS '虚拟文件路径，如 goals/2026/year.json';
COMMENT ON COLUMN user_data_store.content IS 'JSON 数据内容';
COMMENT ON COLUMN user_data_store.version IS '数据版本号（用于乐观锁）';

-- =============================================================================
-- 2. user_reminders 表（用户自定义提醒）
-- =============================================================================

CREATE TABLE IF NOT EXISTS user_reminders (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    reminder_type   VARCHAR(50) NOT NULL,   -- goal_checkin, daily_plan, milestone, custom
    title           VARCHAR(200) NOT NULL,
    description     TEXT,
    schedule        VARCHAR(100),           -- cron 表达式或 ISO 日期
    schedule_type   VARCHAR(20) NOT NULL DEFAULT 'once',  -- once, daily, weekly, monthly, cron
    next_trigger_at TIMESTAMP,
    last_triggered_at TIMESTAMP,
    status          VARCHAR(20) DEFAULT 'active',  -- active, paused, completed, cancelled
    metadata        JSONB DEFAULT '{}',     -- 关联数据（如 goal_id, task_id）
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_user_reminders_user_id
    ON user_reminders(user_id);
CREATE INDEX IF NOT EXISTS idx_user_reminders_next_trigger
    ON user_reminders(next_trigger_at) WHERE status = 'active';
CREATE INDEX IF NOT EXISTS idx_user_reminders_type
    ON user_reminders(user_id, reminder_type);

-- 注释
COMMENT ON TABLE user_reminders IS '用户自定义提醒表';
COMMENT ON COLUMN user_reminders.reminder_type IS '提醒类型: goal_checkin, daily_plan, milestone, custom';
COMMENT ON COLUMN user_reminders.schedule IS 'cron 表达式或 ISO 日期时间';
COMMENT ON COLUMN user_reminders.schedule_type IS '调度类型: once, daily, weekly, monthly, cron';
COMMENT ON COLUMN user_reminders.next_trigger_at IS '下次触发时间';
COMMENT ON COLUMN user_reminders.metadata IS '关联元数据（goal_id, task_id 等）';

-- =============================================================================
-- 3. 更新 unified_profiles 表支持 goal_tracking 配置
-- =============================================================================

-- 确保 profile JSONB 支持新字段（无需 DDL，JSONB 天然支持）
-- 预期 profile.goal_tracking 结构:
-- {
--   "last_checkin": "2026-01-17",
--   "streak_days": 5,
--   "reminder_time": "08:00",
--   "enable_fortune_insights": true
-- }

-- =============================================================================
-- 4. 函数：自动更新 updated_at
-- =============================================================================

CREATE OR REPLACE FUNCTION update_user_data_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    NEW.version = OLD.version + 1;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 触发器
DROP TRIGGER IF EXISTS trigger_user_data_store_update ON user_data_store;
CREATE TRIGGER trigger_user_data_store_update
    BEFORE UPDATE ON user_data_store
    FOR EACH ROW
    EXECUTE FUNCTION update_user_data_timestamp();

DROP TRIGGER IF EXISTS trigger_user_reminders_update ON user_reminders;
CREATE TRIGGER trigger_user_reminders_update
    BEFORE UPDATE ON user_reminders
    FOR EACH ROW
    EXECUTE FUNCTION update_modified_column();
