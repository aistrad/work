# 邮箱注册登录实现计划

## 需求
- 邮箱 + 密码注册（含验证码）
- 邮箱 + 密码登录
- 密码重置

## 现有架构
- 认证服务: `apps/api/services/identity/auth.py`
- 用户仓库: `apps/api/stores/user_repo.py` (bcrypt 已有)
- 前端登录: `apps/web/src/app/auth/login/page.tsx` (仅 OAuth)

## 实现步骤

### Phase 1: 后端
1. **创建验证码表** - `migrations/021_email_verification.sql`
   - `email_verification_codes` (email, code, type, expires_at, created_at)

2. **创建邮件发送服务** - `apps/api/services/notification/email_sender.py`
   - 支持 SMTP 方式发送验证码邮件

3. **创建邮箱认证服务** - `apps/api/services/identity/email.py`
   - `register(email, password, code)` - 注册
   - `login(email, password)` - 登录
   - `send_verification_code(email, type)` - 发送验证码
   - `reset_password(email, code, new_password)` - 重置密码

4. **添加邮箱认证路由** - `apps/api/routes/account.py`
   - `POST /account/auth/email/register`
   - `POST /account/auth/email/login`
   - `POST /account/auth/email/send-code`
   - `POST /account/auth/email/reset-password`

### Phase 2: 前端
5. **创建邮箱登录表单** - `apps/web/src/components/auth/EmailLoginForm.tsx`

6. **创建邮箱注册表单** - `apps/web/src/components/auth/EmailRegisterForm.tsx`

7. **创建密码重置表单** - `apps/web/src/components/auth/PasswordResetForm.tsx`

8. **更新登录页面** - `apps/web/src/app/auth/login/page.tsx`
   - 添加邮箱登录选项

9. **创建注册页面** - `apps/web/src/app/auth/register/page.tsx`

10. **创建密码重置页面** - `apps/web/src/app/auth/reset-password/page.tsx`

11. **更新 API 客户端** - `apps/web/src/lib/api.ts`

### Phase 3: 安全
12. **添加限流** - 登录失败 5次/15分钟，验证码 5次/小时

## 验证方式
1. 运行数据库迁移
2. 启动测试环境 (`/vibelife-test start`)
3. 测试注册流程: 发送验证码 -> 输入验证码 -> 设置密码 -> 注册成功
4. 测试登录流程: 输入邮箱密码 -> 登录成功
5. 测试密码重置: 发送验证码 -> 输入新密码 -> 重置成功

## 配置需求
- SMTP 配置 (SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASSWORD)
