# Soul OS å¿ƒç†æ¶æ„è®¾è®¡

**ç‰ˆæœ¬**ï¼šv4.0ï¼ˆ2026-01-01ï¼ŒEvolutionary Memory Editionï¼‰
**æ–‡æ¡£ç±»å‹**ï¼šOperating System Psychological Architecture
**å®šä½**ï¼šåŸºäºæ·±åº¦å¿ƒç†å­¦çš„ç²¾ç¥æ•°å­—å­ªç”Ÿæ“ä½œç³»ç»Ÿ
**æ ¸å¿ƒæ¶æ„**ï¼šDynamic Profiling & Evolutionary Loopï¼ˆåŠ¨æ€ç”»åƒä¸è¿›åŒ–å›è·¯ï¼‰
**ç†è®ºæ¡†æ¶**ï¼šè£æ ¼åˆ†æå¿ƒç†å­¦ Ã— ç§¯æå¿ƒç†å­¦ Ã— è¡Œä¸ºç§‘å­¦ Ã— è‡ªæˆ‘å†³å®šç†è®º

---

## 0. ä¿®è®¢è¯´æ˜

### 0.0 v4.0 æ¶æ„å‡çº§è¦ç‚¹

æœ¬ç‰ˆæœ¬é‡‡ç”¨ **Dynamic Profiling & Evolutionary Loop** æ¶æ„ï¼Œæ ¸å¿ƒå˜æ›´ï¼š

1. **åŒè·¯å¾„è®¾è®¡ (Hot/Cold Path)**ï¼š
   - **Hot Path (åŒæ­¥)**: è¯»å– L0/L1 â†’ ç»„è£… Context â†’ ç”Ÿæˆå›å¤ï¼ˆè¿½æ±‚ä½å»¶è¿Ÿï¼‰
   - **Cold Path (å¼‚æ­¥)**: åˆ†æäº¤äº’å†å² â†’ æå–äº‹å®/åå¥½/çŠ¶æ€ â†’ åå†™ L0/L1

2. **æ–°æ ¸å¿ƒç»„ä»¶ - Insight & Memory Agent**ï¼š
   - åå°è¿è¡Œçš„æ´å¯Ÿç®—å­ï¼Œä»éç»“æ„åŒ–å¯¹è¯ä¸­èƒå–ç»“æ„åŒ–æ•°æ®
   - è´Ÿè´£ L0/L1 çš„åŠ¨æ€æ›´æ–°ï¼ˆç”»åƒä¸°æ»¡ + æ¨¡å—æ•°æ®ç§¯ç´¯ï¼‰

3. **Context Manager v4.0 è¿›åŒ–**ï¼š
   - æ—§ç‰ˆ: `System Prompt + User Input`
   - æ–°ç‰ˆ: `System Prompt + L0(Status) + L1(Relevant Module) + Vector Search(History) + User Input`

4. **æˆé•¿æ€§ç³»ç»Ÿ**ï¼šSoul OS è¶Šç”¨è¶Šæ‡‚ç”¨æˆ·ï¼Œè¶Šç”¨æ•°æ®è¶Šåš

### 0.0.1 v3.x â†’ v4.0 å±‚æ¬¡æ˜ å°„

| v3.x å±‚æ¬¡ | v4.0 å±‚æ¬¡ | å˜åŒ– |
|-----------|-----------|------|
| Interaction Layer | Interaction Layer | æ— å˜åŒ– |
| Context Management | Context Manager v4.0 | å¢åŠ  History å‘é‡æ£€ç´¢ |
| L2 Agents | L2 Agents + Insight Agent | æ–°å¢åå°æ´å¯Ÿç®—å­ |
| L1 Module Data | L1 Module Data (å¯åå†™) | æ”¯æŒ Cold Path æ›´æ–° |
| L0 Base Data | L0 Base Data (å¯åå†™) | æ”¯æŒç”»åƒåŠ¨æ€ä¸°æ»¡ |

### 0.1 è®¾è®¡ vs å®ç°å¯¹æ¯”

| æ¨¡å— | è®¾è®¡çŠ¶æ€ | å®ç°çŠ¶æ€ | å·®è·åˆ†æ |
|------|----------|----------|----------|
| L0 Base Data | âœ… å®Œæ•´è®¾è®¡ | âœ… å®Œæ•´å®ç° | å…«å­—è®¡ç®—ç²¾ç¡® |
| L1 Module Data | âœ… å¯æ’æ‹”è®¾è®¡ | âœ… å·²å®ç° | å…«å­—/PERMA æ¨¡å—å°±ç»ª |
| L2 Expert Agents | âœ… å¤šæ¨¡å—è®¾è®¡ | âš ï¸ éƒ¨åˆ†å®ç° | ä»…å…«å­— Agentï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç° |
| L2 Style Agents | âœ… ä¸‰é£æ ¼è®¾è®¡ | âœ… å·²å®ç° | standard/warm/roast |
| Context Management | âœ… ç»„è£…å·¥å‚ | âœ… GLM æ•´åˆ | å·¥ä½œæ­£å¸¸ |
| Interaction Layer | âœ… å¤šæ¨¡å‹æ”¯æŒ | âš ï¸ éƒ¨åˆ†å®ç° | GLM ä¸ºä¸»ï¼ŒGemini/Claude å¤‡é€‰ |
| Goal æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
| Reflection æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
| anti-dependency | âœ… ç­–ç•¥è®¾è®¡ | âš ï¸ å¾…ä¼˜åŒ– | æ–°ç”¨æˆ·è±å…å¾…å®ç° |
| A2UI æ¸²æŸ“ | âœ… action_buttons | âš ï¸ å‰ç«¯é—®é¢˜ | CSRF é—®é¢˜ |

---

## 1. å¤šå±‚æ¶æ„æµç¨‹å›¾å¯¹æ¯”

> **æœ¯è¯­å®šä¹‰**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§7 Soul OS æ¶æ„
> **æ ¸å¿ƒæ¶æ„**: Context Driven / Pluggable Modulesï¼ˆè§ Â§1.4ï¼‰

### 1.1 è®¾è®¡æ¶æ„ (å››å±‚å¿ƒç†æ¶æ„) âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä¿ç•™ä½œä¸º v2 æ¶æ„çš„å†å²å‚è€ƒã€‚
> **âœ… å½“å‰è§„èŒƒ**: è¯·ä½¿ç”¨ [Â§1.4 Context é©±åŠ¨æ¶æ„](#14-context-é©±åŠ¨æ¶æ„-å¯æ’æ‹”æ¨¡å—è§†å›¾) ä½œä¸ºå”¯ä¸€å®ç°ä¾æ®ã€‚
>
> | æ—§æœ¯è¯­ | æ–°æ¶æ„æ˜ å°„ |
> |--------|------------|
> | L0 Firmware (å®šæ•°/æœ¬æˆ‘) | L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ) |
> | L1 Schema (ç‰¹è´¨/å›¾å¼) | L1 Module Data (å¯æ’æ‹”æ•°æ®å±‚) |
> | L2 Agents (ç­–ç•¥/è¶…æˆ‘) | L2 Expert + Style Agents (åŒåˆ†æ”¯) |
> | L3 Synthesis (æ„è¯†/è‡ªæˆ‘) | Context Management + Interaction Layer |

```mermaid
graph TB
    subgraph User["ğŸ‘¤ ç”¨æˆ·äº¤äº’"]
        Input["è¾“å…¥æ¶ˆæ¯"]
    end

    subgraph L3["L3: Synthesis (æ„è¯†/è‡ªæˆ‘)"]
        GLM["å…ƒè®¤çŸ¥ä»²è£å™¨<br/>(GLM Agent)"]
        A2UI["A2UI JSON è¾“å‡º<br/>ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·"]
    end

    subgraph L2["L2: Agents (ç­–ç•¥/è¶…æˆ‘)"]
        BaziAgent["å…«å­—è§£è¯» Agent<br/>æ ¼å±€/å¤§è¿/ç¥ç…"]
        PsyAgent["å¿ƒç†å­¦ Agent<br/>PERMA/CBT/æƒ…ç»ª"]
        ActionAgent["è¡ŒåŠ¨æ•™ç»ƒ Agent<br/>å¤„æ–¹/æ—¶é—´/éš¾åº¦"]
    end

    subgraph L1["L1: Schema (ç‰¹è´¨/å›¾å¼)"]
        PERMA["PERMA äº”ç»´<br/>P-E-R-M-A"]
        StateScore["State Score<br/>æƒ…ç»ª40%+è¡ŒåŠ¨35%+æˆé•¿25%"]
    end

    subgraph L0["L0: Firmware (å®šæ•°/æœ¬æˆ‘)"]
        Bazi["å…«å­—ç¡®å®šæ€§è®¡ç®—<br/>å››æŸ±/åç¥/ç¥ç…/å¤§è¿"]
        Profile["ç”¨æˆ·æ¡£æ¡ˆ<br/>åŸºç¡€ä¿¡æ¯+åå¥½+å†å²"]
    end

    Input --> L3
    GLM --> A2UI

    L2 --> GLM
    BaziAgent --> GLM
    PsyAgent --> GLM
    ActionAgent --> GLM

    L1 --> L2
    PERMA --> BaziAgent
    StateScore --> PsyAgent

    L0 --> L1
    Bazi --> PERMA
    Profile --> StateScore

    style L3 fill:#e8f5e9,stroke:#4caf50
    style L2 fill:#e3f2fd,stroke:#2196f3
    style L1 fill:#fff3e0,stroke:#ff9800
    style L0 fill:#fce4ec,stroke:#e91e63
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Soul OS å››å±‚å¿ƒç†æ¶æ„                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚     ç”¨æˆ·äº¤äº’        â”‚
                           â”‚     è¾“å…¥æ¶ˆæ¯        â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3: Synthesis (æ„è¯†/è‡ªæˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    å…ƒè®¤çŸ¥ä»²è£å™¨          â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    A2UI JSON è¾“å‡º            â”‚        â”‚
â”‚  â”‚    (GLM Agent)          â”‚        â”‚    ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2: Agents (ç­–ç•¥/è¶…æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚              â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                                                          â”‚              â”‚
â”‚  â–¼                          â–¼                          â–¼    â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚
â”‚  â”‚ å…«å­—è§£è¯»Agent â”‚    â”‚ å¿ƒç†å­¦ Agent â”‚    â”‚ è¡ŒåŠ¨æ•™ç»ƒAgent â”‚   â”‚              â”‚
â”‚  â”‚ æ ¼å±€/å¤§è¿/ç¥ç…â”‚    â”‚ PERMA/CBT/æƒ…ç»ªâ”‚    â”‚ å¤„æ–¹/æ—¶é—´/éš¾åº¦â”‚   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                   â”‚                   â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1: Schema (ç‰¹è´¨/å›¾å¼) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚          â”‚                   â”‚                   â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                 â”‚   â”‚                                    â”‚              â”‚
â”‚  â–¼                 â–¼   â”‚                                    â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚ PERMA äº”ç»´       â”‚  â”‚    â”‚ State Score               â”‚  â”‚              â”‚
â”‚  â”‚ P-E-R-M-A       â”‚  â”‚    â”‚ æƒ…ç»ª40% + è¡ŒåŠ¨35% + æˆé•¿25%â”‚  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚           â”‚                   â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L0: Firmware (å®šæ•°/æœ¬æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚           â”‚           â”‚                   â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å…«å­—ç¡®å®šæ€§è®¡ç®—                  â”‚  â”‚ ç”¨æˆ·æ¡£æ¡ˆ                    â”‚       â”‚
â”‚  â”‚ å››æŸ± / åç¥ / ç¥ç… / å¤§è¿       â”‚  â”‚ åŸºç¡€ä¿¡æ¯ + åå¥½ + å†å²       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

**PERMA äº”ç»´å®šä¹‰**:

| ç»´åº¦ | è‹±æ–‡ | å«ä¹‰ | æ•°æ®æ¥æº |
|------|------|------|----------|
| P | Positive Emotion | ç§¯ææƒ…ç»ª | fortune_checkin |
| E | Engagement | æŠ•å…¥ | ä»»åŠ¡å®Œæˆç‡ |
| R | Relationships | å…³ç³» | ç¤¾äº¤äº’åŠ¨ |
| M | Meaning | æ„ä¹‰ | ç›®æ ‡å…³è”åº¦ |
| A | Accomplishment | æˆå°± | ç´¯è®¡å®Œæˆä»»åŠ¡ |

### 1.2 å½“å‰å®ç°æ¶æ„ âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä½¿ç”¨ v2 å››å±‚æœ¯è¯­ï¼Œä¿ç•™ä½œä¸ºä»£ç å®ç°çš„å‚è€ƒæ˜ å°„ã€‚
> **âœ… æ–°æœ¯è¯­**: L0â†’L0 Base, L1â†’L1 Module, L2â†’L2 Expert, L3â†’Interaction Layer

```mermaid
graph LR
    subgraph Services["services/"]
        SoulOS["soul_os.py<br/>æ ¸å¿ƒåè°ƒå™¨"]

        subgraph L0_Impl["L0 å®ç° âœ…"]
            L0Facts["get_l0_facts()"]
            BaziSvc["bazi_service.py"]
        end

        subgraph L1_Impl["L1 å®ç° âœ…"]
            L1Schema["get_l1_schema()"]
            PERMA_Calc["calculate_perma()"]
            StateCalc["calculate_state_score()"]
        end

        subgraph L2_Impl["L2 å®ç° âš ï¸"]
            KBSearch["search_knowledge_base()"]
            AntiDep["check_anti_dependency()"]
        end

        subgraph L3_Impl["L3 å®ç° âœ…"]
            PromptBuild["build_system_prompt()"]
            GLMClient["glm_client.py"]
        end
    end

    SoulOS --> L0Facts
    SoulOS --> L1Schema
    SoulOS --> KBSearch
    SoulOS --> PromptBuild

    L0Facts --> BaziSvc
    L1Schema --> PERMA_Calc
    L1Schema --> StateCalc
    PromptBuild --> GLMClient

    style L0_Impl fill:#d4edda
    style L1_Impl fill:#d4edda
    style L2_Impl fill:#fff3cd
    style L3_Impl fill:#d4edda
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å½“å‰å®ç°æ¶æ„ (services/)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      soul_os.py (æ ¸å¿ƒåè°ƒå™¨)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚     â”‚     â”‚     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                            â”‚     â”‚                            â”‚
    â–¼                            â–¼     â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L0 å®ç° âœ…         â”‚  â”‚ L1 å®ç° âœ…         â”‚  â”‚ L2 å®ç° âš ï¸                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ get_l0_facts()â”‚ â”‚  â”‚ â”‚ get_l1_schemaâ”‚ â”‚  â”‚ â”‚ search_knowledge_base()â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚         â”‚  â”‚         â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â–¼         â”‚  â”‚         â–¼         â”‚  â”‚ â”‚ check_anti_dependency()â”‚   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”‚ bazi_service  â”‚ â”‚  â”‚ â”‚ calculate_    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ .py           â”‚ â”‚  â”‚ â”‚ perma()       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚
                       â”‚ â”‚ calculate_    â”‚ â”‚            â”‚
                       â”‚ â”‚ state_score() â”‚ â”‚            â–¼
                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ L3 å®ç° âœ…                    â”‚
                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                              â”‚ â”‚ build_system_prompt()  â”‚   â”‚
                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                              â”‚             â–¼                â”‚
                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                              â”‚ â”‚ glm_client.py          â”‚   â”‚
                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹: âœ… å®Œæ•´å®ç° | âš ï¸ éƒ¨åˆ†å®ç°
```
</details>

**å®ç°çŠ¶æ€çŸ©é˜µ**:

| å±‚çº§ | ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|:----:|------|
| L0 | çœŸå¤ªé˜³æ—¶æ ¡æ­£ | âœ… | swisseph |
| L0 | å››æŸ±æ’ç›˜ | âœ… | lunar_python |
| L0 | åç¥/ç¥ç…/å¤§è¿ | âœ… | å®Œæ•´å®ç° |
| L0 | facts_hash | âœ… | å¯è¿½æº¯ |
| L1 | PERMA äº”ç»´ | âœ… | è®¡ç®—æ­£ç¡® |
| L1 | State Score | âœ… | èšåˆæ­£ç¡® |
| L1 | è¡Œä¸ºè¯æ®å…³è” | âš ï¸ | å¾…å¢å¼º |
| L2 | çŸ¥è¯†åº“æ£€ç´¢ | âœ… | FTS + trgm |
| L2 | å¤šAgentå¹¶è¡Œ | âš ï¸ | ä»…å…«å­—Agent |
| L3 | GLM è¾“å‡º | âœ… | A2UI JSON |
| L3 | If-Then å¤„æ–¹ | âœ… | æ ¼å¼æ­£ç¡® |

### 1.3 æœ€ä¼˜æ¶æ„ (å®Œæ•´å››å±‚ + ç›®æ ‡/å¤ç›˜é—­ç¯) âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚å±•ç¤º v2 å››å±‚æ—¶åºæµç¨‹ï¼Œä¿ç•™ä½œä¸ºå¯¹è¯æµç¨‹çš„å‚è€ƒã€‚
> **âœ… æ–°æ¶æ„æ˜ å°„**:
> - L0æ•°å­¦è„‘ â†’ L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ)
> - L1å¿ƒç†è„‘ â†’ L1 Module Data (PERMA/å…«å­—ç­‰å¯æ’æ‹”æ•°æ®)
> - L2çŸ¥è¯†è„‘ â†’ L2 Expert Agents (å…«å­—Agent/CBT Agentç­‰)
> - L3è¯­è¨€è„‘ â†’ Context Management + Interaction Layer (å¤šæ¨¡å‹)

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯<br/>(Zone A/B)
    participant API as FastAPI<br/>/api/*
    participant OS as Soul OS<br/>åè°ƒå™¨
    participant L0 as L0 æ•°å­¦è„‘
    participant L1 as L1 å¿ƒç†è„‘
    participant L2 as L2 çŸ¥è¯†è„‘
    participant L3 as L3 è¯­è¨€è„‘
    participant DB as PostgreSQL

    U->>FE: è¾“å…¥æ¶ˆæ¯
    FE->>API: POST /api/chat/send

    rect rgb(240, 248, 255)
        Note over OS,L2: get_full_context(user_id)
        API->>OS: è¯·æ±‚ä¸Šä¸‹æ–‡
        OS->>L0: get_l0_facts()
        L0-->>OS: å…«å­— facts
        OS->>L1: get_l1_schema()
        L1-->>OS: PERMA + State Score
        OS->>L2: search_knowledge_base()
        L2-->>OS: kb_refs + rule_ids
        OS->>DB: get_active_goals()
        DB-->>OS: æ´»è·ƒç›®æ ‡åˆ—è¡¨
    end

    rect rgb(255, 248, 240)
        Note over OS,L3: L3 Synthesis
        OS->>L3: System Prompt + context
        L3-->>OS: A2UI JSON<br/>(â‰¤3 If-Then å¤„æ–¹)
    end

    OS->>DB: INSERT conversation_message
    OS->>DB: INSERT commitment (suggested)
    OS-->>FE: A2UI å“åº”

    FE->>FE: Zone A æ¸²æŸ“æ¶ˆæ¯
    FE->>FE: Zone B åˆ·æ–°ä»»åŠ¡
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ€ä¼˜å››å±‚æ¶æ„ + ç›®æ ‡/å¤ç›˜é—­ç¯                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·    å‰ç«¯Zone    FastAPI    SoulOS    L0æ•°å­¦    L1å¿ƒç†    L2çŸ¥è¯†    L3è¯­è¨€    DB
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚â”€â”€è¾“å…¥â”€â–¶â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€POSTâ”€â”€â”€â”€â–¶â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚ chat/send â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚ get_full_context(user_id)     â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€è¯·æ±‚ä¸Šä¸‹æ–‡â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_l0_facts()â”€â”€â–¶â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€å…«å­— factsâ”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_l1_schema()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€PERMA + State Scoreâ”€â”€â”€â”€â”€â”€â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€search_kb()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€kb_refs + rule_idsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_active_goals()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€ç›®æ ‡åˆ—è¡¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚ L3 Synthesis        â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€System Prompt + contextâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€A2UI JSON (â‰¤3 If-Then å¤„æ–¹)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT conversation_messageâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT commitment (suggested)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â—€â”€â”€A2UI å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€Zone A æ¸²æŸ“æ¶ˆæ¯      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€Zone B åˆ·æ–°ä»»åŠ¡      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
```
</details>

**ä¼˜åŒ–é¡¹**:

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | è¯´æ˜ |
|:------:|--------|------|
| P0 | action_buttons + CSRF | å‰ç«¯ç‚¹å‡»å¤„ç† |
| P1 | anti-dependency è±å… | æ–°ç”¨æˆ· 7 å¤©è±å… |
| P1 | å¤„æ–¹å…³è”ç›®æ ‡ | è‡ªåŠ¨å…³è”æ´»è·ƒç›®æ ‡ |
| P2 | å¤šAgentå¹¶è¡Œ | å…«å­—/å¿ƒç†/è¡ŒåŠ¨ Agent |
| P2 | å…¨é“¾è·¯è¿½è¸ª | correlation_id |

### 1.4 è¿›åŒ–è®°å¿†æ¶æ„ (Evolutionary Memory View) - v4.0

> **v4.0 æ ¸å¿ƒ**: åŒè·¯å¾„è®¾è®¡ (Hot Path + Cold Path) + Insight & Memory Agent
> **é‡æ„æ–¹æ¡ˆ**: è¯¦è§ [restructure_v3.md](./restructure_v3.md)

```
+-----------------------------------------------------------------------------------+
|                            Soul OS Architecture v4.0                              |
|                       (Dynamic Profiling & Evolutionary Loop)                     |
+-----------------------------------------------------------------------------------+
                                       ^
                           1. äº¤äº’/å“åº” (Hot Path < 2s)
+-----------------------------------------------------------------------------------+
|  Interaction Layer (å¯é…ç½®æ¨¡å‹å±‚)                                                 |
+-----------------------------------------------------------------------------------+
|  [ Framework: Vercel SDK / LangChain ]                                            |
|  [ LLM Core:  GLM-4 / Gemini / GPT-4o / Claude ]  <-- åŠ¨æ€é€‰æ‹©                    |
+-----------------------------------------------------------------------------------+
                                       ^
                                       | ç»„è£…åçš„ Context (Prompt + Data)
+-----------------------------------------------------------------------------------+
|  Context Management v4.0 (ä¸Šä¸‹æ–‡ç®¡ç†ä¸è·¯ç”±)                                       |
+-----------------------------------------------------------------------------------+
|   ^                                  ^                                        ^   |
|   | (Inject Style)                   | (Inject Expert Knowledge)              |   |
+---|----------------------------------|----------------------------------------|---+
    |                                  |
+---+----------------------------+ +---+----------------------------------------+---+
| L2: Style Agents (é£æ ¼/è¯­æ°”)   | | L2: Expert Agents (ä¸“å®¶æ¨¡å—/Prompt+çŸ¥è¯†åº“)     |
| (Prompt Templates)             | | (Domain Specific Prompts + Knowledge Base)     |
+--------------------------------+ +------------------------------------------------+
|                                | | [å¯æ’æ‹”/Pluggable Modules]                     |
|  +----------+ +----------+     | |                                                |
|  | Standard | |  Warm    |     | | +--------+  +--------+  +--------+  +--------+ |
|  | (æ ‡å‡†)   | | (æ¸©æš–)   |     | | |  å…«å­—  |  |  ç´«å¾®  |  |  æ˜Ÿåº§  |  |  CBT   | |
|  +----------+ +----------+     | | | Agent  |  | Agent  |  | Agent  |  | Agent  | |
|  +----------+                  | | +--------+  +--------+  +--------+  +--------+ |
|  |  Roast   |                  | |                                                |
|  | (æ¯’èˆŒ)   |                  | | +--------+  +--------+  +--------+             |
|  +----------+                  | | | PERMA  |  | Covey  |  | ...... |             |
|                                | | | Agent  |  | (7Hab) |  | (More) |             |
|                                | | +--------+  +--------+  +--------+             |
+--------------------------------+ +------------------------------------------------+
                                       ^
                                       | 2. è¯»å–å¯¹åº”æ¨¡å—æ•°æ® (Hot Path)
                                       | 3. åå†™æ›´æ–° (Cold Path - å¼‚æ­¥)
+--------------------------------------+--------------------------------------------+
| L1: Module Data Layer (å„æ¨¡å—ç‹¬ç«‹æ•°æ®å±‚)                                          |
| (Structured Data Schemas / JSON)                                                  |
+-----------------------------------------------------------------------------------+
|  [å¯æ’æ‹”/Pluggable Data]                                                          |
|                                                                                   |
|  +-------------+   +-------------+   +-------------+   +-------------+            |
|  | å…«å­—æ’ç›˜æ•°æ®|   | ç´«å¾®æ–—æ•°ç›˜  |   | æ˜Ÿåº§/æ˜Ÿç›˜   |   | PERMA é‡è¡¨  |            |
|  | (GanZhi)    |   | (Ziwei Map) |   | (Astro map) |   | (Scores)    |            |
|  +-------------+   +-------------+   +-------------+   +-------------+            |
|                                                                                   |
|  +-------------+   +-------------+   +-------------+                              |
|  | Covey è¿›åº¦  |   | Kçº¿æ•°æ®     |   | å…¶ä»–ä¸šåŠ¡æ•°æ®|                              |
|  | (Habits)    |   | (OHLC)      |   | (Ext Data)  |                              |
|  +-------------+   +-------------+   +-------------+                              |
+-----------------------------------------------------------------------------------+
                                       ^
                                       | åŸºç¡€ä¾èµ–
+--------------------------------------+--------------------------------------------+
| L0: Base Data Layer (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ)                                                |
| (Global User Profile - å¯åå†™/åŠ¨æ€ä¸°æ»¡)                                           |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +---------------------+    +---------------------+    +---------------------+   |
|   |      åŸºç¡€ä¿¡æ¯       |    |       ç”¨æˆ·åå¥½      |    |       å½“å‰çŠ¶æ€      |   |
|   | (Basic Info: DOB/   |    | (Preferences: Tags/ |    | (Status: Mood/      |   |
|   |  Gender/Location)   |    |  Topics/Goals)      |    |  Lifecycle Stage)   |   |
|   +---------------------+    +---------------------+    +---------------------+   |
|                                                                                   |
|                       +---------------------------+                               |
|                       |         å†å²å¯¹è¯          |                               |
|                       | (Conversation History)    |                               |
|                       +---------------------------+                               |
+-----------------------------------------------------------------------------------+
                                       ^
                                       | 4. æ´å¯Ÿä¸æ›´æ–° (Cold Path - åå°å¼‚æ­¥)
+--------------------------------------+--------------------------------------------+
| Insight & Memory Agent (æ´å¯Ÿä¸è®°å¿†ç®—å­)                                           |
| (åå°è¿è¡Œï¼Œä»éç»“æ„åŒ–å¯¹è¯èƒå–ç»“æ„åŒ–æ•°æ®)                                          |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +-----------------------------------+    +-----------------------------------+   |
|   |   L0 Updates (ç”»åƒä¸°æ»¡)           |    |   L1 Updates (æ¨¡å—æ•°æ®ç§¯ç´¯)       |   |
|   | - profile.job = "PM"              |    | - bazi.è¿åŠ¿è§£è¯»å†å²              |   |
|   | - style_preference.roast = 0.8    |    | - perma.ç§¯æäº‹ä»¶è®°å½•             |   |
|   | - current_status = "anxious"      |    | - cbt.è§¦å‘å™¨ä¸åº”å¯¹ç­–ç•¥           |   |
|   +-----------------------------------+    +-----------------------------------+   |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

**æ¶æ„å±‚æ¬¡è¯´æ˜ (v4.0)**:

| å±‚çº§ | å®šä¹‰ | èŒè´£ | è·¯å¾„ | å¯æ›´æ–° |
|------|------|------|------|:------:|
| Interaction | æ¨¡å‹ä¸æ¡†æ¶é…ç½®å±‚ | GLM/Gemini åŠ¨æ€é€‰æ‹© | Hot | - |
| Context Mgmt v4.0 | ä¸Šä¸‹æ–‡ç»„è£…å·¥å‚ | L0+L1+History+Input èåˆ | Hot | - |
| **Insight Agent** | æ´å¯Ÿä¸è®°å¿†ç®—å­ | ä»å¯¹è¯èƒå–ç»“æ„åŒ–æ•°æ® | **Cold** | - |
| L2 Expert | ä¸“å®¶æ¨¡å— (Prompt + KB) | å…«å­—ã€PERMAã€CBT ç­‰ | Hot | - |
| L2 Style | é£æ ¼æ¨¡å— (Prompt) | æ ‡å‡†ã€æ¸©æš–ã€æ¯’èˆŒ | Hot | - |
| L1 Module Data | å„æ¨¡å—ç‹¬ç«‹æ•°æ®å±‚ | å…«å­—ã€PERMAã€Covey ç­‰ | Hot+Cold | âœ… å¯åå†™ |
| L0 Base Data | ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ | åŸºç¡€ä¿¡æ¯ã€åå¥½ã€çŠ¶æ€ | Hot+Cold | âœ… å¯åå†™ |

**å…³é”®è®¾è®¡åŸåˆ™ (v4.0)**:

1. **Hot Path (åŒæ­¥)**: è¯»å– L0/L1 â†’ ç»„è£… Context â†’ ç”Ÿæˆå›å¤ï¼Œè¿½æ±‚ä½å»¶è¿Ÿ (<2s)
2. **Cold Path (å¼‚æ­¥)**: åˆ†æäº¤äº’å†å² â†’ æå–äº‹å®/åå¥½/çŠ¶æ€ â†’ åå†™ L0/L1
3. **Insight Agent**: åå°è¿è¡Œçš„æ´å¯Ÿç®—å­ï¼Œè´Ÿè´£æ•°æ®æ²‰æ·€ä¸ç”»åƒä¸°æ»¡
4. **Context Manager v4.0**: ç»„è£… `L0(Status) + L1(Module) + Vector(History) + Input`
5. **æˆé•¿æ€§ç³»ç»Ÿ**: Soul OS è¶Šç”¨è¶Šæ‡‚ç”¨æˆ·ï¼Œè¶Šç”¨æ•°æ®è¶Šåš

---

## 2. è®°å¿†æ²‰æ·€ä¸è¿›åŒ–å›è·¯ (Memory Sedimentation & Evolutionary Loop)

> **v4.0 æ ¸å¿ƒå‡çº§**: Soul OS ä¸å†æ˜¯å•å‘çš„"è¯»å–æ•°æ® â†’ ç”Ÿæˆå›ç­”"ï¼Œè€Œæ˜¯åŒå‘é—­ç¯çš„**è¿›åŒ–ç³»ç»Ÿ**ã€‚
> **æ‰¿è¯ºçŠ¶æ€æœº**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§5
> **åŒ—ææ˜ŸæŒ‡æ ‡**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§10 WCG

### 2.1 åŒè·¯å¾„æ¶æ„ (Hot Path + Cold Path)

| è·¯å¾„ | ç±»å‹ | èŒè´£ | å»¶è¿Ÿè¦æ±‚ |
|------|------|------|----------|
| **Hot Path** | åŒæ­¥ | è¯»å– L0/L1 â†’ ç»„è£… Context â†’ ç”Ÿæˆå›å¤ | <2s (è¿½æ±‚ä½å»¶è¿Ÿ) |
| **Cold Path** | å¼‚æ­¥ | åˆ†æäº¤äº’å†å² â†’ æå–äº‹å®/åå¥½/çŠ¶æ€ â†’ åå†™ L0/L1 | åå°å¤„ç† |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               Soul OS Architecture v4.0                                 â”‚
â”‚                       (Dynamic Profiling & Evolutionary Loop)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            ^
                                            |  1. äº¤äº’/å“åº” (Response)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Interaction Layer (äº¤äº’å±‚ - Vercel SDK / Chat UI)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [LLM Core: GLM/GPT] â”‚  <-- å®æ—¶å¯¹è¯æµ (Stream) -->   â”‚  2. å¼‚æ­¥æŠ•é€’ (Async Queue)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           ^                                                              |
           | 3. æ³¨å…¥ Context                                              v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Manager (ä¸Šä¸‹æ–‡ç»„è£…å·¥å‚)        â”‚         â”‚  Memory & Insight Pipeline         â”‚
â”‚  (Prompt Engineering / Context Window)   â”‚         â”‚  (æ•°æ®æ²‰æ·€/ETLæµæ°´çº¿)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    ^                   ^                            â”‚  * ç‹¬ç«‹è¿è¡Œçš„åå° Agent            â”‚
    | (Load Prompts)    | (Load Data)                â”‚  * ä»»åŠ¡: æå–äº‹å®, æ„ŸçŸ¥æƒ…ç»ª        â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  * å·¥å…·: NLP / Classification      â”‚
â”‚ L2: Agents Layer (Prompt/Strategy)       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                           |
â”‚ â”‚ Style Agents   â”‚  â”‚ Expert Agents    â”‚ â”‚                           |
â”‚ â”‚ (Tone/Persona) â”‚  â”‚ (Domain Know.)   â”‚ â”‚                           |
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                           |
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           |
                                                                       |
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            |  4. Data Write Back (æ•°æ®åå†™/æ›´æ–°)
            |  (ç»“æ„åŒ–æå– -> æ˜ å°„åˆ°å¯¹åº” Schema)
            v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: Module Data Layer (å‚ç±»æ•°æ®å±‚)  <-- [Update by Insight Agent]                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ›´æ–°é€»è¾‘: æå–ç‰¹å®šé¢†åŸŸçš„åŠ¨æ€æ•°æ®]                                                      â”‚
â”‚                                                                                         â”‚
â”‚  â”œâ”€â–º (Update) [å…«å­—/ç´«å¾®] ä¿®æ­£å‡ºç”Ÿæ—¶é—´ï¼Œè®°å½•æµæœˆè¿åŠ¿éªŒè¯åé¦ˆ                             â”‚
â”‚  â”œâ”€â–º (Update) [PERMA]    è¯†åˆ«ç”¨æˆ·å½“ä¸‹çš„ E/R ç»´åº¦å¾—åˆ†å˜åŒ–ï¼Œæ›´æ–°åˆ†æ•°                       â”‚
â”‚  â”œâ”€â–º (Update) [Covey]    è¯†åˆ«ç”¨æˆ·å®Œæˆäº†"è¦äº‹ç¬¬ä¸€"çš„ä»»åŠ¡ï¼Œæ‰“é’©/æ›´æ–°è¿›åº¦                   â”‚
â”‚  â””â”€â–º (Update) [CBT/æƒ…ç»ª] è®°å½•æœ¬æ¬¡ Trigger äº‹ä»¶ï¼Œå½’æ¡£åˆ°æƒ…ç»ªæ—¥å¿—                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            |
            v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L0: Base Data Layer (ç”¨æˆ·åŸºåº§) <-- [Update by Insight Agent]                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ›´æ–°é€»è¾‘: å…¨å±€é€šç”¨ä¿¡æ¯çš„æ²‰æ·€]                                                          â”‚
â”‚                                                                                         â”‚
â”‚  â”œâ”€â–º (Update) [åŸºç¡€ä¿¡æ¯] ç”¨æˆ·æ— æ„ä¸­æåˆ°"æˆ‘ä¸‹å‘¨å»ä¸Šæµ·" â†’ æ›´æ–° Location/Plan               â”‚
â”‚  â”œâ”€â–º (Update) [åå¥½/Tags] ç”¨æˆ·è¯´"åˆ«ç»™æˆ‘è®²å¤§é“ç†" â†’ Tag: Hate_Preaching                   â”‚
â”‚  â”œâ”€â–º (Update) [å½“å‰çŠ¶æ€] è¿ç»­3æ¬¡å¯¹è¯è¯­æ°”ä½è½ â†’ Status: Depressed â†’ å½±å“L2ç­–ç•¥            â”‚
â”‚  â””â”€â–º (Update) [å†å²æ‘˜è¦] å°†é•¿å¯¹è¯ Summary å­˜å…¥ Long-term Memory                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒä»·å€¼**: Soul OS å…·å¤‡**æˆé•¿æ€§**ã€‚å®ƒè¶Šç”¨è¶Šæ‡‚ç”¨æˆ·ï¼Œè¶Šç”¨æ•°æ®è¶Šåšã€‚

### 2.2 Insight & Memory Agent (æ´å¯Ÿä¸è®°å¿†ç®—å­)

> **æ–°æ ¸å¿ƒç»„ä»¶**: åœ¨åå°è¿è¡Œï¼Œè´Ÿè´£ä»éç»“æ„åŒ–å¯¹è¯ä¸­"èƒå–"ç»“æ„åŒ–æ•°æ®ã€‚

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant Chat as Chat API
    participant LLM as Interaction Layer
    participant Queue as Async Queue
    participant Insight as Insight Agent
    participant L1 as L1 Module Data
    participant L0 as L0 Base Data

    User->>Chat: å‘é€æ¶ˆæ¯
    Chat->>LLM: Hot Path (åŒæ­¥)
    LLM-->>Chat: A2UI å“åº”
    Chat-->>User: è¿”å›å›å¤

    Note over Chat,Queue: Cold Path å¼€å§‹ (å¼‚æ­¥)
    Chat->>Queue: æŠ•é€’å¯¹è¯è®°å½•

    Queue->>Insight: è§¦å‘åˆ†æ
    Insight->>Insight: NLP æå–äº‹å®/æƒ…ç»ª/åå¥½

    alt å‘ç°é¢†åŸŸæ•°æ®
        Insight->>L1: æ›´æ–° PERMA/Covey/å…«å­—
    end

    alt å‘ç°é€šç”¨ä¿¡æ¯
        Insight->>L0: æ›´æ–° Profile/Tags/Status
    end
```

**Insight Agent é…ç½®**:

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| è§¦å‘æ—¶æœº | å¯¹è¯ç»“æŸ / ç´¯è®¡ N è½® | é¿å…å®æ—¶åˆ†æå¡é¡¿ |
| æ‰§è¡Œæ¨¡å‹ | GLM-3-Turbo / GPT-3.5 | è½»é‡æ¨¡å‹èŠ‚çœæˆæœ¬ |
| æ ¸å¿ƒ Prompt | è§ä¸‹æ–¹ | ç»“æ„åŒ–æå–æŒ‡ä»¤ |

**Insight Agent System Prompt**:

```
åˆ†æåˆšæ‰çš„å¯¹è¯ã€‚è¯·è¾“å‡º JSON æ ¼å¼çš„æ›´æ–°æŒ‡ä»¤ï¼š
{
  "l0_updates": {
    "profile": { "location": "ä¸Šæµ·", "upcoming_event": "ä¸‹å‘¨å‡ºå·®" },
    "tags": ["Hate_Preaching", "Prefer_Direct"],
    "status": "stressed",
    "summary": "ç”¨æˆ·æ­£åœ¨å¤„ç†å·¥ä½œå‹åŠ›ï¼Œå¯¹é•¿ç¯‡å¤§è®ºåæ„Ÿ"
  },
  "l1_updates": {
    "perma": { "E": -0.1, "R": 0 },
    "covey": { "task_id": "xxx", "status": "done" },
    "emotion_log": { "trigger": "deadline_pressure", "intensity": 0.7 }
  }
}

è§„åˆ™ï¼š
1. ç”¨æˆ·æ˜¯å¦æä¾›äº†æ–°çš„ä¸ªäººä¿¡æ¯ï¼Ÿ
2. ç”¨æˆ·æ˜¯å¦è¡¨è¾¾äº†å¯¹æŸä¸ªå»ºè®®çš„å–œå¥½ï¼Ÿ
3. ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€å¦‚ä½•ï¼Ÿ
4. ç”¨æˆ·æ˜¯å¦å®Œæˆäº†æŸä¸ª L1 æ¨¡å—çš„ä»»åŠ¡ï¼Ÿ
5. ä»…è¾“å‡ºæœ‰å˜åŒ–çš„å­—æ®µ
```

### 2.3 L1 åŠ¨æ€æ›´æ–°åœºæ™¯

| åœºæ™¯ | ç”¨æˆ·è¾“å…¥ | Insight Agent Action |
|------|----------|---------------------|
| **Covey ä»»åŠ¡å®Œæˆ** | "æˆ‘ç»ˆäºæŠŠé‚£ä¸ªéš¾æçš„æŠ¥å‘Šå†™å®Œäº†" | è°ƒç”¨ L1 Covey APIï¼ŒTask â†’ Done |
| **è¿åŠ¿éªŒè¯åé¦ˆ** | "ä½ è¯´æˆ‘è¿™å‘¨è¿åŠ¿å·®ï¼Œç¡®å®ä¸¢äº†é’±åŒ…" | L1 è¿åŠ¿è®°å½•æ ‡è®° `User_Feedback: Validated` |
| **PERMA å˜åŒ–** | "æœ€è¿‘å’ŒåŒäº‹å…³ç³»å¥½å¤šäº†" | L1 PERMA `R` ç»´åº¦ +0.2 |
| **CBT æƒ…ç»ªå½’æ¡£** | "ä¸€æƒ³åˆ°æ±‡æŠ¥å°±ç„¦è™‘" | L1 CBT è®°å½• Trigger: presentation_anxiety |

### 2.4 L0 ç”»åƒä¸°æ»¡æœºåˆ¶

| ç±»å‹ | æå–æ–¹å¼ | ç¤ºä¾‹ |
|------|----------|------|
| **æ˜¾æ€§æå–** | ç”¨æˆ·ç›´æ¥é™ˆè¿° | "æˆ‘æ˜¯äº§å“ç»ç†" â†’ `job: PM` |
| **éšæ€§æ¨æ–­** | å¤šæ¬¡è¡Œä¸ºåˆ†æ | å¤šæ¬¡å¯¹ Roast æ¨¡å¼ååº”ç§¯æ â†’ `style_preference: { roast: 0.8 }` |
| **çŠ¶æ€æ„ŸçŸ¥** | æƒ…ç»ªè¯†åˆ« | è¿ç»­ 3 æ¬¡ä½è½è¯­æ°” â†’ `current_status: depressed` |

**Status å­—æ®µçš„å½±å“**:

```
L0.current_status = "depressed"
    â†“
Context Manager è¯»å– Status
    â†“
å¼ºåˆ¶è·¯ç”±åˆ° L2 Style Agents (Warm æ¨¡å¼)
    â†“
Interaction Layer ä½¿ç”¨æ¸©æš–è¯­æ°”å›å¤
```

### 2.5 Context Manager è¿›åŒ–

| ç‰ˆæœ¬ | Context ç»„æˆ |
|------|--------------|
| **v3.x** | `System Prompt + User Input` |
| **v4.0** | `System Prompt + L0(Status) + L1(Relevant Module) + Vector Search(History) + User Input` |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Manager v4.0 ç»„è£…æµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. è¯»å– L0 Status/Tags        â†’ å…¨å±€çŠ¶æ€ + åå¥½                 â”‚
â”‚  2. è¯»å– L1 Relevant Module    â†’ å½“å‰è¯é¢˜ç›¸å…³çš„æ¨¡å—æ•°æ®          â”‚
â”‚  3. Vector Search History      â†’ ç›¸å…³å†å²å¯¹è¯ (Long-term Memory) â”‚
â”‚  4. ç”¨æˆ·å½“å‰è¾“å…¥               â†’ User Input                      â”‚
â”‚                                                                  â”‚
â”‚        â†“ æ‹¼è£…                                                    â”‚
â”‚                                                                  â”‚
â”‚  Final Context = [L0 Status] + [L1 Data] + [History] + [Input]  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.6 WCG é—­ç¯éªŒæ”¶ (ä¿ç•™)

> **æ‰¿è¯ºçŠ¶æ€æœº**: suggested â†’ active â†’ done

| æ­¥éª¤ | Hot/Cold | è¯´æ˜ |
|------|----------|------|
| 1. Clarify | Hot | Context Manager ç»„è£… |
| 2. Insight | Hot | L2 Expert Agents åˆ†æ |
| 3. Prescription | Hot | ç”Ÿæˆ If-Then å¤„æ–¹ |
| 4. Commitment | Hot | action_button è§¦å‘ |
| 5. Action | - | ç”¨æˆ·æ‰§è¡Œ |
| 6. Reflection | Cold | Insight Agent åˆ†æç»“æœ |
| 7. Memory | Cold | åå†™ L0/L1 |

**WCG éªŒæ”¶æ ‡å‡†**: æ¯å‘¨ â‰¥1 æ¬¡å®Œæ•´é—­ç¯ (Clarify â†’ Prescription â†’ Commitment â†’ Action â†’ Reflection)

---

## 3. API å®ç°çŠ¶æ€æ˜ å°„

### 3.1 Goal æ¨¡å—

| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
|------|------|------|------|
| `POST /api/goal/create` | âœ… | âœ… | åˆ›å»ºç›®æ ‡ |
| `GET /api/goal/list` | âœ… | âœ… | ç›®æ ‡åˆ—è¡¨ |
| `GET /api/goal/{goal_id}` | âœ… | âœ… | ç›®æ ‡è¯¦æƒ… |
| `PUT /api/goal/{goal_id}` | âœ… | âœ… | æ›´æ–°ç›®æ ‡ |
| `POST /api/goal/{goal_id}/link` | âœ… | âš ï¸ | å¾…å®Œå–„ |

### 3.2 Reflection æ¨¡å—

| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
|------|------|------|------|
| `POST /api/reflection/create` | âœ… | âœ… | åˆ›å»ºå¤ç›˜ |
| `GET /api/reflection/list` | âœ… | âœ… | å¤ç›˜åˆ—è¡¨ |
| `GET /api/reflection/prompt` | âœ… | âœ… | è·å–å¼•å¯¼é—®é¢˜ |

---

## 4. éªŒæ”¶æŒ‡æ ‡å¯¹æ¯”

### 4.1 WCG æŒ‡æ ‡

```sql
-- è®¾è®¡: WCG éªŒæ”¶æŸ¥è¯¢
WITH weekly_loop AS (
  SELECT
    user_id,
    DATE_TRUNC('week', created_at) AS week,
    BOOL_OR(accepted_at IS NOT NULL) AS has_commitment,
    BOOL_OR(status = 'done') AS has_action
  FROM fortune_commitment
  GROUP BY user_id, DATE_TRUNC('week', created_at)
)
SELECT
  user_id,
  week,
  (has_commitment AND has_action) AS wcg_achieved
FROM weekly_loop;

-- å½“å‰çŠ¶æ€: åç«¯æ•°æ®å¯æŸ¥è¯¢, å‰ç«¯é—­ç¯å¾…ä¿®å¤
```

### 4.2 æ–°å¢éªŒæ”¶æŒ‡æ ‡

| æŒ‡æ ‡ | å®šä¹‰ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|------|------|------|----------|
| ç›®æ ‡è®¾å®šç‡ | 7å¤©å†…è®¾å®šâ‰¥1ç›®æ ‡ | â‰¥30% | âš ï¸ å¾…ç»Ÿè®¡ |
| å¤ç›˜å®Œæˆç‡ | æ¯å‘¨â‰¥1æ¬¡å¤ç›˜ | â‰¥20% | âš ï¸ å¾…ç»Ÿè®¡ |
| Check-in ä½¿ç”¨ç‡ | æ¯å‘¨â‰¥1æ¬¡æ‰“å¡ | â‰¥40% | âœ… åç«¯å¯ç”¨ |
| A2UI ç‚¹å‡»ç‡ | action_buttons è¢«ç‚¹å‡» | â‰¥50% | âš ï¸ å‰ç«¯é—®é¢˜ |

---

## 5. æ€»ç»“

### 5.1 è®¾è®¡ vs å®ç°ä¸€è‡´æ€§

```
L0 Base Data:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
L1 Module Data:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%   â† å…«å­—/PERMA å°±ç»ªï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç°
L2 Expert Agents:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%   â† ä»…å…«å­— Agent
L2 Style Agents:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%   â† standard/warm/roast
Context Management: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
Interaction Layer:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%   â† GLM ä¸ºä¸»ï¼Œå¤šæ¨¡å‹å¾…å®Œå–„
Goal æ¨¡å—:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
Reflection:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
å‰ç«¯é—­ç¯:           â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40%   â† ä¸»è¦å·®è·
```

### 5.2 å…³é”®å·®è·

| å·®è· | å½±å“ | ä¼˜å…ˆçº§ | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|----------|
| å‰ç«¯ CSRF | é—­ç¯æ–­è£‚ | P0 | ä¿®å¤ api.ts |
| action_buttons | æ— æ³•ç‚¹å‡» | P0 | å®Œå–„æ¸²æŸ“ |
| anti-dependency | æ–°ç”¨æˆ·è¢«æˆªæ–­ | P1 | æ·»åŠ è±å… |
| L2 Expert æ¨¡å— | ä»…å…«å­— Agent | P2 | æ·»åŠ ç´«å¾®/æ˜Ÿåº§/CBT Agent |
| Interaction å¤šæ¨¡å‹ | GLM å•ä¸€ | P2 | å®Œå–„ Gemini/Claude åˆ‡æ¢ |

### 5.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **P0**: ä¿®å¤å‰ç«¯ CSRF â†’ æ¢å¤é—­ç¯
2. **P0**: å®Œå–„ action_buttons å¤„ç†
3. **P1**: å®ç° anti-dependency æ–°ç”¨æˆ·è±å…
4. **P1**: æ·»åŠ å¤ç›˜å…¥å£åˆ° Dashboard
5. **P2**: æ‰©å±• L2 Expert Agentsï¼ˆç´«å¾®/æ˜Ÿåº§/CBTï¼‰
6. **P2**: Interaction Layer å¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢

---

*æ–‡æ¡£ç‰ˆæœ¬: v3.1 (Context Driven Architecture)*
*æ›´æ–°æ—¥æœŸ: 2026-01-01*
*æµ‹è¯•ç¯å¢ƒ: http://106.37.170.238:8231/new*
