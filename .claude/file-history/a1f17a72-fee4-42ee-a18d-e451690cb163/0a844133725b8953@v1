# Fortune AI 核心功能模块设计 - 修订版 2026-01-01

> **定位**: 基于四层心理架构 (L0-L3) 的可执行功能模块
>
> **入口**: http://106.37.170.238:8231/new
>
> **本版更新**: 设计 vs 实现对比 + 最优方案建议 + 代码问题清单

---

## 0. 修订总览

### 0.1 模块实现状态矩阵

| 模块 | 设计 | 后端 | 前端 | 阻塞项 |
|------|------|------|------|--------|
| Login 页面 | ✅ Tab + 验证点 | ✅ 已实现 | ✅ 已实现 | - |
| 深度报告 | ✅ 6章结构 | ✅ 已实现 | ✅ 已实现 | - |
| 对话系统 | ✅ A2UI + If-Then | ✅ 已实现 | ⚠️ 部分 | action_buttons |
| 海报生成 | ✅ Gemini 图片 | ✅ 已实现 | ⚠️ 待完善 | 前端调用 |
| K线系统 | ✅ OHLC 蜡烛图 | ⚠️ 部分 | ⚠️ 待实现 | API + 组件 |
| Settings | ✅ 完整设计 | ✅ 已实现 | ⚠️ 待完善 | 页面UI |
| 任务系统 | ✅ 承诺闭环 | ✅ 已实现 | ⚠️ CSRF | 前端修复 |

### 0.2 实施优先级确认

> **命名规范**: 参见 [GLOSSARY.md](../GLOSSARY.md)

```mermaid
graph TB
    subgraph P0_Done["P0 已完成 ✅"]
        direction LR
        L[1. Login页面重构]
        R[2. 深度八字报告]
    end

    subgraph P0_Fix["P0 必须修复 ⚠️"]
        C[3. 前端 CSRF 问题<br/>阻塞所有 POST]
    end

    subgraph P1["P1 高优先级"]
        direction LR
        A[4. action_buttons]
        P[5. 海报前端]
        S[6. Settings UI]
    end

    subgraph P2["P2 中优先级"]
        direction LR
        K[7. K线 API+组件]
        M[8. 合并 Tab]
    end

    P0_Done --> P0_Fix
    P0_Fix --> P1
    P1 --> P2

    style P0_Done fill:#d4edda,stroke:#28a745
    style P0_Fix fill:#f8d7da,stroke:#dc3545
    style P1 fill:#fff3cd,stroke:#ffc107
    style P2 fill:#cce5ff,stroke:#007bff
```

---

## 1. Login 页面流程图对比

### 1.1 设计登录流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    原设计：八字/紫微/星座 Tab + 验证点                       │
└─────────────────────────────────────────────────────────────────────────────┘

  用户访问 /new/register
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                         │
  │  ┌─────────────────────────┐     ┌─────────────────────────────────┐   │
  │  │  [八字] [紫微] [星座]    │     │     专业命盘可视化               │   │
  │  └─────────────────────────┘     │                                 │   │
  │                                  │     ┌──┬──┬──┬──┐               │   │
  │  ┌─────────────────────────┐     │     │年│月│日│时│               │   │
  │  │ 出生信息输入             │     │     └──┴──┴──┴──┘               │   │
  │  │ 日期 [____] 时间 [____] │     │                                 │   │
  │  │ 地点 [北京 ▾]           │     │     [五行雷达图]                 │   │
  │  │          [生成预览]      │     │                                 │   │
  │  └─────────────────────────┘     │                                 │   │
  │                                  └─────────────────────────────────┘   │
  │  ┌─────────────────────────┐                                           │
  │  │ 3个「那就是我」验证点    │     ┌─────────────────────────────────┐   │
  │  │ ✓ "你是不是经常..."     │     │  日主：甲木 · 身强               │   │
  │  │ ✓ "你在人际关系中..."   │     │  有利：金、土                   │   │
  │  │ ✓ "你面对压力时..."     │     │  起运：8岁                      │   │
  │  └─────────────────────────┘     └─────────────────────────────────┘   │
  │                                                                         │
  │  ┌─────────────────────────┐                                           │
  │  │ 邮箱 [_______________]  │                                           │
  │  │ 密码 [_______________]  │                                           │
  │  │ 昵称 [_______________]  │                                           │
  │  │ [注册并保存] [直接登录]  │                                           │
  │  └─────────────────────────┘                                           │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 当前实现登录流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    当前实现：简化版注册页面                                  │
└─────────────────────────────────────────────────────────────────────────────┘

  用户访问 /new/register (web-app/src/app/new/register/page.tsx)
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │                                                                         │
  │  ┌─────────────────────────────────────────────────────────────────┐   │
  │  │                      注册表单                                    │   │
  │  │                                                                 │   │
  │  │  邮箱 [_________________________]                               │   │
  │  │  密码 [_________________________]                               │   │
  │  │  昵称 [_________________________]                               │   │
  │  │  性别 (○) 男  (○) 女                                           │   │
  │  │                                                                 │   │
  │  │  出生日期 [1990-01-01]                                          │   │
  │  │  出生时间 [12:00]                                               │   │
  │  │  时区     [+8:00 ▾]                                             │   │
  │  │  出生地点 [北京 ▾] (经度: 116.4, 纬度: 39.9)                    │   │
  │  │                                                                 │   │
  │  │  [注册]                                                         │   │
  │  │                                                                 │   │
  │  │  已有账号？[登录]                                               │   │
  │  └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘

  实现状态:
  ┌───────────────────────────────────────────────────────────────────────┐
  │ ✅ 基础注册表单                                                       │
  │ ✅ 出生信息输入                                                       │
  │ ✅ 地点选择 (默认北京)                                                │
  │ ⚠️ Tab 切换 (八字/紫微/星座) - 未实现                                 │
  │ ⚠️ 验证点生成 - 未实现                                                │
  │ ⚠️ 命盘预览可视化 - 未实现                                            │
  └───────────────────────────────────────────────────────────────────────┘
```

### 1.3 最优登录流程（建议）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    最优方案：渐进式注册 + 即时反馈                           │
└─────────────────────────────────────────────────────────────────────────────┘

  用户访问 /new/register
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Step 1: 出生信息 (最小必要)                                            │
  │  ────────────────────────────────────────────────────────────────────   │
  │                                                                         │
  │  ┌─────────────────────────────────────────────────────────────────┐   │
  │  │                   Fortune AI                                    │   │
  │  │                                                                 │   │
  │  │  选择模式:  [八字 ✓] [紫微] [星座]                              │   │
  │  │                                                                 │   │
  │  │  出生日期   [1980-02-11]                                        │   │
  │  │  出生时间   [14:30]                                             │   │
  │  │  出生地点   [北京 ▾] ← 默认值                                   │   │
  │  │                                                                 │   │
  │  │                 [生成预览 →]                                    │   │
  │  └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       │ 点击 [生成预览]
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Step 2: 验证点展示 (建立信任)                                          │
  │  ────────────────────────────────────────────────────────────────────   │
  │                                                                         │
  │  ┌───────────────────────────┬─────────────────────────────────────┐   │
  │  │     验证点 (左栏)         │      命盘预览 (右栏)                 │   │
  │  │                           │                                     │   │
  │  │  ✓ "你是不是经常想太多,   │      ┌──┬──┬──┬──┐                  │   │
  │  │     决定一件小事都要      │      │庚│辛│丁│丁│                  │   │
  │  │     纠结很久？"           │      │午│巳│丑│未│                  │   │
  │  │     [是的，就是我]        │      └──┴──┴──┴──┘                  │   │
  │  │                           │                                     │   │
  │  │  ✓ "你在人际关系中往往    │      日主: 丁火 · 身强              │   │
  │  │     是付出更多的那个？"   │      有利: 水、金                   │   │
  │  │     [是的，就是我]        │                                     │   │
  │  │                           │      [五行分布]                     │   │
  │  │  ✓ "你面对压力时，第一    │      金 ██░░░ 2                     │   │
  │  │     反应是独自消化？"     │      木 ░░░░░ 0                     │   │
  │  │     [是的，就是我]        │      水 ░░░░░ 0                     │   │
  │  │                           │      火 ████░ 4                     │   │
  │  └───────────────────────────┴      土 ██░░░ 2                     │   │
  │                                                                     │   │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       │ 用户确认验证点
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Step 3: 账号创建 (最后一步)                                            │
  │  ────────────────────────────────────────────────────────────────────   │
  │                                                                         │
  │  ┌─────────────────────────────────────────────────────────────────┐   │
  │  │                                                                 │   │
  │  │  恭喜！你的八字特征已识别                                       │   │
  │  │                                                                 │   │
  │  │  保存你的命盘数据:                                              │   │
  │  │                                                                 │   │
  │  │  邮箱 [_________________________]                               │   │
  │  │  密码 [_________________________]                               │   │
  │  │  昵称 [_________________________] ← 可选                        │   │
  │  │                                                                 │   │
  │  │  [创建账号并保存命盘]                                           │   │
  │  │                                                                 │   │
  │  │  已有账号？[登录]                                               │   │
  │  └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘

  优化要点:
  ┌───────────────────────────────────────────────────────────────────────┐
  │ [P1] 实现 /api/auth/validation-points API                             │
  │ [P1] 添加命盘预览可视化组件                                           │
  │ [P2] Tab 切换 (八字/紫微/星座)                                        │
  │ [P2] 渐进式表单 (分步骤收集信息)                                      │
  └───────────────────────────────────────────────────────────────────────┘
```

---

## 2. 对话系统流程图对比

### 2.1 设计对话流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    原设计：A2UI + If-Then 处方                               │
└─────────────────────────────────────────────────────────────────────────────┘

  用户输入消息
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  1. Context 构建                                                        │
  │     ├── L0: 八字 facts                                                 │
  │     ├── L1: PERMA + 活跃目标                                           │
  │     └── L2: 知识库检索                                                 │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  2. GLM 生成                                                            │
  │     └── 输出 A2UI JSON                                                 │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  3. A2UI 渲染                                                           │
  │                                                                         │
  │  ┌─────────────────────────────────────────────────────────────────┐   │
  │  │  ### 分析结果                                                   │   │
  │  │                                                                 │   │
  │  │  你的日主是甲木，当前处于偏印透出的阶段...                      │   │
  │  │                                                                 │   │
  │  │  ### 行动处方                                                   │   │
  │  │                                                                 │   │
  │  │  **如果**你感到决策焦虑,                                        │   │
  │  │  **那么**做一个5分钟决策模板:                                   │   │
  │  │    1. 写下2个选项                                               │   │
  │  │    2. 列出各自利弊                                              │   │
  │  │    3. 设定24小时决策期限                                        │   │
  │  │                                                                 │   │
  │  │  **这样做是因为**: 甲木日主容易陷入犹豫...                       │   │
  │  │                                                                 │   │
  │  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────┐         │   │
  │  │  │ [现在开始]    │ │ [加入计划]    │ │ [暂不执行]    │         │   │
  │  │  └───────────────┘ └───────────────┘ └───────────────┘         │   │
  │  └─────────────────────────────────────────────────────────────────┘   │
  │                                                                         │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 当前实现对话流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    当前实现：Markdown 渲染 + 按钮 (部分)                     │
└─────────────────────────────────────────────────────────────────────────────┘

  用户输入消息
       │
       ▼
  POST /api/chat/send (api/chat_routes.py)
       │
       ├── ✅ Context 构建 (L0 + L1 + L2)
       ├── ✅ GLM 调用
       └── ✅ A2UI JSON 返回
       │
       ▼
  前端渲染 (web-app/src/components/chat/message-item.tsx)
       │
       ├── ✅ markdown_text → Markdown 组件
       ├── ✅ If-Then 处方格式显示
       └── ⚠️ action_buttons → 按钮显示但点击无响应
       
  问题分析:
  ┌───────────────────────────────────────────────────────────────────────┐
  │ 1. action_buttons 组件存在                                           │
  │ 2. 点击后调用 API 时 CSRF Token 未正确传递                            │
  │ 3. 后端返回 401/500                                                  │
  │ 4. 用户看不到任何反馈                                                 │
  │                                                                       │
  │ 根本原因: lib/api.ts 中未读取 fortune_csrf cookie                     │
  └───────────────────────────────────────────────────────────────────────┘
```

### 2.3 最优对话流程（建议）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    最优方案：完整 A2UI + 统一 API Client                     │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  API Client 统一封装 (lib/api-client.ts)                                │
  │  ─────────────────────────────────────────────────────────────────────  │
  │                                                                         │
  │  class ApiClient {                                                      │
  │    private baseUrl = process.env.NEXT_PUBLIC_API_URL;                   │
  │                                                                         │
  │    private getCSRFToken(): string {                                     │
  │      // 从 cookie 读取 fortune_csrf                                     │
  │      const match = document.cookie.match(/fortune_csrf=([^;]+)/);       │
  │      return match ? match[1] : '';                                      │
  │    }                                                                    │
  │                                                                         │
  │    async post<T>(endpoint: string, data: any): Promise<T> {             │
  │      const response = await fetch(`${this.baseUrl}${endpoint}`, {       │
  │        method: 'POST',                                                  │
  │        headers: {                                                       │
  │          'Content-Type': 'application/json',                            │
  │          'X-CSRF-Token': this.getCSRFToken(), // ← 关键                 │
  │        },                                                               │
  │        credentials: 'include',                                          │
  │        body: JSON.stringify(data),                                      │
  │      });                                                                │
  │                                                                         │
  │      if (!response.ok) {                                                │
  │        throw new ApiError(response.status, await response.json());      │
  │      }                                                                  │
  │                                                                         │
  │      return response.json();                                            │
  │    }                                                                    │
  │  }                                                                      │
  │                                                                         │
  │  export const apiClient = new ApiClient();                              │
  └─────────────────────────────────────────────────────────────────────────┘

  ┌─────────────────────────────────────────────────────────────────────────┐
  │  Action Handler (components/chat/action-button.tsx)                     │
  │  ─────────────────────────────────────────────────────────────────────  │
  │                                                                         │
  │  function ActionButton({ action, label }: Props) {                      │
  │    const [loading, setLoading] = useState(false);                       │
  │    const { refreshTasks } = useTaskStore();                             │
  │                                                                         │
  │    const handleClick = async () => {                                    │
  │      setLoading(true);                                                  │
  │      try {                                                              │
  │        switch (action.type) {                                           │
  │          case 'start_task':                                             │
  │            await apiClient.post('/api/dashboard/task/accept', {         │
  │              task_id: action.task_id,                                   │
  │              commitment_type: 'start_task',                             │
  │            });                                                          │
  │            toast.success('任务已开始！');                               │
  │            refreshTasks(); // 刷新任务列表                              │
  │            break;                                                       │
  │                                                                         │
  │          case 'schedule_task':                                          │
  │            await apiClient.post('/api/dashboard/task/accept', {         │
  │              task_id: action.task_id,                                   │
  │              commitment_type: 'schedule_task',                          │
  │            });                                                          │
  │            toast.success('已加入计划！');                               │
  │            refreshTasks();                                              │
  │            break;                                                       │
  │                                                                         │
  │          case 'open_panel':                                             │
  │            setActiveTab(action.panel);                                  │
  │            break;                                                       │
  │        }                                                                │
  │      } catch (error) {                                                  │
  │        toast.error('操作失败，请重试');                                 │
  │      } finally {                                                        │
  │        setLoading(false);                                               │
  │      }                                                                  │
  │    };                                                                   │
  │                                                                         │
  │    return (                                                             │
  │      <Button onClick={handleClick} disabled={loading}>                  │
  │        {loading ? <Spinner /> : label}                                  │
  │      </Button>                                                          │
  │    );                                                                   │
  │  }                                                                      │
  └─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 海报生成流程图对比

### 3.1 设计海报流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    原设计：Gemini 图片模型生成                               │
└─────────────────────────────────────────────────────────────────────────────┘

  触发场景 (完成解读/情绪签到/查看运势/合盘结果/里程碑/低谷)
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  1. 读取用户 Profile + 当前上下文                                       │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  2. 生成吐槽文案 (GLM)                                                  │
  │     ├── 性格吐槽: 自嘲式                                               │
  │     ├── 情绪吐槽: 夸张式                                               │
  │     ├── 运势吐槽: 调侃式                                               │
  │     └── 成就打卡: 自豪式                                               │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  3. 调用 gemini_create_job (图片模型)                                   │
  │     └── model: gemini-2.0-flash-exp                                    │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  4. 返回 job_id, 前端轮询状态                                           │
  └─────────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  5. 完成后返回 image_url                                                │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 当前实现海报流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    当前实现：后端完整 + 前端待接入                           │
└─────────────────────────────────────────────────────────────────────────────┘

  后端实现 (services/poster_service.py + api/poster_routes.py):
  ┌───────────────────────────────────────────────────────────────────────┐
  │                                                                       │
  │  ✅ PosterType 枚举                                                   │
  │     personality, mood, fortune, pairing, achievement, help            │
  │                                                                       │
  │  ✅ PosterService.generate_poster()                                   │
  │     1. 读取用户 Profile                                               │
  │     2. 生成文案 (基于 poster_type + context)                          │
  │     3. 写入 fortune_poster (status=processing)                        │
  │     4. 返回 poster_id                                                 │
  │                                                                       │
  │  ✅ API 端点                                                          │
  │     POST /api/poster/generate                                         │
  │     GET  /api/poster/{poster_id}                                      │
  │     GET  /api/poster (列表)                                           │
  │                                                                       │
  └───────────────────────────────────────────────────────────────────────┘

  前端状态 (web-app):
  ┌───────────────────────────────────────────────────────────────────────┐
  │                                                                       │
  │  ⚠️ 海报生成入口未添加                                                │
  │  ⚠️ 海报预览组件未实现                                                │
  │  ⚠️ 轮询状态逻辑未实现                                                │
  │                                                                       │
  └───────────────────────────────────────────────────────────────────────┘
```

### 3.3 最优海报流程（建议）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    最优方案：前端完整接入 + 分享功能                         │
└─────────────────────────────────────────────────────────────────────────────┘

  触发入口 (多处可触发):
  ┌───────────────────────────────────────────────────────────────────────┐
  │ 1. 深度报告完成后 → 性格海报                                          │
  │ 2. 情绪打卡后 → 情绪海报                                              │
  │ 3. 任务完成后 → 成就海报                                              │
  │ 4. 状态低谷时 → 求助海报                                              │
  └───────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  前端组件 (components/poster/poster-generator.tsx)                      │
  │  ─────────────────────────────────────────────────────────────────────  │
  │                                                                         │
  │  function PosterGenerator({ type, context, onComplete }) {              │
  │    const [status, setStatus] = useState<'idle'|'generating'|'done'>();  │
  │    const [imageUrl, setImageUrl] = useState<string>();                  │
  │                                                                         │
  │    const generate = async () => {                                       │
  │      setStatus('generating');                                           │
  │                                                                         │
  │      // 1. 提交生成请求                                                 │
  │      const { poster_id } = await apiClient.post('/api/poster/generate', │
  │        { poster_type: type, context }                                   │
  │      );                                                                 │
  │                                                                         │
  │      // 2. 轮询状态                                                     │
  │      const result = await pollUntilComplete(poster_id);                 │
  │                                                                         │
  │      // 3. 完成                                                         │
  │      setImageUrl(result.image_url);                                     │
  │      setStatus('done');                                                 │
  │      onComplete?.(result);                                              │
  │    };                                                                   │
  │                                                                         │
  │    return (                                                             │
  │      <div>                                                              │
  │        {status === 'generating' && <PosterSkeleton />}                  │
  │        {status === 'done' && (                                          │
  │          <>                                                             │
  │            <img src={imageUrl} alt="海报" />                            │
  │            <ShareButtons url={imageUrl} />                              │
  │          </>                                                            │
  │        )}                                                               │
  │        <Button onClick={generate}>生成海报</Button>                     │
  │      </div>                                                             │
  │    );                                                                   │
  │  }                                                                      │
  └─────────────────────────────────────────────────────────────────────────┘
```

---

## 4. K线系统流程图对比

### 4.1 设计 K线流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    原设计：OHLC 蜡烛图                                       │
└─────────────────────────────────────────────────────────────────────────────┘

  数据源:
  ┌───────────────────────────────────────────────────────────────────────┐
  │ fortune_checkin (情绪) + fortune_commitment (行动) → State Score      │
  │                                                                       │
  │ 每日汇总:                                                             │
  │   open  = 当日首次 State Score (早间)                                 │
  │   close = 当日最后 State Score (晚间)                                 │
  │   high  = 当日最高 State Score                                        │
  │   low   = 当日最低 State Score                                        │
  │   volume = 当日活动次数                                               │
  └───────────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────────────┐
  │  K线可视化                                                              │
  │  ─────────────────────────────────────────────────────────────────────  │
  │                                                                         │
  │  State                                                                  │
  │  Score                                                                  │
  │   100 ┤                                                                 │
  │       │                              ┌───┐                              │
  │    80 ┤          ┌───┐    ╷          │███│                              │
  │       │    ┌───┐ │███│    │    ┌───┐ │███│                              │
  │    60 ┤    │███│ │███│   ┌┴┐   │▒▒▒│ │███│                              │
  │       │ ╷  │███│ │███│   │▒│   │▒▒▒│ │███│                              │
  │    40 ┤ │  │███│ │███│ ╷ │▒│   │▒▒▒│ │███│                              │
  │       │ │  │███│ │███│ │ │▒│   │▒▒▒│ │███│                              │
  │    20 ┤ │  └───┘ └───┘ │ └─┘   └───┘ └───┘                              │
  │       │ ╵              ╵                                                │
  │     0 ┼────────────────────────────────────→ 时间                       │
  │         W1   W2   W3   W4   W5   W6   W7                                │
  │                                                                         │
  │  ███ = 上涨 (绿)   ▒▒▒ = 下跌 (红)   ╷╵ = 影线                          │
  └─────────────────────────────────────────────────────────────────────────┘
```

### 4.2 当前实现 K线流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    当前实现：线性图表 (非蜡烛图)                             │
└─────────────────────────────────────────────────────────────────────────────┘

  数据库表:
  ┌───────────────────────────────────────────────────────────────────────┐
  │ ✅ fortune_kline_daily 表已创建                                       │
  │    ├── open_score, high_score, low_score, close_score                │
  │    ├── volume, emotion_avg, action_count                             │
  │    └── drivers (JSONB)                                               │
  └───────────────────────────────────────────────────────────────────────┘

  后端 API:
  ┌───────────────────────────────────────────────────────────────────────┐
  │ ⚠️ GET /api/dashboard/kline 待实现                                    │
  │ ✅ GET /api/dashboard/trends 返回线性数据                             │
  └───────────────────────────────────────────────────────────────────────┘

  前端:
  ┌───────────────────────────────────────────────────────────────────────┐
  │ ✅ trends-tab.tsx 显示线性图表                                        │
  │ ⚠️ K线蜡烛图组件未实现                                                │
  └───────────────────────────────────────────────────────────────────────┘
```

### 4.3 最优 K线流程（建议）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    最优方案：完整 K 线 + 事件标记                            │
└─────────────────────────────────────────────────────────────────────────────┘

  后端实现:
  ┌───────────────────────────────────────────────────────────────────────┐
  │  GET /api/dashboard/kline                                             │
  │  ─────────────────────────────────────────────────────────────────    │
  │                                                                       │
  │  参数:                                                                │
  │    period: 'daily' | 'weekly' | 'monthly'                             │
  │    count: number (默认 30)                                            │
  │                                                                       │
  │  返回:                                                                │
  │  {                                                                    │
  │    "klines": [                                                        │
  │      {                                                                │
  │        "date": "2026-01-01",                                          │
  │        "open": 65,                                                    │
  │        "high": 78,                                                    │
  │        "low": 58,                                                     │
  │        "close": 72,                                                   │
  │        "volume": 5,                                                   │
  │        "change_pct": "+10.8%",                                        │
  │        "events": [                                                    │
  │          {"type": "checkin", "label": "情绪高峰"},                    │
  │          {"type": "achievement", "label": "完成计划"}                 │
  │        ]                                                              │
  │      }                                                                │
  │    ]                                                                  │
  │  }                                                                    │
  └───────────────────────────────────────────────────────────────────────┘

  前端组件:
  ┌───────────────────────────────────────────────────────────────────────┐
  │  components/charts/kline-chart.tsx                                    │
  │  ─────────────────────────────────────────────────────────────────    │
  │                                                                       │
  │  使用 Visx 或 Recharts 实现:                                          │
  │  • 蜡烛体 (open, close)                                               │
  │  • 影线 (high, low)                                                   │
  │  • 颜色: 绿涨/红跌                                                    │
  │  • 悬停: 显示详情 + 事件                                              │
  │  • 时间切换: 日/周/月                                                  │
  └───────────────────────────────────────────────────────────────────────┘
```

---

## 5. 代码问题清单

### 5.1 P0 问题（必须修复）

| # | 问题 | 位置 | 影响 | 修复方案 |
|---|------|------|------|----------|
| 1 | CSRF Token 未传递 | `web-app/src/lib/api.ts` | 所有 POST 请求失败 | 从 cookie 读取 fortune_csrf |
| 2 | action_buttons 点击无响应 | `web-app/src/components/chat/message-item.tsx` | 无法接受任务 | 实现 action handler |

### 5.2 P1 问题（应尽快处理）

| # | 问题 | 位置 | 影响 | 修复方案 |
|---|------|------|------|----------|
| 3 | K线 API 未实现 | `api/dashboard_routes.py` | 趋势可视化不完整 | 实现 kline 端点 |
| 4 | 验证点 API 未完善 | `api/auth_routes.py` | Login 体验不完整 | 基于 L0 生成验证点 |
| 5 | 海报前端未接入 | `web-app/` | 海报功能不可用 | 添加生成入口 + 预览组件 |
| 6 | 复盘入口不明显 | `web-app/` | 用户难以找到 | 在 Dashboard 添加入口 |

### 5.3 P2 问题（后续优化）

| # | 问题 | 位置 | 影响 | 修复方案 |
|---|------|------|------|----------|
| 7 | 无虚拟滚动 | `web-app/src/components/chat/message-list.tsx` | 长对话性能差 | 使用 @tanstack/react-virtual |
| 8 | anti-dependency 无豁免 | `services/soul_os.py` | 新用户被截断 | 添加 7 天豁免逻辑 |
| 9 | 无全链路追踪 | 全局 | 排查困难 | 添加 correlation_id |
| 10 | Settings UI 不完整 | `web-app/src/app/settings/` | 用户无法修改设置 | 完善页面组件 |

---

## 6. 总结

### 6.1 模块完成度

```
Login 页面:     ███████░░░ 70%  ← Tab/验证点待实现
深度报告:       ██████████ 100%
对话系统:       ███████░░░ 70%  ← action_buttons 待修复
海报生成:       ██████░░░░ 60%  ← 前端待接入
K线系统:        ████░░░░░░ 40%  ← API + 组件待实现
Settings:       ██████░░░░ 60%  ← UI 待完善
任务系统:       ███████░░░ 70%  ← CSRF 待修复
```

### 6.2 下一步行动

1. **[P0]** 修复 CSRF Token 处理 → 恢复任务功能
2. **[P0]** 完善 action_buttons 点击处理 → 恢复一键行动
3. **[P1]** 实现 K线 API + 前端组件
4. **[P1]** 海报功能前端接入
5. **[P2]** Settings 页面 UI 完善

---

*文档版本: v4.2 (实测修订版)*
*更新日期: 2026-01-01*
*测试环境: http://106.37.170.238:8231/new*
