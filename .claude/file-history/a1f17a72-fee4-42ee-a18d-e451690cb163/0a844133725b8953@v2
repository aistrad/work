# Fortune AI 核心功能模块设计 - 修订版 2026-01-01

> **定位**: 基于四层心理架构 (L0-L3) 的可执行功能模块
>
> **入口**: http://106.37.170.238:8231/new
>
> **本版更新**: 设计 vs 实现对比 + 最优方案建议 + 代码问题清单

---

## 0. 修订总览

### 0.1 模块实现状态矩阵

| 模块 | 设计 | 后端 | 前端 | 阻塞项 |
|------|------|------|------|--------|
| Login 页面 | ✅ Tab + 验证点 | ✅ 已实现 | ✅ 已实现 | - |
| 深度报告 | ✅ 6章结构 | ✅ 已实现 | ✅ 已实现 | - |
| 对话系统 | ✅ A2UI + If-Then | ✅ 已实现 | ⚠️ 部分 | action_buttons |
| 海报生成 | ✅ Gemini 图片 | ✅ 已实现 | ⚠️ 待完善 | 前端调用 |
| K线系统 | ✅ OHLC 蜡烛图 | ⚠️ 部分 | ⚠️ 待实现 | API + 组件 |
| Settings | ✅ 完整设计 | ✅ 已实现 | ⚠️ 待完善 | 页面UI |
| 任务系统 | ✅ 承诺闭环 | ✅ 已实现 | ⚠️ CSRF | 前端修复 |

### 0.2 实施优先级确认

> **命名规范**: 参见 [GLOSSARY.md](../GLOSSARY.md)

```mermaid
graph TB
    subgraph P0_Done["P0 已完成 ✅"]
        direction LR
        L[1. Login页面重构]
        R[2. 深度八字报告]
    end

    subgraph P0_Fix["P0 必须修复 ⚠️"]
        C[3. 前端 CSRF 问题<br/>阻塞所有 POST]
    end

    subgraph P1["P1 高优先级"]
        direction LR
        A[4. action_buttons]
        P[5. 海报前端]
        S[6. Settings UI]
    end

    subgraph P2["P2 中优先级"]
        direction LR
        K[7. K线 API+组件]
        M[8. 合并 Tab]
    end

    P0_Done --> P0_Fix
    P0_Fix --> P1
    P1 --> P2

    style P0_Done fill:#d4edda,stroke:#28a745
    style P0_Fix fill:#f8d7da,stroke:#dc3545
    style P1 fill:#fff3cd,stroke:#ffc107
    style P2 fill:#cce5ff,stroke:#007bff
```

---

## 1. Login 页面流程图对比

### 1.1 设计登录流程 (Mermaid 时序图)

```mermaid
sequenceDiagram
    autonumber
    participant U as 用户
    participant FE as 前端<br/>/new/register
    participant API as FastAPI
    participant L0 as L0 八字脑
    participant DB as PostgreSQL

    U->>FE: 访问注册页
    FE->>FE: 显示 Tab [八字|紫微|星座]

    U->>FE: 选择八字 + 输入出生信息
    U->>FE: 点击 [生成预览]
    FE->>API: POST /api/auth/preview
    API->>L0: 计算八字 facts
    L0-->>API: {四柱, 五行, 日主, 身强/弱}
    API-->>FE: 预览数据

    FE->>FE: 显示命盘可视化
    FE->>API: POST /api/auth/validation-points
    API->>L0: 生成 3 个验证点
    L0-->>API: ["你是不是经常...", ...]
    API-->>FE: 验证点列表

    U->>FE: 确认验证点 "那就是我"
    U->>FE: 填写邮箱/密码 + 点击注册
    FE->>API: POST /api/auth/register
    API->>DB: INSERT fortune_user
    API->>DB: INSERT fortune_bazi_snapshot
    API-->>FE: 设置 Cookies
    FE->>FE: 跳转 /new
```

**设计页面布局**:

| 区域 | 内容 |
|------|------|
| 顶部 | Tab [八字] [紫微] [星座] |
| 左栏 | 出生信息表单 + 验证点卡片 + 注册表单 |
| 右栏 | 命盘可视化 + 预览数据 |

### 1.2 当前实现登录流程

```mermaid
sequenceDiagram
    autonumber
    participant U as 用户
    participant FE as 前端<br/>/new/register
    participant API as FastAPI
    participant DB as PostgreSQL

    U->>FE: 访问注册页
    FE->>FE: 显示简化表单<br/>(无 Tab)

    U->>FE: 填写全部信息<br/>(邮箱+密码+出生)
    U->>FE: 点击 [注册]
    FE->>API: POST /api/auth/register
    API->>DB: INSERT fortune_user
    API-->>FE: 设置 Cookies
    FE->>FE: 跳转 /new

    Note right of FE: ⚠️ 缺少预览/验证点
```

**实现状态**:

| 功能 | 状态 | 说明 |
|------|:----:|------|
| 基础注册表单 | ✅ | 邮箱/密码/昵称/性别 |
| 出生信息输入 | ✅ | 日期/时间/时区/地点 |
| Tab 切换 | ⚠️ | 八字/紫微/星座 未实现 |
| 验证点生成 | ⚠️ | `/api/auth/validation-points` 待实现 |
| 命盘预览 | ⚠️ | 可视化组件未实现 |

### 1.3 最优登录流程 (渐进式注册)

```mermaid
stateDiagram-v2
    [*] --> Step1_Birth: 访问 /new/register

    state Step1_Birth {
        direction LR
        SelectTab: 选择 [八字|紫微|星座]
        InputBirth: 输入出生信息
        Preview: 点击 [生成预览]
        SelectTab --> InputBirth
        InputBirth --> Preview
    }

    Step1_Birth --> Step2_Validate: 预览成功

    state Step2_Validate {
        direction LR
        ShowChart: 显示命盘可视化
        ShowPoints: 显示 3 个验证点
        Confirm: 用户确认 "那就是我"
        ShowChart --> ShowPoints
        ShowPoints --> Confirm
    }

    Step2_Validate --> Step3_Account: 验证点确认

    state Step3_Account {
        direction LR
        ShowSuccess: "八字特征已识别"
        InputAccount: 填写邮箱/密码
        Register: [创建账号并保存]
        ShowSuccess --> InputAccount
        InputAccount --> Register
    }

    Step3_Account --> [*]: 注册成功 → /new
```

**优化要点**:

| 优先级 | 改进项 | 说明 |
|:------:|--------|------|
| P1 | `/api/auth/validation-points` | 基于 L0 facts 生成 3 个验证问题 |
| P1 | 命盘预览组件 | 四柱 + 五行雷达图 |
| P2 | Tab 切换 | 八字/紫微/星座 模式选择 |
| P2 | 渐进式表单 | 分 3 步收集信息，降低流失 |

---

## 2. 对话系统流程图对比

> **A2UI 类型定义**: 参见 [GLOSSARY.md](../GLOSSARY.md) §4

### 2.1 设计对话流程 (四层架构)

```mermaid
sequenceDiagram
    autonumber
    participant U as 用户
    participant FE as Zone A
    participant API as FastAPI
    participant L0 as L0 数学脑
    participant L1 as L1 心理脑
    participant L2 as L2 知识脑
    participant L3 as L3 语言脑
    participant DB as PostgreSQL

    U->>FE: 输入消息
    FE->>API: POST /api/chat/send

    rect rgb(240, 248, 255)
        Note over API,L2: Context 构建
        API->>L0: 获取八字 facts
        L0-->>API: {日主, 五行, 当前运势}
        API->>L1: 获取 PERMA + 活跃目标
        L1-->>API: {state_score, active_goals}
        API->>L2: RAG 知识检索
        L2-->>API: {kb_refs, rule_ids}
    end

    rect rgb(255, 248, 240)
        Note over API,L3: GLM 生成
        API->>L3: prompt + context
        L3-->>API: A2UI JSON
    end

    API->>DB: INSERT conversation_message
    API-->>FE: A2UI 响应

    FE->>FE: 渲染 markdown_text
    FE->>FE: 渲染 If-Then 处方
    FE->>FE: 渲染 action_buttons
```

**A2UI 输出结构**:

```json
{
  "blocks": [
    {"type": "markdown_text", "data": "### 分析结果\n你的日主是甲木..."},
    {"type": "markdown_text", "data": "### 行动处方\n**如果**你感到决策焦虑...\n**那么**..."},
    {"type": "action_buttons", "data": [
      {"label": "现在开始", "action": {"type": "start_task", "task_id": "xxx"}},
      {"label": "加入计划", "action": {"type": "schedule_task", "task_id": "xxx"}},
      {"label": "暂不执行", "action": {"type": "opt_out"}}
    ]}
  ]
}
```

### 2.2 当前实现 (问题分析)

```mermaid
sequenceDiagram
    autonumber
    participant U as 用户
    participant FE as Zone A
    participant API as FastAPI

    U->>FE: 点击 action_button
    FE->>API: POST /api/dashboard/task/accept

    Note right of FE: ⚠️ 缺少 X-CSRF-Token
    API-->>FE: 403 csrf_invalid

    Note right of FE: ⚠️ 无错误 toast
    Note right of FE: ⚠️ Zone B 不刷新
```

**问题清单**:

| 问题 | 位置 | 影响 | 根因 |
|------|------|------|------|
| CSRF 未传递 | `lib/api.ts` | POST 失败 | 未读取 `fortune_csrf` cookie |
| 无错误反馈 | `blocks/index.tsx` | 用户困惑 | 无 try-catch + toast |
| Zone B 不刷新 | 全局 | 需手动刷新 | 无 store 通知机制 |

### 2.3 最优方案 (action 处理时序)

```mermaid
sequenceDiagram
    autonumber
    participant U as 用户
    participant Btn as ActionButton
    participant Client as api-client.ts
    participant API as FastAPI
    participant Store as Zustand
    participant ZoneB as Zone B
    participant Toast as Toast

    U->>Btn: 点击 "现在开始"
    Btn->>Btn: setLoading(true)
    Btn->>Client: handleAction({type: 'start_task'})
    Client->>Client: getCSRFToken()
    Client->>API: POST /api/dashboard/task/accept<br/>+ X-CSRF-Token

    alt 成功
        API-->>Client: {ok: true}
        Client->>Store: invalidate('tasks')
        Store->>ZoneB: refetch
        Client->>Toast: success("任务已开始")
    else 失败
        API-->>Client: {error}
        Client->>Toast: error("操作失败")
    end

    Btn->>Btn: setLoading(false)
```

**关键代码修复**:

```typescript
// lib/api-client.ts
export const apiClient = {
  getCSRFToken(): string {
    const match = document.cookie.match(/fortune_csrf=([^;]+)/);
    return match ? match[1] : '';
  },

  async post<T>(url: string, data: unknown): Promise<T> {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': this.getCSRFToken(),  // ← 关键
      },
      credentials: 'include',
      body: JSON.stringify(data),
    });
    if (!res.ok) throw new ApiError(res.status, await res.json());
    return res.json();
  }
};
```

---

## 3. 海报生成流程图对比

> **外部任务状态**: 参见 [GLOSSARY.md](../GLOSSARY.md) §6

### 3.1 设计海报流程 (Gemini 图片模型)

```mermaid
sequenceDiagram
    autonumber
    participant U as 用户
    participant FE as 前端
    participant API as FastAPI
    participant GLM as GLM 文案
    participant Gemini as Gemini 图片
    participant DB as PostgreSQL

    U->>FE: 触发海报生成<br/>(报告完成/打卡后)
    FE->>API: POST /api/poster/generate<br/>{poster_type, context}

    API->>DB: 读取用户 Profile
    API->>GLM: 生成吐槽文案
    GLM-->>API: "我就是那个想太多的甲木..."

    API->>DB: INSERT fortune_poster<br/>(status=processing)
    API->>Gemini: gemini_create_job<br/>(图片生成)
    API-->>FE: {poster_id}

    loop 轮询 (3s 间隔)
        FE->>API: GET /api/poster/{id}
        API-->>FE: {status: 'processing'}
    end

    Gemini-->>DB: 完成 → image_url
    FE->>API: GET /api/poster/{id}
    API-->>FE: {status: 'completed', image_url}
    FE->>FE: 显示海报 + 分享按钮
```

**海报类型**:

| type | 场景 | 文案风格 |
|------|------|----------|
| `personality` | 深度报告后 | 自嘲式 |
| `mood` | 情绪打卡后 | 夸张式 |
| `fortune` | 查看运势时 | 调侃式 |
| `achievement` | 任务完成后 | 自豪式 |
| `help` | 状态低谷时 | 求助式 |

### 3.2 当前实现状态

| 组件 | 后端 | 前端 | 说明 |
|------|:----:|:----:|------|
| PosterService | ✅ | - | `services/poster_service.py` |
| API 端点 | ✅ | - | POST/GET `/api/poster/*` |
| fortune_poster 表 | ✅ | - | `20260101_poster_kline.sql` |
| 生成入口 | - | ⚠️ | 待添加触发按钮 |
| 预览组件 | - | ⚠️ | 待实现 |
| 轮询逻辑 | - | ⚠️ | 待实现 |

### 3.3 外部任务状态机

```mermaid
stateDiagram-v2
    [*] --> queued: POST /api/poster/generate

    queued --> processing: Worker 领取
    processing --> completed: 图片生成成功
    processing --> error: 生成失败

    completed --> [*]: 显示海报
    error --> queued: 用户重试
```

---

## 4. K线系统流程图对比

> **数据表**: `fortune_kline_daily` 已在 `20260101_poster_kline.sql` 创建

### 4.1 K线数据流架构

```mermaid
graph TB
    subgraph DataSources["数据源"]
        Checkin["fortune_checkin<br/>(情绪打卡)"]
        Commit["fortune_commitment<br/>(任务完成)"]
        Chat["fortune_conversation_message<br/>(对话)"]
    end

    subgraph Calculate["每日计算"]
        StateScore["State Score 计算"]
        OHLC["OHLC 汇总"]
    end

    subgraph Storage["存储"]
        KlineTable["fortune_kline_daily<br/>open/high/low/close<br/>volume/drivers"]
    end

    subgraph Display["可视化"]
        KlineChart["K线蜡烛图"]
        Events["事件标记"]
    end

    Checkin --> StateScore
    Commit --> StateScore
    Chat --> StateScore

    StateScore --> OHLC
    OHLC --> KlineTable
    KlineTable --> KlineChart
    KlineTable --> Events

    style DataSources fill:#e3f2fd
    style Calculate fill:#fff3e0
    style Storage fill:#e8f5e9
    style Display fill:#fce4ec
```

**OHLC 定义**:

| 字段 | 含义 | 计算规则 |
|------|------|----------|
| `open` | 当日开盘 | 首次 State Score (早间) |
| `high` | 当日最高 | MAX(当日所有 State Score) |
| `low` | 当日最低 | MIN(当日所有 State Score) |
| `close` | 当日收盘 | 最后 State Score (晚间) |
| `volume` | 活动量 | 当日打卡 + 任务完成数 |

### 4.2 当前实现状态

| 组件 | 状态 | 说明 |
|------|:----:|------|
| fortune_kline_daily 表 | ✅ | `migrations/20260101_poster_kline.sql` |
| GET /api/dashboard/kline | ⚠️ | 待实现 |
| GET /api/dashboard/trends | ✅ | 返回线性数据 |
| trends-tab.tsx | ✅ | 线性图表 |
| K线蜡烛图组件 | ⚠️ | 待实现 |

### 4.3 K线 API 设计

```mermaid
sequenceDiagram
    autonumber
    participant FE as 前端
    participant API as FastAPI
    participant DB as PostgreSQL

    FE->>API: GET /api/dashboard/kline<br/>?period=daily&count=30
    API->>DB: SELECT * FROM fortune_kline_daily<br/>WHERE user_id = ? ORDER BY date DESC
    DB-->>API: OHLC 数据
    API-->>FE: {klines: [{date, open, high, low, close, volume, events}]}

    FE->>FE: 渲染蜡烛图<br/>绿涨/红跌
    FE->>FE: 显示事件标记
```

**响应结构**:

```json
{
  "klines": [
    {
      "date": "2026-01-01",
      "open": 65,
      "high": 78,
      "low": 58,
      "close": 72,
      "volume": 5,
      "change_pct": "+10.8%",
      "events": [
        {"type": "checkin", "label": "情绪高峰"},
        {"type": "achievement", "label": "完成计划"}
      ]
    }
  ]
}
```

---

## 5. 代码问题清单

### 5.1 P0 问题（必须修复）

| # | 问题 | 位置 | 影响 | 修复方案 |
|---|------|------|------|----------|
| 1 | CSRF Token 未传递 | `web-app/src/lib/api.ts` | 所有 POST 请求失败 | 从 cookie 读取 fortune_csrf |
| 2 | action_buttons 点击无响应 | `web-app/src/components/chat/message-item.tsx` | 无法接受任务 | 实现 action handler |

### 5.2 P1 问题（应尽快处理）

| # | 问题 | 位置 | 影响 | 修复方案 |
|---|------|------|------|----------|
| 3 | K线 API 未实现 | `api/dashboard_routes.py` | 趋势可视化不完整 | 实现 kline 端点 |
| 4 | 验证点 API 未完善 | `api/auth_routes.py` | Login 体验不完整 | 基于 L0 生成验证点 |
| 5 | 海报前端未接入 | `web-app/` | 海报功能不可用 | 添加生成入口 + 预览组件 |
| 6 | 复盘入口不明显 | `web-app/` | 用户难以找到 | 在 Dashboard 添加入口 |

### 5.3 P2 问题（后续优化）

| # | 问题 | 位置 | 影响 | 修复方案 |
|---|------|------|------|----------|
| 7 | 无虚拟滚动 | `web-app/src/components/chat/message-list.tsx` | 长对话性能差 | 使用 @tanstack/react-virtual |
| 8 | anti-dependency 无豁免 | `services/soul_os.py` | 新用户被截断 | 添加 7 天豁免逻辑 |
| 9 | 无全链路追踪 | 全局 | 排查困难 | 添加 correlation_id |
| 10 | Settings UI 不完整 | `web-app/src/app/settings/` | 用户无法修改设置 | 完善页面组件 |

---

## 6. 总结

### 6.1 模块完成度

```
Login 页面:     ███████░░░ 70%  ← Tab/验证点待实现
深度报告:       ██████████ 100%
对话系统:       ███████░░░ 70%  ← action_buttons 待修复
海报生成:       ██████░░░░ 60%  ← 前端待接入
K线系统:        ████░░░░░░ 40%  ← API + 组件待实现
Settings:       ██████░░░░ 60%  ← UI 待完善
任务系统:       ███████░░░ 70%  ← CSRF 待修复
```

### 6.2 下一步行动

1. **[P0]** 修复 CSRF Token 处理 → 恢复任务功能
2. **[P0]** 完善 action_buttons 点击处理 → 恢复一键行动
3. **[P1]** 实现 K线 API + 前端组件
4. **[P1]** 海报功能前端接入
5. **[P2]** Settings 页面 UI 完善

---

*文档版本: v4.2 (实测修订版)*
*更新日期: 2026-01-01*
*测试环境: http://106.37.170.238:8231/new*
