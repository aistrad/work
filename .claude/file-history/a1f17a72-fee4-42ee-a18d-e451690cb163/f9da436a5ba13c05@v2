window.fortuneAuth = (() => {
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  function resolveErrEl(scope){
    if (scope && scope.classList && scope.classList.contains('error')) return scope;
    return scope?.querySelector?.('.error') || $('#err') || $('#err-login');
  }

  function escapeHtml(text){
    return String(text ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll("\"","&quot;")
      .replaceAll("'","&#39;");
  }

  function safeJsonParse(text){
    try { return JSON.parse(text); } catch { return null; }
  }

  function clamp(n, a, b){
    if (!Number.isFinite(n)) return a;
    return Math.max(a, Math.min(b, n));
  }

  function showErrIn(scope, msg){
    const el = resolveErrEl(scope);
    if(!el) return;
    el.style.display = 'block';
    el.textContent = String(msg || '请求失败');
  }
  function hideErrIn(scope){
    const el = resolveErrEl(scope);
    if(!el) return;
    el.style.display = 'none';
    el.textContent = '';
  }

  async function postJson(url, body){
    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    const data = await res.json().catch(()=>null);
    if(!res.ok || !data || data.ok !== true){
      const msg = data?.error?.message || data?.detail || 'request_failed';
      throw new Error(msg);
    }
    return data.data;
  }

  function parseTzOffsetHours(raw){
    const s = String(raw ?? '').trim().replace(/^UTC/i,'').replace(/^GMT/i,'').trim();
    if (!s) return null;
    const v = Number(s);
    if (!Number.isFinite(v)) return null;
    if (v < -12 || v > 14) return null;
    return v;
  }

  function parseFiniteNumber(raw){
    const v = Number(String(raw ?? '').trim());
    return Number.isFinite(v) ? v : null;
  }

  function normalizeDateInput(raw){
    const digits = String(raw ?? '').replace(/\D/g,'').slice(0,8);
    if (digits.length <= 4) return digits;
    if (digits.length <= 6) return `${digits.slice(0,4)}-${digits.slice(4)}`;
    return `${digits.slice(0,4)}-${digits.slice(4,6)}-${digits.slice(6,8)}`;
  }

  function normalizeTimeInput(raw){
    const s = String(raw ?? '').trim();
    if (s.includes(':')){
      // keep as-is but normalize digits
      const parts = s.split(':').slice(0,2);
      const hh = (parts[0] || '').replace(/\D/g,'').slice(0,2);
      const mm = (parts[1] || '').replace(/\D/g,'').slice(0,2);
      if (!hh && !mm) return '';
      if (hh && !mm) return hh;
      return `${hh}:${mm}`;
    }
    const digits = s.replace(/\D/g,'').slice(0,4);
    if (digits.length <= 2) return digits;
    if (digits.length === 3) return `0${digits.slice(0,1)}:${digits.slice(1)}`;
    return `${digits.slice(0,2)}:${digits.slice(2)}`;
  }

  function normalizeTimeComplete(raw){
    const s = String(raw ?? '').trim();
    if (s.includes(':')){
      const parts = s.split(':').slice(0,2);
      let hh = String(parts[0] || '').replace(/\D/g,'').slice(0,2);
      let mm = String(parts[1] || '').replace(/\D/g,'').slice(0,2);
      if (!hh && !mm) return '';
      if (hh.length === 1) hh = `0${hh}`;
      if (!mm) mm = '00';
      if (mm.length === 1) mm = `0${mm}`;
      return `${hh}:${mm}`;
    }

    const digits = s.replace(/\D/g,'').slice(0,4);
    if (!digits) return '';
    if (digits.length === 1) return `0${digits}:00`;
    if (digits.length === 2) return `${digits}:00`;
    if (digits.length === 3) return `0${digits.slice(0,1)}:${digits.slice(1)}`;
    return `${digits.slice(0,2)}:${digits.slice(2)}`;
  }

  function isValidDateYmd(text){
    const m = String(text ?? '').match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return false;
    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
    if(!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return false;
    if(mo < 1 || mo > 12) return false;
    if(d < 1 || d > 31) return false;
    const dt = new Date(Date.UTC(y, mo-1, d));
    return dt.getUTCFullYear() === y && (dt.getUTCMonth()+1) === mo && dt.getUTCDate() === d;
  }

  function isValidTimeHm(text){
    const m = String(text ?? '').match(/^(\d{2}):(\d{2})$/);
    if(!m) return false;
    const h = Number(m[1]), mm = Number(m[2]);
    if(!Number.isFinite(h) || !Number.isFinite(mm)) return false;
    return h >= 0 && h <= 23 && mm >= 0 && mm <= 59;
  }

  function toBirthdayLocal(dateYmd, timeHm){
    // Backend expects "YYYY-MM-DD HH:MM:SS"
    const t = String(timeHm ?? '');
    const withSeconds = t.length === 5 ? `${t}:00` : t;
    return `${dateYmd} ${withSeconds}`;
  }

  function getDefaultTz(){
    // JS offset minutes west of UTC; want +8 etc.
    const raw = -new Date().getTimezoneOffset() / 60;
    // limit to half-hour increments (avoid 1.999999)
    const v = Math.round(raw * 2) / 2;
    return clamp(v, -12, 14);
  }

  function defaultLocation(){
    return { name: '北京', longitude: 116.4074, latitude: 39.9042 };
  }

  function buildPreviewHtml(preview){
    const p = preview?.pillars || {};
    const dm = preview?.day_master || {};
    const wc = preview?.wuxing_count || {};
    const strength = preview?.strength || '';
    const favorable = Array.isArray(preview?.favorable_elements) ? preview.favorable_elements.filter(Boolean).map(String) : [];
    const luck = preview?.luck || {};

    const max = Math.max(1, ...Object.values(wc).map(v => Number(v) || 0));
    const items = [
      ['金', wc['金'] ?? 0],
      ['木', wc['木'] ?? 0],
      ['水', wc['水'] ?? 0],
      ['火', wc['火'] ?? 0],
      ['土', wc['土'] ?? 0],
    ];

    const bars = items.map(([k, v]) => {
      const n = Number(v) || 0;
      const pct = Math.round((n / max) * 100);
      return `
        <div class="bar">
          <div class="name">${escapeHtml(k)}</div>
          <div class="track"><div class="fill" style="width:${pct}%"></div></div>
          <div class="count">${escapeHtml(String(n))}</div>
        </div>
      `;
    }).join('');

    const forward = typeof luck.forward === 'boolean' ? (luck.forward ? '顺行' : '逆行') : '';
    const startAge = Number.isFinite(Number(luck.start_age_year)) ? String(Number(luck.start_age_year)) : '';

    const usedDefaultLoc = preview?.used_default_location ? '（使用默认经纬度）' : '';

    return `
      <div class="pillars">
        <div class="pillar"><div class="k">year</div><div class="v">${escapeHtml(p.year || '—')}</div></div>
        <div class="pillar"><div class="k">month</div><div class="v">${escapeHtml(p.month || '—')}</div></div>
        <div class="pillar"><div class="k">day</div><div class="v">${escapeHtml(p.day || '—')}</div></div>
        <div class="pillar"><div class="k">hour</div><div class="v">${escapeHtml(p.hour || '—')}</div></div>
      </div>

      <div class="meta-line">
        <span class="tag">日主：${escapeHtml(dm.gan || '—')}${escapeHtml(dm.element || '')}</span>
        ${strength ? `<span class="tag">强弱：${escapeHtml(String(strength))}</span>` : ''}
        ${favorable.length ? `<span class="tag">有利：${escapeHtml(favorable.join(' '))}</span>` : ''}
        ${(forward && startAge) ? `<span class="tag">起运：${escapeHtml(startAge)} 岁 · ${escapeHtml(forward)}</span>` : ''}
      </div>

      <div class="bars">${bars}</div>
      <div class="preview__note">此为即时预览${usedDefaultLoc}；点击“保存并进入工作台”后才会写入并用于个性化。</div>
    `;
  }

  function initLogin(){
    const form = $('#login-form');
    if(!form) return;
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideErrIn(form);
      const q = (sel) => form.querySelector(sel);
      const email = (q('input[type=email]')?.value || '').trim();
      const password = (q('input[type=password]')?.value || '');
      try{
        await postJson('/api/auth/login', {email, password});
        location.href = '/main';
      }catch(err){
        showErrIn(form, String(err?.message || err));
      }
    });
  }

  function initRegister(){
    const form = $('#register-form');
    if(!form) return;
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      hideErrIn(form);
      const q = (sel) => form.querySelector(sel);
      const email = (q('input[type=email]')?.value || '').trim();
      const password = (q('input[type=password]')?.value || '');
      const name = (q('#name')?.value || '').trim();
      const gender = (q('#gender')?.value || '').trim();
      const birthDate = (q('#birth-date')?.value || '').trim();
      const birthTime = (q('#birth-time')?.value || '').trim();
      const tz = parseFloat(((q('#tz')?.value || '8')+'').trim());
      const locName = (q('#loc-name')?.value || '').trim();
      const lon = parseFloat(((q('#lon')?.value || '')+'').trim());
      const lat = parseFloat(((q('#lat')?.value || '')+'').trim());
      if(!birthDate || !birthTime){
        showErrIn(form, 'missing_birthday');
        return;
      }
      const birthday_local = `${birthDate} ${birthTime.length===5 ? birthTime+':00' : birthTime}`;
      try{
        await postJson('/api/auth/register', {
          email,
          password,
          name,
          gender,
          birthday_local,
          tz_offset_hours: tz,
          location: {name: locName, longitude: lon, latitude: lat},
        });
        location.href = '/main';
      }catch(err){
        showErrIn(form, String(err?.message || err));
      }
    });
  }

  function initAuthExperience(){
    const root = document.querySelector('[data-auth-root]');
    if(!root) return;

    const expForm = $('#experience-form', root);
    const errExp = $('#err-exp', root);
    const previewCard = $('#preview-card', root);
    const previewBody = $('#preview-body', root);
    const previewStamp = $('#preview-stamp', root);

    const genderEl = $('#exp-gender', root);
    const tzEl = $('#exp-tz', root);
    const dateEl = $('#exp-birth-date', root);
    const timeEl = $('#exp-birth-time', root);
    const locNameEl = $('#exp-loc-name', root);
    const lonEl = $('#exp-lon', root);
    const latEl = $('#exp-lat', root);

    // Mode tabs (八字/紫微/星座)
    const modeTabs = $$('.mode-tab', root);
    let currentMode = 'bazi';

    // Validation points
    const validationCard = $('#validation-card', root);
    const validationPoints = $('#validation-points', root);

    // Inline auth (非弹窗)
    const authInline = $('#auth-inline', root);
    const errInline = $('#err-inline', root);
    const toggleRegister = $('#toggle-register', root);
    const toggleLogin = $('#toggle-login', root);
    const inlineRegister = $('#inline-register', root);
    const inlineLogin = $('#inline-login', root);
    const inlineRegisterForm = $('#inline-register-form', root);
    const inlineLoginForm = $('#inline-login-form', root);
    const btnInlineRegister = $('#btn-inline-register', root);

    // btnSave alias for compatibility (now uses inline register button)
    const btnSave = btnInlineRegister || { disabled: false };

    // Modal sheet (保留兼容)
    const sheet = $('#account-sheet');
    const errAuth = $('#err-auth');
    const segRegister = $('#seg-register');
    const segLogin = $('#seg-login');
    const paneRegister = $('#pane-register');
    const paneLogin = $('#pane-login');
    const regForm = $('#register-form');
    const loginForm = $('#login-form');

    if(!expForm || !previewCard || !previewBody || !previewStamp || !genderEl || !tzEl || !dateEl || !timeEl || !locNameEl || !lonEl || !latEl){
      return;
    }

    let lastPreviewKey = '';
    let previewTimer = null;
    let inflight = 0;
    let lastPreviewOk = false;
    let validationInflight = 0;

    function setStamp(text){
      previewStamp.textContent = String(text || '').trim() || '—';
    }

    function setPreviewState(state){
      previewCard.dataset.state = state;
      if (state === 'idle') setStamp('waiting');
      if (state === 'loading') setStamp('generating');
      if (state === 'ready') setStamp('ready');
      if (state === 'error') setStamp('error');
    }

    function saveDraft(){
      const draft = readExperienceDraft();
      try{ sessionStorage.setItem('fortune_auth_draft_v1', JSON.stringify(draft)); }catch{}
    }

    function loadDraft(){
      try{
        const raw = sessionStorage.getItem('fortune_auth_draft_v1');
        const d = safeJsonParse(raw);
        if(!d) return;
        if (d.gender) genderEl.value = String(d.gender);
        if (d.tz !== undefined && d.tz !== null && d.tz !== '') tzEl.value = String(d.tz);
        if (d.birth_date) dateEl.value = String(d.birth_date);
        if (d.birth_time) timeEl.value = String(d.birth_time);
        if (d.loc_name) locNameEl.value = String(d.loc_name);
        if (d.lon !== undefined && d.lon !== null) lonEl.value = String(d.lon);
        if (d.lat !== undefined && d.lat !== null) latEl.value = String(d.lat);
      } catch {}
    }

    function readExperienceDraft(){
      return {
        gender: genderEl.value,
        tz: tzEl.value,
        birth_date: dateEl.value,
        birth_time: timeEl.value,
        loc_name: locNameEl.value,
        lon: lonEl.value,
        lat: latEl.value,
      };
    }

    function readBirthInfo(){
      const gender = String(genderEl.value || '').trim();
      const birthDate = String(dateEl.value || '').trim();
      const birthTime = String(timeEl.value || '').trim();
      const tz = parseTzOffsetHours(tzEl.value);
      const locName = String(locNameEl.value || '').trim();
      const lon = parseFiniteNumber(lonEl.value);
      const lat = parseFiniteNumber(latEl.value);
      const locDefault = defaultLocation();

      const validDate = isValidDateYmd(birthDate);
      const validTime = isValidTimeHm(birthTime);

      const loc = (() => {
        const haveLon = Number.isFinite(lon) && lon >= -180 && lon <= 180;
        const haveLat = Number.isFinite(lat) && lat >= -90 && lat <= 90;
        if (haveLon && haveLat){
          return { name: locName || locDefault.name, longitude: lon, latitude: lat, used_default_location: false };
        }
        return { ...locDefault, name: locName || locDefault.name, used_default_location: true };
      })();

      const ok = (gender === '男' || gender === '女') && validDate && validTime;

      return {
        ok,
        gender,
        birthDate,
        birthTime,
        tz: tz ?? getDefaultTz(),
        location: { name: loc.name, longitude: loc.longitude, latitude: loc.latitude },
        used_default_location: loc.used_default_location,
      };
    }

    async function runPreview(reason='auto'){
      const birth = readBirthInfo();
      hideErrIn(errExp);
      if (!birth.ok){
        lastPreviewOk = false;
        btnSave.disabled = true;
        setPreviewState('idle');
        previewBody.innerHTML = `<div class="preview__note">填写出生日期/时间后将自动生成；或点击“生成预览”。</div>`;
        if (reason === 'manual'){
          showErrIn(errExp, '请先补全：性别 / 出生日期 / 出生时间');
        }
        return;
      }

      const key = JSON.stringify({
        gender: birth.gender,
        birthday_local: toBirthdayLocal(birth.birthDate, birth.birthTime),
        tz_offset_hours: birth.tz,
        location: birth.location,
      });
      if (key === lastPreviewKey && lastPreviewOk) {
        btnSave.disabled = false;
        return;
      }
      lastPreviewKey = key;

      setPreviewState('loading');
      previewBody.innerHTML = `<div class="preview__note">正在生成预览…</div>`;
      btnSave.disabled = true;

      const ticket = ++inflight;
      try{
        const payload = JSON.parse(key);
        const data = await postJson('/api/auth/preview', payload);
        if (ticket !== inflight) return;
        lastPreviewOk = true;
        setPreviewState('ready');
        previewBody.innerHTML = buildPreviewHtml(data);
        btnSave.disabled = false;
      }catch(err){
        if (ticket !== inflight) return;
        lastPreviewOk = false;
        setPreviewState('error');
        previewBody.innerHTML = `<div class="preview__note">预览失败：${escapeHtml(String(err?.message || err))}</div>`;
        btnSave.disabled = false; // allow saving even if preview fails; birth info might still be valid
      }
    }

    function schedulePreview(){
      if (previewTimer) window.clearTimeout(previewTimer);
      previewTimer = window.setTimeout(() => runPreview('auto'), 420);
    }

    // Masks
    dateEl.addEventListener('input', () => {
      const next = normalizeDateInput(dateEl.value);
      if (next !== dateEl.value) dateEl.value = next;
      saveDraft();
      schedulePreview();
    });
    timeEl.addEventListener('input', () => {
      const next = normalizeTimeInput(timeEl.value);
      if (next !== timeEl.value) timeEl.value = next;
      saveDraft();
      schedulePreview();
    });
    timeEl.addEventListener('blur', () => {
      const next = normalizeTimeComplete(timeEl.value);
      if (next && next !== timeEl.value) timeEl.value = next;
      saveDraft();
      schedulePreview();
    });
    [genderEl, tzEl, locNameEl, lonEl, latEl].forEach((el) => {
      el.addEventListener('input', () => { saveDraft(); schedulePreview(); });
      el.addEventListener('change', () => { saveDraft(); schedulePreview(); });
    });

    // Actions
    root.addEventListener('click', (e) => {
      const btn = e.target?.closest?.('[data-action]');
      const action = btn?.getAttribute?.('data-action');
      if (!action) return;
      if (action === 'set-noon'){
        timeEl.value = '12:00';
        saveDraft();
        schedulePreview();
      }
      if (action === 'preview'){
        runPreview('manual');
      }
    });

    // Sheet controls
    function showSheet(mode){
      if (!sheet) return;
      sheet.classList.add('show');
      sheet.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      switchAuthMode(mode);
      window.setTimeout(() => {
        const focusEl = mode === 'login' ? $('#login-email') : $('#reg-email');
        focusEl?.focus?.();
      }, 0);
    }
    function hideSheet(){
      if (!sheet) return;
      sheet.classList.remove('show');
      sheet.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      hideErrIn(errAuth);
    }
    function switchAuthMode(mode){
      const login = mode === 'login';
      if (segLogin && segRegister){
        segLogin.classList.toggle('active', login);
        segRegister.classList.toggle('active', !login);
        segLogin.setAttribute('aria-selected', String(login));
        segRegister.setAttribute('aria-selected', String(!login));
      }
      paneLogin?.classList.toggle('hidden', !login);
      paneRegister?.classList.toggle('hidden', login);
    }

    btnSave.addEventListener('click', () => showSheet('register'));

    document.addEventListener('click', (e) => {
      const el = e.target?.closest?.('[data-action]');
      const action = el?.getAttribute?.('data-action');
      if (!action) return;
      if (action === 'open-login'){
        showSheet('login');
      }
      if (action === 'close-sheet'){
        hideSheet();
      }
      if (action === 'switch-login'){
        showSheet('login');
      }
      if (action === 'switch-register'){
        showSheet('register');
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideSheet();
    });

    segRegister?.addEventListener('click', () => switchAuthMode('register'));
    segLogin?.addEventListener('click', () => switchAuthMode('login'));

    // Register / login submit (reuse preview birth info)
    regForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideErrIn(errAuth);

      const birth = readBirthInfo();
      if (!birth.ok){
        hideSheet();
        showErrIn(errExp, '请先补全出生信息（性别/日期/时间），生成预览后再保存。');
        dateEl.focus();
        return;
      }

      const fd = new FormData(regForm);
      const email = String(fd.get('email') || '').trim();
      const password = String(fd.get('password') || '');
      const name = String(fd.get('name') || '').trim();
      if (!name){
        showErrIn(errAuth, '昵称为必填项');
        return;
      }

      try{
        await postJson('/api/auth/register', {
          email,
          password,
          name,
          gender: birth.gender,
          birthday_local: toBirthdayLocal(birth.birthDate, birth.birthTime),
          tz_offset_hours: birth.tz,
          location: birth.location,
        });
        try { sessionStorage.removeItem('fortune_auth_draft_v1'); } catch {}
        location.href = '/main';
      }catch(err){
        showErrIn(errAuth, String(err?.message || err));
      }
    });

    loginForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideErrIn(errAuth);
      const fd = new FormData(loginForm);
      const email = String(fd.get('email') || '').trim();
      const password = String(fd.get('password') || '');
      try{
        await postJson('/api/auth/login', { email, password });
        location.href = '/main';
      }catch(err){
        showErrIn(errAuth, String(err?.message || err));
      }
    });

    // init defaults
    loadDraft();
    if (!String(tzEl.value || '').trim()) tzEl.value = String(getDefaultTz());

    // Handle mode from URL
    const url = new URL(location.href);
    const mode = url.searchParams.get('mode') || '';
    const pathname = location.pathname || '';
    if (mode === 'register' || pathname === '/register'){
      // Encourage preview first; but open the save sheet so users can "save" immediately after preview.
      showSheet('register');
    } else if (mode === 'login'){
      showSheet('login');
    }

    // === Mode Tab Switching ===
    modeTabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const mode = tab.getAttribute('data-mode');
        if (mode === currentMode) return;
        currentMode = mode;
        modeTabs.forEach((t) => {
          const isActive = t.getAttribute('data-mode') === mode;
          t.classList.toggle('active', isActive);
          t.setAttribute('aria-selected', String(isActive));
        });
        // Re-fetch validation points for new mode
        if (lastPreviewOk) {
          fetchValidationPoints();
        }
      });
    });

    // === Validation Points ===
    async function fetchValidationPoints() {
      const birth = readBirthInfo();
      if (!birth.ok) return;

      if (validationInflight > 0) return;
      validationInflight++;

      try {
        const payload = {
          mode: currentMode,
          gender: birth.gender,
          birthday_local: toBirthdayLocal(birth.birthDate, birth.birthTime),
          tz_offset_hours: birth.tz,
          location: birth.location,
        };
        const data = await postJson('/api/auth/validation-points', payload);
        const points = data?.points || [];
        if (points.length > 0) {
          renderValidationPoints(points);
          if (validationCard) {
            validationCard.classList.add('show');
          }
        }
      } catch (err) {
        console.warn('validation-points error:', err);
      } finally {
        validationInflight--;
      }
    }

    function renderValidationPoints(points) {
      if (!validationPoints) return;
      const html = points.map((text) => `
        <div class="validation-point">
          <div class="validation-point__check">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12l5 5L20 7"/></svg>
          </div>
          <div class="validation-point__text">${escapeHtml(String(text))}</div>
        </div>
      `).join('');
      validationPoints.innerHTML = html;
    }

    // Extend runPreview to also fetch validation points on success
    const originalRunPreviewOk = () => {
      // After preview succeeds, fetch validation points
      if (lastPreviewOk) {
        fetchValidationPoints();
      }
    };

    // Patch: hook into setPreviewState to trigger validation points fetch
    const _originalSetPreviewState = setPreviewState;
    setPreviewState = function(state) {
      _originalSetPreviewState(state);
      if (state === 'ready') {
        window.setTimeout(() => fetchValidationPoints(), 200);
      }
    };

    // === Inline Auth Toggle ===
    function switchInlineAuth(mode) {
      const isRegister = mode === 'register';
      if (toggleRegister) {
        toggleRegister.classList.toggle('active', isRegister);
        toggleRegister.setAttribute('aria-selected', String(isRegister));
      }
      if (toggleLogin) {
        toggleLogin.classList.toggle('active', !isRegister);
        toggleLogin.setAttribute('aria-selected', String(!isRegister));
      }
      if (inlineRegister) inlineRegister.classList.toggle('show', isRegister);
      if (inlineLogin) inlineLogin.classList.toggle('show', !isRegister);
      hideErrIn(errInline);
    }

    toggleRegister?.addEventListener('click', () => switchInlineAuth('register'));
    toggleLogin?.addEventListener('click', () => switchInlineAuth('login'));

    // === Inline Register Form Submit ===
    inlineRegisterForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideErrIn(errInline);

      const birth = readBirthInfo();
      if (!birth.ok) {
        showErrIn(errInline, '请先补全出生信息（性别/日期/时间），生成预览后再保存。');
        dateEl.focus();
        return;
      }

      const fd = new FormData(inlineRegisterForm);
      const email = String(fd.get('email') || '').trim();
      const password = String(fd.get('password') || '');
      const name = String(fd.get('name') || '').trim();
      if (!name) {
        showErrIn(errInline, '昵称为必填项');
        return;
      }

      try {
        await postJson('/api/auth/register', {
          email,
          password,
          name,
          gender: birth.gender,
          birthday_local: toBirthdayLocal(birth.birthDate, birth.birthTime),
          tz_offset_hours: birth.tz,
          location: birth.location,
        });
        try { sessionStorage.removeItem('fortune_auth_draft_v1'); } catch {}
        location.href = '/main';
      } catch (err) {
        showErrIn(errInline, String(err?.message || err));
      }
    });

    // === Inline Login Form Submit ===
    inlineLoginForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideErrIn(errInline);
      const fd = new FormData(inlineLoginForm);
      const email = String(fd.get('email') || '').trim();
      const password = String(fd.get('password') || '');
      try {
        await postJson('/api/auth/login', { email, password });
        location.href = '/main';
      } catch (err) {
        showErrIn(errInline, String(err?.message || err));
      }
    });

    // === Enable inline register button when preview is ready ===
    function updateInlineRegisterBtn() {
      if (btnInlineRegister) {
        btnInlineRegister.disabled = !lastPreviewOk;
      }
    }

    // Patch setPreviewState again to update inline register button
    const _setPreviewStateForBtn = setPreviewState;
    setPreviewState = function(state) {
      _setPreviewStateForBtn(state);
      updateInlineRegisterBtn();
    };

    // kick off preview if possible
    schedulePreview();
  }

  return { initLogin, initRegister, initAuthExperience };
})();
