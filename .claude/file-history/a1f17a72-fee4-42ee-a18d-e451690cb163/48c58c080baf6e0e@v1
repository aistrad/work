"""
海报生成API路由
"""

from __future__ import annotations

from typing import Any, Dict, Optional

from fastapi import APIRouter, Request
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field

from api.deps import require_auth, require_csrf
from services.poster_service import PosterRequest, PosterType, poster_service


router = APIRouter(prefix="/api/poster", tags=["poster"])


def _ok(data: Dict[str, Any] | None = None) -> JSONResponse:
    return JSONResponse({"ok": True, "data": data or {}})


def _err(status: int, code: str, message: str, detail: Optional[Dict[str, Any]] = None) -> JSONResponse:
    return JSONResponse(
        {"ok": False, "error": {"code": code, "message": message, "detail": detail or {}}},
        status_code=status,
    )


class GeneratePosterRequest(BaseModel):
    poster_type: str = Field(..., description="personality|mood|fortune|pairing|achievement|help")
    context: Optional[Dict[str, Any]] = Field(default_factory=dict)
    style: str = Field("modern", description="modern|vintage|playful")


@router.post("/generate")
def generate_poster(req: GeneratePosterRequest, request: Request):
    """
    生成海报

    POST /api/poster/generate
    {
        "poster_type": "personality",  // personality|mood|fortune|pairing|achievement|help
        "context": {                   // 可选的上下文
            "mood": "开心",            // mood类型需要
            "fortune_keywords": "财运旺", // fortune类型需要
            "fortune_score": 85,
            "achievement": "完成了XXX",   // achievement类型需要
            "help_topic": "需要帮忙做XXX" // help类型需要
        },
        "style": "modern"             // modern|vintage|playful
    }

    Returns:
    {
        "ok": true,
        "data": {
            "poster_id": "uuid",
            "job_id": 123,
            "status": "processing",
            "text_content": "生成的文案",
            "created_at": "2026-01-01T12:00:00"
        }
    }
    """
    auth = require_auth(request)
    require_csrf(request, auth)
    user_id = int(auth["user_id"])

    # 验证 poster_type
    poster_type_str = req.poster_type.lower().strip()
    try:
        poster_type = PosterType(poster_type_str)
    except ValueError:
        return _err(400, "invalid_request", f"invalid_poster_type: {poster_type_str}")

    # 验证 style
    style = req.style.lower().strip()
    if style not in ("modern", "vintage", "playful"):
        style = "modern"

    poster_request = PosterRequest(
        user_id=user_id,
        poster_type=poster_type,
        context=req.context or {},
        style=style,
    )

    result = poster_service.generate_poster(poster_request)

    if result.status == "error":
        return _err(500, "internal_error", result.error_message or "poster_generation_failed")

    return _ok(result.to_dict())


@router.get("/{poster_id}")
def get_poster(poster_id: str, request: Request):
    """
    获取海报状态

    GET /api/poster/{poster_id}

    Returns:
    {
        "ok": true,
        "data": {
            "poster_id": "uuid",
            "job_id": 123,
            "status": "completed",  // queued|processing|completed|error
            "text_content": "文案内容",
            "image_url": "https://...",  // 完成后有值
            "created_at": "...",
            "completed_at": "..."
        }
    }
    """
    auth = require_auth(request)
    user_id = int(auth["user_id"])

    result = poster_service.get_poster_status(poster_id, user_id)

    if not result:
        return _err(404, "not_found", "poster_not_found")

    return _ok(result.to_dict())


@router.get("")
def list_posters(request: Request, limit: int = 20):
    """
    列出用户的海报历史

    GET /api/poster?limit=20

    Returns:
    {
        "ok": true,
        "data": {
            "posters": [
                {
                    "poster_id": "uuid",
                    "poster_type": "personality",
                    "status": "completed",
                    "text_content": "文案",
                    "image_url": "https://...",
                    "created_at": "..."
                },
                ...
            ]
        }
    }
    """
    auth = require_auth(request)
    user_id = int(auth["user_id"])

    limit = max(1, min(100, limit))
    posters = poster_service.list_posters(user_id, limit)

    return _ok({"posters": posters})
