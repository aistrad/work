-- Fortune AI v4 - Poster & K-line tables
-- Phase 3: 海报生成
-- Phase 4: K线系统

-- ===== Poster Table =====
CREATE TABLE IF NOT EXISTS fortune_poster (
    poster_id TEXT PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    poster_type TEXT NOT NULL CHECK (poster_type IN ('personality', 'mood', 'fortune', 'pairing', 'achievement', 'help')),
    job_id INTEGER,  -- gemini job id for image generation
    status TEXT NOT NULL DEFAULT 'queued' CHECK (status IN ('queued', 'processing', 'completed', 'error')),
    text_content TEXT,  -- 生成的文案
    image_url TEXT,     -- 生成的图片URL
    style TEXT DEFAULT 'modern',  -- modern | vintage | playful
    context JSONB DEFAULT '{}',   -- 额外上下文
    error_message TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    completed_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_poster_user ON fortune_poster(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_poster_status ON fortune_poster(status);

-- ===== K-line Daily Data Table =====
CREATE TABLE IF NOT EXISTS fortune_kline_daily (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    date DATE NOT NULL,
    open_score NUMERIC(5,2) NOT NULL,   -- 开盘分数 (早间)
    high_score NUMERIC(5,2) NOT NULL,   -- 最高分数
    low_score NUMERIC(5,2) NOT NULL,    -- 最低分数
    close_score NUMERIC(5,2) NOT NULL,  -- 收盘分数 (晚间)
    volume INTEGER DEFAULT 0,           -- 当日活动次数
    emotion_avg NUMERIC(5,2),           -- 情绪平均
    action_count INTEGER DEFAULT 0,     -- 行动完成数
    drivers JSONB DEFAULT '[]',         -- 当日关键驱动因素
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, date)
);

CREATE INDEX IF NOT EXISTS idx_kline_user_date ON fortune_kline_daily(user_id, date DESC);

-- ===== Settings Extended Preferences (Phase 6 预留) =====
-- 扩展 fortune_user_preferences 表以支持更多设置选项
DO $$
BEGIN
    -- 添加新字段 (如果不存在)
    ALTER TABLE fortune_user_preferences
        ADD COLUMN IF NOT EXISTS preferred_fortune_mode TEXT DEFAULT 'bazi' CHECK (preferred_fortune_mode IN ('bazi', 'ziwei', 'astro')),
        ADD COLUMN IF NOT EXISTS glm_model TEXT DEFAULT 'glm-4.7',
        ADD COLUMN IF NOT EXISTS gemini_model TEXT,
        ADD COLUMN IF NOT EXISTS report_backend TEXT DEFAULT 'glm' CHECK (report_backend IN ('glm', 'gemini')),
        ADD COLUMN IF NOT EXISTS theme TEXT DEFAULT 'system' CHECK (theme IN ('light', 'dark', 'system')),
        ADD COLUMN IF NOT EXISTS locale TEXT DEFAULT 'zh-CN';
EXCEPTION
    WHEN duplicate_column THEN NULL;
END $$;
