# Fortune AI 核心功能模块设计 v1.0

> **定位**: 基于四层心理架构 (L0-L3) 的可执行功能模块
>
> **目标**: 引流 → 试用 → 留存 → 社交 → 引流 的闭环增长

---

## 0. 一页总览（北极星体验）

### 0.1 北极星体验（5 分钟闭环）

用户第一次接触 Fortune AI 时，不需要学任何术语、不需要填复杂问卷：

1) **30 秒**：输入生辰/地点 → 得到 3 个「那就是我」验证点（建立信任）  
2) **3 分钟**：一键生成「人生说明书」结构化报告（玄学确定性 × 心理学行动图式）  
3) **5 分钟**：给出 ≤3 条可执行处方 + 承诺邀请（把“焦虑”落到“动作”）  

### 0.2 三大核心模块（只做最强三件事）

| 核心模块 | 用户得到什么 | 对应增长阶段 |
|---|---|---|
| **一键深度报告**（玄学 × 心理） | 专业、可追溯的「人生说明书」+ 第一条行动处方 | 试用/转化 |
| **状态量化 × 人生 K 线** | 可量化、可回顾、可解释的状态趋势（含预警与干预） | 留存 |
| **隐私社交引擎**（合盘 + 吐槽海报 + 能量互赠） | 不暴露隐私也能“玩起来/被理解/被加油”，并带来新用户 | 社交/引流 |

### 0.3 成长闭环（引流 → 试用 → 留存 → 社交 → 引流）

```
内容触达/海报种草 → 免费快速解读（信任） → 深度报告（价值锚点） → 每日指引+K线（陪伴）
         ↑                                                                │
         └──────────── 吐槽海报/合盘邀请/加油打赏（社交传播） ───────────────┘
```

## 一、设计原则

### 1.1 架构对齐

所有核心功能必须与 Soul OS 四层架构深度对齐：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Soul OS 四层架构 × 功能模块映射                       │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  L3: Synthesis (意识/自我)                                              │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 元认知仲裁器 - GLM Agent                                          │  │
│  │ → 综合 L0/L1/L2 输出，生成「结论 + 处方 + 承诺邀请」               │  │
│  └───────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────┤
│  L2: Agents (策略/超我)                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 多视角并行分析 Agent                                              │  │
│  │ → 八字解读 Agent / 心理学分析 Agent / 行动教练 Agent              │  │
│  └───────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────┤
│  L1: Schema (特质/图式)                                                 │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ PERMA / VIA / CBT 图式 + 行为证据汇总                             │  │
│  │ → 用户状态量化 (State Score) + 人生K线                            │  │
│  └───────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────┤
│  L0: Firmware (定数/本我)                                               │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 八字/星盘 + 用户档案（快照化、可追溯）                            │  │
│  │ → 深度报告生成 / 合盘匹配                                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 核心设计约束

| 约束 | 说明 |
|-----|------|
| **Agent 优先** | 所有分析由专业 Agent 完成，非通用 LLM 泛聊 |
| **确定性优先** | L0 层事实（八字/星盘）计算结果可追溯、可验证 |
| **表达层分离** | 专业分析结构化输出（A2UI/Viewer），对话只做“教练表达” |
| **行动闭环** | 每次输出必须落到可执行处方 + 承诺机制 |
| **反依赖机制** | 防止沉迷“算命”，连续追问会强制落到现实行动实验 |
| **隐私保护** | 合盘等社交功能不暴露核心隐私数据 |
| **分层渗透** | 交互中逐步引入用户 Profile Context |
| **风险边界** | 不替代医疗/法律/投资建议；负面信息必须附带“你可以做什么” |

---

## 二、核心模块一：一键深度报告生成系统（玄学 × 心理）

### 2.1 模块定位

**一句话**: 用户输入最少信息，获得媲美专业咨询师的深度分析报告。

**解决痛点**:
- 传统命理/心理咨询：贵（单次 200-2000 RMB）+ 慢（排队预约）+ 不可追溯
- 现有 AI 工具：泛化、不专业、缺乏框架

**架构优势**:
- L0 确定性数据 → L2 多 Agent 专业分析 → L3 综合输出
- 知识库 RAG 检索 + 规则引擎 → 可解释、可追溯

### 2.2 一键生成：用户路径（最小输入 → 最大专业输出）

**入口设计（MVP）**：
- Chat 里一句话：`“生成我的人生说明书”`（默认走八字基础解读 → 引导深度）
- Bento 一键卡片：`人生说明书 / 心理画像 / 决策模板`
- Viewer 常驻展示长内容；Chat 只输出“教练表达 + 下一步动作”（对齐 `design.md` 两栏交互）

**用户路径**：
1) **最小输入**：生辰 + 地点 + 性别（可选：当前最想解决的问题 1 句）
2) **秒级信任**：先输出 3 个“那就是我”验证点（只依赖 L0 事实）
3) **专业展开**：展示命盘结构、引用依据（kb_refs / rule_ids / facts_hash）
4) **行动落地**：≤3 条处方 + 承诺邀请（start/schedule/ask/opt_out）
5) **自然扩展**：在用户确认“有用”后，再逐层询问/收集 Context（L1-L2）

> 关键原则：**先给价值，再拿信息**（渐进式 Profile），避免一上来填表导致流失。

### 2.3 报告类型矩阵

| 报告类型 | 输入要求 | 输出规模 | 定价策略 | 用途 |
|---------|---------|---------|---------|-----|
| **八字基础解读** | 生辰+地点 | 3-5 页 | 免费 | 冷启动/建立信任 |
| **八字深度报告** | 生辰+地点+性别 | 15-25 页 | ¥29-49 | 核心付费产品 |
| **流年运势报告** | 已有八字+目标年份 | 5-8 页 | ¥9-19 | 复购引擎 |
| **心理深度画像** | 上传日记/对话记录 | 10-15 页 | ¥39-69 | 差异化服务 |
| **决策分析报告** | 具体问题+选项 | 3-5 页 | ¥19-29 | 高频场景 |

### 2.4 报告生成架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    深度报告生成流水线                                    │
└─────────────────────────────────────────────────────────────────────────┘

     用户输入                L0 计算层                 L2 Agent 层
    ──────────→            ──────────→              ──────────→

  ┌──────────────┐      ┌──────────────┐      ┌──────────────────────┐
  │ 最小必要输入  │      │ 确定性计算    │      │ 多 Agent 并行分析    │
  │              │      │              │      │                      │
  │ • 生辰时间   │  →   │ • 真太阳时    │  →   │ Agent-1: 格局分析   │
  │ • 出生地点   │      │ • 四柱排盘    │      │ Agent-2: 性格解读   │
  │ • 性别      │      │ • 十神推导    │      │ Agent-3: 大运流年   │
  │ • (可选)问题 │      │ • 神煞计算    │      │ Agent-4: 行动建议   │
  └──────────────┘      └──────────────┘      └──────────────────────┘
                              │                        │
                              ▼                        ▼
                       ┌──────────────┐      ┌──────────────────────┐
                       │ facts.json   │      │ 知识库 RAG 检索      │
                       │ facts_hash   │      │ • bazi_kb_chunk     │
                       └──────────────┘      │ • 专业文献引用       │
                                             └──────────────────────┘
                                                      │
                                                      ▼
                                             ┌──────────────────────┐
                                             │ L3 Synthesis Agent   │
                                             │                      │
                                             │ • 综合多视角输出      │
                                             │ • 冲突仲裁           │
                                             │ • 风险边界标注       │
                                             │ • 行动处方生成       │
                                             └──────────────────────┘
                                                      │
                                                      ▼
                                             ┌──────────────────────┐
                                             │ 结构化报告输出        │
                                             │                      │
                                             │ • PDF / Web 阅读     │
                                             │ • 分享海报           │
                                             │ • A2UI 交互版        │
                                             └──────────────────────┘
```

### 2.5 报告结构模板（八字深度报告）

```markdown
# 你的人生说明书

## 第一章：命盘概览
- 四柱信息（年/月/日/时柱）
- 日主分析（你的核心能量）
- 五行分布图 + 强弱判定

## 第二章：性格深度解析
- 性格优势（基于十神 + 心理学映射）
- 性格盲区（过度使用的风险）
- 人际模式分析

## 第三章：事业与财运
- 适合的职业方向
- 财运模式（正财/偏财倾向）
- 职业发展节奏建议

## 第四章：情感与关系
- 情感模式分析
- 理想伴侣特质
- 关系经营建议

## 第五章：大运流年
- 当前大运解读
- 近 3-5 年流年预测
- 关键时间窗口提醒

## 第六章：行动指南
- 本月 3 个核心行动
- 需要避免的 3 个陷阱
- 推荐的成长计划

## 附录
- 术语解释
- 计算依据与引用
- facts_hash（可验证）
```

### 2.6 冷启动信任建立机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    信任建立三步法                                        │
└─────────────────────────────────────────────────────────────────────────┘

Step 1: 即时验证 (30秒内)
────────────────────────

  用户输入生辰
       │
       ▼
  ┌─────────────────────────────────────┐
  │ 快速计算 → 输出 3 个"那就是我"验证点  │
  │                                     │
  │ 例如：                               │
  │ "你是不是经常..."                    │
  │ "你在人际关系中往往..."              │
  │ "你面对压力时的第一反应是..."        │
  └─────────────────────────────────────┘
       │
       ▼
  用户反应："太准了！"  → 转化率 +40%


Step 2: 专业展示 (3分钟内)
───────────────────────────

  ┌─────────────────────────────────────┐
  │ 展示完整八字结构 + 专业术语解释       │
  │                                     │
  │ • 可视化命盘图                       │
  │ • 术语 hover 解释                    │
  │ • 引用经典文献                       │
  └─────────────────────────────────────┘
       │
       ▼
  用户感受："这个系统很专业"


Step 3: 价值锁定 (5分钟内)
───────────────────────────

  ┌─────────────────────────────────────┐
  │ 给出首个行动处方 + 承诺邀请           │
  │                                     │
  │ "基于你的情况，建议你本周先做..."     │
  │ "你愿意试试吗？"                     │
  └─────────────────────────────────────┘
       │
       ▼
  用户行为：开始行动 → 形成闭环
```

### 2.7 心理学报告生成（差异化能力）

**输入方式**:
- 上传日记/朋友圈截图/聊天记录
- 填写心理学量表（PERMA/VIA简版）
- 自由描述当前困惑

**分析 Agent 流程**:

```
用户文本输入
     │
     ▼
┌────────────────────────────────────────────────────────────────────────┐
│                    心理学分析 Agent 流水线                              │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐             │
│  │ 情绪识别     │    │ 认知模式     │    │ 行为模式     │             │
│  │ Agent        │    │ 分析 Agent   │    │ 分析 Agent   │             │
│  └──────────────┘    └──────────────┘    └──────────────┘             │
│         │                  │                   │                      │
│         ▼                  ▼                   ▼                      │
│  ┌──────────────────────────────────────────────────────────────────┐ │
│  │                     综合分析 Agent                                │ │
│  │  • 映射到 PERMA 维度                                             │ │
│  │  • 识别 CBT 认知扭曲                                             │ │
│  │  • 生成可执行干预建议                                            │ │
│  └──────────────────────────────────────────────────────────────────┘ │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
     │
     ▼
┌────────────────────────────────────────────────────────────────────────┐
│ 输出：心理深度画像报告                                                  │
│ • 情绪状态分析（可视化）                                                │
│ • 认知模式洞察                                                         │
│ • 行为模式分析                                                         │
│ • 优势与资源识别                                                       │
│ • 成长路径建议（可执行）                                                │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.8 输出契约（A2UI + 可追溯 + 可分享）

**目标**：把“玄学/心理学洞察”变成**可验证、可执行、可分享**的结构化交付物。

最小交付结构（每次输出都必须包含）：
1) **结论（Conclusion）**：一句话“你现在最关键的矛盾/机会点是什么”
2) **依据（Evidence）**：facts_hash + rule_ids + kb_refs（让用户相信“不是瞎编”）
3) **处方（Prescriptions）**：≤3 条动作（含时长/难度/触发条件）
4) **承诺邀请（Commitment Ask）**：必须问“你愿意先做哪一个？”
5) **风险边界（Risk Boundary）**：不替代医疗/法律/投资建议；负面信息必须给出“你可以做什么”
6) **分享包（Share Pack）**：脱敏可传播文案 + 海报参数（见模块三）

### 2.9 心理材料隐私处理（必须显式告知）

- **最小化**：默认只提取心理维度特征与行为证据，不保留原文（可选：用户勾选允许保存）
- **脱敏**：在进入模型前做 PII 识别与遮罩（姓名/地址/公司/手机号/身份证等）
- **可控**：用户一键删除材料与画像；系统只保留可追溯的结构化摘要与 hashes
- **透明**：明确告知“不会把你的材料展示给任何第三方/好友；合盘也不互传原始信息”

---

## 三、核心模块二：用户状态量化与人生K线

### 3.1 模块定位

**一句话**: 把抽象的"状态"变成可追踪的数字，把散点的记录变成可回顾的趋势。

**解决痛点**:
- "我最近状态不好" → 多不好？哪个维度？比上周如何？
- "我感觉自己有进步" → 有数据支撑吗？趋势是什么？

**架构优势**:
- L1 层 Schema（PERMA/VIA）提供科学维度
- 多数据源融合（情绪签到 + 承诺完成 + 对话分析）

### 3.2 状态量化模型

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    State Score 计算模型                                 │
└─────────────────────────────────────────────────────────────────────────┘

                         State Score (0-100)
                               │
        ┌──────────────────────┼──────────────────────┐
        │                      │                      │
        ▼                      ▼                      ▼
  ┌───────────┐          ┌───────────┐          ┌───────────┐
  │  情绪指数  │          │  行动指数  │          │  成长指数  │
  │   (40%)   │          │   (35%)   │          │   (25%)   │
  └─────┬─────┘          └─────┬─────┘          └─────┬─────┘
        │                      │                      │
        ▼                      ▼                      ▼
  ┌───────────┐          ┌───────────┐          ┌───────────┐
  │ • 情绪签到 │          │ • 承诺完成率│         │ • 计划进度 │
  │ • 对话情感 │          │ • 行动及时性│         │ • 复盘深度 │
  │ • 波动稳定性│         │ • 任务难度  │          │ • 洞察质量 │
  └───────────┘          └───────────┘          └───────────┘
```

### 3.3 PERMA 五维状态

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    PERMA 状态雷达图                                     │
└─────────────────────────────────────────────────────────────────────────┘

                        P (积极情绪)
                            ●
                           /|\
                          / | \
                         /  |  \
                        /   |   \
       M (意义感)  ●───────●───────●  E (投入度)
                        \   |   /
                         \  |  /
                          \ | /
                           \|/
                            ●
                        A (成就感)
                            |
                            ●
                        R (关系)

数据来源:
┌─────────────────────────────────────────────────────────────────────────┐
│ P - 积极情绪: 情绪签到正向比例 + 对话情感分析                            │
│ E - 投入度: 任务开始率 + 深度工作时长（用户上报）                         │
│ R - 关系: 社交互动频率 + 合盘使用 + 感恩练习对象数                        │
│ M - 意义感: 目标关联度 + 复盘深度评分                                    │
│ A - 成就感: 任务完成率 + 里程碑达成 + 计划毕业                           │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.4 人生 K 线设计

**设计理念**: 借鉴股票 K 线的直观性，让用户"一眼看懂"自己的状态趋势。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    人生 K 线示意图                                       │
└─────────────────────────────────────────────────────────────────────────┘

State
Score
 100 ┤
     │                              ┌───┐
  80 ┤          ┌───┐               │   │
     │    ┌───┐ │ ● │         ┌───┐ │ ● │
  60 ┤    │ ● │ │ │ │   ┌───┐ │ ● │ │ │ │
     │ ┌──┤ │ │ │ │ │   │ ● │ │ │ │ │ │ │
  40 ┤ │  │ │ │ │ │ │ ┌─┤ │ │ │ │ │ │ │ │
     │ │  │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │
  20 ┤ │  │ │ │ │ │ │ │ │ │ │ │ │ │ │ │ │
     │ │  └─┴─┘ └─┴─┘ └─┴─┴─┘ └─┴─┘ └─┴─┘
   0 ┼──┴────────────────────────────────→ 时间
       W1   W2   W3   W4   W5   W6   W7

图例:
┌─────────────────────────────────────────────────────────────────────────┐
│  ● = 周收盘价（State Score 周均值）                                      │
│  柱体 = 周高-低区间                                                      │
│  绿色 = 本周 > 上周（上涨）                                              │
│  红色 = 本周 < 上周（下跌）                                              │
│  橙色 = 波动较大（需关注）                                               │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.5 K 线数据结构

```json
{
  "user_id": 123,
  "period": "weekly",
  "period_start": "2026-01-01",
  "period_end": "2026-01-07",
  "kline": {
    "open": 62,      // 周一 State Score
    "close": 68,     // 周日 State Score
    "high": 75,      // 周内最高
    "low": 55,       // 周内最低
    "avg": 65,       // 周均值
    "change": "+6",  // 变化
    "trend": "up"    // 趋势判定
  },
  "drivers": [
    {"dimension": "action", "delta": "+7", "evidence": "承诺完成率提升"},
    {"dimension": "emotion", "delta": "-3", "evidence": "周五负向情绪峰值"}
  ],
  "confidence": "medium",
  "perma": {
    "P": 70, "E": 65, "R": 55, "M": 68, "A": 72
  },
  "key_events": [
    {"date": "2026-01-03", "event": "完成21天感恩计划", "impact": "+5"},
    {"date": "2026-01-05", "event": "情绪低谷（工作压力）", "impact": "-8"}
  ],
  "ai_insight": "本周整体上涨，主要得益于计划完成的成就感。周五的情绪低谷值得关注，建议下周工作压力大时优先使用3分钟降噪协议。"
}
```

### 3.6 K 线交互功能

| 功能 | 描述 | 用户价值 |
|-----|------|---------|
| **缩放查看** | 日/周/月/季/年粒度切换 | 看短期波动或长期趋势 |
| **悬停详情** | 悬停显示当日/当周事件 | 理解"为什么"涨跌 |
| **对比模式** | 与上一周期/去年同期对比 | 量化进步 |
| **时间窗口叠加** | 叠加大运/流年/节气等时间窗口 | 把“预测”变成可行动提醒 |
| **导出分享** | 生成分享图（脱敏） | 社交传播 |
| **AI 解读** | 点击获取 AI 趋势分析 | 专业洞察 |

### 3.7 状态预警机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    JITAI (Just-In-Time Adaptive Intervention)           │
└─────────────────────────────────────────────────────────────────────────┘

触发条件                    系统响应                    用户选项
─────────────────────────────────────────────────────────────────────────

State Score                 主动关怀推送
连续3天 < 40    ──────→    "最近状态不太好，        →  • 聊聊发生了什么
                           要不要聊聊？"                • 做一个3分钟放松
                                                       • 稍后再说

情绪签到                    即时干预建议
强度 ≥ 8 (负向) ──────→    "检测到较强情绪，        →  • 开始3分钟降噪
                           建议先做个降噪"              • 写下来
                                                       • 我可以处理

承诺完成率                  调整建议
连续5天 < 30%   ──────→    "最近任务完成有点难，    →  • 降低任务难度
                           要调整一下吗？"              • 换一个方向
                                                       • 暂停几天
```

### 3.8 防沉迷与安全边界（避免“量化焦虑”）

- **避免伪精度**：State Score 只作为自我觉察仪表盘（展示 drivers 与 confidence），不做诊断结论
- **限制过度查看**：同一日多次刷新只展示“同一结论 + 下一步动作”，避免反复确认
- **极端风险分流**：当文本/签到出现强烈自伤暗示时，优先给出求助资源与“现在能做什么”，并建议线下支持

---

## 四、核心模块三：隐私社交引擎（合盘 + 吐槽海报 + 能量互赠）

### 4.1 模块定位

**一句话**: 让用户可以安全地分享和比较，不暴露核心隐私，同时驱动病毒传播。

**解决痛点**:
- 想知道和 TA 合不合 → 但不想暴露自己的生辰
- 想分享有趣的结果 → 但担心泄露隐私
- 想吐槽/求鼓励 → 但朋友圈太正经

**架构优势**:
- **最小披露原则**：合盘只读取双方的 `facts_hash` 快照与必要字段，输出衍生指标（契合度/维度星级/建议），不互传原始生辰与命盘细节
- **分享默认脱敏**：海报与分享卡只含可传播摘要（维度评分/一句话类型），不含任何可反推的出生信息

### 4.2 隐私保护合盘机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    隐私保护合盘流程                                      │
└─────────────────────────────────────────────────────────────────────────┘

         用户 A                    服务端                    用户 B
    (发起合盘)                  (中立计算)                (被邀请方)
        │                          │                         │
        │  1. 生成合盘邀请码       │                         │
        │  ─────────────────→      │                         │
        │                          │                         │
        │  2. 返回唯一邀请链接     │                         │
        │  ←─────────────────      │                         │
        │                          │                         │
        │  3. 分享链接给 B         │                         │
        │  ──────────────────────────────────────────────→   │
        │                          │                         │
        │                          │   4. B 点击链接         │
        │                          │   ←─────────────────    │
        │                          │                         │
        │                          │   5. B 注册/登录        │
        │                          │   并确认参与合盘        │
        │                          │   ←─────────────────    │
        │                          │                         │
        │     ┌────────────────────┼────────────────────┐    │
        │     │   服务端读取双方八字（不传输给对方）      │    │
        │     │   执行合盘算法                          │    │
        │     │   生成合盘结果（仅输出兼容性指标）       │    │
        │     └────────────────────┼────────────────────┘    │
        │                          │                         │
        │  6. 返回合盘结果给 A     │  6. 返回合盘结果给 B    │
        │  ←─────────────────      │  ─────────────────→     │
        │                          │                         │
        ▼                          ▼                         ▼
  ┌───────────────────────────────────────────────────────────────────┐
  │                         合盘结果展示                               │
  │                                                                   │
  │  • 整体契合度：78% (可分享)                                        │
  │  • 情感维度：★★★★☆                                              │
  │  • 事业维度：★★★☆☆                                              │
  │  • 沟通建议：3 条 (仅各自可见)                                     │
  │                                                                   │
  │  [注意] A 和 B 都看不到对方的具体八字信息                          │
  └───────────────────────────────────────────────────────────────────┘
```

**隐私保障要点（MVP 可落地）**：
- **显式同意**：被邀请方必须确认参与合盘；可随时撤回授权
- **链接可控**：邀请码/链接带 TTL；次数限制；可手动失效
- **结果分层**：可分享的只有总体与维度分；“各自建议”仅本人可见
- **默认匿名**：支持匿名头像/昵称；分享默认不展示任何可识别信息

### 4.3 合盘结果数据结构

```json
{
  "pairing_id": "uuid",
  "user_a_id": 123,
  "user_b_id": 456,
  "created_at": "2026-01-01T10:00:00Z",
  "result": {
    "overall_score": 78,
    "dimensions": {
      "emotional": {"score": 82, "stars": 4, "label": "情感共鸣"},
      "communication": {"score": 71, "stars": 3, "label": "沟通默契"},
      "values": {"score": 85, "stars": 4, "label": "价值观契合"},
      "career": {"score": 65, "stars": 3, "label": "事业互助"},
      "growth": {"score": 80, "stars": 4, "label": "成长互促"}
    },
    "chemistry_type": "互补型",
    "chemistry_description": "你们的组合像水与火，看似矛盾却能相互激发潜能..."
  },
  "advice_for_a": [
    "TA 比较需要空间，给 TA 一些独处时间会更好",
    "沟通时尽量直接表达，TA 不太擅长猜测",
    "在重大决策时，TA 的直觉往往比分析更准"
  ],
  "advice_for_b": [
    "对方比较敏感，批评时注意方式",
    "对方需要更多肯定和认可",
    "对方的计划性很强，尊重 TA 的节奏"
  ],
  "shareable": {
    "title": "我和 TA 的缘分密码",
    "summary": "整体契合度 78%，是互补型组合",
    "image_url": "/api/pairing/123-456/share-image.png"
  }
}
```

### 4.4 吐槽海报系统

**设计理念**: 把用户的状态/洞察变成可分享的社交货币。

**风格边界**：
- 吐槽默认“只吐自己”（自嘲/自我调侃），不对他人做攻击性评价
- 负面内容必须带“可行动出口”（加油/求助/下一步），避免传播绝望感

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    吐槽海报类型矩阵                                      │
└─────────────────────────────────────────────────────────────────────────┘

类型               触发场景                 内容示例                 社交属性
──────────────────────────────────────────────────────────────────────────

【性格吐槽】       完成八字解读后           "系统说我「想太多」      求认同
                                          ...确实，光是决定今天      求安慰
                                          吃什么就用了20分钟"

【情绪吐槽】       情绪签到后               "今日情绪：被生活       求抱抱
                                          暴击但还在假装微笑       求加油
                                          [强颜欢笑.jpg]"

【运势吐槽】       查看流年运势后           "2026年适合蛰伏？       求锦鲤
                                          好的，那我就躺平了       求转运
                                          [理直气壮躺平.jpg]"

【合盘吐槽】       查看合盘结果后           "和 TA 沟通契合度71%    求祝福
                                          怪不得每次吵架都         求经验
                                          像在讲两种语言..."

【成就打卡】       完成计划/里程碑          "21天感恩计划完成！     求点赞
                                          我真的可以坚持！"        求模仿

【求助呼唤】       状态低谷时               "连续3天红盘，          求能量
                                          求各路大神加油站！"      求互动
```

### 4.5 海报生成模板

```
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│   ┌───────────────────────────────────────────────────────────────┐    │
│   │                                                               │    │
│   │                    [用户头像/匿名头像]                         │    │
│   │                                                               │    │
│   │   ─────────────────────────────────────────────               │    │
│   │                                                               │    │
│   │   「  你的吐槽文案/洞察内容  」                                │    │
│   │                                                               │    │
│   │   ─────────────────────────────────────────────               │    │
│   │                                                               │    │
│   │   ┌─────────────────────────────────────────┐                │    │
│   │   │  可视化数据（K线片段/PERMA雷达/契合度）  │                │    │
│   │   └─────────────────────────────────────────┘                │    │
│   │                                                               │    │
│   │   ─────────────────────────────────────────────               │    │
│   │                                                               │    │
│   │   [加油] [打赏能量] [看合盘] [我也要测]                        │    │
│   │                                                               │    │
│   │   ─────────────────────────────────────────────               │    │
│   │                                                               │    │
│   │   长按识别二维码，解锁你的人生说明书                           │    │
│   │   [Fortune AI 二维码]                                         │    │
│   │                                                               │    │
│   └───────────────────────────────────────────────────────────────┘    │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.6 社交互动机制

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    社交互动机制设计                                      │
└─────────────────────────────────────────────────────────────────────────┘

互动类型          发起方          接收方            闭环效果
──────────────────────────────────────────────────────────────────────────

【加油打气】      好友            用户              • 用户收到通知
                 点击"加油"                        • State Score +1
                                                  • 双方关系分 +1

【能量打赏】      好友            用户              • 用户收到「能量包」
                 发送 Aura                        • 可兑换高级功能
                                                  • 双方关系分 +3

【求合盘】        用户            好友              • 好友收到邀请
                 点击"求合盘"                      • 注册后解锁结果
                                                  • 邀请人获奖励

【抄作业】        好友            用户              • 好友复制用户的
                 点击"我也要"                      • 成长计划/行动
                                                  • 双方可互相监督
```

### 4.7 社交裂变增长飞轮

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    社交裂变增长飞轮                                      │
└─────────────────────────────────────────────────────────────────────────┘

                           分享吐槽海报
                          (小红书/朋友圈)
                                │
                                ▼
           ┌────────────────────────────────────────┐
           │                                        │
           ▼                                        │
    ┌─────────────┐                                │
    │  新用户看到  │                                │
    │  扫码体验   │                                │
    └──────┬──────┘                                │
           │                                        │
           ▼                                        │
    ┌─────────────┐      ┌─────────────┐           │
    │  注册获得   │  ─→  │  完成测评   │           │
    │  首次解读   │      │  建立信任   │           │
    └──────┬──────┘      └──────┬──────┘           │
           │                    │                  │
           └────────┬───────────┘                  │
                    ▼                              │
           ┌─────────────┐                         │
           │  生成自己的  │                         │
           │  吐槽海报   │ ────────────────────────┘
           └──────┬──────┘
                  │
                  ▼
           ┌─────────────┐
           │  发起合盘   │
           │  邀请好友   │
           └──────┬──────┘
                  │
                  ▼
           ┌─────────────┐
           │  好友注册   │ ──→ 新一轮循环
           │  解锁结果   │
           └─────────────┘

关键指标:
• K-Factor 目标: > 1.3
• 合盘完成率目标: > 60%
• 海报分享率目标: > 20%
```

---

## 五、用户分层 Context 渗透机制

### 5.1 Context 渗透策略

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    用户 Context 分层渗透                                 │
└─────────────────────────────────────────────────────────────────────────┘

阶段           渗透深度              系统行为                 用户感知
──────────────────────────────────────────────────────────────────────────

【首次接触】   L0 基础               仅使用公开八字信息       "这个系统
               生辰+地点+性别        输出通用性格解读         挺准的"

【注册完成】   L0 + L1 初始化        引入 PERMA 维度          "它开始
               + 首次情绪签到        提供个性化建议           懂我了"

【活跃一周】   L0 + L1 + 行为        根据行为模式调整         "它记得
               任务完成/情绪轨迹     推荐和话术风格           我的情况"

【深度使用】   L0 + L1 + L2          多 Agent 综合分析        "它真的
               + 目标/计划/复盘      引用历史上下文           理解我"

【长期陪伴】   全量 Context          预测性干预               "它比我
               + 趋势 + 规律         主动提供洞察             更了解我"
```

### 5.2 系统 Prompt 动态注入

```python
def build_agent_context(user_id: int, depth: str) -> dict:
    """
    根据用户阶段动态构建 Agent Context
    """
    context = {}

    # L0: 始终可用
    context["l0_facts"] = get_bazi_facts(user_id)

    if depth in ["registered", "active", "deep", "loyal"]:
        # L1: 注册后可用
        context["l1_perma"] = get_perma_scores(user_id)
        context["l1_recent_mood"] = get_recent_checkins(user_id, days=7)

    if depth in ["active", "deep", "loyal"]:
        # 活跃后可用
        context["behavior_patterns"] = get_behavior_patterns(user_id)
        context["commitment_history"] = get_commitment_stats(user_id)
        context["persona_style"] = get_preferred_style(user_id)

    if depth in ["deep", "loyal"]:
        # 深度使用后可用
        context["goals"] = get_active_goals(user_id)
        context["plan_progress"] = get_plan_progress(user_id)
        context["reflection_insights"] = get_recent_reflections(user_id)

    if depth == "loyal":
        # 长期用户
        context["life_kline"] = get_kline_summary(user_id, months=3)
        context["growth_trajectory"] = get_growth_analysis(user_id)
        context["predicted_risks"] = predict_risks(user_id)

    return context
```

### 5.3 "懂你"体验设计

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    "懂你" 体验触点                                       │
└─────────────────────────────────────────────────────────────────────────┘

触点                   系统行为                           用户感知
──────────────────────────────────────────────────────────────────────────

【名字使用】           在关键位置使用用户昵称             "它叫我名字"
                      "张三，今天的指引是..."

【历史引用】           "上次你提到工作压力..."           "它记得我说过的"
                      引用之前对话内容

【模式识别】           "你每次情绪低落时都会..."         "它发现了我的规律"
                      指出行为模式

【预测性建议】         "按照你的八字，下周可能会..."     "它能预见"
                      基于趋势预测

【个性化风格】         根据用户偏好调整语气               "它的语气我喜欢"
                      warm/standard/roast

【进度认可】           "你已经连续7天坚持了！"           "它看到我的努力"
                      肯定成长进步
```

---

## 六、增长闭环设计

### 6.1 完整增长飞轮

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Fortune AI 增长闭环                                   │
└─────────────────────────────────────────────────────────────────────────┘

                         引流
                    (小红书/抖音)
                          │
                          ▼
    ┌─────────────────────────────────────────────────────────────────┐
    │                                                                 │
    │    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐   │
    │    │  免费八字   │  ──→ │  "那就是我!" │  ──→ │  注册完成   │   │
    │    │  快速解读   │      │  信任建立   │      │  深度报告   │   │
    │    └─────────────┘      └─────────────┘      └─────────────┘   │
    │                                                     │          │
    │                              ┌──────────────────────┘          │
    │                              ▼                                 │
    │    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐   │
    │    │  生成海报   │  ←── │  状态追踪   │  ←── │  每日指引   │   │
    │    │  吐槽分享   │      │  人生K线    │      │  行动处方   │   │
    │    └──────┬──────┘      └─────────────┘      └─────────────┘   │
    │           │                                                    │
    │           ▼                                                    │
    │    ┌─────────────┐      ┌─────────────┐                       │
    │    │  好友看到   │  ──→ │  发起合盘   │                       │
    │    │  求合盘    │      │  邀请注册   │                       │
    │    └──────┬──────┘      └──────┬──────┘                       │
    │           │                    │                              │
    │           └────────────────────┘                              │
    │                    │                                          │
    │                    ▼                                          │
    │    ┌─────────────────────────────────────────────────────┐    │
    │    │              新用户获取 (K-Factor > 1.3)             │    │
    │    └─────────────────────────────────────────────────────┘    │
    │                                                                │
    └────────────────────────────────────────────────────────────────┘
                          │
                          ▼
                     新一轮循环
```

### 6.2 关键转化漏斗

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    关键转化漏斗                                          │
└─────────────────────────────────────────────────────────────────────────┘

阶段              指标                目标值            优化手段
──────────────────────────────────────────────────────────────────────────

看到内容         曝光量               -                内容质量 + 投放
     ↓
点击链接         点击率               > 5%             标题/封面优化
     ↓
开始体验         体验启动率           > 80%            加载速度 + 首屏
     ↓
完成解读         解读完成率           > 70%            "那就是我"验证
     ↓
注册账号         注册转化率           > 30%            价值前置 + 简化流程
     ↓
首日活跃         D1 激活率            > 60%            每日指引推送
     ↓
首周留存         W1 留存率            > 35%            成长计划 + K线
     ↓
社交分享         分享率               > 20%            海报模板 + 动机设计
     ↓
邀请成功         邀请转化率           > 40%            合盘机制 + 奖励
     ↓
付费转化         付费率               > 5%             深度报告 + 时机
```

### 6.3 北极星指标追踪

| 指标 | 定义 | 目标 | 数据来源 |
|-----|------|------|---------|
| **WAU** | 周活跃用户 | 增长 10%/周 | `fortune_user.last_login_at` |
| **WCG** | 周闭环完成率 | > 30% | 承诺完成 + 复盘 |
| **K-Factor** | 病毒系数 | > 1.3 | 合盘邀请成功率 |
| **NPS** | 净推荐值 | > 50 | 定期问卷 |
| **D7 Retention** | 7日留存 | > 25% | 登录记录 |
| **Paid Conversion** | 付费转化 | > 5% | 付费订单 |

---

## 七、技术实现要点

### 7.1 API 设计概览

| 模块 | 端点 | 方法 | 描述 |
|-----|------|------|------|
| **Chat/教练** | `/api/chat/ask` | POST | 教练对话 + 快速解读（GLM，输出 A2UI） |
| **确定性事实** | `/api/bazi/facts` | POST | 八字 facts 计算（真太阳时，可追溯） |
| **报告** | `/api/report/bazi/submit` | POST | 异步生成八字报告（backend=cli\|gemini，type=basic\|deep\|annual） |
| | `/api/report/bazi/{job_id}` | GET | 获取八字报告状态/结果（backend 参数匹配） |
| | `/api/report/psychology/submit` | POST | 心理画像报告（材料上传，脱敏处理） |
| | `/api/report/psychology/{job_id}` | GET | 获取心理报告状态/结果 |
| **K线** | `/api/kline/current` | GET | 当前状态 + drivers + confidence |
| | `/api/kline/history` | GET | 历史K线数据（daily/weekly/monthly） |
| | `/api/kline/perma` | GET | PERMA 雷达图数据 |
| | `/api/kline/insight` | GET | AI 趋势洞察（含时间窗口叠加） |
| **合盘** | `/api/pairing/invite` | POST | 生成合盘邀请 |
| | `/api/pairing/accept/{code}` | POST | 接受合盘邀请 |
| | `/api/pairing/{id}` | GET | 获取合盘结果 |
| | `/api/pairing/list` | GET | 我的合盘列表 |
| **社交** | `/api/poster/generate` | POST | 生成分享海报 |
| | `/api/social/cheer` | POST | 加油打气 |
| | `/api/social/tip` | POST | 能量打赏 |
| | `/api/social/notifications` | GET | 社交通知列表 |

### 7.2 数据库扩展

**复用现有 SSOT 表（来自 Final MVP 数据库设计）**：`fortune_user`、`fortune_bazi_snapshot`、`fortune_checkin`、`fortune_commitment`、`fortune_reflection`、`fortune_daily_guidance`、`fortune_external_job` 等。  
本节新增表只用于：K 线聚合快照、合盘邀请与结果、社交互动与海报生成记录。

```sql
-- 合盘记录表
CREATE TABLE IF NOT EXISTS fortune_pairing (
    pairing_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_a_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    user_b_id BIGINT REFERENCES fortune_user(user_id),
    invite_code TEXT UNIQUE NOT NULL,
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending','completed','expired')),
    result JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    completed_at TIMESTAMPTZ
);

-- K线快照表
CREATE TABLE IF NOT EXISTS fortune_kline (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    period TEXT NOT NULL CHECK (period IN ('daily','weekly','monthly')),
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    kline_data JSONB NOT NULL,
    perma_data JSONB NOT NULL,
    key_events JSONB DEFAULT '[]',
    ai_insight TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
    UNIQUE (user_id, period, period_start)
);

-- 社交互动表
CREATE TABLE IF NOT EXISTS fortune_social_interaction (
    id BIGSERIAL PRIMARY KEY,
    from_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    to_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    type TEXT NOT NULL CHECK (type IN ('cheer','tip','copy_plan')),
    amount INT DEFAULT 0,
    message TEXT DEFAULT '',
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- 海报生成记录表
CREATE TABLE IF NOT EXISTS fortune_poster (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    type TEXT NOT NULL CHECK (type IN ('personality','mood','fortune','pairing','achievement')),
    content JSONB NOT NULL,
    image_url TEXT,
    share_count INT DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

---

## 八、实施路线图

### Phase 1: 报告系统 (Week 1-2)
- [ ] 快速八字解读 API
- [ ] 深度报告生成流水线
- [ ] 报告展示页面
- [ ] "那就是我"验证点优化

### Phase 2: K线系统 (Week 3-4)
- [ ] State Score 计算引擎
- [ ] K线数据聚合任务
- [ ] K线可视化组件
- [ ] PERMA 雷达图

### Phase 3: 合盘与社交 (Week 5-6)
- [ ] 合盘邀请/接受流程
- [ ] 合盘算法实现
- [ ] 海报生成服务
- [ ] 社交互动 API

### Phase 4: 增长优化 (Week 7-8)
- [ ] 分享追踪埋点
- [ ] 裂变数据看板
- [ ] A/B 测试框架
- [ ] 增长策略迭代

---

*文档版本: v1.0*
*更新日期: 2026-01-01*
