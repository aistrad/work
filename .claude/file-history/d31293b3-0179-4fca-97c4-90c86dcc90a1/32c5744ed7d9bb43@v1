"""
可解释性生成器 - VibeID v7.0 (四维12原型完整版)

生成用户可理解的原型解释，包括：
- 总结
- 八字洞察
- 星座洞察
- 融合洞察
- 成长方向
- v7.0: 揭晓仪式内容 (三特质、AI第一句话)

V7 变更:
- 接受 Dict 格式的 archetypes (而非 FourDimensionalArchetypes dataclass)
- 返回 Dict 格式的 explanation (而非 Explanation dataclass)
- 新增 generate_reveal() 方法用于首次揭晓仪式
"""

import logging
from typing import Dict, Any, List, Optional

from ..models import (
    BaziAnalysis,
    ZodiacAnalysis,
    get_archetype_info,
    get_archetype_cn_name,
    get_archetype_emoji,
    get_growth_direction,
)

logger = logging.getLogger(__name__)


class Explainer:
    """
    可解释性生成器

    生成用户友好的原型解释文本
    """

    def generate(
        self,
        archetypes: Dict[str, Any],
        bazi_analysis: Optional[BaziAnalysis],
        zodiac_analysis: Optional[ZodiacAnalysis],
        zodiac_explanations: List[str] = None
    ) -> Dict[str, Any]:
        """
        生成完整解释

        Args:
            archetypes: 四维原型结果 (Dict 格式)
                {
                    "core": {"primary": str, "secondary": str, ...},
                    "inner": {...},
                    "outer": {...},
                    "shadow": {...}
                }
            bazi_analysis: 八字分析结果 (可选)
            zodiac_analysis: 星盘分析结果 (可选)
            zodiac_explanations: 星座洞察列表

        Returns:
            Dict 格式的解释
        """
        core = archetypes.get("core", {})
        primary = core.get("primary", "Regular")
        secondary = core.get("secondary")

        # 1. 生成总结
        summary = self._generate_summary(primary, secondary)

        # 2. 生成八字洞察
        bazi_insight = self._generate_bazi_insight(bazi_analysis) if bazi_analysis else ""

        # 3. 生成星座洞察
        zodiac_insight = self._generate_zodiac_insight(
            zodiac_analysis, zodiac_explanations
        ) if zodiac_analysis else ""

        # 4. 生成融合洞察
        integration_insight = self._generate_integration_insight(
            archetypes, bazi_analysis, zodiac_analysis
        ) if bazi_analysis and zodiac_analysis else ""

        # 5. 生成成长方向
        growth_direction = self._generate_growth_direction(primary)

        return {
            "summary": summary,
            "bazi_insight": bazi_insight,
            "zodiac_insight": zodiac_insight,
            "integration_insight": integration_insight,
            "growth_direction": growth_direction,
        }

    def _generate_summary(self, primary: str, secondary: Optional[str]) -> str:
        """生成总结"""
        primary_cn = get_archetype_cn_name(primary)

        if secondary:
            secondary_cn = get_archetype_cn_name(secondary)
            return f"你的核心原型是【{primary_cn}】，副原型是【{secondary_cn}】"
        else:
            return f"你的核心原型是【{primary_cn}】"

    def _generate_bazi_insight(self, bazi_analysis: BaziAnalysis) -> str:
        """生成八字洞察"""
        pattern = bazi_analysis.pattern
        useful_god = bazi_analysis.useful_god
        driver = bazi_analysis.archetype_driver
        primary_cn = get_archetype_cn_name(bazi_analysis.primary_archetype)
        strength = bazi_analysis.day_master_strength

        # 构建洞察文本
        insight_parts = []

        # 格局和用神
        insight_parts.append(
            f"你的八字是{pattern}，用神为{useful_god}，"
            f"这决定了你的人生底色是{primary_cn}型的{driver}。"
        )

        # 日主强弱补充
        if strength in ["极旺", "偏旺"]:
            insight_parts.append(
                f"日主{strength}，你天生精力充沛，适合主动出击、开拓进取。"
            )
        elif strength in ["极弱", "偏弱"]:
            insight_parts.append(
                f"日主{strength}，你更适合借力使力，善于整合资源、借助贵人。"
            )
        else:
            insight_parts.append(
                f"日主中和，你具有良好的平衡感，能够灵活应对各种情况。"
            )

        return "".join(insight_parts)

    def _generate_zodiac_insight(
        self,
        zodiac_analysis: ZodiacAnalysis,
        explanations: List[str] = None
    ) -> str:
        """生成星座洞察"""
        if explanations and len(explanations) >= 3:
            # 使用预生成的解释（取前3条）
            return f"从星盘角度看，{'; '.join(explanations[:3])}。"

        # 自动生成
        parts = []

        if zodiac_analysis.sun_sign:
            primary_cn = get_archetype_cn_name(zodiac_analysis.primary_archetype)
            parts.append(
                f"太阳{zodiac_analysis.sun_sign}赋予你{primary_cn}的核心特质"
            )

        if zodiac_analysis.moon_sign:
            inner_cn = get_archetype_cn_name(zodiac_analysis.inner_archetype)
            parts.append(
                f"月亮{zodiac_analysis.moon_sign}让你的内在呈现{inner_cn}的情感模式"
            )

        if zodiac_analysis.rising_sign:
            outer_cn = get_archetype_cn_name(zodiac_analysis.outer_archetype)
            parts.append(
                f"上升{zodiac_analysis.rising_sign}让你给人{outer_cn}的第一印象"
            )

        if parts:
            return f"从星盘角度看，{'; '.join(parts)}。"
        else:
            return "星盘数据不完整，无法生成详细洞察。"

    def _generate_integration_insight(
        self,
        archetypes: Dict[str, Any],
        bazi_analysis: BaziAnalysis,
        zodiac_analysis: ZodiacAnalysis
    ) -> str:
        """生成融合洞察"""
        bazi_primary = bazi_analysis.primary_archetype
        zodiac_primary = zodiac_analysis.primary_archetype

        bazi_cn = get_archetype_cn_name(bazi_primary)
        zodiac_cn = get_archetype_cn_name(zodiac_primary)

        core = archetypes.get("core", {})
        final_cn = get_archetype_cn_name(core.get("primary", "Regular"))

        # 获取一致性类型
        source = core.get("source", {})
        consistency = source.get("consistency_type", "neutral")

        if consistency == "perfect_match":
            return (
                f"东方命理与西方占星高度一致地指向{final_cn}原型，"
                f"说明这是你非常稳定的核心特质，无论从哪个角度看，"
                f"你都展现出{final_cn}的典型能量。"
            )
        elif consistency == "conflict":
            return (
                f"有趣的是，八字指向{bazi_cn}，而星盘指向{zodiac_cn}，"
                f"这种张力可能让你内心有时感到矛盾——"
                f"一方面渴望{self._get_archetype_desire(bazi_primary)}，"
                f"另一方面又被{self._get_archetype_desire(zodiac_primary)}所吸引。"
                f"最终我们以八字为主，确定你的主原型是{final_cn}，"
                f"但{zodiac_cn}的能量也是你人格的重要组成部分。"
            )
        elif consistency == "similar":
            return (
                f"八字的{bazi_cn}特质与星盘的{zodiac_cn}特质属于相近能量，"
                f"它们相互补充，让你的{final_cn}特质更加丰富立体。"
            )
        else:
            return (
                f"八字的{bazi_cn}特质与星盘的{zodiac_cn}特质"
                f"相互补充，让你的人格更加丰富多元。"
                f"你的核心是{final_cn}，但也具备{zodiac_cn}的某些特点。"
            )

    def _generate_growth_direction(self, primary: str) -> str:
        """生成成长方向"""
        direction = get_growth_direction(primary)
        if direction:
            return f"你的成长方向是{direction}"

        return "持续探索自我，在实践中发现成长的方向。"

    def _get_archetype_desire(self, archetype: str) -> str:
        """获取原型的核心渴望"""
        desires = {
            "Innocent": "纯粹与美好",
            "Explorer": "自由与发现",
            "Sage": "真理与理解",
            "Hero": "掌控与证明",
            "Outlaw": "变革与解放",
            "Magician": "转化与实现",
            "Regular": "归属与连接",
            "Lover": "亲密与体验",
            "Jester": "快乐与当下",
            "Caregiver": "帮助与保护",
            "Creator": "创新与表达",
            "Ruler": "掌控与秩序",
        }
        return desires.get(archetype, "自我实现")

    def generate_card_content(
        self,
        archetypes: Dict[str, Any],
        bazi_analysis: Optional[BaziAnalysis],
        zodiac_analysis: Optional[ZodiacAnalysis]
    ) -> Dict[str, Any]:
        """
        生成 VibeID 卡片内容

        用于前端展示
        """
        core = archetypes.get("core", {})
        inner = archetypes.get("inner", {})
        outer = archetypes.get("outer", {})
        shadow = archetypes.get("shadow", {})

        primary = core.get("primary", "Regular")
        archetype_info = get_archetype_info(primary)

        return {
            # 主原型信息
            "primary": {
                "id": primary,
                "name_cn": archetype_info.get("name_cn", primary) if archetype_info else primary,
                "nickname": archetype_info.get("nickname", "") if archetype_info else "",
                "emoji": archetype_info.get("emoji", "✨") if archetype_info else "✨",
                "slogan": archetype_info.get("slogan", "") if archetype_info else "",
                "description": archetype_info.get("description", "") if archetype_info else "",
            },

            # 副原型
            "secondary": {
                "id": core.get("secondary"),
                "name_cn": get_archetype_cn_name(core.get("secondary")) if core.get("secondary") else None,
            },

            # 四维原型简述
            "dimensions": {
                "core": {
                    "archetype": core.get("primary"),
                    "name_cn": get_archetype_cn_name(core.get("primary")),
                    "emoji": get_archetype_emoji(core.get("primary")),
                },
                "inner": {
                    "archetype": inner.get("primary"),
                    "name_cn": get_archetype_cn_name(inner.get("primary")),
                    "label": "情感风格",
                },
                "outer": {
                    "archetype": outer.get("primary"),
                    "name_cn": get_archetype_cn_name(outer.get("primary")),
                    "label": "社交风格",
                },
                "shadow": {
                    "archetype": shadow.get("primary"),
                    "name_cn": get_archetype_cn_name(shadow.get("primary")),
                    "label": "阴影倾向",
                    "tension": self._get_shadow_tension(
                        core.get("primary"),
                        shadow.get("primary")
                    ),
                },
            },

            # 底层密码
            "source": {
                "bazi": bazi_analysis.brief if bazi_analysis else None,
                "zodiac": zodiac_analysis.brief if zodiac_analysis else None,
            },

            # 超能力和成长点
            "superpowers": archetype_info.get("superpowers", []) if archetype_info else [],
            "growth_points": archetype_info.get("growth_points", []) if archetype_info else [],

            # 关系匹配
            "best_match": archetype_info.get("best_match") if archetype_info else None,
            "caution_match": archetype_info.get("caution_match") if archetype_info else None,
        }

    def _get_shadow_tension(self, core: str, shadow: str) -> str:
        """获取核心与阴影的张力描述"""
        tensions = {
            ("Innocent", "Hero"): "信任 vs 掌控",
            ("Hero", "Innocent"): "征服 vs 信任",
            ("Sage", "Jester"): "深刻 vs 轻盈",
            ("Jester", "Sage"): "轻盈 vs 深刻",
            ("Caregiver", "Explorer"): "扎根 vs 流动",
            ("Explorer", "Caregiver"): "自由 vs 责任",
            ("Creator", "Regular"): "独特 vs 归属",
            ("Regular", "Creator"): "归属 vs 独特",
            ("Lover", "Magician"): "融合 vs 超越",
            ("Magician", "Lover"): "超越 vs 融合",
            ("Ruler", "Outlaw"): "秩序 vs 自由",
            ("Outlaw", "Ruler"): "自由 vs 秩序",
        }
        return tensions.get((core, shadow), f"{core} vs {shadow}")


# ═══════════════════════════════════════════════════════════════════════════════
# 便捷函数
# ═══════════════════════════════════════════════════════════════════════════════

def generate_explanation(
    archetypes: Dict[str, Any],
    bazi_analysis: Optional[BaziAnalysis],
    zodiac_analysis: Optional[ZodiacAnalysis],
    zodiac_explanations: List[str] = None
) -> Dict[str, Any]:
    """
    生成解释（便捷函数）
    """
    explainer = Explainer()
    return explainer.generate(
        archetypes, bazi_analysis, zodiac_analysis, zodiac_explanations
    )
