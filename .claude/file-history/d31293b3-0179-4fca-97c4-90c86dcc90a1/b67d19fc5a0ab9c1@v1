/**
 * show-vibe-id-reveal 工具卡片
 *
 * v7.0 新增: 首次揭晓仪式展示
 * 在聊天中展示 VibeID 揭晓动画
 */

'use client'

import { memo } from 'react'
import { cn } from '@/lib/utils'
import { registerCard } from '@/skills/CardRegistry'
import { VibeIDReveal, VibeIDRevealStatic } from '../components/VibeIDReveal'
import type { ArchetypeScores, ArchetypeType } from '@/types/vibe-id'

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface ArchetypeData {
  primary: string
  secondary?: string | null
  confidence?: string
  scores?: ArchetypeScores
  source?: Record<string, unknown>
}

interface RevealData {
  core_traits: [string, string, string]
  ai_first_words: string
}

interface VibeIDRevealCardData {
  archetypes: {
    core: ArchetypeData
    inner: ArchetypeData
    outer: ArchetypeData
    shadow: ArchetypeData
  }
  scores: ArchetypeScores
  reveal: RevealData
  version?: string
}

interface ShowVibeIDRevealProps {
  data: VibeIDRevealCardData
  cardProps?: Record<string, unknown>
}

// ═══════════════════════════════════════════════════════════════════════════
// Tool Card Component
// ═══════════════════════════════════════════════════════════════════════════

export const ShowVibeIDReveal = memo(function ShowVibeIDReveal({
  data,
}: ShowVibeIDRevealProps) {
  // Validate data
  if (!data || !data.archetypes || !data.reveal) {
    return (
      <div className="w-full md:max-w-md p-6 rounded-2xl bg-red-50 border border-red-200">
        <div className="flex items-center gap-2 text-red-700">
          <span>⚠️</span>
          <span className="text-sm">揭晓数据不完整</span>
        </div>
      </div>
    )
  }

  // Transform scores to ensure correct type
  const normalizedScores: ArchetypeScores = {} as ArchetypeScores
  if (data.scores) {
    Object.entries(data.scores).forEach(([key, value]) => {
      normalizedScores[key as ArchetypeType] = typeof value === 'number' ? value : 0
    })
  }

  return (
    <div className="w-full md:max-w-md">
      <div className="p-6 rounded-2xl bg-white dark:bg-ink-900 shadow-card border border-vellum-200/30 dark:border-ink-700/30">
        {/* Header */}
        <div className="text-center mb-6">
          <h2 className="font-serif text-lg text-ink-500 dark:text-ink-400">
            ✨ VibeID 揭晓
          </h2>
        </div>

        {/* Reveal Content */}
        <VibeIDReveal
          archetypes={data.archetypes}
          scores={normalizedScores}
          reveal={data.reveal}
          autoPlay
        />
      </div>
    </div>
  )
})

// ═══════════════════════════════════════════════════════════════════════════
// Static Variant (for non-animated display)
// ═══════════════════════════════════════════════════════════════════════════

export const ShowVibeIDRevealStatic = memo(function ShowVibeIDRevealStatic({
  data,
}: ShowVibeIDRevealProps) {
  if (!data || !data.archetypes || !data.reveal) {
    return (
      <div className="w-full md:max-w-md p-6 rounded-2xl bg-red-50 border border-red-200">
        <div className="flex items-center gap-2 text-red-700">
          <span>⚠️</span>
          <span className="text-sm">揭晓数据不完整</span>
        </div>
      </div>
    )
  }

  const normalizedScores: ArchetypeScores = {} as ArchetypeScores
  if (data.scores) {
    Object.entries(data.scores).forEach(([key, value]) => {
      normalizedScores[key as ArchetypeType] = typeof value === 'number' ? value : 0
    })
  }

  return (
    <div className="w-full md:max-w-md">
      <div className="p-6 rounded-2xl bg-white dark:bg-ink-900 shadow-card border border-vellum-200/30 dark:border-ink-700/30">
        <div className="text-center mb-6">
          <h2 className="font-serif text-lg text-ink-500 dark:text-ink-400">
            ✨ VibeID
          </h2>
        </div>

        <VibeIDRevealStatic
          archetypes={data.archetypes}
          scores={normalizedScores}
          reveal={data.reveal}
        />
      </div>
    </div>
  )
})

// ═══════════════════════════════════════════════════════════════════════════
// Card Registration
// ═══════════════════════════════════════════════════════════════════════════

// Register card with CardRegistry
registerCard('vibe_id_reveal', ShowVibeIDReveal)

// ═══════════════════════════════════════════════════════════════════════════
// Tool Metadata
// ═══════════════════════════════════════════════════════════════════════════

export const showVibeIDRevealMeta = {
  name: 'show_vibe_id_reveal',
  displayName: 'VibeID 揭晓',
  description: '首次揭晓仪式，展示用户的 VibeID 人格原型',
  skill: 'vibe_id',
  component: ShowVibeIDReveal,
}

export default ShowVibeIDReveal
