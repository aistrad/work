"""
VibeID Skill Tool Handlers v7.0 - 四维12原型完整版

变更:
- calculate_vibe_id: 使用新 service，返回 Dict
- show_vibe_id: 委托给 show_card (custom + vibe_id_card)
- show_vibe_id_reveal: v7.0 新增，首次揭晓仪式
- show_archetype_radar: 委托给 show_card (chart + radar)
- get_archetype_info: 保留，从配置加载原型信息
"""
import logging
from typing import Dict, Any, Optional
from uuid import UUID

from services.agent.tool_registry import tool_handler, ToolContext

logger = logging.getLogger(__name__)


# ═══════════════════════════════════════════════════════════════════════════════
# 计算工具
# ═══════════════════════════════════════════════════════════════════════════════

@tool_handler("calculate_vibe_id")
async def execute_calculate_vibe_id(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    计算用户的 VibeID 四维人格画像

    前置条件:
    - skill_data.bazi.chart 或 skill_data.zodiac.chart 至少存在一个

    Args:
        args: 工具参数
            - force_recalculate: 是否强制重新计算
        context: 工具执行上下文

    Returns:
        {
            "status": "success" | "error",
            "data": {...} | None,
            "cached": bool,
            "error": str | None
        }
    """
    from skills.vibe_id.services import get_vibe_id_service

    user_id = context.user_id
    if not user_id:
        return {"status": "error", "error": "未登录，无法计算 VibeID"}

    force = args.get("force_recalculate", False)

    try:
        user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
        service = get_vibe_id_service()
        result = await service.calculate(user_uuid, force=force)
        return result
    except Exception as e:
        logger.error(f"Failed to calculate VibeID: {e}", exc_info=True)
        return {"status": "error", "error": f"计算失败: {str(e)}"}


@tool_handler("get_archetype_info")
async def execute_get_archetype_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    获取指定原型的详细信息

    Args:
        args: 工具参数
            - archetype_id: 原型ID (Hero, Sage, Lover, etc.)
        context: 工具执行上下文

    Returns:
        原型信息字典
    """
    from skills.vibe_id.config import ARCHETYPE_INFO

    archetype_id = args.get("archetype_id")
    if not archetype_id:
        return {"status": "error", "error": "archetype_id 是必需参数"}

    info = ARCHETYPE_INFO.get(archetype_id)
    if not info:
        valid_ids = list(ARCHETYPE_INFO.keys())
        return {
            "status": "error",
            "error": f"未知原型 '{archetype_id}'",
            "hint": f"有效原型: {', '.join(valid_ids)}"
        }

    return {
        "status": "success",
        "data": info
    }


# ═══════════════════════════════════════════════════════════════════════════════
# 展示工具 - 委托给 show_card (V7 模式)
# ═══════════════════════════════════════════════════════════════════════════════

@tool_handler("show_vibe_id")
async def execute_show_vibe_id(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    展示用户的 VibeID 人格画像卡片

    V7: 优先使用 context.skill_data，否则从数据库读取

    Args:
        args: 工具参数
        context: 工具执行上下文

    Returns:
        show_card 返回的卡片数据
    """
    from services.agent.tool_registry import ToolRegistry

    user_id = context.user_id
    if not user_id:
        return {"status": "error", "error": "未登录，无法展示 VibeID"}

    try:
        # 1. 优先从 context.skill_data 获取数据
        vibe_id_data = None
        if context.skill_data:
            vibe_id_data = context.skill_data.get("vibe_id")

        # 2. 如果 context 中没有，尝试从数据库读取
        if not vibe_id_data:
            from stores.unified_profile_repo import UnifiedProfileRepository
            user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
            profile = await UnifiedProfileRepository.get_profile(user_uuid)
            if profile:
                # v9.0: 只从 skills 读取
                vibe_id_data = profile.get("skills", {}).get("vibe_id")

        if not vibe_id_data:
            return {
                "status": "error",
                "error": "尚未计算 VibeID",
                "hint": "请先说「分析我的人格」来计算 VibeID"
            }

        # 3. 委托给 show_card，使用 inline 数据源
        return await ToolRegistry.execute(
            "show_card",
            {
                "card_type": "custom",
                "data_source": {
                    "type": "inline",
                    "data": vibe_id_data
                },
                "options": {
                    "componentId": "vibe_id_card"
                }
            },
            context
        )
    except Exception as e:
        logger.error(f"Failed to show VibeID: {e}", exc_info=True)
        return {"status": "error", "error": f"展示失败: {str(e)}"}


@tool_handler("show_archetype_radar")
async def execute_show_archetype_radar(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    展示用户的12原型雷达图

    V7: 优先使用 context.skill_data，否则从数据库读取

    Args:
        args: 工具参数
        context: 工具执行上下文

    Returns:
        show_card 返回的图表数据
    """
    from services.agent.tool_registry import ToolRegistry

    user_id = context.user_id
    if not user_id:
        return {"status": "error", "error": "未登录，无法展示雷达图"}

    try:
        # 1. 优先从 context.skill_data 获取数据
        vibe_id_data = None
        if context.skill_data:
            vibe_id_data = context.skill_data.get("vibe_id")

        # 2. 如果 context 中没有，尝试从数据库读取
        if not vibe_id_data:
            from stores.unified_profile_repo import UnifiedProfileRepository
            user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
            profile = await UnifiedProfileRepository.get_profile(user_uuid)
            if profile:
                # v9.0: 只从 skills 读取
                vibe_id_data = profile.get("skills", {}).get("vibe_id")

        if not vibe_id_data:
            return {
                "status": "error",
                "error": "尚未计算 VibeID",
                "hint": "请先说「分析我的人格」来计算 VibeID"
            }

        scores = vibe_id_data.get("scores", {})
        if not scores:
            return {"status": "error", "error": "原型得分数据不存在"}

        # 3. 委托给 show_card，使用 inline 数据源
        return await ToolRegistry.execute(
            "show_card",
            {
                "card_type": "chart",
                "data_source": {
                    "type": "inline",
                    "data": scores
                },
                "options": {
                    "chartType": "radar",
                    "title": "12原型能量分布"
                }
            },
            context
        )
    except Exception as e:
        logger.error(f"Failed to show archetype radar: {e}", exc_info=True)
        return {"status": "error", "error": f"展示失败: {str(e)}"}
