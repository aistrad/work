/**
 * VibeIDReveal - é¦–æ¬¡æ­æ™“ä»ªå¼ç»„ä»¶
 *
 * v7.0 æ–°å¢: ä¸‰é˜¶æ®µåŠ¨ç”»æ­æ™“
 * Stage 1: ä¸‰ä¸ªç‰¹è´¨æ‰“å‡»ç‚¹
 * Stage 2: ä¸»åŸå‹ + å››ç»´å±•ç¤º
 * Stage 3: AI æ¸©æš–çš„ç¬¬ä¸€å¥è¯
 */

'use client'

import { useState, useEffect, useCallback } from 'react'
import { cn } from '@/lib/utils'
import {
  type ArchetypeType,
  type ArchetypeScores,
  ARCHETYPE_META,
  getArchetypeColor,
} from '@/types/vibe-id'
import { CoreTraits } from './CoreTraits'
import { FourDimensionCompact } from './FourDimensionView'
import { ArchetypeRadar } from './ArchetypeRadar'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface RevealData {
  core_traits: [string, string, string]
  ai_first_words: string
}

interface ArchetypeData {
  primary: string
  secondary?: string | null
  confidence?: string
  scores?: ArchetypeScores
  source?: Record<string, unknown>
}

interface VibeIDRevealProps {
  /** å››ç»´åŸå‹æ•°æ® */
  archetypes: {
    core: ArchetypeData
    inner: ArchetypeData
    outer: ArchetypeData
    shadow: ArchetypeData
  }
  /** ç»¼åˆå¾—åˆ† */
  scores: ArchetypeScores
  /** æ­æ™“å†…å®¹ */
  reveal: RevealData
  /** æ˜¯å¦è‡ªåŠ¨æ’­æ”¾ */
  autoPlay?: boolean
  /** å®Œæˆå›è°ƒ */
  onComplete?: () => void
  /** è‡ªå®šä¹‰ç±»å */
  className?: string
}

type RevealStage = 'traits' | 'archetype' | 'greeting' | 'complete'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helper Components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function StageIndicator({ stage, currentStage }: { stage: RevealStage; currentStage: RevealStage }) {
  const stages: RevealStage[] = ['traits', 'archetype', 'greeting']
  const currentIndex = stages.indexOf(currentStage)
  const stageIndex = stages.indexOf(stage)

  const isActive = stage === currentStage
  const isPast = stageIndex < currentIndex

  return (
    <div
      className={cn(
        'w-2 h-2 rounded-full transition-all duration-300',
        isActive && 'w-6 bg-accent',
        isPast && 'bg-accent/40',
        !isActive && !isPast && 'bg-ink-200'
      )}
    />
  )
}

function ArchetypeHero({
  archetype,
  isVisible,
}: {
  archetype: ArchetypeType
  isVisible: boolean
}) {
  const meta = ARCHETYPE_META[archetype]
  const color = getArchetypeColor(archetype)

  return (
    <div
      className={cn(
        'text-center transform transition-all duration-700',
        isVisible ? 'opacity-100 scale-100' : 'opacity-0 scale-90'
      )}
    >
      {/* Glow effect */}
      <div className="relative inline-block">
        <div
          className="absolute inset-0 blur-3xl opacity-30"
          style={{ backgroundColor: color }}
        />
        <div
          className="relative w-28 h-28 mx-auto rounded-3xl flex items-center justify-center text-6xl shadow-lg"
          style={{
            background: `linear-gradient(135deg, ${color}20 0%, ${color}05 100%)`,
            border: `2px solid ${color}30`,
          }}
        >
          {meta.emoji}
        </div>
      </div>

      {/* Name */}
      <h2 className="mt-4 text-2xl font-bold text-ink-800 dark:text-ink-100">
        {meta.name}
      </h2>
      <p className="text-ink-500 dark:text-ink-400">{meta.nickname}</p>

      {/* Slogan */}
      <p className="mt-3 text-base text-ink-600 dark:text-ink-300 italic">
        &ldquo;{meta.slogan}&rdquo;
      </p>
    </div>
  )
}

function AIGreeting({
  message,
  isVisible,
}: {
  message: string
  isVisible: boolean
}) {
  return (
    <div
      className={cn(
        'transform transition-all duration-700',
        isVisible ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-4'
      )}
    >
      <div className="p-5 rounded-2xl bg-gradient-to-br from-accent/10 to-accent/5 border border-accent/20">
        <div className="flex items-start gap-3">
          <div className="w-10 h-10 rounded-full bg-accent/20 flex items-center justify-center flex-shrink-0">
            <span className="text-xl">ğŸ’¬</span>
          </div>
          <div>
            <p className="text-sm text-accent font-medium mb-1">Vibe æƒ³å¯¹ä½ è¯´</p>
            <p className="text-base text-ink-700 dark:text-ink-200 leading-relaxed">
              {message}
            </p>
          </div>
        </div>
      </div>
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function VibeIDReveal({
  archetypes,
  scores,
  reveal,
  autoPlay = true,
  onComplete,
  className,
}: VibeIDRevealProps) {
  const [stage, setStage] = useState<RevealStage>('traits')
  const [traitsComplete, setTraitsComplete] = useState(false)

  const primaryArchetype = archetypes.core.primary as ArchetypeType
  const shadowTension = archetypes.shadow.source?.tension as string | undefined

  // Transform archetypes to dimension format
  const dimensionData = {
    core: {
      primary: archetypes.core.primary as ArchetypeType,
      scores: archetypes.core.scores,
    },
    inner: {
      primary: archetypes.inner.primary as ArchetypeType,
      scores: archetypes.inner.scores,
    },
    outer: {
      primary: archetypes.outer.primary as ArchetypeType,
      scores: archetypes.outer.scores,
    },
    shadow: {
      primary: archetypes.shadow.primary as ArchetypeType,
      scores: archetypes.shadow.scores,
    },
  }

  // Auto advance stages
  useEffect(() => {
    if (!autoPlay) return

    if (stage === 'traits' && traitsComplete) {
      const timer = setTimeout(() => setStage('archetype'), 500)
      return () => clearTimeout(timer)
    }

    if (stage === 'archetype') {
      const timer = setTimeout(() => setStage('greeting'), 2500)
      return () => clearTimeout(timer)
    }

    if (stage === 'greeting') {
      const timer = setTimeout(() => {
        setStage('complete')
        onComplete?.()
      }, 3000)
      return () => clearTimeout(timer)
    }
  }, [stage, traitsComplete, autoPlay, onComplete])

  const handleTraitsComplete = useCallback(() => {
    setTraitsComplete(true)
  }, [])

  const handleSkip = () => {
    setStage('complete')
    onComplete?.()
  }

  return (
    <div className={cn('relative', className)}>
      {/* Skip Button */}
      {stage !== 'complete' && (
        <button
          onClick={handleSkip}
          className="absolute top-0 right-0 text-xs text-ink-400 hover:text-ink-600 transition-colors"
        >
          è·³è¿‡ â†’
        </button>
      )}

      {/* Stage Indicators */}
      <div className="flex items-center justify-center gap-2 mb-6">
        <StageIndicator stage="traits" currentStage={stage} />
        <StageIndicator stage="archetype" currentStage={stage} />
        <StageIndicator stage="greeting" currentStage={stage} />
      </div>

      {/* Stage Content */}
      <div className="min-h-[300px]">
        {/* Stage 1: Traits */}
        {(stage === 'traits' || stage === 'complete') && (
          <div
            className={cn(
              'transition-opacity duration-300',
              stage !== 'traits' && stage !== 'complete' && 'hidden'
            )}
          >
            <h3 className="text-center text-sm text-ink-500 mb-4">å…³äºä½ ...</h3>
            <CoreTraits
              traits={reveal.core_traits}
              animated={stage === 'traits'}
              onComplete={handleTraitsComplete}
            />
          </div>
        )}

        {/* Stage 2: Archetype */}
        {(stage === 'archetype' || stage === 'complete') && (
          <div
            className={cn(
              'space-y-6 transition-opacity duration-300',
              stage !== 'archetype' && stage !== 'complete' && 'hidden'
            )}
          >
            <ArchetypeHero
              archetype={primaryArchetype}
              isVisible={stage === 'archetype' || stage === 'complete'}
            />

            {/* Four Dimensions */}
            <div className="mt-6">
              <h4 className="text-xs text-ink-500 text-center mb-3">ä½ çš„å››ç»´åŸå‹</h4>
              <FourDimensionCompact
                dimensions={dimensionData}
                shadowTension={shadowTension}
              />
            </div>
          </div>
        )}

        {/* Stage 3: Greeting */}
        {(stage === 'greeting' || stage === 'complete') && (
          <div
            className={cn(
              'space-y-6 transition-opacity duration-300',
              stage !== 'greeting' && stage !== 'complete' && 'hidden'
            )}
          >
            {stage === 'complete' && (
              <ArchetypeHero
                archetype={primaryArchetype}
                isVisible
              />
            )}
            <AIGreeting
              message={reveal.ai_first_words}
              isVisible={stage === 'greeting' || stage === 'complete'}
            />
          </div>
        )}
      </div>

      {/* Complete State: Show Full Radar */}
      {stage === 'complete' && (
        <div className="mt-6 pt-6 border-t border-vellum-200/50">
          <h4 className="text-sm text-ink-500 text-center mb-4">12 åŸå‹èƒ½é‡åˆ†å¸ƒ</h4>
          <div className="flex justify-center">
            <ArchetypeRadar
              scores={scores}
              highlightArchetype={primaryArchetype}
              shadowArchetype={archetypes.shadow.primary as ArchetypeType}
              size={260}
              showLabels
              showScores
            />
          </div>
        </div>
      )}
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Static Variant (No Animation)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function VibeIDRevealStatic({
  archetypes,
  scores,
  reveal,
  className,
}: Omit<VibeIDRevealProps, 'autoPlay' | 'onComplete'>) {
  const primaryArchetype = archetypes.core.primary as ArchetypeType
  const shadowTension = archetypes.shadow.source?.tension as string | undefined

  const dimensionData = {
    core: {
      primary: archetypes.core.primary as ArchetypeType,
      scores: archetypes.core.scores,
    },
    inner: {
      primary: archetypes.inner.primary as ArchetypeType,
      scores: archetypes.inner.scores,
    },
    outer: {
      primary: archetypes.outer.primary as ArchetypeType,
      scores: archetypes.outer.scores,
    },
    shadow: {
      primary: archetypes.shadow.primary as ArchetypeType,
      scores: archetypes.shadow.scores,
    },
  }

  return (
    <div className={cn('space-y-6', className)}>
      {/* Hero */}
      <ArchetypeHero archetype={primaryArchetype} isVisible />

      {/* Traits */}
      <CoreTraits traits={reveal.core_traits} animated={false} />

      {/* Four Dimensions */}
      <div>
        <h4 className="text-xs text-ink-500 text-center mb-3">å››ç»´åŸå‹</h4>
        <FourDimensionCompact
          dimensions={dimensionData}
          shadowTension={shadowTension}
        />
      </div>

      {/* AI Greeting */}
      <AIGreeting message={reveal.ai_first_words} isVisible />

      {/* Radar */}
      <div className="pt-4 border-t border-vellum-200/50">
        <h4 className="text-sm text-ink-500 text-center mb-4">èƒ½é‡åˆ†å¸ƒ</h4>
        <div className="flex justify-center">
          <ArchetypeRadar
            scores={scores}
            highlightArchetype={primaryArchetype}
            shadowArchetype={archetypes.shadow.primary as ArchetypeType}
            size={240}
            showLabels
            showScores
          />
        </div>
      </div>
    </div>
  )
}

export default VibeIDReveal
