"""
Model Router - Data Models
Pydantic models for model routing system
"""
from typing import Optional, List, Dict, Any
from dataclasses import dataclass, field
from enum import Enum
from datetime import datetime
from pydantic import BaseModel, Field


class UserTier(str, Enum):
    """用户等级"""
    FREE = "free"
    PRO = "pro"
    VIP = "vip"


class TaskType(str, Enum):
    """任务类型"""
    CHAT = "chat"
    IMAGE_GEN = "image_gen"
    ANALYSIS = "analysis"
    INTERVIEW = "interview"
    REPORT = "report"
    VISION = "vision"
    EMBEDDING = "embedding"


class Capability(str, Enum):
    """模型能力"""
    CHAT = "chat"
    VISION = "vision"
    IMAGE_GEN = "image_gen"
    EMBEDDING = "embedding"
    ANALYSIS = "analysis"


class ExceedAction(str, Enum):
    """配额超限处理策略"""
    DOWNGRADE = "downgrade"
    REJECT = "reject"
    QUEUE = "queue"


class QuotaScope(str, Enum):
    """配额范围"""
    GLOBAL = "global"
    PROVIDER = "provider"
    MODEL = "model"
    USER = "user"
    TIER = "tier"
    TASK = "task"


class Period(str, Enum):
    """配额周期"""
    HOURLY = "hourly"
    DAILY = "daily"
    WEEKLY = "weekly"
    MONTHLY = "monthly"


# ═══════════════════════════════════════════════════════════════════════════
# Request Context
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class ModelContext:
    """
    模型路由上下文 - 用于决定使用哪个模型
    """
    user_id: Optional[str] = None
    user_tier: Optional[str] = None  # free, pro, vip
    skill: Optional[str] = None      # bazi, zodiac, mbti
    task: Optional[str] = None       # chat, image_gen, analysis, etc.
    session_id: Optional[str] = None

    # 可选的能力要求
    required_capabilities: List[str] = field(default_factory=list)

    # A/B 测试
    ab_test_group: Optional[str] = None

    # 额外元数据
    metadata: Dict[str, Any] = field(default_factory=dict)


# ═══════════════════════════════════════════════════════════════════════════
# Database Models (Pydantic)
# ═══════════════════════════════════════════════════════════════════════════

class ModelProvider(BaseModel):
    """模型提供商"""
    id: str
    name: str
    base_url: Optional[str] = None
    api_key_env: Optional[str] = None
    enabled: bool = True
    config: Dict[str, Any] = Field(default_factory=dict)

    class Config:
        from_attributes = True


class Model(BaseModel):
    """模型定义"""
    id: str  # provider:model 格式
    provider_id: str
    model_name: str
    display_name: Optional[str] = None
    capabilities: List[str] = Field(default_factory=list)
    cost_per_1k_input: Optional[float] = None
    cost_per_1k_output: Optional[float] = None
    cost_per_image: Optional[float] = None
    max_tokens: Optional[int] = 4096
    context_window: Optional[int] = 8192
    enabled: bool = True

    class Config:
        from_attributes = True

    @property
    def provider(self) -> str:
        """提取 provider"""
        return self.id.split(":")[0] if ":" in self.id else self.provider_id


class ModelRoute(BaseModel):
    """路由规则"""
    id: int
    name: str
    description: Optional[str] = None
    priority: int = 100

    # 匹配条件
    match_user_id: Optional[str] = None
    match_user_tier: Optional[str] = None
    match_skill: Optional[str] = None
    match_task: Optional[str] = None

    # 目标模型
    model_id: str

    # Fallback
    fallback_chain: List[str] = Field(default_factory=list)

    # A/B 测试
    ab_test_group: Optional[str] = None
    ab_test_percentage: Optional[int] = None

    enabled: bool = True

    class Config:
        from_attributes = True


class QuotaRule(BaseModel):
    """配额规则"""
    id: int
    name: str
    description: Optional[str] = None

    # 范围
    scope: str  # global, provider, model, user, tier, task
    scope_provider_id: Optional[str] = None
    scope_model_id: Optional[str] = None
    scope_user_tier: Optional[str] = None
    scope_task: Optional[str] = None

    # 限制
    period: str = "daily"
    max_calls: Optional[int] = None
    max_input_tokens: Optional[int] = None
    max_output_tokens: Optional[int] = None
    max_cost: Optional[float] = None

    # 超额策略
    on_exceed: str = "downgrade"
    downgrade_to_model: Optional[str] = None
    exceed_message: Optional[str] = None

    enabled: bool = True

    class Config:
        from_attributes = True


class QuotaUsage(BaseModel):
    """配额使用情况"""
    rule_id: int
    user_id: Optional[str] = None
    period_start: datetime
    period_end: datetime
    call_count: int = 0
    input_tokens: int = 0
    output_tokens: int = 0
    estimated_cost: float = 0.0

    class Config:
        from_attributes = True


# ═══════════════════════════════════════════════════════════════════════════
# Response Models
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class ModelSelection:
    """
    模型选择结果 - 路由器返回的最终决策
    """
    provider: str                    # glm, gemini, claude
    model: str                       # 实际的模型名 (e.g., glm-4-plus)
    model_id: str                    # 完整 ID (e.g., glm:glm-4-plus)

    # 路由信息
    route_id: Optional[int] = None
    route_name: Optional[str] = None

    # 降级信息
    was_downgraded: bool = False
    original_model_id: Optional[str] = None
    downgrade_reason: Optional[str] = None

    # 配置
    max_tokens: Optional[int] = None
    base_url: Optional[str] = None

    # 配额信息
    quota_remaining: Optional[int] = None


@dataclass
class QuotaCheckResult:
    """配额检查结果"""
    allowed: bool
    rule_id: Optional[int] = None
    rule_name: Optional[str] = None
    current_usage: int = 0
    max_allowed: int = 0
    remaining: int = 0
    exceed_action: str = "downgrade"
    downgrade_to: Optional[str] = None
    message: Optional[str] = None


# ═══════════════════════════════════════════════════════════════════════════
# Logging Models
# ═══════════════════════════════════════════════════════════════════════════

@dataclass
class ModelCallLog:
    """模型调用日志"""
    user_id: Optional[str] = None
    session_id: Optional[str] = None
    skill: Optional[str] = None
    task: Optional[str] = None

    route_id: Optional[int] = None
    requested_model: Optional[str] = None
    actual_model: str = ""
    was_downgraded: bool = False
    downgrade_reason: Optional[str] = None

    input_tokens: Optional[int] = None
    output_tokens: Optional[int] = None
    estimated_cost: Optional[float] = None

    status: str = "success"  # success, error, timeout, rate_limited
    latency_ms: Optional[int] = None
    error_code: Optional[str] = None
    error_message: Optional[str] = None

    request_id: Optional[str] = None
    metadata: Dict[str, Any] = field(default_factory=dict)
