#!/usr/bin/env python3
"""
Test script for Model Router system
Run from apps/api directory: python scripts/test_model_router.py
"""
import asyncio
import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from dotenv import load_dotenv
load_dotenv(os.path.join(os.path.dirname(__file__), '../../../.env'))


async def test_router():
    from services.model_router import get_model_router, ModelContext

    router = get_model_router()

    print("=" * 60)
    print("Model Router Test")
    print("=" * 60)

    # Test 1: Free user chat
    print("\n[Test 1] Free user - chat")
    ctx = ModelContext(user_id="test-user-1", user_tier="free", task="chat")
    selection = await router.resolve(ctx)
    print(f"  Provider: {selection.provider}")
    print(f"  Model: {selection.model}")
    print(f"  Model ID: {selection.model_id}")
    print(f"  Route: {selection.route_name}")
    print(f"  Downgraded: {selection.was_downgraded}")

    # Test 2: Pro user chat
    print("\n[Test 2] Pro user - chat")
    ctx = ModelContext(user_id="test-user-2", user_tier="pro", task="chat")
    selection = await router.resolve(ctx)
    print(f"  Provider: {selection.provider}")
    print(f"  Model: {selection.model}")
    print(f"  Model ID: {selection.model_id}")
    print(f"  Route: {selection.route_name}")

    # Test 3: VIP user chat
    print("\n[Test 3] VIP user - chat")
    ctx = ModelContext(user_id="test-user-3", user_tier="vip", task="chat")
    selection = await router.resolve(ctx)
    print(f"  Provider: {selection.provider}")
    print(f"  Model: {selection.model}")
    print(f"  Model ID: {selection.model_id}")
    print(f"  Route: {selection.route_name}")

    # Test 4: Image generation
    print("\n[Test 4] Any user - image_gen")
    ctx = ModelContext(user_id="test-user-4", user_tier="free", task="image_gen")
    selection = await router.resolve(ctx, required_capability="image_gen")
    print(f"  Provider: {selection.provider}")
    print(f"  Model: {selection.model}")
    print(f"  Model ID: {selection.model_id}")
    print(f"  Route: {selection.route_name}")

    # Test 5: Get available models
    print("\n[Test 5] Available models with 'chat' capability")
    models = await router.get_available_models(capability="chat")
    for m in models:
        print(f"  - {m.id}: {m.display_name}")

    # Test 6: Cache stats
    print("\n[Test 6] Cache stats")
    stats = router.get_cache_stats()
    print(f"  Hits: {stats['hits']}")
    print(f"  Misses: {stats['misses']}")
    print(f"  Hit Rate: {stats['hit_rate']}")
    print(f"  Cache Size: {stats['cache_size']}")

    print("\n" + "=" * 60)
    print("All tests completed!")
    print("=" * 60)


async def test_quota():
    from services.model_router import get_quota_manager, ModelContext

    print("\n" + "=" * 60)
    print("Quota Manager Test")
    print("=" * 60)

    quota = get_quota_manager()

    # Test quota check for free user
    print("\n[Test] Quota status for free user")
    ctx = ModelContext(user_id="test-quota-user", user_tier="free", task="chat")
    status = await quota.get_quota_status(ctx, "glm:glm-4-flash")

    for s in status:
        print(f"\n  Rule: {s['name']}")
        print(f"  Scope: {s['scope']}")
        print(f"  Limits: {s['limits']}")
        print(f"  Usage: {s['usage']}")
        print(f"  On Exceed: {s['on_exceed']}")


if __name__ == "__main__":
    print("Starting Model Router tests...\n")
    asyncio.run(test_router())
    asyncio.run(test_quota())
