"use client";

/**
 * InterestsCard - 核心兴趣卡片
 *
 * 展示从对话中识别的用户核心兴趣：
 * - 兴趣标签 + 提及频率
 * - 热力图可视化
 *
 * 数据来源：vibe.insight.pattern.interests
 */

import { cn } from "@/lib/utils";
import { GradientEmojiIcon } from "@/components/core/GradientEmojiIcon";
import { ChevronRight, Sparkles, Heart } from "lucide-react";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

export interface Interest {
  name: string;
  /** 热度 0-1 */
  heat: number;
  /** 最近提及 */
  recentMention?: string;
}

export interface InterestsData {
  interests: Interest[];
  lastUpdated?: string;
}

export interface InterestsCardProps {
  data?: InterestsData | null;
  onExplore?: () => void;
  className?: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Helper: Heat to Color
// ═══════════════════════════════════════════════════════════════════════════

function getHeatStyle(heat: number): { bg: string; text: string; bar: string } {
  if (heat >= 0.8) {
    return { bg: "bg-red-100", text: "text-red-700", bar: "bg-red-500" };
  } else if (heat >= 0.6) {
    return { bg: "bg-orange-100", text: "text-orange-700", bar: "bg-orange-500" };
  } else if (heat >= 0.4) {
    return { bg: "bg-amber-100", text: "text-amber-700", bar: "bg-amber-500" };
  } else if (heat >= 0.2) {
    return { bg: "bg-yellow-100", text: "text-yellow-700", bar: "bg-yellow-500" };
  } else {
    return { bg: "bg-slate-100", text: "text-slate-600", bar: "bg-slate-400" };
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// Sub-component
// ═══════════════════════════════════════════════════════════════════════════

function InterestTag({ interest }: { interest: Interest }) {
  const style = getHeatStyle(interest.heat);

  return (
    <div
      className={cn(
        "relative px-3 py-2 rounded-xl overflow-hidden",
        style.bg,
        "border border-white/50"
      )}
    >
      {/* Heat bar */}
      <div
        className={cn("absolute bottom-0 left-0 h-1 rounded-full", style.bar)}
        style={{ width: `${interest.heat * 100}%` }}
      />

      <div className="flex items-center gap-2">
        <Heart
          className={cn(
            "w-3.5 h-3.5",
            interest.heat >= 0.6 ? "fill-current" : "",
            style.text
          )}
        />
        <span className={cn("text-sm font-medium", style.text)}>
          {interest.name}
        </span>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Main Component
// ═══════════════════════════════════════════════════════════════════════════

export function InterestsCard({
  data,
  onExplore,
  className,
}: InterestsCardProps) {
  // Empty state
  if (!data || !data.interests || data.interests.length === 0) {
    return (
      <div
        onClick={onExplore}
        className={cn(
          "relative p-5 rounded-2xl cursor-pointer overflow-hidden",
          "bg-gradient-to-br from-rose-50/50 to-pink-50/30",
          "border border-rose-200/30 shadow-card",
          "hover:shadow-card-hover hover:border-rose-200/50",
          "transition-all duration-200",
          className
        )}
      >
        <div className="flex items-center gap-3 mb-4">
          <GradientEmojiIcon emoji="❤️" theme="red" size="md" glow />
          <div>
            <span className="font-serif text-base font-semibold text-text-primary">
              核心兴趣
            </span>
            <p className="text-xs text-text-tertiary">你热爱什么</p>
          </div>
        </div>
        <p className="text-sm text-text-secondary mb-4">
          继续对话，AI 会识别你的核心兴趣。
        </p>
        <div className="flex items-center justify-center gap-2 px-4 py-2.5 bg-rose-500/10 hover:bg-rose-500/20 text-rose-700 rounded-xl text-sm font-medium transition-colors">
          <Sparkles className="w-4 h-4" />
          <span>开始对话</span>
          <ChevronRight className="w-4 h-4" />
        </div>
      </div>
    );
  }

  // Sort by heat
  const sortedInterests = [...data.interests].sort((a, b) => b.heat - a.heat);

  return (
    <div
      onClick={onExplore}
      className={cn(
        "relative p-5 rounded-2xl cursor-pointer overflow-hidden",
        "bg-gradient-to-br from-rose-50/50 to-pink-50/30",
        "border border-rose-200/30 shadow-card",
        "hover:shadow-card-hover hover:border-rose-200/50",
        "transition-all duration-200 hover:scale-[1.01]",
        className
      )}
    >
      {/* Background decoration */}
      <div className="absolute top-0 right-0 w-24 h-24 bg-gradient-to-bl from-rose-200/10 to-transparent rounded-full blur-2xl" />

      <div className="relative">
        {/* Header */}
        <div className="flex items-center justify-between mb-4">
          <div className="flex items-center gap-2">
            <GradientEmojiIcon emoji="❤️" theme="rose" size="sm" />
            <span className="font-serif text-base font-semibold text-text-primary">
              核心兴趣
            </span>
          </div>
          <div className="flex items-center gap-1 text-rose-600">
            <span className="text-xs">详情</span>
            <ChevronRight className="w-4 h-4" />
          </div>
        </div>

        {/* Interest Tags */}
        <div className="flex flex-wrap gap-2">
          {sortedInterests.slice(0, 8).map((interest, index) => (
            <InterestTag key={index} interest={interest} />
          ))}
        </div>

        {/* Last updated */}
        {data.lastUpdated && (
          <p className="text-[10px] text-text-tertiary text-right mt-3">
            更新于 {new Date(data.lastUpdated).toLocaleDateString("zh-CN")}
          </p>
        )}
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Skeleton
// ═══════════════════════════════════════════════════════════════════════════

export function InterestsCardSkeleton({ className }: { className?: string }) {
  return (
    <div
      className={cn(
        "p-5 rounded-2xl",
        "bg-gradient-to-br from-rose-50/50 to-pink-50/30",
        "border border-rose-200/30 shadow-card animate-pulse",
        className
      )}
    >
      {/* Header */}
      <div className="flex items-center gap-2 mb-4">
        <div className="w-10 h-10 rounded-xl bg-rose-200" />
        <div className="h-5 bg-rose-200 rounded w-20" />
      </div>

      {/* Tags */}
      <div className="flex flex-wrap gap-2">
        {[1, 2, 3, 4, 5, 6].map((i) => (
          <div key={i} className="h-10 bg-rose-100 rounded-xl w-20" />
        ))}
      </div>
    </div>
  );
}

export default InterestsCard;
