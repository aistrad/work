'use client';

/**
 * useSkillSubscription - Skill 订阅管理 Hook
 *
 * 提供 Skill 订阅状态查询和操作功能
 */

import { useCallback, useMemo } from 'react';
import useSWR, { useSWRConfig } from 'swr';
import { useAuth } from '@/providers/AuthProvider';
import { apiClient } from '@/lib/api';
import type {
  SkillSubscription,
  SkillSubscriptionsResponse,
  SkillListResponse,
  SkillRecommendationsResponse,
  SkillUserStatus,
  SkillWithUserStatus,
} from '@/types/skill';

// ═══════════════════════════════════════════════════════════════════════════
// Fetchers
// ═══════════════════════════════════════════════════════════════════════════

async function fetchSubscriptions(): Promise<SkillSubscriptionsResponse> {
  const response = await apiClient.get<SkillSubscriptionsResponse>('/v1/skills/subscriptions');
  return response.data;
}

async function fetchSkills(category?: string): Promise<SkillListResponse> {
  const params = category ? { category } : undefined;
  const response = await apiClient.get<SkillListResponse>('/v1/skills', { params });
  return response.data;
}

async function fetchRecommendations(
  limit: number = 3,
  context?: string
): Promise<SkillRecommendationsResponse> {
  const params: Record<string, unknown> = { limit };
  if (context) params.context = context;
  const response = await apiClient.get<SkillRecommendationsResponse>('/v1/skills/recommendations', { params });
  return response.data;
}

// ═══════════════════════════════════════════════════════════════════════════
// useSkillSubscription Hook
// ═══════════════════════════════════════════════════════════════════════════

export function useSkillSubscription() {
  const { user } = useAuth();
  const { mutate } = useSWRConfig();

  // 获取订阅列表 - 仅登录用户
  const {
    data: subscriptionsData,
    error: subscriptionsError,
    isLoading: subscriptionsLoadingRaw,
  } = useSWR(
    user ? 'skill-subscriptions' : null,
    fetchSubscriptions,
    { revalidateOnFocus: false }
  );

  // 未登录时，isLoading 应该是 false（不需要等待订阅数据）
  const subscriptionsLoading = user ? subscriptionsLoadingRaw : false;

  const subscriptions = subscriptionsData?.subscriptions ?? [];
  const summary = subscriptionsData?.summary;

  // 订阅 Skill
  const subscribe = useCallback(
    async (skillId: string, pushEnabled: boolean = true) => {
      await apiClient.post(`/v1/skills/${skillId}/subscribe`, {
        push_enabled: pushEnabled,
      });
      mutate('skill-subscriptions');
      mutate('skill-list');
    },
    [mutate]
  );

  // 取消订阅 Skill
  const unsubscribe = useCallback(
    async (skillId: string) => {
      await apiClient.post(`/v1/skills/${skillId}/unsubscribe`);
      mutate('skill-subscriptions');
      mutate('skill-list');
    },
    [mutate]
  );

  // 切换推送开关
  const togglePush = useCallback(
    async (skillId: string, enabled: boolean) => {
      await apiClient.post(`/v1/skills/${skillId}/push`, { enabled });
      mutate('skill-subscriptions');
    },
    [mutate]
  );

  // 检查是否已订阅
  const isSubscribed = useCallback(
    (skillId: string): boolean => {
      return subscriptions.some(
        (s) => s.skill_id === skillId && s.status === 'subscribed'
      );
    },
    [subscriptions]
  );

  // 检查推送是否开启
  const isPushEnabled = useCallback(
    (skillId: string): boolean => {
      const sub = subscriptions.find((s) => s.skill_id === skillId);
      return sub?.push_enabled ?? false;
    },
    [subscriptions]
  );

  // 获取订阅状态
  const getSubscription = useCallback(
    (skillId: string): SkillSubscription | undefined => {
      return subscriptions.find((s) => s.skill_id === skillId);
    },
    [subscriptions]
  );

  // 构建 userStatuses map
  const userStatuses = useMemo((): Record<string, SkillUserStatus> => {
    const map: Record<string, SkillUserStatus> = {};
    for (const sub of subscriptions) {
      map[sub.skill_id] = {
        subscribed: sub.status === 'subscribed',
        push_enabled: sub.push_enabled,
        trial_messages_used: sub.trial_messages_used,
        trial_messages_remaining: null, // 需要从 skill metadata 计算
        subscribed_at: sub.subscribed_at ?? undefined,
      };
    }
    return map;
  }, [subscriptions]);

  return {
    subscriptions,
    summary,
    isLoading: subscriptionsLoading,
    error: subscriptionsError,
    subscribe,
    unsubscribe,
    togglePush,
    isSubscribed,
    isPushEnabled,
    getSubscription,
    userStatuses,
    refresh: () => mutate('skill-subscriptions'),
  };
}

// ═══════════════════════════════════════════════════════════════════════════
// useSkills Hook
// ═══════════════════════════════════════════════════════════════════════════

export function useSkills(category?: string) {
  const { user } = useAuth();

  const {
    data,
    error,
    isLoading,
    mutate: refresh,
  } = useSWR(
    ['skill-list', category],
    () => fetchSkills(category),
    { revalidateOnFocus: false }
  );

  return {
    skills: data?.skills ?? [],
    categories: data?.categories,
    total: data?.total ?? 0,
    isLoading,
    error,
    refresh,
  };
}

// ═══════════════════════════════════════════════════════════════════════════
// useSkillRecommendations Hook
// ═══════════════════════════════════════════════════════════════════════════

export function useSkillRecommendations(options?: {
  limit?: number;
  context?: string;
  enabled?: boolean;
}) {
  const { user } = useAuth();
  const { limit = 3, context, enabled = true } = options ?? {};

  const {
    data,
    error,
    isLoading,
    mutate: refresh,
  } = useSWR(
    user && enabled ? ['skill-recommendations', limit, context] : null,
    () => fetchRecommendations(limit, context),
    {
      revalidateOnFocus: false,
      dedupingInterval: 5 * 60 * 1000, // 5 分钟内不重复请求
    }
  );

  return {
    recommendations: data?.recommendations ?? [],
    generatedAt: data?.generated_at,
    isLoading,
    error,
    refresh,
  };
}

// ═══════════════════════════════════════════════════════════════════════════
// useSkillMetadata Hook
// ═══════════════════════════════════════════════════════════════════════════

export function useSkillMetadata(skillId: string) {
  const { skills } = useSkills();
  return useMemo(
    () => skills.find((s) => s.id === skillId),
    [skills, skillId]
  );
}

export default useSkillSubscription;
