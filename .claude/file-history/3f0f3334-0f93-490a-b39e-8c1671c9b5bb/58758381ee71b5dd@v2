# VibeLife 用户数据体系 v2

> **设计原则**: 4 表核心架构，职责清晰，避免冗余

---

## 1. 架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           用户数据体系 v2                                    │
└─────────────────────────────────────────────────────────────────────────────┘

  ┌──────────────────────┐
  │     vibe_users       │  ← 身份层 (Identity)
  │  账号 + 认证 + 计费   │
  └──────────┬───────────┘
             │ 1:1
             ▼
  ┌──────────────────────┐
  │   unified_profiles   │  ← 画像层 (Profile)
  │  出生信息 + 命理计算  │
  │  + 偏好 + 生活上下文  │
  └──────────┬───────────┘
             │ 1:N
             ▼
  ┌──────────────────────┐
  │   user_data_store    │  ← 内容层 (Content)
  │  目标/计划/打卡/文档  │
  │  虚拟文件系统路径     │
  └──────────────────────┘

  ┌──────────────────────┐
  │    user_triggers     │  ← 主动服务层 (Proactive)
  │  提醒 + 条件触发      │
  └──────────────────────┘
```

---

## 2. 数据分层职责

| 层级 | 表名 | 职责 | 数据特性 |
|------|------|------|----------|
| **身份层** | vibe_users | 账号、认证、订阅、配额、计费汇总 | 高频读取，低频写入 |
| **画像层** | unified_profiles | 出生信息、命理计算、偏好、生活上下文 | 用户画像，Skill 共享 |
| **内容层** | user_data_store | 目标、计划、打卡、文档、照片 | 用户创建的内容数据 |
| **主动层** | user_triggers | 提醒、条件触发、定时任务 | 主动服务调度 |

---

## 3. 表结构设计

### 3.1 vibe_users (身份层 + 计费)

```sql
CREATE TABLE vibe_users (
    -- 身份标识
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vibe_id         VARCHAR(20) UNIQUE NOT NULL,  -- VB-A1B2C3D4
    display_name    VARCHAR(100),
    avatar_url      VARCHAR(500),

    -- 订阅状态 (缓存，权威数据在 user_subscriptions)
    tier            VARCHAR(20) DEFAULT 'free',   -- free | paid | premium
    tier_expires_at TIMESTAMPTZ,

    -- 用量配额 (每日/每月限制)
    daily_quota     JSONB DEFAULT '{
        "conversations": 10,
        "llm_calls": 50
    }',

    -- 计费汇总 (由 Worker 从 usage_events 定期聚合)
    billing_summary JSONB DEFAULT '{
        "current_month": {
            "llm_calls": 0,
            "tokens": 0,
            "cost_usd": 0.0
        },
        "lifetime": {
            "total_conversations": 0,
            "total_tokens": 0,
            "total_cost_usd": 0.0
        }
    }',

    -- 时间戳
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 认证表
CREATE TABLE vibe_user_auth (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    auth_type       VARCHAR(20) NOT NULL,  -- email | phone | wechat | apple
    auth_identifier VARCHAR(255) NOT NULL,
    auth_credential VARCHAR(255),          -- hashed password or token
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE (auth_type, auth_identifier)
);

-- 索引
CREATE INDEX idx_users_tier ON vibe_users (tier);
CREATE INDEX idx_users_vibe_id ON vibe_users (vibe_id);
```

**billing_summary 结构**:

```json
{
  "current_month": {
    "period": "2026-01",
    "llm_calls": 150,
    "tokens": 125000,
    "cost_usd": 0.45,
    "by_skill": {
      "bazi": {"calls": 80, "tokens": 60000},
      "zodiac": {"calls": 70, "tokens": 65000}
    }
  },
  "lifetime": {
    "total_conversations": 500,
    "total_tokens": 2500000,
    "total_cost_usd": 12.50,
    "first_use": "2025-06-01"
  }
}
```

---

### 3.2 unified_profiles (画像层)

```sql
CREATE TABLE unified_profiles (
    user_id     UUID PRIMARY KEY REFERENCES vibe_users(id) ON DELETE CASCADE,
    profile     JSONB NOT NULL DEFAULT '{}',
    created_at  TIMESTAMPTZ DEFAULT NOW(),
    updated_at  TIMESTAMPTZ DEFAULT NOW()
);

-- 历史归档表
CREATE TABLE unified_profiles_history (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id     UUID NOT NULL,
    profile     JSONB NOT NULL,
    archived_at TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_profiles_birth ON unified_profiles USING GIN ((profile -> 'birth_info'));
CREATE INDEX idx_profiles_history ON unified_profiles_history (user_id, archived_at DESC);
```

**profile JSONB 结构**:

```json
{
  "birth_info": {
    "date": "1990-05-15",
    "time": "10:30",
    "place": "北京",
    "gender": "male",
    "timezone": "Asia/Shanghai",
    "solar_date": "1990-05-15",
    "lunar_date": "庚午年四月廿一"
  },

  "skill_data": {
    "bazi": {
      "pillars": {
        "year": {"stem": "庚", "branch": "午"},
        "month": {"stem": "辛", "branch": "巳"},
        "day": {"stem": "甲", "branch": "子"},
        "hour": {"stem": "己", "branch": "巳"}
      },
      "day_master": "甲木",
      "day_master_strength": "身弱",
      "useful_god": "水",
      "dayun": [...],
      "calculated_at": "2026-01-18T10:00:00Z"
    },
    "zodiac": {
      "sun_sign": "金牛座",
      "moon_sign": "双子座",
      "rising_sign": "狮子座",
      "chart": {...},
      "calculated_at": "2026-01-18T10:00:00Z"
    }
  },

  "preferences": {
    "voice_mode": "warm",
    "language": "zh-CN",
    "timezone": "Asia/Shanghai",
    "notification_time": "08:00",
    "enable_proactive": true,
    "enable_fortune_insights": true
  },

  "life_context": {
    "current_focus": "职业发展",
    "career": {
      "industry": "互联网",
      "role": "产品经理",
      "concerns": ["晋升", "转型"]
    },
    "relationships": {
      "status": "已婚",
      "partner_birth": "1992-03-20"
    },
    "health": {},
    "updated_at": "2026-01-18T10:00:00Z"
  },

  "extracted": {
    "facts": ["在北京工作", "有两个孩子"],
    "concerns": ["职业发展", "子女教育"],
    "goals": ["今年晋升", "改善睡眠"],
    "patterns": ["早起型", "决策谨慎"],
    "extracted_at": "2026-01-18T10:00:00Z"
  }
}
```

---

### 3.3 user_data_store (内容层)

```sql
CREATE TABLE user_data_store (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id     UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    data_type   VARCHAR(50) NOT NULL,   -- goals | plans | checkins | docs | photos
    data_path   VARCHAR(255) NOT NULL,  -- goals/2026/year, plans/daily/2026-01-18
    content     JSONB NOT NULL,
    version     INTEGER DEFAULT 1,
    created_at  TIMESTAMPTZ DEFAULT NOW(),
    updated_at  TIMESTAMPTZ DEFAULT NOW(),

    UNIQUE (user_id, data_path)
);

-- 索引
CREATE INDEX idx_data_user_type ON user_data_store (user_id, data_type);
CREATE INDEX idx_data_user_path ON user_data_store (user_id, data_path);
CREATE INDEX idx_data_content ON user_data_store USING GIN (content);
CREATE INDEX idx_data_updated ON user_data_store (user_id, updated_at DESC);
```

**虚拟文件系统路径规范**:

```
/users/{user_id}/
│
├── goals/                          # 目标数据
│   ├── 2026/
│   │   ├── year                    # data_path: "goals/2026/year"
│   │   ├── q1                      # data_path: "goals/2026/q1"
│   │   ├── q2
│   │   └── months/
│   │       ├── 01                  # data_path: "goals/2026/months/01"
│   │       └── 02
│   └── 2025/
│
├── plans/                          # 计划数据
│   └── daily/
│       ├── 2026-01-18              # data_path: "plans/daily/2026-01-18"
│       └── 2026-01-19
│
├── checkins/                       # 打卡数据
│   ├── 2026-01-18                  # data_path: "checkins/2026-01-18"
│   └── 2026-01-19
│
├── reflections/                    # 复盘数据
│   ├── week_01                     # data_path: "reflections/week_01"
│   └── week_02
│
└── docs/                           # 用户文档
    ├── career_notes                # data_path: "docs/career_notes"
    └── reading_list
```

**content 示例**:

```json
// goals/2026/year
{
  "title": "2026年度目标",
  "level": "year",
  "status": "active",
  "progress": 25,
  "items": [
    {"id": "g1", "title": "完成 PMP 认证", "status": "in_progress", "deadline": "2026-06-30"},
    {"id": "g2", "title": "晋升高级产品经理", "status": "pending", "deadline": "2026-12-31"}
  ],
  "created_at": "2026-01-01T00:00:00Z"
}

// checkins/2026-01-18
{
  "date": "2026-01-18",
  "completed_tasks": ["task1", "task2"],
  "energy": 4,
  "mood": 4,
  "reflection": "今天效率很高，完成了主要任务",
  "highlights": ["完成了季度报告"],
  "created_at": "2026-01-18T21:30:00Z"
}
```

---

### 3.4 user_triggers (主动服务层)

```sql
CREATE TABLE user_triggers (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,

    -- 触发类型
    trigger_type    VARCHAR(50) NOT NULL,  -- reminder | condition | schedule

    -- 触发内容
    title           VARCHAR(255) NOT NULL,
    description     TEXT,
    action          JSONB NOT NULL DEFAULT '{}',

    -- 调度配置 (for reminder/schedule)
    schedule        VARCHAR(100),           -- cron 表达式 或 HH:MM
    schedule_type   VARCHAR(20),            -- once | daily | weekly | cron
    next_trigger_at TIMESTAMPTZ,
    last_triggered  TIMESTAMPTZ,

    -- 条件配置 (for condition trigger)
    condition       JSONB,

    -- 关联
    source_skill    VARCHAR(50),            -- 来源 skill
    source_path     VARCHAR(255),           -- 关联的 user_data_store path

    -- 状态
    status          VARCHAR(20) DEFAULT 'active',  -- active | paused | completed | cancelled
    trigger_count   INTEGER DEFAULT 0,
    metadata        JSONB DEFAULT '{}',

    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_trigger_user_status ON user_triggers (user_id, status);
CREATE INDEX idx_trigger_next ON user_triggers (next_trigger_at) WHERE status = 'active';
CREATE INDEX idx_trigger_type ON user_triggers (trigger_type, status);
```

**trigger_type 说明**:

| 类型 | 说明 | 示例 |
|------|------|------|
| reminder | 定时提醒 | 每天早8点提醒查看目标 |
| condition | 条件触发 | 连续打卡7天触发庆祝 |
| schedule | 定时任务 | 每周日生成周报 |

**action JSONB 示例**:

```json
// 提醒类
{
  "type": "proactive_message",
  "template": "daily_plan_reminder",
  "params": {
    "greeting": "新的一天开始了！来看看今天的计划吧",
    "include_fortune": true
  }
}

// 数据操作类
{
  "type": "generate_content",
  "template": "weekly_reflection",
  "params": {
    "output_path": "reflections/week_{week_number}"
  }
}

// 庆祝类
{
  "type": "celebration",
  "template": "streak_milestone",
  "params": {
    "milestone": 7,
    "badge": "一周坚持"
  }
}
```

**condition JSONB 示例**:

```json
// 连续打卡触发
{
  "type": "streak",
  "check_path": "checkins/*",
  "rule": {"streak_days": {"$gte": 7}}
}

// 目标即将到期触发
{
  "type": "deadline",
  "check_path": "goals/2026/*",
  "rule": {"days_until_deadline": {"$lte": 7}}
}

// 数据变化触发
{
  "type": "data_change",
  "watch_path": "goals/2026/year",
  "rule": {"progress": {"$gte": 100}}
}
```

---

## 4. 辅助表 (保持不变)

### 4.1 usage_events (用量事件流)

```sql
CREATE TABLE usage_events (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL,
    event_type      VARCHAR(50) NOT NULL,  -- llm_call | skill_use | tool_call | conversation
    model           VARCHAR(100),
    input_tokens    INTEGER DEFAULT 0,
    output_tokens   INTEGER DEFAULT 0,
    estimated_cost  DECIMAL(10, 6) DEFAULT 0,
    skill_id        VARCHAR(50),
    tool_name       VARCHAR(100),
    conversation_id UUID,
    metadata        JSONB,
    created_at      TIMESTAMPTZ DEFAULT NOW()
);

-- 分区表 (按月)
-- 索引
CREATE INDEX idx_usage_user_date ON usage_events (user_id, created_at);
CREATE INDEX idx_usage_skill ON usage_events (skill_id, created_at);
```

### 4.2 user_subscriptions (订阅管理)

```sql
CREATE TABLE user_subscriptions (
    id                      UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id                 UUID NOT NULL REFERENCES vibe_users(id),
    plan_id                 VARCHAR(50) NOT NULL,
    status                  VARCHAR(20) DEFAULT 'active',
    source_skill            VARCHAR(50),
    source_campaign         VARCHAR(100),
    payment_provider        VARCHAR(50),
    payment_subscription_id VARCHAR(255),
    started_at              TIMESTAMPTZ DEFAULT NOW(),
    current_period_end      TIMESTAMPTZ,
    cancelled_at            TIMESTAMPTZ
);
```

---

## 5. 数据流向图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                              数据流向                                       │
└────────────────────────────────────────────────────────────────────────────┘

  用户请求
     │
     ▼
┌────────────┐    配额检查     ┌────────────────┐
│  API 层    │───────────────►│   vibe_users   │
└────────────┘                 │ tier + quota   │
     │                         └────────────────┘
     │ 获取 Profile                    │
     ▼                                 │ 用量累计
┌────────────────┐            ┌────────┴───────┐
│ Profile Cache  │◄───────────│unified_profiles│
│  (Redis/内存)   │            │  (画像数据)     │
└────────────────┘            └────────────────┘
     │
     │ Agent 执行
     ▼
┌────────────┐   读写用户数据   ┌────────────────┐
│ CoreAgent  │◄──────────────►│ user_data_store│
│            │                 │  (内容数据)     │
└────────────┘                 └────────────────┘
     │
     │ 创建触发器
     ▼
┌────────────────┐
│ user_triggers  │◄───────────  ProactiveEngine 扫描
│  (主动服务)     │
└────────────────┘
     │
     │ 触发时
     ▼
┌────────────────┐
│ Notification   │───────────►  推送到用户
│   Service      │
└────────────────┘
     │
     ▼
┌────────────────┐
│ usage_events   │◄───────────  记录所有用量
│  (计费事件流)   │
└────────────────┘
     │
     ▼ (每日聚合 Worker)
┌────────────────┐
│ vibe_users     │
│.billing_summary│
└────────────────┘
```

---

## 6. 主动服务流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         主动服务架构 (Proactive Service)                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│   ┌─────────────┐     ┌─────────────────┐     ┌─────────────────────────┐   │
│   │   Cron Job  │────►│ ProactiveEngine │────►│    TriggerDetector      │   │
│   │ (每分钟跑)  │     │   (engine.py)   │     │  (trigger_detector.py)  │   │
│   └─────────────┘     └────────┬────────┘     └──────────────┬──────────┘   │
│                                │                              │              │
│                                │                              │ 检查触发条件 │
│                                │                              ▼              │
│                    ┌───────────┴───────────┐  ┌─────────────────────────┐   │
│                    │                       │  │     user_triggers       │   │
│                    │                       │  │ • reminder (定时提醒)   │   │
│                    │                       │  │ • condition (条件触发)  │   │
│                    │                       │  │ • schedule (定时任务)   │   │
│                    │                       │  └─────────────────────────┘   │
│                    │                       │              │                  │
│                    ▼                       ▼              ▼                  │
│        ┌─────────────────────┐ ┌─────────────────────────────────────────┐  │
│        │  ContentGenerator   │ │           ActionExecutor                 │  │
│        │ (生成个性化内容)     │ │  • proactive_message → 推送消息          │  │
│        └──────────┬──────────┘ │  • generate_content → 生成内容           │  │
│                   │            │  • celebration → 庆祝动画                 │  │
│                   │            │  • data_update → 更新数据                 │  │
│                   │            └─────────────────────────────────────────┘  │
│                   │                              │                           │
│                   ▼                              ▼                           │
│        ┌─────────────────────────────────────────────────────────────────┐  │
│        │                    NotificationService                           │  │
│        │                    (notification.py)                             │  │
│        ├─────────────────────────────────────────────────────────────────┤  │
│        │  • 保存到 notifications 表                                       │  │
│        │  • 推送到 APNs / FCM (移动端)                                    │  │
│        │  • WebSocket 实时推送 (Web端)                                    │  │
│        └─────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 系统提醒 vs 用户触发器

| 类型 | 来源 | 存储 | 示例 |
|------|------|------|------|
| **系统提醒** | reminders.yaml 配置 | 代码定义 | 每日早报、每日打卡提醒 |
| **用户触发器** | 用户通过对话创建 | user_triggers 表 | "每天8点提醒我看目标" |
| **条件触发器** | 系统根据规则创建 | user_triggers 表 | 连续打卡7天庆祝 |

---

## 8. 删除的表

| 表名 | 状态 | 原因 |
|------|------|------|
| `skill_profiles` | **删除** | 合并到 unified_profiles.skill_data |
| `user_reminders` | **升级** | 升级为 user_triggers，增加条件触发能力 |

---

## 9. 工具与卡片渲染架构

### 9.1 设计原则

1. **通用展示工具**: 用一个 `show_card` 替代多个业务语义工具
2. **后端决定卡片类型**: 工具返回 `{ card_type, data }`, 前端根据 card_type 渲染
3. **数据与展示分离**: 数据工具只负责 CRUD，展示工具只负责渲染

### 9.2 工具分层

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              工具分层架构 v3                                  │
└─────────────────────────────────────────────────────────────────────────────┘

Core Skill (基础层)
├── 数据工具 (返回数据)
│   ├── read_user_data      # 读取用户内容数据
│   ├── write_user_data     # 写入用户内容数据
│   ├── query_user_data     # 查询用户内容数据
│   └── delete_user_data    # 删除用户内容数据
│
├── 触发器工具
│   ├── create_trigger      # 创建触发器
│   ├── list_triggers       # 列出触发器
│   └── cancel_trigger      # 取消触发器
│
└── 展示工具 (通用)
    └── show_card           # 通用卡片展示工具
```

### 9.3 通用展示工具: show_card

```yaml
name: show_card
description: 展示卡片。根据 card_type 和 data_source 在聊天中渲染对应的可视化组件。

parameters:
  card_type:
    type: string
    description: 卡片类型
    enum:
      # 目标追踪类
      - goal_tree          # 目标树状图
      - daily_plan         # 每日计划
      - checkin_form       # 打卡表单
      - progress_ring      # 进度环
      - streak_counter     # 连续打卡计数

      # 通用数据类
      - data_list          # 列表视图
      - data_card          # 卡片视图
      - data_table         # 表格视图
      - data_timeline      # 时间线视图

      # Skill 专用类
      - bazi_chart         # 八字命盘
      - zodiac_chart       # 星盘
      - tarot_spread       # 塔罗牌阵

      # 触发器类
      - trigger_list       # 触发器列表
      - celebration        # 庆祝动画

    required: true

  data_source:
    type: object
    description: 数据来源配置
    properties:
      type:
        type: string
        enum: [path, inline, api]
        description: |
          - path: 从 user_data_store 读取
          - inline: 直接传入数据
          - api: 调用后端 API
      path:
        type: string
        description: user_data_store 路径 (当 type=path)
      data:
        type: object
        description: 内联数据 (当 type=inline)
      endpoint:
        type: string
        description: API 端点 (当 type=api)
    required: true

  options:
    type: object
    description: 卡片渲染选项
    properties:
      title:
        type: string
      subtitle:
        type: string
      interactive:
        type: boolean
        default: true
      theme:
        type: string
        enum: [default, warm, cool, nature]

returns:
  card_type: string
  data: object
  render_options: object
```

### 9.4 工具返回规范

所有工具返回统一格式，支持卡片渲染：

```typescript
interface ToolResult {
  // 必须
  status: 'success' | 'error' | 'pending';

  // 可选：卡片渲染
  card_type?: string;           // 前端根据此类型选择组件
  data?: Record<string, any>;   // 传给卡片组件的数据

  // 可选：模型输出
  model_output?: string;        // 简化的文本描述，减少 token

  // 可选：错误信息
  error?: string;
}
```

**示例**：

```json
// show_card(card_type="goal_tree", data_source={type: "path", path: "goals/2026"})
{
  "status": "success",
  "card_type": "goal_tree",
  "data": {
    "root": {
      "id": "2026",
      "title": "2026年度目标",
      "progress": 25,
      "children": [
        {"id": "q1", "title": "Q1目标", "progress": 60},
        {"id": "q2", "title": "Q2目标", "progress": 0}
      ]
    }
  },
  "model_output": "已展示2026年目标树，整体进度25%，Q1进度60%"
}
```

### 9.5 前端卡片注册表

```typescript
// CardRegistry.ts
const CARD_TYPES = {
  // 目标追踪类
  GOAL_TREE: 'goal_tree',
  DAILY_PLAN: 'daily_plan',
  CHECKIN_FORM: 'checkin_form',
  PROGRESS_RING: 'progress_ring',
  STREAK_COUNTER: 'streak_counter',

  // 通用数据类
  DATA_LIST: 'data_list',
  DATA_CARD: 'data_card',
  DATA_TABLE: 'data_table',
  DATA_TIMELINE: 'data_timeline',

  // Skill 专用类
  BAZI_CHART: 'bazi_chart',
  ZODIAC_CHART: 'zodiac_chart',
  TAROT_SPREAD: 'tarot_spread',

  // 触发器类
  TRIGGER_LIST: 'trigger_list',
  CELEBRATION: 'celebration',
} as const;

// 渲染流程
function renderToolResult(result: ToolResult) {
  if (result.card_type && CardRegistry.has(result.card_type)) {
    return CardRegistry.render(result.card_type, result.data);
  }
  return null; // 无卡片，仅文本
}
```

### 9.6 使用场景示例

**场景1**: 用户说 "帮我设定年度目标"

```
LLM 决策：
1. write_user_data(path="goals/2026/year", content={...})
2. show_card(card_type="goal_tree", data_source={type:"path", path:"goals/2026"})

后端返回：
{
  "card_type": "goal_tree",
  "data": { "root": {...} }
}

前端渲染：
GoalTreeCard 组件
```

**场景2**: 用户说 "展示我的八字"

```
LLM 决策：
1. show_card(card_type="bazi_chart", data_source={type:"api", endpoint:"/bazi/chart"})

后端返回：
{
  "card_type": "bazi_chart",
  "data": { "fourPillars": {...}, "dayMaster": {...} }
}

前端渲染：
BaziChartCard 组件
```

**场景3**: 用户说 "今天打卡"

```
LLM 决策：
1. read_user_data(path="plans/daily/2026-01-18")  → 获取今日计划
2. show_card(card_type="checkin_form", data_source={type:"inline", data:{...}})

后端返回：
{
  "card_type": "checkin_form",
  "data": {
    "date": "2026-01-18",
    "tasks": [...],
    "completed": []
  }
}

前端渲染：
CheckinFormCard 组件（可交互，提交后写入 checkins/2026-01-18）
```

### 9.7 交互式卡片

部分卡片支持用户交互，交互结果通过回调发送：

```typescript
interface InteractiveCardProps {
  data: any;
  onAction: (action: CardAction) => void;
}

interface CardAction {
  type: 'submit' | 'select' | 'confirm' | 'cancel';
  payload: Record<string, any>;
}

// CheckinFormCard 交互示例
function CheckinFormCard({ data, onAction }: InteractiveCardProps) {
  const handleSubmit = (completed: string[], reflection: string) => {
    onAction({
      type: 'submit',
      payload: {
        tool: 'write_user_data',
        params: {
          path: `checkins/${data.date}`,
          content: { completed, reflection, ...data }
        }
      }
    });
  };
  // ...
}
```

---

## 10. 关键设计决策

| 决策 | 选择 | 原因 |
|------|------|------|
| 计费数据位置 | vibe_users.billing_summary | 配额检查高频读取，汇总缓存避免聚合 |
| skill_data 位置 | unified_profiles | 是用户画像的一部分，Skill 间共享 |
| goal_tracking | 移到 user_data_store | 它是内容数据，不是画像元数据 |
| reminders 升级 | user_triggers | 支持条件触发，更强大的主动服务能力 |
| Profile 存储 | JSONB 单字段 | 灵活扩展，无需频繁 DDL |
| 用户数据存储 | 虚拟文件路径 | 支持层级结构，易于理解和查询 |
| 版本控制 | 乐观锁 (version) | 防止并发写入冲突 |
| **展示工具** | **通用 show_card** | **避免工具爆炸，前端卡片组件化** |
| **卡片类型决策** | **后端决定** | **LLM 只关心业务，渲染逻辑后端控制** |

---

## 11. 迁移检查清单

- [ ] 添加 vibe_users.tier, daily_quota, billing_summary 字段
- [ ] 创建 user_triggers 表
- [ ] 迁移 user_reminders 数据到 user_triggers
- [ ] 将 skill_profiles.profile_data 合并到 unified_profiles.skill_data
- [ ] 删除 skill_profiles 表
- [ ] 更新 UnifiedProfileRepository
- [ ] 创建 TriggerService 替代 ReminderService
- [ ] 创建计费汇总 Worker
