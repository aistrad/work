/**
 * 注册所有 Skill 卡片组件 (V7 重构版)
 *
 * v7.0 架构：
 * - 通用视图组件由 ShowCard 直接处理，无需注册
 * - Skill 自定义卡片通过 CardRegistry 注册
 * - 向后兼容旧卡片组件
 *
 * v10.4 性能优化 (Vercel rule: bundle-dynamic-imports):
 * - 使用动态导入延迟加载 Skill 卡片
 * - 只在首次需要时加载对应 Skill 的卡片
 */

import { registerCard, registerLazyCard, getRegisteredCardTypes, CARD_TYPES } from './CardRegistry';

// 通用视图组件 (由 ShowCard 直接处理)
import ShowCard from './shared/ShowCard';

// 向后兼容: 旧卡片组件 - 这些是常用的，保持同步导入
import CollectFormCard from './shared/CollectFormCard';
import InsightCard from './shared/InsightCard';
import SkillListCard from './shared/SkillListCard';

// 延迟加载的旧卡片组件
const ReportCard = () => import('./panels/ReportPanel').then(m => m.default);
const SkillServicesCard = () => import('./shared/SkillServicesCard').then(m => m.default);
const ServiceRecommendationCard = () => import('./shared/ServiceRecommendationCard').then(m => m.default);
const SkillRecommendationCard = () => import('./shared/SkillRecommendationCard').then(m => m.default);
const SkillIntroCard = () => import('./shared/SkillIntroCard').then(m => m.default);
const ShowVibeID = () => import('./vibe-id/tools/show-vibe-id').then(m => m.ShowVibeID);

// QuestionCard - 问答卡片 (V10.3)
import './shared/QuestionCard';

// 通用视图类型列表
const GENERIC_VIEW_TYPES = [
  CARD_TYPES.LIST,
  CARD_TYPES.TREE,
  CARD_TYPES.TABLE,
  CARD_TYPES.TIMELINE,
  CARD_TYPES.FORM,
  CARD_TYPES.SELECT,
  CARD_TYPES.CHART,
  CARD_TYPES.PROGRESS,
  CARD_TYPES.COUNTER,
  CARD_TYPES.MODAL,
  CARD_TYPES.TOAST,
  CARD_TYPES.CUSTOM,
] as const;

// 向后兼容卡片映射
const LEGACY_CARDS: Record<string, React.FC<any>> = {
  [CARD_TYPES.COLLECT_FORM]: CollectFormCard,
  [CARD_TYPES.INSIGHT_CARD]: InsightCard,
  [CARD_TYPES.REPORT_CARD]: ReportCard,
  [CARD_TYPES.SKILL_SERVICES]: SkillServicesCard,
  [CARD_TYPES.SERVICE_RECOMMENDATION]: ServiceRecommendationCard,
  [CARD_TYPES.SKILL_RECOMMENDATION]: SkillRecommendationCard,
  [CARD_TYPES.SKILL_LIST]: SkillListCard,
};

/**
 * 初始化卡片注册表
 * 在应用启动时调用
 */
export function initializeCardRegistry(): void {
  // 注册通用视图组件 (V7)
  for (const type of GENERIC_VIEW_TYPES) {
    registerCard(type, ShowCard);
  }

  // 注册向后兼容卡片
  for (const [type, component] of Object.entries(LEGACY_CARDS)) {
    registerCard(type, component);
  }

  // 注册 VibeID 卡片
  registerCard(CARD_TYPES.VIBE_ID, ShowVibeID);
  registerCard(CARD_TYPES.VIBE_ID_RADAR, ShowVibeID);

  // 注册 SkillIntroCard
  registerCard(CARD_TYPES.SKILL_INTRO, SkillIntroCard);

  if (process.env.NODE_ENV === 'development') {
    console.log('[CardRegistry] V7 Initialized:', getRegisteredCardTypes());
  }
}

// 导出 ShowCard 供直接使用
export { ShowCard };

// 自动初始化 - 当文件被导入时自动执行
initializeCardRegistry();

export default initializeCardRegistry;
