"use client";

/**
 * NavBar - PC端左侧导航栏 v10.0
 *
 * V10 变更:
 * - 对话历史整合到 NavBar 中
 * - "对话"按钮 = 开始新对话
 * - 历史对话列表显示在导航链接下方
 */

import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { cn } from "@/lib/utils";
import {
  MessageSquare,
  Compass,
  Sparkles,
  User,
  PanelLeftClose,
  PanelLeft,
  Settings,
  Plus,
  MoreHorizontal,
  Pencil,
  Trash2,
  Heart,
} from "lucide-react";
import Link from "next/link";
import type { LucideIcon } from "lucide-react";
import { VibeGlyph, type SkillType } from "@/components/core";
import { type TabType } from "./AppShell";
import { useConversations, type ConversationItem } from "@/hooks/useConversations";

// ═══════════════════════════════════════════════════════════════════════════
// Types & Config
// ═══════════════════════════════════════════════════════════════════════════

interface NavBarProps {
  skill: SkillType;
  activeTab: TabType;
  onTabChange: (tab: TabType) => void;
  activeConversationId: string | null;
  onSelectConversation: (id: string | null) => void;
  onNewChat: () => void;
  className?: string;
}

interface NavItem {
  id: TabType;
  icon: LucideIcon;
  label: string;
  description?: string;
  color?: string;
}

// V10: 4 navigation items - 顺序：旅程、我的、关系、探索
const NAV_ITEMS: NavItem[] = [
  {
    id: "journey",
    icon: Compass,
    label: "旅程",
    description: "我的旅程",
    color: "#22c55e", // 翠绿
  },
  {
    id: "me",
    icon: User,
    label: "我的",
    description: "个人中心",
    color: "#3b82f6", // 蓝色
  },
  {
    id: "relations",
    icon: Heart,
    label: "关系",
    description: "人际关系",
    color: "#ec4899", // 粉红
  },
  {
    id: "discover",
    icon: Sparkles,
    label: "探索",
    description: "发现更多 Skills",
    color: "#a855f7", // 紫色
  },
];

const STORAGE_KEY = "vibelife-navbar-expanded";

// ═══════════════════════════════════════════════════════════════════════════
// NavBar Component
// ═══════════════════════════════════════════════════════════════════════════

export function NavBar({
  skill,
  activeTab,
  onTabChange,
  activeConversationId,
  onSelectConversation,
  onNewChat,
  className,
}: NavBarProps) {
  const [isExpanded, setIsExpanded] = useState(true); // 默认展开
  const [hoveredItem, setHoveredItem] = useState<string | null>(null);
  const [isMounted, setIsMounted] = useState(false);
  const [menuOpenId, setMenuOpenId] = useState<string | null>(null);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editTitle, setEditTitle] = useState("");

  const { conversations, isLoading, renameConversation, deleteConversation } = useConversations();

  // 从 localStorage 恢复状态
  useEffect(() => {
    setIsMounted(true);
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved !== null) {
      setIsExpanded(saved === "true");
    }
  }, []);

  const toggleExpanded = () => {
    setIsExpanded((prev) => {
      const newValue = !prev;
      if (typeof window !== "undefined") {
        localStorage.setItem(STORAGE_KEY, String(newValue));
      }
      return newValue;
    });
  };

  // 开始新对话
  const handleNewChat = () => {
    onNewChat();
    onTabChange("chat");
  };

  // 选择对话
  const handleSelectConversation = (id: string) => {
    onSelectConversation(id);
    onTabChange("chat");
    setMenuOpenId(null);
  };

  // 重命名对话
  const handleRename = async (id: string) => {
    if (editTitle.trim()) {
      await renameConversation(id, editTitle.trim());
    }
    setEditingId(null);
    setEditTitle("");
  };

  // 删除对话
  const handleDelete = async (id: string) => {
    await deleteConversation(id);
    if (activeConversationId === id) {
      onSelectConversation(null);
    }
    setMenuOpenId(null);
  };

  return (
    <motion.nav
      initial={false}
      animate={{ width: isExpanded ? 260 : 64 }}
      transition={{ duration: 0.2, ease: "easeInOut" }}
      className={cn(
        "h-full flex flex-col bg-card border-r border-border",
        className
      )}
    >
      {/* Logo Area + Collapse Toggle */}
      <div className="h-14 flex items-center justify-between px-3 border-b border-border">
        <div className="flex items-center gap-2">
          <VibeGlyph size="sm" skill={skill} showAura={false} animate={false} />
          {isExpanded && (
            <span className="font-serif font-semibold text-foreground whitespace-nowrap">
              VibeLife
            </span>
          )}
        </div>
        <button
          onClick={toggleExpanded}
          aria-label={isExpanded ? "收起侧边栏" : "展开侧边栏"}
          className="p-1.5 rounded-md text-muted-foreground/60 hover:text-muted-foreground hover:bg-muted/50 transition-colors"
        >
          {isExpanded ? <PanelLeftClose className="w-4 h-4" /> : <PanelLeft className="w-4 h-4" />}
        </button>
      </div>

      {/* New Chat Button */}
      <div className="px-2 pt-3 pb-2">
        <button
          onClick={handleNewChat}
          className={cn(
            "w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all duration-200",
            "bg-muted/60 text-foreground hover:bg-muted",
            "border border-border/50"
          )}
        >
          <Plus className="w-5 h-5 flex-shrink-0" />
          <AnimatePresence>
            {isExpanded && (
              <motion.span
                initial={{ opacity: 0, width: 0 }}
                animate={{ opacity: 1, width: "auto" }}
                exit={{ opacity: 0, width: 0 }}
                className="text-sm font-medium overflow-hidden whitespace-nowrap"
              >
                新对话
              </motion.span>
            )}
          </AnimatePresence>
        </button>
      </div>

      {/* Conversation History */}
      {isExpanded && (
        <div className="flex-1 overflow-y-auto px-2 pb-2">
          <div className="text-xs text-muted-foreground px-3 py-2 font-medium">
            对话历史
          </div>
          <div className="space-y-0.5">
            {conversations.slice(0, 20).map((conv) => (
              <ConversationItem
                key={conv.id}
                conversation={conv}
                isActive={activeConversationId === conv.id}
                isMenuOpen={menuOpenId === conv.id}
                isEditing={editingId === conv.id}
                editTitle={editTitle}
                onSelect={() => handleSelectConversation(conv.id)}
                onMenuToggle={() => setMenuOpenId(menuOpenId === conv.id ? null : conv.id)}
                onStartEdit={() => {
                  setEditingId(conv.id);
                  setEditTitle(conv.title || "");
                  setMenuOpenId(null);
                }}
                onEditChange={setEditTitle}
                onEditSave={() => handleRename(conv.id)}
                onEditCancel={() => {
                  setEditingId(null);
                  setEditTitle("");
                }}
                onDelete={() => handleDelete(conv.id)}
              />
            ))}
            {isLoading && (
              <div className="px-3 py-2 text-xs text-muted-foreground">加载中...</div>
            )}
            {!isLoading && conversations.length === 0 && (
              <div className="px-3 py-2 text-xs text-muted-foreground">暂无对话</div>
            )}
          </div>
        </div>
      )}

      {/* Nav Items - 收起态时显示 */}
      {!isExpanded && (
        <div className="flex-1 py-2 space-y-1">
          {/* Chat icon for collapsed state */}
          <div className="relative px-2">
            <button
              onClick={handleNewChat}
              onMouseEnter={() => setHoveredItem("chat")}
              onMouseLeave={() => setHoveredItem(null)}
              className={cn(
                "w-full flex items-center justify-center p-2.5 rounded-lg transition-all duration-200",
                activeTab === "chat"
                  ? "bg-skill-primary/10 text-skill-primary"
                  : "text-muted-foreground hover:bg-muted hover:text-foreground"
              )}
            >
              <MessageSquare className="w-5 h-5" />
            </button>
            {hoveredItem === "chat" && (
              <motion.div
                initial={{ opacity: 0, x: -4 }}
                animate={{ opacity: 1, x: 0 }}
                className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
              >
                <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
                  新对话
                  <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
                </div>
              </motion.div>
            )}
          </div>

          {NAV_ITEMS.map((item) => {
            const Icon = item.icon;
            const isActive = activeTab === item.id;

            return (
              <div key={item.id} className="relative px-2">
                <button
                  onClick={() => onTabChange(item.id)}
                  onMouseEnter={() => setHoveredItem(item.id)}
                  onMouseLeave={() => setHoveredItem(null)}
                  className={cn(
                    "w-full flex items-center justify-center p-2.5 rounded-lg transition-all duration-200",
                    isActive
                      ? "bg-black/5 dark:bg-white/10"
                      : "hover:bg-muted"
                  )}
                >
                  <Icon
                    className="w-5 h-5"
                    style={{ color: item.color }}
                  />
                </button>
                {hoveredItem === item.id && (
                  <motion.div
                    initial={{ opacity: 0, x: -4 }}
                    animate={{ opacity: 1, x: 0 }}
                    className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
                  >
                    <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
                      {item.label}
                      <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
                    </div>
                  </motion.div>
                )}
              </div>
            );
          })}
        </div>
      )}

      {/* Other Nav Items - 展开态 */}
      {isExpanded && (
        <div className="border-t border-border py-2 space-y-1">
          {NAV_ITEMS.map((item) => {
            const Icon = item.icon;
            const isActive = activeTab === item.id;

            return (
              <div key={item.id} className="px-2">
                <button
                  onClick={() => onTabChange(item.id)}
                  className={cn(
                    "w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all duration-200",
                    isActive
                      ? "bg-black/5 dark:bg-white/10"
                      : "hover:bg-muted"
                  )}
                >
                  <Icon
                    className="w-5 h-5 flex-shrink-0"
                    style={{ color: item.color }}
                  />
                  <span className="text-sm font-medium text-foreground">{item.label}</span>
                </button>
              </div>
            );
          })}
        </div>
      )}

      {/* Settings Link */}
      <div className="p-2 border-t border-border">
        <Link
          href="/settings"
          className={cn(
            "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200",
            "text-muted-foreground hover:bg-muted hover:text-foreground"
          )}
        >
          <Settings className="w-5 h-5 flex-shrink-0" />
          <AnimatePresence>
            {isExpanded && (
              <motion.span
                initial={{ opacity: 0, width: 0 }}
                animate={{ opacity: 1, width: "auto" }}
                exit={{ opacity: 0, width: 0 }}
                className="text-sm font-medium overflow-hidden whitespace-nowrap"
              >
                设置
              </motion.span>
            )}
          </AnimatePresence>
        </Link>
      </div>
    </motion.nav>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// ConversationItem Component
// ═══════════════════════════════════════════════════════════════════════════

interface ConversationItemProps {
  conversation: ConversationItem;
  isActive: boolean;
  isMenuOpen: boolean;
  isEditing: boolean;
  editTitle: string;
  onSelect: () => void;
  onMenuToggle: () => void;
  onStartEdit: () => void;
  onEditChange: (value: string) => void;
  onEditSave: () => void;
  onEditCancel: () => void;
  onDelete: () => void;
}

function ConversationItem({
  conversation,
  isActive,
  isMenuOpen,
  isEditing,
  editTitle,
  onSelect,
  onMenuToggle,
  onStartEdit,
  onEditChange,
  onEditSave,
  onEditCancel,
  onDelete,
}: ConversationItemProps) {
  if (isEditing) {
    return (
      <div className="px-2 py-1">
        <input
          type="text"
          value={editTitle}
          onChange={(e) => onEditChange(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === "Enter") onEditSave();
            if (e.key === "Escape") onEditCancel();
          }}
          onBlur={onEditSave}
          autoFocus
          className="w-full px-2 py-1 text-sm bg-background border border-border rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--accent-primary)]"
        />
      </div>
    );
  }

  return (
    <div className="relative group">
      <button
        onClick={onSelect}
        className={cn(
          "w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left transition-all duration-200",
          isActive
            ? "bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]"
            : "text-text-secondary hover:bg-muted hover:text-foreground"
        )}
      >
        <MessageSquare className="w-4 h-4 flex-shrink-0 opacity-60" />
        <span className="text-sm truncate flex-1">{conversation.title || "新对话"}</span>
      </button>

      {/* Menu Button */}
      <button
        onClick={(e) => {
          e.stopPropagation();
          onMenuToggle();
        }}
        className={cn(
          "absolute right-1 top-1/2 -translate-y-1/2 p-1 rounded-md transition-opacity",
          "opacity-0 group-hover:opacity-100",
          isMenuOpen && "opacity-100",
          "text-muted-foreground hover:text-foreground hover:bg-muted"
        )}
      >
        <MoreHorizontal className="w-4 h-4" />
      </button>

      {/* Dropdown Menu */}
      {isMenuOpen && (
        <div className="absolute right-0 top-full mt-1 z-50 bg-card border border-border rounded-lg shadow-lg py-1 min-w-[120px]">
          <button
            onClick={(e) => {
              e.stopPropagation();
              onStartEdit();
            }}
            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left hover:bg-muted transition-colors"
          >
            <Pencil className="w-3.5 h-3.5" />
            <span>重命名</span>
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation();
              onDelete();
            }}
            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-colors"
          >
            <Trash2 className="w-3.5 h-3.5" />
            <span>删除</span>
          </button>
        </div>
      )}
    </div>
  );
}
