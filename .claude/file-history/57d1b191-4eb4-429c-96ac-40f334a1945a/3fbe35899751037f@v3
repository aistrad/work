# Fortune AI åç«¯é‡æ„è®¡åˆ’ (v4.2 Vercel AI SDK Edition)

**æ–‡æ¡£ç±»å‹**: Backend Refactoring Plan
**ç‰ˆæœ¬**: v4.2
**æ—¥æœŸ**: 2026-01-01
**ç›®æ ‡**: å°†åç«¯æ¶æ„ä» Python-centric è¿ç§»åˆ° Vercel AI SDK Driven æ¶æ„

---

## 0. æ‰§è¡Œæ‘˜è¦

### 0.1 é‡æ„ç›®æ ‡

å°† Fortune AI åç«¯ä»å½“å‰çš„ **Python FastAPI å…¨æ ˆæ¶æ„** é‡æ„ä¸º **Vercel AI SDK Driven åˆ†å±‚æ¶æ„**ï¼š

| å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ |
|----------|----------|
| FastAPI æ‰¿è½½ AI æ¨ç† + æ•°æ®æœåŠ¡ | Next.js API Route æ‰¿è½½ AI æ¨ç† |
| `glm_client.py` ç›´æ¥è°ƒç”¨ LLM | `streamText()` + Multi-Model Provider |
| è‡ªå®šä¹‰ SSE æ ¼å¼ | `toDataStreamResponse()` æ ‡å‡†æµ |
| Python L2 Agents | TypeScript `tool()` Skills |
| agent_service è¾…åŠ©è§’è‰² | Agent Runtime æ ¸å¿ƒè§’è‰² |

### 0.2 æ ¸å¿ƒæ”¶ç›Š

1. **ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“**: `useChat()` â†’ `streamText()` â†’ `toDataStreamResponse()`
2. **å¤šæ¨¡å‹çƒ­åˆ‡æ¢**: GLM-4.5 / Gemini / Claude é€šè¿‡ Vercel AI Gateway åŠ¨æ€åˆ‡æ¢
3. **Skills å¯æ’æ‹”**: Tool Calling æ ‡å‡†åŒ–ï¼Œæ–°å¢ Expert Agent åªéœ€æ·»åŠ  `tool()` å®šä¹‰
4. **maxSteps å¤šæ­¥æ¨ç†**: å•æ¬¡è¯·æ±‚å¯å¤šæ¬¡ Tool è°ƒç”¨åç»¼åˆè¾“å‡º
5. **ç±»å‹å®‰å…¨**: Zod Schema å‚æ•°éªŒè¯

### 0.3 é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|:----:|----------|
| API å…¼å®¹æ€§ç ´å | ğŸ”´ é«˜ | åŒè·¯ç”±å¹¶è¡ŒæœŸï¼Œé€æ­¥è¿ç§» |
| å‰ç«¯ CSRF é—®é¢˜ | ğŸŸ¡ ä¸­ | Next.js API Route åŒæºï¼Œæ— è·¨åŸŸ |
| æ•°æ®æœåŠ¡è°ƒç”¨å»¶è¿Ÿ | ğŸŸ¡ ä¸­ | Tool execute æ‰¹é‡èšåˆï¼Œç¼“å­˜çƒ­ç‚¹æ•°æ® |
| å›¢é˜Ÿ TypeScript ç†Ÿç»ƒåº¦ | ğŸŸ¢ ä½ | ç°æœ‰ agent_service å·²æœ‰ TS åŸºç¡€ |

---

## 1. ç°çŠ¶åˆ†æ

### 1.1 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å½“å‰æ¶æ„ (v4.0/v4.1)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Browser (:8231/new)
    â”‚
    â”‚ HTTP (fetch + SSE)
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI (:8230)                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  19 Route Files                                                     â”‚  â”‚
â”‚  â”‚  auth_routes / chat_routes / dashboard_routes / bazi_routes ...    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services Layer           â–¼                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚glm_client.pyâ”‚ â”‚bazi_engine  â”‚ â”‚twin_service â”‚ â”‚goal_service â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (LLM è°ƒç”¨)  â”‚ â”‚  (L0 è®¡ç®—) â”‚ â”‚ (çŠ¶æ€ç®¡ç†) â”‚ â”‚ (ç›®æ ‡ç®¡ç†) â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Agent Service Client     â”‚ (HTTP è°ƒç”¨ TypeScript Agent)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Service (:3000) - Express + Vercel AI SDK                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  coach.ts: runCoachAgent() - ä½†ä»…ä½œä¸ºè¾…åŠ©ï¼Œä¸»æµé‡ä»èµ° Python         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                        PostgreSQL (fortune_ai)
```

### 1.2 ç°æœ‰æ–‡ä»¶æ¸…å•

**API Routes (19 ä¸ª)**:
```
api/
â”œâ”€â”€ auth_routes.py        # è®¤è¯ (register/login/logout)
â”œâ”€â”€ chat_routes.py        # å¯¹è¯ (send/stream) âš ï¸ æ ¸å¿ƒé‡æ„å¯¹è±¡
â”œâ”€â”€ dashboard_routes.py   # Dashboard Zone B
â”œâ”€â”€ bazi_routes.py        # å…«å­—è®¡ç®—
â”œâ”€â”€ bento_routes.py       # Bento 6 å¡ç‰‡ (legacy)
â”œâ”€â”€ twin_routes.py        # æ•°å­—å­ªç”Ÿ
â”œâ”€â”€ goal_routes.py        # ç›®æ ‡ç®¡ç†
â”œâ”€â”€ reflection_routes.py  # å¤ç›˜
â”œâ”€â”€ report_routes.py      # æ·±åº¦æŠ¥å‘Š
â”œâ”€â”€ poster_routes.py      # æµ·æŠ¥ç”Ÿæˆ
â”œâ”€â”€ yunshi_routes.py      # è¿åŠ¿
â”œâ”€â”€ plan_routes.py        # è®¡åˆ’
â”œâ”€â”€ kb_routes.py          # çŸ¥è¯†åº“
â”œâ”€â”€ session_routes.py     # ä¼šè¯ç®¡ç†
â”œâ”€â”€ user_routes.py        # ç”¨æˆ·èµ„æ–™
â”œâ”€â”€ social_routes.py      # ç¤¾äº¤
â”œâ”€â”€ push_routes.py        # æ¨é€
â”œâ”€â”€ currency_routes.py    # è´§å¸
â”œâ”€â”€ jitai_routes.py       # å‰å°
â”œâ”€â”€ agent_tool.py         # Agent å·¥å…· API
â”œâ”€â”€ deps.py               # ä¾èµ–æ³¨å…¥
â””â”€â”€ main.py               # å…¥å£
```

**Services (æ ¸å¿ƒ)**:
```
services/
â”œâ”€â”€ glm_client.py          # âš ï¸ å¾…åˆ é™¤ï¼šç›´æ¥ LLM è°ƒç”¨
â”œâ”€â”€ chat_service.py        # ä¼šè¯æ¶ˆæ¯ç®¡ç†
â”œâ”€â”€ bazi_engine.py         # L0 å…«å­—è®¡ç®— âœ… ä¿ç•™
â”œâ”€â”€ bazi_facts.py          # äº‹å®æå– âœ… ä¿ç•™
â”œâ”€â”€ twin_service.py        # æ•°å­—å­ªç”Ÿ âœ… ä¿ç•™
â”œâ”€â”€ goal_service.py        # ç›®æ ‡ç®¡ç† âœ… ä¿ç•™
â”œâ”€â”€ reflection_service.py  # å¤ç›˜ âœ… ä¿ç•™
â”œâ”€â”€ soul_os.py             # ä¸Šä¸‹æ–‡ç»„è£… âš ï¸ é‡æ„
â”œâ”€â”€ agent_service_client.py # âš ï¸ å¾…åˆ é™¤ï¼šæ”¹ä¸º Next.js å†…éƒ¨è°ƒç”¨
â””â”€â”€ ...
```

### 1.3 å…³é”®ç—›ç‚¹

| ç—›ç‚¹ | å½±å“ | æ ¹å›  |
|------|------|------|
| åŒè¯­è¨€äº¤äº’å¤æ‚ | ç»´æŠ¤æˆæœ¬é«˜ | Python/TS è¾¹ç•Œä¸æ¸…æ™° |
| æµå¼æ¸²æŸ“éæ ‡å‡† | å‰ç«¯é€‚é…å›°éš¾ | è‡ªå®šä¹‰ SSE æ ¼å¼ |
| LLM è°ƒç”¨åˆ†æ•£ | éš¾ä»¥ç»Ÿä¸€ç®¡ç† | glm_client + agent_service å¹¶å­˜ |
| Tool Calling æ‰‹åŠ¨ | æ‰©å±•å›°éš¾ | æ— æ ‡å‡†åŒ– Skills æ¡†æ¶ |
| A2UI éæµå¼ | é¦–å­—å»¶è¿Ÿé«˜ | JSON æ•´ä½“è¿”å› |

---

## 2. ç›®æ ‡æ¶æ„

### 2.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç›®æ ‡æ¶æ„ (v4.2 Vercel AI SDK)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Browser
    â”‚
    â”‚ useChat() Hook
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js (:8231)                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  app/api/chat/route.ts   â† Agent Runtime (æ ¸å¿ƒ)                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  streamText({                                                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    model: selectModel(),     // GLM / Gemini / Claude         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    system: buildSystemPrompt(context),                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    tools: getToolsForMode(mode),                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    maxSteps: 5,                                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  }) â†’ toDataStreamResponse()                                  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Skills Registry          â–¼                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚Divine Skillsâ”‚ â”‚ Heal Skills â”‚ â”‚ Grow Skills â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚calculate_   â”‚ â”‚log_perma    â”‚ â”‚covey_matrix â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚  bazi/ziwei â”‚ â”‚cbt_reframe  â”‚ â”‚goal_setting â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚               â”‚
             â”‚ fetch()       â”‚ fetch()       â”‚ fetch()
             â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI (:8230) - çº¯æ•°æ®æœåŠ¡å±‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Data Service APIs (æ—  LLM è°ƒç”¨)                                    â”‚  â”‚
â”‚  â”‚  /api/bazi/calculate     /api/perma/log      /api/goals/create     â”‚  â”‚
â”‚  â”‚  /api/user/context       /api/twin/update    /api/tasks/create     â”‚  â”‚
â”‚  â”‚  /api/landing/insight    /api/kb/search      /api/checkin/mood     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services Layer (ä¿ç•™)    â”‚                                        â”‚  â”‚
â”‚  â”‚  bazi_engine / twin_service / goal_service / reflection_service   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                        PostgreSQL (fortune_ai)
```

### 2.2 èŒè´£è¾¹ç•Œ

| å±‚çº§ | è¿è¡Œç¯å¢ƒ | èŒè´£ | æŠ€æœ¯æ ˆ |
|------|----------|------|--------|
| **Frontend** | Browser | UI æ¸²æŸ“ã€æµå¼å±•ç¤ºã€Command è¾“å…¥ | React + `useChat()` |
| **Agent Runtime** | Next.js API Route | AI æ¨ç†ã€Tool Callingã€æµå¼è¾“å‡º | `streamText()` + `tool()` |
| **Skills Registry** | Next.js | å¯æ’æ‹”æŠ€èƒ½å®šä¹‰ | Zod Schema + execute |
| **Data Service** | FastAPI | L0/L1 æ•°æ® CRUDã€è®¡ç®—é€»è¾‘ | Python + PostgreSQL |
| **Insight Agent** | Cron Worker | Cold Path æ•°æ®æ²‰æ·€ | Python |

### 2.3 API ç«¯ç‚¹è§„åˆ’

**Next.js API Routes (æ–°å¢)**:
```typescript
// Agent Runtime
POST /api/chat           // streamText() ä¸»å…¥å£
POST /api/command        // /divine /heal /grow æŒ‡ä»¤è·¯ç”±

// Landing Page (å¯é€‰è¿ç§»)
POST /api/landing/insight  // å³æ—¶æ´å¯Ÿ (æ— éœ€ç™»å½•)
```

**FastAPI Data Service (é‡æ„)**:
```python
# L0 Base Data
GET  /api/user/context        # èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡
GET  /api/user/profile        # ç”¨æˆ·èµ„æ–™
PUT  /api/user/profile        # æ›´æ–°èµ„æ–™

# L1 Module Data - Divine
POST /api/bazi/calculate      # å…«å­—è®¡ç®—
POST /api/ziwei/calculate     # ç´«å¾®è®¡ç®—
GET  /api/bazi/facts/{user_id}  # è·å–äº‹å®

# L1 Module Data - Heal
POST /api/perma/log           # PERMA è®°å½•
GET  /api/perma/query         # PERMA æŸ¥è¯¢
POST /api/checkin/mood        # æƒ…ç»ªæ‰“å¡

# L1 Module Data - Grow
POST /api/goals/create        # åˆ›å»ºç›®æ ‡
GET  /api/goals/active        # æ´»è·ƒç›®æ ‡
POST /api/tasks/create        # åˆ›å»ºä»»åŠ¡
PUT  /api/tasks/{id}/complete # å®Œæˆä»»åŠ¡

# Twin
GET  /api/twin/{user_id}      # è·å–å­ªç”Ÿæ•°æ®
PUT  /api/twin/update         # æ›´æ–°å­ªç”Ÿ

# KB
POST /api/kb/search           # çŸ¥è¯†åº“æ£€ç´¢

# ä¿ç•™ (æš‚ä¸è¿ç§»)
/api/auth/*                   # è®¤è¯
/api/report/*                 # æ·±åº¦æŠ¥å‘Š
/api/poster/*                 # æµ·æŠ¥
/api/dashboard/*              # Dashboard
```

---

## 3. é‡æ„é˜¶æ®µ

### Phase 1: åŸºç¡€è®¾æ–½å‡†å¤‡ (Week 1)

**ç›®æ ‡**: å»ºç«‹ Next.js Agent Runtime åŸºç¡€æ¡†æ¶

#### 1.1 Next.js API Route ç»“æ„

```bash
web-app/src/app/api/
â”œâ”€â”€ chat/
â”‚   â””â”€â”€ route.ts              # ä¸» Agent Runtime
â”œâ”€â”€ command/
â”‚   â””â”€â”€ route.ts              # æŒ‡ä»¤è·¯ç”±
â””â”€â”€ landing/
    â””â”€â”€ insight/
        â””â”€â”€ route.ts          # Landing Page æ´å¯Ÿ
```

#### 1.2 Skills Registry æ¡†æ¶

```bash
web-app/src/lib/
â”œâ”€â”€ skills/
â”‚   â”œâ”€â”€ index.ts              # Skills ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ divine-skills.ts      # ç„å­¦æŠ€èƒ½
â”‚   â”œâ”€â”€ heal-skills.ts        # ç–—æ„ˆæŠ€èƒ½
â”‚   â””â”€â”€ grow-skills.ts        # æˆé•¿æŠ€èƒ½
â”œâ”€â”€ models/
â”‚   â””â”€â”€ model-provider.ts     # Multi-Model é…ç½®
â””â”€â”€ context/
    â””â”€â”€ context-builder.ts    # System Prompt æ„å»º
```

#### 1.3 é…ç½® Multi-Model Provider

```typescript
// lib/models/model-provider.ts
import { createGoogleGenerativeAI } from '@ai-sdk/google';
import { createAnthropic } from '@ai-sdk/anthropic';

const google = createGoogleGenerativeAI({
  apiKey: process.env.GOOGLE_API_KEY,
});

const anthropic = createAnthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

// Vercel AI Gateway for GLM-4.5
const glm = createGoogleGenerativeAI({
  baseURL: 'https://gateway.ai.cloudflare.com/v1/...',
  apiKey: process.env.GLM_API_KEY,
});

export function selectModel(preference?: string) {
  switch (preference) {
    case 'gemini': return google('gemini-2.0-flash-exp');
    case 'claude': return anthropic('claude-3-5-sonnet-20241022');
    case 'glm':
    default: return glm('glm-4.5');
  }
}
```

#### 1.4 äº¤ä»˜ç‰©

- [ ] Next.js `/api/chat/route.ts` åŸºç¡€æ¡†æ¶
- [ ] Skills Registry ç›®å½•ç»“æ„
- [ ] Multi-Model Provider é…ç½®
- [ ] ç¯å¢ƒå˜é‡é…ç½® (`.env.local`)

---

### Phase 2: Agent Runtime è¿ç§» (Week 2)

**ç›®æ ‡**: å°† AI æ¨ç†é€»è¾‘ä» Python è¿ç§»åˆ° Next.js

#### 2.1 å®ç° `/api/chat/route.ts`

```typescript
// app/api/chat/route.ts
import { streamText } from 'ai';
import { selectModel } from '@/lib/models/model-provider';
import { allSkills } from '@/lib/skills';
import { buildSystemPrompt } from '@/lib/context/context-builder';

export async function POST(req: Request) {
  const { messages, userId, command } = await req.json();

  // è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ (è°ƒç”¨ FastAPI)
  const context = await fetch(`${FASTAPI_URL}/api/user/context?user_id=${userId}`);
  const contextData = await context.json();

  // æ ¹æ® Command ç­›é€‰ Tools
  const tools = command
    ? getToolsForCommand(command)  // /divine â†’ divineSkills only
    : allSkills;                    // Chat Mode: all tools

  const result = streamText({
    model: selectModel(contextData.preference),
    system: buildSystemPrompt(contextData),
    messages,
    tools,
    maxSteps: 5,  // å…è®¸å¤šæ­¥æ¨ç†
  });

  return result.toDataStreamResponse();
}
```

#### 2.2 System Prompt è¿ç§»

å°† `chat_routes.py:SYSTEM_PROMPT_TEMPLATE` è¿ç§»åˆ° TypeScriptï¼š

```typescript
// lib/context/context-builder.ts
export function buildSystemPrompt(context: UserContext): string {
  return `ä½ æ˜¯ Fortune AI çš„å¯¹è¯ Agentï¼Œè§’è‰²æ˜¯ç§¯æå¿ƒç†å­¦æ•™ç»ƒã€‚

ã€ç¡¬æ€§è§„åˆ™ã€‘
1) ç¦æ­¢æå“ã€ç¾è¾±ã€å®¿å‘½è®ºæ–­è¨€ï¼›è´Ÿé¢ä¿¡æ¯å¿…é¡»ç´§æ¥"ä½ å¯ä»¥åšä»€ä¹ˆ"çš„è¡ŒåŠ¨å¤„æ–¹ã€‚
2) ç¦æ­¢è‡ªè¡Œè®¡ç®—å…«å­—äº‹å®ï¼›åªèƒ½åŸºäºæä¾›çš„ facts + evidence è¾“å‡ºã€‚
3) æ¯æ¬¡è¾“å‡ºå¿…é¡»åŒ…å«ï¼šç»“è®º + ä¾æ® + â‰¤3æ¡å¤„æ–¹ + æ‰¿è¯ºé‚€è¯·ã€‚
4) æ¯æ¡å¤„æ–¹å¿…é¡»åŒ…å« if_thenï¼šå¦‚æœ____â†’é‚£ä¹ˆ____ã€‚
5) å¿…é¡»ç»™å‡ºå¯ç‚¹å‡» actionsã€‚

ã€ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‘
persona_style: ${context.persona_style}
facts: ${JSON.stringify(context.facts)}
evidence: ${JSON.stringify(context.evidence)}
active_goals: ${JSON.stringify(context.active_goals)}
`;
}
```

#### 2.3 åŒè·¯ç”±å¹¶è¡ŒæœŸ

**ä¿ç•™ Python `/api/chat/send`**ï¼Œæ–°å¢ Next.js `/api/chat`ï¼š

```python
# api/chat_routes.py - æ·»åŠ  header æ£€æµ‹
@router.post("/send")
async def chat_send(request: Request, body: ChatSendRequest, auth = Depends(require_auth)):
    # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ–°æ¶æ„
    use_new_runtime = request.headers.get("X-Use-New-Runtime") == "true"
    if use_new_runtime:
        # è½¬å‘åˆ° Next.js
        return RedirectResponse(url="/api/chat", status_code=307)
    # åŸæœ‰é€»è¾‘...
```

#### 2.4 äº¤ä»˜ç‰©

- [ ] `/api/chat/route.ts` å®Œæ•´å®ç°
- [ ] `buildSystemPrompt()` è¿ç§»
- [ ] åŒè·¯ç”±å¹¶è¡Œé…ç½®
- [ ] å‰ç«¯ `useChat()` é›†æˆæµ‹è¯•

---

### Phase 3: Skills å®ç° (Week 3)

**ç›®æ ‡**: å°† L2 Expert Agents é‡æ„ä¸º Vercel Tools

#### 3.1 Divine Skills

```typescript
// lib/skills/divine-skills.ts
import { tool } from 'ai';
import { z } from 'zod';

const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';

export const divineSkills = {
  calculate_bazi: tool({
    description: 'è®¡ç®—ç”¨æˆ·çš„å…«å­—å‘½ç›˜ï¼Œè¿”å›å››æŸ±ã€äº”è¡Œã€åç¥ã€ç¥ç…ã€å¤§è¿ç­‰ä¿¡æ¯',
    parameters: z.object({
      birth_datetime: z.string().describe('å‡ºç”Ÿæ—¥æœŸæ—¶é—´ (ISO 8601)'),
      timezone: z.string().default('Asia/Shanghai'),
      include_dayun: z.boolean().default(true),
    }),
    execute: async ({ birth_datetime, timezone, include_dayun }) => {
      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),
      });
      if (!res.ok) throw new Error(`Bazi calculation failed: ${res.status}`);
      return res.json();
    },
  }),

  get_bazi_facts: tool({
    description: 'è·å–ç”¨æˆ·å·²è®¡ç®—çš„å…«å­—äº‹å®æ•°æ®',
    parameters: z.object({
      user_id: z.number(),
    }),
    execute: async ({ user_id }) => {
      const res = await fetch(`${FASTAPI_URL}/api/bazi/facts/${user_id}`);
      return res.json();
    },
  }),

  search_bazi_kb: tool({
    description: 'æœç´¢å…«å­—çŸ¥è¯†åº“ï¼Œè·å–ç›¸å…³å‘½ç†è§£è¯»',
    parameters: z.object({
      query: z.string().describe('æœç´¢å…³é”®è¯'),
      limit: z.number().default(3),
    }),
    execute: async ({ query, limit }) => {
      const res = await fetch(`${FASTAPI_URL}/api/kb/search`, {
        method: 'POST',
        body: JSON.stringify({ query, limit, category: 'bazi' }),
      });
      return res.json();
    },
  }),
};
```

#### 3.2 Heal Skills

```typescript
// lib/skills/heal-skills.ts
export const healSkills = {
  log_perma: tool({
    description: 'è®°å½•ç”¨æˆ·çš„ PERMA äº”ç»´å¿ƒç†çŠ¶æ€åˆ†æ•°',
    parameters: z.object({
      dimension: z.enum(['P', 'E', 'R', 'M', 'A']),
      score: z.number().min(0).max(10),
      note: z.string().optional(),
    }),
    execute: async ({ dimension, score, note }, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/perma/log`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, dimension, score, note }),
      });
      return res.json();
    },
  }),

  mood_checkin: tool({
    description: 'å¿«é€Ÿæƒ…ç»ªæ‰“å¡',
    parameters: z.object({
      mood_score: z.number().min(1).max(10),
      tags: z.array(z.string()).optional(),
      note: z.string().optional(),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),

  cbt_reframe: tool({
    description: 'ä½¿ç”¨ CBT ABC æ¨¡å‹è¿›è¡Œè®¤çŸ¥é‡æ„',
    parameters: z.object({
      activating_event: z.string().describe('è§¦å‘äº‹ä»¶ (A)'),
      belief: z.string().optional().describe('ä¿¡å¿µ/æƒ³æ³• (B)'),
      consequence: z.string().optional().describe('æƒ…ç»ª/è¡Œä¸ºåæœ (C)'),
    }),
    execute: async (params) => {
      // CBT å¼•å¯¼æ¡†æ¶ï¼Œè¿”å›ç»“æ„åŒ–æç¤ºè®© LLM ç»§ç»­å¼•å¯¼
      return {
        framework: 'ABC',
        current_state: params,
        next_step: params.belief ? 'identify_distortion' : 'explore_belief',
        guidance_prompt: params.belief
          ? `ç”¨æˆ·çš„ä¿¡å¿µæ˜¯"${params.belief}"ï¼Œè¯·å¸®åŠ©è¯†åˆ«å¯èƒ½çš„è®¤çŸ¥æ‰­æ›²...`
          : `è¯·å¼•å¯¼ç”¨æˆ·æ¢ç´¢è§¦å‘äº‹ä»¶èƒŒåçš„ä¿¡å¿µå’Œæƒ³æ³•...`,
      };
    },
  }),
};
```

#### 3.3 Grow Skills

```typescript
// lib/skills/grow-skills.ts
export const growSkills = {
  create_commitment: tool({
    description: 'åˆ›å»ºè¡ŒåŠ¨æ‰¿è¯ºä»»åŠ¡',
    parameters: z.object({
      content: z.string().describe('ä»»åŠ¡å†…å®¹'),
      category: z.enum(['energy_boost', 'reflection', 'practice', 'social', 'general']),
      estimated_minutes: z.number().default(5),
      if_then: z.string().optional().describe('If-Then è§¦å‘æ¡ä»¶'),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),

  goal_setting: tool({
    description: 'ä½¿ç”¨ WOOP æ¨¡å‹è®¾å®šç›®æ ‡',
    parameters: z.object({
      wish: z.string().describe('æ„¿æœ›/ç›®æ ‡'),
      outcome: z.string().optional(),
      obstacle: z.string().optional(),
      plan: z.string().optional(),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),

  update_twin: tool({
    description: 'æ›´æ–°ç”¨æˆ·æ•°å­—å­ªç”Ÿæ•°æ®',
    parameters: z.object({
      layer: z.enum(['L1', 'L2', 'L3']),
      path: z.string().describe('JSON è·¯å¾„'),
      value: z.any(),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/twin/update`, {
        method: 'PUT',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),
};
```

#### 3.4 Skills Registry ç»Ÿä¸€å¯¼å‡º

```typescript
// lib/skills/index.ts
import { divineSkills } from './divine-skills';
import { healSkills } from './heal-skills';
import { growSkills } from './grow-skills';

export const allSkills = {
  ...divineSkills,
  ...healSkills,
  ...growSkills,
};

export function getToolsForCommand(command: string) {
  switch (command) {
    case '/divine': return divineSkills;
    case '/heal': return healSkills;
    case '/grow': return growSkills;
    default: return allSkills;
  }
}

export { divineSkills, healSkills, growSkills };
```

#### 3.5 äº¤ä»˜ç‰©

- [ ] `divine-skills.ts` å®Œæ•´å®ç°
- [ ] `heal-skills.ts` å®Œæ•´å®ç°
- [ ] `grow-skills.ts` å®Œæ•´å®ç°
- [ ] Skills Registry å•å…ƒæµ‹è¯•

---

### Phase 4: FastAPI æ•°æ®æœåŠ¡é‡æ„ (Week 4)

**ç›®æ ‡**: å°† FastAPI ç²¾ç®€ä¸ºçº¯æ•°æ®æœåŠ¡å±‚

#### 4.1 æ–°å¢æ•°æ®æœåŠ¡ API

```python
# api/data_routes.py (æ–°æ–‡ä»¶)
from fastapi import APIRouter, Depends
from api.deps import require_auth

router = APIRouter(prefix="/api", tags=["data"])

@router.get("/user/context")
async def get_user_context(user_id: int, auth = Depends(require_auth)):
    """èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œä¾› Agent Runtime è°ƒç”¨"""
    # èšåˆ profile + preferences + facts + active_goals + recent_messages
    profile = await _get_profile(user_id)
    prefs = await _get_preferences(user_id)
    facts = await _get_bazi_facts(user_id)
    goals = await _get_active_goals(user_id)
    messages = await _get_recent_messages(user_id, limit=10)

    return {
        "ok": True,
        "data": {
            "profile": profile,
            "persona_style": prefs.get("persona_style", "warm"),
            "facts": facts,
            "evidence": {
                "facts_hash": facts.get("facts_hash"),
                "kb_refs": [],  # åç»­å¡«å……
            },
            "active_goals": goals,
            "recent_messages": messages,
        }
    }

@router.post("/bazi/calculate")
async def calculate_bazi(body: BaziCalculateRequest):
    """å…«å­—è®¡ç®— (æ— éœ€ç™»å½•ï¼Œä¾› Landing Page ä½¿ç”¨)"""
    from services.bazi_engine import calculate_bazi
    result = calculate_bazi(
        body.birth_datetime,
        body.timezone,
        body.include_dayun,
    )
    return {"ok": True, "data": result}

@router.post("/perma/log")
async def log_perma(body: PermaLogRequest, auth = Depends(require_auth)):
    """PERMA çŠ¶æ€è®°å½•"""
    from services.twin_service import update_perma_score
    result = await update_perma_score(
        auth.user_id,
        body.dimension,
        body.score,
        body.note,
    )
    return {"ok": True, "data": result}

@router.post("/tasks/create")
async def create_task(body: TaskCreateRequest, auth = Depends(require_auth)):
    """åˆ›å»ºæ‰¿è¯ºä»»åŠ¡"""
    from services.bento_service import create_commitment
    result = await create_commitment(
        auth.user_id,
        body.content,
        body.category,
        body.estimated_minutes,
        body.if_then,
    )
    return {"ok": True, "data": result}

@router.post("/goals/create")
async def create_goal(body: GoalCreateRequest, auth = Depends(require_auth)):
    """åˆ›å»º WOOP ç›®æ ‡"""
    from services.goal_service import create_goal
    result = await create_goal(auth.user_id, body.dict())
    return {"ok": True, "data": result}

@router.put("/twin/update")
async def update_twin(body: TwinUpdateRequest, auth = Depends(require_auth)):
    """æ›´æ–°æ•°å­—å­ªç”Ÿ"""
    from services.twin_service import update_twin
    result = await update_twin(auth.user_id, body.layer, body.path, body.value)
    return {"ok": True, "data": result}

@router.post("/kb/search")
async def search_kb(body: KBSearchRequest, auth = Depends(require_auth)):
    """çŸ¥è¯†åº“æ£€ç´¢"""
    from services.kb_service import search
    result = await search(body.query, body.limit, body.category)
    return {"ok": True, "data": result}
```

#### 4.2 Landing Page API

```python
# api/landing_routes.py (æ–°æ–‡ä»¶)
from fastapi import APIRouter

router = APIRouter(prefix="/api/landing", tags=["landing"])

ELEMENT_COLORS = {
    "wood": ["#4ade80", "#22c55e"],
    "fire": ["#f87171", "#ef4444"],
    "earth": ["#fbbf24", "#f59e0b"],
    "metal": ["#f5f5f4", "#d6d3d1"],
    "water": ["#60a5fa", "#3b82f6"],
}

ELEMENT_INSIGHTS = {
    "wood": {
        "en": "A strong Wood energy detected. You seek growth, but feel restricted.",
        "cn": "æ£€æµ‹åˆ°å¼ºæœ¨èƒ½é‡ã€‚ä½ æ¸´æœ›ç”Ÿé•¿ï¼Œä½†æ„Ÿåˆ°å—é™ã€‚",
    },
    "fire": {
        "en": "Fire burns bright within you. Passion drives you forward.",
        "cn": "ç«ç„°åœ¨ä½ å¿ƒä¸­ç‡ƒçƒ§ã€‚çƒ­æƒ…é©±åŠ¨ä½ å‰è¿›ã€‚",
    },
    # ... å…¶ä»–äº”è¡Œ
}

@router.post("/insight")
async def instant_insight(body: InsightRequest):
    """å³æ—¶æ´å¯Ÿ (æ— éœ€ç™»å½•)"""
    if body.input_type == "bazi":
        # å¿«é€Ÿè®¡ç®—æ—¥ä¸»äº”è¡Œ
        from services.bazi_engine import quick_day_master
        element = quick_day_master(body.value)
        insight = ELEMENT_INSIGHTS.get(element, ELEMENT_INSIGHTS["wood"])
        return {
            "ok": True,
            "data": {
                "type": "bazi",
                "element": element,
                "insight": insight["en"],
                "insight_cn": insight["cn"],
                "orb_colors": ELEMENT_COLORS.get(element),
                "cta": "Unlock Full Analysis â†’",
            }
        }
    elif body.input_type == "emotion":
        # è°ƒç”¨ LLM ç”Ÿæˆç®€çŸ­æƒ…ç»ªæ´å¯Ÿ
        from services.glm_client import quick_emotion_insight
        insight = await quick_emotion_insight(body.value)
        return {
            "ok": True,
            "data": {
                "type": "emotion",
                "insight": insight,
                "orb_colors": ["#a78bfa", "#8b5cf6"],  # ç´«è‰²
                "cta": "Start Your Journey â†’",
            }
        }
```

#### 4.3 åˆ é™¤/åºŸå¼ƒçš„ä»£ç 

```python
# å¾…åˆ é™¤æ–‡ä»¶
services/glm_client.py          # LLM è°ƒç”¨è¿ç§»åˆ° TypeScript
services/agent_service_client.py # ä¸å†éœ€è¦

# å¾…åºŸå¼ƒç«¯ç‚¹ (chat_routes.py)
# POST /api/chat/send  â†’ è¿ç§»åˆ° Next.js /api/chat
# GET  /api/chat/stream â†’ è¿ç§»åˆ° Next.js /api/chat
```

#### 4.4 äº¤ä»˜ç‰©

- [ ] `api/data_routes.py` å®Œæ•´å®ç°
- [ ] `api/landing_routes.py` å®Œæ•´å®ç°
- [ ] æ—§ chat ç«¯ç‚¹åºŸå¼ƒæ ‡è®°
- [ ] API æ–‡æ¡£æ›´æ–°

---

### Phase 5: å‰ç«¯é€‚é… (Week 5)

**ç›®æ ‡**: å‰ç«¯åˆ‡æ¢åˆ° `useChat()` Hook

#### 5.1 useChat é›†æˆ

```typescript
// components/chat/chat-panel.tsx
'use client';

import { useChat } from 'ai/react';
import { useState } from 'react';

export function ChatPanel({ userId }: { userId: number }) {
  const [command, setCommand] = useState<string | null>(null);

  const { messages, input, setInput, handleSubmit, isLoading, error } = useChat({
    api: '/api/chat',
    body: { userId, command },
    onFinish: (message) => {
      setCommand(null);
      // å¤„ç† Tool è°ƒç”¨ç»“æœ
      if (message.toolInvocations?.length) {
        refreshDashboard(message.toolInvocations);
      }
    },
  });

  const handleCommandSubmit = (cmd: string, text: string) => {
    setCommand(cmd);
    setInput(text);
    // useChat ä¼šè‡ªåŠ¨æäº¤
  };

  return (
    <div className="flex flex-col h-full">
      {/* Messages */}
      <div className="flex-1 overflow-y-auto">
        {messages.map((m) => (
          <MessageBubble key={m.id} message={m} />
        ))}
      </div>

      {/* Input */}
      <ChatInput
        value={input}
        onChange={setInput}
        onSubmit={handleSubmit}
        onCommand={handleCommandSubmit}
        isLoading={isLoading}
      />
    </div>
  );
}
```

#### 5.2 CommandPalette é›†æˆ

```typescript
// components/chat/command-palette.tsx
const COMMANDS = [
  { cmd: '/divine', label: 'ç„å­¦æµ‹ç®—', icon: 'ğŸ”®' },
  { cmd: '/heal', label: 'å¿ƒç†ç–—æ„ˆ', icon: 'ğŸ’š' },
  { cmd: '/grow', label: 'æˆé•¿æ•™ç»ƒ', icon: 'ğŸŒ±' },
  { cmd: '/status', label: 'çŠ¶æ€æŸ¥çœ‹', icon: 'ğŸ“Š' },
];

export function CommandPalette({ onSelect, visible }: CommandPaletteProps) {
  if (!visible) return null;

  return (
    <div className="absolute bottom-full left-0 w-full bg-background border rounded-lg shadow-lg p-2">
      {COMMANDS.map((c) => (
        <button
          key={c.cmd}
          onClick={() => onSelect(c.cmd)}
          className="flex items-center gap-2 w-full p-2 hover:bg-accent rounded"
        >
          <span>{c.icon}</span>
          <span className="font-medium">{c.cmd}</span>
          <span className="text-muted-foreground">{c.label}</span>
        </button>
      ))}
    </div>
  );
}
```

#### 5.3 Tool Result æ¸²æŸ“

```typescript
// components/chat/tool-result-card.tsx
export function ToolResultCard({ invocation }: { invocation: ToolInvocation }) {
  const { toolName, result, state } = invocation;

  if (state === 'partial-call') {
    return <LoadingCard toolName={toolName} />;
  }

  switch (toolName) {
    case 'calculate_bazi':
      return <BaziResultCard data={result} />;
    case 'mood_checkin':
      return <MoodCheckinCard data={result} />;
    case 'create_commitment':
      return <CommitmentCard data={result} />;
    default:
      return <GenericResultCard data={result} />;
  }
}
```

#### 5.4 äº¤ä»˜ç‰©

- [ ] `useChat()` é›†æˆ
- [ ] `CommandPalette` ç»„ä»¶
- [ ] `ToolResultCard` ç»„ä»¶
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

### Phase 6: æ¸…ç†ä¸ä¼˜åŒ– (Week 6)

**ç›®æ ‡**: åˆ é™¤æ—§ä»£ç ï¼Œæ€§èƒ½ä¼˜åŒ–

#### 6.1 åˆ é™¤åˆ—è¡¨

```bash
# åˆ é™¤æ–‡ä»¶
rm services/glm_client.py
rm services/agent_service_client.py

# åˆ é™¤ agent_service ç›®å½• (å·²è¿ç§»åˆ° Next.js)
rm -rf agent_service/

# æ¸…ç† chat_routes.py ä¸­çš„æ—§ç«¯ç‚¹
# - /api/chat/send
# - /api/chat/stream
```

#### 6.2 API è·¯ç”±æ¸…ç†

```python
# api/main.py - æ›´æ–°è·¯ç”±æ³¨å†Œ
app.include_router(auth_routes.router)
app.include_router(data_routes.router)      # æ–°å¢
app.include_router(landing_routes.router)   # æ–°å¢
app.include_router(dashboard_routes.router)
app.include_router(report_routes.router)
# åˆ é™¤: app.include_router(chat_routes.router)
```

#### 6.3 æ€§èƒ½ä¼˜åŒ–

1. **Context ç¼“å­˜**: ç”¨æˆ·ä¸Šä¸‹æ–‡ Redis ç¼“å­˜ (TTL 5min)
2. **æ‰¹é‡ Tool è°ƒç”¨**: åˆå¹¶å¤šä¸ª fetch è¯·æ±‚
3. **æµå¼é¦–å­—ä¼˜åŒ–**: å‡å°‘ System Prompt é•¿åº¦

#### 6.4 ç›‘æ§ä¸æ—¥å¿—

```typescript
// æ·»åŠ  Tool è°ƒç”¨ç›‘æ§
const result = streamText({
  // ...
  onStepFinish({ stepType, toolCalls, toolResults }) {
    // è®°å½• Tool è°ƒç”¨è€—æ—¶
    logger.info('Step finished', {
      stepType,
      toolCount: toolCalls?.length,
      latency: Date.now() - startTime,
    });
  },
});
```

#### 6.5 äº¤ä»˜ç‰©

- [ ] æ—§æ–‡ä»¶åˆ é™¤
- [ ] API è·¯ç”±æ›´æ–°
- [ ] Redis ç¼“å­˜é…ç½®
- [ ] ç›‘æ§ Dashboard

---

## 4. é£é™©ä¸ç¼“è§£

### 4.1 å…¼å®¹æ€§é£é™©

| é£é™©ç‚¹ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
|--------|----------|----------|
| API ç­¾åå˜æ›´ | å‰ç«¯æ‰€æœ‰ Chat è°ƒç”¨ | åŒè·¯ç”±å¹¶è¡Œï¼ŒFeature Flag æ§åˆ¶ |
| A2UI æ ¼å¼å˜åŒ– | æ¶ˆæ¯æ¸²æŸ“ç»„ä»¶ | ä¿æŒ JSON ç»“æ„å…¼å®¹ï¼Œä»…æ”¹ä¼ è¾“æ–¹å¼ |
| CSRF å¤„ç† | æ‰€æœ‰ POST è¯·æ±‚ | Next.js API Route åŒæºï¼Œæ— éœ€ CSRF |
| Cookie ä¼ é€’ | è®¤è¯æµç¨‹ | `credentials: 'include'` é…ç½® |

### 4.2 å›æ»šæ–¹æ¡ˆ

```typescript
// Feature Flag æ§åˆ¶
const USE_NEW_RUNTIME = process.env.USE_NEW_RUNTIME === 'true';

// å‰ç«¯è·¯ç”±é€‰æ‹©
const chatEndpoint = USE_NEW_RUNTIME ? '/api/chat' : '/api/chat/send';
```

### 4.3 ç°åº¦å‘å¸ƒ

1. **Week 1-4**: å†…éƒ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
2. **Week 5**: 10% ç”¨æˆ·ç°åº¦
3. **Week 6**: 50% ç”¨æˆ·ç°åº¦
4. **Week 7**: å…¨é‡å‘å¸ƒ

---

## 5. éªŒæ”¶æ ‡å‡†

### 5.1 åŠŸèƒ½éªŒæ”¶

| åŠŸèƒ½ | éªŒæ”¶æ ‡å‡† |
|------|----------|
| Chat å¯¹è¯ | æµå¼è¾“å‡ºæ­£å¸¸ï¼Œé¦–å­— < 500ms |
| `/divine` æŒ‡ä»¤ | å…«å­—è®¡ç®—æ­£ç¡®ï¼Œç»“æœæ¸²æŸ“æ­£å¸¸ |
| `/heal` æŒ‡ä»¤ | PERMA è®°å½•æˆåŠŸï¼ŒCBT å¼•å¯¼å®Œæ•´ |
| `/grow` æŒ‡ä»¤ | ç›®æ ‡/ä»»åŠ¡åˆ›å»ºæˆåŠŸ |
| Landing Page | Insight ç”Ÿæˆ < 1sï¼ŒOrb é¢œè‰²æ­£ç¡® |
| Tool Calling | å¤šæ­¥æ¨ç† (maxSteps=5) æ­£å¸¸ |

### 5.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ |
|------|--------|--------|
| é¦–å­—å»¶è¿Ÿ (P50) | < 500ms | ~800ms |
| é¦–å­—å»¶è¿Ÿ (P95) | < 1.5s | ~2s |
| Tool è°ƒç”¨å»¶è¿Ÿ | < 200ms | N/A |
| ç«¯åˆ°ç«¯å“åº” (P50) | < 3s | ~4s |

### 5.3 ä»£ç è´¨é‡

- [ ] TypeScript ä¸¥æ ¼æ¨¡å¼
- [ ] Zod Schema 100% è¦†ç›–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] E2E æµ‹è¯•é€šè¿‡

---

## 6. é™„å½•

### 6.1 ç¯å¢ƒå˜é‡

```bash
# .env.local (Next.js)
FASTAPI_URL=http://localhost:8230
GOOGLE_API_KEY=xxx
ANTHROPIC_API_KEY=xxx
GLM_API_KEY=xxx
USE_NEW_RUNTIME=true
```

### 6.2 ä¾èµ–æ›´æ–°

```json
// package.json
{
  "dependencies": {
    "ai": "^4.0.0",
    "@ai-sdk/google": "^1.0.0",
    "@ai-sdk/anthropic": "^1.0.0",
    "zod": "^3.22.0"
  }
}
```

### 6.3 å‚è€ƒæ–‡æ¡£

- [Vercel AI SDK æ–‡æ¡£](https://sdk.vercel.ai/docs)
- [os_design_v3.md Â§1.4-1.5](./os_design_v3.md)
- [frontend_final_v3.md Â§2.6](./frontend_final_v3.md)
- [system_design_final_mvp_v3.md Â§7.0.1](./system_design_final_mvp_v3.md)
- [admin_v3.md](./admin_v3.md) - Admin System è®¾è®¡ï¼Œå¯ä¸æœ¬é‡æ„å¹¶è¡Œå¼€å‘

### 6.4 å¹¶è¡Œå¼€å‘é¡¹

| é¡¹ç›® | æè¿° | æŠ€æœ¯æ ˆ | ä¾èµ–å…³ç³» |
|------|------|--------|----------|
| **Admin System** | åå°ç®¡ç†é©¾é©¶èˆ± | Next.js App Router + shadcn/ui + Monaco | Phase 1 å®Œæˆåå¯å¯åŠ¨ |
| **Landing Page** | Digital Mirror é¦–é¡µ | Next.js + React Three Fiber | ç‹¬ç«‹å¼€å‘ |

> **æ³¨**: Admin System çš„ Agent Studio æ¨¡å—ä¾èµ–æœ¬é‡æ„ä¸­çš„ `admin_prompts` è¡¨å’Œ Prompt çƒ­åŠ è½½æœºåˆ¶ï¼ˆPhase 4ï¼‰ï¼Œå»ºè®®åœ¨ Phase 4 å®Œæˆåè¿›è¡Œ Admin å‰ç«¯å¼€å‘ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*åˆ›å»ºæ—¥æœŸ: 2026-01-01*
*ä½œè€…: Claude (Anthropic)*
