/**
 * Heal Skills (疗愈技能)
 *
 * Tools for psychological wellbeing: PERMA tracking, mood check-in, CBT reframing.
 */
import { tool } from 'ai';
import { z } from 'zod';

const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';

// Mood check-in tool
export const moodCheckin = tool({
  description: '记录用户当前的情绪状态。当用户分享心情、表达情绪、或需要情绪记录时使用。',
  parameters: z.object({
    mood: z.enum(['great', 'good', 'okay', 'down', 'bad']).describe('情绪等级'),
    note: z.string().optional().describe('情绪备注'),
    triggers: z.array(z.string()).optional().describe('情绪触发因素'),
  }),
  execute: async ({ mood, note, triggers }) => {
    const moodScores: Record<string, number> = {
      great: 90,
      good: 75,
      okay: 50,
      down: 30,
      bad: 15,
    };

    const moodLabels: Record<string, string> = {
      great: '非常好',
      good: '不错',
      okay: '一般',
      down: '低落',
      bad: '很差',
    };

    // Note: In a real implementation, this would call the FastAPI backend
    // to persist the mood record. For now, we return a card indicating success.

    return {
      type: 'a2ui_card' as const,
      card_type: 'mood_logged',
      data: {
        timestamp: new Date().toISOString(),
        mood,
        mood_label: moodLabels[mood],
        score: moodScores[mood],
        note: note || '',
        triggers: triggers || [],
      },
      actions: [
        {
          label: '查看情绪趋势',
          action: 'navigate',
          params: { path: '/dashboard/mood' },
        },
      ],
    };
  },
});

// PERMA dimension logging tool
export const logPerma = tool({
  description: '记录用户的 PERMA 幸福五维度得分。用于定期的幸福感评估。',
  parameters: z.object({
    P: z.number().min(1).max(10).describe('积极情绪 (Positive Emotions) 1-10'),
    E: z.number().min(1).max(10).describe('投入感 (Engagement) 1-10'),
    R: z.number().min(1).max(10).describe('人际关系 (Relationships) 1-10'),
    M: z.number().min(1).max(10).describe('意义感 (Meaning) 1-10'),
    A: z.number().min(1).max(10).describe('成就感 (Accomplishment) 1-10'),
    context: z.string().optional().describe('评估背景或备注'),
  }),
  execute: async ({ P, E, R, M, A, context }) => {
    const overall = Math.round((P + E + R + M + A) / 5 * 10);

    // Note: In production, this would persist to FastAPI backend

    return {
      type: 'a2ui_card' as const,
      card_type: 'perma_checkin',
      data: {
        timestamp: new Date().toISOString(),
        dimensions: { P, E, R, M, A },
        overall_score: overall,
        context: context || '',
      },
      actions: [
        {
          label: '查看 PERMA 趋势',
          action: 'navigate',
          params: { path: '/dashboard/perma' },
        },
      ],
    };
  },
});

// CBT reframing tool
export const cbtReframe = tool({
  description: '使用认知行为疗法帮助用户重构负面想法。当用户表达消极想法或自我批评时使用。',
  parameters: z.object({
    negative_thought: z.string().describe('用户的负面想法'),
    situation: z.string().optional().describe('引发想法的情境'),
  }),
  execute: async ({ negative_thought, situation }) => {
    // This would typically call an AI model or use predefined CBT patterns
    // For now, return a structured response with CBT framework

    return {
      type: 'a2ui_card' as const,
      card_type: 'cbt_reframe',
      data: {
        original_thought: negative_thought,
        situation: situation || '未指定',
        cognitive_distortions: [
          '可能存在的认知偏差需要进一步分析',
        ],
        reframed_thoughts: [
          '让我们一起来看看这个想法是否完全准确...',
          '有没有其他可能的解释？',
          '如果朋友遇到同样的情况，你会怎么看？',
        ],
        action_steps: [
          '记录这个想法和你的感受',
          '寻找支持或反驳这个想法的证据',
          '尝试用更平衡的方式重新表述',
        ],
      },
      actions: [
        {
          label: '记录到日记',
          action: 'api_call',
          params: { endpoint: '/api/reflection/save' },
        },
      ],
    };
  },
});

// Gratitude logging tool
export const logGratitude = tool({
  description: '记录用户的感恩日记。当用户分享感恩的事物或进行感恩练习时使用。',
  parameters: z.object({
    items: z.array(z.string()).min(1).max(5).describe('感恩的事项（1-5项）'),
    category: z.enum(['people', 'experiences', 'things', 'self', 'other'])
      .optional()
      .describe('感恩类别'),
  }),
  execute: async ({ items, category }) => {
    return {
      type: 'a2ui_card' as const,
      card_type: 'gratitude_logged',
      data: {
        timestamp: new Date().toISOString(),
        items,
        category: category || 'other',
        count: items.length,
      },
      actions: [
        {
          label: '查看感恩历史',
          action: 'navigate',
          params: { path: '/dashboard/gratitude' },
        },
      ],
    };
  },
});

// Export all heal skills
export const healSkills = {
  mood_checkin: moodCheckin,
  log_perma: logPerma,
  cbt_reframe: cbtReframe,
  log_gratitude: logGratitude,
};
