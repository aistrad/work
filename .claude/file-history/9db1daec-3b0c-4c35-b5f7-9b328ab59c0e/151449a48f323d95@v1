#!/usr/bin/env python3
"""
Run Migration 025: Create usage_events table

This migration creates the unified usage tracking table with support for:
- LLM call tracking with token counts and cost estimation
- Skill usage tracking
- Tool call tracking
- Conversation tracking

Usage:
    python apps/api/scripts/run_migration_025.py
"""

import asyncio
import sys
from pathlib import Path

# Add apps/api to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_db_pool, get_db_url
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)


async def run_migration():
    """Execute migration 025"""

    logger.info("=" * 70)
    logger.info("VibeLife Migration 025: Create usage_events table")
    logger.info("=" * 70)

    # Check database connection
    try:
        db_url = get_db_url()
        logger.info(f"Database URL: {db_url.split('@')[1] if '@' in db_url else 'localhost'}")
    except Exception as e:
        logger.error(f"Failed to get database URL: {e}")
        logger.error("Please set VIBELIFE_DB_URL environment variable")
        return False

    # Get database pool
    try:
        pool = await get_db_pool()
        logger.info("✓ Database connection established")
    except Exception as e:
        logger.error(f"✗ Failed to connect to database: {e}")
        return False

    # Check if table already exists
    try:
        exists = await pool.fetchval("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables
                WHERE table_schema = 'public'
                AND table_name = 'usage_events'
            )
        """)

        if exists:
            logger.warning("⚠ usage_events table already exists")
            response = input("Do you want to drop and recreate it? (yes/no): ")
            if response.lower() != 'yes':
                logger.info("Migration cancelled")
                return False
            logger.info("Dropping existing table...")
    except Exception as e:
        logger.error(f"✗ Failed to check table existence: {e}")
        return False

    # Read migration SQL
    migration_file = Path(__file__).parent.parent / "stores" / "migrations" / "025_create_usage_events.sql"

    if not migration_file.exists():
        logger.error(f"✗ Migration file not found: {migration_file}")
        return False

    logger.info(f"Reading migration from: {migration_file}")

    try:
        with open(migration_file, 'r', encoding='utf-8') as f:
            migration_sql = f.read()
    except Exception as e:
        logger.error(f"✗ Failed to read migration file: {e}")
        return False

    # Execute migration
    logger.info("Executing migration SQL...")

    try:
        async with pool.acquire() as conn:
            async with conn.transaction():
                # Execute the migration
                await conn.execute(migration_sql)

        logger.info("✓ Migration SQL executed successfully")
    except Exception as e:
        logger.error(f"✗ Migration failed: {e}")
        import traceback
        traceback.print_exc()
        return False

    # Verify table creation
    try:
        # Check table exists
        exists = await pool.fetchval("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables
                WHERE table_schema = 'public'
                AND table_name = 'usage_events'
            )
        """)

        if not exists:
            logger.error("✗ Table verification failed: usage_events not found")
            return False

        logger.info("✓ Table creation verified")

        # Get column count
        columns = await pool.fetch("""
            SELECT column_name, data_type, is_nullable
            FROM information_schema.columns
            WHERE table_name = 'usage_events'
            ORDER BY ordinal_position
        """)

        logger.info(f"✓ Table structure verified: {len(columns)} columns")

        # Display table structure
        logger.info("\nTable structure:")
        logger.info("-" * 70)
        for col in columns:
            nullable = "NULL" if col['is_nullable'] == 'YES' else "NOT NULL"
            logger.info(f"  {col['column_name']:20s} {col['data_type']:20s} {nullable}")
        logger.info("-" * 70)

        # Get index count
        indexes = await pool.fetch("""
            SELECT indexname
            FROM pg_indexes
            WHERE tablename = 'usage_events'
        """)

        logger.info(f"✓ Indexes created: {len(indexes)}")
        for idx in indexes:
            logger.info(f"  - {idx['indexname']}")

    except Exception as e:
        logger.error(f"✗ Table verification failed: {e}")
        return False

    # Success
    logger.info("=" * 70)
    logger.info("✓ Migration 025 completed successfully!")
    logger.info("=" * 70)
    logger.info("\nNext steps:")
    logger.info("  1. Verify UsageService functionality")
    logger.info("  2. Run tests: pytest tests/unit/services/test_usage_service.py")
    logger.info("  3. Update application code to use UsageService")

    return True


async def verify_migration():
    """Verify migration without running it"""

    logger.info("Verifying migration 025...")

    try:
        pool = await get_db_pool()

        # Check if table exists
        exists = await pool.fetchval("""
            SELECT EXISTS (
                SELECT FROM information_schema.tables
                WHERE table_schema = 'public'
                AND table_name = 'usage_events'
            )
        """)

        if exists:
            logger.info("✓ usage_events table exists")

            # Get row count
            count = await pool.fetchval("SELECT COUNT(*) FROM usage_events")
            logger.info(f"✓ Table contains {count} records")

            return True
        else:
            logger.warning("✗ usage_events table does not exist")
            logger.info("Run migration with: python apps/api/scripts/run_migration_025.py")
            return False

    except Exception as e:
        logger.error(f"✗ Verification failed: {e}")
        return False


async def rollback_migration():
    """Rollback migration 025 (drop table)"""

    logger.warning("=" * 70)
    logger.warning("ROLLBACK Migration 025: Drop usage_events table")
    logger.warning("=" * 70)
    logger.warning("This will DELETE ALL usage tracking data!")

    response = input("Are you sure you want to rollback? (yes/no): ")
    if response.lower() != 'yes':
        logger.info("Rollback cancelled")
        return False

    try:
        pool = await get_db_pool()

        await pool.execute("DROP TABLE IF EXISTS usage_events CASCADE")

        logger.info("✓ usage_events table dropped")
        logger.info("✓ Rollback completed")

        return True

    except Exception as e:
        logger.error(f"✗ Rollback failed: {e}")
        return False


async def main():
    """Main entry point"""

    import argparse

    parser = argparse.ArgumentParser(description='Run migration 025: Create usage_events table')
    parser.add_argument('--verify', action='store_true', help='Verify migration without running')
    parser.add_argument('--rollback', action='store_true', help='Rollback migration (drop table)')

    args = parser.parse_args()

    if args.verify:
        success = await verify_migration()
    elif args.rollback:
        success = await rollback_migration()
    else:
        success = await run_migration()

    sys.exit(0 if success else 1)


if __name__ == "__main__":
    asyncio.run(main())
