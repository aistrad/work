-- ═══════════════════════════════════════════════════════════════
-- VibeLife Migration 025: Create usage_events table
-- ═══════════════════════════════════════════════════════════════
-- Purpose: Unified usage tracking with billing support
-- Author: VibeLife Backend Team
-- Date: 2026-01-22
-- Dependencies: vibe_users table
-- ═══════════════════════════════════════════════════════════════

-- Drop table if exists (for re-running migration in dev)
DROP TABLE IF EXISTS usage_events CASCADE;

-- Create usage_events table
CREATE TABLE usage_events (
    -- Primary key
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- User reference
    user_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,

    -- Event classification
    event_type VARCHAR(50) NOT NULL,
    -- Supported types:
    --   'llm_call'      - LLM API call with token/cost tracking
    --   'skill_use'     - Skill activation/usage
    --   'tool_call'     - Tool execution within a skill
    --   'conversation'  - Conversation/session start

    -- LLM-specific fields (used when event_type = 'llm_call')
    model VARCHAR(100),              -- Model identifier (e.g., 'gpt-4o', 'glm-4-flash')
    input_tokens INTEGER DEFAULT 0,  -- Input tokens consumed
    output_tokens INTEGER DEFAULT 0, -- Output tokens generated
    estimated_cost DECIMAL(10, 6) DEFAULT 0,  -- Estimated cost in USD

    -- Contextual relations
    skill_id VARCHAR(50),            -- Associated skill (e.g., 'bazi', 'zodiac')
    tool_name VARCHAR(100),          -- Tool name (for tool_call events)
    conversation_id UUID,            -- Associated conversation

    -- Flexible metadata storage
    metadata JSONB DEFAULT '{}',     -- Additional event-specific data
    -- Example metadata:
    --   {"request_id": "...", "model_version": "...", "response_time_ms": 1234}

    -- Timestamp
    created_at TIMESTAMPTZ DEFAULT now() NOT NULL
);

-- ═══════════════════════════════════════════════════════════════
-- Indexes for query performance
-- ═══════════════════════════════════════════════════════════════

-- Most common query: user's usage over time
CREATE INDEX idx_usage_events_user_time
    ON usage_events(user_id, created_at DESC);

-- Filter by event type
CREATE INDEX idx_usage_events_type
    ON usage_events(event_type);

-- Filter by skill (exclude NULL values to save space)
CREATE INDEX idx_usage_events_skill
    ON usage_events(skill_id)
    WHERE skill_id IS NOT NULL;

-- Filter by conversation
CREATE INDEX idx_usage_events_conversation
    ON usage_events(conversation_id)
    WHERE conversation_id IS NOT NULL;

-- Filter by model (for billing analysis)
CREATE INDEX idx_usage_events_model
    ON usage_events(model)
    WHERE model IS NOT NULL;

-- Composite index for monthly aggregations (common query pattern)
CREATE INDEX idx_usage_events_user_month
    ON usage_events(user_id, date_trunc('month', created_at));

-- ═══════════════════════════════════════════════════════════════
-- Comments for documentation
-- ═══════════════════════════════════════════════════════════════

COMMENT ON TABLE usage_events IS
    'Unified usage tracking table supporting LLM calls, skill usage, tool calls, and conversations with cost estimation';

COMMENT ON COLUMN usage_events.event_type IS
    'Event type: llm_call | skill_use | tool_call | conversation';

COMMENT ON COLUMN usage_events.estimated_cost IS
    'Estimated cost in USD based on model pricing at time of event';

COMMENT ON COLUMN usage_events.metadata IS
    'JSONB field for flexible event-specific data (request IDs, versions, etc.)';

-- ═══════════════════════════════════════════════════════════════
-- Grant permissions (adjust as needed)
-- ═══════════════════════════════════════════════════════════════

-- Grant read/write to application user (if using separate DB user)
-- GRANT SELECT, INSERT ON usage_events TO vibelife_app;

-- ═══════════════════════════════════════════════════════════════
-- Optional: Table partitioning for high-volume data
-- ═══════════════════════════════════════════════════════════════
-- Uncomment below to enable monthly partitioning (for production scale)
--
-- -- Convert to partitioned table
-- ALTER TABLE usage_events
--     RENAME TO usage_events_template;
--
-- CREATE TABLE usage_events (LIKE usage_events_template INCLUDING ALL)
--     PARTITION BY RANGE (created_at);
--
-- -- Create partitions for current and future months
-- CREATE TABLE usage_events_2026_01 PARTITION OF usage_events
--     FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
--
-- CREATE TABLE usage_events_2026_02 PARTITION OF usage_events
--     FOR VALUES FROM ('2026-02-01') TO ('2026-03-01');
--
-- -- Migrate data from template
-- INSERT INTO usage_events SELECT * FROM usage_events_template;
-- DROP TABLE usage_events_template;

-- ═══════════════════════════════════════════════════════════════
-- Migration complete
-- ═══════════════════════════════════════════════════════════════

-- Verify table creation
DO $$
BEGIN
    IF EXISTS (
        SELECT FROM information_schema.tables
        WHERE table_schema = 'public'
        AND table_name = 'usage_events'
    ) THEN
        RAISE NOTICE 'Migration 025: usage_events table created successfully';
    ELSE
        RAISE EXCEPTION 'Migration 025: Failed to create usage_events table';
    END IF;
END $$;
