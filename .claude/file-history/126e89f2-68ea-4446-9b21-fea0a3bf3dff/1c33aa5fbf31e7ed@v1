'use client'

/**
 * Loading Step - Stage 2
 *
 * æ™ºèƒ½åŠ è½½ï¼šè®¡ç®—æ­¥éª¤å±•ç¤º + å‘½ç›˜æ¸è¿›ç»˜åˆ¶ + ä»˜è´¹åŠŸèƒ½é¢„è§ˆ
 * è®¾è®¡è¦ç‚¹ï¼šå±•ç¤ºçœŸå®è®¡ç®—è¿‡ç¨‹ + é¢„è§ˆä»˜è´¹ä½“éªŒï¼Œ5-8ç§’
 */

import { useState, useEffect, useCallback } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Check, Loader2, TrendingUp, Image, Users } from 'lucide-react'
import { useOnboarding } from '../context'
import { CALCULATION_STEPS, type CalculationStep, type BaziData } from '../types'

// å¤©å¹²åœ°æ”¯æ•°æ®
const STEMS = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸']
const BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥']
const ELEMENTS = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' }
const ELEMENT_INSIGHTS: Record<string, { metaphor: string; trait: string }> = {
  'ç”²': { metaphor: 'ä¸€æ£µå‚å¤©å¤§æ ‘', trait: 'å‘ä¸Šç”Ÿé•¿æ˜¯ä½ çš„æœ¬èƒ½' },
  'ä¹™': { metaphor: 'ä¸€æ ªæŸ”éŸ§çš„è—¤è”“', trait: 'é€‚åº”ç¯å¢ƒæ˜¯ä½ çš„å¤©èµ‹' },
  'ä¸™': { metaphor: 'ä¸€è½®ç¿çƒ‚çš„å¤ªé˜³', trait: 'ç…§äº®ä»–äººæ˜¯ä½ çš„ä½¿å‘½' },
  'ä¸': { metaphor: 'ä¸€ç›æ¸©æš–çš„çƒ›ç«', trait: 'æ¸©æš–äººå¿ƒæ˜¯ä½ çš„æœ¬æ€§' },
  'æˆŠ': { metaphor: 'ä¸€åº§å·å³¨çš„é«˜å±±', trait: 'ç¨³é‡å¯é æ˜¯ä½ çš„ç‰¹è´¨' },
  'å·±': { metaphor: 'ä¸€ç‰‡è‚¥æ²ƒçš„ç”°é‡', trait: 'æ»‹å…»ä¸‡ç‰©æ˜¯ä½ çš„æœ¬èƒ½' },
  'åºš': { metaphor: 'ä¸€æŠŠé”‹åˆ©çš„å®å‰‘', trait: 'æœæ–­å†³ç»æ˜¯ä½ çš„é£æ ¼' },
  'è¾›': { metaphor: 'ä¸€ä»¶ç²¾ç¾çš„ç å®', trait: 'è¿½æ±‚å®Œç¾æ˜¯ä½ çš„æ‰§å¿µ' },
  'å£¬': { metaphor: 'ä¸€ç‰‡æµ©ç€šçš„å¤§æµ·', trait: 'åŒ…å®¹ä¸€åˆ‡æ˜¯ä½ çš„èƒ¸æ€€' },
  'ç™¸': { metaphor: 'ä¸€æ»´æ¸…æ¾ˆçš„é›¨éœ²', trait: 'æ¶¦ç‰©æ— å£°æ˜¯ä½ çš„æ–¹å¼' },
}

// ä»˜è´¹åŠŸèƒ½é¢„è§ˆ
const PREMIUM_FEATURES = [
  { icon: TrendingUp, title: 'äººç”Ÿ K çº¿', desc: 'çœ‹è§è¿‡å»ä¸æœªæ¥' },
  { icon: Image, title: 'AI ç”Ÿå›¾', desc: 'ä¸“å±å‘½ç›˜è‰ºæœ¯å“' },
  { icon: Users, title: 'å…³ç³»åˆ†æ', desc: 'äº†è§£ä½ ä»¬çš„ç¼˜åˆ†' },
]

export default function LoadingStep() {
  const { state, setBaziData, nextStep } = useOnboarding()
  const { birthInfo } = state

  // Steps progress
  const [steps, setSteps] = useState<CalculationStep[]>(
    CALCULATION_STEPS.map(s => ({ ...s, status: 'pending' }))
  )
  const [currentStepIndex, setCurrentStepIndex] = useState(0)

  // Bazi drawing animation
  const [visiblePillars, setVisiblePillars] = useState<number>(0)
  const [baziResult, setBaziResult] = useState<BaziData | null>(null)

  // Calculate Bazi (ç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…åº”è°ƒç”¨åç«¯ API)
  const calculateBazi = useCallback(() => {
    if (!birthInfo) return null

    const { year, month, day, hour } = birthInfo

    // ç®€åŒ–è®¡ç®— - å®é™…åº”è¯¥è°ƒç”¨åç«¯ API
    const yearIdx = (year - 4) % 60
    const yearStemIdx = yearIdx % 10
    const yearBranchIdx = yearIdx % 12

    // æœˆæŸ±ç®€åŒ–è®¡ç®—
    const monthStemIdx = (yearStemIdx * 2 + month) % 10
    const monthBranchIdx = (month + 1) % 12

    // æ—¥æŸ±ç®€åŒ–è®¡ç®—ï¼ˆéœ€è¦å®é™…ç®—æ³•ï¼‰
    const dayStemIdx = Math.floor((year * 365 + month * 30 + day) / 1) % 10
    const dayBranchIdx = Math.floor((year * 365 + month * 30 + day) / 1) % 12

    // æ—¶æŸ±
    let hourPillar = null
    if (hour !== null) {
      const hourStemIdx = (dayStemIdx * 2 + Math.floor(hour / 2)) % 10
      const hourBranchIdx = Math.floor((hour + 1) / 2) % 12
      hourPillar = {
        stem: STEMS[hourStemIdx],
        branch: BRANCHES[hourBranchIdx],
      }
    }

    const dayMaster = STEMS[dayStemIdx]
    const dayMasterElement = ELEMENTS[dayMaster as keyof typeof ELEMENTS]
    const insight = ELEMENT_INSIGHTS[dayMaster]

    return {
      yearPillar: { stem: STEMS[yearStemIdx], branch: BRANCHES[yearBranchIdx] },
      monthPillar: { stem: STEMS[monthStemIdx], branch: BRANCHES[monthBranchIdx] },
      dayPillar: { stem: dayMaster, branch: BRANCHES[dayBranchIdx] },
      hourPillar,
      dayMaster,
      dayMasterElement,
      insight: `ä½ çš„å†…å¿ƒä½ç€${insight.metaphor}ï¼Œ\n${insight.trait}ã€‚`,
      fortune: {
        score: 3 + Math.floor(Math.random() * 2), // 3-4 stars
        luckyColor: ['ç»¿è‰²', 'çº¢è‰²', 'é‡‘è‰²', 'è“è‰²', 'é»„è‰²'][Math.floor(Math.random() * 5)],
        luckyNumber: Math.floor(Math.random() * 9) + 1,
        advice: 'ä»Šå¤©é€‚åˆä¸»åŠ¨å‡ºå‡»ï¼ŒæŠŠæ¡æœºä¼šã€‚',
      },
    }
  }, [birthInfo])

  // Progress animation
  useEffect(() => {
    const stepDurations = [800, 1000, 1200, 1000, 1500] // æ¯æ­¥è€—æ—¶

    const runStep = async (index: number) => {
      if (index >= CALCULATION_STEPS.length) {
        // All done, calculate and proceed
        const result = calculateBazi()
        if (result) {
          setBaziResult(result)
          setBaziData(result)
        }
        // Small delay before transitioning
        setTimeout(() => nextStep(), 500)
        return
      }

      // Set current step to loading
      setSteps(prev => prev.map((s, i) =>
        i === index ? { ...s, status: 'loading' } : s
      ))

      // Wait for duration
      await new Promise(resolve => setTimeout(resolve, stepDurations[index]))

      // Set step to done
      setSteps(prev => prev.map((s, i) =>
        i === index ? { ...s, status: 'done' } : s
      ))

      // Show corresponding pillar
      if (index < 4) {
        setVisiblePillars(index + 1)
      }

      setCurrentStepIndex(index + 1)

      // Continue to next step
      setTimeout(() => runStep(index + 1), 200)
    }

    // Start the sequence
    const timer = setTimeout(() => runStep(0), 500)
    return () => clearTimeout(timer)
  }, [calculateBazi, setBaziData, nextStep])

  // Calculate bazi early for display
  useEffect(() => {
    const result = calculateBazi()
    if (result) {
      setBaziResult(result)
    }
  }, [calculateBazi])

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="w-full max-w-lg"
    >
      {/* Title */}
      <motion.h2
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        className="text-center text-xl font-serif font-semibold text-foreground mb-8"
      >
        æ­£åœ¨ä¸ºä½ ç»˜åˆ¶å‘½ç›˜...
      </motion.h2>

      {/* Bazi Chart Animation */}
      <motion.div
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ delay: 0.2 }}
        className="bg-card/80 backdrop-blur-sm border border-border rounded-2xl p-6 mb-6"
      >
        <div className="flex justify-center gap-4 mb-4">
          {/* Four Pillars */}
          {['å¹´', 'æœˆ', 'æ—¥', 'æ—¶'].map((label, index) => {
            const pillars = baziResult ? [
              baziResult.yearPillar,
              baziResult.monthPillar,
              baziResult.dayPillar,
              baziResult.hourPillar,
            ] : []
            const pillar = pillars[index]
            const isVisible = index < visiblePillars

            return (
              <motion.div
                key={label}
                initial={{ opacity: 0, y: 20 }}
                animate={{
                  opacity: isVisible ? 1 : 0.3,
                  y: isVisible ? 0 : 10,
                }}
                transition={{ duration: 0.5 }}
                className="flex flex-col items-center"
              >
                <span className="text-xs text-muted-foreground mb-2">{label}æŸ±</span>
                <div className={`
                  w-12 h-12 rounded-lg flex items-center justify-center text-lg font-bold
                  ${isVisible && pillar
                    ? 'bg-skill-primary/10 text-skill-primary border-2 border-skill-primary/30'
                    : 'bg-muted/30 text-muted-foreground/30 border-2 border-transparent'
                  }
                `}>
                  {isVisible && pillar ? pillar.stem : '?'}
                </div>
                <div className={`
                  w-12 h-12 mt-1 rounded-lg flex items-center justify-center text-lg font-bold
                  ${isVisible && pillar
                    ? 'bg-skill-primary/5 text-skill-primary/80 border border-skill-primary/20'
                    : 'bg-muted/20 text-muted-foreground/20 border border-transparent'
                  }
                `}>
                  {isVisible && pillar ? pillar.branch : '?'}
                </div>
              </motion.div>
            )
          })}
        </div>

        {/* Day Master Highlight */}
        <AnimatePresence>
          {visiblePillars >= 3 && baziResult && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="text-center pt-4 border-t border-border/50"
            >
              <span className="text-sm text-muted-foreground">æ—¥ä¸»</span>
              <p className="text-2xl font-serif font-bold text-skill-primary mt-1">
                {baziResult.dayMaster}{baziResult.dayMasterElement}
              </p>
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>

      {/* Calculation Steps */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3 }}
        className="mb-8"
      >
        <p className="text-sm text-muted-foreground mb-3">è®¡ç®—æ­¥éª¤ï¼š</p>
        <div className="space-y-2">
          {steps.map((step, index) => (
            <motion.div
              key={step.id}
              initial={{ opacity: 0, x: -10 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.4 + index * 0.1 }}
              className="flex items-center gap-3"
            >
              <div className="w-5 h-5 flex items-center justify-center">
                {step.status === 'done' && (
                  <motion.div
                    initial={{ scale: 0 }}
                    animate={{ scale: 1 }}
                    className="text-green-500"
                  >
                    <Check className="w-4 h-4" />
                  </motion.div>
                )}
                {step.status === 'loading' && (
                  <Loader2 className="w-4 h-4 text-skill-primary animate-spin" />
                )}
                {step.status === 'pending' && (
                  <div className="w-2 h-2 rounded-full bg-muted-foreground/30" />
                )}
              </div>
              <span className={`text-sm ${
                step.status === 'done'
                  ? 'text-foreground'
                  : step.status === 'loading'
                    ? 'text-skill-primary font-medium'
                    : 'text-muted-foreground/50'
              }`}>
                {step.label}
                {step.status === 'loading' && '...'}
              </span>
            </motion.div>
          ))}
        </div>
      </motion.div>

      {/* Premium Features Preview */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.6 }}
        className="border-t border-border pt-6"
      >
        <p className="text-sm text-muted-foreground mb-4 flex items-center gap-2">
          <span className="text-lg">ğŸ’¡</span>
          ä»˜è´¹ç”¨æˆ·è¿˜èƒ½ä½“éªŒï¼š
        </p>
        <div className="grid grid-cols-3 gap-3">
          {PREMIUM_FEATURES.map((feature, index) => (
            <motion.div
              key={feature.title}
              initial={{ opacity: 0, scale: 0.9 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: 0.7 + index * 0.1 }}
              className="bg-gradient-to-br from-skill-primary/5 to-skill-primary/10 border border-skill-primary/20 rounded-xl p-3 text-center"
            >
              <feature.icon className="w-6 h-6 mx-auto mb-2 text-skill-primary" />
              <p className="text-xs font-medium text-foreground">{feature.title}</p>
              <p className="text-xs text-muted-foreground mt-0.5">{feature.desc}</p>
            </motion.div>
          ))}
        </div>
      </motion.div>
    </motion.div>
  )
}
