"""
Onboarding API Routes - v2.1

新用户流程相关 API：
- 排盘计算
- 人格选择
- 信件生成
- 运势获取
"""

from fastapi import APIRouter, HTTPException, Depends
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import datetime
from uuid import UUID

from services.persona import (
    PersonaType,
    get_persona_service,
    LetterContext,
    get_letter_service,
)
from services.push import get_push_service
from services.bazi import get_bazi_calculator

router = APIRouter(prefix="/onboarding", tags=["onboarding"])


# ═══════════════════════════════════════════════════════════════════════════
# Request/Response Models
# ═══════════════════════════════════════════════════════════════════════════

class BirthInfoRequest(BaseModel):
    """出生信息请求"""
    year: int = Field(..., ge=1900, le=2100)
    month: int = Field(..., ge=1, le=12)
    day: int = Field(..., ge=1, le=31)
    hour: Optional[int] = Field(None, ge=0, le=23)
    is_lunar: bool = False
    gender: Optional[str] = None


class BaziResponse(BaseModel):
    """八字响应"""
    year_pillar: dict
    month_pillar: dict
    day_pillar: dict
    hour_pillar: Optional[dict]
    day_master: str
    day_master_element: str
    insight: str
    fortune: dict


class PersonaListResponse(BaseModel):
    """人格列表响应"""
    personas: List[dict]


class LetterRequest(BaseModel):
    """信件生成请求"""
    day_master: str
    day_master_element: str
    persona_type: str = "warm"
    concerns: List[str] = []
    interview_summary: str = ""


class LetterResponse(BaseModel):
    """信件响应"""
    content: str
    persona_type: str
    generated_at: str


class FortuneResponse(BaseModel):
    """运势响应"""
    score: int
    lucky_color: str
    lucky_number: int
    good_for: List[str]
    bad_for: List[str]
    advice: str


class DailyGreetingResponse(BaseModel):
    """每日问候响应"""
    greeting: str
    fortune_score: int
    lucky_color: str
    lucky_number: int
    advice: str
    mood_tip: str


# ═══════════════════════════════════════════════════════════════════════════
# Routes
# ═══════════════════════════════════════════════════════════════════════════

@router.post("/calculate-bazi", response_model=BaziResponse)
async def calculate_bazi(request: BirthInfoRequest):
    """
    计算八字

    根据出生信息计算四柱八字
    """
    try:
        calculator = get_bazi_calculator()

        # 计算八字
        result = calculator.calculate(
            year=request.year,
            month=request.month,
            day=request.day,
            hour=request.hour,
            is_lunar=request.is_lunar,
            gender=request.gender,
        )

        # 生成洞察文本
        element_insights = {
            "木": {"metaphor": "一棵参天大树", "trait": "向上生长是你的本能"},
            "火": {"metaphor": "一团炽热的火焰", "trait": "热情表达是你的天性"},
            "土": {"metaphor": "一座稳重的高山", "trait": "稳重可靠是你的特质"},
            "金": {"metaphor": "一把锋利的宝剑", "trait": "果断决绝是你的风格"},
            "水": {"metaphor": "一片浩瀚的大海", "trait": "包容变通是你的智慧"},
        }

        day_master_element = result.get("day_master_element", "木")
        insight_data = element_insights.get(day_master_element, element_insights["木"])
        insight = f"你的内心住着{insight_data['metaphor']}，\n{insight_data['trait']}。"

        # 计算今日运势
        today = datetime.now()
        seed = today.year * 10000 + today.month * 100 + today.day
        fortune = {
            "score": 3 + (seed % 3),
            "lucky_color": ["绿色", "红色", "金色", "蓝色", "紫色"][seed % 5],
            "lucky_number": (seed % 9) + 1,
            "advice": "今天适合主动出击，把握机会。",
        }

        return BaziResponse(
            year_pillar=result.get("year_pillar", {}),
            month_pillar=result.get("month_pillar", {}),
            day_pillar=result.get("day_pillar", {}),
            hour_pillar=result.get("hour_pillar"),
            day_master=result.get("day_master", "甲"),
            day_master_element=day_master_element,
            insight=insight,
            fortune=fortune,
        )

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/personas", response_model=PersonaListResponse)
async def get_personas():
    """
    获取所有人格类型

    返回三种人格配置供用户选择
    """
    persona_service = get_persona_service()
    personas = persona_service.get_all_personas()
    return PersonaListResponse(personas=personas)


@router.post("/generate-letter", response_model=LetterResponse)
async def generate_letter(request: LetterRequest):
    """
    生成来自未来的信

    基于命盘和人格类型生成个性化信件
    """
    try:
        letter_service = get_letter_service()

        # 转换人格类型
        try:
            persona_type = PersonaType(request.persona_type)
        except ValueError:
            persona_type = PersonaType.WARM

        # 构建上下文
        context = LetterContext(
            day_master=request.day_master,
            day_master_element=request.day_master_element,
            persona_type=persona_type,
            concerns=request.concerns,
            interview_summary=request.interview_summary,
        )

        # 生成信件
        content = await letter_service.generate_letter(context)

        return LetterResponse(
            content=content,
            persona_type=persona_type.value,
            generated_at=datetime.now().isoformat(),
        )

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/daily-greeting", response_model=DailyGreetingResponse)
async def get_daily_greeting(
    persona_type: str = "warm",
    day_master: Optional[str] = None,
    day_master_element: Optional[str] = None,
):
    """
    获取每日问候

    返回基于时间和人格风格的问候语
    """
    push_service = get_push_service()

    try:
        persona = PersonaType(persona_type)
    except ValueError:
        persona = PersonaType.WARM

    greeting = push_service.generate_daily_greeting(
        persona_type=persona,
        day_master=day_master,
        day_master_element=day_master_element,
    )

    return DailyGreetingResponse(
        greeting=greeting.greeting,
        fortune_score=greeting.fortune_score,
        lucky_color=greeting.lucky_color,
        lucky_number=greeting.lucky_number,
        advice=greeting.advice,
        mood_tip=greeting.mood_tip,
    )


@router.get("/today-fortune", response_model=FortuneResponse)
async def get_today_fortune(day_master_element: Optional[str] = None):
    """
    获取今日运势

    返回今日运势评分和建议
    """
    today = datetime.now()
    seed = today.year * 10000 + today.month * 100 + today.day

    score = 3 + (seed % 3)
    colors = ["绿色", "红色", "金色", "蓝色", "紫色"]
    lucky_color = colors[seed % len(colors)]
    lucky_number = (seed % 9) + 1

    good_options = [
        ["沟通", "学习", "开拓"],
        ["谈判", "签约", "出行"],
        ["创意", "规划", "社交"],
    ]
    bad_options = [
        ["冲动决策", "大额支出"],
        ["争执", "熬夜"],
        ["投机", "借贷"],
    ]

    # 根据五行调整建议
    element_advice = {
        "木": "今天木气旺盛，适合开拓新领域。",
        "火": "今天火气充沛，适合表达和社交。",
        "土": "今天土气稳定，适合整理和规划。",
        "金": "今天金气锐利，适合决断和完成。",
        "水": "今天水气流动，适合灵活应变。",
    }

    advice = element_advice.get(day_master_element, "顺应自然，把握当下。")

    return FortuneResponse(
        score=score,
        lucky_color=lucky_color,
        lucky_number=lucky_number,
        good_for=good_options[seed % len(good_options)],
        bad_for=bad_options[seed % len(bad_options)],
        advice=advice,
    )
