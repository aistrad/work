'use client'

/**
 * Onboarding Context - v2.1
 *
 * 管理整个 onboarding 流程的状态
 */

import React, { createContext, useContext, useReducer, useCallback, ReactNode } from 'react'
import type {
  OnboardingStep,
  OnboardingState,
  BirthInfo,
  ConcernType,
  PersonaType,
  BaziData,
  InterviewAnswer,
} from './types'

// ═══════════════════════════════════════════════════════════════════════════
// State & Actions
// ═══════════════════════════════════════════════════════════════════════════

const initialState: OnboardingState = {
  step: 'landing',
  birthInfo: null,
  concerns: [],
  persona: null,
  baziData: null,
  interviewAnswers: [],
  letterContent: null,
}

type Action =
  | { type: 'SET_STEP'; payload: OnboardingStep }
  | { type: 'SET_BIRTH_INFO'; payload: BirthInfo }
  | { type: 'SET_CONCERNS'; payload: ConcernType[] }
  | { type: 'SET_PERSONA'; payload: PersonaType }
  | { type: 'SET_BAZI_DATA'; payload: BaziData }
  | { type: 'ADD_INTERVIEW_ANSWER'; payload: InterviewAnswer }
  | { type: 'SET_LETTER_CONTENT'; payload: string }
  | { type: 'RESET' }

function reducer(state: OnboardingState, action: Action): OnboardingState {
  switch (action.type) {
    case 'SET_STEP':
      return { ...state, step: action.payload }
    case 'SET_BIRTH_INFO':
      return { ...state, birthInfo: action.payload }
    case 'SET_CONCERNS':
      return { ...state, concerns: action.payload }
    case 'SET_PERSONA':
      return { ...state, persona: action.payload }
    case 'SET_BAZI_DATA':
      return { ...state, baziData: action.payload }
    case 'ADD_INTERVIEW_ANSWER':
      return {
        ...state,
        interviewAnswers: [...state.interviewAnswers, action.payload],
      }
    case 'SET_LETTER_CONTENT':
      return { ...state, letterContent: action.payload }
    case 'RESET':
      return initialState
    default:
      return state
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// Context
// ═══════════════════════════════════════════════════════════════════════════

interface OnboardingContextValue {
  state: OnboardingState
  // Navigation
  goToStep: (step: OnboardingStep) => void
  nextStep: () => void
  // Data setters
  setBirthInfo: (info: BirthInfo) => void
  setConcerns: (concerns: ConcernType[]) => void
  setPersona: (persona: PersonaType) => void
  setBaziData: (data: BaziData) => void
  addInterviewAnswer: (answer: InterviewAnswer) => void
  setLetterContent: (content: string) => void
  // Utils
  reset: () => void
}

const OnboardingContext = createContext<OnboardingContextValue | null>(null)

// Step order for nextStep navigation
const STEP_ORDER: OnboardingStep[] = [
  'landing',
  'loading',
  'aha',
  'persona',
  'interview',
  'letter',
  'conversion',
]

// ═══════════════════════════════════════════════════════════════════════════
// Provider
// ═══════════════════════════════════════════════════════════════════════════

export function OnboardingProvider({ children }: { children: ReactNode }) {
  const [state, dispatch] = useReducer(reducer, initialState)

  const goToStep = useCallback((step: OnboardingStep) => {
    dispatch({ type: 'SET_STEP', payload: step })
  }, [])

  const nextStep = useCallback(() => {
    const currentIndex = STEP_ORDER.indexOf(state.step)
    if (currentIndex < STEP_ORDER.length - 1) {
      dispatch({ type: 'SET_STEP', payload: STEP_ORDER[currentIndex + 1] })
    }
  }, [state.step])

  const setBirthInfo = useCallback((info: BirthInfo) => {
    dispatch({ type: 'SET_BIRTH_INFO', payload: info })
  }, [])

  const setConcerns = useCallback((concerns: ConcernType[]) => {
    dispatch({ type: 'SET_CONCERNS', payload: concerns })
  }, [])

  const setPersona = useCallback((persona: PersonaType) => {
    dispatch({ type: 'SET_PERSONA', payload: persona })
  }, [])

  const setBaziData = useCallback((data: BaziData) => {
    dispatch({ type: 'SET_BAZI_DATA', payload: data })
  }, [])

  const addInterviewAnswer = useCallback((answer: InterviewAnswer) => {
    dispatch({ type: 'ADD_INTERVIEW_ANSWER', payload: answer })
  }, [])

  const setLetterContent = useCallback((content: string) => {
    dispatch({ type: 'SET_LETTER_CONTENT', payload: content })
  }, [])

  const reset = useCallback(() => {
    dispatch({ type: 'RESET' })
  }, [])

  const value: OnboardingContextValue = {
    state,
    goToStep,
    nextStep,
    setBirthInfo,
    setConcerns,
    setPersona,
    setBaziData,
    addInterviewAnswer,
    setLetterContent,
    reset,
  }

  return (
    <OnboardingContext.Provider value={value}>
      {children}
    </OnboardingContext.Provider>
  )
}

// ═══════════════════════════════════════════════════════════════════════════
// Hook
// ═══════════════════════════════════════════════════════════════════════════

export function useOnboarding() {
  const context = useContext(OnboardingContext)
  if (!context) {
    throw new Error('useOnboarding must be used within OnboardingProvider')
  }
  return context
}
