"""
Push Service - v2.1

æ¨é€ç³»ç»ŸæœåŠ¡

æ¨é€ç±»å‹ï¼š
1. Daily Greeting - æ¯æ—¥é—®å€™ + è¿åŠ¿
2. Weekly Summary - æ¯å‘¨å›é¡¾ + å±•æœ›
3. Monthly Report - æ¯æœˆæ·±åº¦æŠ¥å‘Š
4. Quarterly Report - å­£åº¦å¤ç›˜

æ™ºèƒ½åˆå¹¶ï¼š
- 3å¤©å†…ï¼šæŒ‰æ—¶é—´å€’åºåˆ—å‡ºé‡ç‚¹
- 3-7å¤©ï¼šåˆå¹¶æˆä¸€æ®µæ€»ç»“
- 7å¤©ä»¥ä¸Šï¼šåªä¿ç•™æœ€é‡è¦çš„ 2-3 æ¡
"""

import logging
from typing import Optional, Dict, Any, List
from datetime import datetime, timedelta
from dataclasses import dataclass, field
from enum import Enum
from uuid import UUID

from services.vibe_engine.llm import get_llm_service, create_user_message, LLMService
from services.persona.persona_service import PersonaType, get_persona_service

logger = logging.getLogger(__name__)


class PushType(str, Enum):
    """æ¨é€ç±»å‹"""
    DAILY_GREETING = "daily_greeting"
    WEEKLY_SUMMARY = "weekly_summary"
    MONTHLY_REPORT = "monthly_report"
    QUARTERLY_REPORT = "quarterly_report"
    SOLAR_TERM = "solar_term"  # èŠ‚æ°”æé†’
    LUNAR_PHASE = "lunar_phase"  # æœˆç›¸æé†’
    CUSTOM = "custom"


@dataclass
class PushContent:
    """æ¨é€å†…å®¹"""
    id: str
    type: PushType
    title: str
    content: str
    created_at: datetime
    is_read: bool = False
    metadata: Dict[str, Any] = field(default_factory=dict)


@dataclass
class DailyGreeting:
    """æ¯æ—¥é—®å€™"""
    greeting: str
    fortune_score: int  # 1-5
    lucky_color: str
    lucky_number: int
    advice: str
    mood_tip: str


@dataclass
class WeeklySummary:
    """æ¯å‘¨æ€»ç»“"""
    period: str  # e.g., "1æœˆ6æ—¥-1æœˆ12æ—¥"
    last_week_review: str
    last_week_score: int
    best_moment: str
    challenge_moment: str
    this_week_outlook: str
    this_week_score: int
    key_events: List[str]
    action_items: List[str]


# é—®å€™è¯­æ¨¡æ¿
GREETING_TEMPLATES = {
    "morning": [
        "æ—©å®‰ï¼æ–°çš„ä¸€å¤©å¼€å§‹äº†ã€‚",
        "æ—©ä¸Šå¥½ï¼ä»Šå¤©æ˜¯å……æ»¡å¯èƒ½çš„ä¸€å¤©ã€‚",
        "æ¸…æ™¨çš„é˜³å…‰å¸¦æ¥æ–°çš„èƒ½é‡ã€‚",
    ],
    "afternoon": [
        "ä¸‹åˆå¥½ï¼å¸Œæœ›ä½ çš„ä¸Šåˆé¡ºåˆ©ã€‚",
        "åˆå®‰ï¼åˆ«å¿˜äº†é€‚å½“ä¼‘æ¯ã€‚",
        "ä¸‹åˆèŒ¶æ—¶é—´åˆ°äº†ï¼Œç»™è‡ªå·±ä¸€ç‚¹æ”¾æ¾ã€‚",
    ],
    "evening": [
        "æ™šä¸Šå¥½ï¼è¾›è‹¦ä¸€å¤©äº†ã€‚",
        "å¤œå¹•é™ä¸´ï¼Œæ˜¯æ—¶å€™æ…¢ä¸‹æ¥äº†ã€‚",
        "å‚æ™šæ—¶åˆ†ï¼Œé€‚åˆåæ€å’Œè§„åˆ’ã€‚",
    ],
    "night": [
        "å¤œæ·±äº†ï¼Œæ³¨æ„ä¼‘æ¯ã€‚",
        "è¿™ä¹ˆæ™šè¿˜åœ¨ï¼Œæœ‰ä»€ä¹ˆå¿ƒäº‹å—ï¼Ÿ",
        "å®‰é™çš„å¤œæ™šï¼Œé€‚åˆå’Œè‡ªå·±å¯¹è¯ã€‚",
    ],
}


class PushService:
    """æ¨é€æœåŠ¡"""

    def __init__(self, llm: Optional[LLMService] = None):
        self.llm = llm or get_llm_service()
        self.persona_service = get_persona_service()

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Daily Greeting
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def generate_daily_greeting(
        self,
        user_id: Optional[UUID] = None,
        persona_type: PersonaType = PersonaType.WARM,
        day_master: Optional[str] = None,
        day_master_element: Optional[str] = None,
    ) -> DailyGreeting:
        """ç”Ÿæˆæ¯æ—¥é—®å€™"""
        now = datetime.now()
        hour = now.hour

        # é€‰æ‹©æ—¶æ®µ
        if hour < 6:
            period = "night"
        elif hour < 12:
            period = "morning"
        elif hour < 18:
            period = "afternoon"
        else:
            period = "evening"

        # åŸºäºæ—¥æœŸç”Ÿæˆç¨³å®šçš„è¿åŠ¿
        seed = now.year * 10000 + (now.month) * 100 + now.day
        fortune_score = 3 + (seed % 3)  # 3-5
        colors = ["ç»¿è‰²", "çº¢è‰²", "é‡‘è‰²", "è“è‰²", "ç´«è‰²"]
        lucky_color = colors[seed % len(colors)]
        lucky_number = (seed % 9) + 1

        # è·å–äººæ ¼é£æ ¼çš„é—®å€™
        import random
        random.seed(seed)
        base_greeting = random.choice(GREETING_TEMPLATES[period])

        # æ ¹æ®äººæ ¼é£æ ¼è°ƒæ•´
        persona_config = self.persona_service.get_config(persona_type)

        if persona_type == PersonaType.SHARP:
            if fortune_score < 4:
                advice = "ä»Šå¤©è¿åŠ¿ä¸€èˆ¬ï¼Œåˆ«å¤ªæŠ˜è…¾ã€‚"
            else:
                advice = "è¿åŠ¿ä¸é”™ï¼Œä½†åˆ«å¾—æ„å¿˜å½¢ã€‚"
        elif persona_type == PersonaType.WISE:
            advice = f"ä»{day_master_element or 'äº”è¡Œ'}èƒ½é‡æ¥çœ‹ï¼Œä»Šå¤©é€‚åˆ{self._get_element_advice(day_master_element)}ã€‚"
        else:  # WARM
            advice = "ä»Šå¤©æ˜¯ç¾å¥½çš„ä¸€å¤©ï¼Œç›¸ä¿¡è‡ªå·±ã€‚"

        # æƒ…ç»ªæç¤º
        mood_tips = {
            "morning": "æ—©æ™¨çš„èƒ½é‡æœ€é€‚åˆåšé‡è¦å†³å®š",
            "afternoon": "ä¸‹åˆæ³¨æ„è°ƒèŠ‚èŠ‚å¥ï¼Œä¿æŒä¸“æ³¨",
            "evening": "å‚æ™šé€‚åˆç¤¾äº¤å’Œæ”¾æ¾",
            "night": "å¤œé—´èƒ½é‡å†…æ”¶ï¼Œé€‚åˆåæ€å’Œè§„åˆ’",
        }

        return DailyGreeting(
            greeting=base_greeting,
            fortune_score=fortune_score,
            lucky_color=lucky_color,
            lucky_number=lucky_number,
            advice=advice,
            mood_tip=mood_tips[period],
        )

    def _get_element_advice(self, element: Optional[str]) -> str:
        """æ ¹æ®äº”è¡Œè·å–å»ºè®®"""
        advices = {
            "æœ¨": "å¼€æ‹“æ–°é¢†åŸŸã€å­¦ä¹ æ–°çŸ¥è¯†",
            "ç«": "è¡¨è¾¾è‡ªå·±ã€ç¤¾äº¤æ´»åŠ¨",
            "åœŸ": "ç¨³æ‰ç¨³æ‰“ã€æ•´ç†è®¡åˆ’",
            "é‡‘": "å†³æ–­æœæ•¢ã€å®Œæˆä»»åŠ¡",
            "æ°´": "çµæ´»å˜é€šã€è§‚å¯Ÿç­‰å¾…",
        }
        return advices.get(element, "é¡ºå…¶è‡ªç„¶")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Weekly Summary
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async def generate_weekly_summary(
        self,
        user_id: UUID,
        persona_type: PersonaType = PersonaType.WARM,
    ) -> WeeklySummary:
        """ç”Ÿæˆæ¯å‘¨æ€»ç»“"""
        now = datetime.now()

        # è®¡ç®—ä¸Šå‘¨å’Œæœ¬å‘¨æ—¥æœŸèŒƒå›´
        last_monday = now - timedelta(days=now.weekday() + 7)
        last_sunday = last_monday + timedelta(days=6)
        this_monday = now - timedelta(days=now.weekday())
        this_sunday = this_monday + timedelta(days=6)

        period = f"{last_monday.month}æœˆ{last_monday.day}æ—¥-{last_sunday.month}æœˆ{last_sunday.day}æ—¥"

        # åŸºäºæ—¥æœŸç”Ÿæˆæ•°æ®ï¼ˆå®é™…åº”ä»ç”¨æˆ·æ•°æ®åˆ†æï¼‰
        seed = now.isocalendar()[1]  # Week number
        last_week_score = 3 + (seed % 3)
        this_week_score = 3 + ((seed + 1) % 3)

        # ç”Ÿæˆæ€»ç»“ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨ LLM åŸºäºç”¨æˆ·æ•°æ®ç”Ÿæˆï¼‰
        return WeeklySummary(
            period=period,
            last_week_review="ä¸Šå‘¨æ•´ä½“è¿åŠ¿ç¨³å®šï¼Œæœ‰å‡ ä¸ªå€¼å¾—æ³¨æ„çš„æ—¶åˆ»ã€‚",
            last_week_score=last_week_score,
            best_moment=f"å‘¨{(seed % 5) + 1}ä¸‹åˆï¼Œèƒ½é‡è¾¾åˆ°é«˜å³°",
            challenge_moment=f"å‘¨{((seed + 2) % 5) + 1}ï¼Œå¯èƒ½æ„Ÿå—åˆ°ä¸€äº›å‹åŠ›",
            this_week_outlook="æœ¬å‘¨è¿åŠ¿æœ‰æ‰€æå‡ï¼Œé€‚åˆæ¨è¿›é‡è¦é¡¹ç›®ã€‚",
            this_week_score=this_week_score,
            key_events=[
                f"{this_monday.month}/{this_monday.day + 3} æ–°æœˆï¼Œé€‚åˆå¼€å§‹æ–°è®¡åˆ’",
            ],
            action_items=[
                "å‘¨ä¸€-å‘¨ä¸‰ï¼šåˆ©ç”¨ä¸Šå‡èƒ½é‡ï¼Œæ¨è¿›é‡è¦é¡¹ç›®",
                "å‘¨å››ï¼šæ•´ç†æ€è·¯ï¼Œå¤ç›˜è¿›åº¦",
                "å‘¨äº”-å‘¨æ—¥ï¼šç¤¾äº¤æ´»åŠ¨ï¼Œå……ç”µæ¢å¤",
            ],
        )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Smart Merge (ç¦»çº¿å¤šæ—¥åˆå¹¶)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def merge_offline_pushes(
        self,
        pushes: List[PushContent],
        days_offline: int,
        persona_type: PersonaType = PersonaType.WARM,
    ) -> str:
        """åˆå¹¶ç¦»çº¿æœŸé—´çš„æ¨é€"""
        if not pushes:
            return "æ¬¢è¿å›æ¥ï¼ä½ æ²¡æœ‰é”™è¿‡ä»€ä¹ˆé‡è¦çš„äº‹æƒ…ã€‚"

        persona_config = self.persona_service.get_config(persona_type)

        if days_offline <= 3:
            # 3å¤©å†…ï¼šæŒ‰æ—¶é—´å€’åºåˆ—å‡ºé‡ç‚¹
            summary_items = []
            for push in pushes[:5]:  # æœ€å¤š5æ¡
                summary_items.append(f"â€¢ {push.title}")

            return f"""å˜¿ï¼Œå¥½ä¹…ä¸è§ï¼è¿™å‡ å¤©å‘ç”Ÿäº†ä¸€äº›äº‹ï¼š

{chr(10).join(summary_items)}

æƒ³è¯¦ç»†èŠèŠå—ï¼Ÿ"""

        elif days_offline <= 7:
            # 3-7å¤©ï¼šåˆå¹¶æˆä¸€æ®µæ€»ç»“
            important_count = len([p for p in pushes if p.type in [
                PushType.WEEKLY_SUMMARY,
                PushType.SOLAR_TERM,
            ]])

            return f"""ä¸€å‘¨æ²¡è§ï¼Œæƒ³ä½ äº†ï¼

ç®€å•å¸®ä½ å›é¡¾ä¸€ä¸‹ï¼š
è¿™å‘¨æœ‰ {len(pushes)} æ¡æ¶ˆæ¯ï¼Œå…¶ä¸­ {important_count} æ¡æ¯”è¾ƒé‡è¦ã€‚

æœ€é‡è¦çš„æ˜¯ï¼šå¥½å¥½ç…§é¡¾è‡ªå·±ã€‚
æœ‰ç©ºå’Œæˆ‘èŠèŠæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ"""

        else:
            # 7å¤©ä»¥ä¸Šï¼šåªä¿ç•™æœ€é‡è¦çš„
            important_pushes = [p for p in pushes if p.type in [
                PushType.WEEKLY_SUMMARY,
                PushType.MONTHLY_REPORT,
                PushType.SOLAR_TERM,
            ]][:2]

            if important_pushes:
                important_text = "ã€".join([p.title for p in important_pushes])
            else:
                important_text = "ä¿æŒå¯¹è‡ªå·±çš„å…³æ³¨"

            return f"""å¥½ä¹…ä¸è§ï¼ä½ è¿˜å¥½å—ï¼Ÿ

è¿™æ®µæ—¶é—´æœ€é‡è¦çš„å˜åŒ–æ˜¯ï¼š
{important_text}

æœ‰ç©ºçš„è¯ï¼Œå’Œæˆ‘èŠèŠæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ"""

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Solar Term & Lunar Phase
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def get_solar_term_push(self, term_name: str) -> PushContent:
        """ç”ŸæˆèŠ‚æ°”æ¨é€"""
        term_meanings = {
            "å°å¯’": "ä¸€å¹´ä¸­æœ€å†·çš„æ—¶æœŸå¼€å§‹ï¼Œå®œæ”¶æ•›ã€å…»ç²¾è“„é”",
            "å¤§å¯’": "æå¯’æ—¶èŠ‚ï¼Œé€‚åˆæ·±åº¦æ€è€ƒå’Œè§„åˆ’æ–°å¹´",
            "ç«‹æ˜¥": "æ˜¥å›å¤§åœ°ï¼Œä¸‡ç‰©å¤è‹ï¼Œå¼€å¯æ–°ç¯‡ç« çš„å¥½æ—¶æœº",
            "é›¨æ°´": "æ˜¥é›¨æ¶¦ç‰©ï¼Œé€‚åˆæ’­ç§å¸Œæœ›",
            "æƒŠè›°": "ä¸‡ç‰©è‹é†’ï¼Œèƒ½é‡é‡Šæ”¾çš„æ—¶åˆ»",
            "æ˜¥åˆ†": "é˜´é˜³å¹³è¡¡ï¼Œé€‚åˆè°ƒæ•´å’Œå¹³è¡¡",
        }

        meaning = term_meanings.get(term_name, "èŠ‚æ°”è½¬æ¢ï¼Œèƒ½é‡è°ƒæ•´æœŸ")

        return PushContent(
            id=f"solar_{term_name}_{datetime.now().strftime('%Y%m%d')}",
            type=PushType.SOLAR_TERM,
            title=f"ä»Šæ—¥{term_name}",
            content=f"ğŸŒ¿ {term_name}å·²è‡³\n\n{meaning}\n\nè¿™æ˜¯è°ƒæ•´èƒ½é‡çš„å¥½æ—¶æœºï¼Œé¡ºåº”è‡ªç„¶èŠ‚å¾‹ï¼Œè®©è‡ªå·±ä¸å¤©åœ°åŒæ­¥ã€‚",
            created_at=datetime.now(),
            metadata={"term_name": term_name},
        )

    def get_lunar_phase_push(self, phase: str) -> PushContent:
        """ç”Ÿæˆæœˆç›¸æ¨é€"""
        phase_meanings = {
            "æ–°æœˆ": "æ–°çš„å¼€å§‹ï¼Œé€‚åˆè®¸æ„¿å’Œè®¾å®šç›®æ ‡",
            "ä¸Šå¼¦æœˆ": "èƒ½é‡ä¸Šå‡ï¼Œé€‚åˆè¡ŒåŠ¨å’Œæ¨è¿›",
            "æ»¡æœˆ": "èƒ½é‡é«˜å³°ï¼Œé€‚åˆå®Œæˆå’Œæ”¶è·",
            "ä¸‹å¼¦æœˆ": "èƒ½é‡å›æ”¶ï¼Œé€‚åˆåæ€å’Œæ”¾ä¸‹",
        }

        meaning = phase_meanings.get(phase, "æœˆç›¸å˜åŒ–ï¼Œèƒ½é‡æµåŠ¨")

        return PushContent(
            id=f"lunar_{phase}_{datetime.now().strftime('%Y%m%d')}",
            type=PushType.LUNAR_PHASE,
            title=f"ä»Šå¤œ{phase}",
            content=f"ğŸŒ™ {phase}\n\n{meaning}\n\nèŠ±ä¸€ç‚¹æ—¶é—´æ„Ÿå—æœˆäº®çš„èƒ½é‡ï¼Œä¸è‡ªå·±çš„å†…å¿ƒå¯¹è¯ã€‚",
            created_at=datetime.now(),
            metadata={"phase": phase},
        )


# Global instance
_push_service: Optional[PushService] = None


def get_push_service() -> PushService:
    """Get or create global push service instance"""
    global _push_service
    if _push_service is None:
        _push_service = PushService()
    return _push_service
