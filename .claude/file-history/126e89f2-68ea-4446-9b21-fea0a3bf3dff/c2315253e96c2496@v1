'use client'

/**
 * Insight Panel V2 - v2.1 Design
 *
 * ä»Šæ—¥è¦äº‹ + è¿åŠ¿ + æƒ…ç»ª + èŠ‚ç‚¹ + å¿«æ·æ“ä½œ
 * ç›®æ ‡ï¼šæ¯æ¬¡æ‰“å¼€éƒ½æœ‰æ–°é²œæ„Ÿå’Œä»·å€¼
 */

import { useState, useEffect, useCallback } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import {
  Bell,
  Zap,
  Star,
  Calendar,
  Sparkles,
  TrendingUp,
  Image,
  Users,
  X,
  ChevronLeft,
  ChevronRight,
} from 'lucide-react'
import { cn } from '@/lib/utils'
import Link from 'next/link'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface TodayMatter {
  id: string
  icon: string
  title: string
  description: string
  type: 'info' | 'action' | 'warning'
}

interface FortuneData {
  score: number
  luckyColor: string
  luckyNumber: number
  goodFor: string[]
  badFor: string[]
}

interface MoodTip {
  emoji: string
  mood: string
  tip: string
}

interface UpcomingEvent {
  date: string
  name: string
  description: string
  type: 'solar' | 'lunar' | 'dayun' | 'personal'
}

interface QuickAction {
  id: string
  icon: React.ComponentType<{ className?: string }>
  label: string
  href: string
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Data Generators
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const getTodayMatters = (): TodayMatter[] => {
  const hour = new Date().getHours()
  const matters: TodayMatter[] = []

  if (hour < 12) {
    matters.push({
      id: 'morning',
      icon: 'ğŸ””',
      title: 'ä»Šæ—¥æœ¨æ°”æ¸æ—º',
      description: 'é€‚åˆå¼€å±•æ–°è®¡åˆ’',
      type: 'info',
    })
  } else if (hour < 18) {
    matters.push({
      id: 'afternoon',
      icon: 'ğŸ””',
      title: 'åˆåé‡‘æ°”å¢å¼º',
      description: 'é€‚åˆæ²Ÿé€šè°ˆåˆ¤',
      type: 'info',
    })
  } else {
    matters.push({
      id: 'evening',
      icon: 'ğŸ””',
      title: 'å‚æ™šæ°´æ°”æ±‡èš',
      description: 'é€‚åˆæ€è€ƒè§„åˆ’',
      type: 'info',
    })
  }

  matters.push({
    id: 'energy',
    icon: 'âš¡',
    title: hour < 15 ? 'ä¸‹åˆ3ç‚¹åèƒ½é‡æœ€å¼º' : 'å‚æ™šé€‚åˆæ€è€ƒå†³ç­–',
    description: hour < 15 ? 'é‡è¦å†³ç­–å®œæ­¤æ—¶åš' : 'å¤ç›˜ä»Šæ—¥ï¼Œè§„åˆ’æ˜æ—¥',
    type: 'action',
  })

  return matters
}

const getTodayFortune = (): FortuneData => {
  const today = new Date()
  const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate()
  const score = 3 + (seed % 3)
  const colors = ['ç»¿è‰²', 'çº¢è‰²', 'é‡‘è‰²', 'è“è‰²', 'ç´«è‰²']
  const luckyColor = colors[seed % colors.length]
  const luckyNumber = (seed % 9) + 1

  const goodOptions = [
    ['æ²Ÿé€š', 'å­¦ä¹ ', 'å¼€æ‹“'],
    ['è°ˆåˆ¤', 'ç­¾çº¦', 'å‡ºè¡Œ'],
    ['åˆ›æ„', 'è§„åˆ’', 'ç¤¾äº¤'],
  ]
  const badOptions = [
    ['å†²åŠ¨å†³ç­–', 'å¤§é¢æ”¯å‡º'],
    ['äº‰æ‰§', 'ç†¬å¤œ'],
    ['æŠ•æœº', 'å€Ÿè´·'],
  ]

  return {
    score,
    luckyColor,
    luckyNumber,
    goodFor: goodOptions[seed % goodOptions.length],
    badFor: badOptions[seed % badOptions.length],
  }
}

const getMoodTip = (): MoodTip => {
  const hour = new Date().getHours()
  if (hour < 7) {
    return { emoji: 'ğŸŒ„', mood: 'å®é™', tip: 'æ—©èµ·çš„æ—¶å…‰æœ€é€‚åˆå†¥æƒ³æˆ–è§„åˆ’' }
  } else if (hour < 10) {
    return { emoji: 'ğŸŒ…', mood: 'æ¸…é†’', tip: 'æ—©æ™¨é€‚åˆåšé‡è¦å†³å®š' }
  } else if (hour < 14) {
    return { emoji: 'â˜€ï¸', mood: 'æ´»è·ƒ', tip: 'ç²¾åŠ›å……æ²›ï¼ŒæŠŠæ¡æœºä¼š' }
  } else if (hour < 18) {
    return { emoji: 'ğŸ˜Œ', mood: 'å¹³ç¨³', tip: 'å¦‚æœæ„Ÿåˆ°ç„¦è™‘ï¼Œè¯•è¯•æ·±å‘¼å¸ä¸‰æ¬¡' }
  } else if (hour < 22) {
    return { emoji: 'ğŸŒ™', mood: 'æ²‰é™', tip: 'é€‚åˆåæ€å’Œè§„åˆ’æ˜å¤©' }
  } else {
    return { emoji: 'ğŸŒƒ', mood: 'å†…çœ', tip: 'å¤œæ·±äº†ï¼Œç»™è‡ªå·±ä¸€äº›å®‰é™çš„æ—¶é—´' }
  }
}

const getUpcomingEvents = (): UpcomingEvent[] => {
  const today = new Date()
  const events: UpcomingEvent[] = []

  // Solar terms (24 èŠ‚æ°”)
  const solarTerms2026 = [
    { month: 1, day: 5, name: 'å°å¯’' },
    { month: 1, day: 20, name: 'å¤§å¯’' },
    { month: 2, day: 4, name: 'ç«‹æ˜¥' },
    { month: 2, day: 18, name: 'é›¨æ°´' },
    { month: 3, day: 5, name: 'æƒŠè›°' },
    { month: 3, day: 20, name: 'æ˜¥åˆ†' },
  ]

  solarTerms2026.forEach(term => {
    const termDate = new Date(today.getFullYear(), term.month - 1, term.day)
    const diff = Math.ceil((termDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
    if (diff > 0 && diff <= 14) {
      events.push({
        date: `${term.month}/${term.day}`,
        name: term.name,
        description: 'èŠ‚æ°”èƒ½é‡è½¬æ¢æœŸ',
        type: 'solar',
      })
    }
  })

  // Lunar phases (simplified)
  const dayOfMonth = today.getDate()
  if (dayOfMonth < 15) {
    events.push({
      date: `${today.getMonth() + 1}/15`,
      name: 'æ»¡æœˆ',
      description: 'é€‚åˆå®Œæˆé¡¹ç›®',
      type: 'lunar',
    })
  } else if (dayOfMonth < 30) {
    const nextMonth = today.getMonth() + 2 > 12 ? 1 : today.getMonth() + 2
    events.push({
      date: `${nextMonth}/1`,
      name: 'æ–°æœˆ',
      description: 'é€‚åˆè®¸æ„¿æ–°å¼€å§‹',
      type: 'lunar',
    })
  }

  return events.slice(0, 3)
}

const QUICK_ACTIONS: QuickAction[] = [
  { id: 'daily', icon: Sparkles, label: 'ä»Šæ—¥æŠ½å¡', href: '#daily-card' },
  { id: 'relationship', icon: Users, label: 'å…³ç³»åˆ†æ', href: '/bazi/relationship' },
  { id: 'kline', icon: TrendingUp, label: 'äººç”ŸKçº¿', href: '/bazi/kline' },
  { id: 'poster', icon: Image, label: 'ç”Ÿæˆæµ·æŠ¥', href: '#poster' },
]

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface InsightPanelV2Props {
  className?: string
  collapsed?: boolean
  onToggleCollapse?: () => void
}

export function InsightPanelV2({
  className = '',
  collapsed = false,
  onToggleCollapse,
}: InsightPanelV2Props) {
  const [todayMatters, setTodayMatters] = useState<TodayMatter[]>([])
  const [fortune, setFortune] = useState<FortuneData | null>(null)
  const [moodTip, setMoodTip] = useState<MoodTip | null>(null)
  const [upcomingEvents, setUpcomingEvents] = useState<UpcomingEvent[]>([])
  const [isInitialized, setIsInitialized] = useState(false)

  // Initialize data
  useEffect(() => {
    setTodayMatters(getTodayMatters())
    setFortune(getTodayFortune())
    setMoodTip(getMoodTip())
    setUpcomingEvents(getUpcomingEvents())
    setIsInitialized(true)

    // Update mood tip every hour
    const interval = setInterval(() => {
      setMoodTip(getMoodTip())
    }, 60 * 60 * 1000)

    return () => clearInterval(interval)
  }, [])

  const renderStars = useCallback((score: number) => (
    <div className="flex items-center gap-0.5">
      {Array.from({ length: 5 }).map((_, i) => (
        <Star
          key={i}
          className={cn(
            'w-3 h-3',
            i < score ? 'text-yellow-500 fill-yellow-500' : 'text-muted-foreground/30'
          )}
        />
      ))}
    </div>
  ), [])

  // Collapsed state - show toggle button only
  if (collapsed) {
    return (
      <motion.button
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        onClick={onToggleCollapse}
        className={cn(
          'fixed right-0 top-1/2 -translate-y-1/2 z-40',
          'bg-card/80 backdrop-blur-sm border border-border border-r-0',
          'rounded-l-lg p-2 shadow-lg hover:bg-card transition-colors',
          className
        )}
      >
        <ChevronLeft className="w-4 h-4 text-muted-foreground" />
      </motion.button>
    )
  }

  return (
    <motion.div
      initial={{ opacity: 0, x: 20 }}
      animate={{ opacity: 1, x: 0 }}
      exit={{ opacity: 0, x: 20 }}
      className={cn(
        'w-[320px] h-full bg-card/50 backdrop-blur-sm border-l border-border overflow-y-auto',
        className
      )}
    >
      <div className="p-4 space-y-4">
        {/* Header */}
        <div className="flex items-center justify-between">
          <h3 className="font-medium text-foreground">ä»Šæ—¥æ´å¯Ÿ</h3>
          {onToggleCollapse && (
            <button
              onClick={onToggleCollapse}
              className="p-1 rounded hover:bg-muted transition-colors"
              title="æ”¶èµ·é¢æ¿"
            >
              <ChevronRight className="w-4 h-4 text-muted-foreground" />
            </button>
          )}
        </div>

        <AnimatePresence mode="wait">
          {isInitialized && (
            <>
              {/* ä»Šæ—¥è¦äº‹ */}
              <motion.div
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.1 }}
                className="bg-background rounded-xl p-4"
              >
                <div className="flex items-center gap-2 mb-3">
                  <Bell className="w-4 h-4 text-skill-primary" />
                  <h4 className="text-sm font-medium text-foreground">ä»Šæ—¥è¦äº‹</h4>
                </div>
                <div className="space-y-3">
                  {todayMatters.map((matter, index) => (
                    <motion.div
                      key={matter.id}
                      initial={{ opacity: 0, x: -10 }}
                      animate={{ opacity: 1, x: 0 }}
                      transition={{ delay: 0.2 + index * 0.1 }}
                      className="flex items-start gap-2"
                    >
                      <span className="text-base flex-shrink-0">{matter.icon}</span>
                      <div className="min-w-0">
                        <p className="text-sm font-medium text-foreground">{matter.title}</p>
                        <p className="text-xs text-muted-foreground">{matter.description}</p>
                      </div>
                    </motion.div>
                  ))}
                </div>
              </motion.div>

              {/* ä»Šæ—¥è¿åŠ¿ */}
              {fortune && (
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.2 }}
                  className="bg-background rounded-xl p-4"
                >
                  <div className="flex items-center justify-between mb-3">
                    <div className="flex items-center gap-2">
                      <Star className="w-4 h-4 text-yellow-500" />
                      <h4 className="text-sm font-medium text-foreground">ä»Šæ—¥è¿åŠ¿</h4>
                    </div>
                    {renderStars(fortune.score)}
                  </div>
                  <div className="flex items-center justify-between text-xs text-muted-foreground mb-3">
                    <span>
                      å¹¸è¿è‰²ï¼š<span className="text-foreground font-medium">{fortune.luckyColor}</span>
                    </span>
                    <span>
                      æ•°å­—ï¼š<span className="text-foreground font-medium">{fortune.luckyNumber}</span>
                    </span>
                  </div>
                  <div className="space-y-1.5 text-xs">
                    <div className="flex items-start gap-2">
                      <span className="text-green-600 flex-shrink-0">å®œï¼š</span>
                      <span className="text-muted-foreground">{fortune.goodFor.join('ã€')}</span>
                    </div>
                    <div className="flex items-start gap-2">
                      <span className="text-orange-500 flex-shrink-0">å¿Œï¼š</span>
                      <span className="text-muted-foreground">{fortune.badFor.join('ã€')}</span>
                    </div>
                  </div>
                </motion.div>
              )}

              {/* æƒ…ç»ªæç¤º */}
              {moodTip && (
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.3 }}
                  className="bg-background rounded-xl p-4"
                >
                  <div className="flex items-center gap-2 mb-2">
                    <Zap className="w-4 h-4 text-purple-500" />
                    <h4 className="text-sm font-medium text-foreground">æƒ…ç»ªæç¤º</h4>
                  </div>
                  <div className="flex items-start gap-3">
                    <span className="text-2xl flex-shrink-0">{moodTip.emoji}</span>
                    <div className="min-w-0">
                      <p className="text-sm text-foreground">
                        ä»Šå¤©æƒ…ç»ªåŸºè°ƒï¼š<span className="font-medium">{moodTip.mood}</span>
                      </p>
                      <p className="text-xs text-muted-foreground mt-1">{moodTip.tip}</p>
                    </div>
                  </div>
                </motion.div>
              )}

              {/* è¿‘æœŸèŠ‚ç‚¹ */}
              {upcomingEvents.length > 0 && (
                <motion.div
                  initial={{ opacity: 0, y: 10 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ delay: 0.4 }}
                  className="bg-background rounded-xl p-4"
                >
                  <div className="flex items-center gap-2 mb-3">
                    <Calendar className="w-4 h-4 text-blue-500" />
                    <h4 className="text-sm font-medium text-foreground">è¿‘æœŸèŠ‚ç‚¹</h4>
                  </div>
                  <div className="space-y-2">
                    {upcomingEvents.map((event, index) => (
                      <div key={index} className="flex items-center gap-3">
                        <span className="text-xs text-muted-foreground w-10 flex-shrink-0 tabular-nums">
                          {event.date}
                        </span>
                        <span className="text-sm text-foreground font-medium flex-shrink-0">
                          {event.name}
                        </span>
                        <span className="text-xs text-muted-foreground truncate">
                          {event.description}
                        </span>
                      </div>
                    ))}
                  </div>
                </motion.div>
              )}

              {/* å¿«æ·æ“ä½œ */}
              <motion.div
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: 0.5 }}
                className="bg-background rounded-xl p-4"
              >
                <div className="flex items-center gap-2 mb-3">
                  <Sparkles className="w-4 h-4 text-skill-primary" />
                  <h4 className="text-sm font-medium text-foreground">å¿«æ·æ“ä½œ</h4>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  {QUICK_ACTIONS.map((action) => (
                    <Link
                      key={action.id}
                      href={action.href}
                      className="flex items-center gap-2 p-3 rounded-lg bg-muted/50 hover:bg-muted transition-colors"
                    >
                      <action.icon className="w-4 h-4 text-skill-primary flex-shrink-0" />
                      <span className="text-xs font-medium text-foreground">{action.label}</span>
                    </Link>
                  ))}
                </div>
              </motion.div>
            </>
          )}
        </AnimatePresence>
      </div>
    </motion.div>
  )
}

export default InsightPanelV2
