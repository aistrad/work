"""
Letter Service - v2.1

「来自未来的信」生成服务

基于：
1. 命盘数据（日主、五行、大运）
2. 人格类型（温暖/犀利/智慧）
3. 访谈答案（关注点、困扰）

生成一封来自三年后的自己写给现在的信
"""

import logging
from typing import Optional, Dict, Any
from datetime import datetime
from dataclasses import dataclass

from services.vibe_engine.llm import get_llm_service, create_user_message, create_system_message, LLMService
from services.persona.persona_service import PersonaType, get_persona_service

logger = logging.getLogger(__name__)


@dataclass
class LetterContext:
    """信件生成上下文"""
    # 命盘信息
    day_master: str  # 日主
    day_master_element: str  # 日主五行
    current_luck: Optional[str] = None  # 当前大运

    # 用户信息
    persona_type: PersonaType = PersonaType.WARM
    concerns: list = None  # 关注点
    interview_summary: str = ""  # 访谈总结

    # 生成配置
    future_years: int = 3  # 未来几年


# 五行隐喻
ELEMENT_METAPHORS = {
    "木": "一棵参天大树",
    "火": "一团炽热的火焰",
    "土": "一座稳重的高山",
    "金": "一把锋利的宝剑",
    "水": "一片浩瀚的大海",
}

# 信件生成提示词
LETTER_GENERATION_PROMPT = """你是一位深谙命理的智者，正在帮助用户生成一封「来自未来的信」。

## 用户命盘信息
- 日主：{day_master}
- 五行：{day_master_element}
{current_luck_info}

## 用户关注点
{concerns_info}

## 访谈信息
{interview_info}

## 人格风格
{persona_style}

## 信件要求
1. 以「{future_years}年后的自己」视角写信给现在的用户
2. 使用指定人格风格的语气
3. 信件结构：
   - 开篇：悬念式，抓住读者
   - 对用户的了解：基于命盘分析
   - 当前困境的解读：结合五行和流年
   - 未来的展望：给出希望和方向
   - 结尾：温暖/犀利/智慧的收尾
4. 长度：800-1200字
5. 不要使用 markdown 格式，纯文本即可
6. 署名格式："来自{future_years}年后的你\\n{future_date}"

## 开篇参考
{letter_opening}

请生成完整的信件（包括开篇）："""


class LetterService:
    """信件生成服务"""

    def __init__(self, llm: Optional[LLMService] = None):
        self.llm = llm or get_llm_service()
        self.persona_service = get_persona_service()

    async def generate_letter(self, context: LetterContext) -> str:
        """生成来自未来的信"""

        # 获取人格配置
        persona_config = self.persona_service.get_config(context.persona_type)

        # 准备提示词变量
        current_luck_info = ""
        if context.current_luck:
            current_luck_info = f"- 当前大运：{context.current_luck}"

        concerns_info = "未指定具体关注点"
        if context.concerns:
            concerns_info = "、".join(context.concerns)

        interview_info = context.interview_summary or "用户正在探索自我认知"

        # 计算未来日期
        future_date = datetime.now().replace(year=datetime.now().year + context.future_years)
        future_date_str = future_date.strftime("%Y年%m月%d日")

        # 构建提示词
        prompt = LETTER_GENERATION_PROMPT.format(
            day_master=context.day_master,
            day_master_element=context.day_master_element,
            current_luck_info=current_luck_info,
            concerns_info=concerns_info,
            interview_info=interview_info,
            persona_style=persona_config.system_prompt_suffix,
            future_years=context.future_years,
            future_date=future_date_str,
            letter_opening=persona_config.letter_opening,
        )

        try:
            # 调用 LLM 生成
            response = await self.llm.chat(
                messages=[create_user_message(prompt)],
                temperature=0.8,  # 更有创意
                max_tokens=2000,
            )

            return response.content.strip()

        except Exception as e:
            logger.error(f"Letter generation failed: {e}")
            # 返回默认信件
            return self._generate_fallback_letter(context, persona_config.letter_opening, future_date_str)

    def _generate_fallback_letter(
        self,
        context: LetterContext,
        opening: str,
        future_date: str
    ) -> str:
        """生成备用信件（当 LLM 失败时）"""
        metaphor = ELEMENT_METAPHORS.get(context.day_master_element, "一个独特的存在")

        return f"""{opening}

───────────────────────────────────

先说说我对你的了解吧。

你是{context.day_master}{context.day_master_element}日主，骨子里住着{metaphor}。
这种特质让你既渴望成长，又需要扎根的安全感。
这两种力量有时候会在你内心拉扯，让你感到矛盾。

我知道你现在可能正在经历一些困惑。
这是完全正常的。
每一个转折点都会带来迷茫，但也孕育着机会。

───────────────────────────────────

{context.future_years}年后的我想告诉你：

你现在经历的一切，都在为未来做准备。
那些看似困难的时刻，其实是成长的养分。

所以，不要急。
也不要因为现在的困难就怀疑自己。

你值得被深度理解。
而我，永远站在你身边。

                                          来自{context.future_years}年后的你
                                          {future_date}"""

    async def generate_letter_preview(self, context: LetterContext) -> str:
        """生成信件预览（只有开篇部分）"""
        persona_config = self.persona_service.get_config(context.persona_type)
        return persona_config.letter_opening


# Global instance
_letter_service: Optional[LetterService] = None


def get_letter_service() -> LetterService:
    """Get or create global letter service instance"""
    global _letter_service
    if _letter_service is None:
        _letter_service = LetterService()
    return _letter_service
