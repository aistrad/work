'use client'

/**
 * Conversion Step - Stage 7
 *
 * 转化付费墙：按地区自动适配注册/支付
 * 目标：5% 转化率
 */

import { useState, useEffect } from 'react'
import { motion } from 'framer-motion'
import { Check, CreditCard, Smartphone, ArrowRight, MessageCircle } from 'lucide-react'
import { useRouter } from 'next/navigation'
import { useOnboarding } from '../context'

// 检测用户地区
type Region = 'mainland' | 'overseas'

const detectRegion = (): Region => {
  // 简化检测：基于语言/时区
  if (typeof window !== 'undefined') {
    const lang = navigator.language.toLowerCase()
    const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone

    if (lang.includes('zh-cn') || timezone.includes('Shanghai') || timezone.includes('Beijing')) {
      return 'mainland'
    }
  }
  return 'overseas'
}

// 付费权益
const BENEFITS = [
  { text: '完整深度报告（3000+ 字）', highlight: true },
  { text: '人生 K 线图 - 过去10年到未来10年', highlight: true },
  { text: '三元棱镜分析 - 内在/核心/外在', highlight: false },
  { text: 'AI 生图海报 - 专属命盘艺术品', highlight: true },
  { text: '首月 Pro 会员', highlight: false },
  { text: '无限 AI 对话', highlight: false },
  { text: '每日/每周/每月运势推送', highlight: false },
]

export default function ConversionStep() {
  const router = useRouter()
  const { state } = useOnboarding()

  const [region, setRegion] = useState<Region>('overseas')
  const [phone, setPhone] = useState('')
  const [verificationCode, setVerificationCode] = useState('')
  const [email, setEmail] = useState('')
  const [isCodeSent, setIsCodeSent] = useState(false)
  const [countdown, setCountdown] = useState(0)
  const [selectedPayment, setSelectedPayment] = useState<string | null>(null)

  // Detect region on mount
  useEffect(() => {
    setRegion(detectRegion())
  }, [])

  // Countdown timer
  useEffect(() => {
    if (countdown > 0) {
      const timer = setTimeout(() => setCountdown(countdown - 1), 1000)
      return () => clearTimeout(timer)
    }
  }, [countdown])

  // Send verification code
  const handleSendCode = () => {
    if (phone.length >= 11) {
      setIsCodeSent(true)
      setCountdown(60)
      // TODO: Call API to send code
    }
  }

  // Handle payment
  const handlePayment = (method: string) => {
    setSelectedPayment(method)
    // TODO: Integrate payment API
    // For now, redirect to chat after "payment"
    setTimeout(() => {
      router.push('/bazi/chat')
    }, 1500)
  }

  // Skip to free chat
  const handleSkip = () => {
    router.push('/bazi/chat')
  }

  // OAuth handlers
  const handleGoogleAuth = () => {
    // TODO: Implement Google OAuth
    console.log('Google auth')
  }

  const handleAppleAuth = () => {
    // TODO: Implement Apple OAuth
    console.log('Apple auth')
  }

  const price = region === 'mainland' ? '¥19.9' : '$2.99'

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="w-full max-w-lg"
    >
      {/* Title */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        className="text-center mb-6"
      >
        <h2 className="font-serif text-2xl font-bold text-foreground mb-2">
          解锁你的完整人生画像
        </h2>
      </motion.div>

      {/* Benefits Card */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
        className="bg-card/80 backdrop-blur-sm border border-border rounded-2xl p-6 mb-6"
      >
        <p className="text-sm font-medium text-foreground mb-4">你将获得：</p>
        <ul className="space-y-3">
          {BENEFITS.map((benefit, index) => (
            <motion.li
              key={index}
              initial={{ opacity: 0, x: -10 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.2 + index * 0.05 }}
              className="flex items-start gap-3"
            >
              <Check className={`w-5 h-5 flex-shrink-0 ${benefit.highlight ? 'text-skill-primary' : 'text-green-500'}`} />
              <span className={`text-sm ${benefit.highlight ? 'text-foreground font-medium' : 'text-muted-foreground'}`}>
                {benefit.text}
              </span>
            </motion.li>
          ))}
        </ul>

        {/* Price */}
        <div className="mt-6 pt-6 border-t border-border text-center">
          <p className="text-3xl font-bold text-foreground">{price}</p>
          <p className="text-sm text-muted-foreground mt-1">
            首月到期后不自动续费
          </p>
        </div>
      </motion.div>

      {/* Auth & Payment Section */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.3 }}
        className="bg-card/80 backdrop-blur-sm border border-border rounded-2xl p-6"
      >
        {region === 'mainland' ? (
          // 大陆用户界面
          <div className="space-y-4">
            {/* Phone Input */}
            <div>
              <label className="block text-sm font-medium text-foreground mb-2">
                手机号注册并支付
              </label>
              <div className="flex gap-2">
                <div className="flex-1 relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">+86</span>
                  <input
                    type="tel"
                    value={phone}
                    onChange={e => setPhone(e.target.value.replace(/\D/g, '').slice(0, 11))}
                    placeholder="请输入手机号"
                    className="w-full pl-12 pr-4 py-3 bg-background border border-border rounded-xl focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary"
                  />
                </div>
                <button
                  onClick={handleSendCode}
                  disabled={phone.length < 11 || countdown > 0}
                  className={`px-4 py-3 rounded-xl text-sm font-medium transition-all ${
                    phone.length >= 11 && countdown === 0
                      ? 'bg-skill-primary text-white'
                      : 'bg-muted text-muted-foreground'
                  }`}
                >
                  {countdown > 0 ? `${countdown}s` : '获取验证码'}
                </button>
              </div>
            </div>

            {/* Verification Code */}
            {isCodeSent && (
              <motion.div
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
              >
                <input
                  type="text"
                  value={verificationCode}
                  onChange={e => setVerificationCode(e.target.value.replace(/\D/g, '').slice(0, 6))}
                  placeholder="请输入验证码"
                  className="w-full px-4 py-3 bg-background border border-border rounded-xl focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary"
                />
              </motion.div>
            )}

            {/* Payment Methods */}
            <div className="pt-4 border-t border-border">
              <p className="text-sm text-muted-foreground mb-3">选择支付方式</p>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => handlePayment('wechat')}
                  className={`p-4 rounded-xl border-2 transition-all flex items-center justify-center gap-2 ${
                    selectedPayment === 'wechat'
                      ? 'border-green-500 bg-green-500/10'
                      : 'border-border hover:border-green-500/50'
                  }`}
                >
                  <svg className="w-6 h-6 text-green-500" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8.691 2.188C3.891 2.188 0 5.476 0 9.53c0 2.212 1.17 4.203 3.002 5.55a.59.59 0 01.213.665l-.39 1.48c-.019.07-.048.141-.048.213 0 .163.13.295.29.295a.32.32 0 00.167-.054l1.903-1.114a.86.86 0 01.58-.112 9.2 9.2 0 002.974.489c.178 0 .351-.012.528-.022-.114-.38-.177-.778-.177-1.19 0-3.372 3.154-6.11 7.048-6.11.244 0 .484.012.722.03C15.848 5.476 12.698 2.188 8.691 2.188zm-2.37 4.202a1.07 1.07 0 110 2.14 1.07 1.07 0 010-2.14zm4.74 0a1.07 1.07 0 110 2.14 1.07 1.07 0 010-2.14z"/>
                    <path d="M23.09 14.773c0-3.232-3.154-5.856-7.048-5.856s-7.048 2.624-7.048 5.856c0 3.233 3.154 5.857 7.048 5.857.69 0 1.359-.082 1.993-.223a.7.7 0 01.468.088l1.503.875a.26.26 0 00.134.045.23.23 0 00.23-.232c0-.058-.022-.116-.039-.172l-.308-1.159a.48.48 0 01.172-.535c1.449-1.067 2.895-2.59 2.895-4.544zM13.507 14.16a.853.853 0 110-1.706.853.853 0 010 1.706zm5.016 0a.853.853 0 110-1.706.853.853 0 010 1.706z"/>
                  </svg>
                  <span className="font-medium">微信支付</span>
                </button>
                <button
                  onClick={() => handlePayment('alipay')}
                  className={`p-4 rounded-xl border-2 transition-all flex items-center justify-center gap-2 ${
                    selectedPayment === 'alipay'
                      ? 'border-blue-500 bg-blue-500/10'
                      : 'border-border hover:border-blue-500/50'
                  }`}
                >
                  <svg className="w-6 h-6 text-blue-500" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.422 19.754c-3.398-1.168-5.903-2.498-5.903-2.498s.7-1.922.953-3.482h-4.25v-1.313h5.016v-.8h-5.016V9.915h5.016v-.8h-5.016V7.35h-1.8v1.765H4.406v.8h5.016v1.746H4.406v.8h5.016v1.313H5.172v.8h8.578c-.2.846-.5 1.778-.953 2.678 0 0-4.5-1.51-7.97-.568C1.857 17.6 0 19.754 0 19.754V22.4h24v-2.646s-.563-.342-3.578 0z"/>
                  </svg>
                  <span className="font-medium">支付宝</span>
                </button>
              </div>
            </div>
          </div>
        ) : (
          // 海外用户界面
          <div className="space-y-4">
            {/* OAuth Buttons */}
            <button
              onClick={handleGoogleAuth}
              className="w-full p-4 rounded-xl border-2 border-border hover:border-skill-primary/50 transition-all flex items-center justify-center gap-3"
            >
              <svg className="w-5 h-5" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
              </svg>
              <span className="font-medium">Continue with Google</span>
            </button>

            <button
              onClick={handleAppleAuth}
              className="w-full p-4 rounded-xl border-2 border-border hover:border-skill-primary/50 transition-all flex items-center justify-center gap-3"
            >
              <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/>
              </svg>
              <span className="font-medium">Continue with Apple</span>
            </button>

            <div className="relative">
              <div className="absolute inset-0 flex items-center">
                <div className="w-full border-t border-border"></div>
              </div>
              <div className="relative flex justify-center text-xs">
                <span className="px-2 bg-card text-muted-foreground">or</span>
              </div>
            </div>

            {/* Email Input */}
            <div>
              <input
                type="email"
                value={email}
                onChange={e => setEmail(e.target.value)}
                placeholder="Email address"
                className="w-full px-4 py-3 bg-background border border-border rounded-xl focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary"
              />
            </div>

            {/* Payment Methods */}
            <div className="pt-4 border-t border-border">
              <p className="text-sm text-muted-foreground mb-3">Payment method</p>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => handlePayment('card')}
                  className={`p-4 rounded-xl border-2 transition-all flex items-center justify-center gap-2 ${
                    selectedPayment === 'card'
                      ? 'border-skill-primary bg-skill-primary/10'
                      : 'border-border hover:border-skill-primary/50'
                  }`}
                >
                  <CreditCard className="w-5 h-5 text-skill-primary" />
                  <span className="font-medium">Credit Card</span>
                </button>
                <button
                  onClick={() => handlePayment('paypal')}
                  className={`p-4 rounded-xl border-2 transition-all flex items-center justify-center gap-2 ${
                    selectedPayment === 'paypal'
                      ? 'border-blue-600 bg-blue-600/10'
                      : 'border-border hover:border-blue-600/50'
                  }`}
                >
                  <svg className="w-5 h-5 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M7.076 21.337H2.47a.641.641 0 01-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42a3.35 3.35 0 00-.607-.541c-.013.076-.026.175-.041.254-.93 4.778-4.005 7.201-9.138 7.201h-2.19a.563.563 0 00-.556.479l-1.187 7.527h-.506l-.24 1.516a.56.56 0 00.554.647h3.882c.46 0 .85-.334.922-.788.06-.26.76-4.852.816-5.09a.932.932 0 01.923-.788h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.777-4.471z"/>
                  </svg>
                  <span className="font-medium">PayPal</span>
                </button>
              </div>
            </div>
          </div>
        )}
      </motion.div>

      {/* Skip Option */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.5 }}
        className="mt-6 text-center"
      >
        <button
          onClick={handleSkip}
          className="text-sm text-muted-foreground hover:text-foreground transition-colors flex items-center justify-center gap-2 mx-auto"
        >
          <MessageCircle className="w-4 h-4" />
          不急？可以继续免费聊天
          <ArrowRight className="w-4 h-4" />
        </button>
      </motion.div>

      {/* Loading Overlay */}
      {selectedPayment && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="fixed inset-0 bg-background/80 backdrop-blur-sm flex items-center justify-center z-50"
        >
          <div className="text-center">
            <div className="w-12 h-12 border-4 border-skill-primary border-t-transparent rounded-full animate-spin mx-auto mb-4" />
            <p className="text-foreground font-medium">正在处理支付...</p>
          </div>
        </motion.div>
      )}
    </motion.div>
  )
}
