"""
Bazi API Routes - Chinese Four Pillars of Destiny
Based on: vibelife spec v3.0

Endpoints:
- POST /api/v1/bazi/chart - Calculate bazi chart
"""

import logging
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import Optional

from services.bazi import BaziCalculator

logger = logging.getLogger(__name__)
router = APIRouter(prefix="/bazi", tags=["bazi"])


class ChartRequest(BaseModel):
    """Request for bazi chart calculation"""
    birth_date: str = Field(..., description="Birth date in YYYY-MM-DD format")
    birth_time: str = Field(default="12:00", description="Birth time in HH:MM format")
    gender: str = Field(default="unknown", description="Gender: male, female, or unknown")


class ChartResponse(BaseModel):
    """Response for bazi chart"""
    success: bool
    chart: Optional[dict] = None
    error: Optional[str] = None


@router.post("/chart", response_model=ChartResponse)
async def calculate_chart(request: ChartRequest):
    """
    Calculate Bazi (Four Pillars) chart.

    Returns complete chart with:
    - Four Pillars (年月日时柱)
    - Day Master (日主)
    - Ten Gods (十神)
    - Five Elements distribution (五行分布)
    - Pattern (格局)
    """
    try:
        calculator = BaziCalculator()
        chart = calculator.calculate(
            birth_date=request.birth_date,
            birth_time=request.birth_time,
            gender=request.gender,
        )

        return ChartResponse(
            success=True,
            chart=chart.to_dict(),
        )

    except Exception as e:
        logger.error(f"Bazi chart calculation failed: {e}")
        return ChartResponse(
            success=False,
            error=str(e),
        )
