#!/bin/bash
# Start API server and run tests

cd /home/aiscend/work/vibelife/apps/api

# Set environment variables
export GLM_API_KEY="42b82ed9a13e4e8890ef3854bb840ef8.TcWZ4DIq0NF2xElF"
export GLM_CHAT_MODEL="glm-4.7"
export GLM_BASE_URL="https://open.bigmodel.cn/api/paas/v4"
export DEFAULT_LLM_PROVIDER="glm"
export VIBELIFE_DB_URL="postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife"

# Kill any existing server
pkill -f "uvicorn main:app" 2>/dev/null || true
sleep 2

# Start server
echo "Starting API server..."
nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8000 > /tmp/vibelife_api.log 2>&1 &
SERVER_PID=$!
echo "Server PID: $SERVER_PID"

# Wait for server to start
sleep 5

# Check if server is running
if ! kill -0 $SERVER_PID 2>/dev/null; then
    echo "Server failed to start. Log output:"
    cat /tmp/vibelife_api.log
    exit 1
fi

# Test endpoints
echo ""
echo "Testing health endpoint..."
curl -s http://localhost:8000/health

echo ""
echo "Testing chat/guest endpoint..."
curl -s -X POST http://localhost:8000/api/v1/chat/guest \
    -H "Content-Type: application/json" \
    -d '{"message": "你好，我想了解一下八字", "skill": "bazi"}'

echo ""
echo "Server is running. Log:"
tail -20 /tmp/vibelife_api.log
