-- VibeLife v3.0 Database Schema
-- Based on spec v3.0.md
-- Created: 2026-01-07

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "vector";

-- ============================================================================
-- USERS & AUTHENTICATION
-- ============================================================================

-- Users table - core user identity
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vibe_id VARCHAR(50) UNIQUE NOT NULL,  -- 用户唯一标识 (e.g., VIBE-XXXX)
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(20) UNIQUE,
    name VARCHAR(100),
    avatar_url TEXT,
    is_guest BOOLEAN DEFAULT TRUE,  -- 游客状态
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- User authentication methods (email, phone, wechat, apple, google)
CREATE TABLE IF NOT EXISTS user_auth (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    auth_type VARCHAR(20) NOT NULL,  -- email | phone | wechat | apple | google
    auth_identifier VARCHAR(255) NOT NULL,  -- email/phone/openid
    password_hash VARCHAR(255),  -- for email/phone auth
    metadata JSONB DEFAULT '{}',  -- additional auth data
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(auth_type, auth_identifier)
);

-- ============================================================================
-- USER PROFILE (按 spec 4.4 设计)
-- ============================================================================

-- User profiles with versioning (JSONB storage)
CREATE TABLE IF NOT EXISTS user_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    version INT DEFAULT 1,
    profile JSONB NOT NULL DEFAULT '{
        "version": "1.0",
        "basic": {},
        "life_context": {},
        "ai_insights": {},
        "identity_prism": {},
        "preferences": {
            "voice_mode": "warm",
            "language": "zh-CN"
        }
    }',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(user_id, version)
);

-- ============================================================================
-- CONVERSATIONS & MESSAGES
-- ============================================================================

-- Conversation sessions
CREATE TABLE IF NOT EXISTS conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac')),
    voice_mode VARCHAR(20) DEFAULT 'warm' CHECK (voice_mode IN ('warm', 'sarcastic')),
    title VARCHAR(255),  -- 会话标题（可选）
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Chat messages
CREATE TABLE IF NOT EXISTS messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
    content TEXT NOT NULL,
    metadata JSONB DEFAULT '{}',  -- tool calls, extracted info, etc.
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- REPORTS
-- ============================================================================

-- Generated reports
CREATE TABLE IF NOT EXISTS reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac')),
    report_type VARCHAR(20) NOT NULL CHECK (report_type IN ('brief', 'full')),

    -- 报告内容 (结构化 JSON)
    content JSONB NOT NULL DEFAULT '{}',
    -- 卷首语 (综合判断)
    prologue TEXT,
    -- AI 生图 URL
    image_url TEXT,
    image_thumbnail_url TEXT,

    -- 付费状态
    is_paid BOOLEAN DEFAULT FALSE,

    -- 元数据
    interview_data JSONB,  -- AI 访谈数据
    generation_metadata JSONB,  -- 生成时的配置

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- RELATIONSHIPS (关系模拟器)
-- ============================================================================

-- Relationship analysis records
CREATE TABLE IF NOT EXISTS relationships (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

    -- 发起者
    initiator_id UUID REFERENCES users(id) ON DELETE SET NULL,

    -- 对方 (可以是注册用户或匿名信息)
    partner_id UUID REFERENCES users(id) ON DELETE SET NULL,
    partner_info JSONB,  -- 单人模式下对方的基本信息

    -- 分析配置
    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac')),
    relationship_type VARCHAR(50),  -- romantic | friend | family | work

    -- 分析结果
    analysis JSONB NOT NULL DEFAULT '{}',
    action_tips JSONB DEFAULT '[]',  -- 行动建议列表

    -- Vibe Link 分享
    share_token VARCHAR(100) UNIQUE,
    privacy_level VARCHAR(20) DEFAULT 'private' CHECK (privacy_level IN ('private', 'basic', 'detailed')),

    -- 付费状态
    is_paid BOOLEAN DEFAULT FALSE,
    image_url TEXT,  -- 关系海报

    created_at TIMESTAMPTZ DEFAULT NOW(),
    expires_at TIMESTAMPTZ  -- Vibe Link 过期时间
);

-- ============================================================================
-- KNOWLEDGE BASE (向量存储)
-- ============================================================================

-- Knowledge chunks for RAG
CREATE TABLE IF NOT EXISTS knowledge_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac', 'shared')),
    category VARCHAR(100),  -- e.g., "十神", "格局", "星座特质"
    subcategory VARCHAR(100),

    -- 内容
    title VARCHAR(255),
    content TEXT NOT NULL,

    -- 向量 (BGE-M3, 1024 维)
    embedding vector(1024),

    -- 元数据
    source VARCHAR(255),  -- 来源文件
    metadata JSONB DEFAULT '{}',

    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- SUBSCRIPTIONS & PAYMENTS
-- ============================================================================

-- Subscription plans
CREATE TABLE IF NOT EXISTS subscription_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    code VARCHAR(50) UNIQUE NOT NULL,  -- monthly | yearly
    name VARCHAR(100) NOT NULL,
    description TEXT,
    price_cents INT NOT NULL,  -- 单位：分
    currency VARCHAR(10) DEFAULT 'CNY',
    duration_days INT NOT NULL,  -- 有效期天数
    features JSONB DEFAULT '[]',
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- User subscriptions
CREATE TABLE IF NOT EXISTS subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan_id VARCHAR(50) REFERENCES subscription_plans(id),
    plan_code VARCHAR(50) NOT NULL,

    status VARCHAR(20) NOT NULL CHECK (status IN ('active', 'canceled', 'expired', 'trial')),

    started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMPTZ NOT NULL,
    canceled_at TIMESTAMPTZ,

    -- 来源
    source VARCHAR(50),  -- report_purchase | direct | promo

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Payment records
CREATE TABLE IF NOT EXISTS payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,

    -- 产品信息
    product_type VARCHAR(50) NOT NULL,  -- report | subscription | relationship
    product_id UUID,

    -- 金额
    amount_cents INT NOT NULL,  -- 单位：分
    currency VARCHAR(10) DEFAULT 'CNY',

    -- 状态
    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'success', 'failed', 'refunded')),

    -- 支付渠道
    provider VARCHAR(20),  -- wechat | alipay | stripe
    provider_payment_id VARCHAR(255),
    provider_metadata JSONB DEFAULT '{}',

    -- 回调
    paid_at TIMESTAMPTZ,

    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- DAILY GREETING & FORTUNE
-- ============================================================================

-- Pre-generated daily greetings cache
CREATE TABLE IF NOT EXISTS daily_greetings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    date DATE NOT NULL,
    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac', 'shared')),

    -- 内容
    greeting TEXT NOT NULL,
    fortune_hint TEXT,
    celestial_event TEXT,  -- 天象事件
    solar_term VARCHAR(50),  -- 节气

    -- 元数据
    metadata JSONB DEFAULT '{}',

    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(date, skill)
);

-- ============================================================================
-- INSIGHTS (洞察卡片)
-- ============================================================================

-- User insights collected from conversations
CREATE TABLE IF NOT EXISTS insights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    conversation_id UUID REFERENCES conversations(id) ON DELETE SET NULL,

    -- 洞察类型
    insight_type VARCHAR(50) NOT NULL,  -- discovery | pattern | timing | growth

    -- 内容
    title VARCHAR(255),
    content TEXT NOT NULL,

    -- 来源
    source_skill VARCHAR(20),
    source_context TEXT,  -- 相关对话片段

    -- 状态
    is_bookmarked BOOLEAN DEFAULT FALSE,
    is_shared BOOLEAN DEFAULT FALSE,

    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- ANALYTICS & EVENTS
-- ============================================================================

-- User events for analytics
CREATE TABLE IF NOT EXISTS user_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    session_id VARCHAR(100),

    -- 事件信息
    event_name VARCHAR(100) NOT NULL,
    event_data JSONB DEFAULT '{}',

    -- 来源
    source VARCHAR(50),  -- web | mobile | api
    user_agent TEXT,
    ip_address INET,

    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- INDEXES
-- ============================================================================

-- Users
CREATE INDEX IF NOT EXISTS idx_users_vibe_id ON users(vibe_id);
CREATE INDEX IF NOT EXISTS idx_users_email ON users(email) WHERE email IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_users_phone ON users(phone) WHERE phone IS NOT NULL;

-- User Auth
CREATE INDEX IF NOT EXISTS idx_user_auth_user ON user_auth(user_id);

-- User Profiles
CREATE INDEX IF NOT EXISTS idx_user_profiles_user ON user_profiles(user_id);
CREATE INDEX IF NOT EXISTS idx_user_profiles_latest ON user_profiles(user_id, version DESC);

-- Conversations
CREATE INDEX IF NOT EXISTS idx_conversations_user ON conversations(user_id);
CREATE INDEX IF NOT EXISTS idx_conversations_skill ON conversations(skill);
CREATE INDEX IF NOT EXISTS idx_conversations_active ON conversations(user_id, is_active) WHERE is_active = TRUE;

-- Messages
CREATE INDEX IF NOT EXISTS idx_messages_conversation ON messages(conversation_id);
CREATE INDEX IF NOT EXISTS idx_messages_created ON messages(conversation_id, created_at);

-- Reports
CREATE INDEX IF NOT EXISTS idx_reports_user ON reports(user_id);
CREATE INDEX IF NOT EXISTS idx_reports_skill ON reports(skill);

-- Relationships
CREATE INDEX IF NOT EXISTS idx_relationships_initiator ON relationships(initiator_id);
CREATE INDEX IF NOT EXISTS idx_relationships_partner ON relationships(partner_id) WHERE partner_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_relationships_token ON relationships(share_token) WHERE share_token IS NOT NULL;

-- Knowledge
CREATE INDEX IF NOT EXISTS idx_knowledge_skill ON knowledge_chunks(skill);
CREATE INDEX IF NOT EXISTS idx_knowledge_category ON knowledge_chunks(skill, category);
CREATE INDEX IF NOT EXISTS idx_knowledge_embedding ON knowledge_chunks USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

-- Subscriptions
CREATE INDEX IF NOT EXISTS idx_subscriptions_user ON subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_active ON subscriptions(user_id, status) WHERE status = 'active';

-- Payments
CREATE INDEX IF NOT EXISTS idx_payments_user ON payments(user_id);
CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);

-- Daily Greetings
CREATE INDEX IF NOT EXISTS idx_daily_greetings_date ON daily_greetings(date, skill);

-- Insights
CREATE INDEX IF NOT EXISTS idx_insights_user ON insights(user_id);
CREATE INDEX IF NOT EXISTS idx_insights_bookmarked ON insights(user_id, is_bookmarked) WHERE is_bookmarked = TRUE;

-- Events
CREATE INDEX IF NOT EXISTS idx_events_user ON user_events(user_id);
CREATE INDEX IF NOT EXISTS idx_events_name ON user_events(event_name);
CREATE INDEX IF NOT EXISTS idx_events_created ON user_events(created_at);

-- ============================================================================
-- INITIAL DATA
-- ============================================================================

-- Insert default subscription plans
INSERT INTO subscription_plans (code, name, description, price_cents, duration_days, features) VALUES
    ('monthly', '月度订阅', '每月订阅，畅享所有高级功能', 1990, 30, '["无限报告生成", "无限对话", "Identity Prism", "人生K线", "关系分析"]'),
    ('yearly', '年度订阅', '年度订阅，省80元', 15900, 365, '["无限报告生成", "无限对话", "Identity Prism", "人生K线", "关系分析", "优先支持"]')
ON CONFLICT (code) DO NOTHING;

-- ============================================================================
-- FUNCTIONS & TRIGGERS
-- ============================================================================

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Apply updated_at trigger to relevant tables
DROP TRIGGER IF EXISTS update_users_updated_at ON users;
CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON users
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_conversations_updated_at ON conversations;
CREATE TRIGGER update_conversations_updated_at
    BEFORE UPDATE ON conversations
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_reports_updated_at ON reports;
CREATE TRIGGER update_reports_updated_at
    BEFORE UPDATE ON reports
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_subscriptions_updated_at ON subscriptions;
CREATE TRIGGER update_subscriptions_updated_at
    BEFORE UPDATE ON subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

DROP TRIGGER IF EXISTS update_payments_updated_at ON payments;
CREATE TRIGGER update_payments_updated_at
    BEFORE UPDATE ON payments
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();

-- Function to generate vibe_id
CREATE OR REPLACE FUNCTION generate_vibe_id()
RETURNS VARCHAR(50) AS $$
DECLARE
    chars VARCHAR(36) := 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    result VARCHAR(50) := 'VIBE-';
    i INTEGER;
BEGIN
    FOR i IN 1..8 LOOP
        result := result || substr(chars, floor(random() * length(chars) + 1)::int, 1);
    END LOOP;
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- Trigger to auto-generate vibe_id on user creation
CREATE OR REPLACE FUNCTION auto_generate_vibe_id()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.vibe_id IS NULL OR NEW.vibe_id = '' THEN
        NEW.vibe_id := generate_vibe_id();
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_auto_vibe_id ON users;
CREATE TRIGGER trigger_auto_vibe_id
    BEFORE INSERT ON users
    FOR EACH ROW
    EXECUTE FUNCTION auto_generate_vibe_id();

-- ============================================================================
-- COMMENTS
-- ============================================================================

COMMENT ON TABLE users IS 'Core user identity table';
COMMENT ON TABLE user_profiles IS 'User profiles with versioning, stores complete profile JSON';
COMMENT ON TABLE conversations IS 'Chat conversation sessions';
COMMENT ON TABLE messages IS 'Individual chat messages';
COMMENT ON TABLE reports IS 'Generated analysis reports (brief/full)';
COMMENT ON TABLE relationships IS 'Relationship analysis records with Vibe Link sharing';
COMMENT ON TABLE knowledge_chunks IS 'RAG knowledge base with vector embeddings';
COMMENT ON TABLE subscriptions IS 'User subscription records';
COMMENT ON TABLE payments IS 'Payment transaction records';
COMMENT ON TABLE daily_greetings IS 'Pre-generated daily greetings cache';
COMMENT ON TABLE insights IS 'User insights extracted from conversations';
COMMENT ON TABLE user_events IS 'Analytics events tracking';

-- ============================================================================
-- DONE
-- ============================================================================

SELECT 'VibeLife v3.0 Schema created successfully!' as status;
