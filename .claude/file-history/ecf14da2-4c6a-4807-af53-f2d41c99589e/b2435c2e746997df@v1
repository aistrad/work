import json
from typing import Dict, Any

try:
    import jsonschema
except Exception:  # 运行时可能未安装；在集成测试中再严格校验
    jsonschema = None


CARD_SCHEMAS: Dict[str, Dict[str, Any]] = {
    "skill_list": {
        "type": "object",
        "properties": {
            "skills": {
                "type": "array",
                "items": {
                    "type": "object",
                    "required": ["id", "name"],
                    "properties": {
                        "id": {"type": "string"},
                        "name": {"type": "string"},
                        "description": {"type": "string"}
                    }
                }
            }
        },
        "required": ["skills"]
    },
    "skill_recommendation": {
        "type": "object",
        "required": ["skill_id", "skill"],
        "properties": {
            "skill_id": {"type": "string"},
            "skill": {"type": "object"},
            "reason": {"type": "string"}
        }
    },
    "protocol_invitation": {
        "type": "object",
        "required": ["protocol_id", "title", "estimated_time"],
        "properties": {
            "protocol_id": {"type": "string"},
            "title": {"type": "string"},
            "description": {"type": "string"},
            "estimated_time": {"type": "string"},
            "total_steps": {"type": "integer"}
        }
    },
    "insight_card": {
        "type": "object",
        "required": ["title", "content"],
        "properties": {
            "title": {"type": "string"},
            "content": {"type": "string"}
        }
    },
    "dankoe_result": {
        "type": "object",
        "required": ["vision", "anti_vision", "game_elements"],
        "properties": {
            "vision": {
                "type": "object",
                "properties": {
                    "statement": {"type": "string"},
                    "scene": {"type": "string"},
                    "identity": {"type": "string"}
                }
            },
            "anti_vision": {
                "type": "object",
                "properties": {
                    "statement": {"type": "string"},
                    "scene": {"type": "string"}
                }
            },
            "game_elements": {
                "type": "object",
                "properties": {
                    "main_mission": {"type": "string"},
                    "daily_quests": {"type": "array", "items": {"type": "string"}},
                    "rules": {"type": "array", "items": {"type": "string"}}
                }
            }
        }
    }
}


def validate_card(card_type: str, data: Dict[str, Any]) -> None:
    """Validate card payload; no-op if jsonschema missing or schema absent."""
    if jsonschema is None:
        return
    schema = CARD_SCHEMAS.get(card_type)
    if not schema:
        return
    jsonschema.validate(data, schema)

