"""
Document Converters - Convert various formats to Markdown
Supported: PDF, EPUB, DOCX, HTML, MD, TXT
"""
import os
import logging
from pathlib import Path
from typing import Optional
from abc import ABC, abstractmethod

logger = logging.getLogger(__name__)


class BaseConverter(ABC):
    """Base class for document converters"""

    @abstractmethod
    def convert(self, file_path: str) -> str:
        """Convert file to Markdown"""
        pass

    @property
    @abstractmethod
    def supported_extensions(self) -> list[str]:
        """List of supported file extensions"""
        pass


class MarkdownConverter(BaseConverter):
    """Pass-through converter for MD/TXT files"""

    @property
    def supported_extensions(self) -> list[str]:
        return [".md", ".txt", ".markdown"]

    def convert(self, file_path: str) -> str:
        with open(file_path, "r", encoding="utf-8") as f:
            return f.read()


class PDFConverter(BaseConverter):
    """PDF to Markdown using pymupdf4llm"""

    @property
    def supported_extensions(self) -> list[str]:
        return [".pdf"]

    def convert(self, file_path: str) -> str:
        try:
            import pymupdf4llm
            md_text = pymupdf4llm.to_markdown(file_path)
            return md_text
        except ImportError:
            logger.error("pymupdf4llm not installed. Run: pip install pymupdf4llm")
            raise
        except Exception as e:
            logger.error(f"PDF conversion failed for {file_path}: {e}")
            raise


class EPUBConverter(BaseConverter):
    """EPUB to Markdown using ebooklib + BeautifulSoup"""

    @property
    def supported_extensions(self) -> list[str]:
        return [".epub"]

    def convert(self, file_path: str) -> str:
        try:
            import ebooklib
            from ebooklib import epub
            from bs4 import BeautifulSoup
            import html2text

            book = epub.read_epub(file_path)
            h2t = html2text.HTML2Text()
            h2t.ignore_links = False
            h2t.ignore_images = True
            h2t.body_width = 0  # No line wrapping

            chapters = []

            for item in book.get_items():
                if item.get_type() == ebooklib.ITEM_DOCUMENT:
                    soup = BeautifulSoup(item.get_content(), "lxml")

                    # Extract title if present
                    title = soup.find("title")
                    title_text = title.get_text().strip() if title else ""

                    # Get body content
                    body = soup.find("body")
                    if body:
                        html_content = str(body)
                        md_content = h2t.handle(html_content)

                        if title_text and not md_content.startswith(f"# {title_text}"):
                            md_content = f"# {title_text}\n\n{md_content}"

                        chapters.append(md_content.strip())

            return "\n\n---\n\n".join(chapters)

        except ImportError as e:
            logger.error(f"Missing dependency for EPUB: {e}")
            raise
        except Exception as e:
            logger.error(f"EPUB conversion failed for {file_path}: {e}")
            raise


class DOCXConverter(BaseConverter):
    """DOCX to Markdown using python-docx"""

    @property
    def supported_extensions(self) -> list[str]:
        return [".docx", ".doc"]

    def convert(self, file_path: str) -> str:
        try:
            from docx import Document
            from docx.enum.text import WD_PARAGRAPH_ALIGNMENT

            doc = Document(file_path)
            md_parts = []

            for para in doc.paragraphs:
                text = para.text.strip()
                if not text:
                    continue

                style_name = para.style.name.lower() if para.style else ""

                # Handle headings
                if "heading 1" in style_name:
                    md_parts.append(f"# {text}")
                elif "heading 2" in style_name:
                    md_parts.append(f"## {text}")
                elif "heading 3" in style_name:
                    md_parts.append(f"### {text}")
                elif "heading 4" in style_name:
                    md_parts.append(f"#### {text}")
                elif "title" in style_name:
                    md_parts.append(f"# {text}")
                else:
                    # Check for bold/italic in runs
                    formatted_text = self._format_runs(para.runs)
                    md_parts.append(formatted_text)

            # Handle tables
            for table in doc.tables:
                md_parts.append(self._table_to_markdown(table))

            return "\n\n".join(md_parts)

        except ImportError:
            logger.error("python-docx not installed. Run: pip install python-docx")
            raise
        except Exception as e:
            logger.error(f"DOCX conversion failed for {file_path}: {e}")
            raise

    def _format_runs(self, runs) -> str:
        """Format paragraph runs with bold/italic"""
        parts = []
        for run in runs:
            text = run.text
            if not text:
                continue
            if run.bold and run.italic:
                text = f"***{text}***"
            elif run.bold:
                text = f"**{text}**"
            elif run.italic:
                text = f"*{text}*"
            parts.append(text)
        return "".join(parts)

    def _table_to_markdown(self, table) -> str:
        """Convert DOCX table to Markdown"""
        rows = []
        for i, row in enumerate(table.rows):
            cells = [cell.text.strip().replace("|", "\\|") for cell in row.cells]
            rows.append("| " + " | ".join(cells) + " |")
            if i == 0:
                # Add header separator
                rows.append("| " + " | ".join(["---"] * len(cells)) + " |")
        return "\n".join(rows)


class HTMLConverter(BaseConverter):
    """HTML to Markdown using html2text"""

    @property
    def supported_extensions(self) -> list[str]:
        return [".html", ".htm"]

    def convert(self, file_path: str) -> str:
        try:
            import html2text
            from bs4 import BeautifulSoup

            with open(file_path, "r", encoding="utf-8") as f:
                html_content = f.read()

            # Clean up HTML first
            soup = BeautifulSoup(html_content, "lxml")

            # Remove script/style tags
            for tag in soup(["script", "style", "nav", "footer", "aside"]):
                tag.decompose()

            # Get main content
            main = soup.find("main") or soup.find("article") or soup.find("body") or soup
            html_clean = str(main)

            # Convert to Markdown
            h2t = html2text.HTML2Text()
            h2t.ignore_links = False
            h2t.ignore_images = True
            h2t.body_width = 0

            return h2t.handle(html_clean)

        except ImportError as e:
            logger.error(f"Missing dependency for HTML: {e}")
            raise
        except Exception as e:
            logger.error(f"HTML conversion failed for {file_path}: {e}")
            raise


class DocumentConverter:
    """
    Unified document converter - auto-detects format and converts to Markdown
    """

    def __init__(self):
        self._converters: list[BaseConverter] = [
            MarkdownConverter(),
            PDFConverter(),
            EPUBConverter(),
            DOCXConverter(),
            HTMLConverter(),
        ]
        self._extension_map: dict[str, BaseConverter] = {}
        for converter in self._converters:
            for ext in converter.supported_extensions:
                self._extension_map[ext.lower()] = converter

    @property
    def supported_extensions(self) -> list[str]:
        """All supported file extensions"""
        return list(self._extension_map.keys())

    def can_convert(self, file_path: str) -> bool:
        """Check if file can be converted"""
        ext = Path(file_path).suffix.lower()
        return ext in self._extension_map

    def convert(self, file_path: str) -> str:
        """
        Convert document to Markdown

        Args:
            file_path: Path to the document

        Returns:
            Markdown content

        Raises:
            ValueError: If file type is not supported
            FileNotFoundError: If file doesn't exist
        """
        path = Path(file_path)

        if not path.exists():
            raise FileNotFoundError(f"File not found: {file_path}")

        ext = path.suffix.lower()
        converter = self._extension_map.get(ext)

        if not converter:
            raise ValueError(
                f"Unsupported file type: {ext}. "
                f"Supported: {', '.join(self.supported_extensions)}"
            )

        logger.info(f"Converting {path.name} using {converter.__class__.__name__}")
        return converter.convert(file_path)

    def get_file_type(self, file_path: str) -> Optional[str]:
        """Get normalized file type from path"""
        ext = Path(file_path).suffix.lower()
        type_map = {
            ".md": "md",
            ".markdown": "md",
            ".txt": "txt",
            ".pdf": "pdf",
            ".epub": "epub",
            ".docx": "docx",
            ".doc": "docx",
            ".html": "html",
            ".htm": "html",
        }
        return type_map.get(ext)
