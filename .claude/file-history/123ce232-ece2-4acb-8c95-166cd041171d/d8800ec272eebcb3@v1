"""
Dashboard API Route - Dashboard æ•°æ®èšåˆç«¯ç‚¹

ä» UnifiedProfileRepository è·å–çœŸå®ç”¨æˆ·æ•°æ®ï¼Œä¸ä½¿ç”¨ä»»ä½• Mock Dataã€‚

æ•°æ®æ¥æº:
- vibe.target: åŒ—ææ˜Ÿã€ç›®æ ‡ã€ä¸“æ³¨ç‚¹
- skills.lifecoach: å‘¨å¤§çŸ³å¤´ã€ä»Šæ—¥æ æ†
- skills.bazi: è¿åŠ¿æ•°æ®
- èŠ‚æ°”: æ ¹æ®æ—¥æœŸè®¡ç®—
"""

import logging
from datetime import datetime, timezone
from typing import Optional
from uuid import UUID

from fastapi import APIRouter, Depends

from services.identity import get_current_user, CurrentUser
from stores.unified_profile_repo import UnifiedProfileRepository

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/dashboard", tags=["Dashboard"])


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Solar Term Calculation
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOLAR_TERMS = [
    (1, 5, "å°å¯’"), (1, 20, "å¤§å¯’"),
    (2, 4, "ç«‹æ˜¥"), (2, 19, "é›¨æ°´"),
    (3, 6, "æƒŠè›°"), (3, 21, "æ˜¥åˆ†"),
    (4, 5, "æ¸…æ˜"), (4, 20, "è°·é›¨"),
    (5, 6, "ç«‹å¤"), (5, 21, "å°æ»¡"),
    (6, 6, "èŠ’ç§"), (6, 21, "å¤è‡³"),
    (7, 7, "å°æš‘"), (7, 23, "å¤§æš‘"),
    (8, 8, "ç«‹ç§‹"), (8, 23, "å¤„æš‘"),
    (9, 8, "ç™½éœ²"), (9, 23, "ç§‹åˆ†"),
    (10, 8, "å¯’éœ²"), (10, 24, "éœœé™"),
    (11, 8, "ç«‹å†¬"), (11, 22, "å°é›ª"),
    (12, 7, "å¤§é›ª"), (12, 22, "å†¬è‡³"),
]


def get_current_solar_term() -> str:
    """æ ¹æ®å½“å‰æ—¥æœŸè·å–èŠ‚æ°”"""
    now = datetime.now()
    month = now.month
    day = now.day

    current_term = "å†¬è‡³"  # é»˜è®¤å€¼

    for m, d, term in SOLAR_TERMS:
        if month > m or (month == m and day >= d):
            current_term = term
        else:
            break

    return current_term


def get_greeting(display_name: Optional[str] = None) -> str:
    """æ ¹æ®æ—¶é—´ç”Ÿæˆé—®å€™è¯­"""
    hour = datetime.now().hour

    if hour < 6:
        greeting = "å¤œæ·±äº†"
    elif hour < 12:
        greeting = "æ—©ä¸Šå¥½"
    elif hour < 18:
        greeting = "ä¸‹åˆå¥½"
    else:
        greeting = "æ™šä¸Šå¥½"

    if display_name:
        greeting = f"{greeting}ï¼Œ{display_name}"

    return greeting


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Dashboard Endpoint
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.get("")
async def get_dashboard(current_user: CurrentUser = Depends(get_current_user)):
    """
    è·å– Dashboard æ•°æ®

    æ•°æ®æ¥æºï¼š
    - ambient: é—®å€™è¯­ã€èŠ‚æ°”ï¼ˆå®æ—¶è®¡ç®—ï¼‰
    - lifecoach: åŒ—ææ˜Ÿã€å‘¨å¤§çŸ³å¤´ã€ä»Šæ—¥æ æ†ï¼ˆæ¥è‡ª vibe.target + skills.lifecoachï¼‰
    - mySkills: å…«å­—è¿åŠ¿ç­‰ï¼ˆæ¥è‡ª skills.baziï¼‰
    - status: ç”¨æˆ·çŠ¶æ€ï¼ˆæ¥è‡ª preferencesï¼‰

    Returns:
        DashboardDTO æ ¼å¼çš„æ•°æ®
    """
    user_id = current_user.user_id

    # å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
    profile = await UnifiedProfileRepository.get_profile(user_id)
    account = await UnifiedProfileRepository.get_account_full(user_id)
    vibe_target = await UnifiedProfileRepository.get_vibe_target(user_id)
    lifecoach_data = await UnifiedProfileRepository.get_skill_data(user_id, "lifecoach")
    bazi_data = await UnifiedProfileRepository.get_skill_data(user_id, "bazi")
    subscribed_ids = await UnifiedProfileRepository.get_subscribed_skill_ids(user_id)

    display_name = account.get("display_name")
    now = datetime.now(timezone.utc)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Ambient Layer
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ambient = {
        "greeting": get_greeting(display_name),
        "quote": None,  # å¯ä»¥ä»ç”¨æˆ·åå¥½æˆ–æ¨èç³»ç»Ÿè·å–
        "date": now.strftime("%Yå¹´%mæœˆ%dæ—¥"),
        "solarTerm": get_current_solar_term(),
    }

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Status Layer
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # ä» preferences æˆ– state è·å–ç­¾åˆ°çŠ¶æ€
    preferences = profile.get("preferences", {}) if profile else {}
    state = profile.get("state", {}) if profile else {}

    status = {
        "streak": preferences.get("streak", 0),
        "checkedIn": state.get("checked_in_today", False),
        "energy": preferences.get("energy", 80),
    }

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Lifecoach Layer
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # åŒ—ææ˜Ÿä¼˜å…ˆä» vibe.targetï¼Œå›é€€åˆ° skills.lifecoach
    north_star = vibe_target.get("north_star")
    if isinstance(north_star, dict):
        north_star = north_star.get("description") or north_star.get("vision")
    elif not north_star:
        north_star = lifecoach_data.get("north_star")
        if isinstance(north_star, dict):
            north_star = north_star.get("description") or north_star.get("vision")

    # å‘¨å¤§çŸ³å¤´ï¼ˆWeek Rocksï¼‰
    week_rocks_raw = vibe_target.get("goals", []) or lifecoach_data.get("week_rocks", [])
    week_rocks = []
    for i, rock in enumerate(week_rocks_raw[:5]):
        if isinstance(rock, dict):
            week_rocks.append({
                "id": rock.get("id", f"rock-{i}"),
                "text": rock.get("text") or rock.get("title") or rock.get("description", ""),
                "role": rock.get("role", ""),
                "completed": rock.get("completed", False),
            })
        elif isinstance(rock, str):
            week_rocks.append({
                "id": f"rock-{i}",
                "text": rock,
                "role": "",
                "completed": False,
            })

    # ä»Šæ—¥æ æ†ï¼ˆToday Leversï¼‰
    today_levers_raw = lifecoach_data.get("today_levers", []) or vibe_target.get("focus", {}).get("tasks", [])
    today_levers = []
    for i, lever in enumerate(today_levers_raw[:5]):
        if isinstance(lever, dict):
            today_levers.append({
                "id": lever.get("id", f"lever-{i}"),
                "text": lever.get("text") or lever.get("title") or lever.get("description", ""),
                "completed": lever.get("completed", False),
            })
        elif isinstance(lever, str):
            today_levers.append({
                "id": f"lever-{i}",
                "text": lever,
                "completed": False,
            })

    lifecoach = {
        "northStar": north_star,
        "monthlyProject": lifecoach_data.get("monthly_project"),
        "todayLevers": today_levers,
        "weekRocks": week_rocks,
    }

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # My Skills Layer (å…«å­—è¿åŠ¿ç­‰)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    my_skills = []

    # å…«å­— Skill å¡ç‰‡
    if bazi_data:
        daily_fortune = bazi_data.get("daily_fortune", {})
        insights = daily_fortune.get("insights", [])
        if not insights:
            # ä» chart åˆ†æä¸­æå–æ´å¯Ÿ
            chart = bazi_data.get("chart", {})
            if chart:
                insights = chart.get("insights", [])

        rating = daily_fortune.get("rating")
        if not rating and daily_fortune.get("score"):
            score = daily_fortune["score"]
            rating = {
                "overall": score,
                "label": "å‰" if score >= 7 else ("ä¸­" if score >= 4 else "å‡¶"),
            }

        my_skills.append({
            "skillId": "bazi",
            "cardId": "bazi-daily",
            "title": "å…«å­—å‘½ç›˜",
            "icon": "ğŸŒŸ",
            "content": {
                "headline": daily_fortune.get("headline") or "æŸ¥çœ‹ä»Šæ—¥è¿åŠ¿",
                "insights": insights[:3] if insights else [],
                "rating": rating,
            },
            "computedAt": daily_fortune.get("computed_at") or now.isoformat(),
            "actionLabel": "æŸ¥çœ‹è¯¦æƒ…",
            "actionRoute": "/chat?skill=bazi",
        })

    # å¯ä»¥æ·»åŠ å…¶ä»–å·²è®¢é˜…çš„ Skill å¡ç‰‡
    # zodiac_data = await UnifiedProfileRepository.get_skill_data(user_id, "zodiac")
    # if zodiac_data and "zodiac" in subscribed_ids: ...

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Discover Layer (æ¨èæœªè®¢é˜…çš„ Skills)
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # è¿™é‡Œå¯ä»¥ä» skill registry è·å–æ¨èï¼Œç›®å‰è¿”å›ç©º
    discover = []

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Response
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    return {
        "success": True,
        "data": {
            "userId": str(user_id),
            "generatedAt": now.isoformat(),
            "ambient": ambient,
            "status": status,
            "lifecoach": lifecoach,
            "mySkills": my_skills,
            "discover": discover,
        },
        "meta": {
            "cached": False,
            "generatedAt": now.isoformat(),
        },
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Lever Toggle Endpoint
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.patch("/lever/{lever_id}")
async def toggle_lever(
    lever_id: str,
    current_user: CurrentUser = Depends(get_current_user)
):
    """
    åˆ‡æ¢ä»Šæ—¥æ æ†å®ŒæˆçŠ¶æ€

    æ›´æ–° skills.lifecoach.today_levers ä¸­å¯¹åº”é¡¹çš„ completed çŠ¶æ€
    """
    user_id = current_user.user_id

    # è·å–å½“å‰ lifecoach æ•°æ®
    lifecoach_data = await UnifiedProfileRepository.get_skill_data(user_id, "lifecoach")
    today_levers = lifecoach_data.get("today_levers", [])

    # æ‰¾åˆ°å¹¶åˆ‡æ¢çŠ¶æ€
    found = False
    for lever in today_levers:
        if isinstance(lever, dict) and lever.get("id") == lever_id:
            lever["completed"] = not lever.get("completed", False)
            found = True
            break

    if not found:
        return {"success": False, "error": "Lever not found"}

    # ä¿å­˜æ›´æ–°
    lifecoach_data["today_levers"] = today_levers
    await UnifiedProfileRepository.update_skill_data(user_id, "lifecoach", lifecoach_data)

    # è®¡ç®—è¿›åº¦
    completed_count = len([l for l in today_levers if isinstance(l, dict) and l.get("completed")])
    total_count = len(today_levers)

    return {
        "success": True,
        "data": {
            "lever": {"id": lever_id, "completed": not found or lever.get("completed", False)},
            "progress": {
                "completed": completed_count,
                "total": total_count,
                "percentage": round(completed_count / total_count * 100) if total_count > 0 else 0,
            },
            "allCompleted": completed_count == total_count,
        },
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Rock Toggle Endpoint
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@router.patch("/rock/{rock_id}")
async def toggle_rock(
    rock_id: str,
    current_user: CurrentUser = Depends(get_current_user)
):
    """
    åˆ‡æ¢æœ¬å‘¨å¤§çŸ³å¤´å®ŒæˆçŠ¶æ€

    æ›´æ–° vibe.target.goals æˆ– skills.lifecoach.week_rocks ä¸­å¯¹åº”é¡¹çš„ completed çŠ¶æ€
    """
    user_id = current_user.user_id

    # ä¼˜å…ˆä» vibe.target è·å–
    vibe_target = await UnifiedProfileRepository.get_vibe_target(user_id)
    goals = vibe_target.get("goals", [])

    # æ‰¾åˆ°å¹¶åˆ‡æ¢çŠ¶æ€
    found = False
    for goal in goals:
        if isinstance(goal, dict) and goal.get("id") == rock_id:
            goal["completed"] = not goal.get("completed", False)
            found = True
            break

    if found:
        # ä¿å­˜åˆ° vibe.target
        vibe_target["goals"] = goals
        await UnifiedProfileRepository.update_vibe_target(user_id, vibe_target)
    else:
        # å›é€€åˆ° lifecoach.week_rocks
        lifecoach_data = await UnifiedProfileRepository.get_skill_data(user_id, "lifecoach")
        week_rocks = lifecoach_data.get("week_rocks", [])

        for rock in week_rocks:
            if isinstance(rock, dict) and rock.get("id") == rock_id:
                rock["completed"] = not rock.get("completed", False)
                found = True
                break

        if found:
            lifecoach_data["week_rocks"] = week_rocks
            await UnifiedProfileRepository.update_skill_data(user_id, "lifecoach", lifecoach_data)

    if not found:
        return {"success": False, "error": "Rock not found"}

    return {
        "success": True,
        "data": {
            "rockId": rock_id,
            "completed": True,  # å·²åˆ‡æ¢
        },
    }
