/**
 * Storage Utilities - Vercel Best Practices
 *
 * Caches localStorage/sessionStorage reads to avoid repeated I/O
 * Rule: js-cache-storage
 */

// Module-level cache for localStorage
const localStorageCache = new Map<string, string | null>()

// Module-level cache for sessionStorage
const sessionStorageCache = new Map<string, string | null>()

// Parsed JSON cache
const jsonCache = new Map<string, unknown>()

/**
 * Get item from localStorage with caching
 */
export function getLocalStorage(key: string): string | null {
  if (typeof window === 'undefined') return null

  if (!localStorageCache.has(key)) {
    localStorageCache.set(key, localStorage.getItem(key))
  }
  return localStorageCache.get(key) ?? null
}

/**
 * Set item in localStorage and update cache
 */
export function setLocalStorage(key: string, value: string): void {
  if (typeof window === 'undefined') return

  localStorage.setItem(key, value)
  localStorageCache.set(key, value)
  // Invalidate JSON cache for this key
  jsonCache.delete(`local:${key}`)
}

/**
 * Remove item from localStorage and cache
 */
export function removeLocalStorage(key: string): void {
  if (typeof window === 'undefined') return

  localStorage.removeItem(key)
  localStorageCache.delete(key)
  jsonCache.delete(`local:${key}`)
}

/**
 * Get parsed JSON from localStorage with caching
 */
export function getLocalStorageJSON<T>(key: string, defaultValue: T): T {
  const cacheKey = `local:${key}`

  if (jsonCache.has(cacheKey)) {
    return jsonCache.get(cacheKey) as T
  }

  const raw = getLocalStorage(key)
  if (!raw) {
    jsonCache.set(cacheKey, defaultValue)
    return defaultValue
  }

  try {
    const parsed = JSON.parse(raw) as T
    jsonCache.set(cacheKey, parsed)
    return parsed
  } catch {
    jsonCache.set(cacheKey, defaultValue)
    return defaultValue
  }
}

/**
 * Set JSON in localStorage
 */
export function setLocalStorageJSON<T>(key: string, value: T): void {
  const json = JSON.stringify(value)
  setLocalStorage(key, json)
  jsonCache.set(`local:${key}`, value)
}

/**
 * Get item from sessionStorage with caching
 */
export function getSessionStorage(key: string): string | null {
  if (typeof window === 'undefined') return null

  if (!sessionStorageCache.has(key)) {
    sessionStorageCache.set(key, sessionStorage.getItem(key))
  }
  return sessionStorageCache.get(key) ?? null
}

/**
 * Set item in sessionStorage and update cache
 */
export function setSessionStorage(key: string, value: string): void {
  if (typeof window === 'undefined') return

  sessionStorage.setItem(key, value)
  sessionStorageCache.set(key, value)
  jsonCache.delete(`session:${key}`)
}

/**
 * Get parsed JSON from sessionStorage with caching
 */
export function getSessionStorageJSON<T>(key: string, defaultValue: T): T {
  const cacheKey = `session:${key}`

  if (jsonCache.has(cacheKey)) {
    return jsonCache.get(cacheKey) as T
  }

  const raw = getSessionStorage(key)
  if (!raw) {
    jsonCache.set(cacheKey, defaultValue)
    return defaultValue
  }

  try {
    const parsed = JSON.parse(raw) as T
    jsonCache.set(cacheKey, parsed)
    return parsed
  } catch {
    jsonCache.set(cacheKey, defaultValue)
    return defaultValue
  }
}

/**
 * Clear all caches - call when storage might have changed externally
 */
export function clearStorageCache(): void {
  localStorageCache.clear()
  sessionStorageCache.clear()
  jsonCache.clear()
}

/**
 * Invalidate specific key in cache
 */
export function invalidateStorageCache(key: string): void {
  localStorageCache.delete(key)
  sessionStorageCache.delete(key)
  jsonCache.delete(`local:${key}`)
  jsonCache.delete(`session:${key}`)
}

// Listen for storage events from other tabs
if (typeof window !== 'undefined') {
  window.addEventListener('storage', (e) => {
    if (e.key) {
      invalidateStorageCache(e.key)
    } else {
      // Storage was cleared
      clearStorageCache()
    }
  })

  // Clear cache when tab becomes visible (might have changed in background)
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      clearStorageCache()
    }
  })
}

// ============================================================================
// User-specific helpers
// ============================================================================

export interface CachedUser {
  user_id: string
  vibe_id?: string
  display_name?: string
  email?: string
  phone?: string
  nickname?: string
  avatar?: string
  birth_date?: string
  birth_time?: string
  timezone?: string
}

/**
 * Get cached user data
 */
export function getCachedUser(): CachedUser | null {
  return getLocalStorageJSON<CachedUser | null>('user', null)
}

/**
 * Set cached user data
 */
export function setCachedUser(user: CachedUser): void {
  setLocalStorageJSON('user', user)
}

/**
 * Get access token
 */
export function getAccessToken(): string | null {
  return getLocalStorage('access_token')
}

/**
 * Get voice mode preference
 */
export function getVoiceMode(): 'warm' | 'sarcastic' | 'wise' {
  const mode = getLocalStorage('vibelife-voice-mode')
  return mode === 'sarcastic' ? 'sarcastic' : 'warm'
}

/**
 * Get VibeLife profile
 */
export function getVibeLifeProfile(): Record<string, unknown> {
  return getLocalStorageJSON('vibelife-profile', { basic: {}, life_context: {} })
}

// ============================================================================
// Journey fold state helpers
// ============================================================================

export type JourneyCardId = 'north_star' | 'yearly_goals' | 'monthly_boss' | 'weekly_actions' | 'daily_levers' | 'progress'

export interface JourneyFoldState {
  [cardId: string]: boolean // true = expanded, false = collapsed
}

const JOURNEY_FOLD_KEY = 'vibelife-journey-fold'

/**
 * Get Journey card fold states
 */
export function getJourneyFoldState(): JourneyFoldState {
  return getLocalStorageJSON<JourneyFoldState>(JOURNEY_FOLD_KEY, {})
}

/**
 * Set Journey card fold state
 */
export function setJourneyCardFold(cardId: JourneyCardId, expanded: boolean): void {
  const current = getJourneyFoldState()
  setLocalStorageJSON(JOURNEY_FOLD_KEY, { ...current, [cardId]: expanded })
}

/**
 * Get single card fold state (default: true for top cards, false for bottom)
 */
export function getJourneyCardFold(cardId: JourneyCardId): boolean {
  const state = getJourneyFoldState()
  if (cardId in state) {
    return state[cardId]
  }
  // Default: north_star collapsed in executing state, daily_levers expanded
  // This is handled by the component based on context
  return true
}
