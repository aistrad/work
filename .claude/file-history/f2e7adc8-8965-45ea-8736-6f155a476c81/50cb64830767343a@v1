"use client";

/**
 * NorthStarCard - åŒ—ææ˜Ÿæ„¿æ™¯å¡ç‰‡
 *
 * å±•ç¤ºæ„¿æ™¯åœºæ™¯ã€åæ„¿æ™¯åœºæ™¯ã€èº«ä»½è½¬æ¢
 * æ”¯æŒ compact æ¨¡å¼ç”¨äºæ‰§è¡ŒçŠ¶æ€
 * æ”¯æŒ controlled/uncontrolled å±•å¼€çŠ¶æ€
 *
 * è®¾è®¡åŸåˆ™ï¼š
 * 1. è®°ä½ç”¨æˆ·åå¥½ï¼šæŠ˜å çŠ¶æ€æŒä¹…åŒ–
 * 2. Chat-Firstï¼šç¼–è¾‘æ“ä½œè·³è½¬åˆ° Chat
 *
 * åŸºäº: docs/components/ui/journey.md State 3
 */

import { motion } from "framer-motion";
import { useState, useCallback } from "react";
import type { NorthStar, Identity } from "@/types/journey";

interface NorthStarCardProps {
  northStar: NorthStar;
  identity?: Identity;
  /** ç´§å‡‘æ¨¡å¼ - ç”¨äº planned/executing çŠ¶æ€ */
  compact?: boolean;
  /** å—æ§å±•å¼€çŠ¶æ€ */
  expanded?: boolean;
  /** å±•å¼€/æŠ˜å åˆ‡æ¢å›è°ƒ */
  onToggle?: () => void;
  onEdit?: () => void;
  onTalkToFutureSelf?: () => void;
  className?: string;
}

export function NorthStarCard({
  northStar,
  identity,
  compact = false,
  expanded: controlledExpanded,
  onToggle,
  onEdit,
  onTalkToFutureSelf,
  className,
}: NorthStarCardProps) {
  const [showAntiVision, setShowAntiVision] = useState(false);
  const [localExpanded, setLocalExpanded] = useState(false);

  // æ”¯æŒ controlled å’Œ uncontrolled æ¨¡å¼
  const isControlled = controlledExpanded !== undefined;
  const expanded = isControlled ? controlledExpanded : localExpanded;

  const handleToggle = useCallback(() => {
    if (isControlled && onToggle) {
      onToggle();
    } else {
      setLocalExpanded((prev) => !prev);
    }
  }, [isControlled, onToggle]);

  const hasVision = !!northStar.vision_scene;
  const hasAntiVision = !!northStar.anti_vision_scene;
  const hasIdentity = !!identity?.target;

  if (!hasVision && !hasAntiVision) return null;

  // Compact mode - collapsed view
  if (compact && !expanded) {
    return (
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        className={`bg-card border border-border rounded-2xl p-3 ${className}`}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2 flex-1 min-w-0">
            <span className="text-lg">â­</span>
            <p className="text-sm text-foreground truncate flex-1">
              {northStar.vision_scene}
            </p>
          </div>
          <div className="flex items-center gap-2 flex-shrink-0">
            <button
              onClick={() => setExpanded(true)}
              className="text-xs text-muted-foreground hover:text-foreground transition-colors"
            >
              å±•å¼€
            </button>
            {onEdit && (
              <button
                onClick={onEdit}
                className="text-xs text-muted-foreground hover:text-foreground transition-colors"
              >
                ç¼–è¾‘
              </button>
            )}
          </div>
        </div>

        {/* Identity badge in compact mode */}
        {hasIdentity && (
          <div className="mt-2 flex items-center gap-1">
            <span className="text-xs">ğŸªª</span>
            <span className="text-xs text-emerald-600 dark:text-emerald-400 truncate">
              {identity.target}
            </span>
          </div>
        )}
      </motion.div>
    );
  }

  // Full mode (or expanded compact mode)
  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className={`bg-card border border-border rounded-2xl p-4 ${className}`}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-xl">â­</span>
          <h3 className="font-semibold text-foreground">åŒ—ææ˜Ÿ</h3>
        </div>
        <div className="flex items-center gap-2">
          {compact && (
            <button
              onClick={() => setExpanded(false)}
              className="text-xs text-muted-foreground hover:text-foreground transition-colors"
            >
              æ”¶èµ·
            </button>
          )}
          {onEdit && (
            <button
              onClick={onEdit}
              className="text-xs text-muted-foreground hover:text-foreground transition-colors"
            >
              ç¼–è¾‘
            </button>
          )}
        </div>
      </div>

      {/* Vision Scene */}
      {hasVision && (
        <div className="mb-4">
          <p className="text-sm text-foreground leading-relaxed">
            &quot;{northStar.vision_scene}&quot;
          </p>
          {northStar.vision_timeframe && (
            <p className="text-xs text-muted-foreground mt-1">
              {northStar.vision_timeframe}
            </p>
          )}
        </div>
      )}

      {/* Identity */}
      {hasIdentity && (
        <div className="mb-4 p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg">
          <div className="flex items-center gap-1 text-xs text-emerald-600 dark:text-emerald-400 mb-1">
            <span>ğŸªª</span>
            <span>æ–°èº«ä»½</span>
          </div>
          <p className="text-sm text-foreground">{identity.target}</p>
          {identity.current && (
            <p className="text-xs text-muted-foreground mt-1 line-through">
              æ—§ï¼š{identity.current}
            </p>
          )}
        </div>
      )}

      {/* Anti-Vision Toggle */}
      {hasAntiVision && (
        <div className="mb-4">
          <button
            onClick={() => setShowAntiVision(!showAntiVision)}
            className="flex items-center gap-2 text-xs text-muted-foreground hover:text-foreground transition-colors"
          >
            <span>ğŸ”¥</span>
            <span>åæ„¿æ™¯</span>
            <span className="text-[10px]">{showAntiVision ? "â–²" : "â–¼"}</span>
          </button>

          {showAntiVision && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: "auto" }}
              exit={{ opacity: 0, height: 0 }}
              className="mt-2 p-3 bg-red-500/10 border border-red-500/20 rounded-lg"
            >
              <p className="text-sm text-foreground">
                &quot;{northStar.anti_vision_scene}&quot;
              </p>
            </motion.div>
          )}
        </div>
      )}

      {/* Pain Points */}
      {northStar.pain_points && northStar.pain_points.length > 0 && (
        <div className="mb-4">
          <p className="text-xs text-muted-foreground mb-2">æŒç»­çš„ä¸æ»¡ï¼š</p>
          <div className="flex flex-wrap gap-2">
            {northStar.pain_points.map((point, index) => (
              <span
                key={index}
                className="text-xs px-2 py-1 bg-muted rounded-full text-muted-foreground"
              >
                {point}
              </span>
            ))}
          </div>
        </div>
      )}

      {/* CTA */}
      {onTalkToFutureSelf && (
        <button
          onClick={onTalkToFutureSelf}
          className="w-full py-2 text-sm text-primary hover:bg-primary/5 rounded-lg transition-colors"
        >
          å’Œæœªæ¥çš„æˆ‘å¯¹è¯ â†’
        </button>
      )}
    </motion.div>
  );
}

export default NorthStarCard;
