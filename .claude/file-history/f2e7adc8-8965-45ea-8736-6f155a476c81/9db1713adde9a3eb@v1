"use client";

/**
 * useJourneyFoldState - Journey 卡片折叠状态管理
 *
 * 持久化用户的卡片展开/折叠偏好到 localStorage
 * 设计原则：记住用户偏好，刷新后保持状态
 */

import { useState, useCallback, useEffect } from "react";
import {
  type JourneyCardId,
  getJourneyFoldState,
  setJourneyCardFold,
} from "@/utils/storage";

// 默认折叠状态：执行状态下 north_star 默认收起
const DEFAULT_FOLD_STATE: Record<JourneyCardId, boolean> = {
  north_star: false, // 默认收起
  yearly_goals: false, // 默认收起
  monthly_boss: true, // 默认展开
  weekly_actions: true, // 默认展开
  daily_levers: true, // 默认展开
  progress: true, // 默认展开
};

export function useJourneyFoldState() {
  // 初始化时从 localStorage 读取
  const [foldState, setFoldState] = useState<Record<string, boolean>>(() => {
    if (typeof window === "undefined") return DEFAULT_FOLD_STATE;
    const saved = getJourneyFoldState();
    return { ...DEFAULT_FOLD_STATE, ...saved };
  });

  // SSR hydration 修复
  useEffect(() => {
    const saved = getJourneyFoldState();
    setFoldState({ ...DEFAULT_FOLD_STATE, ...saved });
  }, []);

  /**
   * 获取卡片是否展开
   */
  const isExpanded = useCallback(
    (cardId: JourneyCardId): boolean => {
      return foldState[cardId] ?? DEFAULT_FOLD_STATE[cardId] ?? true;
    },
    [foldState]
  );

  /**
   * 切换卡片展开/折叠状态
   */
  const toggle = useCallback((cardId: JourneyCardId) => {
    setFoldState((prev) => {
      const newExpanded = !prev[cardId];
      // 持久化到 localStorage
      setJourneyCardFold(cardId, newExpanded);
      return { ...prev, [cardId]: newExpanded };
    });
  }, []);

  /**
   * 设置卡片展开/折叠状态
   */
  const setExpanded = useCallback((cardId: JourneyCardId, expanded: boolean) => {
    setFoldState((prev) => {
      // 持久化到 localStorage
      setJourneyCardFold(cardId, expanded);
      return { ...prev, [cardId]: expanded };
    });
  }, []);

  /**
   * 全部展开
   */
  const expandAll = useCallback(() => {
    const allExpanded: Record<string, boolean> = {};
    Object.keys(DEFAULT_FOLD_STATE).forEach((key) => {
      allExpanded[key] = true;
      setJourneyCardFold(key as JourneyCardId, true);
    });
    setFoldState(allExpanded);
  }, []);

  /**
   * 全部收起（除了 daily_levers）
   */
  const collapseAll = useCallback(() => {
    const allCollapsed: Record<string, boolean> = {
      north_star: false,
      yearly_goals: false,
      monthly_boss: false,
      weekly_actions: false,
      daily_levers: true, // 保持展开
      progress: false,
    };
    Object.entries(allCollapsed).forEach(([key, value]) => {
      setJourneyCardFold(key as JourneyCardId, value);
    });
    setFoldState(allCollapsed);
  }, []);

  return {
    foldState,
    isExpanded,
    toggle,
    setExpanded,
    expandAll,
    collapseAll,
  };
}

export default useJourneyFoldState;
