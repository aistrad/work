"use client";

/**
 * JourneyContent - Journey é¡µé¢ä¸»å†…å®¹
 *
 * æ ¹æ® skill_data çŠ¶æ€å±•ç¤ºä¸åŒå†…å®¹ï¼š
 * - empty: EmptyJourneyCard (å¼•å¯¼å¼€å§‹)
 * - north_star_set: NorthStarCard + NorthStarSetCard (å¼•å¯¼åˆ¶å®šè·¯çº¿å›¾)
 * - planned: NorthStarCard(compact) + YearlyGoalsCard + MonthlyBossCard + PlannedStateCard (å¼•å¯¼è®¾å®šå‘¨å¤§çŸ³å¤´)
 * - executing: å®Œæ•´çš„æ‰§è¡Œä»ªè¡¨ç›˜
 *
 * è®¾è®¡åŸåˆ™ï¼š
 * 1. Chat-First: æ‰€æœ‰æ·±åº¦äº¤äº’å›åˆ° Chat
 * 2. çŠ¶æ€é©±åŠ¨: æ ¹æ®å®Œæˆè¿›åº¦å±•ç¤ºä¸åŒé¡µé¢çŠ¶æ€
 * 3. å±‚çº§æ¸…æ™°: æ„¿æ™¯ â†’ å¹´ â†’ æœˆ â†’ å‘¨ â†’ æ—¥
 * 4. è¡ŒåŠ¨ä¼˜å…ˆ: ä»Šæ—¥æ æ†å§‹ç»ˆä¼˜å…ˆå±•ç¤º
 * 5. å¿«æ·å…¥å£: å¸¸ç”¨æ“ä½œä¸€é”®è¿›å…¥ Chat
 * 6. æ¸è¿›è§£é”: æœªå®Œæˆçš„åŒºå—ç½®ç°å¼•å¯¼
 *
 * åŸºäº: docs/components/ui/journey.md
 */

import { useRouter } from "next/navigation";
import { useCallback } from "react";
import { useJourneyData } from "@/hooks/useJourneyData";
import { useJourneyFoldState } from "@/hooks/useJourneyFoldState";
import { EmptyJourneyCard } from "./EmptyJourneyCard";
import { NorthStarCard } from "./NorthStarCard";
import { NorthStarSetCard } from "./NorthStarSetCard";
import { PlannedStateCard } from "./PlannedStateCard";
import { YearlyGoalsCard } from "./YearlyGoalsCard";
import { MonthlyBossCard } from "./MonthlyBossCard";
import { WeeklyActionsCard } from "./WeeklyActionsCard";
import { JourneyDailyLeversCard } from "./JourneyDailyLeversCard";
import { JourneySkeleton } from "./JourneySkeleton";

interface JourneyContentProps {
  className?: string;
}

export function JourneyContent({ className }: JourneyContentProps) {
  const router = useRouter();
  const {
    data,
    isLoading,
    error,
    journeyState,
    northStar,
    identity,
    goals,
    weekly,
    monthlyBoss,
    dailyLevers,
    progress,
    toggleAction,
    toggleLever,
    toggleMilestone,
    checkin,
    refresh,
  } = useJourneyData();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Handlers
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ‰€æœ‰å¯æ§å…¥å£æ˜¾å¼ä¼  scenario å‚æ•°ï¼Œç¡®ä¿æ­£ç¡®åŠ è½½å¯¹åº”çš„ rule æ–‡ä»¶
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const handleStartJourney = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=dankoe&prompt=æˆ‘æƒ³åšä¸€æ¬¡äººç”Ÿé‡ç½®");
  }, [router]);

  const handleEditNorthStar = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=dankoe&prompt=æˆ‘æƒ³æ›´æ–°æˆ‘çš„æ„¿æ™¯");
  }, [router]);

  const handleTalkToFutureSelf = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=dankoe&prompt=å’Œæœªæ¥çš„æˆ‘å¯¹è¯");
  }, [router]);

  const handleCreateRoadmap = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=covey&prompt=å¸®æˆ‘åˆ¶å®šå¹´åº¦è·¯çº¿å›¾");
  }, [router]);

  const handleEditGoals = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=covey&prompt=æˆ‘æƒ³è°ƒæ•´å¹´åº¦ç›®æ ‡");
  }, [router]);

  const handleSetWeeklyRocks = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=covey&prompt=å¸®æˆ‘è®¾å®šæœ¬å‘¨å¤§çŸ³å¤´");
  }, [router]);

  const handleAddAction = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=covey&prompt=å¸®æˆ‘æ·»åŠ æœ¬å‘¨è¡ŒåŠ¨");
  }, [router]);

  const handleEditBoss = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=covey&prompt=æˆ‘æƒ³è°ƒæ•´æœ¬æœˆBoss");
  }, [router]);

  const handleAdjustLevers = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=covey&prompt=è°ƒæ•´ä»Šæ—¥æ æ†");
  }, [router]);

  const handleWeeklyReview = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=weekly-review&prompt=å‘¨å¤ç›˜");
  }, [router]);

  const handleStuck = useCallback(() => {
    router.push("/chat?skill=lifecoach&scenario=dankoe&prompt=æˆ‘å¡ä½äº†");
  }, [router]);

  const handleCheckin = useCallback(async () => {
    await checkin();
  }, [checkin]);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Loading State
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (isLoading) {
    return <JourneySkeleton />;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Error State
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (error) {
    // Check if it's an authentication error
    const isAuthError = error.message?.includes("Unauthorized") ||
                        error.message?.includes("Authentication required") ||
                        error.message?.includes("401");

    if (isAuthError) {
      return (
        <div className="flex flex-col items-center justify-center min-h-[60vh] px-6 space-y-6">
          <div className="w-20 h-20 rounded-full bg-accent-primary/10 flex items-center justify-center">
            <span className="text-4xl">ğŸ”’</span>
          </div>
          <div className="text-center space-y-2">
            <h2 className="text-2xl font-bold text-text-primary">éœ€è¦ç™»å½•</h2>
            <p className="text-text-secondary max-w-md">
              Journey æ˜¯ä½ çš„äººç”Ÿè§„åˆ’ä¸­å¿ƒï¼Œéœ€è¦ç™»å½•åæ‰èƒ½è®¿é—®ã€‚
            </p>
          </div>
          <button
            onClick={() => router.push("/auth/login?redirect=/chat")}
            className="px-6 py-3 bg-accent-primary text-text-inverse font-medium rounded-full hover:bg-accent-primary/90 transition-colors"
          >
            ç«‹å³ç™»å½•
          </button>
        </div>
      );
    }

    // Other errors
    return (
      <div className="flex flex-col items-center justify-center min-h-[60vh] px-6 space-y-6">
        <div className="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center">
          <span className="text-4xl">âš ï¸</span>
        </div>
        <div className="text-center space-y-2">
          <h2 className="text-2xl font-bold text-text-primary">åŠ è½½å¤±è´¥</h2>
          <p className="text-text-secondary max-w-md">
            {error.message || "æ— æ³•åŠ è½½ Journey æ•°æ®ï¼Œè¯·ç¨åé‡è¯•"}
          </p>
        </div>
        <button
          onClick={() => refresh()}
          className="px-6 py-3 bg-accent-primary text-text-inverse font-medium rounded-full hover:bg-accent-primary/90 transition-colors"
        >
          é‡æ–°åŠ è½½
        </button>
      </div>
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ï¿½ï¿½â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // State 0: Empty State
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (journeyState === "empty") {
    return <EmptyJourneyCard onStart={handleStartJourney} className={className} />;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // State 1: North Star Set - æœ‰åŒ—ææ˜Ÿï¼Œæ— è·¯çº¿å›¾
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (journeyState === "north_star_set") {
    return (
      <div className={`space-y-4 p-4 ${className}`}>
        {/* North Star Card */}
        {northStar && (
          <NorthStarCard
            northStar={northStar}
            identity={identity}
            onEdit={handleEditNorthStar}
            onTalkToFutureSelf={handleTalkToFutureSelf}
          />
        )}

        {/* CTA: Create Roadmap */}
        <NorthStarSetCard onCreateRoadmap={handleCreateRoadmap} />
      </div>
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // State 2: Planned - æœ‰è·¯çº¿å›¾ï¼Œæ— å‘¨å¤§çŸ³å¤´
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  if (journeyState === "planned") {
    return (
      <div className={`space-y-4 p-4 ${className}`}>
        {/* North Star Card (Compact) */}
        {northStar && (
          <NorthStarCard
            northStar={northStar}
            identity={identity}
            compact
            onEdit={handleEditNorthStar}
          />
        )}

        {/* Yearly Goals Card */}
        {goals.length > 0 && (
          <YearlyGoalsCard goals={goals} onEditGoals={handleEditGoals} />
        )}

        {/* Monthly Boss Card */}
        {monthlyBoss && (
          <MonthlyBossCard
            monthlyBoss={monthlyBoss}
            onToggleMilestone={toggleMilestone}
            onEditBoss={handleEditBoss}
          />
        )}

        {/* CTA: Set Weekly Rocks */}
        <PlannedStateCard onSetWeeklyRocks={handleSetWeeklyRocks} />
      </div>
    );
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // State 3: Executing State - Full Dashboard
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  return (
    <div className={`space-y-4 p-4 ${className}`}>
      {/* 1. North Star Card (Compact) */}
      {northStar && (
        <NorthStarCard
          northStar={northStar}
          identity={identity}
          compact
          onEdit={handleEditNorthStar}
          onTalkToFutureSelf={handleTalkToFutureSelf}
        />
      )}

      {/* 2. Yearly Goals Card */}
      {goals.length > 0 && (
        <YearlyGoalsCard goals={goals} onEditGoals={handleEditGoals} />
      )}

      {/* 3. Monthly Boss Card */}
      {monthlyBoss && (
        <MonthlyBossCard
          monthlyBoss={monthlyBoss}
          onToggleMilestone={toggleMilestone}
          onEditBoss={handleEditBoss}
        />
      )}

      {/* 4. Weekly Actions Card */}
      {weekly && (
        <WeeklyActionsCard
          weekly={weekly}
          onToggleAction={toggleAction}
          onAddAction={handleAddAction}
        />
      )}

      {/* 5. Daily Levers Card */}
      {dailyLevers && (
        <JourneyDailyLeversCard
          dailyLevers={dailyLevers}
          todayCheckedIn={progress?.today_checked_in}
          currentStreak={progress?.current_streak}
          onToggleLever={toggleLever}
          onCheckin={handleCheckin}
          onAdjustLevers={handleAdjustLevers}
        />
      )}

      {/* 6. Progress Stats */}
      {progress && (
        <div className="bg-card border border-border rounded-2xl p-4">
          <div className="flex items-center gap-2 mb-3">
            <span className="text-xl">ğŸ”¥</span>
            <h3 className="font-semibold text-foreground">è¿›åº¦</h3>
          </div>
          <div className="grid grid-cols-3 gap-4 text-center">
            <div>
              <p className="text-2xl font-bold text-foreground">
                {progress.current_streak}
              </p>
              <p className="text-xs text-muted-foreground">è¿ç»­å¤©æ•°</p>
            </div>
            <div>
              <p className="text-2xl font-bold text-foreground">
                {progress.longest_streak}
              </p>
              <p className="text-xs text-muted-foreground">æœ€é•¿è®°å½•</p>
            </div>
            <div>
              <p className="text-2xl font-bold text-foreground">
                {progress.total_checkins}
              </p>
              <p className="text-xs text-muted-foreground">æ€»ç­¾åˆ°</p>
            </div>
          </div>
          {progress.weekly_completion_rate !== undefined && (
            <div className="mt-3 pt-3 border-t border-border">
              <div className="flex items-center justify-between text-sm">
                <span className="text-muted-foreground">æœ¬å‘¨å®Œæˆç‡</span>
                <span className="font-medium text-foreground">
                  {progress.weekly_completion_rate}%
                </span>
              </div>
            </div>
          )}
        </div>
      )}

      {/* 7. Quick Actions */}
      <div className="bg-card border border-border rounded-2xl p-4">
        <div className="flex items-center gap-2 mb-3">
          <span className="text-xl">ğŸ’¬</span>
          <h3 className="font-semibold text-foreground">éœ€è¦å¸®åŠ©ï¼Ÿ</h3>
        </div>
        <div className="flex flex-wrap gap-2">
          <button
            onClick={handleEditNorthStar}
            className="px-3 py-2 text-sm bg-muted hover:bg-muted/80 rounded-lg transition-colors"
          >
            è°ƒæ•´ç›®æ ‡
          </button>
          <button
            onClick={handleWeeklyReview}
            className="px-3 py-2 text-sm bg-muted hover:bg-muted/80 rounded-lg transition-colors"
          >
            å‘¨å¤ç›˜
          </button>
          <button
            onClick={handleStuck}
            className="px-3 py-2 text-sm bg-muted hover:bg-muted/80 rounded-lg transition-colors"
          >
            æˆ‘å¡ä½äº†
          </button>
        </div>
      </div>
    </div>
  );
}

export default JourneyContent;
