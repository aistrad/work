"use client";

/**
 * MonthlyBossCard - æœˆåº¦ Boss å¡ç‰‡
 *
 * å±•ç¤ºæœ¬æœˆä¸»è¦é¡¹ç›®/æŒ‘æˆ˜åŠé‡Œç¨‹ç¢‘
 * æ”¯æŒæŠ˜å /å±•å¼€ï¼Œè®°ä½ç”¨æˆ·åå¥½
 *
 * åŸºäº: Journey Page 4-state ç³»ç»Ÿ
 */

import { motion } from "framer-motion";
import { useState, useCallback } from "react";
import type { MonthlyBoss, Milestone } from "@/types/journey";

interface MonthlyBossCardProps {
  monthlyBoss: MonthlyBoss;
  /** å—æ§å±•å¼€çŠ¶æ€ */
  expanded?: boolean;
  /** å±•å¼€/æŠ˜å åˆ‡æ¢å›è°ƒ */
  onToggle?: () => void;
  onToggleMilestone?: (milestoneId: string) => void;
  onEditBoss?: () => void;
  className?: string;
}

const STATUS_CONFIG = {
  pending: { label: "å¾…å¼€å§‹", color: "bg-gray-500/20 text-gray-600 dark:text-gray-400" },
  in_progress: { label: "è¿›è¡Œä¸­", color: "bg-blue-500/20 text-blue-600 dark:text-blue-400" },
  completed: { label: "å·²å®Œæˆ", color: "bg-emerald-500/20 text-emerald-600 dark:text-emerald-400" },
  failed: { label: "æœªè¾¾æˆ", color: "bg-red-500/20 text-red-600 dark:text-red-400" },
};

function formatMonth(monthStr: string): string {
  try {
    const [year, month] = monthStr.split("-");
    return `${year}å¹´${parseInt(month)}æœˆ`;
  } catch {
    return monthStr;
  }
}

export function MonthlyBossCard({
  monthlyBoss,
  expanded: controlledExpanded,
  onToggle,
  onToggleMilestone,
  onEditBoss,
  className,
}: MonthlyBossCardProps) {
  const [localExpanded, setLocalExpanded] = useState(true);

  // æ”¯æŒ controlled å’Œ uncontrolled æ¨¡å¼
  const isControlled = controlledExpanded !== undefined;
  const expanded = isControlled ? controlledExpanded : localExpanded;

  const handleToggle = useCallback(() => {
    if (isControlled && onToggle) {
      onToggle();
    } else {
      setLocalExpanded((prev) => !prev);
    }
  }, [isControlled, onToggle]);

  const { title, description, month, progress, status, milestones = [] } = monthlyBoss;
  const statusConfig = STATUS_CONFIG[status] || STATUS_CONFIG.pending;

  const completedMilestones = milestones.filter((m) => m.completed).length;
  const totalMilestones = milestones.length;

  // æŠ˜å çŠ¶æ€è§†å›¾
  if (!expanded) {
    return (
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        className={`bg-card border border-border rounded-2xl p-3 ${className}`}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2 flex-1 min-w-0">
            <span className="text-lg">ğŸ‘¹</span>
            <span className="text-sm text-foreground truncate">{title}</span>
            <span className={`text-xs px-1.5 py-0.5 rounded ${statusConfig.color}`}>
              {statusConfig.label}
            </span>
            {/* Mini progress bar */}
            <div className="flex-1 max-w-16 h-1.5 bg-muted rounded-full overflow-hidden">
              <div
                className={`h-full rounded-full transition-all ${
                  status === "completed" ? "bg-emerald-500" : "bg-primary"
                }`}
                style={{ width: `${progress}%` }}
              />
            </div>
            <span className="text-xs text-muted-foreground">{progress}%</span>
          </div>
          <div className="flex items-center gap-2 flex-shrink-0">
            <button
              onClick={handleToggle}
              className="text-xs text-muted-foreground hover:text-foreground transition-colors"
            >
              å±•å¼€
            </button>
            {onEditBoss && (
              <button
                onClick={onEditBoss}
                className="text-xs text-muted-foreground hover:text-foreground transition-colors"
              >
                ç¼–è¾‘
              </button>
            )}
          </div>
        </div>
      </motion.div>
    );
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      className={`bg-card border border-border rounded-2xl p-4 ${className}`}
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-xl">ğŸ‘¹</span>
          <h3 className="font-semibold text-foreground">æœ¬æœˆ Boss</h3>
        </div>
        <div className="flex items-center gap-2">
          <span className={`text-xs px-2 py-0.5 rounded ${statusConfig.color}`}>
            {statusConfig.label}
          </span>
          <button
            onClick={handleToggle}
            className="text-xs text-muted-foreground hover:text-foreground transition-colors"
          >
            æ”¶èµ·
          </button>
          {onEditBoss && (
            <button
              onClick={onEditBoss}
              className="text-xs text-muted-foreground hover:text-foreground transition-colors"
            >
              ç¼–è¾‘
            </button>
          )}
        </div>
      </div>

      {/* Boss Info */}
      <div className="mb-4">
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <h4 className="text-base font-medium text-foreground">{title}</h4>
            {description && (
              <p className="text-sm text-muted-foreground mt-1">{description}</p>
            )}
          </div>
        </div>
        <p className="text-xs text-muted-foreground mt-2">{formatMonth(month)}</p>
      </div>

      {/* Progress */}
      <div className="mb-4">
        <div className="flex items-center justify-between text-xs text-muted-foreground mb-1">
          <span>è¿›åº¦</span>
          <span>{progress}%</span>
        </div>
        <div className="h-2 bg-muted rounded-full overflow-hidden">
          <motion.div
            initial={{ width: 0 }}
            animate={{ width: `${progress}%` }}
            transition={{ duration: 0.5, ease: "easeOut" }}
            className={`h-full rounded-full ${
              status === "completed"
                ? "bg-emerald-500"
                : status === "failed"
                ? "bg-red-500"
                : "bg-primary"
            }`}
          />
        </div>
      </div>

      {/* Milestones */}
      {totalMilestones > 0 && (
        <div>
          <div className="flex items-center justify-between mb-2">
            <p className="text-xs text-muted-foreground">é‡Œç¨‹ç¢‘</p>
            <p className="text-xs text-muted-foreground">
              {completedMilestones}/{totalMilestones}
            </p>
          </div>
          <div className="space-y-2">
            {milestones.map((milestone, index) => (
              <motion.div
                key={milestone.id}
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ delay: index * 0.05 }}
                className={`flex items-center gap-3 p-2 rounded-lg transition-colors ${
                  milestone.completed
                    ? "bg-emerald-500/10"
                    : "bg-muted/50 hover:bg-muted"
                }`}
              >
                {/* Checkbox */}
                <button
                  onClick={() => onToggleMilestone?.(milestone.id)}
                  disabled={!onToggleMilestone}
                  className={`flex-shrink-0 w-5 h-5 rounded border-2 flex items-center justify-center transition-colors ${
                    milestone.completed
                      ? "bg-emerald-500 border-emerald-500 text-white"
                      : "border-muted-foreground/30 hover:border-primary"
                  } ${!onToggleMilestone ? "cursor-default" : "cursor-pointer"}`}
                >
                  {milestone.completed && (
                    <svg
                      className="w-3 h-3"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                    >
                      <path
                        strokeLinecap="round"
                        strokeLinejoin="round"
                        strokeWidth={3}
                        d="M5 13l4 4L19 7"
                      />
                    </svg>
                  )}
                </button>

                {/* Title */}
                <span
                  className={`text-sm flex-1 ${
                    milestone.completed
                      ? "text-muted-foreground line-through"
                      : "text-foreground"
                  }`}
                >
                  {milestone.title}
                </span>
              </motion.div>
            ))}
          </div>
        </div>
      )}
    </motion.div>
  );
}

export default MonthlyBossCard;
