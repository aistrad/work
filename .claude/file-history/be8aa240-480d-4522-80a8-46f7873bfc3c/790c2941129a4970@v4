"use client";

/**
 * NavBar - PCç«¯å·¦ä¾§å¯¼èˆªæ  v10.0
 *
 * V10 å˜æ›´:
 * - å¯¹è¯å†å²æ•´åˆåˆ° NavBar ä¸­
 * - "å¯¹è¯"æŒ‰é’® = å¼€å§‹æ–°å¯¹è¯
 * - å†å²å¯¹è¯åˆ—è¡¨æ˜¾ç¤ºåœ¨å¯¼èˆªé“¾æ¥ä¸‹æ–¹
 */

import { useState, useEffect } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { cn } from "@/lib/utils";
import {
  PanelLeftClose,
  PanelLeft,
  MoreHorizontal,
  Pencil,
  Trash2,
} from "lucide-react";
import Link from "next/link";
import { VibeGlyph, type SkillType } from "@/components/core";
import { type TabType } from "./AppShell";
import { useConversations, type ConversationItem } from "@/hooks/useConversations";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types & Config
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface NavBarProps {
  skill: SkillType;
  activeTab: TabType;
  onTabChange: (tab: TabType) => void;
  activeConversationId: string | null;
  onSelectConversation: (id: string | null) => void;
  onNewChat: () => void;
  className?: string;
}

interface NavItem {
  id: TabType;
  icon: string;
  label: string;
  description?: string;
}

// V10: 4 navigation items - é¡ºåºï¼šæˆ‘ã€æ—…ç¨‹ã€å…³ç³»ã€æ¢ç´¢
// ä½¿ç”¨æ¸å˜èƒŒæ™¯ Emoji å›¾æ ‡é£æ ¼
const NAV_ITEMS: NavItem[] = [
  {
    id: "me",
    icon: "ğŸ‘¤",
    label: "æˆ‘",
    description: "ä¸ªäººä¸­å¿ƒ",
  },
  {
    id: "journey",
    icon: "ğŸ¯",
    label: "ç›®æ ‡",
    description: "æˆ‘çš„ç›®æ ‡",
  },
  {
    id: "relations",
    icon: "ğŸ’‘",
    label: "å…³ç³»",
    description: "äººé™…å…³ç³»",
  },
  {
    id: "discover",
    icon: "âœ¨",
    label: "æ¢ç´¢",
    description: "å‘ç°æ›´å¤š Skills",
  },
];

const STORAGE_KEY = "vibelife-navbar-expanded";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NavBar Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function NavBar({
  skill,
  activeTab,
  onTabChange,
  activeConversationId,
  onSelectConversation,
  onNewChat,
  className,
}: NavBarProps) {
  const [isExpanded, setIsExpanded] = useState(true); // é»˜è®¤å±•å¼€
  const [hoveredItem, setHoveredItem] = useState<string | null>(null);
  const [isMounted, setIsMounted] = useState(false);
  const [menuOpenId, setMenuOpenId] = useState<string | null>(null);
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editTitle, setEditTitle] = useState("");

  const { conversations, isLoading, renameConversation, deleteConversation } = useConversations();

  // ä» localStorage æ¢å¤çŠ¶æ€
  useEffect(() => {
    setIsMounted(true);
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved !== null) {
      setIsExpanded(saved === "true");
    }
  }, []);

  const toggleExpanded = () => {
    setIsExpanded((prev) => {
      const newValue = !prev;
      if (typeof window !== "undefined") {
        localStorage.setItem(STORAGE_KEY, String(newValue));
      }
      return newValue;
    });
  };

  // å¼€å§‹æ–°å¯¹è¯
  const handleNewChat = () => {
    onNewChat();
    onTabChange("chat");
  };

  // é€‰æ‹©å¯¹è¯
  const handleSelectConversation = (id: string) => {
    onSelectConversation(id);
    onTabChange("chat");
    setMenuOpenId(null);
  };

  // é‡å‘½åå¯¹è¯
  const handleRename = async (id: string) => {
    if (editTitle.trim()) {
      await renameConversation(id, editTitle.trim());
    }
    setEditingId(null);
    setEditTitle("");
  };

  // åˆ é™¤å¯¹è¯
  const handleDelete = async (id: string) => {
    await deleteConversation(id);
    if (activeConversationId === id) {
      onSelectConversation(null);
    }
    setMenuOpenId(null);
  };

  return (
    <motion.nav
      initial={false}
      animate={{ width: isExpanded ? 260 : 64 }}
      transition={{ duration: 0.2, ease: "easeInOut" }}
      className={cn(
        "h-full flex flex-col bg-card border-r border-border",
        className
      )}
    >
      {/* Logo Area + Collapse Toggle */}
      <div className="h-14 flex items-center justify-between px-3 border-b border-border">
        <div className="flex items-center gap-2">
          <VibeGlyph size="sm" skill={skill} showAura={false} animate={false} />
          {isExpanded && (
            <span className="font-serif font-semibold text-foreground whitespace-nowrap">
              VibeLife
            </span>
          )}
        </div>
        <button
          onClick={toggleExpanded}
          aria-label={isExpanded ? "æ”¶èµ·ä¾§è¾¹æ " : "å±•å¼€ä¾§è¾¹æ "}
          className="p-1.5 rounded-md text-muted-foreground/60 hover:text-muted-foreground hover:bg-muted/50 transition-colors"
        >
          {isExpanded ? <PanelLeftClose className="w-4 h-4" aria-hidden="true" /> : <PanelLeft className="w-4 h-4" aria-hidden="true" />}
        </button>
      </div>

      {/* Main Nav Section - æ–°å¯¹è¯ + å¯¼èˆªé¡¹ */}
      <div className="px-2 pt-2 pb-1.5 space-y-0.5">
        {/* æ–°å¯¹è¯æŒ‰é’® */}
        <div className="relative">
          <button
            onClick={handleNewChat}
            onMouseEnter={() => !isExpanded && setHoveredItem("chat")}
            onMouseLeave={() => setHoveredItem(null)}
            className={cn(
              "w-full flex items-center gap-2.5 px-2.5 py-2 rounded-lg transition-all duration-200",
              isExpanded ? "justify-start" : "justify-center",
              "bg-muted/60 text-foreground hover:bg-muted",
              "border border-border/50"
            )}
          >
            <div className="w-6 h-6 rounded-md bg-gradient-to-br from-vellum-100 to-vellum-200 flex items-center justify-center flex-shrink-0">
              <span className="text-sm">ğŸ’¬</span>
            </div>
            {isExpanded && (
              <span className="text-sm font-medium whitespace-nowrap">æ–°å¯¹è¯</span>
            )}
          </button>
          {!isExpanded && hoveredItem === "chat" && (
            <motion.div
              initial={{ opacity: 0, x: -4 }}
              animate={{ opacity: 1, x: 0 }}
              className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
            >
              <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
                æ–°å¯¹è¯
                <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
              </div>
            </motion.div>
          )}
        </div>

        {/* å¯¼èˆªé¡¹ï¼šæˆ‘ã€æ—…ç¨‹ã€å…³ç³»ã€æ¢ç´¢ */}
        {NAV_ITEMS.map((item) => {
          const isActive = activeTab === item.id;

          return (
            <div key={item.id} className="relative">
              <button
                onClick={() => onTabChange(item.id)}
                onMouseEnter={() => !isExpanded && setHoveredItem(item.id)}
                onMouseLeave={() => setHoveredItem(null)}
                className={cn(
                  "w-full flex items-center gap-2.5 px-2.5 py-1.5 rounded-lg transition-all duration-200",
                  isExpanded ? "justify-start" : "justify-center",
                  isActive
                    ? "bg-black/5 dark:bg-white/10"
                    : "hover:bg-muted"
                )}
              >
                <div className={cn(
                  "w-6 h-6 rounded-md flex items-center justify-center flex-shrink-0 transition-all duration-200",
                  isActive
                    ? "bg-gradient-to-br from-vellum-200 to-vellum-300"
                    : "bg-gradient-to-br from-vellum-100 to-vellum-200"
                )}>
                  <span className="text-sm">{item.icon}</span>
                </div>
                {isExpanded && (
                  <span className="text-sm font-medium text-foreground">{item.label}</span>
                )}
              </button>
              {!isExpanded && hoveredItem === item.id && (
                <motion.div
                  initial={{ opacity: 0, x: -4 }}
                  animate={{ opacity: 1, x: 0 }}
                  className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
                >
                  <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
                    {item.label}
                    <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
                  </div>
                </motion.div>
              )}
            </div>
          );
        })}
      </div>

      {/* Conversation History Section - å±•å¼€æ€æ˜¾ç¤º */}
      {isExpanded && (
        <div className="flex-1 overflow-y-auto border-t border-border">
          <div className="px-2 pt-2 pb-2">
            <div className="text-xs text-muted-foreground px-3 py-2 font-medium">
              å¯¹è¯å†å²
            </div>
            <div className="space-y-0.5">
              {conversations.slice(0, 20).map((conv) => (
                <ConversationItem
                  key={conv.id}
                  conversation={conv}
                  isActive={activeConversationId === conv.id}
                  isMenuOpen={menuOpenId === conv.id}
                  isEditing={editingId === conv.id}
                  editTitle={editTitle}
                  onSelect={() => handleSelectConversation(conv.id)}
                  onMenuToggle={() => setMenuOpenId(menuOpenId === conv.id ? null : conv.id)}
                  onStartEdit={() => {
                    setEditingId(conv.id);
                    setEditTitle(conv.title || "");
                    setMenuOpenId(null);
                  }}
                  onEditChange={setEditTitle}
                  onEditSave={() => handleRename(conv.id)}
                  onEditCancel={() => {
                    setEditingId(null);
                    setEditTitle("");
                  }}
                  onDelete={() => handleDelete(conv.id)}
                />
              ))}
              {isLoading && (
                <div className="px-3 py-2 text-xs text-muted-foreground">åŠ è½½ä¸­...</div>
              )}
              {!isLoading && conversations.length === 0 && (
                <div className="px-3 py-2 text-xs text-muted-foreground">æš‚æ— å¯¹è¯</div>
              )}
            </div>
          </div>
        </div>
      )}

      {/* æ”¶èµ·æ€æ—¶çš„å ä½ */}
      {!isExpanded && <div className="flex-1" />}

      {/* Settings Link */}
      <div className="px-2 py-1.5 border-t border-border">
        <Link
          href="/settings"
          className={cn(
            "w-full flex items-center gap-2.5 px-2.5 py-1.5 rounded-lg transition-all duration-200",
            "text-muted-foreground hover:bg-muted hover:text-foreground"
          )}
        >
          <div className="w-6 h-6 rounded-md bg-gradient-to-br from-vellum-100 to-vellum-200 flex items-center justify-center flex-shrink-0">
            <span className="text-sm">âš™ï¸</span>
          </div>
          <AnimatePresence>
            {isExpanded && (
              <motion.span
                initial={{ opacity: 0, width: 0 }}
                animate={{ opacity: 1, width: "auto" }}
                exit={{ opacity: 0, width: 0 }}
                className="text-sm font-medium overflow-hidden whitespace-nowrap"
              >
                è®¾ç½®
              </motion.span>
            )}
          </AnimatePresence>
        </Link>
      </div>
    </motion.nav>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ConversationItem Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface ConversationItemProps {
  conversation: ConversationItem;
  isActive: boolean;
  isMenuOpen: boolean;
  isEditing: boolean;
  editTitle: string;
  onSelect: () => void;
  onMenuToggle: () => void;
  onStartEdit: () => void;
  onEditChange: (value: string) => void;
  onEditSave: () => void;
  onEditCancel: () => void;
  onDelete: () => void;
}

function ConversationItem({
  conversation,
  isActive,
  isMenuOpen,
  isEditing,
  editTitle,
  onSelect,
  onMenuToggle,
  onStartEdit,
  onEditChange,
  onEditSave,
  onEditCancel,
  onDelete,
}: ConversationItemProps) {
  if (isEditing) {
    return (
      <div className="px-2 py-1">
        <input
          type="text"
          value={editTitle}
          onChange={(e) => onEditChange(e.target.value)}
          onKeyDown={(e) => {
            if (e.key === "Enter") onEditSave();
            if (e.key === "Escape") onEditCancel();
          }}
          onBlur={onEditSave}
          autoFocus
          className="w-full px-2 py-1 text-sm bg-background border border-border rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--accent-primary)]"
        />
      </div>
    );
  }

  return (
    <div className="relative group">
      <button
        onClick={onSelect}
        className={cn(
          "w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left transition-all duration-200",
          isActive
            ? "bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]"
            : "text-text-secondary hover:bg-muted hover:text-foreground"
        )}
      >
        <span className="text-sm flex-shrink-0 opacity-80">ğŸ’¬</span>
        <span className="text-sm truncate flex-1">{conversation.title || "æ–°å¯¹è¯"}</span>
      </button>

      {/* Menu Button */}
      <button
        onClick={(e) => {
          e.stopPropagation();
          onMenuToggle();
        }}
        aria-label="å¯¹è¯é€‰é¡¹"
        aria-expanded={isMenuOpen}
        aria-haspopup="menu"
        className={cn(
          "absolute right-1 top-1/2 -translate-y-1/2 p-1 rounded-md transition-opacity",
          "opacity-0 group-hover:opacity-100",
          isMenuOpen && "opacity-100",
          "text-muted-foreground hover:text-foreground hover:bg-muted",
          "focus-visible:opacity-100 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent"
        )}
      >
        <MoreHorizontal className="w-4 h-4" aria-hidden="true" />
      </button>

      {/* Dropdown Menu */}
      {isMenuOpen && (
        <div
          role="menu"
          aria-label="å¯¹è¯æ“ä½œ"
          className="absolute right-0 top-full mt-1 z-50 bg-card border border-border rounded-lg shadow-lg py-1 min-w-[120px]"
        >
          <button
            role="menuitem"
            onClick={(e) => {
              e.stopPropagation();
              onStartEdit();
            }}
            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left hover:bg-muted transition-colors focus-visible:outline-none focus-visible:bg-muted"
          >
            <Pencil className="w-3.5 h-3.5" aria-hidden="true" />
            <span>é‡å‘½å</span>
          </button>
          <button
            role="menuitem"
            onClick={(e) => {
              e.stopPropagation();
              onDelete();
            }}
            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-colors focus-visible:outline-none focus-visible:bg-red-50 dark:focus-visible:bg-red-950/20"
          >
            <Trash2 className="w-3.5 h-3.5" aria-hidden="true" />
            <span>åˆ é™¤</span>
          </button>
        </div>
      )}
    </div>
  );
}
