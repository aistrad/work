"""
Bazi Transit Calculator - DaYun (大运) and LiuNian (流年)
"""
from datetime import datetime
from typing import List, Dict, Any, Optional
from dataclasses import dataclass

from tools.shared import LunarCalendar


@dataclass
class DaYunPeriod:
    """A 10-year major luck period"""
    stem: str
    branch: str
    element: str
    start_age: int
    end_age: int
    start_year: int


@dataclass
class LiuNian:
    """A yearly fortune"""
    year: int
    stem: str
    branch: str
    element: str
    animal: str


class TransitCalculator:
    """
    Calculate transits: DaYun (大运) and LiuNian (流年)
    """

    @classmethod
    def calculate_dayun(
        cls,
        birth_year: int,
        month_stem: str,
        month_branch: str,
        gender: str = "male",
        start_age: int = 1
    ) -> List[DaYunPeriod]:
        """
        Calculate 大运 (Major Luck Cycles).
        Each cycle is 10 years.
        """
        stems = LunarCalendar.HEAVENLY_STEMS
        branches = LunarCalendar.EARTHLY_BRANCHES

        # Get starting indices
        stem_idx = stems.index(month_stem)
        branch_idx = branches.index(month_branch)

        # Direction: male yang year or female yin year -> forward
        # male yin year or female yang year -> backward
        year_stem, _ = LunarCalendar.get_year_ganzhi(birth_year)
        yang_stems = ["甲", "丙", "戊", "庚", "壬"]
        is_yang_year = year_stem in yang_stems
        is_male = gender.lower() in ["male", "男", "m"]

        forward = (is_male and is_yang_year) or (not is_male and not is_yang_year)

        periods = []
        current_age = start_age

        for i in range(8):  # 8 major periods
            if forward:
                s_idx = (stem_idx + i + 1) % 10
                b_idx = (branch_idx + i + 1) % 12
            else:
                s_idx = (stem_idx - i - 1) % 10
                b_idx = (branch_idx - i - 1) % 12

            stem = stems[s_idx]
            branch = branches[b_idx]

            periods.append(DaYunPeriod(
                stem=stem,
                branch=branch,
                element=LunarCalendar.get_element(stem),
                start_age=current_age,
                end_age=current_age + 9,
                start_year=birth_year + current_age
            ))

            current_age += 10

        return periods

    @classmethod
    def get_current_dayun(
        cls,
        dayun_periods: List[DaYunPeriod],
        current_age: int
    ) -> Optional[DaYunPeriod]:
        """Get the current DaYun period based on age"""
        for period in dayun_periods:
            if period.start_age <= current_age <= period.end_age:
                return period
        return None

    @classmethod
    def calculate_liunian(
        cls,
        start_year: int,
        count: int = 10
    ) -> List[LiuNian]:
        """Calculate yearly fortunes (流年)"""
        years = []

        for i in range(count):
            year = start_year + i
            stem, branch = LunarCalendar.get_year_ganzhi(year)
            animal = LunarCalendar.get_zodiac_animal(year)

            years.append(LiuNian(
                year=year,
                stem=stem,
                branch=branch,
                element=LunarCalendar.get_element(stem),
                animal=animal
            ))

        return years

    @classmethod
    def get_current_liunian(cls, year: Optional[int] = None) -> LiuNian:
        """Get current year's fortune"""
        if year is None:
            year = datetime.now().year

        stem, branch = LunarCalendar.get_year_ganzhi(year)
        animal = LunarCalendar.get_zodiac_animal(year)

        return LiuNian(
            year=year,
            stem=stem,
            branch=branch,
            element=LunarCalendar.get_element(stem),
            animal=animal
        )

    @classmethod
    def format_dayun(cls, periods: List[DaYunPeriod]) -> str:
        """Format DaYun periods as string"""
        lines = ["大运 (10年周期):", "─" * 40]

        for p in periods:
            lines.append(
                f"  {p.start_age:2d}-{p.end_age:2d}岁: {p.stem}{p.branch} "
                f"({p.element}) [{p.start_year}年起]"
            )

        return "\n".join(lines)

    @classmethod
    def format_liunian(cls, years: List[LiuNian]) -> str:
        """Format yearly fortunes as string"""
        lines = ["流年运势:", "─" * 40]

        for y in years:
            lines.append(
                f"  {y.year}年: {y.stem}{y.branch} "
                f"({y.element}·{y.animal}年)"
            )

        return "\n".join(lines)

    @classmethod
    def to_dict(cls, dayun: List[DaYunPeriod], liunian: List[LiuNian]) -> Dict[str, Any]:
        """Convert transits to dictionary"""
        return {
            "dayun": [
                {
                    "ganzhi": f"{p.stem}{p.branch}",
                    "element": p.element,
                    "start_age": p.start_age,
                    "end_age": p.end_age,
                    "start_year": p.start_year
                }
                for p in dayun
            ],
            "liunian": [
                {
                    "year": y.year,
                    "ganzhi": f"{y.stem}{y.branch}",
                    "element": y.element,
                    "animal": y.animal
                }
                for y in liunian
            ]
        }
