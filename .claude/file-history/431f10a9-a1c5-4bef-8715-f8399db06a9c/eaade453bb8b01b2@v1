"""
SSO Service - Cross-site Single Sign-On
"""
from typing import Optional
from uuid import UUID

from .jwt import JWTService
from stores.user_repo import UserRepository


class SSOService:
    """Cross-site Single Sign-On service"""

    # Valid target sites
    VALID_SITES = {
        "bazi": "bazi.vibelife.app",
        "zodiac": "zodiac.vibelife.app",
        "mbti": "mbti.vibelife.app",
        "id": "id.vibelife.app",
        "main": "vibelife.app"
    }

    @classmethod
    async def generate_sso_token(
        cls,
        user_id: str,
        vibe_id: str,
        target_site: str
    ) -> Optional[str]:
        """
        Generate SSO token for cross-site authentication.
        Token is short-lived (5 minutes) and site-specific.
        """
        if target_site not in cls.VALID_SITES:
            return None

        return JWTService.create_sso_token(
            user_id=user_id,
            vibe_id=vibe_id,
            target_site=target_site
        )

    @classmethod
    async def verify_sso_token(
        cls,
        token: str,
        target_site: str
    ) -> Optional[dict]:
        """
        Verify SSO token and return user info.
        Returns None if invalid.
        """
        payload = JWTService.verify_sso_token(token, target_site)
        if not payload:
            return None

        user_id = payload.get("sub")
        if not user_id:
            return None

        # Get user
        user = await UserRepository.get_by_id(UUID(user_id))
        if not user or user.get("status") != "active":
            return None

        return {
            "user_id": str(user["id"]),
            "vibe_id": user["vibe_id"],
            "display_name": user.get("display_name")
        }

    @classmethod
    async def exchange_sso_for_tokens(
        cls,
        sso_token: str,
        target_site: str
    ) -> Optional[dict]:
        """
        Exchange SSO token for access and refresh tokens.
        Used when user arrives at target site via SSO.
        """
        user_info = await cls.verify_sso_token(sso_token, target_site)
        if not user_info:
            return None

        # Generate site-specific tokens
        access_token = JWTService.create_access_token(
            user_info["user_id"],
            user_info["vibe_id"],
            extra_claims={"site": target_site}
        )
        refresh_token = JWTService.create_refresh_token(
            user_info["user_id"],
            user_info["vibe_id"]
        )

        return {
            "access_token": access_token,
            "refresh_token": refresh_token,
            "token_type": "bearer",
            "expires_in": JWTService.get_token_expiry(),
            "user": user_info
        }

    @classmethod
    def get_sso_redirect_url(cls, site_key: str, sso_token: str) -> Optional[str]:
        """Get SSO redirect URL for a site"""
        if site_key not in cls.VALID_SITES:
            return None

        domain = cls.VALID_SITES[site_key]
        return f"https://{domain}/auth/sso-callback?token={sso_token}"
