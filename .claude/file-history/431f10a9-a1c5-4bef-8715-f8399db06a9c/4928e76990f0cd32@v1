"""
Zodiac Events - Mercury Retrograde, Moon Phases, etc.
"""
from datetime import datetime, date
from typing import List, Dict, Any, Optional
from dataclasses import dataclass


@dataclass
class AstroEvent:
    """Astronomical event"""
    event_type: str
    name: str
    start_date: date
    end_date: Optional[date] = None
    description: Optional[str] = None


class ZodiacEvents:
    """
    Zodiac calendar events for 2026.
    """

    # Mercury Retrograde periods in 2026 (approximate)
    MERCURY_RETROGRADE_2026 = [
        AstroEvent(
            event_type="mercury_retrograde",
            name="水逆",
            start_date=date(2026, 1, 25),
            end_date=date(2026, 2, 14),
            description="水星逆行于水瓶座"
        ),
        AstroEvent(
            event_type="mercury_retrograde",
            name="水逆",
            start_date=date(2026, 5, 19),
            end_date=date(2026, 6, 11),
            description="水星逆行于双子座"
        ),
        AstroEvent(
            event_type="mercury_retrograde",
            name="水逆",
            start_date=date(2026, 9, 17),
            end_date=date(2026, 10, 9),
            description="水星逆行于天秤座"
        ),
    ]

    # New Moons 2026 (approximate)
    NEW_MOONS_2026 = [
        AstroEvent("new_moon", "新月", date(2026, 1, 11), description="摩羯座新月"),
        AstroEvent("new_moon", "新月", date(2026, 2, 10), description="水瓶座新月"),
        AstroEvent("new_moon", "新月", date(2026, 3, 11), description="双鱼座新月"),
        AstroEvent("new_moon", "新月", date(2026, 4, 10), description="白羊座新月"),
        AstroEvent("new_moon", "新月", date(2026, 5, 9), description="金牛座新月"),
        AstroEvent("new_moon", "新月", date(2026, 6, 8), description="双子座新月"),
        AstroEvent("new_moon", "新月", date(2026, 7, 7), description="巨蟹座新月"),
        AstroEvent("new_moon", "新月", date(2026, 8, 6), description="狮子座新月"),
        AstroEvent("new_moon", "新月", date(2026, 9, 4), description="处女座新月"),
        AstroEvent("new_moon", "新月", date(2026, 10, 4), description="天秤座新月"),
        AstroEvent("new_moon", "新月", date(2026, 11, 2), description="天蝎座新月"),
        AstroEvent("new_moon", "新月", date(2026, 12, 2), description="射手座新月"),
    ]

    # Full Moons 2026 (approximate)
    FULL_MOONS_2026 = [
        AstroEvent("full_moon", "满月", date(2026, 1, 26), description="狮子座满月"),
        AstroEvent("full_moon", "满月", date(2026, 2, 25), description="处女座满月"),
        AstroEvent("full_moon", "满月", date(2026, 3, 26), description="天秤座满月"),
        AstroEvent("full_moon", "满月", date(2026, 4, 25), description="天蝎座满月"),
        AstroEvent("full_moon", "满月", date(2026, 5, 24), description="射手座满月"),
        AstroEvent("full_moon", "满月", date(2026, 6, 23), description="摩羯座满月"),
        AstroEvent("full_moon", "满月", date(2026, 7, 22), description="水瓶座满月"),
        AstroEvent("full_moon", "满月", date(2026, 8, 21), description="双鱼座满月"),
        AstroEvent("full_moon", "满月", date(2026, 9, 19), description="双鱼座满月"),
        AstroEvent("full_moon", "满月", date(2026, 10, 18), description="白羊座满月"),
        AstroEvent("full_moon", "满月", date(2026, 11, 17), description="金牛座满月"),
        AstroEvent("full_moon", "满月", date(2026, 12, 16), description="双子座满月"),
    ]

    @classmethod
    def get_all_events(cls) -> List[AstroEvent]:
        """Get all events"""
        events = (
            cls.MERCURY_RETROGRADE_2026 +
            cls.NEW_MOONS_2026 +
            cls.FULL_MOONS_2026
        )
        return sorted(events, key=lambda e: e.start_date)

    @classmethod
    def is_mercury_retrograde(cls, check_date: date = None) -> bool:
        """Check if Mercury is retrograde"""
        if check_date is None:
            check_date = date.today()

        for event in cls.MERCURY_RETROGRADE_2026:
            if event.start_date <= check_date <= event.end_date:
                return True
        return False

    @classmethod
    def get_next_mercury_retrograde(cls, from_date: date = None) -> Optional[AstroEvent]:
        """Get next Mercury retrograde period"""
        if from_date is None:
            from_date = date.today()

        for event in cls.MERCURY_RETROGRADE_2026:
            if event.start_date >= from_date:
                return event
        return None

    @classmethod
    def get_upcoming_events(
        cls,
        from_date: date = None,
        days: int = 30,
        event_types: Optional[List[str]] = None
    ) -> List[AstroEvent]:
        """Get upcoming events within N days"""
        if from_date is None:
            from_date = date.today()

        end_date = date(
            from_date.year,
            from_date.month,
            min(from_date.day + days, 28)  # Simplified
        )

        all_events = cls.get_all_events()
        upcoming = []

        for event in all_events:
            if from_date <= event.start_date <= end_date:
                if event_types is None or event.event_type in event_types:
                    upcoming.append(event)

        return upcoming

    @classmethod
    def get_current_moon_phase(cls, check_date: date = None) -> str:
        """Get current moon phase (simplified)"""
        if check_date is None:
            check_date = date.today()

        # Find nearest new moon
        for i, nm in enumerate(cls.NEW_MOONS_2026):
            if nm.start_date >= check_date:
                # Calculate days since last new moon
                if i > 0:
                    last_nm = cls.NEW_MOONS_2026[i - 1]
                    days_since = (check_date - last_nm.start_date).days
                else:
                    days_since = 0

                if days_since < 4:
                    return "新月"
                elif days_since < 11:
                    return "上弦月"
                elif days_since < 18:
                    return "满月"
                else:
                    return "下弦月"

        return "未知"

    @classmethod
    def to_dict(cls, events: List[AstroEvent]) -> List[Dict[str, Any]]:
        """Convert events to dictionary list"""
        return [
            {
                "type": e.event_type,
                "name": e.name,
                "start_date": str(e.start_date),
                "end_date": str(e.end_date) if e.end_date else None,
                "description": e.description
            }
            for e in events
        ]
