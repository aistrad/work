"""
Bazi Analysis - Ten Gods, Five Elements strength
"""
from typing import Dict, Any, List
from dataclasses import dataclass

from .calculator import BaziChart
from tools.shared import LunarCalendar


@dataclass
class TenGodRelation:
    """Ten God (十神) relationship"""
    name: str
    chinese: str
    description: str
    position: str


class BaziAnalysis:
    """
    Analyze Bazi chart: Ten Gods, Five Elements, Patterns
    """

    # Ten Gods definitions
    TEN_GODS = {
        "比肩": {"en": "Rob Wealth", "desc": "同类相助，竞争"},
        "劫财": {"en": "Friend", "desc": "朋友助力，但需防劫财"},
        "食神": {"en": "Eating God", "desc": "才华、口福、子女"},
        "伤官": {"en": "Hurting Officer", "desc": "叛逆、创新、表达"},
        "偏财": {"en": "Indirect Wealth", "desc": "意外之财、副业"},
        "正财": {"en": "Direct Wealth", "desc": "正当收入、稳定财源"},
        "七杀": {"en": "Seven Killings", "desc": "压力、挑战、权威"},
        "正官": {"en": "Direct Officer", "desc": "事业、地位、规则"},
        "偏印": {"en": "Indirect Seal", "desc": "偏才、灵感、冷门"},
        "正印": {"en": "Direct Seal", "desc": "学业、贵人、母亲"},
    }

    # Five Elements relationships
    ELEMENT_RELATIONS = {
        "木": {"生": "火", "克": "土", "被生": "水", "被克": "金"},
        "火": {"生": "土", "克": "金", "被生": "木", "被克": "水"},
        "土": {"生": "金", "克": "水", "被生": "火", "被克": "木"},
        "金": {"生": "水", "克": "木", "被生": "土", "被克": "火"},
        "水": {"生": "木", "克": "火", "被生": "金", "被克": "土"},
    }

    @classmethod
    def analyze_five_elements(cls, chart: BaziChart) -> Dict[str, Any]:
        """Analyze Five Elements distribution"""
        elements = {"木": 0, "火": 0, "土": 0, "金": 0, "水": 0}

        # Count from stems
        for pillar in [chart.year, chart.month, chart.day, chart.hour]:
            stem_element = LunarCalendar.get_element(pillar.stem)
            if stem_element:
                elements[stem_element] += 1

            # Count from branches (main qi)
            branch_element = LunarCalendar.get_branch_element(pillar.branch)
            if branch_element:
                elements[branch_element] += 1

        total = sum(elements.values())

        return {
            "distribution": elements,
            "percentages": {
                k: round(v / total * 100, 1) if total > 0 else 0
                for k, v in elements.items()
            },
            "strongest": max(elements, key=elements.get),
            "weakest": min(elements, key=elements.get),
            "day_master": chart.day_element
        }

    @classmethod
    def calculate_ten_gods(cls, chart: BaziChart) -> Dict[str, str]:
        """Calculate Ten Gods for each position"""
        day_master = chart.day_element
        day_stem = chart.day_master

        # Yang/Yin determination
        yang_stems = ["甲", "丙", "戊", "庚", "壬"]
        is_day_yang = day_stem in yang_stems

        results = {}

        for position, pillar in [
            ("年干", chart.year.stem),
            ("月干", chart.month.stem),
            ("时干", chart.hour.stem),
            ("年支", chart.year.branch),
            ("月支", chart.month.branch),
            ("日支", chart.day.branch),
            ("时支", chart.hour.branch),
        ]:
            if position.endswith("干"):
                element = LunarCalendar.get_element(pillar)
                is_yang = pillar in yang_stems
            else:
                element = LunarCalendar.get_branch_element(pillar)
                # Branch yang/yin based on position
                yang_branches = ["子", "寅", "辰", "午", "申", "戌"]
                is_yang = pillar in yang_branches

            god = cls._get_ten_god(day_master, element, is_day_yang, is_yang)
            results[position] = god

        return results

    @classmethod
    def _get_ten_god(
        cls,
        day_element: str,
        target_element: str,
        day_yang: bool,
        target_yang: bool
    ) -> str:
        """Determine Ten God based on element relationship"""
        if not target_element:
            return ""

        relations = cls.ELEMENT_RELATIONS.get(day_element, {})
        same_polarity = day_yang == target_yang

        # Same element
        if target_element == day_element:
            return "比肩" if same_polarity else "劫财"

        # I produce (生)
        if relations.get("生") == target_element:
            return "食神" if same_polarity else "伤官"

        # I conquer (克)
        if relations.get("克") == target_element:
            return "偏财" if same_polarity else "正财"

        # Conquers me (被克)
        if relations.get("被克") == target_element:
            return "七杀" if same_polarity else "正官"

        # Produces me (被生)
        if relations.get("被生") == target_element:
            return "偏印" if same_polarity else "正印"

        return ""

    @classmethod
    def analyze_personality(cls, chart: BaziChart) -> Dict[str, Any]:
        """Generate personality analysis based on day master"""
        day_master_traits = {
            "甲": {
                "element": "阳木",
                "symbol": "参天大树",
                "traits": ["正直", "有担当", "领导力强", "有时固执"],
                "strengths": "有远大志向，能屈能伸",
                "challenges": "过于刚强，需学会柔韧"
            },
            "乙": {
                "element": "阴木",
                "symbol": "花草藤蔓",
                "traits": ["柔韧", "适应力强", "善于借力", "温和"],
                "strengths": "灵活变通，善于合作",
                "challenges": "有时优柔寡断"
            },
            "丙": {
                "element": "阳火",
                "symbol": "太阳",
                "traits": ["热情", "开朗", "有感染力", "直率"],
                "strengths": "照耀他人，充满正能量",
                "challenges": "有时过于冲动"
            },
            "丁": {
                "element": "阴火",
                "symbol": "烛光灯火",
                "traits": ["细腻", "聪慧", "有洞察力", "温暖"],
                "strengths": "照亮细节，善于思考",
                "challenges": "有时容易多虑"
            },
            "戊": {
                "element": "阳土",
                "symbol": "高山大地",
                "traits": ["稳重", "包容", "值得信赖", "厚实"],
                "strengths": "承载能力强，可靠",
                "challenges": "有时过于保守"
            },
            "己": {
                "element": "阴土",
                "symbol": "田园沃土",
                "traits": ["务实", "细心", "善于培养", "谨慎"],
                "strengths": "滋养他人，注重细节",
                "challenges": "有时过于计较"
            },
            "庚": {
                "element": "阳金",
                "symbol": "刀剑斧钺",
                "traits": ["果断", "有魄力", "重义气", "刚强"],
                "strengths": "决断力强，行动派",
                "challenges": "有时过于犀利"
            },
            "辛": {
                "element": "阴金",
                "symbol": "珠宝首饰",
                "traits": ["精致", "敏锐", "有品味", "注重细节"],
                "strengths": "追求完美，审美力强",
                "challenges": "有时过于挑剔"
            },
            "壬": {
                "element": "阳水",
                "symbol": "江河大海",
                "traits": ["智慧", "包容", "有谋略", "善变通"],
                "strengths": "思维活跃，善于规划",
                "challenges": "有时过于漂泊"
            },
            "癸": {
                "element": "阴水",
                "symbol": "雨露泉水",
                "traits": ["聪颖", "直觉强", "善于感应", "敏感"],
                "strengths": "滋润万物，善解人意",
                "challenges": "有时情绪波动"
            }
        }

        return day_master_traits.get(chart.day_master, {})

    @classmethod
    def to_analysis_dict(cls, chart: BaziChart) -> Dict[str, Any]:
        """Generate complete analysis dictionary"""
        elements = cls.analyze_five_elements(chart)
        ten_gods = cls.calculate_ten_gods(chart)
        personality = cls.analyze_personality(chart)

        return {
            "five_elements": elements,
            "ten_gods": ten_gods,
            "personality": personality
        }
