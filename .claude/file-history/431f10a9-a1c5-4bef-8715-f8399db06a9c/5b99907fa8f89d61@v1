"""
Bazi Calculator - Generate Bazi chart from birth datetime
"""
from datetime import datetime
from typing import Dict, Any, Tuple, Optional
from dataclasses import dataclass

from tools.shared import LunarCalendar, DateTimeUtils


@dataclass
class Pillar:
    """A pillar (柱) in Bazi"""
    stem: str       # 天干
    branch: str     # 地支
    element: str    # 五行
    hidden_stems: list  # 藏干


@dataclass
class BaziChart:
    """Complete Bazi Chart"""
    year: Pillar
    month: Pillar
    day: Pillar
    hour: Pillar
    day_master: str     # 日主 (Day Stem)
    day_element: str    # 日主五行
    birth_datetime: datetime


class BaziCalculator:
    """
    Calculate Bazi (Four Pillars) from birth datetime.
    """

    # Month stem calculation table (based on year stem)
    # Year stem -> First month stem index offset
    MONTH_STEM_OFFSET = {
        "甲": 2, "己": 2,  # 丙寅月
        "乙": 4, "庚": 4,  # 戊寅月
        "丙": 6, "辛": 6,  # 庚寅月
        "丁": 8, "壬": 8,  # 壬寅月
        "戊": 0, "癸": 0,  # 甲寅月
    }

    # Hour stem calculation (based on day stem)
    HOUR_STEM_OFFSET = {
        "甲": 0, "己": 0,
        "乙": 2, "庚": 2,
        "丙": 4, "辛": 4,
        "丁": 6, "壬": 6,
        "戊": 8, "癸": 8,
    }

    # Hidden stems in each branch (藏干)
    HIDDEN_STEMS = {
        "子": ["癸"],
        "丑": ["己", "癸", "辛"],
        "寅": ["甲", "丙", "戊"],
        "卯": ["乙"],
        "辰": ["戊", "乙", "癸"],
        "巳": ["丙", "庚", "戊"],
        "午": ["丁", "己"],
        "未": ["己", "丁", "乙"],
        "申": ["庚", "壬", "戊"],
        "酉": ["辛"],
        "戌": ["戊", "辛", "丁"],
        "亥": ["壬", "甲"],
    }

    @classmethod
    def calculate(cls, birth_datetime: datetime) -> BaziChart:
        """Calculate complete Bazi chart from birth datetime"""

        # Year pillar
        year_stem, year_branch = cls._calculate_year_pillar(birth_datetime)

        # Month pillar (based on solar term, simplified here)
        month_stem, month_branch = cls._calculate_month_pillar(
            birth_datetime, year_stem
        )

        # Day pillar
        day_stem, day_branch = cls._calculate_day_pillar(birth_datetime)

        # Hour pillar
        hour_stem, hour_branch = cls._calculate_hour_pillar(
            birth_datetime.hour, day_stem
        )

        return BaziChart(
            year=Pillar(
                stem=year_stem,
                branch=year_branch,
                element=LunarCalendar.get_element(year_stem),
                hidden_stems=cls.HIDDEN_STEMS.get(year_branch, [])
            ),
            month=Pillar(
                stem=month_stem,
                branch=month_branch,
                element=LunarCalendar.get_element(month_stem),
                hidden_stems=cls.HIDDEN_STEMS.get(month_branch, [])
            ),
            day=Pillar(
                stem=day_stem,
                branch=day_branch,
                element=LunarCalendar.get_element(day_stem),
                hidden_stems=cls.HIDDEN_STEMS.get(day_branch, [])
            ),
            hour=Pillar(
                stem=hour_stem,
                branch=hour_branch,
                element=LunarCalendar.get_element(hour_stem),
                hidden_stems=cls.HIDDEN_STEMS.get(hour_branch, [])
            ),
            day_master=day_stem,
            day_element=LunarCalendar.get_element(day_stem),
            birth_datetime=birth_datetime
        )

    @classmethod
    def _calculate_year_pillar(cls, dt: datetime) -> Tuple[str, str]:
        """Calculate year stem and branch"""
        # Year changes at 立春, simplified here to use Jan 1
        year = dt.year

        # Adjust for early year (before 立春)
        if dt.month == 1 or (dt.month == 2 and dt.day < 4):
            year -= 1

        return LunarCalendar.get_year_ganzhi(year)

    @classmethod
    def _calculate_month_pillar(
        cls,
        dt: datetime,
        year_stem: str
    ) -> Tuple[str, str]:
        """Calculate month stem and branch"""
        # Month branches are fixed:
        # 寅月(Feb), 卯月(Mar), 辰月(Apr), 巳月(May), 午月(Jun), 未月(Jul)
        # 申月(Aug), 酉月(Sep), 戌月(Oct), 亥月(Nov), 子月(Dec), 丑月(Jan)

        month_branches = [
            "丑", "寅", "卯", "辰", "巳", "午",
            "未", "申", "酉", "戌", "亥", "子"
        ]

        month_idx = dt.month - 1
        branch = month_branches[month_idx]

        # Calculate stem
        stems = LunarCalendar.HEAVENLY_STEMS
        offset = cls.MONTH_STEM_OFFSET.get(year_stem, 0)
        stem_idx = (offset + month_idx) % 10
        stem = stems[stem_idx]

        return stem, branch

    @classmethod
    def _calculate_day_pillar(cls, dt: datetime) -> Tuple[str, str]:
        """
        Calculate day stem and branch.
        Uses a reference date method.
        Reference: Jan 1, 1900 = 甲子日
        """
        reference = datetime(1900, 1, 1)
        delta = (dt - reference).days

        stems = LunarCalendar.HEAVENLY_STEMS
        branches = LunarCalendar.EARTHLY_BRANCHES

        stem_idx = delta % 10
        branch_idx = delta % 12

        return stems[stem_idx], branches[branch_idx]

    @classmethod
    def _calculate_hour_pillar(
        cls,
        hour: int,
        day_stem: str
    ) -> Tuple[str, str]:
        """Calculate hour stem and branch"""
        branch, _ = DateTimeUtils.get_chinese_hour(hour)

        # Calculate stem based on day stem
        stems = LunarCalendar.HEAVENLY_STEMS
        branches = LunarCalendar.EARTHLY_BRANCHES

        branch_idx = branches.index(branch)
        offset = cls.HOUR_STEM_OFFSET.get(day_stem, 0)
        stem_idx = (offset + branch_idx) % 10
        stem = stems[stem_idx]

        return stem, branch

    @classmethod
    def to_dict(cls, chart: BaziChart) -> Dict[str, Any]:
        """Convert chart to dictionary"""
        return {
            "year": {
                "ganzhi": f"{chart.year.stem}{chart.year.branch}",
                "stem": chart.year.stem,
                "branch": chart.year.branch,
                "element": chart.year.element,
                "hidden_stems": chart.year.hidden_stems
            },
            "month": {
                "ganzhi": f"{chart.month.stem}{chart.month.branch}",
                "stem": chart.month.stem,
                "branch": chart.month.branch,
                "element": chart.month.element,
                "hidden_stems": chart.month.hidden_stems
            },
            "day": {
                "ganzhi": f"{chart.day.stem}{chart.day.branch}",
                "stem": chart.day.stem,
                "branch": chart.day.branch,
                "element": chart.day.element,
                "hidden_stems": chart.day.hidden_stems
            },
            "hour": {
                "ganzhi": f"{chart.hour.stem}{chart.hour.branch}",
                "stem": chart.hour.stem,
                "branch": chart.hour.branch,
                "element": chart.hour.element,
                "hidden_stems": chart.hour.hidden_stems
            },
            "day_master": chart.day_master,
            "day_element": chart.day_element,
            "four_pillars": (
                f"{chart.year.stem}{chart.year.branch} "
                f"{chart.month.stem}{chart.month.branch} "
                f"{chart.day.stem}{chart.day.branch} "
                f"{chart.hour.stem}{chart.hour.branch}"
            ),
            "birth_datetime": str(chart.birth_datetime)
        }

    @classmethod
    def format_chart(cls, chart: BaziChart) -> str:
        """Format chart as readable string"""
        return f"""八字命盘
═══════════════════════════════════
      年柱    月柱    日柱    时柱
天干   {chart.year.stem}      {chart.month.stem}      {chart.day.stem}      {chart.hour.stem}
地支   {chart.year.branch}      {chart.month.branch}      {chart.day.branch}      {chart.hour.branch}
五行   {chart.year.element}      {chart.month.element}      {chart.day.element}      {chart.hour.element}
═══════════════════════════════════
日主: {chart.day_master} ({chart.day_element})
四柱: {chart.year.stem}{chart.year.branch} {chart.month.stem}{chart.month.branch} {chart.day.stem}{chart.day.branch} {chart.hour.stem}{chart.hour.branch}
"""
