# Fortune AI æœ€ç»ˆ MVP ç³»ç»Ÿè®¾è®¡ï¼ˆWeb å¯è½åœ° / PostgreSQL / GLMï¼‰

**æ–‡æ¡£ç±»å‹**ï¼šFinal MVP System Design
**äº§å“ä»£å·**ï¼š`Fortune AI`
**ç‰ˆæœ¬**ï¼šv3.0ï¼ˆ2026-01-01ï¼ŒMermaid + ASCII åŒæ ¼å¼ï¼‰
**æ—¥æœŸ**ï¼š2026-01-01  
**æ ¸å¿ƒå®šä½**ï¼šAI é©±åŠ¨çš„â€œäººç”Ÿå¯¼èˆª / é™ªä¼´ / æå‡ç³»ç»Ÿâ€ï¼ˆæœ‰æ•ˆè€Œæç®€ï¼‰  
**ç¡¬çº¦æŸ**ï¼šçº¯ AIï¼ˆä¸å¼•å…¥çœŸäººæœåŠ¡ï¼‰/ ä¸åšâ€œå…¬å¼€ç¤¾åŒº feedâ€ï¼ˆä»…åšéšç§ç¤¾äº¤ï¼‰/ Web ç«¯å¯è½åœ° / **Fortune AI ä¸šåŠ¡æ•°æ® SSOT ä½¿ç”¨ PostgreSQLï¼ˆDB=fortune_aiï¼‰**ï¼›æ·±åº¦æŠ¥å‘Šæ”¯æŒ `backend=cli|gemini`ï¼š`gemini` ä»…åœ¨è°ƒç”¨ gemini æŠ¥å‘Šé“¾è·¯æ—¶è¿æ¥ `DB=gemini`ï¼ˆ`gemini_job/gemini_task`ï¼‰ï¼Œ`cli` ä»…è°ƒç”¨ `cli_worker` çš„æ‰§è¡Œä¸çŠ¶æ€æŸ¥è¯¢ï¼ˆä¸šåŠ¡ SSOT ä»å†™å…¥ `fortune_ai`ï¼‰  
**LLM**ï¼š**GLMï¼ˆZ.AI / /api/paas/v4/chat/completionsï¼‰**  
**å…¥å£**ï¼š`/new`ï¼ˆNext.js åŒæ ï¼šZone A=å¯¹è¯ / Zone B=Dashboard Tabsï¼›æœªç™»å½•è·³è½¬ `/new/login`ï¼›`/main`/`/login`/`/register` ä¸ºå…¼å®¹è·³è½¬ï¼‰  

---

## æ›´æ–°è¯´æ˜ï¼ˆrev_20260101ï¼šå¯¹é½å½“å‰ä»£ç ï¼‰

### A. å®ç°åŸºçº¿ï¼ˆå½“å‰ä»£ç å·²å­˜åœ¨ï¼‰

- å‰ç«¯ï¼šNext.jsï¼ˆ`fortune_ai/web-app`ï¼‰ï¼Œ`basePath="/new"`ï¼Œå…¥å£ `http://<host>:8231/new`  
- åç«¯ï¼šFastAPIï¼ˆ`fortune_ai/api/main.py`ï¼‰+ routersï¼ˆ`fortune_ai/api/*_routes.py`ï¼‰ï¼Œå¯¹å¤–ç»Ÿä¸€ `/api/*`  
- è®¤è¯ï¼šCookie `fortune_session` + `fortune_csrf`ï¼›å†™æ“ä½œå¿…é¡»å¸¦ `X-CSRF-Token`ï¼ˆè§ `fortune_ai/api/deps.py`ã€`fortune_ai/api/auth_routes.py`ï¼‰  
- Chatï¼š`POST /api/chat/send`ï¼ˆA2UI JSONï¼‰+ `GET /api/chat/stream`ï¼ˆSSEï¼š`delta`/`final`/`[DONE]`ï¼‰  
- Dashboardï¼ˆZone Bï¼‰ï¼š`/api/dashboard/*`ï¼ˆ`overview/status/trends/tasks/relations/explore/kline`ï¼‰  
- æ·±åº¦æŠ¥å‘Šï¼š`/api/report/bazi/submit`ï¼ˆ`cli|gemini` å¼‚æ­¥ï¼‰+ `GET /api/report/bazi/{job_id}`ï¼›`/api/report/bazi/deep/submit`ï¼ˆGLM åŒæ­¥ï¼‰  
- æµ·æŠ¥ï¼š`POST /api/poster/generate` + `GET /api/poster/{poster_id}`ï¼ˆæ³¨æ„çŠ¶æ€æŸ¥è¯¢æ˜¯ `poster_id`ï¼Œä¸æ˜¯ `job_id`ï¼‰  
- ç›®æ ‡/å¤ç›˜ï¼š`/api/goal/*`ã€`/api/reflection/*`  
- éšç§ç¤¾äº¤å¼•æ“ï¼š`/api/social/*`ï¼ˆå¥½å‹/èƒ½é‡åŠ æ²¹/å¥½è¿æ¥é¾™/åˆ†äº«å¡ç‰‡ï¼›æ— å…¬å¼€å¹¿åœºï¼‰  

### B. ä¸åŸ v1.0 çš„å…³é”®å·®å¼‚ï¼ˆéœ€è¦åœ¨äº§å“/è¿ç»´å±‚æ˜ç¡®ï¼‰

- å…¥å£ä» `/main`ï¼ˆæ—§é¡µï¼‰è¿ç§»ä¸º `/new`ï¼ˆNext.jsï¼‰ï¼›åç«¯ `/`ã€`/main`ã€`/login`ã€`/register` åœ¨ `fortune_ai/api/main.py` åš `307` è·³è½¬åˆ° `/new*`ã€‚å¦‚æœå‰åç«¯åˆ†ç«¯å£éƒ¨ç½²ï¼ˆ8230/8231ï¼‰ï¼Œéœ€è¦åå‘ä»£ç†æˆ–æ”¹ä¸ºç»å¯¹ URLã€‚  
- æ—§çš„æ— é‰´æƒæ¥å£ `/api/calculate`ã€`/api/v2/*`ã€`/api/system-prompts`ã€`/api/files/*` å·²åœ¨ `fortune_ai/api/main.py` ç»Ÿä¸€è¿”å› `410 deprecated_use_new_api`ã€‚  
- Session Cookie å½“å‰å®ç°ä¸º **30 å¤©**ï¼ˆ`fortune_ai/api/auth_routes.py:_set_session_cookies`ï¼‰ï¼Œä¸éƒ¨åˆ†æ—§ spec çš„ **7 å¤©**ä¸ä¸€è‡´ï¼ˆå»ºè®®åç»­åšæˆå¯é…ç½®å¹¶ç»Ÿä¸€å£å¾„ï¼‰ã€‚  

### C. SSOT çº¦æŸï¼ˆæœ¬è½®éœ€é‡ç‚¹æ²»ç†ï¼‰

- ç›®æ ‡ï¼šä¸šåŠ¡ SSOT åªåœ¨ PostgreSQLã€‚å½“å‰ `fortune_ai/services/task_service.py` ä»å†™å…¥ `fortune_ai/services/conversation_store.py`ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰ä½œä¸ºå¤–éƒ¨ä»»åŠ¡ prompt/output çš„æ—¥å¿—ï¼Œå»ºè®®è¿ç§»åˆ° `fortune_external_job` æˆ–ç‹¬ç«‹å®¡è®¡è¡¨åç§»é™¤æ–‡ä»¶è½ç›˜ã€‚

---

## â˜… æ ¸å¿ƒæµç¨‹å›¾ (Mermaid)

> **å‘½åè§„èŒƒ**: å‚è§ [GLOSSARY.md](../GLOSSARY.md)
> **å®ç°çŠ¶æ€**: å‚è§ [GLOSSARY.md#9-api-å®ç°çŠ¶æ€çŸ©é˜µ](../GLOSSARY.md#9-api-å®ç°çŠ¶æ€çŸ©é˜µssot)

### 1. æ¶æ„å›¾ (ç»„ä»¶è¾¹ç•Œ)

```mermaid
graph TB
    subgraph Client["ğŸŒ Client Layer"]
        Browser["Browser"]
    end

    subgraph Proxy["âš¡ Reverse Proxy (:80/:443)"]
        Nginx["Nginx/Caddy"]
    end

    subgraph Frontend["ğŸ“± Next.js (:8231)"]
        ZoneA["Zone A<br/>Chat Thread"]
        ZoneB["Zone B<br/>Dashboard Tabs"]
        AppStore["Zustand Store<br/>+ CSRF Helper"]
    end

    subgraph Backend["ğŸ”§ FastAPI (:8230)"]
        direction TB
        Middleware["Middleware<br/>Auth | CSRF | RateLimit | CorrelationID"]

        subgraph Routes["Routers"]
            AuthR["auth_routes"]
            ChatR["chat_routes"]
            DashR["dashboard_routes"]
            ReportR["report_routes"]
            PosterR["poster_routes"]
        end

        subgraph Services["Services (L0-L3)"]
            L0["L0 æ•°å­¦è„‘<br/>bazi_facts"]
            L1["L1 å¿ƒç†è„‘<br/>soul_os"]
            L2["L2 çŸ¥è¯†è„‘<br/>kb_service"]
            L3["L3 è¯­è¨€è„‘<br/>glm_client"]
        end
    end

    subgraph External["ğŸ”— External"]
        GLM["GLM API<br/>Z.AI"]
        CLI["CLI Worker<br/>(æŠ¥å‘Šä»»åŠ¡)"]
    end

    subgraph Database["ğŸ—„ï¸ PostgreSQL (fortune_ai)"]
        UserTables["ç”¨æˆ·å±‚<br/>fortune_user<br/>fortune_user_session"]
        ConvTables["ä¼šè¯å±‚<br/>fortune_conversation_*<br/>fortune_commitment"]
        DataTables["æ•°æ®å±‚<br/>fortune_bazi_snapshot<br/>fortune_kline_daily"]
        KBTables["çŸ¥è¯†å±‚<br/>bazi_kb_chunk (FTS)"]
    end

    Browser --> Nginx
    Nginx -->|"/new/*"| Frontend
    Nginx -->|"/api/*"| Backend

    ZoneA --> AppStore
    ZoneB --> AppStore
    AppStore -->|"fetch + X-CSRF-Token"| Middleware

    Middleware --> Routes
    Routes --> Services

    L0 --> DataTables
    L1 --> DataTables
    L2 --> KBTables
    L3 --> GLM

    ReportR --> CLI

    Services --> UserTables
    Services --> ConvTables
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Client Layer                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                             â”‚
â”‚  â”‚  Browser   â”‚                                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Reverse Proxy (:80/:443)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚  Nginx / Caddy  â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚         â”‚
       â”‚ /new/*  â”‚ /api/*
       â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js (:8231)      â”‚    â”‚ FastAPI (:8230)                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Zone A   Zone B  â”‚ â”‚    â”‚ â”‚ Middleware: Auth | CSRF | Rate | Corr-ID   â”‚ â”‚
â”‚ â”‚  Chat   Dashboardâ”‚ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”‚ Routers:                                    â”‚ â”‚
â”‚ â”‚ Zustand Store    â”‚ â”‚    â”‚ â”‚ auth â”‚ chat â”‚ dashboard â”‚ report â”‚ poster  â”‚ â”‚
â”‚ â”‚ + CSRF Helper    â”‚â”€â”¼â”€â”€â”€â”€â”¼â–¶â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚ Services (L0-L3):                           â”‚ â”‚
                            â”‚ â”‚ L0 æ•°å­¦è„‘ â†’ L1 å¿ƒç†è„‘ â†’ L2 çŸ¥è¯†è„‘ â†’ L3 è¯­è¨€è„‘â”‚ â”‚
                            â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                                 â”‚                             â”‚
              â–¼                                 â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL           â”‚    â”‚ External Services           â”‚    â”‚ GLM API (Z.AI)  â”‚
â”‚ (fortune_ai)         â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”‚ CLI Worker (æŠ¥å‘Šä»»åŠ¡)   â”‚ â”‚    â”‚ chat/completionsâ”‚
â”‚ â”‚ ç”¨æˆ·: fortune_*  â”‚ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚                 â”‚
â”‚ â”‚ ä¼šè¯: conv_*     â”‚ â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ çŸ¥è¯†: bazi_kb_*  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

### 2. Chat æ—¶åºå›¾ (è¯·æ±‚-å“åº”-è½åº“)

```mermaid
sequenceDiagram
    autonumber
    participant U as User (Browser)
    participant N as Next.js
    participant F as FastAPI
    participant S as soul_os
    participant G as GLM (Z.AI)
    participant DB as PostgreSQL

    Note over U,DB: POST /api/chat/send (åŒæ­¥) æˆ– GET /api/chat/stream (SSE)

    U->>N: è¾“å…¥æ¶ˆæ¯
    N->>N: csrfHeaders()
    N->>F: POST /api/chat/send<br/>Header: X-CSRF-Token

    F->>F: require_csrf(request)
    alt CSRF æ ¡éªŒå¤±è´¥
        F-->>N: 403 csrf_invalid
        N-->>U: Toast é”™è¯¯
    end

    F->>DB: INSERT fortune_conversation_message (role=user)

    F->>S: get_full_context(user_id)
    S->>DB: SELECT fortune_bazi_snapshot (L0 facts)
    S->>DB: SELECT fortune_checkin (L1 PERMA)
    S->>DB: FTS bazi_kb_chunk (L2 kb_refs)
    S-->>F: {facts, perma, evidence, system_prompt}

    F->>F: anti_dependency.check()
    alt è§¦å‘åä¾èµ–
        F-->>N: A2UI {type: "anti_dependency_warning"}
        N-->>U: æ˜¾ç¤º"å…ˆè¡ŒåŠ¨"æç¤º
    end

    F->>G: POST /chat/completions<br/>{messages, stream: true/false}

    alt éæµå¼ (send)
        G-->>F: {content: A2UI JSON}
    else æµå¼ (stream)
        loop SSE chunks
            G-->>F: delta
            F-->>N: data: {"type":"delta","delta":"..."}
            N-->>U: å®æ—¶æ¸²æŸ“
        end
        G-->>F: [DONE]
        F-->>N: data: {"type":"final","data":{...}}
    end

    F->>F: _ensure_action_buttons()
    F->>DB: INSERT fortune_conversation_message (role=assistant, a2ui)
    F->>DB: INSERT fortune_commitment (status=suggested)
    F->>DB: INSERT fortune_agent_run (å®¡è®¡æ—¥å¿—)

    F-->>N: {ok: true, data: {a2ui, suggested_tasks}}
    N->>N: a2uiToBlocks() è½¬æ¢
    N-->>U: æ¸²æŸ“ A2UI ç»„ä»¶

    Note over U,DB: ç”¨æˆ·ç‚¹å‡» action_button

    U->>N: ç‚¹å‡» "å¼€å§‹è¡ŒåŠ¨"
    N->>F: POST /api/dashboard/task/accept<br/>{task_id, commitment_type}
    F->>DB: UPDATE fortune_commitment SET status='active', accepted_at=NOW()
    F-->>N: {ok: true}
    N->>N: invalidateQueries('tasks')
    N-->>U: Zone B è‡ªåŠ¨åˆ·æ–°
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Chat è¯·æ±‚-å“åº”-è½åº“ æ—¶åº                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    User          Next.js          FastAPI          soul_os          GLM           DB
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚â”€â”€[1]è¾“å…¥æ¶ˆæ¯â”€â–¶â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚â”€â”€csrfHeaders()â”€â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚â”€â”€[2]POST /api/chat/sendâ”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚             â”‚
      â”‚              â”‚    (X-CSRF-Token)               â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€require_csrf()â”‚              â”‚             â”‚
      â”‚              â”‚â—€â”€â”€403 csrf_invalid (å¦‚å¤±è´¥)â”€â”€â”€â”€â”€â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€[3]INSERT conv_msg (user)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€[4]get_full_context()â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚            â”‚
      â”‚              â”‚                â”‚                â”‚â”€â”€SELECT bazi_snapshotâ”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚                â”‚â”€â”€SELECT checkinâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚                â”‚â”€â”€FTS bazi_kb_chunkâ”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚â—€â”€â”€{facts, perma, evidence}â”€â”€â”€â”€â”‚            â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€anti_dependency.check()      â”‚             â”‚
      â”‚              â”‚â—€â”€â”€A2UI {anti_dependency_warning} (å¦‚è§¦å‘)â”€â”€â”€â”€â”€â”€â”‚             â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€[5]POST /chat/completionsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€{A2UI JSON}â”€â”€â”‚             â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€_ensure_action_buttons()     â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€[6]INSERT conv_msg (assistant)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚â”€â”€[7]INSERT commitment (suggested)â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚â”€â”€[8]INSERT agent_run (å®¡è®¡)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚â—€â”€â”€[9]{ok, a2ui, suggested_tasks}â”‚              â”‚             â”‚
      â”‚              â”‚â”€â”€a2uiToBlocks()â”‚                â”‚              â”‚             â”‚
      â”‚â—€â”€â”€[10]æ¸²æŸ“â”€â”€â”€â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
     â”€â”´â”€ ç”¨æˆ·ç‚¹å‡» action_button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚â”€â”€ç‚¹å‡»"å¼€å§‹"â”€â–¶â”‚                â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚â”€â”€POST task/acceptâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚â”€â”€UPDATE commitment (active)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚              â”‚â—€â”€â”€{ok: true}â”€â”€â”€â”‚                â”‚              â”‚             â”‚
      â”‚â—€â”€â”€Zone B åˆ·æ–°â”‚                â”‚              â”‚             â”‚
      â”‚              â”‚                â”‚                â”‚              â”‚             â”‚
```
</details>

### 3. æ‰¿è¯ºçŠ¶æ€æœº (Commitment Lifecycle)

```mermaid
stateDiagram-v2
    [*] --> suggested : Chat/Bento ç”Ÿæˆ

    suggested --> active : POST task/accept
    suggested --> canceled : è¶…æ—¶æ¸…ç† (24h)

    active --> done : POST task/done
    active --> skipped : POST task/skip
    active --> canceled : ç”¨æˆ·å–æ¶ˆ

    done --> [*]
    skipped --> [*]
    canceled --> [*]

    note right of suggested
        å†™å…¥: fortune_commitment
        status = 'suggested'
        accepted_at = NULL
    end note

    note right of active
        UPDATE fortune_commitment
        status = 'active'
        accepted_at = NOW()
    end note

    note right of done
        UPDATE fortune_commitment
        status = 'done'
        done_at = NOW()

        è§¦å‘: WCG æŒ‡æ ‡ +1
    end note
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚           Commitment çŠ¶æ€æœº                        â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚   [åˆå§‹]     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚ Chat/Bento ç”Ÿæˆ
                                                 â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                  suggested                          â”‚
                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                         â”‚  â”‚ å†™å…¥: fortune_commitment                      â”‚  â”‚
                         â”‚  â”‚ status = 'suggested', accepted_at = NULL     â”‚  â”‚
                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚                    â”‚
                      POST task/accept   â”‚                    â”‚ è¶…æ—¶æ¸…ç† (24h)
                                         â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     active                          â”‚    â”‚  canceled   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚             â”‚
â”‚  â”‚ UPDATE: status = 'active', accepted_at = NOW â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
          â”‚                 â”‚             â”‚                      â”‚
 POST task/done    POST task/skip    ç”¨æˆ·å–æ¶ˆ                    â”‚
          â”‚                 â”‚             â”‚                      â”‚
          â–¼                 â–¼             â–¼                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚    done     â”‚   â”‚   skipped   â”‚   â”‚  canceled   â”‚          â”‚
    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚             â”‚   â”‚             â”‚          â”‚
    â”‚ â”‚ WCG +1  â”‚ â”‚   â”‚             â”‚   â”‚             â”‚          â”‚
    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚             â”‚   â”‚             â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
           â”‚                 â”‚                 â”‚                 â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚   [ç»ˆæ€]     â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

### 4. å¤–éƒ¨ä»»åŠ¡çŠ¶æ€æœº (Report/Poster)

```mermaid
stateDiagram-v2
    [*] --> queued : POST submit

    queued --> processing : Worker pickup
    processing --> completed : æˆåŠŸ
    processing --> error : å¤±è´¥

    completed --> [*]
    error --> queued : ç”¨æˆ·é‡è¯•

    note right of queued
        å†™å…¥: fortune_external_job (report)
              fortune_poster (poster)
        status = 'queued'
    end note

    note left of processing
        å‰ç«¯è½®è¯¢: GET /{job_id}
        é—´éš”: 3ç§’
        è¶…æ—¶: 5åˆ†é’Ÿ
    end note

    note right of completed
        UPDATE status = 'completed'
        output_url / image_url å¡«å……
        å‰ç«¯: åœæ­¢è½®è¯¢, æ˜¾ç¤ºç»“æœ
    end note

    note left of error
        UPDATE status = 'error'
        error_message å¡«å……
        å‰ç«¯: æ˜¾ç¤ºé”™è¯¯ + é‡è¯•æŒ‰é’®
    end note
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           å¤–éƒ¨ä»»åŠ¡çŠ¶æ€æœº (Report / Poster)              â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  [åˆå§‹]   â”‚
                                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                          â”‚ POST submit
                                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                      queued                           â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
              â”‚  â”‚ å†™å…¥: fortune_external_job (report)              â”‚â”‚
              â”‚  â”‚       fortune_poster (poster)                    â”‚â”‚
              â”‚  â”‚ status = 'queued'                                â”‚â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚ Worker pickup
                                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                   processing                          â”‚
              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
              â”‚  â”‚ å‰ç«¯è½®è¯¢: GET /{job_id}                          â”‚â”‚
              â”‚  â”‚ é—´éš”: 3ç§’, è¶…æ—¶: 5åˆ†é’Ÿ                           â”‚â”‚
              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ æˆåŠŸ                   â”‚ å¤±è´¥
                             â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              completed                     â”‚  â”‚            error              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ UPDATE status = 'completed'           â”‚ â”‚  â”‚ â”‚ UPDATE status = 'error'   â”‚ â”‚
â”‚ â”‚ output_url / image_url å¡«å……            â”‚ â”‚  â”‚ â”‚ error_message å¡«å……        â”‚ â”‚
â”‚ â”‚ å‰ç«¯: åœæ­¢è½®è¯¢, æ˜¾ç¤ºç»“æœ               â”‚ â”‚  â”‚ â”‚ å‰ç«¯: æ˜¾ç¤ºé”™è¯¯ + é‡è¯•æŒ‰é’®  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                                          â”‚
                    â”‚                              ç”¨æˆ·é‡è¯•     â”‚
                    â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                          â”‚ (å›åˆ° queued)
                    â–¼                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  [ç»ˆæ€]    â”‚              â”‚  queued   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

### 5. è®¤è¯æ—¶åºå›¾

```mermaid
sequenceDiagram
    autonumber
    participant U as User
    participant N as Next.js
    participant F as FastAPI
    participant DB as PostgreSQL

    rect rgb(240, 248, 255)
        Note over U,DB: æ³¨å†Œæµç¨‹
        U->>N: å¡«å†™æ³¨å†Œè¡¨å•
        N->>F: POST /api/auth/register<br/>{email, password, birthday_local, ...}

        F->>DB: INSERT fortune_user
        F->>DB: UPSERT fortune_user_preferences
        F->>F: è®¡ç®—å…«å­— (True Solar Time)
        F->>DB: INSERT fortune_bazi_snapshot
        F->>DB: INSERT fortune_user_session

        F-->>N: Set-Cookie: fortune_session, fortune_csrf
        N-->>U: è·³è½¬åˆ° /new
    end

    rect rgb(255, 248, 240)
        Note over U,DB: åç»­è¯·æ±‚ (éœ€ CSRF)
        U->>N: å‘èµ· POST è¯·æ±‚
        N->>N: è¯»å– Cookie fortune_csrf
        N->>F: POST /api/...<br/>Header: X-CSRF-Token

        F->>F: require_csrf()<br/>sha256(header) == session.csrf_token_hash

        alt æ ¡éªŒå¤±è´¥
            F-->>N: 403 csrf_invalid
        else æ ¡éªŒæˆåŠŸ
            F->>F: ä¸šåŠ¡å¤„ç†
            F-->>N: 200 OK
        end
    end
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              è®¤è¯æ—¶åº (æ³¨å†Œ + CSRF æ ¡éªŒ)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                  æ³¨å†Œæµç¨‹
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    User             Next.js            FastAPI               PostgreSQL
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚â”€â”€å¡«å†™æ³¨å†Œè¡¨å•â”€â”€â–¶â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚â”€â”€POST /api/auth/registerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                 â”‚  {email, password, birthday_local, ...}  â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”‚â”€â”€INSERT fortune_userâ”€â–¶â”‚
      â”‚                 â”‚                  â”‚â”€â”€UPSERT preferencesâ”€â”€â–¶â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”‚ è®¡ç®—å…«å­— (True Solar Time)
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”‚â”€â”€INSERT bazi_snapshotâ–¶â”‚
      â”‚                 â”‚                  â”‚â”€â”€INSERT user_sessionâ”€â–¶â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚â—€â”€Set-Cookie: fortune_session, fortune_csrf
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚â—€â”€â”€è·³è½¬åˆ° /newâ”€â”€â”€â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”‚                       â”‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                         åç»­è¯·æ±‚ (éœ€ CSRF æ ¡éªŒ)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    User             Next.js            FastAPI               PostgreSQL
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚â”€â”€å‘èµ· POSTâ”€â”€â”€â”€â”€â–¶â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚ è¯»å– Cookie fortune_csrf                 â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚â”€â”€POST /api/...â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
      â”‚                 â”‚  Header: X-CSRF-Token                    â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”‚ require_csrf():       â”‚
      â”‚                 â”‚                  â”‚ sha256(header) ==     â”‚
      â”‚                 â”‚                  â”‚ session.csrf_token_hash
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”œâ”€â”€ æ ¡éªŒå¤±è´¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                 â”‚â—€â”€â”€403 csrf_invalidâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                 â”‚                  â”‚                       â”‚
      â”‚                 â”‚                  â”œâ”€â”€ æ ¡éªŒæˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                 â”‚                  â”‚ ä¸šåŠ¡å¤„ç†...           â”‚
      â”‚                 â”‚â—€â”€â”€200 OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
      â”‚                 â”‚                  â”‚                       â”‚
```
</details>

### 6. MVP ä¼˜å…ˆçº§å†³ç­– (Auth æ¨¡å—)

| é¡¹ç›® | MVP | vNext | è¯´æ˜ |
|------|:---:|:-----:|------|
| Cookie Session (30å¤©) | âœ“ | - | å½“å‰å®ç° |
| Session æœ‰æ•ˆæœŸå¯é…ç½® | âœ“ | - | `AUTH_SESSION_DAYS` env |
| ç»Ÿä¸€ CSRF Helper | âœ“ | - | æŠ½å– `lib/csrf.ts` |
| ä¼šè¯åˆ—è¡¨/æ³¨é”€è®¾å¤‡ | - | âœ“ | å·²æœ‰ APIï¼Œå¾…å‰ç«¯ |
| SameSite/Secure | âœ“ | - | ç”Ÿäº§ç¯å¢ƒå¿…é¡» |
| Refresh Token æœºåˆ¶ | - | âœ“ | å¤æ‚åº¦é«˜ï¼ŒMVP ä¸åš |

---

### 7. å·²çŸ¥é—®é¢˜æ¸…å• (æŒ‰ä¼˜å…ˆçº§)

> **SSOT**: å®ç°çŠ¶æ€è¯·å‚è§ [GLOSSARY.md#9-api-å®ç°çŠ¶æ€çŸ©é˜µ](../GLOSSARY.md#9-api-å®ç°çŠ¶æ€çŸ©é˜µssot)

#### P0 (é˜»å¡æ ¸å¿ƒåŠŸèƒ½)

| # | é—®é¢˜ | ä½ç½® | çŠ¶æ€ | ä¿®å¤å»ºè®® |
|---|------|------|:----:|----------|
| ~~1~~ | ~~fortune_kline_daily è¡¨æœªåˆ›å»º~~ | ~~DB schema~~ | âœ… å·²ä¿®å¤ | å·²åœ¨ `20260101_poster_kline.sql` |
| 2 | MarkdownTextBlock.content æ˜ å°„ | app-store.ts:210 | ğŸ” å¾…éªŒè¯ | ç¡®è®¤ dataâ†’content è½¬æ¢æ­£ç¡® |

#### P1 (å½±å“ç”¨æˆ·ä½“éªŒ)

| # | é—®é¢˜ | ä½ç½® | çŠ¶æ€ | ä¿®å¤å»ºè®® |
|---|------|------|:----:|----------|
| 3 | validation-points API ç¼ºå¤± | auth_routes.py | â³ å¾…å®ç° | å®ç°"é‚£å°±æ˜¯æˆ‘"éªŒè¯ç‚¹ |
| 4 | poster å‰ç«¯é›†æˆæœªå®Œæˆ | web-app | â³ å¾…å®ç° | æ·»åŠ æµ·æŠ¥é¢„è§ˆç»„ä»¶ |
| 5 | Session æœ‰æ•ˆæœŸä¸ spec ä¸ä¸€è‡´ | auth_routes.py | ğŸ“ æ–‡æ¡£å¯¹é½ | å·²æ”¹ä¸º 30 å¤©ï¼Œéœ€æ›´æ–° spec |
| 6 | åä¾èµ–æ— è±å…æœºåˆ¶ | soul_os.py | â³ å¾…å®ç° | æ·»åŠ  exempt_phrases |
| 7 | window.location.reload() | blocks/index.tsx | â³ å¾…ä¼˜åŒ– | æ”¹ç”¨ invalidateQueries |

#### P2 (åç»­ä¼˜åŒ–)

| # | é—®é¢˜ | ä½ç½® | çŠ¶æ€ | ä¿®å¤å»ºè®® |
|---|------|------|:----:|----------|
| 8 | æ—  correlation_id è¿½è¸ª | chat_routes.py | â³ å¾…å®ç° | æ·»åŠ  X-Request-ID |
| 9 | CSRF helpers é‡å¤å®šä¹‰ | api.ts, blocks/index.tsx | â³ å¾…é‡æ„ | æŠ½å–åˆ° lib/csrf.ts |
| 10 | K-line å‰ç«¯èœ¡çƒ›å›¾æœªå®ç° | trends-tab.tsx | â³ å¾…å®ç° | æ›¿æ¢ä¸º K-line ç»„ä»¶ |
| 11 | Settings Tab UI ä¸å®Œæ•´ | web-app | â³ å¾…å®ç° | å®Œå–„è®¾ç½®é¡µé¢ |

å›¾ä¾‹: âœ… å·²ä¿®å¤ | ğŸ” å¾…éªŒè¯ | â³ å¾…å®ç° | ğŸ“ æ–‡æ¡£å¯¹é½

---

## 0. ä¸€é¡µç»“è®ºï¼ˆç»™äº§å“ & å¼€å‘ï¼‰

### 0.1 MVP äº¤ä»˜ç›®æ ‡

åœ¨ Web ç«¯è·‘é€šä¸€ä¸ªå¯é‡å¤ã€å¯åº¦é‡ã€å¯è¿½æº¯çš„â€œé™ªè·‘é—­ç¯â€ï¼š

`Clarify â†’ Insight â†’ Prescription â†’ Commitment â†’ Action â†’ Reflection â†’ Memory Update`

å¹¶ç”¨æœ€å°äº¤äº’æ‰¿è½½ä¸‰å¤§ä»·å€¼ï¼š
- **å¯¼èˆª**ï¼šæŠŠé—®é¢˜ç»“æ„åŒ–æˆ `Options / Constraints / Risk Boundary / Next Experiment`
- **é™ªä¼´**ï¼šä»¥ç§¯æå¿ƒç†å­¦ / Performance Coach è¯æœ¯æ‰¿æ¥æƒ…ç»ªï¼ˆä¸æå“ã€ä¸å®¿å‘½ï¼‰
- **æå‡**ï¼šæŠŠè¾“å‡ºæ”¶æ•›ä¸ºå¯æ‰§è¡Œè¡ŒåŠ¨ä¸èƒ½åŠ›è®­ç»ƒè½¨é“ï¼ˆ30 å¤©è®¡åˆ’ + å¤ç›˜ï¼‰

### 0.2 åŒ—ææ˜ŸæŒ‡æ ‡ï¼ˆç»Ÿä¸€å£å¾„ï¼‰

`WCG`ï¼ˆWeekly Closed-loop Guidanceï¼‰  
å®šä¹‰ï¼šç”¨æˆ·åœ¨ä¸€å‘¨å†…å®Œæˆ â‰¥1 æ¬¡â€œè§¦å‘ â†’ æŒ‡å¼• â†’ è¡ŒåŠ¨ â†’ åé¦ˆâ€é—­ç¯ã€‚

### 0.3 æœ€ç»ˆåˆå¹¶å†³ç­–ï¼ˆCodex MVP Ã— Claude MVPï¼‰

| å†³ç­–ç‚¹ | æœ€ç»ˆæ–¹æ¡ˆï¼ˆFinal MVPï¼‰ | å–èˆç†ç”± |
|---|---|---|
| é—­ç¯æ ¸å¿ƒ | å¼•å…¥ `Commitment`ï¼ˆ4 ç±»æ‰¿è¯ºï¼‰ | æ²¡æœ‰æ‰¿è¯ºå°±æ²¡æœ‰é—­ç¯ï¼›ä¸â€œæå‡â€ä¸€è‡´ |
| äº¤äº’æ•ˆç‡ | â€œä¸‰ç‚¹å‡»åŸåˆ™â€ä½œä¸ºéªŒæ”¶æ ‡å‡† | å¯éªŒæ”¶ã€å¯è¿­ä»£ã€å¯æ§å¤æ‚åº¦ |
| å¸ƒå±€ | **ä¸¤æ **ï¼ˆå¯¹è¯ + åŠŸèƒ½åŒºï¼›ä¼šè¯å†å²ä¸ºæŠ½å±‰/å¼¹å±‚ï¼‰ | ä¿æŒæç®€ä¸é«˜æ•ˆï¼›å¤šä¼šè¯ä»å¯ç”¨ä½†ä¸å å¸¸é©»ç©ºé—´ |
| Bento | å¡ç‰‡ä¸ºå†…å®¹ + Tab ä¸ºå®¹å™¨ | å¡ç‰‡å¯å¤ç”¨ã€Tab å¯ç»„ç»‡å¤æ‚åº¦ |
| è®¡åˆ’ | 4 ä¸ªé¢„è®¾è®¡åˆ’å¼€ç®±å³ç”¨ + 30 å¤©è½¨é“ç»Ÿä¸€å£å¾„ | é™ä½é€‰æ‹©æˆæœ¬ï¼ŒåŒæ—¶ä¿è¯â€œæå‡â€å¯åº¦é‡ |
| çŸ¥è¯†åº“ | **PostgreSQL FTS + pg_trgm**ï¼ˆä¸å¼•å…¥å…¶ä»– DBï¼‰ | å¯çœŸå®è½åœ°ã€å¯è¿ç»´ã€å¯è¿½æº¯ |
| LLM | GLMï¼ˆZ.AI / ChatGLM-4ï¼‰ | ç»Ÿä¸€å¯¹è¯ä¸æ–‡æœ¬ç”Ÿæˆåç«¯ï¼Œä¾¿äºæ²»ç† |

---

## 1. äº§å“åŸåˆ™ï¼ˆç¡¬è§„åˆ™ï¼Œå¯éªŒæ”¶ï¼‰

### 1.1 ä¸‰ç‚¹å‡»åŸåˆ™

ä»»ä½•æ ¸å¿ƒä»·å€¼éƒ½å¿…é¡»åœ¨ â‰¤3 æ¬¡ç‚¹å‡»å†…å®Œæˆï¼š
- æ‰“å¼€ `/new` â†’ çœ‹ä»Šæ—¥æŒ‡å¼• â†’ é€‰æ‹©ä¸€ä¸ªè¡ŒåŠ¨ï¼ˆCommitmentï¼‰
- ç‚¹â€œæƒ…ç»ªæ‰“å¡â€ â†’ é€‰æƒ…ç»ª/å¼ºåº¦ â†’ è·å¾—ä¸€ä¸ªè°ƒèŠ‚åŠ¨ä½œå¹¶å¼€å§‹
- ç‚¹â€œå†³ç­–æ¨¡æ¿â€ â†’ é€‰é—®é¢˜ç±»å‹ â†’ ç”Ÿæˆä¸‹ä¸€æ­¥å®éªŒå¹¶åŠ å…¥å¾…åŠ

### 1.2 æ¯æ¬¡äº¤äº’å¿…è½åˆ° Commitment

`commitment_type`ï¼ˆä»… 4 ç±»ï¼‰ï¼š
- `start_task`ï¼šç«‹åˆ»å¼€å§‹ï¼ˆâ‰¤5 åˆ†é’Ÿä¼˜å…ˆï¼‰
- `schedule_task`ï¼šåŠ å…¥ä»Šæ—¥/æœ¬å‘¨å¹¶è®¾æé†’
- `ask_followup`ï¼šé€‰æ‹©ä¸€ä¸ªæ¾„æ¸…é—®é¢˜ç»§ç»­ï¼ˆå‡å°‘å¼€æ”¾å¼è¿½é—®ï¼‰
- `opt_out`ï¼šæš‚åœ/å…³é—­ï¼ˆæ¨é€ä¸åä¾èµ–çš„å¿…è¦å‡ºå£ï¼‰

### 1.3 åä¾èµ–æœºåˆ¶ï¼ˆé˜²ç„å­¦ä¾èµ–ï¼‰

| è§¦å‘æ¡ä»¶ | ç³»ç»Ÿå“åº”ï¼ˆé»˜è®¤æ¸©å’Œï¼‰ |
|---|---|
| è¿ç»­ 3 æ¬¡é—®åŒä¸€é—®é¢˜ | å¼ºåˆ¶ç»™â€œç°å®è¡ŒåŠ¨å®éªŒâ€ï¼ˆ5â€“15 åˆ†é’Ÿï¼‰åå†ç»§ç»­ï¼›æä¾›â€œæˆ‘æ„¿æ„æ‰§è¡Œ/ç¨å/ä¸å†æç¤ºâ€ |
| å½“æ—¥å’¨è¯¢ > 5 æ¬¡ | æç¤ºâ€œä¿¡æ¯è¶³å¤Ÿï¼Œå…ˆè¡ŒåŠ¨â€ï¼›ç»™ 1 ä¸ªæœ€å°ä»»åŠ¡å¹¶ç»“æŸå›åˆ |
| è½¨é“è¾¾æ ‡æ¯•ä¸š | ä¸»åŠ¨é™é¢‘æ¨é€ï¼›å¼ºè°ƒè‡ªæˆ‘æŒæ§ï¼›å¼•å¯¼è¿›å…¥ç»´æŠ¤æœŸæˆ–æ¢è½¨é“ |

### 1.4 Agent è§’è‰²ä¼˜å…ˆçº§ï¼ˆä¸å¯é€†ï¼‰

`Coach > Teaching Assistant > Customer Support > Sales`

é”€å”®è§„åˆ™ï¼š**å…ˆäº¤ä»˜ä»·å€¼ï¼Œå†ç»™å‡çº§è·¯å¾„**ï¼›ç¦æ­¢æå“å¼è½¬åŒ–ã€‚

---

## 2. å‰ç«¯äº¤äº’ï¼ˆWeb /newï¼šåŒæ  + Tabsï¼ŒNext.jsï¼‰

### 2.1 ç™»å½•ä¸ç”¨æˆ·ç®¡ç†ï¼ˆæ— æ¸¸å®¢æ¨¡å¼ï¼‰

- æœªç™»å½•è®¿é—® `/new` æ—¶ï¼Œå‰ç«¯åœ¨è°ƒç”¨å—ä¿æŠ¤ APIï¼ˆå¦‚ `GET /api/dashboard/overview`ï¼‰è¿”å› `401/403` åè·³è½¬ `/new/login`ï¼ˆå½“å‰å®ç°è§ `fortune_ai/web-app/src/lib/api.ts`ï¼‰ã€‚  
- `/new/login`ï¼šç™»å½• / æ³¨å†ŒäºŒåˆä¸€ï¼ˆå·¦ä¾§è¡¨å• + å³ä¾§å‘½ç›˜é¢„è§ˆ + éªŒè¯ç‚¹ï¼‰  
- `/new/register`ï¼šå®Œæ•´æ³¨å†Œé¡µï¼ˆåŸºç¡€ Profileï¼‰  
- å…¼å®¹å…¥å£ï¼šåç«¯ `/login`ã€`/register`ã€`/main` ä»…åšé‡å®šå‘ï¼ˆ`fortune_ai/api/main.py`ï¼‰  
- `è®¾ç½®` Tab å¿…é¡»åŒ…å«ï¼š
  - ä¿®æ”¹å¯†ç 
  - é€€å‡ºç™»å½•
  - æ³¨é”€è´¦æˆ·ï¼ˆè½¯åˆ é™¤ï¼Œæ¸…ç©ºä¼šè¯ï¼‰

### 2.2 é¡µé¢ç»“æ„

`/new` åŒæ å¸ƒå±€ï¼ˆZone A / Zone Bï¼‰ï¼š
- å·¦ï¼šå¯¹è¯çº¿ç¨‹ï¼ˆChat Threadï¼ŒSSOTï¼‰+ é¡¶éƒ¨ä¼šè¯åˆ‡æ¢ï¼›ä¼šè¯å†å²ä»¥**æŠ½å±‰/å¼¹å±‚**å‘ˆç°ï¼ˆä¸å¸¸é©»ï¼‰
- å³ï¼šåŠŸèƒ½åŒºï¼ˆBento/Workbenchï¼Œæ‰¿è½½æ‰€æœ‰éè¯­è¨€äº¤äº’ï¼‰

**ASCIIï¼ˆæ¡Œé¢ç«¯ /new ç»“æ„ï¼‰**

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Fortune AI | ä¼šè¯ â–¼ | é£æ ¼: warm | è®¾ç½® | é€€å‡º                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Chat Thread (SSOT)             â”‚ Bento / Workbench                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ Tabs: [Bento] [å·¥å…·] [è®¾ç½®]               â”‚
â”‚ Â· ä¼šè¯å†å²ï¼ˆæŠ½å±‰/å¼¹å±‚ï¼ŒæŒ‰éœ€å¼€ï¼‰ â”‚                                           â”‚
â”‚ Â· æ¶ˆæ¯æµï¼ˆç”¨æˆ·/æ•™ç»ƒï¼‰          â”‚ 6 å¼ æ ¸å¿ƒå¡ç‰‡ï¼ˆ1 tap å¯åŠ¨ï¼‰                 â”‚
â”‚ Â· è¾“å…¥æ¡† + å¿«æ·åŠ¨ä½œ            â”‚ + å·¥å…·ï¼šå…«å­—æŠ¥å‘Š/æ ¡å‡†/é“æ¿                 â”‚
â”‚                                â”‚ + è®¾ç½®ï¼špush/é™é»˜/éšç§/è¯­è¨€é£æ ¼           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å³ä¾§ Bentoï¼ˆTab ä½œä¸ºå®¹å™¨ï¼Œå¡ç‰‡ä¸ºå†…å®¹ï¼‰

å³ä¾§å›ºå®š 3 ä¸ª Tabï¼š
- `Bento`ï¼ˆé»˜è®¤ï¼‰ï¼š6 å¼ æ ¸å¿ƒå¡ç‰‡
- `å·¥å…·`ï¼šå…«å­—æŠ¥å‘Š / å‡ºç”Ÿæ ¡å‡† / é“æ¿ç¥ç®—
- `è®¾ç½®`ï¼šè¯­è¨€é£æ ¼ / æ¨é€ä¸é™é»˜æ—¶æ®µ / éšç§ä¸æ•°æ®ç®¡ç†

**Bento 6 å¼ æ ¸å¿ƒå¡ç‰‡ï¼ˆå…¨éƒ¨ 1 tap å¯åŠ¨ï¼‰**
1) `ä»Šæ—¥æŒ‡å¼•`ï¼šç»“è®º + 1 ä¸ªåŠ¨ä½œï¼ˆæŒ‰é’®ï¼‰  
2) `è¡ŒåŠ¨å¤„æ–¹`ï¼šæœ€å¤š 3 ä¸ªè¿›è¡Œä¸­ä»»åŠ¡ï¼ˆå®Œæˆ/è·³è¿‡/å¤ç›˜ï¼‰  
3) `æƒ…ç»ªæ‰“å¡`ï¼šæƒ…ç»ª + å¼ºåº¦ï¼ˆ0â€“10ï¼‰â†’ å½’å›  + 1 ä¸ªè°ƒèŠ‚åŠ¨ä½œ  
4) `æˆé•¿è®¡åˆ’`ï¼šé¢„è®¾è®¡åˆ’ï¼ˆ4 ä¸ªï¼‰+ 30 å¤©æ¸¸ç¨‹è½¨é“ï¼ˆç»Ÿä¸€è¿›åº¦å£å¾„ï¼‰  
5) `å†³ç­–æ¨¡æ¿`ï¼šDecision Briefï¼ˆOptions/Constraints/Risks/Next Experimentï¼‰  
6) `è¯æœ¯ç”Ÿæˆ`ï¼šåœºæ™¯ â†’ å¯å¤åˆ¶æ¨¡æ¿ï¼ˆæ²Ÿé€š/è¾¹ç•Œ/æ‹’ç»/è°ˆåˆ¤ï¼‰  

### 2.4 è¯­è¨€é£æ ¼ï¼ˆè¡¨è¾¾å±‚ï¼‰

`persona_style`ï¼š
- `standard`ï¼šæ¸…æ™°ã€ä¸­æ€§ã€ä¸“ä¸š
- `warm`ï¼šå…±æƒ…ã€æ”¯æŒæ€§ï¼ˆé»˜è®¤ï¼‰
- `roast`ï¼šè½»æ¯’èˆŒä½†ä¸ç¾è¾±ã€ä¸åšäººèº«å®šæ€§

---

## 3. Chat Agentï¼ˆGLMï¼‰è®¾è®¡

### 3.1 â€œåç«¯ä¸“ä¸šåˆ†æâ€åˆ°â€œæ•™ç»ƒè¡¨è¾¾â€çš„ç¿»è¯‘è§„åˆ™

åç«¯äº§å‡ºä¸¤ç±»è¾“å…¥ç»™ LLMï¼š
- `facts`ï¼šç¡®å®šæ€§äº‹å®ï¼ˆå…«å­—è®¡ç®—ã€ç”¨æˆ·åå¥½ã€è®¡åˆ’è¿›åº¦ã€å†å²åé¦ˆï¼‰
- `evidence`ï¼šè¯æ®ï¼ˆè§„åˆ™ ID + çŸ¥è¯†åº“å¼•ç”¨ + `facts_hash`ï¼‰

LLM åªåšä¸‰ä»¶äº‹ï¼š
1) å…±æƒ…æ‰¿æ¥ï¼ˆç§¯æå¿ƒç†å­¦ï¼‰
2) ç»“æ„åŒ–è§£é‡Šï¼ˆæŠŠé—®é¢˜æ‹†æˆå¯æ§/ä¸å¯æ§/éœ€æ¾„æ¸…ï¼‰
3) ç”Ÿæˆè¡ŒåŠ¨å¤„æ–¹ + æ‰¿è¯ºé‚€è¯·ï¼ˆâ‰¤3 æ¡å¤„æ–¹ï¼‰

LLM ç¦æ­¢åšï¼š
- è‡ªè¡Œæ¨æ–­å…«å­—äº‹å®ã€ç¼–é€ ç»å…¸å‡ºå¤„ã€è¾“å‡ºç¡®å®šæ€§å®¿å‘½è®ºæ–­è¨€

### 3.2 ç»Ÿä¸€å¯¹è¯ç»“æ„ï¼ˆ6 æ­¥ï¼‰

1) æƒ…ç»ªç¡®è®¤  
2) ç»“æ„è§£é‡Šï¼ˆå¯¼èˆªï¼‰  
3) è¡ŒåŠ¨å¤„æ–¹ï¼ˆâ‰¤3ï¼‰  
4) æ—¶é—´çª—å£ï¼ˆé»˜è®¤å¹²é¢„çª—å£ï¼‰  
5) é£é™©è¾¹ç•Œï¼ˆåŒ»ç–—/æ³•å¾‹/æŠ•èµ„ç­‰ï¼‰  
6) æ‰¿è¯ºé‚€è¯·ï¼ˆCommitmentï¼‰  

### 3.3 GLM æ¥å…¥æ–¹å¼ï¼ˆZ.AI OpenAI-compatï¼‰

é…ç½®æ¥æºï¼š`/home/aiscend/work/docs/apikey.md`

**å¿…é¡»ç¯å¢ƒå˜é‡ï¼ˆä¸åœ¨æ–‡æ¡£ä¸­å†™æ˜å¯†é’¥å€¼ï¼‰**
- `GLM_BASE_URL=https://api.z.ai/api/paas/v4`
- `GLM_API_KEY=$ZAI_GLM_KEY`
- `FORTUNE_AI_GLM_MODEL=glm-4.7`
- `FORTUNE_AI_GLM_THINKING=disabled`ï¼ˆ`enabled|disabled`ï¼‰

**è¯·æ±‚åè®®ï¼ˆChat Completionsï¼‰**
- `POST ${GLM_BASE_URL}/chat/completions`
- Headerï¼š
  - `Content-Type: application/json`
  - `Authorization: Bearer ${GLM_API_KEY}`
- Bodyï¼š`model`, `messages`, `max_tokens`, `temperature`, `thinking.type`, `stream`

**è¯·æ±‚ç¤ºä¾‹ï¼ˆéæµå¼ï¼‰**

```bash
curl -sS "$GLM_BASE_URL/chat/completions" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $GLM_API_KEY" \
  -d '{
    "model": "'"$FORTUNE_AI_GLM_MODEL"'",
    "max_tokens": 1200,
    "temperature": 0.6,
    "stream": false,
    "thinking": {"type":"disabled"},
    "messages": [
      {"role":"system","content":"ä½ æ˜¯ Fortune AI çš„ Performance Coachã€‚è¯·ä¸¥æ ¼ä»…è¾“å‡º A2UI JSONï¼ˆä¸è¦ä»£ç å—/ä¸è¦å¤šä½™æ–‡æœ¬ï¼‰ã€‚"},
      {"role":"user","content":"æˆ‘æœ€è¿‘å¾ˆç„¦è™‘ï¼Œå·¥ä½œè¦ä¸è¦æ¢ï¼Ÿ"}
    ]
  }'
```

**æ³¨æ„**
- è‹¥è®¾ç½® `thinking.type=enabled`ï¼ŒZ.AI å¯èƒ½ä»…è¿”å› `reasoning_content` ä¸” `content` ä¸ºç©ºã€‚
- åç«¯ä¼šåœ¨æ£€æµ‹åˆ° `content` ä¸ºç©ºæ—¶è‡ªåŠ¨é™çº§é‡è¯•ï¼ˆ`thinking=disabled`ï¼‰ä»¥ä¿è¯æœ‰å¯å±•ç¤ºè¾“å‡ºã€‚

**è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆå¼ºåˆ¶ï¼‰**
- è¿”å› **A2UI JSON**ï¼Œé¦–ç»„ä»¶å¿…é¡»ä¸º `markdown_text`ï¼Œç¡®ä¿å‰ç«¯å¯æ¸²æŸ“ã€‚

### 3.4 GLM System Promptï¼ˆæœ€ç»ˆæ¨¡æ¿ï¼Œç›´æ¥ç”¨äºå®ç°ï¼‰

> ç›®æ ‡ï¼šæŠŠâ€œå‘½ç†/çŸ¥è¯†åº“/è§„åˆ™â€çš„ä¸“ä¸šåˆ†æï¼Œç¿»è¯‘æˆâ€œç§¯æå¿ƒç†å­¦/ç»©æ•ˆæ•™ç»ƒâ€çš„è¡ŒåŠ¨é—­ç¯è¾“å‡ºï¼›å¹¶å¼ºåˆ¶ç»“æ„åŒ–ä¸å¯è¿½æº¯ã€‚

```text
ä½ æ˜¯ Fortune AI çš„å¯¹è¯ Agentï¼Œè§’è‰²æ˜¯ç§¯æå¿ƒç†å­¦æ•™ç»ƒï¼ˆPerformance Coachï¼‰ã€‚

ã€äº§å“å®šä½ã€‘
äººç”Ÿå¯¼èˆª / é™ªä¼´ / æå‡ã€‚ç³»ç»Ÿå’Œäº¤äº’ä¿æŒâ€œæœ‰æ•ˆè€Œæç®€â€ã€‚

ã€ä½ çš„ä¼˜å…ˆçº§ï¼ˆä¸å¯é€†ï¼‰ã€‘
Coach > Teaching Assistant > Customer Support > Sales

ã€ç¡¬æ€§è§„åˆ™ï¼ˆå¿…é¡»éµå®ˆï¼‰ã€‘
1) ç¦æ­¢æå“ã€ç¾è¾±ã€å®¿å‘½è®ºæ–­è¨€ï¼›è´Ÿé¢ä¿¡æ¯å¿…é¡»ç´§æ¥â€œä½ å¯ä»¥åšä»€ä¹ˆâ€çš„è¡ŒåŠ¨å¤„æ–¹ã€‚
2) ç¦æ­¢è‡ªè¡Œè®¡ç®—å…«å­—äº‹å®ï¼›åªèƒ½åŸºäºæä¾›çš„ facts + evidence è¾“å‡ºã€‚
3) æ¯æ¬¡è¾“å‡ºå¿…é¡»åŒ…å«ï¼šç»“è®º(conclusion) + ä¾æ®(why) + â‰¤3æ¡å¤„æ–¹(prescriptions) + æ‰¿è¯ºé‚€è¯·(commitment_ask)ã€‚
4) æ—¶é—´çª—å£é»˜è®¤åªç»™å¹²é¢„çª—å£ï¼ˆinterventionï¼‰ï¼›forecast åªèƒ½æ¡ä»¶å¥+ä½ç½®ä¿¡åº¦ã€‚
5) è¾“å‡ºå¿…é¡»æ˜¯ A2UI JSONï¼Œä¸”ç¬¬ä¸€ç»„ä»¶å¿…é¡»æ˜¯ markdown_textã€‚
6) å¿…é¡»ç»™å‡ºå¯ç‚¹å‡» actionsï¼ˆstart_task / schedule_task / open_panel / opt_outï¼‰ã€‚

ã€è¯­è¨€é£æ ¼ persona_styleã€‘
standardï¼šæ¸…æ™°ã€ä¸­æ€§ã€ä¸“ä¸š
warmï¼šå…±æƒ…ã€æ”¯æŒæ€§ï¼ˆé»˜è®¤ï¼‰
roastï¼šè½»æ¯’èˆŒä½†ä¸ç¾è¾±ã€ä¸å¯¹äººæ ¼åšè´Ÿé¢å®šæ€§

ã€è¾“å…¥ã€‘
- persona_style å–å€¼ï¼šstandard / warm / roast
- user_contextï¼šç”¨æˆ·åŸºç¡€ä¿¡æ¯ä¸åå¥½ï¼ˆæ¥è‡ª PostgreSQLï¼‰
- factsï¼šå…«å­—ç¡®å®šæ€§äº‹å® + è®¡åˆ’è¿›åº¦ + å†å²åé¦ˆï¼ˆæ¥è‡ª PostgreSQLï¼‰
- evidenceï¼šrule_ids + kb_refs + facts_hashï¼ˆæ¥è‡ª PostgreSQLï¼‰
- user_messageï¼šç”¨æˆ·æœ¬è½®è¾“å…¥ï¼ˆæ¥è‡ªå¯¹è¯ï¼‰

ã€è¾“å‡ºï¼ˆA2UI JSONï¼‰ã€‘
- meta.summaryï¼šä¸€å¥è¯æ‘˜è¦
- ui_components[0]ï¼šmarkdown_textï¼ˆå¿…é¡»ï¼ŒåŒ…å«ï¼šç»“è®ºè¦ç‚¹/ä¾æ®/å¤„æ–¹/æ—¶é—´çª—å£/è¾¹ç•Œ/æ‰¿è¯ºé‚€è¯·ï¼‰
- ui_components[1]ï¼šaction_buttonsï¼ˆå¿…é¡»ï¼ŒåŒ…å«ï¼šå¼€å§‹è¡ŒåŠ¨/åŠ å…¥è®¡åˆ’/æŸ¥çœ‹Bentoç­‰æŒ‰é’®ï¼‰
```

---

## 4. äº¤ä»˜å¥‘çº¦ï¼ˆGuidance Card + A2UIï¼‰

### 4.1 Guidance Cardï¼ˆæœåŠ¡ç«¯ SSOTï¼‰

```json
{
  "card_id": "b3a28c14-7a04-4b6c-8a37-8f4b0bb4c0f3",
  "type": "daily_guidance",
  "conclusion": "â‰¤50å­—ç»“è®º",
  "why": "ä¾æ®ï¼ˆç”¨å¿ƒç†å­¦/æ•™ç»ƒè¯­è¨€é‡æ„ï¼‰",
  "prescriptions": [
    {"task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1", "content": "è¡ŒåŠ¨1", "estimated_minutes": 5},
    {"task_id": "d1d6b1f3-1c1a-4d0f-9a64-2e4a91bfe5d2", "content": "è¡ŒåŠ¨2", "estimated_minutes": 10}
  ],
  "time_window": {
    "type": "intervention",
    "value": "7å¤©è¯•è¡Œ",
    "confidence": "high",
    "checkpoint_date": "2026-01-05"
  },
  "risk_boundary": "ä¸æ›¿ä»£åŒ»ç–—/æ³•å¾‹/æŠ•èµ„å»ºè®®",
  "commitment_ask": "ä½ æ„¿æ„å…ˆåšå“ªä¸€ä¸ªï¼Ÿ",
  "actions": [
    {"type": "start_task", "task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1", "label": "å¼€å§‹è¡ŒåŠ¨1"},
    {"type": "schedule_task", "task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1", "label": "åŠ å…¥ä»Šæ—¥è®¡åˆ’"}
  ],
  "evidence": {
    "plugin": "bazi",
    "rule_ids": ["RULE-TS-001", "RULE-PATTERN-004"],
    "kb_refs": ["kb:doc:2:page:45:chunk:3"],
    "facts_hash": "sha256:3b9e8b9a1ad0b2f92b2d4e8c5a2d9b4c1f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c"
  },
  "created_at": "2025-12-29T10:00:00Z"
}
```

### 4.2 A2UIï¼ˆå‰ç«¯æ¸²æŸ“ï¼‰

```json
{
  "meta": {"summary": "ä¸€å¥è¯æ‘˜è¦"},
  "ui_components": [
    {"type": "markdown_text", "title": "è¾“å‡º", "data": "### ç»“è®ºè¦ç‚¹\n- ä½ ç°åœ¨çš„ç„¦è™‘ä¸»è¦æ¥è‡ªä¸ç¡®å®šæ€§ä¸ä¿¡æ¯è¿‡è½½ã€‚\n\n### è¡ŒåŠ¨å¤„æ–¹ï¼ˆâ‰¤3æ¡ï¼‰\n1) ç”¨å†³ç­–æ¨¡æ¿å†™æ¸…é€‰é¡¹/çº¦æŸï¼ˆ10åˆ†é’Ÿï¼‰\n2) 48å°æ—¶å†…åšä¸€æ¬¡æœ€å°éªŒè¯ï¼ˆæ‰¾1ä½åŒè¡ŒèŠ15åˆ†é’Ÿï¼‰\n3) æƒ…ç»ªå³°å€¼å…ˆåš3åˆ†é’Ÿé™å™ªå†å†³ç­–\n\n### æ‰¿è¯º\nä½ æ„¿æ„å…ˆåšå“ªä¸€ä¸ªï¼Ÿ"},
    {"type": "action_buttons", "title": "ä¸‹ä¸€æ­¥", "data": [{"label": "å¼€å§‹è¡ŒåŠ¨1", "action": {"type": "start_task", "task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1"}}]}
  ]
}
```

---

## 5. åç«¯æ¶æ„ï¼ˆæ•°å­¦è„‘ / çŸ¥è¯†è„‘ / è¯­è¨€è„‘ï¼‰

```
Client (/new)
  â†’ API (FastAPI)
      â†’ [æ•°å­¦è„‘] å…«å­—ç¡®å®šæ€§è®¡ç®—ï¼ˆfacts + facts_hashï¼‰
      â†’ [çŸ¥è¯†è„‘] PostgreSQL FTS æ£€ç´¢çŸ¥è¯†åº“ï¼ˆkb_refsï¼‰
      â†’ [è¯­è¨€è„‘] GLM ç”Ÿæˆ A2UI + Guidance Card
      â†’ PostgreSQL SSOTï¼ˆç”¨æˆ·/ä¼šè¯/è®¡åˆ’/æ‰¿è¯º/åé¦ˆ/æ¨é€/çŸ¥è¯†åº“ï¼‰
```

### 5.1 æ•°å­¦è„‘ï¼šå…«å­—ç¡®å®šæ€§è®¡ç®—ï¼ˆçœŸå¤ªé˜³æ—¶ï¼Œç›´æ¥å®ç°ï¼‰

**è¾“å…¥ï¼ˆæ¥è‡ªç”¨æˆ· Profileï¼‰**
- `birthday_local`: `YYYY-MM-DD HH:MM:SS`ï¼ˆç”¨æˆ·å½“åœ°æ ‡å‡†æ—¶é—´ï¼‰
- `tz_offset_hours`: ä¾‹å¦‚ `8.0`
- `location`: `{ "name": "åŒ—äº¬", "longitude": 116.4074, "latitude": 39.9042 }`

**çœŸå¤ªé˜³æ—¶æ ¡æ­£ï¼ˆç”¨äºæ—¶æŸ±/è·¨æ—¥è¾¹ç•Œï¼‰**

1) æ—¶åŒºä¸­å¤®ç»çº¿ï¼š`tz_meridian_deg = tz_offset_hours * 15`
2) ç»åº¦æ ¡æ­£ï¼ˆåˆ†é’Ÿï¼‰ï¼š`lon_corr_min = (longitude - tz_meridian_deg) * 4`
3) å‡æ—¶å·®ï¼ˆEquation of Timeï¼Œåˆ†é’Ÿï¼‰ï¼š
   - `birthday_utc = birthday_local - tz_offset_hours`
   - `jd_ut = swisseph.julday(birthday_utc.year, birthday_utc.month, birthday_utc.day, hour_decimal_utc)`
   - `e_days = swisseph.time_equ(jd_ut)`ï¼ˆè¿”å›â€œçœŸå¤ªé˜³æ—¶ - å¹³å¤ªé˜³æ—¶â€ï¼Œå•ä½å¤©ï¼‰
   - `eot_min = e_days * 1440`
4) çœŸå¤ªé˜³æ—¶ï¼ˆæœ¬åœ°ï¼‰ï¼š`true_solar_time_local = birthday_local + lon_corr_min + eot_min`

**æ’ç›˜ï¼ˆlunar_pythonï¼‰**

ä»¥ `true_solar_time_local` ä¸ºæ’ç›˜æ—¶é—´ï¼š
- `Solar.fromYmdHms(Y,M,D,hh,mm,ss) -> Lunar -> EightChar`
- å››æŸ±ï¼š
  - `EightChar.getYear()/getMonth()/getDay()/getTime()`
- åç¥ï¼ˆå¤©å¹² + åœ°æ”¯ï¼‰ï¼š
  - `getYearShiShenGan/getMonthShiShenGan/getDayShiShenGan/getTimeShiShenGan`
  - `getYearShiShenZhi/getMonthShiShenZhi/getDayShiShenZhi/getTimeShiShenZhi`
- çº³éŸ³ï¼š`getYearNaYin/getMonthNaYin/getDayNaYin/getTimeNaYin`
- åœ°åŠ¿ï¼š`getYearDiShi/getMonthDiShi/getDayDiShi/getTimeDiShi`
- å¤§è¿/æµå¹´ï¼š
  - `yun = EightChar.getYun(gender_code)`ï¼ˆ`ç”·=1`ï¼Œ`å¥³=0`ï¼‰
  - `da_yun_list = yun.getDaYun(10)`ï¼ˆå– 10 æ­¥å¤§è¿ï¼›è¿‡æ»¤ `getGanZhi()==''` çš„æ¡ç›®ï¼‰
  - æ¯æ­¥å¤§è¿ï¼š`getStartAge/getEndAge/getStartYear/getEndYear/getGanZhi/getXun/getXunKong`
  - æµå¹´ï¼š`DaYun.getLiuNian()`ï¼ˆå–å½“å¹´ä¸æœªæ¥ 5 å¹´ç”¨äº MVPï¼‰

### 5.2 `facts`ï¼ˆLLM å”¯ä¸€äº‹å®è¾“å…¥ï¼Œå›ºå®šå­—æ®µï¼‰

`facts` å†™å…¥ `fortune_bazi_snapshot.facts`ï¼Œå¹¶ä½œä¸º GLM ç”Ÿæˆçš„å”¯ä¸€äº‹å®æ¥æºã€‚

ç¤ºä¾‹ï¼ˆåŒ—äº¬ï¼Œ1990-05-12 14:00ï¼Œç”·ï¼‰ï¼š

```json
{
  "profile": {
    "name": "å¼ ä¸‰",
    "gender": "ç”·",
    "birthday_local": "1990-05-12 14:00:00",
    "tz_offset_hours": 8.0,
    "location": {"name": "åŒ—äº¬", "longitude": 116.4074, "latitude": 39.9042}
  },
  "solar_time": {
    "tz_meridian_deg": 120.0,
    "lon_corr_min": -14.3704,
    "eot_min": 3.6845,
    "true_solar_time_local": "1990-05-12 13:49:19"
  },
  "bazi": {
    "pillars": {"year": "åºšåˆ", "month": "è¾›å·³", "day": "ä¸ä¸‘", "hour": "ä¸æœª"},
    "day_master": {"gan": "ä¸", "element": "ç«"},
    "wuxing_count": {"é‡‘": 2, "æœ¨": 0, "æ°´": 0, "ç«": 4, "åœŸ": 2},
    "shi_shen_gan": {"year": "æ­£è´¢", "month": "åè´¢", "day": "æ—¥ä¸»", "hour": "æ¯”è‚©"},
    "shi_shen_zhi": {
      "year": ["æ¯”è‚©", "é£Ÿç¥"],
      "month": ["åŠ«è´¢", "æ­£è´¢", "ä¼¤å®˜"],
      "day": ["é£Ÿç¥", "ä¸ƒæ€", "åè´¢"],
      "hour": ["é£Ÿç¥", "æ¯”è‚©", "åå°"]
    },
    "na_yin": {"year": "è·¯æ—åœŸ", "month": "ç™½èœ¡é‡‘", "day": "æ¶§ä¸‹æ°´", "hour": "å¤©æ²³æ°´"},
    "di_shi": {"year": "ä¸´å®˜", "month": "å¸æ—º", "day": "å¢“", "hour": "å† å¸¦"},
    "luck": {
      "forward": true,
      "start_age_year": 8,
      "da_yun": [
        {"index": 1, "start_age": 9, "end_age": 18, "start_year": 1998, "end_year": 2007, "gan_zhi": "å£¬åˆ", "xun": "ç”²ç”³", "xun_kong": "æˆŒäº¥"},
        {"index": 2, "start_age": 19, "end_age": 28, "start_year": 2008, "end_year": 2017, "gan_zhi": "ç™¸æœª", "xun": "ä¹™é…‰", "xun_kong": "æˆŒäº¥"}
      ],
      "liu_nian_next5": [
        {"year": 2026, "gan_zhi": "ä¸™åˆ"},
        {"year": 2027, "gan_zhi": "ä¸æœª"},
        {"year": 2028, "gan_zhi": "æˆŠç”³"},
        {"year": 2029, "gan_zhi": "å·±é…‰"},
        {"year": 2030, "gan_zhi": "åºšæˆŒ"}
      ]
    },
    "shensha": [
      {"name": "æ¡ƒèŠ±", "hit": true, "note": "ä»¥æ—¥æ”¯/å¹´æ”¯æ¨å’¸æ± "},
      {"name": "é©¿é©¬", "hit": false, "note": "ä»¥æ—¥æ”¯/å¹´æ”¯æ¨é©¿é©¬"},
      {"name": "å¤©ä¹™è´µäºº", "hit": true, "note": "ä»¥æ—¥å¹²æ¨è´µäºº"}
    ]
  },
  "version": {
    "compute_version": "bazi-tts-v1",
    "facts_hash": "sha256:9a59e0f36b8f4c8b0b0e0e7b1c3c0d9610e14aa0f0e2d1d6b1f31c1a4d0f9a64"
  }
}
```

### 5.3 æ—ºè¡°ä¸å–œç”¨ï¼ˆMVP ç¡®å®šæ€§ç®—æ³•ï¼Œè¾“å‡ºå¯è§£é‡Šï¼‰

**æ—¥ä¸»äº”è¡Œæ˜ å°„ï¼ˆæŒ‰æ—¥å¹²ï¼‰**
- ç”²ä¹™=æœ¨ï¼›ä¸™ä¸=ç«ï¼›æˆŠå·±=åœŸï¼›åºšè¾›=é‡‘ï¼›å£¬ç™¸=æ°´

**æœˆä»¤å­£èŠ‚äº”è¡Œï¼ˆæŒ‰æœˆæ”¯ï¼‰**
- å¯…å¯è¾°=æœ¨ï¼ˆæ˜¥ï¼‰ï¼›å·³åˆæœª=ç«ï¼ˆå¤ï¼‰ï¼›ç”³é…‰æˆŒ=é‡‘ï¼ˆç§‹ï¼‰ï¼›äº¥å­ä¸‘=æ°´ï¼ˆå†¬ï¼‰

**å¼ºå¼±è¯„åˆ†ï¼ˆscoreï¼‰**
- `support = count(day_master) + count(generator_of_day_master)`
- `drain = count(produced_by_day_master) + count(controller_of_day_master)`
- `score = support - drain + season_bonus`
- `season_bonus`ï¼š
  - æœˆä»¤åŒäº”è¡Œï¼š`+2`
  - æœˆä»¤ç”Ÿæ—¥ä¸»ï¼š`+1`
  - æœˆä»¤å…‹æ—¥ä¸»ï¼š`-1`
  - æœˆä»¤è¢«æ—¥ä¸»å…‹ï¼š`-1`

**åˆ¤å®š**
- `score >= 2` â†’ `strong`
- `score <= -2` â†’ `weak`
- å…¶ä½™ â†’ `neutral`

**å–œç”¨è¾“å‡º**
- `weak`ï¼šå–œ `æ—¥ä¸»äº”è¡Œ + ç”Ÿæ‰¶äº”è¡Œ`
- `strong`ï¼šå–œ `æ³„è€—äº”è¡Œ + è´¢äº”è¡Œ + å®˜æ€äº”è¡Œ`
- `neutral`ï¼šä¼˜å…ˆè¡¥â€œæœ€å°‘çš„äº”è¡Œâ€

### 5.4 ç¥ç…ï¼ˆMVP å›ºå®šè®¡ç®—èŒƒå›´ä¸è§„åˆ™ï¼‰

å›ºå®šè®¡ç®—ï¼š`æ¡ƒèŠ±(å’¸æ± )`ã€`é©¿é©¬`ã€`åç›–`ã€`å¤©ä¹™è´µäºº`ã€`æ–‡æ˜Œ`

**ä¸‰åˆå±€åˆ†ç»„ï¼ˆä»¥å¹´æ”¯/æ—¥æ”¯æ‰€å±å±€ä¸ºå‡†ï¼‰**
- ç”³å­è¾°å±€ â†’ æ¡ƒèŠ±=é…‰ï¼Œé©¿é©¬=å¯…ï¼Œåç›–=è¾°
- äº¥å¯æœªå±€ â†’ æ¡ƒèŠ±=å­ï¼Œé©¿é©¬=å·³ï¼Œåç›–=æœª
- å¯…åˆæˆŒå±€ â†’ æ¡ƒèŠ±=å¯ï¼Œé©¿é©¬=ç”³ï¼Œåç›–=æˆŒ
- å·³é…‰ä¸‘å±€ â†’ æ¡ƒèŠ±=åˆï¼Œé©¿é©¬=äº¥ï¼Œåç›–=ä¸‘

**å¤©ä¹™è´µäººï¼ˆæŒ‰æ—¥å¹²ï¼‰**
- ç”²/æˆŠ/åºšï¼šä¸‘ã€æœª
- ä¹™/å·±ï¼šå­ã€ç”³
- ä¸™/ä¸ï¼šäº¥ã€é…‰
- è¾›ï¼šå¯…ã€åˆ
- å£¬/ç™¸ï¼šå¯ã€å·³

**æ–‡æ˜Œï¼ˆæŒ‰æ—¥å¹²ï¼‰**
- ç”²ä¹™ï¼šå·³ã€åˆ
- ä¸™ä¸ï¼šç”³ã€é…‰
- æˆŠå·±ï¼šç”³ã€é…‰
- åºšè¾›ï¼šäº¥ã€å­
- å£¬ç™¸ï¼šå¯…ã€å¯

å‘½ä¸­åˆ¤å®šï¼šè‹¥å››æŸ±åœ°æ”¯å‡ºç°å¯¹åº”åœ°æ”¯ï¼Œåˆ™ `hit=true`ã€‚

---

## 6. æ•°æ®åº“è®¾è®¡ï¼ˆPostgreSQL / DB=fortune_aiï¼Œå…¨éƒ¨å¯æ‰§è¡Œï¼‰

> è¯´æ˜ï¼šæœ¬èŠ‚ä¸ºæœ€ç»ˆ schemaï¼ˆä¸ä½¿ç”¨ä»»ä½•å…¶ä»–æ•°æ®åº“ï¼‰ã€‚è¿æ¥å‡­æ®å‚è€ƒ `docs/apikey.md`ï¼Œå°† DB åæ›¿æ¢ä¸º `fortune_ai`ã€‚

**å†³ç­–ï¼ˆå›ç­” DB åç§°å†²çªï¼‰**
- åœ¨åŒä¸€ PostgreSQL å®ä¾‹ä¸­æ–°å»ºæ•°æ®åº“ `fortune_ai`ï¼ŒFortune AI æ‰€æœ‰ä¸šåŠ¡è¡¨åªåˆ›å»ºåœ¨è¯¥åº“å†…ã€‚
- æ·±åº¦æŠ¥å‘Šæ”¯æŒ `backend=cli|gemini`ï¼š`gemini` æ•°æ®åº“ä¿æŒåŸæ ·ï¼Œä»…åœ¨ `backend=gemini` æ—¶ä½œä¸ºæŠ¥å‘Šå¼•æ“çš„ job/task å­˜å‚¨ï¼ˆè¯»å†™ `gemini_job/gemini_task`ï¼‰ï¼›`backend=cli` é€šè¿‡ `cli_worker` çš„æ‰§è¡Œé“¾è·¯æäº¤ä¸è½®è¯¢ï¼ˆä¸è®¿é—® `gemini` DBï¼‰ã€‚

**è¿è¡Œæ—¶è¿æ¥ï¼ˆå¿…é¡»ï¼‰**
- Fortune AI ä¸šåŠ¡åº“ï¼ˆDB=fortune_aiï¼‰ï¼šä½¿ç”¨ `FORTUNE_DB_HOST/FORTUNE_DB_PORT/FORTUNE_DB_NAME/FORTUNE_DB_USER/FORTUNE_DB_PASSWORD`ï¼ˆä¸ç°æœ‰ä»£ç ä¸€è‡´ï¼Œ`FORTUNE_DB_NAME=fortune_ai`ï¼‰ï¼›ä¹Ÿå¯ç”¨å•ä¸€è¿æ¥ä¸² `FORTUNE_AI_DB_URL`ï¼ˆlibpq URL å½¢å¼ï¼‰ã€‚
- `backend=gemini`ï¼šGemini æŠ¥å‘ŠæœåŠ¡åº“ä½¿ç”¨ `.env.example` åŒåå˜é‡ `GEMINI_DB_HOST/GEMINI_DB_PORT/GEMINI_DB_NAME/GEMINI_DB_USER/GEMINI_DB_PASSWORD` è¿æ¥ `gemini`ï¼›**ä»…** `integrations/gemini_repo.py`ï¼ˆä»¥åŠå…¶ä¾èµ–çš„ gemini_toolï¼‰å…è®¸è®¿é—®è¯¥åº“ï¼Œç”¨äºåˆ›å»ºä¸è½®è¯¢ `gemini_job/gemini_task`ã€‚
- `backend=cli`ï¼šCLI Worker ä½¿ç”¨ `CLI_WORKER_DB_URL`ï¼ˆæˆ–æœ¬åœ° sqlite fallbackï¼‰æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼›ä»»åŠ¡æäº¤é€šè¿‡ `cli_worker` é¡¹ç›®æ¥å£æ‰§è¡Œï¼ˆç”± `integrations/cli_worker_repo.py` å°è£…ï¼‰ã€‚

### 6.1 åˆå§‹åŒ–ï¼ˆæ•°æ®åº“ä¸æ‰©å±•ï¼‰

```sql
CREATE DATABASE fortune_ai;

\\c fortune_ai;

CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

### 6.2 ç”¨æˆ·ä¸åå¥½

```sql
CREATE TABLE IF NOT EXISTS fortune_user (
  user_id BIGSERIAL PRIMARY KEY,
  email TEXT NOT NULL,
  password_hash TEXT NOT NULL,          -- bcrypt
  name TEXT NOT NULL,                   -- æ˜µç§°/æ˜¾ç¤ºå
  gender TEXT NOT NULL CHECK (gender IN ('ç”·','å¥³')),
  birthday_local TIMESTAMP NOT NULL,    -- ç”¨æˆ·å½“åœ°æ ‡å‡†æ—¶é—´ï¼ˆä¸å«æ—¶åŒºï¼‰
  birthday_utc TIMESTAMPTZ NOT NULL,    -- ç»Ÿä¸€å­˜ UTC æ—¶é—´ï¼ˆç”± birthday_local + tz_offset_hours æ¨å¯¼ï¼‰
  tz_offset_hours NUMERIC(4,1) NOT NULL DEFAULT 8.0,
  location JSONB NOT NULL,              -- {name, longitude, latitude}
  bazi_digest TEXT,
  last_login_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  deleted_at TIMESTAMPTZ
);
CREATE UNIQUE INDEX IF NOT EXISTS idx_fortune_user_email_lower ON fortune_user ((lower(email))) WHERE deleted_at IS NULL;
CREATE INDEX IF NOT EXISTS idx_fortune_user_name ON fortune_user (name) WHERE deleted_at IS NULL;

CREATE TABLE IF NOT EXISTS fortune_user_preferences (
  user_id BIGINT PRIMARY KEY REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  persona_style TEXT NOT NULL DEFAULT 'warm' CHECK (persona_style IN ('standard','warm','roast')),
  push_enabled BOOLEAN NOT NULL DEFAULT TRUE,
  push_time TIME NOT NULL DEFAULT '08:00:00',
  push_timezone TEXT NOT NULL DEFAULT 'Asia/Shanghai',
  quiet_hours_start TIME NOT NULL DEFAULT '22:00:00',
  quiet_hours_end TIME NOT NULL DEFAULT '07:00:00',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS fortune_user_session (
  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  token_hash TEXT NOT NULL,             -- sha256(base64url_token)
  csrf_token_hash TEXT NOT NULL,        -- sha256(csrf_token)
  ip TEXT NOT NULL DEFAULT '',
  user_agent TEXT NOT NULL DEFAULT '',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  expires_at TIMESTAMPTZ NOT NULL,      -- now() + interval '30 days'
  revoked_at TIMESTAMPTZ
);
CREATE UNIQUE INDEX IF NOT EXISTS idx_user_session_token_hash ON fortune_user_session (token_hash);
CREATE INDEX IF NOT EXISTS idx_user_session_user_active ON fortune_user_session (user_id, expires_at DESC) WHERE revoked_at IS NULL;
```

### 6.3 ä¼šè¯ä¸æ¶ˆæ¯ï¼ˆSSOTï¼Œä¸è½æœ¬åœ°æ–‡ä»¶ï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_conversation_session (
  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  title TEXT NOT NULL DEFAULT '',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_conv_session_user_updated ON fortune_conversation_session (user_id, updated_at DESC);

CREATE TABLE IF NOT EXISTS fortune_conversation_message (
  message_id BIGSERIAL PRIMARY KEY,
  session_id UUID NOT NULL REFERENCES fortune_conversation_session(session_id) ON DELETE CASCADE,
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK (role IN ('user','assistant','system')),
  content TEXT NOT NULL,
  a2ui JSONB,                            -- assistant è¾“å‡ºï¼ˆå¯ç©ºï¼‰
  model TEXT NOT NULL,
  prompt_tokens INTEGER NOT NULL DEFAULT 0,
  completion_tokens INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_conv_msg_session_time ON fortune_conversation_message (session_id, created_at);
```

### 6.4 å…«å­—äº‹å®å¿«ç…§ï¼ˆå¯è¿½æº¯ä¸€è‡´æ€§ï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_bazi_snapshot (
  snapshot_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  compute_version TEXT NOT NULL,
  facts JSONB NOT NULL,
  facts_hash TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id, compute_version, facts_hash)
);
CREATE INDEX IF NOT EXISTS idx_bazi_snapshot_user_time ON fortune_bazi_snapshot (user_id, created_at DESC);
```

### 6.5 æ‰¿è¯ºä¸è¡ŒåŠ¨ï¼ˆé—­ç¯æ ¸å¿ƒï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_commitment (
  task_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,
  card_id UUID,                         -- ç”Ÿæˆè¯¥å»ºè®®çš„äº¤ä»˜å¡ IDï¼ˆå¯ç©ºï¼‰
  source TEXT NOT NULL CHECK (source IN ('chat','bento','push')),
  commitment_type TEXT NOT NULL CHECK (commitment_type IN ('start_task','schedule_task','ask_followup','opt_out')),
  title TEXT NOT NULL,
  details JSONB NOT NULL DEFAULT '{}'::jsonb,
  status TEXT NOT NULL DEFAULT 'suggested' CHECK (status IN ('suggested','active','done','skipped','canceled')),
  accepted_at TIMESTAMPTZ,              -- ç”¨æˆ·ç¡®è®¤æ‰¿è¯ºçš„æ—¶é—´ï¼ˆcommitment_made ä»¥æ­¤åˆ¤å®šï¼‰
  due_at TIMESTAMPTZ,
  done_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_commitment_user_status ON fortune_commitment (user_id, status, created_at DESC);
```

### 6.6 æƒ…ç»ªæ‰“å¡ä¸å¤ç›˜ï¼ˆåé¦ˆé—­ç¯ï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_checkin (
  checkin_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  mood TEXT NOT NULL,                    -- ä¾‹ï¼šç„¦è™‘/ä½è½/å¹³é™/å…´å¥‹
  intensity INTEGER NOT NULL CHECK (intensity BETWEEN 0 AND 10),
  note TEXT NOT NULL DEFAULT '',
  recommended_action TEXT NOT NULL,      -- ç³»ç»Ÿç»™å‡ºçš„ 1 ä¸ªåŠ¨ä½œï¼ˆå¯æ‰§è¡Œï¼‰
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_checkin_user_time ON fortune_checkin (user_id, created_at DESC);

CREATE TABLE IF NOT EXISTS fortune_reflection (
  reflection_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  period TEXT NOT NULL CHECK (period IN ('daily','weekly')),
  reflection_date DATE NOT NULL,
  input JSONB NOT NULL,                 -- ç”¨æˆ·å›ç­”ï¼ˆç»“æ„åŒ–ï¼‰
  output_card JSONB NOT NULL,           -- Guidance Card
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id, period, reflection_date)
);
```

### 6.7 æˆé•¿è®¡åˆ’ï¼ˆ4 ä¸ªé¢„è®¾ + ç”¨æˆ·è¿›åº¦ï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_plan (
  plan_id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  duration_days INTEGER NOT NULL CHECK (duration_days > 0),
  theory TEXT NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS fortune_plan_day (
  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE CASCADE,
  day_no INTEGER NOT NULL CHECK (day_no > 0),
  title TEXT NOT NULL,
  instruction TEXT NOT NULL,
  PRIMARY KEY (plan_id, day_no)
);

CREATE TABLE IF NOT EXISTS fortune_plan_enrollment (
  enrollment_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE RESTRICT,
  start_date DATE NOT NULL,
  current_day INTEGER NOT NULL DEFAULT 1,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','paused','completed','abandoned')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id, plan_id, start_date)
);
CREATE INDEX IF NOT EXISTS idx_plan_enroll_user_status ON fortune_plan_enrollment (user_id, status, updated_at DESC);

CREATE TABLE IF NOT EXISTS fortune_plan_record (
  record_id BIGSERIAL PRIMARY KEY,
  enrollment_id BIGINT NOT NULL REFERENCES fortune_plan_enrollment(enrollment_id) ON DELETE CASCADE,
  day_no INTEGER NOT NULL,
  completed BOOLEAN NOT NULL DEFAULT FALSE,
  note TEXT NOT NULL DEFAULT '',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (enrollment_id, day_no)
);
```

**é¢„è®¾è®¡åˆ’å›ºå®šä¸º 4 ä¸ªï¼ˆå¼€ç®±å³ç”¨ï¼Œå†™å…¥ DBï¼‰**

```sql
INSERT INTO fortune_plan (plan_id, name, duration_days, theory) VALUES
  ('gratitude_21', '21å¤©æ„Ÿæ©ç»ƒä¹ ', 21, 'ç§¯æå¿ƒç†å­¦'),
  ('mindfulness_7', '7å¤©æ­£å¿µå…¥é—¨', 7, 'æ­£å¿µå†¥æƒ³'),
  ('habit_30', '30å¤©ä¹ æƒ¯å…»æˆæŒ‘æˆ˜', 30, 'è¡Œä¸ºç§‘å­¦/åŸå­ä¹ æƒ¯'),
  ('strength_14', '14å¤©ä¼˜åŠ¿å‘ç°ä¹‹æ—…', 14, 'VIAä¼˜åŠ¿ç†è®º')
ON CONFLICT (plan_id) DO NOTHING;
```

**é¢„è®¾è®¡åˆ’ä»»åŠ¡ï¼ˆ`fortune_plan_day`ï¼Œå›ºå®šå†…å®¹ï¼Œç›´æ¥å†™å…¥ DBï¼‰**

```sql
-- 21å¤©æ„Ÿæ©ç»ƒä¹ 
INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
('gratitude_21', 1, 'å¯åŠ¨ï¼šä¸‰ä»¶å¥½äº‹', 'å†™ä¸‹ä»Šå¤©å‘ç”Ÿçš„3ä»¶å€¼å¾—æ„Ÿæ©/æ¬£èµçš„å°äº‹ï¼›æ¯ä»¶ç”¨1å¥è¯å†™æ¸…â€œå‘ç”Ÿäº†ä»€ä¹ˆâ€å’Œâ€œæˆ‘ä¸ºä»€ä¹ˆæ„Ÿæ¿€â€ã€‚'),
('gratitude_21', 2, 'ç»†åŒ–ï¼šæŠŠå¥½äº‹å†™å…·ä½“', 'ä»æ˜¨å¤©çš„3ä»¶å¥½äº‹é‡Œä»»é€‰1ä»¶ï¼Œè¡¥å……3ä¸ªç»†èŠ‚ï¼ˆäºº/åœ°ç‚¹/åŠ¨ä½œ/æ„Ÿå—ï¼‰ï¼Œè®©å®ƒæ›´å¯å›å¿†ã€‚'),
('gratitude_21', 3, 'äººé™…ï¼šæ„Ÿè°¢ä¸€ä¸ªäºº', 'ç»™ä¸€ä¸ªäººå‘ä¸€æ¡æ„Ÿè°¢ä¿¡æ¯ï¼ˆä¸éœ€é•¿ï¼‰ï¼Œæ˜ç¡®è¯´å‡ºï¼šå¯¹æ–¹åšäº†ä»€ä¹ˆâ†’å¯¹ä½ äº§ç”Ÿäº†ä»€ä¹ˆå½±å“ã€‚'),
('gratitude_21', 4, 'é€†å¢ƒï¼šæ‰¾å‡ºä¸€ä¸ªè½¬æŠ˜', 'å›æƒ³æœ€è¿‘ä¸€ä¸ªä¸é¡ºï¼Œå†™ä¸‹ï¼šæœ€éš¾çš„ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»ä¸­å­¦åˆ°çš„ä¸€ä»¶äº‹æ˜¯ä»€ä¹ˆï¼Ÿ'),
('gratitude_21', 5, 'èº«ä½“ï¼šæ„Ÿè°¢èº«ä½“', 'å†™ä¸‹ä»Šå¤©èº«ä½“ä¸ºä½ åšå¥½çš„3ä»¶äº‹ï¼ˆä¾‹å¦‚å‘¼å¸ã€èµ°è·¯ã€æ¢å¤ï¼‰ï¼Œå¹¶åšä¸€æ¬¡1åˆ†é’Ÿä¼¸å±•ã€‚'),
('gratitude_21', 6, 'ç¯å¢ƒï¼šæ„Ÿè°¢ä¸€å¤„ç©ºé—´', 'é€‰ä¸€ä¸ªä½ å¸¸å¾…çš„ç©ºé—´ï¼ˆå·¥ä½/å§å®¤ï¼‰ï¼Œå†™ä¸‹å®ƒå¸¦ç»™ä½ çš„1ä¸ªå¥½å¤„ï¼Œå¹¶æ•´ç†1ä¸ªå°è§’è½ã€‚'),
('gratitude_21', 7, 'ä¸€å‘¨å¤ç›˜ï¼šæˆ‘æ›´å®¹æ˜“çœ‹è§ä»€ä¹ˆ', 'å†™ä¸‹è¿™ä¸€å‘¨ä½ æ›´å®¹æ˜“æ³¨æ„åˆ°çš„â€œå¥½â€æ˜¯ä»€ä¹ˆï¼ˆäºº/äº‹/èƒ½åŠ›/èµ„æºï¼‰ï¼Œä»¥åŠä¸‹å‘¨ä½ æƒ³ç»§ç»­å¼ºåŒ–çš„1ç‚¹ã€‚'),
('gratitude_21', 8, 'è¡Œä¸ºï¼šæŠŠæ„Ÿè°¢å˜æˆè¡ŒåŠ¨', 'é€‰æ‹©ä¸€ä¸ªä½ æ„Ÿæ¿€çš„äººæˆ–èµ„æºï¼Œåšä¸€ä¸ª5åˆ†é’Ÿçš„å°è¡ŒåŠ¨æ¥å›é¦ˆï¼ˆä¾‹å¦‚ä¸»åŠ¨å¸®ä¸€æ¬¡å¿™ï¼‰ã€‚'),
('gratitude_21', 9, 'ä¼˜åŠ¿ï¼šæ„Ÿè°¢è‡ªå·±çš„ä¸€ä¸ªä¼˜ç‚¹', 'å†™ä¸‹ä½ æœ€è¿‘åšå¯¹çš„ä¸€ä»¶äº‹ï¼Œå¹¶æ ‡æ³¨å®ƒä½“ç°äº†ä½ å“ªç§èƒ½åŠ›/å“è´¨ï¼ˆä¾‹å¦‚ä¸“æ³¨ã€å‹‡æ°”ã€è€å¿ƒï¼‰ã€‚'),
('gratitude_21', 10, 'æƒ…ç»ªï¼šæ„Ÿè°¢ä¸€æ¬¡æƒ…ç»ªæé†’', 'å›æƒ³ä»Šå¤©ä¸€æ¬¡è´Ÿé¢æƒ…ç»ªï¼Œå†™ä¸‹ï¼šå®ƒæé†’äº†æˆ‘ä»€ä¹ˆéœ€æ±‚ï¼Ÿæˆ‘èƒ½ç”¨ä¸€ä¸ªå¥åº·æ–¹å¼æ»¡è¶³å®ƒæ˜¯ä»€ä¹ˆï¼Ÿ'),
('gratitude_21', 11, 'å…³ç³»ï¼šä¿®å¤ä¸€ä¸ªå°æ‘©æ“¦', 'é€‰æ‹©ä¸€ä¸ªå°æ‘©æ“¦åœºæ™¯ï¼Œå†™ä¸‹ä½ èƒ½åšçš„ä¸€ä¸ªå°ä¿®å¤åŠ¨ä½œï¼ˆä¾‹å¦‚é“æ­‰ã€è§£é‡Šã€æ„Ÿè°¢ï¼‰ã€‚'),
('gratitude_21', 12, 'æ—¶é—´ï¼šæ„Ÿè°¢ä¸€æ¬¡åšæŒ', 'å†™ä¸‹ä½ æœ€è¿‘åšæŒäº†3å¤©ä»¥ä¸Šçš„ä¸€ä»¶äº‹ï¼Œå¹¶è¯´æ˜å®ƒè®©ä½ å¾—åˆ°çš„ä¸€ä¸ªå¥½å¤„ã€‚'),
('gratitude_21', 13, 'å·¥ä½œï¼šæ„Ÿè°¢ä¸€ä¸ªæœºä¼š', 'å†™ä¸‹ä½ å½“å‰å·¥ä½œ/å­¦ä¹ é‡Œä¸€ä¸ªå¯åˆ©ç”¨çš„æœºä¼šæˆ–èµ„æºï¼Œå¹¶å†™ä¸‹ä½ æ˜å¤©ä¼šåšçš„ä¸€ä¸ªæœ€å°åˆ©ç”¨åŠ¨ä½œã€‚'),
('gratitude_21', 14, 'ä¸¤å‘¨å¤ç›˜ï¼šæˆ‘çš„å˜åŒ–', 'ç”¨0-10åˆ†ç»™â€œæƒ…ç»ªç¨³å®š/è¡ŒåŠ¨ä¸€è‡´/å…³ç³»æ»¡æ„â€å„æ‰“åˆ†ï¼Œå¹¶å†™ä¸‹å„è‡ªæå‡/ä¸‹é™çš„åŸå› ã€‚'),
('gratitude_21', 15, 'è¡¨è¾¾ï¼šæŠŠæ„Ÿè°¢è¯´å‡ºå£', 'å½“é¢æˆ–è¯­éŸ³å¯¹ä¸€ä¸ªäººè¡¨è¾¾æ„Ÿè°¢ï¼ˆ30ç§’å³å¯ï¼‰ï¼šå…·ä½“è¡Œä¸ºâ†’å½±å“â†’ä½ çš„æ„Ÿå—ã€‚'),
('gratitude_21', 16, 'æ„¿æ™¯ï¼šæ„Ÿè°¢æœªæ¥çš„è‡ªå·±', 'å†™ä¸€æ®µç»™30å¤©åçš„è‡ªå·±çš„è¯ï¼šä½ å¸Œæœ›ä»–/å¥¹ä¿æŒä»€ä¹ˆï¼Ÿä½ æ„Ÿè°¢ä»–/å¥¹ä¼šåšåˆ°ä»€ä¹ˆï¼Ÿ'),
('gratitude_21', 17, 'å­¦ä¹ ï¼šæ„Ÿè°¢ä¸€æ¬¡è¾“å…¥', 'é€‰ä¸€æ®µä½ ä»Šå¤©å­¦åˆ°çš„å†…å®¹ï¼ˆæ–‡ç« /è§†é¢‘/å¯¹è¯ï¼‰ï¼Œå†™ä¸‹1å¥å¯æ‰§è¡Œçš„æ”¶è·ï¼ˆæ˜å¤©æ€ä¹ˆç”¨ï¼‰ã€‚'),
('gratitude_21', 18, 'é‡‘é’±ï¼šæ„Ÿè°¢ä¸€ç¬”æ”¯å‡º', 'æŒ‘ä¸€ç¬”ä½ æœ€è¿‘çš„æ”¯å‡ºï¼Œå†™ä¸‹å®ƒè§£å†³äº†ä»€ä¹ˆé—®é¢˜/å¸¦æ¥äº†ä»€ä¹ˆä»·å€¼ï¼›é¿å…è‡ªè´£å¼è¯­è¨€ã€‚'),
('gratitude_21', 19, 'å‹‡æ°”ï¼šæ„Ÿè°¢ä¸€æ¬¡ä¸å®Œç¾è¡ŒåŠ¨', 'å†™ä¸‹ä½ åšè¿‡çš„ä¸€æ¬¡â€œè™½ç„¶ä¸å®Œç¾ä½†ä»ç„¶å»åšâ€çš„è¡ŒåŠ¨ï¼›æ ‡æ³¨å®ƒä½“ç°çš„å‹‡æ°”ã€‚'),
('gratitude_21', 20, 'æ•´åˆï¼šæˆ‘çš„æ„Ÿè°¢æ¸…å•', 'æŠŠå‰19å¤©é‡Œä½ æœ€æƒ³ä¿ç•™çš„5æ¡æ„Ÿè°¢æ•´ç†æˆæ¸…å•ï¼Œå¹¶å†™ä¸‹ä½ å°†å¦‚ä½•æŒç»­ï¼ˆæ¯å‘¨ä¸€æ¬¡ï¼‰ã€‚'),
('gratitude_21', 21, 'æ¯•ä¸šï¼šæŠŠæ„Ÿè°¢å˜æˆä¹ æƒ¯', 'å†™ä¸‹ï¼šè¿™21å¤©æœ€æœ‰æ•ˆçš„ä¸€ä¸ªåšæ³•ï¼›ä»¥åŠä½ æœªæ¥4å‘¨çš„æœ€å°ç»´æŒé¢‘ç‡ï¼ˆä¾‹å¦‚æ¯å‘¨3å¤©ï¼‰ã€‚')
ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;

-- 7å¤©æ­£å¿µå…¥é—¨
INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
('mindfulness_7', 1, 'å‘¼å¸é”šç‚¹ï¼ˆ3åˆ†é’Ÿï¼‰', 'è®¡æ—¶3åˆ†é’Ÿï¼šåªå…³æ³¨å‘¼å¸çš„è¿›å‡ºï¼›èµ°ç¥æ—¶æ¸©å’Œæ‹‰å›ï¼›ç»“æŸåç»™è‡ªå·±ä¸€å¥é¼“åŠ±ã€‚'),
('mindfulness_7', 2, 'èº«ä½“æ‰«æï¼ˆ5åˆ†é’Ÿï¼‰', 'ä»å¤´åˆ°è„šæ‰«æèº«ä½“æ„Ÿå—ï¼›åªæè¿°â€œç´§/æ¾/çƒ­/å†·â€ï¼Œä¸è¯„åˆ¤å¥½åã€‚'),
('mindfulness_7', 3, 'æƒ…ç»ªå‘½åï¼ˆ2åˆ†é’Ÿï¼‰', 'å½“ä¸‹æƒ…ç»ªç”¨ä¸€ä¸ªè¯å‘½åï¼ˆä¾‹å¦‚ç„¦è™‘/çƒ¦èºï¼‰ï¼›å†ç”¨ä¸€å¥è¯æè¿°å®ƒåœ¨èº«ä½“çš„æ„Ÿè§‰ã€‚'),
('mindfulness_7', 4, 'æ­£å¿µè¿›é£Ÿï¼ˆ5åˆ†é’Ÿï¼‰', 'é€‰ä¸€å°å£é£Ÿç‰©ï¼šè§‚å¯Ÿé¢œè‰²/æ°”å‘³/å£æ„Ÿï¼›æ”¾æ…¢å’€åš¼ï¼›æ³¨æ„å†²åŠ¨ä¸æ»¡è¶³çš„å˜åŒ–ã€‚'),
('mindfulness_7', 5, 'æ­£å¿µè¡Œèµ°ï¼ˆ5åˆ†é’Ÿï¼‰', 'èµ°5åˆ†é’Ÿï¼šæ³¨æ„è„šæŒè§¦åœ°ã€èº«ä½“é‡å¿ƒç§»åŠ¨ï¼›ä¸å¬ä¿¡æ¯æµã€‚'),
('mindfulness_7', 6, '3åˆ†é’Ÿé™å™ªåè®®', 'é‡åˆ°å¼ºæƒ…ç»ªæ—¶æ‰§è¡Œï¼š1åˆ†é’Ÿå‘¼å¸â†’1åˆ†é’Ÿèº«ä½“æ„Ÿå—â†’1åˆ†é’Ÿé€‰æ‹©ä¸‹ä¸€æ­¥ï¼ˆä¸€ä¸ªå°åŠ¨ä½œï¼‰ã€‚'),
('mindfulness_7', 7, 'æ¯•ä¸šå¤ç›˜', 'å†™ä¸‹ï¼šæœ¬å‘¨æœ€æœ‰æ•ˆçš„ç»ƒä¹ æ˜¯å“ªä¸€ä¸ªï¼Ÿä½ å‡†å¤‡åœ¨æœªæ¥ä¸¤å‘¨ä»¥ä»€ä¹ˆé¢‘ç‡ç»§ç»­ï¼Ÿ')
ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;

-- 30å¤©ä¹ æƒ¯å…»æˆæŒ‘æˆ˜
INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
('habit_30', 1, 'å®šä¹‰ä¸€ä¸ªæœ€å°ä¹ æƒ¯', 'é€‰æ‹©ä¸€ä¸ªä½ æƒ³å…»æˆçš„ä¹ æƒ¯ï¼ŒæŠŠå®ƒç¼©å°åˆ°â€œ2åˆ†é’Ÿç‰ˆæœ¬â€ï¼ˆä¾‹å¦‚åš5ä¸ªä¿¯å§æ’‘/å†™50å­—ï¼‰ã€‚'),
('habit_30', 2, 'è®¾ç½®è§¦å‘å™¨', 'ä¸ºä¹ æƒ¯é€‰æ‹©ä¸€ä¸ªå›ºå®šè§¦å‘å™¨ï¼ˆèµ·åºŠå/åˆ·ç‰™å/ä¸‹ç­åˆ°å®¶åï¼‰ï¼Œå†™æˆä¸€å¥è¯ï¼Œä¾‹å¦‚ï¼šâ€œå½“æˆ‘åˆ·ç‰™åï¼Œæˆ‘å°±åš2åˆ†é’Ÿç‰ˆæœ¬â€ã€‚'),
('habit_30', 3, 'å‡†å¤‡ç¯å¢ƒ', 'æŠŠæ‰§è¡Œä¹ æƒ¯éœ€è¦çš„ç‰©å“/ç¯å¢ƒå‡†å¤‡å¥½ï¼ˆä¾‹å¦‚æŠŠç‘œä¼½å«æ”¾å‡ºæ¥ï¼‰ï¼›è®©å¼€å§‹æˆæœ¬â‰¤30ç§’ã€‚'),
('habit_30', 4, 'è®°å½•ä¸€æ¬¡å®Œæˆ', 'ä»Šå¤©å®Œæˆä¸€æ¬¡2åˆ†é’Ÿç‰ˆæœ¬ï¼Œå¹¶è®°å½•ï¼šæˆ‘åœ¨ä»€ä¹ˆæ—¶åˆ»åšçš„ï¼Ÿå®Œæˆåæ„Ÿè§‰å¦‚ä½•ï¼ˆ0-10ï¼‰ï¼Ÿ'),
('habit_30', 5, 'åŠ å…¥ä¸€ä¸ªå¥–åŠ±', 'ä¸ºå®ŒæˆååŠ ä¸€ä¸ªå°å¥–åŠ±ï¼ˆ1åˆ†é’Ÿä¼¸å±•/ä¸€æ¯çƒ­æ°´/å¬ä¸€é¦–æ­Œï¼‰ï¼Œå¼ºåŒ–é—­ç¯ã€‚'),
('habit_30', 6, 'è¯†åˆ«é˜»ç¢', 'å†™ä¸‹ä½ ä»Šå¤©æœ€å¯èƒ½å¤±è´¥çš„åŸå› ï¼ˆæ—¶é—´/æƒ…ç»ª/ç¯å¢ƒï¼‰ï¼Œå¹¶ç»™ä¸€ä¸ªåº”å¯¹é¢„æ¡ˆã€‚'),
('habit_30', 7, 'ä¸€å‘¨å¤ç›˜', 'ç»Ÿè®¡æœ¬å‘¨å®Œæˆå¤©æ•°ï¼›å†™ä¸‹æœ€æœ‰æ•ˆçš„è§¦å‘å™¨ä¸æœ€å¤§é˜»ç¢ï¼›è°ƒæ•´ä¸€æ¬¡è§¦å‘å™¨æˆ–æ—¶é—´ã€‚'),
('habit_30', 8, 'æé«˜å¯è§æ€§', 'æŠŠä¹ æƒ¯æ”¾åˆ°æ›´å¯è§çš„ä½ç½®ï¼ˆä¾¿ç­¾/æ¡Œé¢/æ—¥å†ï¼‰ï¼Œè®©ä½ æ›´å®¹æ˜“æƒ³èµ·å®ƒã€‚'),
('habit_30', 9, 'ç¼©çŸ­å¯åŠ¨æ—¶é—´', 'æŠŠâ€œå¼€å§‹åŠ¨ä½œâ€è¿›ä¸€æ­¥ç¼©çŸ­ï¼ˆä¾‹å¦‚åªåš1ä¸ªä¿¯å§æ’‘ä¹Ÿç®—å¼€å§‹ï¼‰ï¼Œç¡®ä¿ä»Šå¤©ä¸ä¼šé›¶ã€‚'),
('habit_30', 10, 'æé«˜ä¸€è‡´æ€§', 'æŠŠä¹ æƒ¯å›ºå®šåˆ°åŒä¸€æ—¶é—´æ®µï¼›å¦‚æœåšä¸åˆ°ï¼Œå°±å›ºå®šâ€œåŒä¸€è§¦å‘å™¨â€ã€‚'),
('habit_30', 11, 'å»ºç«‹æ›¿ä»£æ–¹æ¡ˆ', 'å‡†å¤‡ä¸€ä¸ªâ€œä½èƒ½é‡ç‰ˆæœ¬â€ï¼ˆä¾‹å¦‚ç´¯æ—¶åš30ç§’ï¼‰ï¼Œä¿è¯æƒ…ç»ªä½è°·ä¹Ÿèƒ½å®Œæˆã€‚'),
('habit_30', 12, 'æ¶ˆé™¤ä¸€ä¸ªæ‘©æ“¦', 'æ‰¾åˆ°ä¸€ä¸ªè®©ä½ ä¸æƒ³åšçš„æ‘©æ“¦ç‚¹ï¼ˆå‡†å¤‡éº»çƒ¦/å¤ªè¿œï¼‰ï¼Œä»Šå¤©æŠŠå®ƒæ¶ˆæ‰ã€‚'),
('habit_30', 13, 'æŠŠä¹ æƒ¯å’Œèº«ä»½ç»‘å®š', 'å†™ä¸€å¥èº«ä»½å®£è¨€ï¼šæˆ‘æ˜¯è°â†’æˆ‘ä¼šåšä»€ä¹ˆï¼ˆä¾‹å¦‚â€œæˆ‘æ˜¯é‡è§†å¥åº·çš„äººï¼Œæ‰€ä»¥æˆ‘æ¯å¤©åŠ¨2åˆ†é’Ÿâ€ï¼‰ã€‚'),
('habit_30', 14, 'ä¸¤å‘¨å¤ç›˜', 'ç»Ÿè®¡14å¤©å®Œæˆç‡ï¼›å†™ä¸‹ä½ æœ€å¸¸è§çš„å¤±è´¥åœºæ™¯ï¼Œå¹¶æ›´æ–°ä¸€ä¸ªæ›´ç°å®çš„é¢„æ¡ˆã€‚'),
('habit_30', 15, 'æå‡ä¸€ç‚¹éš¾åº¦', 'æŠŠ2åˆ†é’Ÿç‰ˆæœ¬æå‡10%-20%ï¼ˆä»ç„¶å¾ˆå°ï¼‰ï¼Œä¾‹å¦‚ä»å†™50å­—åˆ°å†™60å­—ã€‚'),
('habit_30', 16, 'è®©å®ƒæ›´æœ‰è¶£', 'ç»™ä¹ æƒ¯åŠ ä¸€ç‚¹ä¹è¶£ï¼ˆéŸ³ä¹/è®¡æ—¶æŒ‘æˆ˜/æ‰“å¡è§†è§‰åŒ–ï¼‰ï¼Œè®©ä½ æ›´æ„¿æ„å¼€å§‹ã€‚'),
('habit_30', 17, 'å»ºç«‹â€œå¦‚æœ-é‚£ä¹ˆâ€è®¡åˆ’', 'å†™ä¸‹ä¸¤æ¡ï¼šå¦‚æœæˆ‘åŠ ç­â†’é‚£ä¹ˆæˆ‘åšä½èƒ½é‡ç‰ˆæœ¬ï¼›å¦‚æœæˆ‘å¿˜äº†â†’é‚£ä¹ˆæˆ‘ç¡å‰è¡¥ä¸€æ¬¡ã€‚'),
('habit_30', 18, 'åŠ å…¥ç¤¾äº¤æ‰¿è¯º', 'æ‰¾ä¸€ä¸ªæœ‹å‹æˆ–å¯¹è¯é‡Œåšä¸€ä¸ªæ‰¿è¯ºï¼šæˆ‘å°†åšæŒåˆ°ç¬¬30å¤©ï¼›å¹¶å†™ä¸‹ä½ å¸Œæœ›è¢«å¦‚ä½•æé†’ã€‚'),
('habit_30', 19, 'è¿ç»­3å¤©æŒ‘æˆ˜', 'ç›®æ ‡ï¼šè¿ç»­3å¤©ä¸é—´æ–­å®Œæˆï¼ˆå…è®¸ä½èƒ½é‡ç‰ˆæœ¬ï¼‰ã€‚'),
('habit_30', 20, 'å¤ç›˜å¥–åŠ±æœºåˆ¶', 'å†™ä¸‹å¥–åŠ±æ˜¯å¦æœ‰æ•ˆï¼›å¦‚æœæ— æ•ˆï¼Œæ¢ä¸€ä¸ªæ›´é€‚åˆä½ çš„å¥–åŠ±ï¼ˆä¸é åˆ·çŸ­è§†é¢‘ï¼‰ã€‚'),
('habit_30', 21, 'ä¸‰å‘¨å¤ç›˜', 'ç»Ÿè®¡21å¤©å®Œæˆç‡ï¼›å†™ä¸‹ä½ å®Œæˆæœ€å¤šçš„æ—¶é—´æ®µï¼›æŠŠä¹ æƒ¯å›ºå®šåˆ°é‚£ä¸ªæ—¶é—´æ®µã€‚'),
('habit_30', 22, 'å‡å°‘è‡ªè´£', 'å†™ä¸‹ï¼šæˆ‘å¤±è´¥æ—¶å¸¸è¯´çš„è‡ªè´£å¥ï¼›æŠŠå®ƒæ”¹å†™æˆæ•™ç»ƒå¥ï¼ˆä¾‹å¦‚â€œä¸‹ä¸€æ¬¡æˆ‘åšæ›´å°â€ï¼‰ã€‚'),
('habit_30', 23, 'ä¼˜åŒ–æé†’', 'è®¾ç½®ä¸€ä¸ªå…·ä½“æé†’ï¼ˆé—¹é’Ÿ/æ—¥å†ï¼‰ï¼Œå¹¶å†™ä¸Šè¡ŒåŠ¨æ–‡æ¡ˆï¼ˆä¸æ˜¯â€œåˆ«å¿˜äº†â€ï¼Œè€Œæ˜¯â€œç°åœ¨åš2åˆ†é’Ÿç‰ˆæœ¬â€ï¼‰ã€‚'),
('habit_30', 24, 'æŠŠä¹ æƒ¯è¿åˆ°ç›®æ ‡', 'å†™ä¸‹ï¼šè¿™ä¸ªä¹ æƒ¯æœ€ç»ˆæœåŠ¡ä»€ä¹ˆç›®æ ‡ï¼Ÿå®ƒè®©ä½ æ›´æ¥è¿‘ç›®æ ‡çš„è¯æ®æ˜¯ä»€ä¹ˆï¼Ÿ'),
('habit_30', 25, 'åº”å¯¹çªå‘', 'å‡è®¾æ˜å¤©æœ‰çªå‘äº‹ä»¶ï¼Œå†™ä¸‹ä½ ä»èƒ½å®Œæˆçš„æœ€å°åŠ¨ä½œæ˜¯ä»€ä¹ˆï¼Œå¹¶æ‰¿è¯ºæ‰§è¡Œã€‚'),
('habit_30', 26, 'è¿ç»­7å¤©ç»´æŠ¤', 'ç›®æ ‡ï¼šè¿ç»­7å¤©éƒ½å®Œæˆï¼ˆå…è®¸ä½èƒ½é‡ç‰ˆæœ¬ï¼‰ï¼›åªè¿½æ±‚â€œä¸æ–­â€ã€‚'),
('habit_30', 27, 'æ•´ç†æˆæœ', 'å†™ä¸‹æœ¬æœˆä½ ç´¯è®¡å®Œæˆäº†å¤šå°‘æ¬¡ï¼›ä½ æ„Ÿè§‰æœ€å¤§çš„å˜åŒ–æ˜¯ä»€ä¹ˆï¼ˆå“ªæ€•å¾ˆå°ï¼‰ã€‚'),
('habit_30', 28, 'å»ºç«‹å¤ç›˜ä»ªå¼', 'é€‰æ‹©ä¸€ä¸ªæ¯å‘¨å›ºå®šçš„å¤ç›˜æ—¶åˆ»ï¼ˆä¾‹å¦‚å‘¨æ—¥20:00ï¼‰ï¼Œå†™ä¸‹ä½ å°†æ£€æŸ¥çš„3ä¸ªé—®é¢˜ã€‚'),
('habit_30', 29, 'å‡†å¤‡é•¿æœŸç‰ˆæœ¬', 'ä¸ºä¸‹ä¸ªæœˆå®šä¹‰ä¸€ä¸ªå¯æŒç»­ç‰ˆæœ¬ï¼ˆä¸æ¯”ç°åœ¨æ›´éš¾ï¼‰ï¼Œå¹¶ç¡®å®šè§¦å‘å™¨ä¸æé†’æ–¹å¼ã€‚'),
('habit_30', 30, 'æ¯•ä¸šï¼šå†™ä¸€å°ç»™è‡ªå·±çš„ä¿¡', 'å†™ä¸‹ï¼šæˆ‘é ä»€ä¹ˆåšæŒäº†30å¤©ï¼Ÿæˆ‘ä¸‹ä¸ªæœˆç»§ç»­çš„æœ€å°é¢‘ç‡æ˜¯å¤šå°‘ï¼Ÿ')
ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;

-- 14å¤©ä¼˜åŠ¿å‘ç°ä¹‹æ—…
INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
('strength_14', 1, 'åˆ—å‡º5æ¬¡é«˜å…‰æ—¶åˆ»', 'å†™ä¸‹ä½ è¿‡å»1-2å¹´é‡Œ5æ¬¡â€œåšå¾—å¾ˆé¡º/å¾ˆæŠ•å…¥â€çš„æ—¶åˆ»ï¼›æ¯æ¬¡å†™æ¸…åœºæ™¯ä¸ç»“æœã€‚'),
('strength_14', 2, 'æç‚¼3ä¸ªä¼˜åŠ¿', 'ä»é«˜å…‰æ—¶åˆ»é‡Œæç‚¼3ä¸ªåå¤å‡ºç°çš„ä¼˜åŠ¿ï¼ˆä¾‹å¦‚ç»„ç»‡ã€è¡¨è¾¾ã€æ´å¯Ÿã€æ‰§è¡Œï¼‰ï¼Œå¹¶å„å†™ä¸€å¥è¯æ®ã€‚'),
('strength_14', 3, 'ä¼˜åŠ¿å‘½å', 'ç»™æ¯ä¸ªä¼˜åŠ¿èµ·ä¸€ä¸ªä½ å–œæ¬¢çš„åå­—ï¼ˆæ›´ä¸ªäººåŒ–ï¼‰ï¼Œå¹¶å†™ä¸‹å®ƒåœ¨ä½ èº«ä¸Šçš„è¡¨ç°ã€‚'),
('strength_14', 4, 'ä¼˜åŠ¿åº”ç”¨ï¼šå·¥ä½œ', 'é€‰æ‹©ä¸€ä¸ªå·¥ä½œ/å­¦ä¹ ä»»åŠ¡ï¼Œåˆ»æ„ç”¨ä¸€ä¸ªä¼˜åŠ¿å®Œæˆå®ƒï¼›è®°å½•ç»“æœä¸æ„Ÿå—ã€‚'),
('strength_14', 5, 'ä¼˜åŠ¿åº”ç”¨ï¼šå…³ç³»', 'é€‰æ‹©ä¸€ä¸ªå…³ç³»åœºæ™¯ï¼Œç”¨ä¸€ä¸ªä¼˜åŠ¿æ”¹å–„æ²Ÿé€šï¼ˆä¾‹å¦‚å€¾å¬/è¡¨è¾¾/è¾¹ç•Œï¼‰ï¼Œå¹¶è®°å½•åé¦ˆã€‚'),
('strength_14', 6, 'è¯†åˆ«ä¼˜åŠ¿çš„é˜´å½±é¢', 'ä¸ºæ¯ä¸ªä¼˜åŠ¿å†™ä¸‹å®ƒçš„â€œè¿‡åº¦ä½¿ç”¨â€ä¼šå¸¦æ¥çš„é—®é¢˜ï¼ˆä¾‹å¦‚è¿‡åº¦è´Ÿè´£ã€è¿‡åº¦æŒ‘å‰”ï¼‰ã€‚'),
('strength_14', 7, 'ä¸€å‘¨å¤ç›˜ï¼šä¼˜åŠ¿æœ€æœ‰ç”¨çš„æ—¶åˆ»', 'å†™ä¸‹æœ¬å‘¨ä¼˜åŠ¿æœ€æœ‰å¸®åŠ©çš„ä¸€æ¬¡ç»å†ï¼›ä»¥åŠä¸‹ä¸€å‘¨ä½ æƒ³åœ¨å“ªä¸ªåœºæ™¯ç»§ç»­ç”¨å®ƒã€‚'),
('strength_14', 8, 'ä¼˜åŠ¿ç»„åˆ', 'æŒ‘ä¸¤ä¸ªä¼˜åŠ¿åšç»„åˆï¼šå®ƒä»¬å¦‚ä½•äº’è¡¥ï¼Ÿå†™ä¸‹ä¸€ä¸ªä½ æƒ³å°è¯•çš„ç»„åˆè¡ŒåŠ¨ã€‚'),
('strength_14', 9, 'ä¼˜åŠ¿è¡¥çŸ­', 'é€‰ä¸€ä¸ªä½ ç»å¸¸å¡ä½çš„å¼±é¡¹ï¼Œå†™ä¸‹ç”¨å“ªä¸ªä¼˜åŠ¿å¯ä»¥â€œç»•è¿‡å»â€ï¼ˆä¾‹å¦‚ç”¨ç»“æ„åŒ–ä»£æ›¿æ‹–å»¶ï¼‰ã€‚'),
('strength_14', 10, 'ä¼˜åŠ¿ä¸ç›®æ ‡å¯¹é½', 'å†™ä¸‹ä½ å½“å‰ä¸€ä¸ªç›®æ ‡ï¼›æŠŠå®ƒæ‹†æˆ3æ­¥ï¼Œå¹¶æ ‡æ³¨æ¯æ­¥ä½¿ç”¨å“ªä¸ªä¼˜åŠ¿æœ€çœåŠ›ã€‚'),
('strength_14', 11, 'è¯·æ±‚æ”¯æŒ', 'æ‰¾ä¸€ä¸ªäººæè¿°ä½ çš„ä¸€ä¸ªä¼˜åŠ¿ï¼Œå¹¶è¯·å¯¹æ–¹ç»™ä¸€ä¸ªä½ å¯ä»¥æ›´å¥½å‘æŒ¥çš„å»ºè®®ã€‚'),
('strength_14', 12, 'ä¼˜åŠ¿è¡¨è¾¾ä¸ºä»·å€¼', 'å†™ä¸€æ®µ30ç§’è‡ªæˆ‘ä»‹ç»ï¼šæˆ‘æ“…é•¿ä»€ä¹ˆâ†’èƒ½ä¸ºåˆ«äººå¸¦æ¥ä»€ä¹ˆä»·å€¼ï¼ˆé¿å…ç©ºè¯ï¼‰ã€‚'),
('strength_14', 13, 'ä¼˜åŠ¿åœ¨å‹åŠ›ä¸‹çš„ä½¿ç”¨', 'å›æƒ³ä¸€æ¬¡å‹åŠ›æƒ…å¢ƒï¼Œå†™ä¸‹ä½ å¯ä»¥å¦‚ä½•ç”¨ä¼˜åŠ¿ç¨³å®šè‡ªå·±ï¼Œå¹¶è®¾è®¡ä¸€ä¸ªä¸‹æ¬¡çš„åº”å¯¹å¥ã€‚'),
('strength_14', 14, 'æ¯•ä¸šï¼šä¼˜åŠ¿ä½¿ç”¨è®¡åˆ’', 'å†™ä¸‹æœªæ¥4å‘¨ä½ è¦åˆ»æ„ä½¿ç”¨çš„1ä¸ªä¼˜åŠ¿ï¼›è®¾å®šæ¯å‘¨è‡³å°‘2æ¬¡çš„åº”ç”¨åœºæ™¯ã€‚')
ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;
```

### 6.8 æ¯æ—¥æŒ‡å¼•ï¼ˆä»Šæ—¥å¡ SSOTï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_daily_guidance (
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  guidance_date DATE NOT NULL,
  card JSONB NOT NULL,                    -- Guidance Card
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (user_id, guidance_date)
);
```

### 6.9 æ¨é€è°ƒåº¦ä¸å‘é€è®°å½•ï¼ˆå¯å®¡è®¡ï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_push_event (
  push_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  push_type TEXT NOT NULL CHECK (push_type IN ('plan_daily','weekly_reflection','milestone')),
  scheduled_at TIMESTAMPTZ NOT NULL,
  sent_at TIMESTAMPTZ,
  status TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled','sent','skipped','failed')),
  payload JSONB NOT NULL,
  error TEXT NOT NULL DEFAULT '',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_push_user_scheduled ON fortune_push_event (user_id, scheduled_at DESC);
```

### 6.10 å…«å­—çŸ¥è¯†åº“ï¼ˆPDF å…¥åº“ â†’ PostgreSQL æ£€ç´¢ï¼‰

```sql
CREATE TABLE IF NOT EXISTS bazi_kb_document (
  doc_id BIGSERIAL PRIMARY KEY,
  file_name TEXT NOT NULL,
  sha256 TEXT NOT NULL,
  title TEXT NOT NULL DEFAULT '',
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (sha256)
);

CREATE TABLE IF NOT EXISTS bazi_kb_chunk (
  chunk_id BIGSERIAL PRIMARY KEY,
  doc_id BIGINT NOT NULL REFERENCES bazi_kb_document(doc_id) ON DELETE CASCADE,
  page_no INTEGER NOT NULL CHECK (page_no > 0),
  chunk_no INTEGER NOT NULL CHECK (chunk_no > 0),
  content TEXT NOT NULL,
  content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (doc_id, page_no, chunk_no)
);
CREATE INDEX IF NOT EXISTS idx_kb_chunk_tsv ON bazi_kb_chunk USING GIN (content_tsv);
CREATE INDEX IF NOT EXISTS idx_kb_chunk_trgm ON bazi_kb_chunk USING GIN (content gin_trgm_ops);
```

æ£€ç´¢ï¼ˆç”¨äº Structured RAGï¼‰ï¼š
```sql
-- å…³é”®è¯æ£€ç´¢ï¼ˆFTSï¼‰
SELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,
       ts_rank(c.content_tsv, plainto_tsquery('simple', :q)) AS rank,
       c.content
FROM bazi_kb_chunk c
WHERE c.content_tsv @@ plainto_tsquery('simple', :q)
ORDER BY rank DESC
LIMIT 12;

-- ä¸­æ–‡åœºæ™¯è¡¥å……ï¼štrgm ç›¸ä¼¼åº¦
SELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,
       similarity(c.content, :q) AS sim,
       c.content
FROM bazi_kb_chunk c
WHERE c.content % :q
ORDER BY sim DESC
LIMIT 12;
```

### 6.10.1 çŸ¥è¯†åº“å…¥åº“æµç¨‹ï¼ˆPDF â†’ æ–‡æœ¬ â†’ chunk â†’ PostgreSQLï¼‰

**è¾“å…¥ç›®å½•**
- `fortune_ai/knowledge/bazi/*.pdf`

**ä¾èµ–ï¼ˆPythonï¼‰**
- `pypdf`ï¼ˆç”¨äº PDF æ–‡æœ¬æŠ½å–ï¼‰

**å…¥åº“è§„åˆ™ï¼ˆå›ºå®šï¼‰**
- `bazi_kb_document.sha256` å”¯ä¸€ï¼Œä¿è¯å¹‚ç­‰ï¼šåŒä¸€ PDF é‡å¤å¯¼å…¥ä¸ä¼šäº§ç”Ÿé‡å¤æ–‡æ¡£ã€‚
- chunk å‚æ•°å›ºå®šï¼š
  - `chunk_size_chars = 800`
  - `chunk_overlap_chars = 120`
- `kb_ref` ç»Ÿä¸€æ ¼å¼ï¼š`kb:doc:{doc_id}:page:{page_no}:chunk:{chunk_no}`

**å…¥åº“æ­¥éª¤ï¼ˆè„šæœ¬æ‰§è¡Œé¡ºåºï¼‰**
1) éå† PDFï¼šè®¡ç®—æ–‡ä»¶ `sha256`ï¼Œå†™å…¥/å¤ç”¨ `bazi_kb_document`ã€‚
2) é€é¡µæŠ½å–æ–‡æœ¬ï¼šä¿ç•™ `page_no`ï¼›æ¸…ç†å¤šä½™ç©ºç™½ä¸é‡å¤æ¢è¡Œã€‚
3) åˆ†æ®µåˆ‡åˆ†ï¼š
   - å…ˆæŒ‰æ®µè½ï¼ˆç©ºè¡Œï¼‰æ‹†åˆ†
   - å†æŒ‰å­—ç¬¦æ•°åˆå¹¶æˆ chunkï¼ˆ800 å­—ï¼‰ï¼Œç›¸é‚» chunk 120 å­—é‡å 
4) å†™å…¥ `bazi_kb_chunk`ï¼ˆ`doc_id + page_no + chunk_no` å”¯ä¸€ï¼‰

### 6.11 è§„åˆ™åº“ï¼ˆ`rule_ids` SSOTï¼Œå¯è¿½æº¯ï¼‰

```sql
CREATE TABLE IF NOT EXISTS fortune_rule (
  rule_id TEXT PRIMARY KEY,
  category TEXT NOT NULL,
  name TEXT NOT NULL,
  body JSONB NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_rule_category ON fortune_rule (category);
```

å†™å…¥ MVP å¿…å¤‡è§„åˆ™ï¼ˆä¸ Â§5.3/Â§5.4 ä¿æŒä¸€è‡´ï¼‰ï¼š

```sql
INSERT INTO fortune_rule (rule_id, category, name, body) VALUES
('RULE-STRENGTH-SCORE-V1', 'bazi_strength', 'æ—ºè¡°è¯„åˆ†ç®—æ³•', '{
  "season_map": {"å¯…":"æœ¨","å¯":"æœ¨","è¾°":"æœ¨","å·³":"ç«","åˆ":"ç«","æœª":"ç«","ç”³":"é‡‘","é…‰":"é‡‘","æˆŒ":"é‡‘","äº¥":"æ°´","å­":"æ°´","ä¸‘":"æ°´"},
  "day_master_map": {"ç”²":"æœ¨","ä¹™":"æœ¨","ä¸™":"ç«","ä¸":"ç«","æˆŠ":"åœŸ","å·±":"åœŸ","åºš":"é‡‘","è¾›":"é‡‘","å£¬":"æ°´","ç™¸":"æ°´"},
  "threshold": {"strong": 2, "weak": -2}
}'::jsonb),
('RULE-SHENSHA-TAOHUA-V1', 'bazi_shensha', 'æ¡ƒèŠ±ï¼ˆå’¸æ± ï¼‰', '{
  "group_map": {"ç”³å­è¾°":"é…‰","äº¥å¯æœª":"å­","å¯…åˆæˆŒ":"å¯","å·³é…‰ä¸‘":"åˆ"},
  "basis": "year_or_day_branch"
}'::jsonb),
('RULE-SHENSHA-YIMA-V1', 'bazi_shensha', 'é©¿é©¬', '{
  "group_map": {"ç”³å­è¾°":"å¯…","äº¥å¯æœª":"å·³","å¯…åˆæˆŒ":"ç”³","å·³é…‰ä¸‘":"äº¥"},
  "basis": "year_or_day_branch"
}'::jsonb),
('RULE-SHENSHA-HUAGAI-V1', 'bazi_shensha', 'åç›–', '{
  "group_map": {"ç”³å­è¾°":"è¾°","äº¥å¯æœª":"æœª","å¯…åˆæˆŒ":"æˆŒ","å·³é…‰ä¸‘":"ä¸‘"},
  "basis": "year_or_day_branch"
}'::jsonb),
('RULE-SHENSHA-TIANYI-V1', 'bazi_shensha', 'å¤©ä¹™è´µäºº', '{
  "day_gan_map": {"ç”²":["ä¸‘","æœª"],"æˆŠ":["ä¸‘","æœª"],"åºš":["ä¸‘","æœª"],"ä¹™":["å­","ç”³"],"å·±":["å­","ç”³"],"ä¸™":["äº¥","é…‰"],"ä¸":["äº¥","é…‰"],"è¾›":["å¯…","åˆ"],"å£¬":["å¯","å·³"],"ç™¸":["å¯","å·³"]}
}'::jsonb),
('RULE-SHENSHA-WENCHANG-V1', 'bazi_shensha', 'æ–‡æ˜Œ', '{
  "day_gan_map": {"ç”²":["å·³","åˆ"],"ä¹™":["å·³","åˆ"],"ä¸™":["ç”³","é…‰"],"ä¸":["ç”³","é…‰"],"æˆŠ":["ç”³","é…‰"],"å·±":["ç”³","é…‰"],"åºš":["äº¥","å­"],"è¾›":["äº¥","å­"],"å£¬":["å¯…","å¯"],"ç™¸":["å¯…","å¯"]}
}'::jsonb)
ON CONFLICT (rule_id) DO UPDATE SET
  category = EXCLUDED.category,
  name = EXCLUDED.name,
  body = EXCLUDED.body,
  updated_at = now();
```

### 6.12 å¤–éƒ¨ä»»åŠ¡æ˜ å°„ï¼ˆæŠ¥å‘Š Jobï¼šbackend=cli|geminiï¼‰

ç›®æ ‡ï¼šFortune AI çš„ä¸šåŠ¡é—­ç¯ä¸æƒé™åœ¨ `fortune_ai` åº“å†…å®Œæˆï¼›æŠ¥å‘Šç”Ÿæˆçš„æ‰§è¡Œä¸çŠ¶æ€å¯æ¥è‡ª `backend=cli|gemini`ï¼Œæœ¬è¡¨è´Ÿè´£åœ¨ä¸¤è€…ä¹‹é—´å»ºç«‹â€œç”¨æˆ· â†” provider_job_idâ€çš„å¯å®¡è®¡æ˜ å°„ã€‚

```sql
CREATE TABLE IF NOT EXISTS fortune_external_job (
  id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,
  provider TEXT NOT NULL CHECK (provider IN ('cli','gemini')),
  job_type TEXT NOT NULL CHECK (job_type IN ('bazi_report')),
  provider_job_id BIGINT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('processing','completed','error')),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  last_polled_at TIMESTAMPTZ,
  output_url TEXT NOT NULL DEFAULT '',
  output_a2ui JSONB,
  error TEXT NOT NULL DEFAULT '',
  UNIQUE (provider, provider_job_id)
);
CREATE INDEX IF NOT EXISTS idx_external_job_user_time ON fortune_external_job (user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_external_job_status ON fortune_external_job (status, updated_at DESC);
```

---

## 7. API è®¾è®¡ï¼ˆç»Ÿä¸€å‘½åï¼Œç›´æ¥å®ç°ï¼‰

### 7.0 è®¤è¯ä¸é€šç”¨çº¦å®šï¼ˆå¿…é¡»ï¼‰

**æ— æ¸¸å®¢æ¨¡å¼**
- åªæœ‰ä»¥ä¸‹æ¥å£ä¸éœ€è¦ç™»å½•ï¼š
  - `POST /api/auth/register`
  - `POST /api/auth/login`
- å…¶ä½™æ‰€æœ‰æ¥å£éƒ½è¦æ±‚æœ‰æ•ˆç™»å½•æ€ï¼Œå¦åˆ™è¿”å› `401`ã€‚

**ç™»å½•æ€ï¼ˆCookie ä¼šè¯ï¼‰**
- Cookieï¼š
  - `fortune_session`ï¼š`base64url` éšæœº tokenï¼ˆHttpOnlyï¼Œ`SameSite=Lax`ï¼Œ`Path=/`ï¼‰
  - `fortune_csrf`ï¼šéšæœº CSRF tokenï¼ˆé HttpOnlyï¼Œ`SameSite=Lax`ï¼Œ`Path=/`ï¼‰
- æœåŠ¡ç«¯æ ¡éªŒï¼š
  - `fortune_session` â†’ `sha256(token)` åŒ¹é… `fortune_user_session.token_hash`ï¼Œä¸” `revoked_at IS NULL AND expires_at > now()`
  - å¯¹æ‰€æœ‰ `POST/PUT/DELETE`ï¼šè¦æ±‚è¯·æ±‚å¤´ `X-CSRF-Token`ï¼Œå…¶ `sha256` å¿…é¡»åŒ¹é… `fortune_user_session.csrf_token_hash`

**ç»Ÿä¸€å“åº”ç»“æ„**

æˆåŠŸï¼š
```json
{"ok": true, "data": {}}
```

å¤±è´¥ï¼š
```json
{"ok": false, "error": {"code": "invalid_request", "message": "missing_field: birthday_local", "detail": {"field": "birthday_local"}}}
```

### 7.1 è®¤è¯ä¸ç”¨æˆ·ç®¡ç†

`POST /api/auth/register`ï¼ˆæ³¨å†Œå³ç™»å½•ï¼‰

è¯·æ±‚ï¼š
```json
{
  "email": "zhangsan@example.com",
  "password": "S3curePassw0rd!",
  "name": "å¼ ä¸‰",
  "gender": "ç”·",
  "birthday_local": "1990-05-12 14:00:00",
  "tz_offset_hours": 8.0,
  "location": {"name": "åŒ—äº¬", "longitude": 116.4074, "latitude": 39.9042}
}
```

è¡Œä¸ºï¼š
- åˆ›å»º `fortune_user`ï¼ˆ`email` ç»Ÿä¸€è½¬å°å†™å­˜å‚¨ï¼›`password_hash` ä½¿ç”¨ bcryptï¼‰
- upsert `fortune_user_preferences`ï¼ˆé»˜è®¤ `persona_style=warm`ï¼‰
- åˆ›å»ºä¼šè¯ï¼šæ’å…¥ `fortune_user_session`ï¼Œä¸‹å‘ `fortune_session` ä¸ `fortune_csrf` Cookie
- è®¡ç®—å¹¶å†™å…¥ `fortune_bazi_snapshot`ï¼ˆ`compute_version=bazi-tts-v1`ï¼‰

å“åº”ï¼š
```json
{
  "ok": true,
  "data": {
    "user_id": 123,
    "email": "zhangsan@example.com",
    "profile_summary": {"name": "å¼ ä¸‰", "gender": "ç”·", "location_name": "åŒ—äº¬"}
  }
}
```

`POST /api/auth/login`

è¯·æ±‚ï¼š
```json
{"email":"zhangsan@example.com","password":"S3curePassw0rd!"}
```

è¡Œä¸ºï¼š
- æ ¡éªŒå¯†ç ï¼ˆbcryptï¼‰
- æ›´æ–° `fortune_user.last_login_at`
- åˆ›å»º `fortune_user_session` å¹¶ä¸‹å‘ Cookie

å“åº”ï¼š
```json
{"ok": true, "data": {"user_id": 123, "email": "zhangsan@example.com", "name": "å¼ ä¸‰"}}
```

`GET /api/auth/me`

å“åº”ï¼š
```json
{"ok": true, "data": {"user_id": 123, "email": "zhangsan@example.com", "name": "å¼ ä¸‰", "persona_style": "warm"}}
```

`POST /api/auth/logout`
- è¡Œä¸ºï¼šå°†å½“å‰ `fortune_user_session.revoked_at = now()`ï¼Œå¹¶æ¸…ç©º Cookie

`GET /api/auth/sessions`
å“åº”ï¼š
```json
{
  "ok": true,
  "data": {
    "sessions": [
      {"session_id":"a9c55f2f-2d2b-4f02-9c35-7f5a0d6d9a1c","created_at":"2025-12-29T10:00:00Z","expires_at":"2026-01-28T10:00:00Z","ip":"106.37.170.238","user_agent":"Mozilla/5.0"}
    ]
  }
}
```

`POST /api/auth/logout-all`
- è¡Œä¸ºï¼šå°†è¯¥ç”¨æˆ·æ‰€æœ‰æœªè¿‡æœŸ session æ ‡è®° `revoked_at = now()`ï¼Œå¹¶æ¸…ç©ºå½“å‰ Cookie

`PUT /api/auth/password`

è¯·æ±‚ï¼š
```json
{"old_password":"S3curePassw0rd!","new_password":"N3wS3curePassw0rd!"}
```

è¡Œä¸ºï¼š
- æ ¡éªŒæ—§å¯†ç  â†’ æ›´æ–° `fortune_user.password_hash`
- é€€å‡ºæ‰€æœ‰ç™»å½•æ€ï¼š`logout-all`

`DELETE /api/auth/account`

è¯·æ±‚ï¼š
```json
{"password":"N3wS3curePassw0rd!"}
```

è¡Œä¸ºï¼š
- æ ¡éªŒå¯†ç  â†’ `fortune_user.deleted_at = now()`
- é€€å‡ºæ‰€æœ‰ç™»å½•æ€ï¼š`logout-all`

### 7.2 ç”¨æˆ·èµ„æ–™ï¼ˆProfileï¼‰

`GET /api/user/profile`

å“åº”ï¼š
```json
{
  "ok": true,
  "data": {
    "profile": {
      "name": "å¼ ä¸‰",
      "gender": "ç”·",
      "birthday_local": "1990-05-12 14:00:00",
      "tz_offset_hours": 8.0,
      "location": {"name": "åŒ—äº¬", "longitude": 116.4074, "latitude": 39.9042}
    },
    "preferences": {"persona_style":"warm","push_enabled":true,"push_time":"08:00:00","quiet_hours_start":"22:00:00","quiet_hours_end":"07:00:00"}
  }
}
```

`PUT /api/user/profile`ï¼ˆæ›´æ–°å‡ºç”Ÿä¿¡æ¯ä¼šè§¦å‘é‡ç®—ï¼‰

è¯·æ±‚ï¼š
```json
{
  "name": "å¼ ä¸‰",
  "gender": "ç”·",
  "birthday_local": "1990-05-12 13:50:00",
  "tz_offset_hours": 8.0,
  "location": {"name": "åŒ—äº¬", "longitude": 116.4074, "latitude": 39.9042}
}
```

è¡Œä¸ºï¼š
- æ›´æ–° `fortune_user` çš„ Profile å­—æ®µ
- å†™å…¥æ–°çš„ `fortune_bazi_snapshot`ï¼ˆé‡ç®—å¹¶ç”Ÿæˆæ–° `facts_hash`ï¼‰

### 7.3 ä¼šè¯

`POST /api/session/new`
```json
{"title": "æ–°å¯¹è¯"}
```

å“åº”ï¼š
```json
{"ok": true, "data": {"session_id": "5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d", "title": "æ–°å¯¹è¯"}}
```

`GET /api/session/list`
```json
{"ok": true, "data": {"sessions": [{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","title":"æ–°å¯¹è¯","updated_at":"2025-12-29T10:00:00Z","preview":"æˆ‘æœ€è¿‘å¾ˆç„¦è™‘ï¼Œå·¥ä½œè¦ä¸è¦æ¢ï¼Ÿ"}]}}
```

`GET /api/session/{session_id}`
```json
{"ok": true, "data": {"messages": [{"role":"user","content":"æˆ‘æœ€è¿‘å¾ˆç„¦è™‘ï¼Œå·¥ä½œè¦ä¸è¦æ¢ï¼Ÿ"},{"role":"assistant","content":"ï¼ˆå·²ç”¨A2UIè¿”å›ï¼‰","a2ui":{"meta":{"summary":"æŠŠé—®é¢˜å†™æ¸…å¹¶åšæœ€å°éªŒè¯"},"ui_components":[{"type":"markdown_text","title":"è¾“å‡º","data":"### ç»“è®ºè¦ç‚¹\\n- ä½ ç°åœ¨çš„ç„¦è™‘ä¸»è¦æ¥è‡ªä¸ç¡®å®šæ€§ä¸ä¿¡æ¯è¿‡è½½ã€‚\\n\\n### è¡ŒåŠ¨å¤„æ–¹ï¼ˆâ‰¤3æ¡ï¼‰\\n1) ç”¨å†³ç­–æ¨¡æ¿å†™æ¸…é€‰é¡¹/çº¦æŸï¼ˆ10åˆ†é’Ÿï¼‰\\n2) 48å°æ—¶å†…åšä¸€æ¬¡æœ€å°éªŒè¯ï¼ˆæ‰¾1ä½åŒè¡ŒèŠ15åˆ†é’Ÿï¼‰\\n3) æƒ…ç»ªå³°å€¼å…ˆåš3åˆ†é’Ÿé™å™ªå†å†³ç­–\\n\\n### æ‰¿è¯º\\nä½ æ„¿æ„å…ˆåšå“ªä¸€ä¸ªï¼Ÿ"}]}}}]}}
```

### 7.4 Chatï¼ˆGLMï¼Œå†™å…¥ä¼šè¯ + ç”Ÿæˆâ€œå»ºè®®æ‰¿è¯ºâ€ï¼‰

`POST /api/chat/send`

è¯·æ±‚ï¼š
```json
{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","text":"æˆ‘æœ€è¿‘å¾ˆç„¦è™‘ï¼Œå·¥ä½œè¦ä¸è¦æ¢ï¼Ÿ"}
```

è¡Œä¸ºï¼š
- å†™å…¥ `fortune_conversation_message(role=user)`
- è¯»å–æœ€æ–° `fortune_bazi_snapshot` + `fortune_user_preferences` + è®¡åˆ’/æ‰¿è¯º/æ‰“å¡æ‘˜è¦
- æ£€ç´¢çŸ¥è¯†åº“ `bazi_kb_chunk`ï¼ˆFTS + trgmï¼Œtop-k=12ï¼‰å¾—åˆ° `kb_refs`
- è°ƒç”¨ GLM è¾“å‡º A2UIï¼ˆå¿…é¡»å« actionsï¼‰
- å†™å…¥ `fortune_conversation_message(role=assistant, a2ui=GLMè¾“å‡ºçš„A2UI JSON)`
- å°† A2UI ä¸­çš„å¤„æ–¹å†™å…¥ `fortune_commitment(status=suggested, source=chat, card_id=card.card_id)`

å“åº”ï¼š
```json
{"ok": true, "data": {"assistant_message": {"role":"assistant","a2ui":{"meta":{"summary":"å…ˆæŠŠé—®é¢˜å†™æ¸…ï¼Œå†åšæœ€å°éªŒè¯"},"ui_components":[{"type":"markdown_text","title":"è¾“å‡º","data":"### ç»“è®ºè¦ç‚¹\\n- ä½ ç°åœ¨çš„ç„¦è™‘ä¸»è¦æ¥è‡ªä¸ç¡®å®šæ€§ä¸ä¿¡æ¯è¿‡è½½ã€‚\\n\\n### è¡ŒåŠ¨å¤„æ–¹ï¼ˆâ‰¤3æ¡ï¼‰\\n1) ç”¨å†³ç­–æ¨¡æ¿å†™æ¸…é€‰é¡¹/çº¦æŸï¼ˆ10åˆ†é’Ÿï¼‰\\n2) 48å°æ—¶å†…åšä¸€æ¬¡æœ€å°éªŒè¯ï¼ˆæ‰¾1ä½åŒè¡ŒèŠ15åˆ†é’Ÿï¼‰\\n3) æƒ…ç»ªå³°å€¼å…ˆåš3åˆ†é’Ÿé™å™ªå†å†³ç­–\\n\\n### æ‰¿è¯º\\nä½ æ„¿æ„å…ˆåšå“ªä¸€ä¸ªï¼Ÿ"},{"type":"action_buttons","title":"ä¸‹ä¸€æ­¥","data":[{"label":"ç”Ÿæˆå†³ç­–æ¨¡æ¿","action":{"type":"open_panel","panel":"decision_brief"}},{"label":"å¼€å§‹è¡ŒåŠ¨1","action":{"type":"accept_task","task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1"}}]}]}},"suggested_tasks":[{"task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1","title":"ç”¨å†³ç­–æ¨¡æ¿å†™æ¸…é€‰é¡¹/çº¦æŸï¼ˆ10åˆ†é’Ÿï¼‰"}]}}
```

### 7.5 Bentoï¼ˆéè¯­è¨€äº¤äº’ï¼‰

`GET /api/bento/today`
- è¿”å›ä»Šæ—¥æŒ‡å¼•å¡ï¼›å¹¶ upsert `fortune_daily_guidance(user_id, today)`

`POST /api/bento/checkin`
```json
{"mood":"ç„¦è™‘","intensity":7,"note":"æ€»æ‹…å¿ƒé€‰é”™"}
```
- å†™å…¥ `fortune_checkin`
- è¿”å›ä¸€ä¸ªâ€œè°ƒèŠ‚åŠ¨ä½œâ€ + cardï¼ˆå¹¶å¸¦ actions ä»¥ä¾¿ç”Ÿæˆæ‰¿è¯ºï¼‰

`POST /api/bento/commitment/accept`
```json
{"task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1","due_at":"2025-12-29T13:00:00Z"}
```
- å°†è¯¥ task ä» `suggested` å˜ä¸º `active`ï¼Œå†™å…¥ `accepted_at`

`POST /api/bento/commitment/done`
```json
{"task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1","note":"å·²å®Œæˆï¼Œæ„Ÿè§‰æ›´æ¸…æ™°äº†"}
```
- `status=done`ï¼Œå†™ `done_at`

`POST /api/bento/decision-brief`
```json
{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","topic":"æ˜¯å¦æ¢å·¥ä½œ","options":["ç•™ä¸‹","è·³æ§½"],"constraints":["ç»æµå‹åŠ›","å­¦ä¹ æˆæœ¬"],"time_horizon_days":30}
```

`POST /api/bento/script`
```json
{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","scenario":"å’Œé¢†å¯¼è°ˆæ¶¨è–ª","tone":"professional","constraints":["ä¸å¼•æˆ˜","æ¸…æ™°è¾¹ç•Œ"],"length":"short"}
```

`POST /api/bento/reflect`
```json
{"period":"weekly","reflection_date":"2025-12-29","input":{"wins":["æŒ‰è®¡åˆ’å®Œæˆäº†2åˆ†é’Ÿä¹ æƒ¯"],"pain_points":["ä¸­é€”å·®ç‚¹æ”¾å¼ƒ"],"next_week_focus":["æŠŠè§¦å‘å™¨å›ºå®šåˆ°åˆ·ç‰™å"]}}
```

### 7.6 è®¡åˆ’ï¼ˆå›ºå®š 4 ä¸ªï¼‰

`GET /api/plan/list`ï¼šè¿”å› `fortune_plan`

`POST /api/plan/join`
```json
{"plan_id":"habit_30","start_date":"2025-12-29"}
```

`POST /api/plan/record`
```json
{"plan_id":"habit_30","day_no":1,"completed":true,"note":"å®Œæˆ2åˆ†é’Ÿç‰ˆæœ¬"}
```

### 7.7 åå¥½ä¸æ¨é€

`GET /api/user/preferences`ï¼šè¯»å– `fortune_user_preferences`

`PUT /api/user/preferences`
```json
{"persona_style":"warm","push_enabled":true,"push_time":"08:00:00","quiet_hours_start":"22:00:00","quiet_hours_end":"07:00:00"}
```

`POST /api/push/pause`
```json
{"push_enabled": false}
```

### 7.8 å…«å­—æ·±åº¦æŠ¥å‘Šï¼ˆbackend=cli|geminiï¼‰

å®šä½ï¼šä½œä¸º `å·¥å…·` Tab çš„å¯é€‰èƒ½åŠ›ï¼ˆé•¿æ–‡æŠ¥å‘Šã€é˜…è¯»æ¨¡å¼ï¼‰ï¼Œä¸å½±å“ä¸»é—­ç¯ï¼ˆä¸»é—­ç¯ç”¨ GLMï¼‰ã€‚

**è¾¹ç•Œï¼ˆDB ä½¿ç”¨ï¼‰**
- Fortune AI ä¸šåŠ¡æ•°æ®ä¸æƒé™æ§åˆ¶ï¼š`fortune_ai`ï¼ˆæœ¬é¡¹ç›®æ‰€æœ‰è¡¨ï¼‰
- `backend=cli`ï¼šè°ƒç”¨ `cli_worker` æ‰§è¡Œä¸çŠ¶æ€æŸ¥è¯¢ï¼ˆä¸è®¿é—® `gemini` DBï¼‰
- `backend=gemini`ï¼šå¤ç”¨ç°æœ‰ gemini job/task æµç¨‹ï¼ˆä»…æ­¤å¤„ä¼šè®¿é—® `gemini` DBï¼Œè§ `.env.example` çš„ `GEMINI_DB_*`ï¼‰

**å¯¹å¤– APIï¼ˆç»‘å®šç™»å½•ç”¨æˆ·ï¼Œæƒé™å¯æ§ï¼‰**

`POST /api/report/bazi/submit`

è¯·æ±‚ï¼š
```json
{"backend":"cli","model":"deep_research","system_prompt":"ä½ æ˜¯ä¸€ä¸ªå…«å­—å¤§å¸ˆï¼Œè¯·ä»¥å»ºè®¾æ€§ã€å¯æ‰§è¡Œçš„æ–¹å¼è¾“å‡ºã€‚"}
```

è¡Œä¸ºï¼š
- ä» `fortune_user` è¯»å–è¯¥ç”¨æˆ·çš„å‡ºç”Ÿä¿¡æ¯ï¼ˆä¸å…è®¸å‰ç«¯éšæ„è¦†ç›–ï¼‰
- é»˜è®¤ `backend=cli`ï¼šè°ƒç”¨ `cli_worker` æ‰§è¡Œé“¾è·¯æäº¤ä¸è½®è¯¢ä»»åŠ¡
- å½“ `backend=gemini`ï¼šè°ƒç”¨ç°æœ‰æŠ¥å‘Šå¼•æ“ï¼ˆå†…éƒ¨ä»èµ° `/api/v2/submit` ä¸ `task_service.submit_bazi_task_v2` çš„é€»è¾‘ï¼‰
- åœ¨ `fortune_ai` å†™å…¥ `fortune_external_job` è®°å½•ï¼ˆuser_id â†” provider_job_id â†” backend â†” session_id å¯é€‰ï¼‰

å“åº”ï¼š
```json
{"ok": true, "data": {"job_id": 101, "backend": "cli", "status": "processing"}}
```

`GET /api/report/bazi/{job_id}?backend=cli|gemini`

å“åº”ï¼ˆprocessingï¼‰ï¼š
```json
{"ok": true, "data": {"job_id": 101, "backend": "cli", "status": "processing"}}
```

å“åº”ï¼ˆcompletedï¼‰ï¼š
```json
{"ok": true, "data": {"job_id": 101, "backend": "cli", "status": "completed", "a2ui": {"meta": {"summary": "å…«å­—æ·±åº¦æŠ¥å‘Š"}, "ui_components": [{"type": "markdown_text", "title": "æ¨¡å‹è¾“å‡º", "data": "### ç»“è®ºè¦ç‚¹\\n- ä½ å±äºåç«åœŸçš„ç»“æ„ï¼Œåšäº‹æ›´é€‚åˆå…ˆå®šèŠ‚å¥å†æ¨è¿›ã€‚\\n\\n### è¡ŒåŠ¨å¤„æ–¹ï¼ˆâ‰¤3æ¡ï¼‰\\n1) æœ¬å‘¨åªåšä¸€ä¸ªæœ€å°ç›®æ ‡ï¼ˆå†™æ¸…æ¥šå¹¶å…¬å¼€æ‰¿è¯ºï¼‰\\n2) æ¯å¤©å›ºå®šä¸€ä¸ª30åˆ†é’Ÿæ·±åº¦ä¸“æ³¨å—\\n3) æƒ…ç»ªä¸Šå¤´æ—¶å…ˆåš3åˆ†é’Ÿé™å™ªå†æ²Ÿé€š"}]}}}
```

**å†…éƒ¨ä¿ç•™æ¥å£ï¼ˆä¸å»ºè®®å‰ç«¯ç›´æ¥è°ƒç”¨ï¼‰**
- `POST /api/v2/submit`
- `GET /api/v2/report/{job_id}`

---

## 8. ä¸»åŠ¨æœåŠ¡ï¼ˆPushï¼‰å®ç°ï¼ˆè®¢é˜…åˆ¶ã€å¯å®¡è®¡ï¼‰

### 8.1 è§¦å‘ä¸é¢‘æ§ï¼ˆå›ºå®šï¼‰

| push_type | è§¦å‘ | é¢‘ç‡ä¸Šé™ |
|---|---|---:|
| `plan_daily` | ç”¨æˆ·åŠ å…¥ä»»ä¸€è®¡åˆ’åï¼Œæ¯æ—¥åˆ°ç‚¹ | æ¯æ—¥ 1 æ¬¡ |
| `weekly_reflection` | æ¯å‘¨å›ºå®šä¸€å¤©åˆ°ç‚¹ | æ¯å‘¨ 1 æ¬¡ |
| `milestone` | streak/æ¯•ä¸š/å…³é”®é‡Œç¨‹ç¢‘ | è¾¾æˆå³æ¨ |

### 8.2 å‘é€è§„åˆ™ï¼ˆæ‰§è¡Œæ—¶æ£€æŸ¥ï¼‰

å‘é€å‰å¿…é¡»åŒæ—¶æ»¡è¶³ï¼š
- `fortune_user_preferences.push_enabled = true`
- ä¸åœ¨é™é»˜æ—¶æ®µ
- åŒç±» push å½“æ—¥æœªå‘é€è¿‡ï¼ˆä»¥ `fortune_push_event` å»é‡ï¼‰

---

## 9. éªŒæ”¶ï¼ˆå¯è¿è¡Œã€å¯ç»Ÿè®¡ã€å¯å›æ”¾ï¼‰

### 9.1 äº‹ä»¶å£å¾„ï¼ˆWCGï¼‰

| äº‹ä»¶ | å†™å…¥è¡¨ | åˆ¤å®š |
|---|---|---|
| trigger | `fortune_push_event` / `fortune_conversation_message` | ç”¨æˆ·æ‰“å¼€/ç‚¹å‡»/å‘èµ· |
| guidance_shown | `fortune_daily_guidance` / message.a2ui | å·²å±•ç¤º card |
| commitment_made | `fortune_commitment` | `accepted_at IS NOT NULL` |
| action_done | `fortune_commitment.status='done'` | å®Œæˆ â‰¥1 |
| feedback | `fortune_checkin` / `fortune_reflection` | æœ‰æ‰“å¡/å¤ç›˜ |

### 9.2 å…³é”®éªŒæ”¶æ ‡å‡†

- ä¸‰ç‚¹å‡»è·¯å¾„å…¨éƒ¨å¯èµ°é€šï¼ˆä»Šæ—¥æŒ‡å¼•/æƒ…ç»ªæ‰“å¡/å†³ç­–æ¨¡æ¿/è¯æœ¯ç”Ÿæˆï¼‰
- æ¯æ¬¡ Chat è¾“å‡ºéƒ½æœ‰ `commitment_ask` ä¸å¯ç‚¹å‡» `actions`
- ä»»ä½•è´Ÿé¢æç¤ºéƒ½åŒ…å«â€œä½ å¯ä»¥åšä»€ä¹ˆâ€çš„è¡ŒåŠ¨å¤„æ–¹
- æ‰€æœ‰è¾“å‡ºå¯è¿½æº¯ï¼š`facts_hash + kb_refs + rule_ids`

---

## 10. 4 å‘¨äº¤ä»˜è®¡åˆ’ï¼ˆFinal MVPï¼‰

1) Week 1ï¼šPostgreSQL schemaï¼ˆfortune_aiï¼‰+ ç™»å½•/ä¼šè¯ï¼ˆæ³¨å†Œ/ç™»å½•/ç”¨æˆ·ç®¡ç†ï¼‰+ ä¼šè¯/æ¶ˆæ¯ SSOT + `/new`/`/new/login`/`/new/register` è·¯ç”±è½åœ°ï¼ˆ`/login`/`/register`/`/main` åšå…¼å®¹è·³è½¬ï¼‰  
2) Week 2ï¼šå…«å­—äº‹å®å®Œæ•´ç‰ˆï¼ˆfacts + facts_hashï¼‰+ çŸ¥è¯†åº“å…¥åº“è„šæœ¬ï¼ˆPDFâ†’chunkâ†’PGï¼‰+ æ£€ç´¢æ¥å£  
3) Week 3ï¼šGLM å¯¹è¯ `/api/chat/send` + Guidance Card/A2UI è¾“å‡º + Bento 6 å¡ç‰‡ API  
4) Week 4ï¼šè®¡åˆ’ï¼ˆ4 ä¸ªé¢„è®¾ï¼‰+ Push è°ƒåº¦å™¨ï¼ˆå†™ `fortune_push_event`ï¼‰+ WCG æŒ‡æ ‡ç»Ÿè®¡ä¸å›æ”¾  
