# Fortune AI æ ¸å¿ƒåŠŸèƒ½æ¨¡å—è®¾è®¡

**ç‰ˆæœ¬**ï¼šv3.1ï¼ˆ2026-01-01ï¼ŒContext Driven + Pluggable Modulesï¼‰

> **å®šä½**: åŸºäº Context Driven / Pluggable Modules æ¶æ„çš„å¯æ‰§è¡ŒåŠŸèƒ½æ¨¡å—
>
> **æ ¸å¿ƒæ¶æ„**: å‚è§ [os_design_v3.md Â§1.4](./os_design_v3.md#14-context-é©±åŠ¨æ¶æ„-å¯æ’æ‹”æ¨¡å—è§†å›¾)
>
> **å…¥å£**: http://106.37.170.238:8231/new
>
> **æœ¬ç‰ˆæ›´æ–°**: å¯¹é½ Context Driven æ¶æ„ + å¯æ’æ‹”æ¨¡å—è®¾è®¡

---

## 0. ä¿®è®¢æ€»è§ˆ

### 0.0 æ¶æ„å±‚æ¬¡æ˜ å°„

æœ¬æ–‡æ¡£ä¸­çš„åŠŸèƒ½æ¨¡å—å¯¹åº” Soul OS æ¶æ„å±‚æ¬¡ï¼š

| æ¶æ„å±‚ | æ¨¡å—ç¤ºä¾‹ | å¯æ’æ‹”æ€§ |
|--------|----------|----------|
| Interaction Layer | æ¨¡å‹é€‰æ‹© (GLM/Gemini/Claude) | âœ… å¯åˆ‡æ¢ |
| Context Management | å¯¹è¯ç³»ç»Ÿä¸Šä¸‹æ–‡ç»„è£… | - |
| L2 Expert Agents | å…«å­—è§£è¯»ã€ç´«å¾®åˆ†æã€CBTæ•™ç»ƒ | âœ… å¯æ’æ‹” |
| L2 Style Agents | standard/warm/roast é£æ ¼ | âœ… å¯åˆ‡æ¢ |
| L1 Module Data | å…«å­—æ’ç›˜ã€PERMAé‡è¡¨ã€Kçº¿æ•°æ® | âœ… å¯æ’æ‹” |
| L0 Base Data | ç”¨æˆ·æ¡£æ¡ˆã€å‡ºç”Ÿä¿¡æ¯ã€å†å²å¯¹è¯ | - |

### 0.1 æ¨¡å—å®ç°çŠ¶æ€çŸ©é˜µ

| æ¨¡å— | è®¾è®¡ | åç«¯ | å‰ç«¯ | é˜»å¡é¡¹ | æ¶æ„å±‚ |
|------|------|------|------|--------|--------|
| Login é¡µé¢ | âœ… Tab + éªŒè¯ç‚¹ | âœ… å·²å®ç° | âœ… å·²å®ç° | - | L0 |
| æ·±åº¦æŠ¥å‘Š | âœ… 6ç« ç»“æ„ | âœ… å·²å®ç° | âœ… å·²å®ç° | - | L2 Expert |
| å¯¹è¯ç³»ç»Ÿ | âœ… A2UI + If-Then | âœ… å·²å®ç° | âš ï¸ éƒ¨åˆ† | action_buttons | Context Mgmt |
| æµ·æŠ¥ç”Ÿæˆ | âœ… Gemini å›¾ç‰‡ | âœ… å·²å®ç° | âš ï¸ å¾…å®Œå–„ | å‰ç«¯è°ƒç”¨ | Interaction |
| Kçº¿ç³»ç»Ÿ | âœ… OHLC èœ¡çƒ›å›¾ | âš ï¸ éƒ¨åˆ† | âš ï¸ å¾…å®ç° | API + ç»„ä»¶ | L1 Module |
| Settings | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | âš ï¸ å¾…å®Œå–„ | é¡µé¢UI | L0 |
| ä»»åŠ¡ç³»ç»Ÿ | âœ… æ‰¿è¯ºé—­ç¯ | âœ… å·²å®ç° | âš ï¸ CSRF | å‰ç«¯ä¿®å¤ | L1 Module |

### 0.2 å®æ–½ä¼˜å…ˆçº§ç¡®è®¤

> **å‘½åè§„èŒƒ**: å‚è§ [GLOSSARY.md](../GLOSSARY.md)

```mermaid
graph TB
    subgraph P0_Done["P0 å·²å®Œæˆ âœ…"]
        direction LR
        L[1. Loginé¡µé¢é‡æ„]
        R[2. æ·±åº¦å…«å­—æŠ¥å‘Š]
    end

    subgraph P0_Fix["P0 å¿…é¡»ä¿®å¤ âš ï¸"]
        C[3. å‰ç«¯ CSRF é—®é¢˜<br/>é˜»å¡æ‰€æœ‰ POST]
    end

    subgraph P1["P1 é«˜ä¼˜å…ˆçº§"]
        direction LR
        A[4. action_buttons]
        P[5. æµ·æŠ¥å‰ç«¯]
        S[6. Settings UI]
    end

    subgraph P2["P2 ä¸­ä¼˜å…ˆçº§"]
        direction LR
        K[7. Kçº¿ API+ç»„ä»¶]
        M[8. åˆå¹¶ Tab]
    end

    P0_Done --> P0_Fix
    P0_Fix --> P1
    P1 --> P2

    style P0_Done fill:#d4edda,stroke:#28a745
    style P0_Fix fill:#f8d7da,stroke:#dc3545
    style P1 fill:#fff3cd,stroke:#ffc107
    style P2 fill:#cce5ff,stroke:#007bff
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®æ–½ä¼˜å…ˆçº§çŸ©é˜µ                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  P0 å·²å®Œæˆ âœ…                                         â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ 1. Loginé¡µé¢é‡æ„   â”‚  â”‚ 2. æ·±åº¦å…«å­—æŠ¥å‘Š         â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  P0 å¿…é¡»ä¿®å¤ âš ï¸                                       â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚  â”‚ 3. å‰ç«¯ CSRF é—®é¢˜ (é˜»å¡æ‰€æœ‰ POST è¯·æ±‚)        â”‚   â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  P1 é«˜ä¼˜å…ˆçº§                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚ 4. action_   â”‚  â”‚ 5. æµ·æŠ¥å‰ç«¯    â”‚  â”‚ 6. Settingsâ”‚  â”‚
    â”‚  â”‚    buttons   â”‚  â”‚    é›†æˆ       â”‚  â”‚    UI     â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  P2 ä¸­ä¼˜å…ˆçº§                                          â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
    â”‚  â”‚ 7. Kçº¿ API + ç»„ä»¶    â”‚  â”‚ 8. åˆå¹¶çŠ¶æ€/è¶‹åŠ¿ Tab   â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

---

## 1. Login é¡µé¢æµç¨‹å›¾å¯¹æ¯”

### 1.1 è®¾è®¡ç™»å½•æµç¨‹ (Mermaid æ—¶åºå›¾)

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯<br/>/new/register
    participant API as FastAPI
    participant L0 as L0 å…«å­—è„‘
    participant DB as PostgreSQL

    U->>FE: è®¿é—®æ³¨å†Œé¡µ
    FE->>FE: æ˜¾ç¤º Tab [å…«å­—|ç´«å¾®|æ˜Ÿåº§]

    U->>FE: é€‰æ‹©å…«å­— + è¾“å…¥å‡ºç”Ÿä¿¡æ¯
    U->>FE: ç‚¹å‡» [ç”Ÿæˆé¢„è§ˆ]
    FE->>API: POST /api/auth/preview
    API->>L0: è®¡ç®—å…«å­— facts
    L0-->>API: {å››æŸ±, äº”è¡Œ, æ—¥ä¸», èº«å¼º/å¼±}
    API-->>FE: é¢„è§ˆæ•°æ®

    FE->>FE: æ˜¾ç¤ºå‘½ç›˜å¯è§†åŒ–
    FE->>API: POST /api/auth/validation-points
    API->>L0: ç”Ÿæˆ 3 ä¸ªéªŒè¯ç‚¹
    L0-->>API: ["ä½ æ˜¯ä¸æ˜¯ç»å¸¸...", ...]
    API-->>FE: éªŒè¯ç‚¹åˆ—è¡¨

    U->>FE: ç¡®è®¤éªŒè¯ç‚¹ "é‚£å°±æ˜¯æˆ‘"
    U->>FE: å¡«å†™é‚®ç®±/å¯†ç  + ç‚¹å‡»æ³¨å†Œ
    FE->>API: POST /api/auth/register
    API->>DB: INSERT fortune_user
    API->>DB: INSERT fortune_bazi_snapshot
    API-->>FE: è®¾ç½® Cookies
    FE->>FE: è·³è½¬ /new
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       è®¾è®¡ç™»å½•æµç¨‹ (å®Œæ•´ç‰ˆ)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·      å‰ç«¯ /new/register      FastAPI         L0 å…«å­—è„‘      PostgreSQL
   â”‚              â”‚                   â”‚                 â”‚              â”‚
   â”‚â”€â”€[1]è®¿é—®â”€â”€â”€â”€â–¶â”‚                   â”‚                 â”‚              â”‚
   â”‚              â”‚â”€â”€æ˜¾ç¤º Tab â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚              â”‚
   â”‚              â”‚  [å…«å­—|ç´«å¾®|æ˜Ÿåº§]  â”‚                 â”‚              â”‚
   â”‚              â”‚                   â”‚                 â”‚              â”‚
   â”‚â”€â”€[2]é€‰æ‹©å…«å­—+â”‚                   â”‚                 â”‚              â”‚
   â”‚  è¾“å…¥å‡ºç”Ÿä¿¡æ¯â”‚                   â”‚                 â”‚              â”‚
   â”‚              â”‚                   â”‚                 â”‚              â”‚
   â”‚â”€â”€[3]ç‚¹å‡»ç”Ÿæˆé¢„è§ˆâ”€â–¶â”‚              â”‚                 â”‚              â”‚
   â”‚              â”‚â”€â”€POST /api/auth/previewâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚              â”‚
   â”‚              â”‚                   â”‚â”€â”€è®¡ç®—å…«å­— factsâ–¶â”‚              â”‚
   â”‚              â”‚                   â”‚â—€â”€{å››æŸ±,äº”è¡Œ,æ—¥ä¸»}â”‚              â”‚
   â”‚              â”‚â—€â”€â”€é¢„è§ˆæ•°æ®â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚              â”‚
   â”‚              â”‚                   â”‚                 â”‚              â”‚
   â”‚              â”‚â”€â”€æ˜¾ç¤ºå‘½ç›˜å¯è§†åŒ–â”€â”€â”€â”‚                 â”‚              â”‚
   â”‚              â”‚â”€â”€POST /api/auth/validation-pointsâ”€â–¶â”‚              â”‚
   â”‚              â”‚                   â”‚â”€â”€ç”Ÿæˆ3ä¸ªéªŒè¯ç‚¹â”€â–¶â”‚              â”‚
   â”‚              â”‚â—€â”€â”€["ä½ æ˜¯ä¸æ˜¯ç»å¸¸..."]              â”‚              â”‚
   â”‚              â”‚                   â”‚                 â”‚              â”‚
   â”‚â”€â”€[4]ç¡®è®¤éªŒè¯ç‚¹"é‚£å°±æ˜¯æˆ‘"         â”‚                 â”‚              â”‚
   â”‚              â”‚                   â”‚                 â”‚              â”‚
   â”‚â”€â”€[5]å¡«å†™é‚®ç®±/å¯†ç  + æ³¨å†Œâ”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚              â”‚
   â”‚              â”‚â”€â”€POST /api/auth/registerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚              â”‚                   â”‚â”€â”€INSERT fortune_userâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚              â”‚                   â”‚â”€â”€INSERT bazi_snapshotâ”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚              â”‚â—€â”€â”€è®¾ç½® Cookiesâ”€â”€â”€â”€â”‚                 â”‚              â”‚
   â”‚              â”‚â”€â”€è·³è½¬ /newâ”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚              â”‚
   â”‚              â”‚                   â”‚                 â”‚              â”‚
```
</details>

**è®¾è®¡é¡µé¢å¸ƒå±€**:

| åŒºåŸŸ | å†…å®¹ |
|------|------|
| é¡¶éƒ¨ | Tab [å…«å­—] [ç´«å¾®] [æ˜Ÿåº§] |
| å·¦æ  | å‡ºç”Ÿä¿¡æ¯è¡¨å• + éªŒè¯ç‚¹å¡ç‰‡ + æ³¨å†Œè¡¨å• |
| å³æ  | å‘½ç›˜å¯è§†åŒ– + é¢„è§ˆæ•°æ® |

### 1.2 å½“å‰å®ç°ç™»å½•æµç¨‹

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯<br/>/new/register
    participant API as FastAPI
    participant DB as PostgreSQL

    U->>FE: è®¿é—®æ³¨å†Œé¡µ
    FE->>FE: æ˜¾ç¤ºç®€åŒ–è¡¨å•<br/>(æ—  Tab)

    U->>FE: å¡«å†™å…¨éƒ¨ä¿¡æ¯<br/>(é‚®ç®±+å¯†ç +å‡ºç”Ÿ)
    U->>FE: ç‚¹å‡» [æ³¨å†Œ]
    FE->>API: POST /api/auth/register
    API->>DB: INSERT fortune_user
    API-->>FE: è®¾ç½® Cookies
    FE->>FE: è·³è½¬ /new

    Note right of FE: âš ï¸ ç¼ºå°‘é¢„è§ˆ/éªŒè¯ç‚¹
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å½“å‰å®ç°ç™»å½•æµç¨‹ (ç®€åŒ–ç‰ˆ)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·      å‰ç«¯ /new/register      FastAPI         PostgreSQL
   â”‚              â”‚                   â”‚                 â”‚
   â”‚â”€â”€[1]è®¿é—®â”€â”€â”€â”€â–¶â”‚                   â”‚                 â”‚
   â”‚              â”‚â”€â”€æ˜¾ç¤ºç®€åŒ–è¡¨å•â”€â”€â”€â”€â”€â”€â”‚                 â”‚
   â”‚              â”‚  (æ—  Tab åˆ‡æ¢)     â”‚                 â”‚
   â”‚              â”‚                   â”‚                 â”‚
   â”‚â”€â”€[2]å¡«å†™å…¨éƒ¨ä¿¡æ¯â”€â–¶â”‚              â”‚                 â”‚
   â”‚  (é‚®ç®±+å¯†ç +å‡ºç”Ÿ)â”‚               â”‚                 â”‚
   â”‚              â”‚                   â”‚                 â”‚
   â”‚â”€â”€[3]ç‚¹å‡»æ³¨å†Œâ”€â”€â–¶â”‚                 â”‚                 â”‚
   â”‚              â”‚â”€â”€POST /api/auth/registerâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚              â”‚                   â”‚â”€â”€INSERT userâ”€â”€â–¶â”‚
   â”‚              â”‚â—€â”€â”€è®¾ç½® Cookiesâ”€â”€â”€â”€â”‚                 â”‚
   â”‚              â”‚â”€â”€è·³è½¬ /newâ”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
   â”‚              â”‚                   â”‚                 â”‚
   â”‚              â”‚  âš ï¸ ç¼ºå°‘é¢„è§ˆ      â”‚                 â”‚
   â”‚              â”‚  âš ï¸ ç¼ºå°‘éªŒè¯ç‚¹    â”‚                 â”‚
   â”‚              â”‚                   â”‚                 â”‚
```
</details>

**å®ç°çŠ¶æ€**:

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|:----:|------|
| åŸºç¡€æ³¨å†Œè¡¨å• | âœ… | é‚®ç®±/å¯†ç /æ˜µç§°/æ€§åˆ« |
| å‡ºç”Ÿä¿¡æ¯è¾“å…¥ | âœ… | æ—¥æœŸ/æ—¶é—´/æ—¶åŒº/åœ°ç‚¹ |
| Tab åˆ‡æ¢ | âš ï¸ | å…«å­—/ç´«å¾®/æ˜Ÿåº§ æœªå®ç° |
| éªŒè¯ç‚¹ç”Ÿæˆ | âš ï¸ | `/api/auth/validation-points` å¾…å®ç° |
| å‘½ç›˜é¢„è§ˆ | âš ï¸ | å¯è§†åŒ–ç»„ä»¶æœªå®ç° |

### 1.3 æœ€ä¼˜ç™»å½•æµç¨‹ (æ¸è¿›å¼æ³¨å†Œ)

```mermaid
stateDiagram-v2
    [*] --> Step1_Birth: è®¿é—® /new/register

    state Step1_Birth {
        direction LR
        SelectTab: é€‰æ‹© [å…«å­—|ç´«å¾®|æ˜Ÿåº§]
        InputBirth: è¾“å…¥å‡ºç”Ÿä¿¡æ¯
        Preview: ç‚¹å‡» [ç”Ÿæˆé¢„è§ˆ]
        SelectTab --> InputBirth
        InputBirth --> Preview
    }

    Step1_Birth --> Step2_Validate: é¢„è§ˆæˆåŠŸ

    state Step2_Validate {
        direction LR
        ShowChart: æ˜¾ç¤ºå‘½ç›˜å¯è§†åŒ–
        ShowPoints: æ˜¾ç¤º 3 ä¸ªéªŒè¯ç‚¹
        Confirm: ç”¨æˆ·ç¡®è®¤ "é‚£å°±æ˜¯æˆ‘"
        ShowChart --> ShowPoints
        ShowPoints --> Confirm
    }

    Step2_Validate --> Step3_Account: éªŒè¯ç‚¹ç¡®è®¤

    state Step3_Account {
        direction LR
        ShowSuccess: "å…«å­—ç‰¹å¾å·²è¯†åˆ«"
        InputAccount: å¡«å†™é‚®ç®±/å¯†ç 
        Register: [åˆ›å»ºè´¦å·å¹¶ä¿å­˜]
        ShowSuccess --> InputAccount
        InputAccount --> Register
    }

    Step3_Account --> [*]: æ³¨å†ŒæˆåŠŸ â†’ /new
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æœ€ä¼˜ç™»å½•æµç¨‹ (æ¸è¿›å¼æ³¨å†Œ)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  å¼€å§‹    â”‚
                              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                   â”‚ è®¿é—® /new/register
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: å‡ºç”Ÿä¿¡æ¯                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ é€‰æ‹© Tab        â”‚â”€â”€â”€â–¶â”‚ è¾“å…¥å‡ºç”Ÿä¿¡æ¯    â”‚â”€â”€â”€â–¶â”‚ ç‚¹å‡» [ç”Ÿæˆé¢„è§ˆ] â”‚           â”‚
â”‚ â”‚ [å…«å­—|ç´«å¾®|æ˜Ÿåº§]â”‚    â”‚ æ—¥æœŸ/æ—¶é—´/åœ°ç‚¹  â”‚    â”‚                 â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ é¢„è§ˆæˆåŠŸ
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: éªŒè¯ç‚¹ç¡®è®¤                                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ æ˜¾ç¤ºå‘½ç›˜å¯è§†åŒ–  â”‚â”€â”€â”€â–¶â”‚ æ˜¾ç¤º 3 ä¸ªéªŒè¯ç‚¹ â”‚â”€â”€â”€â–¶â”‚ ç¡®è®¤"é‚£å°±æ˜¯æˆ‘"  â”‚           â”‚
â”‚ â”‚ å››æŸ±+äº”è¡Œé›·è¾¾   â”‚    â”‚ "ä½ æ˜¯ä¸æ˜¯..."   â”‚    â”‚                 â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ éªŒè¯ç‚¹ç¡®è®¤
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: åˆ›å»ºè´¦å·                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ â”‚ "å…«å­—ç‰¹å¾å·²è¯†åˆ«"â”‚â”€â”€â”€â–¶â”‚ å¡«å†™é‚®ç®±/å¯†ç    â”‚â”€â”€â”€â–¶â”‚ [åˆ›å»ºè´¦å·å¹¶ä¿å­˜]â”‚           â”‚
â”‚ â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚           â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ æ³¨å†ŒæˆåŠŸ
                                  â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ è·³è½¬ /newâ”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

**ä¼˜åŒ–è¦ç‚¹**:

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | è¯´æ˜ |
|:------:|--------|------|
| P1 | `/api/auth/validation-points` | åŸºäº L0 facts ç”Ÿæˆ 3 ä¸ªéªŒè¯é—®é¢˜ |
| P1 | å‘½ç›˜é¢„è§ˆç»„ä»¶ | å››æŸ± + äº”è¡Œé›·è¾¾å›¾ |
| P2 | Tab åˆ‡æ¢ | å…«å­—/ç´«å¾®/æ˜Ÿåº§ æ¨¡å¼é€‰æ‹© |
| P2 | æ¸è¿›å¼è¡¨å• | åˆ† 3 æ­¥æ”¶é›†ä¿¡æ¯ï¼Œé™ä½æµå¤± |

---

## 2. å¯¹è¯ç³»ç»Ÿæµç¨‹å›¾å¯¹æ¯”

> **A2UI ç±»å‹å®šä¹‰**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§4
> **æ¶æ„å±‚æ¬¡**: Context Management + L2 Expert/Style Agents + Interaction Layer

### 2.1 è®¾è®¡å¯¹è¯æµç¨‹ (Context Driven æ¶æ„)

å¯¹è¯ç³»ç»ŸåŸºäº Context Driven æ¶æ„è¿ä½œï¼š

```
ç”¨æˆ·è¾“å…¥ â†’ Context Management ç»„è£…ä¸Šä¸‹æ–‡
                â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
         â†“             â†“
   L2 Expert      L2 Style
   (å…«å­—/CBT)     (warm/roast)
         â†“             â†“
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â†“
         Interaction Layer (GLM/Gemini)
                â†“
         A2UI JSON è¾“å‡º
```

### 2.2 å››å±‚æ¶æ„æ—¶åºå›¾

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as Zone A
    participant API as FastAPI
    participant L0 as L0 æ•°å­¦è„‘
    participant L1 as L1 å¿ƒç†è„‘
    participant L2 as L2 çŸ¥è¯†è„‘
    participant L3 as L3 è¯­è¨€è„‘
    participant DB as PostgreSQL

    U->>FE: è¾“å…¥æ¶ˆæ¯
    FE->>API: POST /api/chat/send

    rect rgb(240, 248, 255)
        Note over API,L2: Context æ„å»º
        API->>L0: è·å–å…«å­— facts
        L0-->>API: {æ—¥ä¸», äº”è¡Œ, å½“å‰è¿åŠ¿}
        API->>L1: è·å– PERMA + æ´»è·ƒç›®æ ‡
        L1-->>API: {state_score, active_goals}
        API->>L2: RAG çŸ¥è¯†æ£€ç´¢
        L2-->>API: {kb_refs, rule_ids}
    end

    rect rgb(255, 248, 240)
        Note over API,L3: GLM ç”Ÿæˆ
        API->>L3: prompt + context
        L3-->>API: A2UI JSON
    end

    API->>DB: INSERT conversation_message
    API-->>FE: A2UI å“åº”

    FE->>FE: æ¸²æŸ“ markdown_text
    FE->>FE: æ¸²æŸ“ If-Then å¤„æ–¹
    FE->>FE: æ¸²æŸ“ action_buttons
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å¯¹è¯ç³»ç»Ÿå››å±‚æ¶æ„æµç¨‹                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·    Zone A     FastAPI      L0æ•°å­¦è„‘    L1å¿ƒç†è„‘    L2çŸ¥è¯†è„‘   L3è¯­è¨€è„‘    DB
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚â”€â”€è¾“å…¥â”€â–¶â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚â”€â”€POST â”€â”€â”€â–¶â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚ chat/send â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚  Context æ„å»º (L0-L2)  â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€è·å–factsâ”€â–¶â”‚          â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚â—€â”€{æ—¥ä¸»,äº”è¡Œ}â”‚          â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€è·å–PERMAâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚          â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚â—€â”€{state_score,goals}â”€â”€â”€â”‚          â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€RAGæ£€ç´¢â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚â—€â”€{kb_refs,rule_ids}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚  GLM ç”Ÿæˆ (L3)         â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€prompt + contextâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚        â”‚
   â”‚        â”‚           â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€A2UI JSON â”€â”€â”€â”€â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€INSERT conversation_messageâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚â—€â”€A2UIå“åº”â”€â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚â”€â”€æ¸²æŸ“ markdown_text    â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚â”€â”€æ¸²æŸ“ If-Then å¤„æ–¹     â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚â”€â”€æ¸²æŸ“ action_buttons   â”‚           â”‚           â”‚          â”‚        â”‚
   â”‚        â”‚           â”‚            â”‚           â”‚           â”‚          â”‚        â”‚
```
</details>

**A2UI è¾“å‡ºç»“æ„**:

```json
{
  "blocks": [
    {"type": "markdown_text", "data": "### åˆ†æç»“æœ\nä½ çš„æ—¥ä¸»æ˜¯ç”²æœ¨..."},
    {"type": "markdown_text", "data": "### è¡ŒåŠ¨å¤„æ–¹\n**å¦‚æœ**ä½ æ„Ÿåˆ°å†³ç­–ç„¦è™‘...\n**é‚£ä¹ˆ**..."},
    {"type": "action_buttons", "data": [
      {"label": "ç°åœ¨å¼€å§‹", "action": {"type": "start_task", "task_id": "xxx"}},
      {"label": "åŠ å…¥è®¡åˆ’", "action": {"type": "schedule_task", "task_id": "xxx"}},
      {"label": "æš‚ä¸æ‰§è¡Œ", "action": {"type": "opt_out"}}
    ]}
  ]
}
```

### 2.2 å½“å‰å®ç° (é—®é¢˜åˆ†æ)

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as Zone A
    participant API as FastAPI

    U->>FE: ç‚¹å‡» action_button
    FE->>API: POST /api/dashboard/task/accept

    Note right of FE: âš ï¸ ç¼ºå°‘ X-CSRF-Token
    API-->>FE: 403 csrf_invalid

    Note right of FE: âš ï¸ æ— é”™è¯¯ toast
    Note right of FE: âš ï¸ Zone B ä¸åˆ·æ–°
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å½“å‰å®ç°é—®é¢˜ (action_button)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·           Zone A           FastAPI
   â”‚               â”‚                 â”‚
   â”‚â”€â”€ç‚¹å‡»â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                 â”‚
   â”‚  action_buttonâ”‚                 â”‚
   â”‚               â”‚                 â”‚
   â”‚               â”‚â”€â”€POST /api/dashboard/task/accept
   â”‚               â”‚                 â”‚
   â”‚               â”‚  âš ï¸ ç¼ºå°‘ X-CSRF-Token
   â”‚               â”‚                 â”‚
   â”‚               â”‚â—€â”€â”€403 csrf_invalid
   â”‚               â”‚                 â”‚
   â”‚               â”‚  âš ï¸ æ— é”™è¯¯ toastâ”‚
   â”‚               â”‚  âš ï¸ Zone B ä¸åˆ·æ–°
   â”‚               â”‚                 â”‚
```
</details>

**é—®é¢˜æ¸…å•**:

| é—®é¢˜ | ä½ç½® | å½±å“ | æ ¹å›  |
|------|------|------|------|
| CSRF æœªä¼ é€’ | `lib/api.ts` | POST å¤±è´¥ | æœªè¯»å– `fortune_csrf` cookie |
| æ— é”™è¯¯åé¦ˆ | `blocks/index.tsx` | ç”¨æˆ·å›°æƒ‘ | æ—  try-catch + toast |
| Zone B ä¸åˆ·æ–° | å…¨å±€ | éœ€æ‰‹åŠ¨åˆ·æ–° | æ—  store é€šçŸ¥æœºåˆ¶ |

### 2.3 æœ€ä¼˜æ–¹æ¡ˆ (action å¤„ç†æ—¶åº)

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant Btn as ActionButton
    participant Client as api-client.ts
    participant API as FastAPI
    participant Store as Zustand
    participant ZoneB as Zone B
    participant Toast as Toast

    U->>Btn: ç‚¹å‡» "ç°åœ¨å¼€å§‹"
    Btn->>Btn: setLoading(true)
    Btn->>Client: handleAction({type: 'start_task'})
    Client->>Client: getCSRFToken()
    Client->>API: POST /api/dashboard/task/accept<br/>+ X-CSRF-Token

    alt æˆåŠŸ
        API-->>Client: {ok: true}
        Client->>Store: invalidate('tasks')
        Store->>ZoneB: refetch
        Client->>Toast: success("ä»»åŠ¡å·²å¼€å§‹")
    else å¤±è´¥
        API-->>Client: {error}
        Client->>Toast: error("æ“ä½œå¤±è´¥")
    end

    Btn->>Btn: setLoading(false)
```

**å…³é”®ä»£ç ä¿®å¤**:

```typescript
// lib/api-client.ts
export const apiClient = {
  getCSRFToken(): string {
    const match = document.cookie.match(/fortune_csrf=([^;]+)/);
    return match ? match[1] : '';
  },

  async post<T>(url: string, data: unknown): Promise<T> {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': this.getCSRFToken(),  // â† å…³é”®
      },
      credentials: 'include',
      body: JSON.stringify(data),
    });
    if (!res.ok) throw new ApiError(res.status, await res.json());
    return res.json();
  }
};
```

---

## 3. æµ·æŠ¥ç”Ÿæˆæµç¨‹å›¾å¯¹æ¯”

> **å¤–éƒ¨ä»»åŠ¡çŠ¶æ€**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§6

### 3.1 è®¾è®¡æµ·æŠ¥æµç¨‹ (Gemini å›¾ç‰‡æ¨¡å‹)

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯
    participant API as FastAPI
    participant GLM as GLM æ–‡æ¡ˆ
    participant Gemini as Gemini å›¾ç‰‡
    participant DB as PostgreSQL

    U->>FE: è§¦å‘æµ·æŠ¥ç”Ÿæˆ<br/>(æŠ¥å‘Šå®Œæˆ/æ‰“å¡å)
    FE->>API: POST /api/poster/generate<br/>{poster_type, context}

    API->>DB: è¯»å–ç”¨æˆ· Profile
    API->>GLM: ç”Ÿæˆåæ§½æ–‡æ¡ˆ
    GLM-->>API: "æˆ‘å°±æ˜¯é‚£ä¸ªæƒ³å¤ªå¤šçš„ç”²æœ¨..."

    API->>DB: INSERT fortune_poster<br/>(status=processing)
    API->>Gemini: gemini_create_job<br/>(å›¾ç‰‡ç”Ÿæˆ)
    API-->>FE: {poster_id}

    loop è½®è¯¢ (3s é—´éš”)
        FE->>API: GET /api/poster/{id}
        API-->>FE: {status: 'processing'}
    end

    Gemini-->>DB: å®Œæˆ â†’ image_url
    FE->>API: GET /api/poster/{id}
    API-->>FE: {status: 'completed', image_url}
    FE->>FE: æ˜¾ç¤ºæµ·æŠ¥ + åˆ†äº«æŒ‰é’®
```

**æµ·æŠ¥ç±»å‹**:

| type | åœºæ™¯ | æ–‡æ¡ˆé£æ ¼ |
|------|------|----------|
| `personality` | æ·±åº¦æŠ¥å‘Šå | è‡ªå˜²å¼ |
| `mood` | æƒ…ç»ªæ‰“å¡å | å¤¸å¼ å¼ |
| `fortune` | æŸ¥çœ‹è¿åŠ¿æ—¶ | è°ƒä¾ƒå¼ |
| `achievement` | ä»»åŠ¡å®Œæˆå | è‡ªè±ªå¼ |
| `help` | çŠ¶æ€ä½è°·æ—¶ | æ±‚åŠ©å¼ |

### 3.2 å½“å‰å®ç°çŠ¶æ€

| ç»„ä»¶ | åç«¯ | å‰ç«¯ | è¯´æ˜ |
|------|:----:|:----:|------|
| PosterService | âœ… | - | `services/poster_service.py` |
| API ç«¯ç‚¹ | âœ… | - | POST/GET `/api/poster/*` |
| fortune_poster è¡¨ | âœ… | - | `20260101_poster_kline.sql` |
| ç”Ÿæˆå…¥å£ | - | âš ï¸ | å¾…æ·»åŠ è§¦å‘æŒ‰é’® |
| é¢„è§ˆç»„ä»¶ | - | âš ï¸ | å¾…å®ç° |
| è½®è¯¢é€»è¾‘ | - | âš ï¸ | å¾…å®ç° |

### 3.3 å¤–éƒ¨ä»»åŠ¡çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> queued: POST /api/poster/generate

    queued --> processing: Worker é¢†å–
    processing --> completed: å›¾ç‰‡ç”ŸæˆæˆåŠŸ
    processing --> error: ç”Ÿæˆå¤±è´¥

    completed --> [*]: æ˜¾ç¤ºæµ·æŠ¥
    error --> queued: ç”¨æˆ·é‡è¯•
```

---

## 4. Kçº¿ç³»ç»Ÿæµç¨‹å›¾å¯¹æ¯”

> **æ•°æ®è¡¨**: `fortune_kline_daily` å·²åœ¨ `20260101_poster_kline.sql` åˆ›å»º

### 4.1 Kçº¿æ•°æ®æµæ¶æ„

```mermaid
graph TB
    subgraph DataSources["æ•°æ®æº"]
        Checkin["fortune_checkin<br/>(æƒ…ç»ªæ‰“å¡)"]
        Commit["fortune_commitment<br/>(ä»»åŠ¡å®Œæˆ)"]
        Chat["fortune_conversation_message<br/>(å¯¹è¯)"]
    end

    subgraph Calculate["æ¯æ—¥è®¡ç®—"]
        StateScore["State Score è®¡ç®—"]
        OHLC["OHLC æ±‡æ€»"]
    end

    subgraph Storage["å­˜å‚¨"]
        KlineTable["fortune_kline_daily<br/>open/high/low/close<br/>volume/drivers"]
    end

    subgraph Display["å¯è§†åŒ–"]
        KlineChart["Kçº¿èœ¡çƒ›å›¾"]
        Events["äº‹ä»¶æ ‡è®°"]
    end

    Checkin --> StateScore
    Commit --> StateScore
    Chat --> StateScore

    StateScore --> OHLC
    OHLC --> KlineTable
    KlineTable --> KlineChart
    KlineTable --> Events

    style DataSources fill:#e3f2fd
    style Calculate fill:#fff3e0
    style Storage fill:#e8f5e9
    style Display fill:#fce4ec
```

**OHLC å®šä¹‰**:

| å­—æ®µ | å«ä¹‰ | è®¡ç®—è§„åˆ™ |
|------|------|----------|
| `open` | å½“æ—¥å¼€ç›˜ | é¦–æ¬¡ State Score (æ—©é—´) |
| `high` | å½“æ—¥æœ€é«˜ | MAX(å½“æ—¥æ‰€æœ‰ State Score) |
| `low` | å½“æ—¥æœ€ä½ | MIN(å½“æ—¥æ‰€æœ‰ State Score) |
| `close` | å½“æ—¥æ”¶ç›˜ | æœ€å State Score (æ™šé—´) |
| `volume` | æ´»åŠ¨é‡ | å½“æ—¥æ‰“å¡ + ä»»åŠ¡å®Œæˆæ•° |

### 4.2 å½“å‰å®ç°çŠ¶æ€

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|:----:|------|
| fortune_kline_daily è¡¨ | âœ… | `migrations/20260101_poster_kline.sql` |
| GET /api/dashboard/kline | âš ï¸ | å¾…å®ç° |
| GET /api/dashboard/trends | âœ… | è¿”å›çº¿æ€§æ•°æ® |
| trends-tab.tsx | âœ… | çº¿æ€§å›¾è¡¨ |
| Kçº¿èœ¡çƒ›å›¾ç»„ä»¶ | âš ï¸ | å¾…å®ç° |

### 4.3 Kçº¿ API è®¾è®¡

```mermaid
sequenceDiagram
    autonumber
    participant FE as å‰ç«¯
    participant API as FastAPI
    participant DB as PostgreSQL

    FE->>API: GET /api/dashboard/kline<br/>?period=daily&count=30
    API->>DB: SELECT * FROM fortune_kline_daily<br/>WHERE user_id = ? ORDER BY date DESC
    DB-->>API: OHLC æ•°æ®
    API-->>FE: {klines: [{date, open, high, low, close, volume, events}]}

    FE->>FE: æ¸²æŸ“èœ¡çƒ›å›¾<br/>ç»¿æ¶¨/çº¢è·Œ
    FE->>FE: æ˜¾ç¤ºäº‹ä»¶æ ‡è®°
```

**å“åº”ç»“æ„**:

```json
{
  "klines": [
    {
      "date": "2026-01-01",
      "open": 65,
      "high": 78,
      "low": 58,
      "close": 72,
      "volume": 5,
      "change_pct": "+10.8%",
      "events": [
        {"type": "checkin", "label": "æƒ…ç»ªé«˜å³°"},
        {"type": "achievement", "label": "å®Œæˆè®¡åˆ’"}
      ]
    }
  ]
}
```

---

## 5. ä»£ç é—®é¢˜æ¸…å•

### 5.1 P0 é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

| # | é—®é¢˜ | ä½ç½® | å½±å“ | ä¿®å¤æ–¹æ¡ˆ |
|---|------|------|------|----------|
| 1 | CSRF Token æœªä¼ é€’ | `web-app/src/lib/api.ts` | æ‰€æœ‰ POST è¯·æ±‚å¤±è´¥ | ä» cookie è¯»å– fortune_csrf |
| 2 | action_buttons ç‚¹å‡»æ— å“åº” | `web-app/src/components/chat/message-item.tsx` | æ— æ³•æ¥å—ä»»åŠ¡ | å®ç° action handler |

### 5.2 P1 é—®é¢˜ï¼ˆåº”å°½å¿«å¤„ç†ï¼‰

| # | é—®é¢˜ | ä½ç½® | å½±å“ | ä¿®å¤æ–¹æ¡ˆ |
|---|------|------|------|----------|
| 3 | Kçº¿ API æœªå®ç° | `api/dashboard_routes.py` | è¶‹åŠ¿å¯è§†åŒ–ä¸å®Œæ•´ | å®ç° kline ç«¯ç‚¹ |
| 4 | éªŒè¯ç‚¹ API æœªå®Œå–„ | `api/auth_routes.py` | Login ä½“éªŒä¸å®Œæ•´ | åŸºäº L0 ç”ŸæˆéªŒè¯ç‚¹ |
| 5 | æµ·æŠ¥å‰ç«¯æœªæ¥å…¥ | `web-app/` | æµ·æŠ¥åŠŸèƒ½ä¸å¯ç”¨ | æ·»åŠ ç”Ÿæˆå…¥å£ + é¢„è§ˆç»„ä»¶ |
| 6 | å¤ç›˜å…¥å£ä¸æ˜æ˜¾ | `web-app/` | ç”¨æˆ·éš¾ä»¥æ‰¾åˆ° | åœ¨ Dashboard æ·»åŠ å…¥å£ |

### 5.3 P2 é—®é¢˜ï¼ˆåç»­ä¼˜åŒ–ï¼‰

| # | é—®é¢˜ | ä½ç½® | å½±å“ | ä¿®å¤æ–¹æ¡ˆ |
|---|------|------|------|----------|
| 7 | æ— è™šæ‹Ÿæ»šåŠ¨ | `web-app/src/components/chat/message-list.tsx` | é•¿å¯¹è¯æ€§èƒ½å·® | ä½¿ç”¨ @tanstack/react-virtual |
| 8 | anti-dependency æ— è±å… | `services/soul_os.py` | æ–°ç”¨æˆ·è¢«æˆªæ–­ | æ·»åŠ  7 å¤©è±å…é€»è¾‘ |
| 9 | æ— å…¨é“¾è·¯è¿½è¸ª | å…¨å±€ | æ’æŸ¥å›°éš¾ | æ·»åŠ  correlation_id |
| 10 | Settings UI ä¸å®Œæ•´ | `web-app/src/app/settings/` | ç”¨æˆ·æ— æ³•ä¿®æ”¹è®¾ç½® | å®Œå–„é¡µé¢ç»„ä»¶ |

---

## 6. æ€»ç»“

### 6.1 æ¨¡å—å®Œæˆåº¦ (æŒ‰æ¶æ„å±‚)

```
=== Interaction Layer ===
æ¨¡å‹é…ç½®:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%  â† GLM ä¸ºä¸»ï¼ŒGemini/Claude å¤‡é€‰

=== Context Management ===
ä¸Šä¸‹æ–‡ç»„è£…:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%  â† å·¥ä½œæ­£å¸¸

=== L2 Agents ===
Expert Agents:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%  â† ä»…å…«å­— Agentï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç°
Style Agents:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%  â† standard/warm/roast å°±ç»ª

=== L1 Module Data ===
å…«å­—æ•°æ®:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
PERMA é‡è¡¨:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%
Kçº¿æ•°æ®:        â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40%  â† API + ç»„ä»¶å¾…å®ç°

=== L0 Base Data ===
ç”¨æˆ·æ¡£æ¡ˆ:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
ç™»å½•ç³»ç»Ÿ:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%  â† Tab/éªŒè¯ç‚¹å¾…å®ç°

=== å‰ç«¯åŠŸèƒ½ ===
å¯¹è¯ç³»ç»Ÿ:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%  â† action_buttons å¾…ä¿®å¤
æµ·æŠ¥ç”Ÿæˆ:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%  â† å‰ç«¯å¾…æ¥å…¥
Settings:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%  â† UI å¾…å®Œå–„
ä»»åŠ¡ç³»ç»Ÿ:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%  â† CSRF å¾…ä¿®å¤
```

### 6.2 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **[P0]** ä¿®å¤ CSRF Token å¤„ç† â†’ æ¢å¤ä»»åŠ¡åŠŸèƒ½
2. **[P0]** å®Œå–„ action_buttons ç‚¹å‡»å¤„ç† â†’ æ¢å¤ä¸€é”®è¡ŒåŠ¨
3. **[P1]** å®ç° Kçº¿ API + å‰ç«¯ç»„ä»¶ (L1 Module Data)
4. **[P1]** æµ·æŠ¥åŠŸèƒ½å‰ç«¯æ¥å…¥ (Interaction Layer)
5. **[P2]** æ‰©å±• L2 Expert Agentsï¼ˆç´«å¾®/æ˜Ÿåº§/CBTï¼‰
6. **[P2]** Settings é¡µé¢ UI å®Œå–„

---

*æ–‡æ¡£ç‰ˆæœ¬: v3.1 (Context Driven Architecture)*
*æ›´æ–°æ—¥æœŸ: 2026-01-01*
*æµ‹è¯•ç¯å¢ƒ: http://106.37.170.238:8231/new*
