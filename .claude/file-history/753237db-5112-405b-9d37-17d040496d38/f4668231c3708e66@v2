#!/usr/bin/env python3
"""
Goal-Anchored History æµ‹è¯•è„šæœ¬

æµ‹è¯•åœºæ™¯ï¼š
1. åŸºç¡€åŠŸèƒ½ï¼šç¬¬ä¸€æ¡æ¶ˆæ¯ + æœ€è¿‘ N æ¡
2. çŸ­å¯¹è¯ï¼šæ¶ˆæ¯æ•° < limit æ—¶çš„è¡Œä¸º
3. é•¿å¯¹è¯ï¼š50+ æ¡æ¶ˆæ¯åï¼Œç¬¬ä¸€æ¡ä»åœ¨
4. å»é‡ï¼šç¬¬ä¸€æ¡æ¶ˆæ¯åœ¨æœ€è¿‘ N æ¡ä¸­æ—¶ä¸é‡å¤
5. ç©ºä¼šè¯ï¼šæ— æ¶ˆæ¯æ—¶è¿”å›ç©ºåˆ—è¡¨

è¿è¡Œæ–¹å¼ï¼š
    cd apps/api
    python scripts/test_goal_anchored_history.py
"""
import asyncio
import sys
import os
from uuid import uuid4
from datetime import datetime, timedelta

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# åŠ è½½ .envï¼ˆçœŸå®æ•°æ®åº“é…ç½®ï¼‰
from pathlib import Path
env_file = Path(__file__).parent.parent.parent.parent / ".env"
if env_file.exists():
    with open(env_file) as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#") and "=" in line:
                key, value = line.split("=", 1)
                os.environ.setdefault(key.strip(), value.strip())

# å¼ºåˆ¶ä½¿ç”¨çœŸå®æ•°æ®åº“è¿›è¡Œæµ‹è¯•
os.environ["VIBELIFE_ENV"] = "test"
os.environ["VIBELIFE_TEST_DB_URL"] = os.environ.get("VIBELIFE_DB_URL", "")


class TestResult:
    def __init__(self):
        self.passed = 0
        self.failed = 0
        self.errors = []

    def add_pass(self, name: str):
        self.passed += 1
        print(f"  âœ… {name}")

    def add_fail(self, name: str, expected, actual):
        self.failed += 1
        self.errors.append((name, expected, actual))
        print(f"  âŒ {name}")
        print(f"     Expected: {expected}")
        print(f"     Actual:   {actual}")

    def summary(self):
        total = self.passed + self.failed
        print(f"\n{'='*60}")
        print(f"æµ‹è¯•ç»“æœ: {self.passed}/{total} é€šè¿‡")
        if self.errors:
            print(f"\nå¤±è´¥çš„æµ‹è¯•:")
            for name, expected, actual in self.errors:
                print(f"  - {name}")
        print(f"{'='*60}")
        return self.failed == 0


async def create_test_conversation(conv_id):
    """åˆ›å»ºæµ‹è¯•ç”¨çš„ conversation è®°å½•"""
    from stores import conversation_repo
    await conversation_repo.create_conversation(
        skill="core",  # ä½¿ç”¨æœ‰æ•ˆçš„ skill å€¼
        user_id=None,
        conversation_id=conv_id
    )


async def delete_test_conversation(conv_id):
    """åˆ é™¤æµ‹è¯•ç”¨çš„ conversation è®°å½•"""
    from stores.db import execute
    await execute("DELETE FROM conversations WHERE id = $1", conv_id)


async def test_basic_functionality():
    """æµ‹è¯• 1: åŸºç¡€åŠŸèƒ½ - ç¬¬ä¸€æ¡ + æœ€è¿‘ N æ¡"""
    print("\nğŸ“‹ æµ‹è¯• 1: åŸºç¡€åŠŸèƒ½")
    result = TestResult()

    from stores import message_repo
    from stores.db import init_db

    await init_db()

    # åˆ›å»ºæµ‹è¯•ä¼šè¯
    conv_id = uuid4()

    try:
        # å…ˆåˆ›å»º conversation è®°å½•ï¼ˆå¤–é”®çº¦æŸï¼‰
        await create_test_conversation(conv_id)

        # åˆ›å»º 20 æ¡æ¶ˆæ¯
        for i in range(20):
            role = "user" if i % 2 == 0 else "assistant"
            content = f"Message {i+1}: {'ç”¨æˆ·' if role == 'user' else 'åŠ©æ‰‹'}æ¶ˆæ¯"
            if i == 0:
                content = "æˆ‘æƒ³åšäººç”Ÿè§„åˆ’ï¼Œå¸®æˆ‘è®¾å®šä¸€ä¸ªåŒ—ææ˜Ÿç›®æ ‡"  # ç¬¬ä¸€æ¡æ˜¯åŸå§‹æ„å›¾
            await message_repo.create_message(conv_id, role, content)

        # æµ‹è¯• get_messages_anchored
        messages = await message_repo.get_messages_anchored(conv_id, limit=5)

        # éªŒè¯ï¼šåº”è¯¥æœ‰ 6 æ¡ï¼ˆç¬¬ä¸€æ¡ + æœ€è¿‘ 5 æ¡ï¼‰
        if len(messages) == 6:
            result.add_pass("æ¶ˆæ¯æ•°é‡æ­£ç¡® (6æ¡)")
        else:
            result.add_fail("æ¶ˆæ¯æ•°é‡", 6, len(messages))

        # éªŒè¯ï¼šç¬¬ä¸€æ¡æ˜¯åŸå§‹æ„å›¾
        if "åŒ—ææ˜Ÿ" in messages[0]["content"]:
            result.add_pass("ç¬¬ä¸€æ¡æ¶ˆæ¯æ˜¯åŸå§‹æ„å›¾")
        else:
            result.add_fail("ç¬¬ä¸€æ¡æ¶ˆæ¯å†…å®¹", "åŒ…å«'åŒ—ææ˜Ÿ'", messages[0]["content"][:50])

        # éªŒè¯ï¼šæœ€åä¸€æ¡æ˜¯æœ€æ–°æ¶ˆæ¯
        if "Message 20" in messages[-1]["content"]:
            result.add_pass("æœ€åä¸€æ¡æ˜¯æœ€æ–°æ¶ˆæ¯")
        else:
            result.add_fail("æœ€åä¸€æ¡æ¶ˆæ¯", "Message 20", messages[-1]["content"][:50])

    finally:
        # æ¸…ç†æµ‹è¯•æ•°æ®
        await message_repo.delete_conversation_messages(conv_id)
        await delete_test_conversation(conv_id)

    return result


async def test_short_conversation():
    """æµ‹è¯• 2: çŸ­å¯¹è¯ - æ¶ˆæ¯æ•° < limit"""
    print("\nğŸ“‹ æµ‹è¯• 2: çŸ­å¯¹è¯ (æ¶ˆæ¯æ•° < limit)")
    result = TestResult()

    from stores import message_repo

    conv_id = uuid4()

    try:
        # å…ˆåˆ›å»º conversation è®°å½•
        await create_test_conversation(conv_id)

        # åªåˆ›å»º 3 æ¡æ¶ˆæ¯
        await message_repo.create_message(conv_id, "user", "ç¬¬ä¸€æ¡ï¼šæˆ‘çš„ç›®æ ‡æ˜¯ä»€ä¹ˆ")
        await message_repo.create_message(conv_id, "assistant", "ç¬¬äºŒæ¡ï¼šè®©æˆ‘å¸®ä½ åˆ†æ")
        await message_repo.create_message(conv_id, "user", "ç¬¬ä¸‰æ¡ï¼šå¥½çš„")

        # è¯·æ±‚ limit=10
        messages = await message_repo.get_messages_anchored(conv_id, limit=10)

        # éªŒè¯ï¼šåº”è¯¥åªæœ‰ 3 æ¡ï¼ˆä¸ä¼šé‡å¤ï¼‰
        if len(messages) == 3:
            result.add_pass("çŸ­å¯¹è¯æ¶ˆæ¯æ•°æ­£ç¡® (3æ¡)")
        else:
            result.add_fail("çŸ­å¯¹è¯æ¶ˆæ¯æ•°", 3, len(messages))

        # éªŒè¯ï¼šé¡ºåºæ­£ç¡®
        if messages[0]["content"].startswith("ç¬¬ä¸€æ¡"):
            result.add_pass("é¡ºåºæ­£ç¡®")
        else:
            result.add_fail("æ¶ˆæ¯é¡ºåº", "ç¬¬ä¸€æ¡å¼€å¤´", messages[0]["content"][:20])

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        await delete_test_conversation(conv_id)

    return result


async def test_deduplication():
    """æµ‹è¯• 3: å»é‡ - ç¬¬ä¸€æ¡åœ¨æœ€è¿‘ N æ¡ä¸­æ—¶ä¸é‡å¤"""
    print("\nğŸ“‹ æµ‹è¯• 3: å»é‡é€»è¾‘")
    result = TestResult()

    from stores import message_repo

    conv_id = uuid4()

    try:
        # å…ˆåˆ›å»º conversation è®°å½•
        await create_test_conversation(conv_id)

        # åˆ›å»º 5 æ¡æ¶ˆæ¯ï¼Œlimit=10ï¼ˆç¬¬ä¸€æ¡ä¼šåœ¨æœ€è¿‘ 10 æ¡ä¸­ï¼‰
        for i in range(5):
            await message_repo.create_message(conv_id, "user", f"æ¶ˆæ¯ {i+1}")

        messages = await message_repo.get_messages_anchored(conv_id, limit=10)

        # éªŒè¯ï¼šåº”è¯¥åªæœ‰ 5 æ¡ï¼ˆç¬¬ä¸€æ¡ä¸é‡å¤ï¼‰
        if len(messages) == 5:
            result.add_pass("å»é‡æ­£ç¡® (5æ¡)")
        else:
            result.add_fail("å»é‡åæ¶ˆæ¯æ•°", 5, len(messages))

        # éªŒè¯ï¼šæ²¡æœ‰é‡å¤çš„æ¶ˆæ¯
        contents = [m["content"] for m in messages]
        if len(contents) == len(set(contents)):
            result.add_pass("æ— é‡å¤æ¶ˆæ¯")
        else:
            result.add_fail("é‡å¤æ£€æŸ¥", "æ— é‡å¤", f"æœ‰é‡å¤: {contents}")

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        await delete_test_conversation(conv_id)

    return result


async def test_empty_conversation():
    """æµ‹è¯• 4: ç©ºä¼šè¯"""
    print("\nğŸ“‹ æµ‹è¯• 4: ç©ºä¼šè¯")
    result = TestResult()

    from stores import message_repo

    conv_id = uuid4()  # ä¸å­˜åœ¨çš„ä¼šè¯

    messages = await message_repo.get_messages_anchored(conv_id, limit=10)

    if len(messages) == 0:
        result.add_pass("ç©ºä¼šè¯è¿”å›ç©ºåˆ—è¡¨")
    else:
        result.add_fail("ç©ºä¼šè¯ç»“æœ", "[]", messages)

    return result


async def test_long_conversation_goal_retention():
    """æµ‹è¯• 5: é•¿å¯¹è¯ç›®æ ‡ä¿æŒ - 50+ æ¡æ¶ˆæ¯åç¬¬ä¸€æ¡ä»åœ¨"""
    print("\nğŸ“‹ æµ‹è¯• 5: é•¿å¯¹è¯ç›®æ ‡ä¿æŒ (50+ æ¡æ¶ˆæ¯)")
    result = TestResult()

    from stores import message_repo

    conv_id = uuid4()

    try:
        # å…ˆåˆ›å»º conversation è®°å½•
        await create_test_conversation(conv_id)

        # åˆ›å»º 60 æ¡æ¶ˆæ¯
        original_goal = "æˆ‘æƒ³æˆä¸ºç‹¬ç«‹å¼€å‘è€…ï¼Œå®ç°è´¢åŠ¡è‡ªç”±å’Œæ—¶é—´è‡ªç”±"
        await message_repo.create_message(conv_id, "user", original_goal)

        for i in range(59):
            role = "assistant" if i % 2 == 0 else "user"
            content = f"å¯¹è¯ {i+2}: {'åˆ†æä¸­...' if role == 'assistant' else 'ç»§ç»­'}"
            await message_repo.create_message(conv_id, role, content)

        # è¯·æ±‚ limit=14ï¼ˆå…± 15 æ¡ï¼‰
        messages = await message_repo.get_messages_anchored(conv_id, limit=14)

        # éªŒè¯ï¼šåº”è¯¥æœ‰ 15 æ¡
        if len(messages) == 15:
            result.add_pass("é•¿å¯¹è¯æ¶ˆæ¯æ•°æ­£ç¡® (15æ¡)")
        else:
            result.add_fail("é•¿å¯¹è¯æ¶ˆæ¯æ•°", 15, len(messages))

        # éªŒè¯ï¼šç¬¬ä¸€æ¡æ˜¯åŸå§‹ç›®æ ‡
        if "ç‹¬ç«‹å¼€å‘è€…" in messages[0]["content"]:
            result.add_pass("åŸå§‹ç›®æ ‡ä¿ç•™ âœ¨")
        else:
            result.add_fail("åŸå§‹ç›®æ ‡", "åŒ…å«'ç‹¬ç«‹å¼€å‘è€…'", messages[0]["content"][:50])

        # éªŒè¯ï¼šæœ€åä¸€æ¡æ˜¯æœ€æ–°çš„
        if "å¯¹è¯ 60" in messages[-1]["content"]:
            result.add_pass("æœ€æ–°æ¶ˆæ¯æ­£ç¡®")
        else:
            result.add_fail("æœ€æ–°æ¶ˆæ¯", "å¯¹è¯ 60", messages[-1]["content"][:50])

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        await delete_test_conversation(conv_id)

    return result


async def test_chat_v5_integration():
    """æµ‹è¯• 6: Chat V5 è·¯ç”±é›†æˆ"""
    print("\nğŸ“‹ æµ‹è¯• 6: Chat V5 è·¯ç”±é›†æˆ")
    result = TestResult()

    from stores import message_repo
    from routes.chat_v5 import get_conversation_history

    conv_id = uuid4()

    try:
        # å…ˆåˆ›å»º conversation è®°å½•
        await create_test_conversation(conv_id)

        # åˆ›å»º 30 æ¡æ¶ˆæ¯
        await message_repo.create_message(conv_id, "user", "å¸®æˆ‘ç®—å…«å­—ï¼Œæˆ‘æƒ³çŸ¥é“ä»Šå¹´è¿åŠ¿")
        for i in range(29):
            role = "assistant" if i % 2 == 0 else "user"
            await message_repo.create_message(conv_id, role, f"æ¶ˆæ¯ {i+2}")

        # Phase 1 (skill=None): åº”è¯¥æ˜¯ 5 æ¡
        history_p1 = await get_conversation_history(conv_id, skill=None)
        if len(history_p1) == 5:
            result.add_pass("Phase 1: 5 æ¡æ¶ˆæ¯")
        else:
            result.add_fail("Phase 1 æ¶ˆæ¯æ•°", 5, len(history_p1))

        # Phase 2 (skill='bazi'): åº”è¯¥æ˜¯ 15 æ¡
        history_p2 = await get_conversation_history(conv_id, skill="bazi")
        if len(history_p2) == 15:
            result.add_pass("Phase 2: 15 æ¡æ¶ˆæ¯")
        else:
            result.add_fail("Phase 2 æ¶ˆæ¯æ•°", 15, len(history_p2))

        # éªŒè¯ä¸¤ä¸ª Phase çš„ç¬¬ä¸€æ¡éƒ½æ˜¯åŸå§‹æ„å›¾
        if "å…«å­—" in history_p1[0]["content"] and "å…«å­—" in history_p2[0]["content"]:
            result.add_pass("ä¸¤ä¸ª Phase éƒ½ä¿ç•™åŸå§‹æ„å›¾")
        else:
            result.add_fail("åŸå§‹æ„å›¾ä¿ç•™", "åŒ…å«'å…«å­—'",
                          f"P1: {history_p1[0]['content'][:30]}, P2: {history_p2[0]['content'][:30]}")

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        await delete_test_conversation(conv_id)

    return result


async def main():
    print("=" * 60)
    print("Goal-Anchored History æµ‹è¯•")
    print("å€Ÿé‰´ Planning-with-Files çš„ Attention Manipulation åŸåˆ™")
    print("=" * 60)

    all_passed = True
    total_passed = 0
    total_failed = 0

    tests = [
        test_basic_functionality,
        test_short_conversation,
        test_deduplication,
        test_empty_conversation,
        test_long_conversation_goal_retention,
        test_chat_v5_integration,
    ]

    for test in tests:
        try:
            result = await test()
            total_passed += result.passed
            total_failed += result.failed
            if result.failed > 0:
                all_passed = False
        except Exception as e:
            print(f"  ğŸ’¥ æµ‹è¯•å¼‚å¸¸: {e}")
            import traceback
            traceback.print_exc()
            all_passed = False
            total_failed += 1

    print("\n" + "=" * 60)
    print(f"æ€»è®¡: {total_passed} é€šè¿‡, {total_failed} å¤±è´¥")
    print("=" * 60)

    if all_passed:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Goal-Anchored History å·¥ä½œæ­£å¸¸ã€‚")
    else:
        print("\nâš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„é”™è¯¯ä¿¡æ¯ã€‚")

    return all_passed


if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
