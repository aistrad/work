#!/usr/bin/env python3
"""
Goal-Anchored History ç«¯åˆ°ç«¯æµ‹è¯•

éªŒè¯ç‚¹ï¼š
1. é•¿å¯¹è¯ä¸­ LLM æ˜¯å¦èƒ½å¼•ç”¨ç”¨æˆ·åŸå§‹æ„å›¾
2. Context æ„å»ºæ˜¯å¦æ­£ç¡®æ³¨å…¥ç¬¬ä¸€æ¡æ¶ˆæ¯
3. è·¨ Skill åœºæ™¯ä¸‹ç›®æ ‡æ˜¯å¦ä¿æŒ
4. å·¥å…·è°ƒç”¨æ˜¯å¦ç¬¦åˆç”¨æˆ·æ„å›¾

è¿è¡Œæ–¹å¼ï¼š
    cd apps/api
    python scripts/test_goal_anchored_e2e.py
"""
import asyncio
import sys
import os
import json
from uuid import uuid4
from datetime import datetime

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# åŠ è½½ .env
from pathlib import Path
env_file = Path(__file__).parent.parent.parent.parent / ".env"
if env_file.exists():
    with open(env_file) as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#") and "=" in line:
                key, value = line.split("=", 1)
                os.environ.setdefault(key.strip(), value.strip())


class E2ETestResult:
    def __init__(self, name: str):
        self.name = name
        self.checks = []
        self.passed = True

    def check(self, condition: bool, description: str, details: str = ""):
        status = "âœ…" if condition else "âŒ"
        self.checks.append((status, description, details))
        if not condition:
            self.passed = False
        print(f"  {status} {description}")
        if details and not condition:
            print(f"     è¯¦æƒ…: {details[:200]}...")

    def summary(self):
        passed = sum(1 for c in self.checks if c[0] == "âœ…")
        total = len(self.checks)
        return passed, total


async def test_scenario_1_long_conversation_goal_retention():
    """
    åœºæ™¯ 1: é•¿å¯¹è¯ç›®æ ‡ä¿æŒ

    æ¨¡æ‹Ÿï¼šç”¨æˆ·è¯´"æˆ‘æƒ³åšäººç”Ÿè§„åˆ’"ï¼Œç»è¿‡å¤šè½®å¯¹è¯åï¼Œ
    éªŒè¯ context ä¸­æ˜¯å¦ä»åŒ…å«åŸå§‹æ„å›¾ã€‚
    """
    print("\n" + "="*60)
    print("åœºæ™¯ 1: é•¿å¯¹è¯ç›®æ ‡ä¿æŒ")
    print("="*60)

    result = E2ETestResult("é•¿å¯¹è¯ç›®æ ‡ä¿æŒ")

    from stores import message_repo, conversation_repo
    from stores.db import init_db
    from routes.chat_v5 import get_conversation_history

    await init_db()

    conv_id = uuid4()
    original_goal = "æˆ‘æƒ³åšäººç”Ÿè§„åˆ’ï¼Œæ‰¾åˆ°åŒ—ææ˜Ÿç›®æ ‡ï¼Œå®ç°è´¢åŠ¡è‡ªç”±"

    try:
        # 1. åˆ›å»ºä¼šè¯
        await conversation_repo.create_conversation(
            skill="lifecoach",
            user_id=None,
            conversation_id=conv_id
        )

        # 2. æ¨¡æ‹Ÿé•¿å¯¹è¯ï¼ˆ30è½®ï¼‰
        await message_repo.create_message(conv_id, "user", original_goal)
        await message_repo.create_message(conv_id, "assistant", "å¥½çš„ï¼Œè®©æˆ‘å¸®ä½ åšäººç”Ÿè§„åˆ’ã€‚é¦–å…ˆï¼Œå‘Šè¯‰æˆ‘ä½ ç°åœ¨çš„å›°å¢ƒæ˜¯ä»€ä¹ˆï¼Ÿ")

        for i in range(28):
            role = "user" if i % 2 == 0 else "assistant"
            content = f"å¯¹è¯ {i+3}: {'æˆ‘ç»§ç»­è¯´æ˜æƒ…å†µ...' if role == 'user' else 'æˆ‘ç†è§£äº†ï¼Œç»§ç»­åˆ†æ...'}"
            await message_repo.create_message(conv_id, role, content)

        # 3. è·å– historyï¼ˆä½¿ç”¨ Goal-Anchored æ–¹æ³•ï¼‰
        history = await get_conversation_history(conv_id, skill="lifecoach")

        # éªŒè¯ 1: history æ•°é‡
        result.check(
            len(history) == 15,
            f"History æ•°é‡æ­£ç¡® (æœŸæœ› 15ï¼Œå®é™… {len(history)})"
        )

        # éªŒè¯ 2: ç¬¬ä¸€æ¡æ˜¯åŸå§‹æ„å›¾
        first_msg = history[0] if history else {}
        result.check(
            "åŒ—ææ˜Ÿ" in first_msg.get("content", ""),
            "ç¬¬ä¸€æ¡æ¶ˆæ¯åŒ…å«åŸå§‹ç›®æ ‡ 'åŒ—ææ˜Ÿ'",
            first_msg.get("content", "")[:100]
        )

        # éªŒè¯ 3: æœ€åä¸€æ¡æ˜¯æœ€æ–°æ¶ˆæ¯
        last_msg = history[-1] if history else {}
        result.check(
            "å¯¹è¯ 30" in last_msg.get("content", ""),
            "æœ€åä¸€æ¡æ˜¯æœ€æ–°æ¶ˆæ¯",
            last_msg.get("content", "")[:100]
        )

        # éªŒè¯ 4: ä¸­é—´æ¶ˆæ¯è¢«æ­£ç¡®æˆªæ–­
        # history åº”è¯¥æ˜¯: [msg1, msg17, msg18, ..., msg30] (å…± 15 æ¡)
        contents = [h.get("content", "") for h in history]
        has_gap = "å¯¹è¯ 3" not in str(contents) and "å¯¹è¯ 15" not in str(contents)
        result.check(
            has_gap,
            "ä¸­é—´æ¶ˆæ¯è¢«æ­£ç¡®æˆªæ–­ï¼ˆä¸åŒ…å«æ—©æœŸçš„å¯¹è¯ 3-15ï¼‰"
        )

        print(f"\n  ğŸ“Š History ç»“æ„:")
        print(f"     ç¬¬ 1 æ¡: {history[0].get('content', '')[:50]}...")
        print(f"     ç¬¬ 2 æ¡: {history[1].get('content', '')[:50]}...")
        print(f"     ...")
        print(f"     ç¬¬ {len(history)} æ¡: {history[-1].get('content', '')[:50]}...")

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        from stores.db import execute
        await execute("DELETE FROM conversations WHERE id = $1", conv_id)

    return result


async def test_scenario_2_context_injection_verification():
    """
    åœºæ™¯ 2: Context æ³¨å…¥éªŒè¯

    éªŒè¯ PromptBuilder æ„å»ºçš„ messages æ˜¯å¦æ­£ç¡®åŒ…å«ç¬¬ä¸€æ¡æ¶ˆæ¯
    """
    print("\n" + "="*60)
    print("åœºæ™¯ 2: Context æ³¨å…¥éªŒè¯")
    print("="*60)

    result = E2ETestResult("Context æ³¨å…¥éªŒè¯")

    from stores import message_repo, conversation_repo
    from routes.chat_v5 import get_conversation_history
    from services.agent import AgentContext

    conv_id = uuid4()

    try:
        # åˆ›å»ºä¼šè¯
        await conversation_repo.create_conversation(
            skill="bazi",
            user_id=None,
            conversation_id=conv_id
        )

        # åˆ›å»ºæ¶ˆæ¯
        original_intent = "å¸®æˆ‘ç®—å…«å­—ï¼Œæˆ‘æƒ³çŸ¥é“ä»Šå¹´çš„äº‹ä¸šè¿åŠ¿"
        await message_repo.create_message(conv_id, "user", original_intent)

        for i in range(20):
            role = "assistant" if i % 2 == 0 else "user"
            await message_repo.create_message(conv_id, role, f"å¯¹è¯ {i+2}")

        # è·å– Phase 1 historyï¼ˆskill=Noneï¼Œlimit=4+1=5ï¼‰
        history_p1 = await get_conversation_history(conv_id, skill=None)

        # è·å– Phase 2 historyï¼ˆskill='bazi'ï¼Œlimit=14+1=15ï¼‰
        history_p2 = await get_conversation_history(conv_id, skill="bazi")

        # éªŒè¯ Phase 1
        result.check(
            len(history_p1) == 5,
            f"Phase 1: History æ•°é‡æ­£ç¡® (æœŸæœ› 5ï¼Œå®é™… {len(history_p1)})"
        )
        result.check(
            "å…«å­—" in history_p1[0].get("content", ""),
            "Phase 1: ç¬¬ä¸€æ¡åŒ…å«åŸå§‹æ„å›¾ 'å…«å­—'",
            history_p1[0].get("content", "") if history_p1 else ""
        )

        # éªŒè¯ Phase 2
        result.check(
            len(history_p2) == 15,
            f"Phase 2: History æ•°é‡æ­£ç¡® (æœŸæœ› 15ï¼Œå®é™… {len(history_p2)})"
        )
        result.check(
            "å…«å­—" in history_p2[0].get("content", ""),
            "Phase 2: ç¬¬ä¸€æ¡åŒ…å«åŸå§‹æ„å›¾ 'å…«å­—'",
            history_p2[0].get("content", "") if history_p2 else ""
        )

        # éªŒè¯ä¸¤ä¸ª Phase çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ç›¸åŒ
        p1_first = history_p1[0].get("content", "") if history_p1 else ""
        p2_first = history_p2[0].get("content", "") if history_p2 else ""
        result.check(
            p1_first == p2_first,
            "Phase 1 å’Œ Phase 2 çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ç›¸åŒï¼ˆGoal Anchoredï¼‰"
        )

        # æ„å»º AgentContext éªŒè¯
        context = AgentContext(
            user_id="test_user",
            user_tier="free",
            profile={},
            skill_data={},
            history=history_p2,
            skill="bazi",
            conversation_id=str(conv_id)
        )

        result.check(
            len(context.history) == 15,
            "AgentContext.history æ­£ç¡®æ³¨å…¥"
        )

        print(f"\n  ğŸ“Š Phase å¯¹æ¯”:")
        print(f"     Phase 1 ({len(history_p1)} æ¡): {history_p1[0].get('content', '')[:40]}...")
        print(f"     Phase 2 ({len(history_p2)} æ¡): {history_p2[0].get('content', '')[:40]}...")

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        from stores.db import execute
        await execute("DELETE FROM conversations WHERE id = $1", conv_id)

    return result


async def test_scenario_3_cross_skill_continuity():
    """
    åœºæ™¯ 3: è·¨ Skill ä¸Šä¸‹æ–‡è¿ç»­æ€§

    æ¨¡æ‹Ÿï¼šç”¨æˆ·ä» lifecoach åˆ‡æ¢åˆ° baziï¼Œå†å›åˆ° lifecoach
    éªŒè¯åŸå§‹ç›®æ ‡æ˜¯å¦ä¿æŒ
    """
    print("\n" + "="*60)
    print("åœºæ™¯ 3: è·¨ Skill ä¸Šä¸‹æ–‡è¿ç»­æ€§")
    print("="*60)

    result = E2ETestResult("è·¨ Skill è¿ç»­æ€§")

    from stores import message_repo, conversation_repo
    from routes.chat_v5 import get_conversation_history

    conv_id = uuid4()

    try:
        # 1. åˆ›å»ºä¼šè¯ï¼ˆåˆå§‹ skill: lifecoachï¼‰
        await conversation_repo.create_conversation(
            skill="lifecoach",
            user_id=None,
            conversation_id=conv_id
        )

        # 2. Lifecoach å¯¹è¯
        original_goal = "æˆ‘æƒ³è½¬å‹åšç‹¬ç«‹å¼€å‘è€…ï¼Œå®ç°å·¥ä½œä¸ç”Ÿæ´»å¹³è¡¡"
        await message_repo.create_message(conv_id, "user", original_goal)
        await message_repo.create_message(conv_id, "assistant", "å¾ˆå¥½çš„ç›®æ ‡ï¼è®©æˆ‘å¸®ä½ åˆ†æã€‚")

        # 3. ç”¨æˆ·åˆ‡æ¢åˆ° bazi
        await message_repo.create_message(conv_id, "user", "å…ˆå¸®æˆ‘çœ‹çœ‹å…«å­—ï¼Œäº†è§£ä¸€ä¸‹æˆ‘çš„å‘½ç›˜")
        await message_repo.create_message(conv_id, "assistant", "å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ æ’å…«å­—ã€‚è¯·å‘Šè¯‰æˆ‘ä½ çš„å‡ºç”Ÿæ—¥æœŸã€‚")
        await message_repo.create_message(conv_id, "user", "1990å¹´5æœˆ15æ—¥")
        await message_repo.create_message(conv_id, "assistant", "æ”¶åˆ°ï¼Œä½ çš„å…«å­—æ˜¯...")

        # 4. æ›´å¤šå¯¹è¯
        for i in range(10):
            role = "user" if i % 2 == 0 else "assistant"
            await message_repo.create_message(conv_id, role, f"å…«å­—åˆ†æå¯¹è¯ {i+1}")

        # 5. ç”¨æˆ·æƒ³å›åˆ° lifecoach
        await message_repo.create_message(conv_id, "user", "å¥½çš„ï¼Œå…«å­—çœ‹å®Œäº†ï¼Œæˆ‘ä»¬ç»§ç»­èŠäººç”Ÿè§„åˆ’")

        # è·å– history
        history = await get_conversation_history(conv_id, skill="lifecoach")

        # éªŒè¯: ç¬¬ä¸€æ¡ä»æ˜¯åŸå§‹ç›®æ ‡
        first_content = history[0].get("content", "") if history else ""
        result.check(
            "ç‹¬ç«‹å¼€å‘è€…" in first_content,
            "è·¨ Skill åï¼Œç¬¬ä¸€æ¡æ¶ˆæ¯ä»æ˜¯åŸå§‹ç›®æ ‡ 'ç‹¬ç«‹å¼€å‘è€…'",
            first_content[:100]
        )

        # éªŒè¯: æœ€åä¸€æ¡æ˜¯"ç»§ç»­èŠäººç”Ÿè§„åˆ’"
        last_content = history[-1].get("content", "") if history else ""
        result.check(
            "ç»§ç»­èŠäººç”Ÿè§„åˆ’" in last_content,
            "æœ€åä¸€æ¡æ˜¯å›å½’è¯·æ±‚",
            last_content[:100]
        )

        # éªŒè¯: history åŒ…å«äº†è·¨ skill çš„å…³é”®ä¿¡æ¯
        all_content = str(history)
        result.check(
            "å…«å­—" in all_content,
            "History åŒ…å«è·¨ Skill çš„ä¸Šä¸‹æ–‡ï¼ˆå…«å­—ç›¸å…³å†…å®¹ï¼‰"
        )

        print(f"\n  ğŸ“Š è·¨ Skill å¯¹è¯æµ:")
        print(f"     åŸå§‹ç›®æ ‡: {original_goal[:50]}...")
        print(f"     ä¸­é—´åˆ‡æ¢: å…«å­—åˆ†æ")
        print(f"     å›å½’: ç»§ç»­äººç”Ÿè§„åˆ’")
        print(f"     History ç¬¬ä¸€æ¡: {first_content[:50]}...")

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        from stores.db import execute
        await execute("DELETE FROM conversations WHERE id = $1", conv_id)

    return result


async def test_scenario_4_tool_call_with_goal_context():
    """
    åœºæ™¯ 4: å¸¦ Goal Context çš„å·¥å…·è°ƒç”¨éªŒè¯

    éªŒè¯ LLM åœ¨æœ‰ Goal Context çš„æƒ…å†µä¸‹ï¼Œå·¥å…·è°ƒç”¨æ˜¯å¦æ›´å‡†ç¡®
    """
    print("\n" + "="*60)
    print("åœºæ™¯ 4: å·¥å…·è°ƒç”¨ä¸ Goal Context")
    print("="*60)

    result = E2ETestResult("å·¥å…·è°ƒç”¨éªŒè¯")

    from stores import message_repo, conversation_repo
    from routes.chat_v5 import get_conversation_history
    from services.agent.prompt_builder import get_prompt_builder

    conv_id = uuid4()

    try:
        await conversation_repo.create_conversation(
            skill="lifecoach",
            user_id=None,
            conversation_id=conv_id
        )

        # åˆ›å»ºå¸¦æœ‰æ˜ç¡®ç›®æ ‡çš„å¯¹è¯
        await message_repo.create_message(conv_id, "user",
            "æˆ‘æƒ³ç”¨ Dan Koe çš„æ–¹æ³•åšäººç”Ÿé‡ç½®ï¼Œå¸®æˆ‘è®¾å®šåŒ—ææ˜Ÿæ„¿æ™¯")
        await message_repo.create_message(conv_id, "assistant",
            "å¥½çš„ï¼Œè®©æˆ‘ä»¬å¼€å§‹ Dan Koe å¿«é€Ÿé‡ç½®ã€‚")

        # æ¨¡æ‹Ÿå¤šè½®å¯¹è¯
        for i in range(15):
            role = "user" if i % 2 == 0 else "assistant"
            await message_repo.create_message(conv_id, role, f"é‡ç½®å¯¹è¯ {i+1}")

        # ç”¨æˆ·æ¨¡ç³Šè¯·æ±‚
        await message_repo.create_message(conv_id, "user", "ç»§ç»­")

        # è·å– history
        history = await get_conversation_history(conv_id, skill="lifecoach")

        # éªŒè¯: history ç¬¬ä¸€æ¡åŒ…å«æ˜ç¡®çš„æ–¹æ³•è®º
        first_content = history[0].get("content", "") if history else ""
        result.check(
            "Dan Koe" in first_content or "äººç”Ÿé‡ç½®" in first_content,
            "Goal Context åŒ…å«æ–¹æ³•è®ºä¿¡æ¯ (Dan Koe/äººç”Ÿé‡ç½®)",
            first_content[:100]
        )

        # æ„å»º prompt éªŒè¯
        prompt_builder = get_prompt_builder()

        # éªŒè¯ prompt_builder å¯ä»¥æ­£ç¡®å¤„ç† history
        result.check(
            len(history) > 0,
            "History éç©ºï¼Œå¯ä¾› PromptBuilder ä½¿ç”¨"
        )

        # æ¨¡æ‹Ÿ LLM åº”è¯¥å¦‚ä½•ç†è§£è¿™ä¸ª context
        # å½“ç”¨æˆ·è¯´"ç»§ç»­"æ—¶ï¼ŒLLM åº”è¯¥èƒ½ä» Goal Context ç†è§£æ˜¯ç»§ç»­ Dan Koe é‡ç½®
        goal_context_useful = "Dan Koe" in first_content and "ç»§ç»­" in history[-1].get("content", "")
        result.check(
            goal_context_useful,
            "Goal Context å¯¹ç†è§£æ¨¡ç³Šè¯·æ±‚'ç»§ç»­'æœ‰å¸®åŠ©"
        )

        print(f"\n  ğŸ“Š å·¥å…·è°ƒç”¨åœºæ™¯åˆ†æ:")
        print(f"     ç”¨æˆ·åŸå§‹æ„å›¾: {first_content[:60]}...")
        print(f"     ç”¨æˆ·æ¨¡ç³Šè¯·æ±‚: ç»§ç»­")
        print(f"     æœ‰ Goal Context: LLM çŸ¥é“ç»§ç»­çš„æ˜¯ Dan Koe é‡ç½®")
        print(f"     æ—  Goal Context: LLM å¯èƒ½ä¸çŸ¥é“ç»§ç»­ä»€ä¹ˆ")

    finally:
        await message_repo.delete_conversation_messages(conv_id)
        from stores.db import execute
        await execute("DELETE FROM conversations WHERE id = $1", conv_id)

    return result


async def test_scenario_5_edge_cases():
    """
    åœºæ™¯ 5: è¾¹ç•Œæƒ…å†µæµ‹è¯•
    """
    print("\n" + "="*60)
    print("åœºæ™¯ 5: è¾¹ç•Œæƒ…å†µ")
    print("="*60)

    result = E2ETestResult("è¾¹ç•Œæƒ…å†µ")

    from stores import message_repo, conversation_repo
    from routes.chat_v5 import get_conversation_history

    # 5.1 ç©ºä¼šè¯
    empty_conv_id = uuid4()
    history_empty = await get_conversation_history(empty_conv_id, skill="bazi")
    result.check(
        len(history_empty) == 0,
        "ç©ºä¼šè¯è¿”å›ç©º history"
    )

    # 5.2 åªæœ‰ 1 æ¡æ¶ˆæ¯
    conv_id_1 = uuid4()
    try:
        await conversation_repo.create_conversation(skill="core", user_id=None, conversation_id=conv_id_1)
        await message_repo.create_message(conv_id_1, "user", "å”¯ä¸€çš„æ¶ˆæ¯")

        history_1 = await get_conversation_history(conv_id_1, skill="bazi")
        result.check(
            len(history_1) == 1,
            "å•æ¶ˆæ¯ä¼šè¯: history åªæœ‰ 1 æ¡"
        )
        result.check(
            history_1[0].get("content") == "å”¯ä¸€çš„æ¶ˆæ¯",
            "å•æ¶ˆæ¯ä¼šè¯: å†…å®¹æ­£ç¡®"
        )
    finally:
        await message_repo.delete_conversation_messages(conv_id_1)
        from stores.db import execute
        await execute("DELETE FROM conversations WHERE id = $1", conv_id_1)

    # 5.3 æ¶ˆæ¯æ•°åˆšå¥½ç­‰äº limit
    conv_id_exact = uuid4()
    try:
        await conversation_repo.create_conversation(skill="core", user_id=None, conversation_id=conv_id_exact)
        for i in range(15):  # Phase 2 limit = 15
            await message_repo.create_message(conv_id_exact, "user", f"æ¶ˆæ¯ {i+1}")

        history_exact = await get_conversation_history(conv_id_exact, skill="bazi")
        result.check(
            len(history_exact) == 15,
            "æ¶ˆæ¯æ•°=limit: å…¨éƒ¨è¿”å›ï¼Œæ— é‡å¤"
        )

        # éªŒè¯æ— é‡å¤
        contents = [h.get("content") for h in history_exact]
        result.check(
            len(contents) == len(set(contents)),
            "æ¶ˆæ¯æ•°=limit: æ— é‡å¤æ¶ˆæ¯"
        )
    finally:
        await message_repo.delete_conversation_messages(conv_id_exact)
        from stores.db import execute
        await execute("DELETE FROM conversations WHERE id = $1", conv_id_exact)

    # 5.4 ç¬¬ä¸€æ¡æ¶ˆæ¯å†…å®¹å¾ˆé•¿
    conv_id_long = uuid4()
    try:
        await conversation_repo.create_conversation(skill="core", user_id=None, conversation_id=conv_id_long)
        long_goal = "æˆ‘æƒ³åšç‹¬ç«‹å¼€å‘è€…ï¼Œ" * 100  # å¾ˆé•¿çš„ç›®æ ‡
        await message_repo.create_message(conv_id_long, "user", long_goal)
        for i in range(20):
            await message_repo.create_message(conv_id_long, "assistant", f"å›å¤ {i+1}")

        history_long = await get_conversation_history(conv_id_long, skill="bazi")
        result.check(
            "ç‹¬ç«‹å¼€å‘è€…" in history_long[0].get("content", ""),
            "é•¿æ¶ˆæ¯: ç¬¬ä¸€æ¡æ¶ˆæ¯å®Œæ•´ä¿ç•™"
        )
    finally:
        await message_repo.delete_conversation_messages(conv_id_long)
        from stores.db import execute
        await execute("DELETE FROM conversations WHERE id = $1", conv_id_long)

    return result


async def main():
    from stores.db import init_db
    await init_db()

    print("="*60)
    print("Goal-Anchored History ç«¯åˆ°ç«¯æµ‹è¯•")
    print("éªŒè¯å¯¹è¯æµç¨‹ã€Contextã€å·¥å…·è°ƒç”¨æ˜¯å¦ç¬¦åˆç”¨æˆ·æ„å›¾")
    print("="*60)

    tests = [
        test_scenario_1_long_conversation_goal_retention,
        test_scenario_2_context_injection_verification,
        test_scenario_3_cross_skill_continuity,
        test_scenario_4_tool_call_with_goal_context,
        test_scenario_5_edge_cases,
    ]

    all_results = []
    total_passed = 0
    total_checks = 0

    for test in tests:
        try:
            result = await test()
            all_results.append(result)
            passed, checks = result.summary()
            total_passed += passed
            total_checks += checks
        except Exception as e:
            print(f"\n  ğŸ’¥ æµ‹è¯•å¼‚å¸¸: {e}")
            import traceback
            traceback.print_exc()

    # æ€»ç»“
    print("\n" + "="*60)
    print("æµ‹è¯•æ€»ç»“")
    print("="*60)

    for result in all_results:
        passed, checks = result.summary()
        status = "âœ…" if result.passed else "âŒ"
        print(f"  {status} {result.name}: {passed}/{checks}")

    print(f"\n  æ€»è®¡: {total_passed}/{total_checks} é€šè¿‡")

    if total_passed == total_checks:
        print("\nğŸ‰ æ‰€æœ‰ç«¯åˆ°ç«¯æµ‹è¯•é€šè¿‡ï¼")
        print("\nğŸ“‹ éªŒè¯ç»“æœ:")
        print("  âœ… é•¿å¯¹è¯ä¸­åŸå§‹ç›®æ ‡ä¿æŒåœ¨ Context ä¸­")
        print("  âœ… Phase 1/2 éƒ½æ­£ç¡®æ³¨å…¥ç¬¬ä¸€æ¡æ¶ˆæ¯")
        print("  âœ… è·¨ Skill åˆ‡æ¢æ—¶ç›®æ ‡ä¸ä¸¢å¤±")
        print("  âœ… Goal Context å¸®åŠ©ç†è§£æ¨¡ç³Šè¯·æ±‚")
        print("  âœ… è¾¹ç•Œæƒ…å†µå¤„ç†æ­£ç¡®")
    else:
        print("\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šé¢çš„è¯¦æƒ…")

    return total_passed == total_checks


if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
