# CoreAgent 原子工具系统设计

> 目标：让 Agent 能自动组合工具完成复杂任务
> 日期: 2026-01-18

---

## 1. 目标场景

让用户能通过自然语言获得涌现能力：

```
场景 1: "帮我找个适合跳槽的月份"
→ Agent 自主组合: get_liunian_transit(2026) + search_db(跳槽时机) + match_cases + 推理

场景 2: "我和 TA 适合吗"
→ Agent 自主组合: get_user_profile + get_partner_info + calculate_synastry + 分析
```

---

## 2. 现有架构分析

**工具注册机制** (已完善):
```
tools.yaml (定义) → ToolRegistry (注册) → @tool_handler (执行)
```

**当前问题**:
| 工具 | 问题 | 影响 |
|------|------|------|
| `show_bazi_fortune` | 计算+展示耦合 | Agent 无法单独获取数据做推理 |
| `calculate_bazi` | 只能算命盘，不能算流年 | 需要年度分析时必须用 show_fortune |
| 无 `get_profile` | Agent 不知道用户已有什么数据 | 无法自主决策 |

---

## 3. 原子工具设计

### 3.1 数据获取类 (compute)

| 工具名 | 功能 | 输出 | 使用场景 |
|--------|------|------|----------|
| `get_user_profile` | 获取用户基本信息 + 命盘摘要 | JSON | Agent 了解用户背景 |
| `get_liunian_transit` | 计算指定年份流年运势 | JSON | 分析年度运势 |
| `get_monthly_transit` | 计算指定月份运势 | JSON | 精确到月的时机分析 |
| `get_current_transit` | 计算当前运势状态 | JSON | 快速了解现状 |
| `calculate_synastry` | 计算两人合盘 | JSON | 关系兼容性分析 |

### 3.2 知识检索类 (search)

| 工具名 | 功能 | 输出 | 使用场景 |
|--------|------|------|----------|
| `search_db` | 通用知识/案例检索 | 文本列表 | 获取专业知识 |
| `match_cases` | 按模式匹配案例 | 案例列表 | 找相似情况参考 |

### 3.3 展示类 (display) - 保持现有

| 工具名 | 功能 | 卡片类型 |
|--------|------|----------|
| `show_bazi_chart` | 展示命盘 | bazi_chart |
| `show_bazi_fortune` | 展示大运流年 | bazi_fortune |
| `show_insight` | 展示洞察卡片 | insight_card |

---

## 4. 实现计划

### Step 1: 新增计算工具 (不展示，纯数据)

**文件**: `apps/api/skills/bazi/tools/tools.yaml`

```yaml
compute:
  - name: get_liunian_transit
    description: |
      计算指定年份的流年运势数据，返回纯数据供 Agent 分析。
      不展示卡片，仅返回计算结果。
      适用于需要分析特定年份或多年份对比的场景。
    parameters:
      - name: year
        type: integer
        required: true
        description: 要分析的年份
    returns:
      type: object
      description: |
        {
          "year": 2026,
          "year_stem": "丙",
          "year_branch": "午",
          "interaction_with_chart": {...},
          "fortune_score": 75,
          "themes": ["事业突破", "贵人运旺"],
          "cautions": ["注意健康"]
        }

  - name: get_monthly_transit
    description: |
      计算指定月份的运势数据，用于精确时机分析。
      例如："适合跳槽的月份" 需要逐月对比。
    parameters:
      - name: year
        type: integer
        required: true
      - name: month
        type: integer
        required: true
        description: 月份 (1-12)
    returns:
      type: object

  - name: get_current_transit
    description: |
      获取当前（今日）的运势状态快照。
      包含今日天干地支、与命盘互动、关键提示。
    returns:
      type: object
```

**文件**: `apps/api/skills/bazi/tools/handlers.py`

```python
@tool_handler("get_liunian_transit")
async def execute_get_liunian_transit(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """计算流年运势（纯数据，不展示）"""
    year = args.get("year", datetime.now().year)
    computer = get_bazi_computer()

    profile = {
        "birth_info": context.profile.get("birth_info", {}),
        "skill_data": context.skill_data,
    }

    # 计算年度运势
    annual = await computer.calculate_annual_fortune(profile, year)

    return {
        "status": "success",
        "year": year,
        "transit": annual,
        # 不包含 cardType，不触发前端展示
    }

@tool_handler("get_monthly_transit")
async def execute_get_monthly_transit(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """计算月度运势（用于时机分析）"""
    year = args.get("year", datetime.now().year)
    month = args.get("month", datetime.now().month)
    computer = get_bazi_computer()

    profile = {
        "birth_info": context.profile.get("birth_info", {}),
        "skill_data": context.skill_data,
    }

    monthly = await computer.calculate_monthly_fortune(profile, year, month)

    return {
        "status": "success",
        "year": year,
        "month": month,
        "transit": monthly,
    }
```

### Step 2: 新增用户数据工具

**文件**: `apps/api/skills/core/tools/tools.yaml`

```yaml
compute:
  - name: get_user_profile
    description: |
      获取当前用户的完整档案摘要，包含：
      - 基本信息（出生时间、性别）
      - 已有的命盘数据（八字、星盘）
      - 提取的洞察（性格特点、关注话题）

      Agent 应在需要了解用户背景时调用此工具。
    returns:
      type: object
      description: |
        {
          "birth_info": {...},
          "bazi_summary": "甲木日主，身旺，正印格",
          "zodiac_summary": "太阳双鱼，月亮天蝎，上升处女",
          "interests": ["事业", "健康"],
          "recent_topics": ["流年运势", "跳槽时机"]
        }

  - name: get_partner_profile
    description: |
      获取对方的档案信息（用于关系分析）。
      如果对方信息不完整，返回 need_info 状态。
    parameters:
      - name: partner_birth_date
        type: string
        required: false
        description: 对方出生日期
      - name: partner_birth_time
        type: string
        required: false
      - name: partner_gender
        type: string
        required: false
```

**文件**: `apps/api/skills/core/tools/handlers.py`

```python
@tool_handler("get_user_profile")
async def execute_get_user_profile(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """获取用户档案摘要"""
    profile = context.profile or {}
    skill_data = context.skill_data or {}

    # 构建摘要
    birth_info = profile.get("birth_info", {})
    bazi_data = skill_data.get("bazi", {})
    zodiac_data = skill_data.get("zodiac", {})
    extracted = profile.get("extracted", {})

    return {
        "status": "success",
        "birth_info": birth_info,
        "bazi_summary": _summarize_bazi(bazi_data),
        "zodiac_summary": _summarize_zodiac(zodiac_data),
        "interests": extracted.get("interests", []),
        "personality": extracted.get("personality", {}),
        "recent_topics": extracted.get("recent_topics", []),
    }

def _summarize_bazi(bazi_data: dict) -> str:
    """生成八字摘要"""
    if not bazi_data.get("chart"):
        return "未计算"
    chart = bazi_data["chart"]
    day_master = chart.get("day_master", {})
    pattern = chart.get("pattern", {})
    return f"{day_master.get('stem', '?')}{day_master.get('element', '?')}日主，{pattern.get('name', '?')}"
```

### Step 3: 新增合盘计算工具

**文件**: `apps/api/skills/zodiac/tools/tools.yaml`

```yaml
compute:
  - name: calculate_synastry
    description: |
      计算两人的星座/八字合盘，返回兼容性分析数据。
      不展示卡片，仅返回计算结果供 Agent 分析。
    parameters:
      - name: partner_birth_date
        type: string
        required: true
      - name: partner_birth_time
        type: string
        required: false
        default: "12:00"
      - name: partner_gender
        type: string
        required: false
    returns:
      type: object
      description: |
        {
          "overall_score": 75,
          "categories": [
            {"name": "性格契合", "score": 80},
            {"name": "沟通默契", "score": 70}
          ],
          "strengths": ["互补性强"],
          "challenges": ["沟通节奏不同"],
          "advice": "..."
        }
```

---

## 5. 修改文件清单

| 文件 | 操作 | 内容 |
|------|------|------|
| `skills/bazi/tools/tools.yaml` | 新增 | get_liunian_transit, get_monthly_transit, get_current_transit |
| `skills/bazi/tools/handlers.py` | 新增 | 对应 handler 函数 |
| `skills/bazi/services/computer.py` | 新增 | calculate_monthly_fortune 方法 |
| `skills/core/tools/tools.yaml` | 新增 | get_user_profile, get_partner_profile |
| `skills/core/tools/handlers.py` | 新增 | 对应 handler 函数 |
| `skills/zodiac/tools/tools.yaml` | 新增 | calculate_synastry |
| `skills/zodiac/tools/handlers.py` | 新增 | 对应 handler 函数 |

---

## 6. 验证方案

### 测试场景 1: 跳槽时机

```python
# tests/test_emergent_tool_calling.py

async def test_job_change_timing():
    """用户问「帮我找个适合跳槽的月份」"""
    agent = CoreAgent()
    response = await agent.run(
        message="帮我找个适合跳槽的月份",
        context=test_user_context
    )

    # 期望 Agent 调用的工具链:
    # 1. get_user_profile() - 了解用户背景
    # 2. get_liunian_transit(2026) - 获取年度数据
    # 3. get_monthly_transit(2026, 1..12) - 逐月分析
    # 4. search_db("跳槽时机 官杀") - 检索知识
    # 5. 推理后调用 show_insight() - 展示结论

    assert "月" in response.content
    assert len(response.tool_calls) >= 3
```

### 测试场景 2: 关系兼容性

```python
async def test_relationship_compatibility():
    """用户问「我和 TA 适合吗」"""
    response = await agent.run(
        message="我和 1992-08-15 出生的 TA 适合吗",
        context=test_user_context
    )

    # 期望工具链:
    # 1. get_user_profile() - 获取自己信息
    # 2. calculate_synastry(partner_birth_date=...) - 合盘计算
    # 3. search_db("合盘 兼容性") - 检索知识
    # 4. show_relationship() - 展示结论
```

---

## 7. 成功标准

| 指标 | 目标 |
|------|------|
| 新增 compute 工具 | 5 个 |
| 涌现场景通过 | 2 个 |
| 工具组合深度 | ≥3 步 |

---

## 8. 待确认问题

1. `calculate_monthly_fortune` 方法是否已存在于 BaziComputer？
2. 是否需要为星座也添加 `get_liunian_transit` 等价工具？
3. 工具描述中是否需要添加「组合提示」引导 LLM？
