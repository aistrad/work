"use client"

import { cn } from "@/lib/utils"
import { useAppStore } from "@/stores/app-store"
import * as Tabs from "@radix-ui/react-tabs"
import { motion } from "framer-motion"
import { useEffect } from "react"
import { OverviewTab } from "./tabs/overview-tab"
import { StatusTab } from "./tabs/status-tab"
import { TrendsTab } from "./tabs/trends-tab"
import { QuestsTab } from "./tabs/quests-tab"
import { RelationsTab } from "./tabs/relations-tab"
import { ExploreTab } from "./tabs/explore-tab"

const TABS = [
  { id: "overview", label: "概览" },
  { id: "status", label: "状态" },
  { id: "trends", label: "趋势" },
  { id: "quests", label: "任务" },
  { id: "relations", label: "关系" },
  { id: "explore", label: "探索" },
] as const

// Tab 标题映射
const TAB_TITLES: Record<string, string> = {
  overview: "概览",
  status: "状态",
  trends: "趋势",
  quests: "任务",
  relations: "关系",
  explore: "探索",
}

export function DashboardZone() {
  const { activeTab, setActiveTab, setSidebarOpen, isMobile } = useAppStore()

  // Listen for tab switch events from A2UI action buttons
  useEffect(() => {
    const handler = (e: Event) => {
      const detail = (e as CustomEvent<{ tab?: string }>).detail
      const tab = detail?.tab
      if (!tab) return
      setSidebarOpen(true)
      setActiveTab(tab as typeof activeTab)
    }
    window.addEventListener("switchTab", handler as EventListener)
    return () => window.removeEventListener("switchTab", handler as EventListener)
  }, [setActiveTab, setSidebarOpen, activeTab])

  // 移动端布局：底部导航已包含 tabs，这里只显示标题和内容
  if (isMobile) {
    return (
      <div className="flex flex-col h-full">
        {/* 移动端顶部标题栏 - 显示当前 tab 名称 */}
        <header
          className={cn(
            "flex items-center justify-center",
            "h-14 px-4 border-b border-border",
            "bg-background"
          )}
        >
          <h1 className="font-semibold text-foreground">
            {TAB_TITLES[activeTab] || "Dashboard"}
          </h1>
        </header>

        {/* Tab 内容 */}
        <div className="flex-1 overflow-y-auto">
          {activeTab === "overview" && <OverviewTab />}
          {activeTab === "status" && <StatusTab />}
          {activeTab === "trends" && <TrendsTab />}
          {activeTab === "quests" && <QuestsTab />}
          {activeTab === "relations" && <RelationsTab />}
          {activeTab === "explore" && <ExploreTab />}
        </div>
      </div>
    )
  }

  // 桌面端布局：保持顶部 tabs 导航
  return (
    <div className="flex flex-col h-full">
      <Tabs.Root
        value={activeTab}
        onValueChange={(value) => setActiveTab(value as typeof activeTab)}
        className="flex flex-col h-full"
      >
        {/* Tab 导航 */}
        <Tabs.List
          className={cn(
            "flex items-center gap-1 px-4",
            "h-12 border-b border-border",
            "bg-sidebar overflow-x-auto",
            "scrollbar-none" // 隐藏滚动条
          )}
        >
          {TABS.map((tab) => (
            <Tabs.Trigger
              key={tab.id}
              value={tab.id}
              className={cn(
                "relative px-3 py-2 text-sm font-medium",
                "text-muted-foreground hover:text-foreground",
                "transition-colors whitespace-nowrap",
                "data-[state=active]:text-foreground"
              )}
            >
              {tab.label}
              {/* 底部指示器 */}
              {activeTab === tab.id && (
                <motion.div
                  layoutId="tab-indicator"
                  className="absolute bottom-0 left-0 right-0 h-0.5 bg-foreground"
                  transition={{ type: "spring", stiffness: 500, damping: 30 }}
                />
              )}
            </Tabs.Trigger>
          ))}
        </Tabs.List>

        {/* Tab 内容 - 限制最大宽度并居中 */}
        <div className="flex-1 overflow-y-auto">
          <div className="max-w-3xl mx-auto">
            <Tabs.Content value="overview" className="h-full">
              <OverviewTab />
            </Tabs.Content>
            <Tabs.Content value="status" className="h-full">
              <StatusTab />
            </Tabs.Content>
            <Tabs.Content value="trends" className="h-full">
              <TrendsTab />
            </Tabs.Content>
            <Tabs.Content value="quests" className="h-full">
              <QuestsTab />
            </Tabs.Content>
            <Tabs.Content value="relations" className="h-full">
              <RelationsTab />
            </Tabs.Content>
            <Tabs.Content value="explore" className="h-full">
              <ExploreTab />
            </Tabs.Content>
          </div>
        </div>
      </Tabs.Root>
    </div>
  )
}
