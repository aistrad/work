"use client"

import { useState, useEffect, useCallback } from "react"
import { useRouter } from "next/navigation"
import { cn } from "@/lib/utils"
import { useAppStore } from "@/stores/app-store"
import * as api from "@/lib/api"

// Collapsible section component
function SettingsSection({
  icon,
  title,
  children,
  defaultOpen = false,
}: {
  icon: string
  title: string
  children: React.ReactNode
  defaultOpen?: boolean
}) {
  const [isOpen, setIsOpen] = useState(defaultOpen)

  return (
    <section className="border border-border rounded-lg overflow-hidden">
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className={cn(
          "w-full flex items-center justify-between px-4 py-3",
          "bg-sidebar hover:bg-sidebar/80 transition-colors",
          "text-left"
        )}
      >
        <span className="flex items-center gap-2 font-medium text-foreground">
          <span>{icon}</span>
          <span>{title}</span>
        </span>
        <ChevronIcon className={cn("w-5 h-5 text-muted-foreground transition-transform", isOpen && "rotate-180")} />
      </button>
      {isOpen && (
        <div className="p-4 border-t border-border bg-background space-y-4">
          {children}
        </div>
      )}
    </section>
  )
}

// Form field components
function TextField({
  label,
  value,
  onChange,
  placeholder,
  disabled,
}: {
  label: string
  value: string
  onChange: (value: string) => void
  placeholder?: string
  disabled?: boolean
}) {
  return (
    <div className="space-y-1">
      <label className="text-sm text-muted-foreground">{label}</label>
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        disabled={disabled}
        className={cn(
          "w-full px-3 py-2 rounded-lg",
          "bg-sidebar border border-border",
          "text-foreground placeholder:text-muted-foreground",
          "focus:outline-none focus:ring-2 focus:ring-foreground/20",
          "disabled:opacity-50 disabled:cursor-not-allowed"
        )}
      />
    </div>
  )
}

function SelectField({
  label,
  value,
  onChange,
  options,
  description,
}: {
  label: string
  value: string
  onChange: (value: string) => void
  options: { value: string; label: string; desc?: string }[]
  description?: string
}) {
  return (
    <div className="space-y-1">
      <label className="text-sm text-muted-foreground">{label}</label>
      {description && <p className="text-xs text-muted-foreground/70">{description}</p>}
      <select
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className={cn(
          "w-full px-3 py-2 rounded-lg",
          "bg-sidebar border border-border",
          "text-foreground",
          "focus:outline-none focus:ring-2 focus:ring-foreground/20"
        )}
      >
        {options.map((opt) => (
          <option key={opt.value} value={opt.value}>
            {opt.label}{opt.desc ? ` - ${opt.desc}` : ''}
          </option>
        ))}
      </select>
    </div>
  )
}

function RadioGroup({
  label,
  value,
  onChange,
  options,
}: {
  label?: string
  value: string
  onChange: (value: string) => void
  options: { value: string; label: string; desc?: string }[]
}) {
  return (
    <div className="space-y-2">
      {label && <label className="text-sm text-muted-foreground">{label}</label>}
      <div className="space-y-2">
        {options.map((opt) => (
          <label
            key={opt.value}
            className={cn(
              "flex items-start gap-3 p-3 rounded-lg cursor-pointer",
              "border transition-colors",
              value === opt.value
                ? "border-foreground/30 bg-foreground/5"
                : "border-border hover:border-foreground/20"
            )}
          >
            <input
              type="radio"
              name={label}
              value={opt.value}
              checked={value === opt.value}
              onChange={() => onChange(opt.value)}
              className="mt-0.5"
            />
            <div>
              <span className="font-medium text-foreground">{opt.label}</span>
              {opt.desc && <p className="text-sm text-muted-foreground">{opt.desc}</p>}
            </div>
          </label>
        ))}
      </div>
    </div>
  )
}

function ToggleField({
  label,
  description,
  value,
  onChange,
}: {
  label: string
  description?: string
  value: boolean
  onChange: (value: boolean) => void
}) {
  return (
    <div className="flex items-center justify-between">
      <div>
        <p className="font-medium text-foreground">{label}</p>
        {description && <p className="text-sm text-muted-foreground">{description}</p>}
      </div>
      <button
        type="button"
        onClick={() => onChange(!value)}
        className={cn(
          "relative w-11 h-6 rounded-full transition-colors",
          value ? "bg-foreground" : "bg-border"
        )}
      >
        <span
          className={cn(
            "absolute top-0.5 w-5 h-5 rounded-full bg-background transition-transform",
            value ? "left-5.5 translate-x-0" : "left-0.5"
          )}
          style={{ left: value ? "calc(100% - 22px)" : "2px" }}
        />
      </button>
    </div>
  )
}

export function SettingsTab() {
  const router = useRouter()
  const { chatBackend, updateChatBackend } = useAppStore()

  // User info & preferences state
  const [userInfo, setUserInfo] = useState<api.UserInfo | null>(null)
  const [preferences, setPreferences] = useState<api.UserPreferences | null>(null)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [isLoggingOut, setIsLoggingOut] = useState(false)

  // Editable profile fields (for future extension)
  const [editName, setEditName] = useState("")

  // Load user data on mount
  useEffect(() => {
    Promise.all([
      api.fetchMe().catch(() => null),
      api.fetchPreferences().catch(() => null),
    ]).then(([user, prefs]) => {
      setUserInfo(user)
      setPreferences(prefs)
      if (user) setEditName(user.name)
      setLoading(false)
    })
  }, [])

  // Save preferences
  const savePreferences = useCallback(async (patch: Partial<api.UserPreferences>) => {
    setSaving(true)
    try {
      await api.updatePreferences(patch)
      setPreferences((prev) => prev ? { ...prev, ...patch } : null)
    } catch (err) {
      console.error("Failed to save preferences:", err)
    } finally {
      setSaving(false)
    }
  }, [])

  // Handle logout
  const handleLogout = async () => {
    setIsLoggingOut(true)
    try {
      await api.logout()
      router.push("/login")
    } catch (err) {
      console.error("Logout failed:", err)
      router.push("/login")
    }
  }

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <p className="text-muted-foreground">åŠ è½½ä¸­...</p>
      </div>
    )
  }

  return (
    <div className="p-6 space-y-4">
      {/* Header with save indicator */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-foreground">è®¾ç½®</h1>
        {saving && (
          <span className="text-sm text-muted-foreground">ä¿å­˜ä¸­...</span>
        )}
      </div>

      {/* Profile Section */}
      <SettingsSection icon="ğŸ“‹" title="ä¸ªäººèµ„æ–™" defaultOpen>
        {userInfo ? (
          <div className="space-y-4">
            {/* Avatar placeholder + basic info */}
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 rounded-full bg-sidebar border border-border flex items-center justify-center text-2xl">
                ğŸ‘¤
              </div>
              <div>
                <p className="font-medium text-foreground">{userInfo.name}</p>
                <p className="text-sm text-muted-foreground">{userInfo.email}</p>
              </div>
            </div>

            <TextField
              label="æ˜µç§°"
              value={editName}
              onChange={setEditName}
              placeholder="æ‚¨çš„æ˜µç§°"
              disabled
            />

            {/* Birth info - read only for now */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-1">
                <label className="text-sm text-muted-foreground">å‡ºç”Ÿæ—¥æœŸ</label>
                <p className="px-3 py-2 rounded-lg bg-sidebar border border-border text-foreground text-sm">
                  --
                </p>
              </div>
              <div className="space-y-1">
                <label className="text-sm text-muted-foreground">å‡ºç”Ÿåœ°ç‚¹</label>
                <p className="px-3 py-2 rounded-lg bg-sidebar border border-border text-foreground text-sm">
                  --
                </p>
              </div>
            </div>
          </div>
        ) : (
          <p className="text-muted-foreground">æ— æ³•åŠ è½½ç”¨æˆ·ä¿¡æ¯</p>
        )}
      </SettingsSection>

      {/* AI Engine Section */}
      <SettingsSection icon="ğŸ¤–" title="AI å¼•æ“">
        <RadioGroup
          label="å¯¹è¯åç«¯"
          value={chatBackend}
          onChange={(v) => {
            updateChatBackend(v as api.ChatBackend)
            savePreferences({ chat_backend: v as api.ChatBackend })
          }}
          options={[
            { value: "agent_service", label: "Vercel Agent", desc: "å¤šåŠŸèƒ½ Â· å·¥å…·è°ƒç”¨" },
            { value: "fastapi", label: "GLM ç›´è¿", desc: "ä½å»¶è¿Ÿ Â· ç®€å•å¯¹è¯" },
          ]}
        />

        <SelectField
          label="GLM æ¨¡å‹"
          value="glm-4.7"
          onChange={() => {}}
          description="ç”¨äºå¯¹è¯å’ŒæŠ¥å‘Šç”Ÿæˆ"
          options={[
            { value: "glm-4", label: "GLM-4", desc: "åŸºç¡€ç‰ˆ" },
            { value: "glm-4.7", label: "GLM-4.7", desc: "æ¨è" },
            { value: "glm-4-flash", label: "GLM-4-Flash", desc: "å¿«é€Ÿç‰ˆ" },
          ]}
        />

        <SelectField
          label="æŠ¥å‘Šåç«¯"
          value="glm"
          onChange={() => {}}
          description="ç”¨äºç”Ÿæˆæ·±åº¦æŠ¥å‘Š"
          options={[
            { value: "glm", label: "GLM", desc: "ä¸­æ–‡ä¼˜åŒ–ï¼Œæ¨è" },
            { value: "gemini", label: "Gemini CLI", desc: "å¤šæ¨¡æ€æ”¯æŒ" },
            { value: "claude", label: "Claude CLI", desc: "æ·±åº¦åˆ†æ" },
          ]}
        />
      </SettingsSection>

      {/* Persona Section */}
      <SettingsSection icon="ğŸ’¬" title="æ•™ç»ƒé£æ ¼">
        <RadioGroup
          value={preferences?.persona_style || "warm"}
          onChange={(v) => savePreferences({ persona_style: v as "standard" | "warm" | "roast" })}
          options={[
            { value: "standard", label: "ä¸“ä¸šç†æ€§", desc: "å®¢è§‚åˆ†æï¼Œç†æ€§å»ºè®®" },
            { value: "warm", label: "æ¸©æš–é™ªä¼´", desc: "å…±æƒ…é™ªä¼´ï¼Œæ¸©å’Œé¼“åŠ±" },
            { value: "roast", label: "æ¯’èˆŒæ¿€åŠ±", desc: "çŠ€åˆ©åæ§½ï¼Œåå‘æ¿€åŠ±" },
          ]}
        />
      </SettingsSection>

      {/* Push Notifications Section */}
      <SettingsSection icon="ğŸ””" title="æ¨é€é€šçŸ¥">
        <ToggleField
          label="å¯ç”¨æ¨é€"
          description="æ¥æ”¶æ¯æ—¥æé†’å’ŒçŠ¶æ€æ›´æ–°"
          value={preferences?.push_enabled ?? true}
          onChange={(v) => savePreferences({ push_enabled: v })}
        />

        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-1">
            <label className="text-sm text-muted-foreground">æ¨é€æ—¶é—´</label>
            <input
              type="time"
              value={preferences?.push_time?.slice(0, 5) || "08:00"}
              onChange={(e) => savePreferences({ push_time: e.target.value + ":00" })}
              className={cn(
                "w-full px-3 py-2 rounded-lg",
                "bg-sidebar border border-border",
                "text-foreground",
                "focus:outline-none focus:ring-2 focus:ring-foreground/20"
              )}
            />
          </div>
        </div>

        <div className="space-y-1">
          <label className="text-sm text-muted-foreground">å…æ‰“æ‰°æ—¶æ®µ</label>
          <div className="flex items-center gap-2">
            <input
              type="time"
              value={preferences?.quiet_hours_start?.slice(0, 5) || "22:00"}
              onChange={(e) => savePreferences({ quiet_hours_start: e.target.value + ":00" })}
              className={cn(
                "flex-1 px-3 py-2 rounded-lg",
                "bg-sidebar border border-border",
                "text-foreground",
                "focus:outline-none focus:ring-2 focus:ring-foreground/20"
              )}
            />
            <span className="text-muted-foreground">è‡³</span>
            <input
              type="time"
              value={preferences?.quiet_hours_end?.slice(0, 5) || "07:00"}
              onChange={(e) => savePreferences({ quiet_hours_end: e.target.value + ":00" })}
              className={cn(
                "flex-1 px-3 py-2 rounded-lg",
                "bg-sidebar border border-border",
                "text-foreground",
                "focus:outline-none focus:ring-2 focus:ring-foreground/20"
              )}
            />
          </div>
        </div>
      </SettingsSection>

      {/* Appearance Section */}
      <SettingsSection icon="ğŸ¨" title="å¤–è§‚">
        <RadioGroup
          label="ä¸»é¢˜"
          value="dark"
          onChange={() => {}}
          options={[
            { value: "dark", label: "æš—è‰²" },
            { value: "light", label: "äº®è‰²" },
            { value: "system", label: "è·Ÿéšç³»ç»Ÿ" },
          ]}
        />

        <SelectField
          label="è¯­è¨€"
          value="zh-CN"
          onChange={() => {}}
          options={[
            { value: "zh-CN", label: "ç®€ä½“ä¸­æ–‡" },
            { value: "en-US", label: "English" },
          ]}
        />
      </SettingsSection>

      {/* Account Security Section */}
      <SettingsSection icon="ğŸ”" title="è´¦æˆ·å®‰å…¨">
        <div className="space-y-3">
          <button
            type="button"
            className={cn(
              "w-full py-2 px-4 rounded-lg text-left",
              "bg-sidebar border border-border",
              "text-foreground hover:bg-sidebar/80 transition-colors"
            )}
          >
            ä¿®æ”¹å¯†ç 
          </button>

          <button
            type="button"
            className={cn(
              "w-full py-2 px-4 rounded-lg text-left",
              "bg-sidebar border border-border",
              "text-foreground hover:bg-sidebar/80 transition-colors"
            )}
          >
            å¯¼å‡ºæ•°æ®
          </button>

          <button
            type="button"
            onClick={handleLogout}
            disabled={isLoggingOut}
            className={cn(
              "w-full py-2 px-4 rounded-lg",
              "bg-destructive/10 text-destructive",
              "font-medium text-center",
              "hover:bg-destructive/20 transition-colors",
              "disabled:opacity-50 disabled:cursor-not-allowed"
            )}
          >
            {isLoggingOut ? "é€€å‡ºä¸­..." : "é€€å‡ºç™»å½•"}
          </button>
        </div>
      </SettingsSection>

      {/* Version Info */}
      <div className="pt-4 text-center">
        <p className="text-sm text-muted-foreground">
          Fortune AI v1.0.0
        </p>
      </div>
    </div>
  )
}

// Chevron icon for collapsible sections
function ChevronIcon({ className }: { className?: string }) {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      className={className}
    >
      <path d="m6 9 6 6 6-6" />
    </svg>
  )
}
