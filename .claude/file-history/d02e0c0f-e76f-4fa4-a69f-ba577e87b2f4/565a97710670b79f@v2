"""
Usage Service 测试
测试用量统计与计费服务

覆盖场景:
- 记录 LLM 调用
- 记录 Skill 使用
- 记录 Tool 调用
- 计费汇总
- 成本估算
"""

import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from uuid import UUID
from datetime import date, datetime

pytestmark = pytest.mark.asyncio


# ═══════════════════════════════════════════════════════════════════════════
# Test Fixtures
# ═══════════════════════════════════════════════════════════════════════════

@pytest.fixture
def sample_user_id():
    """示例用户 ID"""
    return UUID("550e8400-e29b-41d4-a716-446655440000")


@pytest.fixture
def mock_db_pool():
    """模拟数据库连接池"""
    pool = AsyncMock()
    pool.execute = AsyncMock()
    pool.fetch = AsyncMock(return_value=[])
    pool.fetchrow = AsyncMock(return_value=None)
    return pool


# ═══════════════════════════════════════════════════════════════════════════
# Cost Estimation Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestCostEstimation:
    """成本估算测试"""

    def test_estimate_cost_deepseek(self):
        """测试 DeepSeek 模型成本估算"""
        from services.usage.service import UsageService

        # deepseek-chat: input=0.14, output=0.28 per 1M tokens
        cost = UsageService._estimate_cost("deepseek-chat", 1_000_000, 500_000)

        # 1M * 0.14 + 0.5M * 0.28 = 0.14 + 0.14 = 0.28
        assert cost == pytest.approx(0.28, rel=1e-3)

    def test_estimate_cost_glm_flash(self):
        """测试 GLM Flash 模型成本估算"""
        from services.usage.service import UsageService

        # glm-4-flash: input=0.1, output=0.1 per 1M tokens
        cost = UsageService._estimate_cost("glm-4-flash", 100_000, 50_000)

        # 0.1M * 0.1 + 0.05M * 0.1 = 0.01 + 0.005 = 0.015
        assert cost == pytest.approx(0.015, rel=1e-3)

    def test_estimate_cost_claude_sonnet(self):
        """测试 Claude Sonnet 成本估算"""
        from services.usage.service import UsageService

        # claude-sonnet: input=3.0, output=15.0 per 1M tokens
        cost = UsageService._estimate_cost("claude-3-5-sonnet-20241022", 10_000, 5_000)

        # 0.01M * 3.0 + 0.005M * 15.0 = 0.03 + 0.075 = 0.105
        assert cost == pytest.approx(0.105, rel=1e-3)

    def test_estimate_cost_unknown_model_uses_default(self):
        """测试未知模型使用默认定价"""
        from services.usage.service import UsageService

        # unknown model should use default: input=0.1, output=0.1
        cost = UsageService._estimate_cost("unknown-model-xyz", 1_000_000, 1_000_000)

        # 1M * 0.1 + 1M * 0.1 = 0.1 + 0.1 = 0.2
        assert cost == pytest.approx(0.2, rel=1e-3)

    def test_estimate_cost_zero_tokens(self):
        """测试零 token 成本"""
        from services.usage.service import UsageService

        cost = UsageService._estimate_cost("deepseek-chat", 0, 0)

        assert cost == 0.0

    def test_estimate_cost_partial_model_name_match(self):
        """测试部分模型名匹配"""
        from services.usage.service import UsageService

        # 模型名包含 "gemini-flash"
        cost = UsageService._estimate_cost("gemini-2.0-flash-exp", 1_000_000, 1_000_000)

        # gemini-flash: input=0.075, output=0.3 per 1M tokens
        assert cost == pytest.approx(0.375, rel=1e-3)


# ═══════════════════════════════════════════════════════════════════════════
# Record LLM Call Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestRecordLLMCall:
    """记录 LLM 调用测试"""

    async def test_record_llm_call_success(self, sample_user_id, mock_db_pool):
        """测试成功记录 LLM 调用"""
        from services.usage.service import UsageService

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            await UsageService.record_llm_call(
                user_id=sample_user_id,
                model="deepseek-chat",
                input_tokens=1000,
                output_tokens=500,
                skill_id="bazi"
            )

            mock_db_pool.execute.assert_called_once()
            # 验证 SQL 包含正确的表和字段
            call_args = mock_db_pool.execute.call_args
            assert "usage_events" in call_args[0][0]
            assert "llm_call" in call_args[0][0]

    async def test_record_llm_call_with_conversation_id(self, sample_user_id, mock_db_pool):
        """测试记录带会话 ID 的 LLM 调用"""
        from services.usage.service import UsageService

        conversation_id = UUID("660e8400-e29b-41d4-a716-446655440001")

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            await UsageService.record_llm_call(
                user_id=sample_user_id,
                model="glm-4-flash",
                input_tokens=500,
                output_tokens=200,
                conversation_id=conversation_id
            )

            mock_db_pool.execute.assert_called_once()

    async def test_record_llm_call_db_error_handled(self, sample_user_id, mock_db_pool):
        """测试数据库错误被优雅处理"""
        from services.usage.service import UsageService

        mock_db_pool.execute.side_effect = Exception("DB connection failed")

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            # 不应抛出异常
            await UsageService.record_llm_call(
                user_id=sample_user_id,
                model="deepseek-chat",
                input_tokens=1000,
                output_tokens=500
            )


# ═══════════════════════════════════════════════════════════════════════════
# Record Skill Use Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestRecordSkillUse:
    """记录 Skill 使用测试"""

    async def test_record_skill_use_success(self, sample_user_id, mock_db_pool):
        """测试成功记录 Skill 使用"""
        from services.usage.service import UsageService

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            await UsageService.record_skill_use(
                user_id=sample_user_id,
                skill_id="zodiac"
            )

            mock_db_pool.execute.assert_called_once()
            call_args = mock_db_pool.execute.call_args
            assert "skill_use" in call_args[0][0]

    async def test_record_skill_use_db_error_handled(self, sample_user_id, mock_db_pool):
        """测试 Skill 使用记录数据库错误处理"""
        from services.usage.service import UsageService

        mock_db_pool.execute.side_effect = Exception("DB error")

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            # 不应抛出异常
            await UsageService.record_skill_use(
                user_id=sample_user_id,
                skill_id="tarot"
            )


# ═══════════════════════════════════════════════════════════════════════════
# Record Tool Call Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestRecordToolCall:
    """记录 Tool 调用测试"""

    async def test_record_tool_call_success(self, sample_user_id, mock_db_pool):
        """测试成功记录 Tool 调用"""
        from services.usage.service import UsageService

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            await UsageService.record_tool_call(
                user_id=sample_user_id,
                tool_name="show_bazi_chart",
                skill_id="bazi"
            )

            mock_db_pool.execute.assert_called_once()
            call_args = mock_db_pool.execute.call_args
            assert "tool_call" in call_args[0][0]

    async def test_record_tool_call_without_skill(self, sample_user_id, mock_db_pool):
        """测试记录无 Skill 的 Tool 调用"""
        from services.usage.service import UsageService

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            await UsageService.record_tool_call(
                user_id=sample_user_id,
                tool_name="search_db"
            )

            mock_db_pool.execute.assert_called_once()


# ═══════════════════════════════════════════════════════════════════════════
# Billing Summary Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestBillingSummary:
    """计费汇总测试"""

    async def test_get_billing_summary(self, sample_user_id, mock_db_pool):
        """测试获取计费汇总"""
        from services.usage.service import UsageService

        mock_db_pool.fetchrow.return_value = {
            "llm_calls": 100,
            "total_input_tokens": 50000,
            "total_output_tokens": 25000,
            "total_cost": 0.5,
            "skill_uses": 20,
            "tool_calls": 15,
            "conversations": 30
        }

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            result = await UsageService.get_billing_summary(
                user_id=sample_user_id,
                start_date=date(2026, 1, 1),
                end_date=date(2026, 1, 31)
            )

            assert result["llm_calls"] == 100
            assert result["total_input_tokens"] == 50000
            assert result["total_output_tokens"] == 25000
            assert result["total_tokens"] == 75000
            assert result["total_cost"] == 0.5
            assert result["skill_uses"] == 20
            assert result["tool_calls"] == 15
            assert result["conversations"] == 30


# ═══════════════════════════════════════════════════════════════════════════
# Usage By Skill Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestUsageBySkill:
    """按 Skill 统计用量测试"""

    async def test_get_usage_by_skill(self, sample_user_id, mock_db_pool):
        """测试按 Skill 获取用量"""
        from services.usage.service import UsageService

        mock_db_pool.fetch.return_value = [
            {"skill_id": "bazi", "llm_calls": 50, "skill_uses": 10, "tool_calls": 5, "tokens": 30000, "cost": 0.3},
            {"skill_id": "zodiac", "llm_calls": 30, "skill_uses": 5, "tool_calls": 3, "tokens": 15000, "cost": 0.15}
        ]

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            result = await UsageService.get_usage_by_skill(
                user_id=sample_user_id,
                month=date(2026, 1, 1)
            )

            assert len(result) == 2
            assert result[0]["skill_id"] == "bazi"
            assert result[0]["llm_calls"] == 50
            assert result[1]["skill_id"] == "zodiac"


# ═══════════════════════════════════════════════════════════════════════════
# Usage By Model Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestUsageByModel:
    """按模型统计用量测试"""

    async def test_get_usage_by_model(self, sample_user_id, mock_db_pool):
        """测试按模型获取用量"""
        from services.usage.service import UsageService

        mock_db_pool.fetch.return_value = [
            {"model": "deepseek-chat", "calls": 80, "input_tokens": 40000, "output_tokens": 20000, "cost": 0.2},
            {"model": "glm-4-flash", "calls": 20, "input_tokens": 10000, "output_tokens": 5000, "cost": 0.015}
        ]

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            result = await UsageService.get_usage_by_model(
                user_id=sample_user_id,
                month=date(2026, 1, 1)
            )

            assert len(result) == 2
            assert result[0]["model"] == "deepseek-chat"
            assert result[0]["calls"] == 80


# ═══════════════════════════════════════════════════════════════════════════
# Daily Usage Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestDailyUsage:
    """每日用量测试"""

    async def test_get_daily_usage(self, sample_user_id, mock_db_pool):
        """测试获取今日用量"""
        from services.usage.service import UsageService

        mock_db_pool.fetchrow.return_value = {
            "llm_calls": 10,
            "conversations": 5,
            "tokens": 5000,
            "cost": 0.05
        }

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            result = await UsageService.get_daily_usage(sample_user_id)

            assert result["llm_calls"] == 10
            assert result["conversations"] == 5
            assert result["tokens"] == 5000
            assert result["cost"] == 0.05


# ═══════════════════════════════════════════════════════════════════════════
# Monthly Usage Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestMonthlyUsage:
    """月度用量测试"""

    async def test_get_monthly_usage(self, sample_user_id, mock_db_pool):
        """测试获取本月用量"""
        from services.usage.service import UsageService

        mock_db_pool.fetchrow.return_value = {
            "llm_calls": 200,
            "conversations": 50,
            "tokens": 100000,
            "cost": 1.0
        }

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            result = await UsageService.get_monthly_usage(sample_user_id)

            assert result["llm_calls"] == 200
            assert result["conversations"] == 50
            assert result["tokens"] == 100000
            assert result["cost"] == 1.0


# ═══════════════════════════════════════════════════════════════════════════
# Backward Compatibility Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestBackwardCompatibility:
    """向后兼容性测试"""

    async def test_record_usage_legacy(self, sample_user_id, mock_db_pool):
        """测试旧版 record_usage 方法"""
        from services.usage.service import UsageService

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            await UsageService.record_usage(
                user_id=sample_user_id,
                usage_type="conversation",
                metadata={"skill": "bazi"}
            )

            mock_db_pool.execute.assert_called_once()

    async def test_record_conversation_legacy(self, sample_user_id, mock_db_pool):
        """测试旧版 record_conversation 方法"""
        from services.usage.service import UsageService

        with patch("services.usage.service.get_db_pool", return_value=mock_db_pool):
            await UsageService.record_conversation(
                user_id=sample_user_id,
                skill_id="zodiac"
            )

            mock_db_pool.execute.assert_called_once()
            call_args = mock_db_pool.execute.call_args
            assert "conversation" in call_args[0][0]


# ═══════════════════════════════════════════════════════════════════════════
# Model Pricing Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestModelPricing:
    """模型定价测试"""

    def test_model_pricing_has_required_models(self):
        """测试定价表包含必需的模型"""
        from services.usage.service import MODEL_PRICING

        required_models = ["glm-4-flash", "deepseek-chat", "claude-sonnet", "default"]

        for model in required_models:
            assert model in MODEL_PRICING, f"Missing required model: {model}"

    def test_model_pricing_format(self):
        """测试定价格式正确"""
        from services.usage.service import MODEL_PRICING

        for model, pricing in MODEL_PRICING.items():
            assert "input" in pricing, f"Missing 'input' price for {model}"
            assert "output" in pricing, f"Missing 'output' price for {model}"
            assert pricing["input"] >= 0, f"Invalid input price for {model}"
            assert pricing["output"] >= 0, f"Invalid output price for {model}"
