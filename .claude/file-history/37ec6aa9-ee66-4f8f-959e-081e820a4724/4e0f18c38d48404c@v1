#!/usr/bin/env python3
"""
Protocol å‰ç«¯é›†æˆæµ‹è¯•
éªŒè¯å¡ç‰‡æ˜¯å¦èƒ½åœ¨å‰ç«¯æ­£å¸¸æ¸²æŸ“
"""

import asyncio
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from skills.lifecoach.tools.handlers import (
    show_protocol_progress,
    show_protocol_step,
    show_protocol_completion
)
from services.agent.tool_registry import ToolContext


async def test_card_data_format():
    """æµ‹è¯•å¡ç‰‡æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆå‰ç«¯é¢„æœŸ"""
    print("\n" + "="*80)
    print("æµ‹è¯• 1: å¡ç‰‡æ•°æ®æ ¼å¼éªŒè¯")
    print("="*80)

    context = ToolContext(
        user_id="test_user",
        conversation_id="test_conv",
        skill_id="lifecoach"
    )

    # æµ‹è¯•è¿›åº¦å¡ç‰‡
    progress_result = await show_protocol_progress({
        "protocol_id": "dankoe_vision",
        "protocol_name": "æ„¿æ™¯è®¾è®¡åè®®",
        "step": 3,
        "total": 8,
        "phase": "Phase 1",
        "phase_name": "å‹¾å‹’æ„¿æ™¯ç”»é¢",
        "is_completed": False
    }, context)

    # éªŒè¯å¿…éœ€å­—æ®µ
    assert progress_result["card_type"] == "protocol_progress", "card_type é”™è¯¯"
    assert "data" in progress_result, "ç¼ºå°‘ data å­—æ®µ"
    assert "protocol_name" in progress_result["data"], "ç¼ºå°‘ protocol_name"
    assert "step" in progress_result["data"], "ç¼ºå°‘ step"
    assert "total" in progress_result["data"], "ç¼ºå°‘ total"
    assert "generated_at" in progress_result["data"], "ç¼ºå°‘ generated_at"

    print("âœ… è¿›åº¦å¡ç‰‡æ•°æ®æ ¼å¼æ­£ç¡®")

    # æµ‹è¯•æ­¥éª¤å¡ç‰‡
    step_result = await show_protocol_step({
        "step_number": 1,
        "step_name": "æç»˜ç†æƒ³åœºæ™¯",
        "content": "é—­ä¸Šçœ¼ç›ï¼Œæƒ³è±¡3å¹´å...",
        "is_question": True,
        "options": [
            {"key": "yes", "label": "æ˜¯çš„"}
        ]
    }, context)

    assert step_result["card_type"] == "protocol_step", "card_type é”™è¯¯"
    assert step_result["data"]["is_question"] == True, "is_question é”™è¯¯"
    assert len(step_result["data"]["options"]) == 1, "options é”™è¯¯"

    print("âœ… æ­¥éª¤å¡ç‰‡æ•°æ®æ ¼å¼æ­£ç¡®")

    # æµ‹è¯•å®Œæˆå¡ç‰‡
    completion_result = await show_protocol_completion({
        "protocol_name": "æ„¿æ™¯è®¾è®¡åè®®",
        "completed_steps": 8,
        "total_steps": 8,
        "summary": "åè®®å·²å®Œæˆ",
        "next_actions": ["ä¸‹ä¸€æ­¥1", "ä¸‹ä¸€æ­¥2"]
    }, context)

    assert completion_result["card_type"] == "protocol_completion", "card_type é”™è¯¯"
    assert completion_result["data"]["completed_steps"] == 8, "completed_steps é”™è¯¯"
    assert len(completion_result["data"]["next_actions"]) == 2, "next_actions é”™è¯¯"

    print("âœ… å®Œæˆå¡ç‰‡æ•°æ®æ ¼å¼æ­£ç¡®")

    return True


async def test_card_type_registration():
    """æµ‹è¯•å¡ç‰‡ç±»å‹æ˜¯å¦åœ¨ CardRegistry ä¸­æ³¨å†Œ"""
    print("\n" + "="*80)
    print("æµ‹è¯• 2: CardRegistry æ³¨å†ŒéªŒè¯")
    print("="*80)

    # è¿™ä¸ªæµ‹è¯•éœ€è¦å‰ç«¯è¿è¡Œï¼Œè¿™é‡Œåªèƒ½æ£€æŸ¥åç«¯è¿”å›çš„ card_type
    expected_types = [
        "protocol_progress",
        "protocol_step",
        "protocol_completion"
    ]

    print(f"é¢„æœŸçš„å¡ç‰‡ç±»å‹: {expected_types}")
    print("âš ï¸  éœ€è¦åœ¨æµè§ˆå™¨ä¸­éªŒè¯è¿™äº›ç±»å‹æ˜¯å¦å·²æ³¨å†Œåˆ° CardRegistry")
    print("   æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œè¿è¡Œ:")
    print("   CardRegistry.getTypes()")

    return True


async def generate_frontend_test_html():
    """ç”Ÿæˆå‰ç«¯æµ‹è¯•é¡µé¢"""
    print("\n" + "="*80)
    print("ç”Ÿæˆå‰ç«¯æµ‹è¯•é¡µé¢")
    print("="*80)

    html = """<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Protocol å¡ç‰‡å‰ç«¯é›†æˆæµ‹è¯•</title>
    <script>
        // æ¨¡æ‹Ÿ AI SDK çš„ tool call è¿”å›æ•°æ®
        const mockToolCalls = [
            {
                name: "show_protocol_progress",
                result: {
                    card_type: "protocol_progress",
                    data: {
                        protocol_id: "dankoe_vision",
                        protocol_name: "æ„¿æ™¯è®¾è®¡åè®®",
                        step: 3,
                        total: 8,
                        phase: "Phase 1",
                        phase_name: "å‹¾å‹’æ„¿æ™¯ç”»é¢",
                        is_completed: false,
                        generated_at: new Date().toISOString()
                    }
                }
            },
            {
                name: "show_protocol_step",
                result: {
                    card_type: "protocol_step",
                    data: {
                        step_number: 1,
                        step_name: "æç»˜ç†æƒ³åœºæ™¯",
                        content: "é—­ä¸Šçœ¼ç›ï¼Œæƒ³è±¡3å¹´åçš„ä¸€ä¸ªæ™®é€šå‘¨äºŒ...\\n\\nä½ åœ¨å“ªé‡Œï¼Ÿå‘¨å›´æ˜¯ä»€ä¹ˆæ ·çš„ç¯å¢ƒï¼Ÿ",
                        is_question: false,
                        generated_at: new Date().toISOString()
                    }
                }
            },
            {
                name: "show_protocol_completion",
                result: {
                    card_type: "protocol_completion",
                    data: {
                        protocol_name: "æ„¿æ™¯è®¾è®¡åè®®",
                        completed_steps: 8,
                        total_steps: 8,
                        summary: "æ­å–œï¼ä½ å·²ç»å®Œæˆäº†æ„¿æ™¯è®¾è®¡åè®®ã€‚",
                        next_actions: [
                            "è®¾å®šä¸€å¹´ç›®æ ‡ï¼ˆä¸»çº¿ä»»åŠ¡ï¼‰",
                            "è®¾è®¡æœ¬æœˆé¡¹ç›®ï¼ˆBossæˆ˜ï¼‰"
                        ],
                        generated_at: new Date().toISOString()
                    }
                }
            }
        ];

        function testCardRegistry() {
            console.log("ğŸ§ª æµ‹è¯• CardRegistry");

            // æ£€æŸ¥ CardRegistry æ˜¯å¦å­˜åœ¨
            if (typeof CardRegistry === "undefined") {
                console.error("âŒ CardRegistry æœªå®šä¹‰");
                return false;
            }

            console.log("âœ… CardRegistry å·²åŠ è½½");

            // æ£€æŸ¥å¡ç‰‡ç±»å‹æ˜¯å¦æ³¨å†Œ
            const expectedTypes = [
                "protocol_progress",
                "protocol_step",
                "protocol_completion"
            ];

            let allRegistered = true;
            for (const type of expectedTypes) {
                const hasCard = CardRegistry.has(type);
                if (hasCard) {
                    console.log(`âœ… ${type} å·²æ³¨å†Œ`);
                } else {
                    console.error(`âŒ ${type} æœªæ³¨å†Œ`);
                    allRegistered = false;
                }
            }

            return allRegistered;
        }

        function renderMockCards() {
            console.log("ğŸ¨ æ¸²æŸ“æ¨¡æ‹Ÿå¡ç‰‡");

            // è¿™éœ€è¦åœ¨å®é™…çš„ Next.js ç¯å¢ƒä¸­è¿è¡Œ
            console.log("âš ï¸  æ­¤æµ‹è¯•éœ€è¦åœ¨æµè§ˆå™¨ä¸­çš„å®é™…åº”ç”¨ç¯å¢ƒä¸­è¿è¡Œ");
            console.log("   è¯·è®¿é—®: http://localhost:8232/chat/lifecoach");
            console.log("   ç„¶ååœ¨æ§åˆ¶å°è¿è¡Œ: testCardRegistry()");
        }

        console.log("ğŸ“‹ æµ‹è¯•å·¥å…·å·²åŠ è½½");
        console.log("   è¿è¡Œ testCardRegistry() æ£€æŸ¥å¡ç‰‡æ³¨å†Œ");
        console.log("   è¿è¡Œ renderMockCards() æŸ¥çœ‹å¡ç‰‡æ¸²æŸ“");
    </script>
</head>
<body>
    <h1>Protocol å¡ç‰‡å‰ç«¯é›†æˆæµ‹è¯•</h1>
    <p>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹æµ‹è¯•è¯´æ˜</p>

    <h2>æµ‹è¯•æ­¥éª¤ï¼š</h2>
    <ol>
        <li>å¯åŠ¨æµ‹è¯•ç¯å¢ƒ: <code>npm run dev</code></li>
        <li>è®¿é—®: <a href="http://localhost:8232/chat/lifecoach">http://localhost:8232/chat/lifecoach</a></li>
        <li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰</li>
        <li>è¿è¡Œ: <code>testCardRegistry()</code></li>
        <li>æ£€æŸ¥è¾“å‡ºï¼Œç¡®è®¤æ‰€æœ‰å¡ç‰‡ç±»å‹å·²æ³¨å†Œ</li>
    </ol>

    <h2>é¢„æœŸå¡ç‰‡æ•°æ®æ ¼å¼ï¼š</h2>
    <pre id="mock-data"></pre>

    <script>
        document.getElementById("mock-data").textContent = JSON.stringify(mockToolCalls, null, 2);
    </script>
</body>
</html>
"""

    output_path = Path(__file__).parent.parent.parent.parent / "protocol_frontend_test.html"
    with open(output_path, "w", encoding="utf-8") as f:
        f.write(html)

    print(f"âœ… å·²ç”Ÿæˆæµ‹è¯•é¡µé¢: {output_path}")
    print(f"   åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€: file://{output_path}")

    return True


async def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\nğŸ§ª Protocol å‰ç«¯é›†æˆæµ‹è¯•")
    print("="*80)

    tests = [
        ("å¡ç‰‡æ•°æ®æ ¼å¼", test_card_data_format),
        ("CardRegistry æ³¨å†Œ", test_card_type_registration),
        ("ç”Ÿæˆæµ‹è¯•é¡µé¢", generate_frontend_test_html),
    ]

    results = []
    for name, test_func in tests:
        try:
            result = await test_func()
            results.append((name, "âœ… é€šè¿‡" if result else "âŒ å¤±è´¥"))
        except Exception as e:
            results.append((name, f"âŒ é”™è¯¯: {str(e)}"))
            import traceback
            traceback.print_exc()

    # è¾“å‡ºæµ‹è¯•ç»“æœ
    print("\n" + "="*80)
    print("æµ‹è¯•ç»“æœæ±‡æ€»")
    print("="*80)
    for name, status in results:
        print(f"  {name}: {status}")

    # ç»Ÿè®¡
    passed = sum(1 for _, status in results if "âœ…" in status)
    total = len(results)
    print(f"\næ€»è®¡: {passed}/{total} é€šè¿‡")

    print("\n" + "="*80)
    print("ä¸‹ä¸€æ­¥:")
    print("="*80)
    print("1. å¯åŠ¨æµ‹è¯•ç¯å¢ƒ:")
    print("   cd apps/web && npm run dev")
    print()
    print("2. è®¿é—® lifecoach é¡µé¢:")
    print("   http://localhost:8232/chat/lifecoach")
    print()
    print("3. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼Œè¿è¡Œ:")
    print("   CardRegistry.getTypes()")
    print()
    print("4. æ£€æŸ¥è¾“å‡ºä¸­æ˜¯å¦åŒ…å«:")
    print("   - protocol_progress")
    print("   - protocol_step")
    print("   - protocol_completion")

    return passed == total


if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
