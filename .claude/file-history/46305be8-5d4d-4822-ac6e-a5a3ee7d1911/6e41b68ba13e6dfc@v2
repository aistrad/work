# VibeProfile API Reference

## Python API (VibeProfileRepository)

### Identity 相关

#### get_identity(user_id: UUID) -> Dict

获取用户身份信息，包含出生信息和计算的命盘/星图。

```python
identity = await VibeProfileRepository.get_identity(user_id)
# 返回:
# {
#     "birth_info": {"date": "1990-05-15", "time": "14:30", ...},
#     "bazi_chart": {...},
#     "zodiac_chart": {...}
# }
```

#### update_birth_info(user_id: UUID, birth_info: Dict) -> None

更新出生信息。会触发 `BIRTH_INFO_UPDATED` 事件，Skill 服务监听后会重新计算命盘。

```python
await VibeProfileRepository.update_birth_info(user_id, {
    "date": "1990-05-15",
    "time": "14:30",
    "place": "北京",
    "timezone": "Asia/Shanghai",
    "gender": "male"
})
```

---

### State 相关

#### get_state(user_id: UUID) -> Dict

获取用户当前状态。

```python
state = await VibeProfileRepository.get_state(user_id)
# 返回:
# {
#     "emotion": {"current": "neutral", "baseline": "content", "intensity": 0.3},
#     "focus": {"topics": ["career"], "primary": "career", "intensity": 0.7},
#     "life_stage": {"stage": "career_growth", "sub_stage": "seeking_promotion"},
#     "energy_level": {"level": 0.6, "trend": "stable"}
# }
```

#### update_emotion(user_id: UUID, emotion: str, intensity: float) -> None

更新情绪状态。当情绪强度超过阈值时会触发 `EMOTION_CHANGED` 事件。

**参数:**
- `emotion`: anxious | sad | neutral | content | excited
- `intensity`: 0.0 - 1.0

```python
await VibeProfileRepository.update_emotion(user_id, "anxious", 0.8)
```

#### update_focus(user_id: UUID, topics: List[str], primary: str) -> None

更新用户关注焦点。

```python
await VibeProfileRepository.update_focus(
    user_id,
    topics=["career", "relationship"],
    primary="career"
)
```

#### update_life_stage(user_id: UUID, stage: str, sub_stage: str = None) -> None

更新人生阶段。

**常用阶段:**
- student, job_seeking, career_growth, career_transition
- single, dating, married, parenting
- retirement

```python
await VibeProfileRepository.update_life_stage(user_id, "career_growth", "seeking_promotion")
```

---

### Skill Data 相关

#### get_skill_data(user_id: UUID, skill: str) -> Dict

获取指定 Skill 的计算数据。

```python
bazi_data = await VibeProfileRepository.get_skill_data(user_id, "bazi")
# 返回:
# {
#     "chart": {...},
#     "features": {"daymaster": "甲木", "strength": "身弱"},
#     "current_dayun": {...},
#     "computed_at": "2026-01-19T00:00:00Z"
# }
```

#### get_all_skill_data(user_id: UUID) -> Dict

获取所有 Skill 的数据。

```python
all_skills = await VibeProfileRepository.get_all_skill_data(user_id)
# 返回:
# {
#     "bazi": {...},
#     "zodiac": {...},
#     "tarot": {...}
# }
```

#### update_skill_data(user_id: UUID, skill: str, data: Dict) -> None

更新 Skill 计算数据。会触发缓存失效。

```python
await VibeProfileRepository.update_skill_data(user_id, "bazi", {
    "chart": {...},
    "features": {...},
    "computed_at": datetime.now().isoformat()
})
```

---

### Extracted 相关

#### get_extracted(user_id: UUID) -> Dict

获取从对话中抽取的用户信息。

```python
extracted = await VibeProfileRepository.get_extracted(user_id)
# 返回:
# {
#     "facts": [...],
#     "concerns": [...],
#     "goals": [...],
#     "relationships": [...]
# }
```

#### add_fact(user_id: UUID, fact: str, source: str, confidence: float) -> None

添加新发现的事实。

```python
await VibeProfileRepository.add_fact(
    user_id,
    fact="在互联网公司担任产品经理",
    source="conversation:abc123",
    confidence=0.9
)
```

#### update_concern(user_id: UUID, topic: str, intensity: float) -> None

更新用户关注点。如果已存在则更新 intensity 和 last_mentioned，否则新增。

```python
await VibeProfileRepository.update_concern(user_id, "升职", intensity=0.8)
```

#### upsert_goal(user_id: UUID, goal: str, status: str, progress: float = None) -> None

更新或插入目标。

**状态:**
- active, completed, abandoned, paused

```python
await VibeProfileRepository.upsert_goal(
    user_id,
    goal="年底前升职",
    status="active",
    progress=0.3
)
```

---

### Life Context 相关

#### get_life_context(user_id: UUID) -> Dict

获取生活上下文。

```python
context = await VibeProfileRepository.get_life_context(user_id)
# 返回:
# {
#     "occupation": {"title": "产品经理", "industry": "互联网"},
#     "relationships": {"status": "single"},
#     "health": {"physical": "good", "mental": "moderate_stress"},
#     "finance": {"level": "middle"}
# }
```

#### update_life_context(user_id: UUID, updates: Dict) -> None

更新生活上下文。支持深度合并。

```python
await VibeProfileRepository.update_life_context(user_id, {
    "occupation": {"company_size": "large"},
    "health": {"concerns": ["睡眠质量"]}
})
```

---

### Proactive State 相关

#### get_proactive_state(user_id: UUID) -> Dict

获取推送就绪状态。

```python
state = await VibeProfileRepository.get_proactive_state(user_id)
# 返回:
# {
#     "pending_triggers": [...],
#     "cooldowns": {...},
#     "suppressed": [...],
#     "last_scanned_at": "..."
# }
```

#### add_pending_trigger(user_id: UUID, trigger: Dict) -> None

添加待触发的推送。

```python
await VibeProfileRepository.add_pending_trigger(user_id, {
    "trigger_id": "bazi_fortune_alert",
    "skill_id": "bazi",
    "ready_at": "2026-01-20T04:00:00Z",
    "priority": "high",
    "reason": "low_fortune_score"
})
```

#### mark_trigger_sent(user_id: UUID, trigger_id: str) -> None

标记推送已发送。会从 pending_triggers 移除，并更新 cooldowns。

```python
await VibeProfileRepository.mark_trigger_sent(user_id, "bazi_daily_fortune")
```

#### suppress_trigger(user_id: UUID, trigger_id: str, until: datetime, reason: str) -> None

抑制推送。

**常用原因:**
- user_dismissed, user_settings, system_limit

```python
await VibeProfileRepository.suppress_trigger(
    user_id,
    trigger_id="zodiac_mercury_retrograde",
    until=datetime(2026, 2, 1),
    reason="user_dismissed"
)
```

---

### Insights 相关 (Cold Layer)

#### get_insights(user_id, insight_type, skill_id, limit) -> List[Dict]

获取用户洞察。

**insight_type:**
- discovery: 首次发现的特征
- pattern: 重复出现的规律
- timing: 时机相关建议
- growth: 成长变化观察

```python
insights = await VibeProfileRepository.get_insights(
    user_id,
    insight_type="pattern",
    skill_id="bazi",
    limit=10
)
```

#### add_insight(...) -> UUID

添加新洞察。

```python
insight_id = await VibeProfileRepository.add_insight(
    user_id=user_id,
    insight_type="pattern",
    category="emotion",
    content="用户在周一早上容易感到焦虑",
    skill_id="core",
    confidence=0.75,
    evidence=["conv:abc", "conv:def"]
)
```

#### confirm_insight(user_id: UUID, insight_id: UUID) -> None

确认洞察。增加 observation_count，更新 last_confirmed_at。

```python
await VibeProfileRepository.confirm_insight(user_id, insight_id)
```

---

### Timeline 相关 (Cold Layer)

#### get_timeline(user_id, start_date, end_date, event_types, limit) -> List[Dict]

获取时间线事件。

**event_types:**
- dayun_change, liunian_change: 大运/流年变化
- milestone: 对话里程碑
- observation: AI 观察
- user_marked: 用户标记

```python
events = await VibeProfileRepository.get_timeline(
    user_id,
    start_date=date(2026, 1, 1),
    end_date=date(2026, 12, 31),
    event_types=["dayun_change", "milestone"],
    limit=20
)
```

#### add_timeline_event(...) -> UUID

添加时间线事件。

```python
event_id = await VibeProfileRepository.add_timeline_event(
    user_id=user_id,
    event_type="milestone",
    event_date=date(2026, 1, 19),
    title="首次深度职业咨询",
    description="用户详细讨论了升职困惑",
    skill_id="career",
    importance="high",
    source="ai"
)
```

---

### Batch Operations

#### query_users_by_state(emotion, focus_topic, life_stage, limit) -> List[Dict]

按状态查询用户。Proactive 定向推送使用。

```python
users = await VibeProfileRepository.query_users_by_state(
    emotion="anxious",
    limit=100
)
# 返回:
# [{"user_id": ..., "profile": ...}, ...]
```

#### query_users_with_pending_triggers(before, skill_id, limit) -> List[Dict]

查询有待触发推送的用户。

```python
users = await VibeProfileRepository.query_users_with_pending_triggers(
    before=datetime.now(),
    skill_id="bazi",
    limit=100
)
```

#### batch_update_proactive_state(updates: List[Dict]) -> int

批量更新推送状态。返回更新数量。

```python
count = await VibeProfileRepository.batch_update_proactive_state([
    {"user_id": uuid1, "trigger_id": "...", "action": "sent"},
    {"user_id": uuid2, "trigger_id": "...", "action": "suppress", "until": ...}
])
```

---

### Summary (Privacy)

#### get_profile_summary(user_id: UUID) -> Dict

获取用户画像摘要。用于用户查看 AI 的认知。

```python
summary = await VibeProfileRepository.get_profile_summary(user_id)
# 返回:
# {
#     "identity": "1990年出生，八字甲木日主，金牛座",
#     "personality": {
#         "traits": ["理性务实", "有责任感"],
#         "strengths": ["执行力强"],
#         "challenges": ["过于追求完美"]
#     },
#     "currentState": {
#         "focus": "近期关注职业发展",
#         "emotion": "情绪稳定",
#         "lifeStage": "处于职业上升期"
#     },
#     "keyInsights": ["适合稳扎稳打", "贵人运在下半年"],
#     "goals": ["年底升职"],
#     "dataCompleteness": 0.75,
#     "lastUpdated": "2026-01-19"
# }
```

---

## HTTP API

### GET /api/v1/profile/summary

获取当前用户的 Profile 摘要。

**Response:**
```json
{
  "identity": "...",
  "personality": {...},
  "currentState": {...},
  "keyInsights": [...],
  "goals": [...],
  "dataCompleteness": 0.75
}
```

### GET /api/v1/profile/insights

获取当前用户的洞察列表。

**Query Parameters:**
- `type`: discovery | pattern | timing | growth
- `skill`: bazi | zodiac | ...
- `limit`: 默认 20

### GET /api/v1/profile/timeline

获取当前用户的时间线。

**Query Parameters:**
- `start`: 开始日期 (YYYY-MM-DD)
- `end`: 结束日期 (YYYY-MM-DD)
- `types`: 逗号分隔的事件类型
- `limit`: 默认 50

### PUT /api/v1/profile/privacy

更新隐私设置。

**Request:**
```json
{
  "summary_visibility": "detailed",
  "collect_emotions": true,
  "proactive_enabled": true,
  "proactive_frequency": "normal"
}
```

---

## 事件

### VibeProfileEvents

| 事件 | 触发时机 | 监听者 |
|------|---------|--------|
| BIRTH_INFO_UPDATED | 出生信息更新 | Skill Services (重算命盘) |
| EMOTION_CHANGED | 情绪状态变化 (intensity > 0.7) | ProactiveEngine |
| STATE_CHANGED | 任意状态变化 | CoreAgent |
| INSIGHT_ADDED | 新洞察添加 | CoreAgent |
| GOAL_UPDATED | 目标状态变化 | ProactiveEngine |

### 事件订阅

```python
from services.profile.vibe_profile_events import VibeProfileEvents

@VibeProfileEvents.on(VibeProfileEvents.EMOTION_CHANGED)
async def handle_emotion_change(user_id: UUID, data: Dict):
    if data["emotion"] == "anxious" and data["intensity"] > 0.7:
        # 触发 mindfulness 推送
        await proactive_engine.trigger_immediate(
            user_id,
            trigger_id="mindfulness_check_in"
        )
```
