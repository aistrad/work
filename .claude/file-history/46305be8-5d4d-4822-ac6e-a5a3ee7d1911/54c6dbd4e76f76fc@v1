# VibeProfile 架构与数据流

> 数据使用、更新的架构图与时序图，及深度 Review

---

## 1. 系统架构总览

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                    VibeLife System Architecture                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                    User Interface Layer                                      │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │  Chat UI     │  │  Settings    │  │  Dashboard   │  │  Goals UI    │  │  Push/Notif  │  │    │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │    │
│  └─────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼──────────┘    │
│            │                 │                 │                 │                 │               │
│            ▼                 ▼                 ▼                 ▼                 ▼               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                      API Layer (FastAPI)                                     │    │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │    │
│  │  │  /chat       │  │  /profile    │  │  /skills     │  │  /goals      │  │  /notif      │  │    │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │    │
│  └─────────┼─────────────────┼─────────────────┼─────────────────┼─────────────────┼──────────┘    │
│            │                 │                 │                 │                 │               │
│            ▼                 ▼                 ▼                 ▼                 ▼               │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                     Service Layer                                            │    │
│  │                                                                                              │    │
│  │  ┌────────────────────────────────────┐    ┌────────────────────────────────────┐           │    │
│  │  │         CoreAgent (AI Engine)      │    │        ProactiveEngine             │           │    │
│  │  │  ┌─────────┐  ┌─────────────────┐  │    │  ┌─────────┐  ┌────────────────┐   │           │    │
│  │  │  │ Router  │  │ Skill Dispatcher│  │    │  │Trigger  │  │Content         │   │           │    │
│  │  │  └────┬────┘  └────────┬────────┘  │    │  │Detector │  │Generator       │   │           │    │
│  │  │       │                │           │    │  └────┬────┘  └───────┬────────┘   │           │    │
│  │  └───────┼────────────────┼───────────┘    └───────┼───────────────┼────────────┘           │    │
│  │          │                │                        │               │                         │    │
│  │          ▼                ▼                        ▼               ▼                         │    │
│  │  ┌───────────────────────────────────────────────────────────────────────────────────────┐  │    │
│  │  │                              Skill Services Layer                                      │  │    │
│  │  │                                                                                        │  │    │
│  │  │  ╔═══════════════════════════════════════╗  ┌─────────────────────────────────────┐   │  │    │
│  │  │  ║       Core Layer Skills               ║  │      Professional Layer Skills      │   │  │    │
│  │  │  ║  ┌────────┐ ┌────────┐ ┌───────────┐  ║  │  ┌──────┐ ┌──────┐ ┌─────┐ ┌──────┐│   │  │    │
│  │  │  ║  │  core  │ │lifecoach│ │mindfulness│  ║  │  │ bazi │ │zodiac│ │tarot│ │career││   │  │    │
│  │  │  ║  └────────┘ └────────┘ └───────────┘  ║  │  └──────┘ └──────┘ └─────┘ └──────┘│   │  │    │
│  │  │  ╚═══════════════════════════════════════╝  └─────────────────────────────────────┘   │  │    │
│  │  │          │ 全量读/写                                  │ 受限读/写                      │  │    │
│  │  └──────────┼────────────────────────────────────────────┼───────────────────────────────┘  │    │
│  │             │                                            │                                   │    │
│  └─────────────┼────────────────────────────────────────────┼───────────────────────────────────┘    │
│                │                                            │                                        │
│                ▼                                            ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                                              │    │
│  │                              VibeProfile Repository                                          │    │
│  │                                                                                              │    │
│  │  ┌─────────────────────────────────────────────────────────────────────────────────────┐   │    │
│  │  │                              Access Control Layer                                    │   │    │
│  │  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                     │   │    │
│  │  │   │  Core Access    │  │ Professional    │  │  System Access  │                     │   │    │
│  │  │   │  (Full R/W)     │  │ Access (Limited)│  │  (Full R/W)     │                     │   │    │
│  │  │   └─────────────────┘  └─────────────────┘  └─────────────────┘                     │   │    │
│  │  └─────────────────────────────────────────────────────────────────────────────────────┘   │    │
│  │                                            │                                               │    │
│  │  ┌─────────────────────────────────────────┼─────────────────────────────────────────┐    │    │
│  │  │                              Profile Cache (5min TTL)                              │    │    │
│  │  └─────────────────────────────────────────┼─────────────────────────────────────────┘    │    │
│  │                                            │                                               │    │
│  │  ┌─────────────────────────────────────────┼─────────────────────────────────────────┐    │    │
│  │  │                              Event Emitter                                         │    │    │
│  │  │   BIRTH_INFO_UPDATED │ EMOTION_CHANGED │ STATE_CHANGED │ INSIGHT_ADDED            │    │    │
│  │  └─────────────────────────────────────────┼─────────────────────────────────────────┘    │    │
│  │                                            │                                               │    │
│  └────────────────────────────────────────────┼───────────────────────────────────────────────┘    │
│                                               │                                                    │
│                                               ▼                                                    │
│  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐    │
│  │                                     Data Layer (PostgreSQL)                                  │    │
│  │                                                                                              │    │
│  │  ┌──────────────────────────────────────────────────────────────────────────────────────┐  │    │
│  │  │  unified_profiles (Hot + Warm Layer)                                                  │  │    │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐   │  │    │
│  │  │  │ account  │ │ identity │ │  state   │ │preferences│ │skill_data│ │ life_context │   │  │    │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────┘   │  │    │
│  │  │  ┌──────────────────┐ ┌───────────────────┐                                          │  │    │
│  │  │  │    extracted     │ │  proactive_state  │                                          │  │    │
│  │  │  └──────────────────┘ └───────────────────┘                                          │  │    │
│  │  └──────────────────────────────────────────────────────────────────────────────────────┘  │    │
│  │                                                                                              │    │
│  │  ┌────────────────────────────┐  ┌────────────────────────────┐                             │    │
│  │  │  vibe_profile_insights     │  │  vibe_profile_timeline     │   (Cold Layer)              │    │
│  │  │  (discovery/pattern/...)   │  │  (events/milestones)       │                             │    │
│  │  └────────────────────────────┘  └────────────────────────────┘                             │    │
│  │                                                                                              │    │
│  │  ┌────────────────────────────┐  ┌────────────────────────────┐   (独立表，不合并)          │    │
│  │  │     user_reminders         │  │     skill_usage_log        │                             │    │
│  │  └────────────────────────────┘  └────────────────────────────┘                             │    │
│  │                                                                                              │    │
│  └──────────────────────────────────────────────────────────────────────────────────────────────┘    │
│                                                                                                      │
└──────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 数据读取架构

### 2.1 读取路径总览

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              VibeProfile 数据读取路径                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   调用方                      读取类型                     数据流向                       │
│   ══════                     ════════                    ════════                        │
│                                                                                          │
│   ┌──────────────┐                                                                       │
│   │  CoreAgent   │ ──▶ get_full_profile() ──▶ [Cache] ──▶ [DB] ──▶ 全部数据             │
│   └──────────────┘                             │  hit?                                   │
│                                                ▼                                         │
│   ┌──────────────┐                         ┌──────┐                                      │
│   │ ProactiveEng │ ──▶ get_proactive_state()  │Cache│ ──▶ proactive_state               │
│   │              │ ──▶ query_pending_triggers │  │                                       │
│   └──────────────┘     (batch)              └──────┘                                     │
│                                                │                                         │
│   ┌──────────────┐                             │ miss                                    │
│   │ Bazi Service │ ──▶ get_identity()      ────┴────▶ [DB] ──▶ identity + state         │
│   │              │ ──▶ get_skill_sub("bazi")                                             │
│   └──────────────┘                                                                       │
│                                                                                          │
│   ┌──────────────┐                                                                       │
│   │Zodiac Service│ ──▶ get_identity()          ──▶ identity + state                     │
│   │              │ ──▶ get_zodiac_chart()      ──▶ skill_data.zodiac                    │
│   └──────────────┘                                                                       │
│                                                                                          │
│   ┌──────────────┐                                                                       │
│   │LifeCoach Svc│ ──▶ get_full_profile()       ──▶ 全部 (含 life_context.goals)         │
│   │              │ ──▶ get_insights()          ──▶ Cold Layer                            │
│   └──────────────┘                                                                       │
│                                                                                          │
│   ┌──────────────┐                                                                       │
│   │  Frontend    │ ──▶ get_profile_summary()   ──▶ 脱敏摘要                              │
│   │  (Settings)  │ ──▶ get_privacy_settings()  ──▶ preferences.privacy_level            │
│   └──────────────┘                                                                       │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 缓存策略

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ProfileCache 缓存策略                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   Cache Key 格式                                                                         │
│   ══════════════                                                                         │
│                                                                                          │
│   {user_id}:all      ──▶ 完整 Profile (全量)                                            │
│   {user_id}:bazi     ──▶ identity + skill_data.bazi (Skill 专用)                        │
│   {user_id}:zodiac   ──▶ identity + skill_data.zodiac                                   │
│   {user_id}:state    ──▶ state 快照 (高频读取)                                           │
│                                                                                          │
│   ─────────────────────────────────────────────────────────────────────────────────     │
│                                                                                          │
│   失效策略                                                                               │
│   ════════                                                                               │
│                                                                                          │
│   更新 birth_info      ──▶ 失效 {user_id}:* (全部)                                       │
│   更新 skill_data.bazi ──▶ 失效 {user_id}:bazi + {user_id}:all                          │
│   更新 state           ──▶ 失效 {user_id}:state + {user_id}:all                         │
│   更新 preferences     ──▶ 失效 {user_id}:all                                           │
│                                                                                          │
│   ─────────────────────────────────────────────────────────────────────────────────     │
│                                                                                          │
│   TTL 配置                                                                               │
│   ════════                                                                               │
│                                                                                          │
│   DEFAULT_TTL = 300s (5分钟)                                                            │
│   STATE_TTL   = 60s  (1分钟，高频变化)                                                  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据写入架构

### 3.1 写入路径总览

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              VibeProfile 数据写入路径                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   写入源                      写入类型                     触发事件                       │
│   ══════                     ════════                    ════════                        │
│                                                                                          │
│   ┌──────────────┐           identity.birth_info                                         │
│   │  Onboarding  │ ──────────────────────────────────▶ BIRTH_INFO_UPDATED               │
│   │  /Settings   │           account.*                   │                               │
│   └──────────────┘ ──────────────────────────────────▶   │                               │
│                                                          ▼                               │
│                                                   ┌────────────┐                         │
│   ┌──────────────┐           state.emotion        │   Event    │                         │
│   │  CoreAgent   │ ──────────────────────────────▶│  Emitter   │──▶ EMOTION_CHANGED     │
│   │  (对话中)    │           extracted.*          │            │                         │
│   │              │ ──────────────────────────────▶│            │                         │
│   └──────────────┘           insights             │            │──▶ INSIGHT_ADDED       │
│                   ──────────────────────────────▶│            │                         │
│                                                   └────────────┘                         │
│                                                          │                               │
│   ┌──────────────┐           skill_data.bazi             │                               │
│   │ Bazi Service │ ──────────────────────────────▶ 无事件 (仅失效缓存)                   │
│   └──────────────┘                                       │                               │
│                                                          │                               │
│   ┌──────────────┐           skill_data.zodiac           │                               │
│   │Zodiac Service│ ──────────────────────────────▶ 无事件                               │
│   └──────────────┘                                       │                               │
│                                                          │                               │
│   ┌──────────────┐           life_context.goals          │                               │
│   │  Goals API   │ ──────────────────────────────▶ GOAL_UPDATED                         │
│   │              │           life_context.tasks          │                               │
│   │              │ ──────────────────────────────▶       │                               │
│   └──────────────┘           life_context.checkins       ▼                               │
│                   ──────────────────────────────▶ ┌────────────┐                         │
│                                                   │   Cache    │                         │
│   ┌──────────────┐           proactive_state     │ Invalidate │                         │
│   │ProactiveEng  │ ──────────────────────────────▶│            │                         │
│   │  (Worker)    │                               └────────────┘                         │
│   └──────────────┘                                       │                               │
│                                                          ▼                               │
│                                                   ┌────────────┐                         │
│                                                   │  Database  │                         │
│                                                   │  (jsonb_   │                         │
│                                                   │   set)     │                         │
│                                                   └────────────┘                         │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 写入冲突处理

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              并发写入处理策略                                            │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   场景 1: 不同字段并发写入 (无冲突)                                                      │
│   ══════════════════════════════════                                                     │
│                                                                                          │
│   CoreAgent                  Bazi Service                                                │
│       │                           │                                                      │
│       │ update_emotion()          │ update_skill_data("bazi")                            │
│       ▼                           ▼                                                      │
│   jsonb_set('{state,emotion}')   jsonb_set('{skill_data,bazi}')                         │
│       │                           │                                                      │
│       └───────────┬───────────────┘                                                      │
│                   ▼                                                                      │
│            互不干扰，各自更新对应路径                                                    │
│                                                                                          │
│   ─────────────────────────────────────────────────────────────────────────────────     │
│                                                                                          │
│   场景 2: 同一字段并发写入 (需要处理)                                                    │
│   ══════════════════════════════════                                                     │
│                                                                                          │
│   CoreAgent A                CoreAgent B (另一个会话)                                    │
│       │                           │                                                      │
│       │ add_fact("A")            │ add_fact("B")                                        │
│       ▼                           ▼                                                      │
│   extracted.facts = [..., A]     extracted.facts = [..., B]                             │
│       │                           │                                                      │
│       └───────────┬───────────────┘                                                      │
│                   ▼                                                                      │
│            可能丢失 A 或 B                                                               │
│                                                                                          │
│   解决方案: 使用 jsonb_array_append / 乐观锁                                             │
│   ════════════════════════════════════════════                                           │
│                                                                                          │
│   -- 方案 1: jsonb 数组追加 (推荐)                                                       │
│   UPDATE unified_profiles                                                                │
│   SET profile = jsonb_set(                                                               │
│       profile,                                                                           │
│       '{extracted,facts}',                                                               │
│       COALESCE(profile->'extracted'->'facts', '[]'::jsonb) || $2::jsonb                 │
│   )                                                                                      │
│   WHERE user_id = $1;                                                                    │
│                                                                                          │
│   -- 方案 2: 乐观锁 (version 字段)                                                       │
│   UPDATE unified_profiles                                                                │
│   SET profile = ..., version = version + 1                                               │
│   WHERE user_id = $1 AND version = $expected_version;                                   │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 典型场景时序图

### 4.1 用户对话场景

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              时序图: 用户对话场景                                                    │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│   User        ChatAPI      CoreAgent     VibeProfile     BaziSkill      ProactiveEng    Database    │
│     │            │             │              │              │               │              │        │
│     │  发送消息  │             │              │              │               │              │        │
│     │ ─────────▶│             │              │              │               │              │        │
│     │            │  处理消息   │              │              │               │              │        │
│     │            │ ──────────▶│              │              │               │              │        │
│     │            │             │              │              │               │              │        │
│     │            │             │ get_profile()│              │               │              │        │
│     │            │             │ ────────────▶│              │               │              │        │
│     │            │             │              │  Cache Miss  │               │              │        │
│     │            │             │              │ ─────────────────────────────────────────▶│        │
│     │            │             │              │              │               │   SELECT    │        │
│     │            │             │              │◀─────────────────────────────────────────│        │
│     │            │             │◀────────────│ Profile Data │               │              │        │
│     │            │             │              │              │               │              │        │
│     │            │             │ 路由到 Bazi  │              │               │              │        │
│     │            │             │ ──────────────────────────▶│               │              │        │
│     │            │             │              │              │ get_bazi_data │              │        │
│     │            │             │              │◀─────────────│ (from cache) │              │        │
│     │            │             │              │ ────────────▶│               │              │        │
│     │            │             │              │              │               │              │        │
│     │            │             │              │              │ 生成回复      │              │        │
│     │            │             │◀──────────────────────────│               │              │        │
│     │            │             │              │              │               │              │        │
│     │            │             │ 抽取用户信息  │              │               │              │        │
│     │            │             │ update_extracted()         │               │              │        │
│     │            │             │ ────────────▶│              │               │              │        │
│     │            │             │              │ jsonb_set    │               │              │        │
│     │            │             │              │ ─────────────────────────────────────────▶│        │
│     │            │             │              │              │               │   UPDATE    │        │
│     │            │             │              │ invalidate   │               │              │        │
│     │            │             │              │ cache        │               │              │        │
│     │            │             │              │              │               │              │        │
│     │            │             │ 检测情绪变化 │              │               │              │        │
│     │            │             │ update_emotion("anxious", 0.8)              │              │        │
│     │            │             │ ────────────▶│              │               │              │        │
│     │            │             │              │ emit(EMOTION_CHANGED)        │              │        │
│     │            │             │              │ ─────────────────────────────▶│              │        │
│     │            │             │              │              │               │ 检测是否触发 │        │
│     │            │             │              │              │               │ mindfulness │        │
│     │            │             │              │              │               │ 推送        │        │
│     │            │             │              │              │               │              │        │
│     │            │◀────────────│ 返回回复     │              │               │              │        │
│     │◀───────────│             │              │              │               │              │        │
│     │  显示回复  │             │              │              │               │              │        │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 主动推送场景

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              时序图: 主动推送场景 (每日运势)                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│   Scheduler    ProactiveEng   VibeProfile    BaziComputer   ContentGen    NotificationSvc  User     │
│       │             │              │              │              │              │            │       │
│  04:00 触发       │              │              │              │              │            │       │
│  ────────────────▶│              │              │              │              │            │       │
│       │             │              │              │              │              │            │       │
│       │             │ query_users_with_pending_triggers()       │              │            │       │
│       │             │ ────────────▶│              │              │              │            │       │
│       │             │              │ SELECT WHERE pending_triggers contains bazi_daily     │       │
│       │             │              │              AND ready_at <= now()                     │       │
│       │             │◀────────────│ [user_1, user_2, ...]       │              │            │       │
│       │             │              │              │              │              │            │       │
│       │             │  for each user:            │              │              │            │       │
│       │             │              │              │              │              │            │       │
│       │             │ get_profile(user_1)        │              │              │            │       │
│       │             │ ────────────▶│              │              │              │            │       │
│       │             │◀────────────│ profile      │              │              │            │       │
│       │             │              │              │              │              │            │       │
│       │             │ compute_daily_fortune(profile)            │              │            │       │
│       │             │ ────────────────────────────▶│              │              │            │       │
│       │             │              │              │ 使用 bazi_chart              │            │       │
│       │             │              │              │ + current_dayun              │            │       │
│       │             │◀────────────────────────────│ fortune_data │              │            │       │
│       │             │              │              │              │              │            │       │
│       │             │ generate_content(profile, fortune_data)   │              │            │       │
│       │             │ ───────────────────────────────────────────▶│              │            │       │
│       │             │              │              │              │ 结合 life_context         │       │
│       │             │              │              │              │ 个性化内容    │            │       │
│       │             │◀───────────────────────────────────────────│ ReminderContent           │       │
│       │             │              │              │              │              │            │       │
│       │             │ send_notification(user_1, content)        │              │            │       │
│       │             │ ──────────────────────────────────────────────────────────▶│            │       │
│       │             │              │              │              │              │ 保存到DB   │       │
│       │             │              │              │              │              │ 推送到设备 │       │
│       │             │              │              │              │              │ ──────────▶│       │
│       │             │              │              │              │              │            │ 收到  │
│       │             │              │              │              │              │            │ 推送  │
│       │             │              │              │              │              │            │       │
│       │             │ mark_trigger_sent(user_1, "bazi_daily")   │              │            │       │
│       │             │ ────────────▶│              │              │              │            │       │
│       │             │              │ 更新 cooldowns              │              │            │       │
│       │             │              │ 移除 pending_trigger        │              │            │       │
│       │             │              │              │              │              │            │       │
│       │             │ add_timeline_event("daily_fortune_sent")  │              │            │       │
│       │             │ ────────────▶│              │              │              │            │       │
│       │             │              │ INSERT vibe_profile_timeline               │            │       │
│       │             │              │              │              │              │            │       │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 出生信息更新场景

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              时序图: 出生信息更新 (触发全量重算)                                     │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│   User       SettingsAPI    VibeProfile     EventEmitter    BaziService   ZodiacService  Database  │
│     │            │              │               │               │              │             │      │
│   修改出生时间   │              │               │               │              │             │      │
│  ────────────▶│              │               │               │              │             │      │
│     │            │ update_birth_info()         │               │              │             │      │
│     │            │ ────────────▶│               │               │              │             │      │
│     │            │              │               │               │              │             │      │
│     │            │              │ UPDATE profile->'identity'->'birth_info'    │             │      │
│     │            │              │ ────────────────────────────────────────────────────────▶│      │
│     │            │              │               │               │              │             │      │
│     │            │              │ invalidate ALL cache for user │              │             │      │
│     │            │              │               │               │              │             │      │
│     │            │              │ emit(BIRTH_INFO_UPDATED)      │              │             │      │
│     │            │              │ ─────────────▶│               │              │             │      │
│     │            │              │               │               │              │             │      │
│     │            │              │               │ 广播给所有监听者              │             │      │
│     │            │              │               │ ─────────────▶│              │             │      │
│     │            │              │               │               │ 重算八字命盘 │             │      │
│     │            │              │               │               │ compute_bazi_chart()       │      │
│     │            │              │               │               │ update_skill_data("bazi")  │      │
│     │            │              │               │ ──────────────────────────────▶│             │      │
│     │            │              │               │              │ 重算星盘     │             │      │
│     │            │              │               │              │ compute_zodiac_chart()     │      │
│     │            │              │               │              │ update_skill_data("zodiac")│      │
│     │            │              │               │               │              │             │      │
│     │            │              │               │ 重算大运/流年 │              │             │      │
│     │            │              │               │ ─────────────▶│              │             │      │
│     │            │              │               │               │ compute_dayun()            │      │
│     │            │              │               │               │ ────────────────────────▶│      │
│     │            │              │               │               │              │             │      │
│     │            │              │               │ 更新 proactive_state          │             │      │
│     │            │              │               │ (新的大运交接触发器)          │             │      │
│     │            │              │               │               │              │             │      │
│     │            │              │ add_timeline_event("birth_info_updated")    │             │      │
│     │            │              │ ────────────────────────────────────────────────────────▶│      │
│     │            │              │               │               │              │             │      │
│     │            │◀────────────│ 更新完成      │               │              │             │      │
│     │◀───────────│              │               │               │              │             │      │
│   显示新命盘    │              │               │               │              │             │      │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

### 4.4 Skill 订阅变更场景

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                              时序图: 用户订阅 Bazi Skill                                            │
├─────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                      │
│   User       SkillAPI      VibeProfile      BaziService    ProactiveEng     Database               │
│     │            │              │               │               │              │                    │
│   订阅 Bazi     │              │               │               │              │                    │
│  ────────────▶│              │               │               │              │                    │
│     │            │ update_skill_subscription("bazi", {status: "subscribed"}) │                    │
│     │            │ ────────────▶│               │               │              │                    │
│     │            │              │               │               │              │                    │
│     │            │              │ jsonb_set profile->'preferences'->'skill_subscriptions'->'bazi'  │
│     │            │              │ ────────────────────────────────────────────────────────────────▶│
│     │            │              │               │               │              │                    │
│     │            │              │ 检查是否需要初始化 skill_data.bazi           │                    │
│     │            │              │ ─────────────▶│               │              │                    │
│     │            │              │               │ 检查 birth_info              │                    │
│     │            │              │               │ 计算命盘      │              │                    │
│     │            │              │               │ update_skill_data("bazi")    │                    │
│     │            │              │◀──────────────│               │              │                    │
│     │            │              │               │               │              │                    │
│     │            │              │ 添加 pending_trigger (bazi_daily_fortune)   │                    │
│     │            │              │ ─────────────────────────────▶│              │                    │
│     │            │              │               │               │ 计算下次推送时间               │
│     │            │              │               │               │ add_pending_trigger()          │
│     │            │              │               │               │ ─────────────▶│                    │
│     │            │              │               │               │              │                    │
│     │            │              │ add_timeline_event("skill_subscribed", skill="bazi")            │
│     │            │              │ ────────────────────────────────────────────────────────────────▶│
│     │            │              │               │               │              │                    │
│     │            │◀────────────│ 订阅成功      │               │              │                    │
│     │◀───────────│              │               │               │              │                    │
│   显示 Bazi UI  │              │               │               │              │                    │
│                                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 深度 Review

### 5.1 发现的问题

#### 问题 1: 缓存一致性风险

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  问题: 多实例部署时，A 实例更新数据，B 实例缓存未失效                                    │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   Instance A                        Instance B                                           │
│       │                                 │                                                │
│   update_emotion()                      │ get_profile()                                  │
│   ─▶ DB UPDATE                          │ ◀─ Cache HIT (旧数据)                          │
│   ─▶ Local Cache Invalidate             │                                                │
│       │                                 │ ← 看到旧的 emotion                             │
│       │                                 │                                                │
│   ═══════════════════════════════════════════════════════════════════════════════════   │
│                                                                                          │
│   解决方案:                                                                              │
│   ──────────                                                                             │
│   方案 A: Redis 集中式缓存 (替换内存缓存)                                                │
│   方案 B: PostgreSQL LISTEN/NOTIFY 广播失效消息                                          │
│   方案 C: 短 TTL + 容忍短暂不一致 (当前方案，适用于画像数据)                             │
│                                                                                          │
│   推荐: 方案 C (画像数据变化不需要实时同步，5分钟 TTL 可接受)                            │
│        但 state.emotion 需要用方案 A (Redis) 保证实时性                                  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 问题 2: JSONB 大小膨胀

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  问题: life_context.checkins / extracted.facts 持续增长                                 │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   profile JSONB 预估大小                                                                 │
│   ══════════════════════                                                                 │
│                                                                                          │
│   account          ~500 bytes                                                            │
│   identity         ~2KB (bazi_chart + zodiac_chart)                                      │
│   state            ~500 bytes                                                            │
│   preferences      ~2KB (含 skill_subscriptions)                                         │
│   skill_data       ~5KB (多个 skill)                                                     │
│   extracted.facts  ~100 bytes/fact × N facts                                             │
│   life_context     ~3KB + checkins (30天 × 100 bytes = 3KB)                              │
│   proactive_state  ~1KB                                                                  │
│                                                                                          │
│   初始: ~15KB                                                                            │
│   1年后: ~50KB (facts 膨胀)                                                              │
│   风险: 超过 64KB 时 PostgreSQL TOAST 压缩，查询变慢                                     │
│                                                                                          │
│   ═══════════════════════════════════════════════════════════════════════════════════   │
│                                                                                          │
│   解决方案:                                                                              │
│   ──────────                                                                             │
│   1. checkins 只保留 30 天，历史归档到 timeline                                          │
│   2. facts 超过 100 条时，合并相似项 / 删除低置信度项                                    │
│   3. 定期运行压缩任务: compact_profile()                                                 │
│                                                                                          │
│   async def compact_profile(user_id: UUID):                                              │
│       # 归档旧 checkins                                                                  │
│       checkins = profile["life_context"]["checkins"]                                     │
│       old_checkins = {k: v for k, v in checkins.items()                                  │
│                       if parse_date(k) < today - 30}                                     │
│       if old_checkins:                                                                   │
│           await add_timeline_events(user_id, "checkin_archive", old_checkins)            │
│           del checkins[old_keys]                                                         │
│                                                                                          │
│       # 合并重复 facts                                                                   │
│       facts = profile["extracted"]["facts"]                                              │
│       if len(facts) > 100:                                                               │
│           facts = dedupe_and_prune(facts, max_count=80)                                  │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 问题 3: 事件风暴风险

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  问题: 快速连续更新触发大量事件                                                          │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   场景: 用户在 1 分钟内发送 10 条消息，每条消息都触发 update_emotion()                   │
│                                                                                          │
│   ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐                                           │
│   │msg1 │─▶│msg2 │─▶│msg3 │─▶│msg4 │─▶│msg5 │ ...                                       │
│   └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘  └──┬──┘                                           │
│      │       │       │       │       │                                                   │
│      ▼       ▼       ▼       ▼       ▼                                                   │
│   EMOTION_CHANGED × 10                                                                   │
│      │       │       │       │       │                                                   │
│      ▼       ▼       ▼       ▼       ▼                                                   │
│   ProactiveEngine 处理 10 次 (浪费)                                                      │
│                                                                                          │
│   ═══════════════════════════════════════════════════════════════════════════════════   │
│                                                                                          │
│   解决方案: 事件去抖 (Debounce)                                                          │
│   ──────────────────────────────                                                         │
│                                                                                          │
│   class DebouncedEventEmitter:                                                           │
│       _pending: Dict[str, asyncio.Task] = {}                                             │
│       DEBOUNCE_MS = 5000  # 5 秒内只触发一次                                             │
│                                                                                          │
│       async def emit(self, event_type: str, user_id: UUID, data: Dict):                  │
│           key = f"{event_type}:{user_id}"                                                │
│                                                                                          │
│           # 取消之前的待触发事件                                                         │
│           if key in self._pending:                                                       │
│               self._pending[key].cancel()                                                │
│                                                                                          │
│           # 延迟触发，合并最新数据                                                       │
│           async def delayed_emit():                                                      │
│               await asyncio.sleep(5.0)                                                   │
│               await self._do_emit(event_type, user_id, data)                             │
│               del self._pending[key]                                                     │
│                                                                                          │
│           self._pending[key] = asyncio.create_task(delayed_emit())                       │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 问题 4: 权限控制未强制执行

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  问题: 当前权限矩阵只是文档约定，代码中未强制执行                                        │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   现状: Professional Skill 可以直接调用 get_full_profile()                               │
│                                                                                          │
│   # bazi_service.py                                                                      │
│   profile = await VibeProfileRepository.get_profile(user_id)                             │
│   # 能访问 account, extracted, proactive_state (不应该!)                                 │
│                                                                                          │
│   ═══════════════════════════════════════════════════════════════════════════════════   │
│                                                                                          │
│   解决方案: 强制访问控制层                                                               │
│   ────────────────────────                                                               │
│                                                                                          │
│   class VibeProfileAccessor:                                                             │
│       """带访问控制的 Profile 访问器"""                                                  │
│                                                                                          │
│       def __init__(self, caller_type: str, skill_id: str = None):                        │
│           self.caller_type = caller_type  # "core" | "professional" | "system"          │
│           self.skill_id = skill_id                                                       │
│                                                                                          │
│       async def get_identity(self, user_id: UUID) -> Dict:                               │
│           """所有调用方都可以读 identity"""                                              │
│           return await VibeProfileRepository.get_identity(user_id)                       │
│                                                                                          │
│       async def get_account(self, user_id: UUID) -> Dict:                                │
│           """只有 Core Layer 可以读 account"""                                           │
│           if self.caller_type != "core" and self.caller_type != "system":               │
│               raise PermissionDenied("Professional skills cannot access account")        │
│           return await VibeProfileRepository.get_account(user_id)                        │
│                                                                                          │
│       async def update_skill_data(self, user_id: UUID, skill: str, data: Dict):          │
│           """只能更新自己 skill 的数据"""                                                │
│           if self.caller_type == "professional" and skill != self.skill_id:             │
│               raise PermissionDenied(f"Cannot update skill_data.{skill}")               │
│           await VibeProfileRepository.update_skill_data(user_id, skill, data)            │
│                                                                                          │
│   # 使用                                                                                 │
│   # bazi_service.py                                                                      │
│   accessor = VibeProfileAccessor("professional", skill_id="bazi")                        │
│   identity = await accessor.get_identity(user_id)  # OK                                  │
│   account = await accessor.get_account(user_id)    # Raises PermissionDenied!            │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

#### 问题 5: proactive_state 预计算时机

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│  问题: 何时更新 pending_triggers？                                                       │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│   当前设计: ProactiveEngine 定时扫描 (每小时)                                            │
│                                                                                          │
│   问题 1: 新订阅用户需要等待下次扫描才能收到推送                                         │
│   问题 2: 大量用户时，全量扫描耗时长                                                     │
│   问题 3: 触发条件变化 (如大运交接) 可能被遗漏                                           │
│                                                                                          │
│   ═══════════════════════════════════════════════════════════════════════════════════   │
│                                                                                          │
│   解决方案: 事件驱动 + 定时扫描 混合模式                                                 │
│   ──────────────────────────────────────                                                 │
│                                                                                          │
│   触发时机                          动作                                                 │
│   ────────                          ────                                                 │
│   用户订阅 Skill                   立即计算该 Skill 的 pending_triggers                  │
│   birth_info 更新                  立即重新计算所有 pending_triggers                     │
│   每小时定时任务                   扫描所有用户，补漏                                     │
│   每日 00:00                       更新 liunian 相关触发器                                │
│   大运交接日期                     触发 dayun_change 事件                                │
│                                                                                          │
│   @VibeProfileEvents.on(VibeProfileEvents.BIRTH_INFO_UPDATED)                            │
│   async def recalc_proactive(user_id: UUID, data: Dict):                                 │
│       # 立即重新计算 pending_triggers                                                    │
│       profile = await VibeProfileRepository.get_profile(user_id)                         │
│       subscribed_skills = profile["preferences"]["skill_subscriptions"]                  │
│                                                                                          │
│       for skill_id, sub in subscribed_skills.items():                                    │
│           if sub["status"] == "subscribed":                                              │
│               triggers = await compute_skill_triggers(user_id, skill_id, profile)        │
│               await VibeProfileRepository.update_pending_triggers(user_id, triggers)     │
│                                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 优化建议汇总

| 问题 | 优先级 | 解决方案 |
|------|--------|---------|
| 缓存一致性 | 中 | state 用 Redis，其他保持内存缓存 + 短 TTL |
| JSONB 膨胀 | 高 | checkins 30天限制，facts 100条限制，定期 compact |
| 事件风暴 | 中 | Debounce 5秒去抖 |
| 权限未强制 | 高 | 实现 VibeProfileAccessor 访问控制层 |
| 预计算时机 | 中 | 事件驱动 + 定时扫描混合模式 |

### 5.3 建议的实现顺序

```
Phase 1: 基础架构 (立即)
├── 实现 VibeProfileRepository
├── 实现基础 CRUD 接口
└── 迁移现有 unified_profile_repo 调用

Phase 2: 安全加固 (1周内)
├── 实现 VibeProfileAccessor 访问控制
├── 修改所有 Skill Service 使用 Accessor
└── 添加访问审计日志

Phase 3: 性能优化 (2周内)
├── 实现 state 的 Redis 缓存
├── 实现 JSONB compact 任务
└── 实现事件去抖

Phase 4: Proactive 集成 (2周内)
├── 实现事件驱动的 pending_trigger 更新
├── 修改 ProactiveEngine 使用新接口
└── 端到端测试
```

---

## 6. 数据完整性保障

### 6.1 数据校验规则

```yaml
# Profile 数据校验规则

account:
  user_id: required, uuid
  vibe_id: required, pattern: "VB-[A-Z0-9]{8}"
  status: required, enum: [active, suspended, deleted]
  tier: required, enum: [free, premium, enterprise]
  daily_quota: required, integer, min: 0, max: 1000

identity:
  birth_info:
    date: optional, date, format: "YYYY-MM-DD"
    time: optional, time, format: "HH:mm"
    timezone: optional, iana_timezone
    gender: optional, enum: [male, female, other]

state:
  emotion:
    current: required, enum: [anxious, sad, neutral, content, excited]
    intensity: required, float, min: 0, max: 1
  focus:
    topics: array, max_items: 10
    intensity: float, min: 0, max: 1

preferences:
  push_preferences:
    default_push_hour: integer, min: 0, max: 23
    max_daily_pushes: integer, min: 0, max: 20
    quiet_start_hour: integer, min: 0, max: 23
    quiet_end_hour: integer, min: 0, max: 23

life_context:
  checkins:
    _max_keys: 30  # 最多保留 30 天
    mood: integer, min: 1, max: 10
    energy: integer, min: 1, max: 10
```

### 6.2 定期检查任务

```python
async def profile_health_check():
    """定期检查 Profile 数据健康度"""

    issues = []

    # 1. 检查 JSONB 大小
    large_profiles = await fetch("""
        SELECT user_id, pg_column_size(profile) as size
        FROM unified_profiles
        WHERE pg_column_size(profile) > 50000  -- 50KB
    """)
    for p in large_profiles:
        issues.append(f"Profile too large: {p['user_id']} ({p['size']} bytes)")

    # 2. 检查必填字段
    invalid_profiles = await fetch("""
        SELECT user_id
        FROM unified_profiles
        WHERE profile->'account'->>'user_id' IS NULL
           OR profile->'account'->>'status' IS NULL
    """)
    for p in invalid_profiles:
        issues.append(f"Missing required fields: {p['user_id']}")

    # 3. 检查 checkins 是否需要归档
    stale_checkins = await fetch("""
        SELECT user_id
        FROM unified_profiles
        WHERE jsonb_array_length(
            COALESCE(profile->'life_context'->'checkins', '[]'::jsonb)
        ) > 30
    """)
    for p in stale_checkins:
        await compact_checkins(p['user_id'])

    return issues
```
