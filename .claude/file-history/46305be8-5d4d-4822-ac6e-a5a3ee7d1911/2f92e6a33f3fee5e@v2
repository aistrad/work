# VibeProfile

> VibeLife 系统的核心用户画像、数据、Context 管理中心

## 快速开始

### 读取用户数据

```python
from services.profile.vibe_profile_repo import VibeProfileRepository

# 获取完整 Profile
profile = await VibeProfileRepository.get_profile(user_id)

# 获取特定 Skill 数据
bazi_data = await VibeProfileRepository.get_skill_data(user_id, "bazi")

# 获取用户当前状态
state = await VibeProfileRepository.get_state(user_id)
```

### 更新用户数据

```python
# 更新情绪状态 (会触发 Proactive 检测)
await VibeProfileRepository.update_emotion(user_id, "anxious", intensity=0.8)

# 更新 Skill 计算数据
await VibeProfileRepository.update_skill_data(user_id, "bazi", {
    "chart": {...},
    "features": {"daymaster": "甲木", "strength": "身弱"}
})

# 添加洞察
await VibeProfileRepository.add_insight(
    user_id=user_id,
    insight_type="pattern",
    category="emotion",
    content="用户在工作压力大时容易焦虑",
    confidence=0.8
)
```

### Proactive 集成

```python
# 查询需要推送的用户
users = await VibeProfileRepository.query_users_with_pending_triggers(
    before=datetime.now(),
    skill_id="bazi"
)

# 标记推送已发送
await VibeProfileRepository.mark_trigger_sent(user_id, "bazi_daily_fortune")
```

## 数据架构

```
VibeProfile
├── Hot Layer (JSONB 存储)
│   ├── identity: 身份信息 (birth_info, bazi_chart, zodiac_chart)
│   ├── state: 当前状态 (emotion, focus, life_stage)
│   ├── preferences: 偏好设置
│   └── skill_data: 各 Skill 计算数据
│
├── Warm Layer (JSONB 存储)
│   ├── extracted: 从对话抽取的信息
│   ├── life_context: 生活上下文
│   └── proactive_state: 推送就绪状态
│
└── Cold Layer (独立表存储)
    ├── vibe_profile_insights: 洞察积累
    └── vibe_profile_timeline: 时间线事件
```

## 相关文档

- [SPEC.md](./SPEC.md) - 完整设计规范
- [api-reference.md](./api-reference.md) - API 参考
- [migration.md](./migration.md) - 迁移指南

## Skill 融合规则

| 类型 | Skills | 融合程度 |
|------|--------|---------|
| Core | core, lifecoach, mindfulness | 完全融合，可读写全部数据 |
| Professional | bazi, zodiac, tarot, career, jungastro | 独立运作，只共享基础信息 |

## 设计原则

1. **Single Source of Truth** - 所有用户画像数据统一存储
2. **Data-Centric** - VibeProfile 是数据层，不包含业务逻辑
3. **Schema Evolution** - 基于 unified_profiles 扩展，保持兼容
4. **Performance First** - Hot/Warm/Cold 分层存储
5. **Privacy Aware** - 摘要透明，用户可查看 AI 认知
