# VibeProfile 设计 Review

> 按 Core Layer / Professional Layer 原则审查，补充遗漏的用户数据

---

## 1. 数据审计结果

### 1.1 发现的散落数据

| 数据源 | 表名 | 状态 | 处理建议 |
|--------|------|------|---------|
| 账户信息 | vibe_users | **遗漏** | 新增 account 子域 |
| 推送偏好 | user_push_preferences | **遗漏** | 合并到 preferences |
| Skill 订阅 | user_skill_subscriptions | **遗漏** | 合并到 preferences |
| 推荐屏蔽 | skill_recommendation_blocks | **遗漏** | 合并到 preferences |
| 用户数据存储 | user_data_store | **遗漏** | 合并到 life_context |
| 用户提醒 | user_reminders | **遗漏** | 保留独立表（有定时触发需求） |
| 使用记录 | skill_usage_log | - | 保留独立表（分析用） |
| 对话/消息 | conversations, messages | - | 保留独立表（业务数据） |
| 报告/关系 | reports, relationships | - | 保留独立表（生成内容） |
| 认证 | vibe_user_auth | - | 保留独立表（安全敏感） |

### 1.2 Core Layer / Professional Layer 原则审查

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     VibeProfile 数据访问权限矩阵                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  数据域                 Core Layer         Professional Layer                │
│  ═══════              ════════════        ═══════════════════               │
│                       (core,lifecoach,    (bazi,zodiac,tarot,               │
│                        mindfulness)        career,jungastro)                 │
│                                                                              │
│  identity.birth_info   读/写               读                                │
│  identity.bazi_chart   读                  bazi: 写                          │
│  identity.zodiac_chart 读                  zodiac: 写                        │
│                                                                              │
│  account               读                  禁止                              │
│                                                                              │
│  state.*               读/写               读                                │
│                                                                              │
│  preferences.voice_mode    读              禁止                              │
│  preferences.push_*        读              禁止                              │
│  preferences.skill_subs.*  读              仅读自己的 skill                  │
│                                                                              │
│  life_context.*        读/写               读 (部分)                         │
│                                                                              │
│  skill_data.{skill}    读所有              仅读写自己的                       │
│                                                                              │
│  extracted.*           读/写               禁止                              │
│                                                                              │
│  proactive_state.*     读/写               禁止                              │
│                                                                              │
│  insights (Cold)       读/写               读 (自己 skill 的)                │
│                                                                              │
│  timeline (Cold)       读/写               写 (skill 相关事件)               │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. SPEC.md 需要补充的内容

### 2.1 新增 account 子域

**来源**: vibe_users 表

```yaml
profile:
  account:
    user_id: "uuid"              # 主键
    vibe_id: "VB-A1B2C3D4"       # 用户唯一标识
    display_name: "用户昵称"
    email: "user@example.com"    # 可选
    phone: "+86..."              # 可选
    avatar_url: "https://..."    # 头像
    status: "active"             # active | suspended | deleted
    tier: "free"                 # free | premium | enterprise
    daily_quota: 10              # 每日消息配额
    billing_summary:             # 账单摘要
      plan: "free"
      expires_at: null
    created_at: "2026-01-01"
    last_active_at: "2026-01-19"
```

**访问规则**:
- Core Layer: 只读
- Professional Layer: 禁止访问（不应关心账户信息）

### 2.2 扩展 preferences 子域

**新增来源**:
- user_push_preferences 表
- user_skill_subscriptions 表
- skill_recommendation_blocks 表

```yaml
profile:
  preferences:
    # === 现有字段 ===
    voice_mode: "warm"
    language: "zh-CN"
    privacy_level: "summary"

    # === 新增: 推送偏好 ===
    push_preferences:
      enabled: true
      default_push_hour: 8       # 默认推送时间 (0-23)
      max_daily_pushes: 5        # 每日最大推送数
      quiet_start_hour: 22       # 静默开始
      quiet_end_hour: 7          # 静默结束

    # === 新增: Skill 订阅 ===
    skill_subscriptions:
      core:
        status: "subscribed"     # 始终订阅
        push_enabled: true
      bazi:
        status: "subscribed"
        push_enabled: true
        preferred_push_hour: 6   # 覆盖默认时间
        trial_messages_used: 0
        subscribed_at: "2026-01-01"
      zodiac:
        status: "unsubscribed"
        unsubscribed_at: "2026-01-15"

    # === 新增: 屏蔽的推荐 ===
    blocked_recommendations:
      - skill_id: "tarot"
        block_type: "permanent"
      - skill_id: "jungastro"
        block_type: "temporary"
        expires_at: "2026-02-01"
```

**访问规则**:
- Core Layer: 读/写所有
- Professional Layer: 只读自己 skill 的订阅状态

### 2.3 扩展 life_context 子域

**新增来源**:
- user_data_store 表 (goals, tasks, checkins, files)

```yaml
profile:
  life_context:
    # === 现有字段 ===
    occupation: { ... }
    relationships: { ... }
    health: { ... }
    finance: { ... }

    # === 新增: 目标管理 ===
    goals:
      year_2026:
        - id: "uuid"
          title: "升职到高级产品经理"
          category: "career"
          status: "active"       # active | completed | abandoned
          progress: 0.3
          deadline: "2026-12-31"
          milestones:
            - title: "完成绩效 A"
              completed: false
          created_at: "2026-01-01"

    # === 新增: 任务管理 ===
    tasks:
      - id: "uuid"
        title: "准备季度汇报"
        status: "pending"        # pending | done | cancelled
        due_at: "2026-01-25"
        goal_id: "uuid"          # 关联目标
        created_at: "2026-01-19"

    # === 新增: 打卡记录 ===
    checkins:
      "2026-01-19":
        mood: 7                  # 1-10
        energy: 6
        notes: "今天状态不错"
        tags: ["productive"]
      "2026-01-18":
        mood: 5
        energy: 4
        notes: "有点累"

    # === 新增: 目标追踪配置 ===
    goal_tracking:
      last_checkin: "2026-01-19"
      streak_days: 5
      reminder_time: "08:00"
      enable_fortune_insights: true

    # === 新增: 关注领域 ===
    focus_areas:
      - "career"
      - "health"
      - "relationships"
```

**访问规则**:
- Core Layer: 读/写所有
- Professional Layer: 只读（用于个性化建议）

---

## 3. 保留为独立表的数据

以下数据不应合并到 VibeProfile，保持独立表：

### 3.1 user_reminders (保留独立)

**原因**:
- 有 next_trigger_at 字段，需要索引和定时查询
- 高频更新（触发后更新 last_triggered_at）
- 与 Proactive Worker 紧密集成

**VibeProfile 集成点**:
- 在 proactive_state.pending_triggers 中引用
- 通过 VibeProfileRepository 提供查询接口

### 3.2 skill_usage_log (保留独立)

**原因**:
- 追加写入，不修改
- 用于推荐算法分析
- 数据量大，适合独立表

**VibeProfile 集成点**: 无需集成

### 3.3 conversations / messages (保留独立)

**原因**:
- 业务交互数据
- 高频写入
- 独立生命周期

**VibeProfile 集成点**:
- extracted.* 从对话中抽取信息
- insights 从对话中生成洞察

### 3.4 vibe_user_auth (保留独立)

**原因**:
- 安全敏感数据
- 认证专用
- 不应与画像数据混合

**VibeProfile 集成点**: 无

---

## 4. 数据迁移策略

### 4.1 从独立表到 VibeProfile

```sql
-- 1. 迁移 user_push_preferences 到 profile.preferences.push_preferences
UPDATE unified_profiles up
SET profile = jsonb_set(
    profile,
    '{preferences,push_preferences}',
    (SELECT jsonb_build_object(
        'enabled', true,
        'default_push_hour', COALESCE(pp.default_push_hour, 8),
        'max_daily_pushes', COALESCE(pp.max_daily_pushes, 5),
        'quiet_start_hour', COALESCE(pp.quiet_start_hour, 22),
        'quiet_end_hour', COALESCE(pp.quiet_end_hour, 7)
    )
    FROM user_push_preferences pp
    WHERE pp.user_id = up.user_id)
)
WHERE EXISTS (SELECT 1 FROM user_push_preferences pp WHERE pp.user_id = up.user_id);

-- 2. 迁移 user_skill_subscriptions 到 profile.preferences.skill_subscriptions
-- (需要聚合为 JSONB 对象)
UPDATE unified_profiles up
SET profile = jsonb_set(
    profile,
    '{preferences,skill_subscriptions}',
    (SELECT jsonb_object_agg(
        skill_id,
        jsonb_build_object(
            'status', status,
            'push_enabled', push_enabled,
            'preferred_push_hour', preferred_push_hour,
            'trial_messages_used', trial_messages_used,
            'subscribed_at', subscribed_at,
            'unsubscribed_at', unsubscribed_at
        )
    )
    FROM user_skill_subscriptions ss
    WHERE ss.user_id = up.user_id)
);

-- 3. 迁移 user_data_store (goals) 到 profile.life_context.goals
-- (按 data_type 分别处理)
```

### 4.2 保持双写期

迁移期间保持双写，确保兼容性：

```python
# 写入时双写
async def subscribe_skill(user_id: UUID, skill_id: str):
    # 1. 写入独立表 (保持兼容)
    await SkillSubscriptionRepository.subscribe(user_id, skill_id)

    # 2. 同步到 VibeProfile
    await VibeProfileRepository.update_skill_subscription(user_id, skill_id, {
        "status": "subscribed",
        "push_enabled": True,
        "subscribed_at": datetime.now().isoformat()
    })
```

---

## 5. 更新后的 Profile Schema

```yaml
# unified_profiles.profile 完整 Schema v2
profile:
  # === 新增: 账户信息 ===
  account:
    user_id: "uuid"
    vibe_id: "VB-XXXXXXXX"
    display_name: "string"
    email: "string | null"
    phone: "string | null"
    avatar_url: "string | null"
    status: "active | suspended | deleted"
    tier: "free | premium"
    daily_quota: 10
    billing_summary: {}
    created_at: "timestamp"
    last_active_at: "timestamp"

  # === Hot Layer ===
  identity:
    birth_info: { date, time, place, timezone, gender }
    bazi_chart: { ... }
    zodiac_chart: { ... }

  state:
    emotion: { current, baseline, intensity, last_updated }
    focus: { topics, primary, intensity, since }
    life_stage: { stage, sub_stage, since }
    energy_level: { level, trend, factors }

  preferences:
    voice_mode: "warm | professional | playful"
    language: "zh-CN"
    privacy_level: "summary | full | minimal"
    # 新增
    push_preferences:
      enabled: true
      default_push_hour: 8
      max_daily_pushes: 5
      quiet_start_hour: 22
      quiet_end_hour: 7
    # 新增
    skill_subscriptions:
      "{skill_id}":
        status: "subscribed | unsubscribed"
        push_enabled: true
        preferred_push_hour: 8 | null
        trial_messages_used: 0
        subscribed_at: "timestamp"
        unsubscribed_at: "timestamp | null"
    # 新增
    blocked_recommendations:
      - { skill_id, block_type, expires_at }

  skill_data:
    "{skill_id}": { chart, features, computed_at, ... }

  # === Warm Layer ===
  extracted:
    facts: [ { fact, source, confidence, timestamp } ]
    concerns: [ { topic, intensity, first_mentioned, last_mentioned } ]
    goals: [ { goal, status, deadline, progress } ]
    relationships: [ { name, relation, sentiment, notes } ]

  life_context:
    occupation: { title, industry, company_size, years_in_role }
    relationships: { status, family_structure }
    health: { physical, mental, concerns }
    finance: { level, concerns, goals }
    # 新增
    goals:
      "year_{year}": [ { id, title, category, status, progress, deadline, milestones } ]
    # 新增
    tasks: [ { id, title, status, due_at, goal_id } ]
    # 新增
    checkins:
      "{date}": { mood, energy, notes, tags }
    # 新增
    goal_tracking:
      last_checkin: "date"
      streak_days: 5
      reminder_time: "08:00"
      enable_fortune_insights: true
    # 新增
    focus_areas: [ "career", "health", ... ]

  proactive_state:
    pending_triggers: [ { trigger_id, skill_id, ready_at, priority } ]
    cooldowns: { "{trigger_id}": "timestamp" }
    suppressed: [ { trigger_id, until, reason } ]
    last_scanned_at: "timestamp"

  # === Metadata ===
  _meta:
    version: "2.0"
    last_full_update: "timestamp"
    data_completeness: { identity, state, life_context, ... }
```

---

## 6. 行动项

### 立即执行

- [ ] 更新 SPEC.md 加入 account 子域
- [ ] 更新 SPEC.md 扩展 preferences 子域
- [ ] 更新 SPEC.md 扩展 life_context 子域
- [ ] 更新 api-reference.md 加入新接口

### 迁移阶段

- [ ] 创建数据迁移脚本
- [ ] 实现双写逻辑
- [ ] 测试数据一致性
- [ ] 逐步切换读取源

### 清理阶段

- [ ] 移除双写逻辑
- [ ] 归档独立表数据
- [ ] 更新相关服务

---

## 7. 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| JSONB 性能下降 | 高 | 控制 profile 大小 < 64KB，checkins 只保留最近30天 |
| 迁移数据不一致 | 中 | 双写期间定时校验，发现不一致自动修复 |
| 接口兼容性 | 中 | 保留旧接口，内部代理到 VibeProfile |
| Cold Layer 膨胀 | 低 | insights/timeline 保留独立表，定期归档 |
