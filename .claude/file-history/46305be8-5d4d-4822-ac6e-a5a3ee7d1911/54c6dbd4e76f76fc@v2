# VibeProfile 架构

## 1. 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              VibeLife System                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│   │  Chat API   │  │ Settings API│  │ Proactive   │                         │
│   └──────┬──────┘  └──────┬──────┘  │ Worker      │                         │
│          │                │         └──────┬──────┘                         │
│          ▼                ▼                ▼                                │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                         CoreAgent                                │       │
│   │  ┌──────────────────────────────────────────────────────────┐   │       │
│   │  │                    Skill Services                         │   │       │
│   │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐  │   │       │
│   │  │  │  core  │ │lifecoach││  bazi  │ │ zodiac │ │ tarot  │  │   │       │
│   │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘  │   │       │
│   │  └──────────────────────────────────────────────────────────┘   │       │
│   └─────────────────────────────────┬───────────────────────────────┘       │
│                                     │                                        │
│                                     ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                     VibeProfileRepository                        │       │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │       │
│   │  │   get_*     │  │  update_*   │  │   Cache     │              │       │
│   │  └─────────────┘  └─────────────┘  │  (5min TTL) │              │       │
│   │                                     └─────────────┘              │       │
│   └─────────────────────────────────┬───────────────────────────────┘       │
│                                     │                                        │
│                                     ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                       PostgreSQL                                 │       │
│   │  ┌───────────────────────┐  ┌───────────────┐  ┌────────────┐   │       │
│   │  │   unified_profiles    │  │   insights    │  │  timeline  │   │       │
│   │  │   (profile JSONB)     │  │   (Cold)      │  │  (Cold)    │   │       │
│   │  └───────────────────────┘  └───────────────┘  └────────────┘   │       │
│   └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 数据流

### 2.1 读取流程

```
请求 ──▶ VibeProfileRepository.get_*() ──▶ Cache命中? ──▶ 返回
                                              │
                                              ▼ miss
                                         SELECT from DB
                                              │
                                              ▼
                                         存入 Cache
                                              │
                                              ▼
                                            返回
```

### 2.2 写入流程

```
请求 ──▶ VibeProfileRepository.update_*() ──▶ jsonb_set() ──▶ 失效 Cache
```

## 3. Skill 访问矩阵

```
                        VibeProfile
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
   Core Layer         Professional         System
   (全量读/写)        (受限读/写)         (全量读/写)
        │                   │                   │
   ┌────┴────┐         ┌────┴────┐         ┌────┴────┐
   │  core   │         │  bazi   │         │Proactive│
   │lifecoach│         │ zodiac  │         │ Worker  │
   │mindful  │         │  tarot  │         │         │
   └─────────┘         │ career  │         └─────────┘
                       └─────────┘

Core Layer:    读 全部 / 写 state, extracted
Professional:  读 identity, state / 写 skill_data.{self}
System:        读/写 全部
```

## 4. Proactive 流程

```
每天 04:00
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│                    ProactiveWorker                             │
│                                                                │
│  1. SELECT * FROM unified_profiles                             │
│     WHERE profile->'preferences'->>'push_enabled' = 'true'     │
│                                                                │
│  2. for each user:                                             │
│       - 检查 subscribed_skills                                 │
│       - 为每个 skill 生成今日内容                              │
│       - 存入 notifications 表                                  │
│                                                                │
│  3. 按 push_hour 时间投递                                      │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```

## 5. 时序图：对话场景

```
User        ChatAPI      CoreAgent     VibeProfile     BaziSkill     DB
  │            │             │              │              │          │
  │  发消息    │             │              │              │          │
  │ ──────────▶│             │              │              │          │
  │            │  处理       │              │              │          │
  │            │ ───────────▶│              │              │          │
  │            │             │ get_profile  │              │          │
  │            │             │ ────────────▶│              │          │
  │            │             │              │──▶ Cache/DB ─────────▶│
  │            │             │◀─────────────│              │          │
  │            │             │              │              │          │
  │            │             │ 路由到 Bazi  │              │          │
  │            │             │ ────────────────────────────▶│          │
  │            │             │              │              │ 生成回复 │
  │            │             │◀────────────────────────────│          │
  │            │             │              │              │          │
  │            │             │ update_state │              │          │
  │            │             │ ────────────▶│              │          │
  │            │             │              │──▶ UPDATE ───────────▶│
  │            │             │              │              │          │
  │            │◀────────────│              │              │          │
  │◀───────────│             │              │              │          │
```
