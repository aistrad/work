# VibeLife ç”¨æˆ·æ•°æ®æ²‰æ·€ä¸ Context æœºåˆ¶è®¾è®¡

> åŸºäº MENTIS OSã€VIBE DIARYã€VibeLife Spec çš„æ·±åº¦ç ”ç©¶
> æ ¸å¿ƒæ€æƒ³ï¼šè®© LLM åšè„æ´»ï¼Œæç®€è®¾è®¡

---

## 1. ç ”ç©¶èƒŒæ™¯

### 1.1 æ–‡æ¡£æ¥æº

- `MENTIS OS part1.md / part2.md` - åŸå§‹è®¾è®¡ç†å¿µ
- `VIBE DIARY idea v1.md` - Vibe Diary æ¦‚å¿µ
- `vibelife spec v2.0.md / v2.1.md` - å½“å‰äº§å“è§„èŒƒ

### 1.2 æ ¸å¿ƒé—®é¢˜

1. å¦‚ä½•æ²‰æ·€ç”¨æˆ·æ•°æ®ï¼Œè®© Vibe è¶Šæ¥è¶Š"æ‡‚"ç”¨æˆ·ï¼Ÿ
2. å¦‚ä½•æ„å»ºæœ‰æ•ˆçš„ Contextï¼Œè®©æ¯æ¬¡å¯¹è¯éƒ½æœ‰è®°å¿†ï¼Ÿ
3. å¦‚ä½•ç”¨æç®€çš„æ–¹å¼å®ç°ï¼Œè€Œéè¿‡åº¦å·¥ç¨‹åŒ–ï¼Ÿ

---

## 2. ä» Mentis åˆ° VibeLife çš„æ¼”è¿›

### 2.1 MENTIS OS çš„å¤æ‚è®¾è®¡

```
ç”¨æˆ·è¾“å…¥ (Stream)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¤æ‚çš„æå–ç®¡é“                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. æƒ…ç»ªè¯†åˆ« (8ç§ä¸»æƒ…ç»ª + 12ç§æ¬¡æƒ…ç»ª)                            â”‚
â”‚ 2. è¡Œä¸ºåŒ¹é… (NLU â†’ Auto Checkin)                                â”‚
â”‚ 3. èƒ½é‡è®¡ç®— (energy_score 0-100)                                â”‚
â”‚ 4. åŠ¨é‡ç³»ç»Ÿ (momentum + streak)                                 â”‚
â”‚ 5. è¿åŠ¿è®¡ç®— (å…«å­—æ—¥è¿ + ç´«å¾®æµæ—¥)                               â”‚
â”‚ 6. Agent ä¸»åŠ¨å¹²é¢„ (4ç±»è§¦å‘å™¨)                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               å¤§é‡ç»“æ„åŒ–å­˜å‚¨                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ emotion_history (æƒ…ç»ªå†å²)                                    â”‚
â”‚ â€¢ behavior_checkins (è¡Œä¸ºæ‰“å¡)                                  â”‚
â”‚ â€¢ momentum_log (åŠ¨é‡æ—¥å¿—)                                       â”‚
â”‚ â€¢ energy_snapshots (èƒ½é‡å¿«ç…§)                                   â”‚
â”‚ â€¢ fortune_cache (è¿åŠ¿ç¼“å­˜)                                      â”‚
â”‚ â€¢ pattern_insights (æ¨¡å¼æ´å¯Ÿ)                                   â”‚
â”‚ â€¢ ... åå‡ å¼ è¡¨                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**: è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œç”¨æˆ·ä»·å€¼ä¸æ˜æ˜¾

### 2.2 VibeLife v2.1 çš„ç®€åŒ–æ–¹å‘

```
ç”¨æˆ·å¯¹è¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Vibe Engine (LLM é©±åŠ¨)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ æƒ…ç»ªæ„ŸçŸ¥ (è§„åˆ™ + LLM)                                         â”‚
â”‚ â€¢ Skill è·¯ç”± (æ„å›¾è¯†åˆ«)                                         â”‚
â”‚ â€¢ çŸ¥è¯†æ£€ç´¢ (RAG)                                                â”‚
â”‚ â€¢ Insight ç”Ÿæˆ (4ç§ç±»å‹)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               æ ¸å¿ƒå­˜å‚¨ (å·²å®ç°)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ vibe_users (ç”¨æˆ·åŸºç¡€ä¿¡æ¯)                                     â”‚
â”‚ â€¢ skill_profiles (æŠ€èƒ½æ¡£æ¡ˆ)                                     â”‚
â”‚ â€¢ skill_conversations (å¯¹è¯)                                    â”‚
â”‚ â€¢ skill_messages (æ¶ˆæ¯)                                         â”‚
â”‚ â€¢ skill_insights (æ´å¯Ÿ)                                         â”‚
â”‚ â€¢ knowledge_chunks (çŸ¥è¯†åº“)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—®é¢˜**: Insight Layer è§¦å‘è§„åˆ™è¿‡äºç®€å•ï¼Œç¼ºå°‘ç”¨æˆ·ç”»åƒç§¯ç´¯

---

## 3. æç®€è®¾è®¡æ–¹æ¡ˆï¼šè®© LLM åšè„æ´»

### 3.1 è®¾è®¡åŸåˆ™

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                               â•‘
â•‘                        æç®€è®¾è®¡ä¸‰åŸåˆ™                                          â•‘
â•‘                                                                               â•‘
â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘
â•‘                                                                               â•‘
â•‘   1. å­˜å‚¨æ–‡æœ¬ï¼Œè€Œéç»“æ„                                                       â•‘
â•‘      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â•‘
â•‘      â€¢ ä¸è¦é¢„å®šä¹‰å¤æ‚çš„æ•°æ®ç»“æ„                                               â•‘
â•‘      â€¢ å­˜å‚¨åŸå§‹å¯¹è¯ + LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€æ‘˜è¦                                  â•‘
â•‘      â€¢ æŸ¥è¯¢æ—¶è®© LLM å®æ—¶ç†è§£å’Œæå–                                            â•‘
â•‘                                                                               â•‘
â•‘   2. Context = å¯¹è¯å†å² + ç”¨æˆ·ç”»åƒæ‘˜è¦ + ç›¸å…³çŸ¥è¯†                              â•‘
â•‘      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â•‘
â•‘      â€¢ å¯¹è¯å†å²: æœ€è¿‘ N æ¡æ¶ˆæ¯                                                â•‘
â•‘      â€¢ ç”¨æˆ·ç”»åƒæ‘˜è¦: ä¸€æ®µ LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€æè¿°                              â•‘
â•‘      â€¢ ç›¸å…³çŸ¥è¯†: RAG æ£€ç´¢çš„çŸ¥è¯†ç‰‡æ®µ                                           â•‘
â•‘                                                                               â•‘
â•‘   3. ç”¨ Agent åšå®šæœŸä»»åŠ¡ï¼Œè€Œéå®æ—¶è®¡ç®—                                        â•‘
â•‘      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â•‘
â•‘      â€¢ ä¸è¦åœ¨æ¯æ¡æ¶ˆæ¯ååšå¤æ‚è®¡ç®—                                             â•‘
â•‘      â€¢ ç”¨åå° Agent å®šæœŸæ›´æ–°ç”¨æˆ·ç”»åƒ                                          â•‘
â•‘      â€¢ ç”¨ Cron Job ç”Ÿæˆå‘¨æœŸæ€§æ´å¯Ÿ                                             â•‘
â•‘                                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### 3.2 æ ¸å¿ƒåˆ›æ–°ï¼šUser Portrait (ç”¨æˆ·ç”»åƒæ‘˜è¦)

**ä¼ ç»Ÿæ–¹å¼ (ä¸æ¨è)**:
```sql
-- å¤æ‚çš„ç»“æ„åŒ–å­˜å‚¨
CREATE TABLE user_emotions (id, user_id, emotion, intensity, timestamp);
CREATE TABLE user_topics (id, user_id, topic, frequency, last_mention);
CREATE TABLE user_patterns (id, user_id, pattern_type, evidence, confidence);
CREATE TABLE user_preferences (id, user_id, key, value);
-- ... æ›´å¤šè¡¨
```

**æç®€æ–¹å¼ (æ¨è)**:
```sql
-- ä¸€å¼ è¡¨ï¼Œä¸€ä¸ªæ ¸å¿ƒå­—æ®µ
CREATE TABLE user_portraits (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES vibe_users(id),
    skill_id VARCHAR(50),

    -- æ ¸å¿ƒ: LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€ç”»åƒ
    portrait_text TEXT NOT NULL,

    -- å…ƒæ•°æ®
    generated_at TIMESTAMPTZ DEFAULT NOW(),
    based_on_messages INT,  -- åŸºäºå¤šå°‘æ¡æ¶ˆæ¯ç”Ÿæˆ
    version INT DEFAULT 1,

    UNIQUE(user_id, skill_id)
);
```

### 3.3 portrait_text ç¤ºä¾‹

```
å…³äºè¿™ä½ç”¨æˆ·ï¼Œæˆ‘äº†è§£åˆ°ï¼š

ã€åŸºæœ¬ç‰¹å¾ã€‘
- 1990å¹´3æœˆ15æ—¥å‡ºç”Ÿï¼Œç”²æœ¨æ—¥ä¸»ï¼Œåå°æ ¼
- æ€§æ ¼ç‰¹ç‚¹ï¼šæ€è€ƒå‹ï¼Œè¿½æ±‚å®Œç¾ï¼Œæœ‰æ—¶è¿‡åº¦åˆ†æ
- æ²Ÿé€šé£æ ¼ï¼šå–œæ¬¢æ·±åº¦äº¤æµï¼Œä¸å–œæ¬¢æ³›æ³›è€Œè°ˆ

ã€è¿‘æœŸçŠ¶æ€ã€‘
- æœ€è¿‘ä¸¤å‘¨ä¸»è¦è¯é¢˜ï¼šå·¥ä½œå‹åŠ›ã€èŒä¸šæ–¹å‘è¿·èŒ«
- æƒ…ç»ªåŸºè°ƒï¼šç•¥æ˜¾ç„¦è™‘ï¼Œä½†åœ¨ç§¯æå¯»æ±‚æ”¹å˜
- æåˆ°3æ¬¡"å·®ä¸€ç‚¹ç‚¹"ï¼Œå¯èƒ½ä¸åå°è¿æœ‰å…³

ã€é‡è¦æ´å¯Ÿã€‘
- å†³ç­–æ¨¡å¼ï¼šå®¹æ˜“çŠ¹è±«ï¼Œå€¾å‘äºè¿‡åº¦å‡†å¤‡
- å‘ç°äº†ä¸€ä¸ªè§„å¾‹ï¼šå‘¨æœ«æƒ…ç»ªæ™®éæ¯”å·¥ä½œæ—¥å¥½
- ä¸Šæ¬¡èŠåˆ°å®¶åº­æ—¶ï¼Œè¯­æ°”æ˜æ˜¾å˜æŸ”å’Œ

ã€äº’åŠ¨åå¥½ã€‘
- å–œæ¬¢æˆ‘ç»™å‡ºå…·ä½“çš„è¡ŒåŠ¨å»ºè®®
- ä¸å–œæ¬¢è¿‡äºç¬¼ç»Ÿçš„å®‰æ…°
- å¯¹å‘½ç†è§£é‡Šæ¥å—åº¦é«˜ï¼Œä½†ä¸æƒ³å¬"ç®—å‘½"

ã€å½“å‰å…³æ³¨ã€‘
- æ­£åœ¨è€ƒè™‘è·³æ§½ï¼Œä½†æ‹…å¿ƒæ—¶æœºä¸å¯¹
- æåˆ°è¿‡æƒ³å­¦ä¹ å†¥æƒ³ï¼Œè¿˜æ²¡å¼€å§‹
```

---

## 4. æ•°æ®æµè®¾è®¡

### 4.1 å®æ—¶æµç¨‹ (æ¯æ¡æ¶ˆæ¯)

```
ç”¨æˆ·æ¶ˆæ¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Assembly (å®æ—¶)                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  1. è¯»å– user_portraits.portrait_text (1æ¬¡æ•°æ®åº“æŸ¥è¯¢)               â”‚
â”‚  2. è¯»å–æœ€è¿‘ 6 æ¡ skill_messages (1æ¬¡æ•°æ®åº“æŸ¥è¯¢)                    â”‚
â”‚  3. RAG æ£€ç´¢ç›¸å…³çŸ¥è¯† (1æ¬¡å‘é‡æŸ¥è¯¢)                                  â”‚
â”‚                                                                     â”‚
â”‚  æ€»å…±: 3 æ¬¡æŸ¥è¯¢ï¼Œæ¯«ç§’çº§                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM System Prompt æ„å»º                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚  ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªæ¸©æš–çš„å‘½ç†åˆ†æå¸ˆ...                                 â”‚
â”‚                                                                     â”‚
â”‚  ## å…³äºè¿™ä½ç”¨æˆ·                                                    â”‚
â”‚  {portrait_text}                                                    â”‚
â”‚                                                                     â”‚
â”‚  ## ç›¸å…³çŸ¥è¯†                                                        â”‚
â”‚  {rag_context}                                                      â”‚
â”‚                                                                     â”‚
â”‚  ## æœ€è¿‘å¯¹è¯                                                        â”‚
â”‚  {recent_messages}                                                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM ç”Ÿæˆå“åº”                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿å­˜æ¶ˆæ¯ (å®æ—¶)                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° skill_messages                                    â”‚
â”‚  â€¢ ä¿å­˜åŠ©æ‰‹å“åº”åˆ° skill_messages                                    â”‚
â”‚  â€¢ ä¸åšå…¶ä»–ä»»ä½•è®¡ç®—                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 åå°æµç¨‹ (å®šæœŸæ‰§è¡Œ)

```
Portrait Agent (æ¯å¤©/æ¯10æ¡æ¶ˆæ¯è§¦å‘)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è¯»å–ç”¨æˆ·æœ€è¿‘ 50 æ¡æ¶ˆæ¯                                          â”‚
â”‚  2. è¯»å–å½“å‰ portrait_text (å¦‚æœå­˜åœ¨)                               â”‚
â”‚  3. è®© LLM ç”Ÿæˆ/æ›´æ–°ç”¨æˆ·ç”»åƒ                                        â”‚
â”‚  4. ä¿å­˜æ–°çš„ portrait_text                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Insight Agent (å¯¹è¯ç»“æŸåè§¦å‘)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è¯»å–ç”¨æˆ·ç”»åƒ + æœ¬æ¬¡å¯¹è¯å†…å®¹                                     â”‚
â”‚  2. è®© LLM åˆ¤æ–­æ˜¯å¦å€¼å¾—ç”Ÿæˆæ´å¯Ÿ                                     â”‚
â”‚  3. å¦‚æœå€¼å¾—ï¼Œç”Ÿæˆæ´å¯Ÿå¹¶ä¿å­˜åˆ° skill_insights                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. æç¤ºè¯è®¾è®¡

### 5.1 Portrait Agent æç¤ºè¯

```python
PORTRAIT_UPDATE_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªç”¨æˆ·ç”»åƒåˆ†æä¸“å®¶ã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºè¿™ä½ç”¨æˆ·ç”Ÿæˆæˆ–æ›´æ–°ç”»åƒæ‘˜è¦ã€‚

## å½“å‰ç”»åƒ (å¦‚æœå­˜åœ¨)
{current_portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰ç”»åƒ"}

## ç”¨æˆ·åŸºç¡€ä¿¡æ¯
- å‡ºç”Ÿæ—¥æœŸ: {birth_datetime}
- å…«å­—: {bazi_chart}
- ä½¿ç”¨æŠ€èƒ½: {skill_id}

## æœ€è¿‘ {message_count} æ¡å¯¹è¯
{recent_messages}

## ä»»åŠ¡
è¯·ç”Ÿæˆä¸€ä»½è‡ªç„¶è¯­è¨€çš„ç”¨æˆ·ç”»åƒï¼ŒåŒ…æ‹¬:

1. ã€åŸºæœ¬ç‰¹å¾ã€‘- æ€§æ ¼ç‰¹ç‚¹ã€æ²Ÿé€šé£æ ¼
2. ã€è¿‘æœŸçŠ¶æ€ã€‘- æœ€è¿‘çš„ä¸»è¦è¯é¢˜ã€æƒ…ç»ªåŸºè°ƒ
3. ã€é‡è¦æ´å¯Ÿã€‘- å‘ç°çš„æ¨¡å¼ã€è§„å¾‹
4. ã€äº’åŠ¨åå¥½ã€‘- å–œæ¬¢ä»€ä¹ˆæ ·çš„å›åº”æ–¹å¼
5. ã€å½“å‰å…³æ³¨ã€‘- æ­£åœ¨æ€è€ƒæˆ–å¤„ç†çš„äº‹æƒ…

è¦æ±‚:
- ç”¨ç¬¬ä¸‰äººç§°æè¿°
- å…·ä½“è€Œéç¬¼ç»Ÿ
- å¦‚æœæ˜¯æ›´æ–°ï¼Œä¿ç•™é‡è¦çš„å†å²ä¿¡æ¯ï¼Œæ›´æ–°è¿‡æ—¶çš„ä¿¡æ¯
- æ§åˆ¶åœ¨ 500 å­—ä»¥å†…
- åªè¾“å‡ºç”»åƒå†…å®¹ï¼Œä¸è¦å…¶ä»–è§£é‡Š
"""
```

### 5.2 Insight åˆ¤æ–­æç¤ºè¯

```python
INSIGHT_CHECK_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªæ´å¯Ÿåˆ¤æ–­ä¸“å®¶ã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦åº”è¯¥ç”Ÿæˆæ´å¯Ÿã€‚

## ç”¨æˆ·ç”»åƒ
{portrait_text}

## æœ¬æ¬¡å¯¹è¯
{conversation}

## æœ€è¿‘ç”Ÿæˆçš„æ´å¯Ÿ (é¿å…é‡å¤)
{recent_insights}

## ä»»åŠ¡
åˆ¤æ–­æœ¬æ¬¡å¯¹è¯æ˜¯å¦åŒ…å«å€¼å¾—è®°å½•çš„æ´å¯Ÿã€‚

æ´å¯Ÿç±»å‹:
1. DISCOVERY - é¦–æ¬¡å‘ç°ç”¨æˆ·çš„æ–°ç‰¹å¾æˆ–æ¨¡å¼
2. PATTERN - å‘ç°é‡å¤å‡ºç°çš„è§„å¾‹ (éœ€è¦è‡³å°‘å‡ºç°3æ¬¡)
3. GROWTH - å‘ç°ç”¨æˆ·çš„ç§¯æå˜åŒ–æˆ–çªç ´
4. TIMING - å‘ç°ä¸å½“å‰è¿åŠ¿ç›¸å…³çš„æ—¶æœºå»ºè®®

è¯·è¿”å› JSON:
{
  "should_generate": true/false,
  "reason": "ä¸ºä»€ä¹ˆå€¼å¾—/ä¸å€¼å¾—ç”Ÿæˆ",
  "insight_type": "DISCOVERY/PATTERN/GROWTH/TIMING/null",
  "insight_title": "æ´å¯Ÿæ ‡é¢˜ (å¦‚æœç”Ÿæˆ)",
  "insight_content": "æ´å¯Ÿå†…å®¹ (å¦‚æœç”Ÿæˆ)"
}

æ³¨æ„:
- ä¸è¦ä¸ºäº†ç”Ÿæˆè€Œç”Ÿæˆï¼Œåªæœ‰çœŸæ­£æœ‰ä»·å€¼çš„æ‰ç”Ÿæˆ
- é¿å…ä¸æœ€è¿‘çš„æ´å¯Ÿé‡å¤
- æ´å¯Ÿåº”è¯¥å…·ä½“ã€å¯è¡ŒåŠ¨
"""
```

---

## 6. æ•°æ®åº“ Schema

### 6.1 ç”¨æˆ·ç”»åƒè¡¨

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- æç®€ç‰ˆ User Insight æ²‰æ·€ Schema
-- æ ¸å¿ƒç†å¿µ: å­˜å‚¨æ–‡æœ¬ï¼Œè®© LLM åšç†è§£
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- ç”¨æˆ·ç”»åƒè¡¨ (æ ¸å¿ƒ)
CREATE TABLE user_portraits (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,

    -- æ ¸å¿ƒ: LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€ç”»åƒ
    portrait_text TEXT NOT NULL,

    -- å…ƒæ•°æ®
    based_on_messages INT DEFAULT 0,  -- åŸºäºå¤šå°‘æ¡æ¶ˆæ¯ç”Ÿæˆ
    last_message_id UUID,             -- æœ€åå¤„ç†çš„æ¶ˆæ¯ID
    generated_at TIMESTAMPTZ DEFAULT NOW(),
    version INT DEFAULT 1,

    UNIQUE(user_id, skill_id)
);

-- ç”»åƒå†å²è¡¨ (å¯é€‰ï¼Œç”¨äºè¿½è¸ªæ¼”å˜)
CREATE TABLE user_portrait_history (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    portrait_text TEXT NOT NULL,
    version INT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_portraits_user_skill ON user_portraits(user_id, skill_id);
CREATE INDEX idx_portrait_history_user ON user_portrait_history(user_id, created_at DESC);
```

---

## 7. å®ç°ä»£ç 

### 7.1 PortraitService

```python
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# portrait_service.py - ç”¨æˆ·ç”»åƒæœåŠ¡
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

from typing import Optional
from uuid import UUID

class PortraitService:
    """
    æç®€ç”¨æˆ·ç”»åƒæœåŠ¡
    æ ¸å¿ƒæ€æƒ³: è®© LLM åšç†è§£å’Œæå–ï¼Œæˆ‘ä»¬åªè´Ÿè´£å­˜å‚¨å’Œè°ƒåº¦
    """

    # è§¦å‘æ¡ä»¶
    UPDATE_INTERVAL_MESSAGES = 10  # æ¯ 10 æ¡æ¶ˆæ¯æ›´æ–°ä¸€æ¬¡

    @staticmethod
    async def get_portrait(user_id: UUID, skill_id: str) -> Optional[str]:
        """è·å–ç”¨æˆ·ç”»åƒæ–‡æœ¬"""
        async with get_connection() as conn:
            row = await conn.fetchrow(
                """
                SELECT portrait_text FROM user_portraits
                WHERE user_id = $1 AND skill_id = $2
                """,
                user_id, skill_id
            )
            return row["portrait_text"] if row else None

    @staticmethod
    async def should_update(user_id: UUID, skill_id: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦åº”è¯¥æ›´æ–°ç”»åƒ"""
        async with get_connection() as conn:
            portrait = await conn.fetchrow(
                """
                SELECT based_on_messages, last_message_id
                FROM user_portraits
                WHERE user_id = $1 AND skill_id = $2
                """,
                user_id, skill_id
            )

            # æ–°ç”¨æˆ·ï¼Œéœ€è¦ç”Ÿæˆ
            if not portrait:
                return True

            # è®¡ç®—æ–°æ¶ˆæ¯æ•°é‡
            new_messages = await conn.fetchval(
                """
                SELECT COUNT(*) FROM skill_messages sm
                JOIN skill_conversations sc ON sm.conversation_id = sc.id
                WHERE sc.user_id = $1 AND sc.skill_id = $2
                  AND (sm.id > $3 OR $3 IS NULL)
                """,
                user_id, skill_id, portrait["last_message_id"]
            )

            return new_messages >= PortraitService.UPDATE_INTERVAL_MESSAGES

    @staticmethod
    async def update_portrait(
        user_id: UUID,
        skill_id: str,
        llm_orchestrator
    ) -> str:
        """æ›´æ–°ç”¨æˆ·ç”»åƒ (åå°ä»»åŠ¡)"""

        # 1. è·å–å½“å‰ç”»åƒ
        current_portrait = await PortraitService.get_portrait(user_id, skill_id)

        # 2. è·å–ç”¨æˆ·åŸºç¡€ä¿¡æ¯
        async with get_connection() as conn:
            user = await conn.fetchrow(
                "SELECT * FROM vibe_users WHERE id = $1", user_id
            )
            profile = await conn.fetchrow(
                """SELECT profile_data FROM skill_profiles
                   WHERE user_id = $1 AND skill_id = $2""",
                user_id, skill_id
            )

        # 3. è·å–æœ€è¿‘æ¶ˆæ¯
        messages = await SkillRepository.get_recent_messages(
            user_id, skill_id, limit=50
        )

        # 4. æ„å»ºæç¤ºè¯
        prompt = PORTRAIT_UPDATE_PROMPT.format(
            current_portrait=current_portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰ç”»åƒ",
            birth_datetime=user["birth_datetime"],
            bazi_chart=profile["profile_data"].get("bazi", {}) if profile else {},
            skill_id=skill_id,
            message_count=len(messages),
            recent_messages=format_messages(messages)
        )

        # 5. è°ƒç”¨ LLM
        response = await llm_orchestrator.chat(
            [LLMMessage(role="user", content=prompt)],
            temperature=0.3,
            max_tokens=1000
        )

        new_portrait = response.content

        # 6. ä¿å­˜ç”»åƒ
        last_msg_id = messages[0]["id"] if messages else None

        async with get_connection() as conn:
            # ä¿å­˜å†å²
            if current_portrait:
                await conn.execute(
                    """
                    INSERT INTO user_portrait_history (user_id, skill_id, portrait_text, version)
                    SELECT user_id, skill_id, portrait_text, version
                    FROM user_portraits WHERE user_id = $1 AND skill_id = $2
                    """,
                    user_id, skill_id
                )

            # æ›´æ–°/æ’å…¥æ–°ç”»åƒ
            await conn.execute(
                """
                INSERT INTO user_portraits (user_id, skill_id, portrait_text, based_on_messages, last_message_id, version)
                VALUES ($1, $2, $3, $4, $5, 1)
                ON CONFLICT (user_id, skill_id)
                DO UPDATE SET
                    portrait_text = $3,
                    based_on_messages = user_portraits.based_on_messages + $4,
                    last_message_id = $5,
                    version = user_portraits.version + 1,
                    generated_at = NOW()
                """,
                user_id, skill_id, new_portrait, len(messages), last_msg_id
            )

        return new_portrait
```

### 7.2 InsightService (ç®€åŒ–ç‰ˆ)

```python
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# insight_service.py - æ´å¯ŸæœåŠ¡ (ç®€åŒ–ç‰ˆ)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import json
from typing import Optional
from uuid import UUID

class InsightService:
    """
    æç®€æ´å¯ŸæœåŠ¡
    æ ¸å¿ƒæ€æƒ³: è®© LLM åˆ¤æ–­æ˜¯å¦å€¼å¾—ç”Ÿæˆæ´å¯Ÿï¼Œè€Œéå¤æ‚çš„è§„åˆ™å¼•æ“
    """

    @staticmethod
    async def maybe_generate_insight(
        user_id: UUID,
        skill_id: str,
        conversation_id: UUID,
        llm_orchestrator
    ) -> Optional[dict]:
        """åœ¨å¯¹è¯ç»“æŸåè°ƒç”¨ï¼Œåˆ¤æ–­æ˜¯å¦ç”Ÿæˆæ´å¯Ÿ"""

        # 1. è·å–ç”¨æˆ·ç”»åƒ
        portrait = await PortraitService.get_portrait(user_id, skill_id)
        if not portrait:
            return None

        # 2. è·å–æœ¬æ¬¡å¯¹è¯
        conversation = await SkillRepository.get_messages(
            conversation_id, limit=20
        )

        # 3. è·å–æœ€è¿‘æ´å¯Ÿ (é¿å…é‡å¤)
        recent_insights = await SkillRepository.get_user_insights(
            user_id, skill_id, limit=5
        )

        # 4. è®© LLM åˆ¤æ–­
        prompt = INSIGHT_CHECK_PROMPT.format(
            portrait_text=portrait,
            conversation=format_messages(conversation),
            recent_insights=format_insights(recent_insights)
        )

        response = await llm_orchestrator.chat(
            [LLMMessage(role="user", content=prompt)],
            temperature=0.3,
            max_tokens=500
        )

        try:
            result = json.loads(response.content)
        except:
            return None

        # 5. å¦‚æœåˆ¤æ–­åº”è¯¥ç”Ÿæˆï¼Œä¿å­˜æ´å¯Ÿ
        if result.get("should_generate"):
            insight = await SkillRepository.create_insight(
                user_id=user_id,
                skill_id=skill_id,
                insight_type=result["insight_type"].lower(),
                title=result["insight_title"],
                content=result["insight_content"],
                confidence=0.8,
                conversation_id=conversation_id
            )
            return insight

        return None
```

### 7.3 AgentRuntime é›†æˆ

```python
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# runtime.py ä¿®æ”¹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import asyncio
from typing import Optional
from uuid import UUID

class AgentRuntime:

    @classmethod
    async def process_message(
        cls,
        user_id: UUID,
        skill_id: str,
        message: str,
        conversation_id: Optional[UUID] = None
    ) -> AgentResponse:
        """æç®€æ¶ˆæ¯å¤„ç†æµç¨‹"""

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 1. Context Assembly (3æ¬¡æŸ¥è¯¢)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        # 1.1 è·å–ç”¨æˆ·ç”»åƒ (1æ¬¡æŸ¥è¯¢)
        portrait = await PortraitService.get_portrait(user_id, skill_id)

        # 1.2 è·å–å¯¹è¯å†å² (1æ¬¡æŸ¥è¯¢)
        history = await SkillRepository.get_messages(conversation_id, limit=6)

        # 1.3 çŸ¥è¯†æ£€ç´¢ (1æ¬¡å‘é‡æŸ¥è¯¢)
        knowledge = await RetrievalService.get_context_for_query(message, skill_id)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 2. æ„å»º System Prompt
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        system_prompt = f"""
ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªæ¸©æš–çš„å‘½ç†åˆ†æå¸ˆ...

## å…³äºè¿™ä½ç”¨æˆ·
{portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰è¶³å¤Ÿçš„äº†è§£"}

## ç›¸å…³çŸ¥è¯†
{knowledge}
"""

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 3. LLM ç”Ÿæˆ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        messages = build_messages(system_prompt, history, message)
        response = await LLMOrchestrator.chat(messages)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 4. ä¿å­˜æ¶ˆæ¯ (åŒæ­¥ï¼Œå¿…é¡»)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        await SkillRepository.add_message(conversation_id, "user", message)
        await SkillRepository.add_message(conversation_id, "assistant", response.content)

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # 5. åå°ä»»åŠ¡ (å¼‚æ­¥ï¼Œä¸é˜»å¡)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ç”»åƒ
        asyncio.create_task(
            cls._maybe_update_portrait(user_id, skill_id)
        )

        return AgentResponse(content=response.content, ...)

    @staticmethod
    async def _maybe_update_portrait(user_id: UUID, skill_id: str):
        """åå°æ£€æŸ¥å¹¶æ›´æ–°ç”»åƒ"""
        try:
            if await PortraitService.should_update(user_id, skill_id):
                await PortraitService.update_portrait(
                    user_id, skill_id, LLMOrchestrator
                )
        except Exception as e:
            print(f"Portrait update failed: {e}")

    @classmethod
    async def on_conversation_end(
        cls,
        user_id: UUID,
        skill_id: str,
        conversation_id: UUID
    ):
        """å¯¹è¯ç»“æŸæ—¶è°ƒç”¨"""

        # å°è¯•ç”Ÿæˆæ´å¯Ÿ
        await InsightService.maybe_generate_insight(
            user_id, skill_id, conversation_id, LLMOrchestrator
        )
```

---

## 8. æ–¹æ¡ˆå¯¹æ¯”

### 8.1 å¤æ‚æ–¹æ¡ˆ vs æç®€æ–¹æ¡ˆ

| ç»´åº¦ | å¤æ‚æ–¹æ¡ˆ | æç®€æ–¹æ¡ˆ |
|------|---------|---------|
| **æ•°æ®åº“è¡¨** | 5+ å¼  (topic_mentions, emotion_history, topic_dictionary...) | **1 å¼ ** (user_portraits) |
| **æ–°æ¨¡å—** | 4 ä¸ª (~500è¡Œä»£ç ) | **2 ä¸ª** (~150è¡Œä»£ç ) |
| **å®æ—¶è®¡ç®—** | è¯é¢˜æå–ã€æƒ…ç»ªåˆ†æã€é¦–æ¬¡æåŠã€æ¨¡å¼åŒ¹é… | **æ— ** |
| **åå°ä»»åŠ¡** | å¤æ‚çš„æ¨¡å¼æ£€æµ‹ | ç®€å•çš„ LLM è°ƒç”¨ |
| **è§¦å‘è§„åˆ™** | ç¡¬ç¼–ç çš„è§„åˆ™å¼•æ“ | LLM åˆ¤æ–­ (æç¤ºè¯å³è§„åˆ™) |
| **å·¥ä½œé‡** | 5-7 å¤© | **1-2 å¤©** |
| **ç»´æŠ¤æˆæœ¬** | é«˜ (ä»£ç  + è§„åˆ™) | **ä½** (åªéœ€è°ƒæç¤ºè¯) |

### 8.2 æˆæœ¬åˆ†æ

**LLM æˆæœ¬:**
- ç”»åƒæ›´æ–°: æ¯ 10 æ¡æ¶ˆæ¯è°ƒç”¨ 1 æ¬¡ LLM (~$0.01)
- æ´å¯Ÿåˆ¤æ–­: æ¯æ¬¡å¯¹è¯ç»“æŸè°ƒç”¨ 1 æ¬¡ LLM (~$0.005)
- æ€»è®¡: ç”¨æˆ·æ¯å¤© $0.02-0.05 çš„ LLM æˆæœ¬

**å¼€å‘æˆæœ¬:**
- å¤æ‚æ–¹æ¡ˆ: 5-7 å¤©å¼€å‘ + æŒç»­ç»´æŠ¤
- æç®€æ–¹æ¡ˆ: 1-2 å¤©å¼€å‘ + æç¤ºè¯è¿­ä»£

**ç»“è®º**: LLM æˆæœ¬ << å¼€å‘ç»´æŠ¤æˆæœ¬

---

## 9. å®ç°è®¡åˆ’

### Phase 1: æ•°æ®åº“ (0.5 å¤©)
- [ ] åˆ›å»º `user_portraits` è¡¨
- [ ] åˆ›å»º `user_portrait_history` è¡¨ (å¯é€‰)

### Phase 2: æ ¸å¿ƒæœåŠ¡ (1 å¤©)
- [ ] å®ç° `PortraitService`
  - [ ] `get_portrait()` - è·å–ç”»åƒ
  - [ ] `should_update()` - åˆ¤æ–­æ˜¯å¦æ›´æ–°
  - [ ] `update_portrait()` - æ›´æ–°ç”»åƒ
- [ ] ç®€åŒ– `InsightService`
  - [ ] `maybe_generate_insight()` - LLM é©±åŠ¨çš„æ´å¯Ÿåˆ¤æ–­

### Phase 3: é›†æˆ (0.5 å¤©)
- [ ] ä¿®æ”¹ `AgentRuntime`
  - [ ] Context Assembly ä½¿ç”¨ç”»åƒ
  - [ ] åå°è§¦å‘ç”»åƒæ›´æ–°
  - [ ] å¯¹è¯ç»“æŸè§¦å‘æ´å¯Ÿåˆ¤æ–­

### å…³é”®ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `migrations/002_user_portraits.sql` | æ–°å¢ | ç”»åƒè¡¨å®šä¹‰ |
| `apps/api/services/vibe_engine/portrait_service.py` | æ–°å¢ | ç”»åƒæœåŠ¡ |
| `apps/api/services/vibe_engine/insight_generator.py` | ä¿®æ”¹ | ç®€åŒ–ä¸º LLM é©±åŠ¨ |
| `apps/api/services/agent/runtime.py` | ä¿®æ”¹ | é›†æˆç”»åƒåˆ° Context |

---

## 10. æ€»ç»“

### æ ¸å¿ƒç†å¿µ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                               â•‘
â•‘   ä¼ ç»Ÿæ–¹å¼: äººç±»è®¾è®¡è§„åˆ™ï¼Œä»£ç æ‰§è¡Œè§„åˆ™                                         â•‘
â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘
â•‘   â€¢ é¢„å®šä¹‰æ•°æ®ç»“æ„                                                            â•‘
â•‘   â€¢ ç¼–å†™å¤æ‚çš„æå–è§„åˆ™                                                        â•‘
â•‘   â€¢ ç»´æŠ¤è§„åˆ™å’Œè¾¹ç•Œæ¡ä»¶                                                        â•‘
â•‘   â€¢ è§„åˆ™åƒµåŒ–ï¼Œéš¾ä»¥é€‚åº”å˜åŒ–                                                    â•‘
â•‘                                                                               â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â•‘
â•‘                                                                               â•‘
â•‘   æç®€æ–¹å¼: å­˜å‚¨æ–‡æœ¬ï¼ŒLLM åšç†è§£                                              â•‘
â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘
â•‘   â€¢ å­˜å‚¨åŸå§‹å¯¹è¯ + LLM ç”Ÿæˆçš„æ‘˜è¦                                             â•‘
â•‘   â€¢ è®© LLM å®æ—¶ç†è§£å’Œæå–                                                     â•‘
â•‘   â€¢ æç¤ºè¯å³è§„åˆ™ï¼Œæ˜“äºè¿­ä»£                                                    â•‘
â•‘   â€¢ çµæ´»é€‚åº”å„ç§æƒ…å†µ                                                          â•‘
â•‘                                                                               â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â•‘
â•‘                                                                               â•‘
â•‘                   "ä¸è¦ç”¨ä»£ç è§£å†³ LLM èƒ½è§£å†³çš„é—®é¢˜"                            â•‘
â•‘                                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### ä¼˜åŠ¿

1. **ä»£ç é‡å‡å°‘ 80%+** - ä» 5-7 å¤© â†’ 1-2 å¤©
2. **ç»´æŠ¤æˆæœ¬ä½** - æ”¹æç¤ºè¯æ¯”æ”¹ä»£ç å®¹æ˜“
3. **æ›´æ™ºèƒ½** - LLM ç†è§£èƒ½åŠ› > è§„åˆ™åŒ¹é…
4. **æ›´çµæ´»** - é€‚åº”å„ç§è¾¹ç•Œæƒ…å†µ
5. **æ›´å¿«è¿­ä»£** - A/B æµ‹è¯•ä¸åŒæç¤ºè¯

---

## 11. è¡¥ä¸ä¼˜åŒ–ï¼šé˜²æ­¢"JPEG å‹ç¼©æŸè€—"

### 11.1 é—®é¢˜ï¼šä¼ å£°ç­’æ•ˆåº”

éšç€å¯¹è¯è¶Šæ¥è¶Šå¤šï¼Œ`portrait_text` ä¼šè¢«åå¤é‡å†™ï¼Œå°±åƒå›¾ç‰‡è¢«åå¤ JPEG å‹ç¼©ï¼Œç»†èŠ‚ä¼šè¶Šæ¥è¶Šæ¨¡ç³Šã€‚

**åœºæ™¯æ¨¡æ‹Ÿï¼š**
- Day 1: ç”¨æˆ·è¯´"æˆ‘æœ‰ä¸€åªå«æ—ºè´¢çš„é‡‘æ¯›ï¼Œå®ƒæ€•æ°´" â†’ å†™å…¥ç”»åƒ
- Day 30: ç”»åƒæ›´æ–° 10 æ¬¡ï¼Œè¢«å‹ç¼©æˆ"å…»æœ‰ä¸€åªå® ç‰©ç‹—"
- Day 60: ç”¨æˆ·é—®"æˆ‘æƒ³å¸¦ç‹—å»æ¸¸æ³³ï¼Œåˆé€‚å—ï¼Ÿ"
- AI å›å¤: "å½“ç„¶åˆé€‚å•Šï¼"ï¼ˆé”™è¯¯ï¼Œå¿˜äº†ç‹—æ€•æ°´ï¼‰

### 11.2 è§£å†³æ–¹æ¡ˆï¼šHot & Cold åŒå±‚è®°å¿†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚                      Hot & Cold åŒå±‚è®°å¿†ä½“ç³»                                 â”‚
â”‚                                                                             â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                             â”‚
â”‚   Hot Memory (çƒ­è®°å¿†) - user_portraits                                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚   â€¢ å®è§‚çŠ¶æ€ï¼šæ€§æ ¼ã€è¿‘æœŸæƒ…ç»ªã€äº’åŠ¨åå¥½                                       â”‚
â”‚   â€¢ é¢‘ç¹æ›´æ–°ï¼šæ¯ 10 æ¡æ¶ˆæ¯é‡å†™                                              â”‚
â”‚   â€¢ ç‰¹ç‚¹ï¼šå‹ç¼©çš„ã€æµåŠ¨çš„ã€æ¦‚æ‹¬æ€§çš„                                          â”‚
â”‚                                                                             â”‚
â”‚   Cold Memory (å†·è®°å¿†) - skill_insights + embedding                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚   â€¢ å¾®è§‚äº‹å®ï¼šå…·ä½“çš„å‘ç°ã€æ¨¡å¼ã€é‡è¦ç»†èŠ‚                                    â”‚
â”‚   â€¢ åªå¢ä¸æ”¹ï¼šæ´å¯Ÿä¸€æ—¦ç”Ÿæˆä¸ä¼šè¢«è¦†ç›–                                        â”‚
â”‚   â€¢ ç‰¹ç‚¹ï¼šç²¾ç¡®çš„ã€æŒä¹…çš„ã€å¯æ£€ç´¢çš„                                          â”‚
â”‚                                                                             â”‚
â”‚   æ£€ç´¢ç­–ç•¥ï¼šæ··åˆç­–ç•¥                                                        â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚   1. å¯¹ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆ embedding                                               â”‚
â”‚   2. å¿«é€ŸæŸ¥è¯¢ top-1 ç›¸ä¼¼ Insight                                            â”‚
â”‚   3. å¦‚æœç›¸ä¼¼åº¦ > 0.75ï¼Œæ‰©å±•æ£€ç´¢ top-3 ä½œä¸º Context                         â”‚
â”‚   4. æˆæœ¬çº¦ $0.0001/æ¬¡ï¼Œå¯æ¥å—                                              â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 11.3 ç”»åƒç»“æ„åŒ–ï¼šFact Anchoring

ä¸ºé˜²æ­¢ LLM åœ¨æ›´æ–°æ—¶ä¸¢å¤±é‡è¦äº‹å®ï¼Œå¼ºåˆ¶è¾“å‡ºç»“æ„åŒ–æ ¼å¼ï¼š

```markdown
# ç”¨æˆ·ç”»åƒ

## ğŸ“Œ é•¿æœŸäº‹å® (Facts)
*ä¸éšæ—¶é—´æ”¹å˜çš„ç¡¬äº‹å®ï¼Œæ›´æ–°æ—¶å¿…é¡»ä¿ç•™ï¼*
- å…»æœ‰ä¸€åªé‡‘æ¯›å«"æ—ºè´¢"ï¼Œæ€•æ°´
- å¯¹èŠ±ç”Ÿè¿‡æ•
- 1990å¹´3æœˆ15æ—¥å‡ºç”Ÿï¼Œç”²æœ¨æ—¥ä¸»

## ğŸŒŠ å½“å‰çŠ¶æ€ (State)
*æµåŠ¨çš„æƒ…ç»ªå’Œè¿‘æœŸå…³æ³¨ï¼Œéšæ—¶æ›´æ–°*
- è¿‘æœŸå·¥ä½œå‹åŠ›å¤§ï¼Œå¤„äºç„¦è™‘çŠ¶æ€
- æ­£åœ¨è€ƒè™‘è·³æ§½ï¼Œæ‹…å¿ƒæ—¶æœºä¸å¯¹
- æåˆ°3æ¬¡"å·®ä¸€ç‚¹ç‚¹"

## ğŸ’¡ äº’åŠ¨åå¥½ (Preferences)
- å–œæ¬¢ç›´çƒå»ºè®®ï¼Œä¸å–œæ¬¢é¸¡æ±¤
- å¯¹å‘½ç†è§£é‡Šæ¥å—åº¦é«˜
- ä¸å–œæ¬¢æ³›æ³›è€Œè°ˆ

## ğŸ¯ å½“å‰å…³æ³¨ (Focus)
- èŒä¸šæ–¹å‘é€‰æ‹©
- æƒ³å­¦å†¥æƒ³ä½†è¿˜æ²¡å¼€å§‹
```

### 11.4 æ›´æ–°åçš„ Prompt

```python
PORTRAIT_UPDATE_PROMPT = """
ä½ æ˜¯ä¸€ä¸ªç”¨æˆ·ç”»åƒåˆ†æä¸“å®¶ã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºè¿™ä½ç”¨æˆ·ç”Ÿæˆæˆ–æ›´æ–°ç”»åƒæ‘˜è¦ã€‚

## å½“å‰ç”»åƒ (å¦‚æœå­˜åœ¨)
{current_portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰ç”»åƒ"}

## ç”¨æˆ·åŸºç¡€ä¿¡æ¯
- å‡ºç”Ÿæ—¥æœŸ: {birth_datetime}
- å…«å­—: {bazi_chart}
- ä½¿ç”¨æŠ€èƒ½: {skill_id}

## æœ€è¿‘ {message_count} æ¡å¯¹è¯
{recent_messages}

## ä»»åŠ¡
è¯·ç”Ÿæˆç»“æ„åŒ–çš„ç”¨æˆ·ç”»åƒï¼Œ**å¿…é¡»**åŒ…å«ä»¥ä¸‹å››ä¸ªåŒºåŸŸï¼š

# ç”¨æˆ·ç”»åƒ

## ğŸ“Œ é•¿æœŸäº‹å® (Facts)
*ä¸éšæ—¶é—´æ”¹å˜çš„ç¡¬äº‹å®ã€‚å¦‚ï¼šå§“åã€ç”Ÿæ—¥ã€å® ç‰©åã€é‡å¤§ç»å†ã€è¿‡æ•ä¿¡æ¯ã€‚*
*ã€é‡è¦ã€‘æ›´æ–°æ—¶å¿…é¡»ä¿ç•™å·²æœ‰çš„äº‹å®ï¼Œé™¤éç”¨æˆ·æ˜ç¡®çº æ­£ï¼*

## ğŸŒŠ å½“å‰çŠ¶æ€ (State)
*æµåŠ¨çš„æƒ…ç»ªã€è¿‘æœŸè¯é¢˜ã€å½“å‰å›°æ‰°ã€‚å¯ä»¥éšæ—¶æ›´æ–°ã€‚*

## ğŸ’¡ äº’åŠ¨åå¥½ (Preferences)
*ç”¨æˆ·å–œæ¬¢ä»€ä¹ˆæ ·çš„å›åº”æ–¹å¼ã€æ²Ÿé€šé£æ ¼ã€‚*

## ğŸ¯ å½“å‰å…³æ³¨ (Focus)
*ç”¨æˆ·æ­£åœ¨æ€è€ƒæˆ–å¤„ç†çš„äº‹æƒ…ã€‚*

è¦æ±‚:
- æ¯ä¸ªåŒºåŸŸç”¨ bullet points
- å…·ä½“è€Œéç¬¼ç»Ÿ
- ğŸ“Œ Facts åŒºåŸŸï¼šåªå¢ä¸åˆ ï¼Œé™¤éç”¨æˆ·æ˜ç¡®çº æ­£
- æ€»é•¿åº¦æ§åˆ¶åœ¨ 500 å­—ä»¥å†…
- åªè¾“å‡ºç”»åƒå†…å®¹ï¼Œä¸è¦å…¶ä»–è§£é‡Š
"""
```

### 11.5 æ•°æ®åº“æ›´æ–°

```sql
-- ä¸º skill_insights æ·»åŠ  embedding åˆ—
ALTER TABLE skill_insights
ADD COLUMN IF NOT EXISTS embedding vector(3072);

-- æ·»åŠ å‘é‡ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_skill_insights_embedding
ON skill_insights USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);

-- æ·»åŠ ç”¨æˆ·+æŠ€èƒ½çš„å¤åˆç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_skill_insights_user_skill
ON skill_insights(user_id, skill_id);
```

### 11.6 æ›´æ–°åçš„ Context Assembly

```python
async def assemble_context(
    user_id: UUID,
    skill_id: str,
    message: str,
    conversation_id: UUID
) -> Context:
    """
    Context Assembly with Hot & Cold Memory
    """

    # 1. Hot Memory: ç”¨æˆ·ç”»åƒ
    portrait = await PortraitService.get_portrait(user_id, skill_id)

    # 2. Buffer: æœ€è¿‘å¯¹è¯
    history = await SkillRepository.get_messages(conversation_id, limit=6)

    # 3. Cold Memory: ç›¸å…³ Insights (æ··åˆç­–ç•¥)
    relevant_insights = await retrieve_relevant_insights(
        user_id, skill_id, message
    )

    # 4. Knowledge: RAG æ£€ç´¢
    knowledge = await RetrievalService.get_context_for_query(message, skill_id)

    return Context(
        portrait=portrait,
        history=history,
        insights=relevant_insights,
        knowledge=knowledge
    )


async def retrieve_relevant_insights(
    user_id: UUID,
    skill_id: str,
    query: str,
    threshold: float = 0.75
) -> List[dict]:
    """
    æ··åˆç­–ç•¥æ£€ç´¢ç›¸å…³ Insights
    """
    # 1. ç”Ÿæˆ query embedding
    query_embedding = await EmbeddingService.embed_query(query)

    # 2. å¿«é€ŸæŸ¥è¯¢ top-1
    async with get_connection() as conn:
        top1 = await conn.fetchrow(
            """
            SELECT id, title, content,
                   1 - (embedding <=> $1::vector) as similarity
            FROM skill_insights
            WHERE user_id = $2 AND skill_id = $3 AND embedding IS NOT NULL
            ORDER BY embedding <=> $1::vector
            LIMIT 1
            """,
            query_embedding, user_id, skill_id
        )

    # 3. å¦‚æœç›¸ä¼¼åº¦é«˜ï¼Œæ‰©å±•æ£€ç´¢
    if top1 and top1["similarity"] > threshold:
        async with get_connection() as conn:
            rows = await conn.fetch(
                """
                SELECT title, content, insight_type,
                       1 - (embedding <=> $1::vector) as similarity
                FROM skill_insights
                WHERE user_id = $2 AND skill_id = $3 AND embedding IS NOT NULL
                ORDER BY embedding <=> $1::vector
                LIMIT 3
                """,
                query_embedding, user_id, skill_id
            )
            return [dict(r) for r in rows]

    return []
```

### 11.7 å¹¶å‘æ§åˆ¶ï¼šä¹è§‚é”

```python
async def update_portrait_with_optimistic_lock(
    user_id: UUID,
    skill_id: str,
    new_portrait: str,
    expected_version: int,
    last_msg_id: UUID
) -> bool:
    """
    ä½¿ç”¨ä¹è§‚é”æ›´æ–°ç”»åƒï¼Œé˜²æ­¢å¹¶å‘è¦†ç›–
    """
    async with get_connection() as conn:
        result = await conn.execute(
            """
            UPDATE user_portraits
            SET portrait_text = $1,
                version = version + 1,
                last_message_id = $2,
                generated_at = NOW()
            WHERE user_id = $3 AND skill_id = $4 AND version = $5
            """,
            new_portrait, last_msg_id, user_id, skill_id, expected_version
        )

        # å¦‚æœå½±å“è¡Œæ•°ä¸º 0ï¼Œè¯´æ˜æœ‰å¹¶å‘å†™å…¥ï¼Œä¸¢å¼ƒæœ¬æ¬¡æ›´æ–°
        return result == "UPDATE 1"
```

---

## 12. æœ€ç»ˆå®ç°è®¡åˆ’

### Phase 1: æ•°æ®åº“ (0.5 å¤©)
- [ ] åˆ›å»º `user_portraits` è¡¨
- [ ] åˆ›å»º `user_portrait_history` è¡¨
- [ ] ä¸º `skill_insights` æ·»åŠ  `embedding` åˆ—å’Œç´¢å¼•

### Phase 2: æ ¸å¿ƒæœåŠ¡ (1 å¤©)
- [ ] å®ç° `PortraitService`
  - [ ] ç»“æ„åŒ–ç”»åƒæ ¼å¼ (Facts/State/Preferences/Focus)
  - [ ] ä¹è§‚é”å¹¶å‘æ§åˆ¶
- [ ] å¢å¼º `InsightService`
  - [ ] ç”Ÿæˆ Insight æ—¶åŒæ—¶ç”Ÿæˆ embedding
  - [ ] ç›¸å…³ Insight æ£€ç´¢ (æ··åˆç­–ç•¥)

### Phase 3: é›†æˆ (0.5 å¤©)
- [ ] ä¿®æ”¹ `AgentRuntime`
  - [ ] Context Assembly åŒ…å« Hot + Cold Memory
  - [ ] System Prompt æ•´åˆç”»åƒå’Œç›¸å…³ Insights

### å…³é”®ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
|------|---------|------|
| `migrations/002_user_portraits.sql` | æ–°å¢ | ç”»åƒè¡¨ + insights embedding |
| `apps/api/services/vibe_engine/portrait_service.py` | æ–°å¢ | ç”»åƒæœåŠ¡ (ç»“æ„åŒ–+ä¹è§‚é”) |
| `apps/api/services/vibe_engine/insight_generator.py` | ä¿®æ”¹ | æ·»åŠ  embedding ç”Ÿæˆ |
| `apps/api/stores/skill_repo.py` | ä¿®æ”¹ | æ·»åŠ  Insight å‘é‡æ£€ç´¢ |
| `apps/api/services/agent/runtime.py` | ä¿®æ”¹ | Hot+Cold Context Assembly |

---

## 13. æ€»ç»“

### æœ€ç»ˆæ¶æ„

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                               â•‘
â•‘                      VibeLife ç”¨æˆ·è®°å¿†ä½“ç³» (æœ€ç»ˆç‰ˆ)                            â•‘
â•‘                                                                               â•‘
â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â•‘
â•‘                                                                               â•‘
â•‘   ç”¨æˆ·æ¶ˆæ¯                                                                    â•‘
â•‘       â”‚                                                                       â•‘
â•‘       â–¼                                                                       â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘   â”‚  Context Assembly                                                   â”‚     â•‘
â•‘   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â”‚  1. ğŸ”¥ Hot Memory: user_portraits                                   â”‚     â•‘
â•‘   â”‚     â€¢ ç»“æ„åŒ–ç”»åƒ (Facts/State/Preferences/Focus)                    â”‚     â•‘
â•‘   â”‚     â€¢ å®è§‚çŠ¶æ€ï¼Œé¢‘ç¹æ›´æ–°                                            â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â”‚  2. ğŸ’¬ Buffer: skill_messages (æœ€è¿‘ 6 æ¡)                           â”‚     â•‘
â•‘   â”‚     â€¢ å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡                                                â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â”‚  3. â„ï¸ Cold Memory: skill_insights + embedding                      â”‚     â•‘
â•‘   â”‚     â€¢ å¾®è§‚äº‹å®ï¼Œå‘é‡æ£€ç´¢                                            â”‚     â•‘
â•‘   â”‚     â€¢ æ··åˆç­–ç•¥ï¼štop-1 å¿«æ£€ â†’ æ‰©å±• top-3                             â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â”‚  4. ğŸ“š Knowledge: RAG æ£€ç´¢                                          â”‚     â•‘
â•‘   â”‚     â€¢ ä¸“ä¸šçŸ¥è¯†åº“                                                    â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘       â”‚                                                                       â•‘
â•‘       â–¼                                                                       â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘   â”‚  LLM ç”Ÿæˆå“åº”                                                       â”‚     â•‘
â•‘   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â”‚  System Prompt:                                                     â”‚     â•‘
â•‘   â”‚  â€¢ Persona (Vibe è§’è‰²)                                              â”‚     â•‘
â•‘   â”‚  â€¢ ç”¨æˆ·ç”»åƒ (Hot Memory)                                            â”‚     â•‘
â•‘   â”‚  â€¢ ç›¸å…³å†å²æ´å¯Ÿ (Cold Memory)                                       â”‚     â•‘
â•‘   â”‚  â€¢ ä¸“ä¸šçŸ¥è¯† (RAG)                                                   â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘       â”‚                                                                       â•‘
â•‘       â–¼                                                                       â•‘
â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
â•‘   â”‚  åå°ä»»åŠ¡                                                           â”‚     â•‘
â•‘   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â”‚  Portrait Agent (æ¯ 10 æ¡æ¶ˆæ¯)                                      â”‚     â•‘
â•‘   â”‚  â€¢ æ›´æ–° Hot Memory                                                  â”‚     â•‘
â•‘   â”‚  â€¢ ä¹è§‚é”é˜²æ­¢å¹¶å‘è¦†ç›–                                               â”‚     â•‘
â•‘   â”‚  â€¢ ä¿æŠ¤ ğŸ“Œ Facts ä¸è¢«å‹ç¼©ä¸¢å¤±                                       â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â”‚  Insight Agent (å¯¹è¯ç»“æŸå)                                         â”‚     â•‘
â•‘   â”‚  â€¢ åˆ¤æ–­æ˜¯å¦ç”Ÿæˆ Cold Memory                                         â”‚     â•‘
â•‘   â”‚  â€¢ ç”Ÿæˆ embedding æ”¯æŒå‘é‡æ£€ç´¢                                      â”‚     â•‘
â•‘   â”‚                                                                     â”‚     â•‘
â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
â•‘                                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

### æ ¸å¿ƒç†å¿µ

> **"Hot Memory è´Ÿè´£å…¨å±€è§‚ï¼ŒCold Memory è´Ÿè´£ç»†èŠ‚è®°å¿†"**
>
> - ç”»åƒè¢«å‹ç¼©ï¼Ÿæ²¡å…³ç³»ï¼ŒFacts åŒºåŸŸè¢«é”å®š
> - ç»†èŠ‚è¢«é—å¿˜ï¼Ÿæ²¡å…³ç³»ï¼ŒInsights æ°¸ä¹…ä¿å­˜ä¸”å¯å‘é‡æ£€ç´¢
> - è¿™æ˜¯ä¸€ä¸ª**æ—¢æœ‰å…¨å±€è§‚ã€åˆæœ‰ç»†èŠ‚è®°å¿†**çš„å®Œç¾ AI å¤§è„‘

---

*æ–‡æ¡£ç‰ˆæœ¬: 2.0*
*åˆ›å»ºæ—¥æœŸ: 2026-01-06*
*æ ¸å¿ƒæ€æƒ³: è®© LLM åšè„æ´»ï¼ŒHot & Cold åŒå±‚è®°å¿†*
