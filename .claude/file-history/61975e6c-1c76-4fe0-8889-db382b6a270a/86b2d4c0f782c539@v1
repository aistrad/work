/**
 * Relationship Panel - View and create relationship analyses
 */

"use client";

import { useEffect, useState } from "react";
import type { PanelProps } from "../types";

interface Relationship {
  id: string;
  partnerName: string;
  score: number;
  type: string;
  createdAt: string;
}

export default function RelationshipPanel({ skill, isActive }: PanelProps) {
  const [relationships, setRelationships] = useState<Relationship[]>([]);
  const [loading, setLoading] = useState(true);
  const [showForm, setShowForm] = useState(false);

  useEffect(() => {
    if (isActive) {
      fetchRelationships();
    }
  }, [isActive, skill]);

  async function fetchRelationships() {
    try {
      setLoading(true);
      const response = await fetch(`/api/v1/relationship/list?skill=${skill}`);
      if (response.ok) {
        const data = await response.json();
        setRelationships(data.relationships || []);
      }
    } catch (error) {
      console.error("Failed to fetch relationships:", error);
    } finally {
      setLoading(false);
    }
  }

  if (loading) {
    return (
      <div className="h-full flex items-center justify-center">
        <div className="animate-pulse text-muted-foreground">åŠ è½½ä¸­...</div>
      </div>
    );
  }

  return (
    <div className="h-full flex flex-col">
      <div className="p-4 border-b">
        <h3 className="font-semibold">å…³ç³»åˆ†æ</h3>
        <p className="text-sm text-muted-foreground">
          åˆ†æä½ ä¸ä»–äººçš„å…¼å®¹æ€§
        </p>
      </div>

      <div className="flex-1 overflow-auto">
        {relationships.length === 0 && !showForm ? (
          <div className="flex flex-col items-center justify-center h-full p-6 text-center">
            <div className="w-16 h-16 bg-muted rounded-full flex items-center justify-center mb-4">
              <span className="text-2xl">ğŸ’•</span>
            </div>
            <h3 className="font-medium mb-2">å¼€å§‹ç¬¬ä¸€æ¬¡åˆ†æ</h3>
            <p className="text-sm text-muted-foreground mb-4">
              è¾“å…¥å¯¹æ–¹çš„å‡ºç”Ÿä¿¡æ¯ï¼Œçœ‹çœ‹ä½ ä»¬æœ‰å¤šåŒ¹é…
            </p>
            <button
              onClick={() => setShowForm(true)}
              className="px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm"
            >
              å¼€å§‹åˆ†æ
            </button>
          </div>
        ) : showForm ? (
          <div className="p-4">
            <RelationshipForm
              skill={skill}
              onCancel={() => setShowForm(false)}
              onSuccess={() => {
                setShowForm(false);
                fetchRelationships();
              }}
            />
          </div>
        ) : (
          <div className="p-4 space-y-3">
            {relationships.map((rel) => (
              <button
                key={rel.id}
                className="w-full text-left p-4 rounded-lg border bg-card hover:bg-muted/50 transition-colors"
              >
                <div className="flex items-center justify-between">
                  <div>
                    <div className="font-medium">{rel.partnerName}</div>
                    <div className="text-sm text-muted-foreground mt-1">
                      {rel.type} Â· {rel.createdAt}
                    </div>
                  </div>
                  <div className="text-2xl font-bold text-primary">
                    {rel.score}%
                  </div>
                </div>
              </button>
            ))}
          </div>
        )}
      </div>

      {/* New Analysis Button */}
      {relationships.length > 0 && !showForm && (
        <div className="p-4 border-t">
          <button
            onClick={() => setShowForm(true)}
            className="w-full px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm"
          >
            æ–°å»ºåˆ†æ
          </button>
        </div>
      )}
    </div>
  );
}

// Relationship Form Component
function RelationshipForm({
  skill,
  onCancel,
  onSuccess,
}: {
  skill: string;
  onCancel: () => void;
  onSuccess: () => void;
}) {
  const [partnerName, setPartnerName] = useState("");
  const [birthDate, setBirthDate] = useState("");
  const [relationshipType, setRelationshipType] = useState("romantic");
  const [loading, setLoading] = useState(false);

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    if (!birthDate) return;

    try {
      setLoading(true);
      const response = await fetch("/api/v1/relationship/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          skill,
          partnerInfo: {
            name: partnerName || "TA",
            birthDate,
          },
          relationshipType,
        }),
      });

      if (response.ok) {
        onSuccess();
      }
    } catch (error) {
      console.error("Failed to analyze:", error);
    } finally {
      setLoading(false);
    }
  }

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div>
        <label className="block text-sm font-medium mb-1">å¯¹æ–¹æ˜µç§°</label>
        <input
          type="text"
          value={partnerName}
          onChange={(e) => setPartnerName(e.target.value)}
          placeholder="å¯é€‰"
          className="w-full px-3 py-2 rounded-lg border bg-background"
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">å‡ºç”Ÿæ—¥æœŸ *</label>
        <input
          type="date"
          value={birthDate}
          onChange={(e) => setBirthDate(e.target.value)}
          required
          className="w-full px-3 py-2 rounded-lg border bg-background"
        />
      </div>

      <div>
        <label className="block text-sm font-medium mb-1">å…³ç³»ç±»å‹</label>
        <select
          value={relationshipType}
          onChange={(e) => setRelationshipType(e.target.value)}
          className="w-full px-3 py-2 rounded-lg border bg-background"
        >
          <option value="romantic">æ‹äºº/ä¼´ä¾£</option>
          <option value="friend">æœ‹å‹</option>
          <option value="family">å®¶äºº</option>
          <option value="colleague">åŒäº‹</option>
        </select>
      </div>

      <div className="flex gap-2 pt-2">
        <button
          type="button"
          onClick={onCancel}
          className="flex-1 px-4 py-2 border rounded-lg text-sm"
        >
          å–æ¶ˆ
        </button>
        <button
          type="submit"
          disabled={!birthDate || loading}
          className="flex-1 px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm disabled:opacity-50"
        >
          {loading ? "åˆ†æä¸­..." : "å¼€å§‹åˆ†æ"}
        </button>
      </div>
    </form>
  );
}
