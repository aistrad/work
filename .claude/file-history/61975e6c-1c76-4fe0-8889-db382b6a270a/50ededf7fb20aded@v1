/**
 * Show Fortune Tool - Generative UI
 *
 * Renders major luck cycles and yearly fortune
 */

import { z } from "zod";
import type { ToolDefinition, ToolExecuteContext } from "../../types";

// ═══════════════════════════════════════════════════════════════════════════
// Parameters Schema
// ═══════════════════════════════════════════════════════════════════════════

const FortuneParams = z.object({
  userId: z.string().optional().describe("User ID"),
  year: z.number().optional().describe("Specific year to analyze"),
  includePast: z.boolean().optional().default(false).describe("Include past luck cycles"),
});

type FortuneParamsType = z.infer<typeof FortuneParams>;

// ═══════════════════════════════════════════════════════════════════════════
// Result Type
// ═══════════════════════════════════════════════════════════════════════════

interface MajorLuckCycle {
  startAge: number;
  endAge: number;
  stem: string;
  branch: string;
  element: string;
  isCurrent: boolean;
  quality: "excellent" | "good" | "neutral" | "challenging" | "difficult";
  description: string;
}

interface YearlyFortune {
  year: number;
  stem: string;
  branch: string;
  animal: string;
  quality: "excellent" | "good" | "neutral" | "challenging" | "difficult";
  themes: string[];
  advice: string;
}

interface FortuneResult {
  userId: string;
  currentAge: number;
  majorLuckCycles: MajorLuckCycle[];
  currentMajorLuck: MajorLuckCycle;
  yearlyFortune: YearlyFortune;
  nextYearFortune?: YearlyFortune;
  keyAdvice: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Tool Definition
// ═══════════════════════════════════════════════════════════════════════════

export const showFortuneTool: ToolDefinition<FortuneParamsType, FortuneResult> = {
  name: "show_bazi_fortune",
  description: "展示用户的大运流年分析，包括当前大运、今年流年运势和关键建议。当用户问'今年运势'、'大运'、'流年'或想了解特定年份运势时调用此工具。",

  parameters: FortuneParams,

  async execute(params, context) {
    const { year, includePast } = params;
    const targetUserId = params.userId || context.userId;

    if (!targetUserId) {
      throw new Error("需要用户信息才能分析运势");
    }

    const queryParams = new URLSearchParams();
    if (year) queryParams.set("year", year.toString());
    if (includePast) queryParams.set("include_past", "true");

    const response = await fetch(
      `/api/v1/fortune/cycles?${queryParams.toString()}`,
      {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      }
    );

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.message || "获取运势数据失败");
    }

    return response.json();
  },

  render(result) {
    const { currentMajorLuck, yearlyFortune, nextYearFortune, majorLuckCycles, keyAdvice } = result;

    return (
      <div className="fortune-card bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-950/30 dark:to-indigo-950/30 rounded-xl border border-purple-200 dark:border-purple-800 p-4 my-2">
        {/* Header */}
        <h3 className="text-lg font-semibold text-purple-900 dark:text-purple-100 mb-4">
          大运流年分析
        </h3>

        {/* Major Luck Timeline */}
        <div className="mb-4">
          <div className="text-sm font-medium text-purple-700 dark:text-purple-300 mb-2">
            大运周期
          </div>
          <div className="flex overflow-x-auto gap-2 pb-2">
            {majorLuckCycles.map((cycle, index) => (
              <div
                key={index}
                className={`flex-shrink-0 px-3 py-2 rounded-lg text-center min-w-[70px] ${
                  cycle.isCurrent
                    ? "bg-purple-200 dark:bg-purple-800 ring-2 ring-purple-400"
                    : "bg-white/60 dark:bg-black/20"
                }`}
              >
                <div className="text-xs text-muted-foreground">
                  {cycle.startAge}-{cycle.endAge}岁
                </div>
                <div className="font-medium">
                  {cycle.stem}{cycle.branch}
                </div>
                <div className={`text-xs mt-1 ${getQualityColor(cycle.quality)}`}>
                  {getQualityLabel(cycle.quality)}
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Current Major Luck */}
        <div className="bg-white/60 dark:bg-black/30 rounded-lg p-3 mb-3">
          <div className="flex items-center justify-between mb-2">
            <span className="text-sm font-medium">当前大运</span>
            <span className={`px-2 py-0.5 rounded text-xs ${getQualityBgColor(currentMajorLuck.quality)}`}>
              {currentMajorLuck.stem}{currentMajorLuck.branch} ({currentMajorLuck.element})
            </span>
          </div>
          <p className="text-sm text-muted-foreground">
            {currentMajorLuck.description}
          </p>
        </div>

        {/* Yearly Fortune */}
        <div className="grid grid-cols-2 gap-3 mb-3">
          <div className="bg-white/60 dark:bg-black/30 rounded-lg p-3">
            <div className="flex items-center justify-between mb-2">
              <span className="text-sm font-medium">{yearlyFortune.year}年</span>
              <span className="text-xs">{yearlyFortune.animal}年</span>
            </div>
            <div className={`text-sm font-medium ${getQualityColor(yearlyFortune.quality)}`}>
              {getQualityLabel(yearlyFortune.quality)}
            </div>
            <div className="flex flex-wrap gap-1 mt-2">
              {yearlyFortune.themes.slice(0, 3).map((theme, i) => (
                <span
                  key={i}
                  className="px-1.5 py-0.5 bg-purple-100 dark:bg-purple-900/30 rounded text-xs"
                >
                  {theme}
                </span>
              ))}
            </div>
          </div>

          {nextYearFortune && (
            <div className="bg-white/40 dark:bg-black/20 rounded-lg p-3 opacity-80">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium">{nextYearFortune.year}年</span>
                <span className="text-xs">{nextYearFortune.animal}年</span>
              </div>
              <div className={`text-sm font-medium ${getQualityColor(nextYearFortune.quality)}`}>
                {getQualityLabel(nextYearFortune.quality)}
              </div>
              <div className="flex flex-wrap gap-1 mt-2">
                {nextYearFortune.themes.slice(0, 3).map((theme, i) => (
                  <span
                    key={i}
                    className="px-1.5 py-0.5 bg-purple-100/50 dark:bg-purple-900/20 rounded text-xs"
                  >
                    {theme}
                  </span>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Key Advice */}
        <div className="bg-gradient-to-r from-purple-100 to-indigo-100 dark:from-purple-900/30 dark:to-indigo-900/30 rounded-lg p-3">
          <div className="text-sm font-medium mb-1">关键建议</div>
          <p className="text-sm text-muted-foreground">{keyAdvice}</p>
        </div>
      </div>
    );
  },

  toModelOutput(result) {
    return `已展示大运流年分析。当前大运: ${result.currentMajorLuck.stem}${result.currentMajorLuck.branch}(${getQualityLabel(result.currentMajorLuck.quality)})。${result.yearlyFortune.year}年流年: ${getQualityLabel(result.yearlyFortune.quality)}，主题: ${result.yearlyFortune.themes.join("、")}。建议: ${result.keyAdvice}`;
  },
};

// Helper functions
function getQualityLabel(quality: string): string {
  const labels: Record<string, string> = {
    excellent: "大吉",
    good: "吉",
    neutral: "平",
    challenging: "小凶",
    difficult: "凶",
  };
  return labels[quality] || quality;
}

function getQualityColor(quality: string): string {
  const colors: Record<string, string> = {
    excellent: "text-green-600 dark:text-green-400",
    good: "text-emerald-600 dark:text-emerald-400",
    neutral: "text-slate-600 dark:text-slate-400",
    challenging: "text-orange-600 dark:text-orange-400",
    difficult: "text-red-600 dark:text-red-400",
  };
  return colors[quality] || "";
}

function getQualityBgColor(quality: string): string {
  const colors: Record<string, string> = {
    excellent: "bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300",
    good: "bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300",
    neutral: "bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300",
    challenging: "bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",
    difficult: "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300",
  };
  return colors[quality] || "";
}
