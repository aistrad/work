"""
CoreAgent v12 统一配置框架测试用例

测试维度:
1. Phase 1 路由测试 - 意图识别与 Skill 激活
2. Phase 2 执行测试 - SOP 流程与边界控制
3. v12 配置测试 - skill_data 和 includes 加载
4. 跨 Skill 场景 - 切换与会话恢复

运行方式:
  pytest tests/test_coreagent_v12.py -v
  或使用 test_queries 字典进行手动测试
"""

import pytest
from typing import Dict, List, Any

# ═══════════════════════════════════════════════════════════════
# 测试用例数据
# ═══════════════════════════════════════════════════════════════

test_queries: Dict[str, Dict[str, Any]] = {

    # ─────────────────────────────────────────────────────────────
    # 1. Phase 1 路由测试
    # ─────────────────────────────────────────────────────────────

    "phase1_routing": {
        "description": "Phase 1 意图识别与 Skill 激活",
        "cases": [
            # 1.1 明确触发词 - 应该直接 activate_skill
            {
                "id": "P1-01",
                "query": "帮我看八字",
                "expected_action": "activate_skill",
                "expected_skill": "bazi",
                "description": "明确触发词 → 直接激活"
            },
            {
                "id": "P1-02",
                "query": "我想看星盘",
                "expected_action": "activate_skill",
                "expected_skill": "zodiac",
                "description": "明确触发词 → 直接激活"
            },
            {
                "id": "P1-03",
                "query": "抽一张塔罗牌",
                "expected_action": "activate_skill",
                "expected_skill": "tarot",
                "description": "明确触发词 → 直接激活"
            },
            {
                "id": "P1-04",
                "query": "帮我做心理占星分析",
                "expected_action": "activate_skill",
                "expected_skill": "jungastro",
                "description": "明确触发词 → 直接激活"
            },
            {
                "id": "P1-05",
                "query": "分析一下我的人格原型",
                "expected_action": "activate_skill",
                "expected_skill": "vibe_id",
                "description": "明确触发词 → 直接激活"
            },
            {
                "id": "P1-06",
                "query": "想和男朋友合盘",
                "expected_action": "activate_skill",
                "expected_skill": "synastry",
                "description": "明确触发词 → 直接激活"
            },

            # 1.2 协议关键词 - 应该 show_protocol_invitation
            {
                "id": "P1-10",
                "query": "帮我用 Dan Koe 方法做一次人生重置",
                "expected_action": "show_protocol_invitation",
                "expected_protocol": "dankoe",
                "description": "协议关键词 → 展示协议邀请"
            },
            {
                "id": "P1-11",
                "query": "我想用七个习惯的方法规划一下",
                "expected_action": "show_protocol_invitation",
                "expected_protocol": "covey",
                "description": "协议关键词 → 展示协议邀请"
            },
            {
                "id": "P1-12",
                "query": "想用了凡四训改变命运",
                "expected_action": "show_protocol_invitation",
                "expected_protocol": "liaofan",
                "description": "协议关键词 → 展示协议邀请"
            },

            # 1.3 模糊意图 - 应该 recommend_skills 或对话引导
            {
                "id": "P1-20",
                "query": "你好",
                "expected_action": "greeting",
                "description": "打招呼 → 欢迎语"
            },
            {
                "id": "P1-21",
                "query": "你能做什么",
                "expected_action": "show_capabilities",
                "description": "询问能力 → 展示服务"
            },
            {
                "id": "P1-22",
                "query": "我最近不太顺",
                "expected_action": "ask_clarification_or_recommend",
                "description": "模糊困扰 → 询问或推荐"
            },

            # 1.4 出生信息 + 意图
            {
                "id": "P1-30",
                "query": "1990年5月15日 14:30 北京 男，帮我看星座",
                "expected_action": "activate_skill",
                "expected_skill": "zodiac",
                "description": "出生信息+明确意图 → 直接激活"
            },
            {
                "id": "P1-31",
                "query": "1990年5月15日 14:30 北京",
                "expected_action": "ask_user_question",
                "description": "只有出生信息无意图 → 询问想做什么"
            },
        ]
    },

    # ─────────────────────────────────────────────────────────────
    # 2. Phase 2 执行测试 (需要先激活 Skill)
    # ─────────────────────────────────────────────────────────────

    "phase2_execution": {
        "description": "Phase 2 SOP 流程与工具调用",
        "cases": [
            # 2.1 需要收集信息的场景
            {
                "id": "P2-01",
                "context": {"active_skill": "bazi", "has_birth_info": False},
                "query": "帮我看命盘",
                "expected_tool": "collect_bazi_info",
                "description": "无出生信息 → 调用收集工具"
            },
            {
                "id": "P2-02",
                "context": {"active_skill": "zodiac", "has_birth_info": False},
                "query": "分析我的星盘",
                "expected_tool": "collect_zodiac_info",
                "description": "无出生信息 → 调用收集工具"
            },

            # 2.2 有信息直接计算
            {
                "id": "P2-10",
                "context": {"active_skill": "bazi", "has_birth_info": True, "has_chart": False},
                "query": "帮我排盘",
                "expected_tool": "calculate_bazi",
                "description": "有出生信息无命盘 → 调用计算工具"
            },
            {
                "id": "P2-11",
                "context": {"active_skill": "zodiac", "has_birth_info": True, "has_chart": False},
                "query": "展示我的星盘",
                "expected_tool": "calculate_zodiac",
                "description": "有出生信息无星盘 → 调用计算工具"
            },

            # 2.3 已有数据直接分析
            {
                "id": "P2-20",
                "context": {"active_skill": "bazi", "has_birth_info": True, "has_chart": True},
                "query": "今年运势怎么样",
                "expected_tool": "show_bazi_fortune",
                "description": "已有命盘 → 调用展示工具"
            },
            {
                "id": "P2-21",
                "context": {"active_skill": "zodiac", "has_birth_info": True, "has_chart": True},
                "query": "看看最近运势",
                "expected_tool": "show_zodiac_transit",
                "description": "已有星盘 → 调用行运工具"
            },

            # 2.4 边界控制 - Skill 内模糊请求
            {
                "id": "P2-30",
                "context": {"active_skill": "tarot"},
                "query": "今日指引",
                "expected_tool": "draw_tarot_cards",
                "not_expected": "recommend_skills",
                "description": "塔罗内模糊请求 → 用塔罗工具处理，不跳出"
            },
            {
                "id": "P2-31",
                "context": {"active_skill": "bazi", "has_chart": True},
                "query": "帮我看看",
                "expected_tool": "show_bazi_chart",
                "not_expected": "recommend_skills",
                "description": "八字内模糊请求 → 用八字工具处理，不跳出"
            },
            {
                "id": "P2-32",
                "context": {"active_skill": "zodiac", "has_chart": True},
                "query": "继续",
                "expected_tool": "any_zodiac_tool",
                "not_expected": "recommend_skills",
                "description": "星座内继续 → 继续当前分析，不跳出"
            },

            # 2.5 Skill 切换请求
            {
                "id": "P2-40",
                "context": {"active_skill": "bazi"},
                "query": "我想看星座",
                "expected_action": "activate_skill",
                "expected_skill": "zodiac",
                "description": "明确切换请求 → 切换 Skill"
            },
            {
                "id": "P2-41",
                "context": {"active_skill": "tarot"},
                "query": "退出",
                "expected_action": "warm_farewell",
                "description": "退出请求 → 温暖告别"
            },
        ]
    },

    # ─────────────────────────────────────────────────────────────
    # 3. v12 统一配置测试
    # ─────────────────────────────────────────────────────────────

    "v12_config": {
        "description": "v12 skill_data 和 includes 配置验证",
        "cases": [
            # 3.1 skill_data 依赖加载
            {
                "id": "V12-01",
                "context": {"active_skill": "jungastro"},
                "verify": "context.skill_data",
                "expected_keys": ["jungastro", "bazi", "zodiac"],
                "description": "jungastro 应加载 bazi + zodiac 数据"
            },
            {
                "id": "V12-02",
                "context": {"active_skill": "vibe_id"},
                "verify": "context.skill_data",
                "expected_keys": ["vibe_id", "bazi", "zodiac"],
                "description": "vibe_id 应加载 bazi + zodiac 数据"
            },
            {
                "id": "V12-03",
                "context": {"active_skill": "synastry"},
                "verify": "context.skill_data",
                "expected_keys": ["synastry", "bazi", "zodiac"],
                "description": "synastry 应加载 bazi + zodiac 数据"
            },
            {
                "id": "V12-04",
                "context": {"active_skill": "bazi"},
                "verify": "context.skill_data",
                "expected_keys": ["bazi"],
                "not_expected_keys": ["zodiac", "jungastro"],
                "description": "bazi 只加载自身数据"
            },

            # 3.2 includes 工具加载
            {
                "id": "V12-10",
                "context": {"active_skill": "jungastro"},
                "verify": "available_tools",
                "expected_tools": ["calculate_zodiac", "collect_zodiac_info", "show_zodiac_chart"],
                "description": "jungastro 应包含 zodiac 的工具"
            },
            {
                "id": "V12-11",
                "context": {"active_skill": "synastry"},
                "verify": "available_tools",
                "expected_tools": ["calculate_bazi", "calculate_zodiac", "show_bazi_chart", "show_zodiac_chart"],
                "description": "synastry 应包含 bazi + zodiac 的工具"
            },
            {
                "id": "V12-12",
                "context": {"active_skill": "bazi"},
                "verify": "available_tools",
                "not_expected_tools": ["calculate_zodiac", "show_zodiac_chart"],
                "description": "bazi 不应包含 zodiac 的工具"
            },

            # 3.3 global_tools 加载
            {
                "id": "V12-20",
                "context": {"active_skill": "bazi"},
                "verify": "available_tools",
                "expected_tools": ["search_db", "request_info", "show_insight"],
                "description": "bazi 应有声明的全局工具"
            },
            {
                "id": "V12-21",
                "context": {"active_skill": "vibe_id"},
                "verify": "available_tools",
                "expected_tools": ["show_card", "request_info", "search_db"],
                "description": "vibe_id 应有声明的全局工具"
            },
        ]
    },

    # ─────────────────────────────────────────────────────────────
    # 4. 复杂场景测试
    # ─────────────────────────────────────────────────────────────

    "complex_scenarios": {
        "description": "复杂交互场景",
        "cases": [
            # 4.1 多轮对话
            {
                "id": "CS-01",
                "conversation": [
                    {"user": "帮我看八字", "expected": "activate_skill(bazi)"},
                    {"user": "1990-05-15 14:30 北京 男", "expected": "calculate_bazi"},
                    {"user": "今年运势", "expected": "show_bazi_fortune"},
                    {"user": "想看星座", "expected": "activate_skill(zodiac)"},
                ],
                "description": "八字完整流程 → 切换到星座"
            },
            {
                "id": "CS-02",
                "conversation": [
                    {"user": "抽一张塔罗牌", "expected": "activate_skill(tarot)"},
                    {"user": "今日指引", "expected": "draw_tarot_cards"},
                    {"user": "再抽一张", "expected": "draw_tarot_cards"},
                    {"user": "三牌阵", "expected": "draw_tarot_cards(spread=three)"},
                ],
                "description": "塔罗多轮交互"
            },

            # 4.2 协议流程
            {
                "id": "CS-10",
                "conversation": [
                    {"user": "帮我做人生重置", "expected": "show_protocol_invitation(dankoe)"},
                    {"user": "[点击开始]", "expected": "redirect_to_protocol_page"},
                ],
                "description": "协议邀请流程"
            },

            # 4.3 融合 Skill 场景
            {
                "id": "CS-20",
                "conversation": [
                    {"user": "分析我的心理占星", "expected": "activate_skill(jungastro)"},
                    {"user": "1990-05-15 14:30 北京", "expected": "calculate_zodiac"},
                    {"user": "展示心理画像", "expected": "show_psychological_portrait"},
                ],
                "description": "荣格占星 - 使用 zodiac 计算工具"
            },
            {
                "id": "CS-21",
                "conversation": [
                    {"user": "和男朋友合盘", "expected": "activate_skill(synastry)"},
                    {"user": "[提交对方信息]", "expected": "calculate_synastry"},
                ],
                "description": "合盘 - 使用多 Skill 工具"
            },
        ]
    },

    # ─────────────────────────────────────────────────────────────
    # 5. 边界与异常测试
    # ─────────────────────────────────────────────────────────────

    "edge_cases": {
        "description": "边界情况与异常处理",
        "cases": [
            # 5.1 无效请求
            {
                "id": "EC-01",
                "query": "帮我写代码",
                "expected_action": "polite_decline_or_clarify",
                "description": "超出能力范围 → 礼貌拒绝"
            },
            {
                "id": "EC-02",
                "query": "我明天会死吗",
                "expected_action": "ethical_boundary",
                "description": "伦理边界 → 拒绝预测"
            },

            # 5.2 不完整信息
            {
                "id": "EC-10",
                "context": {"active_skill": "bazi"},
                "query": "1990年5月",
                "expected_action": "request_complete_info",
                "description": "信息不完整 → 请求补充"
            },

            # 5.3 快速切换
            {
                "id": "EC-20",
                "conversation": [
                    {"user": "看八字", "expected": "activate_skill(bazi)"},
                    {"user": "不对，看星座", "expected": "activate_skill(zodiac)"},
                    {"user": "算了，抽塔罗", "expected": "activate_skill(tarot)"},
                ],
                "description": "快速连续切换 Skill"
            },
        ]
    },
}

# ═══════════════════════════════════════════════════════════════
# 测试辅助函数
# ═══════════════════════════════════════════════════════════════

def print_test_cases():
    """打印所有测试用例（用于手动测试）"""
    print("=" * 60)
    print("CoreAgent v12 测试用例")
    print("=" * 60)

    for category, data in test_queries.items():
        print(f"\n## {data['description']}")
        print("-" * 40)

        for case in data["cases"]:
            case_id = case.get("id", "N/A")
            desc = case.get("description", "")

            if "query" in case:
                print(f"\n[{case_id}] {desc}")
                print(f"  输入: {case['query']}")
                if "expected_action" in case:
                    print(f"  期望: {case['expected_action']}")
                if "expected_skill" in case:
                    print(f"  目标 Skill: {case['expected_skill']}")
                if "expected_tool" in case:
                    print(f"  期望工具: {case['expected_tool']}")
                if "context" in case:
                    print(f"  上下文: {case['context']}")

            elif "conversation" in case:
                print(f"\n[{case_id}] {desc}")
                for i, turn in enumerate(case["conversation"], 1):
                    print(f"  {i}. User: {turn['user']}")
                    print(f"     Expected: {turn['expected']}")

            elif "verify" in case:
                print(f"\n[{case_id}] {desc}")
                print(f"  验证: {case['verify']}")
                if "expected_keys" in case:
                    print(f"  应包含: {case['expected_keys']}")
                if "expected_tools" in case:
                    print(f"  应有工具: {case['expected_tools']}")

# ═══════════════════════════════════════════════════════════════
# Pytest 测试类
# ═══════════════════════════════════════════════════════════════

class TestPhase1Routing:
    """Phase 1 路由测试"""

    @pytest.fixture
    def routing_config(self):
        from services.agent.routing_config import load_routing_config
        return load_routing_config()

    def test_skill_triggers_loaded(self, routing_config):
        """验证所有 Skill 的触发词已加载"""
        skills = routing_config.get("skills", {})
        assert "bazi" in skills
        assert "zodiac" in skills
        assert "tarot" in skills
        assert len(skills["bazi"].get("triggers", [])) > 0

    def test_protocols_loaded(self, routing_config):
        """验证协议配置已加载"""
        protocols = routing_config.get("protocols", {})
        assert "dankoe" in protocols
        assert "covey" in protocols
        assert protocols["dankoe"].get("total_steps", 0) > 0


class TestV12Config:
    """v12 统一配置框架测试"""

    def test_skill_data_deps(self):
        """测试 skill_data 依赖"""
        from services.agent.routing_config import get_skill_data_deps

        # jungastro 应该返回自身 + bazi + zodiac
        deps = get_skill_data_deps("jungastro")
        assert "jungastro" in deps
        assert "bazi" in deps
        assert "zodiac" in deps

        # bazi 只应该返回自身
        deps = get_skill_data_deps("bazi")
        assert deps == ["bazi"]

    def test_skill_includes(self):
        """测试 includes 工具依赖"""
        from services.agent.routing_config import get_skill_includes

        # jungastro 应该包含 zodiac
        includes = get_skill_includes("jungastro")
        assert "zodiac" in includes

        # synastry 应该包含 bazi + zodiac
        includes = get_skill_includes("synastry")
        assert "bazi" in includes
        assert "zodiac" in includes

        # bazi 不应该包含任何其他 skill
        includes = get_skill_includes("bazi")
        assert includes == []

    def test_tool_registry_includes(self):
        """测试 ToolRegistry 正确加载 includes 的工具"""
        from services.agent.tool_registry import ToolRegistry

        ToolRegistry.initialize()

        # jungastro 应该有 zodiac 的工具
        jungastro_tools = ToolRegistry.get_tools_for_skill("jungastro")
        tool_names = {t["function"]["name"] for t in jungastro_tools}
        assert "calculate_zodiac" in tool_names

        # bazi 不应该有 zodiac 的工具
        bazi_tools = ToolRegistry.get_tools_for_skill("bazi")
        bazi_tool_names = {t["function"]["name"] for t in bazi_tools}
        assert "calculate_zodiac" not in bazi_tool_names


class TestProfileCache:
    """Profile 缓存测试"""

    @pytest.mark.asyncio
    async def test_skill_data_loading(self):
        """测试 skill_data 依赖加载"""
        from stores.profile_cache import get_cached_profile_with_skill
        from uuid import uuid4

        # 模拟用户 ID（实际测试需要真实数据）
        test_user_id = uuid4()

        # 这个测试需要数据库中有测试数据
        # result = await get_cached_profile_with_skill(test_user_id, "jungastro")
        # assert "bazi" in result.get("skill_data", {})
        # assert "zodiac" in result.get("skill_data", {})


# ═══════════════════════════════════════════════════════════════
# 运行入口
# ═══════════════════════════════════════════════════════════════

if __name__ == "__main__":
    print_test_cases()
