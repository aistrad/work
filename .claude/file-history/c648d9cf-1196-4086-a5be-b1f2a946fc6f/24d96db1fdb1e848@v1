/**
 * OAuth Buttons Component
 * Google and Apple sign-in buttons
 */
"use client";

import { useState } from "react";
import { Button } from "@/components/ui/Button";
import { googleAuth, appleAuth, OnboardingData } from "@/lib/api";

interface OAuthButtonsProps {
  onSuccess?: () => void;
  onError?: (error: string) => void;
  onboarding?: OnboardingData;
  disabled?: boolean;
}

// Google OAuth configuration
const GOOGLE_CLIENT_ID = process.env.NEXT_PUBLIC_GOOGLE_CLIENT_ID || "";

export function OAuthButtons({
  onSuccess,
  onError,
  onboarding,
  disabled = false,
}: OAuthButtonsProps) {
  const [isGoogleLoading, setIsGoogleLoading] = useState(false);
  const [isAppleLoading, setIsAppleLoading] = useState(false);

  // Google Sign-In
  const handleGoogleSignIn = async () => {
    if (!GOOGLE_CLIENT_ID) {
      onError?.("Google OAuth not configured");
      return;
    }

    setIsGoogleLoading(true);

    try {
      // Load Google Identity Services
      const google = (window as unknown as { google?: { accounts: { id: { initialize: (config: { client_id: string; callback: (response: { credential: string }) => void }) => void; prompt: () => void } } } }).google;

      if (!google) {
        // Load the script if not already loaded
        await loadGoogleScript();
      }

      // Initialize and prompt
      const googleAccounts = (window as unknown as { google: { accounts: { id: { initialize: (config: { client_id: string; callback: (response: { credential: string }) => void }) => void; prompt: () => void } } } }).google.accounts.id;

      googleAccounts.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: async (response: { credential: string }) => {
          try {
            await googleAuth(response.credential, onboarding);
            onSuccess?.();
          } catch (err) {
            onError?.(err instanceof Error ? err.message : "Google auth failed");
          } finally {
            setIsGoogleLoading(false);
          }
        },
      });

      googleAccounts.prompt();
    } catch (err) {
      onError?.(err instanceof Error ? err.message : "Google sign-in failed");
      setIsGoogleLoading(false);
    }
  };

  // Apple Sign-In
  const handleAppleSignIn = async () => {
    setIsAppleLoading(true);

    try {
      // Load Apple JS SDK if not loaded
      const AppleID = (window as unknown as { AppleID?: { auth: { init: (config: { clientId: string; scope: string; redirectURI: string; usePopup: boolean }) => void; signIn: () => Promise<{ authorization: { id_token: string }; user?: { name?: { firstName?: string; lastName?: string } } }> } } }).AppleID;

      if (!AppleID) {
        await loadAppleScript();
      }

      const appleAuth_ = (window as unknown as { AppleID: { auth: { init: (config: { clientId: string; scope: string; redirectURI: string; usePopup: boolean }) => void; signIn: () => Promise<{ authorization: { id_token: string }; user?: { name?: { firstName?: string; lastName?: string } } }> } } }).AppleID.auth;

      appleAuth_.init({
        clientId: process.env.NEXT_PUBLIC_APPLE_CLIENT_ID || "",
        scope: "name email",
        redirectURI: `${window.location.origin}/auth/apple-callback`,
        usePopup: true,
      });

      const response = await appleAuth_.signIn();
      const idToken = response.authorization.id_token;
      const userName = response.user?.name
        ? `${response.user.name.firstName || ""} ${response.user.name.lastName || ""}`.trim()
        : undefined;

      await appleAuth(idToken, userName, onboarding);
      onSuccess?.();
    } catch (err) {
      // User cancelled or error
      if ((err as { error?: string })?.error !== "popup_closed_by_user") {
        onError?.(err instanceof Error ? err.message : "Apple sign-in failed");
      }
    } finally {
      setIsAppleLoading(false);
    }
  };

  return (
    <div className="space-y-3">
      {/* Google Sign-In */}
      <Button
        type="button"
        variant="secondary"
        className="w-full flex items-center justify-center gap-2"
        onClick={handleGoogleSignIn}
        disabled={disabled || isGoogleLoading}
        isLoading={isGoogleLoading}
      >
        <GoogleIcon />
        Continue with Google
      </Button>

      {/* Apple Sign-In */}
      <Button
        type="button"
        variant="secondary"
        className="w-full flex items-center justify-center gap-2"
        onClick={handleAppleSignIn}
        disabled={disabled || isAppleLoading}
        isLoading={isAppleLoading}
      >
        <AppleIcon />
        Continue with Apple
      </Button>

      {/* WeChat Sign-In */}
      <WechatLoginButton
        onSuccess={onSuccess}
        onError={onError}
        onboarding={onboarding}
        disabled={disabled}
      />
    </div>
  );
}

// Helper to load Google Identity Services script
function loadGoogleScript(): Promise<void> {
  return new Promise((resolve, reject) => {
    if (document.getElementById("google-identity-script")) {
      resolve();
      return;
    }

    const script = document.createElement("script");
    script.id = "google-identity-script";
    script.src = "https://accounts.google.com/gsi/client";
    script.async = true;
    script.defer = true;
    script.onload = () => resolve();
    script.onerror = () => reject(new Error("Failed to load Google script"));
    document.head.appendChild(script);
  });
}

// Helper to load Apple JS SDK
function loadAppleScript(): Promise<void> {
  return new Promise((resolve, reject) => {
    if (document.getElementById("apple-signin-script")) {
      resolve();
      return;
    }

    const script = document.createElement("script");
    script.id = "apple-signin-script";
    script.src = "https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js";
    script.async = true;
    script.defer = true;
    script.onload = () => resolve();
    script.onerror = () => reject(new Error("Failed to load Apple script"));
    document.head.appendChild(script);
  });
}

// Google Icon
function GoogleIcon() {
  return (
    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
      <path
        d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"
        fill="#4285F4"
      />
      <path
        d="M9.003 18c2.43 0 4.467-.806 5.956-2.18l-2.909-2.26c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.96v2.332A8.997 8.997 0 009.003 18z"
        fill="#34A853"
      />
      <path
        d="M3.964 10.712A5.41 5.41 0 013.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 000 9c0 1.452.348 2.827.957 4.042l3.007-2.33z"
        fill="#FBBC05"
      />
      <path
        d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.428 0 9.002 0A8.997 8.997 0 00.957 4.958L3.964 7.29c.708-2.127 2.692-3.71 5.036-3.71z"
        fill="#EA4335"
      />
    </svg>
  );
}

// Apple Icon
function AppleIcon() {
  return (
    <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
      <path d="M14.94 9.88c-.02-2.08 1.7-3.08 1.78-3.13-.97-1.42-2.48-1.61-3.02-1.63-1.28-.13-2.51.76-3.16.76-.65 0-1.66-.74-2.73-.72-1.4.02-2.7.82-3.42 2.08-1.46 2.53-.37 6.28 1.05 8.34.7 1.01 1.53 2.14 2.62 2.1 1.05-.04 1.45-.68 2.72-.68 1.27 0 1.64.68 2.74.66 1.13-.02 1.84-1.03 2.53-2.04.8-1.17 1.13-2.3 1.15-2.36-.03-.01-2.2-.84-2.22-3.34l-.04-.04zM12.87 3.53c.58-.7.97-1.68.86-2.65-.83.03-1.84.55-2.44 1.25-.53.62-1 1.61-.87 2.56.92.07 1.87-.47 2.45-1.16z" />
    </svg>
  );
}
