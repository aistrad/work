/**
 * Email Authentication Form
 *
 * Two-step registration flow:
 * 1. Enter email/password -> Get verification code
 * 2. Enter verification code -> Account created
 *
 * Also supports login for existing users.
 */
"use client";

import { useState, useCallback, useRef } from "react";
import { Button } from "@/components/ui/Button";
import { Input } from "@/components/ui/Input";

// Turnstile types (package may not be installed in all environments)
type TurnstileInstance = {
  reset: () => void;
};

// Dynamic import for Turnstile to handle SSR and missing package gracefully
let Turnstile: React.ComponentType<{
  siteKey: string;
  onSuccess: (token: string) => void;
  onError?: () => void;
  options?: {
    size?: "normal" | "compact" | "invisible";
    theme?: "light" | "dark" | "auto";
  };
  ref?: React.Ref<TurnstileInstance>;
}> | null = null;

try {
  // eslint-disable-next-line @typescript-eslint/no-require-imports
  Turnstile = require("@marsidev/react-turnstile").Turnstile;
} catch {
  // Package not installed, Turnstile will be null
}

interface EmailAuthFormProps {
  onSuccess?: () => void;
  onError?: (error: string) => void;
  disabled?: boolean;
}

type Mode = "login" | "register";
type Step = "input" | "verify";

const TURNSTILE_SITE_KEY = process.env.NEXT_PUBLIC_CF_SITE_KEY || "";

export function EmailAuthForm({
  onSuccess,
  onError,
  disabled = false,
}: EmailAuthFormProps) {
  const [mode, setMode] = useState<Mode>("login");
  const [step, setStep] = useState<Step>("input");

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [code, setCode] = useState("");

  const [turnstileToken, setTurnstileToken] = useState("");
  const turnstileRef = useRef<TurnstileInstance | null>(null);

  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState("");
  const [countdown, setCountdown] = useState(0);

  // Reset Turnstile after each submission
  const resetTurnstile = useCallback(() => {
    setTurnstileToken("");
    turnstileRef.current?.reset();
  }, []);

  // Start countdown for resend
  const startCountdown = () => {
    setCountdown(60);
    const timer = setInterval(() => {
      setCountdown((c) => {
        if (c <= 1) {
          clearInterval(timer);
          return 0;
        }
        return c - 1;
      });
    }, 1000);
  };

  // Step 1: Register - send verification code
  const handleRegister = async () => {
    if (!email || !password) {
      setError("Please enter email and password");
      return;
    }

    if (password.length < 8) {
      setError("Password must be at least 8 characters");
      return;
    }

    if (!turnstileToken) {
      setError("Please complete the verification");
      return;
    }

    setIsLoading(true);
    setError("");

    try {
      const res = await fetch("/api/auth/email/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          password,
          turnstile_token: turnstileToken,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.detail || data.error || "Registration failed");
      }

      // Move to verification step
      setStep("verify");
      startCountdown();
      resetTurnstile();
    } catch (err) {
      const message = err instanceof Error ? err.message : "Registration failed";
      setError(message);
      onError?.(message);
      resetTurnstile();
    } finally {
      setIsLoading(false);
    }
  };

  // Step 2: Verify code
  const handleVerify = async () => {
    if (!code || code.length !== 6) {
      setError("Please enter the 6-digit code");
      return;
    }

    setIsLoading(true);
    setError("");

    try {
      const res = await fetch("/api/auth/email/verify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, code }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.detail || data.error || "Verification failed");
      }

      // Store tokens
      localStorage.setItem("vibelife_access_token", data.access_token);
      localStorage.setItem("vibelife_refresh_token", data.refresh_token);

      onSuccess?.();
    } catch (err) {
      const message = err instanceof Error ? err.message : "Verification failed";
      setError(message);
      onError?.(message);
    } finally {
      setIsLoading(false);
    }
  };

  // Resend code
  const handleResend = async () => {
    if (countdown > 0) return;

    if (!turnstileToken) {
      setError("Please complete the verification");
      return;
    }

    setIsLoading(true);
    setError("");

    try {
      const res = await fetch("/api/auth/email/resend", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          turnstile_token: turnstileToken,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.detail || data.error || "Failed to resend code");
      }

      startCountdown();
      resetTurnstile();
    } catch (err) {
      const message = err instanceof Error ? err.message : "Failed to resend code";
      setError(message);
      resetTurnstile();
    } finally {
      setIsLoading(false);
    }
  };

  // Login
  const handleLogin = async () => {
    if (!email || !password) {
      setError("Please enter email and password");
      return;
    }

    if (!turnstileToken) {
      setError("Please complete the verification");
      return;
    }

    setIsLoading(true);
    setError("");

    try {
      const res = await fetch("/api/auth/email/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email,
          password,
          turnstile_token: turnstileToken,
        }),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.detail || data.error || "Login failed");
      }

      // Store tokens
      localStorage.setItem("vibelife_access_token", data.access_token);
      localStorage.setItem("vibelife_refresh_token", data.refresh_token);

      onSuccess?.();
    } catch (err) {
      const message = err instanceof Error ? err.message : "Login failed";
      setError(message);
      onError?.(message);
      resetTurnstile();
    } finally {
      setIsLoading(false);
    }
  };

  // Switch between login and register
  const switchMode = () => {
    setMode(mode === "login" ? "register" : "login");
    setStep("input");
    setError("");
    setCode("");
    resetTurnstile();
  };

  // Go back from verify step
  const goBack = () => {
    setStep("input");
    setCode("");
    setError("");
  };

  // Verification code input step
  if (step === "verify") {
    return (
      <div className="space-y-4">
        <div className="text-center">
          <p className="text-sm text-gray-600 dark:text-gray-400">
            Verification code sent to
          </p>
          <p className="font-medium text-gray-900 dark:text-white">{email}</p>
        </div>

        <Input
          type="text"
          inputMode="numeric"
          pattern="[0-9]*"
          maxLength={6}
          value={code}
          onChange={(e) => setCode(e.target.value.replace(/\D/g, ""))}
          placeholder="Enter 6-digit code"
          className="text-center text-2xl tracking-widest"
          disabled={disabled || isLoading}
          autoFocus
        />

        {error && (
          <p className="text-sm text-red-500 text-center">{error}</p>
        )}

        <Button
          onClick={handleVerify}
          disabled={disabled || isLoading || code.length !== 6}
          isLoading={isLoading}
          className="w-full"
        >
          Verify & Create Account
        </Button>

        <div className="flex items-center justify-between text-sm">
          <button
            type="button"
            onClick={goBack}
            className="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300"
          >
            Back
          </button>

          {countdown > 0 ? (
            <span className="text-gray-400">Resend in {countdown}s</span>
          ) : (
            <>
              {TURNSTILE_SITE_KEY && Turnstile && (
                <Turnstile
                  siteKey={TURNSTILE_SITE_KEY}
                  onSuccess={setTurnstileToken}
                  ref={(ref: TurnstileInstance | null) => { turnstileRef.current = ref; }}
                  options={{
                    size: "invisible",
                    theme: "auto",
                  }}
                />
              )}
              <button
                type="button"
                onClick={handleResend}
                disabled={isLoading}
                className="text-indigo-600 hover:text-indigo-500 dark:text-indigo-400"
              >
                Resend code
              </button>
            </>
          )}
        </div>
      </div>
    );
  }

  // Email/Password input step
  return (
    <div className="space-y-4">
      <Input
        type="email"
        value={email}
        onChange={(e) => setEmail(e.target.value)}
        placeholder="Email address"
        disabled={disabled || isLoading}
        autoComplete="email"
      />

      <Input
        type="password"
        value={password}
        onChange={(e) => setPassword(e.target.value)}
        placeholder={mode === "register" ? "Password (8+ characters)" : "Password"}
        disabled={disabled || isLoading}
        autoComplete={mode === "register" ? "new-password" : "current-password"}
      />

      {error && (
        <p className="text-sm text-red-500 text-center">{error}</p>
      )}

      {/* Turnstile Widget */}
      {TURNSTILE_SITE_KEY && Turnstile && (
        <div className="flex justify-center">
          <Turnstile
            siteKey={TURNSTILE_SITE_KEY}
            onSuccess={setTurnstileToken}
            onError={() => setError("Verification failed. Please try again.")}
            ref={(ref: TurnstileInstance | null) => { turnstileRef.current = ref; }}
            options={{
              theme: "auto",
              size: "normal",
            }}
          />
        </div>
      )}

      <Button
        onClick={mode === "register" ? handleRegister : handleLogin}
        disabled={disabled || isLoading || !email || !password}
        isLoading={isLoading}
        className="w-full"
      >
        {mode === "register" ? "Create Account" : "Sign In"}
      </Button>

      <div className="text-center text-sm">
        <span className="text-gray-500 dark:text-gray-400">
          {mode === "register" ? "Already have an account? " : "Don't have an account? "}
        </span>
        <button
          type="button"
          onClick={switchMode}
          className="text-indigo-600 hover:text-indigo-500 dark:text-indigo-400 font-medium"
        >
          {mode === "register" ? "Sign in" : "Create one"}
        </button>
      </div>
    </div>
  );
}
