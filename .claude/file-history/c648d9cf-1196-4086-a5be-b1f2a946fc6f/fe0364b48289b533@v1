-- Migration 026: Email Verification System
-- Purpose: Store temporary verification codes for email registration

-- ═══════════════════════════════════════════════════════════════════════════
-- Email Verification Codes Table
-- ═══════════════════════════════════════════════════════════════════════════

CREATE TABLE IF NOT EXISTS email_verification_codes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,  -- Email being verified
    code VARCHAR(6) NOT NULL,            -- 6-digit verification code
    password_hash VARCHAR(255) NOT NULL, -- Hashed password (stored until verified)
    attempts INT DEFAULT 0,              -- Failed verification attempts
    expires_at TIMESTAMPTZ NOT NULL,     -- Code expiration time
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_email_verification_email ON email_verification_codes(email);
CREATE INDEX IF NOT EXISTS idx_email_verification_expires ON email_verification_codes(expires_at);

-- ═══════════════════════════════════════════════════════════════════════════
-- Cleanup Job (Optional: Can be run via cron)
-- ═══════════════════════════════════════════════════════════════════════════

-- Cleanup function to remove expired codes
CREATE OR REPLACE FUNCTION cleanup_expired_verification_codes()
RETURNS void AS $$
BEGIN
    DELETE FROM email_verification_codes WHERE expires_at < NOW();
END;
$$ LANGUAGE plpgsql;

-- Comments
COMMENT ON TABLE email_verification_codes IS 'Temporary storage for email verification codes during registration';
COMMENT ON COLUMN email_verification_codes.password_hash IS 'Bcrypt hashed password, stored temporarily until email is verified';
COMMENT ON COLUMN email_verification_codes.attempts IS 'Number of failed verification attempts (max 5)';
