/**
 * useVibeChat - AI SDK 4.x useChat wrapper for VibeLife
 *
 * v5.3 协议流支持:
 * - 监听 protocol_progress 和 protocol_completed 事件
 * - 追踪当前协议状态
 * - 内联嵌入的协议进度展示
 *
 * v5.2 优化:
 * - 使用缓存的 localStorage 工具 (Vercel rule: js-cache-storage)
 * - 优化 useMemo 依赖 (Vercel rule: rerender-usememo-expensive)
 *
 * Provides streaming chat with OpenAI-compatible backend
 * Uses standard OpenAI SSE format from Python CoreAgent
 */

'use client';

import { useChat, Message } from 'ai/react';
import { useCallback, useMemo, useState } from 'react';
import { getAccessToken } from '@/utils/storage';

export type SkillId = 'bazi' | 'zodiac' | 'mbti' | 'tarot' | 'attach' | 'career' | 'lifecoach';
export type VoiceMode = 'warm' | 'sarcastic';

export interface ProtocolState {
  id: string;
  step: number;
  totalSteps: number;
  phase: string;
  progress: number; // 0-1
  stepName: string;
}

export interface UseVibeChatOptions {
  /**
   * Skill ID - 可选
   * - 传入时：后端直接使用该 skill，不走 LLM 路由
   * - 不传时：后端 CoreAgent 通过 LLM 自动识别用户意图并路由到合适的 skill
   */
  skillId?: SkillId;
  voiceMode?: VoiceMode;
  conversationId?: string;
  onConversationStart?: (id: string) => void;
  onError?: (error: Error) => void;
  onFinish?: (message: Message) => void;
  onProtocolProgress?: (state: ProtocolState) => void;
  onProtocolCompleted?: (protocolId: string) => void;
}

export function useVibeChat({
  skillId,
  voiceMode = 'warm',
  conversationId,
  onConversationStart,
  onError,
  onFinish,
  onProtocolProgress,
  onProtocolCompleted,
}: UseVibeChatOptions) {
  // Protocol state tracking
  const [protocolState, setProtocolState] = useState<ProtocolState | null>(null);

  // Get auth token - getAccessToken() uses cached Map lookup (O(1)), safe to call on each render
  // This ensures token changes (login/logout) are reflected immediately
  const accessToken = getAccessToken();

  // Memoize headers to prevent unnecessary re-renders (Vercel rule: rerender-usememo-expensive)
  const headers = useMemo(
    () => (accessToken ? { Authorization: `Bearer ${accessToken}` } : undefined),
    [accessToken]
  );

  // Memoize body to prevent unnecessary re-renders
  // 当 skillId 为 undefined 时，不传 skill 字段，让后端 LLM 自动路由
  const body = useMemo(
    () => ({
      ...(skillId && { skill: skillId }),
      voice_mode: voiceMode,
      conversation_id: conversationId,
    }),
    [skillId, voiceMode, conversationId]
  );

  // AI SDK 4.x useChat hook
  const chat = useChat({
    api: '/api/v1/chat/v5/stream',
    // 使用默认 data 协议，支持 toolInvocations (0:, 9:, a: 格式) 和自定义数据 (2:[key, value])
    headers,
    body,
    onFinish: (message) => {
      // 检测协议事件（AI SDK Data Stream Protocol: 2:[key, value]）
      if (message.data) {
        const events = Array.isArray(message.data) ? message.data : [message.data];

        for (const event of events) {
          if (Array.isArray(event) && event.length === 2) {
            const [eventType, eventData] = event;

            if (eventType === 'protocol_progress' && eventData) {
              const state: ProtocolState = {
                id: eventData.protocol_id,
                step: eventData.step,
                totalSteps: eventData.total_steps,
                phase: eventData.phase,
                progress: eventData.progress,
                stepName: eventData.step_name,
              };
              setProtocolState(state);
              onProtocolProgress?.(state);
            } else if (eventType === 'protocol_completed' && eventData) {
              setProtocolState(null);
              onProtocolCompleted?.(eventData.protocol_id);
            }
          }
        }
      }

      onFinish?.(message);
    },
    onError: (error) => {
      console.error('Chat error:', error);
      onError?.(error);
    },
  });

  // Wrapper for sending messages
  const sendVibeMessage = useCallback(
    async (content: string) => {
      return chat.append({
        role: 'user',
        content,
      });
    },
    [chat]
  );

  // Clear messages and send (for quick prompts)
  const sendQuickPrompt = useCallback(
    async (content: string) => {
      chat.setMessages([]);
      return sendVibeMessage(content);
    },
    [chat, sendVibeMessage]
  );

  // Tool approval (placeholder for AI SDK 4.x compatibility)
  // In AI SDK 4.x, tool results are handled server-side
  const approveToolCall = useCallback(
    (toolCallId: string, approved: boolean) => {
      console.log(`Tool ${toolCallId} ${approved ? 'approved' : 'rejected'}`);
      // AI SDK 4.x handles tool execution server-side
    },
    []
  );

  return {
    // Core state
    messages: chat.messages,
    isLoading: chat.isLoading,
    error: chat.error,

    // Protocol state
    protocolState,

    // Actions
    sendMessage: sendVibeMessage,
    sendQuickPrompt,
    stop: chat.stop,
    reload: chat.reload,
    approveToolCall,

    // For advanced use
    setMessages: chat.setMessages,
    append: chat.append,
    input: chat.input,
    setInput: chat.setInput,
    handleInputChange: chat.handleInputChange,
    handleSubmit: chat.handleSubmit,

    // Metadata
    conversationId,
    skillId,
    voiceMode,
  };
}

export default useVibeChat;
