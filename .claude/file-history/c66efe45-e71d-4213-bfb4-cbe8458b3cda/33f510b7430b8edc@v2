# VibeLife 顶层架构设计

> Version: 11.0 | 2026-01-21
> 设计原则：**四维统一 × 各司其职 × LLM 原生**

---

## 一、核心洞察：VibeLife 解决什么问题？

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                    VibeLife = 人类理解自己的基础设施                          │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   用户的四个核心问题               VibeLife 的四大支柱                        │
│   ────────────────────           ────────────────────                       │
│                                                                             │
│   "我想找专家咨询"          ──▶   CoreAgent + Skills                        │
│                                   用户找专家（对话即服务）                    │
│                                                                             │
│   "我的信息太分散"          ──▶   VibeProfile                               │
│                                   用户信息统一（一个人的全貌）                │
│                                                                             │
│   "我是谁？"               ──▶   Me (VibeID)                                │
│                                   用户是谁（跨维度自我认知）                  │
│                                                                             │
│   "我要成为谁？"           ──▶   Journey (Goals)                            │
│                                   用户的目标（行动与成长）                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、顶层架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         VibeLife Top-Level Architecture                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         前端界面 (Next.js)                           │   │
│   │   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐            │   │
│   │   │  Chat   │   │   Me    │   │ Journey │   │ Skills  │            │   │
│   │   │  对话   │   │  画像   │   │  旅程   │   │  技能   │            │   │
│   │   │         │   │         │   │         │   │         │            │   │
│   │   │ 问专家  │   │ 我是谁  │   │ 我要去哪│   │ 找能力  │            │   │
│   │   └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘            │   │
│   └────────┼─────────────┼─────────────┼─────────────┼──────────────────┘   │
│            │             │             │             │                      │
│            ▼             ▼             ▼             ▼                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         API Layer (FastAPI)                          │   │
│   │                                                                      │   │
│   │   /chat/v5/*      /me/*         /journey/*      /skills/*           │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│            │             │             │             │                      │
│            ▼             │             │             │                      │
│   ┌────────────────┐     │             │             │                      │
│   │   CoreAgent    │◀────┼─────────────┼─────────────┘                      │
│   │  (LLM 对话核心) │     │             │                                    │
│   │                │     │             │                                    │
│   │ ┌────────────┐ │     │             │                                    │
│   │ │   Skills   │ │     │             │                                    │
│   │ │ ┌────┬────┐│ │     │             │                                    │
│   │ │ │bazi│zodiac││     │             │                                    │
│   │ │ ├────┼────┤│ │     │             │                                    │
│   │ │ │life│vibe_id│     │             │                                    │
│   │ │ │coach│    ││ │     │             │                                    │
│   │ │ └────┴────┘│ │     │             │                                    │
│   │ └────────────┘ │     │             │                                    │
│   └───────┬────────┘     │             │                                    │
│           │              │             │                                    │
│           ▼              ▼             ▼                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                      │   │
│   │                         VibeProfile Layer                            │   │
│   │                      (统一用户数据中心)                               │   │
│   │                                                                      │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐  │   │
│   │   │  Identity   │  │ Skill Data  │  │  Extracted  │  │  Insights │  │   │
│   │   │   身份层    │  │   业务层    │  │    抽取层   │  │   洞察层  │  │   │
│   │   │             │  │             │  │             │  │           │  │   │
│   │   │ birth_info  │  │ bazi.chart  │  │ emotion     │  │ vibe_id   │  │   │
│   │   │ account     │  │ zodiac.chart│  │ behavior    │  │ fortune   │  │   │
│   │   │             │  │ lifecoach   │  │ topic_heat  │  │ alignment │  │   │
│   │   │             │  │   .goals    │  │             │  │           │  │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘  │   │
│   │                                                                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、四大支柱详解

### 3.1 CoreAgent + Skills：用户找专家

**核心问题**：用户有问题想找专家咨询

**解决方案**：
```
┌─────────────────────────────────────────────────────────────────┐
│                    CoreAgent + Skills                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  职责：提供专业对话服务                                           │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  用户说："我想看看今天的运势"                                     │
│      ↓                                                           │
│  CoreAgent 路由到 Bazi Skill                                     │
│      ↓                                                           │
│  Bazi Skill 调用 calculate_daily_fortune                        │
│      ↓                                                           │
│  返回专业运势分析                                                 │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  Skill 类型：                                                    │
│  • Core: core (灵魂)                                             │
│  • Default: lifecoach, mindfulness                               │
│  • Professional: bazi, zodiac, tarot, career, jungastro, vibe_id │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  关键特性：                                                       │
│  • LLM 自动路由（不是 if-else 硬编码）                           │
│  • 配置驱动（SKILL.md 定义能力）                                 │
│  • 流式输出（SSE 实时响应）                                      │
│  • Tool Calling（工具即能力）                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**数据流向**：
```
Chat → CoreAgent → Skill → Tool → VibeProfile (写入 skill_data)
```

---

### 3.2 VibeProfile：用户信息统一

**核心问题**：用户信息分散在各处，无法形成完整画像

**解决方案**：
```
┌─────────────────────────────────────────────────────────────────┐
│                       VibeProfile                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  职责：统一存储、统一访问、统一更新                               │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  数据来源：                                                       │
│                                                                  │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐          │
│  │   用户填写   │    │  Skill 写入 │    │  Extractor  │          │
│  │             │    │             │    │   抽取      │          │
│  │ birth_info  │    │ bazi.chart  │    │ emotion     │          │
│  │ preferences │    │ zodiac.chart│    │ behavior    │          │
│  │             │    │ goals       │    │ topic_heat  │          │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘          │
│         │                  │                  │                  │
│         └─────────────┬────┴──────────────────┘                  │
│                       ▼                                          │
│              unified_profiles.profile                            │
│                    (JSONB)                                       │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  四层数据架构：                                                   │
│                                                                  │
│  Layer 1: Identity    用户是谁（静态）     birth_info, account   │
│  Layer 2: Skill Data  Skill 产出（动态）   bazi, zodiac, goals   │
│  Layer 3: Extracted   对话抽取（批量）     emotion, behavior     │
│  Layer 4: Insights    跨维度洞察（融合）   vibe_id, fortune      │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  访问方式：UnifiedProfileRepository                              │
│  • get_profile() / update_profile()                              │
│  • get_skill_data() / update_skill_data()                        │
│  • jsonb_set 局部更新，避免全量覆盖                              │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**关键洞察**：
- VibeProfile 是 **数据中心**，不是功能模块
- 所有模块读写 VibeProfile，VibeProfile 不主动做任何事
- 这是 **Single Source of Truth**

---

### 3.3 Me (VibeID)：用户是谁

**核心问题**：用户不知道自己是谁，需要多维度自我认知

**解决方案**：
```
┌─────────────────────────────────────────────────────────────────┐
│                        Me (VibeID)                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  职责：回答"我是谁"——跨维度的自我画像                            │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  三层认知：                                                       │
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  Layer 1: 命理特质（先天）                                 │   │
│  │  ─────────────────────────────────────────────────────────│   │
│  │  来源：skill_data.bazi + skill_data.zodiac                │   │
│  │  内容：八字格局、太阳星座、人格倾向                        │   │
│  │  示例："日主甲木，食神旺，表达力强"                        │   │
│  └───────────────────────────────────────────────────────────┘   │
│                        ↓ 融合                                     │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  Layer 2: 行为模式（后天）                                 │   │
│  │  ─────────────────────────────────────────────────────────│   │
│  │  来源：extracted (ProfileExtractor 抽取)                   │   │
│  │  内容：情绪状态、行为模式、话题热度、原型信号               │   │
│  │  示例："近期频繁讨论写作，创造者原型 40%"                  │   │
│  └───────────────────────────────────────────────────────────┘   │
│                        ↓ 融合                                     │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │  Layer 3: VibeID 洞察（跨维度）                            │   │
│  │  ─────────────────────────────────────────────────────────│   │
│  │  来源：LLM 融合 Layer 1 + Layer 2                         │   │
│  │  内容：四原型权重、融合洞察、成长建议                       │   │
│  │  示例："八字食神旺 + 双子善沟通 + 近期频繁写作，           │   │
│  │        创造者原型正在觉醒"                                 │   │
│  └───────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  Me 页展示：                                                     │
│  • 首屏：1 条融合洞察（简洁）                                    │
│  • 展开：VibeID 原型演化、情绪轨迹、运势上下文                   │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  核心原则：                                                       │
│  • 命理是"倾向"，不是"宿命"                                      │
│  • VibeID 是动态演化的，不是固定标签                             │
│  • 洞察要赋能，不要限制                                          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**数据流向**：
```
skill_data (bazi + zodiac) ─┐
                            ├─▶ ProfileExtractor ─▶ insights.vibe_id
extracted (behavior)        ─┘

Me 页 ◀── GET /me/dashboard ◀── insights + extracted
```

---

### 3.4 Journey (Goals)：用户的目标

**核心问题**：用户有目标但难以坚持，需要陪伴和指引

**解决方案**：
```
┌─────────────────────────────────────────────────────────────────┐
│                      Journey (Goals)                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  职责：回答"我要成为谁"——目标管理 + 命理对齐                    │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  数据结构：                                                       │
│                                                                  │
│  skill_data.lifecoach.goals = [                                  │
│    {                                                             │
│      id: "goal_001",                                             │
│      title: "完成写作项目",                                      │
│      tags: ["career", "creativity"],                             │
│      progress: 0.6,                                              │
│      check_ins: [...]                                            │
│    }                                                             │
│  ]                                                               │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  智能排序（Journey 页核心创新）：                                 │
│                                                                  │
│  priority_score =                                                │
│      topic_heat * 0.4 +        // 近期关注度                     │
│      fortune_alignment * 0.3 + // 命理契合度                     │
│      archetype_match * 0.3     // VibeID 匹配度                  │
│                                                                  │
│  示例：                                                          │
│  • "完成写作项目" → 高优先级                                     │
│    - topic_heat: career 0.8 ✓                                   │
│    - fortune: 大运利文 ✓                                         │
│    - archetype: 创造者 35% ✓                                    │
│                                                                  │
│  • "学习投资理财" → 低优先级                                     │
│    - topic_heat: finance 0.2                                    │
│    - fortune: 大运不利财 ⚠️                                      │
│    - archetype: 智者 10%                                        │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  Lifecoach 整合：                                                │
│  • 目标管理是 Lifecoach Skill 的核心能力                        │
│  • Chat 中设定目标 → 写入 skill_data.lifecoach.goals            │
│  • Journey 页读取并展示                                          │
│  • Proactive 推送目标提醒                                        │
│                                                                  │
│  ─────────────────────────────────────────────────────────────   │
│                                                                  │
│  表达方式（重要！）：                                             │
│  ✓ "当前大运利文，建议优先推进"                                  │
│  ✗ "大运不利，建议放弃"                                          │
│                                                                  │
│  核心原则：                                                       │
│  • 命理是参考，不是判决                                          │
│  • 提供选择，不要替用户决定                                      │
│  • 困难的目标需要额外努力，不是不能做                            │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

**数据流向**：
```
Chat (Lifecoach) ─▶ skill_data.lifecoach.goals (写入目标)
                          │
                          ▼
Journey 页 ◀── GET /journey/goals (读取 + 智能排序)
                          │
                          ▼
ProactiveEngine ─▶ 目标提醒推送
```

---

## 四、模块关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            四大支柱关系图                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────┐                                 │
│                         │    用户对话     │                                 │
│                         └────────┬────────┘                                 │
│                                  │                                          │
│                                  ▼                                          │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                                                                     │    │
│   │                    CoreAgent + Skills                               │    │
│   │                    (对话即服务)                                      │    │
│   │                                                                     │    │
│   │   bazi ──┬── 计算命盘 ─────────────────┐                            │    │
│   │   zodiac ┤                             │                            │    │
│   │   tarot  ┤                             │                            │    │
│   │   lifecoach ┼── 设定目标 ──────────────┼──┐                         │    │
│   │   vibe_id ──── 计算 VibeID ────────────┼──┼──┐                      │    │
│   │                                        │  │  │                      │    │
│   └────────────────────────────────────────┼──┼──┼──────────────────────┘    │
│                                            │  │  │                          │
│                                            ▼  ▼  ▼                          │
│   ┌────────────────────────────────────────────────────────────────────┐    │
│   │                                                                     │    │
│   │                       VibeProfile                                   │    │
│   │                     (统一数据中心)                                   │    │
│   │                                                                     │    │
│   │   skill_data.bazi ◀────────────────────┘  │  │                      │    │
│   │   skill_data.lifecoach.goals ◀────────────┘  │                      │    │
│   │   skill_data.vibe_id ◀───────────────────────┘                      │    │
│   │                                                                     │    │
│   │   ─────────────────────────────────────────────────────────────     │    │
│   │   ProfileExtractor (每日凌晨 3 点)                                   │    │
│   │   ─────────────────────────────────────────────────────────────     │    │
│   │   conversations + skill_data                                        │    │
│   │       ↓                                                             │    │
│   │   extracted (emotion, behavior, topic_heat)                         │    │
│   │       ↓                                                             │    │
│   │   insights.vibe_id (跨维度融合)                                     │    │
│   │                                                                     │    │
│   └────────────────────────────────────────────────────────────────────┘    │
│                        │                    │                               │
│            ┌───────────┴────────┐    ┌──────┴──────┐                        │
│            │                    │    │             │                        │
│            ▼                    ▼    ▼             ▼                        │
│   ┌────────────────┐   ┌────────────────┐   ┌────────────────┐             │
│   │                │   │                │   │                │             │
│   │    Me 页       │   │  Journey 页    │   │ ProactiveEngine│             │
│   │   (我是谁)     │   │  (我要去哪)    │   │   (主动关怀)   │             │
│   │                │   │                │   │                │             │
│   │ 读取:          │   │ 读取:          │   │ 读取:          │             │
│   │ • insights     │   │ • goals        │   │ • extracted    │             │
│   │ • extracted    │   │ • topic_heat   │   │ • skill_data   │             │
│   │                │   │ • fortune      │   │ • insights     │             │
│   │                │   │ • vibe_id      │   │                │             │
│   └────────────────┘   └────────────────┘   └────────────────┘             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、数据流全景

### 5.1 写入流

```
用户对话 (Chat)
    │
    ├─ Bazi Skill ─────▶ skill_data.bazi (命盘)
    ├─ Zodiac Skill ───▶ skill_data.zodiac (星盘)
    ├─ Lifecoach ──────▶ skill_data.lifecoach.goals (目标)
    ├─ VibeID Skill ───▶ skill_data.vibe_id (原型计算)
    │
    ▼
conversations/messages (对话历史)
    │
    ▼ (每日凌晨 3 点)
ProfileExtractor
    │
    ├─ 抽取 ──▶ extracted (emotion, behavior, topic_heat)
    └─ 融合 ──▶ insights.vibe_id (跨维度洞察)
```

### 5.2 读取流

```
Me 页 ◀─── insights + extracted
Journey 页 ◀─── goals + topic_heat + fortune + vibe_id
Chat ◀─── skill_data (上下文注入)
ProactiveEngine ◀─── extracted + skill_data + insights
```

---

## 六、API 设计

### 6.1 Chat API（已有）

```
POST /api/v1/chat/v5/stream
{
  "message": "用户输入",
  "conversation_id": "可选"
}
```

### 6.2 Me API（新增）

```
GET /api/v1/me/dashboard

Response:
{
  "primary_insight": {
    "content": "融合洞察文案",
    "type": "fusion"
  },
  "vibe_id": {
    "archetype": { "creator": 0.35, "pioneer": 0.30, ... },
    "trend": { "rising": "pioneer", "delta": 0.05 }
  },
  "emotion": { "current": "calm", "intensity": 0.6, "trend": "stable" },
  "fortune_context": {
    "phase": "突破期",
    "guidance": "利沟通表达"
  },
  "data_level": "A"  // A=完整, B=部分, C=空白
}
```

### 6.3 Journey API（新增）

```
GET /api/v1/journey/goals

Response:
{
  "goals": [
    {
      "id": "g1",
      "title": "完成写作项目",
      "progress": 0.6,
      "priority_score": 0.92,
      "signals": {
        "topic_heat": 0.8,
        "fortune_aligned": true,
        "archetype_match": 0.35
      },
      "recommendation": "当前是推进此目标的好时机"
    }
  ],
  "alignment_summary": "当前大运利文，建议优先推进创作类目标"
}

POST /api/v1/journey/goals
{
  "title": "目标标题",
  "tags": ["career"]
}

PUT /api/v1/journey/goals/{id}/check-in
{
  "note": "今天写了一章"
}
```

---

## 七、实施路径

### Phase 1: VibeProfile 完善（已基本完成）

```
✅ unified_profiles 表
✅ UnifiedProfileRepository
✅ skill_data 写入（bazi, zodiac, lifecoach）
⏳ extracted 层完善（emotion, behavior, topic_heat）
⏳ insights 层（vibe_id 融合）
```

### Phase 2: ProfileExtractor 升级（3 天）

```
Day 1: 扩展抽取维度
  □ emotion (情绪)
  □ behavior (行为模式)
  □ topic_heat (话题热度)
  □ archetype_signals (原型信号)

Day 2: 跨维度融合
  □ 读取 skill_data (bazi, zodiac)
  □ LLM 生成 insights.vibe_id

Day 3: 测试验证
  □ 质量评估
  □ Prompt 调优
```

### Phase 3: Me 页 + API（2 天）

```
Day 4: Me API
  □ GET /api/v1/me/dashboard
  □ 容错策略 (Level A/B/C)

Day 5: Me 前端
  □ 首屏组件（核心洞察）
  □ 深度分析折叠区
```

### Phase 4: Journey 页 + API（3 天）

```
Day 6: Journey API
  □ GET /api/v1/journey/goals
  □ 智能排序算法

Day 7: Journey 前端
  □ 目标列表组件
  □ 优先级展示

Day 8: 打卡 + 提醒
  □ PUT /api/v1/journey/goals/{id}/check-in
  □ ProactiveEngine 目标提醒
```

**总计：8 天**

---

## 八、关键设计决策

### D1: 四大支柱的职责边界

| 支柱 | 核心职责 | 不做什么 |
|------|---------|---------|
| CoreAgent + Skills | 对话服务 | 不存储数据（委托 VibeProfile） |
| VibeProfile | 数据存储 | 不做业务逻辑 |
| Me (VibeID) | 自我认知 | 不做目标管理 |
| Journey (Goals) | 目标管理 | 不做深度分析 |

### D2: 数据分层原则

```
Identity    → 用户填写（静态）
Skill Data  → Skill 实时写入（动态）
Extracted   → ProfileExtractor 批量抽取（每日）
Insights    → LLM 跨维度融合（按需）
```

### D3: 命理定位

**原则：命理是"倾向"，不是"宿命"**

```
✓ "你的创造者特质正在显化"（赋能）
✗ "你命中注定是创造者"（限制）

✓ "当前大运利文，建议优先推进"（建议）
✗ "大运不利武，不要健身"（禁止）
```

---

## 九、与 V8 北极星对齐

| 北极星目标 | 实现方式 | 支柱 |
|-----------|---------|------|
| 深度理解 | 跨维度融合洞察 | Me (VibeID) |
| 主动关心 | ProactiveEngine | 全部 |
| 无限扩展 | Skill 配置驱动 | CoreAgent |
| 温暖不粘腻 | Core Skill 人格 | CoreAgent |
| 数据护城河 | VibeProfile 累积 | VibeProfile |

---

## 十、结语

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                  │
│                    VibeLife 四大支柱                             │
│                                                                  │
│   CoreAgent + Skills  ──  用户找专家（对话即服务）               │
│   VibeProfile        ──  用户信息统一（一个人的全貌）            │
│   Me (VibeID)        ──  用户是谁（跨维度自我认知）              │
│   Journey (Goals)    ──  用户的目标（行动与成长）                │
│                                                                  │
│   ─────────────────────────────────────────────────────────      │
│                                                                  │
│   四个问题，四个支柱，各司其职，统一于用户的成长旅程。            │
│                                                                  │
│   我们不只是做一个 App，                                         │
│   我们是在帮助人类理解自己。                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

> **Version**: 11.0 | 2026-01-21
> **基于**: V8 北极星 + V9 设计 + 顶层思考
