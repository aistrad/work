# Fortune AI Claude MVP v1.1 - 需求规格说明书

**文档类型**: Requirements Specification
**版本**: v1.0
**日期**: 2025-12-30
**HOS 来源**: `system_design_claude_mvp v1.md` (digest: `0dcb8e5c5d563160`)
**状态**: Draft

---

## 1. 引言

### 1.1 目的

本文档定义 Fortune AI Claude MVP v1.1 的完整功能需求，作为设计与实现的唯一依据。所有需求均可追溯到 HOS（Highest-Order Spec）。

### 1.2 范围

覆盖以下核心模块（按优先级排序）：

| 优先级 | 模块 | HOS 章节 |
|--------|------|----------|
| P0 | 数字孪生服务 | §1 |
| P0 | Agent Service (Vercel AI SDK) | §2 |
| P0 | Tool API 端点 | §10.5 |
| P1 | 社交能量网络 | §7 |
| P1 | JITAI 引擎 | §6 |
| P2 | 付费/货币系统 | §3 |
| P2 | 可插拔知识库 | §2.4 |

### 1.3 术语定义

| 术语 | 定义 |
|------|------|
| **HOS** | Highest-Order Spec，最高规范文档 |
| **Twin** | 精神数字孪生，用户的结构化状态表示 |
| **L1/L2/L3** | 孪生三层架构：元数据/动态状态/聚合指标 |
| **A2UI** | Agent-to-UI 协议，LLM 输出的结构化 JSON 格式 |
| **Aura** | 能量积分，通过行动获得的不可充值货币 |
| **Coins** | 灵币，可充值的虚拟货币 |
| **JITAI** | Just-In-Time Adaptive Interventions，即时自适应干预 |
| **KB** | Knowledge Base，知识库 |
| **Tool API** | Agent Service 调用 FastAPI 的内部接口 |

---

## 2. 用户故事

### 2.1 数字孪生相关

| US-ID | 用户故事 | 优先级 |
|-------|----------|--------|
| US-TWIN-01 | 作为用户，我希望在注册时自动创建数字孪生，这样我可以立即看到我的"角色面板" | P0 |
| US-TWIN-02 | 作为用户，我希望我的孪生能显示能量/清晰度/连接/成长/平衡五个维度分数，这样我能直观了解当前状态 | P0 |
| US-TWIN-03 | 作为用户，我希望完成打卡/承诺后孪生状态自动更新，这样我能看到成长的即时反馈 | P0 |
| US-TWIN-04 | 作为用户，我希望能查看孪生状态的历史变化趋势，这样我能追踪长期成长轨迹 | P1 |

### 2.2 智能体对话相关

| US-ID | 用户故事 | 优先级 |
|-------|----------|--------|
| US-AGENT-01 | 作为用户，我希望与 AI 教练对话时它能记住我的孪生状态，这样对话更个性化 | P0 |
| US-AGENT-02 | 作为用户，我希望 AI 能在对话中主动建议行动承诺，这样我能有具体可执行的下一步 | P0 |
| US-AGENT-03 | 作为用户，我希望能选择不同的专家视角（八字/星座/心理学），这样我能获得多元解读 | P1 |
| US-AGENT-04 | 作为用户，我希望对话输出有丰富的可视化组件（雷达图/时间线/卡片），这样体验更沉浸 | P0 |

### 2.3 社交相关

| US-ID | 用户故事 | 优先级 |
|-------|----------|--------|
| US-SOCIAL-01 | 作为用户，我希望能给好友发送能量打赏，这样我能表达支持和关心 | P1 |
| US-SOCIAL-02 | 作为用户，我希望能查看与好友的合盘分析，这样我能了解我们的关系动力学 | P1 |
| US-SOCIAL-03 | 作为用户，我希望能参与好运接龙活动，这样我能获得群体仪式感和奖励 | P1 |
| US-SOCIAL-04 | 作为用户，我希望能生成分享卡片导出到社交媒体，这样我能展示成就 | P1 |

### 2.4 付费相关

| US-ID | 用户故事 | 优先级 |
|-------|----------|--------|
| US-PAY-01 | 作为用户，我希望完成任务能获得 Aura 奖励，这样我有动力持续行动 | P2 |
| US-PAY-02 | 作为用户，我希望能用 Coins 解锁高级专家知识库，这样我能获得更深度的分析 | P2 |
| US-PAY-03 | 作为用户，我希望能订阅会员获得更多免费额度，这样我能更自由地使用服务 | P2 |

---

## 3. 功能需求（EARS 格式）

### 3.1 数字孪生服务 [P0]

#### REQ-TWIN-001: 孪生自动创建
- **HOS-REF**: §1.2, §10.5.4 (line 3900-3910)
- **EARS**: When a new user registers, the system shall automatically create a `fortune_digital_twin` record with default values for all layers.
- **验收标准**:
  - [ ] 新用户注册后 `fortune_digital_twin` 表存在对应记录
  - [ ] L1 `metadata_astrology` 包含从 `fortune_bazi_snapshot` 同步的八字数据
  - [ ] L3 `dimension_scores` 初始化为 `{"energy":50,"clarity":50,"connection":50,"growth":50,"balance":50}`
- **日志要求**: `TWIN_CREATED` | INFO | `{user_id, twin_id, initial_scores}`
- **验证要求**: 计算验证 - dimension_scores 各字段范围 [0, 100]

#### REQ-TWIN-002: 孪生数据查询
- **HOS-REF**: §1.2, §4.2.2 (line 2496-2518)
- **EARS**: When a user requests twin data, the system shall return the specified layers (L1/L2/L3/all) with the most recent values.
- **验收标准**:
  - [ ] GET `/api/twin?layer=L1` 返回仅 L1 元数据
  - [ ] GET `/api/twin?layer=all` 返回完整孪生数据
  - [ ] 响应包含 `last_updated` 时间戳
- **日志要求**: `TWIN_QUERY` | DEBUG | `{user_id, layer, response_size_bytes}`

#### REQ-TWIN-003: 孪生状态更新
- **HOS-REF**: §1.3, §10.5.2 (line 3617-3632)
- **EARS**: When a twin update event occurs (checkin/commitment/chat_insight/daily_refresh), the system shall update the specified layer and path, and log the change to `fortune_twin_update_log`.
- **验收标准**:
  - [ ] 更新后 `fortune_digital_twin.updated_at` 刷新
  - [ ] `fortune_twin_update_log` 记录包含 `trigger_type`, `layer`, `path`, `old_value`, `new_value`, `confidence`
  - [ ] 支持的 trigger_type: `daily_refresh`, `checkin_completed`, `commitment_done`, `chat_insight`, `social_event`, `external_sync`
- **日志要求**: `TWIN_UPDATE` | INFO | `{user_id, trigger, layer, path, confidence}`
- **验证要求**: 业务规则 - confidence 范围 [0, 1]

#### REQ-TWIN-004: 维度分数计算
- **HOS-REF**: §1.2 (line 192-203)
- **EARS**: When L2 dynamic state changes, the system shall recalculate L3 dimension_scores using the defined algorithm.
- **验收标准**:
  - [ ] `energy` 分数受 `dynamic_emotional.mood_intensity` 和 `dynamic_bio.sleep_score` 影响
  - [ ] `connection` 分数受 `dynamic_social.support_network_score` 影响
  - [ ] `growth` 分数受 `growth_streak` 和承诺完成率影响
  - [ ] 所有分数保持在 [0, 100] 范围
- **日志要求**: `DIMENSION_RECALC` | DEBUG | `{user_id, old_scores, new_scores, delta}`
- **验证要求**: 计算验证 - 分数边界检查，防止溢出

#### REQ-TWIN-005: 孪生历史查询
- **HOS-REF**: §4.1 (line 2211-2224)
- **EARS**: When a user requests twin history, the system shall return paginated update logs sorted by time descending.
- **验收标准**:
  - [ ] GET `/api/twin/history?limit=20&offset=0` 返回最近 20 条更新记录
  - [ ] 支持按 `trigger_type` 和 `layer` 过滤
  - [ ] 响应包含 `total_count` 用于分页
- **日志要求**: `TWIN_HISTORY_QUERY` | DEBUG | `{user_id, filters, result_count}`

---

### 3.2 Agent Service [P0]

#### REQ-AGENT-001: Agent 编排层
- **HOS-REF**: §2.1, §2.2 (line 233-266)
- **EARS**: The Agent Service shall implement an Orchestrator that routes user intents to appropriate agents (Coach/Analyst/Social/Expert).
- **验收标准**:
  - [ ] 支持意图识别：`chat`, `analysis`, `social`, `expert_consult`
  - [ ] 根据意图路由到对应 Agent
  - [ ] 支持多 Agent 协作（如 Analyst → Coach 串联）
- **日志要求**: `AGENT_ROUTE` | INFO | `{user_id, intent, agents_selected, routing_reason}`

#### REQ-AGENT-002: Coach Agent 实现
- **HOS-REF**: §2.2 (line 268-350)
- **EARS**: The Coach Agent shall provide conversational coaching with action suggestions, using user's twin context.
- **验收标准**:
  - [ ] 系统提示词包含用户孪生摘要（L1+L2+L3）
  - [ ] 支持 Tool Calling: `createCommitment`, `updateTwinState`
  - [ ] 输出格式为 A2UI JSON
  - [ ] 响应时间 < 10s (P95)
- **日志要求**: `COACH_RESPONSE` | INFO | `{user_id, session_id, tool_calls, latency_ms}`
- **验证要求**: 业务规则 - 输出必须通过 A2UI 格式校验

#### REQ-AGENT-003: Analyst Agent 实现
- **HOS-REF**: §2.2, §5.1 (line 125-127)
- **EARS**: The Analyst Agent shall analyze user state and extract structured insights for twin updates.
- **验收标准**:
  - [ ] 从对话中提取情绪状态变化
  - [ ] 输出结构化的 `TwinUpdateEvent` 数组
  - [ ] 每个更新包含 `confidence` 评分
- **日志要求**: `ANALYST_INSIGHT` | INFO | `{user_id, insights_count, avg_confidence}`

#### REQ-AGENT-004: Tool Calling 机制
- **HOS-REF**: §2.2, §10.5.3 (line 3662-3756)
- **EARS**: The Agent Service shall implement Tool Calling via Vercel AI SDK, invoking FastAPI Tool APIs for data mutations.
- **验收标准**:
  - [ ] 使用 `tool()` 函数定义 Tools
  - [ ] 支持的 Tools: `createCommitment`, `updateTwinState`, `getUserContext`, `createShareCard`
  - [ ] 所有写操作通过 Tool API 完成，不直接写数据库
  - [ ] Tool 调用失败时有重试机制（最多 3 次）
- **日志要求**: `TOOL_CALL` | INFO | `{tool_name, params_hash, success, retry_count, latency_ms}`

#### REQ-AGENT-005: 流式输出
- **HOS-REF**: §4.2.1 (line 2464-2492)
- **EARS**: The Agent Service shall support streaming response using Vercel AI SDK `streamText`.
- **验收标准**:
  - [ ] 使用 SSE (Server-Sent Events) 传输
  - [ ] 首字节延迟 < 500ms (P95)
  - [ ] 支持客户端中断
- **日志要求**: `STREAM_START` | DEBUG | `{user_id, session_id}`; `STREAM_END` | INFO | `{total_tokens, duration_ms}`

#### REQ-AGENT-006: Agent 运行审计
- **HOS-REF**: §4.1 (line 3849-3863)
- **EARS**: Every agent invocation shall be logged to `fortune_agent_run` for auditing and debugging.
- **验收标准**:
  - [ ] 记录 `agent_name`, `prompt_version`, `facts_hash`
  - [ ] 记录完整 `input` 和 `output` (JSONB)
  - [ ] 记录 `tool_calls`, `usage`, `latency_ms`
- **日志要求**: `AGENT_RUN_LOGGED` | DEBUG | `{run_id, agent_name}`

---

### 3.3 Tool API 端点 [P0]

#### REQ-TOOL-001: 服务令牌认证
- **HOS-REF**: §10.5.2 (line 3528-3533)
- **EARS**: All Tool API endpoints shall require `Authorization: Bearer {SERVICE_TOKEN}` header for authentication.
- **验收标准**:
  - [ ] 缺少 token 返回 401 Unauthorized
  - [ ] token 不匹配返回 401 Unauthorized
  - [ ] 使用 `hmac.compare_digest` 防止时序攻击
- **日志要求**: `TOOL_AUTH_FAIL` | WARN | `{endpoint, client_ip, reason}`

#### REQ-TOOL-002: 获取用户上下文
- **HOS-REF**: §10.5.2 (line 3574-3597)
- **EARS**: GET `/api/agent/tool/context` shall return user's twin data, recent messages, active commitments, and current plan.
- **验收标准**:
  - [ ] 请求参数: `user_id`, `layers[]`, `include_recent_messages`
  - [ ] 响应包含 `twin`, `recent_messages`, `active_commitments`, `current_plan`, `facts_hash`
  - [ ] `facts_hash` 为八字数据的 SHA256 前 16 位
- **日志要求**: `TOOL_CONTEXT` | DEBUG | `{user_id, layers, response_time_ms}`

#### REQ-TOOL-003: 创建承诺
- **HOS-REF**: §10.5.2 (line 3599-3615)
- **EARS**: POST `/api/agent/tool/commitment` shall create a new commitment record with agent as source.
- **验收标准**:
  - [ ] 请求参数: `user_id`, `title`, `description`, `category`, `duration_minutes`, `aura_reward`
  - [ ] 响应包含 `commitment_id`, `status: "created"`
  - [ ] `source` 字段固定为 `"agent"`
- **日志要求**: `TOOL_COMMITMENT_CREATE` | INFO | `{user_id, commitment_id, category}`

#### REQ-TOOL-004: 更新孪生状态
- **HOS-REF**: §10.5.2 (line 3617-3632)
- **EARS**: POST `/api/agent/tool/twin_update` shall update twin state and create update log.
- **验收标准**:
  - [ ] 请求参数: `user_id`, `layer`, `path`, `new_value`, `confidence`, `source`, `trigger`
  - [ ] 响应包含 `updated: true`, `log_id`
  - [ ] 支持嵌套路径更新（如 `dynamic_emotional.current_mood`）
- **日志要求**: `TOOL_TWIN_UPDATE` | INFO | `{user_id, layer, path, log_id}`

#### REQ-TOOL-005: 创建分享卡
- **HOS-REF**: §10.5.2 (line 3634-3645)
- **EARS**: POST `/api/agent/tool/share_card` shall create a share card record with rendered payload.
- **验收标准**:
  - [ ] 请求参数: `user_id`, `card_type`, `payload`
  - [ ] 支持的 card_type: `cosmic_roast`, `bento_grid`, `streak`, `compatibility`
  - [ ] 响应包含 `card_id`, `share_url`
- **日志要求**: `TOOL_SHARE_CARD` | INFO | `{user_id, card_type, card_id}`

#### REQ-TOOL-006: 获取八字事实
- **HOS-REF**: §10.5.2 (line 3647-3657)
- **EARS**: GET `/api/agent/tool/facts/{user_id}` shall return user's bazi snapshot with facts_hash.
- **验收标准**:
  - [ ] 响应包含 `bazi` 对象和 `facts_hash`
  - [ ] 无八字数据时 `bazi` 为 `null`
- **日志要求**: `TOOL_FACTS` | DEBUG | `{user_id, has_bazi}`

---

### 3.4 社交能量网络 [P1]

#### REQ-SOCIAL-001: 好友关系管理
- **HOS-REF**: §4.1 (line 2230-2243)
- **EARS**: The system shall support friend relationships with status (pending/accepted/blocked).
- **验收标准**:
  - [ ] POST `/api/social/friends/request` 发送好友请求
  - [ ] POST `/api/social/friends/accept` 接受好友请求
  - [ ] GET `/api/social/friends` 获取好友列表
  - [ ] 双向关系自动创建（A→B 接受后同时创建 B→A）
- **日志要求**: `FRIEND_REQUEST` | INFO | `{from_user, to_user, action}`

#### REQ-SOCIAL-002: 能量打赏
- **HOS-REF**: §7.2 (line 2884-2932)
- **EARS**: When a user sends energy buff to a friend, the system shall transfer coins, record buff, update receiver's twin, and send notification.
- **验收标准**:
  - [ ] POST `/api/social/buff` 发送能量打赏
  - [ ] 验证好友关系存在
  - [ ] 扣除发送者 coins，增加接收者 coins
  - [ ] 记录到 `fortune_energy_buff` 表
  - [ ] 更新接收者孪生 `energy` 维度
  - [ ] 发送推送通知
- **日志要求**: `ENERGY_BUFF` | INFO | `{from_user, to_user, buff_type, amount}`
- **验证要求**: 业务规则 - 发送者余额 >= amount

#### REQ-SOCIAL-003: 合盘分析
- **HOS-REF**: §4.2.3 (line 2524-2553)
- **EARS**: The system shall generate compatibility analysis between two friends using Social Agent.
- **验收标准**:
  - [ ] POST `/api/social/compatibility` 请求合盘分析
  - [ ] 仅好友关系（status=accepted）可请求
  - [ ] 结果缓存到 `fortune_social_edge.compatibility_data`
  - [ ] 响应包含 `compatibility_score` (0-100) 和详细分析
- **日志要求**: `COMPATIBILITY_ANALYSIS` | INFO | `{user_id, peer_id, score, cached}`

#### REQ-SOCIAL-004: 好运接龙
- **HOS-REF**: §7.2 (line 2934-2974)
- **EARS**: The system shall support luck chain ritual with increasing rewards based on participant count.
- **验收标准**:
  - [ ] POST `/api/social/chain/create` 创建接龙
  - [ ] POST `/api/social/chain/join` 参与接龙
  - [ ] 奖励公式: `reward = base_reward * log2(participant_count + 2)`
  - [ ] 所有参与者在新成员加入时获得奖励
- **日志要求**: `CHAIN_JOIN` | INFO | `{chain_id, user_id, position, reward}`
- **验证要求**: 计算验证 - 奖励公式正确性

#### REQ-SOCIAL-005: 分享卡生成
- **HOS-REF**: §7.1 (line 2834-2879)
- **EARS**: The system shall generate shareable card data for client-side image export.
- **验收标准**:
  - [ ] POST `/api/social/share` 生成分享卡数据
  - [ ] 支持类型: `cosmic_roast`, `bento_grid`, `manifestation_diary`, `compatibility`, `streak`
  - [ ] 响应包含 `template_id`, `content`, `share_url`, `qr_data`
  - [ ] 前端使用 `html-to-image` 导出图片
- **日志要求**: `SHARE_CARD_GEN` | INFO | `{user_id, card_type, card_id}`

---

### 3.5 JITAI 引擎 [P1]

#### REQ-JITAI-001: 触发器定义
- **HOS-REF**: §6.1 (line 2667-2754)
- **EARS**: The system shall support configurable JITAI triggers with conditions, interventions, cooldowns, and priorities.
- **验收标准**:
  - [ ] 支持条件类型: `time`, `state`, `behavior`, `context`
  - [ ] 支持操作符: `eq`, `gt`, `lt`, `in`, `not_in`
  - [ ] 每个触发器有 `cooldown_hours` 和 `priority`
- **日志要求**: `JITAI_TRIGGER_MATCH` | DEBUG | `{user_id, trigger_id, conditions_met}`

#### REQ-JITAI-002: 干预类型
- **HOS-REF**: §6.1 (line 2683-2688)
- **EARS**: The system shall support multiple intervention types for JITAI.
- **验收标准**:
  - [ ] 支持: `push_notification`, `in_app_card`, `chat_proactive`, `email`
  - [ ] 每种类型有对应的模板和 CTA
  - [ ] `chat_proactive` 支持 `content_generator` 指定 Agent
- **日志要求**: `JITAI_INTERVENTION` | INFO | `{user_id, trigger_id, intervention_type}`

#### REQ-JITAI-003: 定时评估
- **HOS-REF**: §6.2 (line 2790-2826)
- **EARS**: The system shall evaluate JITAI triggers for active users every 15 minutes via Cron.
- **验收标准**:
  - [ ] Cron 端点: GET `/api/cron/jitai`
  - [ ] 需要 `CRON_SECRET` 认证
  - [ ] 仅评估最近 7 天活跃用户
  - [ ] 每个用户执行最高优先级的一个干预
  - [ ] 记录冷却状态防止重复触发
- **日志要求**: `JITAI_CRON` | INFO | `{evaluated_count, intervened_count, duration_ms}`

#### REQ-JITAI-004: 预置触发器
- **HOS-REF**: §6.1 (line 2691-2754)
- **EARS**: The system shall include predefined JITAI triggers for common scenarios.
- **验收标准**:
  - [ ] `morning_checkin`: 7-9 点未打卡时提醒
  - [ ] `low_energy_intervention`: 能量 < 30 且情绪强度 > 6 时推送鼓励
  - [ ] `retrograde_warning`: 水逆开始时发送指南
  - [ ] `streak_celebration`: 连续 7/21/30/100 天时庆祝
- **日志要求**: `JITAI_PRESET_TRIGGERED` | INFO | `{trigger_id, user_count}`

---

### 3.6 付费/货币系统 [P2]

#### REQ-PAY-001: 双货币体系
- **HOS-REF**: §3 (line 1215+)
- **EARS**: The system shall implement dual currency: Coins (purchasable) and Aura (action-earned only).
- **验收标准**:
  - [ ] `fortune_user_balance` 表存储 `coins` 和 `aura` 余额
  - [ ] Coins 可充值、可转让
  - [ ] Aura 仅通过行动获得，不可充值
- **日志要求**: `CURRENCY_INIT` | INFO | `{user_id, initial_coins, initial_aura}`

#### REQ-PAY-002: 货币账本
- **HOS-REF**: §4.1 (line 2263-2294)
- **EARS**: All currency transactions shall be logged to `fortune_currency_ledger` with full audit trail.
- **验收标准**:
  - [ ] 记录 `amount`, `balance_after`, `category`, `reason`, `ref_type`, `ref_id`
  - [ ] category 枚举: `earn`, `spend`, `transfer_in`, `transfer_out`
  - [ ] 支持事务回滚
- **日志要求**: `CURRENCY_TRANSACTION` | INFO | `{user_id, amount, category, reason, balance_after}`

#### REQ-PAY-003: 赚取规则
- **HOS-REF**: §3 (Earn Rules)
- **EARS**: The system shall award currency based on predefined earn rules with multipliers.
- **验收标准**:
  - [ ] 每日打卡: +10 Aura
  - [ ] 完成承诺: +5-50 Aura (根据 aura_reward)
  - [ ] 连续打卡 7 天: +50 Aura bonus
  - [ ] 邀请好友: +100 Coins
- **日志要求**: `CURRENCY_EARN` | INFO | `{user_id, rule_id, amount, currency_type}`

#### REQ-PAY-004: 消费定价
- **HOS-REF**: §3 (Consumption Pricing)
- **EARS**: The system shall define consumption prices for features.
- **验收标准**:
  - [ ] 解锁专家知识库: 100-500 Coins
  - [ ] 深度合盘分析: 50 Coins
  - [ ] 详细报告生成: 30 Coins
  - [ ] 基础对话: 免费（每日限额）
- **日志要求**: `FEATURE_CONSUME` | INFO | `{user_id, feature, cost, currency_type}`
- **验证要求**: 业务规则 - 余额检查在扣费前完成

#### REQ-PAY-005: 余额查询
- **HOS-REF**: §4 (API Routes)
- **EARS**: GET `/api/currency/balance` shall return user's current balance.
- **验收标准**:
  - [ ] 响应包含 `coins`, `aura`, `total_earned`, `total_spent`
  - [ ] 使用物化视图或缓存优化性能
- **日志要求**: `BALANCE_QUERY` | DEBUG | `{user_id}`

---

### 3.7 可插拔知识库 [P2]

#### REQ-KB-001: 知识库注册表
- **HOS-REF**: §2.4 (line 600+)
- **EARS**: The system shall maintain a registry of available knowledge bases with metadata.
- **验收标准**:
  - [ ] 每个 KB 包含: `kb_id`, `name`, `domain`, `access_level`, `price_coins`
  - [ ] access_level 枚举: `free`, `basic`, `premium`, `enterprise`
  - [ ] 支持 KB 启用/禁用
- **日志要求**: `KB_REGISTERED` | INFO | `{kb_id, domain, access_level}`

#### REQ-KB-002: 用户 KB 配置
- **HOS-REF**: §2.4.2 (line 700-744)
- **EARS**: Users shall be able to configure which KBs are enabled for each agent.
- **验收标准**:
  - [ ] `fortune_user_agent_kb` 表存储用户配置
  - [ ] 支持自定义权重（influence）
  - [ ] 默认启用所有已解锁的 KB
- **日志要求**: `KB_CONFIG_UPDATE` | INFO | `{user_id, agent_id, kb_ids}`

#### REQ-KB-003: 混合检索
- **HOS-REF**: §2.4.3 (line 749-862)
- **EARS**: The system shall support hybrid retrieval (FTS + Vector) from multiple KBs.
- **验收标准**:
  - [ ] 支持检索类型: `fts`, `vector`, `hybrid`
  - [ ] 使用 RRF (Reciprocal Rank Fusion) 融合多 KB 结果
  - [ ] 支持 rerank 重排序
  - [ ] 每个 chunk 标记来源 KB
- **日志要求**: `KB_RETRIEVAL` | DEBUG | `{query_hash, kb_count, chunk_count, latency_ms}`

#### REQ-KB-004: 预置知识库
- **HOS-REF**: §2.4.4 (line 867-950)
- **EARS**: The system shall include predefined knowledge bases for core domains.
- **验收标准**:
  - [ ] 免费 KB: `psychology-basics`, `bazi-basics`
  - [ ] Basic KB: `bazi-advanced`, `zodiac-basics`
  - [ ] Premium KB: `ziwei-complete`, `psychology-cbt`
  - [ ] 每个 KB 指定 `compatible_agents`
- **日志要求**: `KB_PRESET_LOADED` | INFO | `{kb_count, total_chunks}`

#### REQ-KB-005: KB 解锁
- **HOS-REF**: §3 (Product Catalog)
- **EARS**: Users shall be able to unlock premium KBs using Coins.
- **验收标准**:
  - [ ] POST `/api/kb/unlock` 解锁知识库
  - [ ] 验证用户 Coins 余额
  - [ ] 记录到 `fortune_user_kb_unlock` 表
  - [ ] 扣除 Coins 并记录账本
- **日志要求**: `KB_UNLOCK` | INFO | `{user_id, kb_id, cost}`

---

## 4. 非功能性需求

### 4.1 性能需求

| NFR-ID | 需求 | 指标 | HOS-REF |
|--------|------|------|---------|
| NFR-PERF-001 | 对话响应延迟 | 首字节 < 500ms (P95) | §2 |
| NFR-PERF-002 | Tool API 响应 | < 200ms (P95) | §10.5 |
| NFR-PERF-003 | 孪生查询 | < 100ms (P95) | §1 |
| NFR-PERF-004 | 数据库连接池 | 最大 20 连接 | §9 |
| NFR-PERF-005 | 并发用户 | 支持 1000 DAU | §11 |

### 4.2 可靠性需求

| NFR-ID | 需求 | 指标 | HOS-REF |
|--------|------|------|---------|
| NFR-REL-001 | 服务可用性 | > 99.5% | §11 |
| NFR-REL-002 | 数据持久性 | 0 数据丢失 | §4 |
| NFR-REL-003 | LLM 故障恢复 | 多 Provider 自动切换 | §2.2 |
| NFR-REL-004 | 事务完整性 | ACID 保证 | §4 |

### 4.3 安全需求

| NFR-ID | 需求 | 指标 | HOS-REF |
|--------|------|------|---------|
| NFR-SEC-001 | 认证 | JWT + CSRF 双重验证 | §8 |
| NFR-SEC-002 | Tool API 认证 | SERVICE_TOKEN + HMAC | §10.5 |
| NFR-SEC-003 | 密码存储 | bcrypt 哈希 | 现有代码 |
| NFR-SEC-004 | 敏感数据 | PII 在日志中脱敏 | §9 |
| NFR-SEC-005 | SQL 注入防护 | 参数化查询 | §4 |

### 4.4 合规需求

| NFR-ID | 需求 | 指标 | HOS-REF |
|--------|------|------|---------|
| NFR-COMP-001 | 危机干预 | 自伤关键词触发安全协议 | §8.1 |
| NFR-COMP-002 | 禁止宿命论 | 输出过滤绝对预测 | §8.1 |
| NFR-COMP-003 | 数据导出 | 支持 GDPR/PIPL 导出 | §8.3 |
| NFR-COMP-004 | 数据删除 | 支持完整删除 | §8.3 |
| NFR-COMP-005 | 反依赖 | 高频使用提醒 | §8.2 |

### 4.5 可观测性需求

| NFR-ID | 需求 | 指标 | HOS-REF |
|--------|------|------|---------|
| NFR-OBS-001 | 结构化日志 | JSON 格式，含 correlation_id | §9 |
| NFR-OBS-002 | LLM 用量追踪 | 记录 tokens 和成本 | §9.3 |
| NFR-OBS-003 | Agent 审计 | 完整 input/output 记录 | §4.1 |
| NFR-OBS-004 | 错误追踪 | 堆栈和上下文 | §9 |

---

## 5. 约束条件

### 5.1 技术约束

| 约束 | 描述 | 来源 |
|------|------|------|
| TC-001 | 后端框架 | FastAPI（复用现有代码） | 项目现状 |
| TC-002 | Agent 框架 | Vercel AI SDK (TypeScript) | HOS §2 |
| TC-003 | 数据库 | PostgreSQL + pgvector | HOS §4 |
| TC-004 | LLM Provider | GLM-4 / Claude / OpenAI | HOS §0.3 |
| TC-005 | 前端 | Jinja2 + 原生 JS（复用现有） | 项目现状 |

### 5.2 业务约束

| 约束 | 描述 | 来源 |
|------|------|------|
| BC-001 | MVP 不做复杂社交 | 仅好友+打赏+接龙 | HOS §3.2 |
| BC-002 | 暂不支持现金交易 | 仅虚拟货币 | HOS §3.2 |
| BC-003 | 不做 AIGC 图像 | 仅文本+模板 | HOS §3.2 |

---

## 6. 开放问题

| 问题 ID | 描述 | 状态 | 负责人 |
|---------|------|------|--------|
| OI-001 | Agent Service 与 FastAPI 部署在同一容器还是分离？ | Open | Architect |
| OI-002 | pgvector 索引类型选择 (IVFFlat vs HNSW)？ | Open | DBA |
| OI-003 | 会员等级功能是否在 MVP 实现？ | Open | PM |

---

## 7. 追溯矩阵

### 7.1 需求到 HOS 映射

| REQ-ID | HOS 章节 | HOS 行号 | 验证方法 |
|--------|----------|----------|----------|
| REQ-TWIN-001 | §1.2, §10.5.4 | 3900-3910 | 集成测试 |
| REQ-TWIN-002 | §1.2, §4.2.2 | 2496-2518 | API 测试 |
| REQ-TWIN-003 | §1.3, §10.5.2 | 3617-3632 | 单元测试 |
| REQ-TWIN-004 | §1.2 | 192-203 | 计算验证 |
| REQ-TWIN-005 | §4.1 | 2211-2224 | API 测试 |
| REQ-AGENT-001 | §2.1, §2.2 | 233-266 | 集成测试 |
| REQ-AGENT-002 | §2.2 | 268-350 | E2E 测试 |
| REQ-AGENT-003 | §2.2, §5.1 | 125-127 | 单元测试 |
| REQ-AGENT-004 | §2.2, §10.5.3 | 3662-3756 | 集成测试 |
| REQ-AGENT-005 | §4.2.1 | 2464-2492 | 性能测试 |
| REQ-AGENT-006 | §4.1 | 3849-3863 | 日志验证 |
| REQ-TOOL-001 | §10.5.2 | 3528-3533 | 安全测试 |
| REQ-TOOL-002 | §10.5.2 | 3574-3597 | API 测试 |
| REQ-TOOL-003 | §10.5.2 | 3599-3615 | API 测试 |
| REQ-TOOL-004 | §10.5.2 | 3617-3632 | API 测试 |
| REQ-TOOL-005 | §10.5.2 | 3634-3645 | API 测试 |
| REQ-TOOL-006 | §10.5.2 | 3647-3657 | API 测试 |
| REQ-SOCIAL-001 | §4.1 | 2230-2243 | API 测试 |
| REQ-SOCIAL-002 | §7.2 | 2884-2932 | 集成测试 |
| REQ-SOCIAL-003 | §4.2.3 | 2524-2553 | E2E 测试 |
| REQ-SOCIAL-004 | §7.2 | 2934-2974 | 计算验证 |
| REQ-SOCIAL-005 | §7.1 | 2834-2879 | API 测试 |
| REQ-JITAI-001 | §6.1 | 2667-2754 | 单元测试 |
| REQ-JITAI-002 | §6.1 | 2683-2688 | 单元测试 |
| REQ-JITAI-003 | §6.2 | 2790-2826 | 集成测试 |
| REQ-JITAI-004 | §6.1 | 2691-2754 | E2E 测试 |
| REQ-PAY-001 | §3 | 1215+ | 单元测试 |
| REQ-PAY-002 | §4.1 | 2263-2294 | 单元测试 |
| REQ-PAY-003 | §3 | - | 集成测试 |
| REQ-PAY-004 | §3 | - | 集成测试 |
| REQ-PAY-005 | §4 | - | API 测试 |
| REQ-KB-001 | §2.4 | 600+ | 单元测试 |
| REQ-KB-002 | §2.4.2 | 700-744 | API 测试 |
| REQ-KB-003 | §2.4.3 | 749-862 | 集成测试 |
| REQ-KB-004 | §2.4.4 | 867-950 | 数据验证 |
| REQ-KB-005 | §3 | - | 集成测试 |

---

## 8. 审批记录

| 版本 | 日期 | 审批人 | 状态 | 备注 |
|------|------|--------|------|------|
| v1.0 | 2025-12-30 | - | Draft | 初始版本 |

---

**文档结束**
