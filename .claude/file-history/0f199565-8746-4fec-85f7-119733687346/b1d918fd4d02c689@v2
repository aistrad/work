# Fortune AI ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼ˆClaude MVP v1.0ï¼‰

**æ–‡æ¡£ç±»å‹**ï¼šSystem Design
**äº§å“ä»£å·**ï¼š`Fortune AI - ç²¾ç¥æ•°å­—å­ªç”Ÿä¸äººç”Ÿæ™ºèƒ½OS`
**ç‰ˆæœ¬**ï¼š`MVP v1.0`
**æ—¥æœŸ**ï¼š2025-12-30
**è¾“å…¥ä¾æ®**ï¼š`bp v1.md`ï¼ˆå•†ä¸šè®¡åˆ’ä¹¦ï¼‰ã€`system_design_codex_v5.md`ï¼ˆæŠ€æœ¯å‚è€ƒï¼‰
**æ™ºèƒ½ä½“æ¡†æ¶**ï¼šVercel AI SDK

---

## 0. æ‰§è¡Œæ‘˜è¦

### 0.1 äº§å“å®šä½ï¼ˆæ¥è‡ª bp v1.mdï¼‰

> **ç”¨AIæ™ºèƒ½ä½“é‡æ„"å¿ƒç†æˆé•¿"ï¼›æ™ºèƒ½ä½“æ˜¯ä½ çš„"ç²¾ç¥æ“ä½œç³»ç»Ÿ"ï¼Œç²¾ç¥æ•°å­—å­ªç”Ÿæ˜¯ä½ çš„"è§’è‰²é¢æ¿"**

### 0.2 æ¶æ„ç›®æ ‡

æœ¬è®¾è®¡æ—¨åœ¨å®ç°å•†ä¸šè®¡åˆ’ä¹¦ä¸­çš„ä¸‰å¤§æ ¸å¿ƒæ”¯æŸ±ï¼š

| æ”¯æŸ± | æè¿° | æŠ€æœ¯æ˜ å°„ |
|------|------|----------|
| **å®ä½“æ•°å­—åŒ–** | æŠŠå¿ƒç†çŠ¶æ€å˜æˆç»“æ„åŒ–æ•°å­—å­ªç”Ÿ Avatar | Multi-Layer Twin Model + PostgreSQL SSOT |
| **æ·±å±‚æ¬¡å¿ƒç†åŠ¨æœº** | æŠŠç—›è‹¦çš„"æˆé•¿"å˜æˆçˆ½æ„Ÿçš„"ç»ƒçº§" | Gamification Engine + Social Graph |
| **ä¸»åŠ¨åŒ–æ¨ç†** | åŸºäºæ•°æ®çš„æ™ºèƒ½ä½“ä¸»åŠ¨é¢„åˆ¤ä¸å¹²é¢„ | Vercel AI SDK Multi-Agent + JITAI |

### 0.3 æŠ€æœ¯é€‰å‹å†³ç­–

| å±‚é¢ | é€‰å‹ | ç†ç”± |
|------|------|------|
| **æ™ºèƒ½ä½“æ¡†æ¶** | Vercel AI SDK | åŸç”Ÿ TypeScript/Edge æ”¯æŒã€æµå¼è¾“å‡ºã€Tool Callingã€Multi-Agent ç¼–æ’ |
| **åç«¯è¿è¡Œæ—¶** | Next.js 14+ (App Router) | ä¸ Vercel AI SDK æ·±åº¦é›†æˆã€API Routesã€Server Actions |
| **æ•°æ®åº“** | PostgreSQL + pgvector | ç°æœ‰åŸºç¡€è®¾æ–½å¤ç”¨ã€SSOTã€è¯­ä¹‰æ£€ç´¢ |
| **LLM Provider** | Multi-Provider (GLM-4/Claude/OpenAI) | Vercel AI SDK ç»Ÿä¸€æ¥å£ã€Provider çƒ­åˆ‡æ¢ |
| **éƒ¨ç½²** | Vercel Edge + Serverless | å…¨çƒè¾¹ç¼˜ã€è‡ªåŠ¨æ‰©ç¼©ã€é›¶è¿ç»´ |

---

## 1. ç²¾ç¥æ•°å­—å­ªç”Ÿæ¨¡å‹ï¼ˆSpiritual Digital Twinï¼‰

> **æ ¸å¿ƒèµ„äº§**ï¼šä¸€ä¸ªéšçŠ¶æ€å®æ—¶å˜åŒ–çš„ç»“æ„åŒ–"è§’è‰²é¢æ¿"

### 1.1 ä¸‰å±‚å­ªç”Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    L3 - å¯è§†åŒ–å±•ç¤ºå±‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  æ•°æ®çœ‹æ¿    â”‚  â”‚  èƒ½é‡é›·è¾¾å›¾  â”‚  â”‚  æ—¶é—´åºåˆ—    â”‚           â”‚
â”‚  â”‚  Dashboard   â”‚  â”‚  Aura Radar  â”‚  â”‚  Timeline    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    L2 - åŠ¨æ€çŠ¶æ€å±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ç„å­¦åˆ†æ    â”‚  â”‚  ç”Ÿç‰©æ•°æ®    â”‚  â”‚  ç¤¾äº¤çŠ¶æ€    â”‚           â”‚
â”‚  â”‚  æ°´é€†/æµå¹´   â”‚  â”‚  ç¡çœ /æ­¥æ•°   â”‚  â”‚  å…³ç³»å›¾è°±    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â†‘               â†‘               â†‘                     â”‚
â”‚       æ™ºèƒ½ä½“äº¤äº’       å¤–éƒ¨API        ç¤¾äº¤ç³»ç»Ÿ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    L1 - å…ƒæ•°æ®å±‚ï¼ˆå‡ºå‚è®¾ç½®ï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  ç„å­¦å…ƒæ•°æ®  â”‚  â”‚  å¿ƒç†å­¦å…ƒæ•°æ® â”‚  â”‚  å†å²è®°å¿†    â”‚           â”‚
â”‚  â”‚  å…«å­—/æ˜Ÿç›˜   â”‚  â”‚  PERMA/VIA   â”‚  â”‚  å¯¹è¯æ‘˜è¦    â”‚           â”‚
â”‚  â”‚  MBTI/ç´«è–‡   â”‚  â”‚  ä¾é™„ç±»å‹    â”‚  â”‚  å…³é”®äº‹ä»¶    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®æ¨¡å‹å®šä¹‰

```typescript
// types/twin.ts
interface SpiritualDigitalTwin {
  // L1 - å…ƒæ•°æ®å±‚ï¼ˆç›¸å¯¹ç¨³å®šï¼‰
  metadata: {
    astrology: {
      bazi: BaziSnapshot;           // å…«å­—å››æŸ±
      zodiac: ZodiacProfile;        // æ˜Ÿåº§æ˜Ÿç›˜
      ziwei: ZiweiChart | null;     // ç´«è–‡æ–—æ•°ï¼ˆå¯é€‰ï¼‰
    };
    psychology: {
      mbti: MBTIProfile | null;
      perma: PERMAScores;           // ç§¯æå¿ƒç†å­¦äº”ç»´åº¦
      via_strengths: string[];      // å“æ ¼ä¼˜åŠ¿
      attachment_style: AttachmentType;
    };
    memory: {
      key_events: KeyEvent[];       // å…³é”®äººç”Ÿäº‹ä»¶
      conversation_summary: string; // å¯¹è¯æ‘˜è¦ï¼ˆå®šæœŸæ›´æ–°ï¼‰
      last_updated: Date;
    };
  };

  // L2 - åŠ¨æ€çŠ¶æ€å±‚ï¼ˆå®æ—¶å˜åŒ–ï¼‰
  dynamic_state: {
    astro_context: {
      current_transit: TransitInfo;   // å½“å‰è¡Œæ˜Ÿè¿‡å¢ƒ
      retrograde_status: RetrogradeStatus[]; // é€†è¡ŒçŠ¶æ€
      daily_theme: string;
    };
    bio_state: {
      sleep_score: number | null;     // 0-100
      activity_level: number | null;
      stress_indicator: number | null;
    };
    social_state: {
      active_relationships: number;
      recent_interactions: number;
      support_network_score: number;
    };
    emotional_state: {
      current_mood: MoodType;
      mood_intensity: number;         // 0-10
      last_checkin: Date;
    };
  };

  // L3 - èšåˆæŒ‡æ ‡å±‚ï¼ˆå±•ç¤ºç”¨ï¼‰
  aggregated_metrics: {
    aura_points: number;              // èƒ½é‡ç§¯åˆ†
    overall_wellbeing: number;        // ç»¼åˆå¹¸ç¦æŒ‡æ•° 0-100
    growth_streak: number;            // è¿ç»­æˆé•¿å¤©æ•°
    dimension_scores: {
      energy: number;                 // èƒ½é‡ç»´åº¦
      clarity: number;                // æ¸…æ™°åº¦ç»´åº¦
      connection: number;             // è¿æ¥ç»´åº¦
      growth: number;                 // æˆé•¿ç»´åº¦
      balance: number;                // å¹³è¡¡ç»´åº¦
    };
  };
}
```

### 1.3 å­ªç”Ÿæ›´æ–°æœºåˆ¶

```typescript
// services/twin-updater.ts
type TwinUpdateTrigger =
  | 'daily_refresh'      // æ¯æ—¥è‡ªåŠ¨åˆ·æ–°
  | 'checkin_completed'  // æƒ…ç»ªæ‰“å¡å
  | 'commitment_done'    // å®Œæˆæ‰¿è¯ºå
  | 'chat_insight'       // å¯¹è¯ä¸­æå–æ´å¯Ÿ
  | 'social_event'       // ç¤¾äº¤äº‹ä»¶å‘ç”Ÿ
  | 'external_sync';     // å¤–éƒ¨æ•°æ®åŒæ­¥

interface TwinUpdateEvent {
  trigger: TwinUpdateTrigger;
  layer: 'L1' | 'L2' | 'L3';
  path: string;           // e.g., 'dynamic_state.emotional_state.current_mood'
  old_value: any;
  new_value: any;
  confidence: number;     // 0-1
  source: string;         // æ¥æºè¿½æº¯
  timestamp: Date;
}
```

---

## 2. AI æ™ºèƒ½ä½“ç³»ç»Ÿæ¶æ„ï¼ˆåŸºäº Vercel AI SDKï¼‰

### 2.1 å¤šæ™ºèƒ½ä½“æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Soul OS - çµé­‚æ“ä½œç³»ç»Ÿ                           â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Orchestrator Agentï¼ˆç¼–æ’å±‚ï¼‰                   â”‚    â”‚
â”‚  â”‚   â€¢ æ„å›¾è¯†åˆ«ä¸è·¯ç”±                                                â”‚    â”‚
â”‚  â”‚   â€¢ ä¸Šä¸‹æ–‡èšåˆ                                                    â”‚    â”‚
â”‚  â”‚   â€¢ å¤š Agent åè°ƒ                                                 â”‚    â”‚
â”‚  â”‚   â€¢ A2UI è¾“å‡ºç»„è£…                                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚          â”‚              â”‚               â”‚              â”‚                 â”‚
â”‚          â–¼              â–¼               â–¼              â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  Coach   â”‚   â”‚ Analyst  â”‚   â”‚  Social  â”‚   â”‚  Expert  â”‚             â”‚
â”‚  â”‚  Agent   â”‚   â”‚  Agent   â”‚   â”‚  Agent   â”‚   â”‚  Agents  â”‚             â”‚
â”‚  â”‚          â”‚   â”‚          â”‚   â”‚          â”‚   â”‚          â”‚             â”‚
â”‚  â”‚ å¯¹è¯é™ªä¼´ â”‚   â”‚ æ•°æ®åˆ†æ â”‚   â”‚ ç¤¾äº¤åŒ¹é… â”‚   â”‚ ä¸“å®¶çŸ¥è¯† â”‚             â”‚
â”‚  â”‚ è¡ŒåŠ¨è®¡åˆ’ â”‚   â”‚ å­ªç”Ÿæ›´æ–° â”‚   â”‚ ç¾¤ä½“æœºåˆ¶ â”‚   â”‚ å¯æ’æ‹”   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                    â”‚                     â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                                    â”‚               â”‚               â”‚    â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”‚
â”‚                               â”‚  å…«å­—   â”‚   â”‚  ç´«è–‡   â”‚   â”‚  æ˜Ÿåº§   â”‚  â”‚
â”‚                               â”‚ Expert  â”‚   â”‚ Expert  â”‚   â”‚ Expert  â”‚  â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Vercel AI SDK å®ç°æ¶æ„

```typescript
// lib/ai/agents/index.ts
import { experimental_createModelRegistry as createModelRegistry } from 'ai';
import { openai } from '@ai-sdk/openai';
import { anthropic } from '@ai-sdk/anthropic';

// æ¨¡å‹æ³¨å†Œï¼ˆå¤š Provider æ”¯æŒï¼‰
export const modelRegistry = createModelRegistry({
  openai,
  anthropic,
  // è‡ªå®šä¹‰ GLM Provider
  glm: createGLMProvider({
    baseURL: process.env.GLM_BASE_URL,
    apiKey: process.env.GLM_API_KEY,
  }),
});

// Agent åŸºç¡€é…ç½®
interface AgentConfig {
  id: string;
  name: string;
  model: string;                    // e.g., 'openai:gpt-4-turbo'
  systemPrompt: string;
  tools: Tool[];
  maxTokens?: number;
  temperature?: number;
}
```

### 2.3 æ ¸å¿ƒ Agent å®šä¹‰

#### 2.3.1 Coach Agentï¼ˆæ•™ç»ƒæ™ºèƒ½ä½“ï¼‰

```typescript
// lib/ai/agents/coach-agent.ts
import { generateText, streamText, tool } from 'ai';
import { z } from 'zod';

export const coachAgent: AgentConfig = {
  id: 'coach',
  name: 'Fortune Coach',
  model: 'glm:glm-4',
  systemPrompt: `ä½ æ˜¯ Fortune AI çš„æ ¸å¿ƒæ•™ç»ƒæ™ºèƒ½ä½“ï¼Œè§’è‰²å®šä½ï¼š

ã€èº«ä»½ã€‘
- ç§¯æå¿ƒç†å­¦æ•™ç»ƒï¼ˆPerformance Coachï¼‰
- æ¸©æš–è€Œä¸è®¨å¥½ï¼Œç›´æ¥è€Œä¸å†’çŠ¯
- æ°¸è¿œç«™åœ¨ç”¨æˆ·çš„æˆé•¿è§’åº¦

ã€æ ¸å¿ƒèŒè´£ã€‘
1. æƒ…ç»ªæ‰¿æ¥ï¼šå…ˆå…±æƒ…ï¼Œå†åˆ†æ
2. æ´å¯Ÿæä¾›ï¼šåŸºäºå­ªç”Ÿæ•°æ®ç»™å‡ºä¸ªæ€§åŒ–è§£è¯»
3. è¡ŒåŠ¨æ¨åŠ¨ï¼šæ¯æ¬¡å¯¹è¯å¿…é¡»äº§å‡ºå¯æ‰§è¡Œçš„æœ€å°è¡ŒåŠ¨
4. æ‰¿è¯ºé‚€è¯·ï¼šå¼•å¯¼ç”¨æˆ·åšå‡ºæ‰¿è¯ºï¼ˆcommitmentï¼‰

ã€è¾“å‡ºè§„èŒƒã€‘
- å¿…é¡»ä½¿ç”¨ A2UI JSON æ ¼å¼
- æ¯æ¬¡è¾“å‡ºåŒ…å«ï¼šç»“è®º + ä¾æ® + â‰¤3æ¡å¤„æ–¹ + æ‰¿è¯ºé‚€è¯·
- ç¦æ­¢æå“ã€å®¿å‘½è®ºã€ç»å¯¹é¢„æµ‹

ã€å¯ç”¨å·¥å…·ã€‘
- query_twin: æŸ¥è¯¢ç”¨æˆ·æ•°å­—å­ªç”Ÿæ•°æ®
- create_commitment: åˆ›å»ºè¡ŒåŠ¨æ‰¿è¯º
- search_kb: æœç´¢çŸ¥è¯†åº“
- schedule_task: å®‰æ’ä»»åŠ¡åˆ°è®¡åˆ’`,

  tools: [
    tool({
      name: 'query_twin',
      description: 'æŸ¥è¯¢ç”¨æˆ·çš„ç²¾ç¥æ•°å­—å­ªç”Ÿæ•°æ®',
      parameters: z.object({
        layer: z.enum(['L1', 'L2', 'L3']),
        path: z.string().optional(),
      }),
      execute: async ({ layer, path }) => {
        // å®ç°ï¼šä»æ•°æ®åº“è·å–å­ªç”Ÿæ•°æ®
      },
    }),

    tool({
      name: 'create_commitment',
      description: 'ä¸ºç”¨æˆ·åˆ›å»ºä¸€ä¸ªè¡ŒåŠ¨æ‰¿è¯º',
      parameters: z.object({
        title: z.string(),
        type: z.enum(['start_task', 'schedule_task', 'daily_habit']),
        duration_minutes: z.number().optional(),
        due_at: z.string().optional(),
      }),
      execute: async (params) => {
        // å®ç°ï¼šå†™å…¥ fortune_commitment è¡¨
      },
    }),

    tool({
      name: 'search_kb',
      description: 'æœç´¢çŸ¥è¯†åº“è·å–ä¸“ä¸šå†…å®¹',
      parameters: z.object({
        query: z.string(),
        domain: z.enum(['psychology', 'astrology', 'bazi', 'practice']),
        limit: z.number().default(3),
      }),
      execute: async ({ query, domain, limit }) => {
        // å®ç°ï¼šRAG æ£€ç´¢
      },
    }),
  ],

  temperature: 0.7,
  maxTokens: 1500,
};
```

#### 2.3.2 Analyst Agentï¼ˆåˆ†ææ™ºèƒ½ä½“ï¼‰

```typescript
// lib/ai/agents/analyst-agent.ts
export const analystAgent: AgentConfig = {
  id: 'analyst',
  name: 'Twin Analyst',
  model: 'glm:glm-4',
  systemPrompt: `ä½ æ˜¯æ•°å­—å­ªç”Ÿåˆ†æå¸ˆï¼ŒèŒè´£æ˜¯ä»ç”¨æˆ·å¯¹è¯å’Œè¡Œä¸ºä¸­æå–ç»“æ„åŒ–ä¿¡æ¯ã€‚

ã€æ ¸å¿ƒä»»åŠ¡ã€‘
1. æƒ…ç»ªçŠ¶æ€è¯†åˆ«ï¼šä»å¯¹è¯ä¸­è¯†åˆ«æƒ…ç»ªç±»å‹å’Œå¼ºåº¦
2. å…³é”®äº‹ä»¶æå–ï¼šè¯†åˆ«å½±å“ç”¨æˆ·çŠ¶æ€çš„äº‹ä»¶
3. æ¨¡å¼è¯†åˆ«ï¼šå‘ç°ç”¨æˆ·è¡Œä¸º/æ€ç»´æ¨¡å¼
4. å­ªç”Ÿæ›´æ–°å»ºè®®ï¼šäº§å‡ºç»“æ„åŒ–çš„å­ªç”Ÿæ›´æ–°æŒ‡ä»¤

ã€è¾“å‡ºæ ¼å¼ã€‘
{
  "insights": [...],           // æ´å¯Ÿåˆ—è¡¨
  "twin_updates": [...],       // å­ªç”Ÿæ›´æ–°æŒ‡ä»¤
  "risk_flags": [...],         // é£é™©æ ‡è®°ï¼ˆå¦‚è‡ªä¼¤å€¾å‘ï¼‰
  "confidence": 0.0-1.0
}

ã€æ³¨æ„äº‹é¡¹ã€‘
- åªæå–æ˜ç¡®è¡¨è¾¾æˆ–å¼ºçƒˆæš—ç¤ºçš„ä¿¡æ¯
- ä¸åšè¿‡åº¦æ¨æ–­
- é£é™©æ£€æµ‹ä¼˜å…ˆçº§æœ€é«˜`,

  tools: [
    tool({
      name: 'update_twin',
      description: 'æ›´æ–°ç”¨æˆ·æ•°å­—å­ªç”Ÿçš„ç‰¹å®šå­—æ®µ',
      parameters: z.object({
        layer: z.enum(['L1', 'L2', 'L3']),
        path: z.string(),
        value: z.any(),
        confidence: z.number(),
        reason: z.string(),
      }),
      execute: async (params) => {
        // å®ç°ï¼šå†™å…¥ twin_update_log å¹¶è§¦å‘æ›´æ–°
      },
    }),

    tool({
      name: 'flag_risk',
      description: 'æ ‡è®°é£é™©ä¿¡å·',
      parameters: z.object({
        risk_type: z.enum(['self_harm', 'crisis', 'dependency', 'medical']),
        severity: z.enum(['low', 'medium', 'high', 'critical']),
        evidence: z.string(),
      }),
      execute: async (params) => {
        // å®ç°ï¼šè§¦å‘å®‰å…¨åè®®
      },
    }),
  ],

  temperature: 0.3,  // ä½æ¸©åº¦ä¿è¯ç¨³å®šæ€§
  maxTokens: 800,
};
```

#### 2.3.3 Social Agentï¼ˆç¤¾äº¤æ™ºèƒ½ä½“ï¼‰

```typescript
// lib/ai/agents/social-agent.ts
export const socialAgent: AgentConfig = {
  id: 'social',
  name: 'Connection Agent',
  model: 'glm:glm-4',
  systemPrompt: `ä½ æ˜¯ç¤¾äº¤è¿æ¥æ™ºèƒ½ä½“ï¼Œè´Ÿè´£å¤„ç†ç”¨æˆ·é—´çš„æ·±åº¦è¿æ¥ã€‚

ã€æ ¸å¿ƒåŠŸèƒ½ã€‘
1. åˆç›˜åˆ†æï¼šåŸºäºåŒæ–¹å­ªç”Ÿæ•°æ®åˆ†æå…³ç³»åŠ¨åŠ›å­¦
2. åŒ¹é…æ¨èï¼šåŸºäºæ·±å±‚ç‰¹å¾è€Œéè¡¨é¢å…´è¶£
3. ç¾¤ä½“æœºåˆ¶ï¼šèƒ½é‡æ‰“èµã€å¥½è¿æ¥é¾™ã€åæ§½å¤§ä¼š
4. éšç§ä¿æŠ¤ï¼šä¸æ³„éœ²å…·ä½“å‡ºç”Ÿæ—¶é—´ç­‰æ•æ„Ÿä¿¡æ¯

ã€ç¤¾äº¤ç©æ³•ã€‘
- èƒ½é‡æ‰“èµï¼ˆBuffï¼‰ï¼šå¥½å‹é—´çš„èƒ½é‡ä¼ é€’
- å¥½è¿æ¥é¾™ï¼šç¾¤ä½“ä»ªå¼æ„Ÿ + è£‚å˜
- åæ§½å¤§ä¼šï¼šå®‰å…¨å®£æ³„ + é‡è¯„è®­ç»ƒ`,

  tools: [
    tool({
      name: 'generate_compatibility',
      description: 'ç”Ÿæˆä¸¤äººæˆ–å¤šäººåˆç›˜åˆ†æ',
      parameters: z.object({
        user_ids: z.array(z.string()),
        relationship_type: z.enum(['romantic', 'friendship', 'work', 'family']),
        depth: z.enum(['quick', 'standard', 'deep']),
      }),
      execute: async (params) => {
        // å®ç°ï¼šåˆç›˜ç®—æ³•
      },
    }),

    tool({
      name: 'send_energy_buff',
      description: 'å‘é€èƒ½é‡æ‰“èµ',
      parameters: z.object({
        from_user_id: z.string(),
        to_user_id: z.string(),
        buff_type: z.enum(['energy', 'luck', 'calm', 'focus']),
        amount: z.number(),
      }),
      execute: async (params) => {
        // å®ç°ï¼šå†™å…¥ ledger + è§¦å‘é€šçŸ¥
      },
    }),
  ],
};
```

#### 2.3.4 Expert Agent Factoryï¼ˆä¸“å®¶æ™ºèƒ½ä½“å·¥å‚ï¼‰

```typescript
// lib/ai/agents/expert-factory.ts
interface ExpertConfig {
  domain: 'bazi' | 'ziwei' | 'zodiac' | 'mbti' | 'perma';
  name: string;
  knowledgeBase: string;      // KB è·¯å¾„
  systemPromptTemplate: string;
}

const expertConfigs: ExpertConfig[] = [
  {
    domain: 'bazi',
    name: 'å…«å­—ä¸“å®¶',
    knowledgeBase: 'kb/bazi',
    systemPromptTemplate: `ä½ æ˜¯å…«å­—å‘½ç†ä¸“å®¶ï¼ŒåŸºäºç”¨æˆ·çš„å…«å­—æ•°æ®æä¾›è§£è¯»ã€‚

ã€ä¸“ä¸šè§„èŒƒã€‘
- åŸºäºå››æŸ±ï¼ˆå¹´æœˆæ—¥æ—¶ï¼‰è¿›è¡Œåˆ†æ
- ç»“åˆåç¥ã€ç¥ç…ã€å¤§è¿æµå¹´
- ç¿»è¯‘ä¸ºç°ä»£å¿ƒç†å­¦è¯­è¨€
- ç¦æ­¢ç»å¯¹é¢„æµ‹ï¼Œä½¿ç”¨æ¦‚ç‡è¯­è¨€`,
  },
  {
    domain: 'zodiac',
    name: 'æ˜Ÿåº§ä¸“å®¶',
    knowledgeBase: 'kb/astrology',
    systemPromptTemplate: `ä½ æ˜¯å æ˜Ÿå­¦ä¸“å®¶ï¼ŒåŸºäºæ˜Ÿç›˜æ•°æ®æä¾›è§£è¯»ã€‚

ã€ä¸“ä¸šè§„èŒƒã€‘
- åˆ†æå¤ªé˜³ã€æœˆäº®ã€ä¸Šå‡ç­‰å…³é”®é…ç½®
- å…³æ³¨å½“å‰è¡Œæ˜Ÿè¿‡å¢ƒå½±å“
- ç»“åˆç§¯æå¿ƒç†å­¦æ¡†æ¶
- ç»™å‡ºå¯è¡ŒåŠ¨çš„å»ºè®®`,
  },
  // ... æ›´å¤šä¸“å®¶é…ç½®
];

export function createExpertAgent(domain: ExpertConfig['domain']): AgentConfig {
  const config = expertConfigs.find(c => c.domain === domain);
  if (!config) throw new Error(`Unknown expert domain: ${domain}`);

  return {
    id: `expert-${domain}`,
    name: config.name,
    model: 'glm:glm-4',
    systemPrompt: config.systemPromptTemplate,
    tools: [
      tool({
        name: 'search_domain_kb',
        description: `æœç´¢${config.name}çŸ¥è¯†åº“`,
        parameters: z.object({ query: z.string() }),
        execute: async ({ query }) => {
          // å®ç°ï¼šé¢†åŸŸç‰¹å®š RAG
        },
      }),
    ],
  };
}
```

### 2.4 Orchestratorï¼ˆç¼–æ’å±‚ï¼‰å®ç°

```typescript
// lib/ai/orchestrator.ts
import { generateObject, streamText } from 'ai';
import { z } from 'zod';

// æ„å›¾è¯†åˆ« Schema
const IntentSchema = z.object({
  primary_intent: z.enum([
    'emotional_support',    // æƒ…ç»ªæ”¯æŒ
    'insight_seeking',      // å¯»æ±‚æ´å¯Ÿ
    'action_planning',      // è¡ŒåŠ¨è§„åˆ’
    'social_interaction',   // ç¤¾äº¤äº’åŠ¨
    'expert_consultation',  // ä¸“å®¶å’¨è¯¢
    'general_chat',         // é—²èŠ
  ]),
  sub_intent: z.string().optional(),
  required_agents: z.array(z.string()),
  expert_domains: z.array(z.string()).optional(),
  urgency: z.enum(['low', 'medium', 'high', 'critical']),
});

export async function orchestrate(
  userId: string,
  message: string,
  sessionContext: SessionContext,
): Promise<OrchestratorResult> {

  // Step 1: åŠ è½½ç”¨æˆ·å­ªç”Ÿæ•°æ®
  const twin = await loadTwinData(userId);

  // Step 2: æ„å›¾è¯†åˆ«
  const { object: intent } = await generateObject({
    model: modelRegistry.get('glm:glm-4'),
    schema: IntentSchema,
    prompt: `åˆ†æç”¨æˆ·æ„å›¾ï¼š
ç”¨æˆ·æ¶ˆæ¯ï¼š${message}
ç”¨æˆ·çŠ¶æ€ï¼š${JSON.stringify(twin.dynamic_state)}
æœ€è¿‘å¯¹è¯ï¼š${sessionContext.recentMessages.slice(-3).join('\n')}`,
  });

  // Step 3: é£é™©æ£€æŸ¥ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
  if (await checkRiskSignals(message, twin)) {
    return handleCrisisProtocol(userId, message);
  }

  // Step 4: Agent è·¯ç”±ä¸æ‰§è¡Œ
  const agentResults = await Promise.all(
    intent.required_agents.map(agentId =>
      executeAgent(agentId, { userId, message, twin, intent })
    )
  );

  // Step 5: ç»“æœèšåˆä¸ A2UI ç»„è£…
  const a2uiOutput = assembleA2UI(agentResults, intent);

  // Step 6: è§¦å‘ Analyst è¿›è¡Œå­ªç”Ÿæ›´æ–°ï¼ˆå¼‚æ­¥ï¼‰
  queueTwinAnalysis(userId, message, agentResults);

  return {
    a2ui: a2uiOutput,
    metadata: {
      intent,
      agents_used: intent.required_agents,
      processing_time_ms: Date.now() - startTime,
    },
  };
}
```

### 2.5 åŒæ¨¡å¼äº¤äº’ï¼ˆæ¥è‡ª bp v1.mdï¼‰

```typescript
// app/api/chat/route.ts
import { streamText } from 'ai';

export async function POST(req: Request) {
  const { messages, mode, userId, sessionId } = await req.json();

  // è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡
  const context = await buildUserContext(userId);

  if (mode === 'chat') {
    // Chat Modeï¼ˆå’¨è¯¢å®¤ï¼‰ï¼šæ·±åº¦å¯¹è¯
    const result = await streamText({
      model: modelRegistry.get('glm:glm-4'),
      system: buildCoachSystemPrompt(context),
      messages,
      tools: coachAgent.tools,
      maxSteps: 5,  // å…è®¸å¤šè½® tool è°ƒç”¨
      onFinish: async ({ text, toolCalls }) => {
        // æŒä¹…åŒ–å¯¹è¯
        await saveConversation(sessionId, messages, text, toolCalls);
        // è§¦å‘å­ªç”Ÿåˆ†æ
        await queueTwinAnalysis(userId, text);
      },
    });

    return result.toDataStreamResponse();

  } else if (mode === 'function') {
    // Function Modeï¼ˆæ˜¾åŒ–æ§åˆ¶å°ï¼‰ï¼šè‡ªåŠ¨æ˜¾åŒ–åŠŸèƒ½
    const orchestratorResult = await orchestrate(
      userId,
      messages[messages.length - 1].content,
      { recentMessages: messages.slice(-5) },
    );

    return Response.json(orchestratorResult.a2ui);
  }
}
```

---

## 3. æ•°æ®å±‚è®¾è®¡ï¼ˆPostgreSQL SSOTï¼‰

### 3.1 æ ¸å¿ƒè¡¨ç»“æ„å¢é‡ï¼ˆåœ¨ç°æœ‰ MVP åŸºç¡€ä¸Šï¼‰

#### 3.1.1 ç²¾ç¥æ•°å­—å­ªç”Ÿè¡¨

```sql
-- å­ªç”Ÿä¸»è¡¨
CREATE TABLE fortune_digital_twin (
    twin_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL UNIQUE REFERENCES fortune_user(user_id),

    -- L1 å…ƒæ•°æ®å±‚
    metadata_astrology JSONB NOT NULL DEFAULT '{}',
    metadata_psychology JSONB NOT NULL DEFAULT '{}',
    metadata_memory JSONB NOT NULL DEFAULT '{}',

    -- L2 åŠ¨æ€çŠ¶æ€å±‚
    dynamic_astro JSONB NOT NULL DEFAULT '{}',
    dynamic_bio JSONB NOT NULL DEFAULT '{}',
    dynamic_social JSONB NOT NULL DEFAULT '{}',
    dynamic_emotional JSONB NOT NULL DEFAULT '{}',

    -- L3 èšåˆæŒ‡æ ‡
    aura_points INTEGER NOT NULL DEFAULT 0,
    overall_wellbeing NUMERIC(5,2) NOT NULL DEFAULT 50.00,
    growth_streak INTEGER NOT NULL DEFAULT 0,
    dimension_scores JSONB NOT NULL DEFAULT '{"energy":50,"clarity":50,"connection":50,"growth":50,"balance":50}',

    -- å…ƒä¿¡æ¯
    compute_version TEXT NOT NULL DEFAULT 'v1.0',
    last_full_refresh TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_twin_user ON fortune_digital_twin(user_id);

-- å­ªç”Ÿæ›´æ–°æ—¥å¿—ï¼ˆäº‹ä»¶æº¯æºï¼‰
CREATE TABLE fortune_twin_update_log (
    log_id BIGSERIAL PRIMARY KEY,
    twin_id BIGINT NOT NULL REFERENCES fortune_digital_twin(twin_id),
    trigger_type TEXT NOT NULL,  -- daily_refresh/checkin_completed/chat_insight/...
    layer TEXT NOT NULL,         -- L1/L2/L3
    path TEXT NOT NULL,          -- e.g., 'dynamic_emotional.current_mood'
    old_value JSONB,
    new_value JSONB NOT NULL,
    confidence NUMERIC(3,2) NOT NULL,
    source TEXT NOT NULL,        -- agent_id/manual/external
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_twin_log_twin ON fortune_twin_update_log(twin_id, created_at DESC);
```

#### 3.1.2 ç¤¾äº¤å…³ç³»è¡¨

```sql
-- å¥½å‹å…³ç³»è¾¹ï¼ˆé‚»æ¥è¡¨ï¼‰
CREATE TABLE fortune_social_edge (
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    peer_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    relationship_type TEXT NOT NULL DEFAULT 'friend',  -- friend/family/romantic/work
    status TEXT NOT NULL DEFAULT 'pending',  -- pending/accepted/blocked
    compatibility_score NUMERIC(5,2),  -- åˆç›˜åˆ†æ•°ç¼“å­˜
    compatibility_data JSONB,          -- åˆç›˜è¯¦æƒ…ç¼“å­˜
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (user_id, peer_user_id)
);

CREATE INDEX idx_social_peer ON fortune_social_edge(peer_user_id, status);

-- èƒ½é‡æ‰“èµè®°å½•
CREATE TABLE fortune_energy_buff (
    buff_id BIGSERIAL PRIMARY KEY,
    from_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    to_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    buff_type TEXT NOT NULL,  -- energy/luck/calm/focus
    amount INTEGER NOT NULL,
    message TEXT,
    source TEXT NOT NULL DEFAULT 'app',  -- app/share_card/qr_scan
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_buff_to ON fortune_energy_buff(to_user_id, created_at DESC);
CREATE INDEX idx_buff_from ON fortune_energy_buff(from_user_id, created_at DESC);
```

#### 3.1.3 è™šæ‹Ÿè´§å¸è´¦æœ¬

```sql
-- è´§å¸è´¦æœ¬ï¼ˆåŒå‘è®°è´¦ï¼‰
CREATE TABLE fortune_currency_ledger (
    entry_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    amount INTEGER NOT NULL,  -- æ­£=æ”¶å…¥ï¼Œè´Ÿ=æ”¯å‡º
    balance_after INTEGER NOT NULL,  -- äº¤æ˜“åä½™é¢

    -- æ¥æº/å»å‘åˆ†ç±»
    category TEXT NOT NULL,  -- earn/spend/transfer_in/transfer_out
    reason TEXT NOT NULL,    -- task_complete/daily_checkin/feature_use/social_buff/...

    -- å…³è”å®ä½“
    ref_type TEXT,           -- commitment/plan/social/feature/...
    ref_id TEXT,

    -- å…ƒä¿¡æ¯
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_ledger_user ON fortune_currency_ledger(user_id, created_at DESC);

-- ç”¨æˆ·è´§å¸ä½™é¢è§†å›¾ï¼ˆæˆ–ç‰©åŒ–è§†å›¾ï¼‰
CREATE VIEW fortune_user_balance AS
SELECT
    user_id,
    COALESCE(SUM(amount), 0) AS total_balance,
    COALESCE(SUM(CASE WHEN amount > 0 THEN amount ELSE 0 END), 0) AS total_earned,
    COALESCE(SUM(CASE WHEN amount < 0 THEN ABS(amount) ELSE 0 END), 0) AS total_spent
FROM fortune_currency_ledger
GROUP BY user_id;
```

#### 3.1.4 ä¸“å®¶çŸ¥è¯†åº“é…ç½®

```sql
-- å¯æ’æ‹”ä¸“å®¶é…ç½®
CREATE TABLE fortune_expert_config (
    expert_id TEXT PRIMARY KEY,
    domain TEXT NOT NULL,  -- bazi/ziwei/zodiac/mbti/perma
    name TEXT NOT NULL,
    description TEXT,

    -- æ¨¡å‹é…ç½®
    model_id TEXT NOT NULL DEFAULT 'glm:glm-4',
    system_prompt TEXT NOT NULL,
    temperature NUMERIC(3,2) NOT NULL DEFAULT 0.7,
    max_tokens INTEGER NOT NULL DEFAULT 1000,

    -- çŸ¥è¯†åº“é…ç½®
    kb_collection TEXT,    -- pgvector collection å
    kb_filter JSONB,       -- æ£€ç´¢è¿‡æ»¤æ¡ä»¶

    -- å¯ç”¨æ€§
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_premium BOOLEAN NOT NULL DEFAULT FALSE,  -- æ˜¯å¦ä»˜è´¹ä¸“å±

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ç”¨æˆ·å·²è§£é”ä¸“å®¶
CREATE TABLE fortune_user_expert (
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id),
    expert_id TEXT NOT NULL REFERENCES fortune_expert_config(expert_id),
    unlocked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    unlock_source TEXT NOT NULL DEFAULT 'purchase',  -- purchase/gift/promotion
    PRIMARY KEY (user_id, expert_id)
);
```

### 3.2 pgvector çŸ¥è¯†åº“æ‰©å±•

```sql
-- å¯ç”¨ vector æ‰©å±•
CREATE EXTENSION IF NOT EXISTS vector;

-- ç»Ÿä¸€çŸ¥è¯†åº“ chunk è¡¨
CREATE TABLE fortune_kb_chunk (
    chunk_id BIGSERIAL PRIMARY KEY,
    collection TEXT NOT NULL,  -- bazi/psychology/astrology/practice
    source_doc TEXT NOT NULL,
    title TEXT,
    content TEXT NOT NULL,

    -- å‘é‡åµŒå…¥
    embedding vector(1536),    -- OpenAI ada-002 / å…¶ä»–æ¨¡å‹ç»´åº¦

    -- å…ƒæ•°æ®
    meta JSONB NOT NULL DEFAULT '{}',

    -- å…¨æ–‡æœç´¢
    content_tsv TSVECTOR GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_kb_collection ON fortune_kb_chunk(collection);
CREATE INDEX idx_kb_tsv ON fortune_kb_chunk USING GIN(content_tsv);
CREATE INDEX idx_kb_embedding ON fortune_kb_chunk USING ivfflat (embedding vector_cosine_ops);
```

---

## 4. API è·¯ç”±è®¾è®¡ï¼ˆNext.js App Routerï¼‰

### 4.1 è·¯ç”±ç»“æ„

```
app/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ register/route.ts
â”‚   â”‚   â”œâ”€â”€ login/route.ts
â”‚   â”‚   â””â”€â”€ logout/route.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â””â”€â”€ route.ts              # ä¸»å¯¹è¯ç«¯ç‚¹ï¼ˆæµå¼ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ twin/
â”‚   â”‚   â”œâ”€â”€ route.ts              # GET: è·å–å­ªç”Ÿæ•°æ®
â”‚   â”‚   â”œâ”€â”€ refresh/route.ts      # POST: è§¦å‘å­ªç”Ÿåˆ·æ–°
â”‚   â”‚   â””â”€â”€ history/route.ts      # GET: å­ªç”Ÿæ›´æ–°å†å²
â”‚   â”‚
â”‚   â”œâ”€â”€ commitment/
â”‚   â”‚   â”œâ”€â”€ route.ts              # GET: åˆ—è¡¨, POST: åˆ›å»º
â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚       â””â”€â”€ route.ts          # PATCH: æ›´æ–°çŠ¶æ€
â”‚   â”‚
â”‚   â”œâ”€â”€ social/
â”‚   â”‚   â”œâ”€â”€ friends/route.ts      # å¥½å‹åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ compatibility/route.ts # åˆç›˜åˆ†æ
â”‚   â”‚   â”œâ”€â”€ buff/route.ts         # èƒ½é‡æ‰“èµ
â”‚   â”‚   â””â”€â”€ share/route.ts        # ç”Ÿæˆåˆ†äº«å¡
â”‚   â”‚
â”‚   â”œâ”€â”€ plan/
â”‚   â”‚   â”œâ”€â”€ route.ts              # è®¡åˆ’åˆ—è¡¨
â”‚   â”‚   â”œâ”€â”€ [planId]/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts          # è®¡åˆ’è¯¦æƒ…
â”‚   â”‚   â””â”€â”€ enrollment/route.ts   # å‚ä¸ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ currency/
â”‚   â”‚   â”œâ”€â”€ balance/route.ts      # ä½™é¢æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ history/route.ts      # äº¤æ˜“å†å²
â”‚   â”‚
â”‚   â”œâ”€â”€ expert/
â”‚   â”‚   â”œâ”€â”€ route.ts              # å¯ç”¨ä¸“å®¶åˆ—è¡¨
â”‚   â”‚   â””â”€â”€ [domain]/
â”‚   â”‚       â””â”€â”€ route.ts          # ä¸“å®¶å’¨è¯¢
â”‚   â”‚
â”‚   â””â”€â”€ webhook/
â”‚       â”œâ”€â”€ health/route.ts       # å¥åº·æ•°æ®åŒæ­¥ï¼ˆApple/Fitbitï¼‰
â”‚       â””â”€â”€ notification/route.ts # æ¨é€å›è°ƒ
â”‚
â”œâ”€â”€ (app)/                        # åº”ç”¨é¡µé¢ï¼ˆéœ€è®¤è¯ï¼‰
â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”œâ”€â”€ dashboard/page.tsx        # ä¸»é¢æ¿/æ•°å­—å­ªç”Ÿå±•ç¤º
â”‚   â”œâ”€â”€ chat/page.tsx             # å¯¹è¯ç•Œé¢
â”‚   â”œâ”€â”€ plan/page.tsx             # æˆé•¿è®¡åˆ’
â”‚   â”œâ”€â”€ social/page.tsx           # ç¤¾äº¤ä¸­å¿ƒ
â”‚   â””â”€â”€ profile/page.tsx          # ä¸ªäººè®¾ç½®
â”‚
â””â”€â”€ (auth)/                       # è®¤è¯é¡µé¢
    â”œâ”€â”€ login/page.tsx
    â””â”€â”€ register/page.tsx
```

### 4.2 æ ¸å¿ƒ API å®ç°ç¤ºä¾‹

#### 4.2.1 å¯¹è¯ APIï¼ˆæµå¼ï¼‰

```typescript
// app/api/chat/route.ts
import { streamText, convertToCoreMessages } from 'ai';
import { modelRegistry, coachAgent } from '@/lib/ai/agents';
import { buildUserContext, saveConversation, queueTwinAnalysis } from '@/lib/services';
import { auth } from '@/lib/auth';

export async function POST(req: Request) {
  // è®¤è¯æ£€æŸ¥
  const session = await auth();
  if (!session?.user?.id) {
    return new Response('Unauthorized', { status: 401 });
  }

  const { messages, sessionId, mode = 'chat' } = await req.json();
  const userId = session.user.id;

  // æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå­ªç”Ÿæ•°æ® + åå¥½ï¼‰
  const context = await buildUserContext(userId);

  // å‡†å¤‡ç³»ç»Ÿæç¤ºè¯
  const systemPrompt = interpolatePrompt(coachAgent.systemPrompt, {
    user_context: JSON.stringify(context.summary),
    facts: JSON.stringify(context.twin.metadata_astrology),
    current_state: JSON.stringify(context.twin.dynamic_emotional),
    aura_points: context.twin.aura_points,
  });

  // æµå¼ç”Ÿæˆ
  const result = await streamText({
    model: modelRegistry.get(coachAgent.model),
    system: systemPrompt,
    messages: convertToCoreMessages(messages),
    tools: coachAgent.tools,
    maxSteps: 5,

    // å®Œæˆå›è°ƒ
    onFinish: async ({ text, toolCalls, usage }) => {
      // 1. æŒä¹…åŒ–å¯¹è¯
      await saveConversation({
        sessionId,
        userId,
        userMessage: messages[messages.length - 1].content,
        assistantMessage: text,
        toolCalls,
        usage,
      });

      // 2. å¼‚æ­¥è§¦å‘å­ªç”Ÿåˆ†æ
      await queueTwinAnalysis(userId, text, toolCalls);

      // 3. è®°å½• LLM ä½¿ç”¨æˆæœ¬
      await logLLMUsage(userId, usage);
    },
  });

  return result.toDataStreamResponse();
}
```

#### 4.2.2 å­ªç”Ÿæ•°æ® API

```typescript
// app/api/twin/route.ts
import { auth } from '@/lib/auth';
import { getTwinData, getTwinMetrics } from '@/lib/services/twin';

export async function GET(req: Request) {
  const session = await auth();
  if (!session?.user?.id) {
    return new Response('Unauthorized', { status: 401 });
  }

  const { searchParams } = new URL(req.url);
  const layer = searchParams.get('layer') as 'L1' | 'L2' | 'L3' | 'all';

  const twin = await getTwinData(session.user.id, layer || 'all');

  return Response.json({
    twin,
    metrics: await getTwinMetrics(session.user.id),
    last_updated: twin.updated_at,
  });
}
```

#### 4.2.3 ç¤¾äº¤åˆç›˜ API

```typescript
// app/api/social/compatibility/route.ts
import { auth } from '@/lib/auth';
import { generateCompatibility, socialAgent } from '@/lib/ai/agents/social-agent';

export async function POST(req: Request) {
  const session = await auth();
  if (!session?.user?.id) {
    return new Response('Unauthorized', { status: 401 });
  }

  const { peerId, relationshipType = 'friendship', depth = 'standard' } = await req.json();

  // æ£€æŸ¥å¥½å‹å…³ç³»
  const relationship = await checkFriendship(session.user.id, peerId);
  if (!relationship || relationship.status !== 'accepted') {
    return new Response('Not friends', { status: 403 });
  }

  // ç”Ÿæˆåˆç›˜åˆ†æï¼ˆä½¿ç”¨ Social Agentï¼‰
  const compatibility = await generateCompatibility({
    userIds: [session.user.id, peerId],
    relationshipType,
    depth,
  });

  // ç¼“å­˜ç»“æœ
  await cacheCompatibility(session.user.id, peerId, compatibility);

  return Response.json(compatibility);
}
```

---

## 5. A2UI è¾“å‡ºåè®®ï¼ˆæ‰©å±•ç‰ˆï¼‰

### 5.1 ç»„ä»¶ç±»å‹å®šä¹‰

```typescript
// types/a2ui.ts
type A2UIComponentType =
  | 'markdown_text'      // æ–‡æœ¬å†…å®¹
  | 'action_buttons'     // è¡ŒåŠ¨æŒ‰é’®
  | 'commitment_card'    // æ‰¿è¯ºå¡ç‰‡
  | 'twin_snapshot'      // å­ªç”Ÿå¿«ç…§å±•ç¤º
  | 'aura_radar'         // èƒ½é‡é›·è¾¾å›¾
  | 'timeline'           // æ—¶é—´çº¿
  | 'tarot_card'         // å¡”ç½—å¡
  | 'ritual_guide'       // ä»ªå¼å¼•å¯¼
  | 'compatibility'      // åˆç›˜ç»“æœ
  | 'share_card'         // å¯åˆ†äº«å¡ç‰‡
  | 'buff_animation'     // Buff åŠ¨ç”»
  | 'progress_ring';     // è¿›åº¦ç¯

interface A2UIComponent {
  type: A2UIComponentType;
  id: string;
  title?: string;
  data: any;
  style?: {
    theme?: 'light' | 'dark' | 'cosmic';
    accent_color?: string;
  };
}

interface A2UIOutput {
  meta: {
    summary: string;
    intent?: string;
    agents_used?: string[];
    processing_time_ms?: number;
  };
  ui_components: A2UIComponent[];
}
```

### 5.2 ç»„ä»¶ç¤ºä¾‹

```typescript
// æ‰¿è¯ºå¡ç‰‡
const commitmentCard: A2UIComponent = {
  type: 'commitment_card',
  id: 'commit-001',
  title: 'ä»Šæ—¥æœ€å°è¡ŒåŠ¨',
  data: {
    task_id: 'uuid',
    title: '3åˆ†é’Ÿèƒ½é‡é‡å¯',
    description: 'æ·±å‘¼å¸ + æ­£å¿µæ‰«æ',
    duration_minutes: 3,
    aura_reward: 10,
    status: 'suggested',
    actions: [
      { label: 'ç«‹å³å¼€å§‹', action_type: 'start_task' },
      { label: 'åŠ å…¥æ—¥ç¨‹', action_type: 'schedule_task' },
      { label: 'æ¢ä¸€ä¸ª', action_type: 'refresh' },
    ],
  },
};

// èƒ½é‡é›·è¾¾å›¾
const auraRadar: A2UIComponent = {
  type: 'aura_radar',
  id: 'radar-001',
  title: 'å½“å‰çŠ¶æ€',
  data: {
    dimensions: [
      { name: 'èƒ½é‡', value: 72, max: 100 },
      { name: 'æ¸…æ™°åº¦', value: 85, max: 100 },
      { name: 'è¿æ¥', value: 60, max: 100 },
      { name: 'æˆé•¿', value: 78, max: 100 },
      { name: 'å¹³è¡¡', value: 65, max: 100 },
    ],
    trend: 'rising',      // rising/stable/declining
    vs_yesterday: +5,
  },
  style: {
    theme: 'cosmic',
    accent_color: '#6366f1',
  },
};

// Buff åŠ¨ç”»
const buffAnimation: A2UIComponent = {
  type: 'buff_animation',
  id: 'buff-001',
  data: {
    from_name: 'å°æ˜',
    buff_type: 'energy',
    amount: 50,
    message: 'åŠ æ²¹ï¼',
    animation: 'sparkle',  // sparkle/wave/glow
  },
};
```

---

## 6. ä¸»åŠ¨è®¡ç®—ä¸æ¨é€ï¼ˆJITAI ç®—æ³•ï¼‰

### 6.1 Just-In-Time Adaptive Interventions

```typescript
// lib/jitai/engine.ts
interface JITAITrigger {
  id: string;
  name: string;
  conditions: JITAICondition[];
  intervention: JITAIIntervention;
  cooldown_hours: number;
  priority: number;
}

interface JITAICondition {
  type: 'time' | 'state' | 'behavior' | 'context';
  operator: 'eq' | 'gt' | 'lt' | 'in' | 'not_in';
  field: string;
  value: any;
}

interface JITAIIntervention {
  type: 'push_notification' | 'in_app_card' | 'chat_proactive' | 'email';
  template: string;
  content_generator?: string;  // Agent ID for dynamic content
  cta?: { label: string; action: string };
}

// é¢„å®šä¹‰è§¦å‘å™¨
const jitaiTriggers: JITAITrigger[] = [
  {
    id: 'morning_checkin',
    name: 'æ™¨é—´æ‰“å¡æé†’',
    conditions: [
      { type: 'time', operator: 'in', field: 'hour', value: [7, 8, 9] },
      { type: 'behavior', operator: 'eq', field: 'checked_in_today', value: false },
    ],
    intervention: {
      type: 'push_notification',
      template: 'morning_checkin',
      cta: { label: 'æ‰“å¡', action: 'open_checkin' },
    },
    cooldown_hours: 24,
    priority: 80,
  },

  {
    id: 'low_energy_intervention',
    name: 'ä½èƒ½é‡å¹²é¢„',
    conditions: [
      { type: 'state', operator: 'lt', field: 'twin.dimension_scores.energy', value: 30 },
      { type: 'state', operator: 'gt', field: 'twin.dynamic_emotional.mood_intensity', value: 6 },
    ],
    intervention: {
      type: 'in_app_card',
      template: 'energy_boost',
      content_generator: 'coach',
    },
    cooldown_hours: 6,
    priority: 90,
  },

  {
    id: 'retrograde_warning',
    name: 'æ°´é€†/é€†è¡Œæé†’',
    conditions: [
      { type: 'context', operator: 'eq', field: 'astro.mercury_retrograde', value: true },
      { type: 'behavior', operator: 'eq', field: 'notified_retrograde', value: false },
    ],
    intervention: {
      type: 'chat_proactive',
      template: 'retrograde_guidance',
      content_generator: 'expert-zodiac',
    },
    cooldown_hours: 168,  // 7 å¤©
    priority: 70,
  },

  {
    id: 'streak_celebration',
    name: 'è¿ç»­æ‰“å¡åº†ç¥',
    conditions: [
      { type: 'behavior', operator: 'in', field: 'growth_streak', value: [7, 21, 30, 100] },
    ],
    intervention: {
      type: 'in_app_card',
      template: 'streak_celebration',
      cta: { label: 'åˆ†äº«æˆå°±', action: 'share_achievement' },
    },
    cooldown_hours: 24,
    priority: 85,
  },
];

// JITAI å¼•æ“
export async function evaluateJITAI(userId: string): Promise<JITAIIntervention[]> {
  const twin = await getTwinData(userId, 'all');
  const behavior = await getUserBehavior(userId);
  const context = await getAstroContext();
  const currentHour = new Date().getHours();

  const triggeredInterventions: JITAIIntervention[] = [];

  for (const trigger of jitaiTriggers) {
    // æ£€æŸ¥å†·å´æœŸ
    if (await isInCooldown(userId, trigger.id)) continue;

    // è¯„ä¼°æ¡ä»¶
    const allConditionsMet = trigger.conditions.every(cond =>
      evaluateCondition(cond, { twin, behavior, context, currentHour })
    );

    if (allConditionsMet) {
      triggeredInterventions.push({
        ...trigger.intervention,
        triggerId: trigger.id,
        priority: trigger.priority,
      });
    }
  }

  // æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œè¿”å›æœ€é«˜ä¼˜å…ˆçº§çš„å¹²é¢„
  return triggeredInterventions.sort((a, b) => b.priority - a.priority);
}
```

### 6.2 æ¨é€è°ƒåº¦å™¨ï¼ˆVercel Cronï¼‰

```typescript
// app/api/cron/jitai/route.ts
import { evaluateJITAI, executeIntervention } from '@/lib/jitai';

export const dynamic = 'force-dynamic';
export const maxDuration = 60;

// Vercel Cron: æ¯ 15 åˆ†é’Ÿæ‰§è¡Œ
export async function GET(req: Request) {
  // éªŒè¯ Cron Secret
  const authHeader = req.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return new Response('Unauthorized', { status: 401 });
  }

  // è·å–æ´»è·ƒç”¨æˆ·ï¼ˆæœ€è¿‘ 7 å¤©æœ‰æ´»åŠ¨ï¼‰
  const activeUsers = await getActiveUsers(7);

  let interventionCount = 0;

  for (const userId of activeUsers) {
    const interventions = await evaluateJITAI(userId);

    if (interventions.length > 0) {
      // æ‰§è¡Œæœ€é«˜ä¼˜å…ˆçº§çš„å¹²é¢„
      await executeIntervention(userId, interventions[0]);
      interventionCount++;
    }
  }

  return Response.json({
    evaluated: activeUsers.length,
    intervened: interventionCount,
    timestamp: new Date().toISOString(),
  });
}
```

---

## 7. å¢é•¿ä¸ç—…æ¯’ä¼ æ’­æœºåˆ¶

### 7.1 åˆ†äº«å¡ç³»ç»Ÿ

```typescript
// lib/share/generator.ts
interface ShareCardConfig {
  type: 'cosmic_roast' | 'bento_grid' | 'manifestation_diary' | 'compatibility' | 'streak';
  userId: string;
  customData?: any;
}

export async function generateShareCard(config: ShareCardConfig): Promise<ShareCardResult> {
  const twin = await getTwinData(config.userId, 'all');
  const template = await getShareTemplate(config.type);

  // ç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹ï¼ˆä½¿ç”¨ Agentï¼‰
  let content: any;

  switch (config.type) {
    case 'cosmic_roast':
      // æ¯’èˆŒæŠ¥å‘Š - ä½¿ç”¨ Social Agent ç”Ÿæˆ
      content = await generateRoast(twin, config.customData?.targetUserId);
      break;

    case 'bento_grid':
      // æ„¿æ™¯æ¿ - èšåˆå­ªç”Ÿæ•°æ®
      content = {
        aura: twin.aura_points,
        dimensions: twin.dimension_scores,
        streak: twin.growth_streak,
        recent_wins: await getRecentWins(config.userId, 3),
      };
      break;

    case 'manifestation_diary':
      // æ˜¾åŒ–æ—¥è®° - æœ€è¿‘çš„æ‰¿è¯ºå®Œæˆè®°å½•
      content = await getManifestationContent(config.userId);
      break;
  }

  // è¿”å›æ¸²æŸ“æ•°æ®ï¼ˆå‰ç«¯ä½¿ç”¨ html-to-image å¯¼å‡ºï¼‰
  return {
    template_id: template.id,
    template_version: template.version,
    content,
    share_url: `${process.env.NEXT_PUBLIC_BASE_URL}/s/${encodeShareData(config)}`,
    qr_data: generateQRData(config),
  };
}
```

### 7.2 ç¤¾äº¤äº’åŠ¨æœºåˆ¶

```typescript
// lib/social/interactions.ts

// èƒ½é‡æ‰“èµ
export async function sendEnergyBuff(
  fromUserId: string,
  toUserId: string,
  buffType: BuffType,
  amount: number,
  message?: string,
  source: 'app' | 'share_card' | 'qr_scan' = 'app'
): Promise<BuffResult> {
  // 1. æ‰£é™¤å‘é€è€…è´§å¸
  await deductCurrency(fromUserId, amount, {
    category: 'transfer_out',
    reason: 'send_buff',
    ref_type: 'buff',
  });

  // 2. å¢åŠ æ¥æ”¶è€…è´§å¸
  await addCurrency(toUserId, amount, {
    category: 'transfer_in',
    reason: 'receive_buff',
    ref_type: 'buff',
  });

  // 3. è®°å½• Buff
  const buff = await db.insert(fortune_energy_buff, {
    from_user_id: fromUserId,
    to_user_id: toUserId,
    buff_type: buffType,
    amount,
    message,
    source,
  });

  // 4. æ›´æ–°æ¥æ”¶è€…å­ªç”ŸçŠ¶æ€
  await updateTwinDimension(toUserId, 'energy', amount * 0.1);  // Buff è½¬åŒ–ä¸ºèƒ½é‡å€¼

  // 5. å‘é€é€šçŸ¥
  await sendNotification(toUserId, {
    type: 'buff_received',
    title: 'æ”¶åˆ°èƒ½é‡ï¼',
    body: `${await getUserName(fromUserId)} ç»™ä½ å……èƒ½ +${amount}`,
    data: { buff_id: buff.buff_id },
  });

  return buff;
}

// å¥½è¿æ¥é¾™
export async function joinLuckChain(
  chainId: string,
  userId: string,
  contribution?: string  // å¦‚ï¼šæ‹ä¸€å¼ å¤©ç©ºç…§ç‰‡
): Promise<ChainResult> {
  const chain = await getChain(chainId);

  // 1. åŠ å…¥æ¥é¾™
  const position = await db.insert(fortune_luck_chain_participant, {
    chain_id: chainId,
    user_id: userId,
    position: chain.participant_count + 1,
    contribution,
  });

  // 2. è®¡ç®—é“¾æ¡ Buffï¼ˆå‚ä¸äººæ•°è¶Šå¤šï¼Œå¥–åŠ±è¶Šé«˜ï¼‰
  const chainMultiplier = Math.log2(chain.participant_count + 2);
  const reward = Math.floor(chain.base_reward * chainMultiplier);

  // 3. ç»™æ‰€æœ‰å‚ä¸è€…å‘æ”¾å¥–åŠ±
  const participants = await getChainParticipants(chainId);
  for (const p of participants) {
    await addCurrency(p.user_id, reward, {
      category: 'earn',
      reason: 'luck_chain',
      ref_type: 'chain',
      ref_id: chainId,
    });
  }

  // 4. æ›´æ–°æ¥é¾™çŠ¶æ€
  await updateChainStats(chainId);

  return {
    position: position.position,
    reward,
    total_participants: chain.participant_count + 1,
    chain_strength: chainMultiplier,
  };
}
```

### 7.3 å¢é•¿é£è½®æ•°æ®è¿½è¸ª

```sql
-- å¢é•¿æŒ‡æ ‡è¡¨
CREATE TABLE fortune_growth_metrics (
    metric_id BIGSERIAL PRIMARY KEY,
    metric_date DATE NOT NULL,

    -- ç”¨æˆ·æŒ‡æ ‡
    new_users INTEGER NOT NULL DEFAULT 0,
    active_users_daily INTEGER NOT NULL DEFAULT 0,
    active_users_weekly INTEGER NOT NULL DEFAULT 0,
    active_users_monthly INTEGER NOT NULL DEFAULT 0,

    -- å‚ä¸æŒ‡æ ‡
    total_checkins INTEGER NOT NULL DEFAULT 0,
    total_commitments_created INTEGER NOT NULL DEFAULT 0,
    total_commitments_completed INTEGER NOT NULL DEFAULT 0,

    -- ç¤¾äº¤æŒ‡æ ‡
    total_buffs_sent INTEGER NOT NULL DEFAULT 0,
    total_shares INTEGER NOT NULL DEFAULT 0,
    viral_coefficient NUMERIC(5,2) NOT NULL DEFAULT 0,  -- Kå› å­

    -- ç•™å­˜æŒ‡æ ‡
    retention_d1 NUMERIC(5,2),
    retention_d7 NUMERIC(5,2),
    retention_d30 NUMERIC(5,2),

    -- è´§å¸æŒ‡æ ‡
    total_currency_earned INTEGER NOT NULL DEFAULT 0,
    total_currency_spent INTEGER NOT NULL DEFAULT 0,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    UNIQUE (metric_date)
);
```

---

## 8. å®‰å…¨ã€åˆè§„ä¸ä¼¦ç†

### 8.1 AI å®‰å…¨å›´æ 

```typescript
// lib/safety/guardrails.ts
interface SafetyCheck {
  passed: boolean;
  risk_level: 'none' | 'low' | 'medium' | 'high' | 'critical';
  flags: string[];
  action: 'proceed' | 'modify' | 'block' | 'crisis_protocol';
}

// è¾“å…¥å®‰å…¨æ£€æŸ¥
export async function checkInputSafety(
  userId: string,
  message: string
): Promise<SafetyCheck> {
  const flags: string[] = [];
  let riskLevel: SafetyCheck['risk_level'] = 'none';

  // 1. è‡ªä¼¤/è‡ªæ€å…³é”®è¯æ£€æµ‹
  const crisisKeywords = ['è‡ªæ€', 'ä¸æƒ³æ´»', 'ç»“æŸç”Ÿå‘½', 'æ­»äº†ç®—äº†', 'è·³æ¥¼', 'å‰²è…•'];
  if (crisisKeywords.some(kw => message.includes(kw))) {
    flags.push('crisis_signal');
    riskLevel = 'critical';
    return {
      passed: false,
      risk_level: riskLevel,
      flags,
      action: 'crisis_protocol',
    };
  }

  // 2. ç»å¯¹é¢„æµ‹è¯·æ±‚æ£€æµ‹
  const fortuneTellingPatterns = ['å‘Šè¯‰æˆ‘ä¼šä¸ä¼š', 'æˆ‘èƒ½ä¸èƒ½', 'æˆ‘ä»Šå¹´ä¼š', 'ä»€ä¹ˆæ—¶å€™èƒ½'];
  if (fortuneTellingPatterns.some(p => message.includes(p))) {
    flags.push('fortune_telling_request');
    riskLevel = 'medium';
  }

  // 3. åŒ»ç–—/æ³•å¾‹/æŠ•èµ„å’¨è¯¢æ£€æµ‹
  const professionalDomains = ['æˆ‘å¾—äº†', 'åº”è¯¥åƒä»€ä¹ˆè¯', 'èµ·è¯‰', 'å¾‹å¸ˆ', 'è‚¡ç¥¨', 'æŠ•èµ„'];
  if (professionalDomains.some(d => message.includes(d))) {
    flags.push('professional_advice_request');
    riskLevel = 'medium';
  }

  return {
    passed: riskLevel !== 'critical',
    risk_level: riskLevel,
    flags,
    action: riskLevel === 'critical' ? 'crisis_protocol' :
            flags.length > 0 ? 'modify' : 'proceed',
  };
}

// è¾“å‡ºå®‰å…¨æ£€æŸ¥
export async function checkOutputSafety(
  response: string
): Promise<SafetyCheck> {
  const flags: string[] = [];

  // 1. ç»å¯¹é¢„æµ‹æ£€æµ‹
  const absolutePredictions = ['ä½ ä¸€å®šä¼š', 'è‚¯å®šèƒ½', 'å¿…ç„¶å‘ç”Ÿ', 'ç™¾åˆ†ä¹‹ç™¾'];
  if (absolutePredictions.some(p => response.includes(p))) {
    flags.push('absolute_prediction');
  }

  // 2. æå“æ€§æªè¾æ£€æµ‹
  const scarePatterns = ['å¤§éš¾ä¸´å¤´', 'åŠ«éš¾', 'è¡€å…‰ä¹‹ç¾', 'å¿…æ­»æ— ç–‘'];
  if (scarePatterns.some(p => response.includes(p))) {
    flags.push('scare_language');
  }

  // 3. ä¸“ä¸šå»ºè®®è¶Šç•Œæ£€æµ‹
  const professionalClaims = ['ä½ åº”è¯¥åƒ', 'å»ºè®®æœè¯', 'å»ä¹°è¿™ä¸ªè‚¡ç¥¨'];
  if (professionalClaims.some(p => response.includes(p))) {
    flags.push('professional_overreach');
  }

  return {
    passed: flags.length === 0,
    risk_level: flags.length > 0 ? 'medium' : 'none',
    flags,
    action: flags.length > 0 ? 'modify' : 'proceed',
  };
}

// å±æœºå¹²é¢„åè®®
export async function handleCrisisProtocol(
  userId: string,
  message: string
): Promise<A2UIOutput> {
  // 1. è®°å½•å±æœºäº‹ä»¶
  await logCrisisEvent(userId, message);

  // 2. è¿”å›å®‰å…¨å“åº”
  return {
    meta: {
      summary: 'å®‰å…¨åè®®å·²è§¦å‘',
      intent: 'crisis_intervention',
    },
    ui_components: [
      {
        type: 'markdown_text',
        id: 'crisis-response',
        title: 'æˆ‘åœ¨è¿™é‡Œ',
        data: `æˆ‘å¬åˆ°äº†ä½ æ­£åœ¨ç»å†çš„å›°éš¾ã€‚å¦‚æœä½ æœ‰ä¼¤å®³è‡ªå·±çš„æƒ³æ³•ï¼Œè¯·ç«‹å³å¯»æ±‚ä¸“ä¸šå¸®åŠ©ï¼š

**å…¨å›½å¿ƒç†æ´åŠ©çƒ­çº¿**
ğŸ“ 400-161-9995ï¼ˆ24å°æ—¶ï¼‰
ğŸ“ åŒ—äº¬ï¼š010-82951332
ğŸ“ ä¸Šæµ·ï¼š021-12320-5

**ä½ çš„ç”Ÿå‘½å¾ˆé‡è¦ï¼Œä¸“ä¸šçš„å¸®åŠ©å°±åœ¨èº«è¾¹ã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘ä»¬å¯ä»¥èŠèŠä½ ç°åœ¨çš„æ„Ÿå—ã€‚`,
      },
      {
        type: 'action_buttons',
        id: 'crisis-actions',
        title: 'ä¸‹ä¸€æ­¥',
        data: [
          { label: 'æ‹¨æ‰“çƒ­çº¿', action_type: 'call', value: '400-161-9995' },
          { label: 'æˆ‘æƒ³èŠèŠ', action_type: 'continue_chat' },
          { label: 'æˆ‘ç°åœ¨å®‰å…¨', action_type: 'confirm_safe' },
        ],
      },
    ],
  };
}
```

### 8.2 åä¾èµ–æœºåˆ¶

```typescript
// lib/safety/anti-dependency.ts
interface DependencyMetrics {
  daily_sessions: number;
  avg_session_length_minutes: number;
  repeated_questions_count: number;
  fortune_seeking_frequency: number;
  action_completion_rate: number;
}

export async function checkDependencySignals(
  userId: string
): Promise<{
  level: 'healthy' | 'mild' | 'moderate' | 'concerning';
  interventions: string[];
}> {
  const metrics = await calculateDependencyMetrics(userId);
  const interventions: string[] = [];
  let level: 'healthy' | 'mild' | 'moderate' | 'concerning' = 'healthy';

  // 1. é«˜é¢‘ä½¿ç”¨æ£€æµ‹
  if (metrics.daily_sessions > 10) {
    level = 'moderate';
    interventions.push('usage_limit');
  }

  // 2. é‡å¤è¿½é—®æ£€æµ‹
  if (metrics.repeated_questions_count > 5) {
    level = level === 'healthy' ? 'mild' : level;
    interventions.push('redirect_to_action');
  }

  // 3. ç®—å‘½ä¾èµ–æ£€æµ‹
  if (metrics.fortune_seeking_frequency > 0.7) {
    level = level === 'healthy' ? 'mild' : level;
    interventions.push('diversify_content');
  }

  // 4. è¡ŒåŠ¨å®Œæˆç‡è¿‡ä½
  if (metrics.action_completion_rate < 0.2) {
    level = level === 'healthy' ? 'mild' : level;
    interventions.push('simplify_tasks');
  }

  return { level, interventions };
}

// åä¾èµ–å¹²é¢„å®ç°
export async function applyAntiDependencyIntervention(
  userId: string,
  intervention: string
): Promise<void> {
  switch (intervention) {
    case 'usage_limit':
      // æ¸©å’Œæç¤ºï¼Œä¸å¼ºåˆ¶é™åˆ¶
      await sendInAppMessage(userId, {
        type: 'gentle_reminder',
        content: 'ä»Šå¤©ä½ å·²ç»æ¥äº†å¥½å¤šæ¬¡äº†ã€‚ä¸å¦‚å‡ºå»èµ°èµ°ï¼Œç°å®ä¸–ç•Œé‡Œä¹Ÿæœ‰å¾ˆå¤šç¾å¥½åœ¨ç­‰ç€ä½ ã€‚',
      });
      break;

    case 'redirect_to_action':
      // å¼ºåˆ¶æ’å…¥è¡ŒåŠ¨å®éªŒ
      await forceCommitmentSuggestion(userId, {
        title: 'è¯•è¯•è¿™ä¸ªå°å®éªŒ',
        description: 'åœ¨ç»§ç»­å¯¹è¯ä¹‹å‰ï¼Œå…ˆå®Œæˆè¿™ä¸ª 5 åˆ†é’Ÿçš„ç»ƒä¹ ',
        type: 'reality_experiment',
      });
      break;

    case 'diversify_content':
      // å‡å°‘å‘½ç†å†…å®¹ï¼Œå¢åŠ å¿ƒç†å­¦å†…å®¹
      await adjustContentMix(userId, {
        astrology: 0.3,
        psychology: 0.5,
        practice: 0.2,
      });
      break;

    case 'simplify_tasks':
      // é™ä½ä»»åŠ¡éš¾åº¦
      await adjustTaskDifficulty(userId, 'easier');
      break;
  }
}
```

### 8.3 éšç§ä¿æŠ¤

```typescript
// lib/privacy/data-minimization.ts

// LLM ä¸Šä¸‹æ–‡æ³¨å…¥æ—¶çš„æ•°æ®æœ€å°åŒ–
export function buildSafeContext(twin: SpiritualDigitalTwin): SafeContext {
  return {
    // L1: åªæä¾›æ‘˜è¦ï¼Œä¸æä¾›åŸå§‹æ•°æ®
    astrology_summary: summarizeAstrology(twin.metadata.astrology),
    psychology_traits: twin.metadata.psychology.mbti?.type || 'unknown',

    // L2: åªæä¾›çŠ¶æ€çº§åˆ«ï¼Œä¸æä¾›å…·ä½“æ•°å€¼
    energy_level: categorize(twin.dynamic_state.emotional_state.mood_intensity, ['low', 'medium', 'high']),
    recent_mood_trend: 'stable',  // æˆ– improving/declining

    // L3: å¯ä»¥å®Œæ•´æä¾›ï¼ˆå·²æ˜¯èšåˆæ•°æ®ï¼‰
    aura_points: twin.aggregated_metrics.aura_points,
    dimension_scores: twin.aggregated_metrics.dimension_scores,

    // æ’é™¤æ•æ„Ÿä¿¡æ¯
    // - å…·ä½“å‡ºç”Ÿæ—¶é—´
    // - åŸå§‹å¯¹è¯å†…å®¹
    // - å…³é”®äº‹ä»¶è¯¦æƒ…
  };
}

// æ•°æ®å¯¼å‡º/åˆ é™¤ï¼ˆGDPR/PIPL åˆè§„ï¼‰
export async function exportUserData(userId: string): Promise<ExportPackage> {
  const userData = await collectAllUserData(userId);

  return {
    profile: userData.profile,
    twin: userData.twin,
    conversations: userData.conversations.map(c => ({
      ...c,
      messages: c.messages,  // åŒ…å«å®Œæ•´å¯¹è¯
    })),
    commitments: userData.commitments,
    currency_history: userData.ledger,
    social_connections: userData.social.map(s => ({
      type: s.relationship_type,
      created_at: s.created_at,
    })),
    export_date: new Date().toISOString(),
  };
}

export async function deleteUserData(userId: string): Promise<void> {
  // 1. è½¯åˆ é™¤ä¸»è®°å½•
  await softDeleteUser(userId);

  // 2. åŒ¿ååŒ–å…³è”æ•°æ®ï¼ˆä¿ç•™ç»Ÿè®¡ä»·å€¼ï¼‰
  await anonymizeConversations(userId);
  await anonymizeSocialEdges(userId);

  // 3. ç¡¬åˆ é™¤æ•æ„Ÿæ•°æ®
  await hardDeleteTwinData(userId);
  await hardDeleteCurrencyLedger(userId);

  // 4. è®°å½•åˆ é™¤äº‹ä»¶
  await logDataDeletion(userId);
}
```

---

## 9. éƒ¨ç½²ä¸è¿ç»´

### 9.1 Vercel éƒ¨ç½²é…ç½®

```json
// vercel.json
{
  "framework": "nextjs",
  "buildCommand": "next build",
  "installCommand": "pnpm install",
  "regions": ["hkg1", "sin1"],  // é¦™æ¸¯ + æ–°åŠ å¡

  "crons": [
    {
      "path": "/api/cron/jitai",
      "schedule": "*/15 * * * *"
    },
    {
      "path": "/api/cron/twin-refresh",
      "schedule": "0 0 * * *"
    },
    {
      "path": "/api/cron/metrics",
      "schedule": "0 1 * * *"
    }
  ],

  "functions": {
    "app/api/chat/route.ts": {
      "maxDuration": 60
    },
    "app/api/expert/*/route.ts": {
      "maxDuration": 30
    }
  },

  "env": {
    "DATABASE_URL": "@database-url",
    "GLM_API_KEY": "@glm-api-key",
    "OPENAI_API_KEY": "@openai-api-key",
    "ANTHROPIC_API_KEY": "@anthropic-api-key",
    "CRON_SECRET": "@cron-secret"
  }
}
```

### 9.2 æ•°æ®åº“è¿æ¥ï¼ˆVercel Postgres æˆ– Neonï¼‰

```typescript
// lib/db/index.ts
import { neon, neonConfig } from '@neondatabase/serverless';
import { drizzle } from 'drizzle-orm/neon-http';

// Serverless ä¼˜åŒ–
neonConfig.fetchConnectionCache = true;

const sql = neon(process.env.DATABASE_URL!);
export const db = drizzle(sql);

// è¿æ¥æ± ï¼ˆç”¨äº Cron ç­‰é•¿ä»»åŠ¡ï¼‰
import { Pool } from '@neondatabase/serverless';

export const pool = new Pool({ connectionString: process.env.DATABASE_URL });
```

### 9.3 ç›‘æ§ä¸å¯è§‚æµ‹æ€§

```typescript
// lib/observability/index.ts
import { trace, context, SpanStatusCode } from '@opentelemetry/api';

// Agent è°ƒç”¨è¿½è¸ª
export function traceAgentCall(agentId: string, fn: () => Promise<any>) {
  const tracer = trace.getTracer('fortune-ai');

  return tracer.startActiveSpan(`agent.${agentId}`, async (span) => {
    try {
      const result = await fn();
      span.setStatus({ code: SpanStatusCode.OK });
      return result;
    } catch (error) {
      span.setStatus({ code: SpanStatusCode.ERROR, message: error.message });
      throw error;
    } finally {
      span.end();
    }
  });
}

// LLM è°ƒç”¨æŒ‡æ ‡
export async function logLLMUsage(
  userId: string,
  usage: { promptTokens: number; completionTokens: number },
  model: string
) {
  await db.insert(fortune_llm_usage).values({
    user_id: userId,
    model,
    prompt_tokens: usage.promptTokens,
    completion_tokens: usage.completionTokens,
    cost_usd: calculateCost(model, usage),
    created_at: new Date(),
  });
}
```

---

## 10. å®æ–½è·¯çº¿å›¾

### Phase 0: åŸºç¡€è¿ç§»ï¼ˆ1-2 å‘¨ï¼‰

- [ ] Next.js 14 é¡¹ç›®åˆå§‹åŒ–
- [ ] Vercel AI SDK é›†æˆ
- [ ] PostgreSQL æ•°æ®åº“è¿ç§»è„šæœ¬
- [ ] ç°æœ‰è®¤è¯ç³»ç»Ÿé€‚é…
- [ ] åŸºç¡€ API è·¯ç”±æ­å»º

### Phase 1: æ ¸å¿ƒ Agent å®ç°ï¼ˆ2-3 å‘¨ï¼‰

- [ ] Coach Agent å®ç°ï¼ˆå¯¹è¯ + æ‰¿è¯ºï¼‰
- [ ] Analyst Agent å®ç°ï¼ˆå­ªç”Ÿæ›´æ–°ï¼‰
- [ ] Orchestrator ç¼–æ’å±‚
- [ ] A2UI è¾“å‡ºç³»ç»Ÿ
- [ ] åŸºç¡€ Tool Calling

### Phase 2: æ•°å­—å­ªç”Ÿç³»ç»Ÿï¼ˆ2-3 å‘¨ï¼‰

- [ ] ä¸‰å±‚å­ªç”Ÿæ¨¡å‹å®ç°
- [ ] å­ªç”Ÿæ›´æ–°æ—¥å¿—
- [ ] å¯è§†åŒ–ç»„ä»¶ï¼ˆé›·è¾¾å›¾/æ—¶é—´çº¿ï¼‰
- [ ] å­ªç”Ÿæ•°æ® API

### Phase 3: ç¤¾äº¤ä¸å¢é•¿ï¼ˆ2-3 å‘¨ï¼‰

- [ ] å¥½å‹ç³»ç»Ÿ
- [ ] åˆç›˜åˆ†æï¼ˆSocial Agentï¼‰
- [ ] èƒ½é‡æ‰“èµæœºåˆ¶
- [ ] åˆ†äº«å¡ç”Ÿæˆ
- [ ] å¥½è¿æ¥é¾™

### Phase 4: ä¸“å®¶ç³»ç»Ÿä¸é«˜çº§åŠŸèƒ½ï¼ˆ2-3 å‘¨ï¼‰

- [ ] Expert Agent Factory
- [ ] å¯æ’æ‹”ä¸“å®¶é…ç½®
- [ ] pgvector RAG
- [ ] ä»˜è´¹ä¸“å®¶è§£é”

### Phase 5: å®‰å…¨ä¸åˆè§„ï¼ˆ1-2 å‘¨ï¼‰

- [ ] è¾“å…¥/è¾“å‡ºå®‰å…¨æ£€æŸ¥
- [ ] å±æœºå¹²é¢„åè®®
- [ ] åä¾èµ–æœºåˆ¶
- [ ] æ•°æ®å¯¼å‡º/åˆ é™¤

### Phase 6: ä¼˜åŒ–ä¸ç›‘æ§ï¼ˆæŒç»­ï¼‰

- [ ] JITAI å¼•æ“
- [ ] æ¨é€è°ƒåº¦ä¼˜åŒ–
- [ ] æ€§èƒ½ç›‘æ§
- [ ] å¢é•¿æŒ‡æ ‡è¿½è¸ª

---

## 11. æŠ€æœ¯é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£ç­–ç•¥ |
|------|------|----------|
| Vercel å†·å¯åŠ¨å»¶è¿Ÿ | é¦–æ¬¡è¯·æ±‚æ…¢ | Edge Runtime + é¢„çƒ­ Cron |
| LLM å“åº”ä¸ç¨³å®š | ç”¨æˆ·ä½“éªŒå·® | å¤š Provider æ•…éšœè½¬ç§» + é‡è¯• |
| æ•°æ®åº“è¿æ¥æ± è€—å°½ | æœåŠ¡ä¸å¯ç”¨ | Serverless Driver + è¿æ¥å¤ç”¨ |
| LLM æˆæœ¬å¤±æ§ | è´¢åŠ¡é£é™© | ç”¨é‡é™åˆ¶ + ç¼“å­˜ + ç”¨æˆ·é…é¢ |
| å®‰å…¨æ¼æ´ | åˆè§„é£é™© | å¤šå±‚å®‰å…¨æ£€æŸ¥ + å®¡è®¡æ—¥å¿— |

---

## 12. é™„å½•

### A. ç¯å¢ƒå˜é‡æ¸…å•

```bash
# æ•°æ®åº“
DATABASE_URL=postgresql://...

# LLM Providers
GLM_BASE_URL=https://api.z.ai/api/paas/v4
GLM_API_KEY=
OPENAI_API_KEY=
ANTHROPIC_API_KEY=

# Vercel
CRON_SECRET=
NEXT_PUBLIC_BASE_URL=https://fortune.ai

# å¯é€‰ï¼šå¥åº·æ•°æ®
APPLE_HEALTH_WEBHOOK_SECRET=
FITBIT_CLIENT_ID=
FITBIT_CLIENT_SECRET=

# å¯é€‰ï¼šæ¨é€
EXPO_ACCESS_TOKEN=
APNS_KEY_ID=
```

### B. æ ¸å¿ƒä¾èµ–

```json
{
  "dependencies": {
    "next": "^14.0.0",
    "react": "^18.2.0",
    "ai": "^3.0.0",
    "@ai-sdk/openai": "^0.0.1",
    "@ai-sdk/anthropic": "^0.0.1",
    "@neondatabase/serverless": "^0.9.0",
    "drizzle-orm": "^0.30.0",
    "zod": "^3.22.0"
  }
}
```

### C. å‚è€ƒèµ„æ–™

- [Vercel AI SDK æ–‡æ¡£](https://sdk.vercel.ai/docs)
- [Next.js App Router](https://nextjs.org/docs/app)
- [pgvector æ‰©å±•](https://github.com/pgvector/pgvector)
- [JITAI è®ºæ–‡](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5977682/)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šMVP v1.0
**æœ€åæ›´æ–°**ï¼š2025-12-30
**ä½œè€…**ï¼šSystem Architect (Claude)
