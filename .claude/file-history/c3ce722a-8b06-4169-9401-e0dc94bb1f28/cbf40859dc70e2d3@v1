#!/usr/bin/env python3
"""
执行 017_drop_legacy_profile_tables 迁移
清理 VibeProfile 重构后的废弃表
"""
import asyncio
import logging
import sys
from pathlib import Path

# 添加项目根目录到 path
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


async def run_migration():
    """执行迁移脚本"""
    migration_file = Path(__file__).parent.parent / "stores/migrations/017_drop_legacy_profile_tables.sql"

    if not migration_file.exists():
        logger.error(f"Migration file not found: {migration_file}")
        return False

    # 读取 SQL 脚本
    sql_content = migration_file.read_text()

    logger.info("=" * 60)
    logger.info("Starting Migration 017: Drop Legacy Profile Tables")
    logger.info("=" * 60)

    try:
        conn = await get_connection()

        # 执行 SQL 脚本
        logger.info("Executing migration SQL...")
        await conn.execute(sql_content)

        logger.info("✓ Migration completed successfully!")
        logger.info("=" * 60)

        return True

    except Exception as e:
        logger.error(f"✗ Migration failed: {e}")
        logger.error("Please check the error and retry")
        return False


if __name__ == "__main__":
    success = asyncio.run(run_migration())
    sys.exit(0 if success else 1)
