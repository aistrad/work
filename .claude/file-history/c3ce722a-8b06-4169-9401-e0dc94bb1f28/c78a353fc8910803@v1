-- VibeProfile 重构后清理废弃表
-- Created: 2026-01-19
-- Ref: docs/components/VibeProfile/SPEC.md Section 6
-- Ref: docs/components/VibeProfile/CLEANUP_CHECKLIST.md

-- ============================================================================
-- 说明
-- ============================================================================
-- 以下表的数据已迁移到 unified_profiles.profile JSONB 字段：
--   1. user_data_store          → life_context.{goals, tasks, checkins}
--   2. user_reminders           → life_context.reminders
--   3. user_skill_subscriptions → preferences.subscribed_skills
--   4. user_push_preferences    → preferences.{push_enabled, push_hour}
--   5. skill_recommendation_blocks → preferences.blocked_skills
--
-- 执行此脚本前请务必：
--   1. 备份数据库: pg_dump -d vibelife > backup_$(date +%Y%m%d).sql
--   2. 验证迁移完成: 检查 unified_profiles 数据完整性
--   3. 在测试环境先执行
-- ============================================================================

BEGIN;

-- ============================================================================
-- Step 1: 数据验证（打印行数供确认）
-- ============================================================================
DO $$
DECLARE
    user_data_count INT;
    user_reminders_count INT;
    user_subscriptions_count INT;
    user_push_prefs_count INT;
    skill_blocks_count INT;
    unified_profiles_count INT;
BEGIN
    -- 统计废弃表行数
    SELECT COUNT(*) INTO user_data_count FROM user_data_store;
    SELECT COUNT(*) INTO user_reminders_count FROM user_reminders;
    SELECT COUNT(*) INTO user_subscriptions_count FROM user_skill_subscriptions;
    SELECT COUNT(*) INTO user_push_prefs_count FROM user_push_preferences;
    SELECT COUNT(*) INTO skill_blocks_count FROM skill_recommendation_blocks;

    -- 统计新表行数
    SELECT COUNT(*) INTO unified_profiles_count FROM unified_profiles;

    RAISE NOTICE '========================================';
    RAISE NOTICE 'Legacy Tables Row Counts:';
    RAISE NOTICE '  user_data_store: %', user_data_count;
    RAISE NOTICE '  user_reminders: %', user_reminders_count;
    RAISE NOTICE '  user_skill_subscriptions: %', user_subscriptions_count;
    RAISE NOTICE '  user_push_preferences: %', user_push_prefs_count;
    RAISE NOTICE '  skill_recommendation_blocks: %', skill_blocks_count;
    RAISE NOTICE '';
    RAISE NOTICE 'New Table:';
    RAISE NOTICE '  unified_profiles: %', unified_profiles_count;
    RAISE NOTICE '========================================';

    -- 安全检查：如果 unified_profiles 为空，中止
    IF unified_profiles_count = 0 THEN
        RAISE EXCEPTION 'ABORT: unified_profiles is empty! Migration may not have completed.';
    END IF;
END $$;

-- ============================================================================
-- Step 2: 删除废弃表
-- ============================================================================

RAISE NOTICE 'Dropping legacy tables...';

-- 1. user_data_store
DROP TABLE IF EXISTS user_data_store CASCADE;
RAISE NOTICE '  ✓ Dropped user_data_store';

-- 2. user_reminders
DROP TABLE IF EXISTS user_reminders CASCADE;
RAISE NOTICE '  ✓ Dropped user_reminders';

-- 3. user_skill_subscriptions
DROP TABLE IF EXISTS user_skill_subscriptions CASCADE;
RAISE NOTICE '  ✓ Dropped user_skill_subscriptions';

-- 4. user_push_preferences
DROP TABLE IF EXISTS user_push_preferences CASCADE;
RAISE NOTICE '  ✓ Dropped user_push_preferences';

-- 5. skill_recommendation_blocks
DROP TABLE IF EXISTS skill_recommendation_blocks CASCADE;
RAISE NOTICE '  ✓ Dropped skill_recommendation_blocks';

-- ============================================================================
-- Step 3: 清理相关索引和约束（如果有残留）
-- ============================================================================

-- PostgreSQL 的 CASCADE 应该已经清理了所有依赖，这里做二次确认
DO $$
DECLARE
    dropped_objects TEXT;
BEGIN
    -- 检查是否还有残留的索引
    SELECT string_agg(indexname, ', ')
    INTO dropped_objects
    FROM pg_indexes
    WHERE tablename IN (
        'user_data_store',
        'user_reminders',
        'user_skill_subscriptions',
        'user_push_preferences',
        'skill_recommendation_blocks'
    );

    IF dropped_objects IS NOT NULL THEN
        RAISE WARNING 'Found orphaned indexes: %', dropped_objects;
    ELSE
        RAISE NOTICE '  ✓ No orphaned indexes found';
    END IF;
END $$;

-- ============================================================================
-- Step 4: 记录清理日志
-- ============================================================================

-- 创建迁移日志表（如果不存在）
CREATE TABLE IF NOT EXISTS migration_log (
    id SERIAL PRIMARY KEY,
    migration_name VARCHAR(200) NOT NULL,
    executed_at TIMESTAMPTZ DEFAULT NOW(),
    description TEXT
);

INSERT INTO migration_log (migration_name, description)
VALUES (
    '017_drop_legacy_profile_tables',
    'Dropped 5 legacy profile tables after VibeProfile refactor: user_data_store, user_reminders, user_skill_subscriptions, user_push_preferences, skill_recommendation_blocks'
);

RAISE NOTICE '';
RAISE NOTICE '========================================';
RAISE NOTICE 'Migration 017 completed successfully!';
RAISE NOTICE 'Dropped 5 legacy tables.';
RAISE NOTICE 'All data preserved in unified_profiles.';
RAISE NOTICE '========================================';

COMMIT;
