"use client";

/**
 * ConversationalLifecoachCard - å¯¹è¯å¼ Lifecoach è¿›åº¦å¡ç‰‡
 *
 * ä¼˜åŒ–ç‚¹ï¼š
 * 1. å¯¹è¯å¼æ–‡æ¡ˆï¼ˆè€Œéä»»åŠ¡åˆ—è¡¨ï¼‰
 * 2. æƒ…æ„ŸåŒ–è¿›åº¦åé¦ˆ
 * 3. çªå‡ºæœªå®Œæˆçš„è¡ŒåŠ¨é¡¹
 * 4. åŒ—ææ˜Ÿæé†’
 */

import { useMemo } from "react";
import { cn } from "@/lib/utils";

interface Rock {
  id: string;
  text: string;
  role?: string;
  completed: boolean;
}

interface Lever {
  id: string;
  text: string;
  completed: boolean;
}

interface LifecoachData {
  northStar?: string;
  weekRocks: Rock[];
  todayLevers: Lever[];
}

interface ConversationalLifecoachCardProps {
  data: LifecoachData;
  onShowMore?: () => void;
  className?: string;
}

export function ConversationalLifecoachCard({
  data,
  onShowMore,
  className
}: ConversationalLifecoachCardProps) {
  const { northStar, weekRocks, todayLevers } = data;

  const completedRocks = useMemo(() =>
    weekRocks.filter(r => r.completed).length,
    [weekRocks]
  );

  const completedLevers = useMemo(() =>
    todayLevers.filter(l => l.completed).length,
    [todayLevers]
  );

  // ç”Ÿæˆæƒ…æ„ŸåŒ–è¿›åº¦åé¦ˆ
  const progressMessage = useMemo(() => {
    return generateProgressMessage(
      completedRocks,
      weekRocks.length,
      completedLevers,
      todayLevers.length
    );
  }, [completedRocks, weekRocks.length, completedLevers, todayLevers.length]);

  // æœªå®Œæˆçš„ä»Šæ—¥æ æ†
  const uncompletedLevers = useMemo(() =>
    todayLevers.filter(l => !l.completed),
    [todayLevers]
  );

  return (
    <div className={cn(
      "bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border border-green-100",
      className
    )}>
      {/* åŒ—ææ˜Ÿæé†’ */}
      {northStar && (
        <div className="flex items-start gap-2 mb-2">
          <span className="text-base">â­</span>
          <p className="text-xs text-green-800 flex-1">
            è®°å¾—å—ï¼Ÿä½ æƒ³ <strong>{northStar}</strong>
          </p>
        </div>
      )}

      {/* è¿›åº¦åé¦ˆï¼ˆå¯¹è¯å¼ï¼‰ */}
      <p className="text-sm text-green-900 mb-3 leading-relaxed">
        {progressMessage}
      </p>

      {/* æœ¬å‘¨é‡è¦äº‹ï¼ˆåªæ˜¾ç¤ºå‰ 2 ä¸ªï¼‰ */}
      {weekRocks.length > 0 && (
        <div className="mb-3">
          <p className="text-xs text-green-700 mb-1.5 font-medium">æœ¬å‘¨ä½ åœ¨æ¨è¿›çš„äº‹ï¼š</p>
          <div className="space-y-1">
            {weekRocks.slice(0, 2).map(rock => (
              <div key={rock.id} className="flex items-center gap-2 text-xs text-green-800">
                <span className={rock.completed ? "text-green-500" : "text-green-300"}>
                  {rock.completed ? "âœ“" : "â€¢"}
                </span>
                <span className={rock.completed ? "line-through opacity-60" : ""}>
                  {rock.text}
                </span>
                {rock.role && (
                  <span className="text-green-600 text-[10px] opacity-70">
                    ({rock.role})
                  </span>
                )}
              </div>
            ))}
          </div>

          {weekRocks.length > 2 && onShowMore && (
            <button
              onClick={onShowMore}
              className="text-xs text-green-600 mt-1.5 hover:text-green-700 transition-colors"
            >
              è¿˜æœ‰ {weekRocks.length - 2} ä»¶äº‹ â†’
            </button>
          )}
        </div>
      )}

      {/* ä»Šæ—¥é‡ç‚¹ï¼ˆé«˜äº®æœªå®Œæˆçš„ï¼‰ */}
      {uncompletedLevers.length > 0 && (
        <div className="bg-white/60 rounded-lg px-3 py-2 backdrop-blur-sm">
          <p className="text-xs text-green-700 mb-1.5 font-medium">
            ä»Šå¤©æœ€é‡è¦çš„{uncompletedLevers.length > 1 ? `${uncompletedLevers.length}ä»¶äº‹` : ''}ï¼š
          </p>
          <div className="space-y-1">
            {uncompletedLevers.map(lever => (
              <div key={lever.id} className="flex items-center gap-2 text-xs text-green-900">
                <span className="text-green-500">â†’</span>
                <span className="font-medium">{lever.text}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* å·²å®Œæˆæç¤º */}
      {uncompletedLevers.length === 0 && todayLevers.length > 0 && (
        <div className="bg-green-100/50 rounded-lg px-3 py-2 text-center">
          <p className="text-xs text-green-800">
            âœ¨ ä»Šæ—¥è®¡åˆ’å…¨éƒ¨å®Œæˆï¼ä½ å¤ªæ£’äº†ï¼
          </p>
        </div>
      )}
    </div>
  );
}

// ç”Ÿæˆæƒ…æ„ŸåŒ–è¿›åº¦åé¦ˆ
function generateProgressMessage(
  completedRocks: number,
  totalRocks: number,
  completedLevers: number,
  totalLevers: number
): string {
  const rockProgress = totalRocks > 0 ? completedRocks / totalRocks : 0;
  const leverProgress = totalLevers > 0 ? completedLevers / totalLevers : 0;

  // é«˜è¿›åº¦ï¼ˆ>60%ï¼‰
  if (rockProgress >= 0.6 && leverProgress >= 0.6) {
    return "è¿™å‘¨æ¨è¿›å¾—å¾ˆç¨³ï¼ä¿æŒè¿™ä¸ªèŠ‚å¥ ğŸ’ª";
  }

  // æœ¬å‘¨è¿›åº¦å¥½ï¼Œä»Šæ—¥è¿˜æ²¡å¼€å§‹
  if (rockProgress >= 0.5 && totalLevers > 0 && completedLevers === 0) {
    return "æœ¬å‘¨è¿›åº¦ä¸é”™ï¼ä»Šå¤©ä¹Ÿæ¥ç‚¹è¡ŒåŠ¨å§ ğŸŒ±";
  }

  // ä»Šæ—¥å®Œæˆåº¦é«˜
  if (leverProgress >= 0.6) {
    return "ä»Šå¤©çŠ¶æ€å¾ˆå¥½ï¼ç»§ç»­ä¿æŒ âœ¨";
  }

  // ä¸­ç­‰è¿›åº¦ï¼ˆ30-60%ï¼‰
  if (rockProgress >= 0.3 || leverProgress >= 0.3) {
    return "è¿˜æœ‰ä¸€äº›é‡è¦çš„äº‹ç­‰ç€ä½ ï¼Œä»Šå¤©å¯ä»¥æ¨ä¸€æŠŠ ğŸ¯";
  }

  // ä»Šæ—¥è¿˜æ²¡å¼€å§‹
  if (totalLevers > 0 && completedLevers === 0) {
    return "ä»Šå¤©è¿˜æ²¡å¼€å§‹è¡ŒåŠ¨ï¼Ÿä»æœ€å°çš„ä¸€æ­¥å¼€å§‹å§ ğŸŒ±";
  }

  // é»˜è®¤
  return "æœ¬å‘¨çš„é‡ç‚¹éƒ½åœ¨è¿™é‡Œï¼Œå‡†å¤‡å¥½äº†å—ï¼Ÿ";
}
