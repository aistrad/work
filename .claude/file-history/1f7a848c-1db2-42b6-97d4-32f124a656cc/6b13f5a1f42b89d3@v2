# Skill 统一配置框架（routing.yaml 升级）

> 统一模型：`skill_data` + `includes`，无需区分类型

## 核心思想

所有 Skill 使用相同的配置模型：
- `skill_data`: 需要加载哪些 Skill 的数据
- `includes`: 需要加载哪些 Skill 的工具

不再区分"能力型"和"编排型"，统一处理。

---

## routing.yaml 统一结构

```yaml
skills:
  # 基础 Skill
  bazi:
    name: 八字命理
    short_desc: 八字命理分析
    category: astrology
    triggers: [八字, 命理, 生辰, 算命, 命盘]
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_bazi
    collect_tool: request_info
    global_tools: [search_db, request_info, show_insight]
    # skill_data: []      # 默认只加载自身
    # includes: []        # 默认不包含其他 Skill

  zodiac:
    name: 星座占星
    short_desc: 星座星盘分析
    category: astrology
    triggers: [星座, 星盘, 占星, 上升]
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_zodiac
    collect_tool: request_info
    global_tools: [search_db, request_info, show_insight]

  # 依赖其他 Skill 数据的 Skill
  jungastro:
    name: 荣格心理占星
    short_desc: 荣格心理占星分析
    category: self-awareness
    triggers: [荣格, 心理占星, 阴影整合]
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_zodiac
    skill_data: [bazi, zodiac]          # 加载这些 Skill 的数据
    includes: [zodiac]                  # 包含 zodiac 的工具
    global_tools: [search_db, request_info]

  vibe_id:
    name: VibeID 人格画像
    short_desc: 四维人格原型分析
    category: self-awareness
    triggers: [人格画像, VibeID, 原型分析]
    requires_birth_info: true
    requires_compute: true
    skill_data: [bazi, zodiac]
    global_tools: [show_card, request_info, search_db]

  # 包含多个 Skill 工具的 Skill
  career_timing:
    name: 职场时机
    short_desc: 职场时机分析
    category: professional
    triggers: [职场时机, 跳槽时机, 什么时候换工作]
    requires_birth_info: true
    skill_data: [bazi, zodiac]
    includes: [bazi, zodiac, career]    # 包含这些 Skill 的工具

  relationship_intel:
    name: 关系经营
    short_desc: 关系经营智能
    category: relationship
    triggers: [合盘, 配对, 关系分析]
    requires_birth_info: true
    skill_data: [bazi, zodiac]
    includes: [bazi, zodiac]
```

---

## 配置字段说明

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `name` | string | - | Skill 显示名称 |
| `short_desc` | string | - | 一句话描述 |
| `category` | string | - | 分类（astrology/self-awareness/professional/relationship） |
| `triggers` | list | [] | 触发词列表 |
| `requires_birth_info` | bool | false | 是否需要出生信息 |
| `requires_compute` | bool | false | 是否需要排盘/计算 |
| `compute_tool` | string | - | 计算工具名 |
| `collect_tool` | string | request_info | 收集工具名 |
| `global_tools` | list | [] | 需要的全局工具 |
| `skill_data` | list | [self] | 需要加载的 skill_data |
| `includes` | list | [] | 需要包含工具的 Skill |

---

## 实施步骤

### Step 1: 升级 routing.yaml

将所有 SKILL.md frontmatter 中的机器配置迁移到 routing.yaml。

### Step 2: 新增查询函数

**文件**: `services/agent/routing_config.py`

```python
def get_skill_data_deps(skill_id: str) -> List[str]:
    """获取需要加载的 skill_data 列表"""
    config = get_skill_routing(skill_id)
    deps = config.get("skill_data", [])
    # 始终包含自身
    if skill_id not in deps:
        deps = [skill_id] + deps
    return deps

def get_skill_includes(skill_id: str) -> List[str]:
    """获取需要加载工具的 Skill 列表"""
    config = get_skill_routing(skill_id)
    return config.get("includes", [])
```

### Step 3: 修改数据加载

**文件**: `stores/profile_cache.py`

```python
async def get_cached_profile_with_skill(user_id, skill):
    deps = get_skill_data_deps(skill) if skill else [skill]
    skill_data_dict = {sid: skills_store.get(sid, {}) for sid in deps}
    return {"profile": profile, "skill_data": skill_data_dict}
```

### Step 4: 修改工具加载

**文件**: `services/agent/tool_registry.py`

```python
def get_tools_for_skill(skill_id):
    tools = []
    # 加载 includes 列表中的工具
    for inc_skill in get_skill_includes(skill_id):
        tools.extend(_load_skill_tools(inc_skill))
    # 加载自身工具
    tools.extend(_load_skill_tools(skill_id))
    return tools
```

### Step 5: 简化 SKILL.md

移除机器配置，只保留 prompt 内容：
- 专家身份
- 服务原则
- 伦理边界
- 详细规则索引

---

## 修改文件清单

| 文件 | 改动 |
|------|------|
| `skills/core/config/routing.yaml` | 迁入所有配置 |
| `services/agent/routing_config.py` | 新增 2 个查询函数 |
| `stores/profile_cache.py` | 使用 `get_skill_data_deps()` |
| `services/agent/tool_registry.py` | 使用 `get_skill_includes()` |
| `services/agent/skill_loader.py` | 优先从 routing.yaml 读配置 |
| `skills/*/SKILL.md` | 简化 |

---

## 配置字段分工

| 字段 | routing.yaml | SKILL.md |
|------|--------------|----------|
| name, short_desc | ✅ | - |
| triggers | ✅ | - |
| category | ✅ | - |
| requires_birth_info | ✅ | - |
| requires_compute | ✅ | - |
| compute_tool, collect_tool | ✅ | - |
| global_tools | ✅ | - |
| skill_data, includes | ✅ | - |
| 专家身份 | - | ✅ |
| 服务原则 | - | ✅ |
| 伦理边界 | - | ✅ |
| 核心能力索引 | - | ✅ |

---

## 验证

1. `get_skill_data_deps("jungastro")` → `["jungastro", "bazi", "zodiac"]`
2. `get_skill_includes("career_timing")` → `["bazi", "zodiac", "career"]`
3. 激活 career_timing 后 context.skill_data 包含 bazi + zodiac 数据
4. LLM 能看到 bazi/zodiac/career 的所有工具

---

## 示例：创建新的编排 Skill

### 1. 在 routing.yaml 添加配置

```yaml
skills:
  life_milestone:
    name: 人生节点导航
    short_desc: 人生重大决策时机分析
    category: professional
    triggers: [买房, 结婚时机, 要不要生孩子, 创业时机]
    requires_birth_info: true
    skill_data: [bazi, zodiac]
    includes: [bazi, zodiac, career, lifecoach]
```

### 2. 创建 SKILL.md

```markdown
# 人生节点导航 Skill

## 专家身份

你是一位融合命理智慧和人生规划经验的导航师...

## 服务原则

1. 综合多维度分析
2. 提供时机窗口建议
3. 全程陪伴式服务

## 伦理边界

- 不替用户做决定
- 强调人的主观能动性
```

### 3. 创建 rules/（可选）

```
skills/life_milestone/
├── SKILL.md
└── rules/
    ├── house-buying.md
    ├── marriage.md
    └── startup.md
```

无需其他代码，系统自动：
- 根据 triggers 路由到此 Skill
- 加载 bazi + zodiac 数据
- 加载 bazi/zodiac/career/lifecoach 的工具
