# Skill 统一配置框架（routing.yaml 升级）

> 统一模型：`skill_data` + `includes`，无需区分类型

## 核心思想

所有 Skill 使用相同的配置模型：
- `skill_data`: 需要加载哪些 Skill 的数据
- `includes`: 需要加载哪些 Skill 的工具

不再区分"能力型"和"编排型"，统一处理。

---

## routing.yaml 统一结构

```yaml
skills:
  # 基础 Skill
  bazi:
    name: 八字命理
    short_desc: 八字命理分析
    category: astrology
    triggers: [八字, 命理, 生辰, 算命, 命盘]
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_bazi
    collect_tool: request_info
    global_tools: [search_db, request_info, show_insight]
    # skill_data: []      # 默认只加载自身
    # includes: []        # 默认不包含其他 Skill

  zodiac:
    name: 星座占星
    short_desc: 星座星盘分析
    category: astrology
    triggers: [星座, 星盘, 占星, 上升]
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_zodiac
    collect_tool: request_info
    global_tools: [search_db, request_info, show_insight]

  # 依赖其他 Skill 数据的 Skill
  jungastro:
    name: 荣格心理占星
    short_desc: 荣格心理占星分析
    category: self-awareness
    triggers: [荣格, 心理占星, 阴影整合]
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_zodiac
    skill_data: [bazi, zodiac]          # 加载这些 Skill 的数据
    includes: [zodiac]                  # 包含 zodiac 的工具
    global_tools: [search_db, request_info]

  vibe_id:
    name: VibeID 人格画像
    short_desc: 四维人格原型分析
    category: self-awareness
    triggers: [人格画像, VibeID, 原型分析]
    requires_birth_info: true
    requires_compute: true
    skill_data: [bazi, zodiac]
    global_tools: [show_card, request_info, search_db]

  # 包含多个 Skill 工具的 Skill
  career_timing:
    name: 职场时机
    short_desc: 职场时机分析
    category: professional
    triggers: [职场时机, 跳槽时机, 什么时候换工作]
    requires_birth_info: true
    skill_data: [bazi, zodiac]
    includes: [bazi, zodiac, career]    # 包含这些 Skill 的工具

  relationship_intel:
    name: 关系经营
    short_desc: 关系经营智能
    category: relationship
    triggers: [合盘, 配对, 关系分析]
    requires_birth_info: true
    skill_data: [bazi, zodiac]
    includes: [bazi, zodiac]
```

---

## 实施步骤

### Step 1: 升级 routing.yaml

将所有 SKILL.md frontmatter 中的机器配置迁移到 routing.yaml。

### Step 2: 新增查询函数

**文件**: `services/agent/routing_config.py`

```python
def get_skill_data_deps(skill_id: str) -> List[str]:
    """获取需要加载的 skill_data 列表"""
    config = get_skill_routing(skill_id)
    deps = config.get("skill_data", [])
    # 始终包含自身
    if skill_id not in deps:
        deps = [skill_id] + deps
    return deps

def get_skill_includes(skill_id: str) -> List[str]:
    """获取需要加载工具的 Skill 列表"""
    config = get_skill_routing(skill_id)
    return config.get("includes", [])
```

### Step 3: 修改数据加载

**文件**: `stores/profile_cache.py`

```python
async def get_cached_profile_with_skill(user_id, skill):
    deps = get_skill_data_deps(skill) if skill else [skill]
    skill_data_dict = {sid: skills_store.get(sid, {}) for sid in deps}
    return {"profile": profile, "skill_data": skill_data_dict}
```

### Step 4: 修改工具加载

**文件**: `services/agent/tool_registry.py`

```python
def get_tools_for_skill(skill_id):
    tools = []
    # 加载 includes 列表中的工具
    for inc_skill in get_skill_includes(skill_id):
        tools.extend(_load_skill_tools(inc_skill))
    # 加载自身工具
    tools.extend(_load_skill_tools(skill_id))
    return tools
```

### Step 5: 简化 SKILL.md

移除机器配置，只保留 prompt 内容。

---

## 修改文件清单

| 文件 | 改动 |
|------|------|
| `skills/core/config/routing.yaml` | 迁入所有配置 |
| `services/agent/routing_config.py` | 新增 2 个查询函数 |
| `stores/profile_cache.py` | 使用 `get_skill_data_deps()` |
| `services/agent/tool_registry.py` | 使用 `get_skill_includes()` |
| `services/agent/skill_loader.py` | 优先从 routing.yaml 读配置 |
| `skills/*/SKILL.md` | 简化 |

---

## 验证

1. `get_skill_data_deps("jungastro")` → `["jungastro", "bazi", "zodiac"]`
2. `get_skill_includes("career_timing")` → `["bazi", "zodiac", "career"]`
3. 激活 career_timing 后 context.skill_data 包含 bazi + zodiac 数据
4. LLM 能看到 bazi/zodiac/career 的所有工具
