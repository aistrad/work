#!/usr/bin/env python3
"""
ç®¡ç†æµ‹è¯•ç”¨æˆ· - å¿«é€Ÿåˆ›å»º/ä¿®æ”¹æµ‹è¯•ç¯å¢ƒçš„é»˜è®¤ç™»å½•ç”¨æˆ·

ä½¿ç”¨æ–¹æ³•:
  python scripts/manage_test_user.py                    # æŸ¥çœ‹å½“å‰æµ‹è¯•ç”¨æˆ·
  python scripts/manage_test_user.py create             # åˆ›å»ºæ–°çš„æµ‹è¯•ç”¨æˆ·
  python scripts/manage_test_user.py update EMAIL       # ä¿®æ”¹é»˜è®¤æµ‹è¯•ç”¨æˆ·
"""

import asyncio
import sys
import os
from pathlib import Path
from uuid import UUID, uuid4
from datetime import datetime, timezone

# è®¾ç½®æ•°æ®åº“ç¯å¢ƒå˜é‡ï¼ˆä½¿ç”¨æµ‹è¯•ç¯å¢ƒï¼‰
os.environ["VIBELIFE_DB_URL"] = "postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife"

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection, execute, fetchrow, fetchval


async def show_current_user():
    """æ˜¾ç¤ºå½“å‰é»˜è®¤æµ‹è¯•ç”¨æˆ·"""
    print("\n" + "=" * 80)
    print("å½“å‰é»˜è®¤æµ‹è¯•ç”¨æˆ·")
    print("=" * 80)

    user = await fetchrow('''
        SELECT ua.user_id, ua.auth_identifier, u.vibe_id,
               up.profile->'account'->>'display_name' as display_name
        FROM vibe_user_auth ua
        JOIN vibe_users u ON ua.user_id = u.id
        LEFT JOIN unified_profiles up ON ua.user_id = up.user_id
        WHERE ua.auth_identifier = $1
    ''', 'iaaichina@163.com')

    if user:
        print(f"âœ… æ‰¾åˆ°æµ‹è¯•ç”¨æˆ·:")
        print(f"   Email: {user['auth_identifier']}")
        print(f"   Vibe ID: {user['vibe_id']}")
        print(f"   Display Name: {user.get('display_name') or '(æœªè®¾ç½®)'}")
        print(f"   User ID: {user['user_id']}")
    else:
        print("âŒ æœªæ‰¾åˆ°é»˜è®¤æµ‹è¯•ç”¨æˆ· (iaaichina@163.com)")

    # åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç”¨æˆ·
    all_test_users = await fetchrow('''
        SELECT COUNT(*) as count
        FROM vibe_user_auth
        WHERE auth_identifier LIKE '%test%' OR auth_identifier LIKE '%@163.com'
    ''')
    print(f"\næ•°æ®åº“ä¸­å…±æœ‰ {all_test_users['count']} ä¸ªæµ‹è¯•ç›¸å…³ç”¨æˆ·")


async def create_test_user():
    """åˆ›å»ºæ–°çš„æµ‹è¯•ç”¨æˆ·"""
    print("\n" + "=" * 80)
    print("åˆ›å»ºæ–°æµ‹è¯•ç”¨æˆ·")
    print("=" * 80)

    email = input("\nè¯·è¾“å…¥é‚®ç®±åœ°å€ (ä¾‹å¦‚: test@example.com): ").strip()
    if not email or '@' not in email:
        print("âŒ æ— æ•ˆçš„é‚®ç®±åœ°å€")
        return

    display_name = input("è¯·è¾“å…¥æ˜¾ç¤ºåç§° (å¯é€‰): ").strip() or "æµ‹è¯•ç”¨æˆ·"

    # æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    existing = await fetchval(
        "SELECT 1 FROM vibe_user_auth WHERE auth_identifier = $1",
        email
    )

    if existing:
        print(f"âŒ é‚®ç®± {email} å·²è¢«æ³¨å†Œ")
        return

    # ç”Ÿæˆ Vibe ID
    vibe_id = f"VB-TEST{uuid4().hex[:8].upper()}"
    user_id = uuid4()

    # åˆ›å»ºç”¨æˆ·
    await execute(
        """INSERT INTO vibe_users (id, vibe_id, tier, status, created_at, updated_at)
           VALUES ($1, $2, $3, $4, $5, $6)""",
        user_id,
        vibe_id,
        "free",
        "active",
        datetime.now(timezone.utc),
        datetime.now(timezone.utc)
    )

    # åˆ›å»ºè®¤è¯è®°å½•
    await execute(
        """INSERT INTO vibe_user_auth (user_id, auth_provider, auth_identifier, created_at, updated_at)
           VALUES ($1, $2, $3, $4, $5)""",
        user_id,
        "email",
        email,
        datetime.now(timezone.utc),
        datetime.now(timezone.utc)
    )

    # åˆ›å»º unified_profiles
    import json
    profile_data = {
        "account": {
            "vibe_id": vibe_id,
            "display_name": display_name,
            "tier": "free",
            "status": "active"
        },
        "preferences": {
            "language": "zh-CN",
            "timezone": "Asia/Shanghai"
        },
        "skills": {},
        "skill_data": {}
    }

    await execute(
        """INSERT INTO unified_profiles (user_id, profile, created_at, updated_at)
           VALUES ($1, $2::jsonb, $3, $4)""",
        user_id,
        json.dumps(profile_data, ensure_ascii=False),
        datetime.now(timezone.utc),
        datetime.now(timezone.utc)
    )

    print(f"\nâœ… æµ‹è¯•ç”¨æˆ·åˆ›å»ºæˆåŠŸ!")
    print(f"   Email: {email}")
    print(f"   Vibe ID: {vibe_id}")
    print(f"   Display Name: {display_name}")
    print(f"   User ID: {user_id}")
    print(f"\nğŸ’¡ ä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªé‚®ç®±åœ¨ dev-login é¡µé¢ç™»å½•")


async def list_test_users():
    """åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç”¨æˆ·"""
    print("\n" + "=" * 80)
    print("æ‰€æœ‰æµ‹è¯•ç”¨æˆ·åˆ—è¡¨")
    print("=" * 80)

    from stores.db import fetch

    users = await fetch('''
        SELECT ua.auth_identifier, u.vibe_id,
               up.profile->'account'->>'display_name' as display_name,
               u.created_at
        FROM vibe_user_auth ua
        JOIN vibe_users u ON ua.user_id = u.id
        LEFT JOIN unified_profiles up ON ua.user_id = up.user_id
        WHERE ua.auth_provider = 'email'
        ORDER BY u.created_at DESC
        LIMIT 10
    ''')

    if users:
        print(f"\næœ€è¿‘çš„ {len(users)} ä¸ªé‚®ç®±ç™»å½•ç”¨æˆ·:\n")
        for user in users:
            print(f"  ğŸ“§ {user['auth_identifier']}")
            print(f"     Vibe ID: {user['vibe_id']}")
            print(f"     Name: {user.get('display_name') or '(æœªè®¾ç½®)'}")
            print(f"     åˆ›å»ºæ—¶é—´: {user['created_at'].strftime('%Y-%m-%d %H:%M')}\n")
    else:
        print("æœªæ‰¾åˆ°ä»»ä½•é‚®ç®±ç™»å½•ç”¨æˆ·")


async def main():
    """ä¸»å‡½æ•°"""
    print("\n" + "â•”" + "=" * 78 + "â•—")
    print("â•‘" + " " * 25 + "æµ‹è¯•ç”¨æˆ·ç®¡ç†å·¥å…·" + " " * 37 + "â•‘")
    print("â•š" + "=" * 78 + "â•")

    if len(sys.argv) == 1:
        # æ— å‚æ•°ï¼Œæ˜¾ç¤ºå½“å‰æµ‹è¯•ç”¨æˆ·
        await show_current_user()
        print("\nğŸ’¡ æç¤º:")
        print("   - python scripts/manage_test_user.py list    # åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç”¨æˆ·")
        print("   - python scripts/manage_test_user.py create  # åˆ›å»ºæ–°æµ‹è¯•ç”¨æˆ·")
        return

    command = sys.argv[1].lower()

    if command == "list":
        await list_test_users()
    elif command == "create":
        await create_test_user()
    elif command == "show" or command == "current":
        await show_current_user()
    else:
        print(f"âŒ æœªçŸ¥å‘½ä»¤: {command}")
        print("\nå¯ç”¨å‘½ä»¤:")
        print("  show    - æ˜¾ç¤ºå½“å‰é»˜è®¤æµ‹è¯•ç”¨æˆ·")
        print("  list    - åˆ—å‡ºæ‰€æœ‰æµ‹è¯•ç”¨æˆ·")
        print("  create  - åˆ›å»ºæ–°æµ‹è¯•ç”¨æˆ·")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\næ“ä½œå·²å–æ¶ˆ")
        sys.exit(0)
    except Exception as e:
        print(f"\n\nâŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
