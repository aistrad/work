"""
路由配置加载器 - Single Source of Truth

从 skills/core/config/routing.yaml 加载所有路由相关配置，
避免在代码中重复定义元数据。
"""
import os
import yaml
import logging
from typing import Dict, Any, List, Optional
from functools import lru_cache

logger = logging.getLogger(__name__)

# 配置文件路径
CONFIG_PATH = os.path.join(
    os.path.dirname(__file__),
    "../../skills/core/config/routing.yaml"
)


@lru_cache(maxsize=1)
def load_routing_config() -> Dict[str, Any]:
    """加载路由配置（带缓存）"""
    try:
        with open(CONFIG_PATH, "r", encoding="utf-8") as f:
            config = yaml.safe_load(f)
            logger.info(f"[RoutingConfig] Loaded from {CONFIG_PATH}")
            return config or {}
    except Exception as e:
        logger.error(f"[RoutingConfig] Failed to load config: {e}")
        return {}


def get_phase1_prompt() -> str:
    """获取 Phase 1 System Prompt"""
    config = load_routing_config()
    return config.get("phase1_prompt", "")


def get_protocol_meta(protocol_id: str) -> Optional[Dict[str, Any]]:
    """获取协议元数据"""
    config = load_routing_config()
    protocols = config.get("protocols", {})
    return protocols.get(protocol_id)


def get_all_protocols() -> Dict[str, Dict[str, Any]]:
    """获取所有协议元数据"""
    config = load_routing_config()
    return config.get("protocols", {})


def get_skill_routing_config(skill_id: str) -> Optional[Dict[str, Any]]:
    """获取 Skill 路由配置"""
    config = load_routing_config()
    skills = config.get("skills", {})
    return skills.get(skill_id)


def get_all_skill_routing() -> Dict[str, Dict[str, Any]]:
    """获取所有 Skill 路由配置"""
    config = load_routing_config()
    return config.get("skills", {})


def get_sop_template(template_name: str) -> str:
    """获取 SOP 规则模板"""
    config = load_routing_config()
    templates = config.get("sop_templates", {})
    return templates.get(template_name, "")


def get_welcome_config() -> Dict[str, Any]:
    """获取欢迎消息配置"""
    config = load_routing_config()
    return config.get("welcome", {})


def build_protocol_tool_description() -> str:
    """
    构建 show_protocol_invitation 工具的描述
    从配置文件动态生成，避免硬编码
    """
    protocols = get_all_protocols()
    if not protocols:
        return "展示协议邀请卡片"

    lines = ["展示协议邀请卡片，引导用户进入结构化协议流程。\n"]
    lines.append("## 可用协议\n")
    lines.append("| protocol_id | 名称 | 适用场景 | 时长 |")
    lines.append("|-------------|------|---------|------|")

    for pid, meta in protocols.items():
        name = meta.get("name", pid)
        desc = meta.get("description", "")[:20] + "..."
        time = meta.get("estimated_time", "10分钟")
        lines.append(f"| {pid} | {name} | {desc} | {time} |")

    lines.append("\n## 触发词映射\n")
    for pid, meta in protocols.items():
        triggers = meta.get("triggers", [])
        if triggers:
            lines.append(f"- {pid}: {', '.join(triggers[:3])}")

    lines.append("\n## 重要")
    lines.append("匹配到协议关键词时，必须调用此工具！")

    return "\n".join(lines)


def build_skill_tool_description() -> str:
    """
    构建 activate_skill 工具的描述 - v10.1: 包含 rule 选择指引
    从配置文件动态生成
    """
    from .skill_loader import load_skill, get_available_skills, get_skill_rules, load_rule

    available_skills = [s for s in get_available_skills() if s != "core"]
    skill_routing = get_all_skill_routing()

    lines = ["激活专业技能来回答用户问题。\n"]
    lines.append("## 可用技能\n")

    for skill_id in available_skills:
        skill = load_skill(skill_id)
        routing = skill_routing.get(skill_id, {})

        if skill:
            desc = routing.get("short_desc") or skill.description
            if len(desc) > 50:
                desc = desc[:50] + "..."
            triggers = routing.get("triggers", skill.triggers or [])[:3]
            trigger_text = "、".join(triggers) if triggers else ""
            lines.append(f"- **{skill_id}**: {desc}（{trigger_text}）")

            # v10.1: 列出可选 rules
            rules = get_skill_rules(skill_id)
            if rules and len(rules) > 0:
                lines.append(f"  可选规则（rule 参数）：")
                for rule_id in rules[:3]:  # 最多显示 3 个
                    rule = load_rule(skill_id, rule_id)
                    if rule:
                        rule_name = getattr(rule, 'name', rule_id)
                        tags = getattr(rule, 'tags', [])
                        tags_text = "、".join(tags[:2]) if tags else ""
                        lines.append(f"    - `{rule_id}`: {rule_name}（{tags_text}）")

    lines.append("\n## 参数说明")
    lines.append("- `skill`: 必需，技能 ID")
    lines.append("- `rule`: 可选，规则 ID。用户意图明确匹配某规则时传入")

    lines.append("\n## rule 参数使用指南")
    lines.append("- 用户说'做人生重置' → `activate_skill(skill='lifecoach', rule='dankoe')`")
    lines.append("- 用户说'算命'（无明确 rule）→ `activate_skill(skill='bazi')`")
    lines.append("- 用户说'七个习惯' → `activate_skill(skill='lifecoach', rule='covey')`")

    lines.append("\n## 何时调用")
    lines.append("- 用户明确需要某个专业领域的帮助")
    lines.append("- 用户提到了技能相关的关键词")

    return "\n".join(lines)


def reload_config():
    """重新加载配置（清除缓存）"""
    load_routing_config.cache_clear()
    logger.info("[RoutingConfig] Cache cleared, will reload on next access")
