#!/usr/bin/env python3
"""
Phase 1 æµ‹è¯•ï¼šéªŒè¯å·¥å…·é›†é™åˆ¶ç§»é™¤åçš„ LLM é©±åŠ¨è¡Œä¸º

æµ‹è¯•ç›®æ ‡ï¼š
1. éªŒè¯ LLM åœ¨ Phase 2 èƒ½è®¿é—®å®Œæ•´å·¥å…·é›†
2. éªŒè¯ LLM æ ¹æ® SOP Prompt ä¸»åŠ¨é€‰æ‹©æ­£ç¡®çš„å·¥å…·
3. éªŒè¯ LLM çµæ´»å¤„ç†ç”¨æˆ·è¾“å…¥ï¼ˆå¦‚ç›´æ¥æä¾›ç”Ÿæ—¥ï¼‰

æµ‹è¯•åœºæ™¯ï¼š
- S1: ç”¨æˆ·è¯´"å¸®æˆ‘ç®—å‘½" â†’ LLM åº”è°ƒç”¨ request_info
- S2: ç”¨æˆ·è¯´"æˆ‘1990-01-01ç”Ÿï¼Œç®—å‘½" â†’ LLM åº”è·³è¿‡ request_infoï¼Œç›´æ¥ calculate_bazi
- S3: å·²æœ‰å‘½ç›˜ï¼Œç”¨æˆ·è¯´"çœ‹äº‹ä¸šè¿" â†’ LLM åº”ç›´æ¥åˆ†æï¼Œä¸è°ƒç”¨å‰ç½®å·¥å…·
"""

import asyncio
import sys
import os

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "../"))

from services.agent.core import CoreAgent, AgentContext
from services.agent.tool_registry import ToolRegistry
from services.llm import get_llm_client


def print_section(title: str):
    """æ‰“å°æµ‹è¯•æ®µè½æ ‡é¢˜"""
    print(f"\n{'=' * 60}")
    print(f"  {title}")
    print('=' * 60)


async def test_s1_no_data():
    """
    S1: ç”¨æˆ·è¯´"å¸®æˆ‘ç®—å‘½"ï¼Œæ— ä»»ä½•æ•°æ®

    é¢„æœŸï¼š
    - LLM èƒ½è®¿é—®å®Œæ•´å·¥å…·é›†ï¼ˆåŒ…æ‹¬ request_info å’Œ calculate_baziï¼‰
    - LLM æ ¹æ® SOP Prompt ä¸»åŠ¨é€‰æ‹© request_info
    """
    print_section("S1: ç”¨æˆ·è¯´'å¸®æˆ‘ç®—å‘½'ï¼ˆæ— æ•°æ®ï¼‰")

    agent = CoreAgent(llm=get_llm_client(), max_iterations=5)
    # æ¨¡æ‹Ÿæ¿€æ´» skill
    agent._active_skill = "bazi"
    agent._active_scenario = None

    context = AgentContext(
        user_id="test-user-s1",
        user_tier="premium",
        profile={
            "identity": {
                "birth_info": {}  # æ— å‡ºç”Ÿä¿¡æ¯
            }
        },
        skill_data={},
        history=[],
        skill="bazi",
        scenario=None,
        conversation_id="test-conv-s1"
    )

    # æ¨¡æ‹Ÿè·å–å·¥å…·é›†
    tools = agent._get_current_tools(context)
    tool_names = [t["function"]["name"] for t in tools]

    print(f"\nâœ“ æ£€æŸ¥å·¥å…·é›†...")
    print(f"  å¯ç”¨å·¥å…·æ•°é‡: {len(tools)}")
    print(f"  å·¥å…·åˆ—è¡¨: {', '.join(tool_names)}")

    # éªŒè¯å·¥å…·é›†å®Œæ•´æ€§
    assert "request_info" in tool_names, "âŒ ç¼ºå°‘ request_info å·¥å…·"
    assert "calculate_bazi" in tool_names, "âŒ ç¼ºå°‘ calculate_bazi å·¥å…·"
    print(f"  âœ“ å·¥å…·é›†åŒ…å«æ‰€æœ‰å¿…è¦å·¥å…·")

    # æ£€æŸ¥ SOP Prompt
    sop_rules = agent._build_sop_rules(context)
    print(f"\nâœ“ æ£€æŸ¥ SOP Prompt...")
    print(f"  é•¿åº¦: {len(sop_rules)} å­—ç¬¦")
    print(f"  å…³é”®è¯æ£€æŸ¥:")
    print(f"    - åŒ…å« 'request_info': {('request_info' in sop_rules)}")
    print(f"    - åŒ…å« 'æ¨èå·¥å…·': {('æ¨èå·¥å…·' in sop_rules)}")
    print(f"    - åŒ…å« 'çµæ´»å¤„ç†': {('çµæ´»å¤„ç†' in sop_rules)}")

    assert "request_info" in sop_rules, "âŒ SOP Prompt ç¼ºå°‘ request_info æç¤º"
    assert "æ¨èå·¥å…·" in sop_rules or "ä¸‹ä¸€æ­¥" in sop_rules, "âŒ SOP Prompt ç¼ºå°‘æŒ‡å¯¼è¯­"

    print(f"\nâœ“ S1 æµ‹è¯•é€šè¿‡")
    print(f"  - LLM èƒ½è®¿é—®å®Œæ•´å·¥å…·é›† âœ“")
    print(f"  - SOP Prompt æ­£ç¡®æŒ‡å¯¼ LLM âœ“")


async def test_s2_with_birth_info():
    """
    S2: ç”¨æˆ·è¯´"æˆ‘1990-01-01ç”Ÿï¼Œç®—å‘½"ï¼Œæä¾›äº†ç”Ÿæ—¥

    é¢„æœŸï¼š
    - LLM èƒ½è®¿é—®å®Œæ•´å·¥å…·é›†
    - SOP Prompt æç¤º LLM å¯ä»¥çµæ´»è·³è¿‡ request_info
    """
    print_section("S2: ç”¨æˆ·è¯´'æˆ‘1990-01-01ç”Ÿï¼Œç®—å‘½'ï¼ˆå·²æœ‰ç”Ÿæ—¥ï¼‰")

    agent = CoreAgent(llm=get_llm_client(), max_iterations=5)
    # æ¨¡æ‹Ÿæ¿€æ´» skill
    agent._active_skill = "bazi"
    agent._active_scenario = None

    context = AgentContext(
        user_id="test-user-s2",
        user_tier="premium",
        profile={
            "identity": {
                "birth_info": {
                    "birth_date": "1990-01-01",
                    "birth_time": "12:00",
                    "timezone": "Asia/Shanghai"
                }
            }
        },
        skill_data={},
        history=[],
        skill="bazi",
        scenario=None,
        conversation_id="test-conv-s2"
    )

    # æ¨¡æ‹Ÿè·å–å·¥å…·é›†
    tools = agent._get_current_tools(context)
    tool_names = [t["function"]["name"] for t in tools]

    print(f"\nâœ“ æ£€æŸ¥å·¥å…·é›†...")
    print(f"  å¯ç”¨å·¥å…·æ•°é‡: {len(tools)}")
    print(f"  å·¥å…·åˆ—è¡¨: {', '.join(tool_names)}")

    # éªŒè¯å·¥å…·é›†å®Œæ•´æ€§
    assert "request_info" in tool_names, "âŒ ç¼ºå°‘ request_info å·¥å…·ï¼ˆåº”ä¿ç•™ï¼‰"
    assert "calculate_bazi" in tool_names, "âŒ ç¼ºå°‘ calculate_bazi å·¥å…·"
    print(f"  âœ“ å·¥å…·é›†åŒ…å«æ‰€æœ‰å¿…è¦å·¥å…·ï¼ˆåŒ…æ‹¬å¯è·³è¿‡çš„ request_infoï¼‰")

    # æ£€æŸ¥ SOP Prompt
    sop_rules = agent._build_sop_rules(context)
    print(f"\nâœ“ æ£€æŸ¥ SOP Prompt...")
    print(f"  é•¿åº¦: {len(sop_rules)} å­—ç¬¦")
    print(f"  çŠ¶æ€æç¤º:")
    print(f"    - åŒ…å« 'calculate_bazi': {('calculate_bazi' in sop_rules)}")
    print(f"    - åŒ…å« 'å·²æä¾›': {('å·²æä¾›' in sop_rules or 'å·²æœ‰å‡ºç”Ÿä¿¡æ¯' in sop_rules)}")

    assert "calculate_bazi" in sop_rules, "âŒ SOP Prompt åº”æŒ‡å¯¼è°ƒç”¨ calculate_bazi"

    print(f"\nâœ“ S2 æµ‹è¯•é€šè¿‡")
    print(f"  - LLM èƒ½è®¿é—®å®Œæ•´å·¥å…·é›† âœ“")
    print(f"  - SOP Prompt æ­£ç¡®æŒ‡å¯¼ä¸‹ä¸€æ­¥ âœ“")


async def test_s3_with_chart():
    """
    S3: å·²æœ‰å‘½ç›˜ï¼Œç”¨æˆ·è¯´"çœ‹äº‹ä¸šè¿"

    é¢„æœŸï¼š
    - LLM èƒ½è®¿é—®å®Œæ•´å·¥å…·é›†ï¼ˆåŒ…æ‹¬åˆ†æå·¥å…·ï¼‰
    - SOP Prompt æç¤º LLM å¯ä»¥ç›´æ¥åˆ†æ
    """
    print_section("S3: å·²æœ‰å‘½ç›˜ï¼Œç”¨æˆ·è¯´'çœ‹äº‹ä¸šè¿'")

    agent = CoreAgent(llm=get_llm_client(), max_iterations=5)
    # æ¨¡æ‹Ÿæ¿€æ´» skill
    agent._active_skill = "bazi"
    agent._active_scenario = None

    context = AgentContext(
        user_id="test-user-s3",
        user_tier="premium",
        profile={
            "identity": {
                "birth_info": {
                    "birth_date": "1990-01-01",
                    "birth_time": "12:00",
                    "timezone": "Asia/Shanghai"
                }
            }
        },
        skill_data={
            "bazi": {
                "chart": {
                    "pillars": [
                        {"year_stem": "åºš", "year_branch": "åˆ"},
                        {"month_stem": "æˆŠ", "month_branch": "å¯…"},
                        {"day_stem": "ç”²", "day_branch": "å­"},
                        {"hour_stem": "ä¸™", "hour_branch": "åˆ"}
                    ],
                    "month_order": "å¯…"
                }
            }
        },
        history=[],
        skill="bazi",
        scenario=None,
        conversation_id="test-conv-s3"
    )

    # æ¨¡æ‹Ÿè·å–å·¥å…·é›†
    tools = agent._get_current_tools(context)
    tool_names = [t["function"]["name"] for t in tools]

    print(f"\nâœ“ æ£€æŸ¥å·¥å…·é›†...")
    print(f"  å¯ç”¨å·¥å…·æ•°é‡: {len(tools)}")
    print(f"  å…³é”®å·¥å…·:")
    show_tools = [t for t in tool_names if t.startswith("show_")]
    print(f"    - show_* å·¥å…·: {', '.join(show_tools[:5])}")

    # éªŒè¯å·¥å…·é›†å®Œæ•´æ€§
    assert len(show_tools) > 0, "âŒ ç¼ºå°‘åˆ†æå±•ç¤ºå·¥å…·"
    assert "request_info" in tool_names, "âŒ request_info åº”ä¿ç•™ï¼ˆè™½ç„¶ä¸ä¼šè¢«è°ƒç”¨ï¼‰"
    assert "calculate_bazi" in tool_names, "âŒ calculate_bazi åº”ä¿ç•™ï¼ˆè™½ç„¶ä¸ä¼šè¢«è°ƒç”¨ï¼‰"
    print(f"  âœ“ å·¥å…·é›†å®Œæ•´ï¼ŒåŒ…å«æ‰€æœ‰é˜¶æ®µçš„å·¥å…·")

    # æ£€æŸ¥ SOP Prompt
    sop_rules = agent._build_sop_rules(context)
    print(f"\nâœ“ æ£€æŸ¥ SOP Prompt...")
    print(f"  é•¿åº¦: {len(sop_rules)} å­—ç¬¦")
    print(f"  çŠ¶æ€æç¤º:")
    print(f"    - åŒ…å« 'å¯ä»¥å¼€å§‹åˆ†æ': {('å¯ä»¥å¼€å§‹åˆ†æ' in sop_rules or 'å¯ä»¥åˆ†æ' in sop_rules)}")
    print(f"    - åŒ…å« 'å‘½ç›˜å·²ç”Ÿæˆ': {('å‘½ç›˜å·²ç”Ÿæˆ' in sop_rules or 'å·²ç”Ÿæˆå‘½ç›˜' in sop_rules)}")

    # æ£€æŸ¥ chart_summary æå–
    chart_summary = agent._extract_chart_summary(context)
    print(f"  å‘½ç›˜æ‘˜è¦: {chart_summary}")
    assert "æ—¥ä¸»" in chart_summary or "ç”²å­" in chart_summary, "âŒ å‘½ç›˜æ‘˜è¦æå–å¤±è´¥"

    print(f"\nâœ“ S3 æµ‹è¯•é€šè¿‡")
    print(f"  - LLM èƒ½è®¿é—®å®Œæ•´å·¥å…·é›† âœ“")
    print(f"  - SOP Prompt æ­£ç¡®æŒ‡å¯¼åˆ†æ âœ“")
    print(f"  - å‘½ç›˜æ‘˜è¦æ­£ç¡®æå– âœ“")


async def test_tool_accessibility_summary():
    """
    æ±‡æ€»æµ‹è¯•ï¼šéªŒè¯ v10 æ¶æ„ä¸‹çš„å·¥å…·å¯è®¿é—®æ€§

    éªŒè¯ç‚¹ï¼š
    1. æ‰€æœ‰é˜¶æ®µéƒ½è¿”å›å®Œæ•´å·¥å…·é›†
    2. ä¸å­˜åœ¨ Python ç¡¬ç¼–ç é™åˆ¶
    3. LLM å®Œå…¨ä¾èµ– SOP Prompt å†³ç­–
    """
    print_section("æ±‡æ€»æµ‹è¯•ï¼šå·¥å…·å¯è®¿é—®æ€§éªŒè¯")

    agent = CoreAgent(llm=get_llm_client(), max_iterations=5)

    # æµ‹è¯• 3 ä¸ªé˜¶æ®µçš„å·¥å…·é›†
    stages = [
        ("P1-æ— æ•°æ®", AgentContext(
            user_id="test", user_tier="premium",
            profile={"identity": {"birth_info": {}}},
            skill_data={},
            history=[], skill="bazi", conversation_id="test"
        )),
        ("P2-æœ‰ç”Ÿæ—¥", AgentContext(
            user_id="test", user_tier="premium",
            profile={"identity": {"birth_info": {"birth_date": "1990-01-01"}}},
            skill_data={},
            history=[], skill="bazi", conversation_id="test"
        )),
        ("P3-æœ‰å‘½ç›˜", AgentContext(
            user_id="test", user_tier="premium",
            profile={"identity": {"birth_info": {"birth_date": "1990-01-01"}}},
            skill_data={"bazi": {"chart": {"pillars": []}}},
            history=[], skill="bazi", conversation_id="test"
        ))
    ]

    print("\nâœ“ éªŒè¯å„é˜¶æ®µå·¥å…·é›†ä¸€è‡´æ€§...")
    tool_counts = []
    for stage_name, context in stages:
        tools = agent._get_current_tools(context)
        tool_names = [t["function"]["name"] for t in tools]
        tool_counts.append(len(tool_names))
        print(f"  {stage_name}: {len(tool_names)} ä¸ªå·¥å…·")

    # éªŒè¯æ‰€æœ‰é˜¶æ®µå·¥å…·æ•°é‡ç›¸åŒ
    assert len(set(tool_counts)) == 1, f"âŒ å·¥å…·é›†ä¸ä¸€è‡´ï¼š{tool_counts}"
    print(f"\nâœ“ æ‰€æœ‰é˜¶æ®µå·¥å…·é›†ä¸€è‡´ ({tool_counts[0]} ä¸ªå·¥å…·)")
    print(f"  âœ“ æ—  Python ç¡¬ç¼–ç é™åˆ¶")
    print(f"  âœ“ å®Œå…¨ç”± LLM æ ¹æ® SOP Prompt å†³ç­–")


async def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print_section("Phase 1: LLM é©±åŠ¨æ¶æ„æµ‹è¯•")
    print("æµ‹è¯•ç‰ˆæœ¬: v10")
    print("æµ‹è¯•ç›®æ ‡: éªŒè¯å·¥å…·é›†é™åˆ¶ç§»é™¤åçš„ LLM é©±åŠ¨è¡Œä¸º")

    try:
        await test_s1_no_data()
        await test_s2_with_birth_info()
        await test_s3_with_chart()
        await test_tool_accessibility_summary()

        print_section("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡")
        print("âœ“ Phase 1 æ”¹é€ æˆåŠŸ")
        print("âœ“ å·¥å…·é›†é™åˆ¶å·²å®Œå…¨ç§»é™¤")
        print("âœ“ LLM å¯æ ¹æ® SOP Prompt çµæ´»å†³ç­–")

        return 0

    except AssertionError as e:
        print(f"\nâŒ æµ‹è¯•å¤±è´¥: {e}")
        return 1

    except Exception as e:
        print(f"\nâŒ æµ‹è¯•é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
