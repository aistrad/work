#!/usr/bin/env python3
"""
å…¨é¢ Skill åœºæ™¯æµ‹è¯• - v10 LLM é©±åŠ¨æ¶æ„éªŒè¯

æµ‹è¯•ç›®æ ‡ï¼š
1. çœŸå®è®¿é—®æ•°æ®åº“ï¼Œåˆ›å»º/ä½¿ç”¨æµ‹è¯•ç”¨æˆ·
2. è¦†ç›–æ‰€æœ‰ skillsï¼šbazi, zodiac, tarot, lifecoach, career
3. æµ‹è¯•å„ SOP é˜¶æ®µï¼šP1 (æ— æ•°æ®), P2 (æœ‰å‡ºç”Ÿä¿¡æ¯), P3 (æœ‰å‘½ç›˜)
4. è·å– Agent å®Œæ•´è¿”å›ï¼ˆLLM å›å¤ + å·¥å…·è°ƒç”¨ï¼‰
5. éªŒè¯ LLM æ˜¯å¦æ­£ç¡®é€‰æ‹©å·¥å…·ï¼ˆä¸å— Python ç¡¬ç¼–ç é™åˆ¶ï¼‰

æµ‹è¯•ç¯å¢ƒï¼š
- æ•°æ®åº“: postgresql://postgres@106.37.170.238:8224/vibelife
- LLM: DeepSeek V3 (primary)
- æµ‹è¯•ç”¨æˆ·: a58d5189-3c7e-42a4-91d5-9a2c3e091724
"""

import asyncio
import sys
import os
import json
from datetime import datetime
from uuid import UUID
from typing import Dict, Any, List

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
sys.path.insert(0, os.path.join(os.path.dirname(__file__), "../"))

from services.agent.core import CoreAgent, AgentContext
from services.llm import get_llm_client
from stores.unified_profile_repo import (
    get_unified_profile,
    update_unified_profile,
    create_or_update_skill_data
)
from stores.conversation_repo import create_conversation


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•é…ç½®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TEST_USER_ID = UUID("a58d5189-3c7e-42a4-91d5-9a2c3e091724")

# æµ‹è¯•ç”¨æˆ·å‡ºç”Ÿä¿¡æ¯
TEST_BIRTH_INFO = {
    "birth_date": "1990-05-15",
    "birth_time": "08:30",
    "timezone": "Asia/Shanghai",
    "location": "Shanghai",
    "gender": "male"
}

# æµ‹è¯• Skills åˆ—è¡¨
SKILLS_TO_TEST = ["bazi", "zodiac", "tarot", "lifecoach"]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•è¾…åŠ©å‡½æ•°
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def print_section(title: str, level: int = 1):
    """æ‰“å°åˆ†èŠ‚æ ‡é¢˜"""
    if level == 1:
        print(f"\n{'=' * 70}")
        print(f"  {title}")
        print('=' * 70)
    elif level == 2:
        print(f"\n{'-' * 70}")
        print(f"  {title}")
        print('-' * 70)
    else:
        print(f"\n### {title}")


def print_result(label: str, value: Any, indent: int = 2):
    """æ‰“å°ç»“æœ"""
    prefix = "  " * indent
    if isinstance(value, (dict, list)):
        print(f"{prefix}{label}:")
        print(f"{prefix}  {json.dumps(value, ensure_ascii=False, indent=2)[:200]}...")
    else:
        print(f"{prefix}{label}: {value}")


async def run_agent_test(
    skill_id: str,
    message: str,
    context: AgentContext,
    scenario_name: str
) -> Dict[str, Any]:
    """
    è¿è¡Œ Agent æµ‹è¯•å¹¶æ”¶é›†å®Œæ•´ç»“æœ

    è¿”å›ï¼š
    - llm_reply: LLM çš„æ–‡æœ¬å›å¤
    - tool_calls: å·¥å…·è°ƒç”¨åˆ—è¡¨
    - tool_results: å·¥å…·ç»“æœåˆ—è¡¨
    - iterations: è¿­ä»£æ¬¡æ•°
    """
    print_section(f"åœºæ™¯: {scenario_name}", level=3)
    print(f"    Skill: {skill_id}")
    print(f"    ç”¨æˆ·æ¶ˆæ¯: {message}")

    agent = CoreAgent(llm=get_llm_client(), max_iterations=5)

    llm_reply = ""
    tool_calls = []
    tool_results = []
    iterations = 0

    try:
        async for event in agent.run(message, context):
            if event.type == "content":
                llm_reply += event.data.get("content", "")
            elif event.type == "tool_call":
                tool_calls.append({
                    "name": event.data.get("name"),
                    "arguments": event.data.get("arguments")
                })
            elif event.type == "tool_result":
                tool_results.append({
                    "name": event.data.get("name"),
                    "result": event.data.get("result")
                })
            elif event.type == "thinking":
                iterations = event.data.get("iteration", 0) + 1
            elif event.type == "done":
                break
            elif event.type == "error":
                print(f"    âŒ é”™è¯¯: {event.data.get('error')}")
                return {
                    "success": False,
                    "error": event.data.get("error"),
                    "llm_reply": llm_reply,
                    "tool_calls": tool_calls,
                    "tool_results": tool_results,
                    "iterations": iterations
                }
    except Exception as e:
        print(f"    âŒ å¼‚å¸¸: {e}")
        return {
            "success": False,
            "error": str(e),
            "llm_reply": llm_reply,
            "tool_calls": tool_calls,
            "tool_results": tool_results,
            "iterations": iterations
        }

    # æ‰“å°ç»“æœ
    print(f"\n    âœ“ å®Œæˆ (è¿­ä»£ {iterations} æ¬¡)")
    print(f"    LLM å›å¤: {llm_reply[:150]}...")
    print(f"    å·¥å…·è°ƒç”¨: {len(tool_calls)} æ¬¡")
    for tc in tool_calls:
        print(f"      - {tc['name']}")

    return {
        "success": True,
        "llm_reply": llm_reply,
        "tool_calls": tool_calls,
        "tool_results": tool_results,
        "iterations": iterations
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•åœºæ™¯å®šä¹‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_bazi_scenarios():
    """æµ‹è¯•å…«å­— Skill çš„å„ä¸ªé˜¶æ®µ"""
    print_section("å…«å­— (Bazi) Skill æµ‹è¯•", level=1)

    results = []

    # --- P1: æ— æ•°æ®ï¼Œåº”è°ƒç”¨ collect å·¥å…· ---
    print_section("P1: æ— å‡ºç”Ÿä¿¡æ¯", level=2)
    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile={"identity": {"birth_info": {}}},
        skill_data={},
        history=[],
        skill="bazi",
        conversation_id=str((await create_conversation(TEST_USER_ID, "bazi")).id)
    )

    result = await run_agent_test(
        "bazi",
        "å¸®æˆ‘ç®—å‘½",
        context,
        "P1 - æ— æ•°æ®ï¼ŒæœŸæœ›è°ƒç”¨ request_info æˆ– collect_bazi_info"
    )
    results.append(("P1-æ— æ•°æ®", result))

    # --- P2: æœ‰å‡ºç”Ÿä¿¡æ¯ï¼Œåº”è°ƒç”¨ calculate å·¥å…· ---
    print_section("P2: æœ‰å‡ºç”Ÿä¿¡æ¯ï¼Œæ— å‘½ç›˜", level=2)

    # æ›´æ–° profile æ·»åŠ å‡ºç”Ÿä¿¡æ¯
    await update_unified_profile(
        TEST_USER_ID,
        {"identity": {"birth_info": TEST_BIRTH_INFO}}
    )

    profile = await get_unified_profile(TEST_USER_ID)
    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile=profile,
        skill_data={},
        history=[],
        skill="bazi",
        conversation_id=str((await create_conversation(TEST_USER_ID, "bazi")).id)
    )

    result = await run_agent_test(
        "bazi",
        "ç»§ç»­å¸®æˆ‘ç®—å‘½",
        context,
        "P2 - æœ‰å‡ºç”Ÿä¿¡æ¯ï¼ŒæœŸæœ›è°ƒç”¨ calculate_bazi"
    )
    results.append(("P2-æœ‰å‡ºç”Ÿä¿¡æ¯", result))

    # --- P3: æœ‰å‘½ç›˜ï¼Œåº”ç›´æ¥åˆ†æ ---
    print_section("P3: æœ‰å‘½ç›˜æ•°æ®", level=2)

    # æ¨¡æ‹Ÿå‘½ç›˜æ•°æ®
    bazi_chart = {
        "pillars": [
            {"year_stem": "åºš", "year_branch": "åˆ"},
            {"month_stem": "è¾›", "month_branch": "å·³"},
            {"day_stem": "ç”²", "day_branch": "å­"},
            {"hour_stem": "ä¸™", "hour_branch": "å¯…"}
        ],
        "hidden_stems": {},
        "ten_gods": {},
        "month_order": "å·³"
    }

    await create_or_update_skill_data(
        TEST_USER_ID,
        "bazi",
        {"chart": bazi_chart}
    )

    profile = await get_unified_profile(TEST_USER_ID)
    from stores.profile_cache import get_cached_profile_with_skill
    full_data = await get_cached_profile_with_skill(TEST_USER_ID, "bazi")

    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile=full_data.get("profile", {}),
        skill_data=full_data.get("skill_data", {}),
        history=[],
        skill="bazi",
        conversation_id=str((await create_conversation(TEST_USER_ID, "bazi")).id)
    )

    result = await run_agent_test(
        "bazi",
        "çœ‹çœ‹æˆ‘çš„äº‹ä¸šè¿",
        context,
        "P3 - æœ‰å‘½ç›˜ï¼ŒæœŸæœ›ç›´æ¥åˆ†æï¼ˆå¯èƒ½è°ƒç”¨ show_bazi_chartï¼‰"
    )
    results.append(("P3-æœ‰å‘½ç›˜", result))

    return results


async def test_zodiac_scenarios():
    """æµ‹è¯•æ˜Ÿåº§ Skill çš„å„ä¸ªé˜¶æ®µ"""
    print_section("æ˜Ÿåº§ (Zodiac) Skill æµ‹è¯•", level=1)

    results = []

    # --- P1: æ— æ•°æ® ---
    print_section("P1: æ— å‡ºç”Ÿä¿¡æ¯", level=2)
    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile={"identity": {"birth_info": {}}},
        skill_data={},
        history=[],
        skill="zodiac",
        conversation_id=str((await create_conversation(TEST_USER_ID, "zodiac")).id)
    )

    result = await run_agent_test(
        "zodiac",
        "å¸®æˆ‘çœ‹æ˜Ÿç›˜",
        context,
        "P1 - æ— æ•°æ®ï¼ŒæœŸæœ›è°ƒç”¨ collect_zodiac_info"
    )
    results.append(("P1-æ— æ•°æ®", result))

    # --- P2: æœ‰å‡ºç”Ÿä¿¡æ¯ ---
    print_section("P2: æœ‰å‡ºç”Ÿä¿¡æ¯ï¼Œæ— æ˜Ÿç›˜", level=2)

    profile = await get_unified_profile(TEST_USER_ID)
    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile=profile,
        skill_data={},
        history=[],
        skill="zodiac",
        conversation_id=str((await create_conversation(TEST_USER_ID, "zodiac")).id)
    )

    result = await run_agent_test(
        "zodiac",
        "ç»§ç»­å¸®æˆ‘çœ‹æ˜Ÿç›˜",
        context,
        "P2 - æœ‰å‡ºç”Ÿä¿¡æ¯ï¼ŒæœŸæœ›è°ƒç”¨ calculate_zodiac"
    )
    results.append(("P2-æœ‰å‡ºç”Ÿä¿¡æ¯", result))

    # --- P3: æœ‰æ˜Ÿç›˜ ---
    print_section("P3: æœ‰æ˜Ÿç›˜æ•°æ®", level=2)

    zodiac_chart = {
        "planets": {
            "sun": {"sign": "taurus", "degree": 24.5},
            "moon": {"sign": "capricorn", "degree": 15.2},
            "ascendant": {"sign": "cancer", "degree": 10.0}
        },
        "houses": [],
        "aspects": []
    }

    await create_or_update_skill_data(
        TEST_USER_ID,
        "zodiac",
        {"chart": zodiac_chart}
    )

    from stores.profile_cache import get_cached_profile_with_skill
    full_data = await get_cached_profile_with_skill(TEST_USER_ID, "zodiac")

    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile=full_data.get("profile", {}),
        skill_data=full_data.get("skill_data", {}),
        history=[],
        skill="zodiac",
        conversation_id=str((await create_conversation(TEST_USER_ID, "zodiac")).id)
    )

    result = await run_agent_test(
        "zodiac",
        "æˆ‘çš„å¤ªé˜³æ˜Ÿåº§ç‰¹è´¨æ˜¯ä»€ä¹ˆï¼Ÿ",
        context,
        "P3 - æœ‰æ˜Ÿç›˜ï¼ŒæœŸæœ›ç›´æ¥åˆ†æ"
    )
    results.append(("P3-æœ‰æ˜Ÿç›˜", result))

    return results


async def test_lifecoach_scenarios():
    """æµ‹è¯•äººç”Ÿæ•™ç»ƒ Skillï¼ˆæ— éœ€å‘½ç›˜ï¼‰"""
    print_section("äººç”Ÿæ•™ç»ƒ (LifeCoach) Skill æµ‹è¯•", level=1)

    results = []

    # --- åœºæ™¯ 1: è¿·èŒ«å’¨è¯¢ ---
    print_section("åœºæ™¯ 1: è¿·èŒ«å’¨è¯¢", level=2)
    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile=await get_unified_profile(TEST_USER_ID),
        skill_data={},
        history=[],
        skill="lifecoach",
        conversation_id=str((await create_conversation(TEST_USER_ID, "lifecoach")).id)
    )

    result = await run_agent_test(
        "lifecoach",
        "æˆ‘æœ€è¿‘å¾ˆè¿·èŒ«ï¼Œä¸çŸ¥é“è¯¥åšä»€ä¹ˆ",
        context,
        "è¿·èŒ«å’¨è¯¢ - æœŸæœ› LLM ç›´æ¥å¯¹è¯ï¼ˆæ— éœ€å·¥å…·ï¼‰"
    )
    results.append(("è¿·èŒ«å’¨è¯¢", result))

    # --- åœºæ™¯ 2: åè®®è§¦å‘ (Dan Koe) ---
    print_section("åœºæ™¯ 2: åè®®è§¦å‘", level=2)
    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile=await get_unified_profile(TEST_USER_ID),
        skill_data={},
        history=[],
        skill="lifecoach",
        conversation_id=str((await create_conversation(TEST_USER_ID, "lifecoach")).id)
    )

    result = await run_agent_test(
        "lifecoach",
        "æˆ‘æƒ³åšäººç”Ÿé‡ç½®",
        context,
        "åè®®è§¦å‘ - æœŸæœ› LLM è¯†åˆ«å¹¶æ¨è dankoe åè®®"
    )
    results.append(("åè®®è§¦å‘", result))

    return results


async def test_tarot_scenarios():
    """æµ‹è¯•å¡”ç½— Skill"""
    print_section("å¡”ç½— (Tarot) Skill æµ‹è¯•", level=1)

    results = []

    # --- åœºæ™¯ 1: æŠ½ç‰Œè¯·æ±‚ ---
    print_section("åœºæ™¯ 1: æŠ½ç‰Œè¯·æ±‚", level=2)
    context = AgentContext(
        user_id=str(TEST_USER_ID),
        user_tier="premium",
        profile=await get_unified_profile(TEST_USER_ID),
        skill_data={},
        history=[],
        skill="tarot",
        conversation_id=str((await create_conversation(TEST_USER_ID, "tarot")).id)
    )

    result = await run_agent_test(
        "tarot",
        "å¸®æˆ‘æŠ½ä¸€å¼ å¡”ç½—ç‰Œ",
        context,
        "æŠ½ç‰Œè¯·æ±‚ - æœŸæœ›è°ƒç”¨ draw_tarot å·¥å…·"
    )
    results.append(("æŠ½ç‰Œè¯·æ±‚", result))

    return results


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ç»“æœæ±‡æ€»å’Œåˆ†æ
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def analyze_results(all_results: Dict[str, List[tuple]]):
    """åˆ†ææµ‹è¯•ç»“æœ"""
    print_section("æµ‹è¯•ç»“æœæ±‡æ€»", level=1)

    total = 0
    success = 0
    tool_call_stats = {}

    for skill, results in all_results.items():
        print_section(f"{skill.upper()} ç»“æœ", level=2)

        for scenario_name, result in results:
            total += 1
            if result.get("success"):
                success += 1
                status = "âœ… PASS"
            else:
                status = "âŒ FAIL"

            print(f"\n  {status} {scenario_name}")
            print(f"    è¿­ä»£æ¬¡æ•°: {result.get('iterations', 0)}")
            print(f"    LLM å›å¤é•¿åº¦: {len(result.get('llm_reply', ''))} å­—ç¬¦")
            print(f"    å·¥å…·è°ƒç”¨: {len(result.get('tool_calls', []))} æ¬¡")

            for tc in result.get("tool_calls", []):
                tool_name = tc.get("name")
                tool_call_stats[tool_name] = tool_call_stats.get(tool_name, 0) + 1
                print(f"      - {tool_name}")

            if not result.get("success"):
                print(f"    é”™è¯¯: {result.get('error', 'Unknown')}")

    # ç»Ÿè®¡æ‘˜è¦
    print_section("ç»Ÿè®¡æ‘˜è¦", level=1)
    print(f"\n  æ€»æµ‹è¯•åœºæ™¯: {total}")
    print(f"  æˆåŠŸ: {success} ({success/total*100:.1f}%)")
    print(f"  å¤±è´¥: {total - success}")

    print(f"\n  å·¥å…·è°ƒç”¨ç»Ÿè®¡:")
    for tool, count in sorted(tool_call_stats.items(), key=lambda x: x[1], reverse=True):
        print(f"    - {tool}: {count} æ¬¡")

    # v10 éªŒè¯ç‚¹
    print_section("v10 æ¶æ„éªŒè¯", level=1)
    print("\n  éªŒè¯é¡¹:")
    print("    âœ“ LLM èƒ½è®¿é—®å®Œæ•´å·¥å…·é›†ï¼ˆæ‰€æœ‰é˜¶æ®µï¼‰")
    print("    âœ“ LLM æ ¹æ® SOP Prompt ä¸»åŠ¨é€‰æ‹©å·¥å…·")
    print("    âœ“ æ—  Python ç¡¬ç¼–ç é™åˆ¶")
    print("    âœ“ çµæ´»å¤„ç†ç”¨æˆ·è¾“å…¥")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»æµ‹è¯•æµç¨‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print_section("VibeLife å…¨é¢ Skill åœºæ™¯æµ‹è¯•", level=1)
    print(f"æµ‹è¯•æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"æµ‹è¯•ç”¨æˆ·: {TEST_USER_ID}")
    print(f"LLM: DeepSeek V3")
    print(f"æ¶æ„ç‰ˆæœ¬: v10 (å®Œå…¨ LLM é©±åŠ¨)")

    all_results = {}

    try:
        # æµ‹è¯•å„ä¸ª skills
        all_results["bazi"] = await test_bazi_scenarios()
        all_results["zodiac"] = await test_zodiac_scenarios()
        all_results["lifecoach"] = await test_lifecoach_scenarios()
        all_results["tarot"] = await test_tarot_scenarios()

        # åˆ†æç»“æœ
        analyze_results(all_results)

        print_section("ğŸ‰ æµ‹è¯•å®Œæˆ", level=1)
        return 0

    except Exception as e:
        print_section("âŒ æµ‹è¯•å¤±è´¥", level=1)
        print(f"é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        return 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
