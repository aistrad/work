# VibeLife v5 核心改动分析

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║   ██╗   ██╗███████╗    ██████╗ ██████╗ ██████╗ ███████╗                      ║
║   ██║   ██║██╔════╝   ██╔════╝██╔═══██╗██╔══██╗██╔════╝                      ║
║   ██║   ██║███████╗   ██║     ██║   ██║██████╔╝█████╗                        ║
║   ╚██╗ ██╔╝╚════██║   ██║     ██║   ██║██╔══██╗██╔══╝                        ║
║    ╚████╔╝ ███████║   ╚██████╗╚██████╔╝██║  ██║███████╗                      ║
║     ╚═══╝  ╚══════╝    ╚═════╝ ╚═════╝ ╚═╝  ╚═╝╚══════╝                      ║
║                                                                              ║
║              从 现 状 到 v5 的 最 短 路 径                                   ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

> 基于深度访谈的核心改动分析，聚焦最小可行改动达成 v5 核心目标

---

## 执行摘要

### 核心目标
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                         提 升 用 户 留 存                                   │
│                                                                             │
│              Day 7 留存: ~20%  ────────────▶  35%                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 核心手段

**一句话**：让用户每天回来有"新东西"看，且这个东西是"懂我"的。

### 最小必要改动

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           必 须 做                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. 记忆系统 ──────────────▶ 让 AI "记住" 用户                            │
│                                                                             │
│   2. 每日内容生成 ──────────▶ 个性化今日运势/洞察                          │
│                                                                             │
│   3. 智能触发系统 ──────────▶ 关键节点（大运/流年）提醒                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           可 以 推 迟                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   * Web Push / 微信推送  ──▶ 先做 App 内通知即可                           │
│   * 三时段仪式（晨/午/夜）──▶ 先做每日一条                                 │
│   * L0-L3 四层订阅 ────────▶ 保持现有模式，微调即可                        │
│   * 完整 Identity Prism ──▶ 先做核心融合，3D 可视化推迟                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 现状 vs v5 差距分析

### 1.1 v5 规划的差距评估

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           差 距 评 估 矩 阵                                  │
├───────────────────────┬───────────────┬─────────────┬───────────────────────┤
│       v5 规划要求     │   当前状态    │  差距等级   │     实际优先级        │
├───────────────────────┼───────────────┼─────────────┼───────────────────────┤
│                       │               │             │                       │
│  六阶段用户旅程       │  单一漏斗     │  🔴 重大    │  ⬇️ 低（可推迟）      │
│                       │               │             │                       │
│  每日三仪式           │  无           │  🔴 重大    │  ⬆️ 高（简化为每日一条）│
│                       │               │             │                       │
│  长期记忆系统         │  基础存储     │  🟡 中等    │  ⬆️ 高（核心必做）    │
│                       │               │             │                       │
│  Identity Prism       │  无           │  🔴 重大    │  ⬆️ 高（简化版先做）  │
│                       │               │             │                       │
│  L0-L3 订阅模型       │  一次性       │  🟡 中等    │  ⬇️ 低（微调即可）    │
│                       │               │             │                       │
│  多维度融合对话       │  单技能       │  🟡 中等    │  ⬆️ 中（顺带做）      │
│                       │               │             │                       │
│  主动推送系统         │  无           │  🔴 重大    │  ⬇️ 低（App内通知优先）│
│                       │               │             │                       │
└───────────────────────┴───────────────┴─────────────┴───────────────────────┘
```

### 1.2 重新定义优先级

基于访谈结果，真正的优先级排序：

```
                    ┌───────────────────────────────┐
                    │                               │
           1st      │   记忆系统（用户信息持续抽取）│
                    │                               │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │                               │
           2nd      │   每日个性化内容生成          │
                    │                               │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │                               │
           3rd      │   智能触发（大运/流年节点）   │
                    │                               │
                    └───────────────┬───────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │                               │
           4th      │   多维度融合（Identity Prism）│
                    │                               │
                    └───────────────────────────────┘
```

---

## 2. 核心改动详解

### 2.1 改动一：记忆系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           记 忆 系 统                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   目的: 让 AI "记住" 用户，实现真正个性化                                  │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════  │
│                                                                             │
│   数据来源:                                                                 │
│   ┌─────────────────┐                                                       │
│   │  排盘数据       │ ───▶ 八字/星座基础信息、大运流年                     │
│   │  （已有）       │                                                       │
│   └─────────────────┘                                                       │
│                                                                             │
│   ┌─────────────────┐                                                       │
│   │  访谈数据       │ ───▶ 用户痛点、目标、关注领域                        │
│   │  （已有）       │                                                       │
│   └─────────────────┘                                                       │
│                                                                             │
│   ┌─────────────────┐                                                       │
│   │  对话抽取       │ ───▶ 从每次对话中提取关键事件/偏好/情绪             │
│   │  （需新增）     │                                                       │
│   └─────────────────┘                                                       │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   存储结构:                                                                 │
│   {                                                                         │
│     "user_id": "xxx",                                                       │
│     "dimensions": {                                                         │
│       "bazi": { ... },        // 八字原始数据 + 解读                       │
│       "zodiac": { ... },      // 星座原始数据 + 解读                       │
│     },                                                                      │
│     "portrait": {             // 用户画像（从访谈/对话抽取）               │
│       "concerns": [...],      // 关注领域                                  │
│       "goals": [...],         // 人生目标                                  │
│       "pain_points": [...],   // 当前痛点                                  │
│       "life_stage": "...",    // 人生阶段                                  │
│     },                                                                      │
│     "memories": [             // 对话记忆                                  │
│       {                                                                     │
│         "type": "event",      // event/preference/emotion/insight          │
│         "content": "...",                                                   │
│         "timestamp": "...",                                                 │
│         "source": "conversation_id"                                         │
│       }                                                                     │
│     ],                                                                      │
│     "life_events": [          // 生活事件                                  │
│       {                                                                     │
│         "date": "2026-02-14",                                               │
│         "type": "anniversary",                                              │
│         "title": "结婚纪念日",                                              │
│         "reminder_sent": false                                              │
│       }                                                                     │
│     ]                                                                       │
│   }                                                                         │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   技术实现:                                                                 │
│   1. 扩展现有 skill.py 中的 Message 模型，增加 extracted_memories 字段     │
│   2. 新增 MemoryExtractor 服务，在对话后异步提取关键信息                   │
│   3. 新增 user_memories 表存储抽取的记忆                                   │
│   4. 修改 ContextBuilder，将用户记忆纳入对话上下文                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**与现有系统的关系：**
- 现有 `services/knowledge/` 的 RAG 系统可以复用
- 现有 `services/vibe_engine/context.py` 的 ContextBuilder 需要扩展
- 现有 `services/extraction/` 可以参考其抽取逻辑

---

### 2.2 改动二：每日内容生成

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           每 日 内 容 生 成                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   目的: 用户每天打开有"新东西"看，且是"懂我"的                            │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════  │
│                                                                             │
│   内容结构:                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │    ☀️ 今日运势                                                     │  │
│   │                                                                     │  │
│   │    能量主题: 「突破」                                               │  │
│   │                                                                     │  │
│   │    今日可能遇到的情况:                                              │  │
│   │    根据你的八字日主偏弱，今天甲木透出，会有贵人相助的机会...        │  │
│   │    加上月亮进入你的第十宫，事业方面会有好消息...                    │  │
│   │                                                                     │  │
│   │    建议:                                                            │  │
│   │    * 适合谈判、争取资源                                             │  │
│   │    * 避免与长辈/权威冲突                                            │  │
│   │                                                                     │  │
│   │    💡 小提醒: 你上次提到想换工作，今天可能是个好时机...             │  │
│   │                                                                     │  │
│   │                                    [开始对话]                       │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   生成时机:                                                                 │
│   * 每日凌晨 4:00 批量生成（异步 Worker）                                  │
│   * 用户打开 App 时实时展示                                                │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   技术实现:                                                                 │
│   1. 新增 DailyFortuneService，负责生成每日运势内容                        │
│   2. 新增 daily_fortunes 表存储生成的内容                                  │
│   3. 新增定时任务 Worker（可复用现有 workers/ 框架）                       │
│   4. 前端新增首页"今日运势"卡片                                           │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   成本控制:                                                                 │
│   * 仅为付费用户生成个性化内容（需要调用 LLM）                             │
│   * 免费用户展示通用内容（基于当日天象/节气）                              │
│   * 可以用较便宜的模型（如 GLM-4-Flash）生成                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**与现有系统的关系：**
- 现有 `services/fortune/` 的运势计算可以复用
- 现有 `services/greeting/` 的问候逻辑可以参考
- 现有 `workers/` 框架可以复用

---

### 2.3 改动三：智能触发系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           智 能 触 发 系 统                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   目的: 在关键时间节点主动提供价值，而不只是每天推送                       │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════  │
│                                                                             │
│   触发类型:                                                                 │
│                                                                             │
│   1. 大运/流年节点                                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  * 大运交接前 30 天、7 天、当天                                     │  │
│   │  * 流年开始（立春前后）                                             │  │
│   │  * 本命年开始                                                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   2. 星象事件                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  * 水逆开始/结束                                                    │  │
│   │  * 日/月食（与本命盘有相位）                                        │  │
│   │  * 土星/木星过境本命行星                                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   3. 用户生活事件                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  * 生日提前 7 天、当天                                              │  │
│   │  * 用户记录的重要日期（从对话中抽取）                               │  │
│   │  * 用户设置的提醒事项                                               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   展示方式:                                                                 │
│   * App 首页显示「重要提醒」徽章                                           │
│   * 点击进入详情页，展示专属分析                                           │
│   * 引导进入对话，深入讨论                                                 │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   技术实现:                                                                 │
│   1. 新增 EventTriggerService，计算每个用户的关键节点                      │
│   2. 新增 triggered_events 表记录触发状态                                  │
│   3. 每日凌晨 Worker 扫描即将到来的事件                                    │
│   4. 前端首页增加「重要事件」入口                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**与现有系统的关系：**
- 现有 `services/fortune/kline.py` 已经有大运/流年计算
- 现有 `tools/zodiac/events.py` 已经有星象事件计算
- 只需要整合 + 添加触发逻辑

---

### 2.4 改动四：多维度融合（Identity Prism）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           多 维 度 融 合 (Identity Prism)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   目的: 将八字/星座等多个维度融合成统一的用户画像                          │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════  │
│                                                                             │
│   核心概念:                                                                 │
│                                                                             │
│                         ┌─────────────┐                                     │
│                         │             │                                     │
│                         │     你      │                                     │
│                         │             │                                     │
│                         └──────┬──────┘                                     │
│                                │                                            │
│            ┌───────────────────┼───────────────────┐                       │
│            │                   │                   │                       │
│            ▼                   ▼                   ▼                       │
│     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                │
│     │   核心本质  │     │   内在自我  │     │   外在表现  │                │
│     │   (Core)    │     │   (Inner)   │     │   (Outer)   │                │
│     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘                │
│            │                   │                   │                       │
│            ▼                   ▼                   ▼                       │
│     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                │
│     │ 八字日主格局│     │ 月亮/上升   │     │ 八字外格    │                │
│     │ 太阳星座    │     │ 八字印比    │     │ 星座外行星  │                │
│     └─────────────┘     └─────────────┘     └─────────────┘                │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   MVP 版本（先做）:                                                         │
│   * 生成文字版的融合画像（不需要 3D 可视化）                               │
│   * 在对话中自动引用多个维度                                               │
│   * 在报告中展示融合分析                                                   │
│                                                                             │
│   完整版本（后做）:                                                         │
│   * 3D 棱镜可视化                                                          │
│   * 维度解锁进度条                                                         │
│   * 交互式探索                                                             │
│                                                                             │
│   ───────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   技术实现:                                                                 │
│   1. 新增 identity_prism 表存储融合画像                                    │
│   2. 新增 PrismGenerator 服务，基于多维度数据生成融合画像                  │
│   3. 修改 ContextBuilder，将 Prism 纳入对话上下文                          │
│   4. 前端新增「身份画像」页面（简化版先文字展示）                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**与现有系统的关系：**
- 现有 `services/vibe_engine/portrait.py` 已经有 PortraitService
- 只需要扩展为多维度融合版本

---

## 3. 商业模式（简化版）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           商 业 模 式 调 整                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   基于访谈，采用混合模式而非完整 L0-L3:                                    │
│                                                                             │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                    │
│   │             │    │             │    │             │                    │
│   │    免费     │    │  普通付费   │    │  高端付费   │                    │
│   │   ¥0       │    │   ¥29.9    │    │   ¥59.9    │                    │
│   │             │    │             │    │             │                    │
│   ├─────────────┤    ├─────────────┤    ├─────────────┤                    │
│   │             │    │             │    │             │                    │
│   │ * 基础排盘  │    │ * 完整报告  │    │ * 完整报告  │                    │
│   │ * 卷首语    │    │ * 每日运势  │    │ * 每日运势  │                    │
│   │ * 3次对话/日│    │ * 10次对话  │    │ * 无限对话  │                    │
│   │             │    │ * 关系分析  │    │ * 关系分析  │                    │
│   │             │    │             │    │ * 优先客服  │                    │
│   │             │    │             │    │             │                    │
│   └─────────────┘    └─────────────┘    └─────────────┘                    │
│                                                                             │
│   转化路径:                                                                 │
│   新用户 ──▶ 免费体验 ──▶ 购买报告礼包 ──▶ 赠送 1 个月会员体验            │
│                              ¥29.9              ▶ 续费 ¥29.9/月            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 实施路线图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           实 施 路 线 图                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Sprint 1: 记忆系统基础                                                    │
│   ────────────────────────────────────────────────────────────────────     │
│   [ ] 新增 user_memories 数据表                                            │
│   [ ] 实现 MemoryExtractor 服务（从对话中抽取关键信息）                    │
│   [ ] 修改 ContextBuilder，整合记忆到上下文                                │
│   [ ] 测试对话中是否能"记住"用户                                          │
│                                                                             │
│   Sprint 2: 每日内容生成                                                    │
│   ────────────────────────────────────────────────────────────────────     │
│   [ ] 新增 daily_fortunes 数据表                                           │
│   [ ] 实现 DailyFortuneService                                             │
│   [ ] 新增定时生成 Worker                                                  │
│   [ ] 前端首页增加「今日运势」卡片                                         │
│                                                                             │
│   Sprint 3: 智能触发                                                        │
│   ────────────────────────────────────────────────────────────────────     │
│   [ ] 整合现有大运/流年/星象事件计算                                       │
│   [ ] 新增 triggered_events 数据表                                         │
│   [ ] 实现事件触发 Worker                                                  │
│   [ ] 前端增加「重要事件」入口                                             │
│                                                                             │
│   Sprint 4: 多维度融合                                                      │
│   ────────────────────────────────────────────────────────────────────     │
│   [ ] 新增 identity_prism 数据表                                           │
│   [ ] 实现 PrismGenerator（文字版）                                        │
│   [ ] 修改对话系统，自动引用多维度                                         │
│   [ ] 前端新增「身份画像」页面                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据表变更清单

```sql
-- 1. 用户记忆表
CREATE TABLE user_memories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),
    memory_type VARCHAR(30) NOT NULL,  -- event/preference/emotion/insight
    content TEXT NOT NULL,
    context JSONB,
    source_conversation_id UUID,
    importance_score FLOAT DEFAULT 0.5,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. 每日运势表
CREATE TABLE daily_fortunes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),
    fortune_date DATE NOT NULL,
    content JSONB NOT NULL,  -- energy_theme, prediction, advice, reminder
    generated_at TIMESTAMP DEFAULT NOW(),
    viewed_at TIMESTAMP,
    UNIQUE(user_id, fortune_date)
);

-- 3. 触发事件表
CREATE TABLE triggered_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),
    event_type VARCHAR(30) NOT NULL,  -- dayun/liunian/transit/birthday/custom
    event_date DATE NOT NULL,
    title VARCHAR(255),
    content JSONB,
    is_sent BOOLEAN DEFAULT false,
    is_viewed BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT NOW()
);

-- 4. Identity Prism 表
CREATE TABLE identity_prism (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),
    core_essence JSONB,      -- 核心本质
    inner_self JSONB,        -- 内在自我
    outer_expression JSONB,  -- 外在表现
    source_dimensions JSONB, -- 来源维度列表
    version INTEGER DEFAULT 1,
    generated_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, version)
);
```

---

## 6. 成功指标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           成 功 指 标                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   核心指标                      当前              目标              提升    │
│   ─────────────────────────────────────────────────────────────────────    │
│                                                                             │
│   Day 7 留存                   ~20%    ────▶     35%              +75%    │
│   ████████░░░░░░░░░░░░░░░░░░░  ██████████████░░░░░░░░░░░░░░░░░░░░░         │
│                                                                             │
│   每日打开率（付费用户）       N/A     ────▶     40%              新增    │
│   ░░░░░░░░░░░░░░░░░░░░░░░░░░░  ████████████████░░░░░░░░░░░░░░░░░░          │
│                                                                             │
│   今日运势查看率               N/A     ────▶     60%              新增    │
│   ░░░░░░░░░░░░░░░░░░░░░░░░░░░  ████████████████████████░░░░░░░░░░          │
│                                                                             │
│   对话中记忆引用率             0%      ────▶     50%              新增    │
│   ░░░░░░░░░░░░░░░░░░░░░░░░░░░  ████████████████████░░░░░░░░░░░░░░          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 核心结论

```
╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║   从当前系统到 v5 的最短路径：                                              ║
║                                                                              ║
║   ┌────────────────────────────────────────────────────────────────────┐   ║
║   │                                                                    │   ║
║   │   不是做"仪式系统"                                                 │   ║
║   │                                                                    │   ║
║   │   而是让 AI "记住" 用户 + 每天给他一个"回来的理由"                │   ║
║   │                                                                    │   ║
║   └────────────────────────────────────────────────────────────────────┘   ║
║                                                                              ║
║   技术上：                                                                   ║
║   1. 记忆系统（让 AI 有记忆）                                               ║
║   2. 每日内容（让用户有理由回来）                                           ║
║   3. 智能触发（在关键节点提供价值）                                         ║
║   4. 维度融合（差异化体验）                                                 ║
║                                                                              ║
║   商业上：                                                                   ║
║   先不大改，保持 29.9/59.9 + 送会员体验的混合模式                           ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

---

*文档版本: v5.ultrathink*
*创建日期: 2026-01-10*
*基于深度访谈结果*
