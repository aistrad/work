"use client";

/**
 * SmartSuggestions - æ™ºèƒ½æ¨è Chips
 *
 * æç®€è®¾è®¡ï¼Œæ¨ªå‘æ»šåŠ¨ï¼Œæ”¾åœ¨ ChatInput ä¸Šæ–¹
 * åŸºäºç”¨æˆ·æ•°æ®æ™ºèƒ½ç”Ÿæˆæ¨èï¼ˆskill + è¯é¢˜ï¼‰
 */

import { useMemo } from "react";
import { cn } from "@/lib/utils";
import type { DashboardDTO } from "@/types/dashboard";

interface Suggestion {
  id: string;
  icon: string;
  label: string;
  prompt: string;
  skill?: string;
}

interface SmartSuggestionsProps {
  dashboardData?: DashboardDTO | null;
  onSelect: (prompt: string) => void;
  className?: string;
}

export function SmartSuggestions({
  dashboardData,
  onSelect,
  className,
}: SmartSuggestionsProps) {
  const suggestions = useMemo(() => {
    const items: Suggestion[] = [];
    const hour = new Date().getHours();

    // 1. å¾…åŠé©±åŠ¨ï¼šæœ‰æœªå®Œæˆçš„ todayLevers
    const pendingLevers = dashboardData?.lifecoach?.todayLevers?.filter(
      (l) => !l.completed
    );
    if (pendingLevers && pendingLevers.length > 0) {
      const firstLever = pendingLevers[0];
      items.push({
        id: "focus",
        icon: "ğŸ¯",
        label: firstLever.text.length > 12
          ? firstLever.text.slice(0, 12) + "â€¦"
          : firstLever.text,
        prompt: `å¸®æˆ‘å®Œæˆï¼š${firstLever.text}`,
        skill: "lifecoach",
      });
    }

    // 2. æ—¶é—´é©±åŠ¨ï¼šæ—©ä¸Šè§„åˆ’ï¼Œæ™šä¸Šå¤ç›˜
    if (hour >= 5 && hour < 12) {
      items.push({
        id: "plan",
        icon: "ğŸŒ…",
        label: "è§„åˆ’ä»Šå¤©",
        prompt: "å¸®æˆ‘è§„åˆ’ä»Šå¤©çš„é‡ç‚¹ä»»åŠ¡",
        skill: "lifecoach",
      });
    } else if (hour >= 18 || hour < 5) {
      items.push({
        id: "review",
        icon: "ğŸŒ™",
        label: "å¤ç›˜ä»Šå¤©",
        prompt: "å¸®æˆ‘å¤ç›˜ä»Šå¤©çš„è¿›å±•",
        skill: "lifecoach",
      });
    }

    // 3. è¿åŠ¿é©±åŠ¨ï¼šå…«å­—æ•°æ®
    const hasBazi = dashboardData?.mySkills?.some((s) => s.skillId === "bazi");
    if (hasBazi) {
      items.push({
        id: "fortune",
        icon: "ğŸŒŸ",
        label: "ä»Šæ—¥è¿åŠ¿",
        prompt: "å¸®æˆ‘çœ‹çœ‹ä»Šå¤©çš„è¿åŠ¿",
        skill: "bazi",
      });
    }

    // 4. ç›®æ ‡é©±åŠ¨ï¼šæœ‰ northStar
    if (dashboardData?.lifecoach?.northStar) {
      const weekRocks = dashboardData?.lifecoach?.weekRocks || [];
      const pendingRocks = weekRocks.filter((r) => !r.completed);
      if (pendingRocks.length > 0) {
        items.push({
          id: "progress",
          icon: "ğŸ“Š",
          label: "æœ¬å‘¨è¿›åº¦",
          prompt: "å¸®æˆ‘å›é¡¾æœ¬å‘¨ç›®æ ‡çš„è¿›åº¦",
          skill: "lifecoach",
        });
      }
    }

    // 5. é»˜è®¤å…œåº•
    items.push({
      id: "chat",
      icon: "ğŸ’¬",
      label: "éšä¾¿èŠèŠ",
      prompt: "å—¨",
    });

    // æœ€å¤šæ˜¾ç¤º 4 ä¸ª
    return items.slice(0, 4);
  }, [dashboardData]);

  if (suggestions.length === 0) {
    return null;
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-2 lg:gap-3 px-4 py-2 lg:py-3 overflow-x-auto scrollbar-hide",
        "max-w-3xl xl:max-w-4xl 2xl:max-w-5xl mx-auto",
        className
      )}
    >
      {suggestions.map((suggestion) => (
        <button
          key={suggestion.id}
          onClick={() => onSelect(suggestion.prompt)}
          className={cn(
            "flex items-center gap-1.5 lg:gap-2 px-3 lg:px-4 py-1.5 lg:py-2 rounded-full",
            "bg-card/80 hover:bg-card",
            "text-xs lg:text-sm text-foreground whitespace-nowrap",
            "border border-border/60 hover:border-border",
            // Enhanced: subtle shadow + micro-interaction
            "shadow-sm hover:shadow-md",
            "transition-all duration-200 ease-out",
            "hover:scale-[1.02] active:scale-[0.98]",
            "flex-shrink-0"
          )}
        >
          <span className="lg:text-base">{suggestion.icon}</span>
          <span>{suggestion.label}</span>
        </button>
      ))}
    </div>
  );
}

export default SmartSuggestions;
