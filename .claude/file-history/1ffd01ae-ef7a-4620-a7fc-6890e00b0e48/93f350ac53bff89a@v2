#!/bin/bash
# VibeLife 测试环境启动脚本 v2.0

set -e

cd /home/aiscend/work/vibelife

# 启动后端
echo "Starting API on port 8100..."
cd apps/api
source venv/bin/activate
nohup uvicorn main:app --host 0.0.0.0 --port 8100 > /tmp/vibelife-api.log 2>&1 &
API_PID=$!
echo "API PID: $API_PID"

# 等待 API 启动
sleep 3

# 启动前端 (生产模式)
echo "Starting Web on port 8232 (production mode)..."
cd ../web

# 检查是否需要重新构建
if [ ! -d ".next" ] || [ "$(find src -newer .next -type f | head -1)" ]; then
    echo "Building frontend..."
    pnpm build
fi

nohup pnpm start -H 0.0.0.0 -p 8232 > /tmp/vibelife-web-8232.log 2>&1 &
WEB_PID=$!
echo "Web PID: $WEB_PID"

# 等待服务启动
sleep 5

echo ""
echo "=== VibeLife Test Environment ==="
echo "API: http://106.37.170.238:8100"
echo "Web: http://106.37.170.238:8232"
echo ""
echo "Health Check:"
curl -s http://localhost:8100/health | head -1 || echo "API not ready"
curl -s -o /dev/null -w "Web: %{http_code}\n" http://localhost:8232 || echo "Web not ready"
echo ""
echo "Logs:"
echo "  API: tail -f /tmp/vibelife-api.log"
echo "  Web: tail -f /tmp/vibelife-web-8232.log"
