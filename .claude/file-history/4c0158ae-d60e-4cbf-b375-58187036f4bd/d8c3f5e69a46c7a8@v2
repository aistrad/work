# V9 LLM-First 架构落地计划

## 核心问题

routing.yaml 与 V9 架构设计存在根本矛盾：
- V9 要求"单一事实源在各 Skill 的 SKILL.md"
- 当前 routing.yaml 重复定义了 skills/protocols/sop_templates

## 目标状态（V9 完整落地）

### 1. 删除/迁移的配置

| 配置项 | 处理方式 |
|--------|---------|
| `protocols` | → lifecoach/rules/*.md |
| `skills` | 删除（从 SKILL.md 解析） |
| `sop_templates` | → 各 Skill/rules/*.md |
| `welcome` | 删除（可内置极简） |
| `boundary_rules` | → core/rules/boundary.md 或 SKILL.md |

### 2. 代码改动

**skill_loader.py**
- `load_all_skill_metas()`: 从 `skills/*/SKILL.md` frontmatter 解析
- 缓存 + 版本控制 + 文件监听（可选）

**prompt_builder.py**
- Phase 1: Core 精简文本 + Skill metas 列表
- 不再从 routing.yaml 读取 phase1_prompt

**core.py**
- Phase 1 工具: 仅 activate_skills, ask, show
- 移除 show_skill_intro / recommend_skills / show_protocol_invitation

### 3. 订阅同步机制

```
写入: save(path="preferences.subscribed_skills.{id}", data={...})
      ↓
服务端 handler 同时写 DB (user_skill_subscriptions)
      ↓
跨设备同步

读取: Phase 1 构建时从 profile.preferences.subscribed_skills 过滤排序
```

## 待确认问题

1. **协议迁移优先级**：lifecoach 的 dankoe/covey/yangming/liaofan 现在迁移，还是后续单独处理？

2. **Phase 1 工具精简**：是否现在就移除 show_skill_intro/recommend_skills，改为 show(type=skill_list/recommendation)？

3. **回滚策略**：是否需要保留 routing.yaml 作为 fallback，还是直接删除？

4. **boundary_rules 位置**：放 Core SKILL.md 内，还是 core/rules/boundary.md？

## 迁移步骤

### Phase 1: 最小化 routing.yaml（兼容过渡）

1. 删除 protocols/skills/sop_templates/welcome
2. 仅保留 boundary_rules（如果选择保留在 yaml）
3. prompt_builder 保持回退逻辑

### Phase 2: skill_loader 索引实现

1. `parse_skill_md()` 增强：提取 frontmatter 完整字段
2. `load_all_skill_metas()` 遍历 skills/ 目录
3. 内存缓存 + 启动时初始化

### Phase 3: prompt_builder 重构

1. `build_phase1_prompt(profile)`: Core 精简 + Skill metas
2. 移除对 routing_config 的依赖

### Phase 4: Phase 1 工具精简

1. 移除 show_skill_intro/recommend_skills
2. 统一通过 show(type=skill_list|recommendation) 实现

### Phase 5: 协议迁移

1. lifecoach/rules/ 新建协议文件
2. 通过 show(type=card, card_type=protocol_invitation) 展示

## 验证方式

- E2E: "帮我看星座" → Phase 1 activate_skills(["zodiac"]) → Phase 2 执行
- E2E: "我能做什么" → show(type="skill_list")
- E2E: "推荐适合我的" → show(type="recommendation")
- 协议: "Dan Koe" → lifecoach 激活 → 展示协议卡片

## 关键文件

- `apps/api/skills/core/config/routing.yaml` - 删除或极简化
- `apps/api/services/agent/skill_loader.py` - 索引实现
- `apps/api/services/agent/prompt_builder.py` - Phase 1 重构
- `apps/api/services/agent/core.py` - 工具精简
- `apps/api/skills/lifecoach/rules/*.md` - 协议迁移目标
