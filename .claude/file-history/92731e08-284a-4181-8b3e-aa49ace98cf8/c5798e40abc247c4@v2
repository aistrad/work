'use client'

/**
 * Settings Page - v6.0 ç»Ÿä¸€å¸ƒå±€ç‰ˆ
 *
 * v6.0 å˜æ›´:
 * - ä½¿ç”¨ä¸ Chat é¡µç›¸åŒçš„ NavBar ç»„ä»¶ï¼Œä¿æŒå·¦ä¾§æ ä¸€è‡´æ€§
 * - ç§»é™¤ PCLayoutï¼Œä½¿ç”¨è‡ªå®šä¹‰å¸ƒå±€
 * - ä¿®å¤é€€å‡ºç™»å½•åŠŸèƒ½
 *
 * PCç«¯å¸ƒå±€: NavBar + è®¾ç½®èœå• + è®¾ç½®å†…å®¹
 * ç§»åŠ¨ç«¯å¸ƒå±€: å•æ è®¾ç½®åˆ—è¡¨
 */

import { useState, useEffect, useCallback, memo, useMemo } from 'react'
import { useRouter } from 'next/navigation'
import { NavBar } from '@/components/layout/NavBar'
import { MobileHeader } from '@/components/layout/MobileHeader'
import { BirthDateInputs } from '@/components/ui/Input'
import { getLocalStorageJSON, getAccessToken, setLocalStorageJSON, invalidateStorageCache } from '@/utils/storage'
import { AccountDeletionSection } from '@/components/settings/AccountDeletionSection'
import { SkillCard } from '@/components/skill'
import { useSkillSubscription, useSkills } from '@/hooks/useSkillSubscription'
import { useAuth } from '@/providers/AuthProvider'
import { cn } from '@/lib/utils'

// Use Next.js API routes for server communication to avoid exposing backend URL
const API_BASE = '/api'

const SETTINGS_MENU = [
  { id: 'profile', icon: 'ğŸ‘¤', label: 'ä¸ªäººèµ„æ–™' },
  { id: 'skills', icon: 'ğŸ¯', label: 'Skill ç®¡ç†' },
  { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥è®¾ç½®' },
  { id: 'privacy', icon: 'ğŸ”', label: 'éšç§ä¸å®‰å…¨' },
  { id: 'membership', icon: 'ğŸ’', label: 'ä¼šå‘˜ç®¡ç†' },
  { id: 'memory', icon: 'ğŸ§ ', label: 'è®°å¿†ç®¡ç†' },
  { id: 'preferences', icon: 'âš™ï¸', label: 'åå¥½è®¾ç½®' },
  { id: 'account', icon: 'âš ï¸', label: 'è´¦æˆ·ç®¡ç†' },
  { id: 'help', icon: 'â“', label: 'å¸®åŠ©ä¸åé¦ˆ' },
  { id: 'about', icon: 'ğŸ“„', label: 'å…³äº' },
]

interface UserProfile {
  nickname: string
  email: string
  avatar: string
  birthDate: string
  birthTime: string
  timezone: string
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Skill ç®¡ç†åŒºå—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function SkillSettingsSection({ router }: { router: ReturnType<typeof useRouter> }) {
  const { skills } = useSkills()
  const { subscriptions, togglePush, unsubscribe, userStatuses } = useSkillSubscription()

  // åˆ†ç»„
  const { subscribed, available } = useMemo(() => {
    const subscribedIds = new Set(
      subscriptions.filter(s => s.status === 'subscribed').map(s => s.skill_id)
    )
    return {
      subscribed: skills.filter(s => subscribedIds.has(s.id)),
      available: skills.filter(s => !subscribedIds.has(s.id) && s.category !== 'core'),
    }
  }, [skills, subscriptions])

  const handleTogglePush = async (skillId: string, enabled: boolean) => {
    try {
      await togglePush(skillId, enabled)
    } catch (err) {
      console.error('Toggle push failed:', err)
    }
  }

  const handleUnsubscribe = async (skillId: string) => {
    try {
      await unsubscribe(skillId)
    } catch (err) {
      console.error('Unsubscribe failed:', err)
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="font-serif text-xl text-text-primary">Skill ç®¡ç†</h2>
        <button
          onClick={() => router.push('/skills')}
          className="text-sm text-accent hover:underline"
        >
          æ¢ç´¢æ›´å¤š â†’
        </button>
      </div>

      {/* å·²è®¢é˜… */}
      <div>
        <h3 className="text-sm font-medium text-text-secondary mb-3">
          å·²è®¢é˜… ({subscribed.length})
        </h3>
        <div className="space-y-2">
          {subscribed.map((skill) => {
            const sub = subscriptions.find(s => s.skill_id === skill.id)
            const isCore = skill.category === 'core'
            return (
              <div key={skill.id} className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)]">
                <div
                  className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
                  style={{ backgroundColor: `${skill.color}20` }}
                >
                  {skill.icon}
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <span className="font-medium text-text-primary">{skill.name}</span>
                    {isCore && (
                      <span className="px-1.5 py-0.5 text-xs rounded bg-accent/10 text-accent">
                        å§‹ç»ˆæ¿€æ´»
                      </span>
                    )}
                  </div>
                  <p className="text-xs text-text-secondary truncate">
                    {skill.features?.slice(0, 2).map(f => f.name).join(' Â· ')}
                  </p>
                </div>
                {!isCore && (
                  <div className="flex items-center gap-3">
                    <div className="flex items-center gap-2">
                      <span className="text-xs text-text-tertiary">æ¨é€</span>
                      <label className="relative inline-flex items-center cursor-pointer">
                        <input
                          type="checkbox"
                          checked={sub?.push_enabled ?? false}
                          onChange={(e) => handleTogglePush(skill.id, e.target.checked)}
                          className="sr-only peer"
                        />
                        <div className="w-9 h-5 bg-[var(--bg-secondary)] peer-focus:ring-2 peer-focus:ring-accent/50 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-accent" />
                      </label>
                    </div>
                    <button
                      onClick={() => handleUnsubscribe(skill.id)}
                      className="text-xs text-error hover:underline"
                    >
                      å–æ¶ˆ
                    </button>
                  </div>
                )}
              </div>
            )
          })}
        </div>
      </div>

      {/* å¯è®¢é˜… */}
      {available.length > 0 && (
        <div>
          <h3 className="text-sm font-medium text-text-secondary mb-3">
            å¯è®¢é˜… ({available.length})
          </h3>
          <div className="space-y-2">
            {available.slice(0, 3).map((skill) => (
              <div
                key={skill.id}
                onClick={() => router.push(`/skills/${skill.id}`)}
                className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)] cursor-pointer hover:bg-[var(--bg-secondary)] transition-colors"
              >
                <div
                  className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
                  style={{ backgroundColor: `${skill.color}20` }}
                >
                  {skill.icon}
                </div>
                <div className="flex-1 min-w-0">
                  <span className="font-medium text-text-primary">{skill.name}</span>
                  <p className="text-xs text-text-secondary truncate">
                    {skill.showcase?.tagline || skill.description}
                  </p>
                </div>
                <button className="px-3 py-1 text-xs rounded-full bg-accent text-white">
                  è®¢é˜…
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é€šçŸ¥è®¾ç½®åŒºå— - ä½¿ç”¨ Skill çº§åˆ«çš„æ¨é€è®¾ç½®
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function NotificationSettingsSection() {
  const { skills } = useSkills()
  const { subscriptions, togglePush } = useSkillSubscription()

  // åªæ˜¾ç¤ºå·²è®¢é˜…çš„ Skills çš„æ¨é€è®¾ç½®
  const subscribedSkills = useMemo(() => {
    const subscribedIds = new Set(
      subscriptions.filter(s => s.status === 'subscribed').map(s => s.skill_id)
    )
    return skills.filter(s => subscribedIds.has(s.id))
  }, [skills, subscriptions])

  const handleTogglePush = async (skillId: string, enabled: boolean) => {
    try {
      await togglePush(skillId, enabled)
    } catch (err) {
      console.error('Toggle push failed:', err)
    }
  }

  return (
    <div className="space-y-6">
      <h2 className="font-serif text-xl text-text-primary">é€šçŸ¥è®¾ç½®</h2>
      <p className="text-sm text-text-secondary">
        ç®¡ç†ä½ è®¢é˜…çš„ Skills çš„æ¨é€é€šçŸ¥ã€‚
      </p>

      {subscribedSkills.length === 0 ? (
        <div className="text-center py-8 text-text-secondary">
          <p>æš‚æ— å·²è®¢é˜…çš„ Skill</p>
          <p className="text-sm mt-2">è®¢é˜… Skill åå¯åœ¨æ­¤ç®¡ç†æ¨é€é€šçŸ¥</p>
        </div>
      ) : (
        <div className="space-y-3">
          {subscribedSkills.map((skill) => {
            const sub = subscriptions.find(s => s.skill_id === skill.id)
            return (
              <div key={skill.id} className="flex items-center justify-between p-4 bg-[var(--bg-card-alt)] rounded-lg">
                <div className="flex items-center gap-3">
                  <div
                    className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
                    style={{ backgroundColor: `${skill.color}20` }}
                  >
                    {skill.icon}
                  </div>
                  <div>
                    <p className="text-text-primary font-medium">{skill.name}</p>
                    <p className="text-sm text-text-secondary">æ¥æ”¶ {skill.name} ç›¸å…³æ¨é€</p>
                  </div>
                </div>
                <label className="relative inline-flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    checked={sub?.push_enabled ?? false}
                    onChange={(e) => handleTogglePush(skill.id, e.target.checked)}
                    className="sr-only peer"
                  />
                  <div className="w-11 h-6 bg-[var(--bg-secondary)] peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                </label>
              </div>
            )
          })}
        </div>
      )}

      <div className="pt-4 border-t border-[var(--border-light)]">
        <p className="text-xs text-text-tertiary">
          æ¨é€é€šçŸ¥ç”¨äºæé†’ä½ é‡è¦çš„è¿åŠ¿å˜åŒ–å’Œä¸ªæ€§åŒ–å»ºè®®ã€‚ä½ å¯ä»¥éšæ—¶åœ¨è¿™é‡Œè°ƒæ•´è®¾ç½®ã€‚
        </p>
      </div>
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è®°å¿†ç®¡ç†åŒºå— - æ˜¾ç¤ºç”¨æˆ·æ´å¯Ÿ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function MemoryManagementSection() {
  const [insights, setInsights] = useState<Array<{ id: string; content: string; created_at: string }>>([])
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    const loadInsights = async () => {
      try {
        const token = getAccessToken()
        if (!token) return

        // å°è¯•ä» identity prism API è·å–è®°å¿†
        const res = await fetch(`${API_BASE}/identity/prism`, {
          headers: { Authorization: `Bearer ${token}` }
        })
        if (res.ok) {
          const data = await res.json()
          if (data.memories) {
            setInsights(data.memories.map((m: { content: string; date: string }, i: number) => ({
              id: String(i),
              content: m.content,
              created_at: m.date
            })))
          }
        }
      } catch (err) {
        console.error('Failed to load insights:', err)
      } finally {
        setIsLoading(false)
      }
    }
    loadInsights()
  }, [])

  if (isLoading) {
    return (
      <div className="space-y-6">
        <h2 className="font-serif text-xl text-text-primary">è®°å¿†ç®¡ç†</h2>
        <div className="animate-pulse space-y-3">
          <div className="h-16 bg-[var(--bg-secondary)] rounded-lg" />
          <div className="h-16 bg-[var(--bg-secondary)] rounded-lg" />
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <h2 className="font-serif text-xl text-text-primary">è®°å¿†ç®¡ç†</h2>
      <p className="text-sm text-text-secondary">
        VibeLife ä¼šè®°ä½ä½ åˆ†äº«çš„ä¿¡æ¯ï¼Œä»¥æä¾›æ›´ä¸ªæ€§åŒ–çš„ä½“éªŒã€‚
      </p>

      {insights.length === 0 ? (
        <div className="text-center py-8 text-text-secondary">
          <p>æš‚æ— è®°å¿†</p>
          <p className="text-sm mt-2">ä¸ VibeLife å¯¹è¯åï¼Œä¼šè‡ªåŠ¨ç§¯ç´¯å¯¹ä½ çš„äº†è§£</p>
        </div>
      ) : (
        <div className="space-y-3">
          {insights.map((insight) => (
            <div key={insight.id} className="flex items-center justify-between p-4 bg-[var(--bg-callout)] rounded-lg">
              <div>
                <p className="text-text-primary">{insight.content}</p>
                <p className="text-xs text-text-secondary mt-1">{insight.created_at}</p>
              </div>
            </div>
          ))}
        </div>
      )}

      <div className="pt-4 border-t border-[var(--border-light)]">
        <p className="text-xs text-text-tertiary">
          è®°å¿†å¸®åŠ© VibeLife æ›´å¥½åœ°ç†è§£ä½ ï¼Œæä¾›æ›´ç²¾å‡†çš„å»ºè®®ã€‚
          å¦‚éœ€æ¸…é™¤æ‰€æœ‰è®°å¿†ï¼Œè¯·åœ¨è´¦æˆ·ç®¡ç†ä¸­åˆ é™¤è´¦æˆ·ã€‚
        </p>
      </div>
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// éšç§ä¸å®‰å…¨åŒºå—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function PrivacySecuritySection() {
  const router = useRouter()

  return (
    <div className="space-y-6">
      <h2 className="font-serif text-xl text-text-primary">éšç§ä¸å®‰å…¨</h2>

      <div className="space-y-4">
        <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-text-primary font-medium">æ•°æ®å¯¼å‡º</p>
              <p className="text-sm text-text-secondary">ä¸‹è½½ä½ åœ¨ VibeLife çš„æ‰€æœ‰æ•°æ®</p>
            </div>
            <button
              onClick={() => {
                const token = getAccessToken()
                if (token) {
                  window.open(`${API_BASE}/profile/export`, '_blank')
                }
              }}
              className="px-4 py-2 text-sm bg-[var(--bg-secondary)] rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors"
            >
              å¯¼å‡ºæ•°æ®
            </button>
          </div>
        </div>

        <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-text-primary font-medium">ç™»å½•è®¾å¤‡</p>
              <p className="text-sm text-text-secondary">æŸ¥çœ‹å’Œç®¡ç†ä½ çš„ç™»å½•è®¾å¤‡</p>
            </div>
            <span className="text-sm text-text-tertiary">å³å°†æ¨å‡º</span>
          </div>
        </div>

        <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-text-primary font-medium">åŒé‡è®¤è¯</p>
              <p className="text-sm text-text-secondary">å¢å¼ºè´¦æˆ·å®‰å…¨æ€§</p>
            </div>
            <span className="text-sm text-text-tertiary">å³å°†æ¨å‡º</span>
          </div>
        </div>
      </div>

      <div className="pt-4 border-t border-[var(--border-light)]">
        <p className="text-xs text-text-tertiary">
          æˆ‘ä»¬é‡è§†ä½ çš„éšç§ã€‚æŸ¥çœ‹æˆ‘ä»¬çš„
          <a href="/privacy" className="text-accent hover:underline mx-1">éšç§æ”¿ç­–</a>
          äº†è§£æ›´å¤šã€‚
        </p>
      </div>
    </div>
  )
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¸®åŠ©ä¸åé¦ˆåŒºå—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function HelpFeedbackSection() {
  return (
    <div className="space-y-6">
      <h2 className="font-serif text-xl text-text-primary">å¸®åŠ©ä¸åé¦ˆ</h2>

      <div className="space-y-4">
        <a
          href="mailto:support@vibelife.app"
          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors"
        >
          <div className="flex items-center gap-3">
            <span className="text-xl">ğŸ“§</span>
            <div>
              <p className="text-text-primary font-medium">è”ç³»å®¢æœ</p>
              <p className="text-sm text-text-secondary">support@vibelife.app</p>
            </div>
          </div>
        </a>

        <a
          href="https://vibelife.app/faq"
          target="_blank"
          rel="noopener noreferrer"
          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors"
        >
          <div className="flex items-center gap-3">
            <span className="text-xl">â“</span>
            <div>
              <p className="text-text-primary font-medium">å¸¸è§é—®é¢˜</p>
              <p className="text-sm text-text-secondary">æŸ¥çœ‹å¸¸è§é—®é¢˜è§£ç­”</p>
            </div>
          </div>
        </a>

        <a
          href="https://vibelife.app/feedback"
          target="_blank"
          rel="noopener noreferrer"
          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors"
        >
          <div className="flex items-center gap-3">
            <span className="text-xl">ğŸ’¡</span>
            <div>
              <p className="text-text-primary font-medium">åŠŸèƒ½å»ºè®®</p>
              <p className="text-sm text-text-secondary">å‘Šè¯‰æˆ‘ä»¬ä½ å¸Œæœ›çœ‹åˆ°çš„åŠŸèƒ½</p>
            </div>
          </div>
        </a>

        <a
          href="https://vibelife.app/bug-report"
          target="_blank"
          rel="noopener noreferrer"
          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors"
        >
          <div className="flex items-center gap-3">
            <span className="text-xl">ğŸ›</span>
            <div>
              <p className="text-text-primary font-medium">æŠ¥å‘Šé—®é¢˜</p>
              <p className="text-sm text-text-secondary">å‘ç°é—®é¢˜ï¼Ÿå‘Šè¯‰æˆ‘ä»¬</p>
            </div>
          </div>
        </a>
      </div>
    </div>
  )
}

export default function SettingsPage() {
  const router = useRouter()
  const [activeSection, setActiveSection] = useState('profile')
  const [loading, setLoading] = useState(false)
  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic" | "wise">("warm")
  const [profile, setProfile] = useState<UserProfile>(() => ({
    nickname: 'ç”¨æˆ·',
    email: 'user@example.com',
    avatar: 'ğŸ‘¤',
    // Do not prefill with fake defaults; leave empty until loaded
    birthDate: '',
    birthTime: '',
    timezone: 'Asia/Shanghai',
  }))
  // Local Y/M/D states for better date UX (year select solves typing issue)
  const [birthYear, setBirthYear] = useState('')
  const [birthMonth, setBirthMonth] = useState('')
  const [birthDay, setBirthDay] = useState('')

  useEffect(() => {
    // Prefer authoritative profile from API; fall back to cached localStorage
    const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
    if (user) {
      setProfile(prev => ({
        ...prev,
        nickname: user.nickname || user.display_name || 'ç”¨æˆ·',
        email: user.email || '',
        avatar: user.avatar || 'ğŸ‘¤',
        timezone: user.timezone || 'Asia/Shanghai',
      }))
    }

    const token = getAccessToken()
    if (!token) return

    // Fetch current profile to populate birth date/time accurately
    fetch(`${API_BASE}/profile`, {
      headers: { 'Authorization': `Bearer ${token}` }
    })
      .then(async (res) => {
        if (!res.ok) return null
        return res.json()
      })
      .then((data) => {
        if (!data) return
        // Parse ISO like "YYYY-MM-DDTHH:MM:SS" without TZ shift
        const iso: string | undefined = data.birth_datetime
        let birthDate = ''
        let birthTime = ''
        if (iso && typeof iso === 'string') {
          const [d, t] = iso.split('T')
          birthDate = d || ''
          if (t) birthTime = t.slice(0, 5) // HH:MM
        }

        setProfile(prev => ({
          ...prev,
          nickname: data.display_name ?? prev.nickname,
          avatar: data.avatar_url ? 'ğŸ‘¤' : prev.avatar,
          birthDate,
          birthTime,
          timezone: data.timezone || prev.timezone,
        }))
      })
      .catch(() => {})

    // Load voice mode preference
    fetch(`${API_BASE}/preferences`, {
      headers: { 'Authorization': `Bearer ${token}` }
    })
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if (data?.voice_mode) {
          setVoiceModeState(data.voice_mode as "warm" | "sarcastic" | "wise")
        }
      })
      .catch(() => {})
  }, [])

  // Save voice mode to API
  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic" | "wise") => {
    setVoiceModeState(mode)
    const token = getAccessToken()
    if (!token) return
    try {
      await fetch(`${API_BASE}/preferences`, {
        method: 'PUT',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ voice_mode: mode })
      })
    } catch (error) {
      console.error('Failed to save voice mode:', error)
    }
  }, [])

  // Keep local Y/M/D in sync when profile.birthDate changes (e.g., loaded from API)
  useEffect(() => {
    const [y, m, d] = (profile.birthDate || '').split('-')
    setBirthYear(y || '')
    setBirthMonth(m || '')
    setBirthDay(d || '')
  }, [profile.birthDate])

  // Use useCallback for stable reference (Vercel rule: rerender-functional-setstate)
  const handleProfileChange = useCallback((field: keyof UserProfile, value: string) => {
    setProfile(prev => ({ ...prev, [field]: value }))
  }, [])

  const handleSaveProfile = useCallback(async () => {
    setLoading(true)
    try {
      const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
      const token = getAccessToken()

      if (user?.user_id && token) {
        const body: any = {
          display_name: profile.nickname,
          timezone: profile.timezone,
        }
        // When both date and time present -> set; otherwise explicitly clear on server
        if (profile.birthDate && profile.birthTime) {
          body.birth_datetime = `${profile.birthDate}T${profile.birthTime}:00`
        } else {
          body.birth_datetime = null
        }

        const res = await fetch(`${API_BASE}/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(body),
        })

        if (res.ok) {
          // Update local cache with normalized values
          setLocalStorageJSON('user', {
            ...user,
            nickname: profile.nickname,
            display_name: profile.nickname,
            birth_date: profile.birthDate || undefined,
            birth_time: profile.birthTime || undefined,
            timezone: profile.timezone,
          })
        }
      }
    } catch (err) {
      console.error('Failed to save profile:', err)
    } finally {
      setLoading(false)
    }
  }, [profile])

  // è®¾ç½®å†…å®¹åŒºåŸŸ
  const SettingsContent = () => {
    switch (activeSection) {
      case 'profile':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">ä¸ªäººèµ„æ–™</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-text-secondary mb-2">å¤´åƒ</label>
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 rounded-full bg-[var(--bg-secondary)] flex items-center justify-center text-3xl">
                    {profile.avatar}
                  </div>
                  <button className="btn btn-secondary">æ›´æ¢å¤´åƒ</button>
                </div>
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">æ˜µç§°</label>
                <input
                  type="text"
                  value={profile.nickname}
                  onChange={(e) => handleProfileChange('nickname', e.target.value)}
                  className="input"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">é‚®ç®±</label>
                <input
                  type="email"
                  value={profile.email}
                  disabled
                  className="input bg-[var(--bg-secondary)]"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¥æœŸ</label>
                <BirthDateInputs
                  year={birthYear}
                  month={birthMonth}
                  day={birthDay}
                  onYearChange={(v) => {
                    setBirthYear(v)
                    const dateStr = v && birthMonth && birthDay ? `${v}-${birthMonth}-${birthDay}` : ''
                    handleProfileChange('birthDate', dateStr)
                  }}
                  onMonthChange={(v) => {
                    setBirthMonth(v)
                    const dateStr = birthYear && v && birthDay ? `${birthYear}-${v}-${birthDay}` : ''
                    handleProfileChange('birthDate', dateStr)
                  }}
                  onDayChange={(v) => {
                    setBirthDay(v)
                    const dateStr = birthYear && birthMonth && v ? `${birthYear}-${birthMonth}-${v}` : ''
                    handleProfileChange('birthDate', dateStr)
                  }}
                  showHour={false}
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¶é—´</label>
                <div className="flex items-center gap-3">
                  <input
                    type="time"
                    step={60}
                    value={profile.birthTime}
                    onChange={(e) => handleProfileChange('birthTime', e.target.value)}
                    className="input"
                    placeholder="--:--"
                  />
                  <label className="inline-flex items-center gap-2 text-sm text-text-secondary">
                    <input
                      type="checkbox"
                      checked={!profile.birthTime}
                      onChange={(e) => handleProfileChange('birthTime', e.target.checked ? '' : '12:00')}
                    />
                    ä¸ç¡®å®š
                  </label>
                </div>
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">æ—¶åŒº</label>
                <select
                  value={profile.timezone}
                  onChange={(e) => handleProfileChange('timezone', e.target.value)}
                  className="input"
                >
                  <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
                  <option value="Asia/Hong_Kong">Asia/Hong_Kong (UTC+8)</option>
                  <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
                  <option value="America/New_York">America/New_York (UTC-5)</option>
                  <option value="America/Los_Angeles">America/Los_Angeles (UTC-8)</option>
                  <option value="Europe/London">Europe/London (UTC+0)</option>
                </select>
              </div>
              <button onClick={handleSaveProfile} disabled={loading} className="btn btn-primary">
                {loading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜æ›´æ”¹'}
              </button>
            </div>
          </div>
        )
      case 'skills':
        return <SkillSettingsSection router={router} />
      case 'notifications':
        return <NotificationSettingsSection />
      case 'membership':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">ä¼šå‘˜ç®¡ç†</h2>
            <div className="card p-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <p className="text-text-primary font-medium">å½“å‰çŠ¶æ€</p>
                  <p className="text-sm text-text-secondary">å…è´¹ç”¨æˆ·</p>
                </div>
                <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded-full text-sm text-text-secondary">Free</span>
              </div>
              <button onClick={() => router.push('/membership')} className="btn btn-premium w-full">
                âœ¨ å‡çº§ Premium
              </button>
            </div>
            <div className="space-y-3">
              <p className="text-sm text-text-secondary">Premium ä¼šå‘˜æƒç›Šï¼š</p>
              <ul className="space-y-2 text-sm text-text-secondary">
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´æ¯æ—¥è¿åŠ¿</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> 30æ¬¡/å¤© AIå¯¹è¯</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´å¤§è¿/æµå¹´åˆ†æ</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> Identity Prism æ·±åº¦è§£è¯»</li>
              </ul>
            </div>
          </div>
        )
      case 'memory':
        return <MemoryManagementSection />
      case 'account':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">è´¦æˆ·ç®¡ç†</h2>
            <AccountDeletionSection />
          </div>
        )
      case 'preferences':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">åå¥½è®¾ç½®</h2>
            <div className="space-y-4">
              {/* è¯­æ°”æ¨¡å¼ */}
              <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
                <div className="mb-3">
                  <h3 className="text-text-primary font-medium mb-1">è¯­æ°”æ¨¡å¼</h3>
                  <p className="text-sm text-text-secondary">é€‰æ‹© AI çš„å¯¹è¯é£æ ¼</p>
                </div>
                <div className="flex gap-3">
                  <button
                    onClick={() => setVoiceMode('warm')}
                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                      voiceMode === 'warm'
                        ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 shadow-sm'
                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
                    }`}
                  >
                    <div className="text-2xl mb-1">ğŸŒ</div>
                    <div>æ¸©æš–æ”¯æŒ</div>
                  </button>
                  <button
                    onClick={() => setVoiceMode('sarcastic')}
                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                      voiceMode === 'sarcastic'
                        ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 shadow-sm'
                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
                    }`}
                  >
                    <div className="text-2xl mb-1">ğŸ˜ˆ</div>
                    <div>ç›´æ¥æŒ‘æˆ˜</div>
                  </button>
                  <button
                    onClick={() => setVoiceMode('wise')}
                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-all ${
                      voiceMode === 'wise'
                        ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 shadow-sm'
                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
                    }`}
                  >
                    <div className="text-2xl mb-1">ğŸ§™</div>
                    <div>ç¿æ™ºå¯¼å¸ˆ</div>
                  </button>
                </div>
                <div className="mt-3 p-3 bg-[var(--bg-callout)] rounded text-xs text-text-secondary">
                  {voiceMode === 'warm' && 'ğŸ’­ åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿ'}
                  {voiceMode === 'sarcastic' && 'ğŸ’­ ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸'}
                  {voiceMode === 'wise' && 'ğŸ’­ åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒ'}
                </div>
              </div>
            </div>
          </div>
        )
      case 'privacy':
        return <PrivacySecuritySection />
      case 'help':
        return <HelpFeedbackSection />
      case 'about':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">å…³äº VibeLife</h2>
            <div className="text-center py-8">
              <span className="text-5xl mb-4 block">ğŸŒŸ</span>
              <h3 className="font-serif text-2xl text-text-primary mb-2">VibeLife</h3>
              <p className="text-text-secondary mb-4">æ¢ç´¢å†…å¿ƒä¸–ç•Œ</p>
              <p className="text-sm text-text-secondary">ç‰ˆæœ¬ 6.0.0</p>
            </div>
            <div className="space-y-2 text-sm text-text-secondary">
              <a href="/terms" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">ç”¨æˆ·åè®®</a>
              <a href="/privacy" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">éšç§æ”¿ç­–</a>
              <a href="mailto:support@vibelife.app" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">è”ç³»æˆ‘ä»¬</a>
            </div>
          </div>
        )
      default:
        return (
          <div className="text-center py-8 text-text-secondary">
            <p>è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
          </div>
        )
    }
  }

  // ä½¿ç”¨ AuthProvider çš„ logout åŠŸèƒ½
  const { logout } = useAuth()

  // å¤„ç†é€€å‡ºç™»å½•
  const handleLogout = useCallback(async () => {
    try {
      await logout()
      router.push('/auth/login')
    } catch (err) {
      console.error('Logout failed:', err)
    }
  }, [logout, router])

  // PCç«¯è®¾ç½®èœå•åŒºå—
  const SettingsMenuSection = () => (
    <div className="w-64 flex-shrink-0 bg-card border-r border-border h-full overflow-y-auto">
      <div className="p-4 border-b border-border">
        <h2 className="font-semibold text-foreground">è®¾ç½®</h2>
      </div>
      <div className="p-2 space-y-1">
        {SETTINGS_MENU.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveSection(item.id)}
            className={cn(
              "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition-all duration-200",
              activeSection === item.id
                ? 'bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]'
                : 'text-muted-foreground hover:bg-muted hover:text-foreground'
            )}
          >
            <span className="text-lg">{item.icon}</span>
            <span className="text-sm font-medium">{item.label}</span>
          </button>
        ))}
      </div>
      <div className="p-2 border-t border-border mt-2">
        <button
          onClick={handleLogout}
          className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-colors"
        >
          <span className="text-lg">ğŸšª</span>
          <span className="text-sm font-medium">é€€å‡ºç™»å½•</span>
        </button>
      </div>
    </div>
  )

  // PCç«¯ä¸»å†…å®¹
  const PCMainContent = () => (
    <div className="flex-1 overflow-y-auto p-6">
      <div className="max-w-2xl">
        <div className="bg-card rounded-xl p-6 shadow-sm">
          <SettingsContent />
        </div>
      </div>
    </div>
  )

  // ç§»åŠ¨ç«¯å†…å®¹
  const MobileContentView = () => (
    <div className="min-h-screen bg-background lg:hidden">
      <MobileHeader skill="bazi" />

      <main className="max-w-lg mx-auto px-4 py-6">
        <h1 className="font-serif text-xl text-foreground mb-4">è®¾ç½®</h1>
        <div className="space-y-2">
          {SETTINGS_MENU.map((item, index) => (
            <button
              key={item.id}
              onClick={() => {
                if (item.id === 'membership') {
                  router.push('/membership')
                } else {
                  setActiveSection(item.id)
                }
              }}
              className="w-full bg-card p-4 flex items-center gap-3 rounded-lg shadow-sm"
              style={{ animationDelay: `${index * 50}ms` }}
            >
              <span className="text-xl">{item.icon}</span>
              <span className="text-foreground">{item.label}</span>
              <span className="ml-auto text-muted-foreground">â€º</span>
            </button>
          ))}
        </div>

        <div className="mt-8">
          <button
            onClick={handleLogout}
            className="w-full p-4 text-center text-red-500 bg-card rounded-lg shadow-sm"
          >
            é€€å‡ºç™»å½•
          </button>
        </div>

        <div className="mt-8 text-center text-sm text-muted-foreground">
          <p>VibeLife v6.0.0</p>
        </div>
      </main>
    </div>
  )

  return (
    <div className="h-screen flex flex-col bg-background">
      {/* PCç«¯å¸ƒå±€ */}
      <div className="hidden lg:flex h-full">
        {/* å·¦ä¾§ NavBar - ä¸ Chat é¡µä¿æŒä¸€è‡´ */}
        <NavBar
          skill="bazi"
          activeTab="me"
          onTabChange={(tab) => {
            if (tab === 'chat') router.push('/chat')
            else if (tab === 'journey') router.push('/chat?tab=journey')
            else if (tab === 'discover') router.push('/chat?tab=discover')
            else if (tab === 'me') router.push('/chat?tab=me')
          }}
          activeConversationId={null}
          onSelectConversation={() => {}}
          onNewChat={() => router.push('/chat')}
        />

        {/* è®¾ç½®èœå•åŒºå— */}
        <SettingsMenuSection />

        {/* ä¸»å†…å®¹åŒºåŸŸ */}
        <PCMainContent />
      </div>

      {/* ç§»åŠ¨ç«¯å¸ƒå±€ */}
      <MobileContentView />
    </div>
  )
}
