# VibeLife E2E 测试套件

## 概述

本目录包含 VibeLife 的端到端测试，使用 Playwright 框架编写。测试覆盖：

- **Onboarding 流程** - 用户首次使用的完整旅程
- **Skill 功能** - 所有 10 个 Skill 的端到端测试
- **用户场景** - 基于真实用户行为的测试

## 测试文件结构

```
tests/e2e/
├── pages/                          # Page Object Model
│   ├── OnboardingPage.ts           # Onboarding 页面对象
│   └── ChatPage.ts                 # Chat 页面对象
├── fixtures/                       # 测试数据
│   └── test-data.ts                # 统一测试数据
├── onboarding-comprehensive.spec.ts # Onboarding 综合测试
├── skills.spec.ts                   # Skill 端到端测试
├── user-scenarios.spec.ts           # 用户场景测试
├── onboarding.spec.ts               # 基础 onboarding 测试
├── bazi.spec.ts                     # 八字功能测试
├── zodiac.spec.ts                   # 星座功能测试
└── README.md                        # 本文档
```

## 快速开始

### 1. 安装依赖

```bash
# 安装项目依赖
pnpm install

# 安装 Playwright 浏览器
npx playwright install chromium
```

### 2. 运行测试

```bash
# 运行所有测试
./scripts/run-e2e-tests.sh

# 运行特定测试套件
./scripts/run-e2e-tests.sh onboarding
./scripts/run-e2e-tests.sh skills
./scripts/run-e2e-tests.sh scenarios

# 有头模式（显示浏览器）
./scripts/run-e2e-tests.sh --headed

# 调试模式
./scripts/run-e2e-tests.sh --debug

# UI 模式
./scripts/run-e2e-tests.sh --ui

# 指定测试 URL
./scripts/run-e2e-tests.sh --url https://staging.vibelife.com all
```

### 3. 查看报告

```bash
npx playwright show-report
```

## 测试覆盖范围

### 1. Onboarding 综合测试 (`onboarding-comprehensive.spec.ts`)

| 测试类别 | 描述 |
|---------|------|
| 变体入口测试 | bazi / zodiac / jungastro / dankoe 四种入口 |
| 用户旅程测试 | 新用户完整流程 / 回访用户 / 异常流程 |
| 表单验证测试 | 年份边界 / 日期边界 / 空值必填项 |
| 流程完整性 | URL 状态一致 / 步骤间导航 / Loading 动画 |
| 响应式测试 | 6 种视口 (iPhone SE ~ Wide Desktop) |
| Skill 端到端 | Bazi / Zodiac / Tarot / Lifecoach / Psych / Mindfulness / Career |
| 性能可访问性 | 加载时间 / 键盘导航 / ARIA 标签 |
| 错误处理 | API 超时 / 500 错误 / JS 错误 |

### 2. Skill 测试 (`skills.spec.ts`)

| Skill | 触发词 | 测试场景 |
|-------|--------|---------|
| bazi | 八字、命理、排盘 | 命盘计算、聊天交互 |
| zodiac | 星座、星盘、占星 | 星盘计算、运势分析 |
| tarot | 塔罗、抽牌、占卜 | 抽牌、牌阵 |
| psych | 心理、焦虑、抑郁 | 心理评估、情绪分析 |
| mindfulness | 正念、冥想、呼吸 | 练习引导 |
| lifecoach | 目标、迷茫、拖延 | Dan Koe / Covey / 王阳明 / 了凡四训 |
| career | 职业、工作、跳槽 | 职业规划 |
| synastry | 合盘、配对 | 关系分析 |
| vibe_id | 人格画像、原型 | 性格分析 |

### 3. 用户场景测试 (`user-scenarios.spec.ts`)

| 场景 | 描述 |
|-----|------|
| 新用户八字流程 | Onboarding → 首次洞察 → 多轮对话 |
| 新用户星座流程 | 完整星盘分析 |
| Dankoe 直接对话 | 跳过生日输入 |
| 焦虑用户 | 寻求心理支持 |
| 职业转型用户 | 综合分析 |
| 感情咨询用户 | 星座分析 |
| 自我提升用户 | Lifecoach 深度对话 |

## Page Object Model

### OnboardingPage

```typescript
import { OnboardingPage } from './pages/OnboardingPage'

const onboardingPage = new OnboardingPage(page)

// 导航
await onboardingPage.goto('bazi')
await onboardingPage.gotoStep('loading', 'bazi')

// 填写表单
await onboardingPage.fillBirthInfo({ year: 1990, month: 6, day: 15 })
await onboardingPage.clickContinue()

// 检查状态
const hasError = await onboardingPage.hasError()
const headline = await onboardingPage.getHeadlineText()
```

### ChatPage

```typescript
import { ChatPage } from './pages/ChatPage'

const chatPage = new ChatPage(page)

// 导航
await chatPage.goto()
await chatPage.gotoWithSkill('bazi')

// 发送消息
await chatPage.sendMessage('帮我看看八字')
await chatPage.waitForResponse(30000)

// 获取响应
const lastMessage = await chatPage.getLastAssistantMessage()
```

## 测试数据

测试数据集中管理在 `fixtures/test-data.ts`：

```typescript
import { BIRTH_DATES, USER_SCENARIOS, SKILL_TRIGGERS } from './fixtures/test-data'

// 生日数据
BIRTH_DATES.standard      // { year: 1990, month: 6, day: 15, hour: 10 }
BIRTH_DATES.leapYear      // 闰年2月29日
BIRTH_DATES.zi            // 子时 (00:00)

// 用户场景
USER_SCENARIOS.find(s => s.id === 'anxious-user')

// Skill 触发词
SKILL_TRIGGERS.find(s => s.skillId === 'bazi').queries
```

## 配置说明

### Playwright 配置 (`playwright.config.ts`)

```typescript
{
  testDir: './tests/e2e',
  timeout: 60000,           // 测试超时 60 秒
  expect: { timeout: 10000 }, // 断言超时 10 秒
  workers: 1,               // 顺序执行
  retries: process.env.CI ? 2 : 0,
  projects: [
    { name: 'Desktop Chrome', viewport: { width: 1440, height: 900 } },
    { name: 'Mobile Chrome', use: devices['Pixel 7'] },
  ],
  use: {
    baseURL: process.env.TEST_URL || 'http://localhost:3000',
    trace: 'on',
    screenshot: 'on',
    video: 'on',
  },
}
```

### 环境变量

| 变量 | 默认值 | 描述 |
|------|-------|------|
| `TEST_URL` | `http://localhost:3000` | 测试目标 URL |
| `CI` | - | CI 环境标识 |

## 截图和报告

### 截图位置

```
test-results/
├── comprehensive/        # 综合测试截图
├── responsive/           # 响应式测试截图
├── skill-*.png           # Skill 测试截图
└── scenario-*.png        # 场景测试截图
```

### 报告位置

```
playwright-report/
├── index.html            # HTML 报告
└── results.json          # JSON 报告
```

## CI/CD 集成

### GitHub Actions 示例

```yaml
name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: pnpm install

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Start server
        run: pnpm dev &
        env:
          NODE_ENV: test

      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Run E2E tests
        run: npx playwright test
        env:
          TEST_URL: http://localhost:3000

      - name: Upload report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
```

## 最佳实践

### 1. 使用 Page Object Model

```typescript
// ✅ 好：使用 Page Object
const chatPage = new ChatPage(page)
await chatPage.sendMessage('你好')

// ❌ 差：直接操作定位器
await page.locator('textarea').fill('你好')
await page.keyboard.press('Enter')
```

### 2. 使用 data-testid

```tsx
// 组件中添加 data-testid
<button data-testid="submit-btn">提交</button>

// 测试中使用
await page.locator('[data-testid="submit-btn"]').click()
```

### 3. 等待 API 响应而非固定时间

```typescript
// ✅ 好：等待响应
await chatPage.waitForResponse(30000)

// ❌ 差：固定等待
await page.waitForTimeout(5000)
```

### 4. 使用测试数据文件

```typescript
// ✅ 好：集中管理测试数据
import { BIRTH_DATES } from './fixtures/test-data'
await onboardingPage.fillBirthInfo(BIRTH_DATES.standard)

// ❌ 差：硬编码
await page.fill('[name="year"]', '1990')
```

## 故障排除

### 测试超时

```bash
# 增加超时时间
npx playwright test --timeout=120000

# 或在测试中设置
test.setTimeout(120000)
```

### 元素定位失败

```bash
# 使用调试模式查看页面状态
npx playwright test --debug

# 或使用 UI 模式
npx playwright test --ui
```

### 截图对比失败

```bash
# 更新截图基线
npx playwright test --update-snapshots
```

## 相关链接

- [Playwright 文档](https://playwright.dev/docs/intro)
- [Page Object Model 模式](https://playwright.dev/docs/pom)
- [测试报告](https://playwright.dev/docs/test-reporters)
