/**
 * Onboarding E2E 测试套件 - 全面覆盖版
 *
 * 测试场景分类：
 * 1. 变体入口测试 (bazi / zodiac / jungastro / dankoe)
 * 2. 用户旅程测试 (新用户 / 回访用户 / 异常流程)
 * 3. 表单验证测试 (边界值 / 必填项 / 格式校验)
 * 4. 流程完整性测试 (landing → loading → embeddedChat → conversion)
 * 5. 响应式测试 (桌面端 / 移动端)
 * 6. Skill 端到端测试
 */

import { test, expect, Page } from '@playwright/test'

// ═══════════════════════════════════════════════════════════════════════════
// 测试配置和工具函数
// ═══════════════════════════════════════════════════════════════════════════

const TEST_BIRTH_DATES = {
  valid: {
    year: 1990,
    month: 6,
    day: 15,
    hour: 10,
  },
  leap_year: {
    year: 2000,
    month: 2,
    day: 29,
    hour: 12,
  },
  edge_old: {
    year: 1920,
    month: 1,
    day: 1,
    hour: 0,
  },
  edge_young: {
    year: 2010,
    month: 12,
    day: 31,
    hour: 23,
  },
}

const VARIANTS = ['bazi', 'zodiac', 'jungastro', 'dankoe'] as const
type Variant = (typeof VARIANTS)[number]

const VARIANT_EXPECTATIONS: Record<
  Variant,
  {
    headline: string | RegExp
    requiresBirthInfo: boolean
    skillId: string
  }
> = {
  bazi: {
    headline: /告诉我你的生日|命盘/,
    requiresBirthInfo: true,
    skillId: 'bazi',
  },
  zodiac: {
    headline: /告诉我你的生日|星盘/,
    requiresBirthInfo: true,
    skillId: 'zodiac',
  },
  jungastro: {
    headline: /告诉我你的生日|荣格/,
    requiresBirthInfo: true,
    skillId: 'zodiac',
  },
  dankoe: {
    headline: /准备好重置|人生/,
    requiresBirthInfo: false,
    skillId: 'lifecoach',
  },
}

// 辅助函数：填写生日表单
async function fillBirthInfo(
  page: Page,
  birthInfo: { year: number; month: number; day: number; hour?: number }
) {
  // 尝试多种输入方式
  const yearInput = page.locator(
    'input[name="year"], input[placeholder*="年"], input[data-testid="year"]'
  )
  const monthInput = page.locator(
    'input[name="month"], input[placeholder*="月"], input[data-testid="month"]'
  )
  const dayInput = page.locator(
    'input[name="day"], input[placeholder*="日"], input[data-testid="day"]'
  )

  if ((await yearInput.isVisible()) && (await monthInput.isVisible()) && (await dayInput.isVisible())) {
    await yearInput.fill(birthInfo.year.toString())
    await monthInput.fill(birthInfo.month.toString())
    await dayInput.fill(birthInfo.day.toString())

    if (birthInfo.hour !== undefined) {
      const hourInput = page.locator(
        'input[name="hour"], input[placeholder*="时"], input[data-testid="hour"]'
      )
      if (await hourInput.isVisible()) {
        await hourInput.fill(birthInfo.hour.toString())
      }
    }
    return true
  }

  // 尝试 date picker
  const dateInput = page.locator('input[type="date"]')
  if (await dateInput.isVisible()) {
    const dateStr = `${birthInfo.year}-${String(birthInfo.month).padStart(2, '0')}-${String(birthInfo.day).padStart(2, '0')}`
    await dateInput.fill(dateStr)
    return true
  }

  return false
}

// 辅助函数：等待并截图
async function waitAndScreenshot(page: Page, name: string, timeout = 2000) {
  await page.waitForTimeout(timeout)
  await page.screenshot({
    path: `test-results/comprehensive/${name}.png`,
    fullPage: true,
  })
}

// 辅助函数：点击继续按钮
async function clickContinue(page: Page) {
  const continueBtn = page
    .getByRole('button', { name: /继续|开始|下一步|计算|看看|确认/i })
    .first()
  if ((await continueBtn.isVisible()) && (await continueBtn.isEnabled())) {
    await continueBtn.click()
    await page.waitForTimeout(1000)
    return true
  }
  return false
}

// ═══════════════════════════════════════════════════════════════════════════
// 1. 变体入口测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('1. 变体入口测试', () => {
  for (const variant of VARIANTS) {
    const expectation = VARIANT_EXPECTATIONS[variant]

    test.describe(`${variant} 变体`, () => {
      test(`${variant}: 页面正确加载`, async ({ page }) => {
        await page.goto(`/onboarding?variant=${variant}`)
        await page.waitForLoadState('networkidle')

        // 验证页面标题/内容
        const pageContent = await page.content()
        expect(pageContent.length).toBeGreaterThan(500)

        await waitAndScreenshot(page, `variant-${variant}-landing`)
      })

      test(`${variant}: 显示正确的主标题`, async ({ page }) => {
        await page.goto(`/onboarding?variant=${variant}`)
        await page.waitForLoadState('networkidle')

        const headline = page.locator('h1, h2, [data-testid="headline"]').first()
        if (await headline.isVisible()) {
          const text = await headline.textContent()
          expect(text).toMatch(expectation.headline)
        }
      })

      if (expectation.requiresBirthInfo) {
        test(`${variant}: 显示生日输入表单`, async ({ page }) => {
          await page.goto(`/onboarding?variant=${variant}`)
          await page.waitForLoadState('networkidle')

          // 应该有生日输入字段
          const birthInputs = page.locator(
            'input[name="year"], input[name="month"], input[name="day"], input[type="date"]'
          )
          const count = await birthInputs.count()
          expect(count).toBeGreaterThan(0)
        })
      } else {
        test(`${variant}: 直接跳转到聊天`, async ({ page }) => {
          await page.goto(`/onboarding?variant=${variant}`)
          await page.waitForLoadState('networkidle')
          await page.waitForTimeout(2000)

          // dankoe 应该直接显示聊天界面
          const chatContainer = page.locator(
            '[data-testid="chat-container"], .chat-container, textarea, [contenteditable="true"]'
          )
          const hasChatUI = await chatContainer.first().isVisible().catch(() => false)

          await waitAndScreenshot(page, `variant-${variant}-chat-direct`)
        })
      }
    })
  }
})

// ═══════════════════════════════════════════════════════════════════════════
// 2. 用户旅程测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('2. 用户旅程测试', () => {
  test.describe('新用户完整流程', () => {
    test('bazi: landing → loading → embeddedChat → conversion', async ({ page }) => {
      // Step 1: Landing
      await page.goto('/onboarding?variant=bazi')
      await page.waitForLoadState('networkidle')
      await waitAndScreenshot(page, 'journey-bazi-01-landing')

      // 填写生日
      const filled = await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
      if (filled) {
        await waitAndScreenshot(page, 'journey-bazi-02-filled')

        // 点击继续
        await clickContinue(page)
        await waitAndScreenshot(page, 'journey-bazi-03-loading')

        // Step 2: Loading - 等待计算完成
        await page.waitForTimeout(5000) // 等待 loading 动画
        await waitAndScreenshot(page, 'journey-bazi-04-loading-progress')

        // Step 3: EmbeddedChat
        await page.waitForTimeout(10000) // 等待跳转到 chat
        await waitAndScreenshot(page, 'journey-bazi-05-chat')

        // 检查是否有聊天输入框
        const chatInput = page.locator('textarea, input[type="text"]').last()
        if (await chatInput.isVisible()) {
          await chatInput.fill('你好')
          await waitAndScreenshot(page, 'journey-bazi-06-chat-input')
        }
      }
    })

    test('zodiac: 完整流程', async ({ page }) => {
      await page.goto('/onboarding?variant=zodiac')
      await page.waitForLoadState('networkidle')
      await waitAndScreenshot(page, 'journey-zodiac-01-landing')

      const filled = await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
      if (filled) {
        await clickContinue(page)
        await page.waitForTimeout(8000)
        await waitAndScreenshot(page, 'journey-zodiac-02-after-loading')
      }
    })

    test('dankoe: 直接进入对话', async ({ page }) => {
      await page.goto('/onboarding?variant=dankoe')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(3000)
      await waitAndScreenshot(page, 'journey-dankoe-01-chat')

      // dankoe 应该跳过 landing 和 loading，直接显示聊天
      const chatElements = page.locator('textarea, [data-testid="chat-input"]')
      const chatVisible = await chatElements.first().isVisible().catch(() => false)
      await waitAndScreenshot(page, 'journey-dankoe-02-chat-ready')
    })
  })

  test.describe('回访用户场景', () => {
    test('有 localStorage 数据的用户重新进入', async ({ page }) => {
      // 预设 localStorage
      await page.goto('/onboarding')
      await page.evaluate(() => {
        localStorage.setItem(
          'vibelife_onboarding',
          JSON.stringify({
            variant: 'bazi',
            step: 'embeddedChat',
            birthInfo: { year: 1990, month: 6, day: 15 },
          })
        )
      })

      await page.reload()
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)
      await waitAndScreenshot(page, 'journey-returning-user')
    })
  })

  test.describe('异常流程处理', () => {
    test('无效 variant 参数回退到默认', async ({ page }) => {
      await page.goto('/onboarding?variant=invalid_variant')
      await page.waitForLoadState('networkidle')
      await waitAndScreenshot(page, 'journey-invalid-variant')

      // 应该回退到默认 variant (bazi)
      const pageContent = await page.content()
      expect(pageContent.length).toBeGreaterThan(100)
    })

    test('直接访问 loading step 但无数据', async ({ page }) => {
      await page.goto('/onboarding?step=loading')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)
      await waitAndScreenshot(page, 'journey-direct-loading')

      // 应该重定向回 landing 或显示错误
    })

    test('网络错误恢复', async ({ page }) => {
      // 模拟网络错误
      await page.route('**/api/**', (route) => route.abort())

      await page.goto('/onboarding?variant=bazi')
      await page.waitForLoadState('networkidle')

      const filled = await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
      if (filled) {
        await clickContinue(page)
        await page.waitForTimeout(3000)
        await waitAndScreenshot(page, 'journey-network-error')
      }

      // 恢复网络
      await page.unroute('**/api/**')
    })
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 3. 表单验证测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('3. 表单验证测试', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')
  })

  test.describe('年份验证', () => {
    test('有效年份 1920-2020', async ({ page }) => {
      const years = [1920, 1950, 1990, 2000, 2010, 2020]
      for (const year of years) {
        await fillBirthInfo(page, { year, month: 1, day: 1 })
        // 验证没有错误提示
        const errorMsg = page.locator('[data-testid="error"], .error-message, .text-red')
        const hasError = await errorMsg.first().isVisible().catch(() => false)
        // 可选：断言无错误
      }
    })

    test('无效年份显示错误', async ({ page }) => {
      const invalidYears = [1800, 2100, 0, -1]
      for (const year of invalidYears) {
        await fillBirthInfo(page, { year, month: 1, day: 1 })
        await page.waitForTimeout(500)
        // 检查是否禁用继续按钮或显示错误
      }
      await waitAndScreenshot(page, 'form-invalid-year')
    })
  })

  test.describe('日期边界值', () => {
    test('闰年 2月29日', async ({ page }) => {
      await fillBirthInfo(page, TEST_BIRTH_DATES.leap_year)
      await waitAndScreenshot(page, 'form-leap-year')
      // 应该接受
    })

    test('非闰年 2月29日', async ({ page }) => {
      await fillBirthInfo(page, { year: 2001, month: 2, day: 29 })
      await waitAndScreenshot(page, 'form-non-leap-year-feb29')
      // 应该显示错误或自动修正
    })

    test('大小月边界', async ({ page }) => {
      // 31天的月份
      await fillBirthInfo(page, { year: 1990, month: 1, day: 31 })
      await waitAndScreenshot(page, 'form-jan-31')

      // 30天的月份
      await fillBirthInfo(page, { year: 1990, month: 4, day: 30 })
      await waitAndScreenshot(page, 'form-apr-30')

      // 30天月份的31日（无效）
      await fillBirthInfo(page, { year: 1990, month: 4, day: 31 })
      await waitAndScreenshot(page, 'form-apr-31-invalid')
    })
  })

  test.describe('空值和必填项', () => {
    test('空表单提交', async ({ page }) => {
      // 不填写任何内容，直接点击继续
      const continueBtn = page.getByRole('button', { name: /继续|开始|计算/i }).first()
      if (await continueBtn.isVisible()) {
        await continueBtn.click()
        await page.waitForTimeout(1000)
        await waitAndScreenshot(page, 'form-empty-submit')
        // 按钮应该被禁用或显示验证错误
      }
    })

    test('部分填写', async ({ page }) => {
      const yearInput = page.locator('input[name="year"], input[placeholder*="年"]').first()
      if (await yearInput.isVisible()) {
        await yearInput.fill('1990')
        // 只填年份，不填月日
        await waitAndScreenshot(page, 'form-partial-fill')
      }
    })
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 4. 流程完整性测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('4. 流程完整性测试', () => {
  test('每个步骤的 URL 和状态一致', async ({ page }) => {
    const steps = ['landing', 'loading', 'embeddedChat', 'conversion']

    for (const step of steps) {
      await page.goto(`/onboarding?step=${step}`)
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(1000)
      await waitAndScreenshot(page, `step-${step}`)

      // 验证 URL
      const url = page.url()
      // 可能重定向，所以只检查是否在 onboarding 路径下
      expect(url).toContain('/onboarding')
    }
  })

  test('步骤间前进后退', async ({ page }) => {
    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    // 填写生日并前进
    await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
    await clickContinue(page)
    await page.waitForTimeout(3000)
    await waitAndScreenshot(page, 'flow-forward')

    // 尝试后退
    await page.goBack()
    await page.waitForTimeout(1000)
    await waitAndScreenshot(page, 'flow-back')

    // 再次前进
    await page.goForward()
    await page.waitForTimeout(1000)
    await waitAndScreenshot(page, 'flow-forward-again')
  })

  test('Loading 进度动画完整性', async ({ page }) => {
    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
    await clickContinue(page)

    // 截取 loading 不同阶段
    for (let i = 1; i <= 5; i++) {
      await page.waitForTimeout(2000)
      await waitAndScreenshot(page, `loading-progress-${i}`)
    }
  })

  test('Conversion 页面元素完整', async ({ page }) => {
    await page.goto('/onboarding?step=conversion')
    await page.waitForLoadState('networkidle')
    await page.waitForTimeout(2000)

    // 检查关键元素
    const pricingElements = page.locator('[data-testid="pricing"], .pricing, text=/订阅|升级|会员/i')
    const count = await pricingElements.count()

    await waitAndScreenshot(page, 'conversion-full-page')

    // 检查 CTA 按钮
    const ctaBtn = page.getByRole('button', { name: /订阅|开通|升级|购买/i })
    if (await ctaBtn.first().isVisible()) {
      await expect(ctaBtn.first()).toBeEnabled()
    }
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 5. 响应式测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('5. 响应式测试', () => {
  const viewports = [
    { name: 'iPhone SE', width: 375, height: 667 },
    { name: 'iPhone 14 Pro', width: 393, height: 852 },
    { name: 'iPad Mini', width: 768, height: 1024 },
    { name: 'iPad Pro', width: 1024, height: 1366 },
    { name: 'Desktop', width: 1440, height: 900 },
    { name: 'Wide Desktop', width: 1920, height: 1080 },
  ]

  for (const viewport of viewports) {
    test(`${viewport.name} (${viewport.width}x${viewport.height})`, async ({ page }) => {
      await page.setViewportSize({ width: viewport.width, height: viewport.height })
      await page.goto('/onboarding?variant=bazi')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(1000)

      await page.screenshot({
        path: `test-results/responsive/${viewport.name.replace(' ', '-')}-landing.png`,
        fullPage: true,
      })

      // 填写表单
      await fillBirthInfo(page, TEST_BIRTH_DATES.valid)

      await page.screenshot({
        path: `test-results/responsive/${viewport.name.replace(' ', '-')}-filled.png`,
        fullPage: true,
      })
    })
  }

  test.describe('移动端特定测试', () => {
    test.use({ viewport: { width: 375, height: 812 } })

    test('移动端滚动行为', async ({ page }) => {
      await page.goto('/onboarding?variant=bazi')
      await page.waitForLoadState('networkidle')

      // 滚动到底部
      await page.evaluate(() => window.scrollTo(0, document.body.scrollHeight))
      await page.waitForTimeout(500)
      await waitAndScreenshot(page, 'mobile-scroll-bottom')

      // 滚动回顶部
      await page.evaluate(() => window.scrollTo(0, 0))
      await page.waitForTimeout(500)
      await waitAndScreenshot(page, 'mobile-scroll-top')
    })

    test('移动端键盘弹出', async ({ page }) => {
      await page.goto('/onboarding?variant=bazi')
      await page.waitForLoadState('networkidle')

      const firstInput = page.locator('input').first()
      if (await firstInput.isVisible()) {
        await firstInput.focus()
        await page.waitForTimeout(500)
        await waitAndScreenshot(page, 'mobile-keyboard-focus')
      }
    })

    test('移动端触摸操作', async ({ page }) => {
      await page.goto('/onboarding?variant=bazi')
      await page.waitForLoadState('networkidle')

      // 模拟滑动
      await page.touchscreen.tap(200, 400)
      await page.waitForTimeout(500)
      await waitAndScreenshot(page, 'mobile-touch')
    })
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 6. Skill 端到端测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('6. Skill 端到端测试', () => {
  test.describe('Bazi Skill', () => {
    test('八字命盘计算和显示', async ({ page }) => {
      await page.goto('/onboarding?variant=bazi')
      await page.waitForLoadState('networkidle')

      await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
      await clickContinue(page)

      // 等待命盘计算完成
      await page.waitForTimeout(10000)
      await waitAndScreenshot(page, 'skill-bazi-chart')

      // 检查命盘元素
      const chartElements = page.locator('[data-testid="bazi-chart"], .bazi-pillar, text=/日主|年柱|月柱/i')
      const chartCount = await chartElements.count()
      // 可选断言
    })

    test('八字聊天交互', async ({ page }) => {
      await page.goto('/chat')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('帮我看看八字')
        await chatInput.press('Enter')
        await page.waitForTimeout(5000)
        await waitAndScreenshot(page, 'skill-bazi-chat-response')
      }
    })
  })

  test.describe('Zodiac Skill', () => {
    test('星盘计算和显示', async ({ page }) => {
      await page.goto('/onboarding?variant=zodiac')
      await page.waitForLoadState('networkidle')

      await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
      await clickContinue(page)

      await page.waitForTimeout(10000)
      await waitAndScreenshot(page, 'skill-zodiac-chart')
    })

    test('星座分析对话', async ({ page }) => {
      await page.goto('/chat')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('分析我的星座')
        await chatInput.press('Enter')
        await page.waitForTimeout(5000)
        await waitAndScreenshot(page, 'skill-zodiac-chat-response')
      }
    })
  })

  test.describe('Tarot Skill', () => {
    test('塔罗抽牌', async ({ page }) => {
      await page.goto('/chat')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('帮我抽一张塔罗牌')
        await chatInput.press('Enter')
        await page.waitForTimeout(8000)
        await waitAndScreenshot(page, 'skill-tarot-draw')
      }
    })
  })

  test.describe('Lifecoach Skill', () => {
    test('Dankoe 方法对话', async ({ page }) => {
      await page.goto('/onboarding?variant=dankoe')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(3000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('我想重新规划我的人生')
        await chatInput.press('Enter')
        await page.waitForTimeout(5000)
        await waitAndScreenshot(page, 'skill-dankoe-response')
      }
    })

    test('Covey 七个习惯', async ({ page }) => {
      await page.goto('/chat')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('教我高效能人士的七个习惯')
        await chatInput.press('Enter')
        await page.waitForTimeout(5000)
        await waitAndScreenshot(page, 'skill-covey-response')
      }
    })
  })

  test.describe('Psych Skill', () => {
    test('心理评估对话', async ({ page }) => {
      await page.goto('/chat')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('我最近感到很焦虑')
        await chatInput.press('Enter')
        await page.waitForTimeout(5000)
        await waitAndScreenshot(page, 'skill-psych-response')
      }
    })
  })

  test.describe('Mindfulness Skill', () => {
    test('正念冥想引导', async ({ page }) => {
      await page.goto('/chat')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('带我做一个呼吸冥想')
        await chatInput.press('Enter')
        await page.waitForTimeout(5000)
        await waitAndScreenshot(page, 'skill-mindfulness-response')
      }
    })
  })

  test.describe('Career Skill', () => {
    test('职业规划对话', async ({ page }) => {
      await page.goto('/chat')
      await page.waitForLoadState('networkidle')
      await page.waitForTimeout(2000)

      const chatInput = page.locator('textarea, input[type="text"]').last()
      if (await chatInput.isVisible()) {
        await chatInput.fill('我想转行做产品经理')
        await chatInput.press('Enter')
        await page.waitForTimeout(5000)
        await waitAndScreenshot(page, 'skill-career-response')
      }
    })
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 7. 性能和可访问性测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('7. 性能和可访问性', () => {
  test('页面加载性能', async ({ page }) => {
    const startTime = Date.now()
    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')
    const loadTime = Date.now() - startTime

    console.log(`Page load time: ${loadTime}ms`)

    // 期望在 5 秒内加载完成
    expect(loadTime).toBeLessThan(5000)
  })

  test('无障碍 - 键盘导航', async ({ page }) => {
    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    // Tab 键导航
    for (let i = 0; i < 5; i++) {
      await page.keyboard.press('Tab')
      await page.waitForTimeout(300)
    }

    await waitAndScreenshot(page, 'a11y-keyboard-nav')

    // 检查焦点可见性
    const focusedElement = await page.evaluate(() => {
      const el = document.activeElement
      return el ? el.tagName : null
    })
    expect(focusedElement).not.toBeNull()
  })

  test('无障碍 - ARIA 标签', async ({ page }) => {
    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    // 检查主要交互元素是否有 ARIA 标签
    const buttons = page.locator('button')
    const buttonCount = await buttons.count()

    for (let i = 0; i < Math.min(buttonCount, 5); i++) {
      const button = buttons.nth(i)
      const ariaLabel = await button.getAttribute('aria-label')
      const innerText = await button.textContent()
      // 按钮应该有文本或 aria-label
      expect(ariaLabel || innerText).toBeTruthy()
    }
  })

  test('颜色对比度检查', async ({ page }) => {
    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    // 简单检查文本是否可见
    const textElements = page.locator('h1, h2, p, span, label')
    const textCount = await textElements.count()

    for (let i = 0; i < Math.min(textCount, 10); i++) {
      const element = textElements.nth(i)
      if (await element.isVisible()) {
        const text = await element.textContent()
        expect(text?.trim().length).toBeGreaterThan(0)
      }
    }
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 8. 错误处理测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('8. 错误处理', () => {
  test('API 超时处理', async ({ page }) => {
    // 模拟 API 延迟
    await page.route('**/api/**', async (route) => {
      await new Promise((resolve) => setTimeout(resolve, 30000))
      await route.continue()
    })

    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
    await clickContinue(page)

    // 等待超时处理
    await page.waitForTimeout(15000)
    await waitAndScreenshot(page, 'error-api-timeout')
  })

  test('API 500 错误处理', async ({ page }) => {
    await page.route('**/api/v1/skills/**', (route) => {
      route.fulfill({
        status: 500,
        body: JSON.stringify({ error: 'Internal Server Error' }),
      })
    })

    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
    await clickContinue(page)

    await page.waitForTimeout(5000)
    await waitAndScreenshot(page, 'error-api-500')
  })

  test('JavaScript 错误不崩溃页面', async ({ page }) => {
    const errors: string[] = []
    page.on('pageerror', (error) => {
      errors.push(error.message)
    })

    await page.goto('/onboarding?variant=bazi')
    await page.waitForLoadState('networkidle')

    await fillBirthInfo(page, TEST_BIRTH_DATES.valid)
    await clickContinue(page)
    await page.waitForTimeout(5000)

    // 记录错误但不一定断言（有些错误可能是预期的）
    if (errors.length > 0) {
      console.log('JS Errors:', errors)
    }
  })
})
