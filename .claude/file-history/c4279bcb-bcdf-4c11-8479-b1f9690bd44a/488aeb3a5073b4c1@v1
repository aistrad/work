/**
 * Onboarding Page Object Model
 *
 * 封装 Onboarding 页面的所有交互逻辑
 */

import { Page, Locator, expect } from '@playwright/test'

export interface BirthInfo {
  year: number
  month: number
  day: number
  hour?: number
}

export type Variant = 'bazi' | 'zodiac' | 'jungastro' | 'dankoe'
export type OnboardingStep = 'landing' | 'loading' | 'embeddedChat' | 'conversion'

export class OnboardingPage {
  readonly page: Page

  // Landing Step Locators
  readonly yearInput: Locator
  readonly monthInput: Locator
  readonly dayInput: Locator
  readonly hourInput: Locator
  readonly dateInput: Locator
  readonly continueButton: Locator
  readonly headline: Locator
  readonly subheadline: Locator

  // Loading Step Locators
  readonly progressBar: Locator
  readonly loadingSteps: Locator
  readonly loadingAnimation: Locator

  // Chat Step Locators
  readonly chatContainer: Locator
  readonly chatInput: Locator
  readonly chatMessages: Locator
  readonly sendButton: Locator

  // Conversion Step Locators
  readonly pricingCards: Locator
  readonly subscribeButton: Locator
  readonly planOptions: Locator

  // Common Locators
  readonly errorMessage: Locator
  readonly backButton: Locator

  constructor(page: Page) {
    this.page = page

    // Landing
    this.yearInput = page.locator('input[name="year"], input[placeholder*="年"], input[data-testid="year"]')
    this.monthInput = page.locator('input[name="month"], input[placeholder*="月"], input[data-testid="month"]')
    this.dayInput = page.locator('input[name="day"], input[placeholder*="日"], input[data-testid="day"]')
    this.hourInput = page.locator('input[name="hour"], input[placeholder*="时"], input[data-testid="hour"]')
    this.dateInput = page.locator('input[type="date"]')
    this.continueButton = page.getByRole('button', { name: /继续|开始|下一步|计算|看看|确认/i }).first()
    this.headline = page.locator('h1, h2, [data-testid="headline"]').first()
    this.subheadline = page.locator('[data-testid="subheadline"], .subheadline, h2, h3').first()

    // Loading
    this.progressBar = page.locator('[data-testid="progress"], .progress-bar, [role="progressbar"]')
    this.loadingSteps = page.locator('[data-testid="loading-step"], .loading-step')
    this.loadingAnimation = page.locator('[data-testid="loading-animation"], .loading-animation')

    // Chat
    this.chatContainer = page.locator('[data-testid="chat-container"], .chat-container')
    this.chatInput = page.locator('textarea, input[type="text"]').last()
    this.chatMessages = page.locator('[data-testid="chat-message"], .chat-message')
    this.sendButton = page.locator('button[type="submit"], button[aria-label*="send"], button[aria-label*="发送"]')

    // Conversion
    this.pricingCards = page.locator('[data-testid="pricing-card"], .pricing-card')
    this.subscribeButton = page.getByRole('button', { name: /订阅|开通|升级|购买/i })
    this.planOptions = page.locator('[data-testid="plan-option"], .plan-option')

    // Common
    this.errorMessage = page.locator('[data-testid="error"], .error-message, .text-red-500, [role="alert"]')
    this.backButton = page.locator('button[aria-label*="back"], button[aria-label*="返回"], a[href*="back"]')
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // 导航方法
  // ═══════════════════════════════════════════════════════════════════════════

  async goto(variant: Variant = 'bazi') {
    await this.page.goto(`/onboarding?variant=${variant}`)
    await this.page.waitForLoadState('networkidle')
  }

  async gotoStep(step: OnboardingStep, variant: Variant = 'bazi') {
    await this.page.goto(`/onboarding?variant=${variant}&step=${step}`)
    await this.page.waitForLoadState('networkidle')
  }

  async gotoChat() {
    await this.page.goto('/chat')
    await this.page.waitForLoadState('networkidle')
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // Landing Step 方法
  // ═══════════════════════════════════════════════════════════════════════════

  async fillBirthInfo(birthInfo: BirthInfo): Promise<boolean> {
    // 尝试分离的输入框
    if (await this.yearInput.isVisible() && await this.monthInput.isVisible() && await this.dayInput.isVisible()) {
      await this.yearInput.fill(birthInfo.year.toString())
      await this.monthInput.fill(birthInfo.month.toString())
      await this.dayInput.fill(birthInfo.day.toString())

      if (birthInfo.hour !== undefined && await this.hourInput.isVisible()) {
        await this.hourInput.fill(birthInfo.hour.toString())
      }
      return true
    }

    // 尝试 date picker
    if (await this.dateInput.isVisible()) {
      const dateStr = `${birthInfo.year}-${String(birthInfo.month).padStart(2, '0')}-${String(birthInfo.day).padStart(2, '0')}`
      await this.dateInput.fill(dateStr)
      return true
    }

    return false
  }

  async clickContinue(): Promise<boolean> {
    if (await this.continueButton.isVisible() && await this.continueButton.isEnabled()) {
      await this.continueButton.click()
      await this.page.waitForTimeout(1000)
      return true
    }
    return false
  }

  async getHeadlineText(): Promise<string | null> {
    if (await this.headline.isVisible()) {
      return await this.headline.textContent()
    }
    return null
  }

  async hasError(): Promise<boolean> {
    return await this.errorMessage.first().isVisible().catch(() => false)
  }

  async getErrorText(): Promise<string | null> {
    if (await this.hasError()) {
      return await this.errorMessage.first().textContent()
    }
    return null
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // Loading Step 方法
  // ═══════════════════════════════════════════════════════════════════════════

  async waitForLoadingComplete(timeout = 30000): Promise<void> {
    // 等待进度条消失或到达 100%
    await this.page.waitForFunction(
      () => {
        const progress = document.querySelector('[data-testid="progress"], .progress-bar, [role="progressbar"]')
        if (!progress) return true // 进度条已消失
        const width = progress.getAttribute('style')?.match(/width:\s*(\d+)%/)
        return width && parseInt(width[1]) >= 100
      },
      { timeout }
    ).catch(() => {
      // 超时不抛错，继续执行
    })
  }

  async getLoadingProgress(): Promise<number> {
    const progressEl = this.progressBar.first()
    if (await progressEl.isVisible()) {
      const style = await progressEl.getAttribute('style')
      const match = style?.match(/width:\s*(\d+)%/)
      return match ? parseInt(match[1]) : 0
    }
    return 0
  }

  async getCompletedSteps(): Promise<number> {
    const steps = this.loadingSteps
    let completed = 0
    const count = await steps.count()
    for (let i = 0; i < count; i++) {
      const step = steps.nth(i)
      const classList = await step.getAttribute('class')
      if (classList?.includes('completed') || classList?.includes('done')) {
        completed++
      }
    }
    return completed
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // Chat Step 方法
  // ═══════════════════════════════════════════════════════════════════════════

  async sendMessage(message: string): Promise<void> {
    await this.chatInput.fill(message)
    await this.chatInput.press('Enter')
  }

  async waitForResponse(timeout = 10000): Promise<void> {
    const initialCount = await this.chatMessages.count()
    await this.page.waitForFunction(
      (initial) => {
        const messages = document.querySelectorAll('[data-testid="chat-message"], .chat-message')
        return messages.length > initial
      },
      initialCount,
      { timeout }
    ).catch(() => {})
  }

  async getLastMessage(): Promise<string | null> {
    const count = await this.chatMessages.count()
    if (count > 0) {
      return await this.chatMessages.nth(count - 1).textContent()
    }
    return null
  }

  async isChatReady(): Promise<boolean> {
    return await this.chatInput.isVisible() && await this.chatInput.isEnabled()
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // Conversion Step 方法
  // ═══════════════════════════════════════════════════════════════════════════

  async selectPlan(planIndex: number): Promise<void> {
    const plan = this.planOptions.nth(planIndex)
    if (await plan.isVisible()) {
      await plan.click()
    }
  }

  async clickSubscribe(): Promise<void> {
    if (await this.subscribeButton.first().isVisible()) {
      await this.subscribeButton.first().click()
    }
  }

  async getPricingOptions(): Promise<number> {
    return await this.pricingCards.count()
  }

  // ═══════════════════════════════════════════════════════════════════════════
  // 工具方法
  // ═══════════════════════════════════════════════════════════════════════════

  async screenshot(name: string): Promise<void> {
    await this.page.screenshot({
      path: `test-results/${name}.png`,
      fullPage: true,
    })
  }

  async getCurrentStep(): Promise<OnboardingStep | null> {
    const url = this.page.url()
    const stepMatch = url.match(/step=(\w+)/)
    if (stepMatch) {
      return stepMatch[1] as OnboardingStep
    }
    // 默认是 landing
    if (url.includes('/onboarding') && !url.includes('step=')) {
      return 'landing'
    }
    return null
  }

  async setLocalStorage(key: string, value: object): Promise<void> {
    await this.page.evaluate(
      ([k, v]) => {
        localStorage.setItem(k, JSON.stringify(v))
      },
      [key, value]
    )
  }

  async getLocalStorage(key: string): Promise<object | null> {
    return await this.page.evaluate((k) => {
      const value = localStorage.getItem(k)
      return value ? JSON.parse(value) : null
    }, key)
  }

  async clearLocalStorage(): Promise<void> {
    await this.page.evaluate(() => localStorage.clear())
  }
}
