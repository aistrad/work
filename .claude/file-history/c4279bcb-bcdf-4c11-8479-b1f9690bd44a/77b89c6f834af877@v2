#!/bin/bash

# ═══════════════════════════════════════════════════════════════════════════
# VibeLife E2E 测试运行脚本
# ═══════════════════════════════════════════════════════════════════════════

set -e

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 默认配置
TEST_URL="${TEST_URL:-http://localhost:3000}"
WORKERS="${WORKERS:-1}"
RETRIES="${RETRIES:-0}"
HEADED="${HEADED:-false}"

# 打印帮助信息
print_help() {
    echo "VibeLife E2E 测试运行脚本"
    echo ""
    echo "用法: $0 [选项] [测试文件/模式]"
    echo ""
    echo "选项:"
    echo "  -h, --help          显示帮助信息"
    echo "  -u, --url URL       测试目标 URL (默认: http://localhost:3000)"
    echo "  -w, --workers N     并行 worker 数量 (默认: 1)"
    echo "  -r, --retries N     失败重试次数 (默认: 0)"
    echo "  --headed            使用有头模式运行 (显示浏览器)"
    echo "  --debug             调试模式 (单步执行)"
    echo "  --ui                使用 Playwright UI 模式"
    echo ""
    echo "测试套件:"
    echo "  all                 运行所有测试"
    echo "  onboarding          运行 Onboarding 测试"
    echo "  skills              运行 Skills 测试"
    echo "  scenarios           运行用户场景测试"
    echo "  comprehensive       运行综合测试"
    echo ""
    echo "示例:"
    echo "  $0                           # 运行所有测试"
    echo "  $0 onboarding                # 只运行 onboarding 测试"
    echo "  $0 skills --headed           # 有头模式运行 skills 测试"
    echo "  $0 --url https://staging.example.com all"
    echo ""
}

# 检查依赖
check_dependencies() {
    echo -e "${BLUE}检查依赖...${NC}"

    if ! command -v npx &> /dev/null; then
        echo -e "${RED}错误: 未找到 npx，请安装 Node.js${NC}"
        exit 1
    fi

    if [ ! -f "playwright.config.ts" ]; then
        echo -e "${RED}错误: 未找到 playwright.config.ts，请在项目根目录运行${NC}"
        exit 1
    fi

    # 检查浏览器是否已安装
    if ! npx playwright install --dry-run &> /dev/null; then
        echo -e "${YELLOW}安装 Playwright 浏览器...${NC}"
        npx playwright install chromium
    fi

    echo -e "${GREEN}依赖检查完成${NC}"
}

# 准备测试目录
prepare_directories() {
    echo -e "${BLUE}准备测试目录...${NC}"

    mkdir -p test-results
    mkdir -p test-results/comprehensive
    mkdir -p test-results/responsive
    mkdir -p playwright-report

    echo -e "${GREEN}测试目录准备完成${NC}"
}

# 运行测试
run_tests() {
    local test_pattern="$1"
    local extra_args="$2"

    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${BLUE}运行测试: ${test_pattern:-所有}${NC}"
    echo -e "${BLUE}目标 URL: ${TEST_URL}${NC}"
    echo -e "${BLUE}═══════════════════════════════════════════════════════════════${NC}"

    local cmd="npx playwright test"

    # 添加测试文件
    if [ -n "$test_pattern" ]; then
        cmd="$cmd $test_pattern"
    fi

    # 添加环境变量和参数
    cmd="TEST_URL=${TEST_URL} $cmd"
    cmd="$cmd --workers=${WORKERS}"
    cmd="$cmd --retries=${RETRIES}"

    if [ "$HEADED" = "true" ]; then
        cmd="$cmd --headed"
    fi

    if [ -n "$extra_args" ]; then
        cmd="$cmd $extra_args"
    fi

    echo -e "${YELLOW}执行命令: $cmd${NC}"
    echo ""

    eval $cmd
    local exit_code=$?

    if [ $exit_code -eq 0 ]; then
        echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
        echo -e "${GREEN}✓ 测试通过!${NC}"
        echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    else
        echo -e "${RED}═══════════════════════════════════════════════════════════════${NC}"
        echo -e "${RED}✗ 测试失败 (exit code: $exit_code)${NC}"
        echo -e "${RED}═══════════════════════════════════════════════════════════════${NC}"
    fi

    return $exit_code
}

# 显示测试报告
show_report() {
    echo ""
    echo -e "${BLUE}测试报告已生成:${NC}"
    echo -e "  HTML 报告: playwright-report/index.html"
    echo -e "  JSON 报告: playwright-report/results.json"
    echo -e "  截图目录: test-results/"
    echo ""
    echo -e "${YELLOW}查看报告: npx playwright show-report${NC}"
}

# 主函数
main() {
    local test_suite=""
    local extra_args=""
    local debug_mode=false
    local ui_mode=false

    # 解析参数
    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                print_help
                exit 0
                ;;
            -u|--url)
                TEST_URL="$2"
                shift 2
                ;;
            -w|--workers)
                WORKERS="$2"
                shift 2
                ;;
            -r|--retries)
                RETRIES="$2"
                shift 2
                ;;
            --headed)
                HEADED=true
                shift
                ;;
            --debug)
                debug_mode=true
                shift
                ;;
            --ui)
                ui_mode=true
                shift
                ;;
            all|onboarding|skills|scenarios|comprehensive)
                test_suite="$1"
                shift
                ;;
            *)
                extra_args="$extra_args $1"
                shift
                ;;
        esac
    done

    # 检查依赖
    check_dependencies

    # 准备目录
    prepare_directories

    # UI 模式
    if [ "$ui_mode" = true ]; then
        echo -e "${BLUE}启动 Playwright UI 模式...${NC}"
        TEST_URL=${TEST_URL} npx playwright test --ui
        exit $?
    fi

    # 调试模式
    if [ "$debug_mode" = true ]; then
        echo -e "${BLUE}启动调试模式...${NC}"
        TEST_URL=${TEST_URL} npx playwright test --debug $extra_args
        exit $?
    fi

    # 根据测试套件选择测试文件
    local test_pattern=""
    case $test_suite in
        onboarding)
            test_pattern="tests/e2e/onboarding*.spec.ts"
            ;;
        skills)
            test_pattern="tests/e2e/skills.spec.ts"
            ;;
        scenarios)
            test_pattern="tests/e2e/user-scenarios.spec.ts"
            ;;
        comprehensive)
            test_pattern="tests/e2e/onboarding-comprehensive.spec.ts"
            ;;
        all|"")
            test_pattern=""
            ;;
    esac

    # 运行测试
    run_tests "$test_pattern" "$extra_args"
    local result=$?

    # 显示报告
    show_report

    exit $result
}

# 执行主函数
main "$@"
