/**
 * Skills E2E 测试套件
 *
 * 覆盖所有 Skill 的端到端测试：
 * - bazi (八字命理)
 * - zodiac (西方占星)
 * - jungastro (荣格心理占星)
 * - tarot (塔罗占卜)
 * - psych (心理探索)
 * - mindfulness (正念导师)
 * - synastry (关系合盘)
 * - vibe_id (VibeID人格画像)
 * - lifecoach (人生教练)
 * - career (职业规划)
 */

import { test, expect } from '@playwright/test'
import { ChatPage, SkillId } from './pages/ChatPage'
import { OnboardingPage } from './pages/OnboardingPage'

// ═══════════════════════════════════════════════════════════════════════════
// 测试配置
// ═══════════════════════════════════════════════════════════════════════════

const TEST_TIMEOUT = 60000 // 60 秒超时，等待 LLM 响应

interface SkillTestConfig {
  id: SkillId
  name: string
  triggers: string[]
  expectedTools?: string[]
  requiresBirthInfo: boolean
  sampleQueries: string[]
}

const SKILL_CONFIGS: SkillTestConfig[] = [
  {
    id: 'bazi',
    name: '八字命理',
    triggers: ['八字', '命理', '算命', '看命', '排盘'],
    expectedTools: ['show_bazi_chart', 'show_bazi_fortune'],
    requiresBirthInfo: true,
    sampleQueries: [
      '帮我看看八字',
      '我的命盘怎么样',
      '今年运势如何',
      '分析一下我的格局',
    ],
  },
  {
    id: 'zodiac',
    name: '西方占星',
    triggers: ['星座', '星盘', '占星', '上升', '月亮星座'],
    expectedTools: ['show_zodiac_chart'],
    requiresBirthInfo: true,
    sampleQueries: [
      '看看我的星盘',
      '我的上升星座是什么',
      '分析我的太阳月亮上升',
      '最近水星逆行对我有什么影响',
    ],
  },
  {
    id: 'tarot',
    name: '塔罗占卜',
    triggers: ['塔罗', '抽牌', '占卜', '牌阵'],
    expectedTools: ['draw_tarot', 'show_tarot_spread'],
    requiresBirthInfo: false,
    sampleQueries: [
      '帮我抽一张塔罗牌',
      '做一个三张牌的牌阵',
      '用塔罗看看我的感情',
      '抽一张今日指引牌',
    ],
  },
  {
    id: 'psych',
    name: '心理探索',
    triggers: ['心理', '焦虑', '抑郁', '压力', '情绪'],
    expectedTools: ['show_assessment', 'show_distortion_analysis'],
    requiresBirthInfo: false,
    sampleQueries: [
      '我最近很焦虑',
      '帮我分析一下我的心理状态',
      '我觉得很压抑怎么办',
      '做一个心理测试',
    ],
  },
  {
    id: 'mindfulness',
    name: '正念导师',
    triggers: ['正念', '冥想', '呼吸', '放松', '睡不着'],
    expectedTools: ['show_practice_guide', 'show_emotion_check'],
    requiresBirthInfo: false,
    sampleQueries: [
      '带我做一个呼吸练习',
      '我睡不着觉',
      '教我正念冥想',
      '我需要放松一下',
    ],
  },
  {
    id: 'lifecoach',
    name: '人生教练',
    triggers: ['人生规划', '目标', '迷茫', '拖延', 'Dan Koe', '王阳明'],
    expectedTools: ['show_action_plan', 'show_weekly_review'],
    requiresBirthInfo: false,
    sampleQueries: [
      '我感到很迷茫',
      '帮我制定一个目标',
      '用 Dan Koe 的方法分析我',
      '怎么克服拖延症',
    ],
  },
  {
    id: 'career',
    name: '职业规划',
    triggers: ['职业', '工作', '跳槽', '面试', '升职'],
    expectedTools: ['show_career_analysis'],
    requiresBirthInfo: false,
    sampleQueries: [
      '我想转行怎么办',
      '帮我分析一下职业方向',
      '面试应该注意什么',
      '我该不该跳槽',
    ],
  },
  {
    id: 'synastry',
    name: '关系合盘',
    triggers: ['合盘', '配对', '关系分析', '八字合婚'],
    requiresBirthInfo: true,
    sampleQueries: [
      '帮我们看看合盘',
      '我和ta合不合',
      '分析我们的关系',
    ],
  },
  {
    id: 'vibe_id',
    name: 'VibeID人格画像',
    triggers: ['人格画像', 'VibeID', '原型分析', '性格分析'],
    requiresBirthInfo: true,
    sampleQueries: [
      '分析我的人格原型',
      '我的 VibeID 是什么',
      '帮我做一个性格分析',
    ],
  },
]

// ═══════════════════════════════════════════════════════════════════════════
// Skill 触发测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('Skill 触发测试', () => {
  test.setTimeout(TEST_TIMEOUT)

  for (const skillConfig of SKILL_CONFIGS) {
    test.describe(`${skillConfig.name} (${skillConfig.id})`, () => {
      test(`关键词触发: "${skillConfig.triggers[0]}"`, async ({ page }) => {
        const chatPage = new ChatPage(page)
        await chatPage.goto()
        await chatPage.waitForChatReady()

        // 使用第一个触发词
        const trigger = skillConfig.triggers[0]
        await chatPage.sendMessage(trigger)

        // 等待响应
        await chatPage.waitForResponse(30000)
        await chatPage.screenshot(`skill-${skillConfig.id}-trigger`)

        // 验证有响应
        const lastMessage = await chatPage.getLastAssistantMessage()
        expect(lastMessage).not.toBeNull()
        expect(lastMessage!.length).toBeGreaterThan(10)
      })

      test(`样例查询: "${skillConfig.sampleQueries[0]}"`, async ({ page }) => {
        const chatPage = new ChatPage(page)
        await chatPage.goto()
        await chatPage.waitForChatReady()

        await chatPage.sendMessage(skillConfig.sampleQueries[0])
        await chatPage.waitForResponse(30000)
        await chatPage.screenshot(`skill-${skillConfig.id}-query`)

        const lastMessage = await chatPage.getLastAssistantMessage()
        expect(lastMessage).not.toBeNull()
      })
    })
  }
})

// ═══════════════════════════════════════════════════════════════════════════
// Skill Tool 调用测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('Skill Tool 调用测试', () => {
  test.setTimeout(TEST_TIMEOUT)

  test('Bazi: show_bazi_chart 工具调用', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('帮我排八字命盘')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-bazi-chart-tool')

    // 检查是否有 tool card 显示
    const hasToolCard = await chatPage.hasToolCard()
    // Tool card 是可选的，取决于 UI 实现
  })

  test('Tarot: draw_tarot 工具调用', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('抽一张塔罗牌')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-tarot-draw-tool')

    const lastMessage = await chatPage.getLastAssistantMessage()
    // 应该包含塔罗牌相关内容
    expect(lastMessage).not.toBeNull()
  })

  test('Mindfulness: 呼吸练习引导', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('带我做呼吸练习')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-mindfulness-breathing')

    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()
    // 应该包含呼吸相关指引
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// Skill 切换测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('Skill 切换测试', () => {
  test.setTimeout(TEST_TIMEOUT)

  test('从八字切换到塔罗', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    // 先用八字
    await chatPage.sendMessage('看看我的八字')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-switch-01-bazi')

    // 切换到塔罗
    await chatPage.sendMessage('抽一张塔罗牌')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-switch-02-tarot')

    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()
  })

  test('从心理切换到正念', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('我感到焦虑')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-switch-psych')

    await chatPage.sendMessage('带我做个冥想')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-switch-mindfulness')
  })

  test('多轮对话保持 Skill 上下文', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    // 第一轮
    await chatPage.sendMessage('我最近工作不顺')
    await chatPage.waitForResponse(30000)

    // 第二轮 - 应该保持 career/lifecoach 上下文
    await chatPage.sendMessage('那我应该怎么办')
    await chatPage.waitForResponse(30000)

    // 第三轮
    await chatPage.sendMessage('有什么具体建议吗')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-multi-turn-context')
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// Lifecoach 场景测试 (多种方法论)
// ═══════════════════════════════════════════════════════════════════════════

test.describe('Lifecoach 场景测试', () => {
  test.setTimeout(TEST_TIMEOUT)

  test('Dan Koe 方法', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('用 Dan Koe 的方法帮我分析')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-lifecoach-dankoe')

    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()
  })

  test('Covey 七个习惯', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('教我高效能人士的七个习惯')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-lifecoach-covey')
  })

  test('王阳明心学', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('用王阳明的智慧指导我')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-lifecoach-yangming')
  })

  test('了凡四训', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('用了凡四训的思想帮我')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-lifecoach-liaofan')
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// Onboarding + Skill 集成测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('Onboarding + Skill 集成测试', () => {
  test.setTimeout(90000) // 更长的超时时间

  test('Bazi Onboarding 完整流程', async ({ page }) => {
    const onboardingPage = new OnboardingPage(page)
    await onboardingPage.goto('bazi')

    // 填写生日
    const filled = await onboardingPage.fillBirthInfo({
      year: 1990,
      month: 6,
      day: 15,
      hour: 10,
    })

    if (filled) {
      await onboardingPage.clickContinue()

      // 等待 loading 完成
      await page.waitForTimeout(15000)
      await onboardingPage.screenshot('integration-bazi-loading')

      // 检查是否进入聊天
      const chatPage = new ChatPage(page)
      const isReady = await chatPage.isChatReady()

      if (isReady) {
        await chatPage.sendMessage('分析我的命盘')
        await chatPage.waitForResponse(30000)
        await chatPage.screenshot('integration-bazi-chat')
      }
    }
  })

  test('Zodiac Onboarding 完整流程', async ({ page }) => {
    const onboardingPage = new OnboardingPage(page)
    await onboardingPage.goto('zodiac')

    const filled = await onboardingPage.fillBirthInfo({
      year: 1995,
      month: 3,
      day: 21,
    })

    if (filled) {
      await onboardingPage.clickContinue()
      await page.waitForTimeout(15000)
      await onboardingPage.screenshot('integration-zodiac-flow')
    }
  })

  test('Dankoe 直接对话流程', async ({ page }) => {
    const onboardingPage = new OnboardingPage(page)
    await onboardingPage.goto('dankoe')

    // Dankoe 应该直接进入聊天
    await page.waitForTimeout(3000)
    await onboardingPage.screenshot('integration-dankoe-start')

    const chatPage = new ChatPage(page)
    const isReady = await chatPage.isChatReady()

    if (isReady) {
      await chatPage.sendMessage('我想改变我的人生')
      await chatPage.waitForResponse(30000)
      await chatPage.screenshot('integration-dankoe-chat')
    }
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// Skill 错误处理测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('Skill 错误处理', () => {
  test.setTimeout(TEST_TIMEOUT)

  test('模糊查询的处理', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    // 模糊的查询
    await chatPage.sendMessage('帮帮我')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-error-ambiguous')

    // 应该有某种回应（可能是询问更多信息）
    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()
  })

  test('无关查询的处理', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('今天天气怎么样')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-error-irrelevant')

    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()
  })

  test('超长输入的处理', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    const longText = '我'.repeat(2000)
    await chatPage.sendMessage(longText)
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-error-long-input')
  })

  test('特殊字符输入的处理', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('帮我看看<script>alert(1)</script>八字')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('skill-error-special-chars')

    // 页面不应该崩溃
    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// Skill 响应质量测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('Skill 响应质量', () => {
  test.setTimeout(TEST_TIMEOUT)

  test('八字响应包含关键元素', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('帮我排八字看看')
    await chatPage.waitForResponse(30000)

    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()

    // 检查是否包含八字相关术语
    const baziTerms = ['日主', '格局', '五行', '大运', '流年', '天干', '地支']
    const hasRelevantContent = baziTerms.some(
      (term) => lastMessage!.includes(term)
    )
    // 可选断言，取决于实际响应
  })

  test('塔罗响应包含牌面解读', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('抽一张塔罗牌')
    await chatPage.waitForResponse(30000)

    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()
    expect(lastMessage!.length).toBeGreaterThan(50)
  })

  test('心理响应具有共情性', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage('我最近很难过')
    await chatPage.waitForResponse(30000)

    const lastMessage = await chatPage.getLastAssistantMessage()
    expect(lastMessage).not.toBeNull()

    // 响应不应该太短
    expect(lastMessage!.length).toBeGreaterThan(30)
  })
})
