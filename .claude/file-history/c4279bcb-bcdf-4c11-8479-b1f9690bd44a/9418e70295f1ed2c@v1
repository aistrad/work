/**
 * 用户场景 E2E 测试
 *
 * 基于真实用户场景的端到端测试
 * 覆盖各种用户类型和使用场景
 */

import { test, expect } from '@playwright/test'
import { ChatPage } from './pages/ChatPage'
import { OnboardingPage } from './pages/OnboardingPage'
import { BIRTH_DATES, USER_SCENARIOS, BOUNDARY_TESTS, ERROR_SCENARIOS, VIEWPORTS } from './fixtures/test-data'

// ═══════════════════════════════════════════════════════════════════════════
// 新用户完整旅程测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('新用户完整旅程', () => {
  test.setTimeout(120000) // 2分钟超时

  test('八字用户: Onboarding → 首次洞察 → 多轮对话', async ({ page }) => {
    const scenario = USER_SCENARIOS.find((s) => s.id === 'new-user-bazi')!
    const onboardingPage = new OnboardingPage(page)

    // Step 1: 进入 Onboarding
    await onboardingPage.goto(scenario.variant)
    await onboardingPage.screenshot('scenario-bazi-01-landing')

    // Step 2: 填写生日
    if (scenario.birthInfo) {
      const filled = await onboardingPage.fillBirthInfo(scenario.birthInfo)
      expect(filled).toBe(true)
      await onboardingPage.screenshot('scenario-bazi-02-filled')
    }

    // Step 3: 提交并等待 Loading
    await onboardingPage.clickContinue()
    await page.waitForTimeout(5000)
    await onboardingPage.screenshot('scenario-bazi-03-loading')

    // Step 4: 等待进入聊天
    await page.waitForTimeout(15000)
    await onboardingPage.screenshot('scenario-bazi-04-chat-entry')

    // Step 5: 发送初始消息
    const chatPage = new ChatPage(page)
    if (await chatPage.isChatReady()) {
      await chatPage.sendMessage(scenario.initialMessage)
      await chatPage.waitForResponse(30000)
      await chatPage.screenshot('scenario-bazi-05-first-response')

      // Step 6: 后续对话
      for (let i = 0; i < scenario.followUpMessages.length; i++) {
        await chatPage.sendMessage(scenario.followUpMessages[i])
        await chatPage.waitForResponse(30000)
        await chatPage.screenshot(`scenario-bazi-06-followup-${i + 1}`)
      }
    }
  })

  test('星座用户: 完整星盘分析流程', async ({ page }) => {
    const scenario = USER_SCENARIOS.find((s) => s.id === 'new-user-zodiac')!
    const onboardingPage = new OnboardingPage(page)

    await onboardingPage.goto(scenario.variant)

    if (scenario.birthInfo) {
      await onboardingPage.fillBirthInfo(scenario.birthInfo)
    }

    await onboardingPage.clickContinue()
    await page.waitForTimeout(20000)
    await onboardingPage.screenshot('scenario-zodiac-after-loading')

    const chatPage = new ChatPage(page)
    if (await chatPage.isChatReady()) {
      await chatPage.sendMessage(scenario.initialMessage)
      await chatPage.waitForResponse(30000)
      await chatPage.screenshot('scenario-zodiac-response')
    }
  })

  test('Dankoe 用户: 直接对话模式', async ({ page }) => {
    const scenario = USER_SCENARIOS.find((s) => s.id === 'new-user-dankoe')!
    const onboardingPage = new OnboardingPage(page)

    await onboardingPage.goto(scenario.variant)
    await page.waitForTimeout(3000)
    await onboardingPage.screenshot('scenario-dankoe-entry')

    // Dankoe 跳过生日输入，直接进入对话
    const chatPage = new ChatPage(page)
    if (await chatPage.isChatReady()) {
      await chatPage.sendMessage(scenario.initialMessage)
      await chatPage.waitForResponse(30000)
      await chatPage.screenshot('scenario-dankoe-response')
    }
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 特定需求用户场景
// ═══════════════════════════════════════════════════════════════════════════

test.describe('特定需求用户', () => {
  test.setTimeout(90000)

  test('焦虑用户: 寻求心理支持', async ({ page }) => {
    const scenario = USER_SCENARIOS.find((s) => s.id === 'anxious-user')!
    const chatPage = new ChatPage(page)

    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage(scenario.initialMessage)
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('scenario-anxious-01')

    const response = await chatPage.getLastAssistantMessage()
    expect(response).not.toBeNull()
    // 响应应该具有共情性，不应该太短
    expect(response!.length).toBeGreaterThan(50)

    // 后续对话
    await chatPage.sendMessage(scenario.followUpMessages[0])
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('scenario-anxious-02')
  })

  test('职业转型用户: 综合分析', async ({ page }) => {
    const scenario = USER_SCENARIOS.find((s) => s.id === 'career-transition')!
    const chatPage = new ChatPage(page)

    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage(scenario.initialMessage)
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('scenario-career-01')

    // 追问命理角度
    await chatPage.sendMessage(scenario.followUpMessages[0])
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('scenario-career-02')
  })

  test('感情咨询用户: 星座分析', async ({ page }) => {
    const scenario = USER_SCENARIOS.find((s) => s.id === 'relationship-inquiry')!
    const chatPage = new ChatPage(page)

    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage(scenario.initialMessage)
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('scenario-relationship-01')

    for (const followUp of scenario.followUpMessages) {
      await chatPage.sendMessage(followUp)
      await chatPage.waitForResponse(30000)
    }
    await chatPage.screenshot('scenario-relationship-final')
  })

  test('自我提升用户: Lifecoach 深度对话', async ({ page }) => {
    const scenario = USER_SCENARIOS.find((s) => s.id === 'self-improvement')!
    const chatPage = new ChatPage(page)

    await chatPage.goto()
    await chatPage.waitForChatReady()

    await chatPage.sendMessage(scenario.initialMessage)
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('scenario-improvement-01')

    // 多轮深入对话
    for (let i = 0; i < scenario.followUpMessages.length; i++) {
      await chatPage.sendMessage(scenario.followUpMessages[i])
      await chatPage.waitForResponse(30000)
      await chatPage.screenshot(`scenario-improvement-${i + 2}`)
    }
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 边界值和异常场景
// ═══════════════════════════════════════════════════════════════════════════

test.describe('边界值测试', () => {
  test.setTimeout(60000)

  test.describe('年份边界', () => {
    test('最小有效年份 (1900)', async ({ page }) => {
      const onboardingPage = new OnboardingPage(page)
      await onboardingPage.goto('bazi')

      await onboardingPage.fillBirthInfo({
        year: BOUNDARY_TESTS.years.min,
        month: 1,
        day: 1,
      })
      await onboardingPage.screenshot('boundary-year-min')
    })

    test('最大有效年份 (2100)', async ({ page }) => {
      const onboardingPage = new OnboardingPage(page)
      await onboardingPage.goto('bazi')

      await onboardingPage.fillBirthInfo({
        year: BOUNDARY_TESTS.years.max,
        month: 12,
        day: 31,
      })
      await onboardingPage.screenshot('boundary-year-max')
    })

    test('无效年份处理', async ({ page }) => {
      const onboardingPage = new OnboardingPage(page)
      await onboardingPage.goto('bazi')

      for (const invalidYear of BOUNDARY_TESTS.years.invalid.slice(0, 2)) {
        await onboardingPage.fillBirthInfo({
          year: invalidYear,
          month: 1,
          day: 1,
        })
        await page.waitForTimeout(500)
      }
      await onboardingPage.screenshot('boundary-year-invalid')
    })
  })

  test.describe('日期边界', () => {
    test('闰年2月29日', async ({ page }) => {
      const onboardingPage = new OnboardingPage(page)
      await onboardingPage.goto('bazi')

      await onboardingPage.fillBirthInfo(BIRTH_DATES.leapYear)
      await onboardingPage.screenshot('boundary-leap-year')
    })

    test('各月份最大日期', async ({ page }) => {
      const onboardingPage = new OnboardingPage(page)
      await onboardingPage.goto('bazi')

      // 31天月份
      await onboardingPage.fillBirthInfo({ year: 1990, month: 1, day: 31 })
      await page.waitForTimeout(300)

      // 30天月份
      await onboardingPage.fillBirthInfo({ year: 1990, month: 4, day: 30 })
      await page.waitForTimeout(300)

      // 2月28日
      await onboardingPage.fillBirthInfo({ year: 1990, month: 2, day: 28 })
      await onboardingPage.screenshot('boundary-month-max-days')
    })
  })

  test.describe('时辰边界', () => {
    test('所有时辰测试', async ({ page }) => {
      const onboardingPage = new OnboardingPage(page)
      await onboardingPage.goto('bazi')

      const hours = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 23]
      for (const hour of hours) {
        await onboardingPage.fillBirthInfo({
          year: 1990,
          month: 6,
          day: 15,
          hour,
        })
        await page.waitForTimeout(200)
      }
      await onboardingPage.screenshot('boundary-hours')
    })
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 错误处理场景
// ═══════════════════════════════════════════════════════════════════════════

test.describe('错误处理', () => {
  test.setTimeout(60000)

  test.describe('输入错误', () => {
    test('空输入', async ({ page }) => {
      const chatPage = new ChatPage(page)
      await chatPage.goto()
      await chatPage.waitForChatReady()

      await chatPage.sendMessage('')
      await page.waitForTimeout(1000)
      await chatPage.screenshot('error-empty-input')
    })

    test('超长输入', async ({ page }) => {
      const chatPage = new ChatPage(page)
      await chatPage.goto()
      await chatPage.waitForChatReady()

      const longInput = '我想知道'.repeat(500)
      await chatPage.sendMessage(longInput)
      await chatPage.waitForResponse(30000)
      await chatPage.screenshot('error-long-input')
    })

    test('特殊字符 (XSS 尝试)', async ({ page }) => {
      const chatPage = new ChatPage(page)
      await chatPage.goto()
      await chatPage.waitForChatReady()

      await chatPage.sendMessage('<script>alert("xss")</script>帮我看八字')
      await chatPage.waitForResponse(30000)
      await chatPage.screenshot('error-xss-attempt')

      // 页面不应崩溃
      expect(await chatPage.isChatReady()).toBe(true)
    })
  })

  test.describe('网络错误', () => {
    test('API 超时恢复', async ({ page }) => {
      // 模拟慢速网络
      await page.route('**/api/v1/chat/**', async (route) => {
        await new Promise((resolve) => setTimeout(resolve, 10000))
        await route.continue()
      })

      const chatPage = new ChatPage(page)
      await chatPage.goto()
      await chatPage.waitForChatReady()

      await chatPage.sendMessage('你好')
      await page.waitForTimeout(15000)
      await chatPage.screenshot('error-timeout')

      // 清除路由
      await page.unroute('**/api/v1/chat/**')
    })

    test('API 500 错误', async ({ page }) => {
      await page.route('**/api/v1/chat/**', (route) => {
        route.fulfill({
          status: 500,
          contentType: 'application/json',
          body: JSON.stringify({ error: 'Internal Server Error' }),
        })
      })

      const chatPage = new ChatPage(page)
      await chatPage.goto()
      await chatPage.waitForChatReady()

      await chatPage.sendMessage('你好')
      await page.waitForTimeout(5000)
      await chatPage.screenshot('error-500')

      await page.unroute('**/api/v1/chat/**')
    })
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 响应式测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('响应式设计', () => {
  for (const viewport of VIEWPORTS.slice(0, 4)) {
    // 测试前4个视口
    test(`${viewport.name} (${viewport.width}x${viewport.height})`, async ({ page }) => {
      await page.setViewportSize({ width: viewport.width, height: viewport.height })

      const onboardingPage = new OnboardingPage(page)
      await onboardingPage.goto('bazi')
      await onboardingPage.screenshot(`responsive-${viewport.name.replace(' ', '-')}-landing`)

      await onboardingPage.fillBirthInfo(BIRTH_DATES.standard)
      await onboardingPage.screenshot(`responsive-${viewport.name.replace(' ', '-')}-filled`)

      // 测试聊天页面
      const chatPage = new ChatPage(page)
      await chatPage.goto()
      await chatPage.screenshot(`responsive-${viewport.name.replace(' ', '-')}-chat`)
    })
  }
})

// ═══════════════════════════════════════════════════════════════════════════
// 多轮对话上下文保持
// ═══════════════════════════════════════════════════════════════════════════

test.describe('对话上下文', () => {
  test.setTimeout(120000)

  test('多轮对话上下文保持', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    // 第一轮: 建立话题
    await chatPage.sendMessage('我1990年6月15日出生，帮我看看八字')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('context-01-setup')

    // 第二轮: 引用上下文
    await chatPage.sendMessage('那我的日主是什么')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('context-02-reference')

    // 第三轮: 深入追问
    await chatPage.sendMessage('对我的事业有什么影响')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('context-03-followup')

    // 第四轮: 切换话题但保持身份
    await chatPage.sendMessage('感情方面呢')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('context-04-switch')

    // 验证消息数量
    const messageCount = await chatPage.getMessageCount()
    expect(messageCount).toBeGreaterThanOrEqual(8) // 4轮对话，每轮2条
  })

  test('Skill 切换保持用户身份', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    // 八字分析
    await chatPage.sendMessage('看看我的八字命盘')
    await chatPage.waitForResponse(30000)

    // 切换到塔罗
    await chatPage.sendMessage('抽一张塔罗牌')
    await chatPage.waitForResponse(30000)

    // 切换到心理
    await chatPage.sendMessage('我最近心情不好')
    await chatPage.waitForResponse(30000)

    await chatPage.screenshot('context-skill-switch')
  })
})

// ═══════════════════════════════════════════════════════════════════════════
// 会话恢复测试
// ═══════════════════════════════════════════════════════════════════════════

test.describe('会话恢复', () => {
  test('页面刷新后恢复对话', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    // 发送消息
    await chatPage.sendMessage('你好，记住我叫小明')
    await chatPage.waitForResponse(30000)
    await chatPage.screenshot('session-01-before-refresh')

    // 刷新页面
    await page.reload()
    await page.waitForLoadState('networkidle')
    await page.waitForTimeout(2000)
    await chatPage.screenshot('session-02-after-refresh')

    // 检查对话历史是否保留
    const messageCount = await chatPage.getMessageCount()
    // 根据实现，消息可能保留也可能不保留
  })

  test('新会话清除上下文', async ({ page }) => {
    const chatPage = new ChatPage(page)
    await chatPage.goto()
    await chatPage.waitForChatReady()

    // 发送消息
    await chatPage.sendMessage('记住这个信息')
    await chatPage.waitForResponse(30000)

    // 开始新会话
    await chatPage.startNewChat()
    await page.waitForTimeout(2000)
    await chatPage.screenshot('session-new-chat')
  })
})
