"use client";

/**
 * AppShell - ä¸‰æ å¸ƒå±€å®¹å™¨ v8.0
 * Based on: vibelife spec v8.0 - LifeCoach Dashboard
 *
 * V8 å˜æ›´:
 * - å¯¼èˆªå…¥å£ä» 4 ä¸ªæ”¹ä¸º 3 ä¸ª: Dashboard / Chat / Me
 * - é»˜è®¤é¦–é¡µä» Chat æ”¹ä¸º Dashboard
 * - å³ä¾§è¾¹æ æ ¹æ®ä¸»èˆå°æ™ºèƒ½åˆ‡æ¢å†…å®¹
 *
 * å“åº”å¼æ–­ç‚¹ï¼ˆä¸ tailwind.config.ts ä¿æŒä¸€è‡´ï¼‰ï¼š
 * - PC â‰¥1024px (lg): ä¸‰æ å¸ƒå±€
 * - Tablet+Mobile <1024px: å•æ  + TabBar
 *
 * PCç«¯å¸ƒå±€ (â‰¥1024px):
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ NavBar â”‚         ä¸»å†…å®¹åŒºåŸŸ             â”‚   Insight Panel        â”‚
 * â”‚ (64px) â”‚       (flex-1, å·¦å¯¹é½)         â”‚    (320-600px å¯è°ƒ)    â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * Tablet+ç§»åŠ¨ç«¯å¸ƒå±€ (<1024px):
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  Header                                  â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  å†…å®¹åŒºåŸŸ (æ ¹æ®Tabå®Œå…¨åˆ‡æ¢)              â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  ğŸ  Dashboard â”‚ ğŸ’¬ Chat â”‚ ğŸ‘¤ Me          â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

import { useState, useEffect, useCallback, createContext, useContext, ReactNode } from "react";
import { useSearchParams } from "next/navigation";
import { apiClient } from "@/lib/api";
import { cn } from "@/lib/utils";
import { type SkillType } from "@/components/core";
import { NavBar } from "./NavBar";
import { MobileTabBar } from "./MobileTabBar";
import { MobileHeader } from "./MobileHeader";
import { ResizablePanel } from "./ResizablePanel";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// V9.1: 4 entry points - Chat / Journey / Discover / Me
export type TabType = "chat" | "journey" | "discover" | "me";

interface AppShellContextValue {
  skill: SkillType;
  activeTab: TabType;
  setActiveTab: (tab: TabType) => void;
  voiceMode: "warm" | "sarcastic" | "wise";
  setVoiceMode: (mode: "warm" | "sarcastic" | "wise") => void;
}

const AppShellContext = createContext<AppShellContextValue | null>(null);

export function useAppShell() {
  const context = useContext(AppShellContext);
  if (!context) {
    throw new Error("useAppShell must be used within AppShell");
  }
  return context;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AppShell Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AppShellProps {
  skill: SkillType;
  children: ReactNode;
  /** Journey å†…å®¹ */
  journeyContent?: ReactNode;
  /** Discover å†…å®¹ - V9.1 æ–°å¢ */
  discoverContent?: ReactNode;
  /** Me é¡µé¢å†…å®¹ */
  meContent?: ReactNode;
  /** åˆå§‹æ¿€æ´»çš„ Tab - V9 é»˜è®¤ä¸º chat */
  defaultTab?: TabType;
}

export function AppShell({
  skill,
  children,
  journeyContent,
  discoverContent,
  meContent,
  defaultTab = "chat",
}: AppShellProps) {
  const searchParams = useSearchParams();

  // ä» URL å‚æ•°è¯»å– tabï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ defaultTab
  const urlTab = searchParams?.get("tab") as TabType | null;
  const initialTab = (urlTab && ["chat", "journey", "discover", "me"].includes(urlTab))
    ? urlTab
    : defaultTab;

  const [activeTab, setActiveTab] = useState<TabType>(initialTab);
  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic" | "wise">("warm");

  // ç›‘å¬ URL å‚æ•°å˜åŒ–ï¼ŒåŒæ­¥ activeTab
  useEffect(() => {
    if (urlTab && ["chat", "journey", "discover", "me"].includes(urlTab)) {
      setActiveTab(urlTab);
    }
  }, [urlTab]);

  // Load voice_mode from backend on mount
  useEffect(() => {
    const loadPreferences = async () => {
      try {
        const response = await apiClient.get<{ voice_mode: string; language: string }>("/preferences");
        if (response.data?.voice_mode) {
          setVoiceModeState(response.data.voice_mode as "warm" | "sarcastic" | "wise");
        }
      } catch (error) {
        console.error("Failed to load preferences:", error);
      }
    };
    loadPreferences();
  }, []);

  // Save voice_mode to backend when changed
  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic" | "wise") => {
    setVoiceModeState(mode);
    try {
      await apiClient.put("/preferences", { voice_mode: mode });
    } catch (error) {
      console.error("Failed to save voice_mode:", error);
    }
  }, []);

  const contextValue: AppShellContextValue = {
    skill,
    activeTab,
    setActiveTab,
    voiceMode,
    setVoiceMode,
  };

  return (
    <AppShellContext.Provider value={contextValue}>
      <div className="h-screen flex flex-col bg-background">
        {/* Mobile Header - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
        <div className="lg:hidden">
          <MobileHeader skill={skill} />
        </div>

        {/* Main Content Area */}
        <div className="flex-1 flex overflow-hidden">
          {/* Left NavBar - ä»… PC ç«¯æ˜¾ç¤º */}
          <div className="hidden lg:block">
            <NavBar
              skill={skill}
              activeTab={activeTab}
              onTabChange={setActiveTab}
            />
          </div>

          {/* Center - ä¸»å†…å®¹åŒºåŸŸ (å…¨å®½) */}
          <main className="flex-1 min-h-0 flex flex-col">
            {/* PCç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
            <div className="hidden lg:flex lg:flex-col h-full min-h-0">
              <PCContent
                activeTab={activeTab}
                chatContent={children}
                journeyContent={journeyContent}
                discoverContent={discoverContent}
                meContent={meContent}
              />
            </div>

            {/* ç§»åŠ¨ç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
            <div className="lg:hidden h-full min-h-0 flex flex-col">
              <MobileContent
                activeTab={activeTab}
                chatContent={children}
                journeyContent={journeyContent}
                discoverContent={discoverContent}
                meContent={meContent}
              />
            </div>
          </main>
        </div>

        {/* Mobile TabBar - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
        <div className="lg:hidden">
          <MobileTabBar activeTab={activeTab} onTabChange={setActiveTab} />
        </div>
      </div>
    </AppShellContext.Provider>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PCContent - PCç«¯å†…å®¹åˆ‡æ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface ContentProps {
  activeTab: TabType;
  chatContent: ReactNode;
  journeyContent?: ReactNode;
  discoverContent?: ReactNode;
  meContent?: ReactNode;
}

function PCContent({ activeTab, chatContent, journeyContent, discoverContent, meContent }: ContentProps) {
  switch (activeTab) {
    case "chat":
      return <div className="h-full min-h-0 flex flex-col">{chatContent}</div>;
    case "journey":
      return (
        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
          {journeyContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              æˆ‘çš„æ—…ç¨‹
            </div>
          )}
        </div>
      );
    case "discover":
      return (
        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
          {discoverContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              æ¢ç´¢ Skills
            </div>
          )}
        </div>
      );
    case "me":
      return (
        <div className="h-full overflow-y-auto">
          {meContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              ä¸ªäººè®¾ç½®
            </div>
          )}
        </div>
      );
    default:
      return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MobileContent - ç§»åŠ¨ç«¯å†…å®¹åˆ‡æ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function MobileContent({ activeTab, chatContent, journeyContent, discoverContent, meContent }: ContentProps) {
  switch (activeTab) {
    case "chat":
      return <div className="h-full min-h-0 flex flex-col">{chatContent}</div>;
    case "journey":
      return (
        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
          {journeyContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              æˆ‘çš„æ—…ç¨‹
            </div>
          )}
        </div>
      );
    case "discover":
      return (
        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
          {discoverContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              æ¢ç´¢ Skills
            </div>
          )}
        </div>
      );
    case "me":
      return (
        <div className="h-full overflow-y-auto">
          {meContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              ä¸ªäººè®¾ç½®
            </div>
          )}
        </div>
      );
    default:
      return null;
  }
}
