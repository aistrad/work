import React, { useState, useEffect } from 'react';
import { 
  Send, 
  Sparkles, 
  Compass, 
  BookOpen, 
  Moon, 
  Sun, 
  MoreHorizontal, 
  Play, 
  CheckCircle2, 
  Circle,
  Lightbulb,
  ArrowRight
} from 'lucide-react';

/**
 * SOUL OS DESIGN SYSTEM
 *
 * æ³¨æ„ï¼šæ‰€æœ‰é¢œè‰²åº”ä½¿ç”¨è¯­ä¹‰åŒ– Tokenï¼Œè€Œéç¡¬ç¼–ç å€¼ï¼
 *
 * Token æ˜ å°„å…³ç³» (å‚è€ƒ globals.css):
 * - Background: hsl(var(--surface-base))       // æ›¿ä»£ #F9F9F7
 * - Text Main: hsl(var(--text-primary))        // æ›¿ä»£ #37352F
 * - Text Muted: hsl(var(--text-secondary))     // æ›¿ä»£ #9B9A97
 * - Accent: hsl(var(--interactive-accent))     // æ›¿ä»£ #E16259
 *
 * Tailwind ç±»åæ˜ å°„:
 * - bg-surface-base / bg-surface-elevated / bg-surface-muted
 * - text-text-primary / text-text-secondary / text-text-tertiary
 * - bg-interactive-accent / hover:bg-interactive-accent-hover
 * - border-border-default / border-border-emphasis
 *
 * PERMA é¢œè‰² (å·²å®šä¹‰ä¸º Tailwind ç±»):
 * - P: bg-perma-p / text-perma-p
 * - E: bg-perma-e / text-perma-e
 * - R: bg-perma-r / text-perma-r
 * - M: bg-perma-m / text-perma-m
 * - A: bg-perma-a / text-perma-a
 */

// --- Components ---

// 1. Customized Button (Notion Style) - å·²å‡çº§ä¸ºå¯è®¿é—®ç‰ˆæœ¬
const SoulButton = ({
  children,
  icon: Icon,
  onClick,
  className = "",
  ariaLabel,
  type = "button"
}) => (
  <button
    type={type}
    onClick={onClick}
    aria-label={ariaLabel || (typeof children === 'string' ? children : undefined)}
    className={`
      group flex items-center justify-center gap-2 px-4 py-2 rounded-md
      transition-all duration-200 ease-out
      hover:bg-interactive-hover active:bg-interactive-active
      text-text-primary text-sm font-medium
      focus-visible:outline-none focus-visible:ring-2
      focus-visible:ring-interactive-focus-ring focus-visible:ring-offset-2
      focus-visible:ring-offset-surface-base
      ${className}
    `}
  >
    {Icon && <Icon size={16} aria-hidden="true" className="text-text-secondary group-hover:text-text-primary transition-colors" />}
    {children}
  </button>
);

// 2. Prompt Card (Zone A) - å·²å‡çº§ä¸ºå¯è®¿é—®ç‰ˆæœ¬
const PromptCard = ({ emoji, title, subtitle, onClick }) => {
  const handleKeyDown = (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      onClick?.();
    }
  };

  return (
    <div
      role="button"
      tabIndex={0}
      onClick={onClick}
      onKeyDown={handleKeyDown}
      aria-label={`${title}: ${subtitle}`}
      className="
        cursor-pointer group relative overflow-hidden
        bg-surface-elevated border border-border-default rounded-xl p-5
        shadow-sm hover:shadow-lg
        hover:-translate-y-1 hover:border-border-emphasis
        transition-all duration-300 ease-out
        focus-visible:outline-none focus-visible:ring-2
        focus-visible:ring-interactive-focus-ring focus-visible:ring-offset-2
        focus-visible:ring-offset-surface-base
      "
    >
      <div className="flex flex-col gap-3">
        <span className="text-3xl filter grayscale-[0.2] group-hover:grayscale-0 transition-all" aria-hidden="true">{emoji}</span>
        <div>
          <h3 className="font-serif text-lg text-text-primary mb-1">{title}</h3>
          <p className="text-xs text-text-secondary font-medium tracking-wide">{subtitle}</p>
        </div>
      </div>
      {/* Decorative light gradient on hover */}
      <div className="absolute inset-0 bg-gradient-to-br from-transparent to-surface-base/50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none" aria-hidden="true" />
    </div>
  );
};

// 3. Radar Chart for PERMA (Zone B)
const RadarChart = ({ data }) => {
  // Config
  const size = 200;
  const center = size / 2;
  const radius = (size / 2) - 30; // padding
  const axes = ['P', 'E', 'R', 'M', 'A'];
  
  // Calculate points
  const points = axes.map((axis, i) => {
    const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2; // Start from top
    const value = data[axis] / 10; // Normalized 0-1
    const x = center + radius * value * Math.cos(angle);
    const y = center + radius * value * Math.sin(angle);
    return `${x},${y}`;
  }).join(' ');

  // Calculate axis lines
  const axisLines = axes.map((axis, i) => {
    const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
    const x = center + radius * Math.cos(angle);
    const y = center + radius * Math.sin(angle);
    return (
      <line 
        key={axis} 
        x1={center} y1={center} x2={x} y2={y} 
        stroke="#E9E9E7" strokeWidth="1" 
        strokeDasharray="4 4"
      />
    );
  });

  // Calculate label positions
  const labels = axes.map((axis, i) => {
    const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
    const x = center + (radius + 20) * Math.cos(angle);
    const y = center + (radius + 20) * Math.sin(angle);
    return (
      <text 
        key={axis} 
        x={x} y={y} 
        textAnchor="middle" 
        dominantBaseline="middle"
        className="text-[10px] fill-[#9B9A97] font-serif font-bold"
      >
        {axis}
      </text>
    );
  });

  return (
    <div className="flex flex-col items-center justify-center py-4">
      <svg width={size} height={size} className="overflow-visible">
        {/* Background Pentagon */}
        <polygon 
          points={axes.map((_, i) => {
            const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
            const x = center + radius * Math.cos(angle);
            const y = center + radius * Math.sin(angle);
            return `${x},${y}`;
          }).join(' ')}
          fill="#F9F9F7"
          stroke="#E9E9E7"
          strokeWidth="1"
        />
        {/* Axes */}
        {axisLines}
        {/* Data Shape */}
        <polygon 
          points={points}
          fill="rgba(132, 165, 157, 0.2)" // Sage Green tint
          stroke="#84A59D" 
          strokeWidth="2"
          className="transition-all duration-1000 ease-out"
        />
        {/* Points */}
        {axes.map((axis, i) => {
          const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
          const value = data[axis] / 10;
          const x = center + radius * value * Math.cos(angle);
          const y = center + radius * value * Math.sin(angle);
          return (
            <circle 
              key={i} cx={x} cy={y} r="3" 
              fill="#FFFFFF" stroke="#84A59D" strokeWidth="2"
            />
          );
        })}
        {labels}
      </svg>
      <div className="mt-2 text-xs text-[#9B9A97] tracking-wider">äº”ç»´å¿ƒç†å¹³è¡¡</div>
    </div>
  );
};

// 4. Task Item (Zone B) - å·²å‡çº§ï¼šCommitment çŠ¶æ€æœº + å¯è®¿é—®æ€§
// status: 'suggested' | 'active' | 'done' | 'skipped'
const TaskItem = ({
  id,
  title,
  tag,
  status = 'suggested',
  estimatedDuration,
  onAction
}) => {
  // çŠ¶æ€æœºé…è‰²
  const statusStyles = {
    suggested: 'text-commitment-suggested border-commitment-suggested/30 bg-commitment-suggested/10',
    active: 'text-commitment-active border-commitment-active/30 bg-commitment-active/10',
    done: 'text-commitment-done border-commitment-done/30 bg-commitment-done/10',
    skipped: 'text-commitment-skipped border-commitment-skipped/30 bg-commitment-skipped/10'
  };

  // åŠ¨ä½œæŒ‰é’®æ–‡æ¡ˆ
  const actionLabel = {
    suggested: 'æ¥å—',
    active: 'å®Œæˆ',
    done: null,
    skipped: null
  };

  const handleAction = () => {
    if (status === 'suggested') {
      onAction?.(id, 'start');
    } else if (status === 'active') {
      onAction?.(id, 'complete');
    }
  };

  return (
    <div
      className="group flex items-center justify-between py-3 border-b border-border-subtle last:border-0"
      role="listitem"
      aria-label={`${title}, çŠ¶æ€: ${status}`}
    >
      <div className="flex items-center gap-3">
        <button
          type="button"
          aria-label={status === 'done' ? 'å·²å®Œæˆ' : status === 'active' ? 'æ ‡è®°å®Œæˆ' : 'å¼€å§‹ä»»åŠ¡'}
          onClick={handleAction}
          className="text-text-tertiary hover:text-status-success transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-interactive-focus-ring rounded"
        >
          {status === 'done' ? (
            <CheckCircle2 size={20} className="text-commitment-done" aria-hidden="true" />
          ) : status === 'active' ? (
            <Circle size={20} className="text-commitment-active" aria-hidden="true" />
          ) : (
            <Circle size={20} aria-hidden="true" />
          )}
        </button>
        <span className={`text-sm ${status === 'done' ? 'text-text-tertiary line-through' : 'text-text-primary'}`}>
          {title}
        </span>
      </div>
      <div className="flex items-center gap-3 opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition-opacity">
        {/* Status Badge */}
        <span className={`text-[10px] px-2 py-0.5 rounded-full border uppercase tracking-wider ${statusStyles[status]}`}>
          {tag}
        </span>
        {/* Duration Badge */}
        {estimatedDuration && status !== 'done' && (
          <span className="text-[10px] px-2 py-0.5 rounded-full bg-surface-muted text-text-secondary">
            {estimatedDuration}
          </span>
        )}
        {/* Action Button */}
        {actionLabel[status] && (
          <button
            type="button"
            onClick={handleAction}
            aria-label={`${actionLabel[status]} ${title}`}
            className="text-xs px-2 py-1 rounded bg-primary text-text-inverse hover:bg-primary/90 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-interactive-focus-ring"
          >
            {actionLabel[status]}
          </button>
        )}
      </div>
    </div>
  );
};


// --- Main Application ---

const App = () => {
  const [inputValue, setInputValue] = useState("");
  const [messages, setMessages] = useState([]);
  const [tasks, setTasks] = useState([
    { id: '1', title: 'æ™¨é—´å†¥æƒ³', tag: 'Mind', status: 'done', estimatedDuration: '10åˆ†é’Ÿ' },
    { id: '2', title: 'æ„Ÿæ©æ—¥è®°', tag: 'Soul', status: 'active', estimatedDuration: '5åˆ†é’Ÿ' },
    { id: '3', title: 'é˜…è¯»æ–¯å¤šè‘›å“²å­¦', tag: 'Wisdom', status: 'suggested', estimatedDuration: '20åˆ†é’Ÿ' },
    { id: '4', title: 'Deep Work Session', tag: 'Flow', status: 'suggested', estimatedDuration: '45åˆ†é’Ÿ' },
  ]);

  // Fake PERMA Data
  const permaData = { P: 8, E: 6, R: 7, M: 9, A: 5 };

  const handleSend = () => {
    if (!inputValue.trim()) return;
    setMessages([...messages, { type: 'user', text: inputValue }]);
    setInputValue("");
    // Simulate AI thinking
    setTimeout(() => {
      setMessages(prev => [...prev, {
        type: 'ai',
        text: "æˆ‘ç†è§£ä½ çš„æ„Ÿå—ã€‚åœ¨æ··ä¹±ä¸­å¯»æ‰¾ç§©åºæ˜¯é‡å»ºå†…å¿ƒå¹³é™çš„ç¬¬ä¸€æ­¥ã€‚ä½ ç°åœ¨æ„Ÿè§‰å¦‚ä½•ï¼Ÿ"
      }]);
    }, 1000);
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  };

  // ä»»åŠ¡çŠ¶æ€æœºå¤„ç†
  const handleTaskAction = (taskId, action) => {
    setTasks(prev => prev.map(task => {
      if (task.id !== taskId) return task;
      if (action === 'start') return { ...task, status: 'active' };
      if (action === 'complete') return { ...task, status: 'done' };
      return task;
    }));
  };

  // è·å–å¾…å¤„ç†ä»»åŠ¡æ•°
  const pendingCount = tasks.filter(t => t.status === 'suggested' || t.status === 'active').length;

  return (
    <div className="min-h-screen bg-surface-base text-text-primary font-sans selection:bg-interactive-accent selection:text-text-inverse flex overflow-hidden">

      {/* LAYOUT ARCHITECTURE
        Left: Zone A (Interaction) - 60%
        Right: Zone B (Dashboard) - 40%
        Mobile: Bottom Tab Navigation
      */}

      {/* --- ZONE A: The Canvas (Chat/Interaction) --- */}
      <main className="flex-1 flex flex-col relative h-screen p-6 md:p-10 transition-all duration-500">

        {/* Header */}
        <header className="flex justify-between items-center mb-10" role="banner">
          <div className="flex items-center gap-3">
            {/* Mini Orb - å“ç‰Œè§†è§‰é”šç‚¹ */}
            <div
              className="w-8 h-8 rounded-full bg-primary flex items-center justify-center text-text-inverse font-serif italic animate-breathe"
              aria-hidden="true"
            >
              F
            </div>
            <h1 className="font-serif text-2xl font-semibold tracking-tight text-text-primary">
              Fortune AI
            </h1>
          </div>
          <nav className="flex gap-2" aria-label="å·¥å…·æ ">
            <SoulButton icon={Moon} ariaLabel="åˆ‡æ¢æ·±è‰²æ¨¡å¼" />
            <SoulButton icon={MoreHorizontal} ariaLabel="æ›´å¤šé€‰é¡¹" />
          </nav>
        </header>

        {/* Content Area */}
        <div className="flex-1 overflow-y-auto scrollbar-none pb-32" role="main">
          {messages.length === 0 ? (
            <div className="max-w-3xl mx-auto mt-10 animate-fade-in-up">
              {/* é—®å€™è¯­ - ä¸­æ–‡ä¸ºä¸» */}
              <h2 className="font-serif text-4xl md:text-5xl text-text-primary mb-4 leading-tight">
                æ—©å®‰ï¼Œæ—…è¡Œè€…
                <br />
                <span className="text-text-secondary text-3xl">ä½ çš„å†…å¿ƒä»Šå¤©å¦‚ä½•ï¼Ÿ</span>
              </h2>

              {/* å¿«æ·å…¥å£ - ä¸­æ–‡æ ‡é¢˜ */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-12" role="list" aria-label="å¿«æ·åŠŸèƒ½">
                <PromptCard
                  emoji="ğŸ”®"
                  title="æ¯æ—¥å¡”ç½—"
                  subtitle="æŠ½å–ä»Šæ—¥æ´å¯Ÿå¡ç‰Œ"
                  onClick={() => setInputValue("æŠ½ä¸€å¼ ä»Šæ—¥å¡”ç½—ç‰Œ")}
                />
                <PromptCard
                  emoji="ğŸŒ±"
                  title="æˆé•¿æ—¥è®°"
                  subtitle="å›é¡¾æœ¬å‘¨çš„è¿›æ­¥"
                  onClick={() => setInputValue("å›é¡¾æˆ‘è¿™å‘¨çš„æˆé•¿")}
                />
                <PromptCard
                  emoji="ğŸŒŒ"
                  title="è§£æ¢¦åˆ†æ"
                  subtitle="æ¢ç´¢æ½œæ„è¯†çš„ä¿¡æ¯"
                  onClick={() => setInputValue("æˆ‘æ˜¨æ™šåšäº†ä¸€ä¸ªæ¢¦...")}
                />
                <PromptCard
                  emoji="ğŸ§˜"
                  title="æ­£å¿µå†¥æƒ³"
                  subtitle="5åˆ†é’Ÿå¼•å¯¼æ”¾æ¾"
                  onClick={() => setInputValue("å¼€å§‹5åˆ†é’Ÿæ­£å¿µå¼•å¯¼")}
                />
              </div>
            </div>
          ) : (
            <div className="max-w-3xl mx-auto space-y-8" role="log" aria-live="polite">
              {messages.map((msg, idx) => (
                <div key={idx} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                  <div className={`
                    max-w-[80%] p-5 rounded-2xl text-base leading-relaxed
                    ${msg.type === 'user'
                      ? 'bg-surface-muted text-text-primary'
                      : 'bg-surface-elevated border border-border-default shadow-sm text-text-primary font-sans'}
                  `}>
                    {/* AI æ¶ˆæ¯ï¼šæ­£æ–‡ç”¨ Sansï¼Œå¼•è¨€ç”¨ Serif */}
                    {msg.type === 'ai' ? (
                      <p className="font-sans leading-relaxed">{msg.text}</p>
                    ) : (
                      msg.text
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Floating Capsule Input (Omnibar) - å·²å¢å¼ºå¯è®¿é—®æ€§ */}
        <div className="absolute bottom-10 left-0 right-0 flex justify-center px-4 safe-area-pb">
          <form
            onSubmit={(e) => { e.preventDefault(); handleSend(); }}
            className="
              w-full max-w-2xl
              capsule-glass rounded-full
              flex items-center p-2 pl-6 gap-2
              transition-all duration-300
              focus-within:ring-2 focus-within:ring-interactive-focus-ring focus-within:ring-offset-2 focus-within:ring-offset-surface-base
            "
            role="search"
          >
            <span className="text-text-secondary font-serif italic text-lg mr-2" aria-hidden="true">/</span>
            <label htmlFor="omnibar-input" className="sr-only">è¾“å…¥æ¶ˆæ¯æˆ–å‘½ä»¤</label>
            <input
              id="omnibar-input"
              type="text"
              value={inputValue}
              onChange={(e) => setInputValue(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder="è¾“å…¥ / æŸ¥çœ‹å‘½ä»¤ï¼Œæˆ–ç›´æ¥æé—®..."
              className="flex-1 bg-transparent outline-none text-text-primary placeholder-text-tertiary h-10"
              autoComplete="off"
            />
            <button
              type="submit"
              aria-label="å‘é€æ¶ˆæ¯"
              disabled={!inputValue.trim()}
              className="
                w-10 h-10 rounded-full bg-primary text-text-inverse
                flex items-center justify-center
                hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed
                transition-colors
                focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-interactive-focus-ring focus-visible:ring-offset-2
              "
            >
              <ArrowRight size={18} aria-hidden="true" />
            </button>
          </form>
        </div>
      </main>

      {/* --- ZONE B: The Dashboard (Soul Metrics) --- */}
      <aside
        className="hidden lg:flex w-[400px] flex-col p-6 border-l border-border-default/60 bg-surface-subtle"
        role="complementary"
        aria-label="çŠ¶æ€é¢æ¿"
      >

        {/* Banner Callout - æ¯æ—¥æ™ºæ…§ */}
        <div className="mb-8 p-4 rounded-lg bg-surface-muted/50 border border-border-default flex gap-3 items-start">
          <Lightbulb size={20} className="text-interactive-accent mt-0.5 flex-shrink-0" aria-hidden="true" />
          <div>
            <h4 className="font-medium text-text-primary text-sm">æ¯æ—¥æ™ºæ…§</h4>
            <p className="text-xs text-text-secondary mt-1 leading-5">
              "ä½ è¶Šå®‰é™ï¼Œå°±èƒ½å¬åˆ°è¶Šå¤šã€‚" â€” Ram Dass
            </p>
          </div>
        </div>

        {/* PERMA Radar Chart - èƒ½é‡å¹³è¡¡ */}
        <div className="mb-8">
          <div className="flex items-center justify-between mb-2">
            <h3 className="font-serif text-text-primary font-medium">èƒ½é‡å¹³è¡¡</h3>
            <button
              type="button"
              className="text-text-secondary hover:text-text-primary text-xs transition-colors focus-visible:outline-none focus-visible:underline"
              aria-label="æŸ¥çœ‹è¯¦æƒ…"
            >
              è¯¦æƒ…
            </button>
          </div>
          <div className="bg-surface-elevated rounded-xl border border-border-default shadow-sm p-2 flex justify-center">
            <RadarChart data={permaData} />
            {/* TODO: å¢åŠ è¶‹åŠ¿æŒ‡ç¤ºå’Œé˜ˆå€¼æé†’ */}
          </div>
          {/* ä¸‹ä¸€æ­¥å»ºè®® */}
          <div className="mt-3 p-3 rounded-lg bg-commitment-suggested/10 border border-commitment-suggested/20">
            <p className="text-xs text-text-secondary">
              <span className="font-medium text-text-primary">å»ºè®®ï¼š</span>
              æˆå°±æ„Ÿ(A)åä½ï¼Œå°è¯•è®¾ç½®ä¸€ä¸ª15åˆ†é’Ÿçš„å°ç›®æ ‡
            </p>
          </div>
        </div>

        {/* Task List - ä»Šæ—¥ä»ªå¼ */}
        <div className="flex-1 overflow-hidden flex flex-col">
          <div className="flex items-center justify-between mb-4">
            <h3 className="font-serif text-text-primary font-medium">ä»Šæ—¥ä»ªå¼</h3>
            <span className="text-xs bg-commitment-active/10 text-commitment-active px-2 py-1 rounded-full border border-commitment-active/20">
              {pendingCount} å¾…å®Œæˆ
            </span>
          </div>

          <div
            className="bg-surface-elevated rounded-xl border border-border-default shadow-sm p-4 flex-1 overflow-y-auto scrollbar-thin"
            role="list"
            aria-label="ä»»åŠ¡åˆ—è¡¨"
          >
            {tasks.map(task => (
              <TaskItem
                key={task.id}
                id={task.id}
                title={task.title}
                tag={task.tag}
                status={task.status}
                estimatedDuration={task.estimatedDuration}
                onAction={handleTaskAction}
              />
            ))}
          </div>
        </div>

        {/* Footer */}
        <div className="mt-6 pt-6 border-t border-border-default text-center">
          <p className="text-[10px] text-text-tertiary uppercase tracking-widest">
            ä¸ºå†…å¿ƒå¹³é™è€Œè®¾è®¡
          </p>
        </div>

      </aside>
    </div>
  );
};

export default App;