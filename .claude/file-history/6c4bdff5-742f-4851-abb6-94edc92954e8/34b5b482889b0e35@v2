"use client"

import { cn } from "@/lib/utils"
import { motion } from "framer-motion"
import { useMemo } from "react"

// ═══════════════════════════════════════════════════════════════════════════
// PERMA 雷达图组件
// 设计规范: 五角雷达图，莫兰迪配色，带动画效果
// ═══════════════════════════════════════════════════════════════════════════

interface PermaRadarProps {
  data: {
    P: number // Positive Emotion - 积极情绪 (0-10)
    E: number // Engagement - 投入 (0-10)
    R: number // Relationships - 关系 (0-10)
    M: number // Meaning - 意义 (0-10)
    A: number // Accomplishment - 成就 (0-10)
  }
  size?: number
  className?: string
  showLabels?: boolean
  animate?: boolean
}

// PERMA 维度配色 (莫兰迪色系)
const PERMA_COLORS = {
  P: "hsl(var(--perma-p))", // Sage Green
  E: "hsl(var(--perma-e))", // Dusty Blue
  R: "hsl(var(--perma-r))", // Terracotta
  M: "hsl(var(--perma-m))", // Mustard
  A: "hsl(var(--perma-a))", // Slate Purple
}

// 维度标签
const PERMA_LABELS = {
  P: "积极",
  E: "投入",
  R: "关系",
  M: "意义",
  A: "成就",
}

export function PermaRadar({
  data,
  size = 200,
  className,
  showLabels = true,
  animate = true,
}: PermaRadarProps) {
  const center = size / 2
  const maxRadius = (size / 2) * 0.75 // 留出标签空间

  // 计算五角形顶点位置 (从顶部开始，顺时针)
  const dimensions = ["P", "E", "R", "M", "A"] as const
  const angleStep = (2 * Math.PI) / 5

  // 生成网格线
  const gridLevels = [0.2, 0.4, 0.6, 0.8, 1.0]

  // 计算数据点位置
  const dataPoints = useMemo(() => {
    return dimensions.map((dim, i) => {
      const angle = -Math.PI / 2 + i * angleStep // 从顶部开始
      const value = (data[dim] || 0) / 10 // 归一化到 0-1
      const radius = value * maxRadius
      return {
        x: center + radius * Math.cos(angle),
        y: center + radius * Math.sin(angle),
        label: PERMA_LABELS[dim],
        key: dim,
        value: data[dim],
        color: PERMA_COLORS[dim],
        labelX: center + (maxRadius + 24) * Math.cos(angle),
        labelY: center + (maxRadius + 24) * Math.sin(angle),
      }
    })
  }, [data, center, maxRadius, angleStep])

  // 生成数据区域的 path
  const dataPath = useMemo(() => {
    return dataPoints.map((p, i) => (i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`)).join(" ") + " Z"
  }, [dataPoints])

  // 生成网格 path
  const gridPath = (level: number) => {
    const radius = level * maxRadius
    return dimensions
      .map((_, i) => {
        const angle = -Math.PI / 2 + i * angleStep
        const x = center + radius * Math.cos(angle)
        const y = center + radius * Math.sin(angle)
        return i === 0 ? `M ${x} ${y}` : `L ${x} ${y}`
      })
      .join(" ") + " Z"
  }

  return (
    <div className={cn("relative", className)}>
      <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
        {/* 背景网格 */}
        <g>
          {gridLevels.map((level) => (
            <path
              key={level}
              d={gridPath(level)}
              fill="none"
              stroke="hsl(var(--border))"
              strokeWidth={1}
              opacity={0.5}
            />
          ))}

          {/* 轴线 */}
          {dimensions.map((_, i) => {
            const angle = -Math.PI / 2 + i * angleStep
            const x = center + maxRadius * Math.cos(angle)
            const y = center + maxRadius * Math.sin(angle)
            return (
              <line
                key={i}
                x1={center}
                y1={center}
                x2={x}
                y2={y}
                stroke="hsl(var(--border))"
                strokeWidth={1}
                opacity={0.3}
              />
            )
          })}
        </g>

        {/* 数据区域 - 渐变填充 */}
        <defs>
          <linearGradient id="perma-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stopColor="hsl(var(--perma-p))" stopOpacity={0.3} />
            <stop offset="50%" stopColor="hsl(var(--perma-m))" stopOpacity={0.3} />
            <stop offset="100%" stopColor="hsl(var(--perma-a))" stopOpacity={0.3} />
          </linearGradient>
        </defs>

        {animate ? (
          <motion.path
            d={dataPath}
            fill="url(#perma-gradient)"
            stroke="hsl(var(--accent))"
            strokeWidth={2}
            strokeLinejoin="round"
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.6, ease: [0.16, 1, 0.3, 1] }}
            style={{ transformOrigin: "center" }}
          />
        ) : (
          <path
            d={dataPath}
            fill="url(#perma-gradient)"
            stroke="hsl(var(--accent))"
            strokeWidth={2}
            strokeLinejoin="round"
          />
        )}

        {/* 数据点 */}
        {dataPoints.map((point, i) => (
          <motion.circle
            key={point.key}
            cx={point.x}
            cy={point.y}
            r={5}
            fill={point.color}
            stroke="white"
            strokeWidth={2}
            initial={animate ? { opacity: 0, scale: 0 } : {}}
            animate={animate ? { opacity: 1, scale: 1 } : {}}
            transition={{ duration: 0.4, delay: 0.1 * i }}
          />
        ))}

        {/* 标签 */}
        {showLabels &&
          dataPoints.map((point) => (
            <g key={`label-${point.key}`}>
              <text
                x={point.labelX}
                y={point.labelY}
                textAnchor="middle"
                dominantBaseline="middle"
                className="text-xs font-medium fill-foreground"
              >
                {point.key}
              </text>
            </g>
          ))}
      </svg>

      {/* 图例 - 可选 */}
      {showLabels && (
        <div className="absolute bottom-0 left-1/2 -translate-x-1/2 flex items-center gap-3">
          {dataPoints.map((point) => (
            <div key={point.key} className="flex items-center gap-1">
              <span
                className="w-2 h-2 rounded-full"
                style={{ backgroundColor: point.color }}
              />
              <span className="text-[10px] text-foreground-muted">{point.value.toFixed(1)}</span>
            </div>
          ))}
        </div>
      )}
    </div>
  )
}

// ═══════════════════════════════════════════════════════════════════════════
// PERMA 状态卡片 - 带雷达图的完整卡片组件
// ═══════════════════════════════════════════════════════════════════════════
interface PermaStatusCardProps {
  perma: {
    positiveEmotion: { score: number }
    engagement: { score: number }
    relationships: { score: number }
    meaning: { score: number }
    accomplishment: { score: number }
  }
  totalScore?: number
  className?: string
  onCheckin?: () => void
}

export function PermaStatusCard({
  perma,
  totalScore,
  className,
  onCheckin,
}: PermaStatusCardProps) {
  const radarData = {
    P: perma.positiveEmotion.score,
    E: perma.engagement.score,
    R: perma.relationships.score,
    M: perma.meaning.score,
    A: perma.accomplishment.score,
  }

  return (
    <div className={cn("p-4 rounded-xl bg-card border border-border/50", className)}>
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-serif font-medium text-foreground">PERMA 状态</h3>
        {totalScore !== undefined && (
          <span className="text-sm text-foreground-muted">
            总分 <strong className="text-foreground">{totalScore}</strong>
          </span>
        )}
      </div>

      {/* Radar Chart */}
      <div className="flex justify-center py-4">
        <PermaRadar data={radarData} size={180} />
      </div>

      {/* Check-in Button */}
      {onCheckin && (
        <button
          type="button"
          onClick={onCheckin}
          className={cn(
            "w-full mt-4 flex items-center justify-center gap-2 py-2.5 px-4",
            "rounded-lg border border-border",
            "bg-background hover:bg-hover transition-colors",
            "text-sm font-medium text-foreground",
            "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent/50"
          )}
        >
          情绪打卡
        </button>
      )}
    </div>
  )
}

export default PermaRadar
