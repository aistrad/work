"use client"

import { useState, useEffect } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { cn } from "@/lib/utils"

interface BootStep {
  id: string
  label: string
  labelCn: string
}

const BOOT_STEPS: BootStep[] = [
  { id: "l0", label: "Loading L0 Data...", labelCn: "八字计算中" },
  { id: "l1", label: "Calibrating L1 Schema...", labelCn: "心理模型校准中" },
  { id: "l2", label: "Waking up Agents...", labelCn: "唤醒专家智能体" },
  { id: "ready", label: "System Ready", labelCn: "系统就绪" },
]

interface BootingSequenceProps {
  onComplete: () => void
  className?: string
}

export function BootingSequence({ onComplete, className }: BootingSequenceProps) {
  const [currentStep, setCurrentStep] = useState(0)
  const [completedSteps, setCompletedSteps] = useState<string[]>([])

  useEffect(() => {
    if (currentStep >= BOOT_STEPS.length) {
      // All steps complete, trigger callback after a short delay
      const timer = setTimeout(onComplete, 600)
      return () => clearTimeout(timer)
    }

    const step = BOOT_STEPS[currentStep]
    const duration = step.id === "ready" ? 400 : 500 + Math.random() * 300

    const timer = setTimeout(() => {
      setCompletedSteps((prev) => [...prev, step.id])
      setCurrentStep((prev) => prev + 1)
    }, duration)

    return () => clearTimeout(timer)
  }, [currentStep, onComplete])

  return (
    <motion.div
      className={cn(
        "fixed inset-0 z-50",
        "flex flex-col items-center justify-center",
        "bg-landing-bg",
        className
      )}
      initial={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      transition={{ duration: 0.5 }}
    >
      {/* Logo */}
      <motion.div
        className="mb-12"
        initial={{ opacity: 0, scale: 0.8 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ duration: 0.4 }}
      >
        <div className="flex items-center gap-3">
          <img src="/assets/logo.png" alt="Mentis" className="h-10" />
        </div>
      </motion.div>

      {/* Boot steps */}
      <div className="space-y-4 w-full max-w-xs">
        <AnimatePresence mode="popLayout">
          {BOOT_STEPS.slice(0, currentStep + 1).map((step, index) => {
            const isCompleted = completedSteps.includes(step.id)
            const isCurrent = index === currentStep && !isCompleted

            return (
              <motion.div
                key={step.id}
                className="flex items-center gap-3"
                initial={{ opacity: 0, x: -20 }}
                animate={{ opacity: 1, x: 0 }}
                transition={{ duration: 0.3 }}
              >
                {/* Status indicator */}
                <div className="flex-shrink-0 w-5 h-5 flex items-center justify-center">
                  {isCompleted ? (
                    <motion.div
                      initial={{ scale: 0 }}
                      animate={{ scale: 1 }}
                      className="w-2 h-2 rounded-full bg-success"
                    />
                  ) : isCurrent ? (
                    <motion.div
                      className="w-2 h-2 rounded-full bg-accent"
                      animate={{
                        scale: [1, 1.3, 1],
                        opacity: [1, 0.6, 1],
                      }}
                      transition={{
                        duration: 0.8,
                        repeat: Infinity,
                        ease: "easeInOut",
                      }}
                    />
                  ) : (
                    <div className="w-2 h-2 rounded-full bg-foreground-subtle" />
                  )}
                </div>

                {/* Label */}
                <div className="flex-1">
                  <p
                    className={cn(
                      "font-mono text-sm transition-colors duration-300",
                      isCompleted
                        ? "text-success"
                        : isCurrent
                        ? "text-foreground"
                        : "text-foreground-subtle"
                    )}
                  >
                    {step.label}
                  </p>
                  <p
                    className={cn(
                      "text-xs transition-colors duration-300",
                      isCompleted
                        ? "text-success/60"
                        : isCurrent
                        ? "text-foreground-muted"
                        : "text-foreground-subtle/60"
                    )}
                  >
                    {step.labelCn}
                  </p>
                </div>

                {/* Checkmark for completed */}
                {isCompleted && (
                  <motion.svg
                    width="16"
                    height="16"
                    viewBox="0 0 16 16"
                    initial={{ scale: 0, opacity: 0 }}
                    animate={{ scale: 1, opacity: 1 }}
                    className="text-success"
                  >
                    <path
                      fill="currentColor"
                      d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"
                    />
                  </motion.svg>
                )}
              </motion.div>
            )
          })}
        </AnimatePresence>
      </div>

      {/* Progress bar */}
      <div className="absolute bottom-12 left-1/2 -translate-x-1/2 w-48">
        <div className="h-1 rounded-full bg-background-subtle overflow-hidden">
          <motion.div
            className="h-full bg-accent"
            initial={{ width: "0%" }}
            animate={{
              width: `${((currentStep + (completedSteps.length > currentStep ? 1 : 0.5)) / BOOT_STEPS.length) * 100}%`,
            }}
            transition={{ duration: 0.3, ease: "easeOut" }}
          />
        </div>
      </div>
    </motion.div>
  )
}
