"use client"

import { useState, useEffect, useCallback } from "react"
import { useRouter } from "next/navigation"
import { cn } from "@/lib/utils"
import { useAppStore } from "@/stores/app-store"
import * as api from "@/lib/api"
import { User, Bot, MessageSquare, Bell, Palette, Shield, ChevronDown } from "lucide-react"

// Collapsible section component
function SettingsSection({
  icon,
  title,
  children,
  defaultOpen = false,
}: {
  icon: React.ReactNode
  title: string
  children: React.ReactNode
  defaultOpen?: boolean
}) {
  const [isOpen, setIsOpen] = useState(defaultOpen)

  return (
    <section className="border border-border rounded-lg overflow-hidden">
      <button
        type="button"
        onClick={() => setIsOpen(!isOpen)}
        className={cn(
          "w-full flex items-center justify-between px-4 py-3",
          "bg-sidebar hover:bg-sidebar/80 transition-colors",
          "text-left",
          "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-foreground/20",
          "focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        )}
      >
        <span className="flex items-center gap-2 font-medium text-foreground">
          <span className="w-8 h-8 rounded-lg bg-background border border-border flex items-center justify-center text-muted-foreground">
            {icon}
          </span>
          <span>{title}</span>
        </span>
        <ChevronDown className={cn("w-5 h-5 text-muted-foreground transition-transform", isOpen && "rotate-180")} />
      </button>
      {isOpen && (
        <div className="p-4 border-t border-border bg-background space-y-4">
          {children}
        </div>
      )}
    </section>
  )
}

// Form field components
function TextField({
  label,
  value,
  onChange,
  placeholder,
  disabled,
}: {
  label: string
  value: string
  onChange: (value: string) => void
  placeholder?: string
  disabled?: boolean
}) {
  return (
    <div className="space-y-1">
      <label className="text-sm text-muted-foreground">{label}</label>
      <input
        type="text"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
        disabled={disabled}
        className={cn(
          "w-full px-3 py-2 rounded-lg",
          "bg-sidebar border border-border",
          "text-foreground placeholder:text-muted-foreground",
          "focus:outline-none focus:ring-2 focus:ring-foreground/20",
          "disabled:opacity-50 disabled:cursor-not-allowed"
        )}
      />
    </div>
  )
}

function SelectField({
  label,
  value,
  onChange,
  options,
  description,
}: {
  label: string
  value: string
  onChange: (value: string) => void
  options: { value: string; label: string; desc?: string }[]
  description?: string
}) {
  return (
    <div className="space-y-1">
      <label className="text-sm text-muted-foreground">{label}</label>
      {description && <p className="text-xs text-muted-foreground/70">{description}</p>}
      <select
        value={value}
        onChange={(e) => onChange(e.target.value)}
        className={cn(
          "w-full px-3 py-2 rounded-lg",
          "bg-sidebar border border-border",
          "text-foreground",
          "focus:outline-none focus:ring-2 focus:ring-foreground/20"
        )}
      >
        {options.map((opt) => (
          <option key={opt.value} value={opt.value}>
            {opt.label}{opt.desc ? ` - ${opt.desc}` : ''}
          </option>
        ))}
      </select>
    </div>
  )
}

function RadioGroup({
  label,
  value,
  onChange,
  options,
}: {
  label?: string
  value: string
  onChange: (value: string) => void
  options: { value: string; label: string; desc?: string }[]
}) {
  return (
    <div className="space-y-2">
      {label && <label className="text-sm text-muted-foreground">{label}</label>}
      <div className="space-y-2">
        {options.map((opt) => (
          <label
            key={opt.value}
            className={cn(
              "flex items-start gap-3 p-3 rounded-lg cursor-pointer",
              "border transition-colors",
              value === opt.value
                ? "border-foreground/30 bg-foreground/5"
                : "border-border hover:border-foreground/20"
            )}
          >
            <input
              type="radio"
              name={label}
              value={opt.value}
              checked={value === opt.value}
              onChange={() => onChange(opt.value)}
              className="mt-0.5"
            />
            <div>
              <span className="font-medium text-foreground">{opt.label}</span>
              {opt.desc && <p className="text-sm text-muted-foreground">{opt.desc}</p>}
            </div>
          </label>
        ))}
      </div>
    </div>
  )
}

function ToggleField({
  label,
  description,
  value,
  onChange,
}: {
  label: string
  description?: string
  value: boolean
  onChange: (value: boolean) => void
}) {
  return (
    <div className="flex items-center justify-between">
      <div>
        <p className="font-medium text-foreground">{label}</p>
        {description && <p className="text-sm text-muted-foreground">{description}</p>}
      </div>
      <button
        type="button"
        onClick={() => onChange(!value)}
        className={cn(
          "relative w-11 h-6 rounded-full transition-colors",
          value ? "bg-foreground" : "bg-border",
          "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-foreground/20",
          "focus-visible:ring-offset-2 focus-visible:ring-offset-background"
        )}
        role="switch"
        aria-checked={value}
        aria-label={label}
      >
        <span
          className={cn(
            "absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-background transition-transform",
            value && "translate-x-5"
          )}
        />
      </button>
    </div>
  )
}

export function SettingsTab() {
  const router = useRouter()
  const { chatBackend, setChatBackend } = useAppStore()

  // User info & preferences state
  const [userInfo, setUserInfo] = useState<api.UserInfo | null>(null)
  const [preferences, setPreferences] = useState<api.UserPreferences | null>(null)
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [isLoggingOut, setIsLoggingOut] = useState(false)

  // Editable profile fields (for future extension)
  const [editName, setEditName] = useState("")

  // Load user data on mount
  useEffect(() => {
    Promise.all([
      api.fetchMe().catch(() => null),
      api.fetchPreferences().catch(() => null),
    ]).then(([user, prefs]) => {
      setUserInfo(user)
      setPreferences(prefs)
      if (user) setEditName(user.name)
      setLoading(false)
    })
  }, [])

  // Save preferences
  const savePreferences = useCallback(async (patch: Partial<api.UserPreferences>) => {
    setSaving(true)
    try {
      await api.updatePreferences(patch)
      setPreferences((prev) => prev ? { ...prev, ...patch } : null)
      return true
    } catch (err) {
      console.error("Failed to save preferences:", err)
      return false
    } finally {
      setSaving(false)
    }
  }, [])

  // Handle logout
  const handleLogout = async () => {
    setIsLoggingOut(true)
    try {
      await api.logout()
      router.push("/login")
    } catch (err) {
      console.error("Logout failed:", err)
      router.push("/login")
    }
  }

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center">
        <p className="text-muted-foreground">加载中...</p>
      </div>
    )
  }

  return (
    <div className="p-6 space-y-4">
      {/* Header with save indicator */}
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-bold text-foreground">设置</h1>
        {saving && (
          <span className="text-sm text-muted-foreground">保存中...</span>
        )}
      </div>

      {/* Profile Section */}
      <SettingsSection icon={<User className="w-4 h-4" />} title="个人资料" defaultOpen>
        {userInfo ? (
          <div className="space-y-4">
            {/* Avatar placeholder + basic info */}
            <div className="flex items-center gap-4">
              <div className="w-16 h-16 rounded-full bg-sidebar border border-border flex items-center justify-center text-2xl">
                <User className="w-7 h-7 text-muted-foreground" />
              </div>
              <div>
                <p className="font-medium text-foreground">{userInfo.name}</p>
                <p className="text-sm text-muted-foreground">{userInfo.email}</p>
              </div>
            </div>

            <TextField
              label="昵称"
              value={editName}
              onChange={setEditName}
              placeholder="您的昵称"
              disabled
            />

            {/* Birth info - read only for now */}
            <div className="grid grid-cols-2 gap-4">
              <div className="space-y-1">
                <label className="text-sm text-muted-foreground">出生日期</label>
                <p className="px-3 py-2 rounded-lg bg-sidebar border border-border text-foreground text-sm">
                  --
                </p>
              </div>
              <div className="space-y-1">
                <label className="text-sm text-muted-foreground">出生地点</label>
                <p className="px-3 py-2 rounded-lg bg-sidebar border border-border text-foreground text-sm">
                  --
                </p>
              </div>
            </div>
          </div>
        ) : (
          <p className="text-muted-foreground">无法加载用户信息</p>
        )}
      </SettingsSection>

      {/* AI Engine Section */}
      <SettingsSection icon={<Bot className="w-4 h-4" />} title="AI 引擎">
        <RadioGroup
          label="对话后端"
          value={chatBackend}
          onChange={async (v) => {
            const next = v as api.ChatBackend
            const previous = chatBackend
            setChatBackend(next)
            const ok = await savePreferences({ chat_backend: next })
            if (!ok) setChatBackend(previous)
          }}
          options={[
            { value: "agent_service", label: "Vercel Agent", desc: "多功能 · 工具调用" },
            { value: "fastapi", label: "GLM 直连", desc: "低延迟 · 简单对话" },
          ]}
        />

        <SelectField
          label="GLM 模型"
          value="glm-4.7"
          onChange={() => {}}
          description="用于对话和报告生成"
          options={[
            { value: "glm-4", label: "GLM-4", desc: "基础版" },
            { value: "glm-4.7", label: "GLM-4.7", desc: "推荐" },
            { value: "glm-4-flash", label: "GLM-4-Flash", desc: "快速版" },
          ]}
        />

        <SelectField
          label="报告后端"
          value="glm"
          onChange={() => {}}
          description="用于生成深度报告"
          options={[
            { value: "glm", label: "GLM", desc: "中文优化，推荐" },
            { value: "gemini", label: "Gemini CLI", desc: "多模态支持" },
            { value: "claude", label: "Claude CLI", desc: "深度分析" },
          ]}
        />
      </SettingsSection>

      {/* Persona Section */}
      <SettingsSection icon={<MessageSquare className="w-4 h-4" />} title="教练风格">
        <RadioGroup
          value={preferences?.persona_style || "warm"}
          onChange={(v) => savePreferences({ persona_style: v as "standard" | "warm" | "roast" })}
          options={[
            { value: "standard", label: "专业理性", desc: "客观分析，理性建议" },
            { value: "warm", label: "温暖陪伴", desc: "共情陪伴，温和鼓励" },
            { value: "roast", label: "毒舌激励", desc: "犀利吐槽，反向激励" },
          ]}
        />
      </SettingsSection>

      {/* Push Notifications Section */}
      <SettingsSection icon={<Bell className="w-4 h-4" />} title="推送通知">
        <ToggleField
          label="启用推送"
          description="接收每日提醒和状态更新"
          value={preferences?.push_enabled ?? true}
          onChange={(v) => savePreferences({ push_enabled: v })}
        />

        <div className="grid grid-cols-2 gap-4">
          <div className="space-y-1">
            <label className="text-sm text-muted-foreground">推送时间</label>
            <input
              type="time"
              value={preferences?.push_time?.slice(0, 5) || "08:00"}
              onChange={(e) => savePreferences({ push_time: e.target.value + ":00" })}
              className={cn(
                "w-full px-3 py-2 rounded-lg",
                "bg-sidebar border border-border",
                "text-foreground",
                "focus:outline-none focus:ring-2 focus:ring-foreground/20"
              )}
            />
          </div>
        </div>

        <div className="space-y-1">
          <label className="text-sm text-muted-foreground">免打扰时段</label>
          <div className="flex items-center gap-2">
            <input
              type="time"
              value={preferences?.quiet_hours_start?.slice(0, 5) || "22:00"}
              onChange={(e) => savePreferences({ quiet_hours_start: e.target.value + ":00" })}
              className={cn(
                "flex-1 px-3 py-2 rounded-lg",
                "bg-sidebar border border-border",
                "text-foreground",
                "focus:outline-none focus:ring-2 focus:ring-foreground/20"
              )}
            />
            <span className="text-muted-foreground">至</span>
            <input
              type="time"
              value={preferences?.quiet_hours_end?.slice(0, 5) || "07:00"}
              onChange={(e) => savePreferences({ quiet_hours_end: e.target.value + ":00" })}
              className={cn(
                "flex-1 px-3 py-2 rounded-lg",
                "bg-sidebar border border-border",
                "text-foreground",
                "focus:outline-none focus:ring-2 focus:ring-foreground/20"
              )}
            />
          </div>
        </div>
      </SettingsSection>

      {/* Appearance Section */}
      <SettingsSection icon={<Palette className="w-4 h-4" />} title="外观">
        <RadioGroup
          label="主题"
          value="dark"
          onChange={() => {}}
          options={[
            { value: "dark", label: "暗色" },
            { value: "light", label: "亮色" },
            { value: "system", label: "跟随系统" },
          ]}
        />

        <SelectField
          label="语言"
          value="zh-CN"
          onChange={() => {}}
          options={[
            { value: "zh-CN", label: "简体中文" },
            { value: "en-US", label: "English" },
          ]}
        />
      </SettingsSection>

      {/* Account Security Section */}
      <SettingsSection icon={<Shield className="w-4 h-4" />} title="账户安全">
        <div className="space-y-3">
          <button
            type="button"
            className={cn(
              "w-full py-2 px-4 rounded-lg text-left",
              "bg-sidebar border border-border",
              "text-foreground hover:bg-sidebar/80 transition-colors"
            )}
          >
            修改密码
          </button>

          <button
            type="button"
            className={cn(
              "w-full py-2 px-4 rounded-lg text-left",
              "bg-sidebar border border-border",
              "text-foreground hover:bg-sidebar/80 transition-colors"
            )}
          >
            导出数据
          </button>

          <button
            type="button"
            onClick={handleLogout}
            disabled={isLoggingOut}
            className={cn(
              "w-full py-2 px-4 rounded-lg",
              "bg-destructive/10 text-destructive",
              "font-medium text-center",
              "hover:bg-destructive/20 transition-colors",
              "disabled:opacity-50 disabled:cursor-not-allowed"
            )}
          >
            {isLoggingOut ? "退出中..." : "退出登录"}
          </button>
        </div>
      </SettingsSection>

      {/* Version Info */}
      <div className="pt-4 text-center">
        <p className="text-sm text-muted-foreground">
          Fortune AI v1.0.0
        </p>
      </div>
    </div>
  )
}
