#!/usr/bin/env python3
"""
åè®®æµçœŸå®åœºæ™¯æµ‹è¯•

åŸºäºç”¨æˆ·å®é™…ä½¿ç”¨è®¾è®¡çš„å¤šç§scenarioï¼ŒåŒ…æ‹¬ï¼š
1. å®Œæ•´æµç¨‹ - ç”¨æˆ·ä»å¤´åˆ°å°¾å®Œæˆ
2. ä¸­æ–­æ¢å¤ - ç”¨æˆ·åšåˆ°ä¸€åŠé€€å‡ºå†è¿›
3. è¾¹ç•Œæƒ…å†µ - ç©ºå›ç­”ã€é•¿å›ç­”ã€ç‰¹æ®Šå­—ç¬¦
4. åè®®å–æ¶ˆ - ç”¨æˆ·ä¸­é€”æ”¾å¼ƒ
5. æ•°æ®æŒä¹…åŒ– - éªŒè¯æ•°æ®æ­£ç¡®ä¿å­˜

ç”¨æ³•ï¼š
  python scripts/test_protocol_scenarios.py
"""

import asyncio
import json
import sys
import os
from pathlib import Path
from datetime import datetime, timezone
from uuid import UUID

# è®¾ç½®æ•°æ®åº“ç¯å¢ƒå˜é‡
os.environ["VIBELIFE_DB_URL"] = "postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife"

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.unified_profile_repo import UnifiedProfileRepository
from routes.chat_v5 import (
    load_protocol_config,
    build_protocol_prompt,
    get_protocol_state,
    emit_protocol_progress_event,
)
from skills.lifecoach.tools.handlers import (
    show_protocol_invitation,
    advance_protocol_step,
    cancel_protocol,
)
from services.agent.tool_registry import ToolContext


# Test user IDs
TEST_USER_COMPLETE = UUID("00000000-0000-0000-0000-000000000001")
TEST_USER_INTERRUPT = UUID("00000000-0000-0000-0000-000000000002")
TEST_USER_CANCEL = UUID("00000000-0000-0000-0000-000000000003")
TEST_USER_BOUNDARY = UUID("00000000-0000-0000-0000-000000000004")


def print_section(title):
    """æ‰“å°æµ‹è¯•ç« èŠ‚æ ‡é¢˜"""
    print("\n" + "=" * 80)
    print(f"  {title}")
    print("=" * 80)


def print_result(status, message):
    """æ‰“å°æµ‹è¯•ç»“æœ"""
    emoji = "âœ…" if status == "success" else "âŒ" if status == "error" else "âš ï¸"
    print(f"{emoji} {message}")


async def cleanup_test_user(user_id: UUID):
    """æ¸…ç†æµ‹è¯•ç”¨æˆ·æ•°æ®ï¼ˆå®Œå…¨æ¸…ç† lifecoach skill æ•°æ®ï¼‰"""
    try:
        # å®Œå…¨æ¸…ç©º skills.lifecoach å¯¹è±¡ï¼ˆè€Œä¸æ˜¯åªæ¸…ç† protocol å­—æ®µï¼‰
        from stores.db import execute
        await execute(
            """UPDATE unified_profiles
               SET profile = jsonb_set(
                   COALESCE(profile, '{}'::jsonb),
                   '{skills}',
                   COALESCE(profile -> 'skills', '{}'::jsonb) - 'lifecoach'
               ),
               updated_at = NOW()
               WHERE user_id = $1""",
            user_id
        )
    except Exception as e:
        print(f"  âš ï¸  æ¸…ç†å¤±è´¥: {e}")
        pass  # é¦–æ¬¡è¿è¡Œå¯èƒ½æ²¡æœ‰æ•°æ®


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Scenario 1: å®Œæ•´æµç¨‹æµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_scenario_complete_flow():
    """
    æµ‹è¯•åœºæ™¯ 1: å®Œæ•´æµç¨‹

    ç”¨æˆ·ä»å¯åŠ¨åè®®åˆ°å®Œæˆå…¨éƒ¨6ä¸ªæ­¥éª¤ï¼Œæ£€éªŒï¼š
    - åè®®å¯åŠ¨
    - æ¯æ­¥æ•°æ®ä¿å­˜
    - æ­¥éª¤è‡ªåŠ¨æ¨è¿›
    - åè®®å®Œæˆ
    """
    print_section("Scenario 1: å®Œæ•´æµç¨‹æµ‹è¯•")

    user_id = TEST_USER_COMPLETE
    context = ToolContext(user_id=user_id, skill_id="lifecoach", user_tier="paid")

    # æ¸…ç†æ—§æ•°æ®
    print("\n[å‡†å¤‡] æ¸…ç†æ—§æ•°æ®...")
    await cleanup_test_user(user_id)
    print_result("success", "æ•°æ®æ¸…ç†å®Œæˆ")

    # æ¨¡æ‹Ÿç”¨æˆ·å›ç­”
    user_answers = {
        1: "å·¥ä½œæ²¡æ„ä¹‰ï¼Œæ¯å¤©éƒ½åœ¨é‡å¤",
        2: "åœ¨ä¸€ä¸ªç°æš—çš„å‡ºç§Ÿå±‹é†’æ¥ï¼Œèº«ä½“ç–²æƒ«ï¼Œ9ç‚¹åˆ°6ç‚¹åšç€é‡å¤çš„å·¥ä½œï¼Œæ™šä¸Š10ç‚¹æ„Ÿåˆ°ç©ºè™š",
        3: "åœ¨æµ·è¾¹çš„æˆ¿å­é†’æ¥ï¼Œèº«ä½“è½»ç›ˆï¼Œä¸€å¤©è‡ªç”±å®‰æ’ï¼Œæ™šä¸Šæ„Ÿåˆ°æ»¡è¶³å’Œå¹³é™",
        4: "æˆ‘æ˜¯é‚£ç§ä¼šæ‹–å»¶çš„äºº",
        5: "æˆ‘æ˜¯é‚£ç§è¯´åˆ°åšåˆ°çš„äºº",
        6: ["å‘¨ä¸‰æ™šä¸Šè·‘æ­¥30åˆ†é’Ÿ", "å‘¨æœ«å†™ä¸€ç¯‡æ–‡ç« ", "æ¯å¤©æ—©èµ·30åˆ†é’Ÿ"],
    }

    # Step 1: å¯åŠ¨åè®®
    print("\n[1/7] å¯åŠ¨åè®®...")
    await UnifiedProfileRepository.update_skill_state(
        user_id,
        "lifecoach",
        "protocol",
        {
            "id": "dankoe",
            "step": 1,
            "started_at": datetime.now(timezone.utc).isoformat(),
            "completed": False
        }
    )

    # éªŒè¯å¯åŠ¨
    state = await get_protocol_state(user_id, "lifecoach")
    if state and state["id"] == "dankoe" and state["step"] == 1:
        print_result("success", f"åè®®å·²å¯åŠ¨: {state['id']}, å½“å‰æ­¥éª¤: {state['step']}")
    else:
        print_result("error", "åè®®å¯åŠ¨å¤±è´¥")
        return

    # Step 2-7: æ¨¡æ‹Ÿå®Œæˆæ¯ä¸ªæ­¥éª¤
    for step in range(1, 7):
        print(f"\n[{step + 1}/7] æ­¥éª¤ {step}: {user_answers[step][:50]}...")

        # è°ƒç”¨ advance_protocol_step
        result = await advance_protocol_step(
            {
                "step_data": {
                    "answer": user_answers[step],
                    "answered_at": datetime.now(timezone.utc).isoformat()
                },
                "step_summary": f"ç”¨æˆ·å›ç­”äº†æ­¥éª¤{step}"
            },
            context
        )

        if result["status"] == "success":
            print_result("success", f"æ­¥éª¤{step}æ•°æ®å·²ä¿å­˜")

            # æ‰‹åŠ¨æ¨è¿›æ­¥éª¤ï¼ˆæ¨¡æ‹Ÿ chat_v5.py çš„è¡Œä¸ºï¼‰
            if step < 6:
                await UnifiedProfileRepository.update_skill_state(
                    user_id,
                    "lifecoach",
                    "protocol",
                    {"step": step + 1}
                )
                print_result("success", f"å·²æ¨è¿›åˆ°æ­¥éª¤{step + 1}")
        else:
            print_result("error", f"æ­¥éª¤{step}ä¿å­˜å¤±è´¥: {result.get('message')}")
            return

    # Step 8: æ ‡è®°åè®®å®Œæˆ
    print(f"\n[8/7] æ ‡è®°åè®®å®Œæˆ...")
    await UnifiedProfileRepository.update_skill_state(
        user_id,
        "lifecoach",
        "protocol",
        {"completed": True}
    )

    # éªŒè¯å®Œæˆ
    final_state = await UnifiedProfileRepository.get_skill_state(user_id, "lifecoach")
    protocol_data = final_state.get("protocol", {})

    if protocol_data.get("completed"):
        print_result("success", "åè®®å·²å®Œæˆ")

        # éªŒè¯æ‰€æœ‰æ­¥éª¤çš„æ•°æ®
        print("\n[éªŒè¯] æ£€æŸ¥ä¿å­˜çš„æ•°æ®...")
        data = protocol_data.get("data", {})
        for step in range(1, 7):
            step_key = f"step_{step}"
            if step_key in data:
                print_result("success", f"æ­¥éª¤{step}æ•°æ®å·²ä¿å­˜: {data[step_key].get('answer', '')[:50]}...")
            else:
                print_result("warning", f"æ­¥éª¤{step}æ•°æ®ç¼ºå¤±")
    else:
        print_result("error", "åè®®æœªæ ‡è®°ä¸ºå®Œæˆ")

    print("\n" + "-" * 80)
    print("Scenario 1 å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Scenario 2: ä¸­æ–­æ¢å¤æµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_scenario_interrupt_recovery():
    """
    æµ‹è¯•åœºæ™¯ 2: ä¸­æ–­æ¢å¤

    ç”¨æˆ·åšåˆ°ç¬¬3æ­¥æ—¶é€€å‡ºï¼Œå†æ¬¡è¿›å…¥æ—¶åº”è¯¥ï¼š
    - æ­£ç¡®æ¢å¤åˆ°ç¬¬3æ­¥
    - èƒ½çœ‹åˆ°ä¹‹å‰ä¿å­˜çš„æ•°æ®
    - èƒ½ç»§ç»­å®Œæˆåç»­æ­¥éª¤
    """
    print_section("Scenario 2: ä¸­æ–­æ¢å¤æµ‹è¯•")

    user_id = TEST_USER_INTERRUPT
    context = ToolContext(user_id=user_id, skill_id="lifecoach", user_tier="paid")

    # æ¸…ç†æ—§æ•°æ®
    print("\n[å‡†å¤‡] æ¸…ç†æ—§æ•°æ®...")
    await cleanup_test_user(user_id)

    # Phase 1: åšåˆ°ç¬¬3æ­¥åé€€å‡º
    print("\n[Phase 1] ç”¨æˆ·å®Œæˆå‰3æ­¥...")

    await UnifiedProfileRepository.update_skill_state(
        user_id,
        "lifecoach",
        "protocol",
        {
            "id": "dankoe",
            "step": 1,
            "started_at": datetime.now(timezone.utc).isoformat(),
            "completed": False
        }
    )

    # å®Œæˆæ­¥éª¤ 1-3
    answers_phase1 = {
        1: "å·¥ä½œå‹åŠ›å¤§",
        2: "åœ¨ç–²æƒ«ä¸­é†’æ¥",
        3: "åœ¨è‡ªç”±ä¸­é†’æ¥",
    }

    for step in range(1, 4):
        await advance_protocol_step(
            {
                "step_data": {"answer": answers_phase1[step]},
                "step_summary": f"æ­¥éª¤{step}å®Œæˆ"
            },
            context
        )
        if step < 3:
            await UnifiedProfileRepository.update_skill_state(
                user_id, "lifecoach", "protocol", {"step": step + 1}
            )

    # ç”¨æˆ·é€€å‡ºï¼ˆä¸æ¨è¿›åˆ°ç¬¬4æ­¥ï¼‰
    print_result("success", "ç”¨æˆ·å®Œæˆå‰3æ­¥ï¼Œç„¶åé€€å‡º")

    # Phase 2: æ¨¡æ‹Ÿç”¨æˆ·å†æ¬¡è¿›å…¥ï¼ˆéš”å¤©ï¼‰
    print("\n[Phase 2] ç”¨æˆ·ç¬¬äºŒå¤©å†æ¬¡è¿›å…¥...")

    # æ¢å¤åè®®çŠ¶æ€
    recovered_state = await get_protocol_state(user_id, "lifecoach")

    if recovered_state and recovered_state["step"] == 3:
        print_result("success", f"åè®®çŠ¶æ€å·²æ¢å¤: æ­¥éª¤ {recovered_state['step']}")

        # éªŒè¯ä¹‹å‰çš„æ•°æ®
        lifecoach_data = await UnifiedProfileRepository.get_skill_state(user_id, "lifecoach")
        saved_data = lifecoach_data.get("protocol", {}).get("data", {})

        for step in range(1, 4):
            if f"step_{step}" in saved_data:
                print_result("success", f"æ­¥éª¤{step}æ•°æ®å·²æ¢å¤")
            else:
                print_result("error", f"æ­¥éª¤{step}æ•°æ®ä¸¢å¤±")
    else:
        print_result("error", "åè®®çŠ¶æ€æ¢å¤å¤±è´¥")
        return

    # Phase 3: ç»§ç»­å®Œæˆå‰©ä½™æ­¥éª¤
    print("\n[Phase 3] ç»§ç»­å®Œæˆæ­¥éª¤ 4-6...")

    answers_phase2 = {
        4: "æˆ‘æ˜¯é‚£ç§çŠ¹è±«çš„äºº",
        5: "æˆ‘æ˜¯é‚£ç§æœæ–­çš„äºº",
        6: ["æ™¨è·‘", "å†¥æƒ³"],
    }

    # å…ˆæ¨è¿›åˆ°ç¬¬4æ­¥
    await UnifiedProfileRepository.update_skill_state(
        user_id, "lifecoach", "protocol", {"step": 4}
    )

    for step in range(4, 7):
        await advance_protocol_step(
            {
                "step_data": {"answer": answers_phase2[step]},
                "step_summary": f"æ­¥éª¤{step}å®Œæˆ"
            },
            context
        )
        if step < 6:
            await UnifiedProfileRepository.update_skill_state(
                user_id, "lifecoach", "protocol", {"step": step + 1}
            )

    # æ ‡è®°å®Œæˆ
    await UnifiedProfileRepository.update_skill_state(
        user_id, "lifecoach", "protocol", {"completed": True}
    )

    # éªŒè¯æœ€ç»ˆæ•°æ®
    final_data = await UnifiedProfileRepository.get_skill_state(user_id, "lifecoach")
    all_steps = final_data.get("protocol", {}).get("data", {})

    if len(all_steps) == 6:
        print_result("success", f"æ‰€æœ‰6ä¸ªæ­¥éª¤çš„æ•°æ®éƒ½å·²ä¿å­˜")
    else:
        print_result("warning", f"åªä¿å­˜äº†{len(all_steps)}ä¸ªæ­¥éª¤çš„æ•°æ®")

    print("\n" + "-" * 80)
    print("Scenario 2 å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Scenario 3: åè®®å–æ¶ˆæµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_scenario_protocol_cancel():
    """
    æµ‹è¯•åœºæ™¯ 3: åè®®å–æ¶ˆ

    ç”¨æˆ·åœ¨ç¬¬2æ­¥æ—¶å†³å®šå–æ¶ˆåè®®ï¼Œæ£€éªŒï¼š
    - cancel_protocol å·¥å…·æ­£å¸¸å·¥ä½œ
    - å·²ä¿å­˜çš„æ•°æ®è¢«ä¿ç•™
    - åè®®çŠ¶æ€è¢«æ ‡è®°ä¸ºå·²å–æ¶ˆ
    """
    print_section("Scenario 3: åè®®å–æ¶ˆæµ‹è¯•")

    user_id = TEST_USER_CANCEL
    context = ToolContext(user_id=user_id, skill_id="lifecoach", user_tier="paid")

    # æ¸…ç†æ—§æ•°æ®
    print("\n[å‡†å¤‡] æ¸…ç†æ—§æ•°æ®...")
    await cleanup_test_user(user_id)

    # å¯åŠ¨åè®®
    print("\n[1/4] å¯åŠ¨åè®®...")
    await UnifiedProfileRepository.update_skill_state(
        user_id,
        "lifecoach",
        "protocol",
        {
            "id": "dankoe",
            "step": 1,
            "started_at": datetime.now(timezone.utc).isoformat(),
            "completed": False
        }
    )
    print_result("success", "åè®®å·²å¯åŠ¨")

    # å®Œæˆç¬¬1æ­¥
    print("\n[2/4] å®Œæˆç¬¬1æ­¥...")
    await advance_protocol_step(
        {
            "step_data": {"answer": "å·¥ä½œå¤ªç´¯"},
            "step_summary": "æ­¥éª¤1å®Œæˆ"
        },
        context
    )
    await UnifiedProfileRepository.update_skill_state(
        user_id, "lifecoach", "protocol", {"step": 2}
    )
    print_result("success", "ç¬¬1æ­¥å·²å®Œæˆ")

    # ç”¨æˆ·å†³å®šå–æ¶ˆ
    print("\n[3/4] ç”¨æˆ·å†³å®šå–æ¶ˆåè®®...")
    cancel_result = await cancel_protocol(
        {"reason": "ç”¨æˆ·æš‚æ—¶æ²¡æœ‰æ—¶é—´"},
        context
    )

    if cancel_result["status"] == "success":
        print_result("success", "åè®®å·²å–æ¶ˆ")
    else:
        print_result("error", f"å–æ¶ˆå¤±è´¥: {cancel_result.get('message')}")
        return

    # éªŒè¯å–æ¶ˆçŠ¶æ€
    print("\n[4/4] éªŒè¯å–æ¶ˆçŠ¶æ€...")
    cancelled_state = await UnifiedProfileRepository.get_skill_state(user_id, "lifecoach")
    protocol = cancelled_state.get("protocol", {})

    if protocol.get("cancelled"):
        print_result("success", "åè®®çŠ¶æ€å·²æ ‡è®°ä¸ºå·²å–æ¶ˆ")
        print_result("success", f"å–æ¶ˆåŸå› : {protocol.get('cancel_reason')}")

        # éªŒè¯å·²ä¿å­˜çš„æ•°æ®ä»ç„¶å­˜åœ¨
        if "step_1" in protocol.get("data", {}):
            print_result("success", "å·²ä¿å­˜çš„æ•°æ®è¢«ä¿ç•™")
        else:
            print_result("warning", "å·²ä¿å­˜çš„æ•°æ®ä¸¢å¤±")
    else:
        print_result("error", "åè®®çŠ¶æ€æœªæ ‡è®°ä¸ºå·²å–æ¶ˆ")

    print("\n" + "-" * 80)
    print("Scenario 3 å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Scenario 4: è¾¹ç•Œæƒ…å†µæµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_scenario_boundary_cases():
    """
    æµ‹è¯•åœºæ™¯ 4: è¾¹ç•Œæƒ…å†µ

    æµ‹è¯•å„ç§è¾¹ç•Œè¾“å…¥ï¼š
    - ç©ºå›ç­”
    - è¶…é•¿å›ç­”
    - ç‰¹æ®Šå­—ç¬¦
    - æ•°ç»„ç±»å‹å›ç­”
    """
    print_section("Scenario 4: è¾¹ç•Œæƒ…å†µæµ‹è¯•")

    user_id = TEST_USER_BOUNDARY
    context = ToolContext(user_id=user_id, skill_id="lifecoach", user_tier="paid")

    # æ¸…ç†æ—§æ•°æ®
    print("\n[å‡†å¤‡] æ¸…ç†æ—§æ•°æ®...")
    await cleanup_test_user(user_id)

    # å¯åŠ¨åè®®
    await UnifiedProfileRepository.update_skill_state(
        user_id,
        "lifecoach",
        "protocol",
        {
            "id": "dankoe",
            "step": 1,
            "started_at": datetime.now(timezone.utc).isoformat(),
            "completed": False
        }
    )

    # æµ‹è¯•æ¡ˆä¾‹
    test_cases = [
        {
            "name": "ç©ºå›ç­”",
            "data": {"answer": ""},
            "expected": "åº”è¯¥ä¿å­˜ç©ºå­—ç¬¦ä¸²"
        },
        {
            "name": "è¶…é•¿å›ç­”",
            "data": {"answer": "è¿™æ˜¯ä¸€ä¸ªéå¸¸é•¿çš„å›ç­”" * 100},
            "expected": "åº”è¯¥ä¿å­˜å®Œæ•´çš„é•¿æ–‡æœ¬"
        },
        {
            "name": "ç‰¹æ®Šå­—ç¬¦",
            "data": {"answer": "åŒ…å«ç‰¹æ®Šå­—ç¬¦: <>&\"'{}[]"},
            "expected": "åº”è¯¥æ­£ç¡®è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦"
        },
        {
            "name": "ä¸­æ–‡å’Œemoji",
            "data": {"answer": "æˆ‘æƒ³è¦ğŸ˜Šè‡ªç”±ğŸ‰"},
            "expected": "åº”è¯¥æ”¯æŒUnicode"
        },
        {
            "name": "æ•°ç»„ç±»å‹",
            "data": {"answer": ["è¡ŒåŠ¨1", "è¡ŒåŠ¨2", "è¡ŒåŠ¨3"]},
            "expected": "åº”è¯¥æ”¯æŒæ•°ç»„"
        },
    ]

    for i, test_case in enumerate(test_cases, 1):
        print(f"\n[{i}/{len(test_cases)}] æµ‹è¯•: {test_case['name']}")

        try:
            result = await advance_protocol_step(
                {
                    "step_data": test_case["data"],
                    "step_summary": test_case["name"]
                },
                context
            )

            if result["status"] == "success":
                print_result("success", test_case["expected"])
            else:
                print_result("error", f"ä¿å­˜å¤±è´¥: {result.get('message')}")

            # æ¨è¿›åˆ°ä¸‹ä¸€æ­¥
            if i < len(test_cases):
                await UnifiedProfileRepository.update_skill_state(
                    user_id, "lifecoach", "protocol", {"step": i + 1}
                )
        except Exception as e:
            print_result("error", f"å¼‚å¸¸: {str(e)}")

    # éªŒè¯æ‰€æœ‰æ•°æ®
    print("\n[éªŒè¯] æ£€æŸ¥æ‰€æœ‰è¾¹ç•Œæ•°æ®...")
    final_data = await UnifiedProfileRepository.get_skill_state(user_id, "lifecoach")
    saved_steps = final_data.get("protocol", {}).get("data", {})

    for i in range(1, len(test_cases) + 1):
        if f"step_{i}" in saved_steps:
            print_result("success", f"æ­¥éª¤{i}æ•°æ®å·²ä¿å­˜")
        else:
            print_result("error", f"æ­¥éª¤{i}æ•°æ®ä¸¢å¤±")

    print("\n" + "-" * 80)
    print("Scenario 4 å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Scenario 5: åè®®é…ç½®åŠ è½½æµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_scenario_config_loading():
    """
    æµ‹è¯•åœºæ™¯ 5: åè®®é…ç½®åŠ è½½

    éªŒè¯ï¼š
    - load_protocol_config æ­£ç¡®åŠ è½½YAML
    - build_protocol_prompt æ­£ç¡®ç”Ÿæˆprompt
    - emit_protocol_progress_event æ­£ç¡®ç”Ÿæˆäº‹ä»¶
    """
    print_section("Scenario 5: åè®®é…ç½®åŠ è½½æµ‹è¯•")

    # æµ‹è¯• 1: åŠ è½½é…ç½®
    print("\n[1/3] æµ‹è¯•é…ç½®åŠ è½½...")
    config = load_protocol_config("dankoe")

    if config and config.get("id") == "dankoe":
        print_result("success", f"é…ç½®åŠ è½½æˆåŠŸ: {config['name']}")
        print_result("success", f"æ€»æ­¥éª¤æ•°: {config['total_steps']}")
        print_result("success", f"é¢„è®¡æ—¶é•¿: {config['estimated_time']}")
    else:
        print_result("error", "é…ç½®åŠ è½½å¤±è´¥")
        return

    # æµ‹è¯• 2: æ„å»º prompt
    print("\n[2/3] æµ‹è¯• prompt æ„å»º...")

    mock_lifecoach_state = {
        "protocol": {
            "data": {
                "step_1": {
                    "answer": "å·¥ä½œæ²¡æ„ä¹‰",
                    "summary": "ç”¨æˆ·æåˆ°å·¥ä½œç¼ºä¹æ„ä¹‰"
                }
            }
        }
    }

    for step in [1, 3, 6]:
        prompt = build_protocol_prompt(config, step, mock_lifecoach_state)
        if prompt and f"æ­¥éª¤ {step}" in prompt:
            print_result("success", f"æ­¥éª¤{step} prompt ç”ŸæˆæˆåŠŸ")
        else:
            print_result("error", f"æ­¥éª¤{step} prompt ç”Ÿæˆå¤±è´¥")

    # æµ‹è¯• 3: ç”Ÿæˆè¿›åº¦äº‹ä»¶
    print("\n[3/3] æµ‹è¯•è¿›åº¦äº‹ä»¶ç”Ÿæˆ...")

    mock_protocol_state = {
        "id": "dankoe",
        "step": 3
    }

    try:
        event = await emit_protocol_progress_event(mock_protocol_state, config)
        if event.type == "protocol_progress":
            print_result("success", "è¿›åº¦äº‹ä»¶ç”ŸæˆæˆåŠŸ")
            print_result("success", f"äº‹ä»¶æ•°æ®: step={event.data['step']}, progress={event.data['progress']:.2f}")
        else:
            print_result("error", "äº‹ä»¶ç±»å‹é”™è¯¯")
    except Exception as e:
        print_result("error", f"ç”Ÿæˆäº‹ä»¶å¤±è´¥: {str(e)}")

    print("\n" + "-" * 80)
    print("Scenario 5 å®Œæˆ")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»æµ‹è¯•å…¥å£
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def run_all_scenarios():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•åœºæ™¯"""
    print("\n")
    print("â•”" + "=" * 78 + "â•—")
    print("â•‘" + " " * 20 + "åè®®æµçœŸå®åœºæ™¯æµ‹è¯•å¥—ä»¶" + " " * 36 + "â•‘")
    print("â•š" + "=" * 78 + "â•")

    scenarios = [
        ("å®Œæ•´æµç¨‹", test_scenario_complete_flow),
        ("ä¸­æ–­æ¢å¤", test_scenario_interrupt_recovery),
        ("åè®®å–æ¶ˆ", test_scenario_protocol_cancel),
        ("è¾¹ç•Œæƒ…å†µ", test_scenario_boundary_cases),
        ("é…ç½®åŠ è½½", test_scenario_config_loading),
    ]

    results = {}

    for name, test_func in scenarios:
        try:
            await test_func()
            results[name] = "âœ… é€šè¿‡"
        except Exception as e:
            print_result("error", f"æµ‹è¯•å¼‚å¸¸: {str(e)}")
            import traceback
            traceback.print_exc()
            results[name] = f"âŒ å¤±è´¥: {str(e)}"

    # æ‰“å°æµ‹è¯•æ€»ç»“
    print_section("æµ‹è¯•æ€»ç»“")
    print("\næµ‹è¯•ç»“æœï¼š")
    for name, result in results.items():
        print(f"  {result:10} - {name}")

    passed = sum(1 for r in results.values() if r.startswith("âœ…"))
    total = len(results)

    print(f"\né€šè¿‡ç‡: {passed}/{total} ({passed/total*100:.0f}%)")

    if passed == total:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
    else:
        print(f"\nâš ï¸ {total - passed} ä¸ªæµ‹è¯•å¤±è´¥")


if __name__ == "__main__":
    print("\nåè®®æµçœŸå®åœºæ™¯æµ‹è¯•")
    print("åŸºäºç”¨æˆ·å®é™…ä½¿ç”¨è®¾è®¡çš„å¤šç§scenario")
    print("-" * 80)

    try:
        asyncio.run(run_all_scenarios())
    except KeyboardInterrupt:
        print("\n\næµ‹è¯•è¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"\n\nâŒ æµ‹è¯•è¿è¡Œå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
