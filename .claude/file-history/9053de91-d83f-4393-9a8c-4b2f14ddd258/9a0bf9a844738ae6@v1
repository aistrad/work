version: "2.0"
skill_id: core
description: 全局工具 - 所有 Skill 共享 (V7 重构版)

# ═══════════════════════════════════════════════════════════════════════════
# 搜索型工具
# ═══════════════════════════════════════════════════════════════════════════
search:
  - name: search_db
    description: |
      从数据库检索知识或案例。
      - table='knowledge_chunks': 检索专业知识
      - table='cases': 检索参考案例
      LLM 根据 SOP 自己判断何时需要检索。
    parameters:
      - name: table
        type: string
        required: true
        description: 要查询的表
        enum:
          - knowledge_chunks
          - cases
      - name: query
        type: string
        required: true
        description: 检索查询词
      - name: filters
        type: object
        required: false
        description: 可选过滤条件，如 skill_id, scenario_id, tags 等
      - name: top_k
        type: integer
        required: false
        description: 返回结果数量
        default: 5

# ═══════════════════════════════════════════════════════════════════════════
# 收集型工具
# ═══════════════════════════════════════════════════════════════════════════
collect:
  - name: ask_user_question
    description: |
      主动向用户提问以获取更多信息。
      何时调用：
      - 用户意图不明确，需要澄清
      - 需要用户做出选择
      - 缺少必要信息无法继续
      提问原则：
      - 问题要具体、明确
      - 提供选项时不超过4个
      - 避免连续追问
    card_type: question_card
    parameters:
      - name: question
        type: string
        required: true
        description: 要问用户的问题
      - name: options
        type: array
        required: false
        description: 可选的选项列表（最多4个）

  - name: request_info
    description: |
      向用户请求信息。当需要收集出生信息或其他必要信息时调用。
    card_type: collect_form
    parameters:
      - name: info_type
        type: string
        required: true
        description: 信息类型
        enum:
          - birth
          - context
          - goals
          - concerns
      - name: question
        type: string
        required: false
        description: 自定义问题

# ═══════════════════════════════════════════════════════════════════════════
# Skill 数据工具 (V8 新增 - 统一 Skill Data 架构)
# ═══════════════════════════════════════════════════════════════════════════
action:
  # ─────────────────────────────────────────────────────────────────────────
  # 通用 Skill 状态工具 - REFACTOR_PLAN.md Phase 1
  # ─────────────────────────────────────────────────────────────────────────
  - name: read_state
    description: |
      读取当前 Skill 的用户状态。

      这是一个通用工具，所有 Skill 共享。
      自动使用当前 skill_id，无需手动指定。

      数据存储在 profile.skills.{skill_id}

      调用时机：
      - 需要读取之前保存的数据时
      - 检查协议状态时
      - 获取用户目标、计划等业务数据时

      示例调用：
      read_state({})  # 读取全部数据
      read_state({"sections": ["north_star", "goals"]})  # 只读取指定部分
    parameters:
      - name: sections
        type: array
        required: false
        description: |
          要读取的部分（可选）。
          如果不指定，则读取全部数据。
          示例：["north_star", "goals", "protocol"]

  - name: write_state
    description: |
      写入当前 Skill 的用户状态。

      这是一个通用工具，所有 Skill 共享。
      自动使用当前 skill_id，无需手动指定。

      支持深度合并，不会覆盖未指定的字段。
      数据存储在 profile.skills.{skill_id}.{section}

      调用时机：
      - 保存协议数据时
      - 更新用户目标、计划时
      - 记录重要状态变化时

      示例调用：
      write_state({
        "section": "north_star",
        "data": {
          "vision": "通过创作实现财务自由",
          "anti_vision": "被困在无意义的工作中"
        }
      })

      write_state({
        "section": "protocol",
        "data": {
          "id": "dankoe",
          "step": 2,
          "started_at": "2026-01-20T10:00:00Z"
        }
      })
    parameters:
      - name: section
        type: string
        required: true
        description: |
          要写入的部分，如 "north_star"、"protocol"、"goals"。
          数据会写入 profile.skills.{skill_id}.{section}
      - name: data
        type: object
        required: true
        description: |
          要写入的数据。
          会与现有数据深度合并，不会覆盖未指定的字段。

  - name: append_to_list
    description: |
      向列表追加条目。

      这是一个通用工具，所有 Skill 共享。
      用于日志、记录等场景。

      自动添加 _created_at 时间戳。
      支持多级路径（如 "progress.milestones"）。
      自动限制列表长度，删除最旧的条目。

      调用时机：
      - 添加日志条目时
      - 记录里程碑时
      - 保存历史记录时

      示例调用：
      append_to_list({
        "path": "journal",
        "entry": {
          "content": "今天完成了第一个目标",
          "mood": "excited"
        },
        "max_items": 100
      })

      append_to_list({
        "path": "progress.milestones",
        "entry": {
          "title": "完成第一章",
          "description": "书稿第一章完成"
        }
      })
    parameters:
      - name: path
        type: string
        required: true
        description: |
          列表路径。
          单级路径：如 "journal"
          多级路径：如 "progress.milestones"
      - name: entry
        type: object
        required: true
        description: |
          要追加的条目。
          会自动添加 _created_at 时间戳。
      - name: max_items
        type: integer
        required: false
        default: 100
        description: |
          列表最大长度。
          超出时会删除最旧的条目（保留最新的）。

  # ─────────────────────────────────────────────────────────────────────────
  # 旧版工具（保留向后兼容）
  # ─────────────────────────────────────────────────────────────────────────
  - name: save_skill_data
    description: |
      保存当前 Skill 的数据到 VibeProfile.skill_data.{skill_id}。

      这是一个通用工具，所有 Skill 都可以使用。
      数据会自动与现有数据深度合并。

      调用时机：
      - 完成一个协议/流程后（如 Dan Koe 快速重置）
      - 用户提供了重要信息需要记住
      - 状态发生变化需要持久化

      数据结构建议：
      - 业务数据：north_star, identity, weekly 等
      - 运行时状态：_state.current_protocol, _state.streak 等
      - 元数据 _meta 会自动管理（version, updated_at）

      示例调用：
      save_skill_data({
        "data": {
          "north_star": {
            "vision": "成为独立创业者",
            "anti_vision": "继续打工"
          },
          "identity": {
            "old": "我是那种会拖延的人",
            "new": "我是那种说到做到的人"
          },
          "_state": {
            "last_interaction": "2026-01-20"
          }
        }
      })
    parameters:
      - name: data
        type: object
        required: true
        description: |
          要保存的数据，会与现有数据深度合并。
          传入 null 值可删除对应字段。
      - name: replace
        type: boolean
        required: false
        description: |
          是否完全替换（而非合并）。
          默认 false，即深度合并现有数据。
        default: false

# ═══════════════════════════════════════════════════════════════════════════
# 用户数据工具 (Core 零业务语义)
# ═══════════════════════════════════════════════════════════════════════════

  - name: read_user_data
    description: |
      读取用户存储的数据。
      何时调用：
      - 用户询问自己的目标、计划、任务时
      - 需要获取用户之前保存的信息时
      - 查看打卡记录或进度时
    parameters:
      - name: path
        type: string
        required: true
        description: |
          数据路径，如：
          - goals/2026/year - 年度目标
          - goals/2026/q1 - 季度目标
          - plans/daily/2026-01-18 - 每日计划
          - checkins/2026-01-18 - 打卡记录

  - name: write_user_data
    description: |
      写入或更新用户数据。
      何时调用：
      - 用户设定新目标时
      - 用户修改计划时
      - 记录打卡或反思时
      - 保存用户的任何结构化信息时
    parameters:
      - name: path
        type: string
        required: true
        description: 数据路径
      - name: content
        type: object
        required: true
        description: |
          JSON 数据内容。建议包含：
          - title: 标题
          - status: 状态 (active/completed/archived)
          - items: 子项列表（如适用）
          - notes: 用户备注
      - name: expected_version
        type: integer
        required: false
        description: |
          乐观锁版本号（可选）。
          如果指定，只有当前版本匹配时才会更新，否则返回 conflict 错误。
          用于防止并发写入冲突。

  - name: query_user_data
    description: |
      查询用户数据。支持按路径前缀、内容过滤。
      何时调用：
      - 列出用户所有目标
      - 查找特定时间段的计划
      - 搜索包含特定关键词的记录
    parameters:
      - name: path_prefix
        type: string
        required: false
        description: |
          路径前缀过滤，如 "goals/2026"、"plans/daily"。
          这是主要的查询方式，路径规范由 scenarios/ 定义。
      - name: filters
        type: object
        required: false
        description: 'JSONB 过滤条件，如 {"status": "active"}'
      - name: sort_by
        type: string
        required: false
        description: 排序字段，如 "updated_at"、"created_at"
      - name: limit
        type: integer
        required: false
        description: 返回数量限制
        default: 20

  - name: delete_user_data
    description: |
      删除用户数据。
      何时调用：
      - 用户明确要求删除某个目标或计划时
      注意：删除前应确认用户意图
    parameters:
      - name: path
        type: string
        required: true
        description: 要删除的数据路径

# ═══════════════════════════════════════════════════════════════════════════
# 触发器工具 (V7 新增)
# ═══════════════════════════════════════════════════════════════════════════
  - name: create_trigger
    description: |
      创建用户触发器（提醒、条件触发、定时任务）。
      何时调用：
      - 用户要求每日提醒打卡时 (trigger_type: reminder)
      - 设置目标截止日期提醒时 (trigger_type: reminder)
      - 当某个数据满足条件时触发 (trigger_type: condition)
      - 定时执行任务 (trigger_type: schedule)
    parameters:
      - name: trigger_type
        type: string
        required: true
        description: 触发类型
        enum:
          - reminder
          - condition
          - schedule
      - name: title
        type: string
        required: true
        description: 触发器标题
      - name: schedule
        type: string
        required: false
        description: |
          调度表达式（reminder/schedule 类型必填）：
          - daily: "08:00" (每天8点)
          - weekly: "1,3,5 09:00" (周一三五9点)
          - once: "2026-01-20T10:00:00" (一次性)
          - cron: "0 8 * * *" (cron 表达式)
      - name: schedule_type
        type: string
        required: false
        description: 调度类型
        default: daily
        enum:
          - once
          - daily
          - weekly
          - cron
      - name: condition
        type: object
        required: false
        description: |
          条件规则（condition 类型必填）：
          {field: "status", operator: "eq", value: "completed"}
          支持的 operator: eq, ne, gt, gte, lt, lte, contains, exists, not_exists
      - name: action
        type: object
        required: false
        description: |
          触发动作：
          {type: "notify", payload: {title: "...", body: "..."}}
          {type: "message", payload: {content: "..."}}
      - name: source_path
        type: string
        required: false
        description: 监控的数据路径（condition 类型）
      - name: trigger_subtype
        type: string
        required: false
        description: 子类型
        default: custom
        enum:
          - goal_checkin
          - daily_plan
          - milestone
          - custom

  - name: list_triggers
    description: |
      列出用户的触发器。
      何时调用：
      - 用户询问"我有哪些提醒"时
      - 需要展示用户的触发器设置时
    parameters:
      - name: trigger_type
        type: string
        required: false
        description: 按触发类型过滤
        enum:
          - reminder
          - condition
          - schedule
      - name: status
        type: string
        required: false
        description: 按状态过滤
        default: active
        enum:
          - active
          - paused
          - completed
          - cancelled

  - name: cancel_trigger
    description: |
      取消用户的触发器。
      何时调用：
      - 用户要求取消某个提醒时
      - 目标完成后自动取消关联触发器时
    parameters:
      - name: trigger_id
        type: string
        required: true
        description: 要取消的触发器 ID

# ═══════════════════════════════════════════════════════════════════════════
# 展示型工具 (V7 统一为 show_card)
# ═══════════════════════════════════════════════════════════════════════════
display:
  - name: show_all_skills
    description: |
      展示所有可用 Skill 的 IntroCard 列表。

      何时调用：
      - 用户问题超出当前 Skill 能力范围时
      - 用户询问"你能做什么"、"有什么功能"时
      - 需要引导用户选择合适的 Skill 时

      注意：
      - 这是边界控制的核心工具
      - 当无法处理用户请求时，优先调用此工具而不是简单拒绝
      - 展示后让用户自己选择，不要替用户做决定
    card_type: skill_list
    parameters:
      - name: category
        type: string
        required: false
        description: 按分类过滤 Skill
        enum:
          - core
          - default
          - professional
      - name: message
        type: string
        required: false
        description: 展示给用户的引导语，如"这个问题超出了我的专长，以下是我能帮你的领域"

  - name: show_card
    description: |
      统一卡片展示工具。支持 11 种通用视图类型和自定义卡片。

      通用视图类型：
      - list: 列表展示
      - tree: 树形结构（目标层级）
      - table: 表格数据
      - timeline: 时间线
      - form: 交互表单
      - select: 选择器
      - chart: 图表 (line, bar, pie, radar)
      - progress: 进度条
      - counter: 计数器
      - modal: 模态框
      - toast: 轻提示
      - custom: 自定义组件（需指定 component_id）

      何时调用：
      - 展示目标树时 (card_type: tree)
      - 展示今日计划时 (card_type: list)
      - 展示打卡表单时 (card_type: form)
      - 展示进度时 (card_type: progress)
      - 展示 Skill 专属卡片时 (card_type: custom, component_id: bazi_chart)
    parameters:
      - name: card_type
        type: string
        required: true
        description: 卡片类型
        enum:
          - list
          - tree
          - table
          - timeline
          - form
          - select
          - chart
          - progress
          - counter
          - modal
          - toast
          - custom
      - name: data_source
        type: object
        required: false
        description: |
          数据源配置：
          - {type: "inline", data: [...]} - 内联数据
          - {type: "path", path: "goals/2026"} - 从 user_data_store 读取
          - {type: "api", endpoint: "/api/..."} - 前端调用 API
      - name: options
        type: object
        required: false
        description: |
          视图选项，根据 card_type 不同：
          - list: {emptyText, showIndex}
          - tree: {expandLevel, showProgress}
          - table: {columns, sortable, pagination}
          - form: {fields, submitLabel, submitAction}
          - chart: {chartType, xAxis, yAxis}
          - progress: {max, label, showPercentage}
          - custom: {componentId} - 必填，指定自定义组件

  - name: recommend_skill
    description: |
      推荐 Skill 给用户。当判断用户可能对某个未订阅的 Skill 感兴趣时调用。

      何时调用：
      - 用户提到与某个 Skill 相关的话题，但当前未使用该 Skill
      - 用户表达了某种需求，某个 Skill 可以更好地满足
      - 对话中自然出现推荐时机

      注意：
      - 不要频繁推荐，每次对话最多推荐一次
      - 推荐要自然，不要强行推销
      - 如果用户已订阅该 Skill，工具会自动跳过
    card_type: skill_recommendation
    parameters:
      - name: skill_id
        type: string
        required: true
        description: 推荐的 Skill ID
        enum:
          - bazi
          - zodiac
          - tarot
          - jungastro
          - career
          - mindfulness
          - vibe_id
      - name: reason
        type: string
        required: true
        description: 推荐原因，基于对话内容生成，要自然、有说服力
      - name: confidence
        type: string
        required: false
        description: 推荐置信度
        default: medium
        enum:
          - high
          - medium
          - low
