#!/usr/bin/env python3
"""
åè®®æµå•å…ƒæµ‹è¯• - ä¸ä¾èµ–æ•°æ®åº“

ä¸“æ³¨æµ‹è¯•ï¼š
1. åè®®é…ç½®åŠ è½½
2. Prompt ç”Ÿæˆé€»è¾‘
3. äº‹ä»¶ç”Ÿæˆ
4. è¾¹ç•Œæƒ…å†µå¤„ç†

ç”¨æ³•ï¼š
  python scripts/test_protocol_unit.py
"""

import sys
from pathlib import Path
import json

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from routes.chat_v5 import (
    load_protocol_config,
    build_protocol_prompt,
)


def print_section(title):
    """æ‰“å°æµ‹è¯•ç« èŠ‚æ ‡é¢˜"""
    print("\n" + "=" * 80)
    print(f"  {title}")
    print("=" * 80)


def print_result(status, message):
    """æ‰“å°æµ‹è¯•ç»“æœ"""
    emoji = "âœ…" if status == "success" else "âŒ" if status == "error" else "âš ï¸"
    print(f"{emoji} {message}")


def test_config_loading():
    """æµ‹è¯•åè®®é…ç½®åŠ è½½"""
    print_section("Test 1: åè®®é…ç½®åŠ è½½")

    config = load_protocol_config("dankoe")

    # éªŒè¯åŸºæœ¬å­—æ®µ
    assert config.get("id") == "dankoe", "åè®®IDä¸åŒ¹é…"
    print_result("success", f"åè®®ID: {config['id']}")

    assert config.get("name") == "Dan Koe å¿«é€Ÿé‡ç½®", "åè®®åç§°ä¸åŒ¹é…"
    print_result("success", f"åè®®åç§°: {config['name']}")

    assert config.get("total_steps") == 6, "æ­¥éª¤æ•°ä¸æ­£ç¡®"
    print_result("success", f"æ€»æ­¥éª¤æ•°: {config['total_steps']}")

    # éªŒè¯æ¯ä¸ªæ­¥éª¤çš„é…ç½®
    steps = config.get("steps", {})
    for step_num in range(1, 7):
        step_config = steps.get(step_num)
        assert step_config is not None, f"æ­¥éª¤{step_num}é…ç½®ç¼ºå¤±"

        # éªŒè¯å¿…éœ€å­—æ®µ
        assert "phase" in step_config, f"æ­¥éª¤{step_num}ç¼ºå°‘phase"
        assert "name" in step_config, f"æ­¥éª¤{step_num}ç¼ºå°‘name"
        assert "question" in step_config, f"æ­¥éª¤{step_num}ç¼ºå°‘question"
        assert "save_to" in step_config, f"æ­¥éª¤{step_num}ç¼ºå°‘save_to"
        assert "response_prompt" in step_config, f"æ­¥éª¤{step_num}ç¼ºå°‘response_prompt"

        print_result("success", f"æ­¥éª¤{step_num}: {step_config['name']}")

    print_result("success", "æ‰€æœ‰é…ç½®å­—æ®µéªŒè¯é€šè¿‡")
    return config


def test_prompt_generation(config):
    """æµ‹è¯• Prompt ç”Ÿæˆ"""
    print_section("Test 2: Prompt ç”Ÿæˆé€»è¾‘")

    # æµ‹è¯•æ¡ˆä¾‹
    test_cases = [
        {
            "step": 1,
            "state": {"protocol": {"data": {}}},
            "expected_in_prompt": ["æ­¥éª¤ 1/6", "æŒç»­çš„ä¸æ»¡", "Phase 1"]
        },
        {
            "step": 3,
            "state": {
                "protocol": {
                    "data": {
                        "step_1": {"summary": "å·¥ä½œç¼ºä¹æ„ä¹‰"},
                        "step_2": {"summary": "åæ„¿æ™¯æè¿°"}
                    }
                }
            },
            "expected_in_prompt": ["æ­¥éª¤ 3/6", "æ„¿æ™¯åœºæ™¯", "å·²æ”¶é›†çš„æ•°æ®"]
        },
        {
            "step": 6,
            "state": {
                "protocol": {
                    "data": {
                        "step_1": {"summary": "æ­¥éª¤1å®Œæˆ"},
                        "step_2": {"summary": "æ­¥éª¤2å®Œæˆ"},
                        "step_3": {"summary": "æ­¥éª¤3å®Œæˆ"},
                        "step_4": {"summary": "æ­¥éª¤4å®Œæˆ"},
                        "step_5": {"summary": "æ­¥éª¤5å®Œæˆ"},
                    }
                }
            },
            "expected_in_prompt": ["æ­¥éª¤ 6/6", "æœ¬å‘¨è¡ŒåŠ¨", "Phase 3"]
        }
    ]

    for i, test_case in enumerate(test_cases, 1):
        step = test_case["step"]
        state = test_case["state"]
        expected = test_case["expected_in_prompt"]

        print(f"\n[Case {i}] ç”Ÿæˆæ­¥éª¤{step}çš„ prompt...")

        prompt = build_protocol_prompt(config, step, state)

        # éªŒè¯ prompt åŒ…å«é¢„æœŸå†…å®¹
        for expected_text in expected:
            if expected_text in prompt:
                print_result("success", f"åŒ…å«: '{expected_text}'")
            else:
                print_result("error", f"ç¼ºå¤±: '{expected_text}'")

        # éªŒè¯ prompt é•¿åº¦åˆç†
        if 100 < len(prompt) < 2000:
            print_result("success", f"Prompt é•¿åº¦åˆç†: {len(prompt)} å­—ç¬¦")
        else:
            print_result("warning", f"Prompt é•¿åº¦å¼‚å¸¸: {len(prompt)} å­—ç¬¦")

    print_result("success", "Prompt ç”Ÿæˆæµ‹è¯•é€šè¿‡")


def test_edge_cases(config):
    """æµ‹è¯•è¾¹ç•Œæƒ…å†µ"""
    print_section("Test 3: è¾¹ç•Œæƒ…å†µå¤„ç†")

    # æµ‹è¯•æ¡ˆä¾‹
    edge_cases = [
        {
            "name": "ç©ºçŠ¶æ€",
            "step": 1,
            "state": {},
            "should_work": True
        },
        {
            "name": "æ— æ•ˆæ­¥éª¤ (0)",
            "step": 0,
            "state": {},
            "should_work": False
        },
        {
            "name": "æ— æ•ˆæ­¥éª¤ (7)",
            "step": 7,
            "state": {},
            "should_work": False
        },
        {
            "name": "è´Ÿæ•°æ­¥éª¤",
            "step": -1,
            "state": {},
            "should_work": False
        },
        {
            "name": "åŒ…å«å¤§é‡å†å²æ•°æ®",
            "step": 3,
            "state": {
                "protocol": {
                    "data": {
                        f"step_{i}": {"summary": f"æ­¥éª¤{i}" * 50}
                        for i in range(1, 3)
                    }
                }
            },
            "should_work": True
        },
    ]

    for test_case in edge_cases:
        print(f"\n[{test_case['name']}]")

        try:
            prompt = build_protocol_prompt(
                config,
                test_case["step"],
                test_case["state"]
            )

            if test_case["should_work"]:
                if prompt:
                    print_result("success", "æ­£å¸¸å¤„ç†")
                else:
                    print_result("success", "è¿”å›ç©º promptï¼ˆç¬¦åˆé¢„æœŸï¼‰")
            else:
                if not prompt:
                    print_result("success", "æ­£ç¡®è¿”å›ç©º prompt")
                else:
                    print_result("warning", f"åº”è¯¥è¿”å›ç©ºä½†ç”Ÿæˆäº† prompt: {len(prompt)} å­—ç¬¦")

        except Exception as e:
            if test_case["should_work"]:
                print_result("error", f"ä¸åº”è¯¥æŠ›å‡ºå¼‚å¸¸: {str(e)}")
            else:
                print_result("success", f"æ­£ç¡®æŠ›å‡ºå¼‚å¸¸: {type(e).__name__}")

    print_result("success", "è¾¹ç•Œæƒ…å†µæµ‹è¯•å®Œæˆ")


def test_protocol_data_structure():
    """æµ‹è¯•åè®®æ•°æ®ç»“æ„çš„åˆç†æ€§"""
    print_section("Test 4: åè®®æ•°æ®ç»“æ„éªŒè¯")

    config = load_protocol_config("dankoe")

    # éªŒè¯æ­¥éª¤ç¼–å·è¿ç»­æ€§
    steps = config.get("steps", {})
    expected_steps = list(range(1, config["total_steps"] + 1))
    actual_steps = sorted(steps.keys())

    if actual_steps == expected_steps:
        print_result("success", "æ­¥éª¤ç¼–å·è¿ç»­ä¸”å®Œæ•´")
    else:
        print_result("error", f"æ­¥éª¤ç¼–å·ä¸è¿ç»­: {actual_steps}")

    # éªŒè¯æ•°æ®ä¿å­˜è·¯å¾„çš„ä¸€è‡´æ€§
    save_paths = []
    for step_num, step_config in steps.items():
        save_to = step_config.get("save_to", "")
        if save_to:
            save_paths.append(save_to)
            print_result("success", f"æ­¥éª¤{step_num} ä¿å­˜åˆ°: {save_to}")

    # æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„ä¿å­˜è·¯å¾„
    if len(save_paths) == len(set(save_paths)):
        print_result("success", "æ‰€æœ‰ä¿å­˜è·¯å¾„å”¯ä¸€")
    else:
        duplicates = [p for p in save_paths if save_paths.count(p) > 1]
        print_result("warning", f"å­˜åœ¨é‡å¤çš„ä¿å­˜è·¯å¾„: {set(duplicates)}")

    # éªŒè¯é˜¶æ®µåˆ’åˆ†çš„åˆç†æ€§
    phases = [step_config.get("phase", "") for step_config in steps.values()]
    unique_phases = list(dict.fromkeys(phases))  # ä¿æŒé¡ºåºå»é‡
    print_result("success", f"åè®®åˆ†ä¸º{len(unique_phases)}ä¸ªé˜¶æ®µ: {unique_phases}")


def test_prompt_quality():
    """æµ‹è¯• Prompt è´¨é‡"""
    print_section("Test 5: Prompt è´¨é‡è¯„ä¼°")

    config = load_protocol_config("dankoe")

    quality_checks = []

    for step_num in range(1, 7):
        step_config = config["steps"][step_num]

        # æ£€æŸ¥é—®é¢˜è´¨é‡
        question = step_config.get("question", "")
        if "ï¼Ÿ" in question or "?" in question:
            quality_checks.append(("success", f"æ­¥éª¤{step_num} é—®é¢˜åŒ…å«é—®å·"))
        else:
            quality_checks.append(("warning", f"æ­¥éª¤{step_num} é—®é¢˜å¯èƒ½ç¼ºå°‘é—®å·"))

        # æ£€æŸ¥å›åº”æç¤º
        response_prompt = step_config.get("response_prompt", "")
        if "ç”¨æˆ·" in response_prompt and "ä»»åŠ¡" in response_prompt:
            quality_checks.append(("success", f"æ­¥éª¤{step_num} response_prompt ç»“æ„å®Œæ•´"))
        else:
            quality_checks.append(("warning", f"æ­¥éª¤{step_num} response_prompt ç»“æ„ç®€å•"))

        # æ£€æŸ¥ç¤ºä¾‹
        if "ç¤ºä¾‹" in response_prompt or "example" in response_prompt.lower():
            quality_checks.append(("success", f"æ­¥éª¤{step_num} åŒ…å«ç¤ºä¾‹"))

    # æ‰“å°æ£€æŸ¥ç»“æœ
    for status, message in quality_checks:
        print_result(status, message)

    success_count = sum(1 for s, _ in quality_checks if s == "success")
    total = len(quality_checks)

    print(f"\nè´¨é‡åˆ†æ•°: {success_count}/{total} ({success_count/total*100:.0f}%)")


def test_protocol_flow_simulation():
    """æ¨¡æ‹Ÿå®Œæ•´çš„åè®®æµç¨‹"""
    print_section("Test 6: åè®®æµç¨‹æ¨¡æ‹Ÿ")

    config = load_protocol_config("dankoe")

    # æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
    simulated_state = {"protocol": {"data": {}}}

    print("\næ¨¡æ‹Ÿç”¨æˆ·å®Œæˆ6ä¸ªæ­¥éª¤...\n")

    for step in range(1, 7):
        print(f"--- æ­¥éª¤ {step}/6 ---")

        # ç”Ÿæˆ prompt
        prompt = build_protocol_prompt(config, step, simulated_state)

        # æå–å…³é”®ä¿¡æ¯
        step_config = config["steps"][step]
        print(f"é˜¶æ®µ: {step_config['phase']}")
        print(f"ä»»åŠ¡: {step_config['name']}")
        print(f"é—®é¢˜é•¿åº¦: {len(step_config['question'])} å­—ç¬¦")
        print(f"ç”Ÿæˆçš„ prompt é•¿åº¦: {len(prompt)} å­—ç¬¦")

        # æ¨¡æ‹Ÿä¿å­˜æ•°æ®
        simulated_state["protocol"]["data"][f"step_{step}"] = {
            "summary": f"æ­¥éª¤{step}å®Œæˆ",
            "completed": True
        }

        print_result("success", f"æ­¥éª¤{step}æ¨¡æ‹Ÿå®Œæˆ\n")

    print_result("success", "å®Œæ•´æµç¨‹æ¨¡æ‹ŸæˆåŠŸ")


def run_all_tests():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\n")
    print("â•”" + "=" * 78 + "â•—")
    print("â•‘" + " " * 25 + "åè®®æµå•å…ƒæµ‹è¯•" + " " * 39 + "â•‘")
    print("â•š" + "=" * 78 + "â•")

    tests = [
        ("é…ç½®åŠ è½½", test_config_loading),
        ("Prompt ç”Ÿæˆ", lambda: test_prompt_generation(config)),
        ("è¾¹ç•Œæƒ…å†µ", lambda: test_edge_cases(config)),
        ("æ•°æ®ç»“æ„", test_protocol_data_structure),
        ("Prompt è´¨é‡", test_prompt_quality),
        ("æµç¨‹æ¨¡æ‹Ÿ", test_protocol_flow_simulation),
    ]

    # å…ˆåŠ è½½é…ç½®
    config = None

    results = {}

    for name, test_func in tests:
        try:
            if name == "é…ç½®åŠ è½½":
                config = test_func()
            else:
                test_func()
            results[name] = "âœ… é€šè¿‡"
        except Exception as e:
            print_result("error", f"æµ‹è¯•å¤±è´¥: {str(e)}")
            import traceback
            traceback.print_exc()
            results[name] = f"âŒ å¤±è´¥"

    # æ‰“å°æ€»ç»“
    print_section("æµ‹è¯•æ€»ç»“")
    print("\næµ‹è¯•ç»“æœï¼š")
    for name, result in results.items():
        print(f"  {result:10} - {name}")

    passed = sum(1 for r in results.values() if r.startswith("âœ…"))
    total = len(results)

    print(f"\né€šè¿‡ç‡: {passed}/{total} ({passed/total*100:.0f}%)")

    if passed == total:
        print("\nğŸ‰ æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡ï¼")
    else:
        print(f"\nâš ï¸ {total - passed} ä¸ªæµ‹è¯•å¤±è´¥")


if __name__ == "__main__":
    try:
        run_all_tests()
    except Exception as e:
        print(f"\n\nâŒ æµ‹è¯•è¿è¡Œå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
