#!/usr/bin/env python3
"""
自动修复 datetime 导入，添加 timezone
"""

import re
from pathlib import Path

def fix_file(file_path):
    """修复单个文件的导入"""
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()

    # 检查是否使用了 timezone.utc
    if 'timezone.utc' not in content:
        return False

    # 检查是否已经导入了 timezone
    if 'from datetime import' in content and 'timezone' in content:
        return False

    # 查找 from datetime import 语句
    pattern = r'^from datetime import (.+)$'

    modified = False
    lines = content.split('\n')
    new_lines = []

    for line in lines:
        match = re.match(pattern, line)
        if match:
            imports = match.group(1)
            # 检查是否已经有 timezone
            if 'timezone' not in imports:
                # 添加 timezone 到导入列表
                if '(' in imports:
                    # 多行导入格式
                    new_line = line.replace(')', ', timezone)')
                else:
                    # 单行导入格式
                    new_line = line.rstrip() + ', timezone'
                new_lines.append(new_line)
                modified = True
            else:
                new_lines.append(line)
        else:
            new_lines.append(line)

    if modified:
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write('\n'.join(new_lines))
        return True

    return False

def main():
    """修复所有 Python 文件"""
    api_dir = Path(__file__).parent.parent

    files_to_check = list(api_dir.rglob('*.py'))

    fixed_count = 0

    for file_path in files_to_check:
        try:
            if fix_file(file_path):
                print(f"✅ Fixed: {file_path.relative_to(api_dir)}")
                fixed_count += 1
        except Exception as e:
            print(f"❌ Error in {file_path}: {e}")

    print(f"\n修复了 {fixed_count} 个文件")

if __name__ == '__main__':
    main()
