#!/bin/bash
# ═══════════════════════════════════════════════════════════════
# VibeLife 测试环境启动脚本
# ═══════════════════════════════════════════════════════════════

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
ENV_FILE="$PROJECT_DIR/.env"
LOG_DIR="/data/vibelife/logs/test"
PID_DIR="$PROJECT_DIR/.pids"

# 颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}══════════════════════════════��════════════════════════════════${NC}"
echo -e "${GREEN}  VibeLife 测试环境启动${NC}"
echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"

# 检查环境配置文件
if [ ! -f "$ENV_FILE" ]; then
    echo -e "${RED}错误: 找不到测试环境配置文件 $ENV_FILE${NC}"
    exit 1
fi

# 创建必要目录
mkdir -p "$LOG_DIR" "$PID_DIR"

# 加载环境变量
set -a
source "$ENV_FILE"
set +a

# 测试环境端口覆盖
export VIBELIFE_API_PORT=8100
export VIBELIFE_ENV=development

# 检查端口是否被占用
check_port() {
    local port=$1
    if lsof -i :$port > /dev/null 2>&1; then
        echo -e "${YELLOW}警告: 端口 $port 已被占用${NC}"
        return 1
    fi
    return 0
}

# 启动 API 服务
start_api() {
    echo -e "${YELLOW}启动 API 服务 (端口 $VIBELIFE_API_PORT)...${NC}"

    if ! check_port $VIBELIFE_API_PORT; then
        echo -e "${RED}API 端口已被占用，跳过启动${NC}"
        return 1
    fi

    cd "$PROJECT_DIR/apps/api"

    # 使用 Python -m uvicorn 方式启动（避免 shebang 路径问题）
    local PYTHON="/data/anaconda3/envs/ai/bin/python"
    if [ ! -f "$PYTHON" ]; then
        PYTHON="python3"
    fi

    nohup "$PYTHON" -m uvicorn main:app \
        --host 0.0.0.0 \
        --port $VIBELIFE_API_PORT \
        --reload \
        > "$LOG_DIR/api.log" 2>&1 &

    echo $! > "$PID_DIR/api.pid"
    echo -e "${GREEN}API 服务已启动 (PID: $!)${NC}"
}

# 启动 Web 服务
start_web() {
    local WEB_PORT=8232
    echo -e "${YELLOW}启动 Web 服务 (端口 $WEB_PORT)...${NC}"

    if ! check_port $WEB_PORT; then
        echo -e "${RED}Web 端口已被占用，跳过启动${NC}"
        return 1
    fi

    cd "$PROJECT_DIR/apps/web"

    # 创建 .env.local 用于测试环境
    cat > .env.local << EOF
NEXT_PUBLIC_API_URL=http://106.37.170.238:$VIBELIFE_API_PORT
NEXT_PUBLIC_API_BASE=http://106.37.170.238:$VIBELIFE_API_PORT/api/v1
NEXT_PUBLIC_WS_URL=ws://106.37.170.238:$VIBELIFE_API_PORT/ws
VIBELIFE_API_INTERNAL=http://127.0.0.1:$VIBELIFE_API_PORT
EOF

    nohup pnpm dev --port $WEB_PORT --hostname 0.0.0.0 \
        > "$LOG_DIR/web.log" 2>&1 &

    echo $! > "$PID_DIR/web.pid"
    echo -e "${GREEN}Web 服务已启动 (PID: $!)${NC}"
}

# 主流程
main() {
    start_api
    sleep 2
    start_web

    echo ""
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${GREEN}  测试环境启动完成${NC}"
    echo -e "${GREEN}═══════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo -e "  API:  http://106.37.170.238:$VIBELIFE_API_PORT"
    echo -e "  Web:  http://106.37.170.238:8232"
    echo ""
    echo -e "  日志目录: $LOG_DIR"
    echo -e "  停止命令: $SCRIPT_DIR/stop-test.sh"
    echo ""
}

main "$@"
