# VibeLife Chat 功能优化 - Top 3 优先改进

> 基于文档深度阅读 + 8232 实际测试的 Ultra Analysis

---

## 一、发现的关键问题

### 实测发现

1. **Skill 路由失控**
   - 测试：在 bazi skill 页面 (`/chat?skill=bazi`) 输入"帮我看看今天运势"
   - 预期：使用 bazi skill 计算今日运势
   - 实际：LLM 调用 `activate_skill(skill=tarot)` 切换到塔罗
   - 控制台大量警告：`[ToolCardRenderer] Unknown tool: activate_skill` 重复数百次

2. **工具卡片渲染缺失**
   - `activate_skill` 工具调用没有被前端 ToolCardRenderer 处理
   - 导致控制台警告刷屏，影响性能和用户体验

3. **Phase 2 边界意识不足**
   - 文档 `LLM_DRIVEN_ARCHITECTURE.md` 已识别此问题
   - LLM 在 Phase 2 时不应调用 `recommend_skills` 或 `activate_skill` 切换离开当前 skill

---

## 二、Top 3 优先改进

### 优先级 1：修复 Phase 2 边界意识（Skill 路由失控）

**问题**：用户已在 bazi skill 内，但 LLM 却切换到 tarot

**根本原因**：
- Phase 2 System Prompt 没有强调"你现在在 {skill_id} skill 内，应使用当前 skill 的工具"
- 缺少 `when_not_to_call` 指导

**解决方案**：
1. 修改 `apps/api/services/agent/prompt_builder.py`：在 Phase 2 System Prompt 注入边界意识
2. 修改 `apps/api/config/routing.yaml`：SOP 模板增加 "不推荐调用 activate_skill（除非用户明确要求换服务）"
3. 修改 bazi skill 的 SKILL.md：增加"今日运势"意图映射到 daily_fortune 工具

**关键文件**：
- `apps/api/services/agent/prompt_builder.py`
- `apps/api/services/agent/routing_config.py`
- `apps/api/skills/bazi/SKILL.md`
- `apps/api/skills/bazi/tools/tools.yaml`

---

### 优先级 2：修复 activate_skill 工具卡片渲染

**问题**：控制台大量 `Unknown tool: activate_skill` 警告

**根本原因**：前端 ToolCardRenderer 没有处理 `activate_skill` 工具类型

**解决方案**：
1. 在 `apps/web/src/skills/CardRegistry.ts` 注册 activate_skill 卡片
2. 创建 `SkillActivationCard.tsx`：优雅显示 skill 切换过渡状态
3. 或者：如果 activate_skill 不需要卡片展示，应在 ChatMessage 中过滤掉

**关键文件**：
- `apps/web/src/skills/CardRegistry.ts`
- `apps/web/src/components/chat/ChatMessage.tsx`
- `apps/web/src/skills/shared/SkillActivationCard.tsx` (新建)

---

### 优先级 3：增强 Dashboard 数据与对话的连接

**问题**：Dashboard 显示了用户的目标和习惯，但对话中没有利用这些数据

**当前状态**：
- Dashboard 显示："你想成为一个有影响力的创作者"
- Dashboard 显示："本周：发布新版本 (创作者)"
- 但对话中 LLM 完全没有利用这些上下文

**解决方案**：
1. 在 chat 请求中将 Dashboard 关键数据注入到对话上下文
2. 修改 `apps/api/routes/chat_v5.py`：读取用户的 lifecoach 目标数据
3. 修改 `apps/api/services/agent/context_manager.py`：将目标/习惯作为 hidden context 注入

**关键文件**：
- `apps/api/routes/chat_v5.py`
- `apps/api/services/agent/context_manager.py`
- `apps/api/services/agent/prompt_builder.py`

---

## 三、实施计划

### Phase 1: 修复 Skill 路由失控 (P0)

```
Day 1:
1. 阅读 prompt_builder.py 和 routing_config.py
2. 在 Phase 2 System Prompt 添加：
   - "你现在是 {skill_id} 专家"
   - "用户请求应使用当前 skill 工具处理"
   - "不推荐调用 activate_skill（除非用户明确要求换服务）"
3. 在 bazi/SKILL.md 添加"今日运势"意图映射
4. 测试验证
```

### Phase 2: 修复工具卡片渲染 (P0)

```
Day 1-2:
1. 在 CardRegistry.ts 添加 activate_skill 处理
2. 创建 SkillActivationCard 或过滤逻辑
3. 清除控制台警告
```

### Phase 3: Dashboard 数据连接 (P1)

```
Day 2-3:
1. 修改 chat_v5.py 读取 lifecoach 目标
2. 在 context_manager.py 注入 hidden context
3. 测试对话是否能感知用户目标
```

---

## 四、验证方法

1. **路由修复验证**：
   - 在 `/chat?skill=bazi` 输入"帮我看看今天运势"
   - 预期：使用 bazi 的 daily_fortune 工具，不切换 skill

2. **卡片渲染验证**：
   - 打开浏览器控制台
   - 发送任意消息
   - 预期：无 `Unknown tool` 警告

3. **Dashboard 连接验证**：
   - 用户有 lifecoach 目标
   - 在对话中问"我最近该关注什么"
   - 预期：AI 引用用户的目标数据

---

## 五、未解决的问题

1. **Skill 切换的正确姿势**：
   - 用户明确说"我想看星座"时，是否应该切换？
   - 切换后 URL 要不要变化？

2. **activate_skill 工具的 UX**：
   - 是否需要显示"正在切换到塔罗..."过渡动画？
   - 还是应该静默切换？
