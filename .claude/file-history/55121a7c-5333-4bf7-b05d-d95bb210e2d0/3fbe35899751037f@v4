# Fortune AI åç«¯é‡æ„è®¡åˆ’ (v4.2 Vercel AI SDK Edition)

**æ–‡æ¡£ç±»å‹**: Backend Refactoring Plan
**ç‰ˆæœ¬**: v4.2
**æ—¥æœŸ**: 2026-01-01
**ç›®æ ‡**: å°†åç«¯æ¶æ„ä» Python-centric è¿ç§»åˆ° Vercel AI SDK Driven æ¶æ„

---

## 0. æ‰§è¡Œæ‘˜è¦

### 0.1 é‡æ„ç›®æ ‡

å°† Fortune AI åç«¯ä»å½“å‰çš„ **Python FastAPI å…¨æ ˆæ¶æ„** é‡æ„ä¸º **Vercel AI SDK Driven åˆ†å±‚æ¶æ„**ï¼š

| å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ |
|----------|----------|
| FastAPI æ‰¿è½½ AI æ¨ç† + æ•°æ®æœåŠ¡ | Next.js API Route æ‰¿è½½ AI æ¨ç† |
| `glm_client.py` ç›´æ¥è°ƒç”¨ LLM | `streamText()` + Multi-Model Provider |
| è‡ªå®šä¹‰ SSE æ ¼å¼ | `toDataStreamResponse()` æ ‡å‡†æµ |
| Python L2 Agents | TypeScript `tool()` Skills |
| agent_service è¾…åŠ©è§’è‰² | Agent Runtime æ ¸å¿ƒè§’è‰² |

### 0.2 æ ¸å¿ƒæ”¶ç›Š

1. **ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“**: `useChat()` â†’ `streamText()` â†’ `toDataStreamResponse()`
2. **å¤šæ¨¡å‹çƒ­åˆ‡æ¢**: GLM-4.5 / Gemini / Claude é€šè¿‡ Vercel AI Gateway åŠ¨æ€åˆ‡æ¢
3. **Skills å¯æ’æ‹”**: Tool Calling æ ‡å‡†åŒ–ï¼Œæ–°å¢ Expert Agent åªéœ€æ·»åŠ  `tool()` å®šä¹‰
4. **maxSteps å¤šæ­¥æ¨ç†**: å•æ¬¡è¯·æ±‚å¯å¤šæ¬¡ Tool è°ƒç”¨åç»¼åˆè¾“å‡º
5. **ç±»å‹å®‰å…¨**: Zod Schema å‚æ•°éªŒè¯

### 0.3 é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|:----:|----------|
| API å…¼å®¹æ€§ç ´å | ğŸ”´ é«˜ | åŒè·¯ç”±å¹¶è¡ŒæœŸï¼Œé€æ­¥è¿ç§» |
| å‰ç«¯ CSRF é—®é¢˜ | ğŸŸ¡ ä¸­ | Next.js API Route åŒæºï¼Œæ— è·¨åŸŸ |
| æ•°æ®æœåŠ¡è°ƒç”¨å»¶è¿Ÿ | ğŸŸ¡ ä¸­ | Tool execute æ‰¹é‡èšåˆï¼Œç¼“å­˜çƒ­ç‚¹æ•°æ® |
| å›¢é˜Ÿ TypeScript ç†Ÿç»ƒåº¦ | ğŸŸ¢ ä½ | ç°æœ‰ agent_service å·²æœ‰ TS åŸºç¡€ |
| maxSteps é‡å¤å†™å…¥ | ğŸ”´ é«˜ | å¹‚ç­‰æ€§è®¾è®¡ + finalize æœºåˆ¶ |
| æµå¼ä¸­æ–­æ•°æ®ä¸ä¸€è‡´ | ğŸ”´ é«˜ | æµå¼ä¸äº‹åŠ¡è§£è€¦ï¼Œfinalize ç»Ÿä¸€æäº¤ |

### 0.4 ç›®æ ‡åç«¯å½¢æ€ï¼ˆä¸‰è¿è¡Œå•å…ƒï¼‰

é‡æ„åçš„åç«¯æ‹†åˆ†ä¸º **3 ä¸ªå¯ç‹¬ç«‹æ¼”è¿›çš„è¿è¡Œå•å…ƒ**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç›®æ ‡æ¶æ„ (v4.2)                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Browser
    â”‚
    â”‚ HTTP
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Reverse Proxy (Nginx/Caddy :80/:443)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  è·¯ç”±è§„åˆ™:                                                               â”‚â”‚
â”‚  â”‚  /api/chat          â†’ Next.js (:8231)  # Agent Runtime                  â”‚â”‚
â”‚  â”‚  /api/landing/*     â†’ Next.js (:8231)  # Landing Page API               â”‚â”‚
â”‚  â”‚  /api/*             â†’ FastAPI (:8230)  # Data Service                   â”‚â”‚
â”‚  â”‚  /new/*             â†’ Next.js (:8231)  # Frontend                       â”‚â”‚
â”‚  â”‚  /admin/*           â†’ Next.js (:8231)  # Admin System                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â–¼                           â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.js Agent     â”‚  â”‚ FastAPI Data Service    â”‚  â”‚ Python Cold Path Worker â”‚
â”‚ Runtime (:8231)   â”‚  â”‚ (:8230)                 â”‚  â”‚ (Cron/Queue)            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€¢ streamText()    â”‚  â”‚ â€¢ Auth/Session          â”‚  â”‚ â€¢ Insight Agent         â”‚
â”‚ â€¢ tool() Skills   â”‚  â”‚ â€¢ é¢†åŸŸå†™å…¥ (SSOT)       â”‚  â”‚ â€¢ Memory æ²‰æ·€           â”‚
â”‚ â€¢ useChat() æµå¼  â”‚  â”‚ â€¢ ç¡®å®šæ€§è®¡ç®—            â”‚  â”‚ â€¢ å¼‚æ­¥æŠ¥å‘Šç”Ÿæˆ          â”‚
â”‚ â€¢ Multi-Model Hub â”‚  â”‚ â€¢ Internal APIs         â”‚  â”‚ â€¢ æ•°æ®æ¸…æ´—              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                           â”‚                           â”‚
        â”‚     fetch() / gRPC        â”‚                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                          PostgreSQL (fortune_ai)
```

| è¿è¡Œå•å…ƒ | èŒè´£ | æŠ€æœ¯æ ˆ | éƒ¨ç½² |
|----------|------|--------|------|
| **Agent Runtime** | AI æ¨ç†ã€æµå¼å“åº”ã€Tool Calling | Next.js + Vercel AI SDK | å¯ç‹¬ç«‹æ‰©ç¼© |
| **Data Service** | Authã€SSOT å†™å…¥ã€ç¡®å®šæ€§è®¡ç®— | FastAPI + PostgreSQL | æœ‰çŠ¶æ€ï¼Œå•å®ä¾‹ä¼˜å…ˆ |
| **Cold Path Worker** | åå°åˆ†æã€Memory æ²‰æ·€ | Python + Celery/Cron | å¼‚æ­¥ï¼Œå¤±è´¥ä¸é˜»å¡ |

### 0.5 ä¿¡ä»»è¾¹ç•Œä¸å®‰å…¨åŸåˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¿¡ä»»è¾¹ç•Œ (Trust Boundary)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚            Untrusted Zone               â”‚
                  â”‚                                         â”‚
                  â”‚   Browser / Mobile App / Third Party    â”‚
                  â”‚                                         â”‚
                  â”‚   âš ï¸ æ°¸è¿œä¸èƒ½ä¿¡ä»»æ¥è‡ªè¿™é‡Œçš„:             â”‚
                  â”‚      â€¢ userId                           â”‚
                  â”‚      â€¢ role / permissions               â”‚
                  â”‚      â€¢ ä»»ä½•æ•æ„Ÿæ ‡è¯†                      â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                    Cookie (fortune_session) + HTTPS Only
                                      â”‚
                                      â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚            Trusted Zone                 â”‚
                  â”‚                                         â”‚
                  â”‚   Next.js API Route / FastAPI           â”‚
                  â”‚                                         â”‚
                  â”‚   âœ… userId åªèƒ½ä» Session è§£å‡º          â”‚
                  â”‚   âœ… session_id å¯ç”±å‰ç«¯ä¼ ä½†å¿…é¡»æ ¡éªŒå½’å± â”‚
                  â”‚   âœ… Internal API éœ€ service token       â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®è§„åˆ™**ï¼š

1. **userId ä¸ä¼ **: å‰ç«¯è¯·æ±‚ä½“æ°¸è¿œä¸åŒ…å« `userId`ï¼Œç”±æœåŠ¡ç«¯ä» Cookie Session è§£å‡º
2. **session_id æ ¡éªŒ**: å¦‚å‰ç«¯ä¼  `session_id`ï¼Œåç«¯å¿…é¡»æ ¡éªŒè¯¥ session å½’å±å½“å‰ç”¨æˆ·
3. **Internal API éš”ç¦»**: `/internal/*` ç«¯ç‚¹ä¸æš´éœ²ç»™æµè§ˆå™¨ï¼Œéœ€ service token æˆ– IP ç™½åå•

### 0.6 å·¥ç¨‹åŒ–åŸåˆ™ï¼ˆå†³å®šé‡æ„æˆè´¥ï¼‰

#### 0.6.1 æµå¼ä¸äº‹åŠ¡è§£è€¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Chat Run Lifecycle (æµå¼ç”Ÿå‘½å‘¨æœŸ)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ¶ˆæ¯ â”€â”€â–¶ run/start â”€â”€â–¶ streamText() â”€â”€â–¶ Toolè°ƒç”¨(Næ¬¡) â”€â”€â–¶ run/finalize
   â”‚            â”‚              â”‚                â”‚                  â”‚
   â”‚            â”‚              â”‚                â”‚                  â”‚
   â–¼            â–¼              â–¼                â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ç”¨æˆ·æ¶ˆæ¯â”‚ â”‚ run_id  â”‚   â”‚ æµå¼è¾“å‡º â”‚    â”‚ å·¥å…·ç»“æœ  â”‚      â”‚ ç»Ÿä¸€æäº¤    â”‚
â”‚ å…¥åº“  â”‚ â”‚ è®°å½•    â”‚   â”‚ (ä¸è½åº“) â”‚    â”‚ (å†…å­˜æš‚å­˜)â”‚      â”‚ äº‹åŠ¡å†™å…¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                                                   â”‚
                                                                   â–¼
                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                          â”‚ ä¸€æ¬¡äº‹åŠ¡åŒ…å«:   â”‚
                                                          â”‚ â€¢ assistant msg â”‚
                                                          â”‚ â€¢ commitments   â”‚
                                                          â”‚ â€¢ tool_log      â”‚
                                                          â”‚ â€¢ twin updates  â”‚
                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è§„åˆ™**ï¼š
- æµå¼è¿‡ç¨‹ä¸­åªåš"å¯é‡æ”¾"è®°å½•ï¼ˆrun_idã€ç”¨æˆ·æ¶ˆæ¯ï¼‰
- Tool æ‰§è¡Œç»“æœæš‚å­˜å†…å­˜ï¼Œä¸ç›´æ¥å†™ DB
- `finalize` æ—¶ç»Ÿä¸€äº‹åŠ¡æäº¤
- ä¸­æ–­åˆ™æ ‡è®° `aborted`ï¼Œé¿å…åŠæ¡æ¶ˆæ¯è¿› SSOT

#### 0.6.2 å…¨é“¾è·¯ correlation_id

```typescript
// Next.js API Route å…¥å£ç”Ÿæˆ
export async function POST(req: Request) {
  const correlationId = req.headers.get('x-correlation-id')
    || `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;

  // é€ä¼ åˆ° FastAPI
  const context = await fetch(`${FASTAPI_URL}/internal/context`, {
    headers: { 'X-Correlation-ID': correlationId },
  });

  // é€ä¼ åˆ° Tool æ‰§è¡Œ
  const result = streamText({
    // ...
    onStepFinish({ toolCalls }) {
      logger.info({ correlationId, toolCalls }, 'Step finished');
    },
  });
}
```

**ç”¨é€”**ï¼šä¸²è”"å¯¹è¯ â†’ Tool è°ƒç”¨ â†’ å†™å…¥ â†’ å¤±è´¥åŸå› "ï¼Œä¾¿äº debug å’Œå®¡è®¡ã€‚

#### 0.6.3 ç»Ÿä¸€é”™è¯¯è¯­ä¹‰

```typescript
// Public API å“åº”æ ¼å¼
interface ApiResponse<T> {
  ok: boolean;
  data?: T;
  error?: {
    code: string;        // 'AUTH_REQUIRED' | 'RATE_LIMITED' | 'TOOL_FAILED' | ...
    message: string;     // ç”¨æˆ·å¯è¯»æ¶ˆæ¯
    detail?: unknown;    // è°ƒè¯•ä¿¡æ¯ï¼ˆä»… dev ç¯å¢ƒï¼‰
    correlation_id?: string;
  };
}

// Tool æ‰§è¡Œå¤±è´¥è¿”å›ï¼ˆå¯æ¸²æŸ“ä¸º Toast æˆ– ErrorCardï¼‰
interface ToolError {
  type: 'tool_error';
  tool_name: string;
  error_code: string;
  user_message: string;  // "å…«å­—è®¡ç®—æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
}
```

---

## 1. ç°çŠ¶åˆ†æ

### 1.1 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å½“å‰æ¶æ„ (v4.0/v4.1)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Browser (:8231/new)
    â”‚
    â”‚ HTTP (fetch + SSE)
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI (:8230)                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  19 Route Files                                                     â”‚  â”‚
â”‚  â”‚  auth_routes / chat_routes / dashboard_routes / bazi_routes ...    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services Layer           â–¼                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚glm_client.pyâ”‚ â”‚bazi_engine  â”‚ â”‚twin_service â”‚ â”‚goal_service â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ (LLM è°ƒç”¨)  â”‚ â”‚  (L0 è®¡ç®—) â”‚ â”‚ (çŠ¶æ€ç®¡ç†) â”‚ â”‚ (ç›®æ ‡ç®¡ç†) â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Agent Service Client     â”‚ (HTTP è°ƒç”¨ TypeScript Agent)          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent Service (:3000) - Express + Vercel AI SDK                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  coach.ts: runCoachAgent() - ä½†ä»…ä½œä¸ºè¾…åŠ©ï¼Œä¸»æµé‡ä»èµ° Python         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                        PostgreSQL (fortune_ai)
```

### 1.2 ç°æœ‰æ–‡ä»¶æ¸…å•

**API Routes (19 ä¸ª)**:
```
api/
â”œâ”€â”€ auth_routes.py        # è®¤è¯ (register/login/logout)
â”œâ”€â”€ chat_routes.py        # å¯¹è¯ (send/stream) âš ï¸ æ ¸å¿ƒé‡æ„å¯¹è±¡
â”œâ”€â”€ dashboard_routes.py   # Dashboard Zone B
â”œâ”€â”€ bazi_routes.py        # å…«å­—è®¡ç®—
â”œâ”€â”€ bento_routes.py       # Bento 6 å¡ç‰‡ (legacy)
â”œâ”€â”€ twin_routes.py        # æ•°å­—å­ªç”Ÿ
â”œâ”€â”€ goal_routes.py        # ç›®æ ‡ç®¡ç†
â”œâ”€â”€ reflection_routes.py  # å¤ç›˜
â”œâ”€â”€ report_routes.py      # æ·±åº¦æŠ¥å‘Š
â”œâ”€â”€ poster_routes.py      # æµ·æŠ¥ç”Ÿæˆ
â”œâ”€â”€ yunshi_routes.py      # è¿åŠ¿
â”œâ”€â”€ plan_routes.py        # è®¡åˆ’
â”œâ”€â”€ kb_routes.py          # çŸ¥è¯†åº“
â”œâ”€â”€ session_routes.py     # ä¼šè¯ç®¡ç†
â”œâ”€â”€ user_routes.py        # ç”¨æˆ·èµ„æ–™
â”œâ”€â”€ social_routes.py      # ç¤¾äº¤
â”œâ”€â”€ push_routes.py        # æ¨é€
â”œâ”€â”€ currency_routes.py    # è´§å¸
â”œâ”€â”€ jitai_routes.py       # å‰å°
â”œâ”€â”€ agent_tool.py         # Agent å·¥å…· API
â”œâ”€â”€ deps.py               # ä¾èµ–æ³¨å…¥
â””â”€â”€ main.py               # å…¥å£
```

**Services (æ ¸å¿ƒ)**:
```
services/
â”œâ”€â”€ glm_client.py          # âš ï¸ å¾…åˆ é™¤ï¼šç›´æ¥ LLM è°ƒç”¨
â”œâ”€â”€ chat_service.py        # ä¼šè¯æ¶ˆæ¯ç®¡ç†
â”œâ”€â”€ bazi_engine.py         # L0 å…«å­—è®¡ç®— âœ… ä¿ç•™
â”œâ”€â”€ bazi_facts.py          # äº‹å®æå– âœ… ä¿ç•™
â”œâ”€â”€ twin_service.py        # æ•°å­—å­ªç”Ÿ âœ… ä¿ç•™
â”œâ”€â”€ goal_service.py        # ç›®æ ‡ç®¡ç† âœ… ä¿ç•™
â”œâ”€â”€ reflection_service.py  # å¤ç›˜ âœ… ä¿ç•™
â”œâ”€â”€ soul_os.py             # ä¸Šä¸‹æ–‡ç»„è£… âš ï¸ é‡æ„
â”œâ”€â”€ agent_service_client.py # âš ï¸ å¾…åˆ é™¤ï¼šæ”¹ä¸º Next.js å†…éƒ¨è°ƒç”¨
â””â”€â”€ ...
```

### 1.3 å…³é”®ç—›ç‚¹

| ç—›ç‚¹ | å½±å“ | æ ¹å›  |
|------|------|------|
| åŒè¯­è¨€äº¤äº’å¤æ‚ | ç»´æŠ¤æˆæœ¬é«˜ | Python/TS è¾¹ç•Œä¸æ¸…æ™° |
| æµå¼æ¸²æŸ“éæ ‡å‡† | å‰ç«¯é€‚é…å›°éš¾ | è‡ªå®šä¹‰ SSE æ ¼å¼ |
| LLM è°ƒç”¨åˆ†æ•£ | éš¾ä»¥ç»Ÿä¸€ç®¡ç† | glm_client + agent_service å¹¶å­˜ |
| Tool Calling æ‰‹åŠ¨ | æ‰©å±•å›°éš¾ | æ— æ ‡å‡†åŒ– Skills æ¡†æ¶ |
| A2UI éæµå¼ | é¦–å­—å»¶è¿Ÿé«˜ | JSON æ•´ä½“è¿”å› |

---

## 2. ç›®æ ‡æ¶æ„

### 2.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç›®æ ‡æ¶æ„ (v4.2 Vercel AI SDK)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Browser
    â”‚
    â”‚ useChat() Hook
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Next.js (:8231)                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  app/api/chat/route.ts   â† Agent Runtime (æ ¸å¿ƒ)                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  streamText({                                                 â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    model: selectModel(),     // GLM / Gemini / Claude         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    system: buildSystemPrompt(context),                        â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    tools: getToolsForMode(mode),                              â”‚ â”‚  â”‚
â”‚  â”‚  â”‚    maxSteps: 5,                                               â”‚ â”‚  â”‚
â”‚  â”‚  â”‚  }) â†’ toDataStreamResponse()                                  â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Skills Registry          â–¼                                        â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
â”‚  â”‚  â”‚Divine Skillsâ”‚ â”‚ Heal Skills â”‚ â”‚ Grow Skills â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚calculate_   â”‚ â”‚log_perma    â”‚ â”‚covey_matrix â”‚                  â”‚  â”‚
â”‚  â”‚  â”‚  bazi/ziwei â”‚ â”‚cbt_reframe  â”‚ â”‚goal_setting â”‚                  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚               â”‚               â”‚
             â”‚ fetch()       â”‚ fetch()       â”‚ fetch()
             â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI (:8230) - çº¯æ•°æ®æœåŠ¡å±‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Data Service APIs (æ—  LLM è°ƒç”¨)                                    â”‚  â”‚
â”‚  â”‚  /api/bazi/calculate     /api/perma/log      /api/goals/create     â”‚  â”‚
â”‚  â”‚  /api/user/context       /api/twin/update    /api/tasks/create     â”‚  â”‚
â”‚  â”‚  /api/landing/insight    /api/kb/search      /api/checkin/mood     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Services Layer (ä¿ç•™)    â”‚                                        â”‚  â”‚
â”‚  â”‚  bazi_engine / twin_service / goal_service / reflection_service   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                        PostgreSQL (fortune_ai)
```

### 2.2 èŒè´£è¾¹ç•Œ

| å±‚çº§ | è¿è¡Œç¯å¢ƒ | èŒè´£ | æŠ€æœ¯æ ˆ |
|------|----------|------|--------|
| **Frontend** | Browser | UI æ¸²æŸ“ã€æµå¼å±•ç¤ºã€Command è¾“å…¥ | React + `useChat()` |
| **Agent Runtime** | Next.js API Route | AI æ¨ç†ã€Tool Callingã€æµå¼è¾“å‡º | `streamText()` + `tool()` |
| **Skills Registry** | Next.js | å¯æ’æ‹”æŠ€èƒ½å®šä¹‰ | Zod Schema + execute |
| **Data Service** | FastAPI | L0/L1 æ•°æ® CRUDã€è®¡ç®—é€»è¾‘ | Python + PostgreSQL |
| **Insight Agent** | Cron Worker | Cold Path æ•°æ®æ²‰æ·€ | Python |

### 2.3 API ç«¯ç‚¹è§„åˆ’

**Next.js API Routes (æ–°å¢)**:
```typescript
// Agent Runtime
POST /api/chat           // streamText() ä¸»å…¥å£
POST /api/command        // /divine /heal /grow æŒ‡ä»¤è·¯ç”±

// Landing Page (å¯é€‰è¿ç§»)
POST /api/landing/insight  // å³æ—¶æ´å¯Ÿ (æ— éœ€ç™»å½•)
```

**FastAPI Data Service (é‡æ„)**:
```python
# L0 Base Data
GET  /api/user/context        # èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡
GET  /api/user/profile        # ç”¨æˆ·èµ„æ–™
PUT  /api/user/profile        # æ›´æ–°èµ„æ–™

# L1 Module Data - Divine
POST /api/bazi/calculate      # å…«å­—è®¡ç®—
POST /api/ziwei/calculate     # ç´«å¾®è®¡ç®—
GET  /api/bazi/facts/{user_id}  # è·å–äº‹å®

# L1 Module Data - Heal
POST /api/perma/log           # PERMA è®°å½•
GET  /api/perma/query         # PERMA æŸ¥è¯¢
POST /api/checkin/mood        # æƒ…ç»ªæ‰“å¡

# L1 Module Data - Grow
POST /api/goals/create        # åˆ›å»ºç›®æ ‡
GET  /api/goals/active        # æ´»è·ƒç›®æ ‡
POST /api/tasks/create        # åˆ›å»ºä»»åŠ¡
PUT  /api/tasks/{id}/complete # å®Œæˆä»»åŠ¡

# Twin
GET  /api/twin/{user_id}      # è·å–å­ªç”Ÿæ•°æ®
PUT  /api/twin/update         # æ›´æ–°å­ªç”Ÿ

# KB
POST /api/kb/search           # çŸ¥è¯†åº“æ£€ç´¢

# ä¿ç•™ (æš‚ä¸è¿ç§»)
/api/auth/*                   # è®¤è¯
/api/report/*                 # æ·±åº¦æŠ¥å‘Š
/api/poster/*                 # æµ·æŠ¥
/api/dashboard/*              # Dashboard
```

### 2.4 Internal Contract APIsï¼ˆå†…éƒ¨å¥‘çº¦ï¼‰

ä¸º Agent Runtime ä¸ FastAPI ä¹‹é—´çš„é€šä¿¡å®šä¹‰ä¸¤ä¸ªæ ¸å¿ƒå¥‘çº¦ï¼Œæ¯”ç»§ç»­å¤ç”¨ `chat_routes.py` æ›´å¹²å‡€ï¼š

#### 2.4.1 Context APIï¼ˆä¸Šä¸‹æ–‡èšåˆï¼‰

```python
# FastAPI: api/internal_routes.py
# åªå¯¹å†…éƒ¨è°ƒç”¨å¼€æ”¾ï¼Œéœ€ X-Service-Token æˆ– IP ç™½åå•

@router.get("/internal/context")
async def get_context(
    session_id: str = Query(None),
    user: AuthUser = Depends(get_current_user_from_cookie),
    x_correlation_id: str = Header(None),
) -> ContextResponse:
    """
    ä¸€æ¬¡æ€§èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œå‡å°‘ Agent Runtime çš„ fetch æ¬¡æ•°
    """
    return ContextResponse(
        l0=UserProfile(
            user_id=user.id,
            display_name=user.name,
            birth_info=get_birth_info(user.id),
            preferences=get_preferences(user.id),
        ),
        l1=ModuleData(
            bazi_chart=get_latest_bazi(user.id),
            perma_recent=get_perma_summary(user.id, days=7),
            active_goals=get_active_goals(user.id, limit=3),
            twin_status=get_twin_status(user.id),
        ),
        policy_flags=PolicyFlags(
            allow_roast=user.preferences.get('allow_roast', False),
            model_override=user.preferences.get('model'),
        ),
        history_excerpt=get_recent_messages(user.id, limit=10),
    )
```

**Response Schema**:
```typescript
interface ContextResponse {
  l0: {
    user_id: string;
    display_name: string;
    birth_info: { year: number; month: number; day: number; hour?: number };
    preferences: Record<string, unknown>;
  };
  l1: {
    bazi_chart?: BaziChart;
    perma_recent?: PermaScore[];
    active_goals?: Goal[];
    twin_status?: TwinStatus;
  };
  policy_flags: {
    allow_roast: boolean;
    model_override?: 'glm' | 'gemini' | 'claude';
  };
  history_excerpt: Message[];
}
```

#### 2.4.2 Chat Persistence APIï¼ˆæµå¼æŒä¹…åŒ–ï¼‰

```python
# FastAPI: api/internal_routes.py

@router.post("/internal/chat/run/start")
async def start_chat_run(
    request: StartRunRequest,
    user: AuthUser = Depends(get_current_user_from_cookie),
) -> StartRunResponse:
    """
    æµå¼å¼€å§‹æ—¶è°ƒç”¨ï¼šè®°å½• run_id + ç”¨æˆ·æ¶ˆæ¯
    """
    run_id = str(uuid4())

    # åªå†™å…¥ç”¨æˆ·æ¶ˆæ¯ï¼ˆassistant æ¶ˆæ¯åœ¨ finalize å†™å…¥ï¼‰
    await db.execute("""
        INSERT INTO chat_runs (id, user_id, session_id, status, started_at)
        VALUES ($1, $2, $3, 'running', NOW())
    """, run_id, user.id, request.session_id)

    await db.execute("""
        INSERT INTO chat_messages (run_id, role, content, created_at)
        VALUES ($1, 'user', $2, NOW())
    """, run_id, request.user_message)

    return StartRunResponse(run_id=run_id)

@router.post("/internal/chat/run/finalize")
async def finalize_chat_run(
    request: FinalizeRunRequest,
    user: AuthUser = Depends(get_current_user_from_cookie),
) -> FinalizeRunResponse:
    """
    æµå¼ç»“æŸæ—¶è°ƒç”¨ï¼šä¸€æ¬¡äº‹åŠ¡å†™å…¥æ‰€æœ‰å‰¯ä½œç”¨
    """
    async with db.transaction():
        # 1. æ›´æ–° run çŠ¶æ€
        await db.execute("""
            UPDATE chat_runs
            SET status = $2, finished_at = NOW()
            WHERE id = $1
        """, request.run_id, 'completed' if request.success else 'aborted')

        # 2. å†™å…¥ assistant æ¶ˆæ¯
        if request.assistant_message:
            await db.execute("""
                INSERT INTO chat_messages (run_id, role, content, created_at)
                VALUES ($1, 'assistant', $2, NOW())
            """, request.run_id, request.assistant_message)

        # 3. å†™å…¥ tool è°ƒç”¨æ—¥å¿—
        for tool_log in request.tool_logs:
            await db.execute("""
                INSERT INTO tool_invocations
                (run_id, tool_name, input, output, latency_ms, idempotency_key)
                VALUES ($1, $2, $3, $4, $5, $6)
                ON CONFLICT (idempotency_key) DO NOTHING
            """, request.run_id, tool_log.name, tool_log.input,
                tool_log.output, tool_log.latency_ms, tool_log.idempotency_key)

        # 4. å†™å…¥ commitmentsï¼ˆæ‰¿è¯º/ä»»åŠ¡ï¼‰
        for commitment in request.commitments:
            await create_commitment(user.id, commitment)

        # 5. æ›´æ–° twin çŠ¶æ€
        if request.twin_updates:
            await update_twin(user.id, request.twin_updates)

    return FinalizeRunResponse(ok=True)
```

**Request/Response Schema**:
```typescript
interface StartRunRequest {
  session_id?: string;
  user_message: string;
  correlation_id: string;
}

interface FinalizeRunRequest {
  run_id: string;
  success: boolean;
  assistant_message?: string;
  tool_logs: ToolLog[];
  commitments: Commitment[];
  twin_updates?: TwinUpdate;
}

interface ToolLog {
  name: string;
  input: Record<string, unknown>;
  output: Record<string, unknown>;
  latency_ms: number;
  idempotency_key: string;  // ç”¨äºé˜²æ­¢ maxSteps é‡å¤å†™å…¥
}
```

### 2.5 A2UI è¿ç§»æ–¹æ¡ˆï¼ˆToolResultCardï¼‰

å°† A2UI ä»"æ•´æ®µ JSON ä½œä¸º assistant content"è¿ç§»ä¸º"ToolResultCard + æ•™ç»ƒè¡¨è¾¾"æ¨¡å¼ï¼š

#### 2.5.1 ç°çŠ¶ vs ç›®æ ‡

```
ã€ç°çŠ¶ã€‘A2UI ä½œä¸º assistant message content
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ { role: 'assistant',                                            â”‚
â”‚   content: '{"type":"a2ui","cards":[{"type":"bazi_chart",...}]}'â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç›®æ ‡ã€‘ToolResultCard + assistant content åˆ†ç¦»
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                                               â”‚
â”‚   role: 'assistant',                                            â”‚
â”‚   content: 'æ ¹æ®ä½ çš„å…«å­—ï¼Œä½ æ˜¯ä¸€ä¸ª...',  // æ•™ç»ƒè¡¨è¾¾           â”‚
â”‚   toolInvocations: [                                            â”‚
â”‚     {                                                           â”‚
â”‚       toolName: 'calculate_bazi',                               â”‚
â”‚       state: 'result',                                          â”‚
â”‚       result: {                                                 â”‚
â”‚         type: 'a2ui_card',                                      â”‚
â”‚         card_type: 'bazi_chart',                                â”‚
â”‚         data: { ... }                                           â”‚
â”‚       }                                                         â”‚
â”‚     }                                                           â”‚
â”‚   ]                                                             â”‚
â”‚ }                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.5.2 ToolResultCard Schema

```typescript
// lib/types/a2ui-card.ts

interface ToolResultCard {
  type: 'a2ui_card';
  card_type: CardType;
  data: CardData;
  actions?: CardAction[];
}

type CardType =
  | 'bazi_chart'      // å…«å­—å‘½ç›˜
  | 'perma_radar'     // PERMA é›·è¾¾å›¾
  | 'goal_progress'   // ç›®æ ‡è¿›åº¦
  | 'commitment_card' // æ‰¿è¯ºå¡ç‰‡
  | 'insight_card'    // æ´å¯Ÿå¡ç‰‡
  | 'kline_chart'     // Kçº¿å›¾
  | 'error_toast';    // é”™è¯¯æç¤º

interface CardAction {
  type: 'accept' | 'done' | 'skip' | 'navigate' | 'share';
  label: string;
  endpoint?: string;   // ä»…æ˜ å°„åˆ° SSOT çŠ¶æ€æœºè·ƒè¿ç«¯ç‚¹
  payload?: Record<string, unknown>;
}

// å‰ç«¯æ¸²æŸ“
function ToolResultRenderer({ toolInvocation }) {
  if (toolInvocation.result?.type === 'a2ui_card') {
    const { card_type, data, actions } = toolInvocation.result;
    switch (card_type) {
      case 'bazi_chart':
        return <BaziChartCard data={data} actions={actions} />;
      case 'commitment_card':
        return <CommitmentCard data={data} actions={actions} />;
      // ...
    }
  }
  return null;
}
```

#### 2.5.3 ActionButton çº¦æŸ

**å…³é”®è§„åˆ™**ï¼šActionButton çš„ `type` åªèƒ½æ˜ å°„åˆ°ä»¥ä¸‹ SSOT çŠ¶æ€æœºè·ƒè¿ç«¯ç‚¹ï¼Œä¸å…è®¸ç»„ä»¶ç§è‡ªå®šä¹‰å†™æ“ä½œï¼š

| action.type | æ˜ å°„ç«¯ç‚¹ | è¯´æ˜ |
|-------------|----------|------|
| `accept` | `POST /api/dashboard/task/accept` | æ¥å—ä»»åŠ¡ |
| `done` | `POST /api/dashboard/task/done` | å®Œæˆä»»åŠ¡ |
| `skip` | `POST /api/dashboard/task/skip` | è·³è¿‡ä»»åŠ¡ |
| `checkin` | `POST /api/dashboard/checkin` | æƒ…ç»ªæ‰“å¡ |
| `navigate` | å‰ç«¯è·¯ç”± | é¡µé¢è·³è½¬ï¼ˆæ— å†™æ“ä½œï¼‰ |
| `share` | `POST /api/social/share` | åˆ†äº«å¡ç‰‡ |

### 2.6 å¹‚ç­‰æ€§è®¾è®¡

é˜²æ­¢ `maxSteps` å¤šæ­¥æ¨ç†ä¸‹çš„é‡å¤å†™å…¥ï¼š

#### 2.6.1 idempotency_key ç­–ç•¥

```typescript
// lib/skills/divine-skills.ts

export const calculateBazi = tool({
  description: 'è®¡ç®—ç”¨æˆ·çš„å…«å­—å‘½ç›˜',
  parameters: z.object({
    birth_datetime: z.string(),
    timezone: z.string().default('Asia/Shanghai'),
  }),
  execute: async ({ birth_datetime, timezone }, { runId, stepIndex }) => {
    // ç”Ÿæˆå¹‚ç­‰é”®ï¼šrun_id + step_index + tool_name + params_hash
    const idempotencyKey = `${runId}:${stepIndex}:calculate_bazi:${hash({ birth_datetime, timezone })}`;

    const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Idempotency-Key': idempotencyKey,
      },
      body: JSON.stringify({ birth_datetime, timezone }),
    });

    return res.json();
  },
});
```

#### 2.6.2 FastAPI å¹‚ç­‰æ€§å¤„ç†

```python
# api/middleware/idempotency.py

@app.middleware("http")
async def idempotency_middleware(request: Request, call_next):
    idempotency_key = request.headers.get("X-Idempotency-Key")

    if idempotency_key and request.method in ("POST", "PUT"):
        # æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œ
        cached = await redis.get(f"idempotency:{idempotency_key}")
        if cached:
            return JSONResponse(content=json.loads(cached))

        response = await call_next(request)

        # ç¼“å­˜ç»“æœï¼ˆTTL 24hï¼‰
        if response.status_code == 200:
            body = await response.body()
            await redis.setex(f"idempotency:{idempotency_key}", 86400, body)

        return response

    return await call_next(request)
```

#### 2.6.3 è‡ªç„¶å”¯ä¸€é”®

å¯¹äºæŸäº›ä¸šåŠ¡å†™å…¥ï¼Œä½¿ç”¨è‡ªç„¶å”¯ä¸€é”®æ›¿ä»£æ˜¾å¼ idempotency_keyï¼š

```sql
-- æ‰¿è¯ºè¡¨ï¼šåŒä¸€ç”¨æˆ·åŒä¸€å¤©åŒä¸€æè¿°åªèƒ½æœ‰ä¸€æ¡
CREATE UNIQUE INDEX uq_commitments_natural
ON commitments (user_id, date_trunc('day', created_at), description_hash)
WHERE status = 'active';

-- PERMA è®°å½•ï¼šåŒä¸€ç”¨æˆ·åŒä¸€å°æ—¶åªèƒ½æœ‰ä¸€æ¡
CREATE UNIQUE INDEX uq_perma_hourly
ON perma_logs (user_id, date_trunc('hour', logged_at));
```

---

## 3. é‡æ„é˜¶æ®µ

### Phase 1: åŸºç¡€è®¾æ–½å‡†å¤‡ (Week 1)

**ç›®æ ‡**: å»ºç«‹ Next.js Agent Runtime åŸºç¡€æ¡†æ¶ + åŒåç«¯è·¯ç”±å…±å­˜

#### 1.0 åå‘ä»£ç†è·¯ç”±é…ç½®ï¼ˆå…³é”®å‰ç½®ï¼‰

é…ç½® Nginx/Caddy å®ç° Next.js å’Œ FastAPI çš„è·¯ç”±å…±å­˜ï¼š

```nginx
# /etc/nginx/sites-available/fortune-ai

upstream nextjs {
    server 127.0.0.1:8231;
}

upstream fastapi {
    server 127.0.0.1:8230;
}

server {
    listen 80;
    server_name fortune-ai.example.com;

    # Agent Runtime (Next.js)
    location /api/chat {
        proxy_pass http://nextjs;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_buffering off;  # æµå¼å“åº”å¿…é¡»
        proxy_read_timeout 300s;
    }

    # Landing Page API (Next.js)
    location /api/landing/ {
        proxy_pass http://nextjs;
        proxy_set_header Host $host;
        # IP çº§é™æµ
        limit_req zone=landing_limit burst=5 nodelay;
    }

    # Internal APIs (ä»…å†…éƒ¨è®¿é—®)
    location /internal/ {
        # åªå…è®¸å†…ç½‘è®¿é—®
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        deny all;
        proxy_pass http://fastapi;
        proxy_set_header Host $host;
    }

    # Data Service APIs (FastAPI)
    location /api/ {
        proxy_pass http://fastapi;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Cookie $http_cookie;
    }

    # Frontend (Next.js)
    location /new/ {
        proxy_pass http://nextjs;
        proxy_set_header Host $host;
    }

    # Admin System (Next.js)
    location /admin/ {
        proxy_pass http://nextjs;
        proxy_set_header Host $host;
    }

    # Landing Page (Next.js)
    location / {
        proxy_pass http://nextjs;
        proxy_set_header Host $host;
    }
}

# IP é™æµé…ç½®
limit_req_zone $binary_remote_addr zone=landing_limit:10m rate=10r/m;
```

**è·¯ç”±ä¼˜å…ˆçº§**ï¼ˆé¡ºåºå¾ˆé‡è¦ï¼‰ï¼š
1. `/api/chat` â†’ Next.jsï¼ˆAgent Runtimeï¼‰
2. `/api/landing/*` â†’ Next.jsï¼ˆLanding Page APIï¼‰
3. `/internal/*` â†’ FastAPIï¼ˆå†…éƒ¨ APIï¼Œé™å†…ç½‘ï¼‰
4. `/api/*` â†’ FastAPIï¼ˆData Serviceï¼‰
5. `/new/*` â†’ Next.jsï¼ˆFrontendï¼‰
6. `/admin/*` â†’ Next.jsï¼ˆAdminï¼‰
7. `/` â†’ Next.jsï¼ˆLanding Pageï¼‰

#### 1.1 Next.js API Route ç»“æ„

```bash
web-app/src/app/api/
â”œâ”€â”€ chat/
â”‚   â””â”€â”€ route.ts              # ä¸» Agent Runtime
â”œâ”€â”€ command/
â”‚   â””â”€â”€ route.ts              # æŒ‡ä»¤è·¯ç”±
â””â”€â”€ landing/
    â””â”€â”€ insight/
        â””â”€â”€ route.ts          # Landing Page æ´å¯Ÿ
```

#### 1.2 Skills Registry æ¡†æ¶

```bash
web-app/src/lib/
â”œâ”€â”€ skills/
â”‚   â”œâ”€â”€ index.ts              # Skills ç»Ÿä¸€å¯¼å‡º
â”‚   â”œâ”€â”€ divine-skills.ts      # ç„å­¦æŠ€èƒ½
â”‚   â”œâ”€â”€ heal-skills.ts        # ç–—æ„ˆæŠ€èƒ½
â”‚   â””â”€â”€ grow-skills.ts        # æˆé•¿æŠ€èƒ½
â”œâ”€â”€ models/
â”‚   â””â”€â”€ model-provider.ts     # Multi-Model é…ç½®
â””â”€â”€ context/
    â””â”€â”€ context-builder.ts    # System Prompt æ„å»º
```

#### 1.3 é…ç½® Multi-Model Provider

```typescript
// lib/models/model-provider.ts
import { createGoogleGenerativeAI } from '@ai-sdk/google';
import { createAnthropic } from '@ai-sdk/anthropic';

const google = createGoogleGenerativeAI({
  apiKey: process.env.GOOGLE_API_KEY,
});

const anthropic = createAnthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

// Vercel AI Gateway for GLM-4.5
const glm = createGoogleGenerativeAI({
  baseURL: 'https://gateway.ai.cloudflare.com/v1/...',
  apiKey: process.env.GLM_API_KEY,
});

export function selectModel(preference?: string) {
  switch (preference) {
    case 'gemini': return google('gemini-2.0-flash-exp');
    case 'claude': return anthropic('claude-3-5-sonnet-20241022');
    case 'glm':
    default: return glm('glm-4.5');
  }
}
```

#### 1.4 äº¤ä»˜ç‰©

- [ ] **Nginx/Caddy åŒåç«¯è·¯ç”±é…ç½®**ï¼ˆå…³é”®å‰ç½®ï¼‰
- [ ] FastAPI `/internal/*` ç«¯ç‚¹éš”ç¦»ï¼ˆIP ç™½åå•ï¼‰
- [ ] Next.js `/api/chat/route.ts` åŸºç¡€æ¡†æ¶
- [ ] Skills Registry ç›®å½•ç»“æ„
- [ ] Multi-Model Provider é…ç½®
- [ ] ç¯å¢ƒå˜é‡é…ç½® (`.env.local`)

---

### Phase 2: Agent Runtime è¿ç§» (Week 2)

**ç›®æ ‡**: å°† AI æ¨ç†é€»è¾‘ä» Python è¿ç§»åˆ° Next.js

#### 2.1 å®ç° `/api/chat/route.ts`ï¼ˆå« Run Lifecycleï¼‰

```typescript
// app/api/chat/route.ts
import { streamText } from 'ai';
import { cookies } from 'next/headers';
import { selectModel } from '@/lib/models/model-provider';
import { allSkills } from '@/lib/skills';
import { buildSystemPrompt } from '@/lib/context/context-builder';

const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';

// è¯·æ±‚ä½“ï¼šä¸åŒ…å« userIdï¼ˆä» Cookie Session è§£å‡ºï¼‰
interface ChatRequest {
  session_id?: string;   // å¯é€‰ï¼Œç”¨äºä¼šè¯ç»­æ¥
  message: string;       // ç”¨æˆ·æ¶ˆæ¯
  command?: string;      // /divine | /heal | /growï¼ˆæ¥è‡ª CommandPaletteï¼‰
}

export async function POST(req: Request) {
  const cookieStore = await cookies();
  const sessionCookie = cookieStore.get('fortune_session')?.value;

  if (!sessionCookie) {
    return Response.json({ ok: false, error: { code: 'AUTH_REQUIRED' } }, { status: 401 });
  }

  const { session_id, message, command }: ChatRequest = await req.json();

  // ç”Ÿæˆ correlation_id
  const correlationId = `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;

  // 1. è°ƒç”¨ Internal Context APIï¼ˆCookie é€ä¼ ï¼ŒuserId ç”± FastAPI è§£å‡ºï¼‰
  const contextRes = await fetch(`${FASTAPI_URL}/internal/context`, {
    headers: {
      'Cookie': `fortune_session=${sessionCookie}`,
      'X-Correlation-ID': correlationId,
    },
  });

  if (!contextRes.ok) {
    return Response.json({ ok: false, error: { code: 'CONTEXT_FETCH_FAILED' } }, { status: 500 });
  }

  const context = await contextRes.json();

  // 2. è°ƒç”¨ run/startï¼ˆè®°å½• run_id + ç”¨æˆ·æ¶ˆæ¯ï¼‰
  const startRes = await fetch(`${FASTAPI_URL}/internal/chat/run/start`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Cookie': `fortune_session=${sessionCookie}`,
      'X-Correlation-ID': correlationId,
    },
    body: JSON.stringify({
      session_id,
      user_message: message,
      correlation_id: correlationId,
    }),
  });

  const { run_id } = await startRes.json();

  // 3. æ ¹æ® Command ç­›é€‰ Tools
  const tools = command
    ? getToolsForCommand(command)  // /divine â†’ divineSkills only
    : allSkills;                   // Chat Mode: all tools

  // 4. æš‚å­˜ Tool è°ƒç”¨è®°å½•ï¼ˆç”¨äº finalizeï¼‰
  const toolLogs: ToolLog[] = [];
  const commitments: Commitment[] = [];

  // 5. streamText æµå¼æ¨ç†
  const result = streamText({
    model: selectModel(context.policy_flags?.model_override),
    system: buildSystemPrompt(context),
    messages: [
      ...context.history_excerpt,
      { role: 'user', content: message },
    ],
    tools,
    maxSteps: 5,

    // æ¯æ­¥å®Œæˆå›è°ƒï¼šè®°å½• Tool è°ƒç”¨
    onStepFinish({ stepType, toolCalls, toolResults }) {
      if (stepType === 'tool-result' && toolCalls) {
        for (let i = 0; i < toolCalls.length; i++) {
          const call = toolCalls[i];
          const result = toolResults?.[i];
          toolLogs.push({
            name: call.toolName,
            input: call.args,
            output: result,
            latency_ms: 0, // TODO: å®é™…è®¡æ—¶
            idempotency_key: `${run_id}:${toolLogs.length}:${call.toolName}`,
          });

          // æ”¶é›† commitments
          if (result?.commitments) {
            commitments.push(...result.commitments);
          }
        }
      }
    },

    // æµå¼å®Œæˆå›è°ƒï¼šè°ƒç”¨ finalize
    async onFinish({ text, finishReason }) {
      await fetch(`${FASTAPI_URL}/internal/chat/run/finalize`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Cookie': `fortune_session=${sessionCookie}`,
          'X-Correlation-ID': correlationId,
        },
        body: JSON.stringify({
          run_id,
          success: finishReason !== 'error',
          assistant_message: text,
          tool_logs: toolLogs,
          commitments,
        }),
      });
    },
  });

  return result.toDataStreamResponse();
}
```

**å…³é”®å˜åŒ–**ï¼š
- è¯·æ±‚ä½“åªåŒ…å« `{ session_id?, message, command? }`ï¼Œ**ä¸ä¼  userId**
- userId ä» Cookie Session ç”± FastAPI è§£å‡º
- æµå¼å¼€å§‹æ—¶è°ƒç”¨ `run/start`ï¼Œç»“æŸæ—¶è°ƒç”¨ `run/finalize`
- Tool è°ƒç”¨è®°å½•æš‚å­˜å†…å­˜ï¼Œ`finalize` æ—¶ç»Ÿä¸€å†™å…¥

#### 2.2 System Prompt è¿ç§»

å°† `chat_routes.py:SYSTEM_PROMPT_TEMPLATE` è¿ç§»åˆ° TypeScriptï¼š

```typescript
// lib/context/context-builder.ts
export function buildSystemPrompt(context: UserContext): string {
  return `ä½ æ˜¯ Fortune AI çš„å¯¹è¯ Agentï¼Œè§’è‰²æ˜¯ç§¯æå¿ƒç†å­¦æ•™ç»ƒã€‚

ã€ç¡¬æ€§è§„åˆ™ã€‘
1) ç¦æ­¢æå“ã€ç¾è¾±ã€å®¿å‘½è®ºæ–­è¨€ï¼›è´Ÿé¢ä¿¡æ¯å¿…é¡»ç´§æ¥"ä½ å¯ä»¥åšä»€ä¹ˆ"çš„è¡ŒåŠ¨å¤„æ–¹ã€‚
2) ç¦æ­¢è‡ªè¡Œè®¡ç®—å…«å­—äº‹å®ï¼›åªèƒ½åŸºäºæä¾›çš„ facts + evidence è¾“å‡ºã€‚
3) æ¯æ¬¡è¾“å‡ºå¿…é¡»åŒ…å«ï¼šç»“è®º + ä¾æ® + â‰¤3æ¡å¤„æ–¹ + æ‰¿è¯ºé‚€è¯·ã€‚
4) æ¯æ¡å¤„æ–¹å¿…é¡»åŒ…å« if_thenï¼šå¦‚æœ____â†’é‚£ä¹ˆ____ã€‚
5) å¿…é¡»ç»™å‡ºå¯ç‚¹å‡» actionsã€‚

ã€ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‘
persona_style: ${context.persona_style}
facts: ${JSON.stringify(context.facts)}
evidence: ${JSON.stringify(context.evidence)}
active_goals: ${JSON.stringify(context.active_goals)}
`;
}
```

#### 2.3 åŒè·¯ç”±å¹¶è¡ŒæœŸ

**ä¿ç•™ Python `/api/chat/send`**ï¼Œæ–°å¢ Next.js `/api/chat`ï¼š

```python
# api/chat_routes.py - æ·»åŠ  header æ£€æµ‹
@router.post("/send")
async def chat_send(request: Request, body: ChatSendRequest, auth = Depends(require_auth)):
    # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ–°æ¶æ„
    use_new_runtime = request.headers.get("X-Use-New-Runtime") == "true"
    if use_new_runtime:
        # è½¬å‘åˆ° Next.js
        return RedirectResponse(url="/api/chat", status_code=307)
    # åŸæœ‰é€»è¾‘...
```

#### 2.4 äº¤ä»˜ç‰©

- [ ] `/api/chat/route.ts` å®Œæ•´å®ç°
- [ ] `buildSystemPrompt()` è¿ç§»
- [ ] åŒè·¯ç”±å¹¶è¡Œé…ç½®
- [ ] å‰ç«¯ `useChat()` é›†æˆæµ‹è¯•

---

### Phase 3: Skills å®ç° (Week 3)

**ç›®æ ‡**: å°† L2 Expert Agents é‡æ„ä¸º Vercel Tools

#### 3.1 Divine Skills

```typescript
// lib/skills/divine-skills.ts
import { tool } from 'ai';
import { z } from 'zod';

const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';

export const divineSkills = {
  calculate_bazi: tool({
    description: 'è®¡ç®—ç”¨æˆ·çš„å…«å­—å‘½ç›˜ï¼Œè¿”å›å››æŸ±ã€äº”è¡Œã€åç¥ã€ç¥ç…ã€å¤§è¿ç­‰ä¿¡æ¯',
    parameters: z.object({
      birth_datetime: z.string().describe('å‡ºç”Ÿæ—¥æœŸæ—¶é—´ (ISO 8601)'),
      timezone: z.string().default('Asia/Shanghai'),
      include_dayun: z.boolean().default(true),
    }),
    execute: async ({ birth_datetime, timezone, include_dayun }) => {
      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),
      });
      if (!res.ok) throw new Error(`Bazi calculation failed: ${res.status}`);
      return res.json();
    },
  }),

  get_bazi_facts: tool({
    description: 'è·å–ç”¨æˆ·å·²è®¡ç®—çš„å…«å­—äº‹å®æ•°æ®',
    parameters: z.object({
      user_id: z.number(),
    }),
    execute: async ({ user_id }) => {
      const res = await fetch(`${FASTAPI_URL}/api/bazi/facts/${user_id}`);
      return res.json();
    },
  }),

  search_bazi_kb: tool({
    description: 'æœç´¢å…«å­—çŸ¥è¯†åº“ï¼Œè·å–ç›¸å…³å‘½ç†è§£è¯»',
    parameters: z.object({
      query: z.string().describe('æœç´¢å…³é”®è¯'),
      limit: z.number().default(3),
    }),
    execute: async ({ query, limit }) => {
      const res = await fetch(`${FASTAPI_URL}/api/kb/search`, {
        method: 'POST',
        body: JSON.stringify({ query, limit, category: 'bazi' }),
      });
      return res.json();
    },
  }),
};
```

#### 3.2 Heal Skills

```typescript
// lib/skills/heal-skills.ts
export const healSkills = {
  log_perma: tool({
    description: 'è®°å½•ç”¨æˆ·çš„ PERMA äº”ç»´å¿ƒç†çŠ¶æ€åˆ†æ•°',
    parameters: z.object({
      dimension: z.enum(['P', 'E', 'R', 'M', 'A']),
      score: z.number().min(0).max(10),
      note: z.string().optional(),
    }),
    execute: async ({ dimension, score, note }, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/perma/log`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, dimension, score, note }),
      });
      return res.json();
    },
  }),

  mood_checkin: tool({
    description: 'å¿«é€Ÿæƒ…ç»ªæ‰“å¡',
    parameters: z.object({
      mood_score: z.number().min(1).max(10),
      tags: z.array(z.string()).optional(),
      note: z.string().optional(),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),

  cbt_reframe: tool({
    description: 'ä½¿ç”¨ CBT ABC æ¨¡å‹è¿›è¡Œè®¤çŸ¥é‡æ„',
    parameters: z.object({
      activating_event: z.string().describe('è§¦å‘äº‹ä»¶ (A)'),
      belief: z.string().optional().describe('ä¿¡å¿µ/æƒ³æ³• (B)'),
      consequence: z.string().optional().describe('æƒ…ç»ª/è¡Œä¸ºåæœ (C)'),
    }),
    execute: async (params) => {
      // CBT å¼•å¯¼æ¡†æ¶ï¼Œè¿”å›ç»“æ„åŒ–æç¤ºè®© LLM ç»§ç»­å¼•å¯¼
      return {
        framework: 'ABC',
        current_state: params,
        next_step: params.belief ? 'identify_distortion' : 'explore_belief',
        guidance_prompt: params.belief
          ? `ç”¨æˆ·çš„ä¿¡å¿µæ˜¯"${params.belief}"ï¼Œè¯·å¸®åŠ©è¯†åˆ«å¯èƒ½çš„è®¤çŸ¥æ‰­æ›²...`
          : `è¯·å¼•å¯¼ç”¨æˆ·æ¢ç´¢è§¦å‘äº‹ä»¶èƒŒåçš„ä¿¡å¿µå’Œæƒ³æ³•...`,
      };
    },
  }),
};
```

#### 3.3 Grow Skills

```typescript
// lib/skills/grow-skills.ts
export const growSkills = {
  create_commitment: tool({
    description: 'åˆ›å»ºè¡ŒåŠ¨æ‰¿è¯ºä»»åŠ¡',
    parameters: z.object({
      content: z.string().describe('ä»»åŠ¡å†…å®¹'),
      category: z.enum(['energy_boost', 'reflection', 'practice', 'social', 'general']),
      estimated_minutes: z.number().default(5),
      if_then: z.string().optional().describe('If-Then è§¦å‘æ¡ä»¶'),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),

  goal_setting: tool({
    description: 'ä½¿ç”¨ WOOP æ¨¡å‹è®¾å®šç›®æ ‡',
    parameters: z.object({
      wish: z.string().describe('æ„¿æœ›/ç›®æ ‡'),
      outcome: z.string().optional(),
      obstacle: z.string().optional(),
      plan: z.string().optional(),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {
        method: 'POST',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),

  update_twin: tool({
    description: 'æ›´æ–°ç”¨æˆ·æ•°å­—å­ªç”Ÿæ•°æ®',
    parameters: z.object({
      layer: z.enum(['L1', 'L2', 'L3']),
      path: z.string().describe('JSON è·¯å¾„'),
      value: z.any(),
    }),
    execute: async (params, { userId }) => {
      const res = await fetch(`${FASTAPI_URL}/api/twin/update`, {
        method: 'PUT',
        body: JSON.stringify({ user_id: userId, ...params }),
      });
      return res.json();
    },
  }),
};
```

#### 3.4 Skills Registry ç»Ÿä¸€å¯¼å‡º

```typescript
// lib/skills/index.ts
import { divineSkills } from './divine-skills';
import { healSkills } from './heal-skills';
import { growSkills } from './grow-skills';

export const allSkills = {
  ...divineSkills,
  ...healSkills,
  ...growSkills,
};

export function getToolsForCommand(command: string) {
  switch (command) {
    case '/divine': return divineSkills;
    case '/heal': return healSkills;
    case '/grow': return growSkills;
    default: return allSkills;
  }
}

export { divineSkills, healSkills, growSkills };
```

#### 3.5 äº¤ä»˜ç‰©

- [ ] `divine-skills.ts` å®Œæ•´å®ç°
- [ ] `heal-skills.ts` å®Œæ•´å®ç°
- [ ] `grow-skills.ts` å®Œæ•´å®ç°
- [ ] Skills Registry å•å…ƒæµ‹è¯•

---

### Phase 4: FastAPI æ•°æ®æœåŠ¡é‡æ„ (Week 4)

**ç›®æ ‡**: å°† FastAPI ç²¾ç®€ä¸ºçº¯æ•°æ®æœåŠ¡å±‚

#### 4.1 æ–°å¢æ•°æ®æœåŠ¡ API

```python
# api/data_routes.py (æ–°æ–‡ä»¶)
from fastapi import APIRouter, Depends
from api.deps import require_auth

router = APIRouter(prefix="/api", tags=["data"])

@router.get("/user/context")
async def get_user_context(user_id: int, auth = Depends(require_auth)):
    """èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œä¾› Agent Runtime è°ƒç”¨"""
    # èšåˆ profile + preferences + facts + active_goals + recent_messages
    profile = await _get_profile(user_id)
    prefs = await _get_preferences(user_id)
    facts = await _get_bazi_facts(user_id)
    goals = await _get_active_goals(user_id)
    messages = await _get_recent_messages(user_id, limit=10)

    return {
        "ok": True,
        "data": {
            "profile": profile,
            "persona_style": prefs.get("persona_style", "warm"),
            "facts": facts,
            "evidence": {
                "facts_hash": facts.get("facts_hash"),
                "kb_refs": [],  # åç»­å¡«å……
            },
            "active_goals": goals,
            "recent_messages": messages,
        }
    }

@router.post("/bazi/calculate")
async def calculate_bazi(body: BaziCalculateRequest):
    """å…«å­—è®¡ç®— (æ— éœ€ç™»å½•ï¼Œä¾› Landing Page ä½¿ç”¨)"""
    from services.bazi_engine import calculate_bazi
    result = calculate_bazi(
        body.birth_datetime,
        body.timezone,
        body.include_dayun,
    )
    return {"ok": True, "data": result}

@router.post("/perma/log")
async def log_perma(body: PermaLogRequest, auth = Depends(require_auth)):
    """PERMA çŠ¶æ€è®°å½•"""
    from services.twin_service import update_perma_score
    result = await update_perma_score(
        auth.user_id,
        body.dimension,
        body.score,
        body.note,
    )
    return {"ok": True, "data": result}

@router.post("/tasks/create")
async def create_task(body: TaskCreateRequest, auth = Depends(require_auth)):
    """åˆ›å»ºæ‰¿è¯ºä»»åŠ¡"""
    from services.bento_service import create_commitment
    result = await create_commitment(
        auth.user_id,
        body.content,
        body.category,
        body.estimated_minutes,
        body.if_then,
    )
    return {"ok": True, "data": result}

@router.post("/goals/create")
async def create_goal(body: GoalCreateRequest, auth = Depends(require_auth)):
    """åˆ›å»º WOOP ç›®æ ‡"""
    from services.goal_service import create_goal
    result = await create_goal(auth.user_id, body.dict())
    return {"ok": True, "data": result}

@router.put("/twin/update")
async def update_twin(body: TwinUpdateRequest, auth = Depends(require_auth)):
    """æ›´æ–°æ•°å­—å­ªç”Ÿ"""
    from services.twin_service import update_twin
    result = await update_twin(auth.user_id, body.layer, body.path, body.value)
    return {"ok": True, "data": result}

@router.post("/kb/search")
async def search_kb(body: KBSearchRequest, auth = Depends(require_auth)):
    """çŸ¥è¯†åº“æ£€ç´¢"""
    from services.kb_service import search
    result = await search(body.query, body.limit, body.category)
    return {"ok": True, "data": result}
```

#### 4.2 Landing Page API

```python
# api/landing_routes.py (æ–°æ–‡ä»¶)
from fastapi import APIRouter

router = APIRouter(prefix="/api/landing", tags=["landing"])

ELEMENT_COLORS = {
    "wood": ["#4ade80", "#22c55e"],
    "fire": ["#f87171", "#ef4444"],
    "earth": ["#fbbf24", "#f59e0b"],
    "metal": ["#f5f5f4", "#d6d3d1"],
    "water": ["#60a5fa", "#3b82f6"],
}

ELEMENT_INSIGHTS = {
    "wood": {
        "en": "A strong Wood energy detected. You seek growth, but feel restricted.",
        "cn": "æ£€æµ‹åˆ°å¼ºæœ¨èƒ½é‡ã€‚ä½ æ¸´æœ›ç”Ÿé•¿ï¼Œä½†æ„Ÿåˆ°å—é™ã€‚",
    },
    "fire": {
        "en": "Fire burns bright within you. Passion drives you forward.",
        "cn": "ç«ç„°åœ¨ä½ å¿ƒä¸­ç‡ƒçƒ§ã€‚çƒ­æƒ…é©±åŠ¨ä½ å‰è¿›ã€‚",
    },
    # ... å…¶ä»–äº”è¡Œ
}

@router.post("/insight")
async def instant_insight(body: InsightRequest):
    """å³æ—¶æ´å¯Ÿ (æ— éœ€ç™»å½•)"""
    if body.input_type == "bazi":
        # å¿«é€Ÿè®¡ç®—æ—¥ä¸»äº”è¡Œ
        from services.bazi_engine import quick_day_master
        element = quick_day_master(body.value)
        insight = ELEMENT_INSIGHTS.get(element, ELEMENT_INSIGHTS["wood"])
        return {
            "ok": True,
            "data": {
                "type": "bazi",
                "element": element,
                "insight": insight["en"],
                "insight_cn": insight["cn"],
                "orb_colors": ELEMENT_COLORS.get(element),
                "cta": "Unlock Full Analysis â†’",
            }
        }
    elif body.input_type == "emotion":
        # è°ƒç”¨ LLM ç”Ÿæˆç®€çŸ­æƒ…ç»ªæ´å¯Ÿ
        from services.glm_client import quick_emotion_insight
        insight = await quick_emotion_insight(body.value)
        return {
            "ok": True,
            "data": {
                "type": "emotion",
                "insight": insight,
                "orb_colors": ["#a78bfa", "#8b5cf6"],  # ç´«è‰²
                "cta": "Start Your Journey â†’",
            }
        }
```

#### 4.3 åˆ é™¤/åºŸå¼ƒçš„ä»£ç 

```python
# å¾…åˆ é™¤æ–‡ä»¶
services/glm_client.py          # LLM è°ƒç”¨è¿ç§»åˆ° TypeScript
services/agent_service_client.py # ä¸å†éœ€è¦

# å¾…åºŸå¼ƒç«¯ç‚¹ (chat_routes.py)
# POST /api/chat/send  â†’ è¿ç§»åˆ° Next.js /api/chat
# GET  /api/chat/stream â†’ è¿ç§»åˆ° Next.js /api/chat
```

#### 4.4 äº¤ä»˜ç‰©

- [ ] `api/data_routes.py` å®Œæ•´å®ç°
- [ ] `api/landing_routes.py` å®Œæ•´å®ç°
- [ ] æ—§ chat ç«¯ç‚¹åºŸå¼ƒæ ‡è®°
- [ ] API æ–‡æ¡£æ›´æ–°

---

### Phase 5: å‰ç«¯é€‚é… (Week 5)

**ç›®æ ‡**: å‰ç«¯åˆ‡æ¢åˆ° `useChat()` Hook

#### 5.1 useChat é›†æˆ

```typescript
// components/chat/chat-panel.tsx
'use client';

import { useChat } from 'ai/react';
import { useState } from 'react';

export function ChatPanel({ userId }: { userId: number }) {
  const [command, setCommand] = useState<string | null>(null);

  const { messages, input, setInput, handleSubmit, isLoading, error } = useChat({
    api: '/api/chat',
    body: { userId, command },
    onFinish: (message) => {
      setCommand(null);
      // å¤„ç† Tool è°ƒç”¨ç»“æœ
      if (message.toolInvocations?.length) {
        refreshDashboard(message.toolInvocations);
      }
    },
  });

  const handleCommandSubmit = (cmd: string, text: string) => {
    setCommand(cmd);
    setInput(text);
    // useChat ä¼šè‡ªåŠ¨æäº¤
  };

  return (
    <div className="flex flex-col h-full">
      {/* Messages */}
      <div className="flex-1 overflow-y-auto">
        {messages.map((m) => (
          <MessageBubble key={m.id} message={m} />
        ))}
      </div>

      {/* Input */}
      <ChatInput
        value={input}
        onChange={setInput}
        onSubmit={handleSubmit}
        onCommand={handleCommandSubmit}
        isLoading={isLoading}
      />
    </div>
  );
}
```

#### 5.2 CommandPalette é›†æˆ

```typescript
// components/chat/command-palette.tsx
const COMMANDS = [
  { cmd: '/divine', label: 'ç„å­¦æµ‹ç®—', icon: 'ğŸ”®' },
  { cmd: '/heal', label: 'å¿ƒç†ç–—æ„ˆ', icon: 'ğŸ’š' },
  { cmd: '/grow', label: 'æˆé•¿æ•™ç»ƒ', icon: 'ğŸŒ±' },
  { cmd: '/status', label: 'çŠ¶æ€æŸ¥çœ‹', icon: 'ğŸ“Š' },
];

export function CommandPalette({ onSelect, visible }: CommandPaletteProps) {
  if (!visible) return null;

  return (
    <div className="absolute bottom-full left-0 w-full bg-background border rounded-lg shadow-lg p-2">
      {COMMANDS.map((c) => (
        <button
          key={c.cmd}
          onClick={() => onSelect(c.cmd)}
          className="flex items-center gap-2 w-full p-2 hover:bg-accent rounded"
        >
          <span>{c.icon}</span>
          <span className="font-medium">{c.cmd}</span>
          <span className="text-muted-foreground">{c.label}</span>
        </button>
      ))}
    </div>
  );
}
```

#### 5.3 Tool Result æ¸²æŸ“

```typescript
// components/chat/tool-result-card.tsx
export function ToolResultCard({ invocation }: { invocation: ToolInvocation }) {
  const { toolName, result, state } = invocation;

  if (state === 'partial-call') {
    return <LoadingCard toolName={toolName} />;
  }

  switch (toolName) {
    case 'calculate_bazi':
      return <BaziResultCard data={result} />;
    case 'mood_checkin':
      return <MoodCheckinCard data={result} />;
    case 'create_commitment':
      return <CommitmentCard data={result} />;
    default:
      return <GenericResultCard data={result} />;
  }
}
```

#### 5.4 äº¤ä»˜ç‰©

- [ ] `useChat()` é›†æˆ
- [ ] `CommandPalette` ç»„ä»¶
- [ ] `ToolResultCard` ç»„ä»¶
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•

---

### Phase 6: æ¸…ç†ä¸ä¼˜åŒ– (Week 6)

**ç›®æ ‡**: åˆ é™¤æ—§ä»£ç ï¼Œæ€§èƒ½ä¼˜åŒ–

#### 6.1 åˆ é™¤åˆ—è¡¨

```bash
# åˆ é™¤æ–‡ä»¶
rm services/glm_client.py
rm services/agent_service_client.py

# åˆ é™¤ agent_service ç›®å½• (å·²è¿ç§»åˆ° Next.js)
rm -rf agent_service/

# æ¸…ç† chat_routes.py ä¸­çš„æ—§ç«¯ç‚¹
# - /api/chat/send
# - /api/chat/stream
```

#### 6.2 API è·¯ç”±æ¸…ç†

```python
# api/main.py - æ›´æ–°è·¯ç”±æ³¨å†Œ
app.include_router(auth_routes.router)
app.include_router(data_routes.router)      # æ–°å¢
app.include_router(landing_routes.router)   # æ–°å¢
app.include_router(dashboard_routes.router)
app.include_router(report_routes.router)
# åˆ é™¤: app.include_router(chat_routes.router)
```

#### 6.3 æ€§èƒ½ä¼˜åŒ–

1. **Context ç¼“å­˜**: ç”¨æˆ·ä¸Šä¸‹æ–‡ Redis ç¼“å­˜ (TTL 5min)
2. **æ‰¹é‡ Tool è°ƒç”¨**: åˆå¹¶å¤šä¸ª fetch è¯·æ±‚
3. **æµå¼é¦–å­—ä¼˜åŒ–**: å‡å°‘ System Prompt é•¿åº¦

#### 6.4 ç›‘æ§ä¸æ—¥å¿—

```typescript
// æ·»åŠ  Tool è°ƒç”¨ç›‘æ§
const result = streamText({
  // ...
  onStepFinish({ stepType, toolCalls, toolResults }) {
    // è®°å½• Tool è°ƒç”¨è€—æ—¶
    logger.info('Step finished', {
      stepType,
      toolCount: toolCalls?.length,
      latency: Date.now() - startTime,
    });
  },
});
```

#### 6.5 äº¤ä»˜ç‰©

- [ ] æ—§æ–‡ä»¶åˆ é™¤
- [ ] API è·¯ç”±æ›´æ–°
- [ ] Redis ç¼“å­˜é…ç½®
- [ ] ç›‘æ§ Dashboard

---

## 4. é£é™©ä¸ç¼“è§£

### 4.1 å…¼å®¹æ€§é£é™©

| é£é™©ç‚¹ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
|--------|----------|----------|
| API ç­¾åå˜æ›´ | å‰ç«¯æ‰€æœ‰ Chat è°ƒç”¨ | åŒè·¯ç”±å¹¶è¡Œï¼ŒFeature Flag æ§åˆ¶ |
| A2UI æ ¼å¼å˜åŒ– | æ¶ˆæ¯æ¸²æŸ“ç»„ä»¶ | ä¿æŒ JSON ç»“æ„å…¼å®¹ï¼Œä»…æ”¹ä¼ è¾“æ–¹å¼ |
| CSRF å¤„ç† | æ‰€æœ‰ POST è¯·æ±‚ | Next.js API Route åŒæºï¼Œæ— éœ€ CSRF |
| Cookie ä¼ é€’ | è®¤è¯æµç¨‹ | `credentials: 'include'` é…ç½® |

### 4.2 å›æ»šæ–¹æ¡ˆ

```typescript
// Feature Flag æ§åˆ¶
const USE_NEW_RUNTIME = process.env.USE_NEW_RUNTIME === 'true';

// å‰ç«¯è·¯ç”±é€‰æ‹©
const chatEndpoint = USE_NEW_RUNTIME ? '/api/chat' : '/api/chat/send';
```

### 4.3 ç°åº¦å‘å¸ƒ

1. **Week 1-4**: å†…éƒ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
2. **Week 5**: 10% ç”¨æˆ·ç°åº¦
3. **Week 6**: 50% ç”¨æˆ·ç°åº¦
4. **Week 7**: å…¨é‡å‘å¸ƒ

---

## 5. éªŒæ”¶æ ‡å‡†

### 5.1 åŠŸèƒ½éªŒæ”¶

| åŠŸèƒ½ | éªŒæ”¶æ ‡å‡† |
|------|----------|
| Chat å¯¹è¯ | æµå¼è¾“å‡ºæ­£å¸¸ï¼Œé¦–å­— < 500ms |
| `/divine` æŒ‡ä»¤ | å…«å­—è®¡ç®—æ­£ç¡®ï¼Œç»“æœæ¸²æŸ“æ­£å¸¸ |
| `/heal` æŒ‡ä»¤ | PERMA è®°å½•æˆåŠŸï¼ŒCBT å¼•å¯¼å®Œæ•´ |
| `/grow` æŒ‡ä»¤ | ç›®æ ‡/ä»»åŠ¡åˆ›å»ºæˆåŠŸ |
| Landing Page | Insight ç”Ÿæˆ < 1sï¼ŒOrb é¢œè‰²æ­£ç¡® |
| Tool Calling | å¤šæ­¥æ¨ç† (maxSteps=5) æ­£å¸¸ |

### 5.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ |
|------|--------|--------|
| é¦–å­—å»¶è¿Ÿ (P50) | < 500ms | ~800ms |
| é¦–å­—å»¶è¿Ÿ (P95) | < 1.5s | ~2s |
| Tool è°ƒç”¨å»¶è¿Ÿ | < 200ms | N/A |
| ç«¯åˆ°ç«¯å“åº” (P50) | < 3s | ~4s |

### 5.3 ä»£ç è´¨é‡

- [ ] TypeScript ä¸¥æ ¼æ¨¡å¼
- [ ] Zod Schema 100% è¦†ç›–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
- [ ] E2E æµ‹è¯•é€šè¿‡

---

## 6. é™„å½•

### 6.1 ç¯å¢ƒå˜é‡

```bash
# .env.local (Next.js)
FASTAPI_URL=http://localhost:8230
GOOGLE_API_KEY=xxx
ANTHROPIC_API_KEY=xxx
GLM_API_KEY=xxx
USE_NEW_RUNTIME=true
```

### 6.2 ä¾èµ–æ›´æ–°

```json
// package.json
{
  "dependencies": {
    "ai": "^4.0.0",
    "@ai-sdk/google": "^1.0.0",
    "@ai-sdk/anthropic": "^1.0.0",
    "zod": "^3.22.0"
  }
}
```

### 6.3 å‚è€ƒæ–‡æ¡£

- [Vercel AI SDK æ–‡æ¡£](https://sdk.vercel.ai/docs)
- [os_design_v3.md Â§1.4-1.5](./os_design_v3.md)
- [frontend_final_v3.md Â§2.6](./frontend_final_v3.md)
- [system_design_final_mvp_v3.md Â§7.0.1](./system_design_final_mvp_v3.md)
- [admin_v3.md](./admin_v3.md) - Admin System è®¾è®¡ï¼Œå¯ä¸æœ¬é‡æ„å¹¶è¡Œå¼€å‘

### 6.4 å¹¶è¡Œå¼€å‘é¡¹

| é¡¹ç›® | æè¿° | æŠ€æœ¯æ ˆ | ä¾èµ–å…³ç³» |
|------|------|--------|----------|
| **Admin System** | åå°ç®¡ç†é©¾é©¶èˆ± | Next.js App Router + shadcn/ui + Monaco | Phase 1 å®Œæˆåå¯å¯åŠ¨ |
| **Landing Page** | Digital Mirror é¦–é¡µ | Next.js + React Three Fiber | ç‹¬ç«‹å¼€å‘ |

> **æ³¨**: Admin System çš„ Agent Studio æ¨¡å—ä¾èµ–æœ¬é‡æ„ä¸­çš„ `admin_prompts` è¡¨å’Œ Prompt çƒ­åŠ è½½æœºåˆ¶ï¼ˆPhase 4ï¼‰ï¼Œå»ºè®®åœ¨ Phase 4 å®Œæˆåè¿›è¡Œ Admin å‰ç«¯å¼€å‘ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*åˆ›å»ºæ—¥æœŸ: 2026-01-01*
*ä½œè€…: Claude (Anthropic)*
