/**
 * Context Builder for Fortune AI Agent Runtime
 *
 * Builds the system prompt from context fetched from FastAPI internal API.
 * The context includes user profile, preferences, evidence, and anti-dependency check.
 */

export interface UserContext {
  user_id: number;
  system_prompt: string;
  persona_style: string;
  user_context: Record<string, unknown>;
  evidence: Record<string, unknown>;
  anti_dependency: {
    should_intervene: boolean;
    intervention_type: string | null;
    intervention_message: string | null;
  };
  history: Array<{ role: string; content: string }>;
}

// System prompt template for streaming (Markdown output)
const SYSTEM_PROMPT_STREAM_TEMPLATE = `你是 Fortune AI 的对话 Agent，角色是积极心理学教练（Performance Coach）。

【产品定位】
人生导航 / 陪伴 / 提升。系统和交互保持"有效而极简"。

【你的优先级（不可逆）】
Coach > Teaching Assistant > Customer Support > Sales

【硬性规则（必须遵守）】
1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接"你可以做什么"的行动处方。
2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。
3) 每次输出必须包含：结论(conclusion) + 依据(why) + ≤3条处方(prescriptions) + 承诺邀请(commitment_ask)。
4) 每条处方必须包含 if_then：如果____→那么____；并优先给 2–5 分钟可启动版本。
5) 只输出 Markdown 文本，不要 JSON/代码块/额外说明。
6) 当需要查询八字、运势、心理等功能时，使用提供的 tools 来获取数据。

【语言风格 persona_style】
standard：清晰、中性、专业
warm：共情、支持性（默认）
roast：轻毒舌但不羞辱、不对人格做负面定性

【输入（系统已注入）】
persona_style: {{persona_style}}
user_context: {{user_context_json}}
evidence: {{evidence_json}}

【输出（Markdown）】
用如下结构输出（标题可省略但必须包含"处方"一节）：

结论：...
依据：...
处方：
1) ...（包含 if_then）
2) ...（包含 if_then）
3) ...（包含 if_then）
承诺邀请：...（一句话，邀请用户选择一个处方开始）
`;

// Build system prompt from context
export function buildSystemPrompt(context: UserContext): string {
  // Start with the template
  let prompt = SYSTEM_PROMPT_STREAM_TEMPLATE;

  // Replace placeholders
  prompt = prompt.replace('{{persona_style}}', context.persona_style || 'warm');
  prompt = prompt.replace(
    '{{user_context_json}}',
    JSON.stringify(context.user_context, null, 2)
  );
  prompt = prompt.replace(
    '{{evidence_json}}',
    JSON.stringify(context.evidence, null, 2)
  );

  // Add anti-dependency intervention if needed
  if (context.anti_dependency?.should_intervene) {
    prompt += `\n\n【反依赖干预 - 必须首先处理】
类型: ${context.anti_dependency.intervention_type}
消息: ${context.anti_dependency.intervention_message}

请在回复开头温和地提醒用户上述内容，然后正常回答问题。
`;
  }

  return prompt;
}

// Convert chat history to Vercel AI SDK format
export function buildMessages(
  context: UserContext,
  userMessage: string
): Array<{ role: 'user' | 'assistant'; content: string }> {
  const messages: Array<{ role: 'user' | 'assistant'; content: string }> = [];

  // Add history
  for (const msg of context.history) {
    if (msg.role === 'user' || msg.role === 'assistant') {
      messages.push({
        role: msg.role as 'user' | 'assistant',
        content: msg.content,
      });
    }
  }

  // Add current message
  messages.push({
    role: 'user',
    content: userMessage,
  });

  return messages;
}

// Fetch context from FastAPI internal API
export async function fetchContext(
  sessionId: string | null,
  query: string,
  sessionCookie: string
): Promise<UserContext> {
  const fastApiUrl = process.env.FASTAPI_URL || 'http://localhost:8230';

  const params = new URLSearchParams();
  if (sessionId) params.set('session_id', sessionId);
  if (query) params.set('query', query);

  const res = await fetch(`${fastApiUrl}/internal/context?${params.toString()}`, {
    headers: {
      Cookie: `fortune_session=${sessionCookie}`,
    },
  });

  if (!res.ok) {
    throw new Error(`Failed to fetch context: ${res.status}`);
  }

  return res.json();
}
