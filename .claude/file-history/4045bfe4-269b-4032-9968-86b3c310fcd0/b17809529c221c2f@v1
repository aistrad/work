"""
Mentis OS v3.0 - Emotion Engine 单元测试
"""

import pytest
import sys
import os

# 添加项目路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from services.emotion_engine import (
    detect_emotion,
    calculate_intensity,
    calculate_confidence,
    detect_secondary_emotions,
    count_exclamations,
    has_repeated_chars,
    EMOTION_KEYWORDS,
    EMOTION_TAXONOMY,
)


class TestEmotionDetection:
    """情绪检测测试"""

    def test_detect_joy(self):
        """测试识别喜悦情绪"""
        result = detect_emotion("今天真的太开心了！")
        assert result.primary == "joy"
        assert result.intensity >= 5

    def test_detect_sadness(self):
        """测试识别悲伤情绪"""
        result = detect_emotion("我感到很难过，心里很难受")
        assert result.primary == "sadness"

    def test_detect_anger(self):
        """测试识别愤怒情绪"""
        result = detect_emotion("气死我了！老板又在瞎指挥")
        assert result.primary == "anger"
        assert result.intensity >= 7

    def test_detect_anxiety(self):
        """测试识别焦虑情绪"""
        result = detect_emotion("明天的面试让我很焦虑，压力好大")
        assert result.primary == "anxiety"

    def test_detect_fear(self):
        """测试识别恐惧情绪"""
        result = detect_emotion("我很害怕，不敢一个人待着")
        assert result.primary == "fear"

    def test_detect_calm(self):
        """测试识别平静情绪"""
        result = detect_emotion("今天天气不错")
        assert result.primary == "calm"

    def test_default_to_calm(self):
        """测试无明确情绪时默认为平静"""
        result = detect_emotion("我去买了杯咖啡")
        assert result.primary == "calm"


class TestIntensityCalculation:
    """情绪强度计算测试"""

    def test_intensity_range(self):
        """测试强度范围 1-10"""
        result = detect_emotion("开心")
        assert 1 <= result.intensity <= 10

    def test_exclamation_increases_intensity(self):
        """测试感叹号增加强度"""
        result1 = detect_emotion("开心")
        result2 = detect_emotion("开心！！")
        assert result2.intensity >= result1.intensity

    def test_modifiers_affect_intensity(self):
        """测试修饰词影响强度"""
        result_normal = detect_emotion("开心")
        result_very = detect_emotion("非常开心")
        assert result_very.intensity >= result_normal.intensity

    def test_low_modifiers(self):
        """测试低程度修饰词"""
        result = detect_emotion("有点开心")
        assert result.intensity <= 5


class TestConfidenceCalculation:
    """置信度计算测试"""

    def test_confidence_range(self):
        """测试置信度范围 0.3-0.95"""
        result = detect_emotion("我很开心")
        assert 0.3 <= result.confidence <= 0.95

    def test_multiple_keywords_increase_confidence(self):
        """测试多关键词增加置信度"""
        result1 = detect_emotion("开心")
        result2 = detect_emotion("开心快乐高兴")
        assert result2.confidence >= result1.confidence

    def test_no_match_low_confidence(self):
        """测试无匹配时低置信度"""
        result = detect_emotion("今天是周一")
        assert result.confidence <= 0.5


class TestSecondaryEmotions:
    """二级情绪检测测试"""

    def test_detect_frustration(self):
        """测试检测挫败感"""
        result = detect_emotion("生气了，真的很郁闷")
        assert "frustration" in result.secondary or result.primary == "anger"

    def test_secondary_limit(self):
        """测试二级情绪最多3个"""
        result = detect_emotion("无力无奈孤独感激希望期待")
        assert len(result.secondary) <= 3

    def test_secondary_excludes_primary(self):
        """测试二级情绪不包含主情绪"""
        result = detect_emotion("开心激动期待")
        assert result.primary not in result.secondary


class TestEnergyDelta:
    """能量变化测试"""

    def test_joy_positive_energy(self):
        """测试喜悦带来正能量"""
        result = detect_emotion("今天太开心了")
        assert result.energy_delta > 0

    def test_anger_negative_energy(self):
        """测试愤怒消耗能量"""
        result = detect_emotion("气死我了")
        assert result.energy_delta < 0

    def test_sadness_negative_energy(self):
        """测试悲伤消耗能量"""
        result = detect_emotion("我好难过")
        assert result.energy_delta < 0

    def test_calm_neutral_energy(self):
        """测试平静能量变化小"""
        result = detect_emotion("今天挺平静的")
        assert -2 <= result.energy_delta <= 2


class TestHelperFunctions:
    """辅助函数测试"""

    def test_count_exclamations(self):
        """测试感叹号计数"""
        assert count_exclamations("你好！") == 1
        assert count_exclamations("好！！！") == 3
        assert count_exclamations("好！！") == 2
        assert count_exclamations("好") == 0

    def test_has_repeated_chars(self):
        """测试重复字符检测"""
        assert has_repeated_chars("啊啊啊") is True
        assert has_repeated_chars("好好好") is True
        assert has_repeated_chars("你好") is False


class TestTaxonomy:
    """情绪分类法测试"""

    def test_primary_emotions_count(self):
        """测试主情绪数量为8"""
        assert len(EMOTION_TAXONOMY["primary"]) == 8

    def test_secondary_emotions_count(self):
        """测试二级情绪数量为12"""
        assert len(EMOTION_TAXONOMY["secondary"]) == 12

    def test_all_primary_have_keywords(self):
        """测试所有主情绪都有关键词"""
        for emotion in EMOTION_TAXONOMY["primary"]:
            assert emotion in EMOTION_KEYWORDS


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
