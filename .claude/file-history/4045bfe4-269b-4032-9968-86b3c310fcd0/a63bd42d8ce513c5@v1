"""
Mentis OS v3.0 - Intervention Agent 单元测试
"""

import pytest
import sys
import os

# 添加项目路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from services.intervention_agent import (
    select_intervention,
    evaluate_intervention,
    INTERVENTION_STRATEGIES,
    EMOTION_INTERVENTION_PRIORITY,
    ENERGY_INTERVENTIONS,
)
from services.emotion_engine import EmotionResult


class TestInterventionStrategies:
    """干预策略测试"""

    def test_strategy_count(self):
        """测试策略数量"""
        assert len(INTERVENTION_STRATEGIES) >= 8

    def test_strategy_has_required_fields(self):
        """测试策略必要字段"""
        for strategy_id, strategy in INTERVENTION_STRATEGIES.items():
            assert "title" in strategy
            assert "title_en" in strategy
            assert "description" in strategy
            assert "duration_minutes" in strategy
            assert "momentum_reward" in strategy
            assert "triggers" in strategy

    def test_breathing_strategy(self):
        """测试呼吸策略"""
        strategy = INTERVENTION_STRATEGIES["breathing"]
        assert strategy["title"] == "呼吸调节"
        assert "anger" in strategy["triggers"]
        assert "anxiety" in strategy["triggers"]

    def test_grounding_strategy(self):
        """测试接地策略"""
        strategy = INTERVENTION_STRATEGIES["grounding"]
        assert strategy["title"] == "5-4-3-2-1 接地"
        assert "anxiety" in strategy["triggers"]


class TestInterventionSelection:
    """干预选择测试"""

    def _make_emotion(
        self,
        primary: str = "calm",
        intensity: int = 5,
        secondary: list = None,
    ) -> EmotionResult:
        return EmotionResult(
            primary=primary,
            intensity=intensity,
            secondary=secondary or [],
            confidence=0.8,
            energy_delta=0,
        )

    def test_select_for_anger(self):
        """测试愤怒时的干预选择"""
        emotion = self._make_emotion(primary="anger", intensity=7)
        result = select_intervention(
            emotion=emotion,
            energy_score=50,
            recent_interventions=[],
            preferences={},
        )
        assert result is not None
        assert result in EMOTION_INTERVENTION_PRIORITY["anger"]

    def test_select_for_anxiety(self):
        """测试焦虑时的干预选择"""
        emotion = self._make_emotion(primary="anxiety", intensity=7)
        result = select_intervention(
            emotion=emotion,
            energy_score=50,
            recent_interventions=[],
            preferences={},
        )
        assert result is not None
        assert result in EMOTION_INTERVENTION_PRIORITY["anxiety"]

    def test_select_for_low_energy(self):
        """测试低能量时的干预选择"""
        emotion = self._make_emotion(primary="calm", intensity=3)
        result = select_intervention(
            emotion=emotion,
            energy_score=25,
            recent_interventions=[],
            preferences={},
        )
        assert result is not None
        # 低能量应该推荐 movement 或 hydration
        assert result in ["movement", "hydration", "mindfulness"]

    def test_avoid_recent_interventions(self):
        """测试避免最近推荐的干预"""
        emotion = self._make_emotion(primary="anger", intensity=7)
        # 标记 breathing 为最近已推荐
        result = select_intervention(
            emotion=emotion,
            energy_score=50,
            recent_interventions=["breathing"],
            preferences={},
        )
        if result:
            assert result != "breathing" or len(EMOTION_INTERVENTION_PRIORITY["anger"]) == 1

    def test_prefer_user_preference(self):
        """测试优先用户偏好"""
        emotion = self._make_emotion(primary="anger", intensity=7)
        result = select_intervention(
            emotion=emotion,
            energy_score=50,
            recent_interventions=[],
            preferences={"preferred_interventions": ["reflection"]},
        )
        # 如果 reflection 在候选中，应该被选中
        if "reflection" in EMOTION_INTERVENTION_PRIORITY["anger"]:
            assert result == "reflection"

    def test_avoid_disliked(self):
        """测试避免不喜欢的干预"""
        emotion = self._make_emotion(primary="anger", intensity=7)
        result = select_intervention(
            emotion=emotion,
            energy_score=50,
            recent_interventions=[],
            preferences={"disliked_interventions": ["breathing"]},
        )
        if result:
            assert result != "breathing"


class TestInterventionEvaluation:
    """干预评估测试"""

    def _make_emotion(
        self,
        primary: str = "calm",
        intensity: int = 5,
    ) -> EmotionResult:
        return EmotionResult(
            primary=primary,
            intensity=intensity,
            secondary=[],
            confidence=0.8,
            energy_delta=0,
        )

    def test_no_intervention_for_calm(self):
        """测试平静且高能量时不触发干预"""
        emotion = self._make_emotion(primary="calm", intensity=3)
        # 注意：这个测试需要模拟数据库连接
        # 实际测试中需要 mock mentis_db
        pass

    def test_trigger_for_high_intensity(self):
        """测试高强度情绪触发干预"""
        emotion = self._make_emotion(primary="anger", intensity=8)
        # 强度 >= 6 应该触发干预
        assert emotion.intensity >= 6


class TestEmotionPriority:
    """情绪干预优先级测试"""

    def test_anger_priority(self):
        """测试愤怒优先级"""
        assert "anger" in EMOTION_INTERVENTION_PRIORITY
        priority = EMOTION_INTERVENTION_PRIORITY["anger"]
        assert "breathing" in priority

    def test_anxiety_priority(self):
        """测试焦虑优先级"""
        assert "anxiety" in EMOTION_INTERVENTION_PRIORITY
        priority = EMOTION_INTERVENTION_PRIORITY["anxiety"]
        assert "grounding" in priority

    def test_sadness_priority(self):
        """测试悲伤优先级"""
        assert "sadness" in EMOTION_INTERVENTION_PRIORITY
        priority = EMOTION_INTERVENTION_PRIORITY["sadness"]
        assert "gratitude" in priority


class TestEnergyInterventions:
    """能量干预测试"""

    def test_energy_thresholds(self):
        """测试能量阈值"""
        assert len(ENERGY_INTERVENTIONS) >= 3

    def test_low_energy_interventions(self):
        """测试低能量干预"""
        for threshold, interventions in ENERGY_INTERVENTIONS:
            if threshold <= 30:
                assert "movement" in interventions or "hydration" in interventions


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
