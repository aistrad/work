/**
 * Mentis OS v3.0 - Drizzle ORM Client
 *
 * 数据库连接和查询客户端
 */

import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";
import * as schema from "./schema";

// 环境变量
const DATABASE_URL = process.env.MENTIS_DB_URL || process.env.DATABASE_URL || "";

// 创建连接池
const pool = new Pool({
  connectionString: DATABASE_URL,
  max: 10,
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 5000,
});

// 创建 Drizzle 实例
export const db = drizzle(pool, { schema });

// 导出 schema
export * from "./schema";

// 类型导出
export type Database = typeof db;

// 辅助函数
export async function withTransaction<T>(
  callback: (tx: typeof db) => Promise<T>
): Promise<T> {
  return await db.transaction(async (tx) => {
    return await callback(tx as unknown as typeof db);
  });
}

// 健康检查
export async function checkConnection(): Promise<boolean> {
  try {
    await pool.query("SELECT 1");
    return true;
  } catch {
    return false;
  }
}

// 关闭连接池
export async function closePool(): Promise<void> {
  await pool.end();
}
