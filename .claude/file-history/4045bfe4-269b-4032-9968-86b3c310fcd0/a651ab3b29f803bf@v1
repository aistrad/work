from __future__ import annotations

from dataclasses import dataclass
from typing import Optional

from stores import mentis_db


@dataclass
class BehaviorMatch:
    matched: bool
    behavior: Optional[str]
    confidence: float
    auto_checkin: bool
    momentum_delta: int


BEHAVIOR_LIBRARY = [
    {
        "id": "meditation",
        "aliases": ["冥想", "呼吸练习", "静心", "打坐"],
        "momentum_reward": 1,
    },
    {
        "id": "hydration",
        "aliases": ["喝水", "补水", "喝了杯水"],
        "momentum_reward": 1,
    },
    {
        "id": "emotion_control",
        "aliases": ["控制情绪", "忍住", "没发火", "冷静下来"],
        "momentum_reward": 2,
    },
]


def match_behavior(text: str) -> BehaviorMatch:
    content = text or ""
    for behavior in BEHAVIOR_LIBRARY:
        if any(alias in content for alias in behavior["aliases"]):
            return BehaviorMatch(
                matched=True,
                behavior=behavior["id"],
                confidence=0.9,
                auto_checkin=True,
                momentum_delta=int(behavior["momentum_reward"]),
            )
    return BehaviorMatch(matched=False, behavior=None, confidence=0.0, auto_checkin=False, momentum_delta=0)


def update_stream_entry_behavior(*, stream_id: str, behavior: BehaviorMatch) -> None:
    if not behavior.matched or not behavior.behavior:
        return
    mentis_db.execute(
        """
        UPDATE stream_entry
        SET matched_behavior = %s,
            matched_confidence = %s
        WHERE id = %s
        """,
        (behavior.behavior, float(behavior.confidence), stream_id),
    )
