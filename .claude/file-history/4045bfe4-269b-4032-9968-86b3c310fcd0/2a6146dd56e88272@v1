from __future__ import annotations

from datetime import datetime, timedelta, timezone
from typing import Any, Dict, Optional

from stores import mentis_db
from services.emotion_engine import EmotionResult


def _now() -> datetime:
    return datetime.now(timezone.utc)


def create_action_task(
    *,
    user_id: str,
    task_type: str,
    title: str,
    description: str,
    momentum_reward: int = 1,
) -> Dict[str, Any]:
    expires_at = _now() + timedelta(minutes=30)
    row = mentis_db.execute_returning_one(
        """
        INSERT INTO action_task (user_id, type, title, description, status, expires_at, momentum_reward)
        VALUES (%s, %s, %s, %s, 'pending', %s, %s)
        RETURNING id, type, title, description, momentum_reward, expires_at
        """,
        (user_id, task_type, title, description, expires_at, momentum_reward),
    )
    return dict(row or {})


def evaluate_intervention(
    *,
    user_id: str,
    emotion: EmotionResult,
    energy_score: int,
) -> Optional[Dict[str, Any]]:
    if emotion.primary in {"anger", "anxiety"} or energy_score < 40:
        task = create_action_task(
            user_id=user_id,
            task_type="breathing",
            title="3-minute breathing",
            description="Slow inhale for 4s, hold 4s, exhale 6s. Repeat 3 times.",
            momentum_reward=1,
        )
        if task:
            return task
    return None
