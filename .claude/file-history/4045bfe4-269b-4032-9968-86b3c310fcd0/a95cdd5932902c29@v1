"""
Mentis OS v3.0 - Behavior Matcher 单元测试
"""

import pytest
import sys
import os

# 添加项目路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from services.behavior_matcher import (
    match_behavior,
    calculate_match_confidence,
    fuzzy_match,
    BEHAVIOR_LIBRARY,
    THRESHOLDS,
)


class TestBehaviorMatching:
    """行为匹配测试"""

    def test_match_meditation(self):
        """测试匹配冥想行为"""
        result = match_behavior("今天做了冥想练习")
        assert result.matched is True
        assert result.behavior == "meditation"

    def test_match_hydration(self):
        """测试匹配喝水行为"""
        result = match_behavior("刚刚喝了一杯水")
        assert result.matched is True
        assert result.behavior == "hydration"

    def test_match_exercise(self):
        """测试匹配运动行为"""
        result = match_behavior("今天跑步了30分钟")
        assert result.matched is True
        assert result.behavior == "exercise"

    def test_match_emotion_control(self):
        """测试匹配情绪控制行为"""
        result = match_behavior("忍住了，没发火")
        assert result.matched is True
        assert result.behavior == "emotion_control"

    def test_no_match(self):
        """测试无匹配"""
        result = match_behavior("今天天气不错")
        assert result.matched is False


class TestConfidenceThresholds:
    """置信度阈值测试"""

    def test_auto_checkin_threshold(self):
        """测试自动确认阈值"""
        result = match_behavior("我刚刚冥想了")
        if result.matched:
            assert result.confidence >= THRESHOLDS["CONFIRM_CARD"]

    def test_high_confidence_auto_checkin(self):
        """测试高置信度自动确认"""
        result = match_behavior("冥想了")
        if result.confidence >= THRESHOLDS["AUTO_CHECKIN"]:
            assert result.auto_checkin is True

    def test_medium_confidence_no_auto(self):
        """测试中等置信度不自动确认"""
        result = match_behavior("好像是冥想吧")
        if THRESHOLDS["CONFIRM_CARD"] <= result.confidence < THRESHOLDS["AUTO_CHECKIN"]:
            assert result.auto_checkin is False


class TestMomentumReward:
    """动量奖励测试"""

    def test_meditation_reward(self):
        """测试冥想奖励为1"""
        result = match_behavior("冥想了")
        if result.matched and result.behavior == "meditation":
            assert result.momentum_delta == 1

    def test_exercise_reward(self):
        """测试运动奖励为2"""
        result = match_behavior("今天运动了")
        if result.matched and result.behavior == "exercise":
            assert result.momentum_delta == 2

    def test_emotion_control_reward(self):
        """测试情绪控制奖励为2"""
        result = match_behavior("控制住情绪了")
        if result.matched and result.behavior == "emotion_control":
            assert result.momentum_delta == 2


class TestFuzzyMatching:
    """模糊匹配测试"""

    def test_fuzzy_match_similar(self):
        """测试相似字符串匹配"""
        score = fuzzy_match("冥想", "冥想练习")
        assert score > 0.5

    def test_fuzzy_match_different(self):
        """测试不同字符串匹配"""
        score = fuzzy_match("冥想", "跑步")
        assert score < 0.5

    def test_fuzzy_match_exact(self):
        """测试完全匹配"""
        score = fuzzy_match("冥想", "冥想")
        assert score == 1.0


class TestBehaviorLibrary:
    """行为库测试"""

    def test_behavior_count(self):
        """测试行为库数量"""
        assert len(BEHAVIOR_LIBRARY) >= 8

    def test_behavior_has_required_fields(self):
        """测试行为库必要字段"""
        for behavior in BEHAVIOR_LIBRARY:
            assert "id" in behavior
            assert "aliases" in behavior
            assert "patterns" in behavior
            assert "momentum_reward" in behavior

    def test_all_behaviors_have_aliases(self):
        """测试所有行为都有别名"""
        for behavior in BEHAVIOR_LIBRARY:
            assert len(behavior["aliases"]) > 0


class TestConfidenceCalculation:
    """置信度计算测试"""

    def test_exact_match_high_confidence(self):
        """测试精确匹配高置信度"""
        behavior = {"id": "test", "aliases": ["冥想"], "patterns": ["冥想了"]}
        conf = calculate_match_confidence("冥想了", behavior)
        assert conf >= 0.9

    def test_contains_match_medium_confidence(self):
        """测试包含匹配中等置信度"""
        behavior = {"id": "test", "aliases": ["冥想"], "patterns": []}
        conf = calculate_match_confidence("今天做了冥想", behavior)
        assert 0.7 <= conf <= 0.95

    def test_no_match_zero_confidence(self):
        """测试无匹配零置信度"""
        behavior = {"id": "test", "aliases": ["冥想"], "patterns": []}
        conf = calculate_match_confidence("今天天气不错", behavior)
        assert conf < 0.6


class TestThresholds:
    """阈值测试"""

    def test_thresholds_defined(self):
        """测试阈值定义"""
        assert "AUTO_CHECKIN" in THRESHOLDS
        assert "CONFIRM_CARD" in THRESHOLDS
        assert "PENDING_TASK_PRIORITY" in THRESHOLDS

    def test_auto_greater_than_confirm(self):
        """测试自动确认阈值大于确认卡阈值"""
        assert THRESHOLDS["AUTO_CHECKIN"] > THRESHOLDS["CONFIRM_CARD"]


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
