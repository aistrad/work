"""
Mentis OS v3.0 - 运势计算模块

基于八字命盘计算每日运势。
"""
from __future__ import annotations

from dataclasses import dataclass
from datetime import datetime, date, timezone
from typing import Any, Dict, List, Optional
import random

from .engine import (
    BaziChart, Pillar, calculate_bazi, get_today_pillar,
    TIAN_GAN, DI_ZHI, GAN_WUXING, ZHI_WUXING, WU_XING,
    _simple_day_pillar,
)


# 运势等级
FORTUNE_LEVELS = {
    "excellent": {"min": 85, "label": "大吉", "color": "#FFD700"},
    "good": {"min": 70, "label": "吉", "color": "#32CD32"},
    "normal": {"min": 50, "label": "平", "color": "#87CEEB"},
    "caution": {"min": 35, "label": "需注意", "color": "#FFA500"},
    "difficult": {"min": 0, "label": "不利", "color": "#FF6347"},
}

# 五行生克关系
WUXING_SHENG = {"木": "火", "火": "土", "土": "金", "金": "水", "水": "木"}  # 相生
WUXING_KE = {"木": "土", "土": "水", "水": "火", "火": "金", "金": "木"}  # 相克
WUXING_被KE = {"木": "金", "火": "水", "土": "木", "金": "火", "水": "土"}  # 被克

# 吉神
LUCKY_GODS = ["天乙贵人", "文昌", "驿马", "将星", "华盖", "天德", "月德"]
# 凶神
UNLUCKY_GODS = ["羊刃", "亡神", "劫煞", "灾煞", "六害"]

# 方位五行
DIRECTION_WUXING = {
    "东": "木", "西": "金", "南": "火", "北": "水", "中": "土",
    "东南": "木", "西南": "土", "东北": "土", "西北": "金",
}

# 颜色五行
COLOR_WUXING = {
    "绿色": "木", "青色": "木",
    "红色": "火", "紫色": "火", "橙色": "火",
    "黄色": "土", "棕色": "土",
    "白色": "金", "银色": "金",
    "黑色": "水", "蓝色": "水",
}


@dataclass
class FortuneResult:
    """运势结果"""
    score: int  # 1-100
    level: str  # excellent/good/normal/caution/difficult
    level_label: str  # 中文标签

    overall: str  # 总体描述
    career: str  # 事业
    relationship: str  # 关系
    health: str  # 健康
    wealth: str  # 财运

    suggestions: List[str]  # 建议
    avoid_items: List[str]  # 避忌

    lucky_color: str
    lucky_number: int
    lucky_direction: str

    today_pillar: str  # 今日干支
    day_master_relation: str  # 日主与今日的关系

    def to_dict(self) -> Dict[str, Any]:
        return {
            "score": self.score,
            "level": self.level,
            "level_label": self.level_label,
            "analysis": {
                "overall": self.overall,
                "career": self.career,
                "relationship": self.relationship,
                "health": self.health,
                "wealth": self.wealth,
            },
            "suggestions": self.suggestions,
            "avoid_items": self.avoid_items,
            "lucky": {
                "color": self.lucky_color,
                "number": self.lucky_number,
                "direction": self.lucky_direction,
            },
            "today_pillar": self.today_pillar,
            "day_master_relation": self.day_master_relation,
        }


def get_fortune_level(score: int) -> tuple[str, str]:
    """根据分数获取运势等级"""
    for level, info in FORTUNE_LEVELS.items():
        if score >= info["min"]:
            return level, info["label"]
    return "difficult", "不利"


def calculate_wuxing_relation(day_master_wx: str, today_wx: str) -> tuple[str, int]:
    """
    计算日主五行与今日五行的关系

    返回: (关系描述, 加分)
    """
    if day_master_wx == today_wx:
        return "同气相助", 10

    if WUXING_SHENG.get(today_wx) == day_master_wx:
        return "得生助力", 15

    if WUXING_SHENG.get(day_master_wx) == today_wx:
        return "耗泄精力", -10

    if WUXING_KE.get(day_master_wx) == today_wx:
        return "克制有利", 5

    if WUXING_被KE.get(day_master_wx) == today_wx:
        return "受克不利", -15

    return "平和", 0


def get_lucky_color(day_master_wx: str) -> str:
    """获取幸运颜色 (生我的颜色)"""
    # 找到生日主的五行
    for wx, sheng in WUXING_SHENG.items():
        if sheng == day_master_wx:
            # 返回该五行对应的颜色
            for color, cwx in COLOR_WUXING.items():
                if cwx == wx:
                    return color
    return "白色"


def get_lucky_direction(day_master_wx: str) -> str:
    """获取幸运方位 (生我的方位)"""
    for wx, sheng in WUXING_SHENG.items():
        if sheng == day_master_wx:
            for direction, dwx in DIRECTION_WUXING.items():
                if dwx == wx:
                    return direction
    return "东"


def get_lucky_number(day_master_wx: str) -> int:
    """获取幸运数字"""
    wuxing_numbers = {
        "木": [3, 8],
        "火": [2, 7],
        "土": [5, 0],
        "金": [4, 9],
        "水": [1, 6],
    }
    numbers = wuxing_numbers.get(day_master_wx, [1, 6])
    return random.choice(numbers)


def calculate_daily_fortune(
    bazi_chart: BaziChart,
    target_date: Optional[date] = None,
) -> FortuneResult:
    """
    计算每日运势

    Args:
        bazi_chart: 用户八字命盘
        target_date: 目标日期，默认今天

    Returns:
        FortuneResult: 运势结果
    """
    if target_date is None:
        target_date = date.today()

    # 获取目标日的日柱
    today_pillar = _simple_day_pillar(target_date.year, target_date.month, target_date.day)

    # 日主五行
    day_master_wx = bazi_chart.day_master_wuxing

    # 今日天干地支五行
    today_gan_wx = GAN_WUXING.get(today_pillar.gan, "")
    today_zhi_wx = ZHI_WUXING.get(today_pillar.zhi, "")

    # 基础分数
    base_score = 50

    # 天干关系
    gan_relation, gan_bonus = calculate_wuxing_relation(day_master_wx, today_gan_wx)
    base_score += gan_bonus

    # 地支关系
    zhi_relation, zhi_bonus = calculate_wuxing_relation(day_master_wx, today_zhi_wx)
    base_score += zhi_bonus // 2  # 地支影响减半

    # 五行平衡调整
    wuxing = bazi_chart.wuxing_analysis
    balance_bonus = (wuxing["balance_score"] - 50) // 5
    base_score += balance_bonus

    # 随机微调 (-5 到 +5)
    random.seed(f"{target_date.isoformat()}-{bazi_chart.day_master}")
    micro_adjust = random.randint(-5, 5)
    base_score += micro_adjust

    # 限制范围
    final_score = max(20, min(95, base_score))

    # 获取等级
    level, level_label = get_fortune_level(final_score)

    # 生成分析文案
    overall = _generate_overall(final_score, gan_relation, day_master_wx, today_gan_wx)
    career = _generate_career(final_score, day_master_wx)
    relationship = _generate_relationship(final_score, day_master_wx)
    health = _generate_health(final_score, wuxing)
    wealth = _generate_wealth(final_score, day_master_wx, today_gan_wx)

    # 生成建议
    suggestions = _generate_suggestions(final_score, day_master_wx, wuxing)
    avoid_items = _generate_avoid_items(final_score, day_master_wx, today_gan_wx)

    # 幸运元素
    lucky_color = get_lucky_color(day_master_wx)
    lucky_number = get_lucky_number(day_master_wx)
    lucky_direction = get_lucky_direction(day_master_wx)

    return FortuneResult(
        score=final_score,
        level=level,
        level_label=level_label,
        overall=overall,
        career=career,
        relationship=relationship,
        health=health,
        wealth=wealth,
        suggestions=suggestions,
        avoid_items=avoid_items,
        lucky_color=lucky_color,
        lucky_number=lucky_number,
        lucky_direction=lucky_direction,
        today_pillar=today_pillar.full,
        day_master_relation=gan_relation,
    )


def _generate_overall(score: int, relation: str, day_wx: str, today_wx: str) -> str:
    """生成总体描述"""
    if score >= 85:
        return f"今日运势极佳，{relation}，适合重要决策和行动。"
    elif score >= 70:
        return f"今日运势良好，{relation}，可以把握机会积极进取。"
    elif score >= 50:
        return f"今日运势平稳，{relation}，宜稳中求进，避免冒险。"
    elif score >= 35:
        return f"今日运势偏弱，{relation}，需谨慎行事，注意调整心态。"
    else:
        return f"今日运势欠佳，{relation}，建议保守行事，多休息养神。"


def _generate_career(score: int, day_wx: str) -> str:
    """生成事业描述"""
    if score >= 70:
        return "事业运势旺盛，适合推进重要项目，易获领导认可。"
    elif score >= 50:
        return "事业运势平稳，按计划执行即可，不宜大动作。"
    else:
        return "事业运势偏弱，宜低调行事，避免与人争执。"


def _generate_relationship(score: int, day_wx: str) -> str:
    """生成关系描述"""
    if score >= 70:
        return "人际关系和谐，适合社交活动，贵人运旺。"
    elif score >= 50:
        return "人际关系平稳，维持现状即可。"
    else:
        return "人际关系需注意，避免口舌之争，多倾听少表态。"


def _generate_health(score: int, wuxing: Dict[str, Any]) -> str:
    """生成健康描述"""
    weak_wx = wuxing.get("weakest", "")
    health_map = {
        "木": "肝胆",
        "火": "心脏",
        "土": "脾胃",
        "金": "肺部",
        "水": "肾脏",
    }
    organ = health_map.get(weak_wx, "身体")

    if score >= 70:
        return f"健康运势良好，精力充沛。"
    elif score >= 50:
        return f"健康运势平稳，注意{organ}保养。"
    else:
        return f"健康运势偏弱，需特别关注{organ}，多休息。"


def _generate_wealth(score: int, day_wx: str, today_wx: str) -> str:
    """生成财运描述"""
    if WUXING_KE.get(day_wx) == today_wx:
        return "财运较旺，有进账机会，可适度投资。"
    elif score >= 70:
        return "财运良好，收入稳定，可考虑理财。"
    elif score >= 50:
        return "财运平稳，量入为出，不宜冒险投资。"
    else:
        return "财运偏弱，控制开支，避免大额消费。"


def _generate_suggestions(score: int, day_wx: str, wuxing: Dict[str, Any]) -> List[str]:
    """生成建议"""
    suggestions = []

    if score >= 70:
        suggestions.append("把握今日好运，积极行动")
        suggestions.append("适合重要会议和决策")
    else:
        suggestions.append("保持平常心，稳中求进")
        suggestions.append("多休息，保持精力")

    # 根据五行缺失给建议
    missing = wuxing.get("missing", [])
    if "木" in missing:
        suggestions.append("多接触绿色植物，有助运势")
    if "水" in missing:
        suggestions.append("多喝水，保持水分充足")

    return suggestions[:4]


def _generate_avoid_items(score: int, day_wx: str, today_wx: str) -> List[str]:
    """生成避忌"""
    avoid = []

    if score < 50:
        avoid.append("避免重大决策")
        avoid.append("避免与人争执")

    if WUXING_被KE.get(day_wx) == today_wx:
        avoid.append("避免冲动行事")
        avoid.append("避免长途旅行")

    if not avoid:
        avoid.append("无特别避忌")

    return avoid[:3]
