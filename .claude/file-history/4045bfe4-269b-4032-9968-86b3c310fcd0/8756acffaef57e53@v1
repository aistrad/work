from __future__ import annotations

from uuid import UUID

from fastapi import APIRouter, WebSocket, WebSocketDisconnect

from stores import mentis_db


router = APIRouter(prefix="/v3", tags=["realtime"])


def _resolve_user_from_token(token: str) -> str | None:
    if not token:
        return None
    try:
        UUID(token)
    except Exception:
        return None
    row = mentis_db.fetch_one("SELECT id FROM mentis_user WHERE id = %s", (token,))
    return token if row else None


@router.websocket("/realtime")
async def realtime(ws: WebSocket):
    token = ws.query_params.get("token") or ""
    user_id = _resolve_user_from_token(token)
    if not user_id:
        await ws.close(code=4401)
        return

    await ws.accept()

    try:
        while True:
            msg = await ws.receive_json()
            msg_type = msg.get("type")
            if msg_type == "ping":
                await ws.send_json({"type": "pong"})
            elif msg_type == "subscribe":
                await ws.send_json({"type": "pong"})
            elif msg_type == "unsubscribe":
                await ws.send_json({"type": "pong"})
    except WebSocketDisconnect:
        return
