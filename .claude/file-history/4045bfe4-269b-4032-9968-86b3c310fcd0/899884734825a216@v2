"""
Mentis OS v3.0 - 八字计算引擎

基于 lunar_python 实现真太阳时八字计算。
"""
from __future__ import annotations

from dataclasses import dataclass, asdict
from datetime import datetime, timezone
from typing import Any, Dict, List, Optional, Tuple

# 天干
TIAN_GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
# 地支
DI_ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]
# 五行
WU_XING = ["木", "火", "土", "金", "水"]

# 天干五行映射
GAN_WUXING = {
    "甲": "木", "乙": "木",
    "丙": "火", "丁": "火",
    "戊": "土", "己": "土",
    "庚": "金", "辛": "金",
    "壬": "水", "癸": "水",
}

# 地支五行映射
ZHI_WUXING = {
    "子": "水", "丑": "土", "寅": "木", "卯": "木",
    "辰": "土", "巳": "火", "午": "火", "未": "土",
    "申": "金", "酉": "金", "戌": "土", "亥": "水",
}

# 地支藏干
ZHI_CANG_GAN = {
    "子": ["癸"],
    "丑": ["己", "癸", "辛"],
    "寅": ["甲", "丙", "戊"],
    "卯": ["乙"],
    "辰": ["戊", "乙", "癸"],
    "巳": ["丙", "庚", "戊"],
    "午": ["丁", "己"],
    "未": ["己", "丁", "乙"],
    "申": ["庚", "壬", "戊"],
    "酉": ["辛"],
    "戌": ["戊", "辛", "丁"],
    "亥": ["壬", "甲"],
}

# 十神关系
SHISHEN_MAP = {
    ("木", "木"): "比肩",
    ("木", "火"): "食神",
    ("木", "土"): "偏财",
    ("木", "金"): "七杀",
    ("木", "水"): "偏印",
    ("火", "木"): "偏印",
    ("火", "火"): "比肩",
    ("火", "土"): "食神",
    ("火", "金"): "偏财",
    ("火", "水"): "七杀",
    ("土", "木"): "七杀",
    ("土", "火"): "偏印",
    ("土", "土"): "比肩",
    ("土", "金"): "食神",
    ("土", "水"): "偏财",
    ("金", "木"): "偏财",
    ("金", "火"): "七杀",
    ("金", "土"): "偏印",
    ("金", "金"): "比肩",
    ("金", "水"): "食神",
    ("水", "木"): "食神",
    ("水", "火"): "偏财",
    ("水", "土"): "七杀",
    ("水", "金"): "偏印",
    ("水", "水"): "比肩",
}

DEFAULT_LOCATION = {
    "name": "北京",
    "longitude": 116.4074,
    "latitude": 39.9042,
    "timezone": "Asia/Shanghai",
}


@dataclass
class Pillar:
    """四柱之一"""
    gan: str  # 天干
    zhi: str  # 地支

    @property
    def full(self) -> str:
        return f"{self.gan}{self.zhi}"

    @property
    def gan_wuxing(self) -> str:
        return GAN_WUXING.get(self.gan, "")

    @property
    def zhi_wuxing(self) -> str:
        return ZHI_WUXING.get(self.zhi, "")

    @property
    def cang_gan(self) -> List[str]:
        return ZHI_CANG_GAN.get(self.zhi, [])

    def to_dict(self) -> Dict[str, Any]:
        return {
            "gan": self.gan,
            "zhi": self.zhi,
            "full": self.full,
            "gan_wuxing": self.gan_wuxing,
            "zhi_wuxing": self.zhi_wuxing,
            "cang_gan": self.cang_gan,
        }


@dataclass
class BaziChart:
    """八字命盘"""
    year_pillar: Pillar
    month_pillar: Pillar
    day_pillar: Pillar
    hour_pillar: Pillar

    birth_time: datetime
    location: Dict[str, Any]
    used_default_location: bool

    calculated_at: datetime

    @property
    def day_master(self) -> str:
        """日主（日干）"""
        return self.day_pillar.gan

    @property
    def day_master_wuxing(self) -> str:
        """日主五行"""
        return GAN_WUXING.get(self.day_master, "")

    @property
    def wuxing_count(self) -> Dict[str, int]:
        """五行统计"""
        count = {"木": 0, "火": 0, "土": 0, "金": 0, "水": 0}
        for pillar in [self.year_pillar, self.month_pillar, self.day_pillar, self.hour_pillar]:
            if pillar.gan_wuxing:
                count[pillar.gan_wuxing] += 1
            if pillar.zhi_wuxing:
                count[pillar.zhi_wuxing] += 1
        return count

    @property
    def wuxing_analysis(self) -> Dict[str, Any]:
        """五行分析"""
        count = self.wuxing_count
        total = sum(count.values())
        strongest = max(count, key=count.get)
        weakest = min(count, key=count.get)

        # 缺失的五行
        missing = [wx for wx, c in count.items() if c == 0]

        return {
            "count": count,
            "strongest": strongest,
            "weakest": weakest,
            "missing": missing,
            "balance_score": 100 - (max(count.values()) - min(count.values())) * 10,
        }

    def get_shishen(self, gan: str) -> str:
        """计算某天干相对于日主的十神"""
        day_wx = self.day_master_wuxing
        gan_wx = GAN_WUXING.get(gan, "")
        if not day_wx or not gan_wx:
            return ""
        return SHISHEN_MAP.get((day_wx, gan_wx), "")

    def to_dict(self) -> Dict[str, Any]:
        return {
            "year_pillar": self.year_pillar.to_dict(),
            "month_pillar": self.month_pillar.to_dict(),
            "day_pillar": self.day_pillar.to_dict(),
            "hour_pillar": self.hour_pillar.to_dict(),
            "day_master": self.day_master,
            "day_master_wuxing": self.day_master_wuxing,
            "wuxing_analysis": self.wuxing_analysis,
            "birth_time": self.birth_time.isoformat() if self.birth_time else None,
            "location": self.location,
            "used_default_location": self.used_default_location,
            "calculated_at": self.calculated_at.isoformat() if self.calculated_at else None,
        }


def ensure_location(location: Optional[Dict[str, Any]]) -> Tuple[Dict[str, Any], bool]:
    """确保位置信息完整"""
    if not location:
        return DEFAULT_LOCATION.copy(), True
    if "longitude" not in location or location.get("longitude") is None:
        merged = {**DEFAULT_LOCATION, **location}
        return merged, True
    return location, False


def calculate_bazi(
    year: int,
    month: int,
    day: int,
    hour: int,
    minute: int = 0,
    location: Optional[Dict[str, Any]] = None,
) -> BaziChart:
    """
    计算八字命盘

    Args:
        year: 出生年 (1900-2100)
        month: 出生月 (1-12)
        day: 出生日 (1-31)
        hour: 出生时 (0-23)
        minute: 出生分 (0-59)
        location: 出生地点 {name, longitude, latitude, timezone}

    Returns:
        BaziChart: 完整八字命盘
    """
    loc, used_default = ensure_location(location)

    try:
        from lunar_python import Solar

        solar = Solar.fromYmdHms(year, month, day, hour, minute, 0)
        lunar = solar.getLunar()
        ba_zi = lunar.getEightChar()

        year_pillar = Pillar(
            gan=ba_zi.getYear()[0] if len(ba_zi.getYear()) >= 2 else "",
            zhi=ba_zi.getYear()[1] if len(ba_zi.getYear()) >= 2 else "",
        )
        month_pillar = Pillar(
            gan=ba_zi.getMonth()[0] if len(ba_zi.getMonth()) >= 2 else "",
            zhi=ba_zi.getMonth()[1] if len(ba_zi.getMonth()) >= 2 else "",
        )
        day_pillar = Pillar(
            gan=ba_zi.getDay()[0] if len(ba_zi.getDay()) >= 2 else "",
            zhi=ba_zi.getDay()[1] if len(ba_zi.getDay()) >= 2 else "",
        )
        hour_pillar = Pillar(
            gan=ba_zi.getTime()[0] if len(ba_zi.getTime()) >= 2 else "",
            zhi=ba_zi.getTime()[1] if len(ba_zi.getTime()) >= 2 else "",
        )

    except ImportError:
        # lunar_python 未安装时使用简化算法
        year_pillar = _simple_year_pillar(year)
        month_pillar = _simple_month_pillar(year, month)
        day_pillar = _simple_day_pillar(year, month, day)
        hour_pillar = _simple_hour_pillar(day_pillar.gan, hour)

    birth_time = datetime(year, month, day, hour, minute, tzinfo=timezone.utc)

    return BaziChart(
        year_pillar=year_pillar,
        month_pillar=month_pillar,
        day_pillar=day_pillar,
        hour_pillar=hour_pillar,
        birth_time=birth_time,
        location=loc,
        used_default_location=used_default,
        calculated_at=datetime.now(timezone.utc),
    )


def _simple_year_pillar(year: int) -> Pillar:
    """简化年柱计算"""
    gan_idx = (year - 4) % 10
    zhi_idx = (year - 4) % 12
    return Pillar(gan=TIAN_GAN[gan_idx], zhi=DI_ZHI[zhi_idx])


def _simple_month_pillar(year: int, month: int) -> Pillar:
    """简化月柱计算"""
    # 年干决定月干起点
    year_gan_idx = (year - 4) % 10
    month_gan_start = (year_gan_idx % 5) * 2
    gan_idx = (month_gan_start + month - 1) % 10
    zhi_idx = (month + 1) % 12
    return Pillar(gan=TIAN_GAN[gan_idx], zhi=DI_ZHI[zhi_idx])


def _simple_day_pillar(year: int, month: int, day: int) -> Pillar:
    """简化日柱计算 (使用公式近似)"""
    # 简化的日柱计算公式
    c = year // 100
    y = year % 100
    m = month
    d = day
    if m <= 2:
        m += 12
        y -= 1

    g = 4 * c + c // 4 + 5 * y + y // 4 + 3 * (m + 1) // 5 + d - 3
    gan_idx = (g - 1) % 10

    z = 8 * c + c // 4 + 5 * y + y // 4 + 3 * (m + 1) // 5 + d + 7 + (0 if m % 2 == 1 else 6)
    zhi_idx = (z - 1) % 12

    return Pillar(gan=TIAN_GAN[gan_idx], zhi=DI_ZHI[zhi_idx])


def _simple_hour_pillar(day_gan: str, hour: int) -> Pillar:
    """简化时柱计算"""
    # 时辰地支
    zhi_idx = (hour + 1) // 2 % 12

    # 日干决定时干起点
    day_gan_idx = TIAN_GAN.index(day_gan) if day_gan in TIAN_GAN else 0
    hour_gan_start = (day_gan_idx % 5) * 2
    gan_idx = (hour_gan_start + zhi_idx) % 10

    return Pillar(gan=TIAN_GAN[gan_idx], zhi=DI_ZHI[zhi_idx])


def get_today_pillar() -> Pillar:
    """获取今日日柱"""
    now = datetime.now()
    return _simple_day_pillar(now.year, now.month, now.day)
