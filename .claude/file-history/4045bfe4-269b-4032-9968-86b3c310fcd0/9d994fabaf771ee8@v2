from __future__ import annotations

import re
from dataclasses import dataclass
from typing import List, Tuple


@dataclass
class EmotionResult:
    primary: str
    intensity: int
    secondary: List[str]
    confidence: float
    energy_delta: int


# 规格定义: 8 种主情绪
EMOTION_TAXONOMY = {
    "primary": ["joy", "sadness", "anger", "fear", "surprise", "disgust", "anxiety", "calm"],
    "secondary": [
        "frustration", "helplessness", "excitement", "pride", "guilt", "shame",
        "loneliness", "gratitude", "hope", "relief", "jealousy", "contempt"
    ],
}

# 主情绪关键词 (扩展版)
EMOTION_KEYWORDS = {
    "joy": ["开心", "快乐", "高兴", "喜悦", "兴奋", "棒", "太好了", "哈哈", "嘿嘿", "爽", "赞", "真好", "太棒", "超开心"],
    "sadness": ["难过", "伤心", "沮丧", "低落", "失落", "哭", "难受", "心痛", "悲伤", "郁闷", "不开心"],
    "anger": ["生气", "愤怒", "气死", "烦", "火大", "恼火", "暴怒", "怒", "气炸", "受不了", "操", "靠"],
    "fear": ["害怕", "恐惧", "担心", "畏惧", "怕", "紧张", "惶恐", "不敢"],
    "surprise": ["惊讶", "震惊", "没想到", "意外", "居然", "竟然", "天哪", "我靠", "卧槽"],
    "disgust": ["恶心", "厌恶", "反感", "讨厌", "烦死", "受够"],
    "anxiety": ["焦虑", "紧张", "不安", "压力大", "担忧", "慌", "忐忑", "心烦", "头大"],
    "calm": ["平静", "放松", "安心", "安静", "淡定", "舒服", "安宁", "惬意", "从容"],
}

# 二级情绪关键词
SECONDARY_KEYWORDS = {
    "frustration": ["烦", "郁闷", "受够", "无语", "崩溃", "服了"],
    "helplessness": ["无力", "无奈", "没办法", "无能为力", "束手无策"],
    "excitement": ["激动", "期待", "迫不及待", "兴奋"],
    "pride": ["骄傲", "自豪", "了不起", "厉害"],
    "guilt": ["内疚", "愧疚", "对不起", "抱歉", "惭愧"],
    "shame": ["丢人", "丢脸", "尴尬", "难为情"],
    "loneliness": ["孤独", "寂寞", "孤单", "一个人"],
    "gratitude": ["感谢", "感激", "谢谢", "多亏"],
    "hope": ["希望", "期待", "盼望", "憧憬"],
    "relief": ["松了口气", "放心", "如释重负", "终于"],
    "jealousy": ["嫉妒", "羡慕", "眼红"],
    "contempt": ["鄙视", "看不起", "瞧不上"],
}

# 强度修饰词
INTENSITY_MODIFIERS = {
    "very_high": ["非常", "特别", "极度", "超级", "太", "真的", "简直", "完全"],  # +3
    "high": ["很", "好", "挺", "相当", "比较"],  # +2
    "low": ["有点", "有些", "稍微", "略微", "一点"],  # -1
}

# 规格定义: 能量映射
ENERGY_MAP = {
    "joy": (2, 5),
    "sadness": (-4, -2),
    "anger": (-5, -3),
    "fear": (-4, -2),
    "surprise": (-1, 1),
    "disgust": (-3, -2),
    "anxiety": (-4, -2),
    "calm": (0, 1),
}


def calculate_energy_delta(emotion: str, intensity: int) -> int:
    """根据情绪和强度计算能量变化"""
    min_v, max_v = ENERGY_MAP.get(emotion, (0, 0))
    ratio = max(1, min(10, intensity)) / 10
    if max_v > 0:
        return round(min_v + (max_v - min_v) * ratio)
    return round(max_v + (min_v - max_v) * ratio)


def count_exclamations(text: str) -> int:
    """计算感叹号数量"""
    return text.count("!") + text.count("！")


def has_repeated_chars(text: str) -> bool:
    """检测是否有重复字符 (如 "啊啊啊", "好好好")"""
    return bool(re.search(r'(.)\1{2,}', text))


def has_caps_emphasis(text: str) -> bool:
    """检测是否有大写强调 (英文)"""
    words = re.findall(r'[A-Z]{2,}', text)
    return len(words) > 0


def calculate_keyword_density(text: str, emotion: str) -> float:
    """计算关键词密度"""
    keywords = EMOTION_KEYWORDS.get(emotion, [])
    if not keywords or not text:
        return 0.0
    matches = sum(1 for k in keywords if k in text)
    return min(1.0, matches / max(len(keywords), 1))


def get_intensity_modifier(text: str) -> int:
    """根据修饰词调整强度"""
    modifier = 0
    for level, words in INTENSITY_MODIFIERS.items():
        if any(w in text for w in words):
            if level == "very_high":
                modifier = 3
                break
            elif level == "high":
                modifier = 2
            elif level == "low":
                modifier = -1
    return modifier


def calculate_intensity(text: str, emotion: str, matched_keywords: List[str]) -> int:
    """
    计算情绪强度 (1-10)

    规格要求: 返回 1-10 范围的强度值
    """
    if not matched_keywords:
        return 3  # 无匹配时的默认低强度

    base = 5  # 基础强度

    # 感叹号调整 (+1 per exclamation, max +2)
    exclamation_bonus = min(count_exclamations(text), 2)
    base += exclamation_bonus

    # 重复字符调整 (+1)
    if has_repeated_chars(text):
        base += 1

    # 大写强调调整 (+1)
    if has_caps_emphasis(text):
        base += 1

    # 修饰词调整 (-1 to +3)
    base += get_intensity_modifier(text)

    # 关键词密度调整 (+0 to +1)
    density = calculate_keyword_density(text, emotion)
    base += int(density * 2)

    # 多关键词匹配 (+1 per extra match, max +2)
    if len(matched_keywords) > 1:
        base += min(len(matched_keywords) - 1, 2)

    return max(1, min(10, base))


def calculate_confidence(text: str, matched_keywords: List[str], emotion: str) -> float:
    """
    动态计算置信度

    规格要求: 根据匹配质量返回 0.3-0.95 的置信度
    """
    if not matched_keywords:
        return 0.3

    base = 0.5

    # 匹配关键词数量 (+0.1 per match, max +0.25)
    base += min(len(matched_keywords) * 0.1, 0.25)

    # 关键词密度 (+0 to +0.1)
    density = calculate_keyword_density(text, emotion)
    base += density * 0.1

    # 感叹号增强 (+0.05)
    if count_exclamations(text) > 0:
        base += 0.05

    # 修饰词明确性 (+0.05)
    if get_intensity_modifier(text) != 0:
        base += 0.05

    return min(0.95, round(base, 2))


def detect_secondary_emotions(text: str, primary: str) -> List[str]:
    """
    检测二级情绪

    规格要求: 返回与主情绪不同的二级情绪列表 (最多 3 个)
    """
    secondary = []
    content = text.lower()

    for emotion, keywords in SECONDARY_KEYWORDS.items():
        # 排除与主情绪重叠的情绪
        if emotion == primary:
            continue
        if any(k in content for k in keywords):
            secondary.append(emotion)
            if len(secondary) >= 3:
                break

    return secondary


def detect_emotion(text: str) -> EmotionResult:
    """
    检测情绪

    规格要求:
    - 主情绪: 8 种 (joy, sadness, anger, fear, surprise, disgust, anxiety, calm)
    - 强度: 1-10
    - 信心度: 动态计算
    - 二级情绪: 最多 3 个
    """
    content = (text or "").lower()
    primary = "calm"
    matched_keywords: List[str] = []

    # 检测主情绪
    for emotion, keywords in EMOTION_KEYWORDS.items():
        matches = [k for k in keywords if k in content]
        if matches:
            # 选择匹配最多关键词的情绪
            if len(matches) > len(matched_keywords):
                primary = emotion
                matched_keywords = matches

    # 计算强度 (1-10)
    intensity = calculate_intensity(content, primary, matched_keywords)

    # 计算置信度 (动态)
    confidence = calculate_confidence(content, matched_keywords, primary)

    # 检测二级情绪
    secondary = detect_secondary_emotions(content, primary)

    # 计算能量变化
    energy_delta = calculate_energy_delta(primary, intensity)

    return EmotionResult(
        primary=primary,
        intensity=intensity,
        secondary=secondary,
        confidence=confidence,
        energy_delta=energy_delta,
    )
