"""
Mentis OS v3.0 - Whisper 语音识别服务

支持使用 OpenAI Whisper API 进行语音转文字。
"""
from __future__ import annotations

import base64
import io
import os
from dataclasses import dataclass
from typing import Any, Dict, Optional

import httpx


# 配置
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY", "")
WHISPER_MODEL = os.getenv("MENTIS_WHISPER_MODEL", "whisper-1")
WHISPER_API_URL = "https://api.openai.com/v1/audio/transcriptions"


@dataclass
class TranscriptionResult:
    """语音识别结果"""
    text: str
    language: Optional[str]
    duration: Optional[float]
    confidence: Optional[float]

    def to_dict(self) -> Dict[str, Any]:
        return {
            "text": self.text,
            "language": self.language,
            "duration": self.duration,
            "confidence": self.confidence,
        }


class WhisperError(Exception):
    """Whisper 服务错误"""
    def __init__(self, code: str, message: str):
        self.code = code
        self.message = message
        super().__init__(message)


async def transcribe_audio(
    audio_data: bytes,
    filename: str = "audio.webm",
    language: Optional[str] = None,
) -> TranscriptionResult:
    """
    使用 Whisper API 转录音频

    Args:
        audio_data: 音频数据（bytes）
        filename: 文件名（用于确定格式）
        language: 语言代码（如 "zh", "en"）

    Returns:
        TranscriptionResult: 识别结果

    Raises:
        WhisperError: 识别失败
    """
    if not OPENAI_API_KEY:
        raise WhisperError("whisper/no-api-key", "未配置 OpenAI API Key")

    # 构建请求
    files = {
        "file": (filename, io.BytesIO(audio_data), _get_mime_type(filename)),
    }
    data = {
        "model": WHISPER_MODEL,
        "response_format": "verbose_json",
    }
    if language:
        data["language"] = language

    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
    }

    async with httpx.AsyncClient(timeout=60.0) as client:
        try:
            response = await client.post(
                WHISPER_API_URL,
                headers=headers,
                files=files,
                data=data,
            )
            response.raise_for_status()

            result = response.json()

            return TranscriptionResult(
                text=result.get("text", ""),
                language=result.get("language"),
                duration=result.get("duration"),
                confidence=None,  # Whisper API 不返回置信度
            )

        except httpx.HTTPStatusError as e:
            error_body = e.response.text
            raise WhisperError(
                "whisper/api-error",
                f"Whisper API 错误: {e.response.status_code} - {error_body[:200]}",
            )
        except Exception as e:
            raise WhisperError("whisper/error", f"语音识别失败: {str(e)}")


async def transcribe_base64(
    base64_audio: str,
    filename: str = "audio.webm",
    language: Optional[str] = None,
) -> TranscriptionResult:
    """
    转录 base64 编码的音频

    Args:
        base64_audio: base64 编码的音频数据
        filename: 文件名
        language: 语言代码

    Returns:
        TranscriptionResult: 识别结果
    """
    try:
        # 移除可能的 data URL 前缀
        if "," in base64_audio:
            base64_audio = base64_audio.split(",", 1)[1]

        audio_data = base64.b64decode(base64_audio)
        return await transcribe_audio(audio_data, filename, language)
    except Exception as e:
        if isinstance(e, WhisperError):
            raise
        raise WhisperError("whisper/decode-error", f"音频解码失败: {str(e)}")


def _get_mime_type(filename: str) -> str:
    """根据文件名获取 MIME 类型"""
    ext = filename.lower().split(".")[-1]
    mime_types = {
        "mp3": "audio/mpeg",
        "mp4": "audio/mp4",
        "m4a": "audio/m4a",
        "wav": "audio/wav",
        "webm": "audio/webm",
        "ogg": "audio/ogg",
        "flac": "audio/flac",
    }
    return mime_types.get(ext, "audio/webm")


# 同步版本（供非异步环境使用）
def transcribe_audio_sync(
    audio_data: bytes,
    filename: str = "audio.webm",
    language: Optional[str] = None,
) -> TranscriptionResult:
    """
    同步版本的语音识别

    Args:
        audio_data: 音频数据
        filename: 文件名
        language: 语言代码

    Returns:
        TranscriptionResult: 识别结果
    """
    if not OPENAI_API_KEY:
        raise WhisperError("whisper/no-api-key", "未配置 OpenAI API Key")

    files = {
        "file": (filename, io.BytesIO(audio_data), _get_mime_type(filename)),
    }
    data = {
        "model": WHISPER_MODEL,
        "response_format": "verbose_json",
    }
    if language:
        data["language"] = language

    headers = {
        "Authorization": f"Bearer {OPENAI_API_KEY}",
    }

    with httpx.Client(timeout=60.0) as client:
        try:
            response = client.post(
                WHISPER_API_URL,
                headers=headers,
                files=files,
                data=data,
            )
            response.raise_for_status()

            result = response.json()

            return TranscriptionResult(
                text=result.get("text", ""),
                language=result.get("language"),
                duration=result.get("duration"),
                confidence=None,
            )

        except httpx.HTTPStatusError as e:
            error_body = e.response.text
            raise WhisperError(
                "whisper/api-error",
                f"Whisper API 错误: {e.response.status_code} - {error_body[:200]}",
            )
        except Exception as e:
            raise WhisperError("whisper/error", f"语音识别失败: {str(e)}")
