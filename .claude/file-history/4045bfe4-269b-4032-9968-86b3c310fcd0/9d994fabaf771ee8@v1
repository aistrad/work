from __future__ import annotations

from dataclasses import dataclass
from typing import List


@dataclass
class EmotionResult:
    primary: str
    intensity: int
    secondary: List[str]
    confidence: float
    energy_delta: int


EMOTION_KEYWORDS = {
    "joy": ["开心", "快乐", "高兴", "喜悦", "兴奋", "棒", "太好了"],
    "sadness": ["难过", "伤心", "沮丧", "低落", "失落"],
    "anger": ["生气", "愤怒", "气死", "烦", "火大", "恼火"],
    "fear": ["害怕", "恐惧", "担心", "畏惧"],
    "surprise": ["惊讶", "震惊", "没想到", "意外"],
    "disgust": ["恶心", "厌恶", "反感", "讨厌"],
    "anxiety": ["焦虑", "紧张", "不安", "压力大"],
    "calm": ["平静", "放松", "安心", "安静", "淡定"],
}

ENERGY_MAP = {
    "joy": (2, 5),
    "sadness": (-4, -2),
    "anger": (-5, -3),
    "fear": (-4, -2),
    "surprise": (-1, 1),
    "disgust": (-3, -2),
    "anxiety": (-4, -2),
    "calm": (0, 1),
}


def calculate_energy_delta(emotion: str, intensity: int) -> int:
    min_v, max_v = ENERGY_MAP.get(emotion, (0, 0))
    ratio = max(1, min(10, intensity)) / 10
    if max_v > 0:
        return round(min_v + (max_v - min_v) * ratio)
    return round(max_v + (min_v - max_v) * ratio)


def detect_emotion(text: str) -> EmotionResult:
    content = (text or "").lower()
    primary = "calm"
    intensity = 4
    for emotion, keywords in EMOTION_KEYWORDS.items():
        if any(k in content for k in keywords):
            primary = emotion
            intensity = 7 if "!" in content or "！" in content else 6
            break
    energy_delta = calculate_energy_delta(primary, intensity)
    return EmotionResult(
        primary=primary,
        intensity=intensity,
        secondary=[],
        confidence=0.7,
        energy_delta=energy_delta,
    )
