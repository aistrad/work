# Proactive Reminders Configuration Schema
# 文件位置: apps/api/skills/{skill_id}/reminders.yaml

$schema: "http://json-schema.org/draft-07/schema#"
title: Skill Reminders Configuration
description: 定义 Skill 的主动推送配置

type: object
required:
  - skill_id
  - enabled
  - reminders

properties:
  skill_id:
    type: string
    description: Skill 标识符，与 SKILL.md 的 id 一致
    examples: ["bazi", "zodiac", "tarot"]

  enabled:
    type: boolean
    description: 是否启用该 Skill 的主动推送
    default: true

  reminders:
    type: array
    description: 提醒配置列表
    items:
      $ref: "#/definitions/Reminder"

definitions:
  Reminder:
    type: object
    required:
      - id
      - name
      - trigger
      - content
    properties:
      id:
        type: string
        description: 提醒唯一标识
        pattern: "^[a-z_]+$"
        examples: ["daily_fortune", "dayun_transition"]

      name:
        type: string
        description: 提醒名称（中文）
        examples: ["每日运势", "大运交接"]

      trigger:
        $ref: "#/definitions/Trigger"

      content:
        $ref: "#/definitions/Content"

      priority:
        type: string
        enum: ["high", "medium", "low"]
        default: "medium"
        description: 推送优先级

  Trigger:
    type: object
    required:
      - type
    properties:
      type:
        type: string
        enum: ["time_based", "event_based", "threshold_based"]
        description: 触发器类型

    oneOf:
      - $ref: "#/definitions/TimeBasedTrigger"
      - $ref: "#/definitions/EventBasedTrigger"
      - $ref: "#/definitions/ThresholdBasedTrigger"

  TimeBasedTrigger:
    type: object
    properties:
      type:
        const: "time_based"
      schedule:
        type: string
        description: Cron 表达式
        examples: ["0 4 * * *", "0 9 * * 1"]

  EventBasedTrigger:
    type: object
    properties:
      type:
        const: "event_based"
      event:
        type: string
        description: 事件类型
        enum:
          - dayun_change      # 大运交接
          - liunian_change    # 流年交接
          - solar_term        # 节气
          - birthday          # 生日
          - lunar_birthday    # 农历生日
      advance_days:
        type: array
        items:
          type: integer
        description: 提前多少天提醒
        examples: [[30, 7, 0], [7, 1, 0]]

  ThresholdBasedTrigger:
    type: object
    properties:
      type:
        const: "threshold_based"
      metric:
        type: string
        description: 检测的指标
        examples: ["daily_fortune_score", "health_score"]
      condition:
        type: string
        enum: ["<", ">", "<=", ">=", "=="]
        description: 比较条件
      threshold:
        type: number
        description: 阈值
      cooldown_days:
        type: integer
        default: 7
        description: 触发后的冷却天数

  Content:
    type: object
    properties:
      generator:
        type: string
        description: 内容生成器，支持复用 rules/ 文件
        examples: ["rules/daily-fortune.md", "rules/dayun-transition.md"]

      card_type:
        type: string
        description: 前端卡片类型
        enum:
          - DailyFortuneCard
          - InsightCard
          - AlertCard

      suggested_prompt:
        type: string
        description: 对话引导提示语
        examples: ["想了解今天的运势详情？"]

      quick_actions:
        type: array
        description: 快捷操作按钮
        items:
          type: object
          required:
            - label
            - prompt
          properties:
            label:
              type: string
              description: 按钮文本
              examples: ["今日宜忌", "开运建议"]
            prompt:
              type: string
              description: 点击后发送的消息
              examples: ["今天适合做什么？"]

# 完整示例
examples:
  - skill_id: bazi
    enabled: true
    reminders:
      - id: daily_fortune
        name: 每日运势
        trigger:
          type: time_based
          schedule: "0 4 * * *"
        content:
          generator: rules/daily-fortune.md
          card_type: DailyFortuneCard
          suggested_prompt: "想了解今天的运势详情？"
          quick_actions:
            - label: "今日宜忌"
              prompt: "今天适合做什么？有什么需要注意的？"
            - label: "开运建议"
              prompt: "今天如何提升运势？"
        priority: medium

      - id: dayun_transition
        name: 大运交接
        trigger:
          type: event_based
          event: dayun_change
          advance_days: [30, 7, 0]
        content:
          generator: rules/dayun-transition.md
          card_type: InsightCard
          suggested_prompt: "想了解新大运的详细分析？"
          quick_actions:
            - label: "大运解读"
              prompt: "请详细分析我即将进入的新大运"
        priority: high
