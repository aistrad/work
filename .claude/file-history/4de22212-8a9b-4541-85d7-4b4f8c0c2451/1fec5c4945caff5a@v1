# Skill 设计规范

版本: 1.0 | 日期: 2026-01-18
基于: Vercel Agent Skills 设计模式

---

## 1. 概述

本规范定义了 VibeLife 平台 Skill 的设计标准，采用 **Agentic + 渐进式加载** 架构。

### 1.1 核心原则

| 原则 | 说明 |
|-----|------|
| **Agentic 决策** | LLM 自主理解意图、规划步骤、调用工具 |
| **渐进式加载** | SKILL.md 只放索引，详细规则按需加载 |
| **优先级驱动** | 能力按 CRITICAL/HIGH/MEDIUM/LOW 分级 |
| **知识驱动** | 通过 RAG 检索专业知识，而非硬编码 |
| **工具优先** | 用工具展示结果，而非纯文字 |

### 1.2 与传统 Scenario 架构对比

| 维度 | 传统 Scenario 架构 | Agentic 架构 |
|-----|-------------------|-------------|
| 场景定义 | 100+ 预定义 .md 文件 | 0 个，LLM 自主决策 |
| 路由方式 | 触发词关键词匹配 | LLM 语义理解 |
| 服务流程 | 预定义 SOP 步骤 | LLM 根据分析规则自主规划 |
| 知识使用 | Scenario 指定检索 | 按需语义检索 |
| 灵活性 | 低（只能处理预定义场景） | 高（任意组合） |
| 维护成本 | 高（每个场景都要维护） | 低（只维护 SKILL.md + 知识库） |

---

## 2. 目录结构

### 2.1 标准结构

```
skills/{skill_id}/
├── SKILL.md                    # 核心定义（< 200 行）
├── rules/                       # 分析规则（按需加载）
│   ├── _index.md               # 规则分类索引
│   ├── {capability-1}.md       # 能力 1 的分析规则
│   ├── {capability-2}.md       # 能力 2 的分析规则
│   └── ...
├── tools/
│   ├── tools.yaml              # 工具定义
│   └── handlers.py             # 工具执行器
└── metadata.json               # 元数据（可选）
```

### 2.2 文件说明

| 文件 | 必须 | 说明 |
|-----|------|------|
| `SKILL.md` | 是 | 核心定义，< 200 行 |
| `rules/*.md` | 是 | 分析规则，按需加载 |
| `tools/tools.yaml` | 是 | 工具定义 |
| `tools/handlers.py` | 是 | 工具执行器 |
| `metadata.json` | 否 | 元数据（版本、作者等） |

### 2.3 命名规范

| 类型 | 规范 | 示例 |
|-----|------|------|
| Skill 目录 | kebab-case | `bazi`, `zodiac`, `career` |
| SKILL.md | 大写 | `SKILL.md` |
| Rule 文件 | kebab-case | `basic-reading.md`, `career.md` |
| 工具名称 | snake_case | `show_bazi_chart`, `search_db` |

---

## 3. SKILL.md 规范

### 3.1 结构模板

```markdown
---
name: {skill-name}
description: {一句话描述 + 触发词。Max 200 chars}
---

# {Skill Name}

## 专家身份
[~20 行，核心理念和知识来源]

## 核心能力索引
[能力表格，包含优先级和规则文件路径]

## 工具快速参考
[工具表格，~30 行]

## 知识检索策略
[检索模式表格，~20 行]

## 服务原则
[5 条原则，~15 行]

## 伦理边界
[禁止事项 + 表达原则，~20 行]

## 详细文档
[指向 rules/*.md 的链接]
```

### 3.2 行数限制

| 部分 | 行数限制 | 说明 |
|-----|---------|------|
| Frontmatter | ~10 行 | name + description |
| 专家身份 | ~20 行 | 核心理念、知识来源 |
| 核心能力索引 | ~30 行 | 能力表格 |
| 工具快速参考 | ~30 行 | 工具表格 |
| 知识检索策略 | ~20 行 | 检索模式 |
| 服务原则 | ~15 行 | 5 条原则 |
| 伦理边界 | ~20 行 | 禁止事项 |
| **总计** | **< 200 行** | 严格限制 |

### 3.3 Frontmatter 规范

```yaml
---
name: {skill-name}           # kebab-case，max 64 chars
description: |               # 一句话描述 + 触发词，max 200 chars
  {描述}。触发词：{词1}、{词2}、{词3}。
---
```

**示例**：
```yaml
---
name: bazi
description: 八字命理专家。融汇《滴天髓》《穷通宝鉴》《子平真诠》的命理分析。触发词：八字、命盘、算命、事业运势、感情婚姻、财运、大运流年。
---
```

### 3.4 核心能力索引规范

```markdown
## 核心能力索引

| 能力 | 优先级 | 规则文件 | 触发场景 |
|-----|-------|---------|---------|
| {能力名} | {CRITICAL/HIGH/MEDIUM/LOW} | `rules/{file}.md` | {触发场景描述} |
```

**优先级定义**：

| 优先级 | 说明 | 使用场景 |
|-------|------|---------|
| CRITICAL | 最高频、最基础的能力 | 命盘解读、本命盘分析 |
| HIGH | 高频需求 | 事业分析、感情分析 |
| MEDIUM | 中频需求 | 财运分析、运势预测 |
| LOW | 低频需求 | 合婚配对、择日选时 |

### 3.5 工具快速参考规范

```markdown
## 工具快速参考

### {工具类别}
| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `{tool_name}` | {用途} | {调用时机} |
```

**工具类别**：
- 信息收集（collect）
- 计算工具（compute）
- 展示工具（display）
- 检索工具（search）

### 3.6 知识检索策略规范

```markdown
## 知识检索策略

| 检索类型 | Query 模式 | 示例 |
|---------|-----------|------|
| 理论知识 | "{概念} 理论 原理" | "{主题} 理论 原理" |
| 分析方法 | "{主题} 分析方法" | "{主题} 分析方法 步骤" |
| 规则依据 | "{主题} 规则 原则" | "{主题} 规则 原则" |
| 参考案例 | "{特征} 案例" | "{特征} 案例" |
```

---

## 4. Rule 文件规范

### 4.1 结构模板

```markdown
---
id: {capability-id}
name: {能力名称}
impact: {CRITICAL|HIGH|MEDIUM|LOW}
impactDescription: {影响说明}
tags: {触发词列表，逗号分隔}
---

# {能力名称}框架

## 适用场景
[触发场景描述]

## 分析要点
[分析步骤表格，包含检索 Query]

## 输出要求
[必须调用的工具和输出格式]

## 常见问题
[FAQ，可选]
```

### 4.2 Frontmatter 规范

```yaml
---
id: career                           # kebab-case
name: 事业分析                        # 中文名称
impact: HIGH                         # CRITICAL/HIGH/MEDIUM/LOW
impactDescription: 高频需求，影响用户职业决策
tags: 事业, 职业, 跳槽, 升职, 工作    # 触发词
---
```

### 4.3 分析要点表格规范

```markdown
## 分析要点

| 步骤 | 分析要点 | 检索 Query | 优先级 |
|-----|---------|-----------|-------|
| 1 | {要点} | "{query}" | 必须/推荐/可选 |
| 2 | {要点} | "{query}" | 必须/推荐/可选 |
```

**优先级说明**：
- **必须**：每次分析都要覆盖
- **推荐**：建议覆盖，可根据情况省略
- **可选**：用户明确要求时才覆盖

### 4.4 输出要求规范

```markdown
## 输出要求

1. **必须调用**：
   - `{tool_1}` {说明}
   - `{tool_2}` {说明}

2. **内容要求**：
   - {要求 1}
   - {要求 2}

3. **引导方向**：
   - {引导 1}
   - {引导 2}
```

---

## 5. 加载流程

### 5.1 渐进式加载

```
┌─────────────────────────────────────────────────────────────────┐
│                    渐进式加载流程                                │
├────────��────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 启动时加载                                                   │
│     └── SKILL.md (< 200 行)                                     │
│         • 专家身份                                               │
│         • 能力索引表                                             │
│         • 工具快速参考                                           │
│         • 服务原则 + 伦理边界                                    │
│                                                                 │
│  2. 匹配能力后加载                                               │
│     └── rules/{capability}.md                                   │
│         • 详细分析规则                                           │
│         • 检索 Query 模板                                        │
│         • 输出要求                                               │
│                                                                 │
│  3. 按需检索                                                     │
│     └── search_db(query)                                        │
│         • 知识库内容                                             │
│         • 参考案例                                               │
│                                                                 │
└──────────────────────────────────────────���──────────────────────┘
```

### 5.2 System Prompt 构建

```python
def build_system_prompt(skill_id: str, user_context: Optional[Dict] = None) -> str:
    """
    构建 System Prompt。
    只加载 SKILL.md，规则文件由 LLM 按需加载。
    """
    parts = []

    # 1. 加载 SKILL.md (< 200 行)
    skill_md = load_skill_md(skill_id)
    parts.append(skill_md)

    # 2. 注入用户上下文 (如果有)
    if user_context:
        ctx_text = format_user_context(user_context)
        parts.append(f"\n---\n\n## 用户上下文\n\n{ctx_text}")

    return "\n".join(parts)
```

### 5.3 Agentic Loop

```
1. 用户输入
2. LLM 理解意图，匹配核心能力索引
3. LLM 决定是否需要加载 Rule
4. 如需要，读取 rules/{capability}.md
5. 按规则规划分析步骤
6. 按需检索知识 (search_db)
7. 调用工具展示结果
8. 引导后续对话
```

---

## 6. 工具设计规范

### 6.1 工具分类

| 类别 | 前缀 | 说明 | 示例 |
|-----|------|------|------|
| 信息收集 | `collect_` | 收集用户信息 | `collect_bazi_info` |
| 计算工具 | `calculate_` | 内部计算 | `calculate_bazi` |
| 展示工具 | `show_` | 展示结果 | `show_bazi_chart` |
| 检索工具 | `search_` | 检索知识 | `search_db` |
| 请求工具 | `request_` | 请求补充信息 | `request_info` |

### 6.2 tools.yaml 规范

```yaml
tools:
  - name: show_bazi_chart
    description: 展示八字命盘图
    type: display
    card_type: BaziChartCard
    parameters:
      - name: user_id
        type: string
        required: true
        description: 用户 ID
    when_to_call: 用户想看命盘时

  - name: search_db
    description: 检索知识库或案例库
    type: search
    parameters:
      - name: table
        type: string
        enum: [knowledge_chunks, cases]
        required: true
      - name: query
        type: string
        required: true
        description: 检索 query
      - name: top_k
        type: integer
        default: 5
    when_to_call: 需要专业知识支撑时
```

### 6.3 全局工具

以下工具在 `skills/core/tools/` 中定义，所有 Skill 共享：

| 工具 | 用途 |
|-----|------|
| `search_db` | 统一数据库查询 |
| `request_info` | 请求用户提供信息 |
| `show_insight` | 通用洞察卡片 |
| `show_report` | 通用报告 |

---

## 7. 知识库设计

### 7.1 数据库结构

```sql
-- knowledge_chunks 表
CREATE TABLE knowledge_chunks (
    id              UUID PRIMARY KEY,
    skill_id        VARCHAR(50) NOT NULL,
    document_id     UUID REFERENCES knowledge_documents(id),
    chunk_index     INT NOT NULL,
    content         TEXT NOT NULL,
    section_path    TEXT,
    section_title   VARCHAR(255),
    embedding       VECTOR(1024),
    search_text_preprocessed TEXT,
    metadata        JSONB,
    created_at      TIMESTAMP DEFAULT NOW()
);

-- cases 表
CREATE TABLE cases (
    id              VARCHAR(50) PRIMARY KEY,
    skill_id        VARCHAR(50) NOT NULL,
    name            VARCHAR(255) NOT NULL,
    core_data       JSONB NOT NULL,
    features        JSONB NOT NULL,
    tags            VARCHAR[] NOT NULL,
    analysis        JSONB NOT NULL,
    conclusion      JSONB NOT NULL,
    authority       VARCHAR(20) DEFAULT 'medium',
    created_at      TIMESTAMP DEFAULT NOW()
);
```

### 7.2 检索接口

```python
async def search_db(
    table: str,           # "knowledge_chunks" 或 "cases"
    query: str,           # LLM 描述的检索需求
    skill_id: str,        # 限定 skill
    top_k: int = 5,       # 返回数量
    filters: dict = None  # 可选过滤条件
) -> List[Dict]:
    """语义检索知识或案例。"""
```

### 7.3 知识库质量要求

| 指标 | 目标 | 说明 |
|-----|------|------|
| 知识覆盖 | ≥300 chunks/skill | 覆盖所有核心能力 |
| 案例数量 | ≥50 cases/skill | 覆盖常见场景 |
| 检索准确率 | ≥70% | Top-5 结果相关 |

---

## 8. 最佳实践

### 8.1 SKILL.md 编写

1. **保持精简**：严格控制在 200 行以内
2. **索引优先**：只放索引，详细内容放 rules/
3. **触发词明确**：在 description 中列出触发词
4. **优先级标注**：每个能力标注 impact 级别

### 8.2 Rule 编写

1. **分析要点完整**：覆盖该能力的所有关键分析点
2. **检索 Query 具体**：提供可直接使用的 query 模板
3. **输出要求明确**：指定必须调用的工具
4. **常见问题补充**：针对高频问题提供指导

### 8.3 避免的反模式

| 反模式 | 说明 | 正确做法 |
|-------|------|---------|
| SKILL.md 过长 | 超过 200 行 | 拆分到 rules/ |
| 硬编码知识 | 在 SKILL.md 中写死规则 | 使用 search_db 检索 |
| 缺少优先级 | 能力没有标注优先级 | 标注 CRITICAL/HIGH/MEDIUM/LOW |
| 触发词匹配 | 使用关键词匹配路由 | 让 LLM 语义理解 |
| 固定 SOP | 预定义死板的流程 | 让 LLM 根据规则自主规划 |

---

## 9. 示例

### 9.1 完整 Skill 示例

参见：
- [Bazi SKILL.md 示例](./templates/SKILL_TEMPLATE_BAZI.md)
- [Zodiac SKILL.md 示例](./templates/SKILL_TEMPLATE_ZODIAC.md)

### 9.2 Rule 示例

参见：
- [Rule 模板](./templates/RULE_TEMPLATE.md)
- [Career Rule 示例](./templates/RULE_CAREER.md)

---

## 10. 检查清单

### 10.1 SKILL.md 检查

- [ ] 行数 < 200 行
- [ ] Frontmatter 包含 name 和 description
- [ ] description 包含触发词
- [ ] 核心能力索引表格完整
- [ ] 每个能力都有优先级标注
- [ ] 每个能力都指向 rule 文件
- [ ] 工具快速参考表格完整
- [ ] 知识检索策略表格完整
- [ ] 服务原则 5 条
- [ ] 伦理边界完整

### 10.2 Rule 检查

- [ ] Frontmatter 包含 id, name, impact, tags
- [ ] 适用场景描述清晰
- [ ] 分析要点表格完整
- [ ] 每个要点都有检索 Query
- [ ] 每个要点都有优先级
- [ ] 输出要求明确
- [ ] 必须调用的工具列出

### 10.3 整体检查

- [ ] 目录结构符合规范
- [ ] 所有能力都有对应 rule 文件
- [ ] 工具定义完整
- [ ] 知识库覆盖所有能力
