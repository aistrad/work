# VibeLife V9 系统架构文档

> Version: 9.0 | 2026-01-24
> 核心理念：遵循 Claude Agent SDK 的渐进式 Skill 架构

---

## 1. 架构升级核心

### 1.1 从 V8 到 V9

| 维度 | V8 | V9 |
|------|----|----|
| Skill 加载 | 全量加载 | 渐进式（frontmatter → 完整内容） |
| Skill 激活 | 单一 | 多 Skill 并行 |
| 工具调用 | Skill 隔离 | 跨 Skill 编排 |
| 新场景 | 新建 Skill + 工具 | LLM 自主编排现有 Skill |

### 1.2 Claude Agent SDK Skill 原则

```
启动时：加载所有 SKILL.md frontmatter
       ↓
Phase 1：LLM 看到 Skill 列表 + 描述，选择 Skill(s)
       ↓
Phase 2：加载已选 Skill(s) 的完整内容 + tools/rules
```

**核心理念**：
1. **Frontmatter 只加载一次**：轻量，约 100 tokens/Skill
2. **完整内容按需加载**：进入 Skill 后才加载工具定义和规则
3. **Skill 可叠加**：不是互斥的，可以同时激活多个
4. **LLM 自主编排**：不需要为每个场景写新 Skill

---

## 2. Skill 系统

### 2.1 目录结构

```
skills/{skill_id}/
├── SKILL.md              # frontmatter + 专家身份
├── rules/                # 规则文件（按需加载）
├── tools/
│   ├── tools.yaml        # 工具 Schema
│   └── handlers.py       # 执行器
└── services/
    └── api.py
```

### 2.2 SKILL.md Frontmatter 规范

```yaml
---
id: zodiac
name: 西方占星
version: 2.0.0
description: |
  星盘计算与解读。可与其他 Skill 组合使用。
triggers:
  - 星座
  - 星盘
  - 运势
category: astrology
tools_summary:
  calculate_zodiac: 计算星盘
  show_zodiac_chart: 展示星盘
  show_zodiac_transit: 展示行运
---
```

### 2.3 Skill 分层

```
┌─────────────────────────────────────────────────────────────┐
│  Core Layer (始终激活)                                       │
│  └─ core: 生命对话者                                        │
├─────────────────────────────────────────────────────────────┤
│  Default Layer (默认激活，可取消)                            │
│  ├─ mindfulness                                              │
│  └─ lifecoach                                                │
├─────────────────────────────────────────────────────────────┤
│  Professional Layer (需订阅)                                 │
│  ├─ bazi, zodiac, synastry, tarot, jungastro, career        │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. CoreAgent 架构

### 3.1 两阶段执行

```
用户消息
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: Skill 选择（轻量上下文）                            │
│                                                              │
│  System Prompt：                                             │
│  - Core Skill 人格                                          │
│  - 所有 Skill 的 frontmatter                                 │
│  - 工具摘要（tools_summary）                                 │
│                                                              │
│  可用工具：                                                  │
│  - activate_skills(skills: List[str])  ← 多 Skill！          │
│  - recommend_skills                                          │
└─────────────────────────────────────────────────────────────┘
    │
    │ LLM: activate_skills(["zodiac", "bazi"])
    ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: Skill 执行（完整上下文）                            │
│                                                              │
│  System Prompt：                                             │
│  - 已激活 Skill 的完整 SKILL.md                              │
│  - rules/*.md                                               │
│  - Profile + Skill Data                                     │
│                                                              │
│  可用工具：                                                  │
│  - 已激活 Skill 的所有工具                                   │
│  - 全局工具（core/tools）                                    │
│  - activate_skills（动态切换）                               │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
流式输出
```

### 3.2 关键代码

#### skill_loader.py

```python
@dataclass
class SkillMeta:
    """轻量元数据（Phase 1）"""
    id: str
    name: str
    description: str
    triggers: List[str]
    category: str
    tools_summary: Dict[str, str]

@dataclass
class SkillFull:
    """完整内容（Phase 2）"""
    meta: SkillMeta
    content: str
    tools: List[ToolDef]
    rules: Dict[str, str]

def load_all_skill_metas() -> Dict[str, SkillMeta]:
    """启动时加载所有 frontmatter"""
    pass

def load_skill_full(skill_id: str) -> Optional[SkillFull]:
    """按需加载完整内容"""
    pass
```

#### core.py

```python
def build_phase1_tools() -> List[Dict]:
    return [{
        "type": "function",
        "function": {
            "name": "activate_skills",
            "description": "激活一个或多个 Skill",
            "parameters": {
                "type": "object",
                "properties": {
                    "skills": {
                        "type": "array",
                        "items": {"type": "string"},
                        "description": "Skill ID 列表（1-3个）"
                    }
                },
                "required": ["skills"]
            }
        }
    }]
```

---

## 4. 场景处理示例

### 4.1 "今天和老公相处怎么样"

**V8（错误）**：需要新建 relationship_weather Skill

**V9（正确）**：
```
Phase 1：activate_skills(["zodiac"])

Phase 2：
  - calculate_zodiac(用户, today)
  - calculate_zodiac(伴侣, today)
  - 综合分析行运对关系的影响
  - ✅ 无需新 Skill
```

### 4.2 "帮我看看职业运势"

```
Phase 1：activate_skills(["bazi", "career"])

Phase 2：
  - calculate_bazi → 获取命盘
  - show_career_analysis → 综合分析
  - ✅ 无需 includes 配置
```

### 4.3 "我想看合盘"

```
Phase 1：activate_skills(["synastry"])

Phase 2：
  - 使用 synastry 的完整 SOP
  - ✅ 现有功能不变
```

---

## 5. 数据模型（继承 V8）

```yaml
profile:
  account: { vibe_id, display_name, tier }
  identity:
    birth_info: { date, time, place, timezone, gender }
  state:
    emotion: "neutral"
    focus: ["career"]
  preferences:
    subscribed_skills: { bazi: {...}, zodiac: {...} }
  skill_data:
    bazi: { chart, features }
    zodiac: { chart, current_transits }
  extracted: { facts, goals, concerns }
  life_context: { goals, tasks, reminders }
```

---

## 6. 迁移路径

| Step | 内容 |
|------|------|
| 1 | 每个 SKILL.md 添加 `tools_summary` |
| 2 | skill_loader.py：分层加载 |
| 3 | core.py：`activate_skill` → `activate_skills` |
| 4 | prompt_builder.py：Phase 1 注入 Skill 列表 |
| 5 | 移除 routing.yaml 的 `includes` |

---

## 7. 关键文件

| 文件 | 改动 |
|------|------|
| `apps/api/services/agent/skill_loader.py` | 分层加载 |
| `apps/api/services/agent/core.py` | 多 Skill 激活 |
| `apps/api/services/agent/prompt_builder.py` | Phase 1 上下文 |
| `apps/api/services/agent/tool_registry.py` | 工具合并 |
| `apps/api/skills/*/SKILL.md` | 添加 tools_summary |

---

## 8. 版本历史

- **V9.0** (2026-01-24): 渐进式 Skill 加载 + 多 Skill 并行 + LLM 自主编排
- **V8.3** (2026-01-23): VibeProfile v13 + VibeExtractor
- **V8.0** (2026-01-19): VibeProfile 整合 + Knowledge v2
