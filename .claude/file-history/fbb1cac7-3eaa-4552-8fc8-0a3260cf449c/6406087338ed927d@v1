"""
Access Control - Skill 数据写入权限控制

基于 VibeProfile V8 三层架构，控制 Skill 对 Profile 数据的写入权限。

权限规则:
- core: 只能写入 extracted
- lifecoach: 可写入 skills.lifecoach, vibe.target
- bazi: 可写入 skills.bazi
- zodiac: 可写入 skills.zodiac
- tarot: 可写入 skills.tarot
- career: 可写入 skills.career
- jungastro: 可写入 skills.jungastro
- mindfulness: 可写入 skills.mindfulness
- vibe_id: 可写入 skills.vibe_id

通用规则:
- 所有 Skill 可读取整个 Profile
- 只有 core 可写入 extracted
- 只有 lifecoach 可写入 vibe.target（因为它是目标管理 Skill）
"""
import logging
from typing import Set, Optional

logger = logging.getLogger(__name__)


# 写入权限映射
WRITE_PERMISSIONS = {
    "core": {"extracted"},
    "lifecoach": {"skills.lifecoach", "vibe.target"},
    "bazi": {"skills.bazi"},
    "zodiac": {"skills.zodiac"},
    "tarot": {"skills.tarot"},
    "career": {"skills.career"},
    "jungastro": {"skills.jungastro"},
    "mindfulness": {"skills.mindfulness"},
    "vibe_id": {"skills.vibe_id"},
}


def get_allowed_write_paths(skill_id: str) -> Set[str]:
    """
    获取 Skill 允许写入的路径

    Args:
        skill_id: Skill ID

    Returns:
        允许写入的路径集合
    """
    return WRITE_PERMISSIONS.get(skill_id, set())


def can_write_path(skill_id: str, path: str) -> bool:
    """
    检查 Skill 是否可以写入指定路径

    Args:
        skill_id: Skill ID
        path: 写入路径 (如 "skills.bazi", "vibe.target")

    Returns:
        是否允许写入
    """
    allowed_paths = get_allowed_write_paths(skill_id)

    # 精确匹配
    if path in allowed_paths:
        return True

    # 前缀匹配：如果 skill 可写 "skills.bazi"，则也可写 "skills.bazi.chart"
    for allowed in allowed_paths:
        if path.startswith(f"{allowed}."):
            return True

    return False


def validate_skill_write(
    skill_id: str,
    path: str,
    strict: bool = False
) -> bool:
    """
    验证 Skill 写入权限

    Args:
        skill_id: Skill ID
        path: 写入路径
        strict: 是否严格模式（严格模式下违规会抛出异常）

    Returns:
        是否允许写入

    Raises:
        PermissionError: 严格模式下权限不足时抛出
    """
    if can_write_path(skill_id, path):
        return True

    message = f"Skill '{skill_id}' is not allowed to write to path '{path}'"
    logger.warning(message)

    if strict:
        raise PermissionError(message)

    return False


class AccessControl:
    """
    访问控制器 - 用于在 ToolExecutor 中校验写入权限

    使用方式:
        access_control = AccessControl(skill_id="bazi")
        if access_control.can_write("skills.bazi.chart"):
            # 执行写入
    """

    def __init__(self, skill_id: str, strict: bool = False):
        """
        初始化访问控制器

        Args:
            skill_id: 当前 Skill ID
            strict: 是否严格模式
        """
        self.skill_id = skill_id
        self.strict = strict
        self.allowed_paths = get_allowed_write_paths(skill_id)

    def can_write(self, path: str) -> bool:
        """
        检查是否可以写入指定路径

        Args:
            path: 写入路径

        Returns:
            是否允许写入
        """
        return validate_skill_write(self.skill_id, path, strict=self.strict)

    def validate_write(self, path: str) -> None:
        """
        验证写入权限（总是使用严格模式）

        Args:
            path: 写入路径

        Raises:
            PermissionError: 权限不足时抛出
        """
        validate_skill_write(self.skill_id, path, strict=True)
