"use client"

import { useMemo } from "react"
import { motion } from "framer-motion"
import { User, Zap } from "lucide-react"
import { cn } from "@/lib/utils"
import type { StreamEntry } from "@/stores/stream-store"

function formatTime(value: string) {
  try {
    return new Date(value).toLocaleTimeString("zh-CN", { hour: "2-digit", minute: "2-digit" })
  } catch {
    return ""
  }
}

interface StreamCardProps {
  entry: StreamEntry
  index?: number
}

export function StreamCard({ entry, index = 0 }: StreamCardProps) {
  const time = useMemo(() => formatTime(entry.created_at), [entry.created_at])
  const energyDelta = entry.energy_delta ?? 0
  const energyLabel = energyDelta > 0 ? `+${energyDelta}` : `${energyDelta}`

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{
        duration: 0.4,
        delay: index * 0.05,
        ease: [0.16, 1, 0.3, 1],
      }}
      className={cn(
        "glass-card rounded-xl px-4 py-3.5",
        "hover:shadow-lg transition-shadow duration-300"
      )}
    >
      {/* Header */}
      <div className="flex items-center justify-between text-xs text-foreground-muted">
        <span className="inline-flex items-center gap-1.5">
          <User className="w-3.5 h-3.5" />
          <span>You</span>
        </span>
        <span>{time}</span>
      </div>

      {/* Content */}
      <p className="mt-2.5 text-sm leading-relaxed text-foreground">
        {entry.raw_content}
      </p>

      {/* Footer */}
      <div className="mt-3 flex flex-wrap items-center gap-2">
        {/* Tags */}
        {(entry.tags || []).map((tag) => (
          <span
            key={tag}
            className="inline-flex text-xs rounded-full bg-muted px-2.5 py-0.5 text-foreground-muted"
          >
            {tag}
          </span>
        ))}

        {/* Energy Delta */}
        <motion.span
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ delay: 0.2, type: "spring", stiffness: 300 }}
          className={cn(
            "ml-auto inline-flex items-center gap-1 text-xs font-medium",
            energyDelta >= 0 ? "text-success" : "text-destructive"
          )}
        >
          <Zap className="w-3.5 h-3.5" />
          {energyLabel}
        </motion.span>
      </div>
    </motion.div>
  )
}
