/**
 * Mentis OS v3.0 - Drizzle ORM Schema
 *
 * 类型安全的数据库 Schema 定义
 */

import {
  pgTable,
  uuid,
  text,
  timestamp,
  integer,
  boolean,
  jsonb,
  varchar,
  real,
  index,
  uniqueIndex,
  check,
} from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";

// =============================================================================
// Users
// =============================================================================

export const mentisUser = pgTable(
  "mentis_user",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    email: text("email").unique(),
    name: text("name"),
    tier: text("tier").notNull().default("free"),
    createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
    updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow(),
  },
  (table) => ({
    emailIdx: index("idx_mentis_user_email").on(table.email),
  })
);

export type MentisUser = typeof mentisUser.$inferSelect;
export type NewMentisUser = typeof mentisUser.$inferInsert;

// =============================================================================
// User Profile
// =============================================================================

export const userProfile = pgTable("user_profile", {
  id: uuid("id").primaryKey().defaultRandom(),
  userId: uuid("user_id")
    .references(() => mentisUser.id, { onDelete: "cascade" })
    .unique(),
  birthTime: timestamp("birth_time", { withTimezone: true }),
  birthLocation: jsonb("birth_location").$type<{
    city?: string;
    lat?: number;
    lng?: number;
    timezone?: string;
  }>(),
  baziData: jsonb("bazi_data"),
  ziweiData: jsonb("ziwei_data"),
  mbtiType: varchar("mbti_type", { length: 4 }),
  mbtiRawScores: jsonb("mbti_raw_scores"),
  jungProfile: jsonb("jung_profile"),
  preferences: jsonb("preferences").$type<{
    preferred_interventions?: string[];
    disliked_interventions?: string[];
    notification_enabled?: boolean;
    password_hash?: string;
  }>(),
  notificationSettings: jsonb("notification_settings"),
  createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow(),
});

export type UserProfile = typeof userProfile.$inferSelect;
export type NewUserProfile = typeof userProfile.$inferInsert;

// =============================================================================
// User State (Real-time)
// =============================================================================

export const userState = pgTable("user_state", {
  userId: uuid("user_id")
    .primaryKey()
    .references(() => mentisUser.id, { onDelete: "cascade" }),
  energyScore: integer("energy_score").default(50),
  momentum: integer("momentum").default(0),
  streakDays: integer("streak_days").default(0),
  currentMood: varchar("current_mood", { length: 50 }),
  moodIntensity: integer("mood_intensity"),
  auraState: varchar("aura_state", { length: 20 }).default("calm"),
  lastActiveAt: timestamp("last_active_at", { withTimezone: true }).defaultNow(),
  lastCheckinAt: timestamp("last_checkin_at", { withTimezone: true }),
  streakUpdatedAt: timestamp("streak_updated_at", { mode: "date" }),
  updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow(),
});

export type UserState = typeof userState.$inferSelect;
export type NewUserState = typeof userState.$inferInsert;

// =============================================================================
// Stream Entry
// =============================================================================

export const streamEntry = pgTable(
  "stream_entry",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    userId: uuid("user_id").references(() => mentisUser.id, {
      onDelete: "cascade",
    }),
    type: varchar("type", { length: 30 }).notNull(),
    rawContent: text("raw_content").notNull(),
    mediaUrls: text("media_urls").array(),
    emotion: jsonb("emotion").$type<{
      primary: string;
      intensity: number;
      secondary?: string[];
      confidence?: number;
    }>(),
    context: jsonb("context").$type<{
      scene?: string;
      trigger?: string;
      target?: string;
      time_of_day?: string;
    }>(),
    tags: text("tags").array(),
    energyDelta: integer("energy_delta").default(0),
    embeddingId: varchar("embedding_id", { length: 100 }),
    matchedBehavior: varchar("matched_behavior", { length: 100 }),
    matchedConfidence: real("matched_confidence"),
    autoCheckin: boolean("auto_checkin"),
    source: varchar("source", { length: 50 }).default("app"),
    clientMetadata: jsonb("client_metadata"),
    createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  },
  (table) => ({
    userCreatedIdx: index("idx_stream_user_created").on(
      table.userId,
      table.createdAt
    ),
    typeIdx: index("idx_stream_type").on(table.type),
  })
);

export type StreamEntry = typeof streamEntry.$inferSelect;
export type NewStreamEntry = typeof streamEntry.$inferInsert;

// =============================================================================
// Action Task
// =============================================================================

export const actionTask = pgTable(
  "action_task",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    userId: uuid("user_id").references(() => mentisUser.id, {
      onDelete: "cascade",
    }),
    type: varchar("type", { length: 50 }).notNull(),
    title: varchar("title", { length: 200 }).notNull(),
    description: text("description"),
    status: varchar("status", { length: 20 }).default("pending"),
    triggerTime: timestamp("trigger_time", { withTimezone: true }),
    expiresAt: timestamp("expires_at", { withTimezone: true }),
    completedAt: timestamp("completed_at", { withTimezone: true }),
    source: varchar("source", { length: 50 }).default("agent"),
    triggerContext: jsonb("trigger_context"),
    momentumReward: integer("momentum_reward").default(1),
    createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
    updatedAt: timestamp("updated_at", { withTimezone: true }).defaultNow(),
  },
  (table) => ({
    userStatusIdx: index("idx_task_user_status").on(table.userId, table.status),
    triggerTimeIdx: index("idx_task_trigger_time").on(table.triggerTime),
  })
);

export type ActionTask = typeof actionTask.$inferSelect;
export type NewActionTask = typeof actionTask.$inferInsert;

// =============================================================================
// Checkin Log
// =============================================================================

export const checkinLog = pgTable(
  "checkin_log",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    userId: uuid("user_id").references(() => mentisUser.id, {
      onDelete: "cascade",
    }),
    taskId: uuid("task_id").references(() => actionTask.id, {
      onDelete: "set null",
    }),
    streamId: uuid("stream_id").references(() => streamEntry.id, {
      onDelete: "set null",
    }),
    behaviorType: varchar("behavior_type", { length: 100 }).notNull(),
    source: varchar("source", { length: 20 }).notNull(),
    momentumDelta: integer("momentum_delta").default(1),
    note: text("note").default(""),
    createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  },
  (table) => ({
    userCreatedIdx: index("idx_checkin_user_created").on(
      table.userId,
      table.createdAt
    ),
  })
);

export type CheckinLog = typeof checkinLog.$inferSelect;
export type NewCheckinLog = typeof checkinLog.$inferInsert;

// =============================================================================
// Insight Record
// =============================================================================

export const insightRecord = pgTable(
  "insight_record",
  {
    id: uuid("id").primaryKey().defaultRandom(),
    userId: uuid("user_id").references(() => mentisUser.id, {
      onDelete: "cascade",
    }),
    type: varchar("type", { length: 50 }).notNull(),
    title: varchar("title", { length: 200 }),
    content: text("content").notNull(),
    sourceData: jsonb("source_data"),
    confidence: real("confidence"),
    status: varchar("status", { length: 20 }).default("draft"),
    publishedAt: timestamp("published_at", { withTimezone: true }),
    createdAt: timestamp("created_at", { withTimezone: true }).defaultNow(),
  },
  (table) => ({
    userCreatedIdx: index("idx_insight_user_created").on(
      table.userId,
      table.createdAt
    ),
  })
);

export type InsightRecord = typeof insightRecord.$inferSelect;
export type NewInsightRecord = typeof insightRecord.$inferInsert;

// =============================================================================
// Relations
// =============================================================================

export const mentisUserRelations = relations(mentisUser, ({ one, many }) => ({
  profile: one(userProfile, {
    fields: [mentisUser.id],
    references: [userProfile.userId],
  }),
  state: one(userState, {
    fields: [mentisUser.id],
    references: [userState.userId],
  }),
  streams: many(streamEntry),
  tasks: many(actionTask),
  checkins: many(checkinLog),
  insights: many(insightRecord),
}));

export const streamEntryRelations = relations(streamEntry, ({ one }) => ({
  user: one(mentisUser, {
    fields: [streamEntry.userId],
    references: [mentisUser.id],
  }),
}));

export const actionTaskRelations = relations(actionTask, ({ one, many }) => ({
  user: one(mentisUser, {
    fields: [actionTask.userId],
    references: [mentisUser.id],
  }),
  checkins: many(checkinLog),
}));

export const checkinLogRelations = relations(checkinLog, ({ one }) => ({
  user: one(mentisUser, {
    fields: [checkinLog.userId],
    references: [mentisUser.id],
  }),
  task: one(actionTask, {
    fields: [checkinLog.taskId],
    references: [actionTask.id],
  }),
  stream: one(streamEntry, {
    fields: [checkinLog.streamId],
    references: [streamEntry.id],
  }),
}));

export const insightRecordRelations = relations(insightRecord, ({ one }) => ({
  user: one(mentisUser, {
    fields: [insightRecord.userId],
    references: [mentisUser.id],
  }),
}));
