"use client"

import { useState, useCallback } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { Mail, Lock, Eye, EyeOff, Loader2, ArrowRight } from "lucide-react"
import { cn } from "@/lib/utils"

type AuthMode = "login" | "register"

interface AuthFormProps {
  onSubmit: (data: { email: string; password: string; mode: AuthMode }) => Promise<void>
  className?: string
}

export function AuthForm({ onSubmit, className }: AuthFormProps) {
  const [mode, setMode] = useState<AuthMode>("login")
  const [email, setEmail] = useState("")
  const [password, setPassword] = useState("")
  const [showPassword, setShowPassword] = useState(false)
  const [isLoading, setIsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const handleSubmit = useCallback(async (e: React.FormEvent) => {
    e.preventDefault()
    if (!email || !password || isLoading) return

    setError(null)
    setIsLoading(true)

    try {
      await onSubmit({ email, password, mode })
    } catch (err) {
      setError(err instanceof Error ? err.message : "发生错误，请重试")
    } finally {
      setIsLoading(false)
    }
  }, [email, password, mode, isLoading, onSubmit])

  return (
    <div className={cn("space-y-6", className)}>
      {/* Mode Toggle */}
      <div className="flex gap-2 p-1 bg-muted rounded-lg">
        {(["login", "register"] as AuthMode[]).map((m) => (
          <button
            key={m}
            type="button"
            onClick={() => {
              setMode(m)
              setError(null)
            }}
            className={cn(
              "flex-1 py-2.5 px-4 rounded-md text-sm font-medium transition-all duration-200",
              mode === m
                ? "bg-card text-foreground shadow-sm"
                : "text-foreground-muted hover:text-foreground"
            )}
          >
            {m === "login" ? "登录" : "注册"}
          </button>
        ))}
      </div>

      {/* Form */}
      <form onSubmit={handleSubmit} className="space-y-4">
        {/* Email Input */}
        <div className="relative">
          <Mail className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-foreground-muted" />
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="邮箱地址"
            required
            className={cn(
              "w-full pl-12 pr-4 py-3 rounded-xl",
              "bg-background border border-border",
              "text-foreground placeholder:text-foreground-muted",
              "focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent",
              "transition-all duration-200"
            )}
          />
        </div>

        {/* Password Input */}
        <div className="relative">
          <Lock className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-foreground-muted" />
          <input
            type={showPassword ? "text" : "password"}
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            placeholder="密码"
            required
            minLength={8}
            className={cn(
              "w-full pl-12 pr-12 py-3 rounded-xl",
              "bg-background border border-border",
              "text-foreground placeholder:text-foreground-muted",
              "focus:outline-none focus:ring-2 focus:ring-accent/20 focus:border-accent",
              "transition-all duration-200"
            )}
          />
          <button
            type="button"
            onClick={() => setShowPassword(!showPassword)}
            className="absolute right-4 top-1/2 -translate-y-1/2 text-foreground-muted hover:text-foreground transition-colors"
          >
            {showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}
          </button>
        </div>

        {/* Error Message */}
        <AnimatePresence>
          {error && (
            <motion.p
              initial={{ opacity: 0, y: -10 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -10 }}
              className="text-sm text-destructive"
            >
              {error}
            </motion.p>
          )}
        </AnimatePresence>

        {/* Forgot Password (Login only) */}
        {mode === "login" && (
          <div className="text-right">
            <button type="button" className="text-sm text-foreground-muted hover:text-accent transition-colors">
              忘记密码？
            </button>
          </div>
        )}

        {/* Submit Button */}
        <motion.button
          type="submit"
          disabled={!email || !password || isLoading}
          whileHover={{ scale: 1.01 }}
          whileTap={{ scale: 0.99 }}
          className={cn(
            "w-full flex items-center justify-center gap-2 py-3 px-6 rounded-xl",
            "bg-foreground text-background font-medium",
            "disabled:opacity-50 disabled:cursor-not-allowed",
            "shadow-lg hover:shadow-xl transition-all duration-200"
          )}
        >
          {isLoading ? (
            <Loader2 className="w-5 h-5 animate-spin" />
          ) : (
            <>
              <span>{mode === "login" ? "登录" : "创建账户"}</span>
              <ArrowRight className="w-4 h-4" />
            </>
          )}
        </motion.button>
      </form>

      {/* Divider */}
      <div className="relative">
        <div className="absolute inset-0 flex items-center">
          <div className="w-full border-t border-border" />
        </div>
        <div className="relative flex justify-center">
          <span className="px-3 bg-card text-sm text-foreground-muted">或</span>
        </div>
      </div>

      {/* Social Auth */}
      <div className="grid grid-cols-2 gap-3">
        <button
          type="button"
          className={cn(
            "flex items-center justify-center gap-2 py-2.5 px-4 rounded-xl",
            "border border-border bg-background",
            "text-sm font-medium text-foreground",
            "hover:bg-muted transition-colors"
          )}
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24">
            <path
              fill="currentColor"
              d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z"
            />
          </svg>
          <span>Google</span>
        </button>
        <button
          type="button"
          className={cn(
            "flex items-center justify-center gap-2 py-2.5 px-4 rounded-xl",
            "border border-border bg-background",
            "text-sm font-medium text-foreground",
            "hover:bg-muted transition-colors"
          )}
        >
          <svg className="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.477 2 2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.879V14.89h-2.54V12h2.54V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.243 0-1.63.771-1.63 1.562V12h2.773l-.443 2.89h-2.33v6.989C18.343 21.129 22 16.99 22 12c0-5.523-4.477-10-10-10z" />
          </svg>
          <span>Apple</span>
        </button>
      </div>

      {/* Terms */}
      {mode === "register" && (
        <p className="text-xs text-center text-foreground-muted">
          注册即表示您同意我们的{" "}
          <a href="#" className="underline hover:text-foreground">
            服务条款
          </a>{" "}
          和{" "}
          <a href="#" className="underline hover:text-foreground">
            隐私政策
          </a>
        </p>
      )}
    </div>
  )
}
