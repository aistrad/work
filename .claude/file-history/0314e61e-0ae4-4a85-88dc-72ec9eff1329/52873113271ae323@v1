"use client"

import { useState, useRef, useCallback } from "react"
import { motion, AnimatePresence } from "framer-motion"
import { Mic, Camera, Send, X, Loader2 } from "lucide-react"
import { cn } from "@/lib/utils"

interface OmnibarProps {
  onSubmit: (content: string) => void
  placeholder?: string
  disabled?: boolean
  isLoading?: boolean
  className?: string
}

export function Omnibar({
  onSubmit,
  placeholder = "有什么想告诉我的...",
  disabled = false,
  isLoading = false,
  className,
}: OmnibarProps) {
  const [value, setValue] = useState("")
  const [isRecording, setIsRecording] = useState(false)
  const inputRef = useRef<HTMLInputElement>(null)

  const handleSubmit = useCallback(() => {
    if (!value.trim() || disabled || isLoading) return
    onSubmit(value.trim())
    setValue("")
  }, [value, disabled, isLoading, onSubmit])

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      handleSubmit()
    }
  }

  const handleVoiceClick = () => {
    setIsRecording(!isRecording)
    // TODO: 实现语音录制
  }

  const handleCameraClick = () => {
    // TODO: 实现拍照功能
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4, ease: [0.16, 1, 0.3, 1] }}
      className={cn(
        "glass-card rounded-full flex items-center px-3 py-2 sm:px-4 sm:py-3 gap-2 sm:gap-3",
        "transition-all duration-300",
        "focus-within:ring-2 focus-within:ring-accent/20",
        disabled && "opacity-50 pointer-events-none",
        className
      )}
    >
      {/* Voice Button */}
      <motion.button
        type="button"
        onClick={handleVoiceClick}
        whileHover={{ scale: 1.1 }}
        whileTap={{ scale: 0.95 }}
        className={cn(
          "p-2 rounded-full transition-colors",
          isRecording
            ? "bg-destructive/10 text-destructive"
            : "hover:bg-accent/10 text-foreground-muted hover:text-foreground"
        )}
        aria-label={isRecording ? "停止录音" : "开始录音"}
      >
        <AnimatePresence mode="wait">
          {isRecording ? (
            <motion.div
              key="recording"
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              exit={{ scale: 0 }}
            >
              <X className="w-5 h-5" />
            </motion.div>
          ) : (
            <motion.div
              key="mic"
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              exit={{ scale: 0 }}
            >
              <Mic className="w-5 h-5" />
            </motion.div>
          )}
        </AnimatePresence>
      </motion.button>

      {/* Camera Button */}
      <motion.button
        type="button"
        onClick={handleCameraClick}
        whileHover={{ scale: 1.1 }}
        whileTap={{ scale: 0.95 }}
        className="p-2 rounded-full hover:bg-accent/10 text-foreground-muted hover:text-foreground transition-colors"
        aria-label="拍照"
      >
        <Camera className="w-5 h-5" />
      </motion.button>

      {/* Divider */}
      <div className="w-px h-6 bg-border" />

      {/* Text Input */}
      <input
        ref={inputRef}
        type="text"
        value={value}
        onChange={(e) => setValue(e.target.value)}
        onKeyDown={handleKeyDown}
        placeholder={placeholder}
        disabled={disabled || isLoading}
        className={cn(
          "flex-1 bg-transparent outline-none min-w-0",
          "text-foreground placeholder:text-foreground-muted",
          "text-sm sm:text-base"
        )}
      />

      {/* Submit Button */}
      <motion.button
        type="button"
        onClick={handleSubmit}
        disabled={!value.trim() || disabled || isLoading}
        whileHover={{ scale: 1.05 }}
        whileTap={{ scale: 0.95 }}
        className={cn(
          "p-2 rounded-full transition-all duration-200",
          value.trim() && !disabled && !isLoading
            ? "bg-foreground text-background hover:opacity-90"
            : "bg-muted text-muted-foreground cursor-not-allowed"
        )}
        aria-label="发送"
      >
        <AnimatePresence mode="wait">
          {isLoading ? (
            <motion.div
              key="loading"
              initial={{ opacity: 0, rotate: 0 }}
              animate={{ opacity: 1, rotate: 360 }}
              exit={{ opacity: 0 }}
              transition={{ repeat: Infinity, duration: 1, ease: "linear" }}
            >
              <Loader2 className="w-4 h-4" />
            </motion.div>
          ) : (
            <motion.div
              key="send"
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              exit={{ scale: 0 }}
            >
              <Send className="w-4 h-4" />
            </motion.div>
          )}
        </AnimatePresence>
      </motion.button>
    </motion.div>
  )
}
