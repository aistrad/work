"""
Mentis Frontend Page Testing
Tests landing, login, and stream pages
"""

from playwright.sync_api import sync_playwright
import os

# Create output directory
os.makedirs('/tmp/mentis-test/screenshots', exist_ok=True)

def test_pages():
    pages_to_test = [
        ("landing", "http://localhost:3000", "Landing Page"),
        ("login", "http://localhost:3000/login", "Login Page"),
        ("stream", "http://localhost:3000/stream", "Stream Page"),
    ]

    results = []

    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        page = browser.new_page(viewport={"width": 1280, "height": 800})

        for name, url, description in pages_to_test:
            print(f"\n{'='*50}")
            print(f"Testing: {description} ({url})")
            print('='*50)

            try:
                # Navigate to page
                response = page.goto(url, wait_until="networkidle", timeout=30000)

                # Check response status
                status = response.status if response else "No response"
                print(f"Status: {status}")

                # Wait for content to load
                page.wait_for_load_state("networkidle")

                # Take screenshot
                screenshot_path = f"/tmp/mentis-test/screenshots/{name}.png"
                page.screenshot(path=screenshot_path, full_page=True)
                print(f"Screenshot: {screenshot_path}")

                # Get page title
                title = page.title()
                print(f"Title: {title}")

                # Check for key elements based on page
                if name == "landing":
                    # Check for Soul Orb or main heading
                    has_orb = page.locator('[class*="orb"], [class*="Orb"]').count() > 0
                    has_heading = page.locator('h1').count() > 0
                    print(f"Has Orb element: {has_orb}")
                    print(f"Has H1 heading: {has_heading}")

                elif name == "login":
                    # Check for login form elements
                    has_form = page.locator('form, input[type="email"], input[type="password"]').count() > 0
                    has_buttons = page.locator('button').count() > 0
                    print(f"Has form elements: {has_form}")
                    print(f"Has buttons: {has_buttons}")

                elif name == "stream":
                    # Check for stream components
                    has_status_bar = page.locator('[class*="status"], [class*="Status"]').count() > 0
                    has_input = page.locator('input, [class*="omnibar"], [class*="Omnibar"]').count() > 0
                    print(f"Has status bar: {has_status_bar}")
                    print(f"Has input/omnibar: {has_input}")

                # Get any console errors
                console_errors = []
                page.on("console", lambda msg: console_errors.append(msg.text) if msg.type == "error" else None)

                results.append({
                    "page": name,
                    "url": url,
                    "status": status,
                    "success": status == 200,
                    "screenshot": screenshot_path
                })

                print(f"✓ {description} loaded successfully")

            except Exception as e:
                print(f"✗ Error testing {description}: {e}")
                results.append({
                    "page": name,
                    "url": url,
                    "status": "error",
                    "success": False,
                    "error": str(e)
                })

        browser.close()

    # Summary
    print(f"\n{'='*50}")
    print("SUMMARY")
    print('='*50)

    success_count = sum(1 for r in results if r["success"])
    print(f"Passed: {success_count}/{len(results)}")

    for r in results:
        status_icon = "✓" if r["success"] else "✗"
        print(f"  {status_icon} {r['page']}: {r['status']}")

    print(f"\nScreenshots saved to: /tmp/mentis-test/screenshots/")

    return results

if __name__ == "__main__":
    test_pages()
