/**
 * ZodiacChartCard - æ˜Ÿç›˜å¡ç‰‡
 *
 * ä» show-zodiac-chart.tsx æå–çš„çº¯æ¸²æŸ“ç»„ä»¶
 * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "zodiac_chart" è§¦å‘
 */

"use client";

import { useState, useRef } from "react";
import { useRouter } from "next/navigation";
import { History, Share2, Image as ImageIcon, Link2 } from "lucide-react";
import { registerCard } from "@/skills/CardRegistry";
import { useImageShare } from "@/hooks/useImageShare";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface PlanetPosition {
  planet: string;
  sign: string;
  degree: number;
  house: number;
  retrograde?: boolean;
}

interface Aspect {
  planet1: string;
  planet2: string;
  type: string;
  orb: number;
}

interface ZodiacChartData {
  userId?: string;
  birthInfo?: { date?: string; time?: string; place?: string };
  birth_info?: { date?: string; time?: string; place?: string };
  sunSign?: string;
  sun_sign?: string;
  moonSign?: string;
  moon_sign?: string;
  risingSign?: string;
  rising_sign?: string;
  planets?: PlanetPosition[];
  aspects?: Aspect[];
  dominantElement?: string;
  dominant_element?: string;
  dominantModality?: string;
  dominant_modality?: string;
}

interface ZodiacChartCardProps {
  data: ZodiacChartData;
  cardProps?: Record<string, unknown>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// è¡Œæ˜Ÿä¸­æ–‡åæ˜ å°„ï¼ˆæ”¯æŒå„ç§æ ¼å¼ï¼‰
const PLANET_CN: Record<string, string> = {
  sun: "å¤ªé˜³", Sun: "å¤ªé˜³", å¤ªé˜³: "å¤ªé˜³",
  moon: "æœˆäº®", Moon: "æœˆäº®", æœˆäº®: "æœˆäº®",
  mercury: "æ°´æ˜Ÿ", Mercury: "æ°´æ˜Ÿ", æ°´æ˜Ÿ: "æ°´æ˜Ÿ",
  venus: "é‡‘æ˜Ÿ", Venus: "é‡‘æ˜Ÿ", é‡‘æ˜Ÿ: "é‡‘æ˜Ÿ",
  mars: "ç«æ˜Ÿ", Mars: "ç«æ˜Ÿ", ç«æ˜Ÿ: "ç«æ˜Ÿ",
  jupiter: "æœ¨æ˜Ÿ", Jupiter: "æœ¨æ˜Ÿ", æœ¨æ˜Ÿ: "æœ¨æ˜Ÿ",
  saturn: "åœŸæ˜Ÿ", Saturn: "åœŸæ˜Ÿ", åœŸæ˜Ÿ: "åœŸæ˜Ÿ",
  uranus: "å¤©ç‹æ˜Ÿ", Uranus: "å¤©ç‹æ˜Ÿ", å¤©ç‹æ˜Ÿ: "å¤©ç‹æ˜Ÿ",
  neptune: "æµ·ç‹æ˜Ÿ", Neptune: "æµ·ç‹æ˜Ÿ", æµ·ç‹æ˜Ÿ: "æµ·ç‹æ˜Ÿ",
  pluto: "å†¥ç‹æ˜Ÿ", Pluto: "å†¥ç‹æ˜Ÿ", å†¥ç‹æ˜Ÿ: "å†¥ç‹æ˜Ÿ",
};

// æ˜Ÿåº§ä¸­æ–‡åæ˜ å°„ï¼ˆæ”¯æŒå„ç§æ ¼å¼ï¼‰
const SIGN_CN: Record<string, string> = {
  aries: "ç™½ç¾Šåº§", Aries: "ç™½ç¾Šåº§", ç™½ç¾Šåº§: "ç™½ç¾Šåº§",
  taurus: "é‡‘ç‰›åº§", Taurus: "é‡‘ç‰›åº§", é‡‘ç‰›åº§: "é‡‘ç‰›åº§",
  gemini: "åŒå­åº§", Gemini: "åŒå­åº§", åŒå­åº§: "åŒå­åº§",
  cancer: "å·¨èŸ¹åº§", Cancer: "å·¨èŸ¹åº§", å·¨èŸ¹åº§: "å·¨èŸ¹åº§",
  leo: "ç‹®å­åº§", Leo: "ç‹®å­åº§", ç‹®å­åº§: "ç‹®å­åº§",
  virgo: "å¤„å¥³åº§", Virgo: "å¤„å¥³åº§", å¤„å¥³åº§: "å¤„å¥³åº§",
  libra: "å¤©ç§¤åº§", Libra: "å¤©ç§¤åº§", å¤©ç§¤åº§: "å¤©ç§¤åº§",
  scorpio: "å¤©èåº§", Scorpio: "å¤©èåº§", å¤©èåº§: "å¤©èåº§",
  sagittarius: "å°„æ‰‹åº§", Sagittarius: "å°„æ‰‹åº§", å°„æ‰‹åº§: "å°„æ‰‹åº§",
  capricorn: "æ‘©ç¾¯åº§", Capricorn: "æ‘©ç¾¯åº§", æ‘©ç¾¯åº§: "æ‘©ç¾¯åº§",
  aquarius: "æ°´ç“¶åº§", Aquarius: "æ°´ç“¶åº§", æ°´ç“¶åº§: "æ°´ç“¶åº§",
  pisces: "åŒé±¼åº§", Pisces: "åŒé±¼åº§", åŒé±¼åº§: "åŒé±¼åº§",
};

// å…ƒç´ ä¸­æ–‡åæ˜ å°„
const ELEMENT_CN: Record<string, string> = {
  fire: "ç«", Fire: "ç«", ç«: "ç«",
  earth: "åœŸ", Earth: "åœŸ", åœŸ: "åœŸ",
  air: "é£", Air: "é£", é£: "é£",
  water: "æ°´", Water: "æ°´", æ°´: "æ°´",
};

// æ¨¡å¼ä¸­æ–‡åæ˜ å°„
const MODALITY_CN: Record<string, string> = {
  cardinal: "å¼€åˆ›", Cardinal: "å¼€åˆ›", å¼€åˆ›: "å¼€åˆ›",
  fixed: "å›ºå®š", Fixed: "å›ºå®š", å›ºå®š: "å›ºå®š",
  mutable: "å˜åŠ¨", Mutable: "å˜åŠ¨", å˜åŠ¨: "å˜åŠ¨",
};

const PLANET_SYMBOLS: Record<string, string> = {
  å¤ªé˜³: "â˜€ï¸", æœˆäº®: "ğŸŒ™", æ°´æ˜Ÿ: "â˜¿", é‡‘æ˜Ÿ: "â™€", ç«æ˜Ÿ: "â™‚",
  æœ¨æ˜Ÿ: "â™ƒ", åœŸæ˜Ÿ: "â™„", å¤©ç‹æ˜Ÿ: "â™…", æµ·ç‹æ˜Ÿ: "â™†", å†¥ç‹æ˜Ÿ: "â™‡",
};

const SIGN_EMOJI: Record<string, string> = {
  ç™½ç¾Šåº§: "â™ˆ", é‡‘ç‰›åº§: "â™‰", åŒå­åº§: "â™Š", å·¨èŸ¹åº§: "â™‹",
  ç‹®å­åº§: "â™Œ", å¤„å¥³åº§: "â™", å¤©ç§¤åº§: "â™", å¤©èåº§: "â™",
  å°„æ‰‹åº§: "â™", æ‘©ç¾¯åº§: "â™‘", æ°´ç“¶åº§: "â™’", åŒé±¼åº§: "â™“",
};

const ELEMENT_EMOJI: Record<string, string> = {
  ç«: "ğŸ”¥", åœŸ: "ğŸŒ", é£: "ğŸ’¨", æ°´: "ğŸ’§",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getSignElement(sign: string): string | null {
  // å…ˆè½¬æ¢ä¸ºä¸­æ–‡æ˜Ÿåº§å
  const signCn = SIGN_CN[sign] || sign;

  const fireSign = ["ç™½ç¾Šåº§", "ç‹®å­åº§", "å°„æ‰‹åº§"];
  const earthSign = ["é‡‘ç‰›åº§", "å¤„å¥³åº§", "æ‘©ç¾¯åº§"];
  const airSign = ["åŒå­åº§", "å¤©ç§¤åº§", "æ°´ç“¶åº§"];
  const waterSign = ["å·¨èŸ¹åº§", "å¤©èåº§", "åŒé±¼åº§"];

  if (fireSign.includes(signCn)) return "ç«";
  if (earthSign.includes(signCn)) return "åœŸ";
  if (airSign.includes(signCn)) return "é£";
  if (waterSign.includes(signCn)) return "æ°´";
  return null;
}

function getElementBarColor(element: string): string {
  const colors: Record<string, string> = {
    ç«: "#ef4444", åœŸ: "#eab308", é£: "#0ea5e9", æ°´: "#3b82f6",
  };
  return colors[element] || "#888";
}

function getElementStyle(element: string): string {
  const styles: Record<string, string> = {
    ç«: "bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300",
    åœŸ: "bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300",
    é£: "bg-sky-100 dark:bg-sky-900/30 text-sky-700 dark:text-sky-300",
    æ°´: "bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300",
  };
  return styles[element] || "bg-muted";
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function ZodiacChartCard({ data }: ZodiacChartCardProps) {
  const [expandedPlanet, setExpandedPlanet] = useState<string | null>(null);
  const [showShareMenu, setShowShareMenu] = useState(false);
  const router = useRouter();
  const cardRef = useRef<HTMLDivElement>(null);
  const { openScreenshotMode, captureElement, downloadImage, state: imageState } = useImageShare();

  // å…¼å®¹ snake_case å’Œ camelCaseï¼Œå¹¶è½¬æ¢ä¸ºä¸­æ–‡
  const birthInfo = data.birthInfo || data.birth_info || {};
  const sunSign = SIGN_CN[data.sunSign || data.sun_sign || ""] || data.sunSign || data.sun_sign || "";
  const moonSign = SIGN_CN[data.moonSign || data.moon_sign || ""] || data.moonSign || data.moon_sign || "";
  const risingSign = SIGN_CN[data.risingSign || data.rising_sign || ""] || data.risingSign || data.rising_sign || "";
  const planets = data.planets || [];
  const aspects = data.aspects || [];
  const dominantElement = ELEMENT_CN[data.dominantElement || data.dominant_element || ""] || data.dominantElement || data.dominant_element || "";
  const dominantModality = MODALITY_CN[data.dominantModality || data.dominant_modality || ""] || data.dominantModality || data.dominant_modality || "";

  // è®¡ç®—å…ƒç´ åˆ†å¸ƒ
  const elementCounts = planets.reduce((acc, p) => {
    const element = getSignElement(p.sign);
    if (element) {
      acc[element] = (acc[element] || 0) + 1;
    }
    return acc;
  }, {} as Record<string, number>);

  const totalPlanets = Object.values(elementCounts).reduce((sum, val) => sum + val, 0) || 1;

  const handleImageShare = async () => {
    if (!cardRef.current) return;

    // Try to capture and download
    const blob = await captureElement(cardRef.current);
    if (blob) {
      downloadImage(blob, `æ˜Ÿç›˜åˆ†æ_${sunSign}_${new Date().toISOString().slice(0,10)}.png`);
    } else {
      // Fallback to screenshot mode
      openScreenshotMode(cardRef.current);
    }
    setShowShareMenu(false);
  };

  const handleLinkShare = async () => {
    // For now, just copy the current URL
    // In the future, this could create a share link through the API
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
    } catch {
      alert('å¤åˆ¶é“¾æ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æµè§ˆå™¨åœ°å€æ ä¸­çš„é“¾æ¥');
    }
    setShowShareMenu(false);
  };

  return (
    <div ref={cardRef} className="zodiac-chart-card bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30 rounded-xl border border-indigo-200 dark:border-indigo-800 p-4 my-2 overflow-hidden animate-fade-in">
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-indigo-900 dark:text-indigo-100 flex items-center gap-2">
          <span>âœ¨</span>
          <span>æœ¬å‘½æ˜Ÿç›˜</span>
        </h3>
        <span className="text-sm text-indigo-700 dark:text-indigo-300">
          {birthInfo.date || ""}
        </span>
      </div>

      {/* Big Three */}
      <div className="grid grid-cols-3 gap-3 mb-4">
        {[
          { label: "å¤ªé˜³", sign: sunSign, icon: "â˜€ï¸" },
          { label: "æœˆäº®", sign: moonSign, icon: "ğŸŒ™" },
          { label: "ä¸Šå‡", sign: risingSign, icon: "â¬†ï¸" },
        ].map((item) => (
          <div
            key={item.label}
            className="text-center p-3 bg-white/60 dark:bg-black/30 rounded-lg cursor-pointer hover:bg-white/80 dark:hover:bg-black/40 transition-all"
          >
            <div className="text-xs text-muted-foreground mb-1">{item.icon} {item.label}</div>
            <div className="text-2xl font-medium">{SIGN_EMOJI[item.sign] || "â˜…"}</div>
            <div className="text-sm font-medium">{item.sign}</div>
          </div>
        ))}
      </div>

      {/* Planets */}
      <div className="bg-white/40 dark:bg-black/20 rounded-lg p-3 mb-3">
        <div className="text-sm font-medium mb-2">è¡Œæ˜Ÿåˆ†å¸ƒ</div>
        <div className="space-y-1">
          {planets.slice(0, 10).map((planet) => {
            const isExpanded = expandedPlanet === planet.planet;
            const planetAspects = aspects.filter(
              a => a.planet1 === planet.planet || a.planet2 === planet.planet
            );
            // è½¬æ¢ä¸ºä¸­æ–‡æ˜¾ç¤º
            const planetCn = PLANET_CN[planet.planet] || planet.planet;
            const signCn = SIGN_CN[planet.sign] || planet.sign;

            return (
              <div key={planet.planet}>
                <div
                  onClick={() => setExpandedPlanet(isExpanded ? null : planet.planet)}
                  className={`flex items-center justify-between p-2 rounded-lg cursor-pointer transition-all ${
                    isExpanded ? "bg-indigo-100 dark:bg-indigo-900/30" : "hover:bg-white/50 dark:hover:bg-black/30"
                  }`}
                >
                  <div className="flex items-center gap-2">
                    <span className="w-6 text-center">{PLANET_SYMBOLS[planetCn] || "â˜…"}</span>
                    <span className="text-sm font-medium">{planetCn}</span>
                  </div>
                  <div className="flex items-center gap-2 text-sm">
                    <span>{SIGN_EMOJI[signCn] || ""} {signCn}</span>
                    <span className="text-muted-foreground">{planet.house}å®«</span>
                    {planet.retrograde && <span className="text-orange-500 text-xs">â„</span>}
                  </div>
                </div>

                {/* Expanded planet details */}
                {isExpanded && planetAspects.length > 0 && (
                  <div className="pl-8 pr-2 py-2 text-xs text-muted-foreground animate-fade-in">
                    <div className="font-medium mb-1">ç›¸ä½å…³ç³»ï¼š</div>
                    {planetAspects.slice(0, 3).map((aspect, i) => {
                      const otherPlanet = aspect.planet1 === planet.planet ? aspect.planet2 : aspect.planet1;
                      const otherPlanetCn = PLANET_CN[otherPlanet] || otherPlanet;
                      return (
                        <div key={i} className="flex items-center gap-1">
                          <span>{aspect.type}</span>
                          <span>{otherPlanetCn}</span>
                          <span className="text-muted-foreground/50">({aspect.orb.toFixed(1)}Â°)</span>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>

      {/* Element Distribution */}
      <div className="mb-3">
        <div className="text-sm font-medium mb-2">å…ƒç´ åˆ†å¸ƒ</div>
        <div className="grid grid-cols-4 gap-2">
          {(["ç«", "åœŸ", "é£", "æ°´"] as const).map((element) => {
            const count = elementCounts[element] || 0;
            const percentage = Math.round((count / totalPlanets) * 100);
            return (
              <div key={element} className="text-center">
                <div className="text-lg mb-1">{ELEMENT_EMOJI[element]}</div>
                <div className="h-2 bg-white/50 dark:bg-black/20 rounded-full overflow-hidden">
                  <div
                    className="h-full rounded-full transition-all duration-500"
                    style={{ width: `${percentage}%`, backgroundColor: getElementBarColor(element) }}
                  />
                </div>
                <div className="text-xs text-muted-foreground mt-1">{percentage}%</div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Dominant Element */}
      <div className="flex items-center justify-between text-sm">
        <div className="flex items-center gap-2">
          <span className="text-muted-foreground">ä¸»å¯¼å…ƒç´ :</span>
          <span className={`px-2 py-0.5 rounded ${getElementStyle(dominantElement)}`}>
            {ELEMENT_EMOJI[dominantElement] || ""} {dominantElement}
          </span>
        </div>
        {dominantModality && (
          <div className="flex items-center gap-2">
            <span className="text-muted-foreground">ä¸»å¯¼æ¨¡å¼:</span>
            <span className="px-2 py-0.5 bg-indigo-100 dark:bg-indigo-900/30 rounded text-indigo-700 dark:text-indigo-300">
              {dominantModality}
            </span>
          </div>
        )}
      </div>

      {/* Hint */}
      <div className="mt-3 text-xs text-center text-muted-foreground">
        ğŸ’¡ ç‚¹å‡»è¡Œæ˜ŸæŸ¥çœ‹ç›¸ä½å…³ç³»
      </div>

      {/* Action Buttons */}
      <div className="mt-4 pt-3 border-t border-indigo-200/50 dark:border-indigo-800/50 flex items-center justify-center gap-4">
        <button
          onClick={() => router.push('/zodiac/history')}
          className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-indigo-600 dark:text-indigo-300 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 rounded-lg transition-colors"
        >
          <History className="w-4 h-4" />
          <span>æŸ¥çœ‹å†å²</span>
        </button>

        {/* Share Dropdown */}
        <div className="relative">
          <button
            onClick={() => setShowShareMenu(!showShareMenu)}
            className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-indigo-600 dark:text-indigo-300 hover:bg-indigo-100 dark:hover:bg-indigo-900/30 rounded-lg transition-colors"
          >
            <Share2 className="w-4 h-4" />
            <span>åˆ†äº«</span>
          </button>

          {showShareMenu && (
            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-indigo-200 dark:border-indigo-800 overflow-hidden z-10 animate-fade-in">
              <button
                onClick={handleLinkShare}
                className="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors"
              >
                <Link2 className="w-4 h-4" />
                <span>å¤åˆ¶é“¾æ¥</span>
              </button>
              <button
                onClick={handleImageShare}
                disabled={imageState.isGenerating}
                className="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-indigo-50 dark:hover:bg-indigo-900/30 transition-colors disabled:opacity-50"
              >
                <ImageIcon className="w-4 h-4" />
                <span>{imageState.isGenerating ? 'ç”Ÿæˆä¸­...' : 'ä¿å­˜å›¾ç‰‡'}</span>
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("zodiac_chart", ZodiacChartCard);

export default ZodiacChartCard;
