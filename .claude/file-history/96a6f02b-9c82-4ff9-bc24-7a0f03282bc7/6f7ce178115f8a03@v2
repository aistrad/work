'use client';

/**
 * Zodiac History Page - 星座分析历史页面
 *
 * 显示用户的星座分析历史记录
 */

import React from 'react';
import { useRouter } from 'next/navigation';
import useSWR from 'swr';
import { ArrowLeft, Star, History } from 'lucide-react';
import { useAuth } from '@/providers/AuthProvider';
import { apiClient } from '@/lib/api';
import ZodiacHistoryCard from '@/skills/zodiac/cards/ZodiacHistoryCard';

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface ZodiacInsight {
  id: string;
  title: string;
  content: string;
  fullContent: string;
  evidence: {
    chart_data?: {
      sunSign?: string;
      sun_sign?: string;
      moonSign?: string;
      moon_sign?: string;
      risingSign?: string;
      rising_sign?: string;
    };
    generated_at?: string;
  };
  createdAt: string;
  userReaction?: string;
}

interface InsightsResponse {
  status: string;
  insights: ZodiacInsight[];
  total: number;
}

// ═══════════════════════════════════════════════════════════════════════════
// API Functions
// ═══════════════════════════════════════════════════════════════════════════

async function fetchInsights(): Promise<InsightsResponse> {
  const response = await apiClient.post<InsightsResponse>('/api/v1/skills/zodiac/insights', {
    args: { limit: 50 },
  });
  return response.data;
}

// ═══════════════════════════════════════════════════════════════════════════
// Loading Skeleton
// ═══════════════════════════════════════════════════════════════════════════

function HistorySkeleton() {
  return (
    <div className="space-y-4">
      {[1, 2, 3].map((i) => (
        <div key={i} className="h-24 bg-white/5 rounded-xl animate-pulse" />
      ))}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Empty State
// ═══════════════════════════════════════════════════════════════════════════

function EmptyState({ onStartChat }: { onStartChat: () => void }) {
  return (
    <div className="flex flex-col items-center justify-center py-16 text-center">
      <div className="w-20 h-20 rounded-full bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center mb-6">
        <Star className="w-10 h-10 text-indigo-500" />
      </div>
      <h2 className="text-xl font-semibold mb-2">还没有分析记录</h2>
      <p className="text-muted-foreground mb-6 max-w-sm">
        开始一次星盘分析，AI 会自动保存你的分析记录，方便日后回顾。
      </p>
      <button
        onClick={onStartChat}
        className="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
      >
        开始星盘分析
      </button>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Main Component
// ═══════════════════════════════════════════════════════════════════════════

export default function ZodiacHistoryPage(): React.ReactElement {
  const router = useRouter();
  const { user } = useAuth();

  const { data, error, isLoading, mutate } = useSWR(
    user ? 'zodiac-insights' : null,
    fetchInsights,
    { revalidateOnFocus: false }
  );

  const handleShare = async (insight: ZodiacInsight) => {
    try {
      const response = await apiClient.post<{
        status: string;
        share_url: string;
        share_token: string;
        expires_at: string;
      }>('/api/v1/skills/zodiac/share', {
        args: { insight_id: insight.id },
      });

      if (response.data.status === 'success') {
        const shareUrl = window.location.origin + response.data.share_url;

        // Try to use native share API if available
        if (navigator.share) {
          await navigator.share({
            title: insight.title,
            text: '看看我的星盘分析！',
            url: shareUrl,
          });
        } else {
          // Fallback: copy to clipboard
          await navigator.clipboard.writeText(shareUrl);
          alert(`分享链接已复制！\n${shareUrl}\n\n链接有效期 7 天`);
        }
      } else {
        alert('生成分享链接失败，请稍后重试');
      }
    } catch (error) {
      console.error('Share failed:', error);
      alert('分享失败，请稍后重试');
    }
  };

  const handleDelete = async (insightId: string) => {
    // TODO: Implement delete API
    console.log('Delete:', insightId);
  };

  const handleStartChat = () => {
    router.push('/chat?prompt=帮我分析一下我的星盘');
  };

  // Redirect to login if not authenticated
  if (!user) {
    router.push('/auth/login?redirect=/zodiac/history');
    return <></>;
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-bg-primary to-bg-secondary">
      {/* Header */}
      <header className="sticky top-0 z-10 bg-bg-primary/80 backdrop-blur-xl border-b border-white/5">
        <div className="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
          <button
            onClick={() => router.back()}
            className="flex items-center gap-2 text-text-secondary hover:text-text-primary transition-colors"
          >
            <ArrowLeft className="w-5 h-5" />
            <span>返回</span>
          </button>

          <h1 className="text-lg font-semibold flex items-center gap-2">
            <History className="w-5 h-5 text-indigo-500" />
            <span>分析历史</span>
          </h1>

          <div className="w-16" /> {/* Spacer for alignment */}
        </div>
      </header>

      <main className="max-w-4xl mx-auto px-4 py-6">
        {/* Stats Header */}
        {data && data.insights.length > 0 && (
          <div className="mb-6 p-4 rounded-xl bg-indigo-50 dark:bg-indigo-950/30 border border-indigo-200 dark:border-indigo-800">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-indigo-600 dark:text-indigo-300">
                  共 {data.total} 次星盘分析
                </p>
              </div>
              <button
                onClick={handleStartChat}
                className="px-4 py-2 text-sm bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors"
              >
                新建分析
              </button>
            </div>
          </div>
        )}

        {/* Content */}
        {isLoading ? (
          <HistorySkeleton />
        ) : error ? (
          <div className="text-center py-16">
            <p className="text-red-500 mb-4">加载失败</p>
            <button
              onClick={() => mutate()}
              className="text-indigo-500 hover:underline"
            >
              重试
            </button>
          </div>
        ) : data && data.insights.length > 0 ? (
          <div className="space-y-4">
            {data.insights.map((insight) => (
              <ZodiacHistoryCard
                key={insight.id}
                insight={insight}
                onShare={handleShare}
                onDelete={handleDelete}
              />
            ))}
          </div>
        ) : (
          <EmptyState onStartChat={handleStartChat} />
        )}
      </main>
    </div>
  );
}
