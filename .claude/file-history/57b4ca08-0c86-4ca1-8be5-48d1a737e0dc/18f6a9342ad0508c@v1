#!/usr/bin/env python3
"""
é€šè¿‡ HTTP API æµ‹è¯• Protocol å¡ç‰‡æ¸²æŸ“

å‘é€æµ‹è¯•æ¶ˆæ¯åˆ° /v5/chatï¼ŒéªŒè¯å¡ç‰‡æ˜¯å¦æ­£ç¡®è¿”å›
"""

import asyncio
import httpx
import json
from datetime import datetime


BASE_URL = "http://localhost:8100"
TEST_USER_ID = "test_protocol_cards"
TEST_CONVERSATION_ID = f"conv_{datetime.now().strftime('%Y%m%d_%H%M%S')}"


async def create_test_message(content: str, tool_results: list = None):
    """åˆ›å»ºæµ‹è¯•æ¶ˆæ¯"""
    return {
        "conversation_id": TEST_CONVERSATION_ID,
        "user_id": TEST_USER_ID,
        "message": content,
        "skill_id": "lifecoach",
        "tool_results": tool_results or []
    }


async def send_chat_request(message_data: dict):
    """å‘é€èŠå¤©è¯·æ±‚"""
    async with httpx.AsyncClient(timeout=30.0) as client:
        try:
            response = await client.post(
                f"{BASE_URL}/v5/chat",
                json=message_data,
                headers={"Content-Type": "application/json"}
            )
            response.raise_for_status()
            return response.json()
        except Exception as e:
            print(f"âŒ è¯·æ±‚å¤±è´¥: {e}")
            return None


async def test_protocol_cards_via_api():
    """é€šè¿‡ API æµ‹è¯• Protocol å¡ç‰‡"""
    print("\n" + "="*80)
    print("ğŸ“¡ é€šè¿‡ API æµ‹è¯• Protocol å¡ç‰‡æ¸²æŸ“")
    print("="*80)

    # æµ‹è¯•1: æ¨¡æ‹Ÿ AI è¿”å›è¿›åº¦å¡ç‰‡
    print("\næµ‹è¯• 1: Protocol è¿›åº¦å¡ç‰‡")
    print("-"*80)

    message1 = await create_test_message(
        "å¼€å§‹æ„¿æ™¯è®¾è®¡",
        tool_results=[
            {
                "tool_name": "show_protocol_progress",
                "result": {
                    "card_type": "protocol_progress",
                    "data": {
                        "protocol_id": "dankoe_vision",
                        "protocol_name": "æ„¿æ™¯è®¾è®¡åè®®",
                        "step": 1,
                        "total": 8,
                        "phase": "Phase 1",
                        "phase_name": "å‹¾å‹’æ„¿æ™¯ç”»é¢",
                        "is_completed": False,
                        "generated_at": datetime.utcnow().isoformat()
                    }
                }
            }
        ]
    )

    response1 = await send_chat_request(message1)
    if response1:
        cards = response1.get("tool_results", [])
        print(f"âœ… æ”¶åˆ° {len(cards)} ä¸ªå¡ç‰‡")
        for card in cards:
            if card.get("result", {}).get("card_type") == "protocol_progress":
                print(f"  - Protocolè¿›åº¦å¡ç‰‡: {card['result']['data']['protocol_name']}")
                print(f"    è¿›åº¦: {card['result']['data']['step']}/{card['result']['data']['total']}")

    # æµ‹è¯•2: æ­¥éª¤å¡ç‰‡
    print("\næµ‹è¯• 2: Protocol æ­¥éª¤å¡ç‰‡")
    print("-"*80)

    message2 = await create_test_message(
        "ç»§ç»­",
        tool_results=[
            {
                "tool_name": "show_protocol_step",
                "result": {
                    "card_type": "protocol_step",
                    "data": {
                        "step_number": 1,
                        "step_name": "æç»˜ç†æƒ³åœºæ™¯",
                        "content": "é—­ä¸Šçœ¼ç›ï¼Œæƒ³è±¡3å¹´åçš„ä¸€ä¸ªæ™®é€šå‘¨äºŒ...\n\nè¯·å‘Šè¯‰æˆ‘ï¼šä½ åœ¨å“ªé‡Œï¼Ÿä½ åœ¨åšä»€ä¹ˆï¼Ÿ",
                        "is_question": True,
                        "options": [],
                        "generated_at": datetime.utcnow().isoformat()
                    }
                }
            }
        ]
    )

    response2 = await send_chat_request(message2)
    if response2:
        cards = response2.get("tool_results", [])
        print(f"âœ… æ”¶åˆ° {len(cards)} ä¸ªå¡ç‰‡")
        for card in cards:
            if card.get("result", {}).get("card_type") == "protocol_step":
                print(f"  - Protocolæ­¥éª¤å¡ç‰‡: {card['result']['data']['step_name']}")
                print(f"    æ˜¯å¦ä¸ºé—®é¢˜: {card['result']['data']['is_question']}")

    # æµ‹è¯•3: å®Œæˆå¡ç‰‡
    print("\næµ‹è¯• 3: Protocol å®Œæˆå¡ç‰‡")
    print("-"*80)

    message3 = await create_test_message(
        "å®Œæˆ",
        tool_results=[
            {
                "tool_name": "show_protocol_completion",
                "result": {
                    "card_type": "protocol_completion",
                    "data": {
                        "protocol_name": "æ„¿æ™¯è®¾è®¡åè®®",
                        "completed_steps": 8,
                        "total_steps": 8,
                        "summary": "æ­å–œï¼ä½ å·²ç»å®Œæˆäº†æ„¿æ™¯è®¾è®¡åè®®ã€‚\n\nä½ çš„è®¾è®¡å·²ä¿å­˜åˆ°äººç”Ÿåœ°å›¾ã€‚",
                        "next_actions": [
                            "è®¾å®šä¸€å¹´ç›®æ ‡",
                            "è®¾è®¡æœ¬æœˆé¡¹ç›®",
                            "è§„åˆ’æ¯æ—¥è¡ŒåŠ¨"
                        ],
                        "generated_at": datetime.utcnow().isoformat()
                    }
                }
            }
        ]
    )

    response3 = await send_chat_request(message3)
    if response3:
        cards = response3.get("tool_results", [])
        print(f"âœ… æ”¶åˆ° {len(cards)} ä¸ªå¡ç‰‡")
        for card in cards:
            if card.get("result", {}).get("card_type") == "protocol_completion":
                print(f"  - Protocolå®Œæˆå¡ç‰‡: {card['result']['data']['protocol_name']}")
                print(f"    å®Œæˆæ­¥éª¤: {card['result']['data']['completed_steps']}/{card['result']['data']['total_steps']}")
                print(f"    åç»­è¡ŒåŠ¨: {len(card['result']['data']['next_actions'])} é¡¹")

    print("\n" + "="*80)
    print("âœ… API æµ‹è¯•å®Œæˆ")
    print("="*80)
    print("\nğŸ’¡ æç¤º:")
    print("  - å‰ç«¯åº”è¯¥èƒ½æ­£ç¡®æ¸²æŸ“è¿™äº›å¡ç‰‡")
    print("  - åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:8232 æŸ¥çœ‹æ•ˆæœ")
    print("  - å¡ç‰‡ä¼šåµŒå…¥åœ¨å¯¹è¯æµä¸­æ˜¾ç¤º")


async def main():
    """ä¸»å‡½æ•°"""
    try:
        await test_protocol_cards_via_api()
    except KeyboardInterrupt:
        print("\n\nâš ï¸ æµ‹è¯•ä¸­æ–­")
    except Exception as e:
        print(f"\n\nâŒ æµ‹è¯•å‡ºé”™: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    asyncio.run(main())
