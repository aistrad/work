# Protocol 系统用户场景测试方案

## 场景设计原则

基于真实用户行为设计以下测试场景：

### 场景分类
1. **理想路径** - 用户顺利完成全流程
2. **常见偏差** - 用户中途打断、简短回答、跳过问题
3. **边界情况** - 重复启动、数据异常、系统错误
4. **用户体验** - 响应时间、视觉反馈、引导清晰度

---

## 测试场景详细设计

### 场景 1: 理想流程 - 顺利完成 6 步
**用户画像**: 目标明确、配合度高的用户
**测试重点**: 完整流程、数据保存、卡片渲染

**对话流程**:
```
用户: "帮我用 Dan Koe 方法做一次人生重置"
AI: [调用 start_protocol]
    [显示 invitation 卡片]
    "好的，我们来做一次 Dan Koe 的快速重置..."
用户: "准备好了"
AI: [显示 progress 1/6]
    [显示 step 1: 持续的不满]
用户: "工作没意义，每天重复劳动，感觉身体越来越疲惫"
AI: [调用 continue_protocol(step=1)]
    [保存到 north_star.pain_points]
    [显示 progress 2/6]
    [显示 step 2: 反愿景场景]
... (继续完成 6 步)
```

**验证点**:
- ✅ start_protocol 正确返回第一步数据
- ✅ 每步 continue_protocol 正确保存和推进
- ✅ 进度卡片显示 1/6 → 6/6
- ✅ 最后调用 show_protocol_completion
- ✅ 数据正确保存到 lifecoach_state

---

### 场景 2: 中途打断 - 切换话题
**用户画像**: 注意力分散、突发想法的用户
**测试重点**: 状态保存、断点续传

**对话流程**:
```
用户: "帮我用 Dan Koe 方法..."
AI: [开始协议，进入第 1 步]
用户: "工作没意义"
AI: [推进到第 2 步]
用户: "等等，我想先问个别的问题，我该怎么提升工作效率？"
AI: [探索式对话模式，回答工作效率问题]
用户: "好的，我们继续刚才的协议"
AI: [读取 protocol state，继续第 2 步]
```

**验证点**:
- ✅ 协议状态正确保存在 lifecoach_state.protocol
- ✅ AI 能识别用户想继续协议
- ✅ 能从中断点恢复（step=2）
- ⚠️ 当前实现：可能需要 AI 手动检查状态

---

### 场景 3: 简短回答 - 一个词
**用户画像**: 话少、不善表达的用户
**测试重点**: 追问机制、response_prompt 指导

**对话流程**:
```
AI: [Step 1: 持续的不满是什么？]
用户: "累"
AI: [根据 response_prompt 追问]
    "累——这个感觉持续多久了？"
用户: "两年了"
AI: "两年了，这确实是很长的时间。
    能再具体说说，是身体上的累，还是心理上的累？"
用户: "都有吧，主要是心累"
AI: "明白了。好，我们继续下一个问题。"
    [推进到 step 2]
```

**验证点**:
- ✅ AI 使用 response_prompt 指导追问
- ✅ 不直接推进，而是深入理解
- ✅ 用户给出更多细节后才继续
- ⚠️ 依赖 AI 理解能力

---

### 场景 4: 详细回答 - 一大段话
**用户画像**: 善于表达、倾诉欲强的用户
**测试重点**: 数据提取、总结能力

**对话流程**:
```
AI: [Step 1: 持续的不满是什么？]
用户: "工作没意义，每天做着重复的事情，老板也不关心我们的想法，
      同事都很功利，下班后还要加班，周末也被工作占满，
      没有时间陪家人，身体也越来越差，经常失眠..."
AI: [总结提取关键点]
    "听起来你提到了几个核心的不满：
     • 工作重复、缺乏意义
     • 加班多、缺乏个人时间
     • 身体健康受影响
    这个状态持续多久了？"
用户: "大概两年"
AI: "两年了。好，我们继续下一个问题。"
    [保存: ["工作重复缺乏意义", "加班多", "身体健康差"]]
```

**验证点**:
- ✅ AI 能从长文本提取关键点
- ✅ 保存为数组格式（save_type: array）
- ✅ 简短确认，不重复用户所有内容
- ⚠️ 依赖 AI 总结能力

---

### 场景 5: 重复启动 - 用户已有进行中的协议
**用户画像**: 尝试重新开始的用户
**测试重点**: 状态冲突、错误处理

**对话流程 A - 有未完成协议**:
```
[用户上次执行到 step 3，未完成]
用户: "帮我用 Dan Koe 方法做一次重置"
AI: [检查 lifecoach_state.protocol]
    "我看到你之前开始了 Dan Koe 协议，还在第 3 步（愿景场景）。
     想继续之前的协议，还是重新开始？"
用户: "继续之前的"
AI: [从 step 3 恢复]
    [显示 progress 3/6]
    [显示 step 3]
```

**对话流程 B - 用户要重新开始**:
```
用户: "重新开始"
AI: [调用 cancel_protocol]
    [调用 start_protocol 重新初始化]
    "好的，我们重新开始。"
    [显示 progress 1/6]
```

**验证点**:
- ✅ 检测到已有进行中的协议
- ✅ 提供继续/重新开始选项
- ✅ cancel_protocol 正确清理状态
- ⚠️ 当前实现：需要 AI 主动检查

---

### 场景 6: 快速完成 - 用户回答简洁
**用户画像**: 时间紧张、效率优先的用户
**测试重点**: 最小化交互、流程效率

**对话流程**:
```
用户: "帮我快速做一次 Dan Koe 重置，我只有5分钟"
AI: "明白，我会尽量简洁。准备好了吗？"
用户: "好"
AI: [Step 1: 持续的不满]
用户: "工作没意义"
AI: "收到。" [直接推进，不追问]
    [Step 2: 反愿景]
用户: "还是在公司，疲惫空虚"
AI: "明白。" [直接推进]
... (快速完成 6 步，约 3-5 分钟)
```

**验证点**:
- ✅ AI 识别用户时间限制
- ✅ 减少追问，快速推进
- ✅ 保持流程完整性
- ⚠️ 依赖 AI 适应能力

---

### 场景 7: 错误恢复 - 工具调用失败
**用户画像**: 遇到系统错误的用户
**测试重点**: 错误处理、用户友好提示

**对话流程**:
```
用户: "帮我用 Dan Koe 方法..."
AI: [调用 start_protocol]
    ❌ 错误: 数据库连接失败
AI: "抱歉，系统遇到了一点问题。
    让我们换个方式，我直接问你第一个问题：
    过去一年，你学会忍受的、持续的不满是什么？"
用户: [回答]
AI: [降级模式：手动问问题，手动保存数据]
```

**验证点**:
- ✅ 优雅降级，不让用户感知错误
- ✅ 仍然能完成协议流程
- ⚠️ 可能缺少进度卡片
- ⚠️ 需要手动管理状态

---

## 测试实施计划

### 自动化测试
```bash
# 测试脚本
python scripts/test_protocol_scenarios.py

# 覆盖场景
1. ✅ 理想流程
2. ⚠️ 中途打断（需要模拟状态保存/恢复）
3. ⚠️ 简短/详细回答（需要 AI 判断）
4. ✅ 重复启动（可测试状态检测）
5. ✅ 错误恢复（可模拟错误）
```

### 手动测试
- 场景 3, 4, 6（依赖 AI 实时表现）
- 在真实对话中验证体验

---

## 关键发现（预测）

### 当前实现的优势
1. ✅ 理想流程完全自动化
2. ✅ 引擎处理配置和状态
3. ✅ 卡片视觉反馈清晰

### 潜在问题
1. ⚠️ 断点续传需要 AI 主动检查状态
2. ⚠️ 错误处理可能不够优雅
3. ⚠️ 依赖 AI 理解 response_prompt
4. ⚠️ 缺少显式的"继续协议"命令

### 改进建议
1. 在对话开始时自动检查未完成协议
2. 添加 resume_protocol 工具
3. 添加更多错误提示和降级逻辑
4. 考虑添加"跳过"、"返回"等控制命令

---

## 下一步
创建 `test_protocol_scenarios.py` 执行自动化测试
