#!/usr/bin/env python3
"""
Protocol å¼•æ“å¿«é€ŸéªŒè¯è„šæœ¬

æµ‹è¯•ï¼š
1. Protocol å¼•æ“èƒ½å¦æ­£ç¡®åŠ è½½ yaml é…ç½®
2. start_protocol å·¥å…·èƒ½å¦æ­£ç¡®è¿”å›ç¬¬ä¸€æ­¥æ•°æ®
3. continue_protocol å·¥å…·èƒ½å¦æ­£ç¡®æ¨è¿›æ­¥éª¤
4. æ‰€æœ‰å¡ç‰‡å·¥å…·èƒ½å¦æ­£ç¡®æ ¼å¼åŒ–æ•°æ®
"""

import asyncio
import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from skills.lifecoach.protocols.engine import get_protocol_engine


def test_engine_load_config():
    """æµ‹è¯•é…ç½®åŠ è½½"""
    print("\n" + "="*80)
    print("æµ‹è¯• 1: åŠ è½½ dankoe.yaml é…ç½®")
    print("="*80)

    try:
        engine = get_protocol_engine()
        config = engine.load_config("dankoe")

        print(f"âœ… é…ç½®åŠ è½½æˆåŠŸ")
        print(f"  åè®®ID: {config['id']}")
        print(f"  åè®®åç§°: {config['name']}")
        print(f"  æ€»æ­¥éª¤æ•°: {config['total_steps']}")
        print(f"  é¢„è®¡æ—¶é—´: {config.get('estimated_time', 'N/A')}")
        print(f"  æ­¥éª¤æ•°é‡: {len(config.get('steps', {}))}")

        return True
    except Exception as e:
        print(f"âŒ é…ç½®åŠ è½½å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_engine_get_step_data():
    """æµ‹è¯•æ­¥éª¤æ•°æ®è·å–"""
    print("\n" + "="*80)
    print("æµ‹è¯• 2: è·å–æ­¥éª¤æ•°æ®")
    print("="*80)

    try:
        engine = get_protocol_engine()

        for step_num in [1, 3, 6]:
            step_data = engine.get_step_data("dankoe", step_num)
            print(f"\næ­¥éª¤ {step_num}:")
            print(f"  åç§°: {step_data['step_name']}")
            print(f"  é˜¶æ®µ: {step_data['phase']}")
            print(f"  ä¿å­˜åˆ°: {step_data['save_to']}")
            print(f"  ä¿å­˜ç±»å‹: {step_data['save_type']}")
            print(f"  é—®é¢˜é•¿åº¦: {len(step_data['question'])} å­—ç¬¦")

        print(f"\nâœ… æ­¥éª¤æ•°æ®è·å–æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ æ­¥éª¤æ•°æ®è·å–å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_engine_format_methods():
    """æµ‹è¯•æ ¼å¼åŒ–æ–¹æ³•"""
    print("\n" + "="*80)
    print("æµ‹è¯• 3: æ•°æ®æ ¼å¼åŒ–æ–¹æ³•")
    print("="*80)

    try:
        engine = get_protocol_engine()

        # æµ‹è¯• format_for_show_protocol_step
        step_data = engine.format_for_show_protocol_step("dankoe", 1)
        print(f"\nformat_for_show_protocol_step:")
        print(f"  step_number: {step_data['step_number']}")
        print(f"  step_name: {step_data['step_name']}")
        print(f"  content é•¿åº¦: {len(step_data['content'])} å­—ç¬¦")
        print(f"  is_question: {step_data['is_question']}")

        # æµ‹è¯• format_for_show_protocol_progress
        progress_data = engine.format_for_show_protocol_progress("dankoe", 1)
        print(f"\nformat_for_show_protocol_progress:")
        print(f"  protocol_id: {progress_data['protocol_id']}")
        print(f"  protocol_name: {progress_data['protocol_name']}")
        print(f"  step: {progress_data['step']}/{progress_data['total']}")
        print(f"  phase: {progress_data['phase']}")
        print(f"  phase_name: {progress_data['phase_name']}")

        # æµ‹è¯• is_last_step
        print(f"\nis_last_step æµ‹è¯•:")
        print(f"  æ­¥éª¤ 1: {engine.is_last_step('dankoe', 1)}")
        print(f"  æ­¥éª¤ 6: {engine.is_last_step('dankoe', 6)}")

        # æµ‹è¯• get_completion_data
        completion_data = engine.get_completion_data("dankoe")
        print(f"\nget_completion_data:")
        print(f"  protocol_name: {completion_data['protocol_name']}")
        print(f"  total_steps: {completion_data['total_steps']}")
        print(f"  completion_tool: {completion_data.get('completion_tool')}")

        print(f"\nâœ… æ ¼å¼åŒ–æ–¹æ³•æµ‹è¯•æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ æ ¼å¼åŒ–æ–¹æ³•æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_all_steps_sequence():
    """æµ‹è¯•å®Œæ•´æ­¥éª¤åºåˆ—"""
    print("\n" + "="*80)
    print("æµ‹è¯• 4: å®Œæ•´æ­¥éª¤åºåˆ—")
    print("="*80)

    try:
        engine = get_protocol_engine()
        config = engine.load_config("dankoe")
        total_steps = config["total_steps"]

        print(f"\næ¨¡æ‹Ÿå®Œæ•´ Protocol æµç¨‹ï¼ˆ{total_steps} æ­¥ï¼‰:")

        for step in range(1, total_steps + 1):
            step_data = engine.get_step_data("dankoe", step)
            progress_data = engine.format_for_show_protocol_progress("dankoe", step)

            print(f"\n--- æ­¥éª¤ {step}/{total_steps} ---")
            print(f"é˜¶æ®µ: {progress_data['phase']} - {progress_data['phase_name']}")
            print(f"åç§°: {step_data['step_name']}")
            print(f"ä¿å­˜: {step_data['save_to']} ({step_data['save_type']})")
            print(f"æ˜¯æœ€åä¸€æ­¥: {engine.is_last_step('dankoe', step)}")

        print(f"\nâœ… å®Œæ•´æ­¥éª¤åºåˆ—éªŒè¯æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ å®Œæ•´æ­¥éª¤åºåˆ—éªŒè¯å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


def test_response_prompts():
    """æµ‹è¯• response_prompt æå–"""
    print("\n" + "="*80)
    print("æµ‹è¯• 5: Response Prompt æå–")
    print("="*80)

    try:
        engine = get_protocol_engine()

        for step in [1, 2, 6]:
            response_prompt = engine.get_response_prompt("dankoe", step)
            print(f"\næ­¥éª¤ {step} çš„ response_prompt:")
            print(f"  é•¿åº¦: {len(response_prompt)} å­—ç¬¦")
            print(f"  å‰100å­—: {response_prompt[:100]}...")

        print(f"\nâœ… Response Prompt æå–æˆåŠŸ")
        return True
    except Exception as e:
        print(f"âŒ Response Prompt æå–å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\nğŸ§ª Protocol å¼•æ“éªŒè¯æµ‹è¯•")
    print("="*80)

    tests = [
        ("é…ç½®åŠ è½½", test_engine_load_config),
        ("æ­¥éª¤æ•°æ®è·å–", test_engine_get_step_data),
        ("æ ¼å¼åŒ–æ–¹æ³•", test_engine_format_methods),
        ("å®Œæ•´æ­¥éª¤åºåˆ—", test_all_steps_sequence),
        ("Response Prompt", test_response_prompts),
    ]

    results = []
    for name, test_func in tests:
        try:
            result = test_func()
            results.append((name, "âœ… é€šè¿‡" if result else "âŒ å¤±è´¥"))
        except Exception as e:
            results.append((name, f"âŒ é”™è¯¯: {str(e)}"))
            import traceback
            traceback.print_exc()

    # è¾“å‡ºæµ‹è¯•ç»“æœ
    print("\n" + "="*80)
    print("æµ‹è¯•ç»“æœæ±‡æ€»")
    print("="*80)
    for name, status in results:
        print(f"  {name}: {status}")

    # ç»Ÿè®¡
    passed = sum(1 for _, status in results if "âœ…" in status)
    total = len(results)
    print(f"\næ€»è®¡: {passed}/{total} é€šè¿‡")

    return passed == total


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
