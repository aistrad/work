#!/usr/bin/env python3
"""
åˆ›å»º Protocol æµ‹è¯•ä¸“ç”¨ç”¨æˆ·

åˆ›å»º 4 ä¸ªæµ‹è¯•ç”¨æˆ·ï¼Œç”¨äº test_protocol_scenarios.py æµ‹è¯•ï¼š
1. TEST_USER_COMPLETE - å®Œæ•´æµç¨‹æµ‹è¯•
2. TEST_USER_INTERRUPT - ä¸­æ–­æ¢å¤æµ‹è¯•
3. TEST_USER_CANCEL - åè®®å–æ¶ˆæµ‹è¯•
4. TEST_USER_BOUNDARY - è¾¹ç•Œæƒ…å†µæµ‹è¯•

ä½¿ç”¨æ–¹æ³•ï¼š
  python scripts/create_test_users.py
"""

import asyncio
import sys
from pathlib import Path
from uuid import UUID
from datetime import datetime

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection, execute, fetchval


# æµ‹è¯•ç”¨æˆ·å®šä¹‰ï¼ˆä¸ test_protocol_scenarios.py ä¿æŒä¸€è‡´ï¼‰
TEST_USERS = [
    {
        "id": UUID("00000000-0000-0000-0000-000000000001"),
        "email": "test-protocol-complete@vibelife.test",
        "vibe_id": "VB-TEST0001",
        "display_name": "æµ‹è¯•-å®Œæ•´æµç¨‹",
        "description": "ç”¨äºæµ‹è¯•å®Œæ•´çš„ 6 æ­¥ Protocol æµç¨‹"
    },
    {
        "id": UUID("00000000-0000-0000-0000-000000000002"),
        "email": "test-protocol-interrupt@vibelife.test",
        "vibe_id": "VB-TEST0002",
        "display_name": "æµ‹è¯•-ä¸­æ–­æ¢å¤",
        "description": "ç”¨äºæµ‹è¯• Protocol ä¸­é€”æš‚åœå’Œæ¢å¤"
    },
    {
        "id": UUID("00000000-0000-0000-0000-000000000003"),
        "email": "test-protocol-cancel@vibelife.test",
        "vibe_id": "VB-TEST0003",
        "display_name": "æµ‹è¯•-åè®®å–æ¶ˆ",
        "description": "ç”¨äºæµ‹è¯• Protocol å–æ¶ˆåŠŸèƒ½"
    },
    {
        "id": UUID("00000000-0000-0000-0000-000000000004"),
        "email": "test-protocol-boundary@vibelife.test",
        "vibe_id": "VB-TEST0004",
        "display_name": "æµ‹è¯•-è¾¹ç•Œæƒ…å†µ",
        "description": "ç”¨äºæµ‹è¯•è¾¹ç•Œè¾“å…¥ï¼ˆç©ºå€¼ã€é•¿æ–‡æœ¬ã€ç‰¹æ®Šå­—ç¬¦ç­‰ï¼‰"
    },
]


async def user_exists(user_id: UUID) -> bool:
    """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨"""
    exists = await fetchval(
        "SELECT 1 FROM vibe_users WHERE id = $1",
        user_id
    )
    return bool(exists)


async def profile_exists(user_id: UUID) -> bool:
    """æ£€æŸ¥ profile æ˜¯å¦å­˜åœ¨"""
    exists = await fetchval(
        "SELECT 1 FROM unified_profiles WHERE user_id = $1",
        user_id
    )
    return bool(exists)


async def create_test_user(user_data: dict) -> None:
    """åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨æˆ·"""
    user_id = user_data["id"]
    email = user_data["email"]
    vibe_id = user_data["vibe_id"]
    display_name = user_data["display_name"]

    print(f"\n[åˆ›å»º] {display_name} ({vibe_id})")

    # 1. æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if await user_exists(user_id):
        print(f"  âš ï¸  ç”¨æˆ·å·²å­˜åœ¨äº vibe_usersï¼Œè·³è¿‡åˆ›å»º")
    else:
        # åˆ›å»º vibe_users è®°å½•
        await execute(
            """INSERT INTO vibe_users (id, email, vibe_id, tier, status, created_at, updated_at)
               VALUES ($1, $2, $3, $4, $5, $6, $7)""",
            user_id,
            email,
            vibe_id,
            "free",
            "active",
            datetime.utcnow(),
            datetime.utcnow()
        )
        print(f"  âœ… åˆ›å»º vibe_users è®°å½•")

    # 2. æ£€æŸ¥ profile æ˜¯å¦å­˜åœ¨
    if await profile_exists(user_id):
        print(f"  âš ï¸  Profile å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º")
    else:
        # åˆ›å»º unified_profiles è®°å½•
        import json
        profile_data = {
            "account": {
                "vibe_id": vibe_id,
                "display_name": display_name,
                "tier": "free",
                "status": "active"
            },
            "preferences": {
                "language": "zh-CN",
                "timezone": "Asia/Shanghai"
            },
            "skills": {},
            "skill_data": {}
        }

        await execute(
            """INSERT INTO unified_profiles (user_id, profile, created_at, updated_at)
               VALUES ($1, $2::jsonb, $3, $4)""",
            user_id,
            json.dumps(profile_data, ensure_ascii=False),
            datetime.utcnow(),
            datetime.utcnow()
        )
        print(f"  âœ… åˆ›å»º unified_profiles è®°å½•")

    print(f"  âœ… ç”¨æˆ·åˆ›å»ºå®Œæˆ")


async def verify_test_users() -> None:
    """éªŒè¯æ‰€æœ‰æµ‹è¯•ç”¨æˆ·æ˜¯å¦æ­£ç¡®åˆ›å»º"""
    print("\n" + "=" * 80)
    print("éªŒè¯æµ‹è¯•ç”¨æˆ·")
    print("=" * 80)

    all_ok = True

    for user_data in TEST_USERS:
        user_id = user_data["id"]
        vibe_id = user_data["vibe_id"]

        has_user = await user_exists(user_id)
        has_profile = await profile_exists(user_id)

        status = "âœ…" if (has_user and has_profile) else "âŒ"
        print(f"{status} {vibe_id}: vibe_users={has_user}, unified_profiles={has_profile}")

        if not (has_user and has_profile):
            all_ok = False

    if all_ok:
        print("\nâœ… æ‰€æœ‰æµ‹è¯•ç”¨æˆ·éªŒè¯é€šè¿‡ï¼")
    else:
        print("\nâŒ éƒ¨åˆ†æµ‹è¯•ç”¨æˆ·åˆ›å»ºå¤±è´¥")
        sys.exit(1)


async def cleanup_test_users() -> None:
    """æ¸…ç†æµ‹è¯•ç”¨æˆ·æ•°æ®ï¼ˆå¯é€‰ï¼‰"""
    print("\n" + "=" * 80)
    print("æ¸…ç†æµ‹è¯•ç”¨æˆ·æ•°æ®")
    print("=" * 80)

    for user_data in TEST_USERS:
        user_id = user_data["id"]
        vibe_id = user_data["vibe_id"]

        # æ¸…ç† lifecoach skill æ•°æ®
        await execute(
            """UPDATE unified_profiles
               SET profile = jsonb_set(
                   profile,
                   '{skills}',
                   COALESCE(profile -> 'skills', '{}'::jsonb) - 'lifecoach'
               )
               WHERE user_id = $1""",
            user_id
        )
        print(f"  âœ… æ¸…ç† {vibe_id} çš„ lifecoach æ•°æ®")

    print("\nâœ… æµ‹è¯•ç”¨æˆ·æ•°æ®æ¸…ç†å®Œæˆ")


async def delete_test_users() -> None:
    """åˆ é™¤æµ‹è¯•ç”¨æˆ·ï¼ˆå±é™©æ“ä½œï¼Œä»…åœ¨ç¡®è®¤æ—¶ä½¿ç”¨ï¼‰"""
    print("\n" + "=" * 80)
    print("âš ï¸  åˆ é™¤æµ‹è¯•ç”¨æˆ·ï¼ˆä¸å¯æ¢å¤ï¼‰")
    print("=" * 80)

    # ç¡®è®¤
    print("\næ˜¯å¦ç¡®è®¤åˆ é™¤æ‰€æœ‰æµ‹è¯•ç”¨æˆ·ï¼Ÿ")
    print("è¿™å°†åˆ é™¤ï¼š")
    for user_data in TEST_USERS:
        print(f"  - {user_data['vibe_id']} ({user_data['display_name']})")

    response = input("\nè¾“å…¥ 'DELETE' ç¡®è®¤åˆ é™¤: ")
    if response != "DELETE":
        print("âŒ æ“ä½œå·²å–æ¶ˆ")
        return

    for user_data in TEST_USERS:
        user_id = user_data["id"]
        vibe_id = user_data["vibe_id"]

        # åˆ é™¤ unified_profiles
        await execute(
            "DELETE FROM unified_profiles WHERE user_id = $1",
            user_id
        )

        # åˆ é™¤ vibe_users
        await execute(
            "DELETE FROM vibe_users WHERE id = $1",
            user_id
        )

        print(f"  âœ… åˆ é™¤ {vibe_id}")

    print("\nâœ… æ‰€æœ‰æµ‹è¯•ç”¨æˆ·å·²åˆ é™¤")


async def main():
    """ä¸»å‡½æ•°"""
    print("\n" + "â•”" + "=" * 78 + "â•—")
    print("â•‘" + " " * 20 + "Protocol æµ‹è¯•ç”¨æˆ·ç®¡ç†" + " " * 38 + "â•‘")
    print("â•š" + "=" * 78 + "â•")

    # æ˜¾ç¤ºèœå•
    print("\nè¯·é€‰æ‹©æ“ä½œï¼š")
    print("  1. åˆ›å»ºæµ‹è¯•ç”¨æˆ·ï¼ˆæ¨èï¼‰")
    print("  2. éªŒè¯æµ‹è¯•ç”¨æˆ·")
    print("  3. æ¸…ç†æµ‹è¯•æ•°æ®ï¼ˆä¿ç•™ç”¨æˆ·ï¼Œæ¸…ç† lifecoach æ•°æ®ï¼‰")
    print("  4. åˆ é™¤æµ‹è¯•ç”¨æˆ·ï¼ˆå±é™©ï¼ï¼‰")
    print("  5. é€€å‡º")

    choice = input("\nè¯·è¾“å…¥é€‰é¡¹ (1-5): ").strip()

    if choice == "1":
        print("\n" + "=" * 80)
        print("åˆ›å»ºæµ‹è¯•ç”¨æˆ·")
        print("=" * 80)

        for user_data in TEST_USERS:
            await create_test_user(user_data)

        # è‡ªåŠ¨éªŒè¯
        await verify_test_users()

    elif choice == "2":
        await verify_test_users()

    elif choice == "3":
        await cleanup_test_users()

    elif choice == "4":
        await delete_test_users()

    elif choice == "5":
        print("\nğŸ‘‹ å†è§ï¼")
        return

    else:
        print("\nâŒ æ— æ•ˆé€‰é¡¹")
        sys.exit(1)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\næ“ä½œå·²å–æ¶ˆ")
        sys.exit(0)
    except Exception as e:
        print(f"\n\nâŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
