"""
Protocol 引擎辅助工具

简化的 Protocol 执行辅助，自动读取 yaml 配置并管理状态
"""

import yaml
from pathlib import Path
from typing import Dict, Any, Optional
from datetime import datetime


class ProtocolEngine:
    """Protocol 执行辅助引擎"""

    def __init__(self, protocols_dir: Path):
        self.protocols_dir = protocols_dir
        self._configs_cache = {}

    def load_config(self, protocol_id: str) -> Dict[str, Any]:
        """加载协议配置"""
        if protocol_id in self._configs_cache:
            return self._configs_cache[protocol_id]

        config_path = self.protocols_dir / f"{protocol_id}.yaml"
        if not config_path.exists():
            raise FileNotFoundError(f"协议配置不存在: {protocol_id}")

        with open(config_path, "r", encoding="utf-8") as f:
            config = yaml.safe_load(f)

        self._configs_cache[protocol_id] = config
        return config

    def get_step_data(self, protocol_id: str, step_number: int) -> Dict[str, Any]:
        """获取指定步骤的数据"""
        config = self.load_config(protocol_id)

        if step_number not in config.get("steps", {}):
            raise ValueError(f"步骤 {step_number} 不存在")

        step_config = config["steps"][step_number]

        return {
            "step_number": step_number,
            "step_name": step_config["name"],
            "phase": step_config["phase"],
            "question": step_config["question"],
            "save_to": step_config.get("save_to"),
            "save_type": step_config.get("save_type", "string"),
            "response_prompt": step_config.get("response_prompt"),
            "extra_save": step_config.get("extra_save", [])
        }

    def format_for_show_protocol_step(
        self, protocol_id: str, step_number: int
    ) -> Dict[str, Any]:
        """格式化为 show_protocol_step 工具参数"""
        step_data = self.get_step_data(protocol_id, step_number)

        return {
            "step_number": step_number,
            "step_name": step_data["step_name"],
            "content": step_data["question"],
            "is_question": True  # Protocol 步骤总是问题
        }

    def format_for_show_protocol_progress(
        self, protocol_id: str, current_step: int
    ) -> Dict[str, Any]:
        """格式化为 show_protocol_progress 工具参数"""
        config = self.load_config(protocol_id)
        step_data = self.get_step_data(protocol_id, current_step)

        # 提取 phase ID 和 name
        phase_full = step_data["phase"]  # 如 "Phase 1: 觉醒"
        phase_parts = phase_full.split(":", 1)
        phase_id = phase_parts[0].strip()  # "Phase 1"
        phase_name = phase_parts[1].strip() if len(phase_parts) > 1 else ""

        return {
            "protocol_id": protocol_id,
            "protocol_name": config["name"],
            "step": current_step,
            "total": config["total_steps"],
            "phase": phase_id,
            "phase_name": phase_name,
            "is_completed": False
        }

    def get_save_instruction(self, protocol_id: str, step_number: int) -> Dict[str, Any]:
        """获取保存指令"""
        step_data = self.get_step_data(protocol_id, step_number)

        return {
            "save_to": step_data["save_to"],
            "save_type": step_data["save_type"],
            "extra_save": step_data["extra_save"]
        }

    def get_response_prompt(self, protocol_id: str, step_number: int) -> str:
        """获取 AI 回应的 prompt 指导"""
        step_data = self.get_step_data(protocol_id, step_number)
        return step_data.get("response_prompt", "")

    def is_last_step(self, protocol_id: str, step_number: int) -> bool:
        """判断是否为最后一步"""
        config = self.load_config(protocol_id)
        return step_number >= config["total_steps"]

    def get_completion_data(self, protocol_id: str) -> Dict[str, Any]:
        """获取完成数据（用于 show_protocol_completion）"""
        config = self.load_config(protocol_id)

        return {
            "protocol_name": config["name"],
            "total_steps": config["total_steps"],
            "completion_tool": config.get("completion_tool"),
            "completion_tool_args": config.get("completion_tool_args", {})
        }


# 全局实例（用于工具处理器）
_engine: Optional[ProtocolEngine] = None


def get_protocol_engine() -> ProtocolEngine:
    """获取全局 Protocol 引擎实例"""
    global _engine
    if _engine is None:
        from pathlib import Path
        protocols_dir = Path(__file__).parent
        _engine = ProtocolEngine(protocols_dir)
    return _engine
