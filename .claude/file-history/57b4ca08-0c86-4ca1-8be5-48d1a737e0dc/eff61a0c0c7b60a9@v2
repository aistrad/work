#!/usr/bin/env python3
"""
æµ‹è¯• Protocol å†…è”å¡ç‰‡å±•ç¤ºåŠŸèƒ½

æµ‹è¯•åœºæ™¯ï¼š
1. show_protocol_progress - å±•ç¤ºè¿›åº¦å¡ç‰‡
2. show_protocol_step - å±•ç¤ºæ­¥éª¤å¡ç‰‡
3. show_protocol_completion - å±•ç¤ºå®Œæˆå¡ç‰‡
4. æ¨¡æ‹Ÿå®Œæ•´ Protocol æµç¨‹
"""

import asyncio
import sys
import os
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ° Python è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from skills.lifecoach.tools.handlers import (
    show_protocol_progress,
    show_protocol_step,
    show_protocol_completion
)
from services.agent.tool_registry import ToolContext


async def test_protocol_progress():
    """æµ‹è¯•è¿›åº¦å¡ç‰‡"""
    print("\n" + "="*80)
    print("æµ‹è¯• 1: Protocol è¿›åº¦å¡ç‰‡")
    print("="*80)

    context = ToolContext(
        user_id="test_user",
        conversation_id="test_conv",
        skill_id="lifecoach"
    )

    # æµ‹è¯•è¿›è¡Œä¸­çš„è¿›åº¦
    result = await show_protocol_progress({
        "protocol_id": "dankoe_vision",
        "protocol_name": "æ„¿æ™¯è®¾è®¡åè®®",
        "step": 3,
        "total": 8,
        "phase": "Phase 1",
        "phase_name": "å‹¾å‹’æ„¿æ™¯ç”»é¢",
        "is_completed": False
    }, context)

    print("\nè¿›è¡Œä¸­çš„è¿›åº¦å¡ç‰‡:")
    print(f"  card_type: {result['card_type']}")
    print(f"  protocol_name: {result['data']['protocol_name']}")
    print(f"  progress: {result['data']['step']}/{result['data']['total']}")
    print(f"  phase: {result['data']['phase']} - {result['data']['phase_name']}")

    # æµ‹è¯•å®Œæˆçš„è¿›åº¦
    result_completed = await show_protocol_progress({
        "protocol_id": "dankoe_vision",
        "protocol_name": "æ„¿æ™¯è®¾è®¡åè®®",
        "step": 8,
        "total": 8,
        "phase": "Phase 3",
        "phase_name": "æ•´åˆä¸è¡ŒåŠ¨",
        "is_completed": True
    }, context)

    print("\nå·²å®Œæˆçš„è¿›åº¦å¡ç‰‡:")
    print(f"  card_type: {result_completed['card_type']}")
    print(f"  is_completed: {result_completed['data']['is_completed']}")

    return True


async def test_protocol_step():
    """æµ‹è¯•æ­¥éª¤å¡ç‰‡"""
    print("\n" + "="*80)
    print("æµ‹è¯• 2: Protocol æ­¥éª¤å¡ç‰‡")
    print("="*80)

    context = ToolContext(
        user_id="test_user",
        conversation_id="test_conv",
        skill_id="lifecoach"
    )

    # æµ‹è¯•æ™®é€šæ­¥éª¤
    result1 = await show_protocol_step({
        "step_number": 1,
        "step_name": "æç»˜ç†æƒ³åœºæ™¯",
        "content": "é—­ä¸Šçœ¼ç›ï¼Œæƒ³è±¡3å¹´åçš„ä¸€ä¸ªæ™®é€šå‘¨äºŒ...\n\nä½ åœ¨å“ªé‡Œï¼Ÿå‘¨å›´æ˜¯ä»€ä¹ˆæ ·çš„ç¯å¢ƒï¼Ÿä½ åœ¨åšä»€ä¹ˆï¼Ÿ",
        "is_question": False
    }, context)

    print("\næ™®é€šæ­¥éª¤å¡ç‰‡:")
    print(f"  card_type: {result1['card_type']}")
    print(f"  step: {result1['data']['step_number']} - {result1['data']['step_name']}")
    print(f"  is_question: {result1['data']['is_question']}")

    # æµ‹è¯•é—®é¢˜æ­¥éª¤ï¼ˆå¸¦é€‰é¡¹ï¼‰
    result2 = await show_protocol_step({
        "step_number": 2,
        "step_name": "é€‰æ‹©æ ¸å¿ƒé¢†åŸŸ",
        "content": "åœ¨ä»¥ä¸‹é¢†åŸŸä¸­ï¼Œä½ æœ€æƒ³åœ¨3å¹´åæœ‰é‡å¤§çªç ´çš„æ˜¯ï¼Ÿ",
        "is_question": True,
        "options": [
            {"key": "career", "label": "äº‹ä¸šå‘å±•"},
            {"key": "health", "label": "èº«ä½“å¥åº·"},
            {"key": "relationship", "label": "äººé™…å…³ç³»"},
            {"key": "learning", "label": "å­¦ä¹ æˆé•¿"}
        ]
    }, context)

    print("\né—®é¢˜æ­¥éª¤å¡ç‰‡:")
    print(f"  card_type: {result2['card_type']}")
    print(f"  step: {result2['data']['step_number']} - {result2['data']['step_name']}")
    print(f"  is_question: {result2['data']['is_question']}")
    print(f"  options: {len(result2['data']['options'])} ä¸ªé€‰é¡¹")
    for opt in result2['data']['options']:
        print(f"    - {opt['key']}: {opt['label']}")

    return True


async def test_protocol_completion():
    """æµ‹è¯•å®Œæˆå¡ç‰‡"""
    print("\n" + "="*80)
    print("æµ‹è¯• 3: Protocol å®Œæˆå¡ç‰‡")
    print("="*80)

    context = ToolContext(
        user_id="test_user",
        conversation_id="test_conv",
        skill_id="lifecoach"
    )

    result = await show_protocol_completion({
        "protocol_name": "æ„¿æ™¯è®¾è®¡åè®®",
        "completed_steps": 8,
        "total_steps": 8,
        "summary": "æ­å–œï¼ä½ å·²ç»å®Œæˆäº†æ„¿æ™¯è®¾è®¡åè®®ã€‚\n\nä½ çš„æ„¿æ™¯ï¼šæˆä¸ºä¸€ä¸ªå¸®åŠ©ä»–äººå®ç°æ¢¦æƒ³çš„æ•™ç»ƒ\nä½ çš„åæ„¿æ™¯ï¼šä¸€ä¸ªè¢«å·¥ä½œæŸç¼šã€å¤±å»çƒ­æƒ…çš„ä¸Šç­æ—\næ–°èº«ä»½ï¼šæˆ‘æ˜¯é‚£ç§ç”¨çƒ­æƒ…æ„ŸæŸ“ä»–äººã€åˆ›é€ ä»·å€¼çš„äºº\n\nè¿™äº›æ´å¯Ÿå·²ä¿å­˜åˆ°ä½ çš„äººç”Ÿåœ°å›¾ä¸­ã€‚",
        "next_actions": [
            "è®¾å®šä¸€å¹´ç›®æ ‡ï¼ˆä¸»çº¿ä»»åŠ¡ï¼‰",
            "è®¾è®¡æœ¬æœˆé¡¹ç›®ï¼ˆBossæˆ˜ï¼‰",
            "è§„åˆ’æ¯æ—¥æ æ†è¡ŒåŠ¨ï¼ˆä»»åŠ¡æ¸…å•ï¼‰"
        ]
    }, context)

    print("\nå®Œæˆå¡ç‰‡:")
    print(f"  card_type: {result['card_type']}")
    print(f"  protocol_name: {result['data']['protocol_name']}")
    print(f"  progress: {result['data']['completed_steps']}/{result['data']['total_steps']}")
    print(f"  summary length: {len(result['data']['summary'])} chars")
    print(f"  next_actions: {len(result['data']['next_actions'])} items")
    for i, action in enumerate(result['data']['next_actions'], 1):
        print(f"    {i}. {action}")

    return True


async def test_full_protocol_flow():
    """æµ‹è¯•å®Œæ•´ Protocol æµç¨‹"""
    print("\n" + "="*80)
    print("æµ‹è¯• 4: æ¨¡æ‹Ÿå®Œæ•´ Protocol æµç¨‹")
    print("="*80)

    context = ToolContext(
        user_id="test_user",
        conversation_id="test_conv",
        skill_id="lifecoach"
    )

    protocol_steps = [
        {
            "step": 1,
            "total": 4,
            "phase": "Phase 1",
            "phase_name": "æ¢ç´¢æ„¿æ™¯",
            "step_name": "æç»˜ç†æƒ³ç”»é¢",
            "content": "æƒ³è±¡3å¹´åçš„ä½ ...",
            "is_question": False
        },
        {
            "step": 2,
            "total": 4,
            "phase": "Phase 1",
            "phase_name": "æ¢ç´¢æ„¿æ™¯",
            "step_name": "é€‰æ‹©æ ¸å¿ƒé¢†åŸŸ",
            "content": "ä½ æœ€æƒ³çªç ´çš„é¢†åŸŸæ˜¯ï¼Ÿ",
            "is_question": True,
            "options": [
                {"key": "career", "label": "äº‹ä¸š"},
                {"key": "health", "label": "å¥åº·"}
            ]
        },
        {
            "step": 3,
            "total": 4,
            "phase": "Phase 2",
            "phase_name": "è®¾è®¡èº«ä»½",
            "step_name": "æ–°èº«ä»½é™ˆè¿°",
            "content": "å®Œæˆè¿™å¥è¯ï¼šæˆ‘æ˜¯é‚£ç§...",
            "is_question": True
        },
        {
            "step": 4,
            "total": 4,
            "phase": "Phase 2",
            "phase_name": "è®¾è®¡èº«ä»½",
            "step_name": "åˆ¶å®šè¡ŒåŠ¨",
            "content": "åŸºäºæ–°èº«ä»½ï¼Œè®¾å®šå…·ä½“è¡ŒåŠ¨",
            "is_question": False
        }
    ]

    print("\næ¨¡æ‹Ÿ Protocol æ‰§è¡Œæµç¨‹:")
    for i, step_data in enumerate(protocol_steps, 1):
        print(f"\n--- Step {i} ---")

        # æ˜¾ç¤ºè¿›åº¦
        progress = await show_protocol_progress({
            "protocol_id": "test_protocol",
            "protocol_name": "æµ‹è¯•åè®®",
            "step": step_data["step"],
            "total": step_data["total"],
            "phase": step_data["phase"],
            "phase_name": step_data["phase_name"],
            "is_completed": False
        }, context)
        print(f"è¿›åº¦: {progress['data']['step']}/{progress['data']['total']} - {progress['data']['phase_name']}")

        # æ˜¾ç¤ºæ­¥éª¤
        step_card = await show_protocol_step({
            "step_number": step_data["step"],
            "step_name": step_data["step_name"],
            "content": step_data["content"],
            "is_question": step_data.get("is_question", False),
            "options": step_data.get("options", [])
        }, context)
        print(f"æ­¥éª¤: {step_card['data']['step_name']}")
        print(f"é—®é¢˜: {'æ˜¯' if step_card['data']['is_question'] else 'å¦'}")

    # æ˜¾ç¤ºå®Œæˆ
    print(f"\n--- Completion ---")
    completion = await show_protocol_completion({
        "protocol_name": "æµ‹è¯•åè®®",
        "completed_steps": 4,
        "total_steps": 4,
        "summary": "åè®®å·²å®Œæˆï¼ä½ çš„è®¾è®¡å·²ä¿å­˜ã€‚",
        "next_actions": ["ä¸‹ä¸€æ­¥è¡ŒåŠ¨1", "ä¸‹ä¸€æ­¥è¡ŒåŠ¨2"]
    }, context)
    print(f"å®Œæˆ: {completion['data']['protocol_name']}")
    print(f"æ€»ç»“: {completion['data']['summary']}")

    return True


async def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\nğŸ§ª Protocol å†…è”å¡ç‰‡æµ‹è¯•")
    print("="*80)

    tests = [
        ("è¿›åº¦å¡ç‰‡", test_protocol_progress),
        ("æ­¥éª¤å¡ç‰‡", test_protocol_step),
        ("å®Œæˆå¡ç‰‡", test_protocol_completion),
        ("å®Œæ•´æµç¨‹", test_full_protocol_flow)
    ]

    results = []
    for name, test_func in tests:
        try:
            result = await test_func()
            results.append((name, "âœ… é€šè¿‡" if result else "âŒ å¤±è´¥"))
        except Exception as e:
            results.append((name, f"âŒ é”™è¯¯: {str(e)}"))
            import traceback
            traceback.print_exc()

    # è¾“å‡ºæµ‹è¯•ç»“æœ
    print("\n" + "="*80)
    print("æµ‹è¯•ç»“æœæ±‡æ€»")
    print("="*80)
    for name, status in results:
        print(f"  {name}: {status}")

    # ç»Ÿè®¡
    passed = sum(1 for _, status in results if "âœ…" in status)
    total = len(results)
    print(f"\næ€»è®¡: {passed}/{total} é€šè¿‡")

    return passed == total


if __name__ == "__main__":
    success = asyncio.run(main())
    sys.exit(0 if success else 1)
