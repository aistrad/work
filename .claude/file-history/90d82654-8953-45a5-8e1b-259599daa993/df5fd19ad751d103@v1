'use client'

/**
 * RelationshipSimulator - Relationship analysis component
 * Based on: vibelife spec v3.0, section 2.2.4
 *
 * Features:
 * - Single-user mode: Enter partner's basic info
 * - Vibe Link mode: Generate link for partner to join
 * - Relationship card generation
 */

import React, { useState, useCallback } from 'react'
import { motion, AnimatePresence } from 'framer-motion'

// Types
interface PartnerInput {
  inputType: 'birthday' | 'zodiac' | 'chinese_zodiac'
  value: string
}

interface RelationshipAnalysis {
  id: string
  headline: string
  communication_style: string
  summary: string
  scores?: Array<{
    dimension: string
    score: number
    description: string
    is_strength: boolean
  }>
  overall_score?: number
  prescriptions: Array<{
    category: string
    template: string
    context: string
  }>
  warnings: string[]
}

interface RelationshipSimulatorProps {
  userProfile: Record<string, unknown>
  userId: string
  onAnalysisComplete?: (analysis: RelationshipAnalysis) => void
  className?: string
}

// Constants
const ZODIAC_SIGNS = [
  { value: 'aries', label: 'ç™½ç¾Šåº§', emoji: 'â™ˆ' },
  { value: 'taurus', label: 'é‡‘ç‰›åº§', emoji: 'â™‰' },
  { value: 'gemini', label: 'åŒå­åº§', emoji: 'â™Š' },
  { value: 'cancer', label: 'å·¨èŸ¹åº§', emoji: 'â™‹' },
  { value: 'leo', label: 'ç‹®å­åº§', emoji: 'â™Œ' },
  { value: 'virgo', label: 'å¤„å¥³åº§', emoji: 'â™' },
  { value: 'libra', label: 'å¤©ç§¤åº§', emoji: 'â™' },
  { value: 'scorpio', label: 'å¤©èåº§', emoji: 'â™' },
  { value: 'sagittarius', label: 'å°„æ‰‹åº§', emoji: 'â™' },
  { value: 'capricorn', label: 'æ‘©ç¾¯åº§', emoji: 'â™‘' },
  { value: 'aquarius', label: 'æ°´ç“¶åº§', emoji: 'â™’' },
  { value: 'pisces', label: 'åŒé±¼åº§', emoji: 'â™“' },
]

const CHINESE_ZODIAC = [
  { value: 'rat', label: 'é¼ ', emoji: 'ğŸ€' },
  { value: 'ox', label: 'ç‰›', emoji: 'ğŸ‚' },
  { value: 'tiger', label: 'è™', emoji: 'ğŸ…' },
  { value: 'rabbit', label: 'å…”', emoji: 'ğŸ‡' },
  { value: 'dragon', label: 'é¾™', emoji: 'ğŸ‰' },
  { value: 'snake', label: 'è›‡', emoji: 'ğŸ' },
  { value: 'horse', label: 'é©¬', emoji: 'ğŸ´' },
  { value: 'goat', label: 'ç¾Š', emoji: 'ğŸ' },
  { value: 'monkey', label: 'çŒ´', emoji: 'ğŸµ' },
  { value: 'rooster', label: 'é¸¡', emoji: 'ğŸ“' },
  { value: 'dog', label: 'ç‹—', emoji: 'ğŸ•' },
  { value: 'pig', label: 'çŒª', emoji: 'ğŸ·' },
]

const RELATIONSHIP_TYPES = [
  { value: 'romantic', label: 'æ‹çˆ±/ä¼´ä¾£', emoji: 'ğŸ’•' },
  { value: 'family', label: 'å®¶äºº', emoji: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§' },
  { value: 'friendship', label: 'æœ‹å‹', emoji: 'ğŸ¤' },
  { value: 'work', label: 'åŒäº‹', emoji: 'ğŸ’¼' },
]

export default function RelationshipSimulator({
  userProfile,
  userId,
  onAnalysisComplete,
  className = '',
}: RelationshipSimulatorProps) {
  const [step, setStep] = useState<'input' | 'select' | 'loading' | 'result'>('input')
  const [inputType, setInputType] = useState<'birthday' | 'zodiac' | 'chinese_zodiac'>('zodiac')
  const [relationshipType, setRelationshipType] = useState('romantic')
  const [partnerInfo, setPartnerInfo] = useState<PartnerInput>({ inputType: 'zodiac', value: '' })
  const [analysis, setAnalysis] = useState<RelationshipAnalysis | null>(null)
  const [error, setError] = useState<string | null>(null)

  // Handle analysis request
  const handleAnalyze = useCallback(async () => {
    if (!partnerInfo.value) {
      setError('è¯·é€‰æ‹©å¯¹æ–¹ä¿¡æ¯')
      return
    }

    setStep('loading')
    setError(null)

    try {
      // Build partner info based on input type
      const partnerData: Record<string, string> = {}
      if (partnerInfo.inputType === 'zodiac') {
        partnerData.zodiac_sign = partnerInfo.value
      } else if (partnerInfo.inputType === 'chinese_zodiac') {
        partnerData.chinese_zodiac = partnerInfo.value
      } else {
        partnerData.birthday = partnerInfo.value
      }

      const response = await fetch('/api/v1/relationship/analyze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user_id: userId,
          user_profile: userProfile,
          partner_info: partnerData,
          relationship_type: relationshipType,
        }),
      })

      const data = await response.json()

      if (data.success) {
        setAnalysis(data.analysis)
        setStep('result')
        onAnalysisComplete?.(data.analysis)
      } else {
        setError(data.error || 'åˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•')
        setStep('select')
      }
    } catch {
      setError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•')
      setStep('select')
    }
  }, [userId, userProfile, partnerInfo, relationshipType, onAnalysisComplete])

  // Reset state
  const handleReset = () => {
    setStep('input')
    setPartnerInfo({ inputType: 'zodiac', value: '' })
    setAnalysis(null)
    setError(null)
  }

  return (
    <div className={`bg-[#FBF7F1] rounded-2xl overflow-hidden ${className}`}>
      <AnimatePresence mode="wait">
        {/* Step 1: Select Input Type */}
        {step === 'input' && (
          <motion.div
            key="input"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            className="p-6 space-y-6"
          >
            <div className="text-center">
              <h2 className="text-xl font-semibold text-[#1C1A17]">å…³ç³»æ¨¡æ‹Ÿå™¨</h2>
              <p className="text-[#1C1A17]/60 mt-1">é€‰æ‹©å¯¹æ–¹ä¿¡æ¯æ¥æº</p>
            </div>

            <div className="space-y-3">
              <button
                onClick={() => { setInputType('zodiac'); setStep('select') }}
                className="w-full p-4 bg-white rounded-xl border border-[#1C1A17]/10 hover:border-[#B88A44] transition-colors flex items-center gap-3"
              >
                <span className="text-2xl">â™ˆ</span>
                <span className="text-[#1C1A17]">æˆ‘çŸ¥é“ TA çš„æ˜Ÿåº§</span>
              </button>

              <button
                onClick={() => { setInputType('chinese_zodiac'); setStep('select') }}
                className="w-full p-4 bg-white rounded-xl border border-[#1C1A17]/10 hover:border-[#B88A44] transition-colors flex items-center gap-3"
              >
                <span className="text-2xl">ğŸ¯</span>
                <span className="text-[#1C1A17]">æˆ‘åªçŸ¥é“ TA çš„å±ç›¸</span>
              </button>

              <button
                onClick={() => { setInputType('birthday'); setStep('select') }}
                className="w-full p-4 bg-white rounded-xl border border-[#1C1A17]/10 hover:border-[#B88A44] transition-colors flex items-center gap-3"
              >
                <span className="text-2xl">ğŸ“…</span>
                <span className="text-[#1C1A17]">æˆ‘çŸ¥é“ TA çš„ç”Ÿæ—¥</span>
              </button>
            </div>
          </motion.div>
        )}

        {/* Step 2: Select Value */}
        {step === 'select' && (
          <motion.div
            key="select"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            className="p-6 space-y-6"
          >
            <button
              onClick={() => setStep('input')}
              className="text-[#1C1A17]/60 hover:text-[#1C1A17] transition-colors flex items-center gap-1"
            >
              <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
              </svg>
              è¿”å›
            </button>

            {/* Relationship Type */}
            <div>
              <label className="block text-sm font-medium text-[#1C1A17]/70 mb-2">
                ä½ ä»¬çš„å…³ç³»æ˜¯
              </label>
              <div className="grid grid-cols-2 gap-2">
                {RELATIONSHIP_TYPES.map(type => (
                  <button
                    key={type.value}
                    onClick={() => setRelationshipType(type.value)}
                    className={`p-3 rounded-lg border transition-colors ${
                      relationshipType === type.value
                        ? 'border-[#B88A44] bg-[#B88A44]/10'
                        : 'border-[#1C1A17]/10 hover:border-[#1C1A17]/30'
                    }`}
                  >
                    <span className="mr-2">{type.emoji}</span>
                    {type.label}
                  </button>
                ))}
              </div>
            </div>

            {/* Partner Info Selection */}
            <div>
              <label className="block text-sm font-medium text-[#1C1A17]/70 mb-2">
                {inputType === 'zodiac' && 'é€‰æ‹© TA çš„æ˜Ÿåº§'}
                {inputType === 'chinese_zodiac' && 'é€‰æ‹© TA çš„å±ç›¸'}
                {inputType === 'birthday' && 'è¾“å…¥ TA çš„ç”Ÿæ—¥'}
              </label>

              {inputType === 'zodiac' && (
                <div className="grid grid-cols-4 gap-2">
                  {ZODIAC_SIGNS.map(sign => (
                    <button
                      key={sign.value}
                      onClick={() => setPartnerInfo({ inputType, value: sign.value })}
                      className={`p-3 rounded-lg border text-center transition-colors ${
                        partnerInfo.value === sign.value
                          ? 'border-[#B88A44] bg-[#B88A44]/10'
                          : 'border-[#1C1A17]/10 hover:border-[#1C1A17]/30'
                      }`}
                    >
                      <div className="text-xl">{sign.emoji}</div>
                      <div className="text-xs mt-1">{sign.label}</div>
                    </button>
                  ))}
                </div>
              )}

              {inputType === 'chinese_zodiac' && (
                <div className="grid grid-cols-4 gap-2">
                  {CHINESE_ZODIAC.map(zodiac => (
                    <button
                      key={zodiac.value}
                      onClick={() => setPartnerInfo({ inputType, value: zodiac.value })}
                      className={`p-3 rounded-lg border text-center transition-colors ${
                        partnerInfo.value === zodiac.value
                          ? 'border-[#B88A44] bg-[#B88A44]/10'
                          : 'border-[#1C1A17]/10 hover:border-[#1C1A17]/30'
                      }`}
                    >
                      <div className="text-xl">{zodiac.emoji}</div>
                      <div className="text-xs mt-1">{zodiac.label}</div>
                    </button>
                  ))}
                </div>
              )}

              {inputType === 'birthday' && (
                <input
                  type="date"
                  value={partnerInfo.value}
                  onChange={(e) => setPartnerInfo({ inputType, value: e.target.value })}
                  className="w-full p-3 rounded-lg border border-[#1C1A17]/10 focus:border-[#B88A44] focus:outline-none"
                />
              )}
            </div>

            {error && (
              <p className="text-red-600 text-sm">{error}</p>
            )}

            <button
              onClick={handleAnalyze}
              disabled={!partnerInfo.value}
              className="w-full py-3 bg-[#1C1A17] text-[#FBF7F1] rounded-xl font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:bg-[#1C1A17]/90 transition-colors"
            >
              å¼€å§‹åˆ†æ
            </button>
          </motion.div>
        )}

        {/* Loading */}
        {step === 'loading' && (
          <motion.div
            key="loading"
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="p-6 py-12 text-center"
          >
            <div className="w-16 h-16 mx-auto mb-4">
              <svg className="animate-spin w-full h-full text-[#B88A44]" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
              </svg>
            </div>
            <p className="text-[#1C1A17]">æ­£åœ¨åˆ†æä½ ä»¬çš„å…³ç³»...</p>
            <p className="text-sm text-[#1C1A17]/60 mt-1">è¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</p>
          </motion.div>
        )}

        {/* Result */}
        {step === 'result' && analysis && (
          <motion.div
            key="result"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: -20 }}
            className="p-6 space-y-6"
          >
            {/* Headline */}
            <div className="text-center">
              <h3 className="text-xl font-semibold text-[#1C1A17]">
                {analysis.headline}
              </h3>
              <p className="text-[#1C1A17]/60 mt-2">
                {analysis.communication_style}
              </p>
            </div>

            {/* Summary */}
            <div className="bg-white rounded-xl p-4">
              <p className="text-[#1C1A17] leading-relaxed">
                {analysis.summary}
              </p>
            </div>

            {/* Prescriptions */}
            <div className="space-y-3">
              <h4 className="font-medium text-[#1C1A17]">ğŸ’¬ ä¸‹æ¬¡å¯ä»¥è¿™æ ·è¯´</h4>
              {analysis.prescriptions.map((p, i) => (
                <div
                  key={i}
                  className="bg-white rounded-xl p-4 flex items-center justify-between"
                >
                  <div>
                    <p className="text-[#1C1A17] font-medium">&ldquo;{p.template}&rdquo;</p>
                    <p className="text-sm text-[#1C1A17]/60 mt-1">{p.context}</p>
                  </div>
                  <button
                    onClick={() => navigator.clipboard.writeText(p.template)}
                    className="p-2 text-[#B88A44] hover:bg-[#B88A44]/10 rounded-lg transition-colors"
                    title="å¤åˆ¶"
                  >
                    ğŸ“‹
                  </button>
                </div>
              ))}
            </div>

            {/* Warnings */}
            {analysis.warnings.length > 0 && (
              <div className="bg-amber-50 rounded-xl p-4">
                <h4 className="font-medium text-amber-800 mb-2">âš ï¸ æ³¨æ„äº‹é¡¹</h4>
                <ul className="space-y-1">
                  {analysis.warnings.map((w, i) => (
                    <li key={i} className="text-sm text-amber-700">{w}</li>
                  ))}
                </ul>
              </div>
            )}

            {/* Actions */}
            <div className="flex gap-3">
              <button
                onClick={handleReset}
                className="flex-1 py-3 border border-[#1C1A17]/20 text-[#1C1A17] rounded-xl hover:bg-[#1C1A17]/5 transition-colors"
              >
                é‡æ–°åˆ†æ
              </button>
              <button
                className="flex-1 py-3 bg-[#1C1A17] text-[#FBF7F1] rounded-xl hover:bg-[#1C1A17]/90 transition-colors"
              >
                åˆ†äº«å…³ç³»å¡
              </button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  )
}
