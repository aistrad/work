"""
Relationship Card Generator
Based on: vibelife spec v3.0, section 2.2.4

Card Types:
1. Basic Card (免费):
   - One relationship conclusion
   - Best communication style
   - One opener template

2. Premium Card (付费):
   - Everything in basic
   - Zodiac/type info (with consent)
   - Compatibility visualization
   - AI generated poster
   - High-res downloadable image
"""

import json
import logging
from dataclasses import dataclass, field
from typing import Optional, Dict, Any, List
from uuid import UUID, uuid4
from datetime import datetime
from enum import Enum

from ..report.image_generator import ImageGenerator, GeneratedImage

logger = logging.getLogger(__name__)


class CardTier(str, Enum):
    BASIC = "basic"      # Free
    PREMIUM = "premium"  # Paid


@dataclass
class RelationshipCard:
    """Shareable relationship analysis card"""
    id: UUID
    tier: CardTier

    # Core content (both tiers)
    headline: str                # Relationship conclusion
    communication_tip: str       # Best communication style
    opener_template: str         # "Use this to start conversation"

    # Premium content
    compatibility_scores: Optional[Dict[str, int]] = None
    type_info: Optional[Dict[str, str]] = None  # Only if both consent
    additional_templates: List[str] = field(default_factory=list)

    # Image
    image_url: Optional[str] = None
    thumbnail_url: Optional[str] = None

    # Metadata
    creator_nickname: str = ""
    partner_nickname: str = ""
    relationship_type: str = "general"
    created_at: datetime = field(default_factory=datetime.now)
    share_code: Optional[str] = None

    def to_dict(self) -> dict:
        base = {
            "id": str(self.id),
            "tier": self.tier.value,
            "headline": self.headline,
            "communication_tip": self.communication_tip,
            "opener_template": self.opener_template,
            "creator_nickname": self.creator_nickname,
            "partner_nickname": self.partner_nickname,
            "relationship_type": self.relationship_type,
            "thumbnail_url": self.thumbnail_url,
            "created_at": self.created_at.isoformat(),
            "share_code": self.share_code,
        }

        if self.tier == CardTier.PREMIUM:
            base.update({
                "compatibility_scores": self.compatibility_scores,
                "type_info": self.type_info,
                "additional_templates": self.additional_templates,
                "image_url": self.image_url,
            })

        return base


class RelationshipCardGenerator:
    """Generator for shareable relationship cards"""

    def __init__(self):
        self._image_gen = None

    @property
    def image_generator(self) -> ImageGenerator:
        if self._image_gen is None:
            self._image_gen = ImageGenerator()
        return self._image_gen

    async def generate(
        self,
        analysis: Dict[str, Any],
        tier: str = "basic",
        creator_nickname: str = "",
        partner_nickname: str = "",
        include_type_info: bool = False,
        type_info: Optional[Dict[str, str]] = None,
    ) -> RelationshipCard:
        """
        Generate a relationship card from analysis results.

        Args:
            analysis: Relationship analysis result
            tier: "basic" or "premium"
            creator_nickname: Display name of card creator
            partner_nickname: Display name of partner
            include_type_info: Whether to include zodiac/type info
            type_info: Type info to include (requires consent)

        Returns:
            RelationshipCard ready for sharing
        """
        card_tier = CardTier(tier)
        card_id = uuid4()

        # Extract core content
        prescriptions = analysis.get("prescriptions", [])
        opener = prescriptions[0]["template"] if prescriptions else "你好，想和你聊聊..."

        card = RelationshipCard(
            id=card_id,
            tier=card_tier,
            headline=analysis.get("headline", ""),
            communication_tip=analysis.get("communication_style", ""),
            opener_template=opener,
            creator_nickname=creator_nickname,
            partner_nickname=partner_nickname,
            relationship_type=analysis.get("relationship_type", "general"),
            share_code=self._generate_share_code(),
        )

        # Add premium content
        if card_tier == CardTier.PREMIUM:
            # Compatibility scores
            scores = analysis.get("scores", [])
            if scores:
                card.compatibility_scores = {
                    s["dimension"]: s["score"] for s in scores
                }

            # Type info (only with consent)
            if include_type_info and type_info:
                card.type_info = type_info

            # Additional templates
            if len(prescriptions) > 1:
                card.additional_templates = [
                    p["template"] for p in prescriptions[1:]
                ]

            # Generate AI image
            image = await self._generate_card_image(card)
            if image:
                card.image_url = image.url
                card.thumbnail_url = image.thumbnail_url
        else:
            # Basic tier gets thumbnail with watermark
            image = await self._generate_card_image(card, watermark=True)
            if image:
                card.thumbnail_url = image.thumbnail_url

        return card

    async def _generate_card_image(
        self,
        card: RelationshipCard,
        watermark: bool = False,
    ) -> Optional[GeneratedImage]:
        """Generate card image"""
        try:
            # Build prompt for relationship card
            prompt = f"""Elegant relationship card design,
two intertwined abstract shapes,
"{card.headline}" as subtle text overlay,
soft gradient background,
minimalist and sophisticated,
warm color palette,
high quality, 4k"""

            return await self.image_generator.generate_relationship_card(
                user1_profile={},  # Privacy: don't include actual profiles
                user2_profile={},
                relationship_summary=card.headline,
            )

        except Exception as e:
            logger.error(f"Card image generation failed: {e}")
            return None

    def _generate_share_code(self, length: int = 6) -> str:
        """Generate a short share code"""
        import secrets
        return secrets.token_urlsafe(length)[:length].upper()


# ═══════════════════════════════════════════════════════════════════════════
# Convenience Function
# ═══════════════════════════════════════════════════════════════════════════

async def generate_relationship_card(
    analysis: Dict[str, Any],
    tier: str = "basic",
    creator_nickname: str = "",
    partner_nickname: str = "",
) -> RelationshipCard:
    """Convenience function to generate a relationship card"""
    generator = RelationshipCardGenerator()
    return await generator.generate(
        analysis=analysis,
        tier=tier,
        creator_nickname=creator_nickname,
        partner_nickname=partner_nickname,
    )
