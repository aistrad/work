"""
Psych Skill Tool Handlers
心理探索技能工具执行器

使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
"""

from typing import Dict, Any, List, Optional
from services.agent.tool_registry import tool_handler, ToolContext, ToolRegistry
from stores.unified_profile_repo import UnifiedProfileRepository
import logging
from datetime import datetime

logger = logging.getLogger(__name__)


# ============================================================
# 评估工具
# ============================================================

@tool_handler("start_assessment")
async def execute_start_assessment(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    启动心理健康评估
    返回评估表单卡片供用户填写
    """
    assessment_type = args.get("assessment_type", "phq9")

    # 评估量表定义
    assessments = {
        "phq2": {
            "name": "PHQ-2 快速抑郁筛查",
            "description": "2 题快速筛查，30 秒完成",
            "recall_period": "过去两周",
            "items": [
                {"id": 1, "text": "做事时提不起劲或没有兴趣"},
                {"id": 2, "text": "感到心情低落、沮丧或绝望"},
            ]
        },
        "gad2": {
            "name": "GAD-2 快速焦虑筛查",
            "description": "2 题快速筛查，30 秒完成",
            "recall_period": "过去两周",
            "items": [
                {"id": 1, "text": "感到紧张、焦虑或急切"},
                {"id": 2, "text": "不能停止或控制担忧"},
            ]
        },
        "phq9": {
            "name": "PHQ-9 患者健康问卷",
            "description": "9 题抑郁评估，3 分钟完成",
            "recall_period": "过去两周",
            "items": [
                {"id": 1, "text": "做事时提不起劲或没有兴趣"},
                {"id": 2, "text": "感到心情低落、沮丧或绝望"},
                {"id": 3, "text": "入睡困难、睡不安稳或睡眠过多"},
                {"id": 4, "text": "感觉疲倦或没有精力"},
                {"id": 5, "text": "食欲不振或吃太多"},
                {"id": 6, "text": "觉得自己很糟——或觉得自己很失败，或让自己或家人失望"},
                {"id": 7, "text": "难以集中注意力做事，例如阅读报纸或看电视"},
                {"id": 8, "text": "动作或说话缓慢到别人可以察觉——或者相反，烦躁不安、走来走去比平常多"},
                {"id": 9, "text": "有不如死掉或用某种方式伤害自己的念头", "critical": True},
            ]
        },
        "gad7": {
            "name": "GAD-7 广泛性焦虑障碍量表",
            "description": "7 题焦虑评估，2 分钟完成",
            "recall_period": "过去两周",
            "items": [
                {"id": 1, "text": "感到紧张、焦虑或急切"},
                {"id": 2, "text": "不能停止或控制担忧"},
                {"id": 3, "text": "对各种各样的事情担忧过多"},
                {"id": 4, "text": "很难放松下来"},
                {"id": 5, "text": "由于不安而无法静坐"},
                {"id": 6, "text": "变得容易烦恼或急躁"},
                {"id": 7, "text": "感到好像将有可怕的事情发生"},
            ]
        },
        "dass21": {
            "name": "DASS-21 抑郁焦虑压力量表",
            "description": "21 题综合评估，5 分钟完成",
            "recall_period": "过去一周",
            "items": [
                # 压力 (S)
                {"id": 1, "text": "我发觉自己为小事而烦恼", "subscale": "stress"},
                # 焦虑 (A)
                {"id": 2, "text": "我感到口干", "subscale": "anxiety"},
                # 抑郁 (D)
                {"id": 3, "text": "我好像不能再有任何好的感觉", "subscale": "depression"},
                {"id": 4, "text": "我感到呼吸困难", "subscale": "anxiety"},
                {"id": 5, "text": "我发觉很难主动去做事", "subscale": "depression"},
                {"id": 6, "text": "我反应过度", "subscale": "stress"},
                {"id": 7, "text": "我发觉手在发抖", "subscale": "anxiety"},
                {"id": 8, "text": "我觉得自己消耗了很多精力", "subscale": "stress"},
                {"id": 9, "text": "我担心自己会惊慌失措、出丑", "subscale": "anxiety"},
                {"id": 10, "text": "我觉得没有什么可以期待", "subscale": "depression"},
                {"id": 11, "text": "我发觉自己变得激动", "subscale": "stress"},
                {"id": 12, "text": "我发觉自己很难放松", "subscale": "stress"},
                {"id": 13, "text": "我感到闷闷不乐、情绪低落", "subscale": "depression"},
                {"id": 14, "text": "我无法忍受任何阻碍我正在做的事情的因素", "subscale": "stress"},
                {"id": 15, "text": "我感觉快要惊慌了", "subscale": "anxiety"},
                {"id": 16, "text": "我对任何事都提不起热情", "subscale": "depression"},
                {"id": 17, "text": "我觉得自己不怎么值得做人", "subscale": "depression"},
                {"id": 18, "text": "我觉得自己相当敏感", "subscale": "stress"},
                {"id": 19, "text": "我意识到自己心跳加速却没有运动", "subscale": "anxiety"},
                {"id": 20, "text": "我无缘无故感到害怕", "subscale": "anxiety"},
                {"id": 21, "text": "我觉得生活毫无意义", "subscale": "depression"},
            ]
        }
    }

    assessment = assessments.get(assessment_type)
    if not assessment:
        return {
            "status": "error",
            "error": f"未知的评估类型: {assessment_type}"
        }

    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {
                "type": "inline",
                "data": {
                    "cardType": "assessment_form",
                    "assessmentType": assessment_type,
                    "name": assessment["name"],
                    "description": assessment["description"],
                    "recallPeriod": assessment["recall_period"],
                    "items": assessment["items"],
                    "responseScale": {
                        "0": "完全没有",
                        "1": "有几天",
                        "2": "一半以上时间",
                        "3": "几乎每天"
                    }
                }
            },
            "options": {"componentId": "assessment_form"}
        },
        context
    )


@tool_handler("calculate_assessment")
async def execute_calculate_assessment(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    计算评估得分
    """
    assessment_type = args.get("assessment_type")
    responses = args.get("responses", [])

    if not responses:
        return {
            "status": "error",
            "error": "未收到评估回答"
        }

    # 计算总分
    total_score = sum(responses)

    # 根据类型确定严重程度和解读
    if assessment_type in ["phq2", "phq9"]:
        result = _calculate_phq_result(assessment_type, responses, total_score)
    elif assessment_type in ["gad2", "gad7"]:
        result = _calculate_gad_result(assessment_type, total_score)
    elif assessment_type == "dass21":
        result = _calculate_dass21_result(responses)
    else:
        return {"status": "error", "error": f"未知评估类型: {assessment_type}"}

    # 保存到用户 profile
    if context.user_id:
        try:
            await UnifiedProfileRepository.update_skill_data(
                context.user_id,
                "psych",
                {
                    f"assessments.latest.{assessment_type}": {
                        "date": datetime.now().isoformat(),
                        "score": result.get("total_score"),
                        "severity": result.get("severity_level")
                    }
                }
            )
        except Exception as e:
            logger.warning(f"Failed to save assessment: {e}")

    return result


def _calculate_phq_result(assessment_type: str, responses: List[int], total_score: int) -> Dict:
    """计算 PHQ 结果"""
    max_score = 6 if assessment_type == "phq2" else 27

    # PHQ-9 第 9 题安全检查
    safety_flag = None
    if assessment_type == "phq9" and len(responses) >= 9 and responses[8] >= 1:
        safety_flag = "suicidal_ideation"

    # 严重程度
    if assessment_type == "phq2":
        if total_score >= 3:
            severity = "阳性筛查"
            interpretation = "建议进行完整的 PHQ-9 评估以进一步了解情况。"
            recommendations = ["建议做完整的 PHQ-9 评估", "关注自己的情绪变化"]
        else:
            severity = "阴性筛查"
            interpretation = "目前没有明显的抑郁症状指征。"
            recommendations = ["继续保持", "如有变化可随时评估"]
    else:  # phq9
        if total_score <= 4:
            severity = "极轻微/无抑郁"
            interpretation = "你目前没有明显的抑郁症状。继续保持健康的生活方式。"
            recommendations = ["保持规律作息", "维持社交连接", "定期自我检查"]
        elif total_score <= 9:
            severity = "轻度抑郁"
            interpretation = "你可能正在经历一些轻微的抑郁症状。这在生活压力时期是常见的。"
            recommendations = ["尝试行为激活技术", "规律运动", "如持续 2 周以上建议咨询专业人士"]
        elif total_score <= 14:
            severity = "中度抑郁"
            interpretation = "你的抑郁症状已达到中度水平，这可能正在影响你的日常生活。"
            recommendations = ["建议寻求专业心理咨询", "尝试认知行为疗法", "与信任的人谈谈你的感受"]
        elif total_score <= 19:
            severity = "中重度抑郁"
            interpretation = "你的抑郁症状比较严重。积极寻求专业帮助非常重要。"
            recommendations = ["强烈建议专业治疗", "考虑心理治疗+必要时药物治疗", "告诉身边的人你需要支持"]
        else:
            severity = "重度抑郁"
            interpretation = "你正在经历严重的抑郁症状。请尽快寻求专业帮助。"
            recommendations = ["请立即联系专业心理健康服务", "考虑精神科就诊", "确保有人陪伴支持你"]

    result = {
        "status": "success",
        "assessment_type": assessment_type,
        "total_score": total_score,
        "max_score": max_score,
        "severity_level": severity,
        "interpretation": interpretation,
        "recommendations": recommendations
    }

    if safety_flag:
        result["safety_flag"] = safety_flag
        result["safety_score"] = responses[8]

    return result


def _calculate_gad_result(assessment_type: str, total_score: int) -> Dict:
    """计算 GAD 结果"""
    max_score = 6 if assessment_type == "gad2" else 21

    if assessment_type == "gad2":
        if total_score >= 3:
            severity = "阳性筛查"
            interpretation = "建议进行完整的 GAD-7 评估以进一步了解情况。"
            recommendations = ["建议做完整的 GAD-7 评估", "关注自己的焦虑感受"]
        else:
            severity = "阴性筛查"
            interpretation = "目前没有明显的焦虑症状指征。"
            recommendations = ["继续保持", "如有变化可随时评估"]
    else:  # gad7
        if total_score <= 4:
            severity = "极轻微焦虑"
            interpretation = "你目前没有明显的焦虑症状。"
            recommendations = ["继续保持", "学习一些放松技术备用"]
        elif total_score <= 9:
            severity = "轻度焦虑"
            interpretation = "你可能正在经历一些轻微的焦虑。这在压力时期是常见的。"
            recommendations = ["尝试放松技术（深呼吸、渐进性肌肉放松）", "规律运动", "减少咖啡因摄入"]
        elif total_score <= 14:
            severity = "中度焦虑"
            interpretation = "你的焦虑症状已达到中度水平，可能正在影响日常功能。"
            recommendations = ["建议寻求专业心理咨询", "认知行为疗法对焦虑非常有效", "学习焦虑管理技巧"]
        else:
            severity = "重度焦虑"
            interpretation = "你正在经历严重的焦虑症状。请尽快寻求专业帮助。"
            recommendations = ["请联系专业心理健康服务", "可能需要综合治疗方案", "与家人朋友分享你的感受"]

    return {
        "status": "success",
        "assessment_type": assessment_type,
        "total_score": total_score,
        "max_score": max_score,
        "severity_level": severity,
        "interpretation": interpretation,
        "recommendations": recommendations
    }


def _calculate_dass21_result(responses: List[int]) -> Dict:
    """计算 DASS-21 结果"""
    # DASS-21 分量表索引（0-based）
    depression_indices = [2, 4, 9, 12, 15, 16, 20]
    anxiety_indices = [1, 3, 6, 8, 14, 18, 19]
    stress_indices = [0, 5, 7, 10, 11, 13, 17]

    # 计算分量表得分（需要乘以 2）
    depression = sum(responses[i] for i in depression_indices if i < len(responses)) * 2
    anxiety = sum(responses[i] for i in anxiety_indices if i < len(responses)) * 2
    stress = sum(responses[i] for i in stress_indices if i < len(responses)) * 2

    def get_depression_severity(score):
        if score <= 9: return "正常"
        elif score <= 13: return "轻度"
        elif score <= 20: return "中度"
        elif score <= 27: return "重度"
        else: return "极重度"

    def get_anxiety_severity(score):
        if score <= 7: return "正常"
        elif score <= 9: return "轻度"
        elif score <= 14: return "中度"
        elif score <= 19: return "重度"
        else: return "极重度"

    def get_stress_severity(score):
        if score <= 14: return "正常"
        elif score <= 18: return "轻度"
        elif score <= 25: return "中度"
        elif score <= 33: return "重度"
        else: return "极重度"

    return {
        "status": "success",
        "assessment_type": "dass21",
        "total_score": depression + anxiety + stress,
        "max_score": 126,
        "subscales": {
            "depression": {"score": depression, "severity": get_depression_severity(depression)},
            "anxiety": {"score": anxiety, "severity": get_anxiety_severity(anxiety)},
            "stress": {"score": stress, "severity": get_stress_severity(stress)}
        },
        "severity_level": f"抑郁{get_depression_severity(depression)}，焦虑{get_anxiety_severity(anxiety)}，压力{get_stress_severity(stress)}",
        "interpretation": "DASS-21 评估了三个维度：抑郁、焦虑和压力。请参考各分量表的严重程度。",
        "recommendations": _get_dass21_recommendations(depression, anxiety, stress)
    }


def _get_dass21_recommendations(depression: int, anxiety: int, stress: int) -> List[str]:
    """根据 DASS-21 分数生成建议"""
    recommendations = []

    if depression > 13:
        recommendations.append("抑郁症状较明显，建议尝试行为激活和专业咨询")
    if anxiety > 9:
        recommendations.append("焦虑症状较明显，建议学习放松技术")
    if stress > 18:
        recommendations.append("压力水平较高，建议关注压力管理和自我关怀")

    if not recommendations:
        recommendations = ["整体状态良好，继续保持", "定期进行自我检查"]

    return recommendations


@tool_handler("analyze_thought")
async def execute_analyze_thought(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    分析认知扭曲
    识别用户想法中的认知扭曲类型
    """
    thought = args.get("thought", "")
    thought_context = args.get("context", "")

    if not thought:
        return {
            "status": "error",
            "error": "未提供要分析的想法"
        }

    # 认知扭曲识别规则
    distortions = []

    # 全或无思维
    if any(word in thought for word in ["总是", "从来", "永远", "完全", "所有人", "没有人", "一定"]):
        distortions.append({
            "type": "全或无思维",
            "description": "以绝对的方式看待事物，没有中间地带",
            "example_in_thought": "使用了绝对化的词语"
        })

    # 灾难化
    if any(word in thought for word in ["完了", "糟糕", "灾难", "毁了", "完蛋", "末日"]):
        distortions.append({
            "type": "灾难化",
            "description": "将小问题放大成灾难",
            "example_in_thought": "对后果的估计过于严重"
        })

    # 读心术
    if any(word in thought for word in ["觉得我", "认为我", "看不起", "讨厌我", "瞧不起"]):
        distortions.append({
            "type": "读心术",
            "description": "假设知道别人在想什么（通常是负面的）",
            "example_in_thought": "猜测他人的想法"
        })

    # 贴标签
    if any(word in thought for word in ["我是", "我就是", "失败者", "蠢", "笨", "无能"]):
        distortions.append({
            "type": "贴标签",
            "description": "用单一负面标签定义自己",
            "example_in_thought": "用标签定义自己"
        })

    # 应该思维
    if any(word in thought for word in ["应该", "必须", "一定要", "不应该"]):
        distortions.append({
            "type": "应该思维",
            "description": "用'应该'对自己或他人提出僵化要求",
            "example_in_thought": "使用了'应该'相关表达"
        })

    # 情绪推理
    if any(word in thought for word in ["感觉", "觉得所以", "害怕所以"]):
        distortions.append({
            "type": "情绪推理",
            "description": "把感受当作事实的证据",
            "example_in_thought": "用感受推断事实"
        })

    # 个人化
    if any(word in thought for word in ["都是我的错", "怪我", "因为我"]):
        distortions.append({
            "type": "个人化",
            "description": "把不完全是自己责任的事归咎于自己",
            "example_in_thought": "过度自责"
        })

    # 如果没有识别到，可能需要更深入分析
    if not distortions:
        distortions.append({
            "type": "需要进一步探索",
            "description": "这个想法可能包含一些微妙的认知模式，让我们一起探索",
            "example_in_thought": ""
        })

    # 生成挑战问题
    challenge_questions = [
        "支持这个想法的证据是什么？",
        "反对这个想法的证据是什么？",
        "如果你的好朋友有这样的想法，你会对 ta 说什么？",
        "最坏的情况是什么？如果发生了，你能应对吗？",
        "一年后回看这件事，会有什么不同？"
    ]

    return {
        "status": "success",
        "original_thought": thought,
        "context": thought_context,
        "distortions": distortions,
        "challenge_questions": challenge_questions
    }


# ============================================================
# 展示工具
# ============================================================

@tool_handler("show_assessment_result")
async def execute_show_assessment_result(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示评估结果卡片"""
    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {
                "type": "inline",
                "data": {
                    "cardType": "assessment_result",
                    **args
                }
            },
            "options": {"componentId": "assessment_result"}
        },
        context
    )


@tool_handler("show_distortion_analysis")
async def execute_show_distortion_analysis(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示认知扭曲分析卡片"""
    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {
                "type": "inline",
                "data": {
                    "cardType": "distortion_card",
                    **args
                }
            },
            "options": {"componentId": "distortion_card"}
        },
        context
    )


@tool_handler("show_exercise")
async def execute_show_exercise(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示心理练习卡片"""
    exercise_type = args.get("exercise_type")
    title = args.get("title", "")
    duration = args.get("duration", "")
    custom_instructions = args.get("instructions")

    # 预定义的练习
    exercises = {
        "breathing_478": {
            "title": "4-7-8 呼吸法",
            "duration": "3 分钟",
            "description": "一种简单有效的放松呼吸技术",
            "instructions": [
                "找一个舒适的姿势，可以坐着或躺着",
                "闭上眼睛，放松身体",
                "用鼻子吸气，默数 4 秒",
                "屏住呼吸，默数 7 秒",
                "用嘴巴缓慢呼气，默数 8 秒",
                "重复 3-4 个循环",
                "注意：如果感到头晕，恢复正常呼吸"
            ]
        },
        "grounding_54321": {
            "title": "5-4-3-2-1 感官着陆",
            "duration": "5 分钟",
            "description": "当焦虑来袭时，用感官把自己带回当下",
            "instructions": [
                "环顾四周，说出 5 样你能看到的东西",
                "找到 4 样你能触摸的东西，感受它们的质地",
                "倾听，说出 3 种你能听到的声音",
                "注意 2 种你能闻到的气味",
                "感受 1 种你能尝到的味道",
                "做完后，感受自己回到当下的感觉"
            ]
        },
        "pmr": {
            "title": "渐进性肌肉放松",
            "duration": "10-15 分钟",
            "description": "通过依次紧绷和放松肌肉群来释放身体紧张",
            "instructions": [
                "找一个安静舒适的地方躺下或坐着",
                "闭上眼睛，做几次深呼吸",
                "从脚趾开始：用力紧绷 5 秒，然后完全放松",
                "依次向上：小腿、大腿、臀部、腹部、胸部、手、手臂、肩膀、脖子、面部",
                "每个部位：紧绷 5 秒，放松 10-15 秒",
                "感受紧绷和放松的对比",
                "最后，感受全身的放松状态"
            ]
        },
        "behavioral_activation": {
            "title": "行为激活：每日一件小事",
            "duration": "取决于活动",
            "description": "通过行动打破情绪低落的循环",
            "instructions": [
                "选择一件你曾经享受但最近没有做的小事",
                "可以是：散步 10 分钟、听一首歌、给朋友发条消息、整理一个小角落",
                "设定具体的时间和地点",
                "关键：不要等有动力才行动，行动会带来动力",
                "做完后，记录你的心情变化",
                "无论心情有没有改善，都要肯定自己迈出了这一步"
            ]
        },
        "thought_record": {
            "title": "认知记录",
            "duration": "10 分钟",
            "description": "记录和分析你的自动化思维",
            "instructions": [
                "描述情境：发生了什么？",
                "记录情绪：你感到什么？强度 1-10？",
                "捕捉想法：那一刻你脑海中闪过什么想法？",
                "识别扭曲：这个想法属于哪种认知扭曲？",
                "挑战想法：支持和反对的证据是什么？",
                "重构想法：有没有更平衡的方式看待这件事？",
                "重新评估：现在情绪强度是多少？"
            ]
        },
        "gratitude": {
            "title": "感恩练习",
            "duration": "3 分钟",
            "description": "培养积极情绪的简单练习",
            "instructions": [
                "找一个安静的时刻",
                "回想今天（或最近）发生的事",
                "写下或想出 3 件你感恩的事",
                "可以是小事：一杯好喝的咖啡、阳光、朋友的消息",
                "对每一件事，想一想为什么让你感恩",
                "感受这种感恩的情绪",
                "如果能坚持每天做，效果更好"
            ]
        },
        "self_compassion": {
            "title": "自我慈悲练习",
            "duration": "5 分钟",
            "description": "学习像对待好朋友一样对待自己",
            "instructions": [
                "想一个你最近对自己很苛刻的情境",
                "第一步-正念：承认这是一个痛苦的时刻，说'这真的很难受'",
                "第二步-共同人性：记住你不孤单，说'很多人都经历过类似的困难'",
                "第三步-自我善待：把手放在心口，问自己'我现在需要什么来照顾自己？'",
                "想象你的好朋友遇到同样的情况，你会对 ta 说什么？",
                "用同样的话对自己说"
            ]
        },
        "shadow_projection": {
            "title": "投射觉察练习",
            "duration": "15 分钟",
            "description": "荣格阴影工作的入门练习",
            "instructions": [
                "想一个你特别反感的人（可以是认识的人或公众人物）",
                "问自己：这个人让你最讨厌的特质是什么？",
                "具体描述这个特质",
                "现在，诚实地问自己：这个特质是否也存在于你自己身上？",
                "可能表现形式不同，但本质相似",
                "如果有，探索一下：你是如何压抑或隐藏这个特质的？",
                "这个特质可能有什么积极的一面？"
            ]
        },
        "worry_time": {
            "title": "担忧时间技术",
            "duration": "15-30 分钟/天",
            "description": "限制担忧的时间和空间",
            "instructions": [
                "选择每天一个固定的'担忧时间'，比如下午 6 点",
                "时长 15-30 分钟",
                "白天出现担忧时，告诉自己'我会在担忧时间处理这个'",
                "把担忧写在纸上，然后继续你正在做的事",
                "到了担忧时间，集中处理你的担忧清单",
                "可以想解决方案，也可以只是思考",
                "时间到了就停止，即使没想完",
                "关键：限制担忧，而不是逃避担忧"
            ]
        }
    }

    exercise = exercises.get(exercise_type, {})

    card_data = {
        "cardType": "exercise_card",
        "exerciseType": exercise_type,
        "title": title or exercise.get("title", "练习"),
        "duration": duration or exercise.get("duration", ""),
        "description": exercise.get("description", ""),
        "instructions": custom_instructions or exercise.get("instructions", [])
    }

    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {"type": "inline", "data": card_data},
            "options": {"componentId": "exercise_card"}
        },
        context
    )


@tool_handler("show_crisis_resources")
async def execute_show_crisis_resources(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示危机资源卡片"""
    risk_level = args.get("risk_level", "high")
    message = args.get("message", "")

    if not message:
        if risk_level == "high":
            message = "我非常担心你刚才说的话。你的安全是最重要的。"
        else:
            message = "我听到了你说的话，我想确保你是安全的。"

    card_data = {
        "cardType": "crisis_alert",
        "riskLevel": risk_level,
        "message": message,
        "hotlines": [
            {"name": "全国心理援助热线", "number": "400-161-9995", "hours": "24小时"},
            {"name": "北京心理危机研究与干预中心", "number": "010-82951332", "hours": "24小时"},
            {"name": "生命热线", "number": "400-821-1215", "hours": "24小时"},
            {"name": "希望24热线", "number": "400-161-9995", "hours": "24小时"}
        ],
        "immediateSteps": [
            "如果你有伤害自己的工具，请先把它们放到安全的地方",
            "联系你信任的人，告诉他们你现在的感受",
            "拨打上面的热线，专业人员可以帮助你",
            "如果情况紧急，请拨打 120 或前往最近的医院急诊"
        ]
    }

    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {"type": "inline", "data": card_data},
            "options": {"componentId": "crisis_alert"}
        },
        context
    )


# ============================================================
# 工作坊工具
# ============================================================

@tool_handler("start_workshop")
async def execute_start_workshop(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """启动专题工作坊"""
    workshop_type = args.get("workshop_type")

    workshops = {
        "anxiety_management": {
            "title": "焦虑管理工作坊",
            "duration": "4 周",
            "description": "学习管理焦虑的循证技术，包括认知重构、放松训练和渐进式暴露。",
            "modules": [
                {"week": 1, "title": "理解焦虑", "topics": ["焦虑的认知三角", "识别触发器", "GAD-7 基线"]},
                {"week": 2, "title": "身体层面", "topics": ["渐进性肌肉放松", "呼吸技术", "感官着陆"]},
                {"week": 3, "title": "认知层面", "topics": ["认知扭曲", "担忧时间技术", "苏格拉底式提问"]},
                {"week": 4, "title": "行为层面", "topics": ["渐进式暴露", "安全行为", "预防复发"]}
            ]
        },
        "depression_coping": {
            "title": "情绪低落应对工作坊",
            "duration": "4 周",
            "description": "通过行为激活和认知重构技术应对情绪低落。",
            "modules": [
                {"week": 1, "title": "理解情绪低落", "topics": ["下行螺旋", "PHQ-9 基线"]},
                {"week": 2, "title": "行为激活", "topics": ["行动先于动力", "愉悦活动计划"]},
                {"week": 3, "title": "认知层面", "topics": ["内在批评者", "自我慈悲"]},
                {"week": 4, "title": "预防维护", "topics": ["预警信号", "自我关怀计划"]}
            ]
        },
        "stress_management": {
            "title": "压力管理工作坊",
            "duration": "4 周",
            "description": "学习有效的压力管理和自我关怀策略。",
            "modules": [
                {"week": 1, "title": "压力觉察", "topics": ["压力信号", "压力源分类"]},
                {"week": 2, "title": "应对策略", "topics": ["问题导向 vs 情绪导向", "时间管理"]},
                {"week": 3, "title": "恢复关怀", "topics": ["恢复四维度", "自我关怀"]},
                {"week": 4, "title": "预防平衡", "topics": ["生活平衡轮", "倦怠预防"]}
            ]
        },
        "relationship": {
            "title": "人际关系改善工作坊",
            "duration": "4 周",
            "description": "改善沟通技巧、设定健康边界、深化人际连接。",
            "modules": [
                {"week": 1, "title": "关系模式", "topics": ["依恋风格", "家庭影响"]},
                {"week": 2, "title": "有效沟通", "topics": ["非暴力沟通", "积极倾听"]},
                {"week": 3, "title": "健康边界", "topics": ["边界设定", "说'不'的艺术"]},
                {"week": 4, "title": "深化连接", "topics": ["脆弱性", "社会支持网络"]}
            ]
        },
        "self_discovery": {
            "title": "自我认知探索工作坊",
            "duration": "4 周",
            "description": "深入探索价值观、优势和人生方向。",
            "modules": [
                {"week": 1, "title": "价值观探索", "topics": ["价值观卡片", "内在 vs 外在"]},
                {"week": 2, "title": "优势资源", "topics": ["核心优势", "原型探索"]},
                {"week": 3, "title": "模式觉察", "topics": ["生活风格", "人格面具"]},
                {"week": 4, "title": "整合方向", "topics": ["个人使命", "目标对齐"]}
            ]
        }
    }

    workshop = workshops.get(workshop_type)
    if not workshop:
        return {
            "status": "error",
            "error": f"未知的工作坊类型: {workshop_type}"
        }

    card_data = {
        "cardType": "workshop_intro",
        "workshopType": workshop_type,
        **workshop
    }

    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {"type": "inline", "data": card_data},
            "options": {"componentId": "workshop_intro"}
        },
        context
    )


@tool_handler("save_progress")
async def execute_save_progress(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """保存用户进度"""
    if not context.user_id:
        return {"status": "skipped", "message": "用户未登录，无法保存进度"}

    progress_type = args.get("progress_type")
    item_id = args.get("item_id")
    data = args.get("data", {})

    try:
        await UnifiedProfileRepository.update_skill_data(
            context.user_id,
            "psych",
            {
                f"progress.{progress_type}.{item_id}": {
                    "completed_at": datetime.now().isoformat(),
                    **data
                }
            }
        )
        return {"status": "success", "message": "进度已保存"}
    except Exception as e:
        logger.error(f"Failed to save progress: {e}")
        return {"status": "error", "error": str(e)}
