"use client";

import { useState } from "react";
import { registerCard } from "@/skills/CardRegistry";
import { Card } from "@/components/ui/Card";

interface ExerciseCardData {
  exerciseType: string;
  title: string;
  duration?: string;
  description?: string;
  instructions: string[];
}

interface ExerciseCardProps {
  data: ExerciseCardData;
  onSubmit?: (answer: string) => void;
}

function ExerciseCard({ data, onSubmit }: ExerciseCardProps) {
  const [currentStep, setCurrentStep] = useState(0);
  const [isStarted, setIsStarted] = useState(false);
  const [isCompleted, setIsCompleted] = useState(false);
  const [reflection, setReflection] = useState("");

  const getExerciseIcon = (type: string) => {
    const icons: Record<string, string> = {
      breathing_478: "ğŸŒ¬ï¸",
      grounding_54321: "ğŸŒ¿",
      pmr: "ğŸ’†",
      behavioral_activation: "âš¡",
      thought_record: "ğŸ“",
      gratitude: "ğŸ™",
      self_compassion: "ğŸ’—",
      shadow_projection: "ğŸŒ‘",
      worry_time: "â°",
    };
    return icons[type] || "âœ¨";
  };

  const getExerciseColor = (type: string) => {
    const colors: Record<string, string> = {
      breathing_478: "from-cyan-500 to-blue-500",
      grounding_54321: "from-green-500 to-emerald-500",
      pmr: "from-purple-500 to-pink-500",
      behavioral_activation: "from-orange-500 to-yellow-500",
      thought_record: "from-indigo-500 to-purple-500",
      gratitude: "from-yellow-500 to-orange-500",
      self_compassion: "from-pink-500 to-rose-500",
      shadow_projection: "from-gray-600 to-gray-800",
      worry_time: "from-blue-500 to-indigo-500",
    };
    return colors[type] || "from-purple-500 to-indigo-500";
  };

  const handleStart = () => {
    setIsStarted(true);
  };

  const handleNext = () => {
    if (currentStep < data.instructions.length - 1) {
      setCurrentStep((prev) => prev + 1);
    } else {
      setIsCompleted(true);
    }
  };

  const handlePrev = () => {
    if (currentStep > 0) {
      setCurrentStep((prev) => prev - 1);
    }
  };

  const handleComplete = () => {
    if (onSubmit) {
      onSubmit(
        reflection
          ? `æˆ‘å®Œæˆäº†"${data.title}"ç»ƒä¹ ã€‚æˆ‘çš„æ„Ÿå—æ˜¯ï¼š${reflection}`
          : `æˆ‘å®Œæˆäº†"${data.title}"ç»ƒä¹ ã€‚`
      );
    }
  };

  // æœªå¼€å§‹çŠ¶æ€
  if (!isStarted) {
    return (
      <Card className="max-w-md mx-auto bg-white dark:bg-gray-900 overflow-hidden">
        <div
          className={`p-6 bg-gradient-to-r ${getExerciseColor(
            data.exerciseType
          )} text-white text-center`}
        >
          <div className="text-4xl mb-3">{getExerciseIcon(data.exerciseType)}</div>
          <h3 className="text-xl font-semibold">{data.title}</h3>
          {data.duration && (
            <p className="text-sm opacity-90 mt-1">é¢„è®¡æ—¶é•¿ï¼š{data.duration}</p>
          )}
        </div>

        {data.description && (
          <div className="p-4 border-b border-gray-100 dark:border-gray-800">
            <p className="text-sm text-gray-600 dark:text-gray-400">
              {data.description}
            </p>
          </div>
        )}

        <div className="p-4">
          <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
            å…± {data.instructions.length} ä¸ªæ­¥éª¤
          </p>
          <button
            onClick={handleStart}
            className={`w-full py-3 rounded-lg text-white font-medium bg-gradient-to-r ${getExerciseColor(
              data.exerciseType
            )} hover:opacity-90 transition-opacity`}
          >
            å¼€å§‹ç»ƒä¹ 
          </button>
        </div>
      </Card>
    );
  }

  // å®ŒæˆçŠ¶æ€
  if (isCompleted) {
    return (
      <Card className="max-w-md mx-auto bg-white dark:bg-gray-900 overflow-hidden">
        <div
          className={`p-6 bg-gradient-to-r ${getExerciseColor(
            data.exerciseType
          )} text-white text-center`}
        >
          <div className="text-4xl mb-3">âœ…</div>
          <h3 className="text-xl font-semibold">ç»ƒä¹ å®Œæˆï¼</h3>
          <p className="text-sm opacity-90 mt-1">{data.title}</p>
        </div>

        <div className="p-4">
          <h4 className="text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">
            è®°å½•ä½ çš„æ„Ÿå—ï¼ˆå¯é€‰ï¼‰
          </h4>
          <textarea
            value={reflection}
            onChange={(e) => setReflection(e.target.value)}
            placeholder="åšå®Œè¿™ä¸ªç»ƒä¹ åï¼Œä½ æœ‰ä»€ä¹ˆæ„Ÿå—æˆ–å‘ç°ï¼Ÿ"
            className="w-full p-3 text-sm border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 resize-none focus:ring-2 focus:ring-purple-500 focus:border-transparent"
            rows={3}
          />
          <button
            onClick={handleComplete}
            className="w-full mt-3 py-3 rounded-lg text-white font-medium bg-gradient-to-r from-green-500 to-emerald-500 hover:opacity-90 transition-opacity"
          >
            å®Œæˆ
          </button>
        </div>
      </Card>
    );
  }

  // è¿›è¡Œä¸­çŠ¶æ€
  return (
    <Card className="max-w-md mx-auto bg-white dark:bg-gray-900 overflow-hidden">
      {/* å¤´éƒ¨ */}
      <div
        className={`p-4 bg-gradient-to-r ${getExerciseColor(
          data.exerciseType
        )} text-white`}
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-2xl">{getExerciseIcon(data.exerciseType)}</span>
            <h3 className="font-semibold">{data.title}</h3>
          </div>
          <span className="text-sm opacity-90">
            {currentStep + 1} / {data.instructions.length}
          </span>
        </div>

        {/* è¿›åº¦æ¡ */}
        <div className="mt-3 h-1 bg-white/30 rounded-full overflow-hidden">
          <div
            className="h-full bg-white transition-all duration-300"
            style={{
              width: `${((currentStep + 1) / data.instructions.length) * 100}%`,
            }}
          />
        </div>
      </div>

      {/* å½“å‰æ­¥éª¤ */}
      <div className="p-6">
        <div className="min-h-[120px] flex items-center justify-center">
          <p className="text-lg text-gray-800 dark:text-gray-200 text-center leading-relaxed">
            {data.instructions[currentStep]}
          </p>
        </div>
      </div>

      {/* å¯¼èˆª */}
      <div className="p-4 border-t border-gray-100 dark:border-gray-800 flex items-center justify-between">
        <button
          onClick={handlePrev}
          disabled={currentStep === 0}
          className={`px-4 py-2 rounded-lg text-sm transition-colors ${
            currentStep === 0
              ? "text-gray-400 cursor-not-allowed"
              : "text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20"
          }`}
        >
          ä¸Šä¸€æ­¥
        </button>

        <button
          onClick={handleNext}
          className={`px-6 py-2 rounded-lg text-white font-medium bg-gradient-to-r ${getExerciseColor(
            data.exerciseType
          )} hover:opacity-90 transition-opacity`}
        >
          {currentStep === data.instructions.length - 1 ? "å®Œæˆ" : "ä¸‹ä¸€æ­¥"}
        </button>
      </div>
    </Card>
  );
}

// æ³¨å†Œå¡ç‰‡
registerCard("exercise_card", ExerciseCard);

export default ExerciseCard;
