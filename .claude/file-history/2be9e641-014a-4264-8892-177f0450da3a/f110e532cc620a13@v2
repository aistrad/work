/**
 * CardRegistry v7.0 - 工具-卡片映射注册表 (V7 重构版)
 *
 * v7.0 变更:
 * - 新增 11 种通用视图类型 (list, tree, table, timeline, form, select, chart, progress, counter, modal, toast)
 * - 新增 custom 类型支持自定义组件
 * - 删除旧的业务卡片类型 (insight_card, skill_services, service_recommendation)
 * - 保留 Skill 专属卡片 (bazi_chart, zodiac_chart 等)
 *
 * 每个后端工具通过 card_type 映射到前端组件。
 * 新增 Skill 时，同时注册对应的卡片组件。
 */

import React, { Suspense, lazy } from 'react';

// 卡片组件类型
type CardComponent = React.FC<any>;
type LazyCardLoader = () => Promise<{ default: CardComponent }>;

// 卡片注册表 - 支持直接组件或懒加载器
const cardRegistry = new Map<string, CardComponent>();
const lazyCardRegistry = new Map<string, React.LazyExoticComponent<CardComponent>>();

/**
 * 注册卡片组件 (直接注册)
 */
export function registerCard(cardType: string, component: CardComponent): void {
  cardRegistry.set(cardType, component);
}

/**
 * 注册懒加载卡片组件 (Vercel rule: bundle-dynamic-imports)
 */
export function registerLazyCard(cardType: string, loader: LazyCardLoader): void {
  const LazyComponent = lazy(loader);
  lazyCardRegistry.set(cardType, LazyComponent);
}

/**
 * 获取卡片组件
 */
export function getCard(cardType: string): CardComponent | React.LazyExoticComponent<CardComponent> | undefined {
  // 优先返回直接注册的组件
  const directComponent = cardRegistry.get(cardType);
  if (directComponent) return directComponent;

  // 其次返回懒加载组件
  return lazyCardRegistry.get(cardType);
}

/**
 * 渲染卡片 (支持懒加载)
 */
export function renderCard(cardType: string, props: any): React.ReactNode {
  const Component = getCard(cardType);
  if (!Component) {
    console.warn(`Unknown card type: ${cardType}`);
    return null;
  }

  // 检查是否是懒加载组件
  const isLazy = lazyCardRegistry.has(cardType);

  if (isLazy) {
    // 懒加载组件需要 Suspense 包装
    return React.createElement(
      Suspense,
      { fallback: React.createElement('div', { className: 'animate-pulse bg-gray-100 rounded-lg h-32' }) },
      React.createElement(Component, props)
    );
  }

  return React.createElement(Component, props);
}

/**
 * 检查卡片是否已注册
 */
export function hasCard(cardType: string): boolean {
  return cardRegistry.has(cardType) || lazyCardRegistry.has(cardType);
}

/**
 * 获取所有已注册的卡片类型
 */
export function getRegisteredCardTypes(): string[] {
  const directTypes = Array.from(cardRegistry.keys());
  const lazyTypes = Array.from(lazyCardRegistry.keys());
  return Array.from(new Set([...directTypes, ...lazyTypes]));
}

// ═══════════════════════════════════════════════════════════════════════════
// 卡片类型常量 (V7)
// ═══════════════════════════════════════════════════════════════════════════

export const CARD_TYPES = {
  // ═══════════════════════════════════════════════════════════════════════════
  // 通用视图类型 (V7 新增)
  // ═══════════════════════════════════════════════════════════════════════════
  LIST: 'list',
  TREE: 'tree',
  TABLE: 'table',
  TIMELINE: 'timeline',
  FORM: 'form',
  SELECT: 'select',
  CHART: 'chart',
  PROGRESS: 'progress',
  COUNTER: 'counter',
  MODAL: 'modal',
  TOAST: 'toast',
  CUSTOM: 'custom',

  // ═══════════════════════════════════════════════════════════════════════════
  // 向后兼容 (将逐步废弃)
  // ═══════════════════════════════════════════════════════════════════════════
  COLLECT_FORM: 'collect_form',
  INSIGHT_CARD: 'insight_card',
  REPORT_CARD: 'report_card',
  SKILL_SERVICES: 'skill_services',
  SERVICE_RECOMMENDATION: 'service_recommendation',
  SKILL_RECOMMENDATION: 'skill_recommendation',

  // ═══════════════════════════════════════════════════════════════════════════
  // 边界控制 (V7.1 新增)
  // ═══════════════════════════════════════════════════════════════════════════
  SKILL_LIST: 'skill_list',

  // ═══════════════════════════════════════════════════════════════════════════
  // Skill 自定义卡片 (通过 custom + component_id 访问)
  // ═══════════════════════════════════════════════════════════════════════════
  // Bazi
  BAZI_CHART: 'bazi_chart',
  BAZI_FORTUNE: 'bazi_fortune',
  BAZI_KLINE: 'bazi_kline',
  BAZI_DAILY_FORTUNE: 'bazi_daily_fortune',

  // Zodiac
  ZODIAC_CHART: 'zodiac_chart',
  ZODIAC_TRANSIT: 'zodiac_transit',
  ZODIAC_SYNASTRY: 'zodiac_synastry',
  ZODIAC_LUNAR_PHASE: 'zodiac_lunar_phase',

  // Tarot
  TAROT_SPREAD: 'tarot_spread',

  // Career
  CAREER_ANALYSIS: 'career_analysis',

  // Jungastro (荣格心理占星)
  JUNGASTRO_PORTRAIT: 'jungastro_portrait',
  JUNGASTRO_SHADOW: 'jungastro_shadow',
  JUNGASTRO_INDIVIDUATION: 'jungastro_individuation',
  JUNGASTRO_FUNCTIONS: 'jungastro_functions',
  JUNGASTRO_RELATIONSHIP: 'jungastro_relationship',

  // Lifecoach (人生教练) - V3 方法论卡片
  DANKOE: 'dankoe',
  COVEY: 'covey',
  YANGMING: 'yangming',
  LIAOFAN: 'liaofan',
  // Lifecoach - 公用卡片
  ACTION_PLAN: 'action_plan',
  PROGRESS_STREAK: 'progress_streak',
  // Lifecoach - Protocol 内联卡片
  PROTOCOL_PROGRESS: 'protocol_progress',
  PROTOCOL_STEP: 'protocol_step',
  PROTOCOL_COMPLETION: 'protocol_completion',
  // Lifecoach - 旧卡片 (向后兼容，将逐步废弃)
  LIFE_ROADMAP: 'life_roadmap',
  ROLE_BALANCE: 'role_balance',
  WEEKLY_ROCKS: 'weekly_rocks',
  DAILY_LEVERS: 'daily_levers',
  PATTERN_INSIGHT: 'pattern_insight',
  VISION_MAP: 'vision_map',
  IDENTITY_DESIGN: 'identity_design',
  LIFE_GAME: 'life_game',

  // VibeID
  VIBE_ID: 'vibe_id',
  VIBE_ID_RADAR: 'vibe_id_radar',

  // SkillIntroCard
  SKILL_INTRO: 'skill_intro',

  // Psych (心理探索)
  PSYCH_ASSESSMENT_FORM: 'assessment_form',
  PSYCH_ASSESSMENT_RESULT: 'assessment_result',
  PSYCH_DISTORTION: 'distortion_card',
  PSYCH_EXERCISE: 'exercise_card',
  PSYCH_CRISIS_ALERT: 'crisis_alert',
  PSYCH_WORKSHOP_INTRO: 'workshop_intro',
} as const;

export type CardType = typeof CARD_TYPES[keyof typeof CARD_TYPES];

// ═══════════════════════════════════════════════════════════════════════════
// 默认导出
// ═══════════════════════════════════════════════════════════════════════════

export const CardRegistry = {
  register: registerCard,
  registerLazy: registerLazyCard,
  get: getCard,
  render: renderCard,
  has: hasCard,
  getTypes: getRegisteredCardTypes,
  TYPES: CARD_TYPES,
};

export default CardRegistry;
