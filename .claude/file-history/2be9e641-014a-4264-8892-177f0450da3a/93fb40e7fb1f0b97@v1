"""
{{SKILL_NAME}} 工具处理器
文件位置: apps/api/skills/{{SKILL_ID}}/tools/handlers.py

处理所有 {{SKILL_ID}} skill 的工具调用。
"""

from typing import Any, Dict, List, Optional
import logging

from ...services.tool_registry import ToolRegistry, tool_handler, ToolContext

logger = logging.getLogger(__name__)


# ═══════════════════════════════════════════════════════════════════════════
# 常量定义
# ═══════════════════════════════════════════════════════════════════════════

# 卡片类型
CARD_TYPES = {
    "{{CARD_TYPE_1}}": "{{CARD_TYPE_1}}",
    "{{CARD_TYPE_2}}": "{{CARD_TYPE_2}}",
}


# ═══════════════════════════════════════════════════════════════════════════
# 辅助函数
# ═══════════════════════════════════════════════════════════════════════════

def _validate_input(args: Dict[str, Any], required_fields: List[str]) -> Optional[str]:
    """验证必填字段"""
    for field in required_fields:
        if field not in args or args[field] is None:
            return f"缺少必填字段: {field}"
    return None


# ═══════════════════════════════════════════════════════════════════════════
# 计算工具 (Compute Tools)
# ═══════════════════════════════════════════════════════════════════════════

@tool_handler("{{COMPUTE_TOOL_1_NAME}}")
async def execute_{{COMPUTE_TOOL_1_NAME}}(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """{{COMPUTE_TOOL_1_DESC}}"""
    # 验证输入
    error = _validate_input(args, ["input_data"])
    if error:
        return {"success": False, "error": error}

    try:
        input_data = args["input_data"]

        # TODO: 实现计算逻辑
        result = {
            "processed": True,
            "data": input_data
        }

        return {
            "success": True,
            "result": result
        }

    except Exception as e:
        logger.error(f"{{COMPUTE_TOOL_1_NAME}} 错误: {e}")
        return {"success": False, "error": f"处理失败: {e}"}


# ═══════════════════════════════════════════════════════════════════════════
# 展示工具 (Display Tools)
# ═══════════════════════════════════════════════════════════════════════════

@tool_handler("show_{{CARD_TYPE_1}}")
async def execute_show_{{CARD_TYPE_1}}(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """展示{{CARD_DESC_1}}"""
    data = args.get("data", {})

    # 构建卡片数据
    card_data = {
        "title": data.get("title", ""),
        "content": data.get("content", ""),
        # 添加更多字段...
    }

    # 委托给 show_card
    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": CARD_TYPES["{{CARD_TYPE_1}}"],
            "data": card_data
        },
        context
    )


# ═══════════════════════════════════════════════════════════════════════════
# 动作工具 (Action Tools)
# ═══════════════════════════════════════════════════════════════════════════

@tool_handler("save_progress")
async def execute_save_progress(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """保存用户进度"""
    session_id = args.get("session_id")
    data = args.get("data", {})

    if not session_id:
        return {"success": False, "error": "缺少 session_id"}

    try:
        # TODO: 实现保存逻辑
        # await save_to_database(session_id, data)

        return {
            "success": True,
            "message": "进度已保存"
        }

    except Exception as e:
        logger.error(f"保存进度错误: {e}")
        return {"success": False, "error": f"保存失败: {e}"}
