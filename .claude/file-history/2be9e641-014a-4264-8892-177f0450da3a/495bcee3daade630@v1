# VibeLife Skill 最佳实践

## 1. 架构原则

### 1.1 LLM 工具路由 (强制)

**禁止** Python 硬编码条件判断路由，**只允许** LLM 工具调用。

```python
# ❌ 错误 - 硬编码路由
if user_intent == "assessment":
    return start_assessment()
elif user_intent == "exercise":
    return start_exercise()

# ✅ 正确 - LLM 决定调用哪个工具
# 在 SKILL.md 中定义规则，让 LLM 决定
```

### 1.2 工具分类

| 类型 | 用途 | 命名规范 |
|------|------|----------|
| compute | 计算/处理数据 | `calculate_*`, `analyze_*`, `process_*` |
| display | 渲染卡片 | `show_*` |
| action | 保存/触发 | `save_*`, `start_*`, `trigger_*` |

### 1.3 卡片委托模式

所有展示工具都应委托给 `show_card`:

```python
@tool_handler("show_result")
async def execute_show_result(args, context):
    return await ToolRegistry.execute(
        "show_card",
        {"card_type": "result_card", "data": args.get("data")},
        context
    )
```

## 2. SKILL.md 编写

### 2.1 触发词设计

- 包含中英文关键词
- 覆盖常见表达方式
- 避免与其他 Skill 冲突

```markdown
触发词：心理、心理学、焦虑、抑郁、压力、情绪、认知、想法、
负面思维、心理测试、PHQ、GAD、psychology、anxiety、depression
```

### 2.2 工具使用规则

明确定义**何时必须**使用工具：

```markdown
## 工具使用规则

### 必须使用工具的场景
- 用户请求做评估 → 使用 start_assessment
- 评估完成需要显示结果 → 使用 show_assessment_result
- 用户描述负面想法 → 使用 analyze_thought

### 禁止直接回复的场景
- 评估分数计算 (必须用工具)
- 危机检测 (必须用工具检查)
```

### 2.3 安全边界

```markdown
## 安全边界

### 能力范围
- 提供心理教育和自助工具
- 进行标准化筛查评估
- 引导认知重构练习

### 明确不做
- 不诊断精神疾病
- 不替代专业治疗
- 不处理紧急危机 (转介)
```

## 3. handlers.py 编写

### 3.1 类型安全

```python
from typing import Any, Dict, List, Optional, TypedDict

class AssessmentResult(TypedDict):
    score: int
    severity: str
    interpretation: str

@tool_handler("calculate_assessment")
async def execute_calculate_assessment(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    # 类型验证
    responses: List[int] = args.get("responses", [])
    assessment_type: str = args.get("type", "phq9")

    # ...
```

### 3.2 错误处理

```python
@tool_handler("some_tool")
async def execute_some_tool(args, context):
    try:
        # 业务逻辑
        result = process(args)
        return {"success": True, "data": result}
    except ValueError as e:
        return {"success": False, "error": f"参数错误: {e}"}
    except Exception as e:
        logger.error(f"Tool error: {e}")
        return {"success": False, "error": "处理失败，请重试"}
```

### 3.3 数据结构设计

卡片数据应该**自包含**，前端不需要额外计算：

```python
# ✅ 正确 - 数据自包含
return {
    "card_type": "assessment_result",
    "data": {
        "score": 15,
        "max_score": 27,
        "percentage": 55.6,  # 预计算
        "severity": "moderate",
        "severity_label": "中度",  # 预计算
        "color": "orange",  # 预计算
        "recommendations": [...]
    }
}

# ❌ 错误 - 前端需要计算
return {
    "card_type": "assessment_result",
    "data": {
        "score": 15,
        "max_score": 27
        # 前端需要自己计算 percentage, severity 等
    }
}
```

## 4. 前端卡片编写

### 4.1 响应式设计

```tsx
// 使用 Tailwind 响应式类
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
  {items.map(item => (
    <ItemCard key={item.id} {...item} />
  ))}
</div>
```

### 4.2 加载状态

```tsx
function ResultCard({ data, isLoading }) {
  if (isLoading) {
    return (
      <div className="animate-pulse bg-gray-100 rounded-xl h-48" />
    );
  }

  return (
    <div className="bg-white rounded-xl p-6">
      {/* 内容 */}
    </div>
  );
}
```

### 4.3 错误边界

```tsx
function CardErrorFallback({ error }) {
  return (
    <div className="bg-red-50 border border-red-200 rounded-xl p-6">
      <p className="text-red-600">加载失败: {error.message}</p>
    </div>
  );
}
```

### 4.4 懒加载注册

```typescript
// initCards.ts - 使用懒加载减少初始 bundle
registerLazyCard(
  CARD_TYPES.MY_CARD,
  () => import('./my-skill/cards/MyCard')
);

// 不要同步导入大组件
// ❌ import MyCard from './my-skill/cards/MyCard';
// ❌ registerCard(CARD_TYPES.MY_CARD, MyCard);
```

## 5. 规则文件编写

### 5.1 结构化知识

```markdown
# 焦虑管理规则

## 症状识别

### 身体症状
- 心跳加速
- 呼吸急促
- 肌肉紧张

### 认知症状
- 过度担忧
- 灾难化思维
- 注意力难集中

## 干预技术

### 即时缓解 (5-10分钟)
1. 4-7-8 呼吸法
2. 5-4-3-2-1 接地技术

### 长期管理 (4-8周)
1. 认知重构
2. 暴露疗法
3. 放松训练
```

### 5.2 引用规范

```markdown
# _index.md

## 规则文件索引

@rules/assessment.md - 评估量表和计分规则
@rules/cognitive.md - 认知重构技术
@rules/exercises.md - 练习指导
```

## 6. 命名规范

### 6.1 文件命名

| 类型 | 规范 | 示例 |
|------|------|------|
| Skill ID | 小写，无连字符 | `psych`, `zodiac` |
| 卡片组件 | PascalCase + Card | `AssessmentResultCard.tsx` |
| 工具名 | snake_case | `calculate_assessment` |
| 规则文件 | kebab-case | `anxiety-workshop.md` |

### 6.2 卡片类型

```typescript
// CardRegistry.ts
// {SKILL_PREFIX}_{CARD_TYPE}
PSYCH_ASSESSMENT_FORM: 'assessment_form',
PSYCH_ASSESSMENT_RESULT: 'assessment_result',
```

## 7. 测试验证

### 7.1 TypeScript 编译

```bash
cd apps/web && pnpm tsc --noEmit
```

### 7.2 Python 语法

```bash
python -m py_compile apps/api/skills/{skill}/tools/handlers.py
```

### 7.3 卡片渲染

1. 启动开发服务器
2. 触发工具调用
3. 检查卡片渲染

## 8. 常见问题

### Q: 卡片不显示？

检查:
1. CardRegistry 是否注册了卡片类型
2. initCards.ts 是否懒加载了组件
3. handlers.py 返回的 card_type 是否匹配

### Q: 工具不被调用？

检查:
1. SKILL.md 触发词是否覆盖用户输入
2. 工具使用规则是否明确
3. tools.yaml 工具定义是否正确

### Q: 数据格式错误？

检查:
1. handlers.py 返回的数据结构
2. 前端卡片期望的 Props 类型
3. 是否有必填字段缺失
