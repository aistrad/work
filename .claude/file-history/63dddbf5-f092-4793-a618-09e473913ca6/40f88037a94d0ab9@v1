"use client";

/**
 * MePanel - Me Tab 的右侧 Panel 内容（v3.0 Bento 布局重构）
 *
 * 定位：Self-Discovery Hub（自我认知中心）
 *
 * v3.0 设计理念：
 * - "被惦记" 感觉 — TodayEnergyCard 置顶，一进来就看到今日能量
 * - Bento 布局 — 紧凑但有层次的卡片网格
 * - 东西方融合 — 八字/占星卡片各有特色但风格统一
 *
 * 数据级别：
 * - Level A: 完整数据（八字 + 星座 + 原型 + 今日能量）
 * - Level B: 有对话但无命理（行为洞察 + 引导）
 * - Level C: 新用户（Onboarding 引导）
 */

import { useRouter, useSearchParams } from "next/navigation";
import { cn } from "@/lib/utils";
import { useMeData, type DataLevel } from "@/hooks/useMeData";
import {
  UserInfoCard,
  UserInfoCardSkeleton,
  BaziSummaryCard,
  BaziSummaryCardSkeleton,
  ZodiacSummaryCard,
  ZodiacSummaryCardSkeleton,
  ArchetypeCard,
  ArchetypeCardSkeleton,
  TodayEnergyCard,
  TodayEnergyCardSkeleton,
  BehaviorInsightCard,
  BehaviorInsightCardSkeleton,
  MeEmptyState,
  MeEmptyStateSkeleton,
} from "@/components/me";
import { Settings, ChevronDown, ChevronUp, Bell, LogOut, CreditCard, Crown, Check } from "lucide-react";
import { useState } from "react";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface MePanelProps {
  mockDataLevel?: DataLevel;
  onEditProfile?: () => void;
  onLogout?: () => void;
  className?: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Sub-components
// ═══════════════════════════════════════════════════════════════════════════

function SettingsSection({
  onNotifications,
  onSubscription,
  onLogout,
}: {
  onNotifications?: () => void;
  onSubscription?: () => void;
  onLogout?: () => void;
}) {
  const [expanded, setExpanded] = useState(false);

  return (
    <section>
      <button
        onClick={() => setExpanded((prev) => !prev)}
        className="w-full flex items-center justify-between py-2 hover:opacity-80 transition-opacity"
      >
        <h2 className="font-serif text-base font-semibold text-foreground flex items-center gap-2">
          <Settings className="w-4 h-4 text-muted-foreground" />
          设置
        </h2>
        {expanded ? (
          <ChevronUp className="w-5 h-5 text-muted-foreground" />
        ) : (
          <ChevronDown className="w-5 h-5 text-muted-foreground" />
        )}
      </button>

      {expanded ? (
        <div className="mt-3 space-y-2 animate-fade-in">
          <button
            onClick={onSubscription}
            className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted transition-colors text-left"
          >
            <CreditCard className="w-5 h-5 text-muted-foreground" />
            <span className="text-sm text-foreground">订阅管理</span>
          </button>
          <button
            onClick={onNotifications}
            className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted transition-colors text-left"
          >
            <Bell className="w-5 h-5 text-muted-foreground" />
            <span className="text-sm text-foreground">通知设置</span>
          </button>
          <button
            onClick={onLogout}
            className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left text-red-600 dark:text-red-400"
          >
            <LogOut className="w-5 h-5" />
            <span className="text-sm">退出登录</span>
          </button>
        </div>
      ) : null}
    </section>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Loading Skeleton - Bento Style
// ═══════════════════════════════════════════════════════════════════════════

function MePanelSkeleton() {
  return (
    <div className="h-full overflow-y-auto p-4 space-y-4">
      {/* Today Energy Skeleton */}
      <TodayEnergyCardSkeleton />

      {/* User Info + Archetype Row */}
      <div className="grid grid-cols-1 gap-4">
        <UserInfoCardSkeleton />
      </div>

      {/* Bazi + Zodiac Row */}
      <div className="grid grid-cols-1 gap-4">
        <BaziSummaryCardSkeleton />
        <ZodiacSummaryCardSkeleton />
      </div>

      {/* Archetype */}
      <ArchetypeCardSkeleton />
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Level A Content - Full Discovery (Bento Layout)
// ═══════════════════════════════════════════════════════════════════════════

function LevelAContent({
  data,
  onEditProfile,
  onExploreBazi,
  onExploreZodiac,
  onExploreArchetype,
  onExploreEnergy,
}: {
  data: NonNullable<ReturnType<typeof useMeData>["data"]>;
  onEditProfile?: () => void;
  onExploreBazi: () => void;
  onExploreZodiac: () => void;
  onExploreArchetype: () => void;
  onExploreEnergy: () => void;
}) {
  // Transform data for components
  const baziData = data.bazi_summary ? {
    dayMaster: {
      element: data.bazi_summary.day_master.element,
      character: data.bazi_summary.day_master.character,
      description: data.bazi_summary.day_master.description,
    },
    fiveElements: data.bazi_summary.five_elements,
    dailyFortune: data.bazi_summary.daily_fortune,
  } : null;

  const zodiacData = data.zodiac_summary ? {
    sun: data.zodiac_summary.sun,
    moon: data.zodiac_summary.moon,
    rising: data.zodiac_summary.rising,
    transitHighlight: data.zodiac_summary.transit_highlight,
  } : null;

  // Build TodayEnergy data - prefer backend data, fallback to local construction
  const todayEnergyData = data.today_energy ? {
    overallScore: data.today_energy.overall_score,
    energyLabel: data.today_energy.energy_label,
    baziInsight: data.today_energy.bazi_insight ? {
      score: data.today_energy.bazi_insight.score,
      headline: data.today_energy.bazi_insight.headline,
    } : undefined,
    zodiacInsight: data.today_energy.zodiac_insight ? {
      score: data.today_energy.zodiac_insight.score,
      headline: data.today_energy.zodiac_insight.headline,
    } : undefined,
    actionTip: data.today_energy.action_tip,
    keywords: data.today_energy.keywords,
    solarTerm: data.today_energy.solar_term,
  } : {
    // Fallback: construct from bazi + zodiac
    overallScore: 75,
    energyLabel: "状态良好",
    baziInsight: baziData?.dailyFortune ? {
      score: 80,
      headline: baziData.dailyFortune,
    } : undefined,
    zodiacInsight: zodiacData?.transitHighlight ? {
      score: 70,
      headline: zodiacData.transitHighlight,
    } : undefined,
    actionTip: "今日适合专注内心，把握当下",
    keywords: ["专注", "内省"],
  };

  return (
    <div className="space-y-4">
      {/* 1. Today Energy - 头条卡片 */}
      <TodayEnergyCard
        data={todayEnergyData}
        displayName={data.user.display_name}
        onClick={onExploreEnergy}
      />

      {/* 2. User Info */}
      <UserInfoCard
        displayName={data.user.display_name}
        avatarUrl={data.user.avatar_url}
        tagline={data.user.tagline}
        primaryArchetype={data.archetype?.primary.name_cn}
        streakDays={7} // TODO: Get from backend
        energyLevel={todayEnergyData.overallScore}
        onEditProfile={onEditProfile}
      />

      {/* 3. Section: 了解自己 */}
      <section className="space-y-4">
        <h2 className="font-serif text-lg font-semibold text-text-primary flex items-center gap-2">
          <span className="w-1 h-5 bg-gradient-to-b from-gold-400 to-accent-primary rounded-full" />
          了解自己
        </h2>

        {/* Bazi + Zodiac Cards */}
        <div className="grid grid-cols-1 gap-4">
          <BaziSummaryCard
            data={baziData}
            onExplore={onExploreBazi}
            showDailyFortune={false} // 已在 TodayEnergyCard 显示
          />

          <ZodiacSummaryCard
            data={zodiacData}
            onExplore={onExploreZodiac}
            showTransit={false} // 已在 TodayEnergyCard 显示
          />
        </div>

        {/* Archetype Card */}
        <ArchetypeCard
          data={data.archetype}
          onExplore={onExploreArchetype}
        />
      </section>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Level B Content - Behavior Insight
// ═══════════════════════════════════════════════════════════════════════════

function LevelBContent({
  data,
  onEditProfile,
  onExploreBazi,
  onExploreZodiac,
}: {
  data: NonNullable<ReturnType<typeof useMeData>["data"]>;
  onEditProfile?: () => void;
  onExploreBazi: () => void;
  onExploreZodiac: () => void;
}) {
  return (
    <div className="space-y-4">
      {/* Welcome Card */}
      <TodayEnergyCard
        displayName={data.user.display_name}
        onClick={onExploreBazi}
      />

      {/* User Info */}
      <UserInfoCard
        displayName={data.user.display_name}
        avatarUrl={data.user.avatar_url}
        tagline={data.user.tagline}
        onEditProfile={onEditProfile}
      />

      {/* Behavior Insight */}
      {data.behavior_insight && (
        <BehaviorInsightCard
          data={data.behavior_insight}
          onExploreBazi={onExploreBazi}
          onExploreZodiac={onExploreZodiac}
        />
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Level C Content - Empty State
// ═══════════════════════════════════════════════════════════════════════════

function LevelCContent({
  onStartChat,
  onExploreBazi,
  onExploreZodiac,
}: {
  onStartChat: () => void;
  onExploreBazi: () => void;
  onExploreZodiac: () => void;
}) {
  return (
    <div className="space-y-4">
      {/* Welcome Card for new users */}
      <TodayEnergyCard onClick={onStartChat} />

      {/* Empty State with guidance */}
      <MeEmptyState
        onStartChat={onStartChat}
        onExploreBazi={onExploreBazi}
        onExploreZodiac={onExploreZodiac}
      />
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// MePanel Component
// ═══════════════════════════════════════════════════════════════════════════

export function MePanel({
  mockDataLevel = "A",
  onEditProfile,
  onLogout,
  className,
}: MePanelProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  // Support query parameter for testing different data levels
  // Usage: /chat?me_level=B or /chat?me_level=C
  const queryLevel = searchParams.get("me_level") as DataLevel | null;
  const effectiveLevel = queryLevel || mockDataLevel;

  const { data, isLoading, error, refresh } = useMeData({ mockLevel: effectiveLevel });

  // Navigation handlers
  const handleExploreBazi = () => {
    router.push("/chat?skill=bazi&prompt=深入了解我的命盘");
  };

  const handleExploreZodiac = () => {
    router.push("/chat?skill=zodiac&prompt=分析我的星盘");
  };

  const handleExploreArchetype = () => {
    router.push("/chat?skill=vibe_id&prompt=深入了解我的原型");
  };

  const handleExploreEnergy = () => {
    router.push("/chat?prompt=今天运势如何？有什么建议吗？");
  };

  const handleStartChat = () => {
    router.push("/chat");
  };

  const handleEditProfile = () => {
    router.push("/settings?section=profile");
  };

  // Loading state
  if (isLoading) {
    return <MePanelSkeleton />;
  }

  // Error state
  if (error) {
    return (
      <div className={cn("h-full overflow-y-auto p-4", className)}>
        <div className="text-center py-10">
          <p className="text-sm text-muted-foreground mb-4">
            加载失败，请重试
          </p>
          <button
            onClick={refresh}
            className="px-4 py-2 bg-vellum-100 hover:bg-vellum-200 text-vellum-700 rounded-lg text-sm font-medium transition-colors"
          >
            重新加载
          </button>
        </div>
      </div>
    );
  }

  // No data (shouldn't happen, but handle gracefully)
  if (!data) {
    return <MePanelSkeleton />;
  }

  return (
    <div className={cn("h-full overflow-y-auto p-4 space-y-4", className)}>
      {/* Content based on data level */}
      {data.data_level === "A" ? (
        <LevelAContent
          data={data}
          onEditProfile={onEditProfile || handleEditProfile}
          onExploreBazi={handleExploreBazi}
          onExploreZodiac={handleExploreZodiac}
          onExploreArchetype={handleExploreArchetype}
          onExploreEnergy={handleExploreEnergy}
        />
      ) : data.data_level === "B" ? (
        <LevelBContent
          data={data}
          onEditProfile={onEditProfile || handleEditProfile}
          onExploreBazi={handleExploreBazi}
          onExploreZodiac={handleExploreZodiac}
        />
      ) : (
        <LevelCContent
          onStartChat={handleStartChat}
          onExploreBazi={handleExploreBazi}
          onExploreZodiac={handleExploreZodiac}
        />
      )}

      {/* Settings Section (only for logged-in users) */}
      {data.data_level !== "C" ? (
        <SettingsSection
          onLogout={onLogout}
        />
      ) : null}

      {/* Bottom padding for safe area */}
      <div className="h-4" />
    </div>
  );
}

export default MePanel;
