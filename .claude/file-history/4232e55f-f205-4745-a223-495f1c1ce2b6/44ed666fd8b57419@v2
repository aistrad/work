"""
Account Routes 测试
测试认证、用户资料、访客会话、身份棱镜等端点

覆盖端点:
- /account/auth/* - 认证相关 (OAuth only)
- /account/profile/* - 用户资料
- /account/guest/* - 访客会话
- /account/identity/* - 身份棱镜

v8.0 更新:
- 移除邮箱密码认证测试
- 添加微信 OAuth 测试
- 添加账户删除测试
- 添加单一登录方式限制测试
"""

import pytest
from datetime import datetime, timedelta
from unittest.mock import AsyncMock, patch
from uuid import UUID

pytestmark = pytest.mark.asyncio


# ═══════════════════════════════════════════════════════════════════════════
# OAuth Endpoints Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestGoogleOAuthEndpoint:
    """Google OAuth 端点测试"""

    async def test_google_auth_success(self, client, mock_oauth_service):
        """测试 Google OAuth 登录成功"""
        response = await client.post(
            "/api/v1/account/auth/oauth/google",
            json={"id_token": "valid_google_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data
        assert data["token_type"] == "bearer"

    async def test_google_auth_with_onboarding(self, client, mock_oauth_service):
        """测试 Google OAuth 带 onboarding 数据"""
        response = await client.post(
            "/api/v1/account/auth/oauth/google",
            json={
                "id_token": "valid_google_token",
                "onboarding": {
                    "birth_datetime": "1990-05-15T10:30:00",
                    "birth_location": "上海",
                    "skill": "zodiac"
                }
            }
        )

        assert response.status_code == 200

    async def test_google_auth_invalid_token(self, client, mock_oauth_service):
        """测试无效 Google token"""
        mock_oauth_service.google_login.side_effect = ValueError("Invalid Google token")

        response = await client.post(
            "/api/v1/account/auth/oauth/google",
            json={"id_token": "invalid_token"}
        )

        assert response.status_code == 401

    async def test_google_auth_single_login_method_restriction(self, client, mock_oauth_service):
        """测试单一登录方式限制 - 邮箱已被其他方式注册"""
        mock_oauth_service.google_login.side_effect = ValueError(
            "This email is already registered with apple. Please use that login method instead."
        )

        response = await client.post(
            "/api/v1/account/auth/oauth/google",
            json={"id_token": "valid_google_token"}
        )

        assert response.status_code == 409  # Conflict
        assert "already registered" in response.json()["detail"]


class TestAppleOAuthEndpoint:
    """Apple OAuth 端点测试"""

    async def test_apple_auth_success(self, client, mock_oauth_service):
        """测试 Apple OAuth 登录成功"""
        response = await client.post(
            "/api/v1/account/auth/oauth/apple",
            json={"id_token": "valid_apple_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data

    async def test_apple_auth_with_user_name(self, client, mock_oauth_service):
        """测试 Apple OAuth 带用户名（首次登录）"""
        response = await client.post(
            "/api/v1/account/auth/oauth/apple",
            json={
                "id_token": "valid_apple_token",
                "user_name": "Apple User"
            }
        )

        assert response.status_code == 200

    async def test_apple_auth_invalid_token(self, client, mock_oauth_service):
        """测试无效 Apple token"""
        mock_oauth_service.apple_login.side_effect = ValueError("Invalid Apple token")

        response = await client.post(
            "/api/v1/account/auth/oauth/apple",
            json={"id_token": "invalid_token"}
        )

        assert response.status_code == 401

    async def test_apple_auth_single_login_method_restriction(self, client, mock_oauth_service):
        """测试单一登录方式限制 - 邮箱已被其他方式注册"""
        mock_oauth_service.apple_login.side_effect = ValueError(
            "This email is already registered with google. Please use that login method instead."
        )

        response = await client.post(
            "/api/v1/account/auth/oauth/apple",
            json={"id_token": "valid_apple_token"}
        )

        assert response.status_code == 409  # Conflict


class TestWechatOAuthEndpoint:
    """微信 OAuth 端点测试"""

    async def test_wechat_generate_qrcode(self, client, mock_wechat_service):
        """测试生成微信二维码"""
        response = await client.post(
            "/api/v1/account/auth/oauth/wechat/qrcode",
            json={"redirect_uri": "https://example.com/auth/wechat-callback"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "scene_id" in data
        assert "qrcode_url" in data
        assert "expires_at" in data

    async def test_wechat_poll_status_pending(self, client, mock_wechat_service):
        """测试轮询微信登录状态 - pending"""
        mock_wechat_service.poll_status.return_value = {"status": "pending"}

        response = await client.get(
            "/api/v1/account/auth/oauth/wechat/status/test_scene_id"
        )

        assert response.status_code == 200
        assert response.json()["status"] == "pending"

    async def test_wechat_poll_status_scanned(self, client, mock_wechat_service):
        """测试轮询微信登录状态 - scanned"""
        mock_wechat_service.poll_status.return_value = {
            "status": "scanned",
            "message": "User scanned, waiting for confirmation"
        }

        response = await client.get(
            "/api/v1/account/auth/oauth/wechat/status/test_scene_id"
        )

        assert response.status_code == 200
        assert response.json()["status"] == "scanned"

    async def test_wechat_poll_status_confirmed(self, client, mock_wechat_service):
        """测试轮询微信登录状态 - confirmed"""
        mock_wechat_service.poll_status.return_value = {
            "status": "confirmed",
            "tokens": {
                "access_token": "test_access_token",
                "refresh_token": "test_refresh_token",
                "token_type": "bearer",
                "expires_in": 3600
            },
            "user": {
                "user_id": "550e8400-e29b-41d4-a716-446655440000",
                "vibe_id": "VB20260105001",
                "display_name": "微信用户"
            }
        }

        response = await client.get(
            "/api/v1/account/auth/oauth/wechat/status/test_scene_id"
        )

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "confirmed"
        assert data["access_token"] == "test_access_token"

    async def test_wechat_poll_status_expired(self, client, mock_wechat_service):
        """测试轮询微信登录状态 - expired"""
        mock_wechat_service.poll_status.return_value = {
            "status": "expired",
            "message": "QR code expired"
        }

        response = await client.get(
            "/api/v1/account/auth/oauth/wechat/status/test_scene_id"
        )

        assert response.status_code == 200
        assert response.json()["status"] == "expired"

    async def test_wechat_callback_success(self, client, mock_wechat_service):
        """测试微信回调成功"""
        response = await client.post(
            "/api/v1/account/auth/oauth/wechat/callback",
            json={
                "code": "valid_wechat_code",
                "state": "test_scene_id"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data

    async def test_wechat_callback_invalid(self, client, mock_wechat_service):
        """测试微信回调失败"""
        mock_wechat_service.handle_callback.return_value = None

        response = await client.post(
            "/api/v1/account/auth/oauth/wechat/callback",
            json={
                "code": "invalid_code",
                "state": "test_scene_id"
            }
        )

        assert response.status_code == 401


# ═══════════════════════════════════════════════════════════════════════════
# Account Deletion Endpoints Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestAccountDeletionEndpoints:
    """账户删除端点测试"""

    async def test_request_deletion_success(self, client, override_auth, mock_account_deletion_service):
        """测试请求账户删除成功"""
        scheduled_at = (datetime.utcnow() + timedelta(days=30)).isoformat()
        mock_account_deletion_service.request_deletion.return_value = {
            "status": "pending_deletion",
            "deletion_requested_at": datetime.utcnow().isoformat(),
            "deletion_scheduled_at": scheduled_at,
            "grace_period_days": 30,
            "message": "Your account will be permanently deleted..."
        }

        response = await client.post(
            "/api/v1/account/auth/delete-account",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "pending_deletion"
        assert data["grace_period_days"] == 30

    async def test_request_deletion_already_pending(self, client, override_auth, mock_account_deletion_service):
        """测试重复请求账户删除"""
        mock_account_deletion_service.request_deletion.side_effect = ValueError(
            "Account deletion already requested"
        )

        response = await client.post(
            "/api/v1/account/auth/delete-account",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 400
        assert "already requested" in response.json()["detail"]

    async def test_cancel_deletion_success(self, client, override_auth, mock_account_deletion_service):
        """测试取消账户删除成功"""
        mock_account_deletion_service.cancel_deletion.return_value = {
            "status": "active",
            "message": "Account deletion request has been cancelled."
        }

        response = await client.post(
            "/api/v1/account/auth/cancel-deletion",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        assert response.json()["status"] == "active"

    async def test_cancel_deletion_no_pending(self, client, override_auth, mock_account_deletion_service):
        """测试取消不存在的删除请求"""
        mock_account_deletion_service.cancel_deletion.side_effect = ValueError(
            "No pending deletion request to cancel"
        )

        response = await client.post(
            "/api/v1/account/auth/cancel-deletion",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 400

    async def test_get_deletion_status_active(self, client, override_auth, mock_account_deletion_service):
        """测试获取删除状态 - active"""
        mock_account_deletion_service.get_deletion_status.return_value = {
            "status": "active",
            "can_cancel": False
        }

        response = await client.get(
            "/api/v1/account/auth/deletion-status",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "active"
        assert data["can_cancel"] is False

    async def test_get_deletion_status_pending(self, client, override_auth, mock_account_deletion_service):
        """测试获取删除状态 - pending_deletion"""
        scheduled_at = (datetime.utcnow() + timedelta(days=30)).isoformat()
        mock_account_deletion_service.get_deletion_status.return_value = {
            "status": "pending_deletion",
            "deletion_scheduled_at": scheduled_at,
            "can_cancel": True
        }

        response = await client.get(
            "/api/v1/account/auth/deletion-status",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "pending_deletion"
        assert data["can_cancel"] is True

    async def test_deletion_endpoints_unauthenticated(self, client):
        """测试未认证用户访问删除端点"""
        # Request deletion
        response = await client.post("/api/v1/account/auth/delete-account")
        assert response.status_code in [401, 403, 422]

        # Cancel deletion
        response = await client.post("/api/v1/account/auth/cancel-deletion")
        assert response.status_code in [401, 403, 422]

        # Get status
        response = await client.get("/api/v1/account/auth/deletion-status")
        assert response.status_code in [401, 403, 422]


# ═══════════════════════════════════════════════════════════════════════════
# Token Refresh Endpoints Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestRefreshTokenEndpoint:
    """Token 刷新端点测试"""

    async def test_refresh_token_success(self, client, mock_auth_service):
        """测试刷新 token 成功"""
        response = await client.post(
            "/api/v1/account/auth/refresh",
            json={"refresh_token": "valid_refresh_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data

    async def test_refresh_token_invalid(self, client, mock_auth_service):
        """测试无效 refresh token"""
        mock_auth_service.refresh_token.side_effect = ValueError("Invalid refresh token")

        response = await client.post(
            "/api/v1/account/auth/refresh",
            json={"refresh_token": "invalid_token"}
        )

        assert response.status_code == 401


class TestLogoutEndpoint:
    """登出端点测试"""

    async def test_logout_success(self, client, override_auth):
        """测试登出成功"""
        response = await client.post(
            "/api/v1/account/auth/logout",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        assert response.json()["message"] == "Logged out successfully"

    async def test_logout_unauthenticated(self, client):
        """测试未认证用户登出"""
        response = await client.post("/api/v1/account/auth/logout")
        assert response.status_code in [401, 403, 422]


class TestGetMeEndpoint:
    """获取当前用户端点测试"""

    async def test_get_me_authenticated(self, client, override_auth):
        """测试已认证用户获取信息"""
        response = await client.get(
            "/api/v1/account/auth/me",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["vibe_id"] == "VB20260105001"
        assert data["display_name"] == "测试用户"

    async def test_get_me_unauthenticated(self, client):
        """测试未认证用户获取信息"""
        response = await client.get("/api/v1/account/auth/me")
        assert response.status_code in [401, 403, 422]


# ═══════════════════════════════════════════════════════════════════════════
# Profile Endpoints Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestProfileEndpoints:
    """用户资料端点测试"""

    async def test_get_profile_success(self, client, override_auth, mock_user_repository):
        """测试获取用户资料成功"""
        response = await client.get(
            "/api/v1/account/profile",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["vibe_id"] == "VB20260105001"
        assert data["display_name"] == "测试用户"
        assert "timezone" in data
        assert "language" in data

    async def test_get_profile_not_found(self, client, override_auth):
        """测试用户资料不存在"""
        with patch("routes.account.UserRepository") as mock_repo:
            mock_repo.get_by_id = AsyncMock(return_value=None)

            response = await client.get(
                "/api/v1/account/profile",
                headers={"Authorization": "Bearer test_token"}
            )

        assert response.status_code == 404

    async def test_get_profile_unauthenticated(self, client):
        """测试未认证用户获取资料"""
        response = await client.get("/api/v1/account/profile")
        assert response.status_code in [401, 403, 422]

    async def test_update_profile_success(self, client, override_auth, sample_user):
        """测试更新用户资料成功"""
        updated_user = {**sample_user, "display_name": "新名字"}

        with patch("routes.account.UserRepository") as mock_repo:
            mock_repo.update = AsyncMock(return_value=updated_user)

            response = await client.put(
                "/api/v1/account/profile",
                headers={"Authorization": "Bearer test_token"},
                json={"display_name": "新名字"}
            )

        assert response.status_code == 200
        assert response.json()["display_name"] == "新名字"

    async def test_export_data_success(
        self, client, override_auth, mock_user_repository,
        mock_skill_repository, mock_subscription_repository
    ):
        """测试导出用户数据（GDPR）"""
        response = await client.get(
            "/api/v1/account/profile/export",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "user" in data
        assert "skill_profiles" in data
        assert "consents" in data
        assert "export_date" in data


# ═══════════════════════════════════════════════════════════════════════════
# Guest Session Endpoints Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestGuestSessionEndpoints:
    """访客会话端点测试"""

    async def test_create_guest_session(self, client, mock_guest_session_service):
        """测试创建访客会话"""
        response = await client.post("/api/v1/account/guest/session")

        assert response.status_code == 200
        data = response.json()
        assert "session_id" in data
        assert "expires_at" in data
        assert "guest_session_id" in response.cookies

    async def test_get_guest_session_success(self, client, mock_guest_session_service):
        """测试获取访客会话成功"""
        response = await client.get(
            "/api/v1/account/guest/session",
            cookies={"guest_session_id": "guest_session_123"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["session_id"] == "guest_session_123"

    async def test_get_guest_session_no_cookie(self, client):
        """测试获取访客会话无 cookie"""
        response = await client.get("/api/v1/account/guest/session")
        assert response.status_code == 404

    async def test_save_guest_onboarding(self, client, mock_guest_session_service):
        """测试保存访客 onboarding 数据"""
        response = await client.put(
            "/api/v1/account/guest/session/onboarding",
            cookies={"guest_session_id": "guest_session_123"},
            json={
                "birth_datetime": "1990-05-15T10:30:00",
                "birth_location": "北京",
                "gender": "male",
                "voice_mode": "warm",
                "skill": "bazi"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["birth_location"] == "北京"

    async def test_delete_guest_session(self, client):
        """测试删除访客会话"""
        response = await client.delete(
            "/api/v1/account/guest/session",
            cookies={"guest_session_id": "guest_session_123"}
        )

        assert response.status_code == 200
        assert response.json()["message"] == "Guest session cleared"


# ═══════════════════════════════════════════════════════════════════════════
# Identity Prism Endpoints Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestIdentityPrismEndpoints:
    """身份棱镜端点测试"""

    async def test_get_prism_authenticated(self, client, override_auth, mock_skill_repository):
        """测试已认证用户获取身份棱镜"""
        response = await client.get(
            "/api/v1/account/identity/prism",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "core" in data
        assert "inner" in data
        assert "outer" in data
        assert "progress" in data
        assert "dimensions" in data
        assert "memories" in data

    async def test_get_prism_guest(self, client, override_auth_optional_none):
        """测试访客获取默认身份棱镜"""
        response = await client.get("/api/v1/account/identity/prism")

        assert response.status_code == 200
        data = response.json()
        assert data["progress"] == 35

    async def test_get_prism_dimensions_calculated(self, client, override_auth, mock_skill_repository):
        """测试身份棱镜维度计算"""
        response = await client.get(
            "/api/v1/account/identity/prism",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert len(data["dimensions"]) == 4
        dimension_names = [d["name"] for d in data["dimensions"]]
        assert "八字命理" in dimension_names
        assert "星座能量" in dimension_names
