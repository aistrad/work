/**
 * WeChat QR Code Modal
 * Displays QR code for WeChat scan login with status polling
 */
"use client";

import { useEffect, useState, useCallback, useRef } from "react";
import { Button } from "@/components/ui/Button";
import { getWechatQRCode, pollWechatStatus, OnboardingData } from "@/lib/api";

interface WechatQRModalProps {
  onSuccess: () => void;
  onError: (error: string) => void;
  onClose: () => void;
  onboarding?: OnboardingData;
}

type ScanStatus = "loading" | "pending" | "scanned" | "confirmed" | "expired" | "error";

export function WechatQRModal({
  onSuccess,
  onError,
  onClose,
}: WechatQRModalProps) {
  const [status, setStatus] = useState<ScanStatus>("loading");
  const [qrcodeUrl, setQrcodeUrl] = useState<string | null>(null);
  const [sceneId, setSceneId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  const pollingRef = useRef<NodeJS.Timeout | null>(null);
  const mountedRef = useRef(true);

  // Generate QR code
  const generateQRCode = useCallback(async () => {
    try {
      setStatus("loading");
      setError(null);

      const redirectUri = `${window.location.origin}/auth/wechat-callback`;
      const result = await getWechatQRCode(redirectUri);

      if (!mountedRef.current) return;

      setQrcodeUrl(result.qrcode_url);
      setSceneId(result.scene_id);
      setStatus("pending");
    } catch (err) {
      if (!mountedRef.current) return;
      setError(err instanceof Error ? err.message : "Failed to generate QR code");
      setStatus("error");
    }
  }, []);

  // Poll status
  const pollStatus = useCallback(async () => {
    if (!sceneId || !mountedRef.current) return;

    try {
      const result = await pollWechatStatus(sceneId);

      if (!mountedRef.current) return;

      switch (result.status) {
        case "pending":
          setStatus("pending");
          break;

        case "scanned":
          setStatus("scanned");
          break;

        case "confirmed":
          setStatus("confirmed");
          // Stop polling
          if (pollingRef.current) {
            clearInterval(pollingRef.current);
            pollingRef.current = null;
          }
          // Success - tokens should be stored by pollWechatStatus
          onSuccess();
          break;

        case "expired":
          setStatus("expired");
          // Stop polling
          if (pollingRef.current) {
            clearInterval(pollingRef.current);
            pollingRef.current = null;
          }
          break;

        default:
          break;
      }
    } catch (err) {
      console.error("Polling error:", err);
    }
  }, [sceneId, onSuccess]);

  // Initialize
  useEffect(() => {
    mountedRef.current = true;
    generateQRCode();

    return () => {
      mountedRef.current = false;
      if (pollingRef.current) {
        clearInterval(pollingRef.current);
      }
    };
  }, [generateQRCode]);

  // Start polling when we have a scene ID
  useEffect(() => {
    if (sceneId && status === "pending") {
      // Poll every 2 seconds
      pollingRef.current = setInterval(pollStatus, 2000);

      return () => {
        if (pollingRef.current) {
          clearInterval(pollingRef.current);
        }
      };
    }
  }, [sceneId, status, pollStatus]);

  // Handle refresh
  const handleRefresh = () => {
    generateQRCode();
  };

  // Handle backdrop click
  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
      onClick={handleBackdropClick}
    >
      <div className="bg-bg-primary rounded-2xl p-6 w-[340px] shadow-2xl animate-in fade-in zoom-in-95 duration-200">
        {/* Header */}
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-lg font-semibold text-text-primary">
            微信扫码登录
          </h3>
          <button
            onClick={onClose}
            className="p-1 hover:bg-bg-secondary rounded-lg transition-colors"
          >
            <CloseIcon />
          </button>
        </div>

        {/* QR Code Area */}
        <div className="flex flex-col items-center">
          {status === "loading" && (
            <div className="w-[200px] h-[200px] flex items-center justify-center bg-bg-secondary rounded-lg">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-accent-primary" />
            </div>
          )}

          {status === "pending" && qrcodeUrl && (
            <div className="relative">
              {/* QR Code iframe - WeChat's official QR page */}
              <iframe
                src={qrcodeUrl}
                className="w-[200px] h-[200px] border-0 rounded-lg bg-white"
                title="WeChat QR Code"
                sandbox="allow-scripts allow-same-origin"
              />
              <p className="text-sm text-text-secondary text-center mt-3">
                请使用微信扫描二维码
              </p>
            </div>
          )}

          {status === "scanned" && (
            <div className="w-[200px] h-[200px] flex flex-col items-center justify-center bg-bg-secondary rounded-lg">
              <CheckIcon className="w-12 h-12 text-success mb-3" />
              <p className="text-text-primary font-medium">扫描成功</p>
              <p className="text-sm text-text-secondary mt-1">
                请在手机上确认登录
              </p>
            </div>
          )}

          {status === "confirmed" && (
            <div className="w-[200px] h-[200px] flex flex-col items-center justify-center bg-bg-secondary rounded-lg">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-success mb-3" />
              <p className="text-text-primary font-medium">登录成功</p>
              <p className="text-sm text-text-secondary mt-1">
                正在跳转...
              </p>
            </div>
          )}

          {status === "expired" && (
            <div className="w-[200px] h-[200px] flex flex-col items-center justify-center bg-bg-secondary rounded-lg">
              <ExpiredIcon className="w-12 h-12 text-text-tertiary mb-3" />
              <p className="text-text-primary font-medium">二维码已过期</p>
              <Button
                variant="primary"
                size="sm"
                className="mt-3"
                onClick={handleRefresh}
              >
                刷新二维码
              </Button>
            </div>
          )}

          {status === "error" && (
            <div className="w-[200px] h-[200px] flex flex-col items-center justify-center bg-bg-secondary rounded-lg">
              <ErrorIcon className="w-12 h-12 text-error mb-3" />
              <p className="text-text-primary font-medium">加载失败</p>
              <p className="text-sm text-error mt-1">{error}</p>
              <Button
                variant="primary"
                size="sm"
                className="mt-3"
                onClick={handleRefresh}
              >
                重试
              </Button>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="mt-6 pt-4 border-t border-border-default">
          <p className="text-xs text-text-tertiary text-center">
            使用微信扫一扫登录 VibeLife
          </p>
        </div>
      </div>
    </div>
  );
}

// Icons
function CloseIcon() {
  return (
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" strokeWidth="2">
      <path d="M15 5L5 15M5 5l10 10" />
    </svg>
  );
}

function CheckIcon({ className }: { className?: string }) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <path d="M20 6L9 17l-5-5" />
    </svg>
  );
}

function ExpiredIcon({ className }: { className?: string }) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <circle cx="12" cy="12" r="10" />
      <path d="M12 6v6l4 2" />
    </svg>
  );
}

function ErrorIcon({ className }: { className?: string }) {
  return (
    <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
      <circle cx="12" cy="12" r="10" />
      <path d="M12 8v4M12 16h.01" />
    </svg>
  );
}
