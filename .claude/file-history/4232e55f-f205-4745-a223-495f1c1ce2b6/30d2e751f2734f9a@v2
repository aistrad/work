/**
 * Account Deletion Section
 * GDPR-compliant account deletion with 30-day grace period
 */
"use client";

import { useState, useEffect } from "react";
import { Button } from "@/components/ui/Button";
import {
  requestAccountDeletion,
  cancelAccountDeletion,
  getAccountDeletionStatus,
  type DeletionStatusResponse,
} from "@/lib/api";

export function AccountDeletionSection() {
  const [status, setStatus] = useState<DeletionStatusResponse | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [showConfirmation, setShowConfirmation] = useState(false);

  // Load current deletion status
  useEffect(() => {
    loadStatus();
  }, []);

  const loadStatus = async () => {
    try {
      setIsLoading(true);
      const result = await getAccountDeletionStatus();
      setStatus(result);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Failed to load status");
    } finally {
      setIsLoading(false);
    }
  };

  const handleRequestDeletion = async () => {
    try {
      setIsLoading(true);
      setError(null);
      const result = await requestAccountDeletion();
      setStatus(result);
      setShowConfirmation(false);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Request failed");
    } finally {
      setIsLoading(false);
    }
  };

  const handleCancelDeletion = async () => {
    try {
      setIsLoading(true);
      setError(null);
      const result = await cancelAccountDeletion();
      setStatus(result);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Cancellation failed");
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading && !status) {
    return (
      <div className="p-6 bg-bg-secondary rounded-xl">
        <div className="animate-pulse">
          <div className="h-6 bg-bg-tertiary rounded w-1/3 mb-4"></div>
          <div className="h-4 bg-bg-tertiary rounded w-2/3"></div>
        </div>
      </div>
    );
  }

  const isPendingDeletion = status?.status === "pending_deletion";

  return (
    <div className="p-6 bg-bg-secondary rounded-xl">
      <h3 className="text-lg font-semibold text-text-primary mb-2">
        账户管理
      </h3>

      {/* Error Display */}
      {error && (
        <div className="mb-4 p-3 rounded-lg bg-error/10 border border-error/20">
          <p className="text-error text-sm">{error}</p>
        </div>
      )}

      {/* Pending Deletion State */}
      {isPendingDeletion && status && (
        <div className="mb-4 p-4 rounded-lg bg-warning/10 border border-warning/20">
          <div className="flex items-start gap-3">
            <WarningIcon className="w-5 h-5 text-warning flex-shrink-0 mt-0.5" />
            <div>
              <p className="text-text-primary font-medium">账户删除已申请</p>
              <p className="text-sm text-text-secondary mt-1">
                你的账户将于{" "}
                <span className="font-medium text-text-primary">
                  {status.deletion_scheduled_at
                    ? new Date(status.deletion_scheduled_at).toLocaleDateString("zh-CN")
                    : "30天后"}
                </span>{" "}
                被永久删除。
              </p>
              <p className="text-sm text-text-tertiary mt-2">
                在此之前，你可以随时取消删除申请并恢复账户。
              </p>
            </div>
          </div>
          <Button
            variant="secondary"
            className="mt-4"
            onClick={handleCancelDeletion}
            isLoading={isLoading}
          >
            取消删除申请
          </Button>
        </div>
      )}

      {/* Normal State */}
      {!isPendingDeletion && (
        <>
          <p className="text-text-secondary text-sm mb-4">
            删除账户将永久移除你的所有数据，包括个人资料、对话记录和订阅信息。
            此操作有 30 天的冷静期，期间你可以取消删除。
          </p>

          {!showConfirmation ? (
            <Button
              variant="secondary"
              className="text-error hover:text-error hover:bg-error/10"
              onClick={() => setShowConfirmation(true)}
            >
              删除账户
            </Button>
          ) : (
            <div className="p-4 rounded-lg bg-error/5 border border-error/20">
              <p className="text-text-primary font-medium mb-2">
                确定要删除账户吗？
              </p>
              <p className="text-sm text-text-secondary mb-4">
                账户将进入 30 天冷静期，之后所有数据将被永久删除。
              </p>
              <div className="flex gap-3">
                <Button
                  variant="secondary"
                  onClick={() => setShowConfirmation(false)}
                >
                  取消
                </Button>
                <Button
                  variant="primary"
                  className="bg-error hover:bg-error/90"
                  onClick={handleRequestDeletion}
                  isLoading={isLoading}
                >
                  确认删除
                </Button>
              </div>
            </div>
          )}
        </>
      )}

      {/* Info */}
      <div className="mt-6 pt-4 border-t border-border-default">
        <p className="text-xs text-text-tertiary">
          如需导出数据，请在删除账户前使用「导出数据」功能。
          如有任何问题，请联系{" "}
          <a href="mailto:support@vibelife.app" className="text-accent-primary hover:underline">
            support@vibelife.app
          </a>
        </p>
      </div>
    </div>
  );
}

function WarningIcon({ className }: { className?: string }) {
  return (
    <svg
      className={className}
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
    >
      <path d="M12 9v3m0 3h.01M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
    </svg>
  );
}
