"""
Account Deletion Worker

Background worker that processes scheduled account deletions.
Runs every hour to check for accounts past their 30-day grace period
and performs hard deletion of all user data.

GDPR Compliance:
- Respects the 30-day grace period before permanent deletion
- Removes all personally identifiable information
- Keeps anonymized payment records for accounting
- Logs deletion events for audit trail
"""
import asyncio
import logging
from datetime import datetime

from services.identity.account_deletion import AccountDeletionService

logger = logging.getLogger(__name__)


# How often to check for deletions (in seconds)
CHECK_INTERVAL = 3600  # 1 hour


async def run_deletion_worker():
    """
    Main worker loop.

    Continuously checks for accounts scheduled for deletion
    and processes them.
    """
    logger.info("Account deletion worker started")

    while True:
        try:
            # Process scheduled deletions
            deleted_count = await AccountDeletionService.process_scheduled_deletions()

            if deleted_count > 0:
                logger.info(f"Processed {deleted_count} scheduled account deletion(s)")

        except Exception as e:
            logger.error(f"Error in deletion worker: {e}", exc_info=True)

        # Wait before next check
        await asyncio.sleep(CHECK_INTERVAL)


async def run_deletion_worker_once():
    """
    Run the deletion worker once (for testing or manual trigger).

    Returns:
        Number of accounts deleted
    """
    logger.info(f"Running account deletion check at {datetime.utcnow()}")

    try:
        deleted_count = await AccountDeletionService.process_scheduled_deletions()
        logger.info(f"Deleted {deleted_count} account(s)")
        return deleted_count
    except Exception as e:
        logger.error(f"Error processing deletions: {e}", exc_info=True)
        return 0


if __name__ == "__main__":
    # Allow running as standalone script
    import sys
    sys.path.insert(0, "/home/aiscend/work/vibelife/apps/api")

    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
    )

    asyncio.run(run_deletion_worker_once())
