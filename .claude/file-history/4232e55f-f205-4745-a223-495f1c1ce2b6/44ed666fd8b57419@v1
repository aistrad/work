"""
Account Routes æµ‹è¯•
æµ‹è¯•è®¤è¯ã€ç”¨æˆ·èµ„æ–™ã€è®¿å®¢ä¼šè¯ã€èº«ä»½æ£±é•œç­‰ç«¯ç‚¹

è¦†ç›–ç«¯ç‚¹:
- /account/auth/* - è®¤è¯ç›¸å…³
- /account/profile/* - ç”¨æˆ·èµ„æ–™
- /account/guest/* - è®¿å®¢ä¼šè¯
- /account/identity/* - èº«ä»½æ£±é•œ

ä¿®å¤è¯´æ˜:
- ä½¿ç”¨ override_auth fixture è¿›è¡Œ FastAPI ä¾èµ–æ³¨å…¥è¦†ç›–
- ä½¿ç”¨ mock_auth_service é¿å…è¿æ¥çœŸå®æ•°æ®åº“
"""

import pytest
from datetime import datetime
from unittest.mock import AsyncMock, patch
from uuid import UUID

pytestmark = pytest.mark.asyncio


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Auth Endpoints Tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestRegisterEndpoint:
    """ç”¨æˆ·æ³¨å†Œç«¯ç‚¹æµ‹è¯•"""

    async def test_register_with_email_success(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•é‚®ç®±æ³¨å†ŒæˆåŠŸ"""
        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "new@example.com",
                "password": "password123",
                "display_name": "æ–°ç”¨æˆ·"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data
        assert data["token_type"] == "bearer"
        assert "user" in data
        assert data["expires_in"] == 3600

    async def test_register_with_phone_success(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•æ‰‹æœºå·æ³¨å†ŒæˆåŠŸ"""
        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "phone": "13800138000",
                "password": "password123"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data

    async def test_register_with_onboarding_data(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•å¸¦ onboarding æ•°æ®çš„æ³¨å†Œ"""
        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "new@example.com",
                "password": "password123",
                "onboarding": {
                    "birth_datetime": "1990-05-15T10:30:00",
                    "birth_location": "åŒ—äº¬",
                    "gender": "male",
                    "voice_mode": "warm",
                    "skill": "bazi",
                    "focus_areas": ["career", "relationship"]
                }
            }
        )

        assert response.status_code == 200

    async def test_register_invalid_email_format(self, client):
        """æµ‹è¯•æ— æ•ˆé‚®ç®±æ ¼å¼"""
        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "invalid-email",
                "password": "password123"
            }
        )

        assert response.status_code == 422  # Validation error

    async def test_register_password_too_short(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•å¯†ç è¿‡çŸ­ - AuthService åº”è¯¥éªŒè¯å¯†ç é•¿åº¦"""
        # Mock AuthService æŠ›å‡ºå¯†ç è¿‡çŸ­é”™è¯¯
        mock_auth_service.register.side_effect = ValueError("Password must be at least 6 characters")

        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "test@example.com",
                "password": "123"  # å¤ªçŸ­
            }
        )

        # è·¯ç”±æ•è· ValueError è¿”å› 400
        assert response.status_code == 400

    async def test_register_duplicate_email(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•é‡å¤é‚®ç®±æ³¨å†Œ"""
        mock_auth_service.register.side_effect = ValueError("Email already exists")

        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "existing@example.com",
                "password": "password123"
            }
        )

        assert response.status_code == 400
        assert "already exists" in response.json()["detail"]

    async def test_register_links_guest_session(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•æ³¨å†Œæ—¶å…³è”è®¿å®¢ä¼šè¯"""
        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "new@example.com",
                "password": "password123",
                "session_id": "guest_session_123"
            }
        )

        assert response.status_code == 200
        mock_guest_session_service.link_to_user.assert_called_once()


class TestLoginEndpoint:
    """ç”¨æˆ·ç™»å½•ç«¯ç‚¹æµ‹è¯•"""

    async def test_login_with_email_success(self, client, mock_auth_service):
        """æµ‹è¯•é‚®ç®±ç™»å½•æˆåŠŸ"""
        response = await client.post(
            "/api/v1/account/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data
        assert data["token_type"] == "bearer"

    async def test_login_with_phone_success(self, client, mock_auth_service):
        """æµ‹è¯•æ‰‹æœºå·ç™»å½•æˆåŠŸ"""
        response = await client.post(
            "/api/v1/account/auth/login",
            json={
                "phone": "13800138000",
                "password": "password123"
            }
        )

        assert response.status_code == 200

    async def test_login_invalid_credentials(self, client, mock_auth_service):
        """æµ‹è¯•æ— æ•ˆå‡­è¯ç™»å½•"""
        mock_auth_service.login.side_effect = ValueError("Invalid credentials")

        response = await client.post(
            "/api/v1/account/auth/login",
            json={
                "email": "test@example.com",
                "password": "wrong_password"
            }
        )

        assert response.status_code == 401

    async def test_login_missing_email_and_phone(self, client, mock_auth_service):
        """æµ‹è¯•ç¼ºå°‘ email å’Œ phone - AuthService éªŒè¯"""
        # å½“ email å’Œ phone éƒ½ä¸ºç©ºæ—¶ï¼ŒAuthService åº”è¯¥æŠ›å‡ºé”™è¯¯
        mock_auth_service.login.side_effect = ValueError("Email or phone is required")

        response = await client.post(
            "/api/v1/account/auth/login",
            json={
                "password": "password123"
                # ç¼ºå°‘ email å’Œ phone
            }
        )

        # è·¯ç”±æ•è· ValueError è¿”å› 401
        assert response.status_code == 401


class TestRefreshTokenEndpoint:
    """Token åˆ·æ–°ç«¯ç‚¹æµ‹è¯•"""

    async def test_refresh_token_success(self, client, mock_auth_service):
        """æµ‹è¯•åˆ·æ–° token æˆåŠŸ"""
        response = await client.post(
            "/api/v1/account/auth/refresh",
            json={"refresh_token": "valid_refresh_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data
        assert "refresh_token" in data

    async def test_refresh_token_invalid(self, client, mock_auth_service):
        """æµ‹è¯•æ— æ•ˆ refresh token"""
        mock_auth_service.refresh_token.side_effect = ValueError("Invalid refresh token")

        response = await client.post(
            "/api/v1/account/auth/refresh",
            json={"refresh_token": "invalid_token"}
        )

        assert response.status_code == 401


class TestLogoutEndpoint:
    """ç™»å‡ºç«¯ç‚¹æµ‹è¯•"""

    async def test_logout_success(self, client, override_auth):
        """æµ‹è¯•ç™»å‡ºæˆåŠŸ - ä½¿ç”¨ override_auth fixture"""
        response = await client.post(
            "/api/v1/account/auth/logout",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        assert response.json()["message"] == "Logged out successfully"

    async def test_logout_unauthenticated(self, client):
        """æµ‹è¯•æœªè®¤è¯ç”¨æˆ·ç™»å‡º"""
        response = await client.post("/api/v1/account/auth/logout")

        # åº”è¯¥è¿”å› 401 æˆ– 403
        assert response.status_code in [401, 403, 422]


class TestGetMeEndpoint:
    """è·å–å½“å‰ç”¨æˆ·ç«¯ç‚¹æµ‹è¯•"""

    async def test_get_me_authenticated(self, client, override_auth):
        """æµ‹è¯•å·²è®¤è¯ç”¨æˆ·è·å–ä¿¡æ¯ - ä½¿ç”¨ override_auth fixture"""
        response = await client.get(
            "/api/v1/account/auth/me",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["vibe_id"] == "VB20260105001"
        assert data["display_name"] == "æµ‹è¯•ç”¨æˆ·"

    async def test_get_me_unauthenticated(self, client):
        """æµ‹è¯•æœªè®¤è¯ç”¨æˆ·è·å–ä¿¡æ¯"""
        response = await client.get("/api/v1/account/auth/me")

        # åº”è¯¥è¿”å› 401 æˆ– 403
        assert response.status_code in [401, 403, 422]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# OAuth Endpoints Tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestGoogleOAuthEndpoint:
    """Google OAuth ç«¯ç‚¹æµ‹è¯•"""

    async def test_google_auth_success(self, client, mock_oauth_service):
        """æµ‹è¯• Google OAuth ç™»å½•æˆåŠŸ"""
        response = await client.post(
            "/api/v1/account/auth/oauth/google",
            json={"id_token": "valid_google_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data

    async def test_google_auth_with_onboarding(self, client, mock_oauth_service):
        """æµ‹è¯• Google OAuth å¸¦ onboarding æ•°æ®"""
        response = await client.post(
            "/api/v1/account/auth/oauth/google",
            json={
                "id_token": "valid_google_token",
                "onboarding": {
                    "birth_datetime": "1990-05-15T10:30:00",
                    "birth_location": "ä¸Šæµ·",
                    "skill": "zodiac"
                }
            }
        )

        assert response.status_code == 200

    async def test_google_auth_invalid_token(self, client, mock_oauth_service):
        """æµ‹è¯•æ— æ•ˆ Google token"""
        mock_oauth_service.google_login.return_value = None

        response = await client.post(
            "/api/v1/account/auth/oauth/google",
            json={"id_token": "invalid_token"}
        )

        assert response.status_code == 401


class TestAppleOAuthEndpoint:
    """Apple OAuth ç«¯ç‚¹æµ‹è¯•"""

    async def test_apple_auth_success(self, client, mock_oauth_service):
        """æµ‹è¯• Apple OAuth ç™»å½•æˆåŠŸ"""
        response = await client.post(
            "/api/v1/account/auth/oauth/apple",
            json={"id_token": "valid_apple_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "access_token" in data

    async def test_apple_auth_with_user_name(self, client, mock_oauth_service):
        """æµ‹è¯• Apple OAuth å¸¦ç”¨æˆ·åï¼ˆé¦–æ¬¡ç™»å½•ï¼‰"""
        response = await client.post(
            "/api/v1/account/auth/oauth/apple",
            json={
                "id_token": "valid_apple_token",
                "user_name": "Apple User"
            }
        )

        assert response.status_code == 200

    async def test_apple_auth_invalid_token(self, client, mock_oauth_service):
        """æµ‹è¯•æ— æ•ˆ Apple token"""
        mock_oauth_service.apple_login.return_value = None

        response = await client.post(
            "/api/v1/account/auth/oauth/apple",
            json={"id_token": "invalid_token"}
        )

        assert response.status_code == 401


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Password Reset Endpoints Tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestPasswordResetEndpoints:
    """å¯†ç é‡ç½®ç«¯ç‚¹æµ‹è¯•"""

    async def test_request_password_reset_email(self, client):
        """æµ‹è¯•è¯·æ±‚å¯†ç é‡ç½®ï¼ˆé‚®ç®±ï¼‰"""
        with patch("routes.account.PasswordResetService") as mock_service:
            mock_service.request_reset = AsyncMock(return_value={"reset_url": "http://example.com/reset/token123"})

            response = await client.post(
                "/api/v1/account/auth/password/reset-request",
                json={"email": "test@example.com"}
            )

        assert response.status_code == 200
        assert "message" in response.json()

    async def test_request_password_reset_phone(self, client):
        """æµ‹è¯•è¯·æ±‚å¯†ç é‡ç½®ï¼ˆæ‰‹æœºï¼‰"""
        with patch("routes.account.PasswordResetService") as mock_service:
            mock_service.request_reset = AsyncMock(return_value={"reset_url": "http://example.com/reset/token123"})

            response = await client.post(
                "/api/v1/account/auth/password/reset-request",
                json={"phone": "13800138000"}
            )

        assert response.status_code == 200

    async def test_request_password_reset_missing_contact(self, client):
        """æµ‹è¯•è¯·æ±‚å¯†ç é‡ç½®ç¼ºå°‘è”ç³»æ–¹å¼"""
        response = await client.post(
            "/api/v1/account/auth/password/reset-request",
            json={}
        )

        assert response.status_code == 400

    async def test_reset_password_success(self, client):
        """æµ‹è¯•é‡ç½®å¯†ç æˆåŠŸ"""
        with patch("routes.account.PasswordResetService") as mock_service:
            mock_service.reset_password = AsyncMock(return_value=True)

            response = await client.post(
                "/api/v1/account/auth/password/reset",
                json={
                    "token": "valid_reset_token",
                    "new_password": "new_password123"
                }
            )

        assert response.status_code == 200
        assert response.json()["message"] == "Password reset successfully"

    async def test_reset_password_invalid_token(self, client):
        """æµ‹è¯•é‡ç½®å¯†ç æ— æ•ˆ token"""
        with patch("routes.account.PasswordResetService") as mock_service:
            mock_service.reset_password = AsyncMock(return_value=False)

            response = await client.post(
                "/api/v1/account/auth/password/reset",
                json={
                    "token": "invalid_token",
                    "new_password": "new_password123"
                }
            )

        assert response.status_code == 400

    async def test_reset_password_too_short(self, client):
        """æµ‹è¯•é‡ç½®å¯†ç è¿‡çŸ­"""
        response = await client.post(
            "/api/v1/account/auth/password/reset",
            json={
                "token": "valid_token",
                "new_password": "123"  # å°‘äº 6 å­—ç¬¦
            }
        )

        assert response.status_code == 400


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Profile Endpoints Tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestProfileEndpoints:
    """ç”¨æˆ·èµ„æ–™ç«¯ç‚¹æµ‹è¯•"""

    async def test_get_profile_success(self, client, override_auth, mock_user_repository):
        """æµ‹è¯•è·å–ç”¨æˆ·èµ„æ–™æˆåŠŸ - ä½¿ç”¨ override_auth fixture"""
        response = await client.get(
            "/api/v1/account/profile",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["vibe_id"] == "VB20260105001"
        assert data["display_name"] == "æµ‹è¯•ç”¨æˆ·"
        assert "timezone" in data
        assert "language" in data

    async def test_get_profile_not_found(self, client, override_auth):
        """æµ‹è¯•ç”¨æˆ·èµ„æ–™ä¸å­˜åœ¨"""
        with patch("routes.account.UserRepository") as mock_repo:
            mock_repo.get_by_id = AsyncMock(return_value=None)

            response = await client.get(
                "/api/v1/account/profile",
                headers={"Authorization": "Bearer test_token"}
            )

        assert response.status_code == 404

    async def test_get_profile_unauthenticated(self, client):
        """æµ‹è¯•æœªè®¤è¯ç”¨æˆ·è·å–èµ„æ–™"""
        response = await client.get("/api/v1/account/profile")

        assert response.status_code in [401, 403, 422]

    async def test_update_profile_success(self, client, override_auth, sample_user):
        """æµ‹è¯•æ›´æ–°ç”¨æˆ·èµ„æ–™æˆåŠŸ"""
        updated_user = {**sample_user, "display_name": "æ–°åå­—"}

        with patch("routes.account.UserRepository") as mock_repo:
            mock_repo.update = AsyncMock(return_value=updated_user)

            response = await client.put(
                "/api/v1/account/profile",
                headers={"Authorization": "Bearer test_token"},
                json={"display_name": "æ–°åå­—"}
            )

        assert response.status_code == 200
        assert response.json()["display_name"] == "æ–°åå­—"

    async def test_update_profile_partial(self, client, override_auth, sample_user):
        """æµ‹è¯•éƒ¨åˆ†æ›´æ–°ç”¨æˆ·èµ„æ–™"""
        with patch("routes.account.UserRepository") as mock_repo:
            mock_repo.update = AsyncMock(return_value=sample_user)

            response = await client.put(
                "/api/v1/account/profile",
                headers={"Authorization": "Bearer test_token"},
                json={"timezone": "America/New_York"}
            )

        assert response.status_code == 200

    async def test_export_data_success(
        self, client, override_auth, mock_user_repository,
        mock_skill_repository, mock_subscription_repository
    ):
        """æµ‹è¯•å¯¼å‡ºç”¨æˆ·æ•°æ®ï¼ˆGDPRï¼‰"""
        response = await client.get(
            "/api/v1/account/profile/export",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "user" in data
        assert "skill_profiles" in data
        assert "consents" in data
        assert "export_date" in data


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Guest Session Endpoints Tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestGuestSessionEndpoints:
    """è®¿å®¢ä¼šè¯ç«¯ç‚¹æµ‹è¯•"""

    async def test_create_guest_session(self, client, mock_guest_session_service):
        """æµ‹è¯•åˆ›å»ºè®¿å®¢ä¼šè¯"""
        response = await client.post("/api/v1/account/guest/session")

        assert response.status_code == 200
        data = response.json()
        assert "session_id" in data
        assert "expires_at" in data
        # æ£€æŸ¥ cookie è®¾ç½®
        assert "guest_session_id" in response.cookies

    async def test_get_guest_session_success(self, client, mock_guest_session_service):
        """æµ‹è¯•è·å–è®¿å®¢ä¼šè¯æˆåŠŸ"""
        response = await client.get(
            "/api/v1/account/guest/session",
            cookies={"guest_session_id": "guest_session_123"}
        )

        assert response.status_code == 200
        data = response.json()
        assert data["session_id"] == "guest_session_123"

    async def test_get_guest_session_no_cookie(self, client):
        """æµ‹è¯•è·å–è®¿å®¢ä¼šè¯æ—  cookie"""
        response = await client.get("/api/v1/account/guest/session")

        assert response.status_code == 404

    async def test_get_guest_session_expired(self, client, mock_guest_session_service):
        """æµ‹è¯•è·å–è¿‡æœŸçš„è®¿å®¢ä¼šè¯"""
        mock_guest_session_service.get_session.return_value = None

        response = await client.get(
            "/api/v1/account/guest/session",
            cookies={"guest_session_id": "expired_session"}
        )

        assert response.status_code == 404

    async def test_save_guest_onboarding(self, client, mock_guest_session_service):
        """æµ‹è¯•ä¿å­˜è®¿å®¢ onboarding æ•°æ®"""
        response = await client.put(
            "/api/v1/account/guest/session/onboarding",
            cookies={"guest_session_id": "guest_session_123"},
            json={
                "birth_datetime": "1990-05-15T10:30:00",
                "birth_location": "åŒ—äº¬",
                "gender": "male",
                "voice_mode": "warm",
                "skill": "bazi"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["birth_location"] == "åŒ—äº¬"

    async def test_save_guest_onboarding_no_session(self, client):
        """æµ‹è¯•ä¿å­˜ onboarding æ— ä¼šè¯"""
        response = await client.put(
            "/api/v1/account/guest/session/onboarding",
            json={"birth_location": "åŒ—äº¬"}
        )

        assert response.status_code == 404

    async def test_delete_guest_session(self, client):
        """æµ‹è¯•åˆ é™¤è®¿å®¢ä¼šè¯"""
        response = await client.delete(
            "/api/v1/account/guest/session",
            cookies={"guest_session_id": "guest_session_123"}
        )

        assert response.status_code == 200
        assert response.json()["message"] == "Guest session cleared"


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Identity Prism Endpoints Tests
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestIdentityPrismEndpoints:
    """èº«ä»½æ£±é•œç«¯ç‚¹æµ‹è¯•"""

    async def test_get_prism_authenticated(self, client, override_auth, mock_skill_repository):
        """æµ‹è¯•å·²è®¤è¯ç”¨æˆ·è·å–èº«ä»½æ£±é•œ - ä½¿ç”¨ override_auth fixture"""
        response = await client.get(
            "/api/v1/account/identity/prism",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()
        assert "core" in data
        assert "inner" in data
        assert "outer" in data
        assert "progress" in data
        assert "dimensions" in data
        assert "memories" in data

    async def test_get_prism_guest(self, client, override_auth_optional_none):
        """æµ‹è¯•è®¿å®¢è·å–é»˜è®¤èº«ä»½æ£±é•œ - ä½¿ç”¨ override_auth_optional_none fixture"""
        response = await client.get("/api/v1/account/identity/prism")

        assert response.status_code == 200
        data = response.json()
        # åº”è¿”å›é»˜è®¤æ£±é•œ
        assert data["progress"] == 35

    async def test_get_prism_with_user_id_param(self, client, override_auth, mock_skill_repository):
        """æµ‹è¯•é€šè¿‡ user_id å‚æ•°è·å–èº«ä»½æ£±é•œ"""
        response = await client.get(
            "/api/v1/account/identity/prism",
            params={"user_id": "550e8400-e29b-41d4-a716-446655440000"}
        )

        assert response.status_code == 200

    async def test_get_prism_dimensions_calculated(self, client, override_auth, mock_skill_repository):
        """æµ‹è¯•èº«ä»½æ£±é•œç»´åº¦è®¡ç®—"""
        response = await client.get(
            "/api/v1/account/identity/prism",
            headers={"Authorization": "Bearer test_token"}
        )

        assert response.status_code == 200
        data = response.json()

        # éªŒè¯ç»´åº¦ç»“æ„
        assert len(data["dimensions"]) == 4
        dimension_names = [d["name"] for d in data["dimensions"]]
        assert "å…«å­—å‘½ç†" in dimension_names
        assert "æ˜Ÿåº§èƒ½é‡" in dimension_names


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Edge Cases & Error Handling
# â•ï¿½ï¿½ï¿½â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

class TestAccountEdgeCases:
    """è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯å¤„ç†æµ‹è¯•"""

    async def test_register_empty_body(self, client):
        """æµ‹è¯•ç©ºè¯·æ±‚ä½“æ³¨å†Œ"""
        response = await client.post(
            "/api/v1/account/auth/register",
            json={}
        )

        assert response.status_code == 422

    async def test_login_empty_body(self, client):
        """æµ‹è¯•ç©ºè¯·æ±‚ä½“ç™»å½•"""
        response = await client.post(
            "/api/v1/account/auth/login",
            json={}
        )

        assert response.status_code == 422

    async def test_invalid_json_body(self, client):
        """æµ‹è¯•æ— æ•ˆ JSON è¯·æ±‚ä½“"""
        response = await client.post(
            "/api/v1/account/auth/login",
            content="invalid json",
            headers={"Content-Type": "application/json"}
        )

        assert response.status_code == 422

    async def test_service_error_handling(self, client, mock_auth_service):
        """æµ‹è¯•æœåŠ¡å±‚é”™è¯¯å¤„ç† - é ValueError å¼‚å¸¸"""
        # è·¯ç”±åªæ•è· ValueErrorï¼Œå…¶ä»–å¼‚å¸¸ä¼šå¯¼è‡´ 500
        # ä½†ç”±äº mock çš„ side_effect æ˜¯ Exceptionï¼Œå®é™…ä¼šè¢« FastAPI æ•è·
        mock_auth_service.login.side_effect = ValueError("Database connection failed")

        response = await client.post(
            "/api/v1/account/auth/login",
            json={
                "email": "test@example.com",
                "password": "password123"
            }
        )

        # ValueError è¢«æ•è·è¿”å› 401
        assert response.status_code == 401

    async def test_concurrent_login_requests(self, client, mock_auth_service):
        """æµ‹è¯•å¹¶å‘ç™»å½•è¯·æ±‚"""
        import asyncio

        async def login():
            return await client.post(
                "/api/v1/account/auth/login",
                json={
                    "email": "test@example.com",
                    "password": "password123"
                }
            )

        # å¹¶å‘å‘é€ 5 ä¸ªè¯·æ±‚
        responses = await asyncio.gather(*[login() for _ in range(5)])

        # æ‰€æœ‰è¯·æ±‚éƒ½åº”è¯¥æˆåŠŸ
        for response in responses:
            assert response.status_code == 200

    async def test_unicode_in_display_name(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•æ˜¾ç¤ºåç§°ä¸­çš„ Unicode å­—ç¬¦"""
        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "unicode@example.com",
                "password": "password123",
                "display_name": "ç”¨æˆ·ğŸ‰æµ‹è¯•"
            }
        )

        assert response.status_code == 200

    async def test_very_long_password(self, client, mock_auth_service, mock_guest_session_service):
        """æµ‹è¯•è¶…é•¿å¯†ç """
        long_password = "a" * 1000

        response = await client.post(
            "/api/v1/account/auth/register",
            json={
                "email": "longpass@example.com",
                "password": long_password
            }
        )

        # åº”è¯¥æˆåŠŸæˆ–è¿”å›éªŒè¯é”™è¯¯
        assert response.status_code in [200, 400, 422]
