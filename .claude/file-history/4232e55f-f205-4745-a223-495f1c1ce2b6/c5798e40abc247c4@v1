'use client'

/**
 * Settings Page - v5.1 æ€§èƒ½ä¼˜åŒ–ç‰ˆ
 * è®¾è®¡æ–‡æ¡£: payment-design-pc.md ç¬¬åç« 
 *
 * v5.1 ä¼˜åŒ–:
 * - ç§»é™¤ framer-motionï¼Œä½¿ç”¨ CSS åŠ¨ç”» (Vercel rule: bundle-dynamic-imports)
 * - ä½¿ç”¨ç¼“å­˜çš„ localStorage è¯»å– (Vercel rule: js-cache-storage)
 * - ä½¿ç”¨å‡½æ•°å¼ setState (Vercel rule: rerender-functional-setstate)
 *
 * PCç«¯å¸ƒå±€: å·¦ä¾§è®¾ç½®èœå• + å³ä¾§è®¾ç½®å†…å®¹
 * ç§»åŠ¨ç«¯å¸ƒå±€: å•æ è®¾ç½®åˆ—è¡¨
 */

import { useState, useEffect, useCallback, memo } from 'react'
import { useRouter } from 'next/navigation'
import { PCLayout } from '@/components/layout/PCLayout'
import { getLocalStorageJSON, getAccessToken, setLocalStorageJSON } from '@/utils/storage'

const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1'

const SETTINGS_MENU = [
  { id: 'profile', icon: 'ğŸ‘¤', label: 'ä¸ªäººèµ„æ–™' },
  { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥è®¾ç½®' },
  { id: 'privacy', icon: 'ğŸ”', label: 'éšç§ä¸å®‰å…¨' },
  { id: 'membership', icon: 'ğŸ’', label: 'ä¼šå‘˜ç®¡ç†' },
  { id: 'memory', icon: 'ğŸ§ ', label: 'è®°å¿†ç®¡ç†' },
  { id: 'preferences', icon: 'âš™ï¸', label: 'åå¥½è®¾ç½®' },
  { id: 'help', icon: 'â“', label: 'å¸®åŠ©ä¸åé¦ˆ' },
  { id: 'about', icon: 'ğŸ“„', label: 'å…³äº' },
]

interface UserProfile {
  nickname: string
  email: string
  avatar: string
  birthDate: string
  birthTime: string
  timezone: string
}

export default function SettingsPage() {
  const router = useRouter()
  const [activeSection, setActiveSection] = useState('profile')
  const [loading, setLoading] = useState(false)
  const [profile, setProfile] = useState<UserProfile>(() => ({
    nickname: 'ç”¨æˆ·',
    email: 'user@example.com',
    avatar: 'ğŸ‘¤',
    birthDate: '1990-05-15',
    birthTime: '10:30',
    timezone: 'Asia/Shanghai',
  }))

  useEffect(() => {
    // Use cached localStorage read (Vercel rule: js-cache-storage)
    const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
    if (user) {
      setProfile(prev => ({
        ...prev,
        nickname: user.nickname || user.display_name || 'ç”¨æˆ·',
        email: user.email || '',
        avatar: user.avatar || 'ğŸ‘¤',
        birthDate: user.birth_date || '',
        birthTime: user.birth_time || '',
        timezone: user.timezone || 'Asia/Shanghai',
      }))
    }
  }, [])

  // Use useCallback for stable reference (Vercel rule: rerender-functional-setstate)
  const handleProfileChange = useCallback((field: keyof UserProfile, value: string) => {
    setProfile(prev => ({ ...prev, [field]: value }))
  }, [])

  const handleSaveProfile = useCallback(async () => {
    setLoading(true)
    try {
      const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
      const token = getAccessToken()

      if (user?.user_id && token) {
        const res = await fetch(`${API_BASE}/users/me/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({
            display_name: profile.nickname,
            birth_datetime: profile.birthDate && profile.birthTime
              ? `${profile.birthDate}T${profile.birthTime}:00`
              : undefined,
            timezone: profile.timezone,
          }),
        })

        if (res.ok) {
          setLocalStorageJSON('user', { ...user, ...profile })
        }
      }
    } catch (err) {
      console.error('Failed to save profile:', err)
    } finally {
      setLoading(false)
    }
  }, [profile])

  // è®¾ç½®å†…å®¹åŒºåŸŸ
  const SettingsContent = () => {
    switch (activeSection) {
      case 'profile':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">ä¸ªäººèµ„æ–™</h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-text-secondary mb-2">å¤´åƒ</label>
                <div className="flex items-center gap-4">
                  <div className="w-16 h-16 rounded-full bg-[var(--bg-secondary)] flex items-center justify-center text-3xl">
                    {profile.avatar}
                  </div>
                  <button className="btn btn-secondary">æ›´æ¢å¤´åƒ</button>
                </div>
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">æ˜µç§°</label>
                <input
                  type="text"
                  value={profile.nickname}
                  onChange={(e) => handleProfileChange('nickname', e.target.value)}
                  className="input"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">é‚®ç®±</label>
                <input
                  type="email"
                  value={profile.email}
                  disabled
                  className="input bg-[var(--bg-secondary)]"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¥æœŸ</label>
                <input
                  type="date"
                  value={profile.birthDate}
                  onChange={(e) => handleProfileChange('birthDate', e.target.value)}
                  className="input"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¶é—´</label>
                <input
                  type="time"
                  value={profile.birthTime}
                  onChange={(e) => handleProfileChange('birthTime', e.target.value)}
                  className="input"
                />
              </div>
              <div>
                <label className="block text-sm text-text-secondary mb-2">æ—¶åŒº</label>
                <select
                  value={profile.timezone}
                  onChange={(e) => handleProfileChange('timezone', e.target.value)}
                  className="input"
                >
                  <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
                  <option value="Asia/Hong_Kong">Asia/Hong_Kong (UTC+8)</option>
                  <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
                  <option value="America/New_York">America/New_York (UTC-5)</option>
                  <option value="America/Los_Angeles">America/Los_Angeles (UTC-8)</option>
                  <option value="Europe/London">Europe/London (UTC+0)</option>
                </select>
              </div>
              <button onClick={handleSaveProfile} disabled={loading} className="btn btn-primary">
                {loading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜æ›´æ”¹'}
              </button>
            </div>
          </div>
        )
      case 'notifications':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">é€šçŸ¥è®¾ç½®</h2>
            <div className="space-y-4">
              {[
                { id: 'daily', label: 'æ¯æ—¥è¿åŠ¿æé†’', desc: 'æ¯å¤©æ—©ä¸Šæ¨é€ä»Šæ—¥è¿åŠ¿' },
                { id: 'astro', label: 'æ˜Ÿè±¡äº‹ä»¶æé†’', desc: 'é‡è¦æ˜Ÿè±¡äº‹ä»¶ï¼ˆæ°´é€†ã€æ»¡æœˆç­‰ï¼‰' },
                { id: 'memory', label: 'è®°å¿†æ›´æ–°æé†’', desc: 'å½“ VibeLife æœ‰æ–°çš„æ´å¯Ÿæ—¶' },
                { id: 'promo', label: 'ä¼˜æƒ æ´»åŠ¨é€šçŸ¥', desc: 'ä¼šå‘˜ä¼˜æƒ å’Œæ´»åŠ¨ä¿¡æ¯' },
              ].map((item) => (
                <div key={item.id} className="flex items-center justify-between p-4 bg-[var(--bg-card-alt)] rounded-lg">
                  <div>
                    <p className="text-text-primary font-medium">{item.label}</p>
                    <p className="text-sm text-text-secondary">{item.desc}</p>
                  </div>
                  <label className="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" defaultChecked className="sr-only peer" />
                    <div className="w-11 h-6 bg-[var(--bg-secondary)] peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
                  </label>
                </div>
              ))}
            </div>
          </div>
        )
      case 'membership':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">ä¼šå‘˜ç®¡ç†</h2>
            <div className="card p-6">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <p className="text-text-primary font-medium">å½“å‰çŠ¶æ€</p>
                  <p className="text-sm text-text-secondary">å…è´¹ç”¨æˆ·</p>
                </div>
                <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded-full text-sm text-text-secondary">Free</span>
              </div>
              <button onClick={() => router.push('/membership')} className="btn btn-premium w-full">
                âœ¨ å‡çº§ Premium
              </button>
            </div>
            <div className="space-y-3">
              <p className="text-sm text-text-secondary">Premium ä¼šå‘˜æƒç›Šï¼š</p>
              <ul className="space-y-2 text-sm text-text-secondary">
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´æ¯æ—¥è¿åŠ¿</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> 30æ¬¡/å¤© AIå¯¹è¯</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´å¤§è¿/æµå¹´åˆ†æ</li>
                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> Identity Prism æ·±åº¦è§£è¯»</li>
              </ul>
            </div>
          </div>
        )
      case 'memory':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">è®°å¿†ç®¡ç†</h2>
            <p className="text-sm text-text-secondary">VibeLife ä¼šè®°ä½ä½ åˆ†äº«çš„ä¿¡æ¯ï¼Œä»¥æä¾›æ›´ä¸ªæ€§åŒ–çš„ä½“éªŒã€‚</p>
            <div className="space-y-3">
              {[
                { content: 'ä½ æœ€è¿‘å·¥ä½œå‹åŠ›è¾ƒå¤§', date: '2å¤©å‰' },
                { content: 'å…³æ³¨èŒä¸šå‘å±•æ–¹å‘', date: '1å‘¨å‰' },
                { content: 'å¯¹æ„Ÿæƒ…é—®é¢˜æœ‰å›°æ‰°', date: '2å‘¨å‰' },
              ].map((memory, i) => (
                <div key={i} className="flex items-center justify-between p-4 bg-[var(--bg-callout)] rounded-lg">
                  <div>
                    <p className="text-text-primary">{memory.content}</p>
                    <p className="text-xs text-text-secondary mt-1">{memory.date}</p>
                  </div>
                  <button className="text-sm text-error">åˆ é™¤</button>
                </div>
              ))}
            </div>
            <button className="text-sm text-error">æ¸…é™¤æ‰€æœ‰è®°å¿†</button>
          </div>
        )
      case 'about':
        return (
          <div className="space-y-6">
            <h2 className="font-serif text-xl text-text-primary">å…³äº VibeLife</h2>
            <div className="text-center py-8">
              <span className="text-5xl mb-4 block">ğŸŒŸ</span>
              <h3 className="font-serif text-2xl text-text-primary mb-2">VibeLife</h3>
              <p className="text-text-secondary mb-4">æ¢ç´¢å†…å¿ƒä¸–ç•Œ</p>
              <p className="text-sm text-text-secondary">ç‰ˆæœ¬ 5.0.0</p>
            </div>
            <div className="space-y-2 text-sm text-text-secondary">
              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">ç”¨æˆ·åè®®</button>
              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">éšç§æ”¿ç­–</button>
              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">è”ç³»æˆ‘ä»¬</button>
            </div>
          </div>
        )
      default:
        return (
          <div className="text-center py-8 text-text-secondary">
            <p>è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
          </div>
        )
    }
  }

  // PCç«¯å³ä¾§è¾¹æ  - è®¾ç½®èœå•
  const AsideContent = () => (
    <div className="space-y-2">
      {SETTINGS_MENU.map((item) => (
        <button
          key={item.id}
          onClick={() => setActiveSection(item.id)}
          className={`w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors ${
            activeSection === item.id
              ? 'bg-accent/10 text-accent'
              : 'text-text-secondary hover:bg-[var(--bg-secondary)]'
          }`}
        >
          <span className="text-lg">{item.icon}</span>
          <span className="text-sm">{item.label}</span>
        </button>
      ))}
      <div className="pt-4 mt-4 border-t border-[var(--border-light)]">
        <button className="w-full flex items-center gap-3 p-3 rounded-lg text-left text-error hover:bg-error/5 transition-colors">
          <span className="text-lg">ğŸšª</span>
          <span className="text-sm">é€€å‡ºç™»å½•</span>
        </button>
      </div>
    </div>
  )

  // PCç«¯ä¸»å†…å®¹
  const PCContent = () => (
    <div className="card p-6">
      <SettingsContent />
    </div>
  )

  // ç§»åŠ¨ç«¯å†…å®¹
  const MobileContent = () => (
    <div className="min-h-screen bg-bg-primary lg:hidden">
      <nav className="nav">
        <div className="nav-container">
          <button onClick={() => router.back()} className="text-text-secondary">â† è¿”å›</button>
          <h1 className="font-serif text-card-title text-text-primary">è®¾ç½®</h1>
          <div className="w-8" />
        </div>
      </nav>

      <main className="max-w-lg mx-auto px-4 py-6">
        <div className="space-y-2">
          {SETTINGS_MENU.map((item, index) => (
            <button
              key={item.id}
              onClick={() => {
                if (item.id === 'membership') {
                  router.push('/membership')
                } else {
                  setActiveSection(item.id)
                }
              }}
              className="w-full card p-4 flex items-center gap-3 animate-slide-in-up stagger-item"
              style={{ animationDelay: `${index * 50}ms` }}
            >
              <span className="text-xl">{item.icon}</span>
              <span className="text-text-primary">{item.label}</span>
              <span className="ml-auto text-text-secondary">â€º</span>
            </button>
          ))}
        </div>

        <div className="mt-8">
          <button className="w-full p-4 text-center text-error">é€€å‡ºç™»å½•</button>
        </div>

        <div className="mt-8 text-center text-sm text-text-secondary">
          <p>VibeLife v5.0.0</p>
        </div>
      </main>
    </div>
  )

  return (
    <>
      {/* PCç«¯: ä½¿ç”¨ PCLayout ä¸‰æ å¸ƒå±€ */}
      <div className="hidden lg:block">
        <PCLayout
          breadcrumb={[
            { label: 'é¦–é¡µ', href: '/' },
            { label: 'è®¾ç½®' }
          ]}
          aside={<AsideContent />}
          showCommandBar={false}
        >
          <PCContent />
        </PCLayout>
      </div>

      {/* ç§»åŠ¨ç«¯: ç®€å•å•æ å¸ƒå±€ */}
      <MobileContent />
    </>
  )
}
