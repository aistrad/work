/**
 * VibeLife API Client
 * All API calls go through Next.js API routes to avoid exposing backend URLs
 */

const API_BASE = "/api";

// ─────────────────────────────────────────────────────────────────
// Types
// ─────────────────────────────────────────────────────────────────

export interface TokenResponse {
  access_token: string;
  refresh_token: string;
  token_type: string;
  expires_in: number;
  user: {
    user_id: string;
    vibe_id: string;
    display_name?: string;
  };
}

export interface ChatRequest {
  message: string;
  skill: string;           // Changed from skill_id to match backend
  conversation_id?: string;
  voice_mode?: string;     // Added voice mode support
}

export interface ChatResponse {
  content: string;
  conversation_id: string;
  intent?: string;
  tools_used?: string[];
  knowledge_used: boolean;
  insight?: {
    id: string;
    insight_type: string;
    title: string;
    content: string;
  };
  suggestions?: string[];
}

// ─────────────────────────────────────────────────────────────────
// Token Management
// ─────────────────────────────────────────────────────────────────

let accessToken: string | null = null;
let refreshToken: string | null = null;

export function setTokens(access: string, refresh: string) {
  accessToken = access;
  refreshToken = refresh;
  if (typeof window !== "undefined") {
    localStorage.setItem("access_token", access);
    localStorage.setItem("refresh_token", refresh);
  }
}

export function getTokens() {
  if (typeof window !== "undefined") {
    accessToken = localStorage.getItem("access_token");
    refreshToken = localStorage.getItem("refresh_token");
  }
  return { accessToken, refreshToken };
}

export function clearTokens() {
  accessToken = null;
  refreshToken = null;
  if (typeof window !== "undefined") {
    localStorage.removeItem("access_token");
    localStorage.removeItem("refresh_token");
    localStorage.removeItem("user");
  }
}

// ─────────────────────────────────────────────────────────────────
// API Helpers
// ─────────────────────────────────────────────────────────────────

async function fetchAPI(
  endpoint: string,
  options: RequestInit = {}
): Promise<Response> {
  const { accessToken } = getTokens();

  const headers: Record<string, string> = {
    "Content-Type": "application/json",
    ...options.headers as Record<string, string>,
  };

  if (accessToken) {
    headers["Authorization"] = `Bearer ${accessToken}`;
  }

  const response = await fetch(`${API_BASE}${endpoint}`, {
    ...options,
    headers,
  });

  // Handle 401 - try to refresh token
  if (response.status === 401) {
    const { refreshToken } = getTokens();
    if (refreshToken) {
      const refreshed = await refreshAccessToken();
      if (refreshed) {
        // IMPORTANT: Get fresh token after refresh
        const { accessToken: newAccessToken } = getTokens();
        const newHeaders = {
          ...headers,
          "Authorization": `Bearer ${newAccessToken}`,
        };
        return fetch(`${API_BASE}${endpoint}`, { ...options, headers: newHeaders });
      }
    }
  }

  return response;
}

async function refreshAccessToken(): Promise<boolean> {
  try {
    const { refreshToken: currentRefreshToken } = getTokens();
    if (!currentRefreshToken) {
      return false;
    }

    const response = await fetch("/api/auth/refresh", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ refresh_token: currentRefreshToken }),
    });

    if (response.ok) {
      const data: TokenResponse = await response.json();
      setTokens(data.access_token, data.refresh_token);
      return true;
    }
  } catch (error) {
    console.error("Token refresh failed:", error);
  }

  clearTokens();
  return false;
}

// ─────────────────────────────────────────────────────────────────
// Auth API
// ─────────────────────────────────────────────────────────────────

export async function register(
  email?: string,
  password?: string,
  displayName?: string,
  phone?: string
): Promise<TokenResponse> {
  const response = await fetch("/api/auth/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: email || undefined,
      phone: phone || undefined,
      password,
      display_name: displayName
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Registration failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}

export async function login(
  email: string,
  password: string
): Promise<TokenResponse> {
  const response = await fetch("/api/auth/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Login failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}

export async function logout(): Promise<void> {
  try {
    await fetchAPI("/auth/logout", { method: "POST" });
  } finally {
    clearTokens();
  }
}

export async function getMe() {
  const response = await fetchAPI("/auth/me");
  if (!response.ok) throw new Error("Failed to get user");
  return response.json();
}

// ─────────────────────────────────────────────────────────────────
// Chat API
// ─────────────────────────────────────────────────────────────────

export async function sendMessage(request: ChatRequest): Promise<ChatResponse> {
  const response = await fetchAPI("/chat/", {
    method: "POST",
    body: JSON.stringify(request),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Chat failed");
  }

  return response.json();
}

export async function sendGuestMessage(
  message: string,
  skill: string
): Promise<{ content: string; is_guest: boolean; suggestion: string }> {
  const response = await fetch("/api/proxy?endpoint=/api/v1/chat/guest", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ message, skill }),
  });

  if (!response.ok) {
    throw new Error("Chat failed");
  }

  return response.json();
}

export interface StreamChatResult {
  conversation_id?: string;
  skill?: string;
  voice_mode?: string;
}

export async function streamChat(
  request: ChatRequest,
  onChunk: (chunk: string) => void,
  onDone: (result: StreamChatResult) => void,
  onError: (error: Error) => void
): Promise<void> {
  const { accessToken } = getTokens();

  try {
    const response = await fetch("/api/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
      },
      body: JSON.stringify(request),
    });

    if (!response.ok) {
      const error = await response.json().catch(() => ({ detail: "Stream failed" }));
      onError(new Error(error.detail || "Stream failed"));
      return;
    }

    const reader = response.body?.getReader();
    const decoder = new TextDecoder();

    if (!reader) {
      onError(new Error("No response body"));
      return;
    }

    let buffer = "";

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split("\n");
      buffer = lines.pop() || "";

      for (const line of lines) {
        if (line.startsWith("data: ")) {
          const dataStr = line.slice(6).trim();
          if (!dataStr) continue;

          try {
            const data = JSON.parse(dataStr);
            if (data.type === "chunk") {
              onChunk(data.content);
            } else if (data.type === "done") {
              onDone({
                conversation_id: data.conversation_id,
                skill: data.skill,
                voice_mode: data.voice_mode,
              });
              return;
            } else if (data.type === "error") {
              onError(new Error(data.message));
              return;
            }
          } catch {
            // Skip malformed JSON
          }
        }
      }
    }

    onDone({});
  } catch (error) {
    onError(error instanceof Error ? error : new Error(String(error)));
  }
}

// ─────────────────────────────────────────────────────────────────
// User API
// ─────────────────────────────────────────────────────────────────

export async function getProfile() {
  const response = await fetchAPI("/users/me/profile");
  if (!response.ok) throw new Error("Failed to get profile");
  return response.json();
}

export async function updateProfile(data: Record<string, unknown>) {
  const response = await fetchAPI("/users/me/profile", {
    method: "PUT",
    body: JSON.stringify(data),
  });
  if (!response.ok) throw new Error("Failed to update profile");
  return response.json();
}

export async function getSubscriptionStatus() {
  const response = await fetchAPI("/users/me/subscription");
  if (!response.ok) throw new Error("Failed to get subscription");
  return response.json();
}

// ─────────────────────────────────────────────────────────────────
// Guest Tool API (Landing page direct tool invocation)
// ─────────────────────────────────────────────────────────────────

export interface GuestToolRequest {
  skill: string;           // Changed from skill_id
  tool: string;
  birth_date: string;
  birth_time?: string;
  gender?: string;
  birth_location?: string;
}

export interface GuestToolResponse {
  success: boolean;
  tool: string;
  skill: string;           // Changed from skill_id
  raw_result?: string;
  chart_data?: Record<string, unknown>;
  interpretation?: string;
  is_guest: boolean;
  suggestion?: string;
  error?: string;
}

export async function invokeGuestTool(
  request: GuestToolRequest
): Promise<GuestToolResponse> {
  const response = await fetch("/api/proxy?endpoint=/api/v1/chat/guest/tool", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(request),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ detail: "Tool invocation failed" }));
    throw new Error(error.detail || "Tool invocation failed");
  }

  return response.json();
}

// ─────────────────────────────────────────────────────────────────
// SSO API
// ─────────────────────────────────────────────────────────────────

export interface SSOGenerateResponse {
  sso_token: string;
  redirect_url: string;
  expires_in: number;
}

export async function generateSSOToken(targetSite: string): Promise<SSOGenerateResponse> {
  const response = await fetchAPI("/auth/sso/generate", {
    method: "POST",
    body: JSON.stringify({ target_site: targetSite }),
  });

  if (!response.ok) {
    throw new Error("Failed to generate SSO token");
  }

  return response.json();
}

export async function exchangeSSOToken(
  token: string,
  site: string
): Promise<TokenResponse> {
  const response = await fetch("/api/auth/sso/callback", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, site }),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ detail: "SSO exchange failed" }));
    throw new Error(error.detail || "SSO exchange failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}

/**
 * Redirect to another VibeLife site with SSO
 */
export async function ssoRedirect(targetSite: string): Promise<void> {
  const response = await generateSSOToken(targetSite);
  if (response.redirect_url) {
    window.location.href = response.redirect_url;
  }
}

// ─────────────────────────────────────────────────────────────────
// Guest Session API
// ─────────────────────────────────────────────────────────────────

export interface GuestSession {
  session_id: string;
  birth_datetime?: string;
  birth_location?: string;
  gender?: string;
  voice_mode?: string;
  skill?: string;
  interview_responses?: Record<string, unknown>;
  focus_areas?: string[];
  expires_at: string;
}

export interface OnboardingData {
  birth_datetime?: string;
  birth_location?: string;
  gender?: string;
  voice_mode?: string;
  skill?: string;
  interview_responses?: Record<string, unknown>;
  focus_areas?: string[];
}

export async function createGuestSession(): Promise<GuestSession> {
  const response = await fetch("/api/guest/session", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
  });

  if (!response.ok) {
    throw new Error("Failed to create guest session");
  }

  return response.json();
}

export async function getGuestSession(): Promise<GuestSession | null> {
  try {
    const response = await fetch("/api/guest/session", {
      credentials: "include",
    });

    if (!response.ok) {
      return null;
    }

    return response.json();
  } catch {
    return null;
  }
}

export async function saveOnboardingData(data: OnboardingData): Promise<GuestSession> {
  const response = await fetch("/api/proxy?endpoint=/api/v1/guest/session/onboarding", {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(data),
  });

  if (!response.ok) {
    throw new Error("Failed to save onboarding data");
  }

  return response.json();
}

// ─────────────────────────────────────────────────────────────────
// OAuth API
// ─────────────────────────────────────────────────────────────────

export async function googleAuth(
  idToken: string,
  onboarding?: OnboardingData
): Promise<TokenResponse> {
  const response = await fetch("/api/auth/oauth/google", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ id_token: idToken, onboarding }),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ detail: "Google auth failed" }));
    throw new Error(error.detail || "Google auth failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}

export async function appleAuth(
  idToken: string,
  userName?: string,
  onboarding?: OnboardingData
): Promise<TokenResponse> {
  const response = await fetch("/api/auth/oauth/apple", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ id_token: idToken, user_name: userName, onboarding }),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ detail: "Apple auth failed" }));
    throw new Error(error.detail || "Apple auth failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}

// ─────────────────────────────────────────────────────────────────
// Password Reset API
// ─────────────────────────────────────────────────────────────────

export async function requestPasswordReset(
  email?: string,
  phone?: string
): Promise<{ message: string; reset_url?: string }> {
  const response = await fetch("/api/proxy?endpoint=/api/v1/auth/password/reset-request", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, phone }),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ detail: "Request failed" }));
    throw new Error(error.detail || "Request failed");
  }

  return response.json();
}

export async function verifyResetToken(token: string): Promise<{ valid: boolean; token_type: string }> {
  const response = await fetch("/api/proxy?endpoint=/api/v1/auth/password/verify-token", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token }),
  });

  if (!response.ok) {
    throw new Error("Invalid or expired token");
  }

  return response.json();
}

export async function resetPassword(token: string, newPassword: string): Promise<{ message: string }> {
  const response = await fetch("/api/proxy?endpoint=/api/v1/auth/password/reset", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ token, new_password: newPassword }),
  });

  if (!response.ok) {
    const error = await response.json().catch(() => ({ detail: "Reset failed" }));
    throw new Error(error.detail || "Reset failed");
  }

  return response.json();
}

// ─────────────────────────────────────────────────────────────────
// Register with Session
// ─────────────────────────────────────────────────────────────────

export async function registerWithSession(
  email?: string,
  password?: string,
  displayName?: string,
  phone?: string,
  sessionId?: string,
  onboarding?: OnboardingData
): Promise<TokenResponse> {
  const response = await fetch("/api/auth/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({
      email: email || undefined,
      phone: phone || undefined,
      password,
      display_name: displayName,
      session_id: sessionId,
      onboarding,
    }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.detail || "Registration failed");
  }

  const data: TokenResponse = await response.json();
  setTokens(data.access_token, data.refresh_token);

  if (typeof window !== "undefined") {
    localStorage.setItem("user", JSON.stringify(data.user));
  }

  return data;
}
