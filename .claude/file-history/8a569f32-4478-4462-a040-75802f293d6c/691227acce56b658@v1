"""
检查数据库 schema
"""
import asyncio
import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# 加载环境变量
root_dir = Path(__file__).parent.parent.parent.parent
env_file = root_dir / '.env'
if env_file.exists():
    load_dotenv(env_file, override=True)

os.environ.pop('VIBELIFE_ENV', None)
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection, init_db, close_db


async def check_schema():
    """检查表结构"""
    await init_db()

    try:
        async with get_connection() as conn:
            # 检查 vibe_users 表结构
            print("=== vibe_users 表结构 ===")
            columns = await conn.fetch("""
                SELECT column_name, data_type
                FROM information_schema.columns
                WHERE table_name = 'vibe_users'
                ORDER BY ordinal_position
            """)

            for col in columns:
                print(f"  {col['column_name']}: {col['data_type']}")

            # 检查 unified_profiles 表结构
            print("\n=== unified_profiles 表结构 ===")
            columns = await conn.fetch("""
                SELECT column_name, data_type
                FROM information_schema.columns
                WHERE table_name = 'unified_profiles'
                ORDER BY ordinal_position
            """)

            for col in columns:
                print(f"  {col['column_name']}: {col['data_type']}")

    finally:
        await close_db()


if __name__ == "__main__":
    asyncio.run(check_schema())
