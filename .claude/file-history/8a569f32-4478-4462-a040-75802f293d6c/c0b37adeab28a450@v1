"""
VibeProfile 真实数据测试 - 直接运行
每个测试独立执行并汇报结果
"""
import asyncio
import os
import sys
import json
from pathlib import Path
from dotenv import load_dotenv
from uuid import UUID
from datetime import datetime

# 加载环境变量
root_dir = Path(__file__).parent.parent.parent.parent
env_file = root_dir / '.env'
if env_file.exists():
    load_dotenv(env_file, override=True)
os.environ.pop('VIBELIFE_ENV', None)

sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.unified_profile_repo import UnifiedProfileRepository
from stores.db import init_db, close_db

# 真实用户ID
TEST_USER_1 = UUID('550e8400-e29b-41d4-a716-446655440000')  # VB_TEST_001
TEST_USER_2 = UUID('22817735-e2a4-4c54-ad06-44ce4211751e')  # VB-G6DP3PQ3
TEST_USER_3 = UUID('11111111-1111-1111-1111-111111111111')  # VIBE-TEST001

# 测试结果
results = []


def log_result(test_num, test_name, status, details=""):
    """记录测试结果"""
    result = {
        "test": f"测试{test_num}: {test_name}",
        "status": status,
        "details": details,
        "timestamp": datetime.now().isoformat()
    }
    results.append(result)

    # 打印到控制台
    symbol = "✅" if status == "PASS" else "❌" if status == "FAIL" else "⚠️"
    print(f"\n{symbol} {result['test']}")
    print(f"   状态: {status}")
    if details:
        print(f"   详情: {details}")


async def main():
    """运行所有测试"""
    print("="*70)
    print("VibeProfile 真实数据测试")
    print("="*70)
    print(f"测试时间: {datetime.now()}")
    print(f"数据库: 真实生产数据库")
    print(f"测试用户: 3个真实用户")
    print("="*70)

    await init_db()
    repo = UnifiedProfileRepository()

    try:
        # ═══════════════════════════════════════════════════════════════
        # 测试组 1: Profile 基础读取
        # ═══════════════════════════════════════════════════════════════
        print("\n\n【测试组 1: Profile 基础读取】\n")

        # 测试1: get_profile (USER 1)
        try:
            profile = await repo.get_profile(TEST_USER_1)
            if profile is not None:
                log_result(1, "读取 TEST_USER_1 Profile", "PASS",
                          f"Profile 存在，包含键: {list(profile.keys())}")
            else:
                log_result(1, "读取 TEST_USER_1 Profile", "FAIL", "Profile 为 None")
        except Exception as e:
            log_result(1, "读取 TEST_USER_1 Profile", "FAIL", f"异常: {str(e)}")

        # 测试2: get_profile (USER 2)
        try:
            profile = await repo.get_profile(TEST_USER_2)
            if profile is not None:
                log_result(2, "读取 TEST_USER_2 Profile", "PASS",
                          f"Profile 存在，包含键: {list(profile.keys())}")
            else:
                log_result(2, "读取 TEST_USER_2 Profile", "FAIL", "Profile 为 None")
        except Exception as e:
            log_result(2, "读取 TEST_USER_2 Profile", "FAIL", f"异常: {str(e)}")

        # 测试3: get_profile (USER 3)
        try:
            profile = await repo.get_profile(TEST_USER_3)
            if profile is not None:
                log_result(3, "读取 TEST_USER_3 Profile", "PASS",
                          f"Profile 存在，包含键: {list(profile.keys())}")
            else:
                log_result(3, "读取 TEST_USER_3 Profile", "FAIL", "Profile 为 None")
        except Exception as e:
            log_result(3, "读取 TEST_USER_3 Profile", "FAIL", f"异常: {str(e)}")

        # 测试4: get_birth_info
        try:
            birth_info = await repo.get_birth_info(TEST_USER_1)
            is_empty = len(birth_info) == 0
            log_result(4, "读取 birth_info", "PASS",
                      f"返回类型: dict, 是否为空: {is_empty}, 内容: {birth_info}")
        except Exception as e:
            log_result(4, "读取 birth_info", "FAIL", f"异常: {str(e)}")

        # 测试5: get_preferences
        try:
            preferences = await repo.get_preferences(TEST_USER_1)
            log_result(5, "读取 preferences", "PASS",
                      f"包含键: {list(preferences.keys())}")
        except Exception as e:
            log_result(5, "读取 preferences", "FAIL", f"异常: {str(e)}")

        # 测试6: get_life_context
        try:
            life_context = await repo.get_life_context(TEST_USER_1)
            log_result(6, "读取 life_context", "PASS",
                      f"包含键: {list(life_context.keys())}")
        except Exception as e:
            log_result(6, "读取 life_context", "FAIL", f"异常: {str(e)}")

        # 测试7: get_skill_data
        try:
            skill_data = await repo.get_skill_data(TEST_USER_1, 'bazi')
            is_empty = len(skill_data) == 0
            log_result(7, "读取 skill_data (bazi)", "PASS",
                      f"是否为空: {is_empty}")
        except Exception as e:
            log_result(7, "读取 skill_data (bazi)", "FAIL", f"异常: {str(e)}")

        # 测试8: get_extracted
        try:
            extracted = await repo.get_extracted(TEST_USER_1)
            is_empty = len(extracted) == 0
            log_result(8, "读取 extracted", "PASS",
                      f"是否为空: {is_empty}")
        except Exception as e:
            log_result(8, "读取 extracted", "FAIL", f"异常: {str(e)}")

        # ═══════════════════════════════════════════════════════════════
        # 测试组 2: Skill 订阅管理
        # ═══════════════════════════════════════════════════════════════
        print("\n\n【测试组 2: Skill 订阅管理】\n")

        # 测试9: get_user_subscriptions
        try:
            subscriptions = await repo.get_user_subscriptions(TEST_USER_1)
            sub_list = [f"{s.skill_id}({s.status})" for s in subscriptions]
            log_result(9, "获取用户订阅列表", "PASS",
                      f"订阅数量: {len(subscriptions)}, 列表: {sub_list}")
        except Exception as e:
            log_result(9, "获取用户订阅列表", "FAIL", f"异常: {str(e)}")

        # 测试10: get_skill_subscription
        try:
            subscriptions = await repo.get_user_subscriptions(TEST_USER_1)
            if subscriptions:
                skill_id = subscriptions[0].skill_id
                subscription = await repo.get_skill_subscription(TEST_USER_1, skill_id)
                if subscription:
                    log_result(10, "获取单个 Skill 订阅", "PASS",
                              f"Skill: {skill_id}, 状态: {subscription.status}")
                else:
                    log_result(10, "获取单个 Skill 订阅", "FAIL", "返回 None")
            else:
                log_result(10, "获取单个 Skill 订阅", "SKIP", "用户无订阅")
        except Exception as e:
            log_result(10, "获取单个 Skill 订阅", "FAIL", f"异常: {str(e)}")

        # 测试11: is_subscribed
        try:
            subscriptions = await repo.get_user_subscriptions(TEST_USER_1)
            if subscriptions:
                skill_id = subscriptions[0].skill_id
                is_sub = await repo.is_subscribed(TEST_USER_1, skill_id)
                log_result(11, "检查是否订阅", "PASS",
                          f"Skill: {skill_id}, 已订阅: {is_sub}")
            else:
                log_result(11, "检查是否订阅", "SKIP", "用户无订阅")
        except Exception as e:
            log_result(11, "检查是否订阅", "FAIL", f"异常: {str(e)}")

        # 测试12: is_push_enabled
        try:
            subscriptions = await repo.get_user_subscriptions(TEST_USER_1)
            if subscriptions:
                skill_id = subscriptions[0].skill_id
                is_enabled = await repo.is_push_enabled(TEST_USER_1, skill_id)
                log_result(12, "检查推送是否开启", "PASS",
                          f"Skill: {skill_id}, 推送开启: {is_enabled}")
            else:
                log_result(12, "检查推送是否开启", "SKIP", "用户无订阅")
        except Exception as e:
            log_result(12, "检查推送是否开启", "FAIL", f"异常: {str(e)}")

        # 测试13: get_subscribed_skill_ids
        try:
            skill_ids = await repo.get_subscribed_skill_ids(TEST_USER_1)
            log_result(13, "获取订阅的 Skill IDs", "PASS",
                      f"数量: {len(skill_ids)}, IDs: {skill_ids}")
        except Exception as e:
            log_result(13, "获取订阅的 Skill IDs", "FAIL", f"异常: {str(e)}")

        # ═══════════════════════════════════════════════════════════════
        # 测试组 3: Push 设置
        # ═══════════════════════════════════════════════════════════════
        print("\n\n【测试组 3: Push 设置】\n")

        # 测试14: get_push_settings
        try:
            settings = await repo.get_push_settings(TEST_USER_1)
            if settings:
                log_result(14, "获取推送设置", "PASS",
                          f"推送时间: {settings.default_push_hour}, 免打扰: {settings.quiet_start_hour}-{settings.quiet_end_hour}")
            else:
                log_result(14, "获取推送设置", "PASS", "返回 None (使用默认值)")
        except Exception as e:
            log_result(14, "获取推送设置", "FAIL", f"异常: {str(e)}")

        # 测试15: get_push_hour
        try:
            push_hour = await repo.get_push_hour(TEST_USER_1)
            log_result(15, "获取推送时间", "PASS",
                      f"推送时间: {push_hour}:00")
        except Exception as e:
            log_result(15, "获取推送时间", "FAIL", f"异常: {str(e)}")

        # 测试16: is_in_quiet_hours
        try:
            test_hours = [0, 8, 12, 20, 23]
            quiet_status = {}
            for hour in test_hours:
                is_quiet = await repo.is_in_quiet_hours(TEST_USER_1, hour)
                quiet_status[f"{hour:02d}:00"] = "免打扰" if is_quiet else "可推送"

            log_result(16, "检查免打扰时段", "PASS",
                      f"各时段状态: {quiet_status}")
        except Exception as e:
            log_result(16, "检查免打扰时段", "FAIL", f"异常: {str(e)}")

        # ═══════════════════════════════════════════════════════════════
        # 测试组 4: Life Context (文件系统API)
        # ═══════════════════════════════════════════════════════════════
        print("\n\n【测试组 4: Life Context】\n")

        # 测试17: list_life_context_paths
        try:
            paths = await repo.list_life_context_paths(TEST_USER_1)
            log_result(17, "列出 life context 路径", "PASS",
                      f"路径数量: {len(paths)}, 前3个: {paths[:3] if paths else '无'}")
        except Exception as e:
            log_result(17, "列出 life context 路径", "FAIL", f"异常: {str(e)}")

        # 测试18: read_life_context_path
        try:
            paths = await repo.list_life_context_paths(TEST_USER_1)
            if paths:
                first_path = paths[0]
                data = await repo.read_life_context_path(TEST_USER_1, first_path)
                if data:
                    log_result(18, "读取 life context 路径", "PASS",
                              f"路径: {first_path}, 版本: {data.version}")
                else:
                    log_result(18, "读取 life context 路径", "PASS", "返回 None")
            else:
                log_result(18, "读取 life context 路径", "SKIP", "无路径数据")
        except Exception as e:
            log_result(18, "读取 life context 路径", "FAIL", f"异常: {str(e)}")

        # ═══════════════════════════════════════════════════════════════
        # 测试组 5: 其他功能
        # ═══════════════════════════════════════════════════════════════
        print("\n\n【测试组 5: 其他功能】\n")

        # 测试19: get_blocked_skills
        try:
            blocked = await repo.get_blocked_skills(TEST_USER_1)
            log_result(19, "获取屏蔽的 Skills", "PASS",
                      f"屏蔽数量: {len(blocked)}, 列表: {blocked if blocked else '无'}")
        except Exception as e:
            log_result(19, "获取屏蔽的 Skills", "FAIL", f"异常: {str(e)}")

        # 测试20: is_skill_blocked
        try:
            is_blocked = await repo.is_skill_blocked(TEST_USER_1, 'test_skill')
            log_result(20, "检查 Skill 是否屏蔽", "PASS",
                      f"test_skill 已屏蔽: {is_blocked}")
        except Exception as e:
            log_result(20, "检查 Skill 是否屏蔽", "FAIL", f"异常: {str(e)}")

    finally:
        await close_db()

    # ═══════════════════════════════════════════════════════════════
    # 生成测试报告
    # ═══════════════════════════════════════════════════════════════
    print("\n\n" + "="*70)
    print("测试结果汇总")
    print("="*70)

    passed = sum(1 for r in results if r['status'] == 'PASS')
    failed = sum(1 for r in results if r['status'] == 'FAIL')
    skipped = sum(1 for r in results if r['status'] == 'SKIP')

    print(f"\n总测试数: {len(results)}")
    print(f"通过: {passed} ({passed/len(results)*100:.1f}%)")
    print(f"失败: {failed} ({failed/len(results)*100:.1f}%)")
    print(f"跳过: {skipped} ({skipped/len(results)*100:.1f}%)")

    # 保存详细结果
    report_file = Path(__file__).parent / "test_results.json"
    with open(report_file, 'w', encoding='utf-8') as f:
        json.dump({
            "summary": {
                "total": len(results),
                "passed": passed,
                "failed": failed,
                "skipped": skipped,
                "pass_rate": f"{passed/len(results)*100:.1f}%"
            },
            "tests": results
        }, f, indent=2, ensure_ascii=False)

    print(f"\n详细结果已保存到: {report_file}")

    return passed, failed, skipped


if __name__ == "__main__":
    passed, failed, skipped = asyncio.run(main())
    sys.exit(0 if failed == 0 else 1)
