"""
设置测试数据到真实数据库
使用环境变量中的数据库连接
"""
import asyncio
import sys
from pathlib import Path

# 添加项目根目录到 Python 路径
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_db_connection


async def setup_test_users():
    """创建测试用户数据"""
    # 读取 SQL 文件
    sql_file = Path(__file__).parent / "fixtures" / "test_users.sql"

    with open(sql_file, 'r', encoding='utf-8') as f:
        sql_content = f.read()

    # 执行 SQL
    conn = await get_db_connection()
    try:
        # 分割 SQL 语句 (按照分号)
        statements = [s.strip() for s in sql_content.split(';') if s.strip() and not s.strip().startswith('--')]

        for statement in statements:
            if statement:
                try:
                    await conn.execute(statement)
                    print(f"✓ 执行成功")
                except Exception as e:
                    # SELECT 语句可能返回结果，不算错误
                    if 'SELECT' in statement.upper():
                        result = await conn.fetch(statement)
                        print(f"\n查询结果:")
                        for row in result:
                            print(f"  {dict(row)}")
                    else:
                        print(f"✗ 执行失败: {e}")
                        print(f"  SQL: {statement[:100]}...")

        print(f"\n✅ 测试数据设置完成")

    finally:
        await conn.close()


if __name__ == "__main__":
    asyncio.run(setup_test_users())
