"""
检查真实用户的 Profile 数据
"""
import asyncio
import os
import sys
import json
from pathlib import Path
from dotenv import load_dotenv
from uuid import UUID

# 加载环境变量
root_dir = Path(__file__).parent.parent.parent.parent
env_file = root_dir / '.env'
if env_file.exists():
    load_dotenv(env_file, override=True)
os.environ.pop('VIBELIFE_ENV', None)

sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.unified_profile_repo import UnifiedProfileRepository
from stores.db import init_db, close_db

TEST_USER_1 = UUID('550e8400-e29b-41d4-a716-446655440000')  # VB_TEST_001
TEST_USER_2 = UUID('22817735-e2a4-4c54-ad06-44ce4211751e')  # VB-G6DP3PQ3
TEST_USER_3 = UUID('11111111-1111-1111-1111-111111111111')  # VIBE-TEST001


async def inspect():
    """检查Profile数据"""
    await init_db()
    repo = UnifiedProfileRepository()

    try:
        for i, user_id in enumerate([TEST_USER_1, TEST_USER_2, TEST_USER_3], 1):
            print(f"\n{'='*70}")
            print(f"TEST_USER_{i}: {user_id}")
            print(f"{'='*70}\n")

            # 获取 Profile
            profile = await repo.get_profile(user_id)

            if profile is None:
                print("❌ Profile 不存在")
                continue

            print("✅ Profile 存在\n")

            # 显示结构
            print(f"Profile 顶层键: {list(profile.keys())}")
            print()

            # 详细信息
            if 'birth_info' in profile:
                print(f"birth_info: {json.dumps(profile['birth_info'], indent=2, ensure_ascii=False)}")

            if 'preferences' in profile:
                prefs = profile['preferences']
                print(f"\npreferences 键: {list(prefs.keys())}")
                if 'subscribed_skills' in prefs:
                    print(f"  subscribed_skills: {list(prefs['subscribed_skills'].keys())}")
                if 'push_settings' in prefs:
                    print(f"  push_settings: {prefs['push_settings']}")

            if 'life_context' in profile:
                lc = profile['life_context']
                print(f"\nlife_context 键: {list(lc.keys())}")

            if 'skill_data' in profile:
                print(f"\nskill_data 键: {list(profile['skill_data'].keys())}")

            # 测试一些方法
            print(f"\n--- 测试方法调用 ---")

            # birth_info
            birth_info = await repo.get_birth_info(user_id)
            print(f"get_birth_info(): {birth_info}")

            # subscriptions
            subscriptions = await repo.get_user_subscriptions(user_id)
            print(f"get_user_subscriptions(): {len(subscriptions)} 个订阅")
            for sub in subscriptions[:3]:
                print(f"  - {sub.skill_id}: {sub.status}")

            # push_settings
            push_settings = await repo.get_push_settings(user_id)
            if push_settings:
                print(f"get_push_settings(): hour={push_settings.default_push_hour}")
            else:
                print(f"get_push_settings(): None")

    finally:
        await close_db()


if __name__ == "__main__":
    asyncio.run(inspect())
