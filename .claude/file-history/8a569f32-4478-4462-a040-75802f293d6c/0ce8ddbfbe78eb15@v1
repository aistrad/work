"""
列出真实数据库中的用户 (用于测试)
"""
import asyncio
import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# 加载环境变量
root_dir = Path(__file__).parent.parent.parent.parent
env_file = root_dir / '.env'
if env_file.exists():
    load_dotenv(env_file, override=True)
os.environ.pop('VIBELIFE_ENV', None)

sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection, init_db, close_db


async def list_users():
    """列出用户"""
    await init_db()

    try:
        async with get_connection() as conn:
            # 查询有 Profile 的用户
            print("=== 有 Profile 的用户 (前10个) ===\n")
            users = await conn.fetch("""
                SELECT
                    u.id,
                    u.vibe_id,
                    u.display_name,
                    u.gender,
                    u.status,
                    u.created_at,
                    CASE WHEN up.user_id IS NOT NULL THEN 'Yes' ELSE 'No' END as has_profile
                FROM vibe_users u
                LEFT JOIN unified_profiles up ON u.id = up.user_id
                WHERE up.user_id IS NOT NULL
                ORDER BY u.created_at DESC
                LIMIT 10
            """)

            for i, user in enumerate(users, 1):
                print(f"{i}. {user['vibe_id']}")
                print(f"   ID: {user['id']}")
                print(f"   Name: {user['display_name']}")
                print(f"   Gender: {user['gender'] or 'N/A'}")
                print(f"   Status: {user['status']}")
                print(f"   Created: {user['created_at']}")
                print()

            # 统计信息
            print("\n=== 统计信息 ===\n")
            stats = await conn.fetchrow("""
                SELECT
                    COUNT(*) as total_users,
                    COUNT(up.user_id) as users_with_profile,
                    COUNT(*) - COUNT(up.user_id) as users_without_profile
                FROM vibe_users u
                LEFT JOIN unified_profiles up ON u.id = up.user_id
            """)

            print(f"总用户数: {stats['total_users']}")
            print(f"有 Profile: {stats['users_with_profile']}")
            print(f"无 Profile: {stats['users_without_profile']}")

            # 选择推荐的测试用户
            print("\n=== 推荐测试用户 ===\n")
            test_users = users[:3] if len(users) >= 3 else users

            print("建议使用以下用户进行测试:\n")
            for i, user in enumerate(test_users, 1):
                print(f"TEST_USER_{i} = UUID('{user['id']}')")
                print(f"# {user['vibe_id']} - {user['display_name']}\n")

    finally:
        await close_db()


if __name__ == "__main__":
    asyncio.run(list_users())
