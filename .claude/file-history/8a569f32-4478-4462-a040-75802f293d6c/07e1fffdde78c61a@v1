"""
验证测试数据是否存在于数据库中
"""
import asyncio
import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# 加载环境变量
root_dir = Path(__file__).parent.parent.parent
env_file = root_dir / '.env'
if env_file.exists():
    load_dotenv(env_file, override=True)

# 确保不使用 TEST_MODE
os.environ.pop('VIBELIFE_ENV', None)

# 添加项目根目录到 Python 路径
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection, init_db, close_db
from uuid import UUID

TEST_USER_1 = UUID('11111111-1111-1111-1111-111111111111')
TEST_USER_2 = UUID('22222222-2222-2222-2222-222222222222')
TEST_USER_3 = UUID('33333333-3333-3333-3333-333333333333')


async def verify_data():
    """验证测试数据"""
    await init_db()

    try:
        async with get_connection() as conn:
            # 1. 检查测试用户是否存在
            print("\n=== 检查测试用户 ===")
            users = await conn.fetch("""
                SELECT id, vibe_id, email, display_name, tier, status
                FROM vibe_users
                WHERE vibe_id LIKE 'VB-TEST%'
                ORDER BY vibe_id
            """)

            print(f"找到 {len(users)} 个测试用户:")
            for user in users:
                print(f"  - {user['vibe_id']}: {user['display_name']} ({user['tier']})")

            # 2. 检查 Profile 数据
            print("\n=== 检查 Profile 数据 ===")
            profiles = await conn.fetch("""
                SELECT
                    user_id,
                    profile->'account'->>'vibe_id' as vibe_id,
                    profile->'preferences'->>'push_enabled' as push_enabled,
                    profile->'preferences'->>'push_hour' as push_hour,
                    jsonb_object_keys(profile->'preferences'->'subscribed_skills') as subscribed_skills
                FROM unified_profiles
                WHERE user_id = ANY($1::uuid[])
                ORDER BY user_id
            """, [str(TEST_USER_1), str(TEST_USER_2), str(TEST_USER_3)])

            print(f"找到 {len(profiles)} 个 Profile:")
            for profile in profiles:
                print(f"  - {profile['vibe_id']}: push={profile['push_enabled']}, hour={profile['push_hour']}")

            # 3. 检查完整 Profile
            print("\n=== 检查 TEST_USER_2 完整 Profile ===")
            profile = await conn.fetchrow("""
                SELECT profile
                FROM unified_profiles
                WHERE user_id = $1
            """, str(TEST_USER_2))

            if profile:
                p = profile['profile']
                print(f"  Account: {p['account']['vibe_id']} ({p['account']['tier']})")
                print(f"  Identity: {p.get('identity', {}).get('birth_info', {}).get('date', 'N/A')}")
                print(f"  State: emotion={p.get('state', {}).get('emotion', 'N/A')}")
                print(f"  Goals: {len(p.get('life_context', {}).get('goals', []))}")
                print(f"  Tasks: {len(p.get('life_context', {}).get('tasks', []))}")
                print(f"  Checkins: {len(p.get('life_context', {}).get('checkins', {}))}")
                print(f"  Reminders: {len(p.get('life_context', {}).get('reminders', []))}")

                # 订阅的 skills
                subscribed = p.get('preferences', {}).get('subscribed_skills', {})
                print(f"  Subscribed skills: {list(subscribed.keys())}")

            print("\n✅ 测试数据验证完成")

    finally:
        await close_db()


if __name__ == "__main__":
    asyncio.run(verify_data())
