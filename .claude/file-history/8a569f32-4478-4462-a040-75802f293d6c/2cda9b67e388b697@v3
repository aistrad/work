"""
VibeProfile Repository 单元测试 - 使用真实数据库
测试用户: VB-TEST0001, VB-TEST0002, VB-TEST0003
"""
import os
import sys
from pathlib import Path
from dotenv import load_dotenv

# 加载环境变量
root_dir = Path(__file__).parent.parent.parent.parent.parent
env_file = root_dir / '.env'
if env_file.exists():
    load_dotenv(env_file, override=True)
    # 确保不使用 TEST_MODE
    os.environ.pop('VIBELIFE_ENV', None)

import pytest
from uuid import UUID
from datetime import date, timedelta
from stores.unified_profile_repo import UnifiedProfileRepository
from stores.db import init_db, close_db

# 测试用户 ID (使用真实数据库用户)
TEST_USER_1 = UUID('550e8400-e29b-41d4-a716-446655440000')  # VB_TEST_001 - 测试用户
TEST_USER_2 = UUID('22817735-e2a4-4c54-ad06-44ce4211751e')  # VB-G6DP3PQ3 - test
TEST_USER_3 = UUID('11111111-1111-1111-1111-111111111111')  # VIBE-TEST001 - Test VIP User


@pytest.fixture(scope="module", autouse=True)
async def setup_db():
    """初始化数据库连接"""
    await init_db()
    yield
    try:
        await close_db()
    except AttributeError:
        # DummyPool 没有 close 方法，忽略
        pass


@pytest.fixture
def repo():
    """创建 Repository 实例"""
    return UnifiedProfileRepository()


# ═══════════════════════════════════════════════════════════════
# Profile 读取测试
# ═══════════════════════════════════════════════════════════════

class TestProfileRead:
    """测试 Profile 读取操作"""

    @pytest.mark.asyncio
    async def test_get_profile_complete(self, repo):
        """测试读取完整 Profile"""
        profile = await repo.get_profile(TEST_USER_1)

        assert profile is not None
        assert profile['account']['vibe_id'] == 'VB-TEST0001'
        assert profile['identity']['birth_info']['date'] == '1990-05-15'
        assert 'career' in profile['state']['focus']
        assert profile['preferences']['push_enabled'] is True
        print(f"✓ TEST_USER_1 Profile 读取成功")

    @pytest.mark.asyncio
    async def test_get_profile_premium_user(self, repo):
        """测试读取 Premium 用户 Profile"""
        profile = await repo.get_profile(TEST_USER_2)

        assert profile is not None
        assert profile['account']['tier'] == 'premium'
        assert profile['account']['vibe_id'] == 'VB-TEST0002'
        # Premium 用户订阅了多个 skill
        subscribed = profile['preferences']['subscribed_skills']
        assert 'bazi' in subscribed
        assert 'zodiac' in subscribed
        assert 'tarot' in subscribed
        print(f"✓ TEST_USER_2 (Premium) Profile 读取成功")

    @pytest.mark.asyncio
    async def test_get_birth_info(self, repo):
        """测试读取 birth_info"""
        birth_info = await repo.get_birth_info(TEST_USER_1)

        assert birth_info is not None
        assert birth_info['date'] == '1990-05-15'
        assert birth_info['time'] == '14:30:00'
        assert birth_info['timezone'] == 'Asia/Shanghai'
        assert birth_info['gender'] == 'male'
        print(f"✓ birth_info 读取成功: {birth_info}")

    @pytest.mark.asyncio
    async def test_get_skill_data(self, repo):
        """测试读取 skill_data"""
        # TEST_USER_2 有 bazi chart 数据
        skill_data = await repo.get_skill_data(TEST_USER_2, 'bazi')

        assert skill_data is not None
        assert 'chart' in skill_data
        assert skill_data['chart']['year'] == '乙丑'
        print(f"✓ skill_data.bazi 读取成功: {skill_data}")

    @pytest.mark.asyncio
    async def test_get_life_context(self, repo):
        """测试读取 life_context"""
        life_context = await repo.get_life_context(TEST_USER_2)

        assert life_context is not None
        assert life_context['occupation']['title'] == '瑜伽教练'
        assert isinstance(life_context['goals'], list)
        assert len(life_context['goals']) > 0
        assert life_context['goals'][0]['title'] == '每周练习5次瑜伽'
        print(f"✓ life_context 读取成功，goals 数量: {len(life_context['goals'])}")

    @pytest.mark.asyncio
    async def test_get_preferences(self, repo):
        """测试读取 preferences"""
        preferences = await repo.get_preferences(TEST_USER_1)

        assert preferences is not None
        assert preferences['voice_mode'] == 'warm'
        assert preferences['language'] == 'zh-CN'
        assert preferences['push_enabled'] is True
        assert 'push_settings' in preferences
        assert preferences['push_settings']['default_push_hour'] == 8
        print(f"✓ preferences 读取成功")

    @pytest.mark.asyncio
    async def test_get_extracted(self, repo):
        """测试读取 extracted"""
        extracted = await repo.get_extracted(TEST_USER_1)

        assert extracted is not None
        assert '在互联网公司工作' in extracted['facts']
        assert '年底升职' in extracted['goals']
        assert '工作压力' in extracted['concerns']
        print(f"✓ extracted 读取成功: {len(extracted['facts'])} facts")


# ═══════════════════════════════════════════════════════════════
# Profile 写入测试
# ═══════════════════════════════════════════════════════════════

class TestProfileWrite:
    """测试 Profile 写入操作"""

    @pytest.mark.asyncio
    async def test_update_state(self, repo):
        """测试更新 state"""
        new_state = {
            'emotion': 'excited',
            'focus': ['health', 'relationship'],
            'life_stage': 'family_building'
        }

        await repo.update_state(TEST_USER_1, new_state)

        # 验证更新
        profile = await repo.get_profile(TEST_USER_1)
        assert profile['state']['emotion'] == 'excited'
        assert 'health' in profile['state']['focus']
        assert 'relationship' in profile['state']['focus']
        print(f"✓ state 更新成功: emotion={profile['state']['emotion']}")

        # 恢复原始数据
        await repo.update_state(TEST_USER_1, {
            'emotion': 'neutral',
            'focus': ['career'],
            'life_stage': 'career_growth'
        })

    @pytest.mark.asyncio
    async def test_update_skill_data(self, repo):
        """测试更新 skill_data"""
        bazi_data = {
            'chart': {
                'year': '庚午',
                'month': '己巳',
                'day': '甲子',
                'hour': '丙寅'
            },
            'daymaster': '甲',
            'strength': '偏弱'
        }

        await repo.update_skill_data(TEST_USER_1, 'bazi', bazi_data)

        # 验证更新
        skill_data = await repo.get_skill_data(TEST_USER_1, 'bazi')
        assert skill_data['daymaster'] == '甲'
        assert skill_data['strength'] == '偏弱'
        assert skill_data['chart']['year'] == '庚午'
        print(f"✓ skill_data.bazi 更新成功: daymaster={skill_data['daymaster']}")

    @pytest.mark.asyncio
    async def test_update_preferences(self, repo):
        """测试更新 preferences"""
        original_prefs = await repo.get_preferences(TEST_USER_1)

        new_preferences = {
            'voice_mode': 'professional',
            'push_settings': {
                'default_push_hour': 20
            }
        }

        await repo.update_preferences(TEST_USER_1, new_preferences)

        # 验证更新
        preferences = await repo.get_preferences(TEST_USER_1)
        assert preferences['voice_mode'] == 'professional'
        assert preferences['push_settings']['default_push_hour'] == 20
        print(f"✓ preferences 更新成功: voice_mode={preferences['voice_mode']}")

        # 恢复原始数据
        await repo.update_preferences(TEST_USER_1, {
            'voice_mode': original_prefs['voice_mode'],
            'push_settings': original_prefs['push_settings']
        })


# ═══════════════════════════════════════════════════════════════
# Life Context 测试
# ═══════════════════════════════════════════════════════════════

class TestLifeContext:
    """测试 life_context 操作"""

    @pytest.mark.asyncio
    async def test_add_goal(self, repo):
        """测试添加目标"""
        goal = {
            'title': '学习 Python 编程',
            'category': 'learning',
            'status': 'active',
            'progress': 0.0,
            'deadline': '2026-12-31'
        }

        goal_id = await repo.add_goal(TEST_USER_1, goal)
        assert goal_id is not None

        # 验证添加
        life_context = await repo.get_life_context(TEST_USER_1)
        goals = life_context.get('goals', [])
        added_goal = next((g for g in goals if g.get('id') == goal_id), None)

        assert added_goal is not None
        assert added_goal['title'] == '学习 Python 编程'
        assert added_goal['category'] == 'learning'
        print(f"✓ 目标添加成功: {goal_id}")

        # 清理：删除添加的目标
        goals_updated = [g for g in goals if g.get('id') != goal_id]
        from stores.db import get_connection
        async with get_connection() as conn:
            await conn.execute("""
                UPDATE unified_profiles
                SET profile = jsonb_set(profile, '{life_context,goals}', $1::jsonb)
                WHERE user_id = $2
            """, str(goals_updated).replace("'", '"'), str(TEST_USER_1))

    @pytest.mark.asyncio
    async def test_add_task(self, repo):
        """测试添加任务"""
        task = {
            'title': '准备周报',
            'status': 'pending',
            'due_date': '2026-01-25'
        }

        task_id = await repo.add_task(TEST_USER_1, task)
        assert task_id is not None

        # 验证添加
        life_context = await repo.get_life_context(TEST_USER_1)
        tasks = life_context.get('tasks', [])
        added_task = next((t for t in tasks if t.get('id') == task_id), None)

        assert added_task is not None
        assert added_task['title'] == '准备周报'
        assert added_task['status'] == 'pending'
        print(f"✓ 任务添加成功: {task_id}")

    @pytest.mark.asyncio
    async def test_add_checkin(self, repo):
        """测试添加打卡"""
        checkin = {
            'mood': 8,
            'energy': 7,
            'notes': '测试打卡'
        }

        today = date.today().isoformat()
        await repo.add_checkin(TEST_USER_1, today, checkin)

        # 验证添加
        life_context = await repo.get_life_context(TEST_USER_1)
        checkins = life_context.get('checkins', {})

        assert today in checkins
        assert checkins[today]['mood'] == 8
        assert checkins[today]['energy'] == 7
        print(f"✓ 打卡添加成功: {today}")

    @pytest.mark.asyncio
    async def test_add_reminder(self, repo):
        """测试添加提醒"""
        reminder = {
            'type': 'custom',
            'title': '测试提醒',
            'schedule_type': 'daily',
            'trigger_hour': 10,
            'status': 'active'
        }

        reminder_id = await repo.add_reminder(TEST_USER_1, reminder)
        assert reminder_id is not None

        # 验证添加
        life_context = await repo.get_life_context(TEST_USER_1)
        reminders = life_context.get('reminders', [])
        added_reminder = next((r for r in reminders if r.get('id') == reminder_id), None)

        assert added_reminder is not None
        assert added_reminder['title'] == '测试提醒'
        assert added_reminder['trigger_hour'] == 10
        print(f"✓ 提醒添加成功: {reminder_id}")


# ═══════════════════════════════════════════════════════════════
# Skill 订阅测试
# ═══════════════════════════════════════════════════════════════

class TestSkillSubscriptions:
    """测试 Skill 订阅管理"""

    @pytest.mark.asyncio
    async def test_get_user_subscriptions(self, repo):
        """测试获取用户订阅列表"""
        subscriptions = await repo.get_user_subscriptions(TEST_USER_1)

        assert isinstance(subscriptions, list)
        assert len(subscriptions) > 0

        # 检查 core 和 bazi 订阅
        skill_ids = [s['skill_id'] for s in subscriptions]
        assert 'core' in skill_ids
        assert 'bazi' in skill_ids
        print(f"✓ 订阅列表: {skill_ids}")

    @pytest.mark.asyncio
    async def test_get_skill_subscription(self, repo):
        """测试获取单个 Skill 订阅状态"""
        subscription = await repo.get_skill_subscription(TEST_USER_1, 'bazi')

        assert subscription is not None
        assert subscription['status'] == 'subscribed'
        assert subscription['push_enabled'] is True
        print(f"✓ bazi 订阅状态: {subscription['status']}")

    @pytest.mark.asyncio
    async def test_subscribe_unsubscribe(self, repo):
        """测试订阅和取消订阅"""
        # 订阅 zodiac
        await repo.subscribe(TEST_USER_1, 'zodiac')

        subscription = await repo.get_skill_subscription(TEST_USER_1, 'zodiac')
        assert subscription['status'] == 'subscribed'
        print(f"✓ zodiac 订阅成功")

        # 取消订阅
        await repo.unsubscribe(TEST_USER_1, 'zodiac')

        subscription = await repo.get_skill_subscription(TEST_USER_1, 'zodiac')
        assert subscription['status'] == 'unsubscribed'
        print(f"✓ zodiac 取消订阅成功")

    @pytest.mark.asyncio
    async def test_update_push_enabled(self, repo):
        """测试更新推送开关"""
        # 关闭 bazi 推送
        await repo.update_push(TEST_USER_1, 'bazi', False)

        subscription = await repo.get_skill_subscription(TEST_USER_1, 'bazi')
        assert subscription['push_enabled'] is False
        print(f"✓ bazi 推送已关闭")

        # 重新开启
        await repo.update_push(TEST_USER_1, 'bazi', True)

        subscription = await repo.get_skill_subscription(TEST_USER_1, 'bazi')
        assert subscription['push_enabled'] is True
        print(f"✓ bazi 推送已开启")

    @pytest.mark.asyncio
    async def test_can_use_skill_core(self, repo):
        """测试 core skill 访问权限 (始终可用)"""
        can_use = await repo.can_use_skill(TEST_USER_1, 'core')
        assert can_use is True
        print(f"✓ core skill 始终可用")

    @pytest.mark.asyncio
    async def test_can_use_skill_premium_user(self, repo):
        """测试 Premium 用户访问所有 skill"""
        # Premium 用户应该可以访问任何 skill
        can_use = await repo.can_use_skill(TEST_USER_2, 'zodiac')
        assert can_use is True

        can_use = await repo.can_use_skill(TEST_USER_2, 'tarot')
        assert can_use is True
        print(f"✓ Premium 用户可访问所有 skill")


# ═══════════════════════════════════════════════════════════════
# Push Settings 测试
# ═══════════════════════════════════════════════════════════════

class TestPushSettings:
    """测试推送设置"""

    @pytest.mark.asyncio
    async def test_get_push_settings(self, repo):
        """测试获取推送设置"""
        settings = await repo.get_push_settings(TEST_USER_1)

        assert settings is not None
        assert settings['default_push_hour'] == 8
        assert 'max_daily_pushes' in settings
        assert 'quiet_start_hour' in settings
        print(f"✓ push_settings: {settings}")

    @pytest.mark.asyncio
    async def test_get_push_hour(self, repo):
        """测试获取推送时间"""
        push_hour = await repo.get_push_hour(TEST_USER_1)
        assert push_hour == 8

        push_hour = await repo.get_push_hour(TEST_USER_2)
        assert push_hour == 20
        print(f"✓ TEST_USER_1 push_hour: 8, TEST_USER_2 push_hour: 20")

    @pytest.mark.asyncio
    async def test_is_in_quiet_hours(self, repo):
        """测试免打扰时段判断"""
        # TEST_USER_1: quiet 22-7
        is_quiet = await repo.is_in_quiet_hours(TEST_USER_1, 23)
        assert is_quiet is True

        is_quiet = await repo.is_in_quiet_hours(TEST_USER_1, 10)
        assert is_quiet is False
        print(f"✓ 免打扰时段判断正确")


# ═══════════════════════════════════════════════════════════════
# Proactive 支持测试
# ═══════════════════════════════════════════════════════════════

class TestProactiveSupport:
    """测试 Proactive 功能支持"""

    @pytest.mark.asyncio
    async def test_get_users_for_push(self, repo):
        """测试获取需要推送的用户 (按小时)"""
        # 8 点推送的用户 (TEST_USER_1)
        users = await repo.get_users_for_push(push_hour=8)

        user_ids = [u['user_id'] for u in users]
        assert str(TEST_USER_1) in user_ids
        print(f"✓ 8 点推送用户数量: {len(users)}")

        # 20 点推送的用户 (TEST_USER_2)
        users = await repo.get_users_for_push(push_hour=20)

        user_ids = [u['user_id'] for u in users]
        assert str(TEST_USER_2) in user_ids
        print(f"✓ 20 点推送用户数量: {len(users)}")

    @pytest.mark.asyncio
    async def test_get_users_with_reminders(self, repo):
        """测试获取有提醒的用户"""
        # TEST_USER_2 有 7 点提醒
        users = await repo.get_users_with_reminders(trigger_hour=7)

        user_ids = [u['user_id'] for u in users]
        assert str(TEST_USER_2) in user_ids

        # 检查 reminders 字段
        user_2 = next(u for u in users if u['user_id'] == str(TEST_USER_2))
        assert 'reminders' in user_2
        assert len(user_2['reminders']) > 0
        print(f"✓ 7 点提醒用户数量: {len(users)}")


# ═══════════════════════════════════════════════════════════════
# 数据完整性测试
# ═══════════════════════════════════════════════════════════════

class TestDataIntegrity:
    """测试数据完整性"""

    @pytest.mark.asyncio
    async def test_profile_structure_complete(self, repo):
        """测试 Profile 结构完整性"""
        profile = await repo.get_profile(TEST_USER_2)

        # 检查顶层字段
        required_fields = ['account', 'identity', 'state', 'preferences',
                          'skill_data', 'extracted', 'life_context']
        for field in required_fields:
            assert field in profile, f"缺少字段: {field}"

        # 检查嵌套字段
        assert 'birth_info' in profile['identity']
        assert 'subscribed_skills' in profile['preferences']
        assert 'push_settings' in profile['preferences']
        assert 'goals' in profile['life_context']
        assert 'tasks' in profile['life_context']
        assert 'checkins' in profile['life_context']
        assert 'reminders' in profile['life_context']
        print(f"✓ Profile 结构完整")

    @pytest.mark.asyncio
    async def test_minimal_profile(self, repo):
        """测试最小化 Profile (TEST_USER_3)"""
        profile = await repo.get_profile(TEST_USER_3)

        assert profile is not None
        assert profile['account']['vibe_id'] == 'VB-TEST0003'
        assert profile['preferences']['push_enabled'] is False

        # 最小化 profile 应该有空的 life_context
        assert profile['life_context']['goals'] == []
        assert profile['life_context']['tasks'] == []
        print(f"✓ 最小化 Profile 结构正确")

    @pytest.mark.asyncio
    async def test_checkins_data_structure(self, repo):
        """测试 checkins 数据结构"""
        life_context = await repo.get_life_context(TEST_USER_2)
        checkins = life_context.get('checkins', {})

        # checkins 应该是字典，key 是日期字符串
        assert isinstance(checkins, dict)

        if checkins:
            # 检查日期格式和字段
            for date_str, checkin in checkins.items():
                assert isinstance(date_str, str)
                assert 'mood' in checkin
                assert 'energy' in checkin
                assert isinstance(checkin['mood'], int)
                assert isinstance(checkin['energy'], int)
        print(f"✓ checkins 数据结构正确，共 {len(checkins)} 条")


if __name__ == "__main__":
    pytest.main([__file__, "-v", "-s"])
