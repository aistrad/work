-- VibeProfile 测试用户数据
-- 用于真实数据库环境测试

-- 清理已存在的测试数据
DELETE FROM unified_profiles WHERE user_id IN (
    '11111111-1111-1111-1111-111111111111',
    '22222222-2222-2222-2222-222222222222',
    '33333333-3333-3333-3333-333333333333'
);

DELETE FROM vibe_users WHERE vibe_id LIKE 'VB-TEST%';

-- 创建测试用户
INSERT INTO vibe_users (id, vibe_id, email, display_name, tier, status, created_at)
VALUES
  ('11111111-1111-1111-1111-111111111111', 'VB-TEST0001', 'test1@vibelife.com', '测试用户1', 'free', 'active', NOW()),
  ('22222222-2222-2222-2222-222222222222', 'VB-TEST0002', 'test2@vibelife.com', '测试用户2', 'premium', 'active', NOW()),
  ('33333333-3333-3333-3333-333333333333', 'VB-TEST0003', 'test3@vibelife.com', '测试用户3', 'free', 'active', NOW())
ON CONFLICT (id) DO UPDATE SET
  email = EXCLUDED.email,
  display_name = EXCLUDED.display_name,
  tier = EXCLUDED.tier,
  status = EXCLUDED.status;

-- 创建测试用户的 Profile
INSERT INTO unified_profiles (user_id, profile, created_at, updated_at)
VALUES
  -- 用户1: 基础 Profile，有八字订阅
  ('11111111-1111-1111-1111-111111111111', '{
    "account": {
      "vibe_id": "VB-TEST0001",
      "display_name": "测试用户1",
      "email": "test1@vibelife.com",
      "tier": "free",
      "status": "active"
    },
    "identity": {
      "birth_info": {
        "date": "1990-05-15",
        "time": "14:30:00",
        "place": "北京",
        "timezone": "Asia/Shanghai",
        "gender": "male"
      }
    },
    "state": {
      "emotion": "neutral",
      "focus": ["career"],
      "life_stage": "career_growth"
    },
    "preferences": {
      "voice_mode": "warm",
      "language": "zh-CN",
      "push_enabled": true,
      "push_hour": 8,
      "subscribed_skills": {
        "core": {
          "status": "subscribed",
          "push_enabled": true,
          "subscribed_at": "2026-01-01T00:00:00Z"
        },
        "bazi": {
          "status": "subscribed",
          "push_enabled": true,
          "subscribed_at": "2026-01-01T00:00:00Z",
          "trial_messages_used": 0
        }
      },
      "push_settings": {
        "default_push_hour": 8,
        "max_daily_pushes": 5,
        "quiet_start_hour": 22,
        "quiet_end_hour": 7
      },
      "blocked_skills": [],
      "data_retention": {
        "conversations": "1y"
      }
    },
    "skill_data": {
      "bazi": {}
    },
    "extracted": {
      "facts": ["在互联网公司工作", "职位是产品经理"],
      "goals": ["年底升职"],
      "concerns": ["工作压力", "团队协作"]
    },
    "life_context": {
      "occupation": {
        "title": "产品经理",
        "industry": "互联网"
      },
      "focus_areas": ["career"],
      "goals": [],
      "tasks": [],
      "checkins": {},
      "reminders": [],
      "tracking": {
        "last_checkin": null,
        "streak_days": 0
      }
    }
  }'::jsonb, NOW(), NOW()),

  -- 用户2: Premium 用户，订阅多个 Skill
  ('22222222-2222-2222-2222-222222222222', '{
    "account": {
      "vibe_id": "VB-TEST0002",
      "display_name": "测试用户2",
      "email": "test2@vibelife.com",
      "tier": "premium",
      "status": "active"
    },
    "identity": {
      "birth_info": {
        "date": "1985-08-20",
        "time": "10:00:00",
        "place": "上海",
        "timezone": "Asia/Shanghai",
        "gender": "female"
      }
    },
    "state": {
      "emotion": "content",
      "focus": ["health", "relationship"],
      "life_stage": "self_discovery"
    },
    "preferences": {
      "voice_mode": "professional",
      "language": "zh-CN",
      "push_enabled": true,
      "push_hour": 20,
      "subscribed_skills": {
        "core": {
          "status": "subscribed",
          "push_enabled": true,
          "subscribed_at": "2026-01-01T00:00:00Z"
        },
        "bazi": {
          "status": "subscribed",
          "push_enabled": true,
          "subscribed_at": "2026-01-01T00:00:00Z"
        },
        "zodiac": {
          "status": "subscribed",
          "push_enabled": true,
          "subscribed_at": "2026-01-05T00:00:00Z"
        },
        "tarot": {
          "status": "subscribed",
          "push_enabled": false,
          "subscribed_at": "2026-01-10T00:00:00Z"
        }
      },
      "push_settings": {
        "default_push_hour": 20,
        "max_daily_pushes": 10,
        "quiet_start_hour": 23,
        "quiet_end_hour": 8
      },
      "blocked_skills": [],
      "data_retention": {
        "conversations": "3y"
      }
    },
    "skill_data": {
      "bazi": {
        "chart": {
          "year": "乙丑",
          "month": "甲申",
          "day": "丙寅",
          "hour": "癸巳"
        }
      },
      "zodiac": {},
      "tarot": {}
    },
    "extracted": {
      "facts": ["瑜伽教练", "注重健康"],
      "goals": ["开设瑜伽工作室"],
      "concerns": ["资金筹备"]
    },
    "life_context": {
      "occupation": {
        "title": "瑜伽教练",
        "industry": "健身"
      },
      "focus_areas": ["health", "career"],
      "goals": [
        {
          "id": "goal-001",
          "title": "每周练习5次瑜伽",
          "category": "health",
          "status": "active",
          "progress": 0.6,
          "created_at": "2026-01-01T00:00:00Z"
        }
      ],
      "tasks": [
        {
          "id": "task-001",
          "title": "准备工作室选址方案",
          "status": "pending",
          "due_date": "2026-02-01",
          "goal_id": null,
          "created_at": "2026-01-15T00:00:00Z"
        }
      ],
      "checkins": {
        "2026-01-19": {
          "mood": 8,
          "energy": 7,
          "notes": "今天很棒"
        },
        "2026-01-18": {
          "mood": 7,
          "energy": 6,
          "notes": "状态不错"
        }
      },
      "reminders": [
        {
          "id": "reminder-001",
          "type": "daily_plan",
          "title": "晨间冥想提醒",
          "schedule_type": "daily",
          "trigger_hour": 7,
          "status": "active",
          "created_at": "2026-01-01T00:00:00Z"
        }
      ],
      "tracking": {
        "last_checkin": "2026-01-19",
        "streak_days": 5
      }
    }
  }'::jsonb, NOW(), NOW()),

  -- 用户3: 最小化 Profile
  ('33333333-3333-3333-3333-333333333333', '{
    "account": {
      "vibe_id": "VB-TEST0003",
      "display_name": "测试用户3",
      "email": "test3@vibelife.com",
      "tier": "free",
      "status": "active"
    },
    "identity": {},
    "state": {},
    "preferences": {
      "voice_mode": "warm",
      "language": "zh-CN",
      "push_enabled": false,
      "subscribed_skills": {
        "core": {
          "status": "subscribed",
          "push_enabled": false,
          "subscribed_at": "2026-01-19T00:00:00Z"
        }
      },
      "push_settings": {
        "default_push_hour": 9,
        "max_daily_pushes": 3
      }
    },
    "skill_data": {},
    "extracted": {},
    "life_context": {
      "goals": [],
      "tasks": [],
      "checkins": {},
      "reminders": []
    }
  }'::jsonb, NOW(), NOW())
ON CONFLICT (user_id) DO UPDATE SET
  profile = EXCLUDED.profile,
  updated_at = NOW();

-- 验证测试数据
SELECT
  u.vibe_id,
  u.display_name,
  u.tier,
  up.profile->'preferences'->>'push_enabled' as push_enabled,
  up.profile->'preferences'->>'push_hour' as push_hour,
  jsonb_array_length(
    COALESCE(
      jsonb_object_keys_array(up.profile->'preferences'->'subscribed_skills'),
      '[]'::jsonb
    )
  ) as subscribed_skills_count
FROM vibe_users u
LEFT JOIN unified_profiles up ON u.id = up.user_id
WHERE u.vibe_id LIKE 'VB-TEST%'
ORDER BY u.vibe_id;
