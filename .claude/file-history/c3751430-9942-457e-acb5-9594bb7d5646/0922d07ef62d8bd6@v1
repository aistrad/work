# VibeLife 部署指南

> **当前部署地址**: http://106.37.170.238:8230/
> **更新日期**: 2026-01-08
> **前端版本**: V4 (AI SDK 6 + Skill 插件系统)
> **状态**: 运行中

## 快速访问

| 功能 | URL |
|------|-----|
| 首页 (Skill选择) | http://106.37.170.238:8230/ |
| 八字 Landing | http://106.37.170.238:8230/bazi |
| 八字 对话 | http://106.37.170.238:8230/bazi/chat |
| 星座 Landing | http://106.37.170.238:8230/zodiac |
| 星座 对话 | http://106.37.170.238:8230/zodiac/chat |
| API 健康检查 | http://106.37.170.238:8230/health |

## 当前架构

```
用户访问 http://106.37.170.238:8230/
                    │
                    ▼
    ┌─────────────────────────────────────┐
    │     Next.js (:8230)                 │
    │  ├── /*           → 前端页面        │
    │  └── /api/v1/*    → rewrites 代理   │
    │      /health      → rewrites 代理   │
    └─────────────────┬───────────────────┘
                      │ (内部代理)
                      ▼
              ┌───────────────┐
              │ FastAPI:8000  │
              │ (内部访问)    │
              └───────┬───────┘
                      │
                      ▼
              ┌─────────────────┐
              │ PostgreSQL:8224 │
              │ + pgvector      │
              └─────────────────┘
```

### 服务端口

| 服务 | 端口 | 说明 |
|------|------|------|
| Next.js | 8230 | 对外统一入口 |
| FastAPI | 8000 | 内部 API (通过 Next.js rewrites 代理) |
| PostgreSQL | 8224 | 数据库 |

## V4 前端架构 (2026-01-08)

### 技术栈

| 组件 | 版本 | 说明 |
|------|------|------|
| AI SDK | 6.x | Vercel AI SDK，Generative UI 支持 |
| Next.js | 14.x | App Router |
| React | 18.x | 客户端组件 |

### Skill 插件系统

```
apps/web/src/skills/
├── types.ts              # 核心类型定义
├── registry.ts           # Skill 注册中心
├── shared-tools.tsx      # 共享 AI 工具
├── shared-panels.ts      # 共享面板
├── bazi/                 # 八字 Skill
│   ├── config.ts
│   ├── tools/            # Generative UI 工具
│   └── panels/
├── zodiac/               # 星座 Skill
│   ├── config.ts
│   ├── tools/
│   └── panels/
└── index.ts              # 统一导出
```

### AI SDK 6 集成

前端支持以下 AI SDK 6 特性：

- **UIMessageStream**: `/api/chat/route.ts` 使用 `createUIMessageStreamResponse`
- **Tool Calling**: 支持 `tool-input-available` 和 `tool-output-available` 事件
- **Generative UI**: `ChatMessage` 组件渲染工具调用结果为 React 组件
- **Tool Approval**: 支持 `needsApproval` 配置和审批 UI

### 后端 Tool 支持（已实现）

后端已实现 Tool Calling 功能，支持以下特性：

**实现模块**:
- `apps/api/services/vibe_engine/llm.py` - LLM 服务扩展，支持 tools 参数
- `apps/api/services/vibe_engine/tools.py` - Tool 定义模块
- `apps/api/routes/chat.py` - Chat 端点集成 tool calling

**Tool 事件格式**:

后端通过 SSE 返回以下事件：

```json
// 文本内容
{"type": "chunk", "content": "..."}

// Tool 调用
{"type": "tool_call", "tool_name": "show_bazi_chart", "tool_call_id": "xxx", "args": {...}}

// 完成标记
{"type": "done", "conversation_id": "...", "skill": "bazi", "voice_mode": "warm"}
```

**可用工具**:
- **共享工具** (4个): show_report, show_relationship, show_insight, request_info
- **八字工具** (3个): show_bazi_chart, show_bazi_fortune, show_bazi_kline
- **星座工具** (3个): show_zodiac_chart, show_zodiac_transit, show_zodiac_synastry

前端会自动将 tool_call 事件转换为 AI SDK 6 格式并渲染对应的 React 组件。

## 目录

- [服务器要求](#服务器要求)
- [数据库部署](#数据库部署)
- [后端 API 部署](#后端-api-部署)
- [前端 Web 部署](#前端-web-部署)
- [反向代理配置](#反向代理配置)
- [域名和 SSL](#域名和-ssl)
- [监控和日志](#监控和日志)
- [故障排查](#故障排查)

## 服务器要求

### 硬件配置

**最小配置（开发/测试）**
- CPU: 2 核
- 内存: 4GB
- 硬盘: 50GB SSD
- 带宽: 5Mbps

**推荐配置（生产环境）**
- CPU: 4 核+
- 内存: 8GB+
- 硬盘: 100GB+ SSD
- 带宽: 10Mbps+

### 软件依赖

```bash
# 操作系统
Ubuntu 20.04+ / CentOS 8+ / Debian 11+

# 运行时
Node.js 18.0.0+
Python 3.11+
PostgreSQL 14+
Redis 6.0+ (可选)

# 工具
pnpm 9.0.0+
Git
Nginx 1.18+
```

## 数据库部署

### PostgreSQL 安装

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y postgresql-14 postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### pgvector 扩展安装

```bash
# 安装编译工具
sudo apt install -y build-essential postgresql-server-dev-14

# 克隆并编译 pgvector
cd /tmp
git clone --branch v0.5.0 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install

# 重启 PostgreSQL
sudo systemctl restart postgresql
```

### 数据库初始化

```bash
# 创建数据库和用户
sudo -u postgres psql <<EOF
CREATE DATABASE vibelife;
CREATE USER vibelife_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE vibelife TO vibelife_user;
\c vibelife
CREATE EXTENSION IF NOT EXISTS vector;
EOF

# 执行迁移脚本
psql -U vibelife_user -d vibelife -f migrations/001_v3_schema.sql
```

### 数据库配置优化

编辑 `/etc/postgresql/14/main/postgresql.conf`:

```conf
# 连接配置
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB

# WAL 配置
wal_level = replica
max_wal_size = 1GB

# 查询优化
random_page_cost = 1.1  # SSD
effective_io_concurrency = 200
```

重启 PostgreSQL:

```bash
sudo systemctl restart postgresql
```

## 后端 API 部署

### 环境准备

```bash
# 安装 Python 和依赖管理工具
sudo apt install -y python3.11 python3.11-venv python3-pip

# 创建项目目录
sudo mkdir -p /opt/vibelife
sudo chown $USER:$USER /opt/vibelife
cd /opt/vibelife

# 克隆项目
git clone https://github.com/aiscendtech/vibelife.git .
```

### Python 虚拟环境

```bash
cd /opt/vibelife/apps/api

# 创建虚拟环境
python3.11 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install --upgrade pip
pip install -r requirements.txt
```

### 环境变量配置

创建 `/opt/vibelife/apps/api/.env`:

```bash
# 数据库
DATABASE_URL=postgresql://vibelife_user:your_secure_password@localhost:5432/vibelife

# LLM 配置
ZHIPU_API_KEY=your_zhipu_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key
DEFAULT_LLM_PROVIDER=zhipu

# 嵌入模型
EMBEDDING_MODEL=bge-m3
EMBEDDING_DIM=1024

# Clerk 认证
CLERK_SECRET_KEY=your_clerk_secret_key

# 支付配置（可选）
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret

# 应用配置
ENVIRONMENT=production
LOG_LEVEL=INFO
CORS_ORIGINS=https://vibelife.app,https://bazi.vibelife.app

# Redis（可选）
REDIS_URL=redis://localhost:6379/0
```

### Systemd 服务配置

创建 `/etc/systemd/system/vibelife-api.service`:

```ini
[Unit]
Description=VibeLife API Service
After=network.target postgresql.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/vibelife/apps/api
Environment="PATH=/opt/vibelife/apps/api/venv/bin"
EnvironmentFile=/opt/vibelife/apps/api/.env
ExecStart=/opt/vibelife/apps/api/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务:

```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start vibelife-api

# 开机自启
sudo systemctl enable vibelife-api

# 查看状态
sudo systemctl status vibelife-api

# 查看日志
sudo journalctl -u vibelife-api -f
```

### 验证 API

```bash
# 检查健康状态
curl http://localhost:8000/health

# 预期输出
# {"status":"ok","service":"vibelife-api","version":"1.0.0","database":"ok"}
```

## 前端 Web 部署

### Node.js 环境

```bash
# 使用 NVM 安装 Node.js
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# 安装 Node.js
nvm install 18
nvm use 18

# 安装 pnpm
npm install -g pnpm@9
```

### 安装依赖

```bash
cd /opt/vibelife

# 安装所有依赖（Monorepo）
pnpm install
```

### 环境变量配置

创建 `/opt/vibelife/apps/web/.env.local`:

```bash
# API 配置
NEXT_PUBLIC_API_URL=http://106.37.170.238:8000
NEXT_PUBLIC_API_BASE=http://106.37.170.238:8000/api/v1

# Clerk 认证（可选）
# 如果不使用 Clerk，请确保代码中已禁用
# NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=your_clerk_publishable_key
```

### 构建生产版本

```bash
cd /opt/vibelife/apps/web

# 构建
NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
NEXT_PUBLIC_API_BASE=http://106.37.170.238:8000/api/v1 \
pnpm build

# 验证构建
ls -la .next/
```

### 启动脚本

创建 `/opt/vibelife/apps/web/start_prod.sh`:

```bash
#!/bin/bash
# VibeLife Frontend Production Server
cd /opt/vibelife/apps/web

export NEXT_PUBLIC_API_URL=http://106.37.170.238:8000
export NEXT_PUBLIC_API_BASE=http://106.37.170.238:8000/api/v1

echo "Starting VibeLife frontend on port 8230..."
exec pnpm start -H 0.0.0.0 -p 8230
```

设置权限:

```bash
chmod +x /opt/vibelife/apps/web/start_prod.sh
```

### Systemd 服务配置

创建 `/etc/systemd/system/vibelife-web.service`:

```ini
[Unit]
Description=VibeLife Web Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/vibelife/apps/web
ExecStart=/opt/vibelife/apps/web/start_prod.sh
Restart=always
RestartSec=10
StandardOutput=append:/var/log/vibelife-web.log
StandardError=append:/var/log/vibelife-web-error.log

[Install]
WantedBy=multi-user.target
```

启动服务:

```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start vibelife-web

# 开机自启
sudo systemctl enable vibelife-web

# 查看状态
sudo systemctl status vibelife-web

# 查看日志
sudo journalctl -u vibelife-web -f
```

### 验证前端

```bash
# 检查端口监听
netstat -tuln | grep 8230

# 测试访问
curl -I http://localhost:8230

# 预期输出
# HTTP/1.1 200 OK
```

## 反向代理配置

### Nginx 安装

```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 主站点配置

创建 `/etc/nginx/sites-available/vibelife`:

```nginx
# API 后端
upstream vibelife_api {
    server 127.0.0.1:8000;
}

# 前端应用
upstream vibelife_web {
    server 127.0.0.1:8230;
}

# HTTP -> HTTPS 重定向
server {
    listen 80;
    server_name vibelife.app *.vibelife.app;
    return 301 https://$host$request_uri;
}

# HTTPS 主站点
server {
    listen 443 ssl http2;
    server_name vibelife.app;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/vibelife.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vibelife.app/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 前端
    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API 路由
    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # 静态资源缓存
    location /_next/static/ {
        proxy_pass http://vibelife_web;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600, immutable";
    }
}

# 子域名配置（bazi, zodiac, mbti 等）
server {
    listen 443 ssl http2;
    server_name bazi.vibelife.app zodiac.vibelife.app mbti.vibelife.app;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/vibelife.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vibelife.app/privkey.pem;

    # 前端
    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API 路由
    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用站点:

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/vibelife /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

### 简化配置（仅 IP 访问）

如果暂不配置域名和 SSL，使用以下简化配置：

创建 `/etc/nginx/sites-available/vibelife-simple`:

```nginx
# 后端代理
upstream vibelife_api {
    server 127.0.0.1:8000;
}

# 前端代理
upstream vibelife_web {
    server 127.0.0.1:8230;
}

server {
    listen 80;
    server_name 106.37.170.238;

    # 前端
    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # API
    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_read_timeout 300s;
    }
}
```

## 域名和 SSL

### Let's Encrypt SSL 证书

```bash
# 安装 certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书（示例）
sudo certbot --nginx -d vibelife.app -d www.vibelife.app \
  -d bazi.vibelife.app -d zodiac.vibelife.app -d mbti.vibelife.app

# 自动续期
sudo certbot renew --dry-run
```

### 域名解析

在 DNS 服务商添加以下记录：

```
A     vibelife.app           -> 106.37.170.238
A     www.vibelife.app       -> 106.37.170.238
A     bazi.vibelife.app      -> 106.37.170.238
A     zodiac.vibelife.app    -> 106.37.170.238
A     mbti.vibelife.app      -> 106.37.170.238
```

## 监控和日志

### 日志位置

```bash
# 后端 API
sudo journalctl -u vibelife-api -f

# 前端 Web
sudo journalctl -u vibelife-web -f
tail -f /var/log/vibelife-web.log

# Nginx
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# PostgreSQL
tail -f /var/log/postgresql/postgresql-14-main.log
```

### 健康检查脚本

创建 `/opt/vibelife/health_check.sh`:

```bash
#!/bin/bash

# 检查 API
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
if [ "$API_STATUS" != "200" ]; then
    echo "API health check failed: $API_STATUS"
    sudo systemctl restart vibelife-api
fi

# 检查前端
WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8230)
if [ "$WEB_STATUS" != "200" ]; then
    echo "Web health check failed: $WEB_STATUS"
    sudo systemctl restart vibelife-web
fi

echo "Health check completed at $(date)"
```

添加到 crontab:

```bash
chmod +x /opt/vibelife/health_check.sh

# 每 5 分钟检查一次
crontab -e
# 添加：
# */5 * * * * /opt/vibelife/health_check.sh >> /var/log/vibelife-health.log 2>&1
```

### 性能监控

```bash
# 安装监控工具
sudo apt install -y htop iotop nethogs

# 实时监控
htop              # CPU/内存
iotop             # 磁盘 I/O
nethogs           # 网络流量

# 进程监控
ps aux | grep -E "(uvicorn|next-server)"
```

## 故障排查

### API 启动失败

**问题**: API 服务无法启动

```bash
# 查看详细日志
sudo journalctl -u vibelife-api -n 100

# 常见原因：
# 1. 数据库连接失败
psql -U vibelife_user -d vibelife -c "SELECT 1;"

# 2. 端口被占用
lsof -i :8000

# 3. 虚拟环境问题
cd /opt/vibelife/apps/api
source venv/bin/activate
python -c "import fastapi; print('OK')"

# 4. 环境变量缺失
cat .env | grep -E "(DATABASE_URL|ZHIPU_API_KEY)"
```

### 前端构建失败

**问题**: Next.js 构建报错

```bash
# 常见问题：
# 1. 缺少依赖
cd /opt/vibelife/apps/web
pnpm install

# 2. TypeScript 错误
pnpm build 2>&1 | grep "error TS"

# 3. 环境变量问题
cat .env.local

# 4. 清理缓存重新构建
rm -rf .next node_modules
pnpm install
pnpm build
```

### Clerk 认证错误

**问题**: Missing publishableKey 错误

**解决方案**:

1. 禁用 Clerk 认证（推荐用于内部部署）

```bash
# 修改 middleware.ts 和 AuthProvider.tsx
# 参考已部署的版本，移除 Clerk 依赖
```

2. 或配置 Clerk 密钥

```bash
# apps/web/.env.local
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
```

### 数据库连接问题

**问题**: 无法连接到 PostgreSQL

```bash
# 检查 PostgreSQL 状态
sudo systemctl status postgresql

# 检查监听端口
sudo netstat -tuln | grep 5432

# 检查连接配置
sudo cat /etc/postgresql/14/main/pg_hba.conf

# 允许本地连接
# local   all             all                                     trust
# host    all             all             127.0.0.1/32            md5

# 重启 PostgreSQL
sudo systemctl restart postgresql
```

### 端口访问问题

**问题**: 外网无法访问服务

```bash
# 检查防火墙
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8230/tcp

# 检查监听地址
netstat -tuln | grep -E "(80|443|8230)"

# 确保绑定 0.0.0.0 而非 127.0.0.1
```

### 性能问题

**问题**: 响应缓慢

```bash
# 检查数据库查询
# 进入 PostgreSQL
sudo -u postgres psql vibelife

# 查看慢查询
SELECT pid, usename, query, state, wait_event_type
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

# 检查索引
SELECT schemaname, tablename, indexname
FROM pg_indexes
WHERE schemaname = 'public';

# 优化建议：
# 1. 添加缓存（Redis）
# 2. 增加 uvicorn workers
# 3. 数据库连接池配置
# 4. CDN 加速静态资源
```

## 更新部署

### 拉取最新代码

```bash
cd /opt/vibelife

# 备份当前版本
git branch backup-$(date +%Y%m%d)

# 拉取更新
git pull origin master
```

### 更新后端

```bash
cd /opt/vibelife/apps/api

# 激活虚拟环境
source venv/bin/activate

# 更新依赖
pip install -r requirements.txt

# 执行数据库迁移（如有）
psql -U vibelife_user -d vibelife -f /path/to/new_migration.sql

# 重启服务
sudo systemctl restart vibelife-api
```

### 更新前端

```bash
cd /opt/vibelife/apps/web

# 更新依赖
pnpm install

# 重新构建
NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
NEXT_PUBLIC_API_BASE=http://106.37.170.238:8000/api/v1 \
pnpm build

# 重启服务
sudo systemctl restart vibelife-web
```

## 安全建议

1. **定期更新**
   - 及时更新系统补丁
   - 升级依赖包版本

2. **密钥管理**
   - 使用强密码
   - 定期轮换 API 密钥
   - 不要将 .env 文件提交到 Git

3. **访问控制**
   - 配置防火墙规则
   - 限制数据库访问
   - 使用 fail2ban 防止暴力攻击

4. **备份策略**
   - 每日数据库备份
   - 定期全量备份
   - 异地备份存储

5. **监控告警**
   - 设置性能监控
   - 配置错误告警
   - 监控磁盘空间

## 快速部署总结

当前生产环境配置:

| 服务 | 地址 | 说明 |
|------|------|------|
| 前端 Web | http://106.37.170.238:8230 | Next.js 应用 |
| 后端 API | http://106.37.170.238:8000 | FastAPI 应用 |
| 数据库 | localhost:5432 | PostgreSQL |

服务管理命令:

```bash
# 查看所有服务状态
sudo systemctl status vibelife-api vibelife-web

# 重启所有服务
sudo systemctl restart vibelife-api vibelife-web nginx

# 查看日志
sudo journalctl -u vibelife-api -u vibelife-web -f
```

---

如有问题，请联系技术支持：tech@aiscend.tech
