"""
Tool Definitions for AI Function Calling
Based on: vibelife spec v4.0 (AI SDK 6 integration)

This module defines tools that can be called by the LLM during chat.
Tool definitions follow OpenAI function calling format, compatible with Zhipu GLM API.
"""

from typing import List, Dict, Any, Optional
from enum import Enum


class ToolCategory(str, Enum):
    """Tool categories"""
    SHARED = "shared"
    BAZI = "bazi"
    ZODIAC = "zodiac"
    MBTI = "mbti"


# ═══════════════════════════════════════════════════════════════════════════
# Shared Tools - Available to all skills
# ═══════════════════════════════════════════════════════════════════════════

SHOW_REPORT_TOOL = {
    "type": "function",
    "function": {
        "name": "show_report",
        "description": "展示用户的完整报告。当用户想查看报告或需要生成新报告时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "reportId": {
                    "type": "string",
                    "description": "Report ID to display (optional, defaults to latest)"
                },
                "reportType": {
                    "type": "string",
                    "enum": ["lite", "full"],
                    "description": "Report type (lite or full)",
                    "default": "lite"
                }
            }
        }
    }
}

SHOW_RELATIONSHIP_TOOL = {
    "type": "function",
    "function": {
        "name": "show_relationship",
        "description": "展示关系分析结果。当用户想分析与他人的关系兼容性时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "relationshipId": {
                    "type": "string",
                    "description": "Relationship analysis ID (optional)"
                },
                "partnerInfo": {
                    "type": "object",
                    "description": "Partner information for new analysis",
                    "properties": {
                        "name": {"type": "string", "description": "Partner name"},
                        "birthDate": {"type": "string", "description": "Partner birth date (YYYY-MM-DD)"}
                    }
                }
            }
        }
    }
}

SHOW_INSIGHT_TOOL = {
    "type": "function",
    "function": {
        "name": "show_insight",
        "description": "展示洞察卡片。当用户需要看到关键洞察或建议时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "insightId": {
                    "type": "string",
                    "description": "Specific insight ID (optional)"
                },
                "category": {
                    "type": "string",
                    "description": "Insight category (optional)"
                }
            }
        }
    }
}

REQUEST_INFO_TOOL = {
    "type": "function",
    "function": {
        "name": "request_info",
        "description": "向用户请求更多信息以提供更准确的分析。当需要用户补充出生信息、当前困境或目标时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "infoType": {
                    "type": "string",
                    "enum": ["birth", "context", "goals", "concerns"],
                    "description": "Type of information to request"
                },
                "question": {
                    "type": "string",
                    "description": "Custom question to ask (optional)"
                }
            },
            "required": ["infoType"]
        }
    }
}


# ═══════════════════════════════════════════════════════════════════════════
# BaZi Skill Tools
# ═══════════════════════════════════════════════════════════════════════════

SHOW_BAZI_CHART_TOOL = {
    "type": "function",
    "function": {
        "name": "show_bazi_chart",
        "description": "展示用户的八字命盘，包括四柱、日主、五行分布和十神关系。当用户想要查看自己的八字、命盘或想了解基本命理信息时调用此工具。",
        "parameters": {
            "type": "object",
            "properties": {
                "userId": {
                    "type": "string",
                    "description": "User ID (optional, uses current user if not provided)"
                },
                "showDetails": {
                    "type": "boolean",
                    "description": "Show detailed analysis",
                    "default": True
                }
            }
        }
    }
}

SHOW_BAZI_FORTUNE_TOOL = {
    "type": "function",
    "function": {
        "name": "show_bazi_fortune",
        "description": "展示用户的大运流年分析，包括当前大运、今年流年运势和关键建议。当用户问'今年运势'、'大运'、'流年'或想了解特定年份运势时调用此工具。",
        "parameters": {
            "type": "object",
            "properties": {
                "userId": {
                    "type": "string",
                    "description": "User ID (optional)"
                },
                "year": {
                    "type": "integer",
                    "description": "Specific year to analyze (optional)"
                },
                "includePast": {
                    "type": "boolean",
                    "description": "Include past luck cycles",
                    "default": False
                }
            }
        }
    }
}

SHOW_KLINE_TOOL = {
    "type": "function",
    "function": {
        "name": "show_bazi_kline",
        "description": "展示用户的运势 K 线图。当用户想要可视化查看运势变化趋势时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "userId": {
                    "type": "string",
                    "description": "User ID (optional)"
                },
                "startYear": {
                    "type": "integer",
                    "description": "Start year for K-line chart (optional)"
                },
                "endYear": {
                    "type": "integer",
                    "description": "End year for K-line chart (optional)"
                }
            }
        }
    }
}


# ═══════════════════════════════════════════════════════════════════════════
# Zodiac Skill Tools
# ═══════════════════════════════════════════════════════════════════════════

SHOW_ZODIAC_CHART_TOOL = {
    "type": "function",
    "function": {
        "name": "show_zodiac_chart",
        "description": "展示用户的星盘（本命盘）。当用户想要查看自己的星座命盘或行星位置时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "userId": {
                    "type": "string",
                    "description": "User ID (optional)"
                },
                "showAspects": {
                    "type": "boolean",
                    "description": "Show planetary aspects",
                    "default": True
                }
            }
        }
    }
}

SHOW_TRANSIT_TOOL = {
    "type": "function",
    "function": {
        "name": "show_zodiac_transit",
        "description": "展示行运分析。当用户想了解当前或特定时期的行星运行对自己的影响时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "userId": {
                    "type": "string",
                    "description": "User ID (optional)"
                },
                "date": {
                    "type": "string",
                    "description": "Date for transit analysis (YYYY-MM-DD, optional)"
                }
            }
        }
    }
}

SHOW_SYNASTRY_TOOL = {
    "type": "function",
    "function": {
        "name": "show_zodiac_synastry",
        "description": "展示合盘分析（两人星盘对比）。当用户想分析与他人的星座兼容性时调用。",
        "parameters": {
            "type": "object",
            "properties": {
                "userId": {
                    "type": "string",
                    "description": "User ID (optional)"
                },
                "partnerId": {
                    "type": "string",
                    "description": "Partner user ID (optional)"
                },
                "partnerBirthInfo": {
                    "type": "object",
                    "description": "Partner birth information",
                    "properties": {
                        "date": {"type": "string", "description": "Birth date (YYYY-MM-DD)"},
                        "time": {"type": "string", "description": "Birth time (HH:MM)"},
                        "location": {"type": "string", "description": "Birth location"}
                    }
                }
            }
        }
    }
}


# ═══════════════════════════════════════════════════════════════════════════
# Tool Registry
# ═══════════════════════════════════════════════════════════════════════════

# Shared tools available to all skills
SHARED_TOOLS = [
    SHOW_REPORT_TOOL,
    SHOW_RELATIONSHIP_TOOL,
    SHOW_INSIGHT_TOOL,
    REQUEST_INFO_TOOL,
]

# Skill-specific tools
BAZI_TOOLS = [
    SHOW_BAZI_CHART_TOOL,
    SHOW_BAZI_FORTUNE_TOOL,
    SHOW_KLINE_TOOL,
]

ZODIAC_TOOLS = [
    SHOW_ZODIAC_CHART_TOOL,
    SHOW_TRANSIT_TOOL,
    SHOW_SYNASTRY_TOOL,
]

MBTI_TOOLS = []  # TODO: Add MBTI-specific tools


def get_tools_for_skill(skill: str) -> List[Dict[str, Any]]:
    """
    Get all available tools for a specific skill.

    Args:
        skill: Skill name ('bazi', 'zodiac', 'mbti', etc.)

    Returns:
        List of tool definitions in OpenAI function calling format
    """
    tools = SHARED_TOOLS.copy()

    skill_lower = skill.lower()
    if skill_lower in ("bazi", "八字"):
        tools.extend(BAZI_TOOLS)
    elif skill_lower in ("zodiac", "星座"):
        tools.extend(ZODIAC_TOOLS)
    elif skill_lower in ("mbti",):
        tools.extend(MBTI_TOOLS)

    return tools


def get_all_tools() -> List[Dict[str, Any]]:
    """Get all available tools across all skills"""
    return SHARED_TOOLS + BAZI_TOOLS + ZODIAC_TOOLS + MBTI_TOOLS


def get_tool_by_name(tool_name: str) -> Optional[Dict[str, Any]]:
    """Get a tool definition by name"""
    all_tools = get_all_tools()
    for tool in all_tools:
        if tool["function"]["name"] == tool_name:
            return tool
    return None
