"""
Test Tool Calling Functionality
Tests the tool calling integration between LLM service and chat endpoints
"""

import asyncio
import sys
import os

# Add parent directory to path
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from services.vibe_engine import (
    get_llm_service,
    create_user_message,
    get_tools_for_skill,
)


async def test_tool_definitions():
    """Test that tool definitions are loaded correctly"""
    print("=" * 60)
    print("Test 1: Tool Definitions")
    print("=" * 60)

    # Get tools for bazi skill
    bazi_tools = get_tools_for_skill("bazi")
    print(f"\nBazi skill has {len(bazi_tools)} tools:")
    for tool in bazi_tools:
        tool_name = tool["function"]["name"]
        tool_desc = tool["function"]["description"]
        print(f"  - {tool_name}: {tool_desc[:50]}...")

    # Get tools for zodiac skill
    zodiac_tools = get_tools_for_skill("zodiac")
    print(f"\nZodiac skill has {len(zodiac_tools)} tools:")
    for tool in zodiac_tools:
        tool_name = tool["function"]["name"]
        tool_desc = tool["function"]["description"]
        print(f"  - {tool_name}: {tool_desc[:50]}...")

    print("\n‚úÖ Tool definitions loaded successfully\n")


async def test_llm_tool_calling():
    """Test LLM service with tool calling"""
    print("=" * 60)
    print("Test 2: LLM Tool Calling")
    print("=" * 60)

    llm = get_llm_service()

    # Create a message that should trigger a tool call
    messages = [
        create_user_message("ËØ∑Â∏ÆÊàëÂ±ïÁ§∫‰∏Ä‰∏ãÊàëÁöÑÂÖ´Â≠óÂëΩÁõò")
    ]

    # Get tools for bazi
    tools = get_tools_for_skill("bazi")

    print("\nSending message to LLM with tools...")
    print(f"Tools available: {len(tools)}")

    # Test streaming
    print("\nStreaming response:")
    print("-" * 40)

    try:
        chunk_count = 0
        tool_call_count = 0

        async for chunk in llm.stream(messages, tools=tools, max_tokens=500):
            chunk_type = chunk.get("type")

            if chunk_type == "content":
                content = chunk.get("content", "")
                print(content, end="", flush=True)
                chunk_count += 1

            elif chunk_type == "tool_call":
                tool_call_count += 1
                print(f"\n\n[Tool Call #{tool_call_count}]")
                print(f"  ID: {chunk.get('tool_call_id')}")
                print(f"  Name: {chunk.get('tool_name')}")
                print(f"  Args: {chunk.get('tool_args')}")

        print(f"\n\n‚úÖ Test completed: {chunk_count} content chunks, {tool_call_count} tool calls\n")

    except Exception as e:
        print(f"\n‚ùå Error during streaming: {e}\n")
        import traceback
        traceback.print_exc()


async def test_simple_stream():
    """Test simple streaming without expecting tool calls"""
    print("=" * 60)
    print("Test 3: Simple Stream (No Tool Call Expected)")
    print("=" * 60)

    llm = get_llm_service()

    messages = [
        create_user_message("‰Ω†Â•ΩÔºåËØ∑ÁÆÄÂçï‰ªãÁªç‰∏Ä‰∏ãÂÖ´Â≠óÂëΩÁêÜ„ÄÇ")
    ]

    tools = get_tools_for_skill("bazi")

    print("\nStreaming response:")
    print("-" * 40)

    try:
        async for chunk in llm.stream(messages, tools=tools, max_tokens=200):
            chunk_type = chunk.get("type")

            if chunk_type == "content":
                content = chunk.get("content", "")
                print(content, end="", flush=True)
            elif chunk_type == "tool_call":
                print(f"\n\n[Unexpected Tool Call]")
                print(f"  Name: {chunk.get('tool_name')}")

        print("\n\n‚úÖ Simple stream completed\n")

    except Exception as e:
        print(f"\n‚ùå Error: {e}\n")


async def main():
    """Run all tests"""
    print("\nüß™ Starting Tool Calling Tests\n")

    # Test 1: Tool definitions
    await test_tool_definitions()

    # Test 2: LLM tool calling
    await test_llm_tool_calling()

    # Test 3: Simple stream
    await test_simple_stream()

    print("=" * 60)
    print("All tests completed!")
    print("=" * 60)


if __name__ == "__main__":
    # Check if API keys are set
    if not os.getenv("ZHIPU_API_KEY") and not os.getenv("GLM_API_KEY"):
        print("‚ùå Error: ZHIPU_API_KEY or GLM_API_KEY environment variable not set")
        print("Please set your Zhipu API key:")
        print("  export ZHIPU_API_KEY=your_key_here")
        sys.exit(1)

    asyncio.run(main())
