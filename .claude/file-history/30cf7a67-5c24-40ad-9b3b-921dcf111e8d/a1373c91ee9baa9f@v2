"use client"

import { useMemo } from "react"
import { motion } from "framer-motion"
import {
  Sparkles,
  Heart,
  TrendingUp,
  BarChart3,
  HelpCircle,
  Wand2,
  Brain,
  Target
} from "lucide-react"
import { cn } from "@/lib/utils"

export interface CommandOption {
  command: string
  label: string
  labelCn: string
  description: string
  icon: typeof Sparkles
  color?: string
}

export const COMMANDS: CommandOption[] = [
  {
    command: "divine",
    label: "Metaphysics",
    labelCn: "玄学测算",
    description: "八字 · 紫微 · 塔罗 · 星座",
    icon: Wand2,
    color: "text-perma-a",
  },
  {
    command: "heal",
    label: "Psychology",
    labelCn: "心理疗愈",
    description: "情绪打卡 · CBT 认知重构",
    icon: Heart,
    color: "text-perma-r",
  },
  {
    command: "grow",
    label: "Growth",
    labelCn: "成长教练",
    description: "目标设定 · 任务管理 · 周复盘",
    icon: TrendingUp,
    color: "text-perma-p",
  },
  {
    command: "status",
    label: "Status",
    labelCn: "状态查看",
    description: "当前状态 · 趋势分析",
    icon: BarChart3,
    color: "text-perma-e",
  },
  {
    command: "help",
    label: "Help",
    labelCn: "帮助",
    description: "查看所有可用指令",
    icon: HelpCircle,
    color: "text-foreground-muted",
  },
]

interface CommandPaletteProps {
  filter: string
  selectedIndex?: number
  onSelect: (cmd: CommandOption) => void
  onClose: () => void
  className?: string
}

export function CommandPalette({
  filter,
  selectedIndex = 0,
  onSelect,
  onClose,
  className,
}: CommandPaletteProps) {
  const filtered = useMemo(() => {
    if (!filter) return COMMANDS
    const lowerFilter = filter.toLowerCase()
    return COMMANDS.filter(
      (cmd) =>
        cmd.command.toLowerCase().includes(lowerFilter) ||
        cmd.label.toLowerCase().includes(lowerFilter) ||
        cmd.labelCn.includes(filter)
    )
  }, [filter])

  if (filtered.length === 0) {
    return (
      <motion.div
        className={cn(
          "p-4 rounded-xl",
          "bg-card border border-border",
          "shadow-floating",
          className
        )}
        initial={{ opacity: 0, y: 8, scale: 0.96 }}
        animate={{ opacity: 1, y: 0, scale: 1 }}
        exit={{ opacity: 0, y: 8, scale: 0.96 }}
        transition={{ duration: 0.15, ease: [0.16, 1, 0.3, 1] }}
      >
        <p className="text-sm text-foreground-muted text-center">
          No commands found
        </p>
      </motion.div>
    )
  }

  return (
    <motion.div
      className={cn(
        "py-2 rounded-xl",
        "bg-card border border-border",
        "shadow-floating",
        "overflow-hidden",
        className
      )}
      initial={{ opacity: 0, y: 8, scale: 0.96 }}
      animate={{ opacity: 1, y: 0, scale: 1 }}
      exit={{ opacity: 0, y: 8, scale: 0.96 }}
      transition={{ duration: 0.15, ease: [0.16, 1, 0.3, 1] }}
    >
      {/* Header */}
      <div className="px-3 pb-2 mb-1 border-b border-border">
        <p className="text-xs font-medium text-foreground-muted uppercase tracking-wider">
          Commands
        </p>
      </div>

      {/* Command list */}
      <div className="max-h-72 overflow-y-auto scrollbar-thin">
        {filtered.map((cmd, index) => {
          const Icon = cmd.icon
          const isSelected = index === selectedIndex

          return (
            <button
              key={cmd.command}
              onClick={() => onSelect(cmd)}
              className={cn(
                "w-full flex items-center gap-3",
                "px-3 py-2.5",
                "text-left",
                "transition-colors duration-100",
                "focus:outline-none",
                isSelected
                  ? "bg-accent-muted"
                  : "hover:bg-background-subtle"
              )}
              data-selected={isSelected}
            >
              {/* Icon */}
              <div
                className={cn(
                  "flex-shrink-0 w-9 h-9 rounded-lg",
                  "flex items-center justify-center",
                  "bg-background-subtle",
                  cmd.color || "text-foreground-muted"
                )}
              >
                <Icon className="w-4.5 h-4.5" />
              </div>

              {/* Content */}
              <div className="flex-1 min-w-0">
                <div className="flex items-baseline gap-2">
                  <span className="font-mono text-sm font-medium text-foreground">
                    /{cmd.command}
                  </span>
                  <span className="text-sm text-foreground-muted">
                    {cmd.labelCn}
                  </span>
                </div>
                <p className="text-xs text-foreground-subtle truncate mt-0.5">
                  {cmd.description}
                </p>
              </div>

              {/* Keyboard hint */}
              {isSelected && (
                <div className="flex-shrink-0 text-xs text-foreground-subtle">
                  Enter ↵
                </div>
              )}
            </button>
          )
        })}
      </div>

      {/* Footer hint */}
      <div className="px-3 pt-2 mt-1 border-t border-border">
        <p className="text-xs text-foreground-subtle">
          ↑↓ Navigate · Enter Select · Esc Close
        </p>
      </div>
    </motion.div>
  )
}
