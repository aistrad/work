'use client'

/**
 * Landing Step - Stage 1
 *
 * 单页表单：键盘输入生辰信息 + 关注点选择
 * 设计要点：5秒内让用户开始输入，零摩擦进入体验
 */

import { useState, useCallback, useRef, useEffect } from 'react'
import { motion } from 'framer-motion'
import { ArrowRight, Sparkles } from 'lucide-react'
import { useOnboarding } from '../context'
import { CONCERNS, type ConcernType, type BirthInfo } from '../types'

export default function LandingStep() {
  const { setBirthInfo, setConcerns, nextStep } = useOnboarding()

  // Birth info state
  const [year, setYear] = useState('')
  const [month, setMonth] = useState('')
  const [day, setDay] = useState('')
  const [hour, setHour] = useState('')

  // Concerns selection
  const [selectedConcerns, setSelectedConcerns] = useState<ConcernType[]>([])

  // Refs for auto-focus
  const monthRef = useRef<HTMLInputElement>(null)
  const dayRef = useRef<HTMLInputElement>(null)
  const hourRef = useRef<HTMLInputElement>(null)

  // Validation
  const isYearValid = year.length === 4 && parseInt(year) >= 1900 && parseInt(year) <= new Date().getFullYear()
  const isMonthValid = month.length >= 1 && parseInt(month) >= 1 && parseInt(month) <= 12
  const isDayValid = day.length >= 1 && parseInt(day) >= 1 && parseInt(day) <= 31
  const isFormValid = isYearValid && isMonthValid && isDayValid

  // Auto-advance to next field
  useEffect(() => {
    if (year.length === 4 && isYearValid) {
      monthRef.current?.focus()
    }
  }, [year, isYearValid])

  useEffect(() => {
    if (month.length === 2 && isMonthValid) {
      dayRef.current?.focus()
    }
  }, [month, isMonthValid])

  useEffect(() => {
    if (day.length === 2 && isDayValid) {
      hourRef.current?.focus()
    }
  }, [day, isDayValid])

  // Concern toggle
  const toggleConcern = useCallback((concernId: ConcernType) => {
    setSelectedConcerns(prev =>
      prev.includes(concernId)
        ? prev.filter(c => c !== concernId)
        : [...prev, concernId]
    )
  }, [])

  // Submit handler
  const handleSubmit = useCallback(() => {
    if (!isFormValid) return

    const birthInfo: BirthInfo = {
      year: parseInt(year),
      month: parseInt(month),
      day: parseInt(day),
      hour: hour ? parseInt(hour) : null,
    }

    setBirthInfo(birthInfo)
    setConcerns(selectedConcerns)
    nextStep()
  }, [year, month, day, hour, selectedConcerns, isFormValid, setBirthInfo, setConcerns, nextStep])

  // Handle keyboard submit
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && isFormValid) {
      handleSubmit()
    }
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -20 }}
      className="w-full max-w-md"
    >
      {/* Title */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
        className="text-center mb-8"
      >
        <h1 className="font-serif text-3xl md:text-4xl font-bold text-foreground mb-3">
          让每个人都能被深度理解
        </h1>
        <p className="text-muted-foreground">
          输入你的出生时间，开启探索之旅
        </p>
      </motion.div>

      {/* Form Card */}
      <motion.div
        initial={{ opacity: 0, scale: 0.98 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ delay: 0.2 }}
        className="bg-card/80 backdrop-blur-sm border border-border rounded-2xl p-6 shadow-lg"
      >
        {/* Birth Info Section */}
        <div className="mb-6">
          <label className="block text-sm font-medium text-foreground mb-3">
            你的出生时间
          </label>

          <div className="flex items-center gap-2" onKeyDown={handleKeyDown}>
            {/* Year */}
            <div className="flex-1">
              <input
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                maxLength={4}
                placeholder="1990"
                value={year}
                onChange={e => setYear(e.target.value.replace(/\D/g, '').slice(0, 4))}
                className="w-full px-3 py-3 bg-background border border-border rounded-xl text-center text-lg font-medium focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary transition-all"
                autoFocus
              />
              <span className="block text-xs text-muted-foreground text-center mt-1">年</span>
            </div>

            {/* Month */}
            <div className="w-20">
              <input
                ref={monthRef}
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                maxLength={2}
                placeholder="03"
                value={month}
                onChange={e => setMonth(e.target.value.replace(/\D/g, '').slice(0, 2))}
                className="w-full px-3 py-3 bg-background border border-border rounded-xl text-center text-lg font-medium focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary transition-all"
              />
              <span className="block text-xs text-muted-foreground text-center mt-1">月</span>
            </div>

            {/* Day */}
            <div className="w-20">
              <input
                ref={dayRef}
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                maxLength={2}
                placeholder="15"
                value={day}
                onChange={e => setDay(e.target.value.replace(/\D/g, '').slice(0, 2))}
                className="w-full px-3 py-3 bg-background border border-border rounded-xl text-center text-lg font-medium focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary transition-all"
              />
              <span className="block text-xs text-muted-foreground text-center mt-1">日</span>
            </div>

            {/* Hour (Optional) */}
            <div className="w-20">
              <input
                ref={hourRef}
                type="text"
                inputMode="numeric"
                pattern="[0-9]*"
                maxLength={2}
                placeholder="08"
                value={hour}
                onChange={e => setHour(e.target.value.replace(/\D/g, '').slice(0, 2))}
                className="w-full px-3 py-3 bg-background border border-border rounded-xl text-center text-lg font-medium focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary transition-all"
              />
              <span className="block text-xs text-muted-foreground text-center mt-1">时</span>
            </div>
          </div>

          <p className="text-xs text-muted-foreground/70 mt-2">
            出生时辰可选，不知道可以留空
          </p>
        </div>

        {/* Divider */}
        <div className="border-t border-border my-6" />

        {/* Concerns Section */}
        <div className="mb-6">
          <label className="block text-sm font-medium text-foreground mb-3">
            你现在最关心什么？
            <span className="text-muted-foreground/70 font-normal ml-1">（可选）</span>
          </label>

          <div className="flex flex-wrap gap-2">
            {CONCERNS.map((concern, index) => (
              <motion.button
                key={concern.id}
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{ delay: 0.3 + index * 0.05 }}
                onClick={() => toggleConcern(concern.id)}
                className={`
                  px-4 py-2 rounded-full text-sm font-medium transition-all duration-200
                  ${selectedConcerns.includes(concern.id)
                    ? 'bg-skill-primary text-white shadow-md'
                    : 'bg-background border border-border text-muted-foreground hover:border-skill-primary/50 hover:text-foreground'
                  }
                `}
              >
                <span className="mr-1.5">{concern.icon}</span>
                {concern.label}
              </motion.button>
            ))}
          </div>
        </div>

        {/* Submit Button */}
        <motion.button
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
          onClick={handleSubmit}
          disabled={!isFormValid}
          className={`
            w-full py-4 rounded-xl font-medium text-lg flex items-center justify-center gap-2 transition-all duration-300
            ${isFormValid
              ? 'bg-skill-primary text-white shadow-lg hover:shadow-xl hover:-translate-y-0.5'
              : 'bg-muted text-muted-foreground cursor-not-allowed'
            }
          `}
        >
          <Sparkles className="w-5 h-5" />
          看见我自己
          <ArrowRight className="w-5 h-5" />
        </motion.button>
      </motion.div>

      {/* Social Proof */}
      <motion.p
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.7 }}
        className="text-center text-sm text-muted-foreground/60 mt-6"
      >
        已有 12,847 人在这里找到了自己
      </motion.p>
    </motion.div>
  )
}
