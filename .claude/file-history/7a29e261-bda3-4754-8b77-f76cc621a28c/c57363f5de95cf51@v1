'use client'

/**
 * Interview Step - Stage 5
 *
 * 深度访谈：展示推理过程 + 选择题 + 开放补充
 * 目标：建立情感连接，收集个性化信息
 */

import { useState, useCallback } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { ArrowRight, Check, Sparkles } from 'lucide-react'
import { useOnboarding } from '../context'
import { PERSONAS, type InterviewAnswer } from '../types'

// 访谈问题配置（基于命盘生成的问题）
interface Question {
  id: string
  reasoning: string[]  // 推理步骤
  questionText: string
  options: Array<{ id: string; text: string }>
  allowMultiple: boolean
  openInputPlaceholder: string
}

// 根据日主生成问题
const generateQuestions = (dayMaster: string, dayMasterElement: string): Question[] => {
  const elementTraits: Record<string, { pattern: string; contrast: string }> = {
    '木': { pattern: '向上生长', contrast: '扎根稳定' },
    '火': { pattern: '热情表达', contrast: '内敛沉稳' },
    '土': { pattern: '稳重踏实', contrast: '灵活变通' },
    '金': { pattern: '决断果敢', contrast: '柔和包容' },
    '水': { pattern: '灵活变化', contrast: '坚定专注' },
  }

  const trait = elementTraits[dayMasterElement] || elementTraits['木']

  return [
    {
      id: 'q1_pattern',
      reasoning: [
        `${dayMaster}${dayMasterElement}日主，${dayMasterElement === '木' ? '偏印格' : '正官格'}`,
        `${dayMasterElement}旺于${dayMasterElement === '木' ? '春' : '夏'}，但今年流年土重`,
        `土克水，水生${dayMasterElement}受阻`,
        `你最近是否感到「想要${trait.pattern}但被压制」的感觉？`,
      ],
      questionText: `在关系中，你是否常常感到：`,
      options: [
        { id: 'security', text: '需要深深扎根的安全感' },
        { id: 'freedom', text: '渴望自由向上生长的空间' },
        { id: 'support', text: '想要被滋养和支持' },
        { id: 'all', text: '以上都有' },
      ],
      allowMultiple: false,
      openInputPlaceholder: '比如最近发生了什么让你有这种感觉...',
    },
    {
      id: 'q2_current',
      reasoning: [
        `结合你选择的「关注点」分析`,
        `${dayMasterElement}气在此时需要${trait.contrast}的平衡`,
        `这个时期的挑战往往指向成长方向`,
      ],
      questionText: `最近有什么事情让你感到困扰或不安吗？`,
      options: [
        { id: 'work', text: '工作压力或职业方向' },
        { id: 'relationship', text: '感情或人际关系' },
        { id: 'self', text: '自我认知或人生方向' },
        { id: 'other', text: '其他方面' },
      ],
      allowMultiple: true,
      openInputPlaceholder: '可以具体说说是什么事情...',
    },
  ]
}

export default function InterviewStep() {
  const { state, addInterviewAnswer, nextStep } = useOnboarding()
  const { baziData, persona } = state

  // Generate questions based on bazi data
  const questions = generateQuestions(
    baziData?.dayMaster || '甲',
    baziData?.dayMasterElement || '木'
  )

  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0)
  const [selectedOptions, setSelectedOptions] = useState<string[]>([])
  const [openAnswer, setOpenAnswer] = useState('')
  const [showReasoning, setShowReasoning] = useState(true)
  const [reasoningStep, setReasoningStep] = useState(0)

  const currentQuestion = questions[currentQuestionIndex]
  const personaConfig = persona ? PERSONAS[persona] : PERSONAS.warm
  const isLastQuestion = currentQuestionIndex === questions.length - 1

  // Reasoning animation
  useState(() => {
    if (showReasoning) {
      const timer = setInterval(() => {
        setReasoningStep(prev => {
          if (prev >= currentQuestion.reasoning.length - 1) {
            clearInterval(timer)
            setShowReasoning(false)
            return prev
          }
          return prev + 1
        })
      }, 800)
      return () => clearInterval(timer)
    }
  })

  // Option selection
  const toggleOption = useCallback((optionId: string) => {
    if (currentQuestion.allowMultiple) {
      setSelectedOptions(prev =>
        prev.includes(optionId)
          ? prev.filter(id => id !== optionId)
          : [...prev, optionId]
      )
    } else {
      setSelectedOptions([optionId])
    }
  }, [currentQuestion.allowMultiple])

  // Submit answer
  const handleSubmit = useCallback(() => {
    if (selectedOptions.length === 0) return

    const answer: InterviewAnswer = {
      questionId: currentQuestion.id,
      questionText: currentQuestion.questionText,
      selectedOptions,
      openAnswer,
    }

    addInterviewAnswer(answer)

    if (isLastQuestion) {
      nextStep()
    } else {
      // Reset for next question
      setCurrentQuestionIndex(prev => prev + 1)
      setSelectedOptions([])
      setOpenAnswer('')
      setShowReasoning(true)
      setReasoningStep(0)
    }
  }, [currentQuestion, selectedOptions, openAnswer, isLastQuestion, addInterviewAnswer, nextStep])

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="w-full max-w-lg"
    >
      {/* Persona Header */}
      <motion.div
        initial={{ opacity: 0, y: -10 }}
        animate={{ opacity: 1, y: 0 }}
        className="flex items-center gap-3 mb-6 p-4 bg-card/80 rounded-xl border border-border"
      >
        <div className="text-2xl">{personaConfig.icon}</div>
        <div>
          <p className="font-medium text-foreground">{personaConfig.name}</p>
          <p className="text-xs text-muted-foreground">正在分析你的命盘...</p>
        </div>
      </motion.div>

      {/* Progress */}
      <div className="mb-6">
        <div className="flex justify-between text-xs text-muted-foreground mb-2">
          <span>问题 {currentQuestionIndex + 1} / {questions.length}</span>
        </div>
        <div className="h-1.5 bg-muted/30 rounded-full overflow-hidden">
          <motion.div
            className="h-full bg-skill-primary rounded-full"
            initial={{ width: 0 }}
            animate={{ width: `${((currentQuestionIndex + 1) / questions.length) * 100}%` }}
          />
        </div>
      </div>

      {/* Main Card */}
      <motion.div
        key={currentQuestion.id}
        initial={{ opacity: 0, x: 20 }}
        animate={{ opacity: 1, x: 0 }}
        exit={{ opacity: 0, x: -20 }}
        className="bg-card/80 backdrop-blur-sm border border-border rounded-2xl p-6"
      >
        {/* Reasoning Box */}
        <AnimatePresence mode="wait">
          {showReasoning && (
            <motion.div
              initial={{ opacity: 0, height: 0 }}
              animate={{ opacity: 1, height: 'auto' }}
              exit={{ opacity: 0, height: 0 }}
              className="mb-6 p-4 bg-skill-primary/5 border border-skill-primary/20 rounded-xl"
            >
              <p className="text-xs text-muted-foreground mb-2 flex items-center gap-1">
                <Sparkles className="w-3 h-3" />
                推理过程：
              </p>
              <div className="space-y-1.5">
                {currentQuestion.reasoning.slice(0, reasoningStep + 1).map((step, index) => (
                  <motion.p
                    key={index}
                    initial={{ opacity: 0, x: -10 }}
                    animate={{ opacity: 1, x: 0 }}
                    className={`text-sm ${
                      index === reasoningStep
                        ? 'text-skill-primary font-medium'
                        : 'text-muted-foreground'
                    }`}
                  >
                    {index < currentQuestion.reasoning.length - 1 ? '✓' : '→'} {step}
                  </motion.p>
                ))}
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Question */}
        <motion.h3
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: showReasoning ? 0 : 0.2 }}
          className="text-lg font-medium text-foreground mb-4"
        >
          {currentQuestion.questionText}
        </motion.h3>

        {/* Options */}
        <div className="space-y-2 mb-6">
          {currentQuestion.options.map((option, index) => {
            const isSelected = selectedOptions.includes(option.id)
            return (
              <motion.button
                key={option.id}
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ delay: (showReasoning ? 0 : 0.3) + index * 0.05 }}
                onClick={() => toggleOption(option.id)}
                className={`
                  w-full p-4 rounded-xl text-left transition-all duration-200 flex items-center gap-3
                  ${isSelected
                    ? 'bg-skill-primary/10 border-2 border-skill-primary text-foreground'
                    : 'bg-background border-2 border-border text-muted-foreground hover:border-skill-primary/50'
                  }
                `}
              >
                <div className={`
                  w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0
                  ${isSelected
                    ? 'bg-skill-primary border-skill-primary'
                    : 'border-muted-foreground/30'
                  }
                `}>
                  {isSelected && <Check className="w-3 h-3 text-white" />}
                </div>
                <span>{option.text}</span>
              </motion.button>
            )
          })}
        </div>

        {/* Open Input */}
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.5 }}
        >
          <p className="text-sm text-muted-foreground mb-2">
            想补充说说吗？
          </p>
          <textarea
            value={openAnswer}
            onChange={e => setOpenAnswer(e.target.value)}
            placeholder={currentQuestion.openInputPlaceholder}
            className="w-full h-24 px-4 py-3 bg-background border border-border rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-skill-primary/50 focus:border-skill-primary text-foreground placeholder:text-muted-foreground/50"
          />
        </motion.div>
      </motion.div>

      {/* Submit Button */}
      <motion.button
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.6 }}
        whileHover={{ scale: selectedOptions.length > 0 ? 1.02 : 1 }}
        whileTap={{ scale: selectedOptions.length > 0 ? 0.98 : 1 }}
        onClick={handleSubmit}
        disabled={selectedOptions.length === 0}
        className={`
          w-full mt-6 py-4 rounded-xl font-medium text-lg flex items-center justify-center gap-2 transition-all duration-300
          ${selectedOptions.length > 0
            ? 'bg-skill-primary text-white shadow-lg hover:shadow-xl'
            : 'bg-muted text-muted-foreground cursor-not-allowed'
          }
        `}
      >
        {isLastQuestion ? '完成' : '继续'}
        <ArrowRight className="w-5 h-5" />
      </motion.button>
    </motion.div>
  )
}
