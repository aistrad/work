'use client'

/**
 * Letter Step - Stage 6
 *
 * 来自未来的信：悬念式开篇 + 三种人格风格
 * 目标：情感高潮，打动用户，激发付费意愿
 */

import { useState, useEffect } from 'react'
import { motion } from 'framer-motion'
import { ArrowRight, Scroll } from 'lucide-react'
import { useOnboarding } from '../context'
import { PERSONAS } from '../types'

// 三种人格的信开篇
const LETTER_OPENINGS = {
  warm: `当你读到这封信的时候，
我已经在三年后的某个清晨，想了很久要怎么和你说这些。

你可能会觉得奇怪——
为什么「未来的自己」会给现在的你写信？

因为我知道，现在的你正站在一个转折点。
而有些话，只有我能告诉你。`,

  sharp: `听好了，我要告诉你一些你可能不想听但必须知道的事。

三年后的我，有几句话憋了很久。
别皱眉，听我说完。

你现在做的很多事，其实都是在逃避。
是的，我知道这听起来不舒服——
但这正是你需要面对的。`,

  wise: `我观察了你的人生轨迹，发现了一些有趣的规律。

作为三年后的你，我想和你分享这些洞察。
不是为了预言未来，而是为了让你更好地理解现在。

命盘显示，你正处于一个关键的转折期。
让我来解释为什么——`,
}

// 生成信的内容
const generateLetterContent = (
  persona: 'warm' | 'sharp' | 'wise',
  dayMaster: string,
  dayMasterElement: string,
  concerns: string[],
  interviewSummary: string
): string => {
  const opening = LETTER_OPENINGS[persona]

  const elementMetaphor: Record<string, string> = {
    '木': '一棵树',
    '火': '一团火',
    '土': '一座山',
    '金': '一把剑',
    '水': '一片海',
  }

  const futureYear = new Date().getFullYear() + 3
  const futureMonth = new Date().getMonth() + 1
  const futureDay = new Date().getDate()

  const body = persona === 'warm' ? `

───────────────────────────────────

先说说我对你的了解吧。

你是${dayMaster}${dayMasterElement}日主，骨子里住着${elementMetaphor[dayMasterElement] || '一个独特的存在'}。
向上生长是你的本能，但你也渴望扎根的安全感。
这两种力量有时候会在你内心拉扯，让你感到矛盾。

${interviewSummary ? `你说你最近${interviewSummary}。
我完全理解。` : ''}

因为今年的流年对你来说，就是一个「土重」的年份——
土克水，水生${dayMasterElement}受阻。
简单说，就是你想成长，但感觉被什么压住了。

但我想告诉你的是...
这种「被压制」的感觉，其实是你成长的信号。
冬天的树本该收敛、蓄力，等待春天。

───────────────────────────────────

三年后的我想告诉你：

${futureYear} 年，你会迎来一个重要的转折。
那一年，${dayMasterElement}气重新旺盛，你积蓄的能量会找到出口。
你现在经历的一切，都在为那个时刻做准备。

所以，不要急。
也不要因为现在的困难就怀疑自己。

你值得被深度理解。
而我，永远站在你身边。

                                          来自三年后的你
                                          ${futureYear}年${futureMonth}月${futureDay}日`

  : persona === 'sharp' ? `

───────────────────────────────────

${dayMaster}${dayMasterElement}日主。
骨子里是${elementMetaphor[dayMasterElement] || '一个独特的存在'}。

你知道你的问题在哪吗？

你太想面面俱到了。想要安全感，又想要自由。
想要被理解，又不愿意先敞开自己。

${interviewSummary ? `你说${interviewSummary}——
但说实话，这不是问题的根源。` : ''}

真正的问题是：你一直在等。
等一个「对的时机」，等一个「确定的答案」。
但${dayMasterElement}的特质告诉我，你根本不是一个适合等待的人。

───────────────────────────────────

三年后的我想告诉你：

别等了。

${futureYear} 年会有转折，没错。
但那个转折不是天上掉下来的，是你现在种下的因。

你要做的不是「熬过现在」，
而是「利用现在」。

这些话可能不好听，但你需要听。
因为三年后的我，不想看到你后悔。

                                          三年后那个更狠的你
                                          ${futureYear}年${futureMonth}月${futureDay}日`

  : `

───────────────────────────────────

从命理学角度分析：

你是${dayMaster}${dayMasterElement}日主。
${dayMasterElement}的特质在你身上表现为：追求成长，但也需要根基。
这是一组有趣的矛盾，也是你人格的核心张力。

${interviewSummary ? `你提到${interviewSummary}。
从大运流年来看，这并非偶然。` : ''}

当前流年土旺，对${dayMasterElement}形成一定压制。
但压力即信号——
这意味着你正在积蓄能量，等待下一个释放点。

───────────────────────────────────

基于命盘推演：

${futureYear} 年将是一个关键节点。
届时${dayMasterElement}气回升，你会感受到明显的能量转换。

建议你在这段时间：
1. 专注积累，不要急于求成
2. 关注内在成长，而非外在验证
3. 记录当下的想法，三年后回看会有不同理解

这不是预言，而是概率较高的趋势。
最终的结果，取决于你如何利用这段时间。

                                          来自三年后的观察者
                                          ${futureYear}年${futureMonth}月${futureDay}日`

  return opening + body
}

export default function LetterStep() {
  const { state, setLetterContent, nextStep } = useOnboarding()
  const { baziData, persona, interviewAnswers, concerns } = state

  const [isRevealing, setIsRevealing] = useState(true)
  const [revealedText, setRevealedText] = useState('')
  const [letterContent, setLocalLetterContent] = useState('')

  // Generate letter on mount
  useEffect(() => {
    if (baziData && persona) {
      // Summarize interview answers
      const summary = interviewAnswers
        .map(a => a.selectedOptions.join('、'))
        .filter(Boolean)
        .join('，')

      const content = generateLetterContent(
        persona,
        baziData.dayMaster,
        baziData.dayMasterElement,
        concerns,
        summary || '在寻找方向'
      )

      setLocalLetterContent(content)
      setLetterContent(content)
    }
  }, [baziData, persona, interviewAnswers, concerns, setLetterContent])

  // Typewriter effect
  useEffect(() => {
    if (!letterContent || !isRevealing) return

    let index = 0
    const timer = setInterval(() => {
      if (index < letterContent.length) {
        setRevealedText(letterContent.slice(0, index + 1))
        index++
      } else {
        clearInterval(timer)
        setIsRevealing(false)
      }
    }, 30) // 30ms per character

    return () => clearInterval(timer)
  }, [letterContent, isRevealing])

  // Skip reveal
  const handleSkipReveal = () => {
    setRevealedText(letterContent)
    setIsRevealing(false)
  }

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      className="w-full max-w-2xl"
    >
      {/* Letter Icon */}
      <motion.div
        initial={{ opacity: 0, y: -20 }}
        animate={{ opacity: 1, y: 0 }}
        className="text-center mb-6"
      >
        <div className="inline-block p-4 bg-skill-primary/10 rounded-full">
          <Scroll className="w-8 h-8 text-skill-primary" />
        </div>
      </motion.div>

      {/* Letter Card */}
      <motion.div
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        transition={{ delay: 0.2 }}
        className="relative bg-card border border-border rounded-2xl shadow-xl overflow-hidden"
      >
        {/* Decorative top border */}
        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-skill-primary/50 via-skill-primary to-skill-primary/50" />

        {/* Letter Content */}
        <div className="p-6 md:p-8">
          <div className="prose prose-sm dark:prose-invert max-w-none">
            <pre className="font-serif text-foreground whitespace-pre-wrap leading-relaxed text-base bg-transparent p-0 m-0 border-0">
              {revealedText}
              {isRevealing && <span className="animate-pulse">|</span>}
            </pre>
          </div>
        </div>
      </motion.div>

      {/* Skip / Continue Button */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.4 }}
        className="mt-6 text-center"
      >
        {isRevealing ? (
          <button
            onClick={handleSkipReveal}
            className="px-6 py-3 text-muted-foreground hover:text-foreground transition-colors"
          >
            跳过动画
          </button>
        ) : (
          <motion.button
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            whileHover={{ scale: 1.02 }}
            whileTap={{ scale: 0.98 }}
            onClick={() => nextStep()}
            className="px-8 py-4 bg-skill-primary text-white rounded-xl font-medium text-lg shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2 mx-auto"
          >
            解锁完整人生画像
            <ArrowRight className="w-5 h-5" />
          </motion.button>
        )}
      </motion.div>
    </motion.div>
  )
}
