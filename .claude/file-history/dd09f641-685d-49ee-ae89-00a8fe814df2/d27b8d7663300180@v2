"use client"

import { cn } from "@/lib/utils"
import { Sun, Moon, Star, RefreshCw, ChevronRight } from "lucide-react"
import { useState, useEffect, useCallback } from "react"

interface DailyYunshi {
  date: string
  day_ganzhi: string
  day_gan_relation: string
  day_zhi_specials: string[]
  score: number
  summary: string
  highlights: string[]
  risks: string[]
  prescriptions: { content: string; priority: string }[]
  time_windows: { hour_range: string; quality: string; suggestion: string }[]
}

interface YunshiCardProps {
  className?: string
  onViewDetail?: () => void
}

export function YunshiCard({ className, onViewDetail }: YunshiCardProps) {
  const [yunshi, setYunshi] = useState<DailyYunshi | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  const fetchYunshi = useCallback(async () => {
    setIsLoading(true)
    setError(null)
    try {
      const res = await fetch("/api/yunshi/today", {
        headers: {
          "X-CSRF-Token": document.cookie.match(/fortune_csrf=([^;]+)/)?.[1] || "",
        },
        credentials: "include",
      })
      const data = await res.json()
      if (data.ok && data.data) {
        setYunshi(data.data)
      } else {
        setError(data.error?.message || "Failed to load yunshi")
      }
    } catch (e) {
      setError("Network error")
    } finally {
      setIsLoading(false)
    }
  }, [])

  useEffect(() => {
    fetchYunshi()
  }, [fetchYunshi])

  const getScoreStars = (score: number) => {
    if (score >= 7) return 5
    if (score >= 4) return 4
    if (score >= 1) return 3
    if (score >= -2) return 2
    return 1
  }

  const getScoreColor = (score: number) => {
    if (score >= 5) return "text-status-foreground"
    if (score >= 0) return "text-advice-foreground"
    return "text-alert-foreground"
  }

  const getScoreLabel = (score: number) => {
    if (score >= 7) return "极佳"
    if (score >= 4) return "良好"
    if (score >= 1) return "平稳"
    if (score >= -2) return "偏弱"
    return "欠佳"
  }

  if (isLoading) {
    return (
      <div className={cn("p-4 rounded-lg bg-mystic animate-pulse", className)}>
        <div className="flex items-center gap-3 mb-3">
          <div className="w-8 h-8 rounded-full bg-mystic-foreground/20" />
          <div className="flex-1">
            <div className="h-4 bg-mystic-foreground/20 rounded w-1/3 mb-1" />
            <div className="h-3 bg-mystic-foreground/20 rounded w-1/2" />
          </div>
        </div>
        <div className="h-16 bg-mystic-foreground/10 rounded" />
      </div>
    )
  }

  if (error || !yunshi) {
    return (
      <div className={cn("p-4 rounded-lg bg-mystic", className)}>
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Sun className="w-5 h-5 text-mystic-foreground" />
            <span className="font-medium text-foreground">今日运势</span>
          </div>
          <button
            onClick={fetchYunshi}
            className="p-1.5 rounded-md text-muted-foreground hover:text-foreground hover:bg-hover/50"
          >
            <RefreshCw className="w-4 h-4" />
          </button>
        </div>
        <p className="text-sm text-muted-foreground mt-2">
          {error || "暂无运势数据"}
        </p>
      </div>
    )
  }

  const stars = getScoreStars(yunshi.score)
  const scoreColor = getScoreColor(yunshi.score)
  const scoreLabel = getScoreLabel(yunshi.score)

  return (
    <div className={cn("p-4 rounded-lg bg-mystic group", className)}>
      {/* Header */}
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-full bg-mystic-foreground/20 flex items-center justify-center">
            <Sun className="w-5 h-5 text-mystic-foreground" />
          </div>
          <div>
            <div className="flex items-center gap-2">
              <span className="font-medium text-foreground">今日运势</span>
              <span className="text-xs text-muted-foreground font-serif">
                {yunshi.day_ganzhi}
              </span>
            </div>
            <div className="flex items-center gap-1 mt-0.5">
              {Array.from({ length: 5 }).map((_, i) => (
                <Star
                  key={i}
                  className={cn(
                    "w-3 h-3",
                    i < stars ? scoreColor : "text-muted-foreground/30"
                  )}
                  fill={i < stars ? "currentColor" : "none"}
                />
              ))}
              <span className={cn("text-xs ml-1", scoreColor)}>
                {scoreLabel}
              </span>
            </div>
          </div>
        </div>
        <button
          onClick={fetchYunshi}
          className="p-1.5 rounded-md text-muted-foreground hover:text-foreground hover:bg-hover/50 opacity-0 group-hover:opacity-100 transition-opacity"
        >
          <RefreshCw className="w-4 h-4" />
        </button>
      </div>

      {/* Summary */}
      <p className="text-sm text-foreground mb-3">{yunshi.summary}</p>

      {/* Highlights */}
      {yunshi.highlights.length > 0 && (
        <div className="space-y-1 mb-3">
          {yunshi.highlights.slice(0, 2).map((h, i) => (
            <div key={i} className="flex items-start gap-2 text-xs">
              <span className="text-status-foreground">+</span>
              <span className="text-muted-foreground">{h}</span>
            </div>
          ))}
        </div>
      )}

      {/* Risks */}
      {yunshi.risks.length > 0 && (
        <div className="space-y-1 mb-3">
          {yunshi.risks.slice(0, 1).map((r, i) => (
            <div key={i} className="flex items-start gap-2 text-xs">
              <span className="text-alert-foreground">!</span>
              <span className="text-muted-foreground">{r}</span>
            </div>
          ))}
        </div>
      )}

      {/* Time Windows */}
      {yunshi.time_windows.length > 0 && (
        <div className="flex items-center gap-2 text-xs text-muted-foreground mb-3">
          <Moon className="w-3 h-3" />
          <span>
            吉时：{yunshi.time_windows.map((tw) => tw.hour_range).join("、")}
          </span>
        </div>
      )}

      {/* Action */}
      {onViewDetail && (
        <button
          onClick={onViewDetail}
          className={cn(
            "w-full flex items-center justify-center gap-1 py-2 px-3",
            "rounded-md border border-mystic-foreground/30",
            "text-xs text-mystic-foreground hover:bg-mystic-foreground/10 transition-colors"
          )}
        >
          查看详细分析
          <ChevronRight className="w-3 h-3" />
        </button>
      )}
    </div>
  )
}
