import { test, expect } from "@playwright/test"

// Mock API responses for testing without authentication
const mockYunshiData = {
  ok: true,
  data: {
    date: "2026-01-01",
    day_ganzhi: "甲子",
    day_gan_relation: "比肩",
    day_zhi_specials: ["天乙贵人"],
    score: 7,
    summary: "今日运势良好，适合开展新计划。",
    highlights: ["贵人运旺", "财运稳定"],
    risks: ["注意休息"],
    prescriptions: [{ content: "多喝水", priority: "normal" }],
    time_windows: [{ hour_range: "9:00-11:00", quality: "吉", suggestion: "适合开会" }],
  },
}

const mockOverviewData = {
  ok: true,
  data: {
    daily_summary: "状态良好",
    score: 85,
    tasks: [],
    pinned: [],
  },
}

// Setup mock routes for all API endpoints
async function setupMockRoutes(page: import("@playwright/test").Page) {
  await page.route("**/api/**", async (route) => {
    const url = route.request().url()

    if (url.includes("/api/yunshi/today")) {
      return route.fulfill({
        status: 200,
        contentType: "application/json",
        body: JSON.stringify(mockYunshiData),
      })
    }

    if (url.includes("/api/dashboard/overview")) {
      return route.fulfill({
        status: 200,
        contentType: "application/json",
        body: JSON.stringify(mockOverviewData),
      })
    }

    // Default mock for all other API calls
    return route.fulfill({
      status: 200,
      contentType: "application/json",
      body: JSON.stringify({ ok: true, data: {} }),
    })
  })
}

test.describe("Login Page", () => {
  test("should display login form", async ({ page }) => {
    await page.goto("/new/login")

    await expect(page.getByRole("heading", { name: "Fortune AI" })).toBeVisible()
    await expect(page.getByText("登录您的账户")).toBeVisible()
    await expect(page.getByPlaceholder("your@email.com")).toBeVisible()
    await expect(page.getByRole("button", { name: "登录" })).toBeVisible()
    await expect(page.getByRole("link", { name: "注册" })).toBeVisible()
  })

  test("should have working register link", async ({ page }) => {
    await page.goto("/new/login")

    await page.getByRole("link", { name: "注册" }).click()
    await expect(page).toHaveURL(/\/register/)
  })
})

test.describe("Dashboard with Mocked APIs", () => {
  test.beforeEach(async ({ page }) => {
    await setupMockRoutes(page)
    await page.goto("/new")
  })

  test("should display main dashboard", async ({ page }) => {
    await expect(page.getByRole("heading", { name: "Fortune AI" })).toBeVisible()
  })

  test("should show tab navigation", async ({ page }) => {
    await expect(page.getByRole("tab", { name: "概览" })).toBeVisible()
    await expect(page.getByRole("tab", { name: "探索" })).toBeVisible()
  })

  test("should navigate to Explore tab", async ({ page }) => {
    await page.getByRole("tab", { name: "探索" }).click()

    // Wait for tab content to load - look for the section header
    await expect(page.getByText("玄学探索")).toBeVisible({ timeout: 10000 })
  })
})

test.describe("Explore Tab - Yunshi and Bazi Report", () => {
  test.beforeEach(async ({ page }) => {
    await setupMockRoutes(page)
    await page.goto("/new")
    await page.getByRole("tab", { name: "探索" }).click()
    // Wait for explore tab content
    await expect(page.getByText("玄学探索")).toBeVisible({ timeout: 10000 })
  })

  test.describe("Today's Yunshi Card", () => {
    test("should display yunshi section header", async ({ page }) => {
      // Look for the h2 heading in the yunshi section
      await expect(page.getByRole("heading", { name: "今日运势", level: 2 })).toBeVisible()
    })

    test("should display yunshi data with day ganzhi", async ({ page }) => {
      await expect(page.getByText("甲子")).toBeVisible()
    })

    test("should display yunshi score label", async ({ page }) => {
      await expect(page.getByText("极佳")).toBeVisible()
    })

    test("should display yunshi summary", async ({ page }) => {
      await expect(page.getByText("今日运势良好，适合开展新计划。")).toBeVisible()
    })

    test("should display highlights", async ({ page }) => {
      await expect(page.getByText("贵人运旺")).toBeVisible()
    })

    test("should display risks", async ({ page }) => {
      await expect(page.getByText("注意休息")).toBeVisible()
    })

    test("should display time windows", async ({ page }) => {
      await expect(page.getByText(/9:00-11:00/)).toBeVisible()
    })
  })

  test.describe("Mystic Cards Section", () => {
    test("should display mystic exploration section", async ({ page }) => {
      await expect(page.getByText("玄学探索")).toBeVisible()
    })

    test("should display all mystic cards", async ({ page }) => {
      // Use the mystic section to avoid conflicts with sidebar buttons
      const mysticSection = page.locator("section").filter({ hasText: "玄学探索" })
      await expect(mysticSection.getByText("八字深度报告")).toBeVisible()
      await expect(mysticSection.getByText("塔罗占卜")).toBeVisible()
      await expect(mysticSection.getByText("星盘解读")).toBeVisible()
      await expect(mysticSection.getByText("数字能量")).toBeVisible()
    })

    test("should show featured badge on bazi report card", async ({ page }) => {
      const mysticSection = page.locator("section").filter({ hasText: "玄学探索" })
      await expect(mysticSection.getByText("推荐")).toBeVisible()
    })
  })

  test.describe("Bazi Report Panel", () => {
    test("should open bazi report panel when clicking bazi card", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()

      await expect(page.locator(".fixed.inset-0")).toBeVisible()
      await expect(
        page.getByRole("heading", { name: "八字深度报告" })
      ).toBeVisible()
    })

    test("should display report type selector", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()

      await expect(page.getByText("报告类型")).toBeVisible()
      await expect(page.getByText("完整报告")).toBeVisible()
    })

    test("should allow changing report type", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()

      await page.locator("button").filter({ hasText: "完整报告" }).click()

      await expect(page.getByText("精简版")).toBeVisible()
      await expect(page.getByText("事业方向")).toBeVisible()
      await expect(page.getByText("感情婚姻")).toBeVisible()
      await expect(page.getByText("健康养生")).toBeVisible()
    })

    test("should select different report type", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()

      await page.locator("button").filter({ hasText: "完整报告" }).click()
      await page.getByText("事业方向").click()

      await expect(
        page.locator("button").filter({ hasText: "事业方向" })
      ).toBeVisible()
    })

    test("should have optional question textarea", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()

      await expect(page.getByText("特别关注（可选）")).toBeVisible()
      await expect(
        page.getByPlaceholder("如有特别想了解的问题，请在此输入...")
      ).toBeVisible()
    })

    test("should show character count for question", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()

      await expect(page.getByText("0/500")).toBeVisible()

      const textarea = page.getByPlaceholder(
        "如有特别想了解的问题，请在此输入..."
      )
      await textarea.fill("测试问题")

      await expect(page.getByText("4/500")).toBeVisible()
    })

    test("should have generate button", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()

      await expect(page.getByRole("button", { name: /生成报告/ })).toBeVisible()
    })

    test("should close panel when clicking X button", async ({ page }) => {
      await page.getByText("八字深度报告").first().click()
      await expect(page.locator(".fixed.inset-0")).toBeVisible()

      // Find and click the close button in the header
      await page
        .locator(".fixed.inset-0")
        .locator("button")
        .filter({ has: page.locator("svg") })
        .first()
        .click()

      await expect(page.locator(".fixed.inset-0")).not.toBeVisible()
    })
  })

  test.describe("Courses Section", () => {
    test("should display courses section", async ({ page }) => {
      await expect(page.getByText("修习课程")).toBeVisible()
    })

    test("should display all course cards", async ({ page }) => {
      await expect(page.getByText("正念冥想入门")).toBeVisible()
      await expect(page.getByText("情绪管理基础")).toBeVisible()
      await expect(page.getByText("自我成长之路")).toBeVisible()
    })

    test("should show progress for started courses", async ({ page }) => {
      await expect(page.getByText("65%")).toBeVisible()
      await expect(page.getByText("30%")).toBeVisible()
    })
  })

  test.describe("Assets Section", () => {
    test("should display assets section", async ({ page }) => {
      await expect(page.getByText("我的资产")).toBeVisible()
    })

    test("should display all asset entries", async ({ page }) => {
      await expect(page.getByText("分析报告")).toBeVisible()
      await expect(page.getByText("笔记页面")).toBeVisible()
      await expect(page.getByText("已完成任务")).toBeVisible()
      await expect(page.getByText("玄学记录")).toBeVisible()
    })
  })
})

test.describe("Responsive Design", () => {
  test("should display login page properly on mobile", async ({ page }) => {
    await page.setViewportSize({ width: 375, height: 667 })
    await page.goto("/new/login")

    await expect(page.getByRole("heading", { name: "Fortune AI" })).toBeVisible()
    await expect(page.getByRole("button", { name: "登录" })).toBeVisible()
  })
})
