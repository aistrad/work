"""
运势 API 路由

提供今日运势、周运势、月运势、流年运势查询接口
"""

from __future__ import annotations

from datetime import date, datetime
from typing import Any, Dict, Optional

from fastapi import APIRouter, Request
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field

from api.deps import require_auth
from services.yunshi_service import yunshi_service, build_daily_yunshi_a2ui, build_annual_yunshi_a2ui


router = APIRouter(prefix="/api/yunshi", tags=["yunshi"])


def _ok(data: Dict[str, Any] | None = None) -> JSONResponse:
    return JSONResponse({"ok": True, "data": data or {}})


def _err(status: int, code: str, message: str, detail: Optional[Dict[str, Any]] = None) -> JSONResponse:
    return JSONResponse(
        {"ok": False, "error": {"code": code, "message": message, "detail": detail or {}}},
        status_code=status,
    )


# =============================================================================
# Request Models
# =============================================================================

class YunshiDateRequest(BaseModel):
    date: Optional[str] = Field(None, description="Target date (YYYY-MM-DD), defaults to today")


# =============================================================================
# 今日运势
# =============================================================================

@router.get("/today")
def get_today_yunshi(request: Request, include_a2ui: bool = True):
    """
    获取今日运势

    返回：
    - date: 日期
    - day_ganzhi: 当日干支
    - summary: 一句话总结
    - score: 综合评分 (-10 ~ +10)
    - highlights: 亮点列表
    - risks: 风险提示
    - prescriptions: 行动处方
    - time_windows: 吉时提示
    - a2ui: A2UI 格式输出（可选）
    """
    auth = require_auth(request)
    user_id = int(auth["user_id"])

    try:
        yunshi = yunshi_service.compute_daily_yunshi(user_id, target_date=date.today())
    except ValueError as e:
        return _err(400, "compute_error", str(e))
    except Exception as e:
        return _err(500, "internal_error", f"Failed to compute yunshi: {str(e)[:100]}")

    result = yunshi.to_dict()

    if include_a2ui:
        result["a2ui"] = build_daily_yunshi_a2ui(yunshi)

    return _ok(result)


@router.get("/daily")
def get_daily_yunshi(request: Request, target_date: Optional[str] = None, include_a2ui: bool = True):
    """
    获取指定日期的运势

    参数：
    - target_date: 目标日期 (YYYY-MM-DD)，默认今天
    - include_a2ui: 是否包含 A2UI 格式输出
    """
    auth = require_auth(request)
    user_id = int(auth["user_id"])

    # 解析日期
    if target_date:
        try:
            parsed_date = datetime.strptime(target_date, "%Y-%m-%d").date()
        except ValueError:
            return _err(400, "invalid_date", "Date format must be YYYY-MM-DD")
    else:
        parsed_date = date.today()

    try:
        yunshi = yunshi_service.compute_daily_yunshi(user_id, target_date=parsed_date)
    except ValueError as e:
        return _err(400, "compute_error", str(e))
    except Exception as e:
        return _err(500, "internal_error", f"Failed to compute yunshi: {str(e)[:100]}")

    result = yunshi.to_dict()

    if include_a2ui:
        result["a2ui"] = build_daily_yunshi_a2ui(yunshi)

    return _ok(result)


# =============================================================================
# 流年运势
# =============================================================================

@router.get("/annual")
def get_annual_yunshi(request: Request, year: Optional[int] = None, include_a2ui: bool = True):
    """
    获取流年运势

    参数：
    - year: 目标年份，默认当前年
    - include_a2ui: 是否包含 A2UI 格式输出

    返回：
    - year: 年份
    - liu_nian_ganzhi: 流年干支
    - da_yun_ganzhi: 当前大运干支
    - summary: 一句话总结
    - score: 综合评分
    - themes: 年度主题
    - key_months: 关键月份
    - prescriptions: 行动处方
    """
    auth = require_auth(request)
    user_id = int(auth["user_id"])

    target_year = year if year else datetime.now().year

    # 限制年份范围
    current_year = datetime.now().year
    if target_year < current_year - 10 or target_year > current_year + 10:
        return _err(400, "invalid_year", "Year must be within 10 years of current year")

    try:
        yunshi = yunshi_service.compute_annual_yunshi(user_id, target_year=target_year)
    except ValueError as e:
        return _err(400, "compute_error", str(e))
    except Exception as e:
        return _err(500, "internal_error", f"Failed to compute annual yunshi: {str(e)[:100]}")

    result = yunshi.to_dict()

    if include_a2ui:
        result["a2ui"] = build_annual_yunshi_a2ui(yunshi)

    return _ok(result)


# =============================================================================
# 运势概览（用于 Dashboard）
# =============================================================================

@router.get("/summary")
def get_yunshi_summary(request: Request):
    """
    获取运势概览（用于 Dashboard 卡片展示）

    返回简化版今日运势 + 流年概要
    """
    auth = require_auth(request)
    user_id = int(auth["user_id"])

    today = date.today()
    current_year = datetime.now().year

    try:
        daily = yunshi_service.compute_daily_yunshi(user_id, target_date=today)
        annual = yunshi_service.compute_annual_yunshi(user_id, target_year=current_year)
    except Exception as e:
        return _err(500, "internal_error", f"Failed to compute yunshi: {str(e)[:100]}")

    return _ok({
        "daily": {
            "date": daily.date.isoformat(),
            "day_ganzhi": daily.day_ganzhi,
            "summary": daily.summary,
            "score": daily.score,
            "highlights": daily.highlights[:2],
        },
        "annual": {
            "year": annual.year,
            "liu_nian_ganzhi": annual.liu_nian_ganzhi,
            "summary": annual.summary,
            "score": annual.score,
            "themes": annual.themes[:2],
        },
    })
