-- Fortune AI Yunshi & Bazi Report Schema
-- Date: 2026-01-01
-- Purpose: Add fortune_yunshi_snapshot and fortune_bazi_report tables for yunshi/bazi report modules
-- REQ: modul_bazi_v1.md

-- =============================================================================
-- 1. Yunshi Snapshot Table (运势快照表)
-- Caches computed yunshi results to avoid redundant calculation
-- =============================================================================

CREATE TABLE IF NOT EXISTS fortune_yunshi_snapshot (
    snapshot_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    snapshot_type TEXT NOT NULL CHECK (snapshot_type IN ('daily', 'weekly', 'monthly', 'annual')),
    snapshot_date DATE NOT NULL,              -- Target date/week-start/month-start/year-start
    bazi_facts_hash TEXT NOT NULL,            -- Associated bazi facts hash for consistency

    -- Yunshi analysis results
    day_ganzhi TEXT,                          -- Current day's Ganzhi (for daily)
    period_ganzhi TEXT,                       -- Period Ganzhi (week/month/year)
    summary TEXT NOT NULL,                    -- One-line summary
    score INTEGER NOT NULL CHECK (score >= -10 AND score <= 10),  -- Overall score
    analysis JSONB NOT NULL DEFAULT '{}',     -- Full analysis result
    highlights JSONB NOT NULL DEFAULT '[]',   -- Key highlights (max 3)
    risks JSONB NOT NULL DEFAULT '[]',        -- Risk warnings (max 2)
    prescriptions JSONB NOT NULL DEFAULT '[]', -- Action prescriptions (max 3)
    time_windows JSONB DEFAULT '[]',          -- Auspicious/inauspicious time windows (daily only)

    -- Evidence & metadata
    rule_ids TEXT[] DEFAULT '{}',             -- Applied rule IDs
    kb_refs JSONB DEFAULT '[]',               -- KB references used
    compute_version TEXT NOT NULL DEFAULT 'v1.0',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    expires_at TIMESTAMPTZ,                   -- Expiration (daily expires next day)

    -- Unique constraint to prevent duplicate snapshots
    UNIQUE (user_id, snapshot_type, snapshot_date, bazi_facts_hash)
);

-- Indexes for common queries
CREATE INDEX IF NOT EXISTS idx_yunshi_user_type_date ON fortune_yunshi_snapshot
    (user_id, snapshot_type, snapshot_date DESC);
CREATE INDEX IF NOT EXISTS idx_yunshi_expires ON fortune_yunshi_snapshot
    (expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_yunshi_date ON fortune_yunshi_snapshot
    (snapshot_date DESC, snapshot_type);

COMMENT ON TABLE fortune_yunshi_snapshot IS 'Cached yunshi (fortune) analysis snapshots';
COMMENT ON COLUMN fortune_yunshi_snapshot.day_ganzhi IS 'Heavenly stem + Earthly branch for the target day';
COMMENT ON COLUMN fortune_yunshi_snapshot.score IS 'Overall fortune score from -10 (very bad) to +10 (excellent)';

-- =============================================================================
-- 2. Bazi Report Table (八字报告表)
-- Stores deep analysis reports generated by LLM backends
-- =============================================================================

CREATE TABLE IF NOT EXISTS fortune_bazi_report (
    report_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    external_job_id BIGINT REFERENCES fortune_external_job(id) ON DELETE SET NULL,

    -- Report type & configuration
    report_type TEXT NOT NULL DEFAULT 'full' CHECK (report_type IN ('full', 'summary', 'career', 'relationship', 'health')),
    backend TEXT NOT NULL CHECK (backend IN ('cli', 'gemini', 'glm')),
    model TEXT,                               -- Model used (e.g., 'glm-4.7', 'gemini-pro')
    system_prompt TEXT,                       -- System prompt used

    -- Input snapshot
    bazi_facts_hash TEXT NOT NULL,            -- Hash of bazi facts at generation time
    input_context JSONB NOT NULL DEFAULT '{}', -- User's additional context/questions

    -- Output content
    status TEXT NOT NULL DEFAULT 'processing' CHECK (status IN ('processing', 'completed', 'error')),
    output_markdown TEXT,                     -- Markdown formatted report
    output_a2ui JSONB,                        -- A2UI formatted output
    output_summary TEXT,                      -- One-line summary (max 100 chars)

    -- Key extractions (for display & search)
    key_findings JSONB DEFAULT '[]',          -- Core findings list
    prescriptions JSONB DEFAULT '[]',         -- Action prescriptions

    -- Metadata
    error_message TEXT DEFAULT '',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    completed_at TIMESTAMPTZ,
    compute_version TEXT NOT NULL DEFAULT 'v1.0'
);

-- Indexes
CREATE INDEX IF NOT EXISTS idx_bazi_report_user_time ON fortune_bazi_report
    (user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_bazi_report_status ON fortune_bazi_report
    (status, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_bazi_report_type ON fortune_bazi_report
    (user_id, report_type, created_at DESC);

COMMENT ON TABLE fortune_bazi_report IS 'Deep bazi analysis reports generated by LLM backends';
COMMENT ON COLUMN fortune_bazi_report.report_type IS 'Report focus: full, summary, career, relationship, health';
COMMENT ON COLUMN fortune_bazi_report.backend IS 'LLM backend: cli (Claude), gemini, glm';

-- =============================================================================
-- 3. Yunshi Calculation Rules (运势计算规则)
-- Insert rules for yunshi computation
-- =============================================================================

INSERT INTO fortune_rule (rule_id, category, name, body) VALUES

-- Day Heavenly Stem relation to Day Master
('RULE-DAILY-DAYGAN-V1', 'yunshi_daily', '日干与日主关系', '{
  "description": "当日天干与日主的五行生克关系",
  "version": "1.0",
  "relations": {
    "same": {"name": "比肩", "score": 0, "desc": "平稳，宜守成"},
    "generates": {"name": "印绶", "score": 2, "desc": "有助力，贵人运"},
    "generated": {"name": "食伤", "score": 1, "desc": "适合表达、创作"},
    "controls": {"name": "财星", "score": 1, "desc": "适合财务、事业推进"},
    "controlled": {"name": "官杀", "score": -1, "desc": "压力增大，宜谨慎"}
  }
}'::jsonb),

-- Day Earthly Branch special markers
('RULE-DAILY-DAYZHI-V1', 'yunshi_daily', '日支与日主关系', '{
  "description": "当日地支与日主的影响及特殊标记",
  "version": "1.0",
  "special_branches": {
    "taohua": {"name": "桃花日", "score": 1, "desc": "人际与感情活跃"},
    "yima": {"name": "驿马日", "score": 0, "desc": "适合出行与变动"},
    "huagai": {"name": "华盖日", "score": 1, "desc": "适合学习与内省"},
    "tianyi": {"name": "贵人日", "score": 2, "desc": "易得助力"},
    "jiangxing": {"name": "将星日", "score": 1, "desc": "适合领导与决策"},
    "yangren": {"name": "羊刃日", "score": -1, "desc": "需注意冲动与意外"}
  },
  "six_combinations": {
    "合": {"score": 1, "desc": "和谐顺遂"},
    "冲": {"score": -2, "desc": "变动冲突"},
    "刑": {"score": -1, "desc": "阻碍困难"},
    "害": {"score": -1, "desc": "暗中不顺"}
  }
}'::jsonb),

-- Liunian (annual) interactions
('RULE-LIUNIAN-INTERACTION-V1', 'yunshi_annual', '流年与八字作用', '{
  "description": "流年干支与原局的作用关系",
  "version": "1.0",
  "key_interactions": ["天克地冲", "天合地合", "伏吟", "反吟", "干支同气"],
  "scoring": {
    "天克地冲": {"score": -3, "desc": "动荡年份，需谨慎应对大变化"},
    "天合地合": {"score": 2, "desc": "和谐年份，机遇较多"},
    "伏吟": {"score": -1, "desc": "重复模式，易有压力"},
    "反吟": {"score": -2, "desc": "反复变化，不宜大动"},
    "干支同气": {"score": 1, "desc": "力量加强，顺势而为"}
  }
}'::jsonb),

-- Monthly fortune rules
('RULE-MONTHLY-INTERACTION-V1', 'yunshi_monthly', '月令与八字作用', '{
  "description": "月令干支与日主的作用关系",
  "version": "1.0",
  "scoring": {
    "得令": {"score": 2, "desc": "月令生扶，运势提升"},
    "失令": {"score": -1, "desc": "月令克泄，需稳健行事"},
    "相合": {"score": 1, "desc": "月令和合，人际顺遂"}
  }
}'::jsonb),

-- Prescription templates
('RULE-PRESCRIPTION-TEMPLATES-V1', 'yunshi_prescription', '行动处方模板', '{
  "description": "基于运势评分的行动处方模板",
  "version": "1.0",
  "templates": {
    "high_score": [
      {"content": "今日运势佳，适合主动出击，推进重要事项", "priority": "high", "minutes": 30},
      {"content": "把握贵人运，联系一位能帮助你的人", "priority": "high", "minutes": 15}
    ],
    "medium_score": [
      {"content": "保持稳定节奏，完成既定计划", "priority": "medium", "minutes": 20},
      {"content": "回顾本周目标，确保方向正确", "priority": "medium", "minutes": 10}
    ],
    "low_score": [
      {"content": "今日宜守不宜攻，专注基础工作", "priority": "high", "minutes": 15},
      {"content": "做3分钟正念呼吸，平复情绪再处理重要事务", "priority": "high", "minutes": 3}
    ]
  }
}'::jsonb)

ON CONFLICT (rule_id) DO UPDATE SET
  category = EXCLUDED.category,
  name = EXCLUDED.name,
  body = EXCLUDED.body,
  updated_at = NOW();

-- =============================================================================
-- 4. Add source tracking for yunshi-generated commitments
-- =============================================================================

DO $$
BEGIN
    -- Add source column if not exists
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'fortune_commitment' AND column_name = 'source'
    ) THEN
        ALTER TABLE fortune_commitment ADD COLUMN source TEXT DEFAULT 'manual';
    END IF;

    -- Add yunshi_snapshot_id column for tracking
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'fortune_commitment' AND column_name = 'yunshi_snapshot_id'
    ) THEN
        ALTER TABLE fortune_commitment ADD COLUMN yunshi_snapshot_id BIGINT REFERENCES fortune_yunshi_snapshot(snapshot_id) ON DELETE SET NULL;
        CREATE INDEX IF NOT EXISTS idx_commitment_yunshi ON fortune_commitment(yunshi_snapshot_id) WHERE yunshi_snapshot_id IS NOT NULL;
    END IF;
END $$;

-- Update source check constraint
DO $$
BEGIN
    ALTER TABLE fortune_commitment DROP CONSTRAINT IF EXISTS fortune_commitment_source_check;
    ALTER TABLE fortune_commitment ADD CONSTRAINT fortune_commitment_source_check
        CHECK (source IN ('manual', 'chat', 'checkin', 'yunshi', 'plan', 'goal'));
EXCEPTION
    WHEN undefined_column THEN NULL;
END $$;

-- =============================================================================
-- 5. Helper function for yunshi cache cleanup
-- =============================================================================

CREATE OR REPLACE FUNCTION cleanup_expired_yunshi_snapshots()
RETURNS INTEGER AS $$
DECLARE
    deleted_count INTEGER;
BEGIN
    DELETE FROM fortune_yunshi_snapshot
    WHERE expires_at IS NOT NULL AND expires_at < NOW();

    GET DIAGNOSTICS deleted_count = ROW_COUNT;
    RETURN deleted_count;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION cleanup_expired_yunshi_snapshots IS 'Removes expired yunshi snapshots, returns count of deleted rows';

-- =============================================================================
-- Verification queries (run manually to verify)
-- =============================================================================
-- SELECT * FROM fortune_yunshi_snapshot LIMIT 1;
-- SELECT * FROM fortune_bazi_report LIMIT 1;
-- SELECT rule_id, category, name FROM fortune_rule WHERE category LIKE 'yunshi%';
