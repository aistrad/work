"use client"

import { cn } from "@/lib/utils"
import { Sparkles, BookOpen, FolderOpen, Sun, FileText } from "lucide-react"
import { useState } from "react"
import { YunshiCard } from "@/components/dashboard/yunshi-card"
import { BaziReportPanel } from "@/components/dashboard/bazi-report-panel"

export function ExploreTab() {
  const [showBaziReport, setShowBaziReport] = useState(false)
  const [selectedMystic, setSelectedMystic] = useState<string | null>(null)

  const handleMysticClick = (id: string) => {
    setSelectedMystic(id)
    if (id === "bazi_report") {
      setShowBaziReport(true)
    }
    // Other mystic types can be handled here
  }

  return (
    <div className="p-4 space-y-6">
      {/* Today's Yunshi Card - Featured */}
      <section>
        <div className="flex items-center gap-2 mb-3">
          <Sun className="w-4 h-4 text-mystic-foreground" />
          <h2 className="text-lg font-semibold font-serif">ä»Šæ—¥è¿åŠ¿</h2>
        </div>
        <YunshiCard />
      </section>

      {/* Mystic Entries */}
      <section>
        <div className="flex items-center gap-2 mb-3">
          <Sparkles className="w-4 h-4 text-mystic-foreground" />
          <h2 className="text-lg font-semibold font-serif">ç„å­¦æ¢ç´¢</h2>
        </div>

        <div className="grid grid-cols-2 gap-3">
          <MysticCard
            id="bazi_report"
            icon={<FileText className="w-6 h-6" />}
            title="å…«å­—æ·±åº¦æŠ¥å‘Š"
            description="AI åˆ†æå‘½å±€"
            onClick={() => handleMysticClick("bazi_report")}
            featured
          />
          <MysticCard
            id="tarot"
            icon="ğŸ”®"
            title="å¡”ç½—å åœ"
            description="ä»Šæ—¥è¿åŠ¿æŒ‡å¼•"
            onClick={() => handleMysticClick("tarot")}
          />
          <MysticCard
            id="star_chart"
            icon="â­"
            title="æ˜Ÿç›˜è§£è¯»"
            description="æœ¬å‘¨æ˜Ÿè±¡åˆ†æ"
            onClick={() => handleMysticClick("star_chart")}
          />
          <MysticCard
            id="numerology"
            icon="ğŸ”¢"
            title="æ•°å­—èƒ½é‡"
            description="ç”Ÿå‘½æ•°å­—æŒ‡å¼•"
            onClick={() => handleMysticClick("numerology")}
          />
        </div>
      </section>

      {/* Courses */}
      <section>
        <div className="flex items-center gap-2 mb-3">
          <BookOpen className="w-4 h-4 text-advice-foreground" />
          <h2 className="text-lg font-semibold">ä¿®ä¹ è¯¾ç¨‹</h2>
        </div>

        <div className="space-y-3">
          <CourseCard
            thumbnail="ğŸ§˜"
            title="æ­£å¿µå†¥æƒ³å…¥é—¨"
            progress={65}
            duration="7å¤©"
          />
          <CourseCard
            thumbnail="ğŸ’ª"
            title="æƒ…ç»ªç®¡ç†åŸºç¡€"
            progress={30}
            duration="14å¤©"
          />
          <CourseCard
            thumbnail="ğŸŒ±"
            title="è‡ªæˆ‘æˆé•¿ä¹‹è·¯"
            progress={0}
            duration="21å¤©"
          />
        </div>
      </section>

      {/* Assets */}
      <section>
        <div className="flex items-center gap-2 mb-3">
          <FolderOpen className="w-4 h-4 text-muted-foreground" />
          <h2 className="text-lg font-semibold">æˆ‘çš„èµ„äº§</h2>
        </div>

        <div className="grid grid-cols-2 gap-3">
          <AssetEntry
            icon="ğŸ“Š"
            label="åˆ†ææŠ¥å‘Š"
            count={12}
          />
          <AssetEntry
            icon="ğŸ“"
            label="ç¬”è®°é¡µé¢"
            count={8}
          />
          <AssetEntry
            icon="ğŸ¯"
            label="å·²å®Œæˆä»»åŠ¡"
            count={45}
          />
          <AssetEntry
            icon="ğŸ”®"
            label="ç„å­¦è®°å½•"
            count={6}
          />
        </div>
      </section>

      {/* Bazi Report Panel */}
      <BaziReportPanel
        isOpen={showBaziReport}
        onClose={() => setShowBaziReport(false)}
      />
    </div>
  )
}

function MysticCard({
  id,
  icon,
  title,
  description,
  onClick,
  featured,
}: {
  id: string
  icon: string | React.ReactNode
  title: string
  description: string
  onClick?: () => void
  featured?: boolean
}) {
  return (
    <button
      onClick={onClick}
      className={cn(
        "p-4 rounded-lg text-left w-full",
        "bg-mystic border border-mystic-foreground/10",
        "hover:border-mystic-foreground/30 transition-colors",
        featured && "ring-2 ring-mystic-foreground/20"
      )}
    >
      <div className="text-2xl mb-2 text-mystic-foreground">
        {typeof icon === "string" ? icon : icon}
      </div>
      <div className="font-medium text-foreground font-serif">{title}</div>
      <div className="text-xs text-muted-foreground mt-1">{description}</div>
      {featured && (
        <div className="mt-2">
          <span className="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-mystic-foreground/20 text-mystic-foreground">
            <Sparkles className="w-3 h-3" />
            æ¨è
          </span>
        </div>
      )}
    </button>
  )
}

function CourseCard({
  thumbnail,
  title,
  progress,
  duration,
}: {
  thumbnail: string
  title: string
  progress: number
  duration: string
}) {
  return (
    <div
      className={cn(
        "flex items-center gap-3 p-3 rounded-lg",
        "bg-sidebar hover:bg-hover transition-colors cursor-pointer"
      )}
    >
      {/* Thumbnail */}
      <div className="flex-shrink-0 w-12 h-12 rounded-lg bg-advice flex items-center justify-center text-2xl">
        {thumbnail}
      </div>

      <div className="flex-1 min-w-0">
        <div className="font-medium text-foreground truncate">{title}</div>
        <div className="flex items-center gap-2 mt-1">
          <span className="text-xs text-muted-foreground">{duration}</span>
          {progress > 0 && (
            <>
              <span className="text-xs text-muted-foreground">Â·</span>
              <span className="text-xs text-status-foreground">{progress}%</span>
            </>
          )}
        </div>
        {/* Progress bar */}
        {progress > 0 && (
          <div className="h-1 bg-hover rounded-full overflow-hidden mt-2">
            <div
              className="h-full bg-status-foreground rounded-full"
              style={{ width: `${progress}%` }}
            />
          </div>
        )}
      </div>
    </div>
  )
}

function AssetEntry({
  icon,
  label,
  count,
}: {
  icon: string
  label: string
  count: number
}) {
  return (
    <div
      className={cn(
        "flex items-center gap-3 p-3 rounded-lg",
        "bg-sidebar hover:bg-hover transition-colors cursor-pointer"
      )}
    >
      <span className="text-lg">{icon}</span>
      <div className="flex-1">
        <div className="text-sm font-medium text-foreground">{label}</div>
      </div>
      <span className="text-sm text-muted-foreground">{count}</span>
    </div>
  )
}
