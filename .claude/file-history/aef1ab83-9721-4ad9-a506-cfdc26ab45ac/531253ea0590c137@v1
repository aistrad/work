#!/usr/bin/env python3
"""
å·¥å…·è°ƒç”¨ä¸ VibeProfile é›†æˆæµ‹è¯• (ä¸ä¾èµ– LLM)
ç›´æ¥æµ‹è¯•å·¥å…·æ³¨å†Œè¡¨ä¸ VibeProfile æ•°æ®çš„åä½œ

ç”¨æ³•:
    cd /home/aiscend/work/vibelife/apps/api
    python scripts/test_tool_vibeprofile_integration.py
"""
import asyncio
import json
import os
import sys
from datetime import datetime
from pathlib import Path
from typing import Dict, Any
import uuid

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

# è®¾ç½®æµ‹è¯•ç¯å¢ƒ
os.environ["VIBELIFE_ENV"] = "test"
os.environ["VIBELIFE_DB_HOST"] = "106.37.170.238"
os.environ["VIBELIFE_DB_PORT"] = "8224"
os.environ["VIBELIFE_DB_NAME"] = "vibelife"
os.environ["VIBELIFE_DB_USER"] = "postgres"

from dotenv import load_dotenv
_project_root = Path(__file__).resolve().parents[2]
load_dotenv(_project_root / ".env.test")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•ç”¨æˆ·æ•°æ®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TEST_USER_ID = "f43b745f-5a70-4ed1-aaa7-637fb1f87a61"


async def get_user_profile() -> Dict[str, Any]:
    """ä»æ•°æ®åº“è·å–ç”¨æˆ· Profile"""
    from stores.db import fetchrow

    row = await fetchrow(
        "SELECT user_id, profile FROM unified_profiles WHERE user_id = $1",
        uuid.UUID(TEST_USER_ID)
    )

    if not row:
        print(f"âŒ ç”¨æˆ·ä¸å­˜åœ¨: {TEST_USER_ID}")
        return None

    profile = row["profile"]
    if isinstance(profile, str):
        profile = json.loads(profile)

    return profile


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# å·¥å…·ç›´æ¥è°ƒç”¨æµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_bazi_tools(profile: Dict[str, Any]):
    """æµ‹è¯•å…«å­—å·¥å…·"""
    from services.agent.tool_registry import ToolRegistry, ToolContext

    print("\n" + "="*80)
    print("ğŸ“‹ æµ‹è¯•å…«å­— (Bazi) å·¥å…·")
    print("="*80)

    skill_data = profile.get("skill_data", {})

    context = ToolContext(
        user_id=TEST_USER_ID,
        user_tier="paid",
        profile=profile,
        skill_data=skill_data,
        skill_id="bazi",
        scenario_id="career_reading"
    )

    # æµ‹è¯• show_bazi_chart
    if ToolRegistry.has_handler("show_bazi_chart"):
        print("\nğŸ”§ æµ‹è¯•: show_bazi_chart")
        try:
            result = await ToolRegistry.execute("show_bazi_chart", {}, context)
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                print(f"  â€¢ æ—¥ä¸»: {data.get('day_master')}")
                print(f"  â€¢ äº”è¡Œ: {data.get('five_elements')}")
                print(f"  â€¢ å¼ºå¼±: {data.get('strength')}")
                print(f"  â€¢ ç”¨ç¥: {data.get('use_god')}")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: show_bazi_chart")

    # æµ‹è¯• show_daily_fortune
    if ToolRegistry.has_handler("show_daily_fortune"):
        print("\nğŸ”§ æµ‹è¯•: show_daily_fortune")
        try:
            result = await ToolRegistry.execute("show_daily_fortune", {}, context)
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                print(f"  â€¢ æ—¥æœŸ: {data.get('date')}")
                print(f"  â€¢ å‰å‡¶: {data.get('fortune_level')}")
                print(f"  â€¢ å»ºè®®: {data.get('advice', '')[:50]}...")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: show_daily_fortune")


async def test_zodiac_tools(profile: Dict[str, Any]):
    """æµ‹è¯•æ˜Ÿåº§å·¥å…·"""
    from services.agent.tool_registry import ToolRegistry, ToolContext

    print("\n" + "="*80)
    print("â­ æµ‹è¯•æ˜Ÿåº§ (Zodiac) å·¥å…·")
    print("="*80)

    skill_data = profile.get("skill_data", {})

    context = ToolContext(
        user_id=TEST_USER_ID,
        user_tier="paid",
        profile=profile,
        skill_data=skill_data,
        skill_id="zodiac",
        scenario_id="daily_reading"
    )

    # æµ‹è¯• show_zodiac_chart
    if ToolRegistry.has_handler("show_zodiac_chart"):
        print("\nğŸ”§ æµ‹è¯•: show_zodiac_chart")
        try:
            result = await ToolRegistry.execute("show_zodiac_chart", {}, context)
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                print(f"  â€¢ å¤ªé˜³æ˜Ÿåº§: {data.get('sun_sign')}")
                print(f"  â€¢ æœˆäº®æ˜Ÿåº§: {data.get('moon_sign')}")
                print(f"  â€¢ ä¸Šå‡æ˜Ÿåº§: {data.get('rising_sign')}")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: show_zodiac_chart")

    # æµ‹è¯• show_lunar_phase
    if ToolRegistry.has_handler("show_lunar_phase"):
        print("\nğŸ”§ æµ‹è¯•: show_lunar_phase")
        try:
            result = await ToolRegistry.execute("show_lunar_phase", {}, context)
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                print(f"  â€¢ æœˆç›¸: {data.get('phase_name')}")
                print(f"  â€¢ äº®åº¦: {data.get('illumination')}%")
                print(f"  â€¢ å«ä¹‰: {data.get('meaning', '')[:50]}...")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: show_lunar_phase")


async def test_vibe_id_tools(profile: Dict[str, Any]):
    """æµ‹è¯• VibeID å·¥å…·"""
    from services.agent.tool_registry import ToolRegistry, ToolContext

    print("\n" + "="*80)
    print("ğŸ­ æµ‹è¯• VibeID å·¥å…·")
    print("="*80)

    skill_data = profile.get("skill_data", {})

    context = ToolContext(
        user_id=TEST_USER_ID,
        user_tier="paid",
        profile=profile,
        skill_data=skill_data,
        skill_id="vibe_id",
        scenario_id="shadow_analysis"
    )

    # æµ‹è¯• show_vibe_id
    if ToolRegistry.has_handler("show_vibe_id"):
        print("\nğŸ”§ æµ‹è¯•: show_vibe_id")
        try:
            result = await ToolRegistry.execute("show_vibe_id", {}, context)
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                archetypes = data.get('archetypes', {})

                print(f"\n  å››ç»´äººæ ¼åŸå‹:")
                print(f"  â€¢ Core (çµé­‚):  {archetypes.get('core', {}).get('primary')}")
                print(f"  â€¢ Inner (å†…åœ¨): {archetypes.get('inner', {}).get('primary')}")
                print(f"  â€¢ Outer (å¤–åœ¨): {archetypes.get('outer', {}).get('primary')}")
                print(f"  â€¢ Shadow (é˜´å½±): {archetypes.get('shadow', {}).get('primary')}")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: show_vibe_id")

    # æµ‹è¯• show_archetype_radar
    if ToolRegistry.has_handler("show_archetype_radar"):
        print("\nğŸ”§ æµ‹è¯•: show_archetype_radar")
        try:
            result = await ToolRegistry.execute("show_archetype_radar", {}, context)
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                scores = result.get('data', {})
                print(f"\n  12åŸå‹èƒ½é‡åˆ†å¸ƒ (Top 5):")

                # æ’åºå¹¶æ˜¾ç¤ºå‰5
                sorted_scores = sorted(scores.items(), key=lambda x: x[1], reverse=True)
                for archetype, score in sorted_scores[:5]:
                    bar = "â–ˆ" * int(score / 10)
                    print(f"  {archetype:12} {score:5.1f} {bar}")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: show_archetype_radar")

    # æµ‹è¯• get_archetype_info
    if ToolRegistry.has_handler("get_archetype_info"):
        print("\nğŸ”§ æµ‹è¯•: get_archetype_info (Sage)")
        try:
            result = await ToolRegistry.execute(
                "get_archetype_info",
                {"archetype_id": "Sage"},
                context
            )
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                print(f"\n  åŸå‹è¯¦æƒ…:")
                print(f"  â€¢ åç§°: {data.get('name_cn')} ({data.get('name_en')})")
                print(f"  â€¢ æ˜µç§°: {data.get('nickname')}")
                print(f"  â€¢ å£å·: {data.get('slogan')}")
                print(f"  â€¢ æ ¸å¿ƒé©±åŠ¨: {data.get('core_drive')}")
                print(f"  â€¢ æ ¸å¿ƒææƒ§: {data.get('core_fear')}")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: get_archetype_info")


async def test_tarot_tools(profile: Dict[str, Any]):
    """æµ‹è¯•å¡”ç½—å·¥å…·"""
    from services.agent.tool_registry import ToolRegistry, ToolContext

    print("\n" + "="*80)
    print("ğŸƒ æµ‹è¯•å¡”ç½— (Tarot) å·¥å…·")
    print("="*80)

    skill_data = profile.get("skill_data", {})

    context = ToolContext(
        user_id=TEST_USER_ID,
        user_tier="paid",
        profile=profile,
        skill_data=skill_data,
        skill_id="tarot",
        scenario_id="single_card"
    )

    # æµ‹è¯• draw_tarot_card
    if ToolRegistry.has_handler("draw_tarot_card"):
        print("\nğŸ”§ æµ‹è¯•: draw_tarot_card")
        try:
            result = await ToolRegistry.execute(
                "draw_tarot_card",
                {"question": "ä»Šå¤©çš„æŒ‡å¼•æ˜¯ä»€ä¹ˆï¼Ÿ"},
                context
            )
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                print(f"\n  æŠ½åˆ°çš„ç‰Œ:")
                print(f"  â€¢ ç‰Œå: {data.get('card_name')}")
                print(f"  â€¢ æ­£é€†: {data.get('orientation')}")
                print(f"  â€¢ å…³é”®è¯: {', '.join(data.get('keywords', []))}")
                print(f"  â€¢ å«ä¹‰: {data.get('meaning', '')[:80]}...")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: draw_tarot_card")


async def test_core_tools(profile: Dict[str, Any]):
    """æµ‹è¯• Core Skill å·¥å…·"""
    from services.agent.tool_registry import ToolRegistry, ToolContext

    print("\n" + "="*80)
    print("ğŸ¯ æµ‹è¯• Core Skill å·¥å…·")
    print("="*80)

    skill_data = profile.get("skill_data", {})

    context = ToolContext(
        user_id=TEST_USER_ID,
        user_tier="paid",
        profile=profile,
        skill_data=skill_data,
        skill_id="core",
        scenario_id="goal_tracking"
    )

    # æµ‹è¯• write_user_data
    if ToolRegistry.has_handler("write_user_data"):
        print("\nğŸ”§ æµ‹è¯•: write_user_data")
        try:
            test_goal = {
                "title": "å­¦ä¼šå¼¹å‰ä»–",
                "target_date": "2026-04-19",
                "category": "skill_learning"
            }

            result = await ToolRegistry.execute(
                "write_user_data",
                {
                    "namespace": "goals",
                    "key": "guitar_2026",
                    "data": test_goal
                },
                context
            )
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                print(f"  â€¢ å†™å…¥æˆåŠŸ: goals/guitar_2026")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: write_user_data")

    # æµ‹è¯• query_user_data
    if ToolRegistry.has_handler("query_user_data"):
        print("\nğŸ”§ æµ‹è¯•: query_user_data")
        try:
            result = await ToolRegistry.execute(
                "query_user_data",
                {"namespace": "goals"},
                context
            )
            print(f"  âœ… ç»“æœçŠ¶æ€: {result.get('status')}")

            if result.get('status') == 'success':
                data = result.get('data', {})
                print(f"  â€¢ æŸ¥è¯¢åˆ° {len(data)} æ¡è®°å½•")
                if data:
                    for key, value in list(data.items())[:3]:
                        print(f"    - {key}: {str(value)[:50]}")
            else:
                print(f"  âš ï¸  é”™è¯¯: {result.get('error')}")
        except Exception as e:
            print(f"  âŒ å¼‚å¸¸: {e}")
    else:
        print("  âš ï¸  å·¥å…·æœªæ³¨å†Œ: query_user_data")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Profile æå–æµ‹è¯•
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_profile_extraction():
    """æµ‹è¯• Profile æ•°æ®æå–"""
    print("\n" + "="*80)
    print("ğŸ“Š æµ‹è¯• VibeProfile æ•°æ®æå–")
    print("="*80)

    profile = await get_user_profile()

    if not profile:
        print("âŒ æ— æ³•è·å–ç”¨æˆ· Profile")
        return

    print("\nåŸºç¡€ä¿¡æ¯:")
    print(f"  â€¢ å§“å: {profile.get('display_name')}")
    print(f"  â€¢ æ€§åˆ«: {profile.get('gender')}")

    birth_info = profile.get('birth_info', {})
    print(f"\nå‡ºç”Ÿä¿¡æ¯:")
    print(f"  â€¢ å‡ºç”Ÿæ—¥æœŸ: {birth_info.get('year')}-{birth_info.get('month')}-{birth_info.get('day')}")
    print(f"  â€¢ å‡ºç”Ÿæ—¶é—´: {birth_info.get('hour')}:{birth_info.get('minute')}")
    print(f"  â€¢ å‡ºç”Ÿåœ°ç‚¹: {birth_info.get('location')}")
    print(f"  â€¢ é˜³å†: {birth_info.get('solar_datetime')}")
    print(f"  â€¢ é˜´å†: {birth_info.get('lunar_date')}")

    extracted = profile.get('extracted', {})
    print(f"\næå–çš„ç”¨æˆ·ç‰¹å¾:")
    print(f"  â€¢ æ€§æ ¼: {', '.join(extracted.get('personality_traits', []))}")
    print(f"  â€¢ æŒ‘æˆ˜: {', '.join(extracted.get('life_challenges', []))}")
    print(f"  â€¢ ä»·å€¼è§‚: {', '.join(extracted.get('values', []))}")
    print(f"  â€¢ å…´è¶£: {', '.join(extracted.get('interests', []))}")

    skill_data = profile.get('skill_data', {})
    print(f"\nSkill æ•°æ®:")

    # Bazi
    bazi = skill_data.get('bazi', {})
    if bazi:
        print(f"\n  å…«å­—:")
        print(f"    â€¢ æ—¥ä¸»: {bazi.get('day_master')}")
        print(f"    â€¢ äº”è¡Œ: {bazi.get('five_elements')}")
        print(f"    â€¢ å¼ºå¼±: {bazi.get('strength')}")
        print(f"    â€¢ ç”¨ç¥: {bazi.get('use_god')}")

    # Zodiac
    zodiac = skill_data.get('zodiac', {})
    if zodiac:
        print(f"\n  æ˜Ÿåº§:")
        print(f"    â€¢ å¤ªé˜³: {zodiac.get('sun_sign')}")
        print(f"    â€¢ æœˆäº®: {zodiac.get('moon_sign')}")
        print(f"    â€¢ ä¸Šå‡: {zodiac.get('rising_sign')}")

    # VibeID
    vibe_id = skill_data.get('vibe_id', {})
    if vibe_id:
        print(f"\n  VibeID:")
        archetypes = vibe_id.get('archetypes', {})
        print(f"    â€¢ Core: {archetypes.get('core', {}).get('primary')}")
        print(f"    â€¢ Inner: {archetypes.get('inner', {}).get('primary')}")
        print(f"    â€¢ Outer: {archetypes.get('outer', {}).get('primary')}")
        print(f"    â€¢ Shadow: {archetypes.get('shadow', {}).get('primary')}")

    portrait = profile.get('portrait', '')
    if portrait:
        print(f"\nç”¨æˆ·ç”»åƒ:")
        print(f"  {portrait}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»æµ‹è¯•æµç¨‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("\n" + "="*80)
    print("ğŸ§ª å·¥å…·è°ƒç”¨ä¸ VibeProfile é›†æˆæµ‹è¯•")
    print("   (ä¸ä¾èµ– LLM API)")
    print("="*80)
    print(f"ğŸ“… æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ“¦ æ•°æ®åº“: {os.environ.get('VIBELIFE_DB_HOST')}:{os.environ.get('VIBELIFE_DB_PORT')}")
    print(f"ğŸ‘¤ æµ‹è¯•ç”¨æˆ·: {TEST_USER_ID}")
    print("="*80)

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    print("\nğŸ”Œ æµ‹è¯•æ•°æ®åº“è¿æ¥...")
    try:
        from stores.db import get_connection
        async with get_connection() as conn:
            result = await conn.fetchval("SELECT 1")
            print(f"  âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
    except Exception as e:
        print(f"  âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return

    # åˆå§‹åŒ–å·¥å…·æ³¨å†Œè¡¨
    print("\nğŸ”§ åˆå§‹åŒ–å·¥å…·æ³¨å†Œè¡¨...")
    from services.agent.tool_registry import ToolRegistry
    ToolRegistry.initialize()

    all_tools = list(ToolRegistry._handlers.keys())
    print(f"  âœ… å·²æ³¨å†Œ {len(all_tools)} ä¸ªå·¥å…·")

    # æŒ‰ skill åˆ†ç»„æ˜¾ç¤º
    skill_tools = {}
    for tool in all_tools:
        # æ ¹æ®å·¥å…·åæ¨æ–­æ‰€å± skill
        if any(x in tool for x in ['bazi', 'pillar', 'fortune', 'grand']):
            skill = 'bazi'
        elif any(x in tool for x in ['zodiac', 'lunar', 'planet', 'retrograde']):
            skill = 'zodiac'
        elif any(x in tool for x in ['tarot', 'card', 'spread']):
            skill = 'tarot'
        elif any(x in tool for x in ['vibe_id', 'archetype', 'radar']):
            skill = 'vibe_id'
        elif any(x in tool for x in ['career', 'job']):
            skill = 'career'
        else:
            skill = 'core'

        if skill not in skill_tools:
            skill_tools[skill] = []
        skill_tools[skill].append(tool)

    for skill, tools in sorted(skill_tools.items()):
        print(f"  â€¢ {skill:12} {len(tools)} ä¸ªå·¥å…·")

    # è·å–ç”¨æˆ· Profile
    print("\nğŸ‘¤ è·å–ç”¨æˆ· Profile...")
    profile = await get_user_profile()

    if not profile:
        print("  âŒ ç”¨æˆ·ä¸å­˜åœ¨ï¼Œè¯·å…ˆè¿è¡Œ test_real_user_scenarios.py åˆ›å»ºæµ‹è¯•ç”¨æˆ·")
        return

    print(f"  âœ… Profile åŠ è½½æˆåŠŸ")

    # è¿è¡Œ Profile æå–æµ‹è¯•
    await test_profile_extraction()

    # è¿è¡Œå„ Skill å·¥å…·æµ‹è¯•
    await test_bazi_tools(profile)
    await test_zodiac_tools(profile)
    await test_vibe_id_tools(profile)
    await test_tarot_tools(profile)
    await test_core_tools(profile)

    # æ€»ç»“
    print("\n\n" + "="*80)
    print("âœ… æµ‹è¯•å®Œæˆ")
    print("="*80)
    print("\nè¯´æ˜:")
    print("  â€¢ æ­¤æµ‹è¯•ç›´æ¥è°ƒç”¨å·¥å…·ï¼Œä¸ä¾èµ– LLM API")
    print("  â€¢ éªŒè¯äº†å·¥å…·æ³¨å†Œè¡¨ã€VibeProfile æå–ã€å·¥å…·è°ƒç”¨é“¾è·¯")
    print("  â€¢ çœŸå®æ•°æ®åº“è¿æ¥ï¼ŒçœŸå®ç”¨æˆ·æ•°æ®")
    print("  â€¢ å¯ä»¥ç”¨äºéªŒè¯ CoreAgent çš„å·¥å…·å±‚åŸºç¡€è®¾æ–½")


if __name__ == "__main__":
    asyncio.run(main())
