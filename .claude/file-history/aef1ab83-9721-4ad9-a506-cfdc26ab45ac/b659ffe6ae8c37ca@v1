#!/usr/bin/env python3
"""数据库诊断"""
import asyncio
import sys
from pathlib import Path
import os

sys.path.insert(0, str(Path(__file__).parent.parent))

os.environ["VIBELIFE_ENV"] = "test"
from dotenv import load_dotenv
load_dotenv(Path(__file__).resolve().parents[2] / ".env.test")

DB_HOST = "106.37.170.238"
DB_PORT = "8224"
DB_NAME = "vibelife"
DB_USER = "postgres"
DB_PASSWORD = os.getenv("VIBELIFE_DB_PASSWORD", "")
os.environ["VIBELIFE_DB_URL"] = f"postgresql://{DB_USER}:{DB_PASSWORD}@{DB_HOST}:{DB_PORT}/{DB_NAME}"

print(f"数据库连接: {DB_HOST}:{DB_PORT}/{DB_NAME}")
print(f"用户: {DB_USER}")
print(f"密码设置: {'是' if DB_PASSWORD else '否'}")
print()

from stores.db import get_connection, fetchval, fetch

async def main():
    print("="*60)
    print("数据库诊断")
    print("="*60)

    # 测试连接
    print("\n1. 测试连接...")
    try:
        async with get_connection() as conn:
            result = await conn.fetchval("SELECT 1")
            print(f"  ✓ 连接成功")
    except Exception as e:
        print(f"  ✗ 连接失败: {e}")
        return

    # 检查表是否存在
    print("\n2. 检查 unified_profiles 表...")
    try:
        exists = await fetchval(
            "SELECT EXISTS(SELECT 1 FROM information_schema.tables WHERE table_name = 'unified_profiles')"
        )
        print(f"  表存在: {exists}")
    except Exception as e:
        print(f"  ✗ 查询失败: {e}")
        return

    if not exists:
        print("  ⚠️  表不存在，需要运行迁移")
        return

    # 统计记录数
    print("\n3. 统计记录数...")
    try:
        count = await fetchval("SELECT COUNT(*) FROM unified_profiles")
        print(f"  记录数: {count}")
    except Exception as e:
        print(f"  ✗ 查询失败: {e}")
        return

    # 列出前几个用户
    if count > 0:
        print("\n4. 列出前10个用户...")
        try:
            rows = await fetch(
                "SELECT user_id::text, (profile->>'display_name') as name, created_at FROM unified_profiles ORDER BY created_at DESC LIMIT 10"
            )
            for row in rows:
                print(f"  {row['user_id']} - {row['name']} (创建于 {row['created_at']})")
        except Exception as e:
            print(f"  ✗ 查询失败: {e}")
    else:
        print("\n4. 数据库为空，没有用户数据")

    print("\n" + "="*60)

if __name__ == "__main__":
    asyncio.run(main())
