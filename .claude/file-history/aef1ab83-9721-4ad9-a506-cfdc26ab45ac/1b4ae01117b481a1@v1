#!/usr/bin/env python3
"""
创建测试用户
为测试场景准备完整的用户数据
"""
import asyncio
import json
import os
import sys
from pathlib import Path
import uuid

sys.path.insert(0, str(Path(__file__).parent.parent))

os.environ["VIBELIFE_ENV"] = "test"
os.environ["VIBELIFE_DB_HOST"] = "106.37.170.238"
os.environ["VIBELIFE_DB_PORT"] = "8224"

from dotenv import load_dotenv
load_dotenv(Path(__file__).resolve().parents[2] / ".env.test")

from stores.db import execute, fetchrow


TEST_USER_ID = "f43b745f-5a70-4ed1-aaa7-637fb1f87a61"


async def main():
    """创建测试用户"""
    print("="*60)
    print("创建测试用户")
    print("="*60)
    print(f"用户 ID: {TEST_USER_ID}")

    # 检查是否已存在
    row = await fetchrow(
        "SELECT user_id FROM unified_profiles WHERE user_id = $1",
        uuid.UUID(TEST_USER_ID)
    )

    if row:
        print("✓ 用户已存在")
        return

    # 创建用户数据
    profile = {
        "display_name": "测试用户",
        "gender": "male",
        "birth_info": {
            "datetime": "1995-06-15T10:30:00",
            "year": 1995,
            "month": 6,
            "day": 15,
            "hour": 10,
            "minute": 30,
            "location": "北京",
            "timezone": "Asia/Shanghai",
            "solar_datetime": "1995-06-15T10:30:00",
            "lunar_date": "1995年五月十八"
        },
        "extracted": {
            "personality_traits": ["内向", "思考型", "完美主义"],
            "life_challenges": ["职业方向不清晰", "人际关系压力"],
            "values": ["成长", "稳定", "自由"],
            "interests": ["阅读", "音乐", "旅行"]
        },
        "skill_data": {
            "bazi": {
                "calculated": True,
                "pillars": {
                    "year": {"heavenly_stem": "乙", "earthly_branch": "亥"},
                    "month": {"heavenly_stem": "壬", "earthly_branch": "午"},
                    "day": {"heavenly_stem": "丙", "earthly_branch": "申"},
                    "hour": {"heavenly_stem": "癸", "earthly_branch": "巳"}
                },
                "day_master": "丙火",
                "five_elements": {"金": 2, "木": 1, "水": 3, "火": 2, "土": 0},
                "strength": "偏弱",
                "use_god": "木"
            },
            "zodiac": {
                "sun_sign": "Gemini",
                "moon_sign": "Pisces",
                "rising_sign": "Libra",
                "chart_calculated": True
            },
            "vibe_id": {
                "calculated": True,
                "archetypes": {
                    "core": {"primary": "Sage", "secondary": "Creator"},
                    "inner": {"primary": "Caregiver", "secondary": "Innocent"},
                    "outer": {"primary": "Hero", "secondary": "Explorer"},
                    "shadow": {"primary": "Outlaw", "secondary": "Jester"}
                },
                "scores": {
                    "Sage": 85.0,
                    "Creator": 75.0,
                    "Hero": 70.0,
                    "Caregiver": 68.0,
                    "Explorer": 65.0,
                    "Outlaw": 60.0,
                    "Jester": 55.0,
                    "Lover": 52.0,
                    "Ruler": 50.0,
                    "Magician": 48.0,
                    "Innocent": 45.0,
                    "Everyman": 40.0
                }
            }
        },
        "portrait": "一个1995年出生的90后，性格内向但有深度思考能力，追求完美主义。目前在职业发展上面临选择，寻求成长与稳定的平衡。"
    }

    # 插入数据库
    await execute(
        """
        INSERT INTO unified_profiles (user_id, profile, created_at, updated_at)
        VALUES ($1, $2, NOW(), NOW())
        """,
        uuid.UUID(TEST_USER_ID),
        json.dumps(profile, ensure_ascii=False)
    )

    print("✓ 用户创建成功")
    print(f"\n用户数据:")
    print(f"  • 姓名: {profile['display_name']}")
    print(f"  • 出生: {profile['birth_info']['year']}-{profile['birth_info']['month']}-{profile['birth_info']['day']}")
    print(f"  • 八字: {profile['skill_data']['bazi']['day_master']}")
    print(f"  • 星座: {profile['skill_data']['zodiac']['sun_sign']}")
    print(f"  • VibeID: {profile['skill_data']['vibe_id']['archetypes']['core']['primary']}")


if __name__ == "__main__":
    asyncio.run(main())
