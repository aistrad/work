#!/usr/bin/env python3
"""
çœŸå®ç”¨æˆ·åœºæ™¯ç«¯åˆ°ç«¯æµ‹è¯•
è¿æ¥çœŸå®æ•°æ®åº“ï¼Œæµ‹è¯• CoreAgent + Skill + VibeProfile åä½œ

ç”¨æ³•:
    cd /home/aiscend/work/vibelife/apps/api
    python scripts/test_real_user_scenarios.py

ç‰¹æ€§:
- ä½¿ç”¨çœŸå®æ•°æ®åº“ (106.37.170.238:8224/vibelife)
- æµ‹è¯•å¤šä¸ª Skill (bazi, zodiac, tarot, career, vibe_id)
- æµ‹è¯• VibeProfile æå–å’Œä½¿ç”¨
- æµ‹è¯•å·¥å…·è°ƒç”¨é“¾è·¯å®Œæ•´æ€§
"""
import asyncio
import json
import os
import sys
from datetime import datetime
from pathlib import Path
from typing import Dict, Any, List, Optional
from uuid import UUID
from dataclasses import dataclass

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

# è®¾ç½®æµ‹è¯•ç¯å¢ƒå˜é‡
os.environ["VIBELIFE_ENV"] = "test"

# åŠ è½½ .env.test
from dotenv import load_dotenv
_project_root = Path(__file__).resolve().parents[2]  # scripts -> api -> apps -> project root
load_dotenv(_project_root / ".env.test")

print(f"âœ“ æ•°æ®åº“è¿æ¥: {os.environ.get('VIBELIFE_DB_HOST')}:{os.environ.get('VIBELIFE_DB_PORT')}")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•åœºæ™¯å®šä¹‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@dataclass
class RealScenario:
    """çœŸå®ç”¨æˆ·åœºæ™¯"""
    name: str
    skill: str
    user_message: str
    description: str
    expected_tools: List[str]  # æœŸæœ›è°ƒç”¨çš„å·¥å…·
    check_profile_usage: bool = False  # æ˜¯å¦æ£€æŸ¥ profile ä½¿ç”¨


REAL_SCENARIOS = [
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Core Skill åœºæ™¯
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RealScenario(
        name="æ—¥å¸¸å€¾è¯‰ - æƒ…æ„Ÿæ”¯æŒ",
        skill="core",
        user_message="æœ€è¿‘å·¥ä½œå‹åŠ›å¥½å¤§ï¼Œæ„Ÿè§‰å¾ˆç„¦è™‘ï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆåŠ",
        description="ç”¨æˆ·å¯»æ±‚æƒ…æ„Ÿæ”¯æŒå’Œå€¾å¬",
        expected_tools=[],
        check_profile_usage=True
    ),
    RealScenario(
        name="ç›®æ ‡è®¾å®š",
        skill="core",
        user_message="æˆ‘æƒ³è®¾å®šä¸€ä¸ªç›®æ ‡ï¼šåœ¨3ä¸ªæœˆå†…å­¦ä¼šå¼¹å‰ä»–ï¼Œè¯·å¸®æˆ‘è®°å½•",
        description="ç”¨æˆ·è®¾å®šç›®æ ‡ï¼Œéœ€è¦è°ƒç”¨ write_user_data å·¥å…·",
        expected_tools=["write_user_data"],
        check_profile_usage=False
    ),
    RealScenario(
        name="æŸ¥è¯¢ç›®æ ‡",
        skill="core",
        user_message="çœ‹çœ‹æˆ‘è®¾å®šçš„æ‰€æœ‰ç›®æ ‡",
        description="ç”¨æˆ·æŸ¥è¯¢å·²è®¾å®šçš„ç›®æ ‡",
        expected_tools=["query_user_data"],
        check_profile_usage=False
    ),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Bazi Skill åœºæ™¯
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RealScenario(
        name="å…«å­—æŸ¥è¯¢ - äº‹ä¸šè¿",
        skill="bazi",
        user_message="å¸®æˆ‘çœ‹çœ‹æˆ‘çš„äº‹ä¸šè¿åŠ¿æ€ä¹ˆæ ·",
        description="ç”¨æˆ·æŸ¥è¯¢å…«å­—äº‹ä¸šè¿",
        expected_tools=["show_bazi_chart"],
        check_profile_usage=True
    ),
    RealScenario(
        name="å…«å­—æŸ¥è¯¢ - ä»Šæ—¥è¿åŠ¿",
        skill="bazi",
        user_message="ä»Šå¤©çš„è¿åŠ¿å¦‚ä½•ï¼Ÿ",
        description="ç”¨æˆ·æŸ¥è¯¢ä»Šæ—¥è¿åŠ¿",
        expected_tools=["show_daily_fortune"],
        check_profile_usage=True
    ),
    RealScenario(
        name="å…«å­—æŸ¥è¯¢ - å¤§è¿æµå¹´",
        skill="bazi",
        user_message="æˆ‘ä»Šå¹´çš„æµå¹´è¿åŠ¿å¦‚ä½•ï¼Ÿ",
        description="ç”¨æˆ·æŸ¥è¯¢æµå¹´è¿åŠ¿",
        expected_tools=["show_bazi_chart", "analyze_grand_fortune"],
        check_profile_usage=True
    ),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Zodiac Skill åœºæ™¯
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RealScenario(
        name="æ˜Ÿåº§æŸ¥è¯¢ - æœ¬å‘¨è¿åŠ¿",
        skill="zodiac",
        user_message="æˆ‘çš„æ˜Ÿåº§æœ¬å‘¨è¿åŠ¿å¦‚ä½•ï¼Ÿ",
        description="ç”¨æˆ·æŸ¥è¯¢æ˜Ÿåº§æœ¬å‘¨è¿åŠ¿",
        expected_tools=["show_zodiac_chart", "show_weekly_fortune"],
        check_profile_usage=True
    ),
    RealScenario(
        name="æ˜Ÿåº§æŸ¥è¯¢ - æœˆç›¸",
        skill="zodiac",
        user_message="ç°åœ¨æ˜¯ä»€ä¹ˆæœˆç›¸ï¼Ÿ",
        description="ç”¨æˆ·æŸ¥è¯¢å½“å‰æœˆç›¸",
        expected_tools=["show_lunar_phase"],
        check_profile_usage=False
    ),
    RealScenario(
        name="æ˜Ÿåº§æŸ¥è¯¢ - è¡Œæ˜Ÿé€†è¡Œ",
        skill="zodiac",
        user_message="ç°åœ¨æœ‰å“ªäº›è¡Œæ˜Ÿé€†è¡Œï¼Ÿ",
        description="ç”¨æˆ·æŸ¥è¯¢è¡Œæ˜Ÿé€†è¡Œæƒ…å†µ",
        expected_tools=["show_retrograde_planets"],
        check_profile_usage=False
    ),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Tarot Skill åœºæ™¯
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RealScenario(
        name="å¡”ç½—å åœ - å•å¼ ç‰Œ",
        skill="tarot",
        user_message="å¸®æˆ‘æŠ½ä¸€å¼ å¡”ç½—ç‰Œï¼Œçœ‹çœ‹ä»Šå¤©çš„æŒ‡å¼•",
        description="ç”¨æˆ·è¯·æ±‚å•å¼ å¡”ç½—ç‰Œå åœ",
        expected_tools=["draw_tarot_card"],
        check_profile_usage=True
    ),
    RealScenario(
        name="å¡”ç½—å åœ - ä¸‰ç‰Œé˜µ",
        skill="tarot",
        user_message="æˆ‘æƒ³ç”¨ä¸‰ç‰Œé˜µçœ‹çœ‹æˆ‘çš„æ„Ÿæƒ…é—®é¢˜ï¼šè¿‡å»-ç°åœ¨-æœªæ¥",
        description="ç”¨æˆ·è¯·æ±‚ä¸‰ç‰Œé˜µå åœ",
        expected_tools=["draw_tarot_spread"],
        check_profile_usage=True
    ),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # VibeID Skill åœºæ™¯
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RealScenario(
        name="VibeID - æŸ¥çœ‹äººæ ¼ç”»åƒ",
        skill="vibe_id",
        user_message="å±•ç¤ºæˆ‘çš„äººæ ¼ç”»åƒ",
        description="ç”¨æˆ·æŸ¥çœ‹å®Œæ•´äººæ ¼ç”»åƒ",
        expected_tools=["show_vibe_id"],
        check_profile_usage=True
    ),
    RealScenario(
        name="VibeID - æŸ¥çœ‹åŸå‹é›·è¾¾å›¾",
        skill="vibe_id",
        user_message="æˆ‘æƒ³çœ‹12åŸå‹çš„åˆ†å¸ƒ",
        description="ç”¨æˆ·æŸ¥çœ‹åŸå‹é›·è¾¾å›¾",
        expected_tools=["show_archetype_radar"],
        check_profile_usage=True
    ),
    RealScenario(
        name="VibeID - æŸ¥çœ‹é˜´å½±åŸå‹",
        skill="vibe_id",
        user_message="åˆ†ææˆ‘çš„é˜´å½±åŸå‹",
        description="ç”¨æˆ·æƒ³äº†è§£é˜´å½±åŸå‹",
        expected_tools=["show_vibe_id", "get_archetype_info"],
        check_profile_usage=True
    ),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Career Skill åœºæ™¯
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RealScenario(
        name="èŒä¸šè§„åˆ’ - èŒä¸šå»ºè®®",
        skill="career",
        user_message="æˆ‘æƒ³åšèŒä¸šè§„åˆ’ï¼Œä½ æœ‰ä»€ä¹ˆå»ºè®®å—ï¼Ÿ",
        description="ç”¨æˆ·å¯»æ±‚èŒä¸šè§„åˆ’å»ºè®®",
        expected_tools=["get_career_insights"],
        check_profile_usage=True
    ),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # è·¨ Skill åœºæ™¯
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    RealScenario(
        name="ç»¼åˆåˆ†æ - äº‹ä¸š+æ˜Ÿåº§",
        skill="bazi",  # ä»å…«å­—å¼€å§‹
        user_message="ç»“åˆæˆ‘çš„å…«å­—å’Œæ˜Ÿåº§ï¼Œå¸®æˆ‘çœ‹çœ‹äº‹ä¸šæ–¹å‘",
        description="ç”¨æˆ·è¯·æ±‚ç»¼åˆå¤šä¸ªç»´åº¦åˆ†æ",
        expected_tools=["show_bazi_chart", "use_skill"],  # å¯èƒ½åˆ‡æ¢åˆ°å…¶ä»– skill
        check_profile_usage=True
    ),
]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•ç”¨æˆ·æ•°æ®ç®¡ç†
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def get_or_create_test_user() -> Dict[str, Any]:
    """è·å–æˆ–åˆ›å»ºæµ‹è¯•ç”¨æˆ·"""
    from stores.db import fetchrow, execute

    TEST_USER_ID = "test-real-scenario-001"

    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    row = await fetchrow(
        "SELECT user_id, profile FROM unified_profiles WHERE user_id = $1",
        UUID(TEST_USER_ID)
    )

    if row:
        print(f"âœ“ ä½¿ç”¨å·²æœ‰æµ‹è¯•ç”¨æˆ·: {TEST_USER_ID}")
        profile = row["profile"]
        if isinstance(profile, str):
            profile = json.loads(profile)
        return {
            "user_id": TEST_USER_ID,
            "profile": profile
        }

    # åˆ›å»ºæ–°ç”¨æˆ·
    print(f"âœ“ åˆ›å»ºæ–°æµ‹è¯•ç”¨æˆ·: {TEST_USER_ID}")

    test_profile = {
        "display_name": "æµ‹è¯•ç”¨æˆ·",
        "gender": "male",
        "birth_info": {
            "datetime": "1995-06-15T10:30:00",
            "year": 1995,
            "month": 6,
            "day": 15,
            "hour": 10,
            "minute": 30,
            "location": "åŒ—äº¬",
            "timezone": "Asia/Shanghai",
            "solar_datetime": "1995-06-15T10:30:00",
            "lunar_date": "1995å¹´äº”æœˆåå…«"
        },
        "extracted": {
            "personality_traits": ["å†…å‘", "æ€è€ƒå‹", "å®Œç¾ä¸»ä¹‰"],
            "life_challenges": ["èŒä¸šæ–¹å‘ä¸æ¸…æ™°", "äººé™…å…³ç³»å‹åŠ›"],
            "values": ["æˆé•¿", "ç¨³å®š", "è‡ªç”±"],
            "interests": ["é˜…è¯»", "éŸ³ä¹", "æ—…è¡Œ"]
        },
        "skill_data": {
            "bazi": {
                "calculated": True,
                "pillars": {
                    "year": {"heavenly_stem": "ä¹™", "earthly_branch": "äº¥"},
                    "month": {"heavenly_stem": "å£¬", "earthly_branch": "åˆ"},
                    "day": {"heavenly_stem": "ä¸™", "earthly_branch": "ç”³"},
                    "hour": {"heavenly_stem": "ç™¸", "earthly_branch": "å·³"}
                },
                "day_master": "ä¸™ç«",
                "five_elements": {"é‡‘": 2, "æœ¨": 1, "æ°´": 3, "ç«": 2, "åœŸ": 0},
                "strength": "åå¼±",
                "use_god": "æœ¨"
            },
            "zodiac": {
                "sun_sign": "Gemini",
                "moon_sign": "Pisces",
                "rising_sign": "Libra",
                "chart_calculated": True
            },
            "vibe_id": {
                "calculated": True,
                "archetypes": {
                    "core": {"primary": "Sage", "secondary": "Creator"},
                    "inner": {"primary": "Caregiver", "secondary": "Innocent"},
                    "outer": {"primary": "Hero", "secondary": "Explorer"},
                    "shadow": {"primary": "Outlaw", "secondary": "Jester"}
                },
                "scores": {
                    "Sage": 85.0,
                    "Creator": 75.0,
                    "Hero": 70.0,
                    "Caregiver": 68.0,
                    "Explorer": 65.0,
                    "Outlaw": 60.0,
                    "Jester": 55.0,
                    "Lover": 52.0,
                    "Ruler": 50.0,
                    "Magician": 48.0,
                    "Innocent": 45.0,
                    "Everyman": 40.0
                }
            }
        },
        "portrait": "ä¸€ä¸ª1995å¹´å‡ºç”Ÿçš„90åï¼Œæ€§æ ¼å†…å‘ä½†æœ‰æ·±åº¦æ€è€ƒèƒ½åŠ›ï¼Œè¿½æ±‚å®Œç¾ä¸»ä¹‰ã€‚ç›®å‰åœ¨èŒä¸šå‘å±•ä¸Šé¢ä¸´é€‰æ‹©ï¼Œå¯»æ±‚æˆé•¿ä¸ç¨³å®šçš„å¹³è¡¡ã€‚"
    }

    await execute(
        """
        INSERT INTO unified_profiles (user_id, profile, created_at, updated_at)
        VALUES ($1, $2, NOW(), NOW())
        ON CONFLICT (user_id) DO UPDATE SET
            profile = EXCLUDED.profile,
            updated_at = NOW()
        """,
        UUID(TEST_USER_ID),
        json.dumps(test_profile)
    )

    return {
        "user_id": TEST_USER_ID,
        "profile": test_profile
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# åœºæ™¯æ‰§è¡Œå™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def run_scenario(
    scenario: RealScenario,
    user_data: Dict[str, Any]
) -> Dict[str, Any]:
    """æ‰§è¡Œå•ä¸ªåœºæ™¯æµ‹è¯•"""
    from services.agent import create_agent, AgentContext

    print(f"\n{'='*80}")
    print(f"ğŸ“ {scenario.name}")
    print(f"{'='*80}")
    print(f"ğŸ”¹ Skill: {scenario.skill}")
    print(f"ğŸ”¹ ç”¨æˆ·: \"{scenario.user_message}\"")
    print(f"ğŸ”¹ æœŸæœ›: {scenario.description}")
    print(f"ğŸ”¹ æœŸæœ›å·¥å…·: {', '.join(scenario.expected_tools) if scenario.expected_tools else 'æ— '}")
    print(f"{'â”€'*80}\n")

    # æ„å»ºä¸Šä¸‹æ–‡
    context = AgentContext(
        user_id=user_data["user_id"],
        user_tier="paid",
        profile=user_data["profile"],
        skill_data=user_data["profile"].get("skill_data", {}),
        history=[],
        skill=scenario.skill,
        voice_mode="warm",
        portrait=user_data["profile"].get("portrait")
    )

    # åˆ›å»º Agent
    agent = create_agent(max_iterations=5)

    # æ”¶é›†äº‹ä»¶
    tool_calls = []
    content_parts = []
    sop_events = []
    thinking_count = 0

    try:
        print("ğŸ“¤ Agent è¾“å‡º:\n")

        async for event in agent.run(scenario.user_message, context):

            if event.type == "thinking":
                thinking_count += 1
                iteration = event.data.get('iteration', 0) + 1
                print(f"  ğŸ’­ æ€è€ƒä¸­ (ç¬¬ {iteration} è½®)...")

            elif event.type == "sop_phase":
                sop_events.append(event.data)
                data = event.data
                print(f"  ğŸ“‹ SOP: skill={data.get('skill')}, scenario={data.get('scenario')}, action={data.get('action')}")

            elif event.type == "tool_call":
                data = event.data
                tool_calls.append(data)
                tool_name = data['name']
                print(f"\n  ğŸ”§ å·¥å…·è°ƒç”¨: {tool_name}")

                args = data.get('arguments', '{}')
                if isinstance(args, str):
                    try:
                        args = json.loads(args)
                    except:
                        pass

                # æ ¼å¼åŒ–å‚æ•°æ˜¾ç¤º
                if args:
                    args_str = json.dumps(args, ensure_ascii=False, indent=6)
                    if len(args_str) > 300:
                        args_str = args_str[:300] + "..."
                    print(f"     å‚æ•°: {args_str}")

            elif event.type == "tool_result":
                data = event.data
                result = data.get('result', {})

                if isinstance(result, dict):
                    status = result.get('status', 'unknown')
                    print(f"  âœ… ç»“æœ: status={status}")

                    # æ˜¾ç¤ºå…³é”®ä¿¡æ¯
                    if 'data' in result and result['data']:
                        result_data = result['data']
                        if isinstance(result_data, dict):
                            # æ˜¾ç¤ºéƒ¨åˆ†æ•°æ®
                            sample_keys = list(result_data.keys())[:3]
                            print(f"     æ•°æ®å­—æ®µ: {', '.join(sample_keys)}...")
                else:
                    print(f"  âœ… ç»“æœ: {str(result)[:100]}")

            elif event.type == "content":
                content = event.data.get("content", "")
                content_parts.append(content)
                print(content, end="", flush=True)

            elif event.type == "done":
                if not content_parts:
                    final = event.data.get("content", "")
                    if final:
                        print(final)

            elif event.type == "error":
                error_msg = event.data.get('error')
                print(f"\n  âŒ é”™è¯¯: {error_msg}")

    except Exception as e:
        print(f"\nâŒ æ‰§è¡Œå¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        return {
            "scenario": scenario.name,
            "success": False,
            "error": str(e)
        }

    # æ£€æŸ¥ç»“æœ
    full_content = "".join(content_parts)
    tool_names = [tc['name'] for tc in tool_calls]

    # éªŒè¯æœŸæœ›å·¥å…·
    tools_matched = True
    if scenario.expected_tools:
        tools_matched = any(
            expected in tool_names
            for expected in scenario.expected_tools
        )

    print(f"\n\n{'â”€'*80}")
    print("ğŸ“Š æ‰§è¡Œç»“æœ:")
    print(f"  â€¢ æ€è€ƒè½®æ¬¡: {thinking_count}")
    print(f"  â€¢ SOP äº‹ä»¶: {len(sop_events)}")
    print(f"  â€¢ å·¥å…·è°ƒç”¨: {len(tool_calls)}")
    if tool_calls:
        print(f"  â€¢ å·¥å…·åˆ—è¡¨: {', '.join(tool_names)}")
    print(f"  â€¢ æœŸæœ›å·¥å…·: {', '.join(scenario.expected_tools) if scenario.expected_tools else 'æ— '}")
    print(f"  â€¢ å·¥å…·åŒ¹é…: {'âœ“' if tools_matched else 'âœ—'}")
    print(f"  â€¢ å›å¤é•¿åº¦: {len(full_content)} å­—ç¬¦")
    print(f"  â€¢ Token ä½¿ç”¨: {agent.usage}")

    # Profile ä½¿ç”¨æ£€æŸ¥
    if scenario.check_profile_usage:
        # æ£€æŸ¥ profile æ•°æ®æ˜¯å¦è¢«ä½¿ç”¨
        profile_used = (
            any(skill in str(tool_calls) for skill in ['bazi', 'zodiac', 'vibe_id']) or
            any(field in full_content for field in ['å‡ºç”Ÿ', 'å…«å­—', 'æ˜Ÿåº§', 'åŸå‹'])
        )
        print(f"  â€¢ Profile ä½¿ç”¨: {'âœ“' if profile_used else 'âœ—'}")

    return {
        "scenario": scenario.name,
        "skill": scenario.skill,
        "success": True,
        "tools_matched": tools_matched,
        "tool_calls": tool_names,
        "thinking_count": thinking_count,
        "sop_events": len(sop_events),
        "content_length": len(full_content),
        "usage": agent.usage
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ä¸»æµ‹è¯•æµç¨‹
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("\n" + "â•"*80)
    print("ğŸš€ çœŸå®ç”¨æˆ·åœºæ™¯ç«¯åˆ°ç«¯æµ‹è¯•")
    print("   CoreAgent + Skill + VibeProfile åä½œ")
    print("â•"*80)
    print(f"ğŸ“… æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ”§ ç¯å¢ƒ: {os.environ.get('VIBELIFE_ENV', 'unknown')}")
    print(f"ğŸ“¦ æ•°æ®åº“: {os.environ.get('VIBELIFE_DB_HOST')}:{os.environ.get('VIBELIFE_DB_PORT')}")
    print("â•"*80)

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    print("\nğŸ”Œ æµ‹è¯•æ•°æ®åº“è¿æ¥...")
    try:
        from stores.db import get_connection
        async with get_connection() as conn:
            result = await conn.fetchval("SELECT 1")
            print(f"  âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
    except Exception as e:
        print(f"  âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return

    # åˆå§‹åŒ–å·¥å…·æ³¨å†Œè¡¨
    print("\nğŸ”§ åˆå§‹åŒ–å·¥å…·æ³¨å†Œè¡¨...")
    from services.agent.tool_registry import ToolRegistry
    ToolRegistry.initialize()

    # è·å–æ‰€æœ‰æ³¨å†Œçš„å·¥å…·
    all_tools = list(ToolRegistry._handlers.keys())
    print(f"  âœ… å·²æ³¨å†Œ {len(all_tools)} ä¸ªå·¥å…·")
    print(f"     {', '.join(all_tools[:10])}...")

    # è·å–æˆ–åˆ›å»ºæµ‹è¯•ç”¨æˆ·
    print("\nğŸ‘¤ å‡†å¤‡æµ‹è¯•ç”¨æˆ·...")
    user_data = await get_or_create_test_user()
    print(f"  âœ… ç”¨æˆ· ID: {user_data['user_id']}")

    # æ˜¾ç¤ºç”¨æˆ·æ•°æ®æ‘˜è¦
    profile = user_data['profile']
    birth_info = profile.get('birth_info', {})
    print(f"  â€¢ å‡ºç”Ÿ: {birth_info.get('year')}-{birth_info.get('month')}-{birth_info.get('day')}")
    print(f"  â€¢ å…«å­—: {'âœ“' if profile.get('skill_data', {}).get('bazi') else 'âœ—'}")
    print(f"  â€¢ æ˜Ÿåº§: {'âœ“' if profile.get('skill_data', {}).get('zodiac') else 'âœ—'}")
    print(f"  â€¢ VibeID: {'âœ“' if profile.get('skill_data', {}).get('vibe_id') else 'âœ—'}")

    # è¿è¡Œæµ‹è¯•åœºæ™¯
    print("\n" + "â•"*80)
    print("ğŸ¬ å¼€å§‹æ‰§è¡Œæµ‹è¯•åœºæ™¯")
    print("â•"*80)

    results = []
    for i, scenario in enumerate(REAL_SCENARIOS, 1):
        print(f"\n\n[åœºæ™¯ {i}/{len(REAL_SCENARIOS)}]")

        try:
            result = await run_scenario(scenario, user_data)
            results.append(result)

            # çŸ­æš‚å»¶è¿Ÿï¼Œé¿å… API é™æµ
            await asyncio.sleep(1)

        except Exception as e:
            print(f"\nâŒ åœºæ™¯æ‰§è¡Œå¤±è´¥: {e}")
            import traceback
            traceback.print_exc()
            results.append({
                "scenario": scenario.name,
                "success": False,
                "error": str(e)
            })

    # æ±‡æ€»æŠ¥å‘Š
    print("\n\n" + "â•"*80)
    print("ğŸ“ˆ æµ‹è¯•æ±‡æ€»æŠ¥å‘Š")
    print("â•"*80)

    success_count = sum(1 for r in results if r.get('success'))
    tools_matched_count = sum(1 for r in results if r.get('tools_matched'))

    print(f"\næ€»ä½“ç»Ÿè®¡:")
    print(f"  â€¢ æ€»åœºæ™¯æ•°: {len(REAL_SCENARIOS)}")
    print(f"  â€¢ æˆåŠŸåœºæ™¯: {success_count}/{len(REAL_SCENARIOS)}")
    print(f"  â€¢ å·¥å…·åŒ¹é…: {tools_matched_count}/{len(REAL_SCENARIOS)}")
    print(f"  â€¢ æˆåŠŸç‡: {success_count/len(REAL_SCENARIOS)*100:.1f}%")

    # æŒ‰ Skill åˆ†ç»„ç»Ÿè®¡
    print(f"\næŒ‰ Skill ç»Ÿè®¡:")
    skill_stats = {}
    for r in results:
        if not r.get('success'):
            continue
        skill = r.get('skill', 'unknown')
        if skill not in skill_stats:
            skill_stats[skill] = {
                'count': 0,
                'total_tokens': 0,
                'total_tools': 0
            }
        skill_stats[skill]['count'] += 1
        usage = r.get('usage', {})
        skill_stats[skill]['total_tokens'] += usage.get('total_tokens', 0)
        skill_stats[skill]['total_tools'] += len(r.get('tool_calls', []))

    for skill, stats in sorted(skill_stats.items()):
        print(f"  â€¢ {skill:12} åœºæ™¯æ•°: {stats['count']:2}, "
              f"å·¥å…·è°ƒç”¨: {stats['total_tools']:3}, "
              f"Tokens: {stats['total_tokens']:6}")

    # Token æ€»è®¡
    total_tokens = sum(
        r.get('usage', {}).get('total_tokens', 0)
        for r in results if r.get('success')
    )
    print(f"\næ€» Token æ¶ˆè€—: {total_tokens:,}")

    # å¤±è´¥åœºæ™¯
    failed = [r for r in results if not r.get('success')]
    if failed:
        print(f"\nâš ï¸  å¤±è´¥åœºæ™¯:")
        for r in failed:
            print(f"  â€¢ {r['scenario']}: {r.get('error', 'unknown')}")

    print("\n" + "â•"*80)
    print("âœ… æµ‹è¯•å®Œæˆ")
    print("â•"*80)


if __name__ == "__main__":
    asyncio.run(main())
