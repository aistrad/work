"""
User Routes - Profile & Settings
"""
from typing import Optional, List
from datetime import datetime
from uuid import UUID

from fastapi import APIRouter, HTTPException, status, Depends
from pydantic import BaseModel

from services.identity import get_current_user, CurrentUser
from stores import UserRepository, SkillRepository, SubscriptionRepository


router = APIRouter(prefix="/users", tags=["Users"])


# ─────────────────────────────────────────────────────────────────
# Request/Response Models
# ─────────────────────────────────────────────────────────────────

class ProfileUpdateRequest(BaseModel):
    display_name: Optional[str] = None
    avatar_url: Optional[str] = None
    birth_datetime: Optional[datetime] = None
    birth_location: Optional[str] = None
    timezone: Optional[str] = None
    language: Optional[str] = None


class ProfileResponse(BaseModel):
    user_id: str
    vibe_id: str
    display_name: Optional[str] = None
    avatar_url: Optional[str] = None
    birth_datetime: Optional[datetime] = None
    birth_location: Optional[str] = None
    timezone: str
    language: str
    created_at: datetime


class ConsentRequest(BaseModel):
    source_skill: str
    target_skill: str
    data_type: str
    consent_granted: bool


class ConsentResponse(BaseModel):
    source_skill: str
    target_skill: str
    data_type: str
    consent_granted: bool
    granted_at: Optional[datetime] = None


class SkillProfileResponse(BaseModel):
    skill: str  # Unified field name
    profile_data: dict
    first_use_at: datetime
    last_use_at: datetime
    total_sessions: int


class SubscriptionStatusResponse(BaseModel):
    is_premium: bool
    plan_id: Optional[str] = None
    plan_name: Optional[str] = None
    skills_access: List[str]
    expires_at: Optional[datetime] = None
    features: dict


# ─────────────────────────────────────────────────────────────────
# Profile Endpoints
# ─────────────────────────────────────────────────────────────────

@router.get("/me/profile", response_model=ProfileResponse)
async def get_profile(current_user: CurrentUser = Depends(get_current_user)):
    """Get current user's full profile"""
    user = await UserRepository.get_by_id(current_user.user_id)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")

    return ProfileResponse(
        user_id=str(user["id"]),
        vibe_id=user["vibe_id"],
        display_name=user.get("display_name"),
        avatar_url=user.get("avatar_url"),
        birth_datetime=user.get("birth_datetime"),
        birth_location=user.get("birth_location"),
        timezone=user.get("timezone", "Asia/Shanghai"),
        language=user.get("language", "zh-CN"),
        created_at=user["created_at"]
    )


@router.put("/me/profile", response_model=ProfileResponse)
async def update_profile(
    request: ProfileUpdateRequest,
    current_user: CurrentUser = Depends(get_current_user)
):
    """Update current user's profile"""
    update_data = request.model_dump(exclude_unset=True)

    user = await UserRepository.update(current_user.user_id, **update_data)
    if not user:
        raise HTTPException(status_code=404, detail="User not found")

    return ProfileResponse(
        user_id=str(user["id"]),
        vibe_id=user["vibe_id"],
        display_name=user.get("display_name"),
        avatar_url=user.get("avatar_url"),
        birth_datetime=user.get("birth_datetime"),
        birth_location=user.get("birth_location"),
        timezone=user.get("timezone", "Asia/Shanghai"),
        language=user.get("language", "zh-CN"),
        created_at=user["created_at"]
    )


# ─────────────────────────────────────────────────────────────────
# Data Consent Endpoints
# ─────────────────────────────────────────────────────────────────

@router.get("/me/consents", response_model=List[ConsentResponse])
async def get_consents(current_user: CurrentUser = Depends(get_current_user)):
    """Get user's data sharing consents"""
    consents = await UserRepository.get_consents(current_user.user_id)
    return [
        ConsentResponse(
            source_skill=c["source_skill"],
            target_skill=c["target_skill"],
            data_type=c["data_type"],
            consent_granted=c["consent_granted"],
            granted_at=c.get("granted_at")
        )
        for c in consents
    ]


@router.post("/me/consents", response_model=ConsentResponse)
async def set_consent(
    request: ConsentRequest,
    current_user: CurrentUser = Depends(get_current_user)
):
    """Set data sharing consent"""
    consent = await UserRepository.set_consent(
        user_id=current_user.user_id,
        source_skill=request.source_skill,
        target_skill=request.target_skill,
        data_type=request.data_type,
        consent_granted=request.consent_granted
    )

    return ConsentResponse(
        source_skill=consent["source_skill"],
        target_skill=consent["target_skill"],
        data_type=consent["data_type"],
        consent_granted=consent["consent_granted"],
        granted_at=consent.get("granted_at")
    )


# ─────────────────────────────────────────────────────────────────
# Skill Profiles
# ─────────────────────────────────────────────────────────────────

@router.get("/me/skills", response_model=List[SkillProfileResponse])
async def get_skill_profiles(current_user: CurrentUser = Depends(get_current_user)):
    """Get user's skill profiles"""
    profiles = await SkillRepository.get_user_profiles(current_user.user_id)
    return [
        SkillProfileResponse(
            skill_id=p["skill_id"],
            profile_data=p["profile_data"],
            first_use_at=p["first_use_at"],
            last_use_at=p["last_use_at"],
            total_sessions=p["total_sessions"]
        )
        for p in profiles
    ]


@router.get("/me/skills/{skill_id}", response_model=SkillProfileResponse)
async def get_skill_profile(
    skill_id: str,
    current_user: CurrentUser = Depends(get_current_user)
):
    """Get specific skill profile"""
    profile = await SkillRepository.get_or_create_profile(
        current_user.user_id, skill_id
    )

    return SkillProfileResponse(
        skill_id=profile["skill_id"],
        profile_data=profile["profile_data"],
        first_use_at=profile["first_use_at"],
        last_use_at=profile["last_use_at"],
        total_sessions=profile["total_sessions"]
    )


# ─────────────────────────────────────────────────────────────────
# Subscription Status
# ─────────────────────────────────────────────────────────────────

@router.get("/me/subscription", response_model=SubscriptionStatusResponse)
async def get_subscription_status(
    current_user: CurrentUser = Depends(get_current_user)
):
    """Get user's subscription status"""
    status = await SubscriptionRepository.get_subscription_status(
        current_user.user_id
    )

    return SubscriptionStatusResponse(**status)


# ─────────────────────────────────────────────────────────────────
# Insights API (for show_insight tool)
# ─────────────────────────────────────────────────────────────────

class InsightResponse(BaseModel):
    id: str
    insight_type: str
    title: str
    content: str
    skill_id: str
    created_at: datetime


@router.get("/me/insights", response_model=dict)
async def get_insights(
    category: Optional[str] = None,
    skill: Optional[str] = None,
    limit: int = 10,
    current_user: Optional[CurrentUser] = Depends(get_current_user)
):
    """
    Get user's insights for display.
    Used by show_insight tool.
    """
    # For logged-in users, get from database
    if current_user:
        insights = await SkillRepository.get_user_insights(
            user_id=current_user.user_id,
            skill_id=skill,
            insight_type=category,
            limit=limit
        )

        return {
            "insights": [
                {
                    "id": str(i.get("id", "")),
                    "insight_type": i.get("insight_type", "discovery"),
                    "title": i.get("title", "洞察"),
                    "content": i.get("content", ""),
                    "skill_id": i.get("skill_id", ""),
                    "created_at": str(i.get("created_at", ""))
                }
                for i in insights
            ],
            "total": len(insights)
        }

    # For guests, return demo insights
    return {
        "insights": [
            {
                "id": "demo-1",
                "insight_type": "discovery",
                "title": "我看见你...",
                "content": "你有着独特的洞察力和直觉，能够看到事物表面之下的深层含义。",
                "skill_id": "bazi",
                "created_at": datetime.utcnow().isoformat()
            },
            {
                "id": "demo-2",
                "insight_type": "timing",
                "title": "现在是思考的好时机",
                "content": "当前的星象有利于内省和规划，适合放慢脚步，理清思绪。",
                "skill_id": "zodiac",
                "created_at": datetime.utcnow().isoformat()
            }
        ],
        "total": 2
    }


# Alias for simpler URL (compatible with show_insight tool)
@router.get("/insights", response_model=dict)
async def get_insights_alias(
    category: Optional[str] = None,
    skill: Optional[str] = None,
    limit: int = 10,
    current_user: Optional[CurrentUser] = Depends(get_current_user)
):
    """Alias endpoint for /users/insights"""
    return await get_insights(category, skill, limit, current_user)


# ─────────────────────────────────────────────────────────────────
# Data Export
# ─────────────────────────────────────────────────────────────────

@router.get("/me/export")
async def export_data(current_user: CurrentUser = Depends(get_current_user)):
    """Export all user data (GDPR compliance)"""
    user = await UserRepository.get_by_id(current_user.user_id)
    profiles = await SkillRepository.get_user_profiles(current_user.user_id)
    consents = await UserRepository.get_consents(current_user.user_id)
    subscription = await SubscriptionRepository.get_user_subscription(current_user.user_id)

    # Get conversations for each skill
    conversations = []
    for profile in profiles:
        convos = await SkillRepository.get_user_conversations(
            current_user.user_id, profile["skill_id"], limit=100
        )
        conversations.extend(convos)

    return {
        "user": {
            "vibe_id": user["vibe_id"],
            "display_name": user.get("display_name"),
            "birth_datetime": str(user.get("birth_datetime")) if user.get("birth_datetime") else None,
            "birth_location": user.get("birth_location"),
            "timezone": user.get("timezone"),
            "language": user.get("language"),
            "created_at": str(user["created_at"])
        },
        "skill_profiles": [
            {
                "skill_id": p["skill_id"],
                "profile_data": p["profile_data"],
                "total_sessions": p["total_sessions"]
            }
            for p in profiles
        ],
        "consents": [
            {
                "source_skill": c["source_skill"],
                "target_skill": c["target_skill"],
                "data_type": c["data_type"],
                "consent_granted": c["consent_granted"]
            }
            for c in consents
        ],
        "conversations_count": len(conversations),
        "subscription": {
            "plan_id": subscription["plan_id"] if subscription else "free",
            "status": subscription["status"] if subscription else "none"
        } if subscription else None,
        "export_date": str(datetime.utcnow())
    }
