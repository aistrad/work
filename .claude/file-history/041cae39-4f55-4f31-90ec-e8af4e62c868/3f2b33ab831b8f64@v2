"""
Zodiac API Routes - Western Astrology
Based on: vibelife spec v3.0

Endpoints:
- POST /api/v1/zodiac/chart - Calculate zodiac chart (natal chart)
- POST /api/v1/zodiac/transit - Calculate transit analysis
- POST /api/v1/zodiac/synastry - Calculate synastry (compatibility)
"""

import logging
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, Field
from typing import Optional, List
from datetime import date

from services.zodiac import ZodiacCalculator, calculate_zodiac, calculate_transit

logger = logging.getLogger(__name__)
router = APIRouter(prefix="/zodiac", tags=["zodiac"])


class ChartRequest(BaseModel):
    """Request for zodiac chart calculation"""
    birth_date: str = Field(..., description="Birth date in YYYY-MM-DD format")
    birth_time: str = Field(default="12:00", description="Birth time in HH:MM format")
    birth_place: str = Field(default="Shanghai", description="Birth city name")


class ChartResponse(BaseModel):
    """Response for zodiac chart"""
    success: bool
    chart: Optional[dict] = None
    error: Optional[str] = None


class TransitRequest(BaseModel):
    """Request for transit analysis"""
    birth_date: str = Field(..., description="Birth date in YYYY-MM-DD format")
    birth_time: str = Field(default="12:00", description="Birth time in HH:MM format")
    birth_place: str = Field(default="Shanghai", description="Birth city name")
    transit_date: Optional[str] = Field(default=None, description="Date for transit analysis (YYYY-MM-DD)")


class TransitResponse(BaseModel):
    """Response for transit analysis"""
    success: bool
    transits: Optional[List[dict]] = None
    error: Optional[str] = None


class SynastryRequest(BaseModel):
    """Request for synastry (compatibility) analysis"""
    person1: ChartRequest = Field(..., description="First person's birth info")
    person2: ChartRequest = Field(..., description="Second person's birth info")


class SynastryResponse(BaseModel):
    """Response for synastry analysis"""
    success: bool
    compatibility: Optional[dict] = None
    error: Optional[str] = None


@router.post("/chart", response_model=ChartResponse)
async def calculate_chart(request: ChartRequest):
    """
    Calculate Zodiac (Western Astrology) natal chart.

    Returns complete chart with:
    - Sun, Moon, Rising signs
    - Planet positions
    - Aspects between planets
    - Dominant element and modality
    """
    try:
        chart = calculate_zodiac(
            birth_date=request.birth_date,
            birth_time=request.birth_time,
            birth_place=request.birth_place,
        )

        return ChartResponse(
            success=True,
            chart=chart,
        )

    except Exception as e:
        logger.error(f"Zodiac chart calculation failed: {e}")
        return ChartResponse(
            success=False,
            error=str(e),
        )


@router.post("/transit", response_model=TransitResponse)
async def calculate_transit_analysis(request: TransitRequest):
    """
    Calculate transit analysis for a specific date.

    Returns active transits affecting the natal chart.
    """
    try:
        transits = calculate_transit(
            birth_date=request.birth_date,
            birth_time=request.birth_time,
            birth_place=request.birth_place,
            transit_date=request.transit_date,
        )

        return TransitResponse(
            success=True,
            transits=transits,
        )

    except Exception as e:
        logger.error(f"Transit calculation failed: {e}")
        return TransitResponse(
            success=False,
            error=str(e),
        )


@router.post("/synastry", response_model=SynastryResponse)
async def calculate_synastry(request: SynastryRequest):
    """
    Calculate synastry (compatibility) between two people.

    Compares planetary positions and aspects between two natal charts.
    """
    try:
        calculator = ZodiacCalculator()

        # Calculate both charts
        chart1 = calculator.calculate(
            birth_date=request.person1.birth_date,
            birth_time=request.person1.birth_time,
            birth_place=request.person1.birth_place,
        )

        chart2 = calculator.calculate(
            birth_date=request.person2.birth_date,
            birth_time=request.person2.birth_time,
            birth_place=request.person2.birth_place,
        )

        # Calculate compatibility score and aspects
        compatibility = _calculate_compatibility(chart1, chart2)

        return SynastryResponse(
            success=True,
            compatibility=compatibility,
        )

    except Exception as e:
        logger.error(f"Synastry calculation failed: {e}")
        return SynastryResponse(
            success=False,
            error=str(e),
        )


def _calculate_compatibility(chart1, chart2) -> dict:
    """
    Calculate compatibility between two charts.

    Returns format expected by frontend show_synastry.tsx:
    - person1/person2: { name, sunSign }
    - overallScore: number
    - categories: [{name, score, description}]
    - strengths: string[]
    - challenges: string[]
    - advice: string
    """
    from services.zodiac import SIGN_ELEMENT, SIGN_CHINESE

    # Element compatibility matrix
    element_compat = {
        ("fire", "fire"): 80,
        ("fire", "air"): 85,
        ("fire", "earth"): 50,
        ("fire", "water"): 45,
        ("earth", "earth"): 75,
        ("earth", "water"): 80,
        ("earth", "air"): 55,
        ("air", "air"): 70,
        ("air", "water"): 60,
        ("water", "water"): 75,
    }

    # Get elements
    elem1 = SIGN_ELEMENT.get(chart1.sun_sign, "fire").value
    elem2 = SIGN_ELEMENT.get(chart2.sun_sign, "fire").value

    # Look up compatibility (order doesn't matter)
    key = (elem1, elem2) if (elem1, elem2) in element_compat else (elem2, elem1)
    sun_score = element_compat.get(key, 65)

    # Moon compatibility
    moon_elem1 = SIGN_ELEMENT.get(chart1.moon_sign, "water").value
    moon_elem2 = SIGN_ELEMENT.get(chart2.moon_sign, "water").value
    moon_key = (moon_elem1, moon_elem2) if (moon_elem1, moon_elem2) in element_compat else (moon_elem2, moon_elem1)
    moon_score = element_compat.get(moon_key, 65)

    # Communication score (Mercury position approximated by sun sign)
    comm_score = 70 + (sun_score - 65) // 2

    # Emotional connection (Moon + Sun-Moon cross)
    emotional_score = moon_score
    if chart1.sun_sign == chart2.moon_sign or chart2.sun_sign == chart1.moon_sign:
        emotional_score = min(100, emotional_score + 15)

    # Calculate overall score
    overall_score = round((sun_score * 0.3 + moon_score * 0.3 + comm_score * 0.2 + emotional_score * 0.2))

    # Get Chinese sign names
    sun1_cn = SIGN_CHINESE.get(chart1.sun_sign, chart1.sun_sign)
    sun2_cn = SIGN_CHINESE.get(chart2.sun_sign, chart2.sun_sign)
    moon1_cn = SIGN_CHINESE.get(chart1.moon_sign, chart1.moon_sign)
    moon2_cn = SIGN_CHINESE.get(chart2.moon_sign, chart2.moon_sign)

    # Element names in Chinese
    elem_cn = {"fire": "火", "earth": "土", "air": "风", "water": "水"}

    # Generate strengths based on scores
    strengths = []
    if sun_score >= 75:
        strengths.append(f"太阳星座相合，性格自然吸引")
    if moon_score >= 75:
        strengths.append(f"月亮星座协调，情感共鸣强")
    if emotional_score >= 80:
        strengths.append("日月交互相位，深层默契")
    if elem1 == elem2:
        strengths.append(f"同为{elem_cn.get(elem1, elem1)}象星座，价值观一致")
    if not strengths:
        strengths.append("互补性强，可以相互学习成长")

    # Generate challenges based on scores
    challenges = []
    if sun_score < 60:
        challenges.append("性格差异需要更多理解和包容")
    if moon_score < 60:
        challenges.append("情感表达方式不同，需要耐心沟通")
    if elem1 != elem2:
        e1_cn = elem_cn.get(elem1, elem1)
        e2_cn = elem_cn.get(elem2, elem2)
        challenges.append(f"{e1_cn}象与{e2_cn}象的处事方式有差异")
    if not challenges:
        challenges.append("保持开放心态，避免过度依赖")

    # Generate advice
    if overall_score >= 80:
        advice = "你们天生默契，珍惜这份缘分。保持真诚沟通，让关系持续升温。"
    elif overall_score >= 65:
        advice = "你们有很好的基础，多关注彼此的情感需求，用行动表达爱意。"
    elif overall_score >= 50:
        advice = "差异是成长的契机。学习对方的优点，用包容化解分歧。"
    else:
        advice = "关系需要更多努力经营。专注于共同目标，建立相互理解的桥梁。"

    return {
        "person1": {
            "name": "你",
            "sunSign": sun1_cn,
        },
        "person2": {
            "name": "TA",
            "sunSign": sun2_cn,
        },
        "overallScore": overall_score,
        "categories": [
            {
                "name": "性格契合",
                "score": sun_score,
                "description": f"{sun1_cn}与{sun2_cn}的能量互动"
            },
            {
                "name": "情感连接",
                "score": emotional_score,
                "description": f"{moon1_cn}与{moon2_cn}的情感共鸣"
            },
            {
                "name": "沟通默契",
                "score": comm_score,
                "description": "思维方式与表达习惯的匹配度"
            },
            {
                "name": "长期稳定",
                "score": round((sun_score + moon_score) / 2),
                "description": "关系的持久性与成长潜力"
            }
        ],
        "strengths": strengths[:3],
        "challenges": challenges[:3],
        "advice": advice,
    }
