"""
VibeLife Skill Mirror Routes
周期回顾系统 API 路由
"""

from typing import Optional
from fastapi import APIRouter, HTTPException, Query
from pydantic import BaseModel

from stores.db import get_db_pool
from services.mirror import (
    MonthlyReviewGenerator,
    WeeklyReviewGenerator,
    ShareableCardGenerator
)
from services.vibe_engine.llm_orchestrator import LLMOrchestrator

router = APIRouter(prefix="/mirror", tags=["mirror"])


# ─────────────────────────────────────────────────────────────────
# Response Models
# ─────────────────────────────────────────────────────────────────

class MonthlyReviewResponse(BaseModel):
    month: str
    month_name: str
    current_month_summary: str
    current_month_highlights: list[str]
    current_month_challenges: list[str]
    next_month_name: str
    next_month_outlook: str
    next_month_opportunities: list[str]
    next_month_cautions: list[str]
    key_advice: str


class WeeklyReviewResponse(BaseModel):
    sun_sign: str
    week_start: str
    week_end: str
    overall_rating: int
    current_week_summary: str
    key_events: list[str]
    emotional_theme: str
    next_week_outlook: str
    lucky_day: str
    lucky_color: str
    key_advice: str


class CardResponse(BaseModel):
    card_type: str
    size: str
    title: str
    image_base64: str
    share_url: Optional[str] = None


# ─────────────────────────────────────────────────────────────────
# Monthly Review Endpoints (Bazi)
# ─────────────────────────────────────────────────────────────────

@router.get("/monthly/{user_id}")
async def get_monthly_review(user_id: str):
    """获取用户月运回顾"""
    pool = await get_db_pool()
    llm = LLMOrchestrator()
    generator = MonthlyReviewGenerator(pool, llm)

    try:
        review = await generator.generate_review(user_id)

        return {
            "review": MonthlyReviewResponse(
                month=review.month,
                month_name=review.month_name,
                current_month_summary=review.current_month_summary,
                current_month_highlights=review.current_month_highlights,
                current_month_challenges=review.current_month_challenges,
                next_month_name=review.next_month_name,
                next_month_outlook=review.next_month_outlook,
                next_month_opportunities=review.next_month_opportunities,
                next_month_cautions=review.next_month_cautions,
                key_advice=review.key_advice
            )
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/monthly/{user_id}/history")
async def get_monthly_history(
    user_id: str,
    limit: int = Query(12, ge=1, le=24)
):
    """获取月运回顾历史"""
    pool = await get_db_pool()
    generator = MonthlyReviewGenerator(pool)

    history = await generator.get_review_history(user_id, limit)

    return {"history": history}


@router.post("/monthly/{user_id}/save")
async def save_monthly_review(user_id: str):
    """生成并保存月运回顾"""
    pool = await get_db_pool()
    llm = LLMOrchestrator()
    generator = MonthlyReviewGenerator(pool, llm)

    review = await generator.generate_review(user_id)
    insight_id = await generator.save_review(review)

    return {
        "message": "Monthly review saved",
        "insight_id": insight_id
    }


# ─────────────────────────────────────────────────────────────────
# Weekly Review Endpoints (Zodiac)
# ─────────────────────────────────────────────────────────────────

@router.get("/weekly/{user_id}")
async def get_weekly_review(user_id: str):
    """获取用户周运回顾"""
    pool = await get_db_pool()
    llm = LLMOrchestrator()
    generator = WeeklyReviewGenerator(pool, llm)

    try:
        review = await generator.generate_review(user_id)

        return {
            "review": WeeklyReviewResponse(
                sun_sign=review.sun_sign,
                week_start=review.week_start.isoformat(),
                week_end=review.week_end.isoformat(),
                overall_rating=review.overall_rating,
                current_week_summary=review.current_week_summary,
                key_events=review.key_events,
                emotional_theme=review.emotional_theme,
                next_week_outlook=review.next_week_outlook,
                lucky_day=review.lucky_day,
                lucky_color=review.lucky_color,
                key_advice=review.key_advice
            )
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))


@router.get("/weekly/sign/{sun_sign}")
async def get_sign_weekly_review(sun_sign: str):
    """获取特定星座的周运（通用版本）"""
    pool = await get_db_pool()
    llm = LLMOrchestrator()
    generator = WeeklyReviewGenerator(pool, llm)

    valid_signs = [
        "白羊座", "金牛座", "双子座", "巨蟹座", "狮子座", "处女座",
        "天秤座", "天蝎座", "射手座", "摩羯座", "水瓶座", "双鱼座"
    ]

    if sun_sign not in valid_signs:
        raise HTTPException(status_code=400, detail=f"Invalid sun sign: {sun_sign}")

    review = await generator.generate_sign_weekly(sun_sign)

    return {"review": review}


@router.get("/weekly/{user_id}/history")
async def get_weekly_history(
    user_id: str,
    limit: int = Query(12, ge=1, le=52)
):
    """获取周运回顾历史"""
    pool = await get_db_pool()
    generator = WeeklyReviewGenerator(pool)

    history = await generator.get_review_history(user_id, limit)

    return {"history": history}


@router.post("/weekly/{user_id}/save")
async def save_weekly_review(user_id: str):
    """生成并保存周运回顾"""
    pool = await get_db_pool()
    llm = LLMOrchestrator()
    generator = WeeklyReviewGenerator(pool, llm)

    review = await generator.generate_review(user_id)
    insight_id = await generator.save_review(review)

    return {
        "message": "Weekly review saved",
        "insight_id": insight_id
    }


# ─────────────────────────────────────────────────────────────────
# Shareable Card Endpoints
# ─────────────────────────────────────────────────────────────────

@router.get("/cards/sizes")
async def get_card_sizes():
    """获取可用的卡片尺寸"""
    pool = await get_db_pool()
    generator = ShareableCardGenerator(pool)

    return {"sizes": generator.get_available_sizes()}


@router.post("/cards/monthly/{user_id}")
async def generate_monthly_card(
    user_id: str,
    size: str = Query("instagram_story")
):
    """生成月运回顾分享卡片"""
    pool = await get_db_pool()
    llm = LLMOrchestrator()

    review_gen = MonthlyReviewGenerator(pool, llm)
    card_gen = ShareableCardGenerator(pool)

    # 生成回顾
    review = await review_gen.generate_review(user_id)

    # 生成卡片
    card = await card_gen.generate_monthly_review_card(review, size)

    # 保存并获取分享URL
    share_url = await card_gen.save_card(card, user_id)

    return {
        "card": CardResponse(
            card_type=card.card_type,
            size=card.size,
            title=card.title,
            image_base64=card.image_base64 or "",
            share_url=share_url
        )
    }


@router.post("/cards/weekly/{user_id}")
async def generate_weekly_card(
    user_id: str,
    size: str = Query("instagram_story")
):
    """生成周运回顾分享卡片"""
    pool = await get_db_pool()
    llm = LLMOrchestrator()

    review_gen = WeeklyReviewGenerator(pool, llm)
    card_gen = ShareableCardGenerator(pool)

    # 生成回顾
    review = await review_gen.generate_review(user_id)

    # 生成卡片
    card = await card_gen.generate_weekly_review_card(review, size)

    # 保存并获取分享URL
    share_url = await card_gen.save_card(card, user_id)

    return {
        "card": CardResponse(
            card_type=card.card_type,
            size=card.size,
            title=card.title,
            image_base64=card.image_base64 or "",
            share_url=share_url
        )
    }


@router.post("/cards/insight")
async def generate_insight_card(
    insight_type: str,
    title: str,
    content: str,
    user_id: str,
    size: str = Query("square")
):
    """生成洞察分享卡片"""
    pool = await get_db_pool()
    card_gen = ShareableCardGenerator(pool)

    valid_types = ["discovery", "pattern", "timing", "growth"]
    if insight_type not in valid_types:
        raise HTTPException(status_code=400, detail=f"Invalid insight type: {insight_type}")

    card = await card_gen.generate_insight_card(insight_type, title, content, size)
    share_url = await card_gen.save_card(card, user_id)

    return {
        "card": CardResponse(
            card_type=card.card_type,
            size=card.size,
            title=card.title,
            image_base64=card.image_base64 or "",
            share_url=share_url
        )
    }
