"""
VibeLife Test Configuration
pytest 配置和共享 fixtures
"""

import os
import pytest
import asyncio
from datetime import datetime, date
from typing import AsyncGenerator
from unittest.mock import AsyncMock, MagicMock

# 设置测试环境变量
os.environ["VIBELIFE_ENV"] = "test"
os.environ["VIBELIFE_DB_URL"] = "postgresql://postgres:test@localhost:5432/vibelife_test"


@pytest.fixture(scope="session")
def event_loop():
    """创建事件循环"""
    loop = asyncio.get_event_loop_policy().new_event_loop()
    yield loop
    loop.close()


@pytest.fixture
def mock_db_pool():
    """模拟数据库连接池"""
    pool = AsyncMock()

    # 模拟 fetch 方法
    pool.fetch = AsyncMock(return_value=[])
    pool.fetchrow = AsyncMock(return_value=None)
    pool.fetchval = AsyncMock(return_value=None)
    pool.execute = AsyncMock(return_value="UPDATE 1")

    return pool


@pytest.fixture
def sample_user():
    """示例用户数据"""
    return {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "vibe_id": "VB20260105001",
        "display_name": "测试用户",
        "email": "test@example.com",
        "birth_datetime": datetime(1990, 5, 15, 10, 30),
        "birth_location": "北京",
        "timezone": "Asia/Shanghai"
    }


@pytest.fixture
def sample_bazi_chart():
    """示例八字数据"""
    return {
        "year": {"stem": "庚", "branch": "午"},
        "month": {"stem": "丁", "branch": "巳"},
        "day": {"stem": "甲", "branch": "子"},
        "hour": {"stem": "乙", "branch": "巳"},
        "day_master": "甲",
        "day_master_element": "木"
    }


@pytest.fixture
def sample_zodiac_profile():
    """示例星座数据"""
    return {
        "sun_sign": "金牛座",
        "moon_sign": "双鱼座",
        "ascendant": "天蝎座",
        "sun_degree": 25.5,
        "moon_degree": 12.3,
        "asc_degree": 8.7
    }


@pytest.fixture
def mock_llm():
    """模拟 LLM 服务"""
    llm = AsyncMock()

    # 模拟生成响应
    mock_response = MagicMock()
    mock_response.content = "这是一个测试响应"
    llm.generate = AsyncMock(return_value=mock_response)

    return llm


@pytest.fixture
def mock_stripe():
    """模拟 Stripe 服务"""
    stripe = MagicMock()

    # 模拟创建客户
    stripe.create_customer = AsyncMock(return_value="cus_test123")

    # 模拟创建 checkout session
    mock_session = MagicMock()
    mock_session.session_id = "cs_test123"
    mock_session.url = "https://checkout.stripe.com/test"
    mock_session.status = "open"
    stripe.create_checkout_session = AsyncMock(return_value=mock_session)

    # 模拟获取订阅
    stripe.get_subscription = AsyncMock(return_value={
        "id": "sub_test123",
        "status": "active",
        "current_period_end": datetime.now()
    })

    return stripe


# ─────────────────────────────────────────────────────────────────
# 数据库 Fixtures (用于集成测试)
# ─────────────────────────────────────────────────────────────────

@pytest.fixture
async def real_db_pool():
    """
    真实数据库连接池（用于集成测试）
    注意：需要测试数据库运行
    """
    import asyncpg

    db_url = os.environ.get("VIBELIFE_TEST_DB_URL")
    if not db_url:
        pytest.skip("Test database not configured")

    pool = await asyncpg.create_pool(db_url)
    yield pool
    await pool.close()


@pytest.fixture
async def clean_db(real_db_pool):
    """清理测试数据库"""
    # 在测试前清理
    await real_db_pool.execute("DELETE FROM skill_messages")
    await real_db_pool.execute("DELETE FROM skill_conversations")
    await real_db_pool.execute("DELETE FROM skill_insights")
    await real_db_pool.execute("DELETE FROM user_notifications")

    yield real_db_pool

    # 在测试后清理
    await real_db_pool.execute("DELETE FROM skill_messages")
    await real_db_pool.execute("DELETE FROM skill_conversations")
    await real_db_pool.execute("DELETE FROM skill_insights")
    await real_db_pool.execute("DELETE FROM user_notifications")
