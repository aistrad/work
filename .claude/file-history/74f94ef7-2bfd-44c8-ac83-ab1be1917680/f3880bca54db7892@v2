#!/bin/bash
# ═══════════════════════════════════════════════════════════════
# VibeLife 后端部署脚本 - aiscend 服务器
# ═══════════════════════════════════════════════════════════════

set -e

DEPLOY_DIR="/home/aiscend/work/vibelife"
COMPOSE_DIR="$DEPLOY_DIR/deploy/aiscend"

echo "🚀 开始部署 VibeLife 后端..."

# ─────────────────────────────────────────────────────────────────
# 1. 拉取最新代码
# ─────────────────────────────────────────────────────────────────
echo "📥 拉取最新代码..."
cd $DEPLOY_DIR
git pull origin main

# ─────────────────────────────────────────────────────────────────
# 2. 检查环境变量
# ─────────────────────────────────────────────────────────────────
if [ ! -f "$COMPOSE_DIR/.env" ]; then
    echo "❌ 错误: .env 文件不存在"
    echo "请复制 .env.example 到 .env 并填写配置"
    exit 1
fi

# ─────────────────────────────────────────────────────────────────
# 3. 构建并启动服务
# ─────────────────────────────────────────────────────────────────
echo "🔨 构建 Docker 镜像..."
cd $COMPOSE_DIR
docker-compose build --no-cache api

echo "🔄 重启服务..."
docker-compose down
docker-compose up -d

# ─────────────────────────────────────────────────────────────────
# 4. 等待服务启动
# ─────────────────────────────────────────────────────────────────
echo "⏳ 等待服务启动..."
sleep 10

# ─────────────────────────────────────────────────────────────────
# 5. 健康检查
# ─────────────────────────────────────────────────────────────────
echo "🏥 健康检查..."
if curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health | grep -q "200"; then
    echo "✅ API 服务正常运行"
else
    echo "❌ API 服务启动失败"
    docker-compose logs api
    exit 1
fi

# ─────────────────────────────────────────────────────────────────
# 6. 清理旧镜像
# ─────────────────────────────────────────────────────────────────
echo "🧹 清理旧镜像..."
docker image prune -f

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "✅ 部署完成!"
echo ""
echo "服务状态:"
docker-compose ps
echo ""
echo "API 地址: http://localhost:8000"
echo "API 文档: http://localhost:8000/docs"
echo "═══════════════════════════════════════════════════════════════"
