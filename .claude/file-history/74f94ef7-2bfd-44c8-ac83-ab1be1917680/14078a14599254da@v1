"""
VibeLife Content Generator
å†…å®¹ç”Ÿæˆå™¨ - ç”Ÿæˆä¸ªæ€§åŒ–æé†’å†…å®¹
"""

from datetime import date
from typing import Optional
from pydantic import BaseModel
import asyncpg

from .scheduler import ReminderTask, ReminderType
from ..vibe_engine.llm_orchestrator import LLMOrchestrator


# æé†’å†…å®¹æ¨¡æ¿
REMINDER_TEMPLATES = {
    ReminderType.BAZI_MONTH: {
        "title": "æœˆè¿äº¤æ¥æé†’",
        "template": """äº²çˆ±çš„{display_name}ï¼Œ

{days_text}å°†è¿æ¥**{event_name}**çš„äº¤æ¥ã€‚

{personalized_content}

è¿™ä¸ªæœˆä»½çš„èƒ½é‡è½¬æ¢ï¼Œå¯¹ä½ æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è°ƒæ•´æ—¶æœºã€‚è®°å¾—å…³æ³¨è‡ªå·±çš„çŠ¶æ€å˜åŒ–å“¦ã€‚

ğŸ’« ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æœˆè¿åˆ†æ""",
    },

    ReminderType.BAZI_YEAR: {
        "title": "æµå¹´äº¤æ¥æé†’",
        "template": """äº²çˆ±çš„{display_name}ï¼Œ

{days_text}å³å°†è¿›å…¥**{event_name}**ï¼

{personalized_content}

æ–°çš„æµå¹´æ„å‘³ç€æ–°çš„èƒ½é‡åœºåŸŸï¼Œè¿™æ˜¯ä¸€å¹´ä¸­æœ€é‡è¦çš„èƒ½é‡è½¬æ¢ç‚¹ä¹‹ä¸€ã€‚

ğŸŠ ç‚¹å‡»æŸ¥çœ‹ä½ çš„æµå¹´è¿åŠ¿æŠ¥å‘Š""",
    },

    ReminderType.MERCURY_RETROGRADE: {
        "title": "æ°´é€†æé†’",
        "template": """äº²çˆ±çš„{display_name}ï¼Œ

{days_text}**æ°´æ˜Ÿé€†è¡Œ**å³å°†å¼€å§‹ï¼

ğŸ“… æ°´é€†æ—¶é—´ï¼š{start_date} - {end_date}
â™ˆ å‘ç”Ÿæ˜Ÿåº§ï¼š{sign}

{personalized_content}

æ°´é€†æœŸé—´å»ºè®®ï¼š
â€¢ é‡è¦æ–‡ä»¶å¤šæ£€æŸ¥å‡ é
â€¢ ç”µå­è®¾å¤‡åšå¥½å¤‡ä»½
â€¢ æ²Ÿé€šæ—¶å¤šç¡®è®¤ç†è§£æ˜¯å¦ä¸€è‡´
â€¢ é€‚åˆå›é¡¾å’Œå®Œæˆæ—§äº‹

ä¸å¿…è¿‡åº¦æ‹…å¿ƒï¼Œæ°´é€†ä¹Ÿæ˜¯åæ€å’Œæ•´ç†çš„å¥½æ—¶æœº âœ¨""",
    },

    ReminderType.NEW_MOON: {
        "title": "æ–°æœˆè®¸æ„¿æé†’",
        "template": """äº²çˆ±çš„{display_name}ï¼Œ

{days_text}è¿æ¥**{event_name}**ï¼ğŸŒ‘

{personalized_content}

æ–°æœˆæ˜¯æ’­ç§æ„¿æœ›çš„æœ€ä½³æ—¶æœºã€‚è¯•ç€åœ¨è¿™ä¸ªæ—¶é—´ï¼š
â€¢ å†™ä¸‹ä½ çš„æ–°æœˆæ„¿æœ›
â€¢ å¼€å§‹ä¸€ä¸ªæ–°è®¡åˆ’
â€¢ è®¾å®šæ¥ä¸‹æ¥ä¸¤å‘¨çš„å°ç›®æ ‡

ğŸŒ™ ç‚¹å‡»è·å–ä½ çš„æ–°æœˆè®¸æ„¿æŒ‡å—""",
    },

    ReminderType.FULL_MOON: {
        "title": "æ»¡æœˆèƒ½é‡æé†’",
        "template": """äº²çˆ±çš„{display_name}ï¼Œ

{days_text}è¿æ¥**{event_name}**ï¼ğŸŒ•

{personalized_content}

æ»¡æœˆæ˜¯æ”¶è·å’Œé‡Šæ”¾çš„æ—¶åˆ»ã€‚è¿™ä¸ªæ—¶é—´é€‚åˆï¼š
â€¢ åº†ç¥ä½ çš„æˆå°±
â€¢ é‡Šæ”¾ä¸å†éœ€è¦çš„èƒ½é‡
â€¢ è¿›è¡Œæ»¡æœˆå†¥æƒ³
â€¢ æ„Ÿæ©ä½ æ‰€æ‹¥æœ‰çš„

âœ¨ ç‚¹å‡»æŸ¥çœ‹æ»¡æœˆå¯¹ä½ çš„å½±å“""",
    },

    ReminderType.WEEKLY_FORTUNE: {
        "title": "æœ¬å‘¨è¿åŠ¿",
        "template": """äº²çˆ±çš„{display_name}ï¼Œ

æ–°çš„ä¸€å‘¨å¼€å§‹äº†ï¼âœ¨

{personalized_content}

ç¥ä½ æœ‰ç¾å¥½çš„ä¸€å‘¨ï¼

ğŸ“Š ç‚¹å‡»æŸ¥çœ‹å®Œæ•´å‘¨è¿æŠ¥å‘Š""",
    },

    ReminderType.BIRTHDAY: {
        "title": "ç”Ÿæ—¥å¿«ä¹",
        "template": """äº²çˆ±çš„{display_name}ï¼Œ

ğŸ‚ ç”Ÿæ—¥å¿«ä¹ï¼

åœ¨è¿™ä¸ªç‰¹åˆ«çš„æ—¥å­é‡Œï¼Œé€ä¸Šæœ€çœŸæŒšçš„ç¥ç¦ã€‚

{personalized_content}

æ–°çš„ä¸€å²ï¼Œæ„¿ä½ ï¼š
â€¢ å¿ƒæƒ³äº‹æˆ
â€¢ å¹³å®‰å–œä¹
â€¢ æ´»å‡ºçœŸæˆ‘

ğŸ ç‚¹å‡»æŸ¥çœ‹ä½ çš„ç”Ÿæ—¥è¿åŠ¿åˆ†æ""",
    },
}


class GeneratedContent(BaseModel):
    """ç”Ÿæˆçš„æé†’å†…å®¹"""
    title: str
    content: str
    short_content: str  # ç”¨äºæ¨é€é€šçŸ¥çš„çŸ­å†…å®¹


class ContentGenerator:
    """å†…å®¹ç”Ÿæˆå™¨"""

    def __init__(self, db_pool: asyncpg.Pool, llm: LLMOrchestrator = None):
        self.db = db_pool
        self.llm = llm

    async def generate_reminder_content(
        self,
        task: ReminderTask,
        use_llm: bool = True
    ) -> GeneratedContent:
        """ç”Ÿæˆæé†’å†…å®¹"""
        # è·å–ç”¨æˆ·ä¿¡æ¯
        user = await self._get_user_info(task.user_id)
        display_name = user.get("display_name", "æœ‹å‹") if user else "æœ‹å‹"

        # è·å–æ¨¡æ¿
        template_data = REMINDER_TEMPLATES.get(task.reminder_type)
        if not template_data:
            return GeneratedContent(
                title="è¿åŠ¿æé†’",
                content=f"æ‚¨æœ‰ä¸€ä¸ªå…³äº {task.event_name} çš„æé†’",
                short_content=task.event_name
            )

        # è®¡ç®—å¤©æ•°æ–‡æœ¬
        days_diff = (task.event_date - date.today()).days
        if days_diff == 0:
            days_text = "ä»Šå¤©"
        elif days_diff == 1:
            days_text = "æ˜å¤©"
        elif days_diff == 2:
            days_text = "åå¤©"
        else:
            days_text = f"{days_diff}å¤©å"

        # ç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹
        personalized_content = ""
        if use_llm and self.llm:
            personalized_content = await self._generate_personalized_content(
                task, user
            )

        # å¡«å……æ¨¡æ¿
        content = template_data["template"].format(
            display_name=display_name,
            days_text=days_text,
            event_name=task.event_name,
            personalized_content=personalized_content,
            # æ°´é€†ç‰¹æ®Šå­—æ®µ
            start_date=task.event_date.strftime("%mæœˆ%dæ—¥") if task.reminder_type == ReminderType.MERCURY_RETROGRADE else "",
            end_date="",  # éœ€è¦ä»event_dataè·å–
            sign="",  # éœ€è¦ä»event_dataè·å–
        )

        # ç”ŸæˆçŸ­å†…å®¹
        short_content = f"{days_text}{task.event_name}"

        return GeneratedContent(
            title=template_data["title"],
            content=content,
            short_content=short_content
        )

    async def _get_user_info(self, user_id: str) -> Optional[dict]:
        """è·å–ç”¨æˆ·ä¿¡æ¯"""
        row = await self.db.fetchrow("""
            SELECT display_name, birth_datetime, timezone
            FROM vibe_users
            WHERE id = $1::uuid
        """, user_id)

        if row:
            return dict(row)
        return None

    async def _generate_personalized_content(
        self,
        task: ReminderTask,
        user: dict
    ) -> str:
        """ä½¿ç”¨LLMç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹"""
        if not self.llm or not user:
            return ""

        # è·å–ç”¨æˆ·çš„æŠ€èƒ½æ¡£æ¡ˆ
        skill_profile = await self._get_user_skill_profile(task.user_id, "bazi")

        prompt = f"""åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·ç”Ÿæˆä¸€æ®µç®€çŸ­çš„ä¸ªæ€§åŒ–è¿åŠ¿æé†’ï¼ˆ2-3å¥è¯ï¼‰ï¼š

äº‹ä»¶ç±»å‹ï¼š{task.reminder_type.value}
äº‹ä»¶åç§°ï¼š{task.event_name}
äº‹ä»¶æ—¥æœŸï¼š{task.event_date}

ç”¨æˆ·ä¿¡æ¯ï¼š
- å‡ºç”Ÿæ—¶é—´ï¼š{user.get('birth_datetime', 'æœªçŸ¥')}

è¦æ±‚ï¼š
1. è¯­æ°”æ¸©æš–äº²åˆ‡ï¼Œåƒä¸€ä¸ªæ‡‚ä½ çš„æœ‹å‹
2. ç»“åˆäº‹ä»¶ç‰¹ç‚¹ç»™å‡ºå…·ä½“çš„å°å»ºè®®
3. ä¸è¦è¿‡åº¦è§£è¯»ï¼Œä¿æŒç§¯ææ­£å‘
4. ç®€æ´æœ‰åŠ›ï¼Œä¸è¶…è¿‡100å­—"""

        try:
            response = await self.llm.generate(
                messages=[{"role": "user", "content": prompt}],
                max_tokens=200
            )
            return response.content
        except Exception:
            return ""

    async def _get_user_skill_profile(
        self,
        user_id: str,
        skill_id: str
    ) -> Optional[dict]:
        """è·å–ç”¨æˆ·æŠ€èƒ½æ¡£æ¡ˆ"""
        row = await self.db.fetchrow("""
            SELECT profile_data FROM skill_profiles
            WHERE user_id = $1::uuid AND skill_id = $2
        """, user_id, skill_id)

        if row:
            return row["profile_data"]
        return None

    async def generate_weekly_fortune(self, user_id: str) -> GeneratedContent:
        """ç”Ÿæˆå‘¨è¿å†…å®¹"""
        user = await self._get_user_info(user_id)
        display_name = user.get("display_name", "æœ‹å‹") if user else "æœ‹å‹"

        # è·å–ç”¨æˆ·çš„å…«å­—å’Œæ˜Ÿåº§ä¿¡æ¯
        bazi_profile = await self._get_user_skill_profile(user_id, "bazi")
        zodiac_profile = await self._get_user_skill_profile(user_id, "zodiac")

        personalized_content = ""
        if self.llm:
            prompt = f"""ä¸ºç”¨æˆ·ç”Ÿæˆæœ¬å‘¨è¿åŠ¿æ¦‚è¦ï¼ˆ3-4å¥è¯ï¼‰ï¼š

ç”¨æˆ·ä¿¡æ¯ï¼š
- å…«å­—ï¼š{bazi_profile.get('chart', 'æœªçŸ¥') if bazi_profile else 'æœªçŸ¥'}
- æ˜Ÿåº§ï¼š{zodiac_profile.get('sun_sign', 'æœªçŸ¥') if zodiac_profile else 'æœªçŸ¥'}

è¦æ±‚ï¼š
1. ç»¼åˆå…«å­—å’Œæ˜Ÿåº§è§†è§’
2. ç»™å‡ºæœ¬å‘¨æ•´ä½“èƒ½é‡å»ºè®®
3. æé†’ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ–¹é¢
4. é¼“åŠ±æ­£å‘çš„å°è¡ŒåŠ¨"""

            try:
                response = await self.llm.generate(
                    messages=[{"role": "user", "content": prompt}],
                    max_tokens=300
                )
                personalized_content = response.content
            except Exception:
                personalized_content = "è¿™ä¸€å‘¨çš„èƒ½é‡æ•´ä½“å¹³ç¨³ï¼Œé€‚åˆæŒ‰éƒ¨å°±ç­åœ°æ¨è¿›è®¡åˆ’ã€‚è®°å¾—ç»™è‡ªå·±ç•™ä¸€äº›ä¼‘æ¯çš„æ—¶é—´ã€‚"

        template = REMINDER_TEMPLATES[ReminderType.WEEKLY_FORTUNE]
        content = template["template"].format(
            display_name=display_name,
            personalized_content=personalized_content
        )

        return GeneratedContent(
            title=template["title"],
            content=content,
            short_content="æ–°çš„ä¸€å‘¨ï¼ŒæŸ¥çœ‹ä½ çš„è¿åŠ¿"
        )

    async def generate_birthday_greeting(self, user_id: str) -> GeneratedContent:
        """ç”Ÿæˆç”Ÿæ—¥ç¥ç¦å†…å®¹"""
        user = await self._get_user_info(user_id)
        display_name = user.get("display_name", "æœ‹å‹") if user else "æœ‹å‹"

        personalized_content = ""
        if self.llm:
            prompt = f"""ä¸ºç”¨æˆ·ç”Ÿæˆç”Ÿæ—¥ç¥ç¦ï¼ˆ2-3å¥è¯ï¼‰ï¼š

ç”¨æˆ·å‡ºç”Ÿæ—¶é—´ï¼š{user.get('birth_datetime', 'æœªçŸ¥') if user else 'æœªçŸ¥'}

è¦æ±‚ï¼š
1. æ¸©æš–çœŸæŒš
2. å¯ä»¥ç»“åˆå‘½ç†ç‰¹ç‚¹æåŠç”¨æˆ·çš„ä¼˜ç‚¹
3. å¯¹æ–°ä¸€å²çš„ç¾å¥½æœŸè®¸"""

            try:
                response = await self.llm.generate(
                    messages=[{"role": "user", "content": prompt}],
                    max_tokens=200
                )
                personalized_content = response.content
            except Exception:
                personalized_content = "åˆé•¿å¤§ä¸€å²çš„ä½ ï¼Œå¸¦ç€è¿‡å»çš„æ™ºæ…§å’Œç»éªŒï¼Œä¸€å®šä¼šåœ¨æ–°çš„ä¸€å¹´é‡Œç»½æ”¾æ›´è€€çœ¼çš„å…‰èŠ’ã€‚"

        template = REMINDER_TEMPLATES[ReminderType.BIRTHDAY]
        content = template["template"].format(
            display_name=display_name,
            personalized_content=personalized_content
        )

        return GeneratedContent(
            title=template["title"],
            content=content,
            short_content=f"ğŸ‚ {display_name}ï¼Œç”Ÿæ—¥å¿«ä¹ï¼"
        )
