# VibeLife 部署指南

## 环境要求

### 系统要求
- Node.js 18+
- Python 3.11+
- PostgreSQL 15+ (with pgvector extension)
- Redis (可选，用于缓存)

### 云服务
- Stripe 账户 (支付)
- 智谱 API (LLM)
- Google Cloud (Gemini Embedding)
- Pinecone (向量存储，可选)

---

## 环境变量配置

创建 `.env` 文件：

```bash
# ─────────────────────────────────────────────────────────────────
# 数据库
# ─────────────────────────────────────────────────────────────────
VIBELIFE_DB_URL=postgresql://postgres:password@localhost:5432/vibelife

# ─────────────────────────────────────────────────────────────────
# JWT 认证
# ─────────────────────────────────────────────────────────────────
VIBELIFE_JWT_SECRET=your-secure-jwt-secret-key
VIBELIFE_JWT_EXPIRE_MINUTES=60
VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30

# ─────────────────────────────────────────────────────────────────
# LLM 服务 - 智谱 GLM
# ─────────────────────────────────────────────────────────────────
GLM_API_KEY=your-glm-api-key
GLM_CHAT_MODEL=glm-4.7
GLM_VISION_MODEL=glm-4.6v

# ─────────────────────────────────────────────────────────────────
# Claude (备选)
# ─────────────────────────────────────────────────────────────────
CLAUDE_API_KEY=your-claude-api-key
CLAUDE_MODEL=claude-3-5-sonnet-20241022

# ─────────────────────────────────────────────────────────────────
# Embedding - Google Gemini
# ─────────────────────────────────────────────────────────────────
GEMINI_API_KEY=your-gemini-api-key
GEMINI_EMBEDDING_MODEL=gemini-embedding-001

# ─────────────────────────────────────────────────────────────────
# Pinecone (向量存储)
# ─────────────────────────────────────────────────────────────────
PINECONE_API_KEY=your-pinecone-api-key
PINECONE_HOST=your-index.pinecone.io

# ─────────────────────────────────────────────────────────────────
# Stripe 支付
# ─────────────────────────────────────────────────────────────────
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# ─────────────────────────────────────────────────────────────────
# 应用配置
# ─────────────────────────────────────────────────────────────────
VIBELIFE_API_HOST=0.0.0.0
VIBELIFE_API_PORT=8000
VIBELIFE_CORS_ORIGINS=https://vibelife.app,https://bazi.vibelife.app
VIBELIFE_ENV=production
```

---

## 本地开发

### 1. 克隆仓库
```bash
git clone https://github.com/your-org/vibelife.git
cd vibelife
```

### 2. 安装依赖

**后端:**
```bash
cd apps/api
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

**前端:**
```bash
cd apps/web
pnpm install
```

### 3. 数据库初始化
```bash
# 创建数据库
psql -U postgres -c "CREATE DATABASE vibelife"

# 安装 pgvector 扩展
psql -U postgres -d vibelife -c "CREATE EXTENSION IF NOT EXISTS vector"

# 运行迁移
psql -U postgres -d vibelife -f migrations/001_init.sql
```

### 4. 启动服务

**方式一: 分别启动**
```bash
# 后端
cd apps/api
VIBELIFE_DEV=1 python -m uvicorn main:app --reload

# 前端
cd apps/web
pnpm dev
```

**方式二: Docker Compose**
```bash
docker-compose up -d
```

---

## 生产部署

### Docker 部署

```bash
# 构建镜像
docker build -t vibelife-api ./apps/api
docker build -t vibelife-web ./apps/web

# 运行容器
docker run -d \
  --name vibelife-api \
  -p 8000:8000 \
  --env-file .env \
  vibelife-api

docker run -d \
  --name vibelife-web \
  -p 3000:3000 \
  vibelife-web
```

### Kubernetes 部署

参考 `k8s/` 目录下的配置文件：
- `deployment.yaml` - 部署配置
- `service.yaml` - 服务配置
- `ingress.yaml` - 入口配置
- `configmap.yaml` - 配置映射
- `secrets.yaml` - 密钥配置

### Vercel 部署 (前端)

1. 连接 GitHub 仓库
2. 设置根目录为 `apps/web`
3. 配置环境变量
4. 部署

---

## 数据库迁移

```bash
# 查看当前版本
psql -d vibelife -c "SELECT * FROM schema_migrations"

# 运行迁移
psql -d vibelife -f migrations/002_xxx.sql

# 回滚 (手动)
psql -d vibelife -f migrations/002_xxx_down.sql
```

---

## 监控与日志

### 健康检查
```bash
curl https://api.vibelife.app/health
```

### 日志查看
```bash
# Docker
docker logs -f vibelife-api

# Kubernetes
kubectl logs -f deployment/vibelife-api
```

### 性能监控

推荐工具：
- Sentry (错误追踪)
- Prometheus + Grafana (指标监控)
- ELK Stack (日志聚合)

---

## 故障排查

### 常见问题

**1. 数据库连接失败**
```bash
# 检查 PostgreSQL 状态
systemctl status postgresql

# 检查连接
psql -U postgres -h localhost -d vibelife
```

**2. LLM 调用失败**
```bash
# 检查 API Key
curl -X POST https://open.bigmodel.cn/api/paas/v4/chat/completions \
  -H "Authorization: Bearer $GLM_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{"model":"glm-4.7","messages":[{"role":"user","content":"hi"}]}'
```

**3. Stripe Webhook 验证失败**
- 确认 Webhook Secret 正确
- 检查签名头 `Stripe-Signature`
- 确保使用原始请求体验证

---

## 安全建议

1. **API 密钥**: 使用环境变量，不要提交到代码库
2. **HTTPS**: 生产环境必须使用 HTTPS
3. **CORS**: 限制允许的来源域名
4. **Rate Limiting**: 配置请求限流
5. **日志脱敏**: 不要记录敏感信息
6. **定期更新**: 保持依赖包更新
