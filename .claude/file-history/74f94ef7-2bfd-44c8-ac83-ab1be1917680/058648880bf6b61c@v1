"""
八字工具测试
"""

import pytest
from datetime import datetime
from tools.bazi.calculator import BaziCalculator


class TestBaziCalculator:
    """八字计算器测试"""

    def test_generate_chart_basic(self):
        """测试基本排盘"""
        calc = BaziCalculator()

        # 1990年5月15日 10:30 北京
        result = calc.generate_chart(
            birth_datetime=datetime(1990, 5, 15, 10, 30),
            birth_location="北京",
            gender="male"
        )

        assert result is not None
        assert "year" in result
        assert "month" in result
        assert "day" in result
        assert "hour" in result
        assert "day_master" in result

        # 检查干支格式
        assert "stem" in result["year"]
        assert "branch" in result["year"]

    def test_heavenly_stems(self):
        """测试天干计算"""
        calc = BaziCalculator()

        # 天干列表
        stems = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]

        # 验证天干存在
        result = calc.generate_chart(
            birth_datetime=datetime(2000, 1, 1, 12, 0)
        )

        assert result["year"]["stem"] in stems
        assert result["month"]["stem"] in stems
        assert result["day"]["stem"] in stems
        assert result["hour"]["stem"] in stems

    def test_earthly_branches(self):
        """测试地支计算"""
        calc = BaziCalculator()

        # 地支列表
        branches = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]

        result = calc.generate_chart(
            birth_datetime=datetime(2000, 1, 1, 12, 0)
        )

        assert result["year"]["branch"] in branches
        assert result["month"]["branch"] in branches
        assert result["day"]["branch"] in branches
        assert result["hour"]["branch"] in branches

    def test_day_master_element(self):
        """测试日主五行"""
        calc = BaziCalculator()

        elements = ["木", "火", "土", "金", "水"]

        result = calc.generate_chart(
            birth_datetime=datetime(1990, 5, 15, 10, 30)
        )

        assert "day_master_element" in result
        assert result["day_master_element"] in elements

    def test_hour_branch_mapping(self):
        """测试时辰地支映射"""
        calc = BaziCalculator()

        # 子时 (23:00-01:00)
        result = calc.generate_chart(datetime(2000, 1, 1, 0, 30))
        assert result["hour"]["branch"] == "子"

        # 午时 (11:00-13:00)
        result = calc.generate_chart(datetime(2000, 1, 1, 12, 0))
        assert result["hour"]["branch"] == "午"

    def test_gender_affects_dayun(self):
        """测试性别影响大运"""
        calc = BaziCalculator()

        male_result = calc.generate_chart(
            birth_datetime=datetime(1990, 5, 15, 10, 30),
            gender="male"
        )

        female_result = calc.generate_chart(
            birth_datetime=datetime(1990, 5, 15, 10, 30),
            gender="female"
        )

        # 男女大运方向可能不同
        # 这里只验证两者都有结果
        assert male_result is not None
        assert female_result is not None


class TestBaziTransit:
    """大运流年测试"""

    def test_calculate_dayun(self):
        """测试大运计算"""
        from tools.bazi.transit import BaziTransitCalculator

        calc = BaziTransitCalculator()

        result = calc.calculate_dayun(
            birth_datetime=datetime(1990, 5, 15, 10, 30),
            gender="male"
        )

        assert result is not None
        assert "dayun_list" in result
        assert "start_age" in result
        assert len(result["dayun_list"]) > 0

    def test_calculate_liunian(self):
        """测试流年计算"""
        from tools.bazi.transit import BaziTransitCalculator

        calc = BaziTransitCalculator()

        result = calc.calculate_liunian(2026)

        assert result is not None
        assert "year" in result
        assert "stem" in result
        assert "branch" in result


class TestBaziAnalysis:
    """八字分析测试"""

    def test_analyze_ten_gods(self, sample_bazi_chart):
        """测试十神分析"""
        from tools.bazi.analysis import BaziAnalyzer

        analyzer = BaziAnalyzer()
        result = analyzer.analyze_ten_gods(sample_bazi_chart)

        assert result is not None
        assert "ten_gods" in result

    def test_calculate_element_strength(self, sample_bazi_chart):
        """测试五行力量分析"""
        from tools.bazi.analysis import BaziAnalyzer

        analyzer = BaziAnalyzer()
        result = analyzer.calculate_element_strength(sample_bazi_chart)

        assert result is not None
        assert "wood" in result
        assert "fire" in result
        assert "earth" in result
        assert "metal" in result
        assert "water" in result

        # 验证总和为 100
        total = sum(result.values())
        assert abs(total - 100) < 0.1  # 允许浮点误差
