import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";

/**
 * Middleware - 子域名检测（Clerk 认证已禁用）
 *
 * 支持的子域名:
 * - bazi.vibelife.app -> skill=bazi
 * - zodiac.vibelife.app -> skill=zodiac
 * - mbti.vibelife.app -> skill=mbti
 *
 * 本地开发:
 * - localhost:3000 -> 默认 skill=bazi
 * - bazi.localhost:3000 -> skill=bazi
 * - zodiac.localhost:3000 -> skill=zodiac
 */

// 支持的 skill 类型
const VALID_SKILLS = ["bazi", "zodiac", "mbti", "attach", "career"] as const;
type ValidSkill = (typeof VALID_SKILLS)[number];

// 默认 skill
const DEFAULT_SKILL: ValidSkill = "bazi";

export default function middleware(request: NextRequest) {
  const url = request.nextUrl.clone();
  const hostname = request.headers.get("host") || "";

  // 提取子域名
  let skill: ValidSkill = DEFAULT_SKILL;

  // 检测子域名
  // 格式: {skill}.vibelife.app 或 {skill}.localhost:xxxx
  const parts = hostname.split(".");

  if (parts.length >= 2) {
    const subdomain = parts[0].toLowerCase();

    // 检查是否是有效的 skill 子域名
    if (VALID_SKILLS.includes(subdomain as ValidSkill)) {
      skill = subdomain as ValidSkill;
    }
  }

  // 设置 skill 到请求头，供后续使用
  const requestHeaders = new Headers(request.headers);
  requestHeaders.set("x-vibelife-skill", skill);

  // 创建响应
  const response = NextResponse.next({
    request: {
      headers: requestHeaders,
    },
  });

  // 设置 cookie（非 httpOnly，允许客户端 JS 读取）
  response.cookies.set("vibelife-skill", skill, {
    path: "/",
    sameSite: "lax",
    secure: process.env.NODE_ENV === "production",
    maxAge: 60 * 60 * 24 * 365, // 1 year
  });

  return response;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except:
     * - _next/static (static files)
     * - _next/image (image optimization files)
     * - favicon.ico (favicon file)
     * - public folder files
     */
    "/((?!_next/static|_next/image|favicon.ico|.*\\..*|api).*)",
  ],
};
