-- ═══════════════════════════════════════════════════════════════════════════
-- Migration 020: Privacy Pairing System
-- ═══════════════════════════════════════════════════════════════════════════
-- - pairing_requests: 配对请求记录
-- - synastry_results: 隐私安全的合盘结果
-- - invite_links: 邀请链接
-- Created: 2026-01-22

-- ─────────────────────────────────────────────────────────────────
-- 1. Pairing Requests Table
-- ─────────────────────────────────────────────────────────────────
-- 用于追踪用户之间的配对请求状态

CREATE TABLE IF NOT EXISTS pairing_requests (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    requester_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    target_vibe_id VARCHAR(20) NOT NULL,
    target_user_id UUID REFERENCES vibe_users(id) ON DELETE SET NULL,
    relationship_type VARCHAR(50) NOT NULL,
    message TEXT,
    status VARCHAR(20) DEFAULT 'pending',  -- pending | accepted | rejected | expired
    expires_at TIMESTAMPTZ NOT NULL,
    responded_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE pairing_requests IS '隐私配对请求记录';
COMMENT ON COLUMN pairing_requests.requester_id IS '发起请求的用户 ID';
COMMENT ON COLUMN pairing_requests.target_vibe_id IS '目标用户的 Vibe ID (VB-XXXXXXXX)';
COMMENT ON COLUMN pairing_requests.target_user_id IS '目标用户的 UUID (查询后填充)';
COMMENT ON COLUMN pairing_requests.relationship_type IS '关系类型: romantic, spouse, parent_child, sibling, business, friend';
COMMENT ON COLUMN pairing_requests.status IS '请求状态: pending (待处理), accepted (已接受), rejected (已拒绝), expired (已过期)';
COMMENT ON COLUMN pairing_requests.expires_at IS '请求过期时间 (默认 7 天)';

-- Indexes for efficient queries
CREATE INDEX IF NOT EXISTS idx_pairing_requests_requester ON pairing_requests(requester_id);
CREATE INDEX IF NOT EXISTS idx_pairing_requests_target_vibe_id ON pairing_requests(target_vibe_id);
CREATE INDEX IF NOT EXISTS idx_pairing_requests_target_user ON pairing_requests(target_user_id) WHERE target_user_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_pairing_requests_status ON pairing_requests(status) WHERE status = 'pending';
CREATE INDEX IF NOT EXISTS idx_pairing_requests_expires ON pairing_requests(expires_at) WHERE status = 'pending';

-- ─────────────────────────────────────────────────────────────────
-- 2. Synastry Results Table
-- ─────────────────────────────────────────────────────────────────
-- 存储隐私安全的合盘结果（不包含原始出生数据）

CREATE TABLE IF NOT EXISTS synastry_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    owner_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    partner_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    relationship_type VARCHAR(50) NOT NULL,
    partner_display_name VARCHAR(100),
    overall_score INT NOT NULL CHECK (overall_score >= 0 AND overall_score <= 100),
    overall_label VARCHAR(50),
    dimensions JSONB DEFAULT '[]',
    strengths JSONB DEFAULT '[]',
    challenges JSONB DEFAULT '[]',
    advice JSONB DEFAULT '[]',
    calculated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(owner_id, partner_id)
);

COMMENT ON TABLE synastry_results IS '隐私安全的合盘结果';
COMMENT ON COLUMN synastry_results.owner_id IS '合盘结果所有者';
COMMENT ON COLUMN synastry_results.partner_id IS '合盘对象';
COMMENT ON COLUMN synastry_results.partner_display_name IS '对方显示名称 (用于展示)';
COMMENT ON COLUMN synastry_results.overall_score IS '综合评分 (0-100)';
COMMENT ON COLUMN synastry_results.overall_label IS '评价标签: 天作之合, 默契组合, 需要磨合, 互补成长, 挑战较多';
COMMENT ON COLUMN synastry_results.dimensions IS '各维度评分详情 JSON';
COMMENT ON COLUMN synastry_results.strengths IS '关系亮点 JSON';
COMMENT ON COLUMN synastry_results.challenges IS '需要注意的地方 JSON';
COMMENT ON COLUMN synastry_results.advice IS '相处建议 JSON';

-- Indexes
CREATE INDEX IF NOT EXISTS idx_synastry_results_owner ON synastry_results(owner_id);
CREATE INDEX IF NOT EXISTS idx_synastry_results_partner ON synastry_results(partner_id);
CREATE INDEX IF NOT EXISTS idx_synastry_results_calculated ON synastry_results(calculated_at DESC);

-- ─────────────────────────────────────────────────────────────────
-- 3. Invite Links Table
-- ─────────────────────────────────────────────────────────────────
-- 用于 VibeLink 邀请链接功能

CREATE TABLE IF NOT EXISTS invite_links (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    creator_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    token VARCHAR(32) UNIQUE NOT NULL,
    relationship_type VARCHAR(50) NOT NULL,
    invite_message TEXT,
    status VARCHAR(20) DEFAULT 'active',  -- active | used | expired
    used_by_id UUID REFERENCES vibe_users(id) ON DELETE SET NULL,
    used_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

COMMENT ON TABLE invite_links IS 'VibeLink 邀请链接';
COMMENT ON COLUMN invite_links.creator_id IS '邀请链接创建者';
COMMENT ON COLUMN invite_links.token IS '邀请码 (32位随机字符串)';
COMMENT ON COLUMN invite_links.relationship_type IS '关系类型';
COMMENT ON COLUMN invite_links.invite_message IS '邀请留言';
COMMENT ON COLUMN invite_links.status IS '链接状态: active (有效), used (已使用), expired (已过期)';
COMMENT ON COLUMN invite_links.used_by_id IS '使用该链接的用户 ID';
COMMENT ON COLUMN invite_links.expires_at IS '链接过期时间 (默认 7 天)';

-- Indexes
CREATE INDEX IF NOT EXISTS idx_invite_links_token ON invite_links(token);
CREATE INDEX IF NOT EXISTS idx_invite_links_creator ON invite_links(creator_id);
CREATE INDEX IF NOT EXISTS idx_invite_links_status ON invite_links(status) WHERE status = 'active';
CREATE INDEX IF NOT EXISTS idx_invite_links_expires ON invite_links(expires_at) WHERE status = 'active';

-- ─────────────────────────────────────────────────────────────────
-- 4. Cleanup Functions
-- ─────────────────────────────────────────────────────────────────

-- 清理过期的配对请求
CREATE OR REPLACE FUNCTION cleanup_expired_pairing_requests()
RETURNS INTEGER AS $$
DECLARE
    updated_count INTEGER;
BEGIN
    UPDATE pairing_requests
    SET status = 'expired'
    WHERE expires_at < NOW() AND status = 'pending';

    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RETURN updated_count;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION cleanup_expired_pairing_requests IS '清理过期的配对请求';

-- 清理过期的邀请链接
CREATE OR REPLACE FUNCTION cleanup_expired_invite_links()
RETURNS INTEGER AS $$
DECLARE
    updated_count INTEGER;
BEGIN
    UPDATE invite_links
    SET status = 'expired'
    WHERE expires_at < NOW() AND status = 'active';

    GET DIAGNOSTICS updated_count = ROW_COUNT;
    RETURN updated_count;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION cleanup_expired_invite_links IS '清理过期的邀请链接';

-- ═══════════════════════════════════════════════════════════════════════════
-- DONE
-- ═══════════════════════════════════════════════════════════════════════════
SELECT 'Migration 020: Privacy Pairing System completed' as status;
