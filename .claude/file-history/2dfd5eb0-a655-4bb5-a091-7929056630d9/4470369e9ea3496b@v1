'use client';

/**
 * Shared Invite Page - VibeLink 邀请页面
 *
 * 公开访问的合盘邀请页面，展示邀请信息
 * 设计风格：密影海报风格，神秘感
 */

import React, { useState } from 'react';
import { useParams, useRouter } from 'next/navigation';
import useSWR from 'swr';
import { AlertCircle, Heart, ArrowRight, Sparkles } from 'lucide-react';
import { apiClient } from '@/lib/api';

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface InviteInfo {
  valid: boolean;
  token: string;
  status?: string;
  creatorName: string;
  relationshipType: string;
  relationshipLabel: string;
  message?: string;
  expiresAt?: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// API Functions
// ═══════════════════════════════════════════════════════════════════════════

async function fetchInviteInfo(token: string): Promise<InviteInfo> {
  const response = await apiClient.get<InviteInfo>(`/api/v1/pairing/link/${token}`);
  return response.data;
}

// ═══════════════════════════════════════════════════════════════════════════
// Helper Functions
// ═══════════════════════════════════════════════════════════════════════════

function formatExpiry(isoString?: string): string {
  if (!isoString) return "";
  const date = new Date(isoString);
  const now = new Date();
  const diffMs = date.getTime() - now.getTime();
  const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

  if (diffDays <= 0) return "已过期";
  if (diffDays === 1) return "1天后过期";
  return `${diffDays}天后过期`;
}

function getRelationshipEmoji(type: string): string {
  const emojis: Record<string, string> = {
    romantic: "heart",
    spouse: "ring",
    parent_child: "family",
    sibling: "siblings",
    business: "briefcase",
    friend: "friends",
  };
  return emojis[type] || "heart";
}

// ═══════════════════════════════════════════════════════════════════════════
// Loading Skeleton
// ═══════════════════════════════════════════════════════════════════════════

function LoadingSkeleton() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      <div className="max-w-md w-full mx-auto px-4">
        <div className="text-center">
          <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-purple-500/30 animate-pulse" />
          <div className="h-8 w-48 mx-auto bg-white/10 rounded animate-pulse mb-4" />
          <div className="h-4 w-64 mx-auto bg-white/10 rounded animate-pulse mb-8" />
          <div className="h-12 w-full bg-white/10 rounded-lg animate-pulse" />
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Error States
// ═══════════════════════════════════════════════════════════════════════════

function ExpiredState() {
  const router = useRouter();

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      <div className="text-center px-4">
        <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-amber-500/20 flex items-center justify-center">
          <AlertCircle className="w-10 h-10 text-amber-400" />
        </div>
        <h1 className="text-2xl font-bold text-white mb-2">链接已失效</h1>
        <p className="text-purple-200 mb-6">
          该邀请链接可能已过期或已被使用
        </p>
        <button
          onClick={() => router.push('/')}
          className="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg hover:from-pink-600 hover:to-purple-600 transition-colors"
        >
          前往 VibeLife
        </button>
      </div>
    </div>
  );
}

function NotFoundState() {
  const router = useRouter();

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900">
      <div className="text-center px-4">
        <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-red-500/20 flex items-center justify-center">
          <AlertCircle className="w-10 h-10 text-red-400" />
        </div>
        <h1 className="text-2xl font-bold text-white mb-2">链接不存在</h1>
        <p className="text-purple-200 mb-6">
          无法找到该邀请链接
        </p>
        <button
          onClick={() => router.push('/')}
          className="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white rounded-lg hover:from-pink-600 hover:to-purple-600 transition-colors"
        >
          前往 VibeLife
        </button>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Main Component
// ═══════════════════════════════════════════════════════════════════════════

export default function SharedInvitePage(): React.ReactElement {
  const params = useParams<{ token: string }>();
  const token = params?.token ?? '';
  const router = useRouter();
  const [isRedirecting, setIsRedirecting] = useState(false);

  const { data, error, isLoading } = useSWR(
    token ? `invite-${token}` : null,
    () => fetchInviteInfo(token),
    { revalidateOnFocus: false }
  );

  const handleAccept = () => {
    setIsRedirecting(true);
    // Redirect to login/register with invite token
    router.push(`/auth/login?invite=${token}`);
  };

  if (isLoading) {
    return <LoadingSkeleton />;
  }

  if (error || !data) {
    return <NotFoundState />;
  }

  if (!data.valid || data.status === 'expired') {
    return <ExpiredState />;
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 relative overflow-hidden">
      {/* Decorative Elements */}
      <div className="absolute inset-0 overflow-hidden">
        <div className="absolute top-0 left-0 w-96 h-96 bg-purple-500 rounded-full blur-[128px] opacity-20" />
        <div className="absolute bottom-0 right-0 w-96 h-96 bg-pink-500 rounded-full blur-[128px] opacity-20" />
        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-indigo-500 rounded-full blur-[128px] opacity-10" />

        {/* Star Pattern */}
        {[...Array(30)].map((_, i) => (
          <div
            key={i}
            className="absolute w-1 h-1 bg-white rounded-full animate-pulse"
            style={{
              top: `${Math.random() * 100}%`,
              left: `${Math.random() * 100}%`,
              animationDelay: `${Math.random() * 3}s`,
              animationDuration: `${2 + Math.random() * 2}s`,
            }}
          />
        ))}
      </div>

      {/* Content */}
      <div className="relative z-10 min-h-screen flex flex-col items-center justify-center px-4 py-12">
        <div className="max-w-md w-full">
          {/* Logo */}
          <div className="text-center mb-8">
            <div className="inline-flex items-center gap-2 text-purple-300 text-sm">
              <Sparkles className="w-4 h-4" />
              <span>VibeLife</span>
            </div>
          </div>

          {/* Main Card */}
          <div className="bg-black/30 backdrop-blur-xl rounded-2xl border border-white/10 p-8 text-center">
            {/* Icon */}
            <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-pink-500/30 to-purple-500/30 border border-pink-400/30 mb-6">
              <Heart className="w-10 h-10 text-pink-300" fill="currentColor" />
            </div>

            {/* Title */}
            <h1 className="text-2xl font-bold text-white mb-2">
              有人想和你看缘分
            </h1>
            <p className="text-purple-200 mb-6">
              {data.creatorName} 邀请你一起合盘
            </p>

            {/* Relationship Badge */}
            <div className="flex justify-center mb-6">
              <span className="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-pink-500/20 text-pink-200 border border-pink-400/30">
                {data.relationshipLabel}
              </span>
            </div>

            {/* Message */}
            {data.message && (
              <div className="bg-white/5 rounded-lg p-4 mb-6 text-left">
                <p className="text-purple-200 text-sm italic">
                  &ldquo;{data.message}&rdquo;
                </p>
              </div>
            )}

            {/* Privacy Notice */}
            <div className="flex items-center justify-center gap-2 mb-6 text-green-300 text-xs">
              <svg className="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fillRule="evenodd" clipRule="evenodd"
                  d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                />
              </svg>
              <span>合盘结果不会泄露任何出生信息</span>
            </div>

            {/* CTA Button */}
            <button
              onClick={handleAccept}
              disabled={isRedirecting}
              className="w-full flex items-center justify-center gap-2 py-4 px-6 rounded-xl font-medium bg-gradient-to-r from-pink-500 to-purple-500 text-white hover:from-pink-600 hover:to-purple-600 transition-all disabled:opacity-50"
            >
              {isRedirecting ? (
                <span>跳转中...</span>
              ) : (
                <>
                  <span>加入 VibeLife，开启合盘</span>
                  <ArrowRight className="w-5 h-5" />
                </>
              )}
            </button>

            {/* Expiry */}
            {data.expiresAt && (
              <p className="text-purple-400 text-xs mt-4">
                {formatExpiry(data.expiresAt)}
              </p>
            )}
          </div>

          {/* Footer */}
          <div className="text-center mt-8">
            <p className="text-purple-400/70 text-xs">
              VibeLife · 让缘分可见
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
