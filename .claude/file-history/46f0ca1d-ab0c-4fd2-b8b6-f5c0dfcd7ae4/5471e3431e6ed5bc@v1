"""
Quote Service - 智能名言选择服务

基于用户上下文（时间、状态、订阅的 Skill）选择最合适的名言。
使用日期作为种子，同一天返回相同名言。
"""

from datetime import datetime
from typing import Dict, List, Optional, Any

# ═══════════════════════════════════════════════════════════════════════════
# 名言库
# ═══════════════════════════════════════════════════════════════════════════

VISION_QUOTES = [
    {"text": "你的愿景正在等待你的行动。", "author": None},
    {"text": "种一棵树最好的时间是十年前，其次是现在。", "author": "中国谚语"},
    {"text": "不是因为看见了才相信，而是因为相信了才看见。", "author": None},
    {"text": "你不必看清整个楼梯，只需迈出第一步。", "author": "马丁·路德·金"},
    {"text": "今天做的每一件小事，都是明天大事的预演。", "author": None},
    {"text": "目标不是用来达成的，而是用来指引方向的。", "author": "布鲁斯·李"},
    {"text": "梦想不会逃跑，逃跑的永远是自己。", "author": "村上春树"},
    {"text": "最慢的步伐不是跬步，而是徘徊。", "author": None},
]

PERSISTENCE_QUOTES = [
    {"text": "滴水穿石，不是力量大，而是功夫深。", "author": None},
    {"text": "每一次你想放弃的时候，想想为什么开始。", "author": None},
    {"text": "成功的秘诀在于坚持。坚持的秘诀在于热爱。", "author": None},
    {"text": "复利效应：今天的1%进步，一年后是37倍。", "author": None},
    {"text": "不是强者才能坚持，而是坚持了才会变强。", "author": None},
    {"text": "你已经走了这么远，不要忘记为什么出发。", "author": None},
    {"text": "日拱一卒，功不唐捐。", "author": "曾国藩"},
]

SELF_AWARENESS_QUOTES = [
    {"text": "认识你自己。", "author": "苏格拉底"},
    {"text": "你是谁，比你做什么更重要。", "author": None},
    {"text": "真正的自由是成为你自己。", "author": None},
    {"text": "接纳自己，是改变的起点。", "author": None},
    {"text": "每个人都是自己生命的作者。", "author": None},
    {"text": "最深的井，往往有最甜的水。", "author": "尼采"},
    {"text": "你内心的答案，比任何外在的声音都重要。", "author": None},
    {"text": "向内求，是所有外在成就的起点。", "author": None},
    {"text": "你的任务不是去寻找爱，而是去寻找并拆除你内心所有阻挡爱的障碍。", "author": "荣格"},
    {"text": "凡是你所抗拒的，都会持续。", "author": "荣格"},
    {"text": "往外看的人在做梦，往内看的人正清醒。", "author": "荣格"},
]

ACTION_QUOTES = [
    {"text": "千里之行，始于足下。", "author": "老子"},
    {"text": "想都是问题，做才是答案。", "author": None},
    {"text": "最好的准备就是立刻开始。", "author": None},
    {"text": "完成比完美更重要。", "author": None},
    {"text": "今天是余生中最年轻的一天。", "author": None},
    {"text": "你不需要很厉害才能开始，但需要开始才能很厉害。", "author": None},
    {"text": "行动是治愈恐惧的良药。", "author": None},
    {"text": "先完成，再完美。", "author": None},
]

GROWTH_QUOTES = [
    {"text": "舒适区的边缘，是成长发生的地方。", "author": None},
    {"text": "蜕变总是伴随着不舒服。", "author": None},
    {"text": "你不是在变老，而是在变好。", "author": None},
    {"text": "今天的你比昨天的你更接近目标。", "author": None},
    {"text": "每一次跌倒，都是在学习如何站得更稳。", "author": None},
    {"text": "不是环境造就人，而是人选择如何回应环境。", "author": "维克多·弗兰克尔"},
    {"text": "成长是一个过程，不是一个事件。", "author": None},
]

REST_QUOTES = [
    {"text": "休息不是放弃，而是为了走更远的路。", "author": None},
    {"text": "张弛有度，方能长久。", "author": None},
    {"text": "有时候，慢下来才能看清方向。", "author": None},
    {"text": "照顾好自己，才能照顾好世界。", "author": None},
    {"text": "留白是为了让重要的事物更突出。", "author": None},
    {"text": "能量管理比时间管理更重要。", "author": None},
]

BREAKTHROUGH_QUOTES = [
    {"text": "山重水复疑无路，柳暗花明又一村。", "author": "陆游"},
    {"text": "在你准备放弃的那一刻，往往离成功最近。", "author": None},
    {"text": "困难是化了妆的礼物。", "author": None},
    {"text": "没有到不了的明天。", "author": None},
    {"text": "冬天来了，春天还会远吗？", "author": "雪莱"},
    {"text": "你现在经历的，都会成为你未来的力量。", "author": None},
]

PERIODIC_QUOTES = {
    "monday": [
        {"text": "新的一周，新的可能。", "author": None},
        {"text": "周一是重新开始的好时机。", "author": None},
        {"text": "这周，你想成为什么样的人？", "author": None},
        {"text": "每个周一都是52次重新开始的机会。", "author": None},
    ],
    "friday": [
        {"text": "回顾这周，你离目标更近了一步。", "author": None},
        {"text": "这周的你，比上周的你更强了。", "author": None},
    ],
    "weekend": [
        {"text": "周末是给灵魂充电的时间。", "author": None},
        {"text": "休息好，才能走得更远。", "author": None},
        {"text": "好好休息，也是一种自律。", "author": None},
    ],
    "month_start": [
        {"text": "新的一月，新的篇章。", "author": None},
        {"text": "这个月，你想完成什么？", "author": None},
    ],
    "month_end": [
        {"text": "月底了，回顾一下这个月的收获。", "author": None},
        {"text": "无论结果如何，感谢这个月努力的自己。", "author": None},
    ],
}


# ═══════════════════════════════════════════════════════════════════════════
# 智能选择算法
# ═══════════════════════════════════════════════════════════════════════════


def _hash_code(s: str) -> int:
    """简单的字符串哈希函数"""
    h = 0
    for c in s:
        h = ((h << 5) - h + ord(c)) & 0xFFFFFFFF
    return h


def select_quote(
    hour: int,
    day_of_week: int,
    day_of_month: int,
    streak: int = 0,
    checked_in: bool = False,
    week_progress: float = 0.0,
    subscribed_skills: Optional[List[str]] = None,
) -> Dict[str, Any]:
    """
    智能选择名言

    基于用户上下文（时间、状态、订阅的 Skill）选择最合适的名言。
    使用日期作为种子，同一天返回相同名言。

    Args:
        hour: 当前小时 (0-23)
        day_of_week: 星期几 (0=周日, 1=周一, ..., 6=周六)
        day_of_month: 几号 (1-31)
        streak: 连续签到天数
        checked_in: 今天是否已签到
        week_progress: 本周进度 (0.0-1.0)
        subscribed_skills: 订阅的技能列表

    Returns:
        {"text": "...", "author": "..." or None}
    """
    subscribed_skills = subscribed_skills or []

    # 候选池: (quote, weight)
    candidate_pool: List[tuple] = []

    # 1. 周期性名言优先（特殊时间点）
    if day_of_week == 1:  # 周一
        for q in PERIODIC_QUOTES["monday"]:
            candidate_pool.append((q, 10))
    elif day_of_week == 5:  # 周五
        for q in PERIODIC_QUOTES["friday"]:
            candidate_pool.append((q, 10))
    elif day_of_week in (0, 6):  # 周末
        for q in PERIODIC_QUOTES["weekend"]:
            candidate_pool.append((q, 10))

    if day_of_month <= 3:
        for q in PERIODIC_QUOTES["month_start"]:
            candidate_pool.append((q, 12))
    elif day_of_month >= 28:
        for q in PERIODIC_QUOTES["month_end"]:
            candidate_pool.append((q, 12))

    # 2. 基于用户订阅 Skill 选择
    if "jungian" in subscribed_skills or "jungastro" in subscribed_skills:
        for q in SELF_AWARENESS_QUOTES:
            candidate_pool.append((q, 8))

    # 3. 基于用户状态选择
    if streak >= 7:
        for q in PERSISTENCE_QUOTES:
            candidate_pool.append((q, 8))

    if not checked_in and 6 <= hour < 12:
        for q in ACTION_QUOTES:
            candidate_pool.append((q, 8))

    if week_progress >= 0.7:
        for q in GROWTH_QUOTES:
            candidate_pool.append((q, 6))

    if week_progress < 0.3 and day_of_week >= 4:
        for q in BREAKTHROUGH_QUOTES:
            candidate_pool.append((q, 8))

    if hour >= 20 or day_of_week in (0, 6):
        for q in REST_QUOTES:
            candidate_pool.append((q, 5))

    # 4. 默认池补充
    for q in VISION_QUOTES:
        candidate_pool.append((q, 3))
    for q in SELF_AWARENESS_QUOTES:
        candidate_pool.append((q, 3))

    # 5. 加权随机选择（使用日期作为种子，同一天返回相同名言）
    seed = datetime.now().strftime("%Y-%m-%d")
    total_weight = sum(w for _, w in candidate_pool)
    target_weight = _hash_code(seed) % total_weight

    cumulative = 0
    for quote, weight in candidate_pool:
        cumulative += weight
        if cumulative >= target_weight:
            return {"text": quote["text"], "author": quote["author"]}

    return VISION_QUOTES[0]


def get_quote_for_dashboard(
    streak: int = 0,
    checked_in: bool = False,
    week_rocks_completed: int = 0,
    week_rocks_total: int = 0,
    subscribed_skills: Optional[List[str]] = None,
) -> Dict[str, Any]:
    """
    获取 Dashboard 用的名言

    便捷函数，自动计算时间相关参数。
    """
    now = datetime.now()
    week_progress = (week_rocks_completed / week_rocks_total) if week_rocks_total > 0 else 0.0

    return select_quote(
        hour=now.hour,
        day_of_week=now.weekday() + 1 if now.weekday() < 6 else 0,  # 转换为周日=0
        day_of_month=now.day,
        streak=streak,
        checked_in=checked_in,
        week_progress=week_progress,
        subscribed_skills=subscribed_skills,
    )
