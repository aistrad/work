"use client";

/**
 * BentoDashboard v2.0 - Bento é£æ ¼çš„ Chat æ¬¢è¿ç•Œé¢
 *
 * è®¾è®¡ç†å¿µï¼š
 * - æœ€è´´å¿ƒçš„åŠ©ç†/æœ‹å‹ï¼Œæå‰å‡†å¤‡å¥½ä¸€åˆ‡
 * - Bento å¡ç‰‡å¸ƒå±€ï¼Œæ¸…æ™°åˆ†éš”ï¼Œè§†è§‰å‘¼å¸æ„Ÿ
 * - èåˆè¿åŠ¿ + ç”Ÿæ´»ç›®æ ‡ï¼Œæä¾›æ´å¯Ÿ
 * - æ¸©æš–çš„æ–‡æ¡ˆï¼Œåƒæœ‹å‹ä¸€æ ·è¯´è¯
 *
 * v2.0 æ–°å¢ï¼š
 * - æ¯æ—¥åè¨€ï¼ˆæ™ºèƒ½é€‰æ‹©ï¼‰
 * - è¿åŠ¿å¡ç‰‡ï¼ˆåˆ†æ•°æ¡ + å®œ/å¿Œï¼‰
 * - ä»Šæ—¥é‡ç‚¹å¡ç‰‡ï¼ˆæ æ† + è¿åŠ¿èåˆï¼‰
 * - ç­¾åˆ°æ¡
 *
 * å¸ƒå±€ï¼š
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ GreetingCard (é—®å€™ + èŠ‚æ°” + åè¨€) â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ FortuneCard (è¿åŠ¿åˆ†æ•° + å®œ/å¿Œ)   â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ TodayPriorityCard (ä»Šæ—¥é‡ç‚¹)     â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
 * â”‚ â”‚NorthStarCardâ”‚WeekProgress  â”‚  â”‚
 * â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚ StreakBar (ç­¾åˆ°æ¡)              â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

import { useMemo } from "react";
import { cn } from "@/lib/utils";
import { motion } from "framer-motion";
import {
  GreetingCard,
  FortuneCard,
  TodayPriorityCard,
  StreakBar,
} from "./dashboard";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface Rock {
  id: string;
  text: string;
  role?: string;
  completed: boolean;
}

interface Lever {
  id: string;
  text: string;
  completed: boolean;
}

interface BentoDashboardData {
  // é—®å€™æ•°æ®
  greeting: string;
  solarTerm?: string;
  fortuneHint?: string;
  quote?: {
    text: string;
    author: string | null;
  };
  // Lifecoach æ•°æ®
  northStar?: string;
  weekRocks: Rock[];
  todayLevers: Lever[];
  // è¿åŠ¿æ•°æ®
  fortuneScore?: number;
  insights?: string[];
  // v2.0 æ–°å¢
  fortuneData?: {
    score: number;
    areaScores: Record<string, number>;
    suggestions: {
      do: string[];
      avoid: string[];
    };
    theme: string;
  };
  // çŠ¶æ€æ•°æ®
  streak?: number;
  checkedIn?: boolean;
}

interface BentoDashboardProps {
  data: BentoDashboardData;
  onCheckin?: () => void;
  onStartFocus?: (leverId: string) => void;
  className?: string;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Animation Variants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const containerVariants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: {
      staggerChildren: 0.08,
      delayChildren: 0.1,
    },
  },
};

const itemVariants = {
  hidden: { opacity: 0, y: 12 },
  visible: {
    opacity: 1,
    y: 0,
    transition: {
      duration: 0.4,
      ease: [0.25, 0.46, 0.45, 0.94],
    },
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function BentoDashboard({
  data,
  onCheckin,
  onStartFocus,
  className,
}: BentoDashboardProps) {
  const {
    greeting,
    solarTerm,
    fortuneHint,
    quote,
    northStar,
    weekRocks,
    todayLevers,
    insights,
    fortuneData,
    streak = 0,
    checkedIn = false,
  } = data;

  // è®¡ç®—æœ¬å‘¨è¿›åº¦
  const weekProgress = useMemo(() => {
    if (weekRocks.length === 0)
      return { completed: 0, total: 0, percentage: 0 };
    const completed = weekRocks.filter((r) => r.completed).length;
    return {
      completed,
      total: weekRocks.length,
      percentage: Math.round((completed / weekRocks.length) * 100),
    };
  }, [weekRocks]);

  // æœªå®Œæˆçš„ä»Šæ—¥è¡ŒåŠ¨
  const pendingLevers = useMemo(
    () => todayLevers.filter((l) => !l.completed),
    [todayLevers]
  );

  // æ˜¯å¦æ˜¾ç¤ºè¿åŠ¿å¡ç‰‡ï¼ˆéœ€è¦æœ‰è¿åŠ¿æ•°æ®ä¸”æœ‰å®œå¿Œå»ºè®®ï¼‰
  const showFortuneCard =
    fortuneData &&
    (fortuneData.suggestions.do.length > 0 ||
      fortuneData.suggestions.avoid.length > 0);

  return (
    <motion.div
      variants={containerVariants}
      initial="hidden"
      animate="visible"
      className={cn(
        "w-full max-w-lg md:max-w-xl lg:max-w-2xl mx-auto px-4 py-4 space-y-3",
        className
      )}
    >
      {/* 1. é—®å€™å¡ç‰‡ (å¸¦åè¨€) */}
      <motion.div variants={itemVariants}>
        <GreetingCard
          greeting={greeting}
          solarTerm={solarTerm}
          quote={quote}
        />
      </motion.div>

      {/* 2. è¿åŠ¿å¡ç‰‡ (å¦‚æœæœ‰è¿åŠ¿æ•°æ®) */}
      {showFortuneCard && (
        <motion.div variants={itemVariants}>
          <FortuneCard
            score={fortuneData.score}
            theme={fortuneData.theme}
            suggestions={fortuneData.suggestions}
            insights={insights}
          />
        </motion.div>
      )}

      {/* 3. ä»Šæ—¥é‡ç‚¹å¡ç‰‡ (å¦‚æœæœ‰å¾…åŠæ æ†) */}
      {pendingLevers.length > 0 && (
        <motion.div variants={itemVariants}>
          <TodayPriorityCard
            levers={pendingLevers}
            fortuneHint={
              fortuneData?.suggestions.do[0] || fortuneHint
            }
            onStartFocus={onStartFocus}
          />
        </motion.div>
      )}

      {/* 4. åŒ—ææ˜Ÿ + æœ¬å‘¨è¿›åº¦ï¼ˆåŒåˆ—ï¼‰ */}
      <div className="grid grid-cols-2 gap-3">
        <motion.div variants={itemVariants}>
          <NorthStarCard northStar={northStar} />
        </motion.div>
        <motion.div variants={itemVariants}>
          <WeekProgressCard
            completed={weekProgress.completed}
            total={weekProgress.total}
            percentage={weekProgress.percentage}
            rocks={weekRocks}
          />
        </motion.div>
      </div>

      {/* 5. ç­¾åˆ°æ¡ */}
      <motion.div variants={itemVariants}>
        <StreakBar
          streak={streak}
          checkedIn={checkedIn}
          onCheckin={onCheckin}
        />
      </motion.div>
    </motion.div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub Components (ä¿ç•™åŸæœ‰çš„åŒ—ææ˜Ÿå’Œè¿›åº¦å¡ç‰‡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * åŒ—ææ˜Ÿå¡ç‰‡ - æ„¿æ™¯æé†’
 */
function NorthStarCard({ northStar }: { northStar?: string }) {
  if (!northStar) {
    return (
      <div className="h-full min-h-[100px] rounded-2xl bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-950/30 dark:to-indigo-950/20 p-3 lg:p-4 border border-purple-100/50 dark:border-purple-800/30">
        <div className="text-xl lg:text-2xl mb-1.5">â­</div>
        <div className="text-xs lg:text-sm font-medium text-purple-900 dark:text-purple-100 mb-0.5">
          è®¾å®šåŒ—ææ˜Ÿ
        </div>
        <div className="text-[11px] lg:text-xs text-purple-600 dark:text-purple-300">
          æ‰¾åˆ°ä½ çš„äººç”Ÿæ–¹å‘
        </div>
      </div>
    );
  }

  return (
    <div className="h-full min-h-[100px] rounded-2xl bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-950/30 dark:to-indigo-950/20 p-3 lg:p-4 border border-purple-100/50 dark:border-purple-800/30">
      <div className="text-xl lg:text-2xl mb-1.5">â­</div>
      <div className="text-[11px] lg:text-xs text-purple-600 dark:text-purple-400 mb-0.5">
        åŒ—ææ˜Ÿæ„¿æ™¯
      </div>
      <div className="text-xs lg:text-sm font-medium text-purple-900 dark:text-purple-100 line-clamp-2 lg:line-clamp-3">
        {northStar}
      </div>
    </div>
  );
}

/**
 * æœ¬å‘¨è¿›åº¦å¡ç‰‡
 */
function WeekProgressCard({
  completed,
  total,
  percentage,
  rocks,
}: {
  completed: number;
  total: number;
  percentage: number;
  rocks: Rock[];
}) {
  if (total === 0) {
    return (
      <div className="h-full min-h-[100px] rounded-2xl bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-950/30 dark:to-green-950/20 p-3 lg:p-4 border border-emerald-100/50 dark:border-emerald-800/30">
        <div className="text-xl lg:text-2xl mb-1.5">ğŸ“Š</div>
        <div className="text-[11px] lg:text-xs text-emerald-600 dark:text-emerald-400 mb-0.5">
          æœ¬å‘¨é‡ç‚¹
        </div>
        <div className="text-xs lg:text-sm text-emerald-700 dark:text-emerald-300">
          è¿˜æ²¡æœ‰è®¾å®šç›®æ ‡
        </div>
      </div>
    );
  }

  return (
    <div className="h-full min-h-[100px] rounded-2xl bg-gradient-to-br from-emerald-50 to-green-50 dark:from-emerald-950/30 dark:to-green-950/20 p-3 lg:p-4 border border-emerald-100/50 dark:border-emerald-800/30">
      <div className="flex items-center justify-between mb-1.5">
        <span className="text-xl lg:text-2xl">ğŸ“Š</span>
        <span className="text-sm lg:text-base font-bold text-emerald-700 dark:text-emerald-300">
          {completed}/{total}
        </span>
      </div>
      <div className="text-[11px] lg:text-xs text-emerald-600 dark:text-emerald-400 mb-1.5 lg:mb-2">
        æœ¬å‘¨è¿›åº¦
      </div>

      {/* è¿›åº¦æ¡ */}
      <div className="h-1.5 lg:h-2 bg-emerald-200 dark:bg-emerald-800 rounded-full overflow-hidden">
        <motion.div
          initial={{ width: 0 }}
          animate={{ width: `${percentage}%` }}
          transition={{ duration: 0.8, delay: 0.3, ease: "easeOut" }}
          className="h-full bg-gradient-to-r from-emerald-400 to-green-500 rounded-full"
        />
      </div>

      {/* æœªå®Œæˆçš„äº‹é¡¹é¢„è§ˆ */}
      {rocks.filter((r) => !r.completed).length > 0 && (
        <div className="mt-1.5 lg:mt-2 text-[11px] lg:text-xs text-emerald-700 dark:text-emerald-300 truncate">
          â†’ {rocks.find((r) => !r.completed)?.text}
        </div>
      )}
    </div>
  );
}

export default BentoDashboard;
