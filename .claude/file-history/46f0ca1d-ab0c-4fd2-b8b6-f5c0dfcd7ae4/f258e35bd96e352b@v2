"use client";

/**
 * useBentoDashboardData - 将 Dashboard 数据转换为 BentoDashboard 格式
 *
 * 从原始 DashboardDTO 提取并转换数据为 BentoDashboard 所需格式
 */

import { useMemo } from "react";
import type { DashboardDTO } from "@/types/dashboard";

export interface BentoDashboardData {
  // 问候数据
  greeting: string;
  solarTerm?: string;
  fortuneHint?: string;
  quote?: {
    text: string;
    author: string | null;
  };
  // Lifecoach 数据
  northStar?: string;
  weekRocks: Array<{
    id: string;
    text: string;
    role?: string;
    completed: boolean;
  }>;
  todayLevers: Array<{
    id: string;
    text: string;
    completed: boolean;
  }>;
  // 运势数据
  fortuneScore?: number;
  insights?: string[];
  // v2.0 新增
  fortuneData?: {
    score: number;
    areaScores: Record<string, number>;
    suggestions: {
      do: string[];
      avoid: string[];
    };
    theme: string;
  };
  // 状态数据
  streak?: number;
  checkedIn?: boolean;
}

export function useBentoDashboardData(
  dashboard: DashboardDTO | null | undefined
): BentoDashboardData | null {
  return useMemo(() => {
    if (!dashboard) return null;

    // 提取 bazi skill 数据
    const baziCard = dashboard.mySkills.find((s) => s.skillId === "bazi");

    // 构建 insights
    const insights = baziCard?.content.insights
      ? Array.isArray(baziCard.content.insights)
        ? baziCard.content.insights.slice(0, 3)
        : []
      : [];

    // 根据时间生成问候语
    const hour = new Date().getHours();
    let greeting = "早上好";
    if (hour >= 5 && hour < 12) {
      greeting = "早上好";
    } else if (hour >= 12 && hour < 18) {
      greeting = "下午好";
    } else if (hour >= 18 && hour < 22) {
      greeting = "晚上好";
    } else {
      greeting = "夜深了";
    }

    // 如果有用户名，添加到问候语
    // greeting = dashboard.ambient.greeting || greeting;

    // 构建 v2.0 运势数据
    const fortuneData = baziCard
      ? {
          score: baziCard.content.rating?.overall ?? 60,
          areaScores: baziCard.content.rating?.details ?? {},
          suggestions: baziCard.content.suggestions ?? { do: [], avoid: [] },
          theme: baziCard.content.headline || "今天适合稳步前行",
        }
      : undefined;

    return {
      // 问候数据
      greeting: dashboard.ambient.greeting || greeting,
      solarTerm: dashboard.ambient.solarTerm,
      fortuneHint: baziCard?.content.headline || "今天适合稳步前行",
      quote: dashboard.ambient.quote,

      // Lifecoach 数据
      northStar: dashboard.lifecoach.northStar,
      weekRocks: dashboard.lifecoach.weekRocks || [],
      todayLevers: dashboard.lifecoach.todayLevers || [],

      // 运势数据
      fortuneScore: baziCard?.content.rating?.overall,
      insights,

      // v2.0 新增
      fortuneData,
      streak: dashboard.status.streak,
      checkedIn: dashboard.status.checkedIn,
    };
  }, [dashboard]);
}
