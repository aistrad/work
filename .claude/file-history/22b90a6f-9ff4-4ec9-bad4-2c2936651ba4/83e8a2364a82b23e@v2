# VibeLife Expert System 通用架构设计

> 版本: 1.2 Generic
> 日期: 2026-01-14
> 适用范围: 所有知识类Skill (Bazi, Zodiac, Tarot, Career, 等)
> 更新: 新增思维架构层、推理链条、指导模式

---

## 核心理念升级

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   从「结论导向」→「推理导向」                                                │
│                                                                             │
│   旧模式：专家系统 = 知识库 + 案例库 + SOP                                  │
│                                                                             │
│   新模式：专家系统 = 思维架构 + 推理链条 + 指导模式                          │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   思维架构 (Thinking Framework)：专家"怎么看"问题                   │   │
│   │   ───────────────────────────────────────────────────              │   │
│   │   每个专业领域都有一套独特的分析维度                                │   │
│   │   例：八字有主体架构、客体架构、时运架构等                          │   │
│   │                                                                     │   │
│   │   推理链条 (Reasoning Chain)：专家"怎么想"问题                      │   │
│   │   ───────────────────────────────────────────────────              │   │
│   │   记录从观察→分析→结论的完整思维过程                               │   │
│   │   用户能看到专家的思维过程，而不只是结论                            │   │
│   │                                                                     │   │
│   │   指导模式 (Guidance Pattern)：专家"怎么建议"用户                   │   │
│   │   ───────────────────────────────────────────────────              │   │
│   │   可复用的指导建议，这是专家系统的核心价值                          │   │
│   │   "八字学的实用性，不在于预见人生，而在于指导更理想的人生"          │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 一、系统定位

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   知识源                     系统                           交付            │
│   ──────                    ────                           ────            │
│                                                                             │
│   ┌─────────────┐         ┌──────────────────┐          ┌─────────────┐   │
│   │ 大模型通用  │         │                  │          │             │   │
│   │ 知识能力    │────────▶│   VibeLife       │─────────▶│  真人专家   │   │
│   └─────────────┘         │   Expert System  │          │  级服务     │   │
│                           │                  │          │             │   │
│   ┌─────────────┐         │  Claude Agent    │          └─────────────┘   │
│   │ 自有知识库  │────────▶│  SDK + Skill     │                            │
│   │ 经典/教程   │         │                  │                            │
│   └─────────────┘         └──────────────────┘                            │
│                                                                             │
│  ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│  适用领域:                                                                  │
│  • 八字命理 (Bazi)        • 西方占星 (Zodiac/Astrology)                    │
│  • 塔罗占卜 (Tarot)       • 职业规划 (Career)                              │
│  • 紫微斗数 (Ziwei)       • 心理咨询 (Psychology)                          │
│  • 风水堪舆 (Fengshui)    • 更多...                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、整体架构

### 2.1 架构全景图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      VibeLife Expert System                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ════════════════════════════ 构建时 (Build Time) ════════════════════════  │
│                                                                             │
│   /data/vibelife/{skill_id}/                                                │
│   ├── source/              原始源文件                                       │
│   └── converted/           格式转换后的MD                                   │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    Knowledge Builder Pipeline                        │  │
│   │                                                                     │  │
│   │  Stage 0      Stage 1      Stage 2      Stage 3      Stage 4       │  │
│   │  格式转换  →  解析切块  →  向量化   →   入库    →  内容提取        │  │
│   │                (大块)                              (案例/场景)      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│            │                         │                    │                 │
│            ▼                         ▼                    ▼                 │
│   ┌──────────────────┐    ┌──────────────────┐   ┌─────────────────────┐  │
│   │   PostgreSQL     │    │   PostgreSQL     │   │  Scenario Candidates │  │
│   │  knowledge_*     │    │     cases        │   │  (待评估)            │  │
│   └──────────────────┘    └──────────────────┘   └──────────┬──────────┘  │
│                                                              │              │
│                                                    人工评估 + 审核          │
│                                                              │              │
│                                                              ▼              │
│   /skills/{skill_id}/                      ◀────────────────────           │
│   ├── SKILL.md                                                             │
│   ├── scenarios/*.md                                                       │
│   └── tools/                                                               │
│       └── *.py / *.js / ...                                                │
│                                                                             │
│  ════════════════════════════ 运行时 (Runtime) ════════════════════════════ │
│                                                                             │
│   用户消息                                                                  │
│       │                                                                     │
│       ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                      Core Agent (Claude Agent SDK)                   │  │
│   │                                                                     │  │
│   │  1. LLM 路由 (use_skill 一次决定 skill + scenario + confidence)     │  │
│   │  2. 加载 SKILL.md + scenario.md (构建 System Prompt)                │  │
│   │  3. 执行 SOP (LLM 根据需要动态调用全局工具)                         │  │
│   │  4. 输出交付                                                        │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、目录结构

### 3.1 知识源目录 (构建输入)

```
/data/vibelife/
│
├── {skill_id}/                          # 每个Skill一个目录
│   │
│   ├── source/                         # 原始源文件
│   │   ├── *.pdf                       # PDF书籍
│   │   ├── *.epub                      # 电子书
│   │   ├── *.srt                       # 视频字幕
│   │   ├── *.docx                      # Word文档
│   │   └── ...
│   │
│   └── converted/                      # 格式转换后的结构化MD
│       ├── book_001.md                 # 转换后的书籍
│       ├── book_002.md
│       ├── manual_001.md               # 操作手册
│       └── cases_raw.md                # 原始案例集
│
├── bazi/
│   ├── source/
│   │   ├── ditianshui.pdf
│   │   └── ...
│   └── converted/
│       ├── ditianshui.md
│       └── ...
│
├── zodiac/
│   ├── source/
│   └── converted/
│
├── tarot/
│   ├── source/
│   └── converted/
│
└── career/
    ├── source/
    └── converted/
```

### 3.2 Skill目录 (Claude Agent SDK规范)

```
/skills/
│
├── {skill_id}/                          # 每个Skill一个目录
│   │
│   ├── SKILL.md                        # Skill核心定义
│   │
│   ├── scenarios/                      # MiniSkill场景库
│   │   ├── {scenario_id}.md           # 每个场景一个MD文件
│   │   └── ...
│   │
│   └── tools/                          # 工具目录 (可执行程序)
│       ├── {tool_name}.py             # Python工具
│       ├── {tool_name}.js             # JavaScript工具
│       ├── {tool_name}.sh             # Shell脚本
│       └── ...
│
├── bazi/
│   ├── SKILL.md
│   ├── scenarios/
│   │   ├── basic_reading.md
│   │   ├── yearly_report.md
│   │   └── ...
│   └── tools/
│       ├── calculate_bazi.py
│       ├── show_bazi_chart.py
│       └── ...
│
├── zodiac/
│   ├── SKILL.md
│   ├── scenarios/
│   └── tools/
│
├── tarot/
│   ├── SKILL.md
│   ├── scenarios/
│   └── tools/
│
└── career/
    ├── SKILL.md
    ├── scenarios/
    └── tools/
```

---

## 四、SKILL.md 通用模板

```markdown
# {Skill名称}

## 基础信息

- **ID**: {skill_id}
- **名称**: {skill_name}
- **版本**: {version}
- **描述**: {description}

## 专家身份

{expert_persona}

描述该领域专家的特征、知识来源、分析方法等。

**知识来源优先级**：
1. {primary_source} (核心经典/权威来源)
2. {secondary_source} (次要来源)
3. 实战验证案例
4. 大模型通用知识

## 场景目录

### 入门级 (Entry)

| 场景 | 文件 | 触发词 | 计费 |
|-----|------|-------|------|
| {场景名称} | {file}.md | {触发词列表} | 免费 |
| ... | ... | ... | ... |

### 标准级 (Standard)

| 场景 | 文件 | 触发词 | 计费 |
|-----|------|-------|------|
| {场景名称} | {file}.md | {触发词列表} | 基础 |
| ... | ... | ... | ... |

### 专业级 (Professional)

| 场景 | 文件 | 触发词 | 计费 |
|-----|------|-------|------|
| {场景名称} | {file}.md | {触发词列表} | 高级 |
| ... | ... | ... | ... |

## 服务级别定义

### 入门级 (Entry)
- **特点**: {特点描述}
- **对话轮次**: {轮次范围}
- **分析深度**: 简要
- **计费**: 免费

### 标准级 (Standard)
- **特点**: {特点描述}
- **对话轮次**: {轮次范围}
- **分析深度**: 详细
- **计费**: 基础积分

### 专业级 (Professional)
- **特点**: {特点描述}
- **对话轮次**: {轮次范围}
- **分析深度**: 综合全面
- **计费**: 高级积分
- **可启动后台Agent**: 是

## 路由配置

**路由方式**: PostgreSQL倒排查询

**升级信号词**: {升级信号词列表}

**默认场景**: {default_scenario_id}

## 伦理边界

### 绝对禁止
- {禁止事项1}
- {禁止事项2}
- ...

### 敏感问题处理
| 问题类型 | 处理方式 |
|---------|---------|
| {问题类型} | {处理方式} |
| ... | ... |

### 表达原则
- {原则1}
- {原则2}
- ...

## 工具列表

| 工具 | 程序 | 用途 |
|-----|------|------|
| {工具名称} | tools/{tool_name}.py | {用途描述} |
| ... | ... | ... |
```

---

## 五、Scenario 通用模板 (MiniSkill)

```markdown
# {场景名称}

## 元数据

- **ID**: {scenario_id}
- **名称**: {scenario_name}
- **级别**: {entry|standard|professional}
- **计费**: {free|basic|premium}
- **描述**: {description}

## 触发条件

**主要触发词**: {primary_triggers}

**次要触发词**: {secondary_triggers}

## 前置要求

- {requirement_1}
- {requirement_2}
- ...

## 可组合场景

本场景可引用以下MiniSkill的分析框架：
- {scenario_id_1} ({描述})
- {scenario_id_2} ({描述})

引用方式: 内联执行

## 输出配置

**使用工具**:
- {tool_1}
- {tool_2}
- ...

**交付物**: {deliverable_description}

**预估轮次**: {turns_range}

## 服务流程 (SOP)

### Phase 1: 信息收集

**类型**: required (如果缺少必要信息)

**描述**: 收集用户基础信息

**工具调用**:
```
collect_user_info:
  form_fields: [...]
  allow_text_input: true
  text_input_placeholder: "请描述你的问题..."
```

### Phase 2: 计算/处理

**类型**: required

**描述**: 执行确定性计算

**工具调用**:
```
calculate_chart:
  user_info: {from_phase_1}
  include_extra: true
```

### Phase 3: 快速扫描

**类型**: required

**描述**: 快速识别模式和红旗信号（30秒内完成）

**执行内容**:
- 匹配SKILL.md中的核心模式
- 检查红旗信号
- 确定分析方向

### Phase 4: 主动追问 (可选)

**类型**: optional

**描述**: 根据分析结果，向用户提出针对性问题以提高分析准确性

**触发条件**: 当检测到需要更多信息才能给出准确分析时

**工具调用**:
```
ask_user_question:
  question: "{根据分析生成的问题}"
  context: "为了给你更准确的分析，我想确认一下..."
  question_type: "open" | "choice" | "confirmation"
  choices: [...] (如果是选择题)
  allow_skip: true
```

**追问示例**:
| 触发条件 | 问题示例 |
|---------|---------|
| 检测到重大变动信号 | "你最近是否有重大人生决策要做？" |
| 分析方向不明确 | "你更想了解哪个方面：事业/财运/感情？" |
| 需要验证判断 | "你过去是否经历过...的情况？" |

**用户响应处理**:
- 回答 → 将答案纳入分析
- 跳过 → 基于现有信息继续分析

### Phase 5: 深度分析

**类型**: required

**描述**: 结合知识库和案例进行深度分析

**知识检索**:
| 检索项 | 类型 | 查询 |
|-------|------|------|
| {item} | {rag|keyword|hybrid} | {query} |

**案例匹配**:
```
query:
  {field1}: {value}
  {field2}: {value}
max_results: {n}
```

### Phase 6: 输出交付

**类型**: required

**工具调用顺序**:
1. show_chart (展示图表)
2. show_report (生成报告)
3. show_insight (洞察卡片)

### Phase 7: 答疑讨论

**类型**: reactive

**常见问题处理**:
| 问题模式 | 处理方式 |
|---------|---------|
| {pattern} | {action} |

## 输出模板

```
{output_template}
```
```

---

## 六、Tools 设计

### 6.1 工具层级架构

工具分为两个层级：全局工具（所有 skill 共享）和 Skill 级工具（定义在各 SKILL.md 中）。

| 层级 | 定义位置 | 加载时机 | 示例 |
|------|---------|---------|------|
| 全局工具 | 系统级 | 始终可用 | search_db, ask_user_question, show_insight |
| Skill 级工具 | SKILL.md | 路由到该 skill 后加载 | calculate_bazi, show_bazi_chart |

### 6.2 全局工具列表

| 工具 | 类型 | 用途 |
|-----|------|------|
| search_db | 检索型 | 统一数据库查询（知识/案例） |
| ask_user_question | 交互型 | 主动追问用户 |
| show_service_menu | 展示型 | 展示服务目录 |
| show_insight | 展示型 | 通用洞察卡片 |
| show_report | 展示型 | 通用报告 |

### 6.3 Skill 级工具示例

**bazi skill:**
| 工具 | 类型 | 用途 |
|-----|------|------|
| collect_bazi_info | 收集型 | 收集出生信息 |
| calculate_bazi | 计算型 | 排盘计算 |
| show_bazi_chart | 展示型 | 展示命盘图 |
| show_bazi_fortune | 展示型 | 展示运势分析 |
| show_bazi_kline | 展示型 | 展示运势K线 |

**zodiac skill:**
| 工具 | 类型 | 用途 |
|-----|------|------|
| collect_zodiac_info | 收集型 | 收集出生信息 |
| calculate_zodiac | 计算型 | 计算星盘 |
| show_zodiac_chart | 展示型 | 展示星盘图 |

### 6.4 工具目录结构

```
/skills/{skill_id}/tools/
│
├── __init__.py                    # Python包初始化
│
├── collect/                       # 收集类工具
│   ├── collect_user_info.py
│   └── ...
│
├── calculate/                     # 计算类工具
│   ├── calculate_chart.py
│   └── ...
│
├── display/                       # 展示类工具
│   ├── show_chart.py
│   ├── show_card.py
│   └── ...
│
├── report/                        # 报告类工具
│   └── generate_report.py
│
├── search/                        # 检索类工具
│   ├── search_knowledge.py
│   └── search_cases.py
│
├── interact/                      # 交互类工具
│   └── ask_user_question.py      # 主动追问工具
│
└── utils/                         # 工具函数
    └── helpers.py
```

### 6.3 主动追问工具 (AskUserQuestion)

参考Claude Code的`AskUserQuestionTool`设计，用于分析过程中主动向用户提问。

```python
# tools/interact/ask_user_question.py

"""
主动追问工具
在分析过程中向用户提出问题，获取更多信息以提高分析准确性

设计原则：
1. 问题必须与当前分析直接相关
2. 用户可以选择回答或跳过
3. 一次只问一个问题，避免信息过载
4. 问题要具体，避免开放式泛问
"""

from typing import Optional, List, Literal
from pydantic import BaseModel

class AskUserQuestionInput(BaseModel):
    """输入参数"""
    question: str                           # 问题内容
    context: str                            # 为什么问这个问题（对用户可见）
    question_type: Literal[
        "confirmation",    # 确认类：是/否
        "choice",          # 选择类：从选项中选
        "open",            # 开放类：自由回答
        "rating"           # 评分类：1-5或1-10
    ] = "open"
    choices: Optional[List[str]] = None     # 选择题的选项
    allow_skip: bool = True                 # 是否允许跳过
    skip_text: str = "跳过此问题"           # 跳过按钮文字
    importance: Literal["high", "medium", "low"] = "medium"  # 重要程度

class AskUserQuestionOutput(BaseModel):
    """输出结果"""
    answered: bool                          # 用户是否回答了
    answer: Optional[str] = None            # 用户的回答
    skipped: bool = False                   # 是否被跳过

def execute(input: AskUserQuestionInput) -> AskUserQuestionOutput:
    """
    执行主动追问
    
    工作流程：
    1. 前端渲染问题卡片
    2. 用户回答或跳过
    3. 返回结果给Agent继续分析
    """
    # 实际由前端处理用户交互
    ...

TOOL_METADATA = {
    "name": "ask_user_question",
    "description": "在分析过程中向用户提出问题，获取更多信息",
    "input_schema": AskUserQuestionInput.schema(),
    "output_schema": AskUserQuestionOutput.schema(),
}
```

**主动追问触发条件配置**（在Scenario中定义）：

```yaml
# 主动追问配置
proactive_questions:
  # 何时触发追问
  trigger_conditions:
    - condition: "检测到命盘有重大变动信号"
      question: "你最近是否有重大人生决策要做？比如跳槽、创业、结婚等？"
      question_type: "open"
      importance: "high"
      
    - condition: "分析涉及健康领域且命盘显示相关信号"
      question: "你或家人最近的健康状况如何？"
      question_type: "open"
      importance: "medium"
      
    - condition: "用户问题模糊，需要明确方向"
      question: "你更想了解哪个方面？"
      question_type: "choice"
      choices: ["事业发展", "财运状况", "感情婚姻", "健康状况", "综合分析"]
      importance: "high"

  # 追问规则
  rules:
    max_questions_per_session: 3          # 每次分析最多追问3次
    min_interval_between_questions: 1     # 至少间隔1个分析步骤
    skip_if_user_provided_context: true   # 如果用户已提供相关信息则跳过
```

### 6.4 工具与前端卡片映射机制

每个工具的输出都对应一个前端卡片组件，通过`card_type`建立映射关系。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         工具 ↔ 前端卡片 映射机制                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  工具定义 (Python)                      前端组件注册                         │
│  ─────────────────                     ─────────────────                    │
│                                                                             │
│  TOOL_METADATA = {                     CardRegistry.register(               │
│    "name": "show_bazi_chart",            "bazi_chart",                      │
│    "card_type": "bazi_chart",    →       BaziChartCard                      │
│    "card_props_schema": {...}          )                                    │
│  }                                                                          │
│                                                                             │
│  TOOL_METADATA = {                     CardRegistry.register(               │
│    "name": "ask_user_question",          "question_card",                   │
│    "card_type": "question_card", →       QuestionCard                       │
│    "card_props_schema": {...}          )                                    │
│  }                                                                          │
│                                                                             │
│  同步流程:                                                                   │
│  1. 后端工具定义时，指定 card_type 和 card_props_schema                     │
│  2. 前端维护 CardRegistry，card_type → React Component                      │
│  3. 新增Skill时，同时新增对应的前端卡片组件                                  │
│  4. 工具返回的数据结构必须与 card_props_schema 保持一致                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**工具元数据扩展（含卡片映射）**：

```python
# 工具元数据标准结构

TOOL_METADATA = {
    # 基础信息
    "name": "show_bazi_chart",
    "description": "展示八字命盘图表",
    "type": "display",                    # 工具类型
    
    # 输入输出Schema
    "input_schema": ShowBaziChartInput.schema(),
    "output_schema": ShowBaziChartOutput.schema(),
    
    # 前端卡片映射
    "card_type": "bazi_chart",            # 对应的前端卡片类型
    "card_props_schema": {                # 传给前端的数据结构
        "type": "object",
        "properties": {
            "pillars": {
                "type": "object",
                "description": "四柱数据",
                "properties": {
                    "year": {"type": "object"},
                    "month": {"type": "object"},
                    "day": {"type": "object"},
                    "hour": {"type": "object"}
                }
            },
            "dayun": {
                "type": "array",
                "description": "大运列表"
            },
            "current_dayun_index": {
                "type": "integer",
                "description": "当前大运索引"
            }
        }
    },
    
    # 调用时机
    "when_to_call": "需要展示命盘时，通常在计算完成后"
}
```

**前端卡片注册表**：

```typescript
// frontend/src/cards/CardRegistry.ts

type CardComponent = React.FC<any>;

class CardRegistry {
  private static cards: Map<string, CardComponent> = new Map();
  
  static register(cardType: string, component: CardComponent) {
    this.cards.set(cardType, component);
  }
  
  static get(cardType: string): CardComponent | undefined {
    return this.cards.get(cardType);
  }
  
  static render(cardType: string, props: any): React.ReactNode {
    const Component = this.get(cardType);
    if (!Component) {
      console.warn(`Unknown card type: ${cardType}`);
      return null;
    }
    return <Component {...props} />;
  }
}

// 注册各Skill的卡片
CardRegistry.register("bazi_chart", BaziChartCard);
CardRegistry.register("bazi_report", BaziReportCard);
CardRegistry.register("bazi_insight", BaziInsightCard);
CardRegistry.register("zodiac_chart", ZodiacChartCard);
CardRegistry.register("tarot_spread", TarotSpreadCard);
CardRegistry.register("question_card", QuestionCard);      // 主动追问卡片
CardRegistry.register("collect_form", CollectFormCard);    // 信息收集表单
```

**收集工具的双模式设计**：

```python
# 收集工具支持表单+自然语言双模式

TOOL_METADATA = {
    "name": "collect_bazi_info",
    "description": "收集用户出生信息",
    "type": "collect",
    
    "card_type": "collect_form",
    "card_props_schema": {
        "type": "object",
        "properties": {
            # 结构化表单部分
            "form_fields": {
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                        "name": {"type": "string"},
                        "type": {"enum": ["date", "time", "location", "text", "select"]},
                        "label": {"type": "string"},
                        "required": {"type": "boolean"},
                        "options": {"type": "array"}  # select类型的选项
                    }
                }
            },
            # 自然语言输入部分
            "allow_text_input": {
                "type": "boolean",
                "default": True,
                "description": "是否同时显示自然语言输入框"
            },
            "text_input_placeholder": {
                "type": "string",
                "default": "请描述你当前的困惑或想了解的问题..."
            }
        }
    }
}
```

### 6.5 工具接口规范

```python
# tools/calculate/calculate_chart.py

"""
工具名称: calculate_chart
功能描述: 根据输入信息计算图表数据
"""

from typing import Dict, Any, Optional
from pydantic import BaseModel

class CalculateChartInput(BaseModel):
    """输入参数"""
    user_info: Dict[str, Any]       # 用户信息
    include_extra: bool = True      # 是否包含额外数据
    target_date: Optional[str] = None  # 目标日期

class CalculateChartOutput(BaseModel):
    """输出结果"""
    chart_data: Dict[str, Any]      # 图表数据
    metadata: Dict[str, Any]        # 元数据

def execute(input: CalculateChartInput) -> CalculateChartOutput:
    """
    执行工具
    
    Args:
        input: 输入参数
        
    Returns:
        输出结果
    """
    # 实现逻辑
    ...
    return CalculateChartOutput(
        chart_data={...},
        metadata={...}
    )

# 工具元数据 (供Agent SDK读取)
TOOL_METADATA = {
    "name": "calculate_chart",
    "description": "根据输入信息计算图表数据",
    "input_schema": CalculateChartInput.schema(),
    "output_schema": CalculateChartOutput.schema(),
}
```

### 6.3 通用工具 (跨Skill复用)

```python
# tools/search/search_knowledge.py

"""
通用知识检索工具
从PostgreSQL检索相关知识
"""

from typing import List, Optional, Literal
from pydantic import BaseModel
import asyncpg

class SearchKnowledgeInput(BaseModel):
    query: str                              # 检索查询
    search_type: Literal["rag", "keyword", "hybrid"] = "rag"
    skill_id: str                           # Skill ID
    top_k: int = 5                           # 返回数量
    filter_book: Optional[str] = None       # 限定书籍
    filter_chapter: Optional[str] = None    # 限定章节

class SearchResult(BaseModel):
    chunk_id: str
    text: str
    source: dict
    score: float

class SearchKnowledgeOutput(BaseModel):
    results: List[SearchResult]

async def execute(input: SearchKnowledgeInput) -> SearchKnowledgeOutput:
    """执行知识检索"""
    
    if input.search_type == "rag":
        results = await _rag_search(input)
    elif input.search_type == "keyword":
        results = await _keyword_search(input)
    else:
        results = await _hybrid_search(input)
    
    return SearchKnowledgeOutput(results=results)

async def _rag_search(input: SearchKnowledgeInput) -> List[SearchResult]:
    """RAG向量检索"""
    # 1. 生成查询向量
    # 2. PostgreSQL向量相似度查询
    ...

async def _keyword_search(input: SearchKnowledgeInput) -> List[SearchResult]:
    """关键词倒排检索"""
    # PostgreSQL tsvector查询
    ...

async def _hybrid_search(input: SearchKnowledgeInput) -> List[SearchResult]:
    """混合检索"""
    # 结合RAG和关键词
    ...

TOOL_METADATA = {
    "name": "search_knowledge",
    "description": "从知识库检索相关内容",
    "input_schema": SearchKnowledgeInput.schema(),
    "output_schema": SearchKnowledgeOutput.schema(),
}
```

```python
# tools/search/search_cases.py

"""
通用案例匹配工具
从PostgreSQL匹配相似案例
"""

from typing import List, Optional
from pydantic import BaseModel

class SearchCasesInput(BaseModel):
    skill_id: str
    scenario_ids: Optional[List[str]] = None  # 限定场景
    features: dict                             # 匹配特征
    tags: Optional[List[str]] = None          # 标签
    max_results: int = 3

class CaseResult(BaseModel):
    id: str
    name: str
    source: str
    authority: str
    data: dict
    analysis: dict
    conclusion: dict
    match_score: float

class SearchCasesOutput(BaseModel):
    cases: List[CaseResult]

async def execute(input: SearchCasesInput) -> SearchCasesOutput:
    """执行案例匹配"""
    # PostgreSQL查询
    ...

TOOL_METADATA = {
    "name": "search_cases",
    "description": "从案例库匹配相似案例",
    "input_schema": SearchCasesInput.schema(),
    "output_schema": SearchCasesOutput.schema(),
}
```

---

## 七、PostgreSQL 通用设计

### 7.1 表结构

```sql
-- ═══════════════════════════════════════════════════════════════════
-- 知识块表 (通用，支持所有Skill)
-- ═══════════════════════════════════════════════════════════════════

CREATE TABLE knowledge_chunks (
    id              VARCHAR(50) PRIMARY KEY,    -- CHK_{skill}_{book}_{seq}
    skill_id        VARCHAR(50) NOT NULL,       -- bazi, zodiac, tarot, ...
    
    -- 来源信息
    source_file     VARCHAR(255) NOT NULL,
    book_name       VARCHAR(100) NOT NULL,
    chapter         VARCHAR(100),
    section         VARCHAR(100),
    
    -- 内容
    chunk_text      TEXT NOT NULL,
    chunk_tokens    INTEGER,
    
    -- 元数据
    chunk_type      VARCHAR(20),                -- theory/rule/case/method
    keywords        VARCHAR[],
    
    -- 全文检索
    tsv             TSVECTOR GENERATED ALWAYS AS (
                        to_tsvector('simple', chunk_text)
                    ) STORED,
    
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_chunks_skill ON knowledge_chunks(skill_id);
CREATE INDEX idx_chunks_book ON knowledge_chunks(book_name);
CREATE INDEX idx_chunks_tsv ON knowledge_chunks USING GIN(tsv);
CREATE INDEX idx_chunks_keywords ON knowledge_chunks USING GIN(keywords);

-- ═══════════════════════════════════════════════════════════════════
-- 向量表
-- ═══════════════════════════════════════════════════════════════════

CREATE TABLE knowledge_vectors (
    id              SERIAL PRIMARY KEY,
    chunk_id        VARCHAR(50) REFERENCES knowledge_chunks(id),
    embedding       VECTOR(1536),
    
    created_at      TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_vectors_embedding ON knowledge_vectors 
    USING ivfflat (embedding vector_cosine_ops)
    WITH (lists = 100);

-- ═══════════════════════════════════════════════════════════════════
-- 案例表 (通用结构，支持多场景关联)
-- v1.2 新增: thinking_frameworks_used, reasoning_chain, guidance_patterns
-- ═══════════════════════════════════════════════════════════════════

CREATE TABLE cases (
    id              VARCHAR(50) PRIMARY KEY,
    skill_id        VARCHAR(50) NOT NULL,
    scenario_ids    VARCHAR[] NOT NULL,         -- 关联多个场景

    -- 案例信息
    name            VARCHAR(255) NOT NULL,
    source_book     VARCHAR(100),
    authority       VARCHAR(20) DEFAULT 'medium',

    -- 核心数据 (JSON，结构因Skill而异)
    core_data       JSONB NOT NULL,             -- Skill特定数据

    -- 特征 (用于匹配)
    features        JSONB NOT NULL,             -- Skill特定特征
    tags            VARCHAR[] NOT NULL,

    -- ══════════════ v1.2 新增字段 ══════════════

    -- 思维架构标注 (用于 Scenario-Case 匹配)
    thinking_frameworks_used VARCHAR[],          -- ["客体思维架构", "时运思维架构"]

    -- 推理链条 (专家的思维过程)
    reasoning_chain JSONB,                       -- [{step, framework, observation, analysis, conclusion}]

    -- 指导模式 (可复用的建议)
    guidance_patterns JSONB,                     -- [{pattern_name, condition, advice, source}]

    -- ══════════════════════════════════════════

    -- 分析内容 (保留兼容)
    analysis        JSONB NOT NULL,
    conclusion      JSONB NOT NULL,

    -- 全文检索
    tsv             TSVECTOR,

    created_at      TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_cases_skill ON cases(skill_id);
CREATE INDEX idx_cases_scenarios ON cases USING GIN(scenario_ids);
CREATE INDEX idx_cases_tags ON cases USING GIN(tags);
CREATE INDEX idx_cases_features ON cases USING GIN(features);
CREATE INDEX idx_cases_tsv ON cases USING GIN(tsv);
-- v1.2 新增索引
CREATE INDEX idx_cases_frameworks ON cases USING GIN(thinking_frameworks_used);

-- ═══════════════════════════════════════════════════════════════════
-- 场景路由索引表
-- ═══════════════════════════════════════════════════════════════════

CREATE TABLE scenario_index (
    id              SERIAL PRIMARY KEY,
    skill_id        VARCHAR(50) NOT NULL,
    scenario_id     VARCHAR(50) NOT NULL,
    
    trigger_word    VARCHAR(100) NOT NULL,
    trigger_type    VARCHAR(20) NOT NULL,       -- primary/secondary
    weight          FLOAT DEFAULT 1.0,
    
    tsv             TSVECTOR GENERATED ALWAYS AS (
                        to_tsvector('simple', trigger_word)
                    ) STORED,
    
    UNIQUE(skill_id, scenario_id, trigger_word)
);

CREATE INDEX idx_scenario_skill ON scenario_index(skill_id);
CREATE INDEX idx_scenario_tsv ON scenario_index USING GIN(tsv);

-- ═══════════════════════════════════════════════════════════════════
-- Scenario候选表 (构建流水线产出)
-- ═══════════════════════════════════════════════════════════════════

CREATE TABLE scenario_candidates (
    id              SERIAL PRIMARY KEY,
    skill_id        VARCHAR(50) NOT NULL,
    scenario_id     VARCHAR(50) NOT NULL,
    
    source_chunks   VARCHAR[],
    generated_at    TIMESTAMP DEFAULT NOW(),
    
    content         TEXT NOT NULL,
    
    status          VARCHAR(20) DEFAULT 'pending',
    reviewer        VARCHAR(50),
    review_notes    TEXT,
    reviewed_at     TIMESTAMP,
    
    published_file  VARCHAR(255)
);

CREATE INDEX idx_candidates_skill ON scenario_candidates(skill_id);
CREATE INDEX idx_candidates_status ON scenario_candidates(status);

-- ═══════════════════════════════════════════════════════════════════
-- Skill元数据表
-- ═══════════════════════════════════════════════════════════════════

CREATE TABLE skill_metadata (
    skill_id        VARCHAR(50) PRIMARY KEY,
    name            VARCHAR(100) NOT NULL,
    version         VARCHAR(20) NOT NULL,
    description     TEXT,
    
    -- 统计信息
    chunk_count     INTEGER DEFAULT 0,
    case_count      INTEGER DEFAULT 0,
    scenario_count  INTEGER DEFAULT 0,
    
    -- 配置
    config          JSONB,                      -- Skill特定配置
    
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);
```

### 7.2 Skill特定数据示例

```sql
-- Bazi案例的core_data和features
INSERT INTO cases (id, skill_id, scenario_ids, name, core_data, features, tags, ...)
VALUES (
    'CASE_BAZI_001',
    'bazi',
    ARRAY['career', 'yearly_report'],
    '甲木身旺食神泄秀',
    '{"year": "甲寅", "month": "丙寅", "day": "甲子", "hour": "甲戌", "gender": "male"}'::jsonb,
    '{"daymaster": "甲木", "strength": "身强", "pattern": "食神泄秀", "key_gods": ["食神", "比肩"]}'::jsonb,
    ARRAY['身旺', '食神泄秀', '甲木', '高官'],
    ...
);

-- Zodiac案例的core_data和features
INSERT INTO cases (id, skill_id, scenario_ids, name, core_data, features, tags, ...)
VALUES (
    'CASE_ZODIAC_001',
    'zodiac',
    ARRAY['career', 'yearly_report'],
    '金星落天蝎事业转型',
    '{"sun": "Leo", "moon": "Cancer", "ascendant": "Scorpio", "venus": "Scorpio", ...}'::jsonb,
    '{"sun_sign": "Leo", "moon_sign": "Cancer", "dominant_element": "Water", "key_aspects": ["Venus square Mars"]}'::jsonb,
    ARRAY['事业', '转型', '金星天蝎'],
    ...
);

-- Tarot案例的core_data和features
INSERT INTO cases (id, skill_id, scenario_ids, name, core_data, features, tags, ...)
VALUES (
    'CASE_TAROT_001',
    'tarot',
    ARRAY['relationship'],
    '恋人逆位感情困境',
    '{"spread": "Celtic Cross", "cards": [{"position": 1, "card": "The Lovers", "reversed": true}, ...]}'::jsonb,
    '{"main_card": "The Lovers", "reversed": true, "spread_type": "Celtic Cross", "theme": "relationship"}'::jsonb,
    ARRAY['感情', '恋人牌', '逆位'],
    ...
);
```

---

## 八、知识构建流水线 (通用)

### 8.1 流水线架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    通用知识构建流水线                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入: /data/vibelife/{skill_id}/source/*                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 0: 格式转换                                                    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 输入格式:                                                           │   │
│  │ • PDF → Markdown (OCR + 结构识别)                                   │   │
│  │ • EPUB → Markdown                                                   │   │
│  │ • 视频字幕 (SRT/VTT) → Markdown                                     │   │
│  │ • DOCX → Markdown                                                   │   │
│  │ • HTML → Markdown                                                   │   │
│  │                                                                     │   │
│  │ 输出: /data/vibelife/{skill_id}/converted/*.md                     │   │
│  │                                                                     │   │
│  │ 要求:                                                               │   │
│  │ • 保留完整章节结构                                                  │   │
│  │ • 人工审核清理                                                      │   │
│  │ • 标注书名、作者、章节                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 1: 解析与切块                                                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 切块策略 (大块优先):                                                │   │
│  │ • 优先按章节切分，保持完整性                                        │   │
│  │ • 单块上限: 2000 tokens                                             │   │
│  │ • 超长章节: 按段落边界切分，50 token重叠                            │   │
│  │                                                                     │   │
│  │ 元数据提取:                                                         │   │
│  │ • 书名、章节、小节                                                  │   │
│  │ • 内容类型 (theory/rule/case/method)                                │   │
│  │ • 关键词自动提取 (LLM辅助)                                          │   │
│  │                                                                     │   │
│  │ 输出: chunks[] with metadata                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 2: 向量化                                                      │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ • 调用 Embedding API                                                │   │
│  │ • 生成向量 (1024维)                                                 │   │
│  │ • 批量处理，控制并发                                                │   │
│  │                                                                     │   │
│  │ 输出: vectors[]                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 3: 入库                                                        │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ • 写入 knowledge_chunks 表                                          │   │
│  │ • 写入 knowledge_vectors 表                                         │   │
│  │ • 自动生成 tsvector 倒排索引                                        │   │
│  │ • 更新 skill_metadata 统计                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 4: 内容提取                                                    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 4a. 案例提取                                                        │   │
│  │ • LLM识别文本中的案例                                               │   │
│  │ • 提取Skill特定的core_data和features                                │   │
│  │ • 自动标注scenario_ids (可对应多个场景)                             │   │
│  │ • 写入cases表                                                       │   │
│  │                                                                     │   │
│  │ 4b. Scenario候选生成                                                │   │
│  │ • 分析内容，识别可服务的场景                                        │   │
│  │ • LLM生成scenario候选内容                                           │   │
│  │ • 写入scenario_candidates表 (status: pending)                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 5: 人工评估与发布                                              │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 评估维度:                                                           │   │
│  │ • SOP完整性和合理性                                                 │   │
│  │ • 知识检索配置                                                      │   │
│  │ • 输出模板质量                                                      │   │
│  │ • 与现有scenarios的差异/互补                                        │   │
│  │                                                                     │   │
│  │ 评估结果:                                                           │   │
│  │ • approved → 导出到 /skills/{skill_id}/scenarios/*.md               │   │
│  │ • rejected → 标注原因，归档                                         │   │
│  │ • 需修改 → 人工调整后重新评估                                       │   │
│  │                                                                     │   │
│  │ 同时更新:                                                           │   │
│  │ • scenario_index表                                                  │   │
│  │ • SKILL.md场景目录                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Stage 6: 质量检查                                                    │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ • 知识覆盖率检查                                                    │   │
│  │ • 案例分布检查                                                      │   │
│  │ • 场景完整性检查                                                    │   │
│  │ • 生成构建报告                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 切块配置

```yaml
# chunking_config.yaml

default:
  max_tokens: 2000
  min_tokens: 200
  overlap_tokens: 50
  prefer_complete_sections: true

skill_specific:
  bazi:
    # 八字书籍章节通常较短，可以更大
    max_tokens: 2500
    
  zodiac:
    # 占星书籍图表较多
    max_tokens: 1500
    special_handling:
      tables: keep_complete
      
  tarot:
    # 塔罗每张牌解读相对独立
    max_tokens: 1000
    split_by: card_boundary
```

### 8.3 案例场景映射配置

```yaml
# case_scenario_mapping.yaml

# 通用映射规则
common:
  allow_multiple: true
  default_scenario: basic_reading

# Skill特定映射
bazi:
  rules:
    - tags: [事业, 升职, 跳槽, 官杀]
      scenarios: [career]
    - tags: [财运, 发财, 财星]
      scenarios: [wealth]
    - tags: [感情, 婚姻, 桃花]
      scenarios: [relationship]
    # ...

zodiac:
  rules:
    - tags: [career, job, work]
      scenarios: [career]
    - tags: [love, relationship, romance]
      scenarios: [relationship]
    - tags: [money, finance, wealth]
      scenarios: [wealth]
    # ...

tarot:
  rules:
    - tags: [love, relationship]
      scenarios: [relationship_reading]
    - tags: [career, work]
      scenarios: [career_reading]
    - tags: [general, daily]
      scenarios: [daily_reading]
    # ...
```

---

## 九、Runtime 执行流程

### 9.1 通用执行流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        通用 Runtime 执行流程                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 入口 A: 用户点击服务卡片                                            │   │
│  │ → 前端直接传递 skill + scenario，跳过路由，进入 Step 2              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 入口 B: 用户自然语言提问                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║ Step 1: LLM 路由 (use_skill 工具一次决定 skill + scenario)            ║ │
│  ╠═══════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                       ║ │
│  ║ LLM 调用 use_skill 工具:                                              ║ │
│  ║ {                                                                     ║ │
│  ║   "skill": "bazi",                                                    ║ │
│  ║   "scenario": "career",                                               ║ │
│  ║   "confidence": "high" | "medium" | "low"                             ║ │
│  ║ }                                                                     ║ │
│  ║                                                                       ║ │
│  ║ 场景目录嵌入工具描述，LLM 语义理解后选择最合适的场景                  ║ │
│  ║                                                                       ║ │
│  ║ if confidence == "low":                                               ║ │
│  ║   → 调用 ask_user_question 让用户选择                                 ║ │
│  ║   → 或展示服务目录卡片                                                ║ │
│  ║                                                                       ║ │
│  ╚═══════════════════════════════════════════════════════════════════════╝ │
│      │                                                                      │
│      ▼                                                                      │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║ Step 2: 加载 Skill + Scenario 配置                                    ║ │
│  ╠═══════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                       ║ │
│  ║ 加载: /skills/{skill_id}/SKILL.md                                     ║ │
│  ║ 获取: 专家身份、伦理边界、工具列表                                    ║ │
│  ║                                                                       ║ │
│  ║ 加载: /skills/{skill_id}/scenarios/{scenario_id}.md                   ║ │
│  ║ 获取: SOP、知识检索配置、工具配置、输出模板                           ║ │
│  ╚═══════════════════════════════════════════════════════════════════════╝ │
│      │                                                                      │
│      ▼                                                                      │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║ Step 3: 执行SOP (LLM 动态调用全局工具)                                 ║ │
│  ╠═══════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                       ║ │
│  ║ LLM 根据 SOP 描述自己判断何时需要调用工具:                            ║ │
│  ║                                                                       ║ │
│  ║ • 数据库查询: search_db(table, query, filters)                        ║ │
│  ║   - table="knowledge_chunks" → 知识检索                               ║ │
│  ║   - table="cases" → 案例匹配                                          ║ │
│  ║ • 计算类: calculate_bazi, calculate_dayun, ...                        ║ │
│  ║ • 展示类: show_bazi_chart, show_insight, ...                          ║ │
│  ║ • 交互类: ask_user_question, collect_birth_info, ...                  ║ │
│  ║                                                                       ║ │
│  ╚═══════════════════════════════════════════════════════════════════════╝ │
│      │                                                                      │
│      ▼                                                                      │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║ Step 4: 输出交付                                                       ║ │
│  ╠═══════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                       ║ │
│  ║ • 调用展示工具渲染结果                                                ║ │
│  ║ • 生成报告（如需要）                                                  ║ │
│  ║ • 等待用户追问或结束                                                  ║ │
│  ╚═══════════════════════════════════════════════════════════════════════╝ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 9.2 Context组装

```yaml
# 通用Context组装规则

context_assembly:
  fixed:
    - system_prompt
    - SKILL.md#专家身份
    - SKILL.md#伦理边界
    - user_context
    
  dynamic:
    - scenario.md#SOP
    - knowledge_results      # PostgreSQL检索
    - matched_cases          # PostgreSQL匹配
    
  budget:
    total: 8000
    fixed: 2000
    sop: 1500
    knowledge: 2500
    cases: 1500
    buffer: 500
    
  priority:
    1: system_prompt
    2: expert_identity
    3: sop
    4: user_context
    5: cases
    6: knowledge
    7: ethics
```

---

## 十、新Skill构建检查清单

### 10.1 准备阶段

```
□ 确定Skill ID和名称
□ 收集源文件到 /data/vibelife/{skill_id}/source/
□ 格式转换到 /data/vibelife/{skill_id}/converted/
□ 定义Skill特定的:
  □ core_data结构 (案例核心数据)
  □ features结构 (匹配特征)
  □ 场景列表 (entry/standard/professional)
```

### 10.2 构建阶段

```
□ 运行知识构建流水线
  □ Stage 1: 切块 (检查切块质量)
  □ Stage 2: 向量化
  □ Stage 3: 入库
  □ Stage 4: 案例提取 (检查案例质量)
  □ Stage 4: Scenario候选生成
□ 人工评估Scenario候选
  □ 审核SOP
  □ 审核知识检索配置
  □ 审核输出模板
□ 发布approved scenarios
```

### 10.3 Skill目录

```
□ 创建 /skills/{skill_id}/
□ 编写 SKILL.md
  □ 专家身份
  □ 场景目录
  □ 服务级别
  □ 伦理边界
  □ 工具列表
□ 创建 scenarios/ 目录
  □ 所有approved场景文件
□ 创建 tools/ 目录
  □ 收集类工具
  □ 计算类工具
  □ 展示类工具
  □ 报告类工具
```

### 10.4 数据库

```
□ knowledge_chunks 有数据
□ knowledge_vectors 有数据
□ cases 有数据
□ scenario_index 有数据
□ skill_metadata 已更新
```

### 10.5 测试

```
□ 场景路由测试
□ 知识检索测试
□ 案例匹配测试
□ 工具调用测试
□ 端到端测试
□ 边界情况测试
```

---

## 十一、附录：Skill配置示例

### A. Bazi (八字命理)

```yaml
skill_id: bazi
name: 八字命理

core_data_schema:
  year: string      # 年柱
  month: string     # 月柱
  day: string       # 日柱
  hour: string      # 时柱
  gender: string    # 性别

features_schema:
  daymaster: string
  strength: string
  pattern: string
  key_gods: array
  
scenarios:
  entry: [basic_reading, personality_brief, yearly_overview, quick_query]
  standard: [yearly_report, career, wealth, relationship, monthly, dayun]
  professional: [life_blueprint, compatibility, timing_selection, ...]
```

### B. Zodiac (西方占星)

```yaml
skill_id: zodiac
name: 西方占星

core_data_schema:
  sun: string       # 太阳星座
  moon: string      # 月亮星座
  ascendant: string # 上升星座
  planets: object   # 行星位置
  houses: object    # 宫位
  aspects: array    # 相位

features_schema:
  sun_sign: string
  moon_sign: string
  ascendant_sign: string
  dominant_element: string
  key_aspects: array
  
scenarios:
  entry: [basic_chart, sun_sign_reading, daily_horoscope]
  standard: [natal_report, transit_report, solar_return]
  professional: [relationship_synastry, career_guidance, life_purpose]
```

### C. Tarot (塔罗)

```yaml
skill_id: tarot
name: 塔罗占卜

core_data_schema:
  spread: string        # 牌阵类型
  question: string      # 问题
  cards: array          # 抽到的牌
    - position: int
      card: string
      reversed: bool

features_schema:
  main_card: string
  reversed: bool
  spread_type: string
  theme: string
  
scenarios:
  entry: [single_card, three_card, daily_guidance]
  standard: [celtic_cross, relationship_spread, career_spread]
  professional: [year_ahead, deep_dive, spiritual_guidance]
```

### D. Career (职业规划)

```yaml
skill_id: career
name: 职业规划

core_data_schema:
  background: object    # 教育/工作背景
  skills: array         # 技能列表
  interests: array      # 兴趣
  values: array         # 价值观
  goals: object         # 职业目标

features_schema:
  experience_level: string
  industry: string
  career_stage: string
  key_strengths: array
  
scenarios:
  entry: [career_overview, skill_assessment, quick_advice]
  standard: [career_path, resume_review, interview_prep]
  professional: [career_transition, executive_coaching, leadership_development]
```

---

*文档版本: 1.2 Generic*
*最后更新: 2026-01-14*
*适用范围: 所有VibeLife知识类Skill*
*本次更新: 新增服务发现机制(show_skill_services, recommend_service)*

---

## 十二、服务发现机制

### 12.1 设计目标

解决用户"不知道能问什么"的痛点，让用户清楚知道 Skill 的服务边界和能力。

### 12.2 两种触发场景

```
场景A: 用户主动选择 Skill（如点击"八字命理"入口）
┌─────────────────────────────────────────────────────────────┐
│  → Agent 调用 show_skill_services 工具                       │
│  → 展示服务目录欢迎卡片                                       │
│  → 用户点击服务项（直接开始）或 自然语言描述需求               │
└─────────────────────────────────────────────────────────────┘

场景B: 用户自然提问，系统路由（如"帮我看看命盘"）
┌─────────────────────────────────────────────────────────────┐
│  → Agent 直接路由到对应场景                                   │
│  → 不展示服务目录，直接开始服务                               │
│  → 服务过程中可能触发智能推荐                                  │
└─────────────────────────────────────────────────────────────┘
```

### 12.3 工具定义

#### show_skill_services

```python
{
    "name": "show_skill_services",
    "description": "展示当前 Skill 的服务目录",
    "card_type": "skill_services",
    "when_to_call": [
        "用户主动选择进入某个 Skill 时",
        "用户询问'你能做什么'、'有什么服务'时",
        "用户表现出不知道如何开始时"
    ],
    "when_not_to_call": [
        "用户已经有明确需求时",
        "对话已经在进行中时"
    ]
}
```

#### recommend_service

```python
{
    "name": "recommend_service",
    "description": "根据对话上下文，向用户推荐相关的升级服务",
    "card_type": "service_recommendation",
    "when_to_call": [
        "完成一个 entry 级别服务后",
        "用户表现出对某个话题的持续关注",
        "用户的问题超出当前服务范围"
    ],
    "principles": [
        "一次只推荐一个最相关的服务",
        "推荐要自然，不能太商业化",
        "用户可以选择忽略"
    ]
}
```

### 12.4 SKILL.md 场景目录扩展

在场景目录表格中增加展示相关字段：

```markdown
### Entry（入门级）

| 场景 | 文件 | 触发词 | 计费 | 展示名称 | 图标 | 简介 |
|-----|------|-------|------|---------|------|------|
| 基础解读 | basic_reading.md | 看命盘、算命 | 免费 | 基础命盘 | 📋 | 快速了解你的八字命盘 |

### Standard（标准级）

| 场景 | 文件 | 触发词 | 计费 | 展示名称 | 图标 | 简介 | 价值点 |
|-----|------|-------|------|---------|------|------|--------|
| 事业分析 | career.md | 事业、工作 | 基础 | 事业运势 | 💼 | 深度分析事业发展 | 时机建议,行业方向,贵人方位 |
```

### 12.5 前端卡片

| 卡片类型 | 组件 | 用途 |
|---------|------|------|
| skill_services | SkillServicesCard | 展示服务目录，支持点击触发 |
| service_recommendation | ServiceRecommendationCard | 智能推荐升级服务 |

### 12.6 数据流

```
SKILL.md 场景目录表格
        │
        ▼
SkillLoader.get_skill_services()  ← 解析 Markdown 表格
        │
        ▼
show_skill_services 工具返回
        │
        ▼
前端 SkillServicesCard 渲染
        │
        ▼
用户点击服务项
        │
        ▼
发送消息触发对应场景（直接开始，无需确认）
```