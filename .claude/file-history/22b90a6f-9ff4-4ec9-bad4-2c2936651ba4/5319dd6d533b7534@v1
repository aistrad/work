# 统一抽取 Prompt 模板 v1.0

> **核心特点**：单次 LLM 调用同时提取 Case 和 Scenario，直接从 MD 文件读取。
> **设计理念**：从"结论导向"转向"推理导向"，提取专家的思维过程。

## 使用场景

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  /data/vibelife/knowledge/{skill}/converted/*.md                            │
│                       │                                                     │
│                       ▼                                                     │
│               unified_extractor.py                                          │
│                       │                                                     │
│         ┌─────────────┴─────────────┐                                       │
│         ▼                           ▼                                       │
│   Cases → cases 表            Scenarios → .md 文件                          │
│   (status='pending')          (extracted/scenarios/)                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Prompt 模板

```
你是一个专业的知识抽取专家。请从以下文本中同时识别：
1. **案例 (Case)**：具体的分析实例，包含完整的推理过程
2. **场景 (Scenario)**：可服务用户的服务流程定义

---

## Skill 类型
{skill_id}

## 该 Skill 的思维架构体系

{thinking_frameworks}

## 源文件信息
- 文件: {source_file}
- 章节: {source_section}

## 案例数据结构

### core_data (核心数据)
{core_data_schema}

### features (特征数据)
{features_schema}

---

## 待分析文本

{text}

---

## 提取要求

### A. 案例 (Case) 提取

#### 1. 基础信息
- name: 案例名称/标题
- core_data: 核心数据 (按上述结构)
- features: 特征数据 (按上述结构)

#### 2. 推理链条 (reasoning_chain) - 关键
从文本中识别专家的推理过程，每个步骤包含：
| 字段 | 说明 |
|------|------|
| step | 步骤序号 (1, 2, 3...) |
| framework | 使用的思维架构名称 |
| observation | 专家观察到的特征/现象 |
| analysis | 专家的分析推理过程 |
| conclusion | 该步骤得出的结论 |

#### 3. 指导模式 (guidance_patterns) - 关键
从文本中提取可复用的指导建议：
| 字段 | 说明 |
|------|------|
| pattern_name | 模式名称 |
| condition | 适用条件 |
| advice | 具体建议 |
| source | 来源依据 |

#### 4. 思维架构标注
- thinking_frameworks_used: 使用的架构列表

#### 5. 其他字段
- tags: 标签数组
- scenario_ids: 适用场景ID数组

---

### B. 场景 (Scenario) 提取

从文本中识别可以提供给用户的服务流程定义：

#### 1. 基础信息
| 字段 | 说明 |
|------|------|
| scenario_id | 英文ID，snake_case 格式 (如: career_analysis) |
| name | 中文名称 (如: 事业运势分析) |
| level | 服务级别: entry / standard / professional |
| billing | 计费类型: free / basic / premium |
| description | 服务描述 (一句话) |

#### 2. 触发条件
| 字段 | 说明 |
|------|------|
| primary_triggers | 主要触发词数组 (高权重) |
| secondary_triggers | 次要触发词数组 (低权重) |

#### 3. SOP 阶段定义
每个阶段包含：
| 字段 | 说明 |
|------|------|
| phase | 阶段序号 (1, 2, 3...) |
| name | 阶段名称 (如: 信息收集, 深度分析) |
| type | 阶段类型: required / optional / reactive |
| description | 阶段描述 |
| tools | 使用的工具数组 (如: ["collect_birth_info", "calculate_bazi"]) |
| knowledge_queries | 知识库查询关键词 (如: ["事业运势分析方法"]) |

---

## 输出格式

以 JSON 格式输出，完整结构如下：

{
  "cases": [
    {
      "name": "案例名称",
      "core_data": {...},
      "features": {...},
      "thinking_frameworks_used": ["架构1", "架构2"],
      "reasoning_chain": [
        {
          "step": 1,
          "framework": "思维架构名称",
          "observation": "观察到的特征",
          "analysis": "分析推理过程",
          "conclusion": "该步骤结论"
        }
      ],
      "guidance_patterns": [
        {
          "pattern_name": "模式名称",
          "condition": "适用条件",
          "advice": "具体建议",
          "source": "来源依据"
        }
      ],
      "tags": ["标签1", "标签2"],
      "scenario_ids": ["scenario1", "scenario2"]
    }
  ],
  "scenarios": [
    {
      "scenario_id": "英文ID",
      "name": "中文名称",
      "level": "entry|standard|professional",
      "billing": "free|basic|premium",
      "description": "服务描述",
      "primary_triggers": ["触发词1", "触发词2"],
      "secondary_triggers": ["次要触发词1"],
      "sop_phases": [
        {
          "phase": 1,
          "name": "信息收集",
          "type": "required",
          "description": "收集用户基本信息",
          "tools": ["collect_birth_info"],
          "knowledge_queries": []
        },
        {
          "phase": 2,
          "name": "深度分析",
          "type": "required",
          "description": "进行专业分析",
          "tools": ["calculate_bazi"],
          "knowledge_queries": ["相关理论"]
        }
      ]
    }
  ],
  "extraction_notes": "抽取备注（可选，说明抽取过程中的特殊情况）"
}

**重要**：
- 如果文本不包含案例，cases 数组返回空 `[]`
- 如果文本不包含场景定义，scenarios 数组返回空 `[]`
- 请直接输出 JSON，不要添加其他说明文字
```

---

## Skill 特定配置

### Bazi (八字)

**思维架构体系**:
```
主体思维架构：身强/身弱判定
客体思维架构：十神分析
五行思维架构：五行分布特征
柱位思维架构：四柱位置含义
冲合思维架构：冲合关系解读
时运思维架构：大运流年分析
正偏思维架构：正偏十神转换
```

**core_data**:
```json
{
  "year": "年柱 (如: 甲子)",
  "month": "月柱",
  "day": "日柱",
  "hour": "时柱",
  "gender": "性别 (男/女)"
}
```

**features**:
```json
{
  "daymaster": "日主 (如: 甲木)",
  "strength": "身强/身弱",
  "pattern": "格局 (如: 正官格)",
  "key_gods": ["关键十神数组"]
}
```

### Zodiac (占星)

**思维架构体系**:
```
元素思维架构：火/土/风/水元素分析
模式思维架构：基本/固定/变动模式分析
相位思维架构：行星相位解读
宫位思维架构：十二宫位分析
行运思维架构：行运推进分析
```

**core_data**:
```json
{
  "sun_sign": "太阳星座",
  "moon_sign": "月亮星座",
  "rising_sign": "上升星座",
  "birth_chart": "星盘配置摘要"
}
```

**features**:
```json
{
  "dominant_element": "主导元素",
  "dominant_modality": "主导模式",
  "key_aspects": ["关键相位"],
  "stellium": "星群 (如有)"
}
```

### Tarot (塔罗)

**思维架构体系**:
```
大小牌思维架构：大牌vs小牌分析
花色思维架构：权杖/圣杯/宝剑/钱币
数字思维架构：牌号数字含义
叙事思维架构：牌阵故事整合
元素尊严架构：元素强弱分析
```

**core_data**:
```json
{
  "spread_type": "牌阵类型",
  "cards": ["抽到的牌数组"],
  "question": "问题类型"
}
```

**features**:
```json
{
  "major_count": "大牌数量",
  "dominant_suit": "主导花色",
  "reversed_count": "逆位数量",
  "key_cards": ["关键牌"]
}
```

### Career (职业)

**思维架构体系**:
```
职业锚思维架构：核心职业动机分析
霍兰德思维架构：职业兴趣类型分析
MBTI思维架构：性格类型分析
技能矩阵架构：技能组合分析
发展阶段架构：职业周期分析
```

**core_data**:
```json
{
  "background": "职业背景",
  "current_role": "当前职位",
  "challenge": "面临挑战"
}
```

**features**:
```json
{
  "industry": "行业",
  "career_stage": "职业阶段",
  "key_skills": ["核心技能"],
  "goals": "职业目标"
}
```

---

## 抽取质量标准

| 维度 | 标准 | 权重 |
|------|------|------|
| 推理链条完整性 | 至少 2-3 步完整的推理过程 | 30% |
| 思维架构标注 | 至少标注 1 个使用的架构 | 20% |
| 指导模式提取 | 至少提取 1 个可复用的指导建议 | 25% |
| 来源追溯 | 指导模式必须标注来源 | 15% |
| Scenario SOP 完整性 | 至少定义 2 个阶段 | 10% |

---

## 调用示例 (Python)

```python
from services.model_router import ModelRouter

async def extract_from_md_file(file_path: Path, skill_id: str):
    """从 MD 文件提取 Cases 和 Scenarios"""

    # 加载 Skill 配置
    skill_config = load_skill_config(skill_id)

    # 读取文件内容
    content = file_path.read_text()

    # 构建 Prompt
    prompt = UNIFIED_EXTRACTION_PROMPT.format(
        skill_id=skill_id,
        thinking_frameworks=skill_config["thinking_frameworks"],
        core_data_schema=skill_config["core_data_schema"],
        features_schema=skill_config["features_schema"],
        source_file=file_path.name,
        source_section="全文",
        text=content
    )

    # 调用 LLM
    router = ModelRouter()
    response = await router.chat(
        messages=[{"role": "user", "content": prompt}],
        capability="analysis"
    )

    # 解析 JSON
    result = parse_json(response)

    return {
        "cases": result.get("cases", []),
        "scenarios": result.get("scenarios", [])
    }
```

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-01-14 | 初始版本，合并 Case 和 Scenario 抽取 |
