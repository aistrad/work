# 优化计划：VibeLife Expert System v6 文档升级

## 背景

基于《东方代码启示录》的深度分析，发现当前系统存在以下核心问题：

### 问题 1：案例提取只提取"结论"而非"推理链条"

**当前状态**：
```json
{
  "features": {
    "daymaster": "甲木",
    "strength": "身强",
    "pattern": "正官格",  // ← 这是结论
    "key_gods": ["正官", "正印"]
  }
}
```

**专家实际做的**：
```json
{
  "reasoning_chain": [
    {
      "step": 1,
      "framework": "天干组合思维架构",
      "observation": "柱中透出天干的劫财辛金就是偏类十神",
      "key_element": "劫财辛金"
    },
    {
      "step": 2,
      "framework": "正偏转换思维架构",
      "observation": "劫财辛金正好被正官丁火给克弱了",
      "analysis": "劫弱的定性，导致它释放出的并非是劫财的本性，而是反向信号",
      "conclusion": "劫财弱→反衬比肩强→人脉扶助机缘"
    }
  ]
}
```

### 问题 2：Scenario-Case 关系基于"场景标签"而非"思维架构"

**当前**：Case 通过 `scenario_ids: ["career", "basic_reading"]` 标签关联场景

**应该**：Case 通过 `thinking_frameworks_used: ["客体思维架构", "时运思维架构"]` 关联场景
- 每个 Scenario 定义它使用哪些思维架构
- 匹配逻辑：`Case.thinking_frameworks_used ∩ Scenario.required_frameworks`

### 问题 3：缺乏"指导模式"（趋吉避凶方法）

《东方代码启示录》强调：
> "八字学的实用性，不在于预见人生，而在于指导更理想的人生。"

当前系统缺少 `guidance_patterns` 字段来记录可复用的指导模式。

---

## 技术调研结果

### 案例匹配现状 (repository.py + SQL)

| 功能 | 当前状态 | 问题 |
|------|---------|------|
| scenario_id 匹配 | ✅ 已实现 | 精确匹配，0或2分 |
| tags 匹配 | ✅ 已实现 | 只计数交集，无权重 |
| features 匹配 | ❌ **未使用** | SQL 接收参数但完全忽略 |
| 向量相似度 | ❌ **未使用** | embedding 列存在但 match_cases 未调用 |

**关键发现**：`match_cases` SQL 函数（第210-243行）接收 `p_features JSONB` 但完全不使用。

### SOP 执行现状 (core.py + scenarios/)

| 功能 | 当前状态 | 问题 |
|------|---------|------|
| 7阶段 SOP | ✅ 已实现 | P1-P2强制，P3-P7自由 |
| 分析框架 | ⚠️ 隐式存在 | 每个 Scenario 中有表格，但非结构化 |
| 思维架构 | ❌ **未实现** | 没有显式概念 |
| 框架复用 | ❌ **未实现** | 每个 Scenario 重新定义 |

**关键发现**：现有 Scenario 文件已有"分析框架"概念（如 career.md 的4维分析），但以 Markdown 表格存储，难以机器解析。

---

## 优化方案

### 第一阶段：文档升级（本次任务）

#### 1. 更新 `VibeLife-Expert-System-v6.md`

新增以下章节：

**A. 思维架构体系（新增第十三节）**
```
┌─────────────────────────────────────────────────────────────┐
│                   思维架构层级体系                            │
├─────────────────────────────────────────────────────────────┤
│  L1: 基础架构 (7种)                                          │
│  ├─ 主体思维架构（身强弱判定）                               │
│  ├─ 客体思维架构（十神分析）                                 │
│  ├─ 五行思维架构（五行分布）                                 │
│  ├─ 柱位思维架构（四柱位置含义）                             │
│  ├─ 冲合思维架构（冲合关系）                                 │
│  ├─ 时运思维架构（大运流年）                                 │
│  └─ 正偏思维架构（正偏转换）                                 │
│                                                             │
│  L2: 场景架构（由L1组合）                                    │
│  ├─ career = 客体 + 时运 + 柱位                             │
│  ├─ relationship = 客体 + 正偏 + 柱位                       │
│  └─ ...                                                     │
└─────────────────────────────────────────────────────────────┘
```

**B. 推理链条规范（新增到第七节 Cases 设计）**
- reasoning_chain 字段定义
- 推理步骤标准结构

**C. 指导模式规范（新增）**
- guidance_patterns 字段定义
- 趋吉避凶方法论

#### 2. 更新 `CASE_EXTRACTION_PROMPT.md`

**A. 新增推理链条提取**
```
## 推理链条提取要点（专家级）

1. **十神配置识别**：此命有哪些关键十神？
2. **强弱状态判定**：各十神的强弱状态如何？（翘翘板关系）
3. **正偏转换分析**：哪些十神发生了正偏转换？
4. **人生际遇对应**：这些特征如何体现在实际际遇中？
```

**B. 新增指导模式提取**
```
## 指导模式提取

1. **趋吉避凶方法**：可以通过什么行为来宣泄负面能量？
2. **行业工种建议**：适合什么行业可以迎合十神特征？
3. **时机选择建议**：什么时运阶段适合什么行动？
```

**C. 扩展 Bazi Schema**
```python
"bazi": {
    "core_data": {...},  # 保持不变
    "features": {...},   # 保持不变
    "reasoning_chain": [  # 新增
        {
            "step": "int",
            "framework": "思维架构名称",
            "observation": "观察内容",
            "analysis": "分析过程",
            "conclusion": "推理结论"
        }
    ],
    "guidance_patterns": [  # 新增
        {
            "pattern_name": "模式名称",
            "condition": "适用条件",
            "advice": "建议行动"
        }
    ],
    "thinking_frameworks_used": ["使用的思维架构列表"]  # 新增
}
```

#### 3. 更新 `SKILL_SCHEMAS.md`

- 新增 reasoning_chain Schema
- 新增 guidance_patterns Schema
- 新增 thinking_frameworks_used 字段

#### 4. 更新 `vibelife-skill/SKILL.md`

- 新增思维架构体系说明
- 更新 Stage 4a 案例提取流程
- 新增推理链条和指导模式的质量标准

### 第二阶段：代码实现（后续任务）

| 任务 | 优先级 | 文件 |
|------|--------|------|
| 扩展 cases 表 | P0 | `001_expert_system_v6.sql` |
| 实现 features 匹配 | P0 | `match_cases` SQL 函数 |
| 扩展 Case dataclass | P1 | `repository.py` |
| 显式化分析框架 | P2 | `scenarios/*.md` |

---

## 待确认问题

1. **思维架构优先级**：25 种思维架构中，MVP 阶段覆盖哪些？
   - 建议 P0: 主体、客体、时运
   - 建议 P1: 五行、正偏、柱位
   - 建议 P2: 其他

2. **推理链条深度**：提取几步推理？
   - A. 2-3 步（核心推理）
   - B. 4-5 步（完整推理）

3. **指导模式提取**：是否作为案例核心价值点？

---

## 关键文件清单

| 文件 | 修改类型 | 说明 |
|------|---------|------|
| `docs/archive/v6/VibeLife-Expert-System-v6.md` | 新增章节 | 思维架构体系 |
| `.claude/skills/vibelife-skill/SKILL.md` | 更新流程 | Stage 4a 增强 |
| `.claude/skills/vibelife-skill/templates/prompts/CASE_EXTRACTION_PROMPT.md` | 重构 | 推理链条提取 |
| `.claude/skills/vibelife-skill/templates/schemas/SKILL_SCHEMAS.md` | 扩展 | 新增字段 |

---

## 验证方案

1. 使用新 Prompt 从《东方代码启示录》乾隆案例提取推理链条
2. 对比提取结果与原文分析质量
3. 验证 thinking_frameworks_used 能否支持场景匹配
