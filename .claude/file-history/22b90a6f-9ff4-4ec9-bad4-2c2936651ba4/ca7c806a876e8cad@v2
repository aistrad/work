---
name: vibelife-skill
description: |
  VibeLife Skill - 知识库与专家系统构建工具 v6。
  基于 VibeLife Expert System v6 架构，整合知识构建流水线全流程。
  触发词：vibelife-skill, 建库, 建skill, 知识库构建, skill构建
---

# VibeLife Skill - 知识库与专家系统构建工具 v6

## 概述

基于 VibeLife Expert System v6 架构设计，提供从原始资料到可用专家系统的完整流水线。

**核心原则**：所有涉及大模型的步骤都在 Claude Code 中完成，自动化流程不调用外部 LLM API。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    通用知识构建流水线 v6.1                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  Stage 0: 格式转换 (自动化) → PDF/EPUB/DOCX → Markdown                      │
│  Stage 1-3: 切块 → 向量化 → 入库 (自动化)                                   │
│  Stage 4: 统一抽取 + LLM 自动审核 (unified_extractor.py)                    │
│           ├─ Cases → 自动评分入库 (score >= 0.6)                            │
│           └─ Scenarios → 相似度检测后自动发布/融合                          │
│  Stage 6: 质量检查 (自动化)                                                 │
│                                                                             │
│  已废弃: Stage 4a/4b (分离抽取), Stage 5 (人工审核)                         │
│  已删除: scenario_candidates 表, scenario_index 表                          │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 运行时路由架构

### LLM 路由 (use_skill 工具一次决定 skill + scenario)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    运行时路由流程                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 入口 A: 用户点击服务卡片                                            │   │
│  │ → 前端直接传递 skill + scenario，跳过路由，进入 Step 2              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 入口 B: 用户自然语言提问                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│      │                                                                      │
│      ▼                                                                      │
│  ╔═══════════════════════════════════════════════════════════════════════╗ │
│  ║ Step 1: LLM 路由 (use_skill 工具)                                     ║ │
│  ╠═══════════════════════════════════════════════════════════════════════╣ │
│  ║                                                                       ║ │
│  ║ LLM 调用 use_skill 工具:                                              ║ │
│  ║ {                                                                     ║ │
│  ║   "skill": "bazi",                                                    ║ │
│  ║   "scenario": "career",                                               ║ │
│  ║   "confidence": "high" | "medium" | "low"                             ║ │
│  ║ }                                                                     ║ │
│  ║                                                                       ║ │
│  ║ 场景目录嵌入工具描述，LLM 语义理解后选择最合适的场景                  ║ │
│  ║                                                                       ║ │
│  ║ if confidence == "low":                                               ║ │
│  ║   → 调用 ask_user_question 让用户选择                                 ║ │
│  ║   → 或展示服务目录卡片                                                ║ │
│  ║                                                                       ║ │
│  ╚═══════════════════════════════════════════════════════════════════════╝ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### use_skill 工具定义

```python
USE_SKILL_TOOL = {
    "type": "function",
    "function": {
        "name": "use_skill",
        "description": """激活专业技能并选择服务场景。

## bazi (八字命理)
| scenario | 适用情况 |
|----------|---------|
| basic_reading | 看命盘、算命、初次咨询 |
| personality | 性格分析、我是什么人、天赋 |
| career | 事业、工作、职业、跳槽 |
| wealth | 财运、投资、赚钱 |
| relationship | 感情、婚姻、桃花 |
| yearly_fortune | 今年运势、流年 |
| dayun | 大运、十年运、人生阶段 |
| life_blueprint | 完整分析、人生规划 |
| compatibility | 合婚、配对 |
| timing | 择日、选日子 |

根据用户问题选择最合适的技能和场景。
如果不确定，设置 confidence 为 low。""",
        "parameters": {
            "type": "object",
            "properties": {
                "skill": {
                    "type": "string",
                    "enum": ["bazi", "zodiac", "career", "tarot"]
                },
                "scenario": {
                    "type": "string",
                    "description": "场景ID，如 career, yearly_fortune 等"
                },
                "confidence": {
                    "type": "string",
                    "enum": ["high", "medium", "low"],
                    "description": "路由置信度，low 时会追问用户确认"
                }
            },
            "required": ["skill", "scenario", "confidence"]
        }
    }
}
```


---

## 工具层级架构

工具分为两个层级：全局工具（所有 skill 共享）和 Skill 级工具（定义在各 SKILL.md 中）。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    工具层级架构                                              │
├───────────────────────────────────────────────��─────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 全局工具 (所有 skill 共享)                                          │   │
│  │                                                                     │   │
│  │ • search_db(table, query, filters) - 数据库查询                     │   │
│  │ • ask_user_question(question, options) - 追问用户                   │   │
│  │ • show_service_menu(services) - 展示服务目录                        │   │
│  │ • show_insight(type, content) - 通用洞察卡片                        │   │
│  │ • show_report(data) - 通用报告                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Skill 级工具 (定义在各 SKILL.md 中)                                 │   │
│  │                                                                     │   │
│  │ bazi skill:                                                         │   │
│  │ • collect_bazi_info - 收集出生信息                                  │   │
│  │ • calculate_bazi - 排盘计算                                         │   │
│  │ • show_bazi_chart - 展示命盘图                                      │   │
│  │ • show_bazi_fortune - 展示运势分析                                  │   │
│  │ • show_bazi_kline - 展示运势K线                                     │   │
│  │                                                                     │   │
│  │ zodiac skill:                                                       │   │
│  │ • collect_zodiac_info - 收集出生信息                                │   │
│  │ • calculate_zodiac - 计算星盘                                       │   │
│  │ • show_zodiac_chart - 展示星盘图                                    │   │
│  │                                                                     │   │
│  │ tarot skill:                                                        │   │
│  │ • draw_cards - 抽牌                                                 │   │
│  │ • show_tarot_spread - 展示牌阵                                      │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 全局工具: search_db

```python
SEARCH_DB_TOOL = {
    "type": "function",
    "function": {
        "name": "search_db",
        "description": """从数据库检索知识或案例。

根据分析需要调用此工具检索相关信息：
- 需要专业知识时：table="knowledge_chunks"
- 需要参考案例时：table="cases"

LLM 根据 SOP 自己判断何时需要检索，检索什么内容。""",
        "parameters": {
            "type": "object",
            "properties": {
                "table": {
                    "type": "string",
                    "enum": ["knowledge_chunks", "cases"],
                    "description": "要查询的表"
                },
                "query": {
                    "type": "string",
                    "description": "检索查询词"
                },
                "filters": {
                    "type": "object",
                    "description": "可选过滤条件，如 skill_id, scenario_id, tags 等"
                },
                "top_k": {
                    "type": "integer",
                    "default": 5,
                    "description": "返回结果数量"
                }
            },
            "required": ["table", "query"]
        }
    }
}
```

---

## 目录结构

### 知识源目录
```
/data/vibelife/knowledge/{skill_id}/
├── source/                    # 原始源文件
└── converted/                 # 转换后的 Markdown
```

### Skill 目录 (Claude Agent SDK 规范)
```
/home/aiscend/work/vibelife/apps/api/skills/{skill_id}/
├── SKILL.md                   # Skill 核心定义
├── scenarios/                 # MiniSkill 场景库
└── tools/                     # 工具目录
```

---

## 模板文件

所有模板文件位于 `templates/` 目录：

### 核心模板

| 模板 | 文件 | 用途 |
|------|------|------|
| SKILL 模板 | [SKILL_TEMPLATE.md](templates/SKILL_TEMPLATE.md) | Skill 核心定义模板 |
| Scenario 模板 | [SCENARIO_TEMPLATE.md](templates/SCENARIO_TEMPLATE.md) | MiniSkill 场景模板 |
| 工具模板 | [TOOL_TEMPLATE.py](templates/TOOL_TEMPLATE.py) | 工具接口规范 |

### Prompt 模板

| 模板 | 文件 | 用途 |
|------|------|------|
| 案例提取 Prompt | [CASE_EXTRACTION_PROMPT.md](templates/prompts/CASE_EXTRACTION_PROMPT.md) | Stage 4a 使用 |
| 场景生成 Prompt | [SCENARIO_GENERATION_PROMPT.md](templates/prompts/SCENARIO_GENERATION_PROMPT.md) | Stage 4b 使用 |
| 术语提取 Prompt | [TERM_EXTRACTION_PROMPT.md](templates/prompts/TERM_EXTRACTION_PROMPT.md) | 术语提取使用 |

### Schema 模板

| 模板 | 文件 | 用途 |
|------|------|------|
| Skill Schema | [SKILL_SCHEMAS.md](templates/schemas/SKILL_SCHEMAS.md) | 各 Skill 的数据结构 |
| 数据库 Schema | [DATABASE_SCHEMAS.sql](templates/schemas/DATABASE_SCHEMAS.sql) | PostgreSQL 表结构 |

### 前端与交互模板

| 模板 | 文件 | 用途 |
|------|------|------|
| 卡片组件模板 | [CARD_TEMPLATE.tsx](templates/CARD_TEMPLATE.tsx) | 前端卡片组件规范 |
| 卡片注册表 | [CARD_REGISTRY.tsx](templates/CARD_REGISTRY.tsx) | 卡片组件注册管理 |
| 工具-卡片映射 | [TOOL_CARD_MAPPING.md](templates/TOOL_CARD_MAPPING.md) | 工具与前端卡片映射规范 |
| 主动追问工具 | [ASK_USER_QUESTION.py](templates/ASK_USER_QUESTION.py) | 主动追问工具模板 |

---

## 使用方式

### CLI 命令

```bash
# 运行完整流水线
python scripts/build_knowledge.py --skill bazi --stages all

# 运行特定阶段
python scripts/build_knowledge.py --skill bazi --stages 0        # 仅格式转换
python scripts/build_knowledge.py --skill bazi --stages 1-3      # 切块+向量化+入库
python scripts/build_knowledge.py --skill bazi --stages 4a       # 案例提取
python scripts/build_knowledge.py --skill bazi --stages 4b       # 场景生成
python scripts/build_knowledge.py --skill bazi --stages 5 --review  # 交互式审核
python scripts/build_knowledge.py --skill bazi --stages 6        # 质量报告
```

### API 端点

| 端点 | 方法 | 描述 |
|------|------|------|
| `/api/knowledge/build` | POST | 启动构建流水线 |
| `/api/knowledge/cases/extract` | POST | 提取案例 |
| `/api/knowledge/scenarios/generate` | POST | 生成场景 |
| `/api/knowledge/scenarios/pending` | GET | 列出待审核场景 |
| `/api/knowledge/scenarios/review` | POST | 审核场景 |
| `/api/knowledge/quality/check` | POST | 质量检查 |
| `/api/knowledge/stats/{skill_id}` | GET | 获取统计 |

---

## Stage 详细说明

### Stage 0: 格式转换

| 输入格式 | 转换方法 | 输出格式 |
|---------|---------|---------|
| PDF | pymupdf4llm | MD |
| EPUB | ebooklib + html2text | MD |
| DOCX | python-docx | MD |
| HTML | BeautifulSoup + html2text | MD |

### Stage 1-3: 切块 → 向量化 → 入库

- 切块: max_tokens=2000, min_tokens=200, overlap=50
- 向量化: BAAI/bge-m3, 1024维, batch_size=4
- 入库: PostgreSQL + pgvector + tsvector

### Stage 4a: 案例提取 (Claude Code 手动)

使用 [CASE_EXTRACTION_PROMPT.md](templates/prompts/CASE_EXTRACTION_PROMPT.md) 模板。

### Stage 4b: Scenario 候选生成 (Claude Code 手动)

使用 [SCENARIO_GENERATION_PROMPT.md](templates/prompts/SCENARIO_GENERATION_PROMPT.md) 模板。

### Stage 5: 人工评估与发布

评估维度：SOP 完整性、知识检索配置、输出模板质量、与现有 scenarios 的差异/互补。

### Stage 6: 质量检查

| 指标 | 目标 |
|------|------|
| 知识覆盖率 | ≥300 chunks |
| 案例分布 | ≥50 cases |
| 检索质量 | ≥70% |

---

## 自检流程

```bash
# Stage 0: 检查转换文件
ls -la /data/vibelife/{skill_id}/converted/*.md | wc -l

# Stage 1-3: 检查入库数量
psql -c "SELECT COUNT(*) FROM knowledge_chunks WHERE skill_id = '{skill_id}';"

# Stage 4a: 检查案例数量
psql -c "SELECT COUNT(*) FROM cases WHERE skill_id = '{skill_id}';"

# Stage 4b: 检查待审核场景
psql -c "SELECT COUNT(*) FROM scenario_candidates WHERE skill_id = '{skill_id}' AND status = 'pending';"

# Stage 6: 生成质量报告
python scripts/build_knowledge.py --skill {skill_id} --stages 6
```

---

## 核心原则

1. **质量优先**：只入库高质量内容
2. **深度优先**：提取大模型不知道的专业知识
3. **可追溯**：所有规则标注来源
4. **可迭代**：支持增量更新
5. **模块化**：各阶段可独立执行

---

## 禁止行为

1. 禁止创建骨架/占位文件
2. 禁止入库空内容 (< 50KB)
3. 禁止猜测/编写内容
4. 禁止跳过质量评估
5. 禁止提取常识性规则
6. 禁止无来源的规则
