# Scenario 与 Case 抽取流程优化计划

> 前置工作（已完成）：通用模板优化，新增 thinking_frameworks_used, reasoning_chain, guidance_patterns 三个字段

---

## 一、现状分析

### 1.1 当前抽取架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     当前架构（两次独立处理）                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  knowledge_chunks 表                                                    │
│        │                                                                │
│        ├───→ [Stage 4a] case_extractor.py ───→ cases 表                │
│        │         └─ LLM Call #1                                        │
│        │                                                                │
│        └───→ [Stage 4b] scenario_generator.py ───→ scenario_candidates │
│                  └─ LLM Call #2                                        │
│                                                                         │
│  问题：                                                                 │
│  • 同一 chunk 被处理两次，浪费 LLM 调用                                  │
│  • 无增量处理，每次全量跑                                                │
│  • Scenario 无法追溯来源 chunk                                          │
│  • 更新 Prompt 后无法选择性重新处理                                      │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.2 关键文件清单

| 文件 | 职责 | 行数 |
|------|------|------|
| `apps/api/workers/case_extractor.py` | Case 提取 | 346 行 |
| `apps/api/workers/scenario_generator.py` | Scenario 生成 | 463 行 |
| `apps/api/scripts/build_knowledge.py` | 流水线编排 | 342 行 |
| `.claude/skills/vibelife-skill/templates/prompts/CASE_EXTRACTION_PROMPT.md` | Case Prompt 模板 | ~150 行 |

### 1.3 数据流分析

**Case 抽取 (case_extractor.py:316-329)**：
```python
# 数据源查询
SELECT id, chunk_text as content
FROM knowledge_chunks
WHERE skill_id = $1
AND chunk_type IN ('case', 'theory', 'rule')  # 过滤条件
LIMIT $2
```

**Scenario 生成 (scenario_generator.py:430-441)**：
```python
# 数据源查询
SELECT id, chunk_text as content, chunk_type
FROM knowledge_chunks
WHERE skill_id = $1
ORDER BY chunk_type DESC  # 优先 method
LIMIT $2
```

---

## 二、优化目标

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     目标架构（统一抽取 + 增量处理）                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  knowledge_chunks 表                                                    │
│        │                                                                │
│        ▼                                                                │
│  [Stage 4] unified_extractor.py                                        │
│        │   └─ 单次 LLM 调用同时提取 Case + Scenario                     │
│        │   └─ 增量处理：只处理 extraction_status = 'pending'            │
│        │   └─ 版本控制：记录 extraction_version                         │
│        │                                                                │
│        ├───→ cases 表 (source_chunk_id 关联)                           │
│        │                                                                │
│        └───→ scenario_candidates 表 (source_chunk_id 关联)             │
│                                                                         │
│  优势：                                                                 │
│  • LLM 调用减半                                                         │
│  • 增量处理，只处理新增/需更新的 chunks                                  │
│  • Case 和 Scenario 可通过 source_chunk_id 关联                        │
│  • 版本控制支持 Prompt 更新后选择性重新处理                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、实施方案

### 3.1 数据库 Schema 变更

**knowledge_chunks 表新增字段**：

```sql
-- 增量处理支持
ALTER TABLE knowledge_chunks ADD COLUMN IF NOT EXISTS
    extraction_status VARCHAR(20) DEFAULT 'pending';
-- Values: pending, extracted, skipped, needs_reextract

-- 版本控制
ALTER TABLE knowledge_chunks ADD COLUMN IF NOT EXISTS
    extraction_version INT DEFAULT 0;

-- 最后处理时间
ALTER TABLE knowledge_chunks ADD COLUMN IF NOT EXISTS
    last_extracted_at TIMESTAMP;

-- 索引
CREATE INDEX IF NOT EXISTS idx_chunks_extraction_status
    ON knowledge_chunks(skill_id, extraction_status);
```

**scenario_candidates 表新增字段**：

```sql
-- 来源追溯
ALTER TABLE scenario_candidates ADD COLUMN IF NOT EXISTS
    source_chunk_ids VARCHAR[] DEFAULT '{}';
```

### 3.2 统一抽取 Prompt 设计

**新建文件**: `.claude/skills/vibelife-skill/templates/prompts/UNIFIED_EXTRACTION_PROMPT.md`

```markdown
你是一个专业的知识抽取专家。请从以下文本中同时识别：
1. **案例 (Case)**：具体的分析实例
2. **场景 (Scenario)**：可服务用户的服务流程

## Skill类型: {skill_id}

## 思维架构体系
{thinking_frameworks}

## 待分析文本
{text}

## 输出格式

```json
{
  "cases": [
    {
      "name": "案例名称",
      "core_data": {...},
      "features": {...},
      "thinking_frameworks_used": ["架构1", "架构2"],
      "reasoning_chain": [...],
      "guidance_patterns": [...],
      "tags": [...],
      "scenario_ids": [...]
    }
  ],
  "scenarios": [
    {
      "scenario_id": "英文ID",
      "name": "中文名称",
      "level": "entry|standard|professional",
      "primary_triggers": [...],
      "sop_phases": [...]
    }
  ],
  "extraction_notes": "抽取备注（可选）"
}
```

如果文本不包含案例或场景，对应数组返回空 `[]`。
```

### 3.3 新建统一抽取器

**新建文件**: `apps/api/workers/unified_extractor.py`

核心逻辑：

```python
class UnifiedExtractor:
    """
    Stage 4: Unified Case & Scenario Extraction

    Features:
    - Single LLM call extracts both Case and Scenario
    - Incremental processing via extraction_status
    - Version control via extraction_version
    - Source tracking via source_chunk_id(s)
    """

    async def extract_from_chunk(self, chunk: dict, skill_id: str) -> dict:
        """Single LLM call for both Case and Scenario extraction"""
        ...

    async def process_pending_chunks(
        self,
        skill_id: str,
        limit: int = 100,
        reextract_version: int = None  # 重新抽取指定版本以下的
    ) -> dict:
        """
        Incremental processing:
        - Only process extraction_status = 'pending'
        - Or extraction_version < reextract_version
        """
        ...

    async def mark_chunks_for_reextract(
        self,
        skill_id: str,
        chunk_types: list[str] = None,
        before_version: int = None
    ):
        """Mark chunks for re-extraction (e.g., after Prompt update)"""
        ...
```

### 3.4 流水线整合

**修改**: `apps/api/scripts/build_knowledge.py`

```python
# 原来
async def run_stage_4a(self, limit: int = 100):
    """Stage 4a: Extract cases"""
    ...

async def run_stage_4b(self, limit: int = 50):
    """Stage 4b: Generate scenario candidates"""
    ...

# 新增
async def run_stage_4(self, limit: int = 100, reextract_version: int = None):
    """
    Stage 4: Unified Extraction (Cases + Scenarios)

    Args:
        limit: Max chunks to process per run
        reextract_version: If set, reextract chunks with version < this
    """
    from workers.unified_extractor import UnifiedExtractor

    extractor = UnifiedExtractor()
    results = await extractor.process_pending_chunks(
        self.skill_id,
        limit=limit,
        reextract_version=reextract_version
    )

    logger.info(f"Stage 4 complete: {results['cases_count']} cases, {results['scenarios_count']} scenarios")
    return results
```

### 3.5 CLI 参数扩展

```bash
# 增量处理（默认行为）
python build_knowledge.py --skill bazi --stages 4

# 强制重新抽取所有
python build_knowledge.py --skill bazi --stages 4 --reextract-all

# 重新抽取指定版本以下的
python build_knowledge.py --skill bazi --stages 4 --reextract-below 2

# 标记特定类型需要重新抽取
python build_knowledge.py --skill bazi --mark-reextract --chunk-types method,theory
```

---

## 四、增量逻辑详解

### 4.1 状态机

```
                    ┌──────────────┐
                    │   pending    │ ◄── 新 chunk 入库
                    └──────┬───────┘
                           │
                           ▼ extract_from_chunk()
                    ┌──────────────┐
              ┌─────│  extracted   │
              │     └──────┬───────┘
              │            │
              │            ▼ Prompt 更新 / 手动标记
              │     ┌──────────────┐
              │     │needs_reextract│
              │     └──────┬───────┘
              │            │
              └────────────┘ 循环重新抽取

              ┌──────────────┐
              │   skipped    │ ◄── 内容太短 / 无有效内容
              └──────────────┘
```

### 4.2 融合策略

**场景 A：新增 knowledge chunk**
```
1. 新 chunk 入库 → extraction_status = 'pending'
2. Stage 4 运行 → 检测到 pending → 抽取 → 状态更新为 'extracted'
3. 结果写入 cases / scenario_candidates，记录 source_chunk_id
```

**场景 B：Prompt/Schema 更新**
```
1. 更新 UNIFIED_EXTRACTION_PROMPT.md
2. 全局版本号 +1（存在 skill_metadata 表）
3. 运行: --reextract-below NEW_VERSION
4. 符合条件的 chunks 状态变为 'needs_reextract'
5. Stage 4 重新处理这些 chunks
6. 新结果 UPSERT 到 cases / scenario_candidates
```

**场景 C：删除源 chunk**
```
1. 删除 knowledge_chunks 记录
2. 级联删除（或标记）相关 cases / scenario_candidates
   WHERE source_chunk_id = deleted_chunk_id
```

### 4.3 关联查询

```sql
-- 查看某个 Case 来源于哪个 Chunk
SELECT c.*, k.book_name, k.chapter
FROM cases c
JOIN knowledge_chunks k ON k.id = c.source_chunk_id
WHERE c.id = 'CASE_bazi_xxxx';

-- 查看某个 Chunk 产出了哪些 Cases 和 Scenarios
SELECT
    k.id as chunk_id,
    array_agg(DISTINCT c.id) as case_ids,
    array_agg(DISTINCT s.scenario_id) as scenario_ids
FROM knowledge_chunks k
LEFT JOIN cases c ON c.source_chunk_id = k.id
LEFT JOIN scenario_candidates s ON k.id = ANY(s.source_chunk_ids)
WHERE k.skill_id = 'bazi'
GROUP BY k.id;
```

---

## 五、关键文件修改清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `apps/api/stores/migrations/002_extraction_incremental.sql` | 新建 | Schema 变更 |
| `apps/api/workers/unified_extractor.py` | 新建 | 统一抽取器 |
| `.claude/skills/vibelife-skill/templates/prompts/UNIFIED_EXTRACTION_PROMPT.md` | 新建 | 统一 Prompt |
| `apps/api/scripts/build_knowledge.py` | 修改 | 新增 run_stage_4() |
| `apps/api/routes/knowledge_builder.py` | 修改 | 新增 API 端点 |

**保留兼容**（不删除）：
- `apps/api/workers/case_extractor.py` - 保留用于单独调试
- `apps/api/workers/scenario_generator.py` - 保留用于单独调试

---

## 六、验证方案

### 6.1 单元测试

```python
# test_unified_extractor.py

async def test_extract_from_chunk_returns_both():
    """验证单次调用能同时返回 Case 和 Scenario"""
    ...

async def test_incremental_only_processes_pending():
    """验证增量逻辑只处理 pending 状态"""
    ...

async def test_reextract_updates_existing():
    """验证重新抽取会 UPSERT 已有结果"""
    ...
```

### 6.2 端到端测试

```bash
# 1. 准备测试数据
INSERT INTO knowledge_chunks (...) VALUES (...);  -- 3 条测试 chunks

# 2. 首次运行
python build_knowledge.py --skill bazi --stages 4

# 3. 验证结果
SELECT COUNT(*) FROM cases WHERE skill_id = 'bazi';
SELECT COUNT(*) FROM scenario_candidates WHERE skill_id = 'bazi';
SELECT extraction_status FROM knowledge_chunks WHERE skill_id = 'bazi';
-- 应该都是 'extracted'

# 4. 再次运行（应该跳过已处理的）
python build_knowledge.py --skill bazi --stages 4
-- 日志应显示 "0 chunks to process"

# 5. 标记重新抽取
python build_knowledge.py --skill bazi --mark-reextract --chunk-types method

# 6. 再次运行（应该只处理标记的）
python build_knowledge.py --skill bazi --stages 4
-- 日志应显示处理了标记的 chunks
```

---

## 七、后续可选优化

1. **批量 LLM 调用**：将多个 chunks 合并到一个 Prompt 中处理
2. **异步队列**：使用 Celery/Redis 实现后台异步抽取
3. **质量评分**：为每个 Case/Scenario 生成质量评分
4. **去重检测**：检测相似的 Case/Scenario 避免重复

---

# 附录：原通用模板优化计划（已完成）

## 从《东方代码启示录》案例中抽象的核心洞察

### 洞察 1：专家存储的是"推理链条"而非"结论"

**学习案例**（乾隆皇帝八字分析）：
```
结论型记录（当前）：                    推理型记录（专家）：
─────────────────────────              ─────────────────────────
{                                      {
  "pattern": "正官格",                   "reasoning_chain": [
  "key_gods": ["正官"]                     {
}                                           "step": 1,
                                            "observation": "劫财辛金透出",
↓ 用户只能看到结论                           "analysis": "被正官丁火克弱",
                                            "conclusion": "释放反向信号→人脉扶助"
                                          }
                                        ]
                                      }

                                      ↓ 用户能看到专家的思维过程
```

**泛化到所有 Skill**：
- 占星：不只记录"金星落天蝎"，要记录如何从相位推导出"情感深刻"
- 塔罗：不只记录"愚者正位"，要记录如何从牌面推导出"新开始的勇气"
- 职业：不只记录"适合管理"，要记录如何从经历推导出"领导力潜质"

---

### 洞察 2：每个领域都有自己的"思维架构"体系

**学习案例**（八字25种思维架构）：
```
主体思维架构 → 身强/身弱判定
客体思维架构 → 十神分析
时运思维架构 → 大运流年
正偏思维架构 → 正偏转换关系
...
```

**泛化到所有 Skill**：

| Skill | 核心思维架构（示例） |
|-------|---------------------|
| Zodiac | 元素架构、模式架构、相位架构、宫位架构、行运架构 |
| Tarot | 大小牌架构、花色架构、数字架构、叙事架构、元素尊严架构 |
| Career | 职业锚架构、霍兰德架构、MBTI架构、技能矩阵架构 |

**核心观点**：每个专业领域都有一套"看问题的方式"，这就是思维架构。

---

### 洞察 3：专家系统的核心价值是"指导"而非"预测"

**学习案例**（《东方代码启示录》原话）：
> "八字学的实用性，不在于预见人生，而在于指导更理想的人生。"
> "可以主动选择较轻微的表现方式来宣泄能量"

**泛化到所有 Skill**：
- 所有专家系统都应该输出"可操作的指导"
- 指导模式是专家系统的核心资产
- 这才是用户真正需要的价值

---

## 通用模板优化方案

### 1. SKILL_TEMPLATE.md 新增「思维架构」章节

```markdown
## 思维架构体系

本 Skill 的分析基于以下思维架构：

### 核心架构 (必须掌握)

| 架构名称 | 分析维度 | 应用场景 |
|---------|---------|---------|
| {架构1} | {描述} | {场景} |
| {架构2} | {描述} | {场景} |

### 进阶架构 (专业级使用)

| 架构名称 | 分析维度 | 应用场景 |
|---------|---------|---------|
| {架构3} | {描述} | {场景} |

### 架构组合规则

| 场景类型 | 使用架构组合 |
|---------|-------------|
| {场景} | {架构1} + {架构2} |
```

**好处**：
- 新手构建 Skill 时知道要思考"这个领域的分析维度有哪些"
- Scenario 可以引用架构组合
- Case 可以标注使用了哪些架构

---

### 2. SCENARIO_TEMPLATE.md 新增「分析框架」配置

在 Phase 5 (深度分析) 中新增：

```markdown
### Phase 5: 深度分析

**使用的思维架构**:
- {架构1}: {在此场景的应用方式}
- {架构2}: {在此场景的应用方式}

**分析框架**:
```yaml
analysis_framework:
  dimensions:
    - name: "{分析维度1}"
      source_framework: "{架构名称}"
      factors: ["{因素1}", "{因素2}"]
      output: "{输出类型}"
    - name: "{分析维度2}"
      source_framework: "{架构名称}"
      factors: [...]
      output: "..."
```

**好处**：
- SOP 不再是"黑盒"，而是清晰标注使用了哪些架构
- LLM 执行时有明确的分析框架指导
- 案例匹配可以基于架构匹配

---

### 3. CASE_EXTRACTION_PROMPT.md 重构为「推理链条提取」

**当前结构**：
```
core_data + features + tags + analysis + conclusion
```

**新结构**：
```
core_data + features + thinking_frameworks_used + reasoning_chain + guidance_patterns
```

**新增字段定义**：

```markdown
## 推理链条 (reasoning_chain)

从专业文本中提取专家的推理过程，每个步骤包含：

| 字段 | 类型 | 说明 |
|------|------|------|
| step | int | 步骤序号 |
| framework | string | 使用的思维架构 |
| observation | string | 观察到的特征 |
| analysis | string | 分析推理过程 |
| conclusion | string | 该步骤的结论 |

## 指导模式 (guidance_patterns)

从专业文本中提取可复用的指导建议：

| 字段 | 类型 | 说明 |
|------|------|------|
| pattern_name | string | 模式名称 |
| condition | string | 适用条件 |
| advice | string | 具体建议 |
| source | string | 来源依据 |

## 使用的思维架构 (thinking_frameworks_used)

标注该案例使用了哪些思维架构：
- 用于 Scenario-Case 匹配
- 用于推理链条归类
```

---

### 4. SKILL_SCHEMAS.md 新增通用字段

**所有 Skill 共享的新字段**：

```python
# 通用案例结构（所有 Skill 共享）
COMMON_CASE_FIELDS = {
    "reasoning_chain": {
        "type": "array",
        "description": "专家推理链条",
        "items": {
            "step": "int",
            "framework": "string",
            "observation": "string",
            "analysis": "string",
            "conclusion": "string"
        }
    },
    "guidance_patterns": {
        "type": "array",
        "description": "指导模式",
        "items": {
            "pattern_name": "string",
            "condition": "string",
            "advice": "string",
            "source": "string"
        }
    },
    "thinking_frameworks_used": {
        "type": "array",
        "description": "使用的思维架构列表",
        "items": "string"
    }
}
```

---

### 5. VibeLife-Expert-System-v6.md 新增「思维架构层」

在架构全景图中新增：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      VibeLife Expert System                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ══════════════════════ 思维架构层 (Thinking Framework Layer) ═══════════   │
│                                                                             │
│   每个 Skill 定义自己的思维架构体系：                                        │
│                                                                             │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│   │   Bazi      │  │   Zodiac    │  │   Tarot     │  │   Career    │       │
│   ├─────────────┤  ├─────────────┤  ├─────────────┤  ├─────────────┤       │
│   │ 主体架构    │  │ 元素架构    │  │ 大小牌架构  │  │ 职业锚架构  │       │
│   │ 客体架构    │  │ 模式架构    │  │ 花色架构    │  │ 霍兰德架构  │       │
│   │ 时运架构    │  │ 相位架构    │  │ 数字架构    │  │ MBTI架构    │       │
│   │ 正偏架构    │  │ 宫位架构    │  │ 叙事架构    │  │ 技能架构    │       │
│   │ ...         │  │ ...         │  │ ...         │  │ ...         │       │
│   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘       │
│                                                                             │
│   Scenario = 思维架构的组合                                                  │
│   Case = 思维架构下的推理示范 + 指导模式                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 关键文件修改清单

| 文件 | 修改类型 | 具体内容 |
|------|---------|---------|
| `templates/SKILL_TEMPLATE.md` | 新增章节 | 「思维架构体系」 |
| `templates/SCENARIO_TEMPLATE.md` | 新增 Phase 5 配置 | 分析框架 YAML |
| `templates/prompts/CASE_EXTRACTION_PROMPT.md` | 重构 | 推理链条+指导模式提取 |
| `templates/schemas/SKILL_SCHEMAS.md` | 新增字段 | 3个通用字段 |
| `docs/archive/v6/VibeLife-Expert-System-v6.md` | 新增章节 | 思维架构层说明 |

---

## 验证方案

1. **用新 SKILL_TEMPLATE 重新审视 Zodiac Skill**
   - 识别占星的思维架构体系
   - 验证模板是否足够通用

2. **用新 CASE_EXTRACTION_PROMPT 提取乾隆案例**
   - 验证推理链条提取是否可行
   - 验证指导模式提取是否可行

3. **用新 SCENARIO_TEMPLATE 检查 career.md**
   - 验证分析框架配置是否清晰
   - 验证思维架构引用是否合理

---

## 核心价值总结

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   从「结论导向」→「推理导向」                                                │
│                                                                             │
│   当前：专家系统 = 知识库 + 案例库 + SOP                                    │
│                                                                             │
│   优化：专家系统 = 思维架构 + 推理链条 + 指导模式                            │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   思维架构：专家"怎么看"问题                                        │   │
│   │   推理链条：专家"怎么想"问题                                        │   │
│   │   指导模式：专家"怎么建议"用户                                      │   │
│   │                                                                     │   │
│   │   这三者才是专家系统的核心资产                                       │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```
