-- Migration: 002_cases_source_tracking
-- Description: Add source tracking, quality scoring, and v1.2 expert system fields to cases table
-- Date: 2026-01-14

-- =============================================================================
-- 1. 来源追溯字段（支持从 MD 文件直接抽取）
-- =============================================================================

-- 源文件路径（相对于 converted/ 目录）
ALTER TABLE cases ADD COLUMN IF NOT EXISTS
    source_file VARCHAR(255);

-- 源章节名称（用于大文件按章节分割抽取）
ALTER TABLE cases ADD COLUMN IF NOT EXISTS
    source_section VARCHAR(255);

-- =============================================================================
-- 2. 质量评分与审核状态
-- =============================================================================

-- 质量评分 (0-1, 由 LLM 或规则生成)
ALTER TABLE cases ADD COLUMN IF NOT EXISTS
    quality_score FLOAT DEFAULT 0;

-- 审核状态
ALTER TABLE cases ADD COLUMN IF NOT EXISTS
    status VARCHAR(20) DEFAULT 'pending';
-- Values: pending, approved, rejected, needs_revision

-- =============================================================================
-- 3. v1.2 专家系统核心字段（思维架构体系）
-- =============================================================================

-- 使用的思维架构列表（用于 Scenario-Case 匹配）
ALTER TABLE cases ADD COLUMN IF NOT EXISTS
    thinking_frameworks_used VARCHAR[] DEFAULT '{}';

-- 专家推理链条
-- 结构: [{step, framework, observation, analysis, conclusion}]
ALTER TABLE cases ADD COLUMN IF NOT EXISTS
    reasoning_chain JSONB DEFAULT '[]';

-- 可复用的指导模式
-- 结构: [{pattern_name, condition, advice, source}]
ALTER TABLE cases ADD COLUMN IF NOT EXISTS
    guidance_patterns JSONB DEFAULT '[]';

-- =============================================================================
-- 4. 索引
-- =============================================================================

-- 来源文件索引（用于按文件查询/更新）
CREATE INDEX IF NOT EXISTS idx_cases_source_file
    ON cases(skill_id, source_file);

-- 审核状态索引（用于查询待审核案例）
CREATE INDEX IF NOT EXISTS idx_cases_status
    ON cases(skill_id, status);

-- 思维架构索引（用于基于架构匹配案例）
CREATE INDEX IF NOT EXISTS idx_cases_frameworks
    ON cases USING GIN(thinking_frameworks_used);

-- =============================================================================
-- 5. 注释
-- =============================================================================

COMMENT ON COLUMN cases.source_file IS '源 MD 文件路径（相对于 converted/ 目录）';
COMMENT ON COLUMN cases.source_section IS '源章节名称（大文件按章节分割时使用）';
COMMENT ON COLUMN cases.quality_score IS '质量评分 0-1（用于自动/人工审核决策）';
COMMENT ON COLUMN cases.status IS '审核状态: pending/approved/rejected/needs_revision';
COMMENT ON COLUMN cases.thinking_frameworks_used IS '使用的思维架构列表（v1.2）';
COMMENT ON COLUMN cases.reasoning_chain IS '专家推理链条 JSON 数组（v1.2）';
COMMENT ON COLUMN cases.guidance_patterns IS '可复用指导模式 JSON 数组（v1.2）';
