"""
API 端点性能基准测试
"""
import pytest
import time
import os
import sys
from typing import List

# 添加路径
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))


class TestAPIBenchmark:
    """API 性能测试"""

    @pytest.fixture
    def client(self):
        """创建测试客户端"""
        # 设置测试环境变量
        os.environ.setdefault("VIBELIFE_WORKER_ENABLED", "0")

        from fastapi.testclient import TestClient
        from main import app
        return TestClient(app)

    def test_health_check(self, client):
        """健康检查 - 目标: < 10ms"""
        # 预热
        client.get("/health")

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            response = client.get("/health")
            times.append((time.perf_counter() - start) * 1000)
            assert response.status_code == 200

        avg_ms = sum(times) / len(times)
        p95_ms = sorted(times)[95]

        print(f"\n  GET /health: avg={avg_ms:.3f}ms, p95={p95_ms:.3f}ms")

        assert avg_ms < 10.0, f"Health check avg {avg_ms:.3f}ms exceeds 10ms target"
        assert p95_ms < 20.0, f"Health check p95 {p95_ms:.3f}ms exceeds 20ms target"

    def test_skills_list(self, client):
        """技能列表 - 目标: < 50ms"""
        # 预热
        client.get("/api/v1/skills")

        times: List[float] = []
        for _ in range(50):
            start = time.perf_counter()
            response = client.get("/api/v1/skills")
            times.append((time.perf_counter() - start) * 1000)
            assert response.status_code == 200

        avg_ms = sum(times) / len(times)
        p95_ms = sorted(times)[int(len(times) * 0.95)]

        print(f"\n  GET /api/v1/skills: avg={avg_ms:.3f}ms, p95={p95_ms:.3f}ms")

        assert avg_ms < 50.0, f"Skills list avg {avg_ms:.3f}ms exceeds 50ms target"

    def test_skill_services(self, client):
        """技能服务列表 - 目标: < 30ms"""
        # 预热
        client.get("/api/v1/skills/bazi/services")

        times: List[float] = []
        for _ in range(50):
            start = time.perf_counter()
            response = client.get("/api/v1/skills/bazi/services")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)
        p95_ms = sorted(times)[int(len(times) * 0.95)]

        print(f"\n  GET /api/v1/skills/bazi/services: avg={avg_ms:.3f}ms, p95={p95_ms:.3f}ms")

        assert avg_ms < 30.0, f"Skill services avg {avg_ms:.3f}ms exceeds 30ms target"

    def test_tools_schema(self, client):
        """工具 Schema - 目标: < 100ms"""
        # 预热
        client.get("/api/v1/tools/schema")

        times: List[float] = []
        for _ in range(30):
            start = time.perf_counter()
            response = client.get("/api/v1/tools/schema")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)
        p95_ms = sorted(times)[int(len(times) * 0.95)]

        print(f"\n  GET /api/v1/tools/schema: avg={avg_ms:.3f}ms, p95={p95_ms:.3f}ms")

        assert avg_ms < 100.0, f"Tools schema avg {avg_ms:.3f}ms exceeds 100ms target"

    def test_skill_service_call(self, client):
        """技能服务调用 (无认证) - 应返回 401"""
        times: List[float] = []

        for _ in range(30):
            start = time.perf_counter()
            response = client.post(
                "/api/v1/skills/bazi/chart",
                json={
                    "args": {
                        "birth_date": "1990-01-15",
                        "birth_time": "12:00",
                        "gender": "male"
                    }
                }
            )
            times.append((time.perf_counter() - start) * 1000)
            # 期望 401 (需要认证) 或 200 (如果该服务不需要认证)
            assert response.status_code in [200, 401, 404]

        avg_ms = sum(times) / len(times)

        print(f"\n  POST /api/v1/skills/bazi/chart: avg={avg_ms:.3f}ms")

        # 即使返回错误，响应也应该很快
        assert avg_ms < 100.0, f"Skill call avg {avg_ms:.3f}ms exceeds 100ms target"


class TestMiddlewareBenchmark:
    """中间件性能测试"""

    @pytest.fixture
    def client(self):
        """创建测试客户端"""
        os.environ.setdefault("VIBELIFE_WORKER_ENABLED", "0")

        from fastapi.testclient import TestClient
        from main import app
        return TestClient(app)

    def test_cors_overhead(self, client):
        """CORS 中间件开销"""
        # 预热
        client.options("/health")

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            response = client.options(
                "/health",
                headers={
                    "Origin": "http://localhost:3000",
                    "Access-Control-Request-Method": "GET"
                }
            )
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  CORS preflight: avg={avg_ms:.3f}ms")

        assert avg_ms < 5.0, f"CORS overhead {avg_ms:.3f}ms exceeds 5ms target"

    def test_logging_middleware_overhead(self, client):
        """日志中间件开销 - 通过对比"""
        # 正常请求
        normal_times: List[float] = []
        for _ in range(50):
            start = time.perf_counter()
            client.get("/health")
            normal_times.append((time.perf_counter() - start) * 1000)

        avg_normal = sum(normal_times) / len(normal_times)

        print(f"\n  Request with logging: avg={avg_normal:.3f}ms")

        # 日志中间件开销应该在 2ms 以内
        # (无法直接测量，但通过整体响应时间间接验证)
        assert avg_normal < 15.0, "Logging middleware adds too much overhead"
