"""
Performance Tests - Shared Fixtures
"""
import os
import sys
import asyncio
import pytest

# 确保可以导入 apps/api 模块
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.dirname(__file__))))


@pytest.fixture(scope="session")
def event_loop():
    """Create event loop for async tests"""
    loop = asyncio.new_event_loop()
    yield loop
    loop.close()


@pytest.fixture
def profile_cache():
    """Get a fresh ProfileCache instance"""
    from stores.profile_cache import ProfileCache
    cache = ProfileCache()
    yield cache
    # Cleanup
    asyncio.get_event_loop().run_until_complete(cache.clear())


@pytest.fixture
def route_cache():
    """Get a fresh RouteCache instance"""
    from services.model_router.cache import RouteCache
    cache = RouteCache()
    yield cache
    asyncio.get_event_loop().run_until_complete(cache.clear())


@pytest.fixture
def mock_profile():
    """Sample profile data for testing"""
    return {
        "basic": {
            "name": "测试用户",
            "birth_datetime": "1990-01-15T12:00:00",
            "gender": "male",
            "birth_location": "北京"
        },
        "skill_data": {
            "bazi": {
                "chart": {
                    "year_pillar": {"stem": "庚", "branch": "午"},
                    "month_pillar": {"stem": "丁", "branch": "丑"},
                    "day_pillar": {"stem": "甲", "branch": "子"},
                    "hour_pillar": {"stem": "庚", "branch": "午"}
                }
            }
        },
        "life_context": {
            "career": {"status": "employed"},
            "relationship": {"status": "single"}
        }
    }


@pytest.fixture
def benchmark_config():
    """Benchmark configuration"""
    return {
        "cache_set_target_ms": 1.0,
        "cache_get_target_ms": 0.5,
        "skill_load_cold_target_ms": 50.0,
        "skill_load_cached_target_ms": 1.0,
        "db_simple_query_target_ms": 5.0,
        "api_health_target_ms": 10.0,
    }
