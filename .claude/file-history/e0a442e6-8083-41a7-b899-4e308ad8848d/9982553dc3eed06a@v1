#!/bin/bash
#
# è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
#
# ç”¨æ³•:
#   ./tests/performance/run_benchmarks.sh [options]
#
# é€‰é¡¹:
#   --all         è¿è¡Œæ‰€æœ‰æµ‹è¯•
#   --unit        åªè¿è¡Œå•å…ƒåŸºå‡†æµ‹è¯•
#   --load        åªè¿è¡Œè´Ÿè½½æµ‹è¯• (éœ€è¦å¯åŠ¨æœåŠ¡)
#   --report      ç”Ÿæˆ HTML æŠ¥å‘Š
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
API_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"

cd "$API_DIR"

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  VibeLife Performance Benchmark Suite ${NC}"
echo -e "${GREEN}========================================${NC}"
echo ""

run_unit_benchmarks() {
    echo -e "${YELLOW}ğŸ“Š è¿è¡Œå•å…ƒåŸºå‡†æµ‹è¯•...${NC}"
    echo ""

    # è®¾ç½® PYTHONPATH
    export PYTHONPATH="$API_DIR:$PYTHONPATH"

    # è¿è¡Œ pytest æ€§èƒ½æµ‹è¯•
    python -m pytest tests/performance/ \
        -v \
        --tb=short \
        -s \
        --durations=20 \
        "$@"

    echo ""
    echo -e "${GREEN}âœ… å•å…ƒåŸºå‡†æµ‹è¯•å®Œæˆ${NC}"
}

run_load_test_k6() {
    echo -e "${YELLOW}ğŸ”¥ è¿è¡Œ k6 è´Ÿè½½æµ‹è¯•...${NC}"
    echo ""

    if ! command -v k6 &> /dev/null; then
        echo -e "${RED}âŒ k6 æœªå®‰è£…${NC}"
        echo "å®‰è£…æ–¹æ³•:"
        echo "  macOS: brew install k6"
        echo "  Linux: snap install k6"
        echo "  Docker: docker run -i grafana/k6 run - <tests/performance/load_test.js"
        return 1
    fi

    k6 run tests/performance/load_test.js \
        --env BASE_URL="${BASE_URL:-http://localhost:8000}"

    echo ""
    echo -e "${GREEN}âœ… k6 è´Ÿè½½æµ‹è¯•å®Œæˆ${NC}"
}

run_load_test_locust() {
    echo -e "${YELLOW}ğŸ¦— è¿è¡Œ Locust è´Ÿè½½æµ‹è¯•...${NC}"
    echo ""

    if ! command -v locust &> /dev/null; then
        echo -e "${RED}âŒ Locust æœªå®‰è£…${NC}"
        echo "å®‰è£…æ–¹æ³•: pip install locust"
        return 1
    fi

    echo "å¯åŠ¨ Locust Web UI: http://localhost:8089"
    echo "æˆ–ä½¿ç”¨æ— å¤´æ¨¡å¼: locust --headless -u 50 -r 5 -t 2m"
    echo ""

    locust -f tests/performance/locustfile.py \
        --host="${BASE_URL:-http://localhost:8000}"
}

generate_report() {
    echo -e "${YELLOW}ğŸ“„ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š...${NC}"

    python -m pytest tests/performance/ \
        --html=tests/performance/report.html \
        --self-contained-html \
        -v

    echo ""
    echo -e "${GREEN}âœ… æŠ¥å‘Šç”Ÿæˆ: tests/performance/report.html${NC}"
}

print_usage() {
    echo "ç”¨æ³•: $0 [é€‰é¡¹]"
    echo ""
    echo "é€‰é¡¹:"
    echo "  --all      è¿è¡Œæ‰€æœ‰æµ‹è¯• (éœ€è¦å¯åŠ¨æœåŠ¡)"
    echo "  --unit     åªè¿è¡Œå•å…ƒåŸºå‡†æµ‹è¯•"
    echo "  --k6       è¿è¡Œ k6 è´Ÿè½½æµ‹è¯•"
    echo "  --locust   è¿è¡Œ Locust è´Ÿè½½æµ‹è¯•"
    echo "  --report   ç”Ÿæˆ HTML æŠ¥å‘Š"
    echo "  --help     æ˜¾ç¤ºå¸®åŠ©"
    echo ""
    echo "ç¯å¢ƒå˜é‡:"
    echo "  BASE_URL        API åŸºç¡€ URL (é»˜è®¤: http://localhost:8000)"
    echo "  VIBELIFE_DB_URL æ•°æ®åº“ URL (æ•°æ®åº“æµ‹è¯•éœ€è¦)"
    echo ""
}

# è§£æå‚æ•°
case "${1:-}" in
    --all)
        run_unit_benchmarks
        run_load_test_k6
        ;;
    --unit)
        shift
        run_unit_benchmarks "$@"
        ;;
    --k6)
        run_load_test_k6
        ;;
    --locust)
        run_load_test_locust
        ;;
    --report)
        generate_report
        ;;
    --help|-h)
        print_usage
        ;;
    *)
        # é»˜è®¤è¿è¡Œå•å…ƒæµ‹è¯•
        run_unit_benchmarks
        ;;
esac

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}  æ€§èƒ½æµ‹è¯•å®Œæˆ                         ${NC}"
echo -e "${GREEN}========================================${NC}"
