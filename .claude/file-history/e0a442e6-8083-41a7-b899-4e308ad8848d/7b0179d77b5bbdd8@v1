"""
Locust è´Ÿè½½æµ‹è¯•è„šæœ¬

å®‰è£…: pip install locust
è¿è¡Œ: locust -f tests/performance/locustfile.py --host=http://localhost:8000

Web UI: http://localhost:8089
æ— å¤´æ¨¡å¼: locust -f locustfile.py --headless -u 100 -r 10 -t 5m
"""

import os
import json
import random
from locust import HttpUser, task, between, events
from locust.runners import MasterRunner, WorkerRunner


class VibeLifeUser(HttpUser):
    """æ¨¡æ‹Ÿ VibeLife ç”¨æˆ·è¡Œä¸º"""

    # è¯·æ±‚é—´éš” 1-3 ç§’
    wait_time = between(1, 3)

    # æµ‹è¯• Token
    token = os.getenv("TEST_TOKEN", "test-token-for-load-testing")

    def on_start(self):
        """ç”¨æˆ·å¯åŠ¨æ—¶çš„åˆå§‹åŒ–"""
        self.headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.token}",
        }
        self.skills = ["bazi", "zodiac", "tarot", "career"]

    @task(10)
    def health_check(self):
        """å¥åº·æ£€æŸ¥ - æƒé‡ 10"""
        with self.client.get("/health", catch_response=True) as response:
            if response.status_code == 200:
                data = response.json()
                if data.get("status") == "ok":
                    response.success()
                else:
                    response.failure(f"Health check failed: {data}")
            else:
                response.failure(f"Status code: {response.status_code}")

    @task(5)
    def get_skills_list(self):
        """è·å–æŠ€èƒ½åˆ—è¡¨ - æƒé‡ 5"""
        with self.client.get("/api/v1/skills", catch_response=True) as response:
            if response.status_code == 200:
                data = response.json()
                if isinstance(data, list):
                    response.success()
                else:
                    response.failure("Skills response is not a list")
            else:
                response.failure(f"Status code: {response.status_code}")

    @task(3)
    def get_skill_services(self):
        """è·å–æŠ€èƒ½æœåŠ¡ - æƒé‡ 3"""
        skill = random.choice(self.skills)
        with self.client.get(
            f"/api/v1/skills/{skill}/services",
            name="/api/v1/skills/[skill]/services",
            catch_response=True
        ) as response:
            if response.status_code in [200, 404]:
                response.success()
            else:
                response.failure(f"Status code: {response.status_code}")

    @task(2)
    def get_tools_schema(self):
        """è·å–å·¥å…· Schema - æƒé‡ 2"""
        with self.client.get("/api/v1/tools/schema", catch_response=True) as response:
            if response.status_code == 200:
                response.success()
            else:
                response.failure(f"Status code: {response.status_code}")

    @task(1)
    def call_skill_service(self):
        """è°ƒç”¨æŠ€èƒ½æœåŠ¡ - æƒé‡ 1"""
        payload = {
            "args": {
                "birth_date": "1990-01-15",
                "birth_time": "12:00",
                "gender": "male"
            }
        }
        with self.client.post(
            "/api/v1/skills/bazi/chart",
            json=payload,
            headers=self.headers,
            catch_response=True
        ) as response:
            # å…è®¸ 401 (æœªè®¤è¯) æˆ– 200 æˆ– 404
            if response.status_code in [200, 401, 404]:
                response.success()
            else:
                response.failure(f"Status code: {response.status_code}")


class ChatUser(HttpUser):
    """æ¨¡æ‹ŸèŠå¤©ç”¨æˆ· - ç‹¬ç«‹çš„ç”¨æˆ·ç±»å‹"""

    wait_time = between(3, 5)
    weight = 1  # è¾ƒä½æƒé‡

    token = os.getenv("TEST_TOKEN", "test-token-for-load-testing")

    def on_start(self):
        self.headers = {
            "Content-Type": "application/json",
            "Authorization": f"Bearer {self.token}",
        }
        self.messages = [
            "å¸®æˆ‘çœ‹çœ‹ä»Šå¤©çš„è¿åŠ¿",
            "åˆ†æä¸€ä¸‹æˆ‘çš„å…«å­—",
            "æˆ‘æƒ³äº†è§£æˆ‘çš„æ„Ÿæƒ…è¿",
            "èƒ½å¸®æˆ‘çœ‹çœ‹äº‹ä¸šå‘å±•å—",
            "æµ‹ç®—ä¸€ä¸‹è´¢è¿",
        ]

    @task
    def chat(self):
        """å‘é€èŠå¤©æ¶ˆæ¯"""
        payload = {
            "messages": [
                {"role": "user", "content": random.choice(self.messages)}
            ],
            "skill": "bazi",
            "stream": False,
        }
        with self.client.post(
            "/api/v1/chat",
            json=payload,
            headers=self.headers,
            timeout=30,
            catch_response=True
        ) as response:
            # å…è®¸ 401 (æœªè®¤è¯) æˆ– 200
            if response.status_code in [200, 401]:
                response.success()
            else:
                response.failure(f"Status code: {response.status_code}")


# æµ‹è¯•äº‹ä»¶é’©å­
@events.test_start.add_listener
def on_test_start(environment, **kwargs):
    """æµ‹è¯•å¼€å§‹æ—¶çš„å›è°ƒ"""
    print("\n" + "=" * 50)
    print("ğŸš€ VibeLife è´Ÿè½½æµ‹è¯•å¼€å§‹")
    print(f"   ç›®æ ‡: {environment.host}")
    print("=" * 50 + "\n")


@events.test_stop.add_listener
def on_test_stop(environment, **kwargs):
    """æµ‹è¯•ç»“æŸæ—¶çš„å›è°ƒ"""
    stats = environment.stats

    print("\n" + "=" * 50)
    print("ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»")
    print("=" * 50)

    # æ±‡æ€»ç»Ÿè®¡
    total_requests = stats.total.num_requests
    total_failures = stats.total.num_failures
    error_rate = (total_failures / total_requests * 100) if total_requests > 0 else 0

    print(f"\næ€»è¯·æ±‚æ•°: {total_requests}")
    print(f"å¤±è´¥è¯·æ±‚: {total_failures}")
    print(f"é”™è¯¯ç‡: {error_rate:.2f}%")

    if stats.total.num_requests > 0:
        print(f"\nå¹³å‡å“åº”æ—¶é—´: {stats.total.avg_response_time:.2f} ms")
        print(f"ä¸­ä½æ•°å“åº”æ—¶é—´: {stats.total.median_response_time:.2f} ms")
        print(f"P95 å“åº”æ—¶é—´: {stats.total.get_response_time_percentile(0.95):.2f} ms")
        print(f"P99 å“åº”æ—¶é—´: {stats.total.get_response_time_percentile(0.99):.2f} ms")
        print(f"æœ€å¤§å“åº”æ—¶é—´: {stats.total.max_response_time:.2f} ms")
        print(f"\nååé‡: {stats.total.total_rps:.2f} req/s")

    print("\n" + "=" * 50 + "\n")


# è‡ªå®šä¹‰å‘½ä»¤è¡Œå‚æ•°
@events.init_command_line_parser.add_listener
def add_custom_arguments(parser):
    parser.add_argument(
        "--test-token",
        type=str,
        default="test-token-for-load-testing",
        help="Test authentication token"
    )


@events.init.add_listener
def on_locust_init(environment, **kwargs):
    """åˆå§‹åŒ–æ—¶è®¾ç½®è‡ªå®šä¹‰å‚æ•°"""
    if isinstance(environment.runner, (MasterRunner, WorkerRunner)):
        return

    # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åˆå§‹åŒ–é€»è¾‘
    pass
