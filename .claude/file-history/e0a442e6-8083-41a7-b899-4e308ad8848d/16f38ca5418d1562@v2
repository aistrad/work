"""
Skill Loader 性能基准测试
"""
import pytest
import time
from typing import List


class TestSkillLoaderBenchmark:
    """Skill 加载性能测试"""

    def test_load_skill_cold(self):
        """冷启动加载 Skill - 目标: < 50ms"""
        from services.agent.skill_loader import load_skill
        import importlib
        import services.agent.skill_loader as loader_module

        times: List[float] = []
        skills = ["bazi", "zodiac", "tarot", "career"]

        for skill_id in skills:
            # 重新加载模块强制清除缓存
            importlib.reload(loader_module)

            start = time.perf_counter()
            result = loader_module.load_skill(skill_id)
            elapsed = (time.perf_counter() - start) * 1000
            times.append(elapsed)

            if result:
                print(f"\n  load_skill('{skill_id}') cold: {elapsed:.3f}ms")

        avg_ms = sum(times) / len(times)
        max_ms = max(times)

        print(f"\n  Cold load average: {avg_ms:.3f}ms, max: {max_ms:.3f}ms")

        assert avg_ms < 50, f"Cold load avg {avg_ms:.3f}ms exceeds 50ms target"
        assert max_ms < 100, f"Cold load max {max_ms:.3f}ms exceeds 100ms target"

    def test_load_skill_cached(self):
        """缓存加载 Skill - 目标: < 1ms"""
        from services.agent.skill_loader import load_skill

        # 预热
        load_skill("bazi")

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            load_skill("bazi")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)
        p95_ms = sorted(times)[95]

        print(f"\n  Cached load: avg={avg_ms:.3f}ms, p95={p95_ms:.3f}ms")

        assert avg_ms < 1.0, f"Cached load avg {avg_ms:.3f}ms exceeds 1ms target"
        assert p95_ms < 2.0, f"Cached load p95 {p95_ms:.3f}ms exceeds 2ms target"

    def test_route_scenario(self):
        """场景路由性能 - 目标: < 5ms"""
        from services.agent.skill_loader import route_scenario

        test_messages = [
            "帮我看看我的八字命盘",
            "分析一下我今年的运势",
            "我想了解我的感情运",
            "能帮我看看事业发展吗",
            "测算一下财运",
        ]

        times: List[float] = []
        for msg in test_messages:
            for _ in range(20):
                start = time.perf_counter()
                result = route_scenario("bazi", msg)
                times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)
        p95_ms = sorted(times)[int(len(times) * 0.95)]

        print(f"\n  route_scenario: avg={avg_ms:.3f}ms, p95={p95_ms:.3f}ms")

        assert avg_ms < 5.0, f"Route scenario avg {avg_ms:.3f}ms exceeds 5ms target"
        assert p95_ms < 10.0, f"Route scenario p95 {p95_ms:.3f}ms exceeds 10ms target"

    def test_build_system_prompt(self):
        """构建 System Prompt - 目标: < 10ms"""
        from services.agent.skill_loader import load_skill, build_system_prompt

        skill = load_skill("bazi")
        if not skill:
            pytest.skip("Skill 'bazi' not found")

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            prompt = build_system_prompt("bazi", scenario_id="basic_reading")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)
        p95_ms = sorted(times)[95]

        print(f"\n  build_system_prompt: avg={avg_ms:.3f}ms, p95={p95_ms:.3f}ms")
        print(f"  Prompt length: {len(prompt) if prompt else 0} chars")

        assert avg_ms < 10.0, f"Build prompt avg {avg_ms:.3f}ms exceeds 10ms target"

    def test_get_available_skills(self):
        """获取可用 Skills - 目标: < 5ms"""
        from services.agent.skill_loader import get_available_skills

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            skills = get_available_skills()
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  get_available_skills: avg={avg_ms:.3f}ms")
        print(f"  Available skills: {skills}")

        assert avg_ms < 5.0, f"Get skills avg {avg_ms:.3f}ms exceeds 5ms target"

    def test_get_skill_scenarios(self):
        """获取 Skill 场景列表 - 目标: < 5ms"""
        from services.agent.skill_loader import get_skill_scenarios

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            scenarios = get_skill_scenarios("bazi")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  get_skill_scenarios('bazi'): avg={avg_ms:.3f}ms")
        print(f"  Scenario count: {len(scenarios) if scenarios else 0}")

        assert avg_ms < 5.0, f"Get scenarios avg {avg_ms:.3f}ms exceeds 5ms target"


class TestToolRegistryBenchmark:
    """工具注册表性能测试"""

    @pytest.fixture(autouse=True)
    def setup(self):
        """初始化 ToolRegistry"""
        from services.agent.tool_registry import UnifiedToolRegistry
        UnifiedToolRegistry.initialize()

    def test_has_handler(self):
        """检查工具处理器 - 目标: < 0.1ms"""
        from services.agent.tool_registry import UnifiedToolRegistry

        times: List[float] = []
        for _ in range(1000):
            start = time.perf_counter()
            has_handler = UnifiedToolRegistry.has_handler("show_bazi_chart")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  UnifiedToolRegistry.has_handler: avg={avg_ms:.6f}ms")
        print(f"  Handler found: {has_handler}")

        assert avg_ms < 0.1, f"Has handler avg {avg_ms:.6f}ms exceeds 0.1ms target"

    def test_get_tool_def(self):
        """获取工具定义 - 目标: < 0.1ms"""
        from services.agent.tool_registry import UnifiedToolRegistry

        times: List[float] = []
        for _ in range(1000):
            start = time.perf_counter()
            tool_def = UnifiedToolRegistry.get_tool_def("show_bazi_chart")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  UnifiedToolRegistry.get_tool_def: avg={avg_ms:.6f}ms")
        print(f"  Tool found: {tool_def is not None}")

        assert avg_ms < 0.1, f"Get tool def avg {avg_ms:.6f}ms exceeds 0.1ms target"

    def test_list_handlers(self):
        """列出所有处理器 - 目标: < 1ms"""
        from services.agent.tool_registry import UnifiedToolRegistry

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            handlers = list(UnifiedToolRegistry._handlers.keys())
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  List handlers: avg={avg_ms:.3f}ms")
        print(f"  Handler count: {len(handlers)}")

        assert avg_ms < 1.0, f"List handlers avg {avg_ms:.3f}ms exceeds 1ms target"

    def test_get_all_tools_for_skill(self):
        """获取 Skill 所有工具定义 - 目标: < 5ms"""
        from services.agent.tool_schema import get_all_tools_for_skill

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            tools = get_all_tools_for_skill("bazi")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  get_all_tools_for_skill('bazi'): avg={avg_ms:.3f}ms")
        print(f"  Tool count: {len(tools) if tools else 0}")

        assert avg_ms < 5.0, f"Get tools avg {avg_ms:.3f}ms exceeds 5ms target"

    def test_get_skill_tools_openai(self):
        """获取 OpenAI 格式工具定义 - 目标: < 10ms"""
        from services.agent.tool_schema import get_skill_tools_openai

        times: List[float] = []
        for _ in range(100):
            start = time.perf_counter()
            tools = get_skill_tools_openai("bazi")
            times.append((time.perf_counter() - start) * 1000)

        avg_ms = sum(times) / len(times)

        print(f"\n  get_skill_tools_openai('bazi'): avg={avg_ms:.3f}ms")

        assert avg_ms < 10.0, f"Get OpenAI tools avg {avg_ms:.3f}ms exceeds 10ms target"
