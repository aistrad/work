/**
 * k6 è´Ÿè½½æµ‹è¯•è„šæœ¬
 *
 * å®‰è£…: brew install k6 (macOS) æˆ– apt install k6 (Linux)
 * è¿è¡Œ: k6 run tests/performance/load_test.js
 *
 * è‡ªå®šä¹‰å‚æ•°:
 *   k6 run --env BASE_URL=http://localhost:8000 tests/performance/load_test.js
 */

import http from 'k6/http';
import { check, sleep, group } from 'k6';
import { Rate, Trend } from 'k6/metrics';

// è‡ªå®šä¹‰æŒ‡æ ‡
const errorRate = new Rate('errors');
const healthLatency = new Trend('health_latency');
const skillsLatency = new Trend('skills_latency');
const chatLatency = new Trend('chat_latency');

// æµ‹è¯•é…ç½®
export const options = {
    scenarios: {
        // åœºæ™¯1: å†’çƒŸæµ‹è¯• - éªŒè¯ç³»ç»ŸåŸºæœ¬åŠŸèƒ½
        smoke: {
            executor: 'constant-vus',
            vus: 1,
            duration: '30s',
            startTime: '0s',
            tags: { scenario: 'smoke' },
        },
        // åœºæ™¯2: è´Ÿè½½æµ‹è¯• - æ¨¡æ‹Ÿæ­£å¸¸è´Ÿè½½
        load: {
            executor: 'ramping-vus',
            startVUs: 0,
            stages: [
                { duration: '1m', target: 10 },   // 1åˆ†é’Ÿå†…å‡åˆ°10ç”¨æˆ·
                { duration: '3m', target: 10 },   // ä¿æŒ10ç”¨æˆ·3åˆ†é’Ÿ
                { duration: '1m', target: 20 },   // 1åˆ†é’Ÿå†…å‡åˆ°20ç”¨æˆ·
                { duration: '3m', target: 20 },   // ä¿æŒ20ç”¨æˆ·3åˆ†é’Ÿ
                { duration: '1m', target: 0 },    // 1åˆ†é’Ÿå†…é™åˆ°0
            ],
            startTime: '30s',
            tags: { scenario: 'load' },
        },
        // åœºæ™¯3: å‹åŠ›æµ‹è¯• - æµ‹è¯•ç³»ç»Ÿæé™
        stress: {
            executor: 'ramping-vus',
            startVUs: 0,
            stages: [
                { duration: '2m', target: 50 },   // 2åˆ†é’Ÿå†…å‡åˆ°50ç”¨æˆ·
                { duration: '5m', target: 50 },   // ä¿æŒ50ç”¨æˆ·5åˆ†é’Ÿ
                { duration: '2m', target: 100 },  // 2åˆ†é’Ÿå†…å‡åˆ°100ç”¨æˆ·
                { duration: '5m', target: 100 },  // ä¿æŒ100ç”¨æˆ·5åˆ†é’Ÿ
                { duration: '2m', target: 0 },    // é™å›0
            ],
            startTime: '10m',
            tags: { scenario: 'stress' },
        },
        // åœºæ™¯4: å³°å€¼æµ‹è¯• - æµ‹è¯•çªå‘æµé‡
        spike: {
            executor: 'ramping-vus',
            startVUs: 0,
            stages: [
                { duration: '10s', target: 100 }, // å¿«é€Ÿå‡åˆ°100
                { duration: '1m', target: 100 },  // ä¿æŒ1åˆ†é’Ÿ
                { duration: '10s', target: 0 },   // å¿«é€Ÿé™å›
            ],
            startTime: '26m',
            tags: { scenario: 'spike' },
        },
    },
    thresholds: {
        // é”™è¯¯ç‡ < 1%
        'errors': ['rate<0.01'],
        // å¥åº·æ£€æŸ¥ p95 < 50ms
        'health_latency': ['p(95)<50'],
        // æŠ€èƒ½åˆ—è¡¨ p95 < 200ms
        'skills_latency': ['p(95)<200'],
        // èŠå¤©æ¥å£ p95 < 5000ms (LLM è°ƒç”¨è¾ƒæ…¢)
        'chat_latency': ['p(95)<5000'],
        // æ•´ä½“è¯·æ±‚ p95 < 2000ms
        'http_req_duration': ['p(95)<2000'],
    },
};

const BASE_URL = __ENV.BASE_URL || 'http://localhost:8000';

// æ¨¡æ‹Ÿç”¨æˆ· Token (æµ‹è¯•ç¯å¢ƒ)
const TEST_TOKEN = __ENV.TEST_TOKEN || 'test-token-for-load-testing';

const headers = {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${TEST_TOKEN}`,
};

export default function () {
    // å¥åº·æ£€æŸ¥
    group('Health Check', function () {
        const start = Date.now();
        const res = http.get(`${BASE_URL}/health`);
        healthLatency.add(Date.now() - start);

        const success = check(res, {
            'health status is 200': (r) => r.status === 200,
            'health response is ok': (r) => r.json('status') === 'ok',
        });
        errorRate.add(!success);
    });

    sleep(0.5);

    // æŠ€èƒ½åˆ—è¡¨
    group('Skills List', function () {
        const start = Date.now();
        const res = http.get(`${BASE_URL}/api/v1/skills`);
        skillsLatency.add(Date.now() - start);

        const success = check(res, {
            'skills status is 200': (r) => r.status === 200,
            'skills returns array': (r) => Array.isArray(r.json()),
        });
        errorRate.add(!success);
    });

    sleep(0.5);

    // æŠ€èƒ½æœåŠ¡åˆ—è¡¨
    group('Skill Services', function () {
        const skills = ['bazi', 'zodiac', 'tarot', 'career'];
        const skill = skills[Math.floor(Math.random() * skills.length)];

        const res = http.get(`${BASE_URL}/api/v1/skills/${skill}/services`);

        const success = check(res, {
            'services status is 200 or 404': (r) => r.status === 200 || r.status === 404,
        });
        errorRate.add(!success);
    });

    sleep(0.5);

    // å·¥å…· Schema
    group('Tools Schema', function () {
        const res = http.get(`${BASE_URL}/api/v1/tools/schema`);

        const success = check(res, {
            'schema status is 200': (r) => r.status === 200,
        });
        errorRate.add(!success);
    });

    sleep(1);
}

// æ¨¡æ‹ŸèŠå¤©åœºæ™¯ (å•ç‹¬çš„è™šæ‹Ÿç”¨æˆ·)
export function chatScenario() {
    group('Chat API', function () {
        const payload = JSON.stringify({
            messages: [
                { role: 'user', content: 'å¸®æˆ‘çœ‹çœ‹ä»Šå¤©çš„è¿åŠ¿' }
            ],
            skill: 'bazi',
            stream: false,
        });

        const start = Date.now();
        const res = http.post(`${BASE_URL}/api/v1/chat`, payload, { headers });
        chatLatency.add(Date.now() - start);

        const success = check(res, {
            'chat status is 200 or 401': (r) => r.status === 200 || r.status === 401,
        });
        errorRate.add(!success);
    });

    sleep(2);
}

// æµ‹è¯•ç»“æŸæ—¶çš„æ±‡æ€»
export function handleSummary(data) {
    return {
        'stdout': textSummary(data, { indent: ' ', enableColors: true }),
        'tests/performance/k6_results.json': JSON.stringify(data, null, 2),
    };
}

function textSummary(data, options) {
    const { metrics } = data;
    let output = '\n========== æ€§èƒ½æµ‹è¯•æŠ¥å‘Š ==========\n\n';

    output += 'ğŸ“Š å…³é”®æŒ‡æ ‡:\n';
    output += `  å¥åº·æ£€æŸ¥å»¶è¿Ÿ (p95): ${metrics.health_latency?.values?.['p(95)']?.toFixed(2) || 'N/A'} ms\n`;
    output += `  æŠ€èƒ½åˆ—è¡¨å»¶è¿Ÿ (p95): ${metrics.skills_latency?.values?.['p(95)']?.toFixed(2) || 'N/A'} ms\n`;
    output += `  èŠå¤©å»¶è¿Ÿ (p95): ${metrics.chat_latency?.values?.['p(95)']?.toFixed(2) || 'N/A'} ms\n`;
    output += `  é”™è¯¯ç‡: ${((metrics.errors?.values?.rate || 0) * 100).toFixed(2)}%\n`;

    output += '\nğŸ“ˆ HTTP è¯·æ±‚ç»Ÿè®¡:\n';
    output += `  æ€»è¯·æ±‚æ•°: ${metrics.http_reqs?.values?.count || 0}\n`;
    output += `  å¹³å‡å»¶è¿Ÿ: ${metrics.http_req_duration?.values?.avg?.toFixed(2) || 'N/A'} ms\n`;
    output += `  P95 å»¶è¿Ÿ: ${metrics.http_req_duration?.values?.['p(95)']?.toFixed(2) || 'N/A'} ms\n`;
    output += `  P99 å»¶è¿Ÿ: ${metrics.http_req_duration?.values?.['p(99)']?.toFixed(2) || 'N/A'} ms\n`;

    output += '\n=====================================\n';

    return output;
}
