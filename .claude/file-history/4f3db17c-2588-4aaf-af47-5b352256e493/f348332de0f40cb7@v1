/**
 * ShowCard - 统一卡片渲染器 (V7)
 *
 * 根据 card_type 渲染对应的视图组件:
 * - 通用视图类型: list, tree, table, timeline, form, select, chart, progress, counter, modal, toast
 * - 自定义卡片: custom + componentId
 */

import React from 'react';
import {
  ListView,
  TreeView,
  TableView,
  Timeline,
  FormView,
  SelectView,
  ChartView,
  ProgressView,
  CounterView,
  ModalView,
  ToastView,
} from './views';
import { getCard } from '../CardRegistry';

// 通用视图类型
const GENERIC_CARD_TYPES = [
  'list',
  'tree',
  'table',
  'timeline',
  'form',
  'select',
  'chart',
  'progress',
  'counter',
  'modal',
  'toast',
  'custom',
] as const;

type GenericCardType = typeof GENERIC_CARD_TYPES[number];

interface ShowCardProps {
  cardType: string;
  data?: any;
  items?: any[];
  nodes?: any[];
  events?: any[];
  fields?: any[];
  values?: Record<string, any>;
  options?: Record<string, any>;
  componentId?: string;
  onAction?: (action: string, payload?: any) => void;
  className?: string;
  [key: string]: any;
}

const isGenericType = (type: string): type is GenericCardType => {
  return GENERIC_CARD_TYPES.includes(type as GenericCardType);
};

export const ShowCard: React.FC<ShowCardProps> = ({
  cardType,
  data,
  items,
  nodes,
  events,
  fields,
  values,
  options = {},
  componentId,
  onAction,
  className = '',
  ...rest
}) => {
  // 处理通用视图类型
  if (isGenericType(cardType)) {
    switch (cardType) {
      case 'list':
        return (
          <ListView
            items={items || data || []}
            emptyText={options.emptyText}
            showIndex={options.showIndex}
            onItemClick={(item) => onAction?.('item_click', item)}
            className={className}
          />
        );

      case 'tree':
        return (
          <TreeView
            nodes={nodes || data || []}
            expandLevel={options.expandLevel}
            showProgress={options.showProgress}
            onNodeClick={(node) => onAction?.('node_click', node)}
            className={className}
          />
        );

      case 'table':
        return (
          <TableView
            columns={options.columns || []}
            rows={data || []}
            sortable={options.sortable}
            pagination={options.pagination}
            emptyText={options.emptyText}
            onRowClick={(row, index) => onAction?.('row_click', { row, index })}
            className={className}
          />
        );

      case 'timeline':
        return (
          <Timeline
            events={events || data || []}
            direction={options.direction}
            emptyText={options.emptyText}
            onEventClick={(event) => onAction?.('event_click', event)}
            className={className}
          />
        );

      case 'form':
        return (
          <FormView
            fields={fields || options.fields || []}
            values={values || data || {}}
            submitLabel={options.submitLabel}
            cancelLabel={options.cancelLabel}
            onSubmit={(formValues) => onAction?.('submit', formValues)}
            onCancel={() => onAction?.('cancel')}
            onChange={(formValues) => onAction?.('change', formValues)}
            className={className}
          />
        );

      case 'select':
        return (
          <SelectView
            options={data || options.options || []}
            value={values?.selected || options.value}
            multiple={options.multiple}
            searchable={options.searchable}
            placeholder={options.placeholder}
            emptyText={options.emptyText}
            onChange={(value) => onAction?.('select', value)}
            className={className}
          />
        );

      case 'chart':
        return (
          <ChartView
            chartType={options.chartType || 'line'}
            data={data || []}
            series={options.series}
            xAxis={options.xAxis}
            yAxis={options.yAxis}
            colors={options.colors}
            height={options.height}
            showLegend={options.showLegend}
            showGrid={options.showGrid}
            className={className}
          />
        );

      case 'progress':
        return (
          <ProgressView
            value={typeof data === 'number' ? data : options.value || 0}
            max={options.max}
            label={options.label}
            showPercentage={options.showPercentage}
            size={options.size}
            color={options.color}
            variant={options.variant}
            className={className}
          />
        );

      case 'counter':
        return (
          <CounterView
            value={data ?? options.value ?? 0}
            label={options.label}
            prefix={options.prefix}
            suffix={options.suffix}
            trend={options.trend}
            trendValue={options.trendValue}
            size={options.size}
            className={className}
          />
        );

      case 'modal':
        return (
          <ModalView
            isOpen={options.isOpen ?? true}
            title={options.title}
            content={data || options.content}
            actions={options.actions}
            closable={options.closable}
            size={options.size}
            onClose={() => onAction?.('close')}
            className={className}
          />
        );

      case 'toast':
        return (
          <ToastView
            message={typeof data === 'string' ? data : options.message || ''}
            type={options.type}
            duration={options.duration}
            isVisible={options.isVisible}
            position={options.position}
            onClose={() => onAction?.('close')}
            className={className}
          />
        );

      case 'custom':
        // 自定义组件通过 componentId 查找
        // V7: 兼容 ToolCardRenderer 传递的嵌套结构 { data: toolData }
        // toolData 包含 { cardType, componentId, data, options }
        const nestedData = data as Record<string, any> | undefined;
        const customComponentId =
          componentId ||
          options?.componentId ||
          nestedData?.componentId ||
          nestedData?.options?.componentId;

        if (!customComponentId) {
          console.warn('ShowCard: custom type requires componentId');
          return null;
        }

        const CustomComponent = getCard(customComponentId);
        if (!CustomComponent) {
          console.warn(`ShowCard: component not found: ${customComponentId}`);
          return null;
        }

        // V7: 提取实际的卡片数据（可能在 data.data 或 data.props 中）
        const actualCardData = nestedData?.data || nestedData?.props || data;
        const actualOptions = nestedData?.options || options;

        return (
          <CustomComponent
            data={actualCardData}
            options={actualOptions}
            onAction={onAction}
            className={className}
            {...rest}
          />
        );

      default:
        return null;
    }
  }

  // 非通用类型，尝试从 CardRegistry 获取
  const RegisteredComponent = getCard(cardType);
  if (RegisteredComponent) {
    return (
      <RegisteredComponent
        data={data}
        items={items}
        nodes={nodes}
        events={events}
        fields={fields}
        values={values}
        options={options}
        onAction={onAction}
        className={className}
        {...rest}
      />
    );
  }

  console.warn(`ShowCard: unknown card type: ${cardType}`);
  return null;
};

export default ShowCard;
