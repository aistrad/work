"""
JungAstro Skill 工具执行器

架构说明：
- 复用 zodiac skill 的计算服务 (ZodiacCalculator)
- 添加荣格心理学解读层 (JungianInterpreter)
- 定义独立的卡片类型 (jungastro_*)

跨 Skill 调用方式：
- 不直接调用 zodiac 的工具
- 而是在服务层导入 zodiac 的计算器
- 这样保��工具的独立性，同时复用计算逻辑
"""

import logging
from typing import Dict, Any, Optional

from services.agent.tool_registry import tool_handler, ToolContext

logger = logging.getLogger(__name__)


# ═══════════════════════════════════════════════════════════════════════════════
# 服务层导入 - 复用 zodiac 计算能力
# ═══════════════════════════════════════════════════════════════════════════════

def get_zodiac_calculator():
    """延迟导入 zodiac 计算器，避免循环依赖"""
    try:
        from skills.zodiac.services.calculator import ZodiacCalculator
        return ZodiacCalculator()
    except ImportError:
        logger.warning("ZodiacCalculator not available, using fallback")
        return None


def get_jungian_interpreter():
    """获取荣格心理解读器"""
    try:
        from skills.jungastro.services.interpreter import JungianInterpreter
        return JungianInterpreter()
    except ImportError:
        logger.warning("JungianInterpreter not available")
        return None


# ════════════════════════════════���══════════════════════════════════════════════
# 工具执行器
# ═══════════════════════════════════════════════════════════════════════════════

@tool_handler("show_psychological_portrait")
async def handle_show_psychological_portrait(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    展示心理画像 - V7 委托模式

    复用 zodiac 计算器获取星盘数据，
    然后用 JungianInterpreter 进行心理学解读。
    """
    from services.agent.tool_registry import ToolRegistry

    focus = args.get("focus", "full")

    calculator = get_zodiac_calculator()
    interpreter = get_jungian_interpreter()

    if not calculator:
        return {"status": "error", "error": "星盘计算服务不可用"}

    # 1. 获取用户星盘数据 (复用 zodiac 计算)
    chart_data = await calculator.get_natal_chart(context.user_id)

    if not chart_data:
        return {
            "status": "error",
            "error": "需要出生信息",
            "action": "collect_birth_info"
        }

    # 2. 荣格心理解读
    portrait = {
        "ego": _analyze_ego(chart_data),           # 太阳分析
        "unconscious": _analyze_unconscious(chart_data),  # 月亮分析
        "persona": _analyze_persona(chart_data),   # 上升分析
        "functions": _analyze_functions(chart_data),  # 功能分布
    }

    # 3. 如果有解读器，使用更深度的分析
    if interpreter:
        portrait = interpreter.analyze_psychological_portrait(chart_data, focus)

    logger.info(f"Showing psychological portrait via show_card for user {context.user_id}")

    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {"type": "inline", "data": portrait},
            "options": {"componentId": "jungastro_portrait"}
        },
        context
    )


@tool_handler("show_shadow_analysis")
async def handle_show_shadow_analysis(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    展示阴影分析

    分析困难相位、冥王星配置、12宫内容等。
    """
    aspect = args.get("aspect")
    planet = args.get("planet")

    calculator = get_zodiac_calculator()

    if not calculator:
        return {"error": "星盘计算服务不可用"}

    chart_data = await calculator.get_natal_chart(context.user_id)

    if not chart_data:
        return {
            "error": "需要出生信息",
            "action": "collect_birth_info"
        }

    shadow = {
        "difficult_aspects": _find_difficult_aspects(chart_data),
        "pluto_analysis": _analyze_pluto(chart_data),
        "twelfth_house": _analyze_twelfth_house(chart_data),
        "saturn_analysis": _analyze_saturn(chart_data),
        "shadow_patterns": [],
        "integration_path": ""
    }

    return {
        "card_type": "jungastro_shadow",
        "data": shadow
    }


@tool_handler("show_individuation_path")
async def handle_show_individuation_path(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    展示个体化路径

    分析土星周期、外行星行运、成长方向。
    """
    cycle = args.get("cycle", "current")

    calculator = get_zodiac_calculator()

    if not calculator:
        return {"error": "星盘计算服务不可用"}

    chart_data = await calculator.get_natal_chart(context.user_id)
    current_transits = await calculator.get_current_transits()

    if not chart_data:
        return {
            "error": "需要出生信息",
            "action": "collect_birth_info"
        }

    # 计算用户年龄
    birth_date = chart_data.get("birth_date")
    age = _calculate_age(birth_date) if birth_date else None

    individuation = {
        "current_stage": _determine_life_stage(age),
        "saturn_cycle": _analyze_saturn_cycle(chart_data, age),
        "outer_planet_transits": _analyze_outer_transits(chart_data, current_transits),
        "growth_direction": "",
        "integration_tasks": []
    }

    return {
        "card_type": "jungastro_individuation",
        "data": individuation
    }


@tool_handler("show_psychological_functions")
async def handle_show_psychological_functions(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    展示心理功能分布

    分析元素分布、模式分布、主导/劣势功能。
    """
    view = args.get("view", "full")

    calculator = get_zodiac_calculator()

    if not calculator:
        return {"error": "星盘计算服务不可用"}

    chart_data = await calculator.get_natal_chart(context.user_id)

    if not chart_data:
        return {
            "error": "需要出生信息",
            "action": "collect_birth_info"
        }

    functions = _analyze_functions(chart_data)

    return {
        "card_type": "jungastro_functions",
        "data": functions
    }


@tool_handler("show_relationship_dynamics")
async def handle_show_relationship_dynamics(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    展示关系动力学

    分析7宫、金星火星配置、投射模式。
    """
    partner_birth_date = args.get("partner_birth_date")
    partner_birth_time = args.get("partner_birth_time")
    partner_birth_location = args.get("partner_birth_location")

    calculator = get_zodiac_calculator()

    if not calculator:
        return {"error": "星盘计算服务不可用"}

    chart_data = await calculator.get_natal_chart(context.user_id)

    if not chart_data:
        return {
            "error": "需要出生信息",
            "action": "collect_birth_info"
        }

    # 如果有对方信息，计算合盘
    partner_chart = None
    if partner_birth_date:
        partner_chart = calculator.calculate_chart(
            partner_birth_date,
            partner_birth_time,
            partner_birth_location
        )

    dynamics = {
        "seventh_house": _analyze_seventh_house(chart_data),
        "venus_mars": _analyze_venus_mars(chart_data),
        "projection_patterns": _identify_projections(chart_data),
        "synastry": _analyze_synastry(chart_data, partner_chart) if partner_chart else None
    }

    return {
        "card_type": "jungastro_relationship",
        "data": dynamics
    }


# ═══════════════════════════════════════════════════════════════════════════════
# 辅助函数 - 心理学分析
# ═══════════════════════════════════════════════════════════════════════════════

def _analyze_ego(chart_data: Dict) -> Dict:
    """分析核心自我 (太阳)"""
    sun = chart_data.get("sun", {})
    return {
        "planet": "sun",
        "sign": sun.get("sign"),
        "house": sun.get("house"),
        "psychological_meaning": "核心自我认同、意识中心、人生目的感",
        "expression": "",  # 由 LLM 填充
        "integration_state": "",
        "blocked_state": ""
    }


def _analyze_unconscious(chart_data: Dict) -> Dict:
    """分析情感需求 (月亮)"""
    moon = chart_data.get("moon", {})
    return {
        "planet": "moon",
        "sign": moon.get("sign"),
        "house": moon.get("house"),
        "psychological_meaning": "情感本能、无意识模式、安全需求",
        "expression": "",
        "nurturing_needs": ""
    }


def _analyze_persona(chart_data: Dict) -> Dict:
    """分析人格面具 (上升)"""
    ascendant = chart_data.get("ascendant", {})
    return {
        "sign": ascendant.get("sign"),
        "psychological_meaning": "面对世界的方式、第一印象、适应策略",
        "expression": "",
        "relationship_to_ego": ""
    }


def _analyze_functions(chart_data: Dict) -> Dict:
    """分析心理功能分布"""
    planets = chart_data.get("planets", [])

    # 元素计数
    elements = {"fire": 0, "earth": 0, "air": 0, "water": 0}
    modalities = {"cardinal": 0, "fixed": 0, "mutable": 0}

    element_map = {
        "aries": "fire", "leo": "fire", "sagittarius": "fire",
        "taurus": "earth", "virgo": "earth", "capricorn": "earth",
        "gemini": "air", "libra": "air", "aquarius": "air",
        "cancer": "water", "scorpio": "water", "pisces": "water"
    }

    modality_map = {
        "aries": "cardinal", "cancer": "cardinal", "libra": "cardinal", "capricorn": "cardinal",
        "taurus": "fixed", "leo": "fixed", "scorpio": "fixed", "aquarius": "fixed",
        "gemini": "mutable", "virgo": "mutable", "sagittarius": "mutable", "pisces": "mutable"
    }

    for planet in planets:
        sign = planet.get("sign", "").lower()
        if sign in element_map:
            elements[element_map[sign]] += 1
        if sign in modality_map:
            modalities[modality_map[sign]] += 1

    # 确定主导和劣势功能
    dominant_element = max(elements, key=elements.get)
    inferior_element = min(elements, key=elements.get)

    return {
        "elements": elements,
        "modalities": modalities,
        "dominant_function": dominant_element,
        "inferior_function": inferior_element,
        "balance_suggestions": []
    }


def _find_difficult_aspects(chart_data: Dict) -> list:
    """找出困难相位 (刑相、对冲)"""
    aspects = chart_data.get("aspects", [])
    difficult = []

    for aspect in aspects:
        aspect_type = aspect.get("type", "").lower()
        if aspect_type in ["square", "opposition"]:
            difficult.append({
                "planet1": aspect.get("planet1"),
                "planet2": aspect.get("planet2"),
                "type": aspect_type,
                "orb": aspect.get("orb"),
                "psychological_tension": ""
            })

    return difficult


def _analyze_pluto(chart_data: Dict) -> Dict:
    """分析冥王星配置"""
    pluto = None
    for planet in chart_data.get("planets", []):
        if planet.get("name", "").lower() == "pluto":
            pluto = planet
            break

    if not pluto:
        return {}

    return {
        "sign": pluto.get("sign"),
        "house": pluto.get("house"),
        "shadow_domain": "",
        "deep_fear": "",
        "transformation_potential": "",
        "integration_suggestions": []
    }


def _analyze_saturn(chart_data: Dict) -> Dict:
    """分析土星配置"""
    saturn = None
    for planet in chart_data.get("planets", []):
        if planet.get("name", "").lower() == "saturn":
            saturn = planet
            break

    if not saturn:
        return {}

    return {
        "sign": saturn.get("sign"),
        "house": saturn.get("house"),
        "fear_domain": "",
        "inner_authority": "",
        "maturation_task": "",
        "integration_suggestions": []
    }


def _analyze_twelfth_house(chart_data: Dict) -> Dict:
    """分析12宫内容"""
    planets_in_12th = []
    for planet in chart_data.get("planets", []):
        if planet.get("house") == 12:
            planets_in_12th.append(planet.get("name"))

    return {
        "planets": planets_in_12th,
        "hidden_energies": "",
        "unconscious_patterns": "",
        "integration_direction": ""
    }


def _calculate_age(birth_date: str) -> Optional[int]:
    """计算年龄"""
    from datetime import datetime
    try:
        birth = datetime.strptime(birth_date, "%Y-%m-%d")
        today = datetime.now()
        age = today.year - birth.year
        if (today.month, today.day) < (birth.month, birth.day):
            age -= 1
        return age
    except:
        return None


def _determine_life_stage(age: Optional[int]) -> Dict:
    """确定人生阶段"""
    if age is None:
        return {"name": "unknown", "description": ""}

    if age < 29:
        return {
            "name": "pre_saturn_return",
            "description": "探索身份期",
            "key_task": "探索自我、建立身份认同"
        }
    elif 28 <= age <= 30:
        return {
            "name": "first_saturn_return",
            "description": "第一次土星回归",
            "key_task": "承担责任、成为真正的成年人"
        }
    elif 30 < age < 40:
        return {
            "name": "building_phase",
            "description": "建设期",
            "key_task": "建立事业和家庭"
        }
    elif 40 <= age <= 44:
        return {
            "name": "uranus_opposition",
            "description": "中年觉醒期",
            "key_task": "重新评估人生、打破旧模式"
        }
    elif 44 < age < 50:
        return {
            "name": "integration_phase",
            "description": "整合期",
            "key_task": "整合人生经验"
        }
    elif 49 <= age <= 51:
        return {
            "name": "chiron_return",
            "description": "凯龙回归",
            "key_task": "接受伤痛、成为疗愈者"
        }
    elif 57 <= age <= 60:
        return {
            "name": "second_saturn_return",
            "description": "第二次土星回归",
            "key_task": "传承智慧、成为长者"
        }
    else:
        return {
            "name": "elder_phase",
            "description": "智慧长者期",
            "key_task": "灵性深化、传承"
        }


def _analyze_saturn_cycle(chart_data: Dict, age: Optional[int]) -> Dict:
    """分析土星周期"""
    saturn = _analyze_saturn(chart_data)
    return {
        "natal_saturn": saturn,
        "current_age": age,
        "cycle_phase": _determine_life_stage(age).get("name"),
        "life_lesson": ""
    }


def _analyze_outer_transits(chart_data: Dict, transits: Dict) -> list:
    """分析外行星行运"""
    # 简化实现，实际需要更复杂的计算
    return []


def _analyze_seventh_house(chart_data: Dict) -> Dict:
    """分析7宫"""
    houses = chart_data.get("houses", {})
    seventh = houses.get("7", {})

    planets_in_7th = []
    for planet in chart_data.get("planets", []):
        if planet.get("house") == 7:
            planets_in_7th.append(planet.get("name"))

    return {
        "sign": seventh.get("sign"),
        "planets": planets_in_7th,
        "relationship_seeking": "",
        "projection_tendency": "",
        "integration_direction": ""
    }


def _analyze_venus_mars(chart_data: Dict) -> Dict:
    """分析金星火星配置"""
    venus = None
    mars = None

    for planet in chart_data.get("planets", []):
        name = planet.get("name", "").lower()
        if name == "venus":
            venus = planet
        elif name == "mars":
            mars = planet

    return {
        "venus": {
            "sign": venus.get("sign") if venus else None,
            "house": venus.get("house") if venus else None,
            "love_style": ""
        },
        "mars": {
            "sign": mars.get("sign") if mars else None,
            "house": mars.get("house") if mars else None,
            "desire_style": ""
        },
        "venus_mars_aspect": None,  # 需要从 aspects 中查找
        "dynamics": ""
    }


def _identify_projections(chart_data: Dict) -> list:
    """识别投射模式"""
    projections = []

    # 下降点分析
    descendant = chart_data.get("descendant", {})
    if descendant.get("sign"):
        projections.append({
            "source": "descendant",
            "sign": descendant.get("sign"),
            "projected_qualities": "",
            "integration_suggestion": ""
        })

    return projections


def _analyze_synastry(chart1: Dict, chart2: Dict) -> Dict:
    """分析合盘心理动力"""
    if not chart2:
        return None

    return {
        "attraction_sources": [],
        "growth_opportunities": [],
        "potential_challenges": [],
        "suggestions": []
    }
