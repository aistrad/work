/**
 * Skill Registry Tests
 *
 * Tests for the central skill registration and management system
 */

import { describe, it, expect, beforeEach } from "vitest";
import {
  skillRegistry,
  getSkillConfig,
  getSkillTheme,
  getSkillTools,
  getSkillPanels,
} from "@/skills/registry";
import { isValidSkillId, SKILL_IDS, type SkillId } from "@/skills/types";

describe("Skill Registry", () => {
  describe("isValidSkillId", () => {
    it("should return true for valid skill IDs", () => {
      expect(isValidSkillId("bazi")).toBe(true);
      expect(isValidSkillId("zodiac")).toBe(true);
    });

    it("should return false for invalid skill IDs", () => {
      expect(isValidSkillId("invalid")).toBe(false);
      expect(isValidSkillId("")).toBe(false);
      expect(isValidSkillId("BAZI")).toBe(false);
    });
  });

  describe("SKILL_IDS constant", () => {
    it("should contain expected skill IDs", () => {
      expect(SKILL_IDS).toContain("bazi");
      expect(SKILL_IDS).toContain("zodiac");
      expect(SKILL_IDS).toContain("mbti");
      expect(SKILL_IDS).toContain("tarot");
    });

    it("should be a readonly array", () => {
      expect(Array.isArray(SKILL_IDS)).toBe(true);
      expect(SKILL_IDS.length).toBeGreaterThan(0);
    });
  });

  describe("skillRegistry.getAll()", () => {
    it("should return array of all registered skills", () => {
      const skills = skillRegistry.getAll();
      expect(Array.isArray(skills)).toBe(true);
      expect(skills.length).toBeGreaterThan(0);
    });

    it("should include bazi and zodiac skills", () => {
      const skills = skillRegistry.getAll();
      const skillIds = skills.map((s) => s.id);
      expect(skillIds).toContain("bazi");
      expect(skillIds).toContain("zodiac");
    });
  });

  describe("skillRegistry.get()", () => {
    it("should return skill by ID", () => {
      const bazi = skillRegistry.get("bazi");
      expect(bazi).toBeDefined();
      expect(bazi?.id).toBe("bazi");
      expect(bazi?.name).toBe("八字命理");
    });

    it("should return undefined for unregistered skill", () => {
      // Cast to any to test invalid ID
      const invalid = skillRegistry.get("invalid" as SkillId);
      expect(invalid).toBeUndefined();
    });
  });

  describe("skillRegistry.getEnabled()", () => {
    it("should return only enabled skills", () => {
      const enabled = skillRegistry.getEnabled();
      expect(enabled.every((s) => s.enabled)).toBe(true);
    });
  });

  describe("skillRegistry.isEnabled()", () => {
    it("should return true for enabled skills", () => {
      expect(skillRegistry.isEnabled("bazi")).toBe(true);
      expect(skillRegistry.isEnabled("zodiac")).toBe(true);
    });

    it("should return false for non-existent skills", () => {
      expect(skillRegistry.isEnabled("invalid" as SkillId)).toBe(false);
    });
  });

  describe("getSkillConfig()", () => {
    it("should return complete skill configuration", () => {
      const config = getSkillConfig("bazi");
      expect(config).toBeDefined();
      expect(config?.id).toBe("bazi");
      expect(config?.theme).toBeDefined();
      expect(config?.features).toBeDefined();
    });
  });

  describe("getSkillTheme()", () => {
    it("should return skill theme", () => {
      const theme = getSkillTheme("bazi");
      expect(theme).toBeDefined();
      expect(theme?.primary).toBeDefined();
      expect(theme?.secondary).toBeDefined();
      expect(theme?.glow).toBeDefined();
      expect(theme?.gradient).toBeDefined();
    });

    it("should return undefined for non-existent skill", () => {
      const theme = getSkillTheme("invalid" as SkillId);
      expect(theme).toBeUndefined();
    });
  });
});

describe("Skill Panels", () => {
  describe("skillRegistry.getSkillPanels()", () => {
    it("should return skill-specific panels", () => {
      const panels = skillRegistry.getSkillPanels("bazi");
      expect(Array.isArray(panels)).toBe(true);
    });
  });

  describe("skillRegistry.getAllPanels()", () => {
    it("should return merged panels (shared + skill-specific)", () => {
      const panels = skillRegistry.getAllPanels("bazi");
      expect(Array.isArray(panels)).toBe(true);
      expect(panels.length).toBeGreaterThan(0);
    });

    it("should include shared panels", () => {
      const panels = skillRegistry.getAllPanels("bazi");
      const panelIds = panels.map((p) => p.id);
      expect(panelIds).toContain("chat");
      expect(panelIds).toContain("me");
    });

    it("should sort panels by order", () => {
      const panels = skillRegistry.getAllPanels("bazi");
      for (let i = 1; i < panels.length; i++) {
        const prevOrder = panels[i - 1].order ?? 50;
        const currOrder = panels[i].order ?? 50;
        expect(currOrder).toBeGreaterThanOrEqual(prevOrder);
      }
    });

    it("should return shared panels for non-existent skill", () => {
      const panels = skillRegistry.getAllPanels("invalid" as SkillId);
      expect(Array.isArray(panels)).toBe(true);
    });
  });

  describe("getSkillPanels()", () => {
    it("should return all panels for skill", () => {
      const panels = getSkillPanels("bazi");
      expect(Array.isArray(panels)).toBe(true);
    });
  });
});

describe("Skill Tools", () => {
  describe("skillRegistry.getSkillTools()", () => {
    it("should return skill-specific tools", () => {
      const tools = skillRegistry.getSkillTools("bazi");
      expect(Array.isArray(tools)).toBe(true);
    });
  });

  describe("skillRegistry.getAllTools()", () => {
    it("should return merged tools (shared + skill-specific)", () => {
      const tools = skillRegistry.getAllTools("bazi");
      expect(Array.isArray(tools)).toBe(true);
    });

    it("should return shared tools for non-existent skill", () => {
      const tools = skillRegistry.getAllTools("invalid" as SkillId);
      expect(Array.isArray(tools)).toBe(true);
    });
  });

  describe("skillRegistry.getTool()", () => {
    it("should return tool by name", () => {
      const tools = skillRegistry.getAllTools("bazi");
      if (tools.length > 0) {
        const tool = skillRegistry.getTool(tools[0].name);
        expect(tool).toBeDefined();
        expect(tool?.name).toBe(tools[0].name);
      }
    });

    it("should return undefined for non-existent tool", () => {
      const tool = skillRegistry.getTool("non_existent_tool");
      expect(tool).toBeUndefined();
    });
  });

  describe("getSkillTools()", () => {
    it("should return all tools for skill", () => {
      const tools = getSkillTools("bazi");
      expect(Array.isArray(tools)).toBe(true);
    });
  });
});

describe("BaZi Skill Plugin", () => {
  const bazi = skillRegistry.get("bazi");

  it("should be defined and enabled", () => {
    expect(bazi).toBeDefined();
    expect(bazi?.enabled).toBe(true);
  });

  it("should have correct basic info", () => {
    expect(bazi?.id).toBe("bazi");
    expect(bazi?.name).toBe("八字命理");
    expect(bazi?.subtitle).toBeDefined();
    expect(bazi?.icon).toBeDefined();
  });

  it("should have theme configuration", () => {
    expect(bazi?.theme).toBeDefined();
    expect(bazi?.theme.primary).toMatch(/^#[0-9A-Fa-f]{6}$/);
    expect(bazi?.theme.secondary).toMatch(/^#[0-9A-Fa-f]{6}$/);
  });

  it("should have features configuration", () => {
    expect(bazi?.features).toBeDefined();
    expect(Array.isArray(bazi?.features.quickPrompts)).toBe(true);
    expect(bazi?.features.quickPrompts.length).toBeGreaterThan(0);
    expect(bazi?.features.emptyState).toBeDefined();
  });

  it("should have input form configuration", () => {
    expect(bazi?.inputForm).toBeDefined();
    expect(Array.isArray(bazi?.inputForm?.fields)).toBe(true);
    expect(bazi?.inputForm?.required).toContain("birthDate");
  });

  it("should have all shared features enabled", () => {
    expect(bazi?.sharedFeatures?.report).toBe(true);
    expect(bazi?.sharedFeatures?.relationship).toBe(true);
    expect(bazi?.sharedFeatures?.greeting).toBe(true);
    expect(bazi?.sharedFeatures?.interview).toBe(true);
    expect(bazi?.sharedFeatures?.kline).toBe(true);
  });
});

describe("Zodiac Skill Plugin", () => {
  const zodiac = skillRegistry.get("zodiac");

  it("should be defined and enabled", () => {
    expect(zodiac).toBeDefined();
    expect(zodiac?.enabled).toBe(true);
  });

  it("should have correct basic info", () => {
    expect(zodiac?.id).toBe("zodiac");
    expect(zodiac?.name).toBeDefined();
    expect(zodiac?.icon).toBeDefined();
  });

  it("should have theme configuration", () => {
    expect(zodiac?.theme).toBeDefined();
    expect(zodiac?.theme.primary).toBeDefined();
    expect(zodiac?.theme.gradient).toBeDefined();
  });
});
