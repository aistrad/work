"""
Onboarding API Routes Tests

Tests for:
- POST /api/v1/onboarding/calculate-bazi
- GET /api/v1/onboarding/personas
- POST /api/v1/onboarding/generate-letter
- GET /api/v1/onboarding/daily-greeting
- GET /api/v1/onboarding/today-fortune
"""

import pytest
from unittest.mock import Mock, patch, AsyncMock
from fastapi.testclient import TestClient


@pytest.fixture
def mock_services():
    """Mock all onboarding services"""
    with patch("routes.onboarding.get_bazi_calculator") as mock_bazi, \
         patch("routes.onboarding.get_persona_service") as mock_persona, \
         patch("routes.onboarding.get_letter_service") as mock_letter, \
         patch("routes.onboarding.get_push_service") as mock_push:

        # Mock Bazi calculator
        bazi_calculator = Mock()
        bazi_calculator.calculate.return_value = {
            "year_pillar": {"stem": "甲", "branch": "午"},
            "month_pillar": {"stem": "乙", "branch": "巳"},
            "day_pillar": {"stem": "丙", "branch": "寅"},
            "hour_pillar": {"stem": "丁", "branch": "卯"},
            "day_master": "丙",
            "day_master_element": "火",
        }
        mock_bazi.return_value = bazi_calculator

        # Mock Persona service
        persona_service = Mock()
        persona_service.get_all_personas.return_value = [
            {"type": "warm", "name": "温暖型", "description": "温柔治愈"},
            {"type": "sarcastic", "name": "毒舌型", "description": "犀利幽默"},
            {"type": "mentor", "name": "导师型", "description": "理性分析"},
        ]
        mock_persona.return_value = persona_service

        # Mock Letter service
        letter_service = Mock()
        letter_service.generate_letter = AsyncMock(return_value="亲爱的你，来自未来的信...")
        mock_letter.return_value = letter_service

        # Mock Push service
        push_service = Mock()
        greeting_result = Mock()
        greeting_result.greeting = "早安！新的一天开始了"
        greeting_result.fortune_score = 85
        greeting_result.lucky_color = "红色"
        greeting_result.lucky_number = 7
        greeting_result.advice = "今天适合主动出击"
        greeting_result.mood_tip = "保持乐观积极的心态"
        push_service.generate_daily_greeting.return_value = greeting_result
        mock_push.return_value = push_service

        yield {
            "bazi": mock_bazi,
            "persona": mock_persona,
            "letter": mock_letter,
            "push": mock_push,
        }


@pytest.fixture
def client():
    """Create test client"""
    from main import app
    return TestClient(app)


class TestCalculateBaziEndpoint:
    """Tests for POST /api/v1/onboarding/calculate-bazi"""

    def test_calculate_bazi_success(self, client, mock_services):
        """Test successful bazi calculation"""
        response = client.post(
            "/api/v1/onboarding/calculate-bazi",
            json={
                "year": 1990,
                "month": 5,
                "day": 15,
                "hour": 8
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "day_master" in data
        assert "day_master_element" in data
        assert "insight" in data
        assert "fortune" in data

    def test_calculate_bazi_without_hour(self, client, mock_services):
        """Test bazi calculation without hour"""
        response = client.post(
            "/api/v1/onboarding/calculate-bazi",
            json={
                "year": 1990,
                "month": 5,
                "day": 15
            }
        )

        assert response.status_code == 200
        data = response.json()
        # Hour pillar may be None
        assert "day_master" in data

    def test_calculate_bazi_with_lunar(self, client, mock_services):
        """Test bazi calculation with lunar calendar"""
        response = client.post(
            "/api/v1/onboarding/calculate-bazi",
            json={
                "year": 1990,
                "month": 5,
                "day": 15,
                "is_lunar": True
            }
        )

        assert response.status_code == 200

    def test_calculate_bazi_invalid_date(self, client):
        """Test bazi calculation with invalid date"""
        response = client.post(
            "/api/v1/onboarding/calculate-bazi",
            json={
                "year": 1990,
                "month": 13,  # Invalid month
                "day": 15
            }
        )

        assert response.status_code == 422

    def test_calculate_bazi_year_range(self, client):
        """Test bazi calculation year validation"""
        # Year too early
        response = client.post(
            "/api/v1/onboarding/calculate-bazi",
            json={"year": 1800, "month": 5, "day": 15}
        )
        assert response.status_code == 422

        # Year too late
        response = client.post(
            "/api/v1/onboarding/calculate-bazi",
            json={"year": 2200, "month": 5, "day": 15}
        )
        assert response.status_code == 422


class TestPersonasEndpoint:
    """Tests for GET /api/v1/onboarding/personas"""

    def test_get_personas_success(self, client, mock_services):
        """Test successful personas retrieval"""
        response = client.get("/api/v1/onboarding/personas")

        assert response.status_code == 200
        data = response.json()
        assert "personas" in data
        assert len(data["personas"]) == 3

    def test_personas_structure(self, client, mock_services):
        """Test persona structure matches expected format"""
        response = client.get("/api/v1/onboarding/personas")

        data = response.json()
        for persona in data["personas"]:
            assert "type" in persona
            assert "name" in persona
            assert "description" in persona


class TestGenerateLetterEndpoint:
    """Tests for POST /api/v1/onboarding/generate-letter"""

    def test_generate_letter_success(self, client, mock_services):
        """Test successful letter generation"""
        response = client.post(
            "/api/v1/onboarding/generate-letter",
            json={
                "day_master": "丙",
                "day_master_element": "火",
                "persona_type": "warm",
                "concerns": ["事业", "感情"],
                "interview_summary": "用户表示最近工作压力大"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "content" in data
        assert "persona_type" in data
        assert "generated_at" in data

    def test_generate_letter_default_persona(self, client, mock_services):
        """Test letter generation with default persona type"""
        response = client.post(
            "/api/v1/onboarding/generate-letter",
            json={
                "day_master": "丙",
                "day_master_element": "火"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["persona_type"] == "warm"

    def test_generate_letter_invalid_persona(self, client, mock_services):
        """Test letter generation with invalid persona type falls back to warm"""
        response = client.post(
            "/api/v1/onboarding/generate-letter",
            json={
                "day_master": "丙",
                "day_master_element": "火",
                "persona_type": "invalid_type"
            }
        )

        assert response.status_code == 200
        data = response.json()
        # Should fall back to warm
        assert data["persona_type"] == "warm"

    def test_generate_letter_all_personas(self, client, mock_services):
        """Test letter generation with all persona types"""
        persona_types = ["warm", "sarcastic", "mentor"]

        for persona_type in persona_types:
            response = client.post(
                "/api/v1/onboarding/generate-letter",
                json={
                    "day_master": "丙",
                    "day_master_element": "火",
                    "persona_type": persona_type
                }
            )
            assert response.status_code == 200


class TestDailyGreetingEndpoint:
    """Tests for GET /api/v1/onboarding/daily-greeting"""

    def test_daily_greeting_success(self, client, mock_services):
        """Test successful daily greeting retrieval"""
        response = client.get("/api/v1/onboarding/daily-greeting")

        assert response.status_code == 200
        data = response.json()
        assert "greeting" in data
        assert "fortune_score" in data
        assert "lucky_color" in data
        assert "lucky_number" in data
        assert "advice" in data
        assert "mood_tip" in data

    def test_daily_greeting_with_persona(self, client, mock_services):
        """Test daily greeting with specific persona type"""
        response = client.get("/api/v1/onboarding/daily-greeting?persona_type=sarcastic")

        assert response.status_code == 200

    def test_daily_greeting_with_day_master(self, client, mock_services):
        """Test daily greeting with day master info"""
        response = client.get(
            "/api/v1/onboarding/daily-greeting"
            "?day_master=丙&day_master_element=火"
        )

        assert response.status_code == 200

    def test_daily_greeting_invalid_persona(self, client, mock_services):
        """Test daily greeting with invalid persona falls back to warm"""
        response = client.get("/api/v1/onboarding/daily-greeting?persona_type=invalid")

        # Should still succeed with fallback
        assert response.status_code == 200


class TestTodayFortuneEndpoint:
    """Tests for GET /api/v1/onboarding/today-fortune"""

    def test_today_fortune_success(self, client):
        """Test successful fortune retrieval"""
        response = client.get("/api/v1/onboarding/today-fortune")

        assert response.status_code == 200
        data = response.json()
        assert "score" in data
        assert "lucky_color" in data
        assert "lucky_number" in data
        assert "good_for" in data
        assert "bad_for" in data
        assert "advice" in data

    def test_today_fortune_score_range(self, client):
        """Test fortune score is in valid range"""
        response = client.get("/api/v1/onboarding/today-fortune")

        data = response.json()
        assert 3 <= data["score"] <= 5

    def test_today_fortune_with_element(self, client):
        """Test fortune with day master element"""
        elements = ["木", "火", "土", "金", "水"]

        for element in elements:
            response = client.get(
                f"/api/v1/onboarding/today-fortune?day_master_element={element}"
            )
            assert response.status_code == 200
            data = response.json()
            # Advice should be element-specific
            assert element in data["advice"] or "适合" in data["advice"]

    def test_today_fortune_consistency(self, client):
        """Test fortune is consistent for same day"""
        response1 = client.get("/api/v1/onboarding/today-fortune")
        response2 = client.get("/api/v1/onboarding/today-fortune")

        data1 = response1.json()
        data2 = response2.json()

        # Same day should return same fortune
        assert data1["score"] == data2["score"]
        assert data1["lucky_color"] == data2["lucky_color"]
        assert data1["lucky_number"] == data2["lucky_number"]


class TestOnboardingFlow:
    """Integration tests for complete onboarding flow"""

    def test_complete_flow(self, client, mock_services):
        """Test complete onboarding flow as described in user-flow-design-v2.md"""
        # Stage 2: Calculate Bazi (30秒 Aha Moment)
        bazi_response = client.post(
            "/api/v1/onboarding/calculate-bazi",
            json={"year": 1990, "month": 5, "day": 15, "hour": 8}
        )
        assert bazi_response.status_code == 200
        bazi_data = bazi_response.json()

        # Stage 3: Get personas for interview
        personas_response = client.get("/api/v1/onboarding/personas")
        assert personas_response.status_code == 200

        # Stage 4: Generate "来自未来的信"
        letter_response = client.post(
            "/api/v1/onboarding/generate-letter",
            json={
                "day_master": bazi_data["day_master"],
                "day_master_element": bazi_data["day_master_element"],
                "persona_type": "warm",
                "concerns": ["事业", "感情"],
                "interview_summary": "用户关心近期的职业发展方向"
            }
        )
        assert letter_response.status_code == 200
        letter_data = letter_response.json()
        assert len(letter_data["content"]) > 0

    def test_returning_user_flow(self, client, mock_services):
        """Test returning user flow with daily greeting"""
        # Stage 6: Daily Greeting for returning users
        greeting_response = client.get(
            "/api/v1/onboarding/daily-greeting"
            "?persona_type=warm&day_master=丙&day_master_element=火"
        )
        assert greeting_response.status_code == 200

        fortune_response = client.get(
            "/api/v1/onboarding/today-fortune?day_master_element=火"
        )
        assert fortune_response.status_code == 200
