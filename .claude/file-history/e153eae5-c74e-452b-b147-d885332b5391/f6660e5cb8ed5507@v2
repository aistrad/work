/**
 * User Flow E2E Tests
 * Based on: user-flow-design-v2.md
 *
 * Tests the complete user journey:
 * - Stage 0: Brand Landing (www.vibelife.app)
 * - Stage 1: Skill Landing (bazi/zodiac)
 * - Stage 2: 30s Aha Moment (chart + fortune)
 * - Stage 3: Deep Interview (3 questions)
 * - Stage 4: Future Letter (preview)
 * - Stage 5: Conversion (payment)
 * - Stage 6: Retention (daily greeting)
 */

import { test, expect, Page } from '@playwright/test';

const BASE_URL = 'http://106.37.170.238:8230';

test.describe('User Flow - New User Journey', () => {

  test.describe('Stage 1: Skill Landing Page', () => {

    test('should load Bazi landing page with value proposition', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Check for skill-specific elements
      const hasContent = await page.locator('body').textContent();
      expect(hasContent).toBeTruthy();

      // Should have a chat input for starting conversation
      const input = page.locator('input, textarea').first();
      await expect(input).toBeVisible({ timeout: 10000 });

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage1-bazi.png', fullPage: true });
    });

    test('should load Zodiac landing page with value proposition', async ({ page }) => {
      await page.goto(`${BASE_URL}/zodiac/chat`);
      await page.waitForLoadState('networkidle');

      // Should have a chat input
      const input = page.locator('input, textarea').first();
      await expect(input).toBeVisible({ timeout: 10000 });

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage1-zodiac.png', fullPage: true });
    });

    test('should show quick prompts for new users', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for quick prompt buttons
      const buttons = page.locator('button');
      const count = await buttons.count();
      console.log(`Found ${count} buttons on page`);

      // Should have empty state with suggestions when no messages
      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage1-prompts.png', fullPage: true });
    });
  });

  test.describe('Stage 2: 30-Second Aha Moment', () => {

    test('should show daily greeting and fortune', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for greeting elements
      const greetingElement = page.locator('[class*="greeting"], [class*="fortune"], [class*="daily"]').first();
      const hasGreeting = await greetingElement.count() > 0;
      console.log(`Greeting element found: ${hasGreeting}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage2-greeting.png', fullPage: true });
    });

    test('should display Bazi chart visualization', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for chart elements
      const chartElements = page.locator('[class*="chart"], [class*="glyph"], canvas, svg').first();
      const hasChart = await chartElements.count() > 0;
      console.log(`Chart elements found: ${hasChart}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage2-chart.png', fullPage: true });
    });

    test('should have responsive layout for Aha moment', async ({ page }) => {
      // Mobile view
      await page.setViewportSize({ width: 375, height: 667 });
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');
      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage2-mobile.png', fullPage: true });

      // Desktop view
      await page.setViewportSize({ width: 1920, height: 1080 });
      await page.waitForLoadState('networkidle');
      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage2-desktop.png', fullPage: true });
    });
  });

  test.describe('Stage 3: Chat Interaction', () => {

    test('should allow sending chat messages', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      const input = page.locator('textarea, input[type="text"]').first();
      await input.waitFor({ state: 'visible', timeout: 10000 });

      // Type birth date message
      await input.fill('我是1990年5月15日出生的');

      // Verify input has value
      const value = await input.inputValue();
      expect(value).toContain('1990');

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage3-input.png', fullPage: true });
    });

    test('should have send button functionality', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      const input = page.locator('textarea, input[type="text"]').first();
      await input.waitFor({ state: 'visible', timeout: 10000 });

      await input.fill('你好');

      // Look for send button
      const sendButton = page.locator('button[type="submit"], button:has-text("发送"), button[aria-label*="发送"], button svg').first();
      const hasSendBtn = await sendButton.count() > 0;
      console.log(`Send button found: ${hasSendBtn}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage3-send.png', fullPage: true });
    });

    test('should support keyboard shortcuts (Enter to send)', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      const input = page.locator('textarea, input[type="text"]').first();
      await input.waitFor({ state: 'visible', timeout: 10000 });

      await input.fill('测试消息');
      await input.press('Enter');

      // Wait for any response indication
      await page.waitForTimeout(1000);
      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage3-enter.png', fullPage: true });
    });
  });

  test.describe('Panel System Tests', () => {

    test('should have panel tabs visible', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for panel tabs or navigation
      const tabs = page.locator('[role="tablist"], [class*="tab"], nav button');
      const tabCount = await tabs.count();
      console.log(`Found ${tabCount} tab-like elements`);

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-panels.png', fullPage: true });
    });

    test('should have insight panel on desktop', async ({ page }) => {
      await page.setViewportSize({ width: 1920, height: 1080 });
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for insight/right panel
      const panel = page.locator('[class*="panel"], [class*="insight"], aside').first();
      const hasPanel = await panel.count() > 0;
      console.log(`Insight panel found: ${hasPanel}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-insight-panel.png', fullPage: true });
    });
  });
});

test.describe('User Flow - Returning User Experience', () => {

  test.describe('Stage 6: Daily Greeting & Retention', () => {

    test('should show daily greeting for returning users', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Check for greeting message elements
      const greetingElements = await page.locator('[class*="greeting"], [class*="daily"]').count();
      console.log(`Greeting elements found: ${greetingElements}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage6-greeting.png', fullPage: true });
    });

    test('should show fortune score', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for fortune score indicator
      const fortuneElements = await page.locator('[class*="fortune"], [class*="score"]').count();
      console.log(`Fortune elements found: ${fortuneElements}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/flow-stage6-fortune.png', fullPage: true });
    });
  });
});

test.describe('UI/UX Design V4 - Skill System Tests', () => {

  test.describe('Skill-Specific Theming', () => {

    test('Bazi should have golden theme colors', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Check CSS custom properties or computed colors
      const themeColor = await page.evaluate(() => {
        const root = document.documentElement;
        return getComputedStyle(root).getPropertyValue('--skill-primary') ||
               getComputedStyle(document.body).getPropertyValue('--skill-primary') || 'not found';
      });
      console.log(`Bazi theme color: ${themeColor}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/theme-bazi.png', fullPage: true });
    });

    test('Zodiac should have blue theme colors', async ({ page }) => {
      await page.goto(`${BASE_URL}/zodiac/chat`);
      await page.waitForLoadState('networkidle');

      const themeColor = await page.evaluate(() => {
        const root = document.documentElement;
        return getComputedStyle(root).getPropertyValue('--skill-primary') ||
               getComputedStyle(document.body).getPropertyValue('--skill-primary') || 'not found';
      });
      console.log(`Zodiac theme color: ${themeColor}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/theme-zodiac.png', fullPage: true });
    });
  });

  test.describe('Chat Container Tests', () => {

    test('should have empty state with quick prompts when no messages', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Should see empty state content
      const emptyState = page.locator('[class*="empty"], [class*="prompt"]');
      const hasEmptyState = await emptyState.count() > 0;
      console.log(`Empty state elements found: ${hasEmptyState}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/chat-empty-state.png', fullPage: true });
    });

    test('should have chat input with media buttons', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for file upload and voice buttons
      const mediaButtons = page.locator('button[aria-label*="上传"], button[aria-label*="语音"]');
      const mediaCount = await mediaButtons.count();
      console.log(`Media buttons found: ${mediaCount}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/chat-input-buttons.png', fullPage: true });
    });

    test('should show character count', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      const input = page.locator('textarea, input[type="text"]').first();
      await input.waitFor({ state: 'visible', timeout: 10000 });

      await input.fill('测试消息');

      // Look for character count display
      const charCount = await page.locator('text=/\\d+ \\/ \\d+/').count();
      console.log(`Character count display found: ${charCount > 0}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/chat-char-count.png', fullPage: true });
    });
  });

  test.describe('Accessibility Tests', () => {

    test('should have proper ARIA labels', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Check for aria-labels
      const ariaElements = await page.locator('[aria-label]').count();
      console.log(`Elements with aria-label: ${ariaElements}`);

      // Check for role attributes
      const roleElements = await page.locator('[role]').count();
      console.log(`Elements with role attribute: ${roleElements}`);
    });

    test('should have semantic HTML structure', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      const hasMain = await page.locator('main').count() > 0;
      const hasNav = await page.locator('nav').count() > 0;
      const hasArticle = await page.locator('article').count() > 0;

      console.log(`Semantic elements - main: ${hasMain}, nav: ${hasNav}, article: ${hasArticle}`);
    });

    test('should support keyboard navigation', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Tab through interactive elements
      await page.keyboard.press('Tab');
      await page.keyboard.press('Tab');
      await page.keyboard.press('Tab');

      const focusedElement = await page.evaluate(() => {
        return document.activeElement?.tagName || 'none';
      });
      console.log(`Focused element after 3 tabs: ${focusedElement}`);
    });
  });
});

test.describe('Performance Tests', () => {

  test('should load within acceptable time', async ({ page }) => {
    const startTime = Date.now();
    await page.goto(`${BASE_URL}/bazi/chat`);
    await page.waitForLoadState('networkidle');
    const loadTime = Date.now() - startTime;

    console.log(`Bazi chat page load time: ${loadTime}ms`);
    expect(loadTime).toBeLessThan(10000);
  });

  test('should not have memory leaks with repeated navigation', async ({ page }) => {
    // Navigate multiple times
    for (let i = 0; i < 3; i++) {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');
      await page.goto(`${BASE_URL}/zodiac/chat`);
      await page.waitForLoadState('networkidle');
    }

    // Final page should still work
    await page.goto(`${BASE_URL}/bazi/chat`);
    const input = page.locator('textarea, input[type="text"]').first();
    await expect(input).toBeVisible({ timeout: 10000 });
  });
});
