"""
Bazi API Routes Tests

Tests for:
- POST /api/v1/bazi/chart - Calculate bazi chart
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
from fastapi.testclient import TestClient


@pytest.fixture
def mock_bazi_calculator():
    """Mock BaziCalculator"""
    with patch("routes.bazi.BaziCalculator") as mock:
        calculator_instance = Mock()
        mock.return_value = calculator_instance

        # Create a mock chart result
        mock_chart = Mock()
        mock_chart.to_dict.return_value = {
            "year_pillar": {"stem": "甲", "branch": "子"},
            "month_pillar": {"stem": "乙", "branch": "丑"},
            "day_pillar": {"stem": "丙", "branch": "寅"},
            "hour_pillar": {"stem": "丁", "branch": "卯"},
            "day_master": "丙",
            "day_master_element": "火",
            "ten_gods": ["比肩", "劫财"],
            "five_elements": {"木": 2, "火": 2, "土": 1, "金": 1, "水": 2},
        }
        calculator_instance.calculate.return_value = mock_chart

        yield mock


@pytest.fixture
def client():
    """Create test client"""
    from main import app
    return TestClient(app)


class TestBaziChartEndpoint:
    """Tests for /api/v1/bazi/chart endpoint"""

    def test_calculate_chart_success(self, client, mock_bazi_calculator):
        """Test successful chart calculation"""
        response = client.post(
            "/api/v1/bazi/chart",
            json={
                "birth_date": "1990-05-15",
                "birth_time": "08:30",
                "gender": "male"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert "chart" in data
        assert data["chart"]["day_master"] == "丙"

    def test_calculate_chart_default_time(self, client, mock_bazi_calculator):
        """Test chart calculation with default time"""
        response = client.post(
            "/api/v1/bazi/chart",
            json={
                "birth_date": "1990-05-15"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True

        # Verify default time was used
        mock_bazi_calculator.return_value.calculate.assert_called_once()
        call_kwargs = mock_bazi_calculator.return_value.calculate.call_args.kwargs
        assert call_kwargs["birth_time"] == "12:00"
        assert call_kwargs["gender"] == "unknown"

    def test_calculate_chart_invalid_date_format(self, client, mock_bazi_calculator):
        """Test chart calculation with invalid date format"""
        mock_bazi_calculator.return_value.calculate.side_effect = ValueError("Invalid date format")

        response = client.post(
            "/api/v1/bazi/chart",
            json={
                "birth_date": "invalid-date"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is False
        assert "error" in data

    def test_calculate_chart_missing_date(self, client):
        """Test chart calculation without birth_date"""
        response = client.post(
            "/api/v1/bazi/chart",
            json={}
        )

        assert response.status_code == 422  # Validation error

    def test_calculate_chart_with_all_params(self, client, mock_bazi_calculator):
        """Test chart calculation with all parameters"""
        response = client.post(
            "/api/v1/bazi/chart",
            json={
                "birth_date": "1990-05-15",
                "birth_time": "08:30",
                "gender": "female"
            }
        )

        assert response.status_code == 200
        mock_bazi_calculator.return_value.calculate.assert_called_once_with(
            birth_date="1990-05-15",
            birth_time="08:30",
            gender="female"
        )

    def test_chart_response_structure(self, client, mock_bazi_calculator):
        """Test that response has correct structure"""
        response = client.post(
            "/api/v1/bazi/chart",
            json={"birth_date": "1990-05-15"}
        )

        data = response.json()
        assert "success" in data
        assert isinstance(data["success"], bool)

        if data["success"]:
            assert "chart" in data
            chart = data["chart"]
            assert "year_pillar" in chart
            assert "month_pillar" in chart
            assert "day_pillar" in chart
            assert "day_master" in chart


class TestBaziErrorHandling:
    """Tests for error handling"""

    def test_calculator_exception(self, client):
        """Test handling of calculator exception"""
        with patch("routes.bazi.BaziCalculator") as mock:
            mock.return_value.calculate.side_effect = Exception("Calculation failed")

            response = client.post(
                "/api/v1/bazi/chart",
                json={"birth_date": "1990-05-15"}
            )

            assert response.status_code == 200
            data = response.json()
            assert data["success"] is False
            assert "Calculation failed" in data["error"]
