/**
 * ChatInput Component Tests
 */

import { describe, it, expect, vi, beforeEach } from "vitest";
import { render, screen, fireEvent, waitFor } from "@testing-library/react";
import userEvent from "@testing-library/user-event";
import { ChatInput, QuickReplies, FloatingOmnibar } from "@/components/chat/ChatInput";

describe("ChatInput", () => {
  const mockOnSend = vi.fn();

  beforeEach(() => {
    mockOnSend.mockClear();
  });

  describe("Rendering", () => {
    it("should render input field with placeholder", () => {
      render(<ChatInput onSend={mockOnSend} />);
      expect(screen.getByPlaceholderText("分享你的生辰或提出问题...")).toBeInTheDocument();
    });

    it("should render with custom placeholder", () => {
      render(<ChatInput onSend={mockOnSend} placeholder="Custom placeholder" />);
      expect(screen.getByPlaceholderText("Custom placeholder")).toBeInTheDocument();
    });

    it("should render send button", () => {
      render(<ChatInput onSend={mockOnSend} />);
      expect(screen.getByLabelText("发送消息")).toBeInTheDocument();
    });

    it("should render media buttons by default", () => {
      render(<ChatInput onSend={mockOnSend} />);
      expect(screen.getByLabelText("上传文件")).toBeInTheDocument();
      expect(screen.getByLabelText("语音输入")).toBeInTheDocument();
    });

    it("should hide media buttons when showMediaButtons is false", () => {
      render(<ChatInput onSend={mockOnSend} showMediaButtons={false} />);
      expect(screen.queryByLabelText("上传文件")).not.toBeInTheDocument();
      expect(screen.queryByLabelText("语音输入")).not.toBeInTheDocument();
    });
  });

  describe("Input Behavior", () => {
    it("should update input value on change", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "Hello");

      expect(input).toHaveValue("Hello");
    });

    it("should limit input to MAX_MESSAGE_LENGTH (500 characters)", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      const longText = "a".repeat(600);
      await user.type(input, longText);

      expect((input as HTMLTextAreaElement).value.length).toBeLessThanOrEqual(500);
    });

    it("should show character count", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "Hello");

      expect(screen.getByText("5 / 500")).toBeInTheDocument();
    });
  });

  describe("Send Behavior", () => {
    it("should call onSend when clicking send button with valid input", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "Hello World");

      const sendButton = screen.getByLabelText("发送消息");
      await user.click(sendButton);

      expect(mockOnSend).toHaveBeenCalledWith("Hello World");
    });

    it("should call onSend on Enter key press", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "Hello World");
      await user.keyboard("{Enter}");

      expect(mockOnSend).toHaveBeenCalledWith("Hello World");
    });

    it("should not send on Shift+Enter (allows newline)", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "Hello World");
      await user.keyboard("{Shift>}{Enter}{/Shift}");

      expect(mockOnSend).not.toHaveBeenCalled();
    });

    it("should clear input after sending", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "Hello World");
      await user.keyboard("{Enter}");

      expect(input).toHaveValue("");
    });

    it("should not send empty message", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const sendButton = screen.getByLabelText("发送消息");
      await user.click(sendButton);

      expect(mockOnSend).not.toHaveBeenCalled();
    });

    it("should not send whitespace-only message", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "   ");

      const sendButton = screen.getByLabelText("发送消息");
      await user.click(sendButton);

      expect(mockOnSend).not.toHaveBeenCalled();
    });

    it("should trim message before sending", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "  Hello World  ");
      await user.keyboard("{Enter}");

      expect(mockOnSend).toHaveBeenCalledWith("Hello World");
    });
  });

  describe("Disabled State", () => {
    it("should disable input when disabled prop is true", () => {
      render(<ChatInput onSend={mockOnSend} disabled={true} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      expect(input).toBeDisabled();
    });

    it("should disable send button when disabled", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} disabled={true} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      await user.type(input, "Hello");

      const sendButton = screen.getByLabelText("发送消息");
      expect(sendButton).toBeDisabled();
    });

    it("should not send when disabled even with valid input", async () => {
      const user = userEvent.setup();
      render(<ChatInput onSend={mockOnSend} disabled={true} />);

      const input = screen.getByPlaceholderText("分享你的生辰或提出问题...");
      fireEvent.change(input, { target: { value: "Hello" } });

      const sendButton = screen.getByLabelText("发送消息");
      await user.click(sendButton);

      expect(mockOnSend).not.toHaveBeenCalled();
    });
  });

  describe("Accessibility", () => {
    it("should have accessible label for input", () => {
      render(<ChatInput onSend={mockOnSend} />);
      expect(screen.getByLabelText(/聊天输入框/)).toBeInTheDocument();
    });

    it("should have keyboard hint text", () => {
      render(<ChatInput onSend={mockOnSend} />);
      expect(screen.getByText("发送")).toBeInTheDocument();
      expect(screen.getByText("换行")).toBeInTheDocument();
    });
  });
});

describe("QuickReplies", () => {
  const mockOnSelect = vi.fn();

  beforeEach(() => {
    mockOnSelect.mockClear();
  });

  it("should render replies as buttons", () => {
    const replies = ["Reply 1", "Reply 2", "Reply 3"];
    render(<QuickReplies replies={replies} onSelect={mockOnSelect} />);

    expect(screen.getByText("Reply 1")).toBeInTheDocument();
    expect(screen.getByText("Reply 2")).toBeInTheDocument();
    expect(screen.getByText("Reply 3")).toBeInTheDocument();
  });

  it("should call onSelect when clicking a reply", async () => {
    const user = userEvent.setup();
    const replies = ["Reply 1", "Reply 2"];
    render(<QuickReplies replies={replies} onSelect={mockOnSelect} />);

    await user.click(screen.getByText("Reply 1"));

    expect(mockOnSelect).toHaveBeenCalledWith("Reply 1");
  });

  it("should not render when replies array is empty", () => {
    const { container } = render(<QuickReplies replies={[]} onSelect={mockOnSelect} />);
    expect(container.firstChild).toBeNull();
  });
});

describe("FloatingOmnibar", () => {
  const mockOnSend = vi.fn();

  beforeEach(() => {
    mockOnSend.mockClear();
  });

  it("should render with default placeholder", () => {
    render(<FloatingOmnibar onSend={mockOnSend} />);
    expect(screen.getByPlaceholderText("输入你的出生日期开始...")).toBeInTheDocument();
  });

  it("should render with custom placeholder", () => {
    render(<FloatingOmnibar onSend={mockOnSend} placeholder="Custom" />);
    expect(screen.getByPlaceholderText("Custom")).toBeInTheDocument();
  });

  it("should call onSend on submit", async () => {
    const user = userEvent.setup();
    render(<FloatingOmnibar onSend={mockOnSend} />);

    const input = screen.getByPlaceholderText("输入你的出生日期开始...");
    await user.type(input, "1990-05-15");
    await user.keyboard("{Enter}");

    expect(mockOnSend).toHaveBeenCalledWith("1990-05-15");
  });

  it("should clear input after submit", async () => {
    const user = userEvent.setup();
    render(<FloatingOmnibar onSend={mockOnSend} />);

    const input = screen.getByPlaceholderText("输入你的出生日期开始...");
    await user.type(input, "1990-05-15");
    await user.keyboard("{Enter}");

    expect(input).toHaveValue("");
  });
});
