"""
Zodiac API Routes Tests

Tests for:
- POST /api/v1/zodiac/chart - Calculate zodiac natal chart
- POST /api/v1/zodiac/transit - Calculate transit analysis
- POST /api/v1/zodiac/synastry - Calculate synastry (compatibility)
"""

import pytest
from unittest.mock import Mock, patch, MagicMock
from fastapi.testclient import TestClient


@pytest.fixture
def mock_zodiac_functions():
    """Mock zodiac calculation functions"""
    with patch("routes.zodiac.calculate_zodiac") as mock_chart, \
         patch("routes.zodiac.calculate_transit") as mock_transit, \
         patch("routes.zodiac.ZodiacCalculator") as mock_calculator:

        # Mock chart calculation
        mock_chart.return_value = {
            "sun_sign": "taurus",
            "moon_sign": "cancer",
            "rising_sign": "leo",
            "planets": [
                {"planet": "Sun", "sign": "Taurus", "degree": 25.5},
                {"planet": "Moon", "sign": "Cancer", "degree": 12.3},
            ],
            "aspects": [
                {"planet1": "Sun", "planet2": "Moon", "aspect": "sextile", "orb": 2.1}
            ],
        }

        # Mock transit calculation
        mock_transit.return_value = [
            {
                "transit_planet": "Saturn",
                "natal_planet": "Sun",
                "aspect": "square",
                "description": "A challenging period for growth",
            }
        ]

        # Mock calculator for synastry
        calculator_instance = Mock()
        mock_calculator.return_value = calculator_instance

        chart1 = Mock()
        chart1.sun_sign = "taurus"
        chart1.moon_sign = "cancer"

        chart2 = Mock()
        chart2.sun_sign = "virgo"
        chart2.moon_sign = "pisces"

        calculator_instance.calculate.side_effect = [chart1, chart2]

        yield {
            "chart": mock_chart,
            "transit": mock_transit,
            "calculator": mock_calculator,
        }


@pytest.fixture
def client():
    """Create test client"""
    from main import app
    return TestClient(app)


class TestZodiacChartEndpoint:
    """Tests for /api/v1/zodiac/chart endpoint"""

    def test_calculate_chart_success(self, client, mock_zodiac_functions):
        """Test successful natal chart calculation"""
        response = client.post(
            "/api/v1/zodiac/chart",
            json={
                "birth_date": "1990-05-15",
                "birth_time": "08:30",
                "birth_place": "Beijing"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert "chart" in data
        assert data["chart"]["sun_sign"] == "taurus"

    def test_calculate_chart_with_defaults(self, client, mock_zodiac_functions):
        """Test chart calculation with default values"""
        response = client.post(
            "/api/v1/zodiac/chart",
            json={
                "birth_date": "1990-05-15"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True

        # Verify defaults were used
        mock_zodiac_functions["chart"].assert_called_once()
        call_kwargs = mock_zodiac_functions["chart"].call_args.kwargs
        assert call_kwargs["birth_time"] == "12:00"
        assert call_kwargs["birth_place"] == "Shanghai"

    def test_calculate_chart_error(self, client):
        """Test chart calculation error handling"""
        with patch("routes.zodiac.calculate_zodiac") as mock:
            mock.side_effect = Exception("Ephemeris data not found")

            response = client.post(
                "/api/v1/zodiac/chart",
                json={"birth_date": "1990-05-15"}
            )

            assert response.status_code == 200
            data = response.json()
            assert data["success"] is False
            assert "error" in data


class TestZodiacTransitEndpoint:
    """Tests for /api/v1/zodiac/transit endpoint"""

    def test_transit_success(self, client, mock_zodiac_functions):
        """Test successful transit calculation"""
        response = client.post(
            "/api/v1/zodiac/transit",
            json={
                "birth_date": "1990-05-15",
                "birth_time": "08:30",
                "birth_place": "Beijing",
                "transit_date": "2026-01-15"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True
        assert "transits" in data
        assert len(data["transits"]) > 0

    def test_transit_without_date(self, client, mock_zodiac_functions):
        """Test transit calculation without transit_date (uses today)"""
        response = client.post(
            "/api/v1/zodiac/transit",
            json={
                "birth_date": "1990-05-15"
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["success"] is True

        # Verify transit_date was None (uses today)
        call_kwargs = mock_zodiac_functions["transit"].call_args.kwargs
        assert call_kwargs["transit_date"] is None

    def test_transit_error(self, client):
        """Test transit calculation error handling"""
        with patch("routes.zodiac.calculate_transit") as mock:
            mock.side_effect = Exception("Transit calculation failed")

            response = client.post(
                "/api/v1/zodiac/transit",
                json={"birth_date": "1990-05-15"}
            )

            assert response.status_code == 200
            data = response.json()
            assert data["success"] is False


class TestZodiacSynastryEndpoint:
    """Tests for /api/v1/zodiac/synastry endpoint"""

    def test_synastry_success(self, client, mock_zodiac_functions):
        """Test successful synastry calculation"""
        # Mock the SIGN_ELEMENT and SIGN_CHINESE imports
        with patch.dict("routes.zodiac.__builtins__", {}), \
             patch("routes.zodiac.SIGN_ELEMENT", {"taurus": Mock(value="earth"), "virgo": Mock(value="earth"), "cancer": Mock(value="water"), "pisces": Mock(value="water")}), \
             patch("routes.zodiac.SIGN_CHINESE", {"taurus": "金牛座", "virgo": "处女座", "cancer": "巨蟹座", "pisces": "双鱼座"}):

            response = client.post(
                "/api/v1/zodiac/synastry",
                json={
                    "person1": {
                        "birth_date": "1990-05-15",
                        "birth_time": "08:30",
                        "birth_place": "Beijing"
                    },
                    "person2": {
                        "birth_date": "1992-09-10",
                        "birth_time": "14:00",
                        "birth_place": "Shanghai"
                    }
                }
            )

            assert response.status_code == 200
            data = response.json()
            assert data["success"] is True
            if "compatibility" in data and data["compatibility"]:
                assert "overallScore" in data["compatibility"]
                assert "categories" in data["compatibility"]

    def test_synastry_response_structure(self, client, mock_zodiac_functions):
        """Test synastry response structure matches frontend expectations"""
        with patch("routes.zodiac.SIGN_ELEMENT", {"taurus": Mock(value="earth"), "virgo": Mock(value="earth"), "cancer": Mock(value="water"), "pisces": Mock(value="water")}), \
             patch("routes.zodiac.SIGN_CHINESE", {"taurus": "金牛座", "virgo": "处女座", "cancer": "巨蟹座", "pisces": "双鱼座"}):

            response = client.post(
                "/api/v1/zodiac/synastry",
                json={
                    "person1": {"birth_date": "1990-05-15"},
                    "person2": {"birth_date": "1992-09-10"}
                }
            )

            if response.status_code == 200:
                data = response.json()
                if data.get("success") and data.get("compatibility"):
                    compat = data["compatibility"]
                    # Check expected structure based on show_synastry.tsx
                    assert "person1" in compat
                    assert "person2" in compat
                    assert "overallScore" in compat
                    assert "categories" in compat
                    assert "strengths" in compat
                    assert "challenges" in compat
                    assert "advice" in compat

    def test_synastry_error(self, client):
        """Test synastry calculation error handling"""
        with patch("routes.zodiac.ZodiacCalculator") as mock:
            mock.return_value.calculate.side_effect = Exception("Chart calculation failed")

            response = client.post(
                "/api/v1/zodiac/synastry",
                json={
                    "person1": {"birth_date": "1990-05-15"},
                    "person2": {"birth_date": "1992-09-10"}
                }
            )

            assert response.status_code == 200
            data = response.json()
            assert data["success"] is False


class TestZodiacInputValidation:
    """Tests for input validation"""

    def test_missing_birth_date(self, client):
        """Test validation error for missing birth_date"""
        response = client.post(
            "/api/v1/zodiac/chart",
            json={}
        )

        assert response.status_code == 422

    def test_invalid_synastry_request(self, client):
        """Test validation error for invalid synastry request"""
        response = client.post(
            "/api/v1/zodiac/synastry",
            json={
                "person1": {"birth_date": "1990-05-15"}
                # Missing person2
            }
        )

        assert response.status_code == 422
