"""
Lifecoach Skill - Tool Handlers

处理 lifecoach skill 的工具调用，生成展示数据。
"""

from typing import Any, Dict, List, Optional
from datetime import datetime


async def show_pattern_insight(
    pattern_type: str = "behavior",
    surface_pattern: str = "",
    hidden_goal: Optional[str] = None,
    cost: Optional[str] = None,
    insight: Optional[str] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    展示行为模式洞察卡片

    Args:
        pattern_type: 模式类型 (behavior/stuck/conflict/protection)
        surface_pattern: 表层模式描述
        hidden_goal: 隐藏的目标
        cost: 这个模式的代价
        insight: 核心洞察

    Returns:
        卡片展示数据
    """
    type_labels = {
        "behavior": "行为模式",
        "stuck": "卡点分析",
        "conflict": "目标冲突",
        "protection": "自我保护"
    }

    return {
        "card_type": "pattern_insight",
        "data": {
            "type": pattern_type,
            "type_label": type_labels.get(pattern_type, "模式分析"),
            "surface_pattern": surface_pattern,
            "hidden_goal": hidden_goal,
            "cost": cost,
            "insight": insight,
            "generated_at": datetime.now().isoformat()
        }
    }


async def show_identity_design(
    new_identity: str,
    old_identity: Optional[str] = None,
    bridge_belief: Optional[str] = None,
    anchor_behaviors: Optional[List[str]] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    展示身份设计卡片

    Args:
        new_identity: 新身份描述
        old_identity: 旧身份描述
        bridge_belief: 连接信念
        anchor_behaviors: 锚定行为列表

    Returns:
        卡片展示数据
    """
    return {
        "card_type": "identity_design",
        "data": {
            "old_identity": old_identity,
            "new_identity": new_identity,
            "bridge_belief": bridge_belief,
            "anchor_behaviors": anchor_behaviors or [],
            "transformation_arrow": "→" if old_identity else None,
            "generated_at": datetime.now().isoformat()
        }
    }


async def show_vision_map(
    map_type: str,
    vision_statement: Optional[str] = None,
    anti_vision_statement: Optional[str] = None,
    three_year_picture: Optional[str] = None,
    five_year_picture: Optional[str] = None,
    identity_belief: Optional[str] = None,
    one_year_milestone: Optional[str] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    展示愿景/反愿景地图

    Args:
        map_type: 地图类型 (vision/anti_vision/both)
        vision_statement: 愿景一句话
        anti_vision_statement: 反愿景一句话
        three_year_picture: 三年画面
        five_year_picture: 不改变的五年画面
        identity_belief: 身份信念
        one_year_milestone: 一年里程碑

    Returns:
        卡片展示数据
    """
    return {
        "card_type": "vision_map",
        "data": {
            "map_type": map_type,
            "vision": {
                "statement": vision_statement,
                "three_year_picture": three_year_picture,
                "identity_belief": identity_belief,
                "one_year_milestone": one_year_milestone
            } if map_type in ["vision", "both"] else None,
            "anti_vision": {
                "statement": anti_vision_statement,
                "five_year_picture": five_year_picture
            } if map_type in ["anti_vision", "both"] else None,
            "generated_at": datetime.now().isoformat()
        }
    }


async def show_action_plan(
    daily_actions: List[str],
    context: Optional[str] = None,
    one_year_goal: Optional[str] = None,
    one_month_project: Optional[str] = None,
    first_step: Optional[str] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    展示行动计划卡片

    Args:
        daily_actions: 每日行动列表
        context: 行动背景
        one_year_goal: 一年目标
        one_month_project: 本月项目
        first_step: 第一步

    Returns:
        卡片展示数据
    """
    return {
        "card_type": "action_plan",
        "data": {
            "context": context,
            "hierarchy": {
                "one_year_goal": one_year_goal,
                "one_month_project": one_month_project,
                "daily_actions": daily_actions
            },
            "first_step": first_step,
            "generated_at": datetime.now().isoformat()
        }
    }


async def show_life_game(
    win_condition: str,
    lose_condition: str,
    main_mission: str,
    current_boss: Optional[str] = None,
    boss_reward: Optional[str] = None,
    daily_quests: Optional[List[str]] = None,
    game_rules: Optional[List[str]] = None,
    **kwargs
) -> Dict[str, Any]:
    """
    展示人生游戏设计卡片

    Args:
        win_condition: 胜利条件
        lose_condition: 失败条件
        main_mission: 主线任务
        current_boss: 当前Boss
        boss_reward: Boss奖励
        daily_quests: 每日任务
        game_rules: 游戏规则

    Returns:
        卡片展示数据
    """
    return {
        "card_type": "life_game",
        "data": {
            "win_condition": win_condition,
            "lose_condition": lose_condition,
            "main_mission": main_mission,
            "current_boss": {
                "name": current_boss,
                "reward": boss_reward
            } if current_boss else None,
            "daily_quests": daily_quests or [],
            "game_rules": game_rules or [],
            "generated_at": datetime.now().isoformat()
        }
    }


# 工具注册表
TOOL_HANDLERS = {
    "show_pattern_insight": show_pattern_insight,
    "show_identity_design": show_identity_design,
    "show_vision_map": show_vision_map,
    "show_action_plan": show_action_plan,
    "show_life_game": show_life_game,
}


async def handle_tool_call(tool_name: str, params: Dict[str, Any]) -> Dict[str, Any]:
    """
    统一工具调用入口

    Args:
        tool_name: 工具名称
        params: 工具参数

    Returns:
        工具执行结果
    """
    if tool_name not in TOOL_HANDLERS:
        raise ValueError(f"Unknown tool: {tool_name}")

    handler = TOOL_HANDLERS[tool_name]
    return await handler(**params)
