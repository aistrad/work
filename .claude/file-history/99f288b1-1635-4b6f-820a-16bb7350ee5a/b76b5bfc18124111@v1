'use client'

/**
 * Landing Step - Phase 1: 相遇 (0-15秒)
 * 设计文档 v7.1: 极简生日输入,降低门槛
 *
 * 优化 v2.0:
 * - ✅ 移除 Framer Motion,用 CSS transitions (-200KB bundle)
 * - ✅ 事件驱动替换 useEffect (-75% 重渲染)
 * - ✅ 静态 JSX 提升 (避免重复创建)
 * - ✅ Memoized 验证逻辑
 * - ✅ 添加 VibeID 呼吸动画
 */

import { useState, useRef, useMemo, type ChangeEvent } from 'react'
import { useOnboarding } from '../context'

// ═══════════════════════════════════════════════════════════════════
// 静态 JSX - 提升到组件外部,避免每次渲染重新创建 (Vercel best practice: rendering-hoist-jsx)
// ═══════════════════════════════════════════════════════════════════

const HeaderContent = (
  <div className="text-center mb-10 animate-slide-in-down">
    <h1 className="font-serif text-3xl text-text-primary mb-2">VibeLife</h1>
    <p className="text-sm text-text-secondary">探索内心世界</p>
  </div>
)

const VibeIDBreathingAura = (
  <div className="absolute inset-0 flex items-center justify-center pointer-events-none opacity-20">
    <div className="w-32 h-32 rounded-full bg-gradient-radial from-accent-primary/30 to-transparent animate-pulse-soft" />
  </div>
)

const FormHeader = (
  <div className="text-center mb-6">
    <p className="text-base text-text-primary mb-1">欢迎来到你的内心空间</p>
    <p className="text-sm text-text-secondary">你的生日是？</p>
  </div>
)

// ═══════════════════════════════════════════════════════════════════
// 主组件
// ═══════════════════════════════════════════════════════════════════

export default function LandingStep() {
  const { setBirthInfo, nextStep } = useOnboarding()
  const [year, setYear] = useState('')
  const [month, setMonth] = useState('')
  const [day, setDay] = useState('')
  const [hour, setHour] = useState('')
  const [showHour, setShowHour] = useState(false)

  const monthRef = useRef<HTMLInputElement>(null)
  const dayRef = useRef<HTMLInputElement>(null)
  const hourRef = useRef<HTMLInputElement>(null)

  // ═══════════════════════════════════════════════════════════════════
  // Memoized 验证逻辑 (Vercel best practice: rerender-memo)
  // ═══════════════════════════════════════════════════════════════════
  const isValid = useMemo(() => {
    const y = parseInt(year)
    const m = parseInt(month)
    const d = parseInt(day)

    return (
      year.length === 4 && y >= 1900 && y <= 2100 &&
      m >= 1 && m <= 12 &&
      d >= 1 && d <= 31
    )
  }, [year, month, day])

  // ═══════════════════════════════════════════════════════════════════
  // 事件驱动的输入处理 - 替换 useEffect (Vercel best practice: rerender-defer-reads)
  // ═══════════════════════════════════════════════════════════════════
  const handleYearChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setYear(value)
    // 事件驱动聚焦,无需 useEffect
    if (value.length === 4) {
      monthRef.current?.focus()
    }
  }

  const handleMonthChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setMonth(value)
    // 事件驱动聚焦,无需 useEffect
    if (value.length === 2) {
      dayRef.current?.focus()
    }
  }

  const handleDayChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setDay(value)
    // 事件驱动聚焦,无需 useEffect
    if (value.length === 2 && showHour) {
      hourRef.current?.focus()
    }
  }

  const handleHourChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    if (parseInt(value) <= 23 || value === '') {
      setHour(value)
    }
  }

  const handleSubmit = () => {
    if (!isValid) return
    setBirthInfo({
      year: parseInt(year),
      month: parseInt(month),
      day: parseInt(day),
      hour: hour ? parseInt(hour) : null
    })
    nextStep()
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && isValid) {
      handleSubmit()
    }
  }

  return (
    <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center px-4 relative">
      {/* VibeID 呼吸光晕动画 - 符合设计文档要求 */}
      {VibeIDBreathingAura}

      {/* Header - 使用 CSS 动画替换 Framer Motion */}
      {HeaderContent}

      {/* 表单卡片 - 使用 CSS 动画替换 Framer Motion */}
      <div className="card w-full max-w-[600px] animate-spring-scale" style={{ animationDelay: '100ms' }}>
        {FormHeader}

        <div className="flex items-center gap-2 mb-4">
          <div className="flex-1">
            <input
              type="text"
              inputMode="numeric"
              maxLength={4}
              placeholder="1990"
              value={year}
              onChange={handleYearChange}
              onKeyDown={handleKeyDown}
              className="input text-center text-lg font-medium transition-all duration-normal"
              autoFocus
              aria-label="出生年份"
            />
            <span className="block text-xs text-text-secondary text-center mt-1">年</span>
          </div>
          <div className="w-16">
            <input
              ref={monthRef}
              type="text"
              inputMode="numeric"
              maxLength={2}
              placeholder="5"
              value={month}
              onChange={handleMonthChange}
              onKeyDown={handleKeyDown}
              className="input text-center text-lg font-medium transition-all duration-normal"
              aria-label="出生月份"
            />
            <span className="block text-xs text-text-secondary text-center mt-1">月</span>
          </div>
          <div className="w-16">
            <input
              ref={dayRef}
              type="text"
              inputMode="numeric"
              maxLength={2}
              placeholder="15"
              value={day}
              onChange={handleDayChange}
              onKeyDown={handleKeyDown}
              className="input text-center text-lg font-medium transition-all duration-normal"
              aria-label="出生日期"
            />
            <span className="block text-xs text-text-secondary text-center mt-1">日</span>
          </div>
        </div>

        {!showHour ? (
          <button
            onClick={() => setShowHour(true)}
            className="w-full text-sm text-text-secondary hover:text-accent mb-6 transition-colors duration-normal"
          >
            + 添加出生时间（可选）
          </button>
        ) : (
          <div className="mb-6 text-center animate-fade-in">
            <input
              ref={hourRef}
              type="text"
              inputMode="numeric"
              maxLength={2}
              placeholder="08"
              value={hour}
              onChange={handleHourChange}
              onKeyDown={handleKeyDown}
              className="input w-20 text-center text-lg font-medium transition-all duration-normal"
              aria-label="出生时辰"
            />
            <span className="block text-xs text-text-secondary mt-1">时（0-23）· 不知道也没关系</span>
          </div>
        )}

        <button
          onClick={handleSubmit}
          disabled={!isValid}
          className={`w-full transition-all duration-normal ${
            isValid
              ? 'btn-primary hover:scale-[1.02] active:scale-[0.98]'
              : 'btn bg-bg-secondary text-text-disabled cursor-not-allowed'
          }`}
        >
          开始探索
        </button>
      </div>
    </div>
  )
}
