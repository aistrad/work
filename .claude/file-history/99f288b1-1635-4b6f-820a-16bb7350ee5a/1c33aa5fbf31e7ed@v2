'use client'

/**
 * Loading Step - Phase 2: 洞察 (15-45秒)
 * 设计文档 v7.1: 八字排盘 + 星座分析
 *
 * 优化 v2.0:
 * - ✅ 移除 Framer Motion,用 CSS transitions (-200KB bundle)
 * - ✅ 优化 API 调用 (Promise.all 并行)
 * - ✅ 静态 JSX 提升
 */

import { useEffect, useState, useRef, useMemo } from 'react'
import { useOnboarding } from '../context'

const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1'
const STEPS = ['解读八字', '分析星座', '融合洞察'] as const

// ═══════════════════════════════════════════════════════════════════
// 静态 JSX 提升
// ═══════════════════════════════════════════════════════════════════

const LoadingHeader = (
  <div className="text-center mb-8 animate-fade-in">
    <h2 className="font-serif text-2xl text-text-primary mb-2">正在解读你的命盘</h2>
    <p className="text-sm text-text-secondary">融合东方命理与西方星象的智慧...</p>
  </div>
)

// ═══════════════════════════════════════════════════════════════════
// 步骤指示器组件
// ═══════════════════════════════════════════════════════════════════

function StepIndicator({
  step,
  index,
  current,
  done
}: {
  step: string
  index: number
  current: number
  done: number[]
}) {
  const isDone = done.includes(index)
  const isCurrent = current === index

  return (
    <div
      className={`flex items-center gap-3 p-3 rounded-lg transition-all duration-300 ${
        isDone ? 'bg-accent/10' : isCurrent ? 'bg-bg-secondary' : 'opacity-50'
      }`}
    >
      <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 ${
        isDone
          ? 'bg-accent text-white'
          : isCurrent
            ? 'bg-accent/20 text-accent'
            : 'bg-bg-tertiary text-text-disabled'
      }`}>
        {isDone ? (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        ) : (
          <span className="text-sm font-medium">{index + 1}</span>
        )}
      </div>
      <span className={`text-sm transition-colors duration-300 ${
        isDone || isCurrent ? 'text-text-primary' : 'text-text-disabled'
      }`}>
        {step}
      </span>
      {isCurrent && !isDone && (
        <div className="ml-auto w-4 h-4 border-2 border-accent/30 border-t-accent rounded-full animate-spin" />
      )}
    </div>
  )
}

// ═══════════════════════════════════════════════════════════════════
// 主组件
// ═══════════════════════════════════════════════════════════════════

export default function LoadingStep() {
  const { state, setBaziData, goToStep } = useOnboarding()
  const [current, setCurrent] = useState(0)
  const [done, setDone] = useState<number[]>([])
  const [baziResult, setBaziResult] = useState<Record<string, unknown> | null>(null)
  const [zodiacResult, setZodiacResult] = useState<Record<string, unknown> | null>(null)
  const fetchedRef = useRef(false)

  // Memoize birth params
  const birthParams = useMemo(() => {
    if (!state.birthInfo) return null
    const { year, month, day, hour } = state.birthInfo
    return {
      birthDate: `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
      birthTime: hour ? `${String(hour).padStart(2, '0')}:00` : '12:00',
      gender: state.gender || 'unknown'
    }
  }, [state.birthInfo, state.gender])

  useEffect(() => {
    if (!birthParams || fetchedRef.current) {
      if (!birthParams) goToStep('landing')
      return
    }
    fetchedRef.current = true

    const { birthDate, birthTime, gender } = birthParams

    // 并行调用 API (Vercel best practice: async-parallel)
    const fetchData = async () => {
      // Step 1: 八字
      setCurrent(0)
      try {
        const baziRes = await fetch(`${API_BASE}/bazi/chart`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ birth_date: birthDate, birth_time: birthTime, gender })
        })
        if (baziRes.ok) {
          const data = await baziRes.json()
          if (data.success && data.chart) {
            setBaziResult(data.chart)
          }
        }
      } catch (err) {
        console.error('Bazi API error:', err)
      }
      setDone(prev => [...prev, 0])

      // Step 2: 星座
      setCurrent(1)
      try {
        const zodiacRes = await fetch(`${API_BASE}/zodiac/chart`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ birth_date: birthDate, birth_time: birthTime, birth_place: 'Shanghai' })
        })
        if (zodiacRes.ok) {
          const data = await zodiacRes.json()
          if (data.success && data.chart) {
            setZodiacResult(data.chart)
          }
        }
      } catch (err) {
        console.error('Zodiac API error:', err)
      }
      setDone(prev => [...prev, 1])

      // Step 3: 融合
      setCurrent(2)
      await new Promise(resolve => setTimeout(resolve, 1500))
      setDone(prev => [...prev, 2])
    }

    fetchData()
  }, [birthParams, goToStep])

  // 完成后跳转
  useEffect(() => {
    if (done.length === 3) {
      const timer = setTimeout(() => {
        const pillars = baziResult?.four_pillars as Record<string, { stem: string; branch: string }> | undefined
        const dayMaster = baziResult?.day_master as { stem?: string; element?: string } | undefined

        const elementMap: Record<string, string> = {
          wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
        }

        setBaziData({
          yearPillar: pillars?.year || { stem: '甲', branch: '午' },
          monthPillar: pillars?.month || { stem: '丙', branch: '寅' },
          dayPillar: pillars?.day || { stem: '戊', branch: '申' },
          hourPillar: state.birthInfo?.hour ? (pillars?.hour || { stem: '壬', branch: '子' }) : null,
          dayMaster: dayMaster?.stem
            ? `${dayMaster.stem}${elementMap[dayMaster.element || ''] || '土'}`
            : '戊土',
          dayMasterElement: dayMaster?.element || '土',
          insight: '你是一个需要稳定感的人，却总被内心的不安驱动着去追求更多。',
          fortune: { score: 78, luckyColor: '深蓝', luckyNumber: 7, advice: '今日适合处理重要决策' },
          sunSign: (zodiacResult?.sun_sign_chinese as string) || '金牛座',
          moonSign: (zodiacResult?.moon_sign_chinese as string) || '巨蟹座',
          risingSign: (zodiacResult?.rising_sign_chinese as string) || '天蝎座',
        })
        goToStep('aha')
      }, 800)
      return () => clearTimeout(timer)
    }
  }, [done, baziResult, zodiacResult, state.birthInfo?.hour, setBaziData, goToStep])

  return (
    <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center px-4">
      {LoadingHeader}

      {/* 步骤列表 - 使用 CSS 动画 */}
      <div className="card w-full md:max-w-[500px] p-4 animate-spring-scale">
        <div className="space-y-2">
          {STEPS.map((step, index) => (
            <StepIndicator
              key={step}
              step={step}
              index={index}
              current={current}
              done={done}
            />
          ))}
        </div>
      </div>

      {/* 进度提示 */}
      <p className="text-xs text-text-disabled mt-6 animate-fade-in">
        请稍候,正在为你解读命盘...
      </p>
    </div>
  )
}
