'use client'

/**
 * Conversion Step - Phase 4: æœŸå¾… (75-90ç§’)
 * è®¾è®¡æ–‡æ¡£ v7.1: ä»Šæ—¥è¿åŠ¿é¢„è§ˆ + åˆ†åŒºå®šä»· + ä»˜è´¹å¼•å¯¼
 *
 * ä¼˜åŒ– v2.0:
 * - âœ… ç§»é™¤ Framer Motion,ç”¨ CSS transitions (-200KB bundle)
 * - âœ… é™æ€ JSX æå‡
 * - âœ… Memoized ç»„ä»¶å‡å°‘é‡æ¸²æŸ“
 */

import { useState, useEffect, memo, useMemo } from 'react'
import { useRouter } from 'next/navigation'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å¸¸é‡å®šä¹‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PRICING = {
  global: { monthly: '$9.90', quarterly: '$24.90', yearly: '$69.90' },
  cn: { monthly: '39 HKD', quarterly: '99 HKD', yearly: '298 HKD' },
} as const

const BENEFITS = [
  'æ¯æ—¥è¿åŠ¿ï¼ˆå®Œæ•´ç‰ˆï¼‰',
  '30æ¬¡/å¤© AI å¯¹è¯',
  'æ™ºèƒ½è§¦å‘æé†’',
  'Identity Prism',
  'å®Œæ•´å¤§è¿/æµå¹´æŠ¥å‘Š',
  'å…³ç³»é…å¯¹åˆ†æ'
] as const

type Region = 'global' | 'cn'
type Plan = 'monthly' | 'quarterly' | 'yearly'

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// é™æ€ JSX æå‡
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const FortunePreview = (
  <div className="card w-full md:max-w-[500px] p-5 mb-6 animate-slide-in-up">
    <div className="flex items-center justify-between mb-3">
      <h3 className="font-serif text-lg text-text-primary">ğŸŒ… ä»Šæ—¥è¿åŠ¿é¢„è§ˆ</h3>
      <span className="text-xs text-accent">ğŸ”’</span>
    </div>
    <p className="text-sm text-text-primary mb-2">èƒ½é‡ä¸»é¢˜ï¼šã€Œçªç ´ã€</p>
    <p className="text-sm text-text-secondary mb-4">ä»Šæ—¥å¯èƒ½é‡åˆ°ä¸€äº›éœ€è¦å†³æ–­çš„äº‹æƒ…...</p>
    <div className="relative">
      <p className="text-sm text-text-secondary blur-sm select-none">
        ä»Šå¤©åœŸæ˜Ÿä¸ä½ çš„æœ¬å‘½å¤ªé˜³å½¢æˆæœ‰åˆ©ç›¸ä½ï¼Œé€‚åˆå¤„ç†é‡è¦å†³ç­–...
      </p>
      <div className="absolute inset-0 flex items-center justify-center">
        <span className="text-sm text-accent">æƒ³äº†è§£å®Œæ•´ä»Šæ—¥è¿åŠ¿ï¼Ÿ</span>
      </div>
    </div>
  </div>
)

const PremiumHeader = (
  <div className="text-center mb-5">
    <h2 className="font-serif text-xl text-text-primary mb-1">âœ¨ VibeLife Premium</h2>
    <p className="text-sm text-text-secondary">è§£é”å®Œæ•´çš„å†…å¿ƒæ¢ç´¢ä½“éªŒ</p>
  </div>
)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// å­ç»„ä»¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PlanButton = memo(function PlanButton({
  planKey,
  currentPlan,
  pricing,
  onSelect
}: {
  planKey: Plan
  currentPlan: Plan
  pricing: typeof PRICING.global
  onSelect: (plan: Plan) => void
}) {
  const isSelected = currentPlan === planKey
  const labels = { monthly: 'æœˆä»˜', quarterly: 'å­£ä»˜', yearly: 'å¹´ä»˜' }
  const savings = { monthly: null, quarterly: 'çœ15%', yearly: 'çœ36%' }

  return (
    <button
      onClick={() => onSelect(planKey)}
      className={`flex-1 relative p-3 rounded-md text-center transition-all duration-normal ${
        isSelected ? 'bg-accent text-white' : 'bg-bg-secondary text-text-primary hover:bg-bg-tertiary'
      }`}
    >
      {planKey === 'yearly' && (
        <span className="absolute -top-2 left-1/2 -translate-x-1/2 text-xs bg-accent text-white px-2 py-0.5 rounded-full">
          æ¨è
        </span>
      )}
      <p className="text-xs mb-1">{labels[planKey]}</p>
      <p className="font-serif text-base font-medium">{pricing[planKey]}</p>
      {savings[planKey] && <p className="text-xs opacity-80">{savings[planKey]}</p>}
    </button>
  )
})

const BenefitsList = memo(function BenefitsList() {
  return (
    <div className="mb-5">
      <p className="text-sm text-text-secondary mb-3">âœ… åŒ…å«å…¨éƒ¨åŠŸèƒ½ï¼š</p>
      <ul className="space-y-2">
        {BENEFITS.map((benefit) => (
          <li key={benefit} className="text-sm text-text-primary flex items-center gap-2">
            <span className="text-accent">Â·</span>
            {benefit}
          </li>
        ))}
      </ul>
    </div>
  )
})

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ä¸»ç»„ä»¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default function ConversionStep() {
  const router = useRouter()
  const [region, setRegion] = useState<Region>('global')
  const [plan, setPlan] = useState<Plan>('yearly')

  // æ£€æµ‹ç”¨æˆ·åŒºåŸŸ
  useEffect(() => {
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone
    if (tz.includes('Shanghai') || tz.includes('Beijing') || tz.includes('Asia/Hong_Kong')) {
      setRegion('cn')
    }
  }, [])

  const pricing = useMemo(() => PRICING[region], [region])

  const handleSubscribe = () => {
    // TODO: å®é™…æ”¯ä»˜æµç¨‹
    router.push('/')
  }

  const handleSkip = () => {
    router.push('/')
  }

  const planLabels = { monthly: 'æœˆ', quarterly: 'å­£', yearly: 'å¹´' }

  return (
    <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center px-4 py-8">
      {/* ä»Šæ—¥è¿åŠ¿é¢„è§ˆ */}
      {FortunePreview}

      {/* Premium è®¢é˜…å¡ç‰‡ */}
      <div
        className="card w-full md:max-w-[500px] p-5 mb-6 animate-slide-in-up"
        style={{ animationDelay: '100ms', animationFillMode: 'both' }}
      >
        {PremiumHeader}

        {/* å®šä»·é€‰æ‹© */}
        <div className="flex gap-2 mb-5">
          {(['monthly', 'quarterly', 'yearly'] as const).map((planKey) => (
            <PlanButton
              key={planKey}
              planKey={planKey}
              currentPlan={plan}
              pricing={pricing}
              onSelect={setPlan}
            />
          ))}
        </div>

        {/* åŠŸèƒ½åˆ—è¡¨ */}
        <BenefitsList />

        {/* è®¢é˜…æŒ‰é’® */}
        <button
          onClick={handleSubscribe}
          className="btn-primary w-full mb-3 hover:scale-[1.02] active:scale-[0.98] transition-transform duration-normal"
        >
          ç«‹å³è®¢é˜… Â· {pricing[plan]}/{planLabels[plan]}
        </button>
        <p className="text-xs text-text-disabled text-center">7å¤©æ— ç†ç”±é€€æ¬¾ä¿éšœ</p>
      </div>

      {/* è·³è¿‡æŒ‰é’® */}
      <button
        onClick={handleSkip}
        className="text-sm text-text-secondary hover:text-accent transition-colors duration-normal animate-fade-in"
        style={{ animationDelay: '300ms', animationFillMode: 'both' }}
      >
        æˆ–ç»§ç»­å…è´¹ä½“éªŒ â†’
      </button>
    </div>
  )
}
