#!/bin/bash
# VibeLife Knowledge Sync Script
# 默认：sync + ingest（扫描并处理）
# --sync-only: 只扫描不处理

set -e

VIBELIFE_ROOT="${VIBELIFE_ROOT:-/home/aiscend/work/vibelife}"

cd "$VIBELIFE_ROOT"

# 加载环境变量
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# 检查是否只执行 sync
SYNC_ONLY=false
for arg in "$@"; do
    if [ "$arg" = "--sync-only" ]; then
        SYNC_ONLY=true
    fi
done

# Step 1: 同步文档
echo "=== Step 1: Syncing knowledge documents ==="
python -m apps.api.scripts.sync_knowledge "$@"

# Step 2: 处理文档（除非 --sync-only 或 --stats）
if [ "$SYNC_ONLY" = false ] && [[ ! " $* " =~ " --stats " ]]; then
    echo ""
    echo "=== Step 2: Processing pending documents ==="
    python -c "
import asyncio
import sys
sys.path.insert(0, 'apps/api')

from stores.db import init_db, close_db
from workers.ingestion import IngestionWorker

async def process_all():
    await init_db()
    worker = IngestionWorker()

    # 处理所有 pending 文档直到完成
    while True:
        doc = await worker._claim_document()
        if not doc:
            break
        await worker._process_document(doc)

    await close_db()
    print('All pending documents processed.')

asyncio.run(process_all())
"
fi
