#!/bin/bash
# VibeLife Ingestion Worker
# 处理 pending 文档：转换 → 分块 → 向量化 → 入库

set -e

VIBELIFE_ROOT="${VIBELIFE_ROOT:-/home/aiscend/work/vibelife}"

cd "$VIBELIFE_ROOT"

# 加载环境变量
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

# 启动 ingestion worker
echo "Starting Ingestion Worker..."
echo "Press Ctrl+C to stop"
echo ""

python -c "
import asyncio
import sys
sys.path.insert(0, 'apps/api')

from stores.db import init_db, close_db
from workers.ingestion import IngestionWorker

async def main():
    await init_db()
    worker = IngestionWorker()

    try:
        await worker.start()
        # Keep running until interrupted
        while True:
            await asyncio.sleep(1)
    except KeyboardInterrupt:
        print('\nStopping worker...')
    finally:
        await worker.stop()
        await close_db()

asyncio.run(main())
"
