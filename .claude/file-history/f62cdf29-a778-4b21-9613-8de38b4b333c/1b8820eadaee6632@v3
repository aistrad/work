#!/bin/bash
# VibeLife Ingestion
# 处理所有 pending 文档：转换 → 分块 → 向量化 → 入库

set -e

VIBELIFE_ROOT="${VIBELIFE_ROOT:-/home/aiscend/work/vibelife}"

cd "$VIBELIFE_ROOT"

# 加载环境变量
if [ -f .env ]; then
    export $(grep -v '^#' .env | xargs)
fi

echo "Processing pending documents..."

python -c "
import asyncio
import sys
sys.path.insert(0, 'apps/api')

from stores.db import init_db, close_db
from workers.ingestion import IngestionWorker

async def process_all():
    await init_db()
    worker = IngestionWorker()
    count = 0

    while True:
        doc = await worker._claim_document()
        if not doc:
            break
        await worker._process_document(doc)
        count += 1

    await close_db()
    if count > 0:
        print(f'Processed {count} document(s).')
    else:
        print('No pending documents.')

asyncio.run(process_all())
"
