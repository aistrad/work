# VibeLife 系统配置手册

> 本文档包含配置和运行整个系统所需的全部核心信息

---

## 1. 环境变量完整配置

复制到 `.env` 文件（项目根目录）:

```bash
# ═══════════════════════════════════════════════════════════════
# 数据库 (必需)
# ═══════════════════════════════════════════════════════════════
VIBELIFE_DB_URL=postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
VIBELIFE_DB_HOST=106.37.170.238
VIBELIFE_DB_PORT=8224
VIBELIFE_DB_NAME=vibelife
VIBELIFE_DB_USER=postgres
VIBELIFE_DB_PASSWORD=Ak4_9lScd-69WX
VIBELIFE_DB_SSLMODE=prefer

# ═══════════════════════════════════════════════════════════════
# JWT 认证 (必需)
# ═══════════════════════════════════════════════════════════════
VIBELIFE_JWT_SECRET=vibelife-jwt-secret-key-2026-aiscend
VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30

# ═══════════════════════════════════════════════════════════════
# API 服务 (必需)
# ═══════════════════════════════════════════════════════════════
VIBELIFE_API_PORT=8000
VIBELIFE_API_HOST=0.0.0.0
VIBELIFE_DEV=1
VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8230,http://106.37.170.238:8231,http://106.37.170.238:8232,http://localhost:3000

# ═══════════════════════════════════════════════════════════════
# LLM 服务 (必需，至少配置一个)
# ═══════════════════════════════════════════════════════════════

# 智谱 GLM (主要对话模型)
GLM_API_KEY=42b82ed9a13e4e8890ef3854bb840ef8.TcWZ4DIq0NF2xElF
GLM_CHAT_MODEL=glm-4-flash
GLM_VISION_MODEL=glm-4.6v
GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4

# Claude (备选)
CLAUDE_API_KEY=sk-Z0kVvuz5cIwtomKfLQH23MuYxsTgG7IuFxSDaeYoV4xwHGqD
CLAUDE_BASE_URL=https://uapi.chat
CLAUDE_MODEL=claude-3-5-sonnet-20241022

# Gemini (生图 + Embedding)
GEMINI_API_KEY=sk-ynk9oTMtjhszj4IDoyUZreMg04NfefVGTlFtW7QvGYw4k9Dg
GEMINI_BASE_URL=https://new.12ai.org/v1
GEMINI_CHAT_MODEL=gemini-2.5-flash
GEMINI_IMAGE_MODEL=gemini-2.5-flash-image

# 默认提供商 (已迁移到 config/models.yaml)
# DEFAULT_LLM_PROVIDER 已废弃，从 models.yaml defaults.chat.primary 读取
# DEFAULT_IMAGE_PROVIDER 已废弃，从 models.yaml defaults.image_gen.primary 读取

# ═══════════════════════════════════════════════════════════════
# 向量嵌入 + 存储 (知识库必需)
# ═══════════════════════════════════════════════════════════════
EMBEDDING_MODEL_NAME=BAAI/bge-m3
EMBEDDING_DIMENSION=1024
EMBEDDING_DEVICE=cuda
EMBEDDING_LOCAL_DIR=/home/aiscend/.cache/vibelife/models/bge-m3
# 向量存储使用 PostgreSQL pgvector，无需额外配置

# ═══════════════════════════════════════════════════════════════
# Stripe 支付 (商业化必需)
# ═══════════════════════════════════════════════════════════════
STRIPE_SECRET_KEY=sk_test_51Snq9KE8u1baYET0WjoEzHNCjlDAkaaATNEFyziJs4X1HF1AjPnV4YhrjS2Gy6UIhGApAenJn8BbP1uxwMrleRbS000LPmMzrC
STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
# STRIPE_WEBHOOK_SECRET=whsec_xxx  # Stripe Dashboard 创建 webhook 后获取

# ═══════════════════════════════════════════════════════════════
# 数据目录
# ═══════════════════════════════════════════════════════════════
VIBELIFE_DATA_ROOT=/data/vibelife
VIBELIFE_KNOWLEDGE_ROOT=/data/vibelife/knowledge
VIBELIFE_UPLOADS_ROOT=/data/vibelife/uploads
VIBELIFE_CACHE_ROOT=/data/vibelife/cache
VIBELIFE_LOGS_ROOT=/data/vibelife/logs

# ═══════════════════════════════════════════════════════════════
# 域名 (生产环境)
# ═══════════════════════════════════════════════════════════════
VIBELIFE_DOMAIN=vibelife.app
BAZI_DOMAIN=bazi.vibelife.app
ZODIAC_DOMAIN=zodiac.vibelife.app
MBTI_DOMAIN=mbti.vibelife.app
ID_DOMAIN=id.vibelife.app
VIBELIFE_WEB_URL=http://106.37.170.238:8232
```

---

## 2. 前端环境变量

`apps/web/.env.local`:

```bash
NEXT_PUBLIC_API_URL=http://106.37.170.238:8100
NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1
NEXT_PUBLIC_WS_URL=ws://106.37.170.238:8100/ws
VIBELIFE_API_INTERNAL=http://127.0.0.1:8100
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
```

---

## 3. 数据库初始化

```bash
# 连接数据库
psql postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife

# 按顺序执行迁移
psql -f migrations/001_v3_schema.sql
psql -f migrations/002_interview_sessions.sql
psql -f migrations/003_model_router.sql
psql -f migrations/004_update_model_routes.sql
psql -f migrations/005_user_gender_voice_mode.sql
psql -f migrations/006_fix_knowledge_table_refs.sql
psql -f migrations/007_skill_terms.sql
psql -f migrations/008_knowledge_converted_path.sql
psql -f migrations/009_user_notifications.sql
psql -f migrations/010_user_entitlements.sql
psql -f migrations/011_guest_sessions.sql
psql -f migrations/012_payment_dual_track.sql
psql -f migrations/013_fortune_cache.sql
psql -f migrations/014_user_skill_data.sql
```

必需扩展: `uuid-ossp`, `pgcrypto`, `vector` (pgvector)

---

## 4. 启动与部署

### 4.1 基础依赖安装

```bash
# 前端依赖
pnpm install

# 后端依赖
pip install -r apps/api/requirements.txt
```

### 4.2 开发与测试环境

```bash
# 开发环境 (API: 8000, Web: 3000)
cd apps/api && uvicorn main:app --reload --host 0.0.0.0 --port 8000
cd apps/web && pnpm dev

# 测试环境 (API: 8100, Web: 8232)
cd apps/api && uvicorn main:app --host 0.0.0.0 --port 8100
cd apps/web && PORT=8232 pnpm dev
```

### 4.3 生产环境分布式部署 (Cloudflare + 火山香港 + 北京)

**网络路径：** 用户 (全球) -> Cloudflare (边缘节点) -> [HTTPS加密隧道] -> 火山引擎香港 (源站Nginx) -> 火山引擎香港 (前端Next.js) -> 北京服务器 (API后端) -> 北京服务器 (PgSQL)

#### A. Cloudflare 安全配置
1. **Origin CA 证书**:
   - `SSL/TLS` -> `Origin Server` -> `Create Certificate` (ECC, 15年)。
   - 复制证书和私钥，分别保存至 `deploy/huoshan/vibelife.pem` 和 `vibelife.key`。
2. **加密模式**: `SSL/TLS` -> `Overview` -> 选择 **Full (Strict) / 完全（严格）**。
3. **DNS 代理**:
   - 配置 `@` 及所有子域名 (`bazi/zodiac/id/mbti/m`) 的 A 记录指向香港服务器 `101.47.72.235`。
   - 确保 **Proxy status** 为 **Proxied (开启代理/小黄云)** 以享受 DDoS 防护和加速。

#### B. 火山香港服务器 (前端/入口)
1. **工程同步**: `git clone git@github.com:aiscendtech/vibelife.git /opt/vibelife`
2. **Nginx 配置**:
   ```bash
   cp /opt/vibelife/deploy/huoshan/vibelife.conf /etc/nginx/sites-enabled/
   rm /etc/nginx/sites-enabled/default
   nginx -t && systemctl reload nginx
   ```
3. **前端服务 (端口 8230)**:
   ```bash
   cd /opt/vibelife/apps/web
   ./start_web.sh  # 首次需安装 Node 25/pnpm
   ```

#### C. 北京服务器 (后端/数据)
1. **API 服务 (端口 8231)**:
   ```bash
   cd /opt/vibelife/apps/api
   ./start_api.sh
   ```
2. **更新后重启**: 每次代码更新后，分别执行对应的 `start_web.sh` 或 `start_api.sh`。

---

## 5. 端口分配

| 服务 | 开发 | 测试 | 生产 (分布式) |
|------|------|------|--------------|
| API Backend | 8000 | 8100 | 8231 (北京) |
| Web Frontend | 3000 | 8232 | 8230 (香港) |
| PostgreSQL | - | 8224 | 8224 (北京) |
| Nginx (Entry) | - | - | 80/443 (香港) |

---

## 6. 核心目录结构

```
apps/api/
├── main.py              # 入口，路由注册
├── routes/              # API 路由 (17个)
├── services/            # 业务服务 (21个模块)
│   ├── vibe_engine/     # 核心引擎 (context, llm, portrait)
│   ├── model_router/    # 模型路由 (多模型、配额、降级)
│   ├── persona/         # 人格系统 (warm/sarcastic/wise)
│   ├── knowledge/       # RAG 知识检索
│   ├── identity/        # 认证 (JWT/OAuth)
│   ├── billing/         # 账单
│   ├── entitlement/     # 权益
│   └── ...
├── stores/db.py         # 数据库连接池
├── tools/               # 命理计算 (bazi/zodiac)
└── workers/             # 后台任务 (IngestionWorker)

apps/web/src/
├── app/                 # Next.js App Router 页面
├── components/          # React 组件
└── hooks/               # 自定义 Hooks
```

---

## 7. API 路由清单

| 路由 | 前缀 | 核心端点 |
|------|------|----------|
| auth | /api/v1 | POST /auth/login, /auth/register |
| guest | /api/v1 | POST /guest/session |
| users | /api/v1 | GET /users/me, PUT /users/profile |
| chat | /api/v1 | POST /chat/message (SSE) |
| onboarding | /api/v1 | POST /onboarding/start |
| report | /api/v1 | POST /report/generate |
| relationship | /api/v1 | POST /relationship/analyze |
| skills | /api/v1 | POST /skills/{skill}/{action} (e.g. bazi: chart/fortune/kline/cycles; zodiac: chart/transit/synastry) |
| notifications | /api/v1 | GET /notifications/daily |
| payment | /api/v1 | POST /payment/create-session |
| billing | /api/v1 | GET /billing/subscription |
| entitlement | /api/v1 | GET /entitlement/check |
| bazi | /api/v1 | POST /bazi/calculate |
| zodiac | /api/v1 | POST /zodiac/chart |
| memories | /api/v1 | GET /memories/insights |
| identity | /api/v1 | POST /identity/link |
| health | / | GET /health |

---

## 8. 数据库核心表

| 表 | 主键 | 关键字段 |
|----|------|----------|
| vibe_users | id (UUID) | vibe_id, email, phone, is_guest |
| user_auth | id | user_id, auth_type, auth_identifier, password_hash |
| user_profiles | id | user_id, version, profile (JSONB) |
| conversations | id | user_id, skill, voice_mode |
| messages | id | conversation_id, role, content |
| reports | id | user_id, skill, report_type, content (JSONB), is_paid |
| relationships | id | initiator_id, partner_id, analysis (JSONB) |
| subscriptions | id | user_id, plan_id, status, current_period_end |
| payments | id | user_id, amount, currency, status |
| user_entitlements | id | user_id, entitlement_type, remaining |
| insights | id | user_id, category, content |

---

## 9. LLM 模型配置

| 用途 | 提供商 | 模型 | 环境变量 |
|------|--------|------|----------|
| 主对话 | 智谱 | glm-4-flash | GLM_CHAT_MODEL |
| 视觉 | 智谱 | glm-4.6v | GLM_VISION_MODEL |
| 备选对话 | Claude | claude-3-5-sonnet | CLAUDE_MODEL |
| 生图 | Gemini | gemini-2.5-flash-image | GEMINI_IMAGE_MODEL |
| 向量嵌入 | 本地 | BAAI/bge-m3 (1024维) | EMBEDDING_MODEL_NAME |

模型路由优先级: 数据库规则 > 代码默认值

---

## 10. 人格系统

| 人格 | voice_mode | 风格 |
|------|------------|------|
| 暖心向导 | warm | 共情、支持、鼓励 |
| 毒舌损友 | sarcastic | 直接、犀利、有趣 |
| 人生导师 | wise | 理性、深度、像长辈指点 |

存储: `user_profiles.profile.preferences.voice_mode`

---

## 11. 支付双轨制

| 轨道 | 货币 | 类型 | 目标用户 |
|------|------|------|----------|
| 海外订阅 | USD | Recurring | 海外用户 |
| 大陆预付 | HKD | One-time | 大陆/香港用户 |

Stripe Price ID 需在 Dashboard 创建后填入环境变量。

---

## 12. 知识库配置

向量嵌入: BAAI/bge-m3 (1024维, 本地 CUDA)
向量存储: PostgreSQL pgvector (1024维, cosine)

知识库目录:
```
packages/knowledge/
├── bazi/      # 八字知识
├── zodiac/    # 星座知识
├── mbti/      # MBTI 知识
└── shared/    # 共享知识
```

---

## 13. 日志位置

- API 请求日志: `/opt/vibelife/logs/api_requests.log`
- 数据目录: `/data/vibelife/`
- Docker 日志: `deploy/aiscend/logs/`

---

## 14. 健康检查

```bash
# API 健康检查
curl http://localhost:8000/health

# 数据库连接测试
psql $VIBELIFE_DB_URL -c "SELECT 1"

# 向量扩展测试
psql $VIBELIFE_DB_URL -c "SELECT vector_dims('[1,2,3]'::vector)"
```

---

## 15. 常见问题

**Q: API 启动失败 "VIBELIFE_DB_URL not set"**
A: 确保 `.env` 文件在项目根目录，且包含 `VIBELIFE_DB_URL`

**Q: 前端无法连接 API**
A: 检查 `VIBELIFE_CORS_ORIGINS` 是否包含前端地址

**Q: 向量嵌入报错**
A: 确保 `EMBEDDING_LOCAL_DIR` 路径存在，或首次运行时会自动下载模型

**Q: Stripe 支付失败**
A: 检查 `STRIPE_SECRET_KEY` 是否正确，测试环境用 `sk_test_` 开头的密钥
