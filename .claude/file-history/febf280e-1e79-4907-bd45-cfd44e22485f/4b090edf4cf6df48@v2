"""
测试语气模式功能
验证 warm / sarcastic / wise 三种语气的 System Prompt 是否正确注入
"""
import sys
from pathlib import Path

# 添加项目根目录到路径
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from services.agent.skill_loader import build_system_prompt, VOICE_MODE_PROMPTS


def test_voice_mode_prompts():
    """测试 VOICE_MODE_PROMPTS 定义是否完整"""
    print("=== 测试 VOICE_MODE_PROMPTS 定义 ===\n")

    required_modes = ["warm", "sarcastic", "wise"]

    for mode in required_modes:
        if mode in VOICE_MODE_PROMPTS:
            print(f"✅ {mode}: 已定义")
            print(f"   内容预览: {VOICE_MODE_PROMPTS[mode][:50]}...\n")
        else:
            print(f"❌ {mode}: 未定义！")

    # 检查是否有不应该存在的模式
    extra_modes = set(VOICE_MODE_PROMPTS.keys()) - set(required_modes)
    if extra_modes:
        print(f"\n⚠️  发现额外的语气模式: {extra_modes}")
        print("   这些模式不在数据库约束中，可能导致问题！")
    else:
        print("\n✅ 没有额外的语气模式")


def test_system_prompt_injection():
    """测试 System Prompt 注入逻辑"""
    print("\n\n=== 测试 System Prompt 注入 ===\n")

    test_cases = [
        {"voice_mode": "warm", "expected": "温暖支持型"},
        {"voice_mode": "sarcastic", "expected": "直接挑战型"},
        {"voice_mode": "wise", "expected": "睿智导师型"},
    ]

    for case in test_cases:
        voice_mode = case["voice_mode"]
        expected = case["expected"]

        user_context = {
            "preferences": {
                "voice_mode": voice_mode
            }
        }

        prompt = build_system_prompt(
            skill_id="lifecoach",
            scenario_id=None,
            user_context=user_context
        )

        if expected in prompt:
            print(f"✅ {voice_mode}: System Prompt 包含语气指令")
        else:
            print(f"❌ {voice_mode}: System Prompt 未包含语气指令！")
            print(f"   期望包含: {expected}")


def test_database_constraint_compatibility():
    """测试与数据库约束的兼容性"""
    print("\n\n=== 测试数据库约束兼容性 ===\n")

    # 数据库约束: CHECK (voice_mode IN ('warm', 'sarcastic', 'wise'))
    db_allowed = {"warm", "sarcastic", "wise"}
    code_defined = set(VOICE_MODE_PROMPTS.keys())

    missing = db_allowed - code_defined
    extra = code_defined - db_allowed

    if missing:
        print(f"❌ 数据库允许但代码未定义: {missing}")
    else:
        print("✅ 所有数据库允许的语气模式都已定义")

    if extra:
        print(f"❌ 代码定义但数据库不允许: {extra}")
        print("   这些模式会导致数据库约束错误！")
    else:
        print("✅ 没有超出数据库约束的语气模式")

    if not missing and not extra:
        print("\n✅✅✅ 完美匹配！代码与数据库约束完全一致")


if __name__ == "__main__":
    print("=" * 60)
    print("语气模式功能测试")
    print("=" * 60)

    test_voice_mode_prompts()
    test_system_prompt_injection()
    test_database_constraint_compatibility()

    print("\n" + "=" * 60)
    print("测试完成")
    print("=" * 60)
