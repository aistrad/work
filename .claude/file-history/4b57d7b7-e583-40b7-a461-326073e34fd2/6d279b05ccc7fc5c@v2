"use client"

import { cn } from "@/lib/utils"
import { useState } from "react"

// 模拟趋势数据
const TREND_DATA = [
  { day: "周一", energy: 65, emotion: 70 },
  { day: "周二", energy: 72, emotion: 68 },
  { day: "周三", energy: 68, emotion: 75 },
  { day: "周四", energy: 78, emotion: 72 },
  { day: "周五", energy: 82, emotion: 80 },
  { day: "周六", energy: 75, emotion: 85 },
  { day: "周日", energy: 80, emotion: 78 },
]

// 模拟事件数据
const EVENTS = [
  { day: "周三", label: "冥想练习", type: "positive" },
  { day: "周五", label: "完成副本", type: "positive" },
]

export function TrendsTab() {
  const [hoveredIndex, setHoveredIndex] = useState<number | null>(null)
  const hoveredData = hoveredIndex !== null ? TREND_DATA[hoveredIndex] : null

  return (
    <div className="p-4 space-y-6">
      {/* 趋势图 */}
      <section>
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold">本周趋势</h2>
          {/* 分离式 Tooltip - 右上角固定显示 */}
          {hoveredData && (
            <div className="text-right">
              <div className="text-xs text-muted-foreground">{hoveredData.day}</div>
              <div className="text-sm font-medium">
                能量 {hoveredData.energy} · 情绪 {hoveredData.emotion}
              </div>
            </div>
          )}
        </div>

        {/* SVG 图表 - 去轴线去网格 */}
        <div className="relative h-48 bg-sidebar rounded-lg p-4">
          <svg
            viewBox="0 0 300 120"
            className="w-full h-full"
            preserveAspectRatio="none"
          >
            {/* 能量曲线 */}
            <path
              d={generateSmoothPath(TREND_DATA.map((d) => d.energy), 300, 120)}
              fill="none"
              stroke="hsl(var(--foreground))"
              strokeWidth="2"
              className="transition-all duration-300"
            />

            {/* 情绪曲线 (虚线) */}
            <path
              d={generateSmoothPath(TREND_DATA.map((d) => d.emotion), 300, 120)}
              fill="none"
              stroke="hsl(var(--muted-foreground))"
              strokeWidth="2"
              strokeDasharray="4 4"
              className="transition-all duration-300"
            />

            {/* 交互点 */}
            {TREND_DATA.map((d, i) => {
              const x = (i / (TREND_DATA.length - 1)) * 280 + 10
              const y = 120 - (d.energy / 100) * 100
              return (
                <circle
                  key={i}
                  cx={x}
                  cy={y}
                  r={hoveredIndex === i ? 6 : 4}
                  fill="hsl(var(--background))"
                  stroke="hsl(var(--foreground))"
                  strokeWidth="2"
                  className="cursor-pointer transition-all duration-150"
                  onMouseEnter={() => setHoveredIndex(i)}
                  onMouseLeave={() => setHoveredIndex(null)}
                />
              )
            })}

            {/* 事件标记 */}
            {EVENTS.map((event, i) => {
              const dayIndex = TREND_DATA.findIndex((d) => d.day === event.day)
              if (dayIndex === -1) return null
              const x = (dayIndex / (TREND_DATA.length - 1)) * 280 + 10
              return (
                <g key={i}>
                  <circle
                    cx={x}
                    cy={115}
                    r={3}
                    fill="hsl(var(--status-foreground))"
                  />
                </g>
              )
            })}
          </svg>

          {/* X 轴标签 */}
          <div className="absolute bottom-0 left-4 right-4 flex justify-between text-xs text-muted-foreground">
            {TREND_DATA.map((d) => (
              <span key={d.day}>{d.day}</span>
            ))}
          </div>
        </div>

        {/* 图例 */}
        <div className="flex items-center justify-center gap-6 mt-3 text-xs text-muted-foreground">
          <div className="flex items-center gap-1.5">
            <div className="w-3 h-0.5 bg-foreground" />
            <span>能量</span>
          </div>
          <div className="flex items-center gap-1.5">
            <div className="w-3 h-0.5 bg-muted-foreground" style={{ borderTop: "1px dashed" }} />
            <span>情绪</span>
          </div>
        </div>
      </section>

      {/* 事件时间线 */}
      <section>
        <h2 className="text-lg font-semibold mb-4">关键事件</h2>
        <div className="space-y-3">
          {EVENTS.map((event, i) => (
            <div
              key={i}
              className={cn(
                "flex items-center gap-3 p-3 rounded-lg",
                "bg-sidebar hover:bg-hover transition-colors cursor-pointer"
              )}
            >
              <div
                className={cn(
                  "w-2 h-2 rounded-full",
                  event.type === "positive"
                    ? "bg-status-foreground"
                    : "bg-alert-foreground"
                )}
              />
              <div className="flex-1">
                <div className="text-sm font-medium text-foreground">{event.label}</div>
                <div className="text-xs text-muted-foreground">{event.day}</div>
              </div>
              <span className="text-xs text-muted-foreground">→ 查看对话</span>
            </div>
          ))}
        </div>
      </section>
    </div>
  )
}

// 生成平滑曲线路径 (monotone 插值简化版)
function generateSmoothPath(values: number[], width: number, height: number): string {
  const points = values.map((v, i) => ({
    x: (i / (values.length - 1)) * (width - 20) + 10,
    y: height - 20 - (v / 100) * (height - 40),
  }))

  if (points.length < 2) return ""

  let path = `M ${points[0].x} ${points[0].y}`

  for (let i = 1; i < points.length; i++) {
    const prev = points[i - 1]
    const curr = points[i]
    const cpx = (prev.x + curr.x) / 2
    path += ` C ${cpx} ${prev.y}, ${cpx} ${curr.y}, ${curr.x} ${curr.y}`
  }

  return path
}
