"use client"

import { cn } from "@/lib/utils"
import { useAppStore } from "@/stores/app-store"
import { RefreshCw, Pin, AlertTriangle, ChevronDown } from "lucide-react"
import { useState } from "react"

export function OverviewTab() {
  const { status, todayQuests, pinnedArtifacts } = useAppStore()
  const [showRisk, setShowRisk] = useState(false)

  return (
    <div className="p-4 space-y-4">
      {/* Bento Grid å¸ƒå±€ */}
      <div className="grid grid-cols-2 gap-4">
        {/* 1. ä»Šæ—¥ä¸€å¥è¯æ´å¯Ÿ - å æ»¡å®½åº¦ */}
        <InsightCard className="col-span-2" />

        {/* 2. ä»Šæ—¥ä¸‰ä»»åŠ¡ */}
        <TodayQuestsCard quests={todayQuests} className="col-span-2" />

        {/* 3. äº”ç»´çŠ¶æ€æ¡ */}
        <StatusBarsCard status={status} />

        {/* 4. æœ€è¿‘é’‰ä½ */}
        <PinnedCard artifacts={pinnedArtifacts} />
      </div>

      {/* 5. é£é™©æç¤º (æŠ˜å ) */}
      <RiskCard isOpen={showRisk} onToggle={() => setShowRisk(!showRisk)} />
    </div>
  )
}

// ä¸€å¥è¯æ´å¯Ÿå¡ç‰‡
function InsightCard({ className }: { className?: string }) {
  return (
    <div
      className={cn(
        "p-4 rounded-lg",
        "bg-advice",
        "relative group",
        className
      )}
    >
      <div className="flex items-start gap-3">
        <div className="flex-shrink-0 text-2xl">ğŸ’¡</div>
        <div className="flex-1">
          <p className="text-foreground font-medium">
            ä»Šå¤©æ˜¯é€‚åˆæ·±åº¦æ€è€ƒçš„ä¸€å¤©ï¼Œä½ çš„èƒ½é‡æ°´å¹³æ­£åœ¨ç¨³æ­¥ä¸Šå‡ã€‚
          </p>
          <p className="text-sm text-muted-foreground mt-1">
            åŸºäºè¿‘7å¤©çš„çŠ¶æ€åˆ†æ
          </p>
        </div>
      </div>
      {/* åˆ·æ–°æŒ‰é’® */}
      <button
        className={cn(
          "absolute top-3 right-3",
          "p-1.5 rounded-md",
          "text-muted-foreground hover:text-foreground hover:bg-hover/50",
          "opacity-0 group-hover:opacity-100 transition-opacity"
        )}
      >
        <RefreshCw className="w-4 h-4" />
      </button>
    </div>
  )
}

// ä»Šæ—¥ä»»åŠ¡å¡ç‰‡
function TodayQuestsCard({
  quests,
  className,
}: {
  quests: { id: string; title: string; duration: number; status: string }[]
  className?: string
}) {
  // æ¨¡æ‹Ÿæ•°æ®
  const mockQuests = quests.length
    ? quests
    : [
        { id: "1", title: "å®Œæˆ 5 åˆ†é’Ÿå‘¼å¸ç»ƒä¹ ", duration: 5, status: "pending" },
        { id: "2", title: "è®°å½•ä»Šæ—¥æ„Ÿæ©äº‹é¡¹", duration: 2, status: "pending" },
        { id: "3", title: "é˜…è¯» 15 åˆ†é’Ÿ", duration: 15, status: "completed" },
      ]

  return (
    <div className={cn("p-4 rounded-lg bg-sidebar", className)}>
      <h3 className="font-medium text-foreground mb-3">ä»Šæ—¥ä»»åŠ¡</h3>
      <div className="space-y-2">
        {mockQuests.map((quest) => (
          <div
            key={quest.id}
            className={cn(
              "flex items-center gap-3 p-2 rounded-md",
              "hover:bg-hover transition-colors",
              quest.status === "completed" && "opacity-60"
            )}
          >
            <div
              className={cn(
                "w-4 h-4 rounded border-2",
                quest.status === "completed"
                  ? "bg-status border-status-foreground"
                  : "border-muted-foreground"
              )}
            />
            <span
              className={cn(
                "flex-1 text-sm",
                quest.status === "completed" && "line-through"
              )}
            >
              {quest.title}
            </span>
            <span className="text-xs text-muted-foreground">
              {quest.duration}åˆ†é’Ÿ
            </span>
          </div>
        ))}
      </div>
    </div>
  )
}

// äº”ç»´çŠ¶æ€æ¡
function StatusBarsCard({
  status,
  className,
}: {
  status: { energy: number; emotion: number; connection: number; growth: number; fortune: number }
  className?: string
}) {
  const dimensions = [
    { key: "energy", label: "èƒ½é‡", value: status.energy, color: "bg-status-foreground" },
    { key: "emotion", label: "æƒ…ç»ª", value: status.emotion, color: "bg-advice-foreground" },
    { key: "connection", label: "è¿æ¥", value: status.connection, color: "bg-mystic-foreground" },
    { key: "growth", label: "æˆé•¿", value: status.growth, color: "bg-alert-foreground" },
    { key: "fortune", label: "è¿åŠ¿", value: status.fortune, color: "bg-foreground" },
  ]

  return (
    <div className={cn("p-4 rounded-lg bg-sidebar", className)}>
      <h3 className="font-medium text-foreground mb-3">çŠ¶æ€æ¦‚è§ˆ</h3>
      <div className="space-y-3">
        {dimensions.map((dim) => (
          <div key={dim.key} className="space-y-1">
            <div className="flex items-center justify-between text-xs">
              <span className="text-muted-foreground">{dim.label}</span>
              <span className="text-foreground font-medium">{dim.value}</span>
            </div>
            <div className="h-1.5 bg-hover rounded-full overflow-hidden">
              <div
                className={cn("h-full rounded-full transition-all duration-500", dim.color)}
                style={{ width: `${dim.value}%` }}
              />
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}

// æœ€è¿‘é’‰ä½å¡ç‰‡
function PinnedCard({
  artifacts,
  className,
}: {
  artifacts: { id: string; title: string; type: string }[]
  className?: string
}) {
  const mockArtifacts = artifacts.length
    ? artifacts
    : [
        { id: "1", title: "æœ¬å‘¨çŠ¶æ€åˆ†æ", type: "analysis" },
        { id: "2", title: "æƒ…ç»ªè¶‹åŠ¿å›¾", type: "chart" },
      ]

  return (
    <div className={cn("p-4 rounded-lg bg-sidebar", className)}>
      <div className="flex items-center gap-2 mb-3">
        <Pin className="w-4 h-4 text-muted-foreground" />
        <h3 className="font-medium text-foreground">æœ€è¿‘é’‰ä½</h3>
      </div>
      <div className="space-y-2">
        {mockArtifacts.map((artifact) => (
          <div
            key={artifact.id}
            className={cn(
              "flex items-center gap-2 p-2 rounded-md",
              "hover:bg-hover transition-colors cursor-pointer"
            )}
          >
            <span className="text-sm">{artifact.type === "analysis" ? "ğŸ“Š" : "ğŸ“ˆ"}</span>
            <span className="text-sm text-foreground truncate">{artifact.title}</span>
          </div>
        ))}
      </div>
    </div>
  )
}

// é£é™©æç¤º (æŠ˜å )
function RiskCard({
  isOpen,
  onToggle,
}: {
  isOpen: boolean
  onToggle: () => void
}) {
  return (
    <div className="rounded-lg bg-alert/50 overflow-hidden">
      <button
        onClick={onToggle}
        className={cn(
          "w-full flex items-center justify-between",
          "p-3 text-left",
          "hover:bg-alert/70 transition-colors"
        )}
      >
        <div className="flex items-center gap-2">
          <AlertTriangle className="w-4 h-4 text-alert-foreground" />
          <span className="text-sm font-medium text-foreground">é£é™©æç¤º</span>
        </div>
        <ChevronDown
          className={cn(
            "w-4 h-4 text-muted-foreground transition-transform",
            isOpen && "rotate-180"
          )}
        />
      </button>
      {isOpen && (
        <div className="px-3 pb-3">
          <p className="text-sm text-muted-foreground">
            æœ¬å‘¨ä¸‰å¯èƒ½æœ‰æ²Ÿé€šå‹åŠ›ï¼Œå»ºè®®æå‰å‡†å¤‡ã€‚
          </p>
        </div>
      )}
    </div>
  )
}
