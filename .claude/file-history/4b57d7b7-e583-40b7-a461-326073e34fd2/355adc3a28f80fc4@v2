"use client"

import { cn } from "@/lib/utils"
import type { Message } from "@/types"
import { BlockRenderer } from "./blocks"
import { ArtifactCard } from "./artifact-card"

interface MessageItemProps {
  message: Message
}

export function MessageItem({ message }: MessageItemProps) {
  const isUser = message.role === "user"

  return (
    <div
      className={cn(
        "group",
        isUser ? "flex justify-end" : "flex justify-start"
      )}
    >
      <div
        className={cn(
          "max-w-[85%]",
          isUser
            ? // 用户消息: 右对齐, 极淡灰底, 去气泡化
              "bg-hover/50 rounded-2xl px-4 py-3"
            : // AI 回复: 左对齐, 无背景
              "space-y-4"
        )}
      >
        {isUser ? (
          // 用户消息: 简单文本
          <p className="text-foreground whitespace-pre-wrap">{message.content}</p>
        ) : (
          // AI 回复: Block 化渲染
          <>
            {message.blocks ? (
              <div className="space-y-3">
                {message.blocks.map((block) => (
                  <BlockRenderer key={block.id} block={block} />
                ))}
              </div>
            ) : (
              // 普通文本 (兼容无 blocks 的消息)
              <div className="prose prose-neutral dark:prose-invert max-w-none">
                <MarkdownContent content={message.content} />
              </div>
            )}

            {/* Artifact Card */}
            {message.artifact && (
              <ArtifactCard artifact={message.artifact} />
            )}
          </>
        )}
      </div>
    </div>
  )
}

// 简单的 Markdown 渲染 (可替换为更完整的库)
function MarkdownContent({ content }: { content: string }) {
  // 简化处理: 分段落
  const paragraphs = content.split("\n\n")

  return (
    <>
      {paragraphs.map((p, i) => (
        <p key={i} className="text-foreground leading-relaxed">
          {p}
        </p>
      ))}
    </>
  )
}
