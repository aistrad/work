import { create } from "zustand"
import type { Message, Artifact, Quest, UserStatus, DashboardTab, Relation } from "@/types"

interface AppState {
  // UI State
  isSidebarOpen: boolean
  activeTab: DashboardTab
  isMobile: boolean

  // Chat State
  messages: Message[]
  isStreaming: boolean

  // Artifacts
  artifacts: Artifact[]
  pinnedArtifacts: Artifact[]

  // User Status
  status: UserStatus

  // Quests
  quests: Quest[]
  todayQuests: Quest[]

  // Relations
  relations: Relation[]

  // Actions
  setSidebarOpen: (open: boolean) => void
  setActiveTab: (tab: DashboardTab) => void
  setIsMobile: (mobile: boolean) => void

  addMessage: (message: Message) => void
  setStreaming: (streaming: boolean) => void

  addArtifact: (artifact: Artifact) => void
  pinArtifact: (id: string) => void
  unpinArtifact: (id: string) => void

  updateStatus: (updates: Partial<UserStatus>) => void

  addQuest: (quest: Quest) => void
  updateQuestStatus: (id: string, status: Quest["status"]) => void
  completeQuest: (id: string) => void
}

export const useAppStore = create<AppState>((set, get) => ({
  // Initial UI State
  isSidebarOpen: true,
  activeTab: "overview",
  isMobile: false,

  // Initial Chat State
  messages: [],
  isStreaming: false,

  // Initial Artifacts
  artifacts: [],
  pinnedArtifacts: [],

  // Initial User Status (五维状态)
  status: {
    energy: 75,
    emotion: 68,
    connection: 82,
    growth: 45,
    fortune: 71,
  },

  // Initial Quests
  quests: [],
  todayQuests: [],

  // Initial Relations
  relations: [],

  // UI Actions
  setSidebarOpen: (open) => set({ isSidebarOpen: open }),
  setActiveTab: (tab) => set({ activeTab: tab }),
  setIsMobile: (mobile) => set({ isMobile: mobile }),

  // Chat Actions
  addMessage: (message) =>
    set((state) => ({
      messages: [...state.messages, message],
    })),

  setStreaming: (streaming) => set({ isStreaming: streaming }),

  // Artifact Actions
  addArtifact: (artifact) =>
    set((state) => ({
      artifacts: [...state.artifacts, artifact],
    })),

  pinArtifact: (id) =>
    set((state) => {
      const artifact = state.artifacts.find((a) => a.id === id)
      if (!artifact) return state

      const updated = { ...artifact, pinned: true }
      return {
        artifacts: state.artifacts.map((a) => (a.id === id ? updated : a)),
        pinnedArtifacts: [...state.pinnedArtifacts, updated],
      }
    }),

  unpinArtifact: (id) =>
    set((state) => ({
      artifacts: state.artifacts.map((a) =>
        a.id === id ? { ...a, pinned: false } : a
      ),
      pinnedArtifacts: state.pinnedArtifacts.filter((a) => a.id !== id),
    })),

  // Status Actions
  updateStatus: (updates) =>
    set((state) => ({
      status: { ...state.status, ...updates },
    })),

  // Quest Actions
  addQuest: (quest) =>
    set((state) => ({
      quests: [...state.quests, quest],
      todayQuests:
        quest.status === "pending"
          ? [...state.todayQuests, quest].slice(0, 3) // 最多3个今日任务
          : state.todayQuests,
    })),

  updateQuestStatus: (id, status) =>
    set((state) => ({
      quests: state.quests.map((q) => (q.id === id ? { ...q, status } : q)),
      todayQuests: state.todayQuests.map((q) =>
        q.id === id ? { ...q, status } : q
      ),
    })),

  completeQuest: (id) => {
    const state = get()
    const quest = state.quests.find((q) => q.id === id)

    if (quest?.rewards) {
      const statusUpdates: Partial<UserStatus> = {}
      quest.rewards.forEach((reward) => {
        const currentValue = state.status[reward.field]
        statusUpdates[reward.field] = Math.min(100, currentValue + reward.value)
      })
      set((s) => ({ status: { ...s.status, ...statusUpdates } }))
    }

    set((state) => ({
      quests: state.quests.map((q) =>
        q.id === id
          ? { ...q, status: "completed", completedAt: new Date() }
          : q
      ),
      todayQuests: state.todayQuests.map((q) =>
        q.id === id
          ? { ...q, status: "completed", completedAt: new Date() }
          : q
      ),
    }))
  },
}))
