"use client"

import { useState } from "react"
import { cn } from "@/lib/utils"
import type { Artifact } from "@/types"
import { useAppStore } from "@/stores/app-store"
import { Pin, FileText, Zap, ExternalLink } from "lucide-react"

interface ArtifactCardProps {
  artifact: Artifact
  className?: string
}

export function ArtifactCard({ artifact, className }: ArtifactCardProps) {
  const { pinArtifact, setActiveTab, setSidebarOpen } = useAppStore()
  const [isPinned, setIsPinned] = useState(artifact.pinned ?? false)
  const [showPulse, setShowPulse] = useState(false)

  // Pin åŠ¨ä½œ
  const handlePin = () => {
    pinArtifact(artifact.id)
    setIsPinned(true)
    // è§¦å‘ Pulse åŠ¨æ•ˆ
    setShowPulse(true)
    setTimeout(() => setShowPulse(false), 500)
  }

  // Save as Page åŠ¨ä½œ
  const handleSave = () => {
    // TODO: å®ç°ä¿å­˜ä¸ºé¡µé¢
    console.log("Save as page:", artifact.id)
  }

  // To Quest åŠ¨ä½œ
  const handleToQuest = () => {
    // TODO: å®ç°è½¬ä¸ºä»»åŠ¡
    setActiveTab("quests")
    setSidebarOpen(true)
  }

  // åœ¨åŠŸèƒ½åŒºæ‰“å¼€
  const handleOpenInDashboard = () => {
    // æ ¹æ® artifact ç±»å‹åˆ‡æ¢åˆ°å¯¹åº” tab
    const tabMap: Record<Artifact["type"], string> = {
      analysis: "trends",
      suggestion: "overview",
      chart: "trends",
      mystic: "explore",
      course: "explore",
    }
    setActiveTab(tabMap[artifact.type] as never)
    setSidebarOpen(true)
  }

  // å›¾æ ‡æ˜ å°„
  const iconMap: Record<Artifact["type"], React.ReactNode> = {
    analysis: "ğŸ“Š",
    suggestion: "ğŸ’¡",
    chart: "ğŸ“ˆ",
    mystic: "ğŸ”®",
    course: "ğŸ“š",
  }

  return (
    <div
      className={cn(
        "group relative",
        "bg-sidebar rounded-lg border border-border",
        "p-4",
        "transition-all duration-200",
        "hover:shadow-hover",
        showPulse && "pulse",
        className
      )}
    >
      {/* ä¸‰é”®æ“ä½œ - å³ä¸Šè§’ */}
      <div
        className={cn(
          "absolute top-2 right-2",
          "flex items-center gap-1",
          "opacity-0 group-hover:opacity-100 transition-opacity"
        )}
      >
        <button
          onClick={handlePin}
          disabled={isPinned}
          title="é’‰ä½"
          className={cn(
            "p-1.5 rounded-md",
            "text-muted-foreground hover:text-foreground hover:bg-hover",
            "transition-colors",
            isPinned && "text-foreground bg-hover"
          )}
        >
          <Pin className="w-4 h-4" />
        </button>
        <button
          onClick={handleSave}
          title="ä¿å­˜ä¸ºé¡µé¢"
          className={cn(
            "p-1.5 rounded-md",
            "text-muted-foreground hover:text-foreground hover:bg-hover",
            "transition-colors"
          )}
        >
          <FileText className="w-4 h-4" />
        </button>
        <button
          onClick={handleToQuest}
          title="è½¬ä¸ºä»»åŠ¡"
          className={cn(
            "p-1.5 rounded-md",
            "text-muted-foreground hover:text-foreground hover:bg-hover",
            "transition-colors"
          )}
        >
          <Zap className="w-4 h-4" />
        </button>
      </div>

      {/* å¡ç‰‡å†…å®¹ */}
      <div className="flex items-start gap-3">
        <div className="flex-shrink-0 text-2xl">{iconMap[artifact.type]}</div>
        <div className="flex-1 min-w-0">
          <h4 className="font-medium text-foreground truncate">{artifact.title}</h4>
          <p className="text-sm text-muted-foreground mt-1 line-clamp-2">
            {artifact.summary}
          </p>
        </div>
      </div>

      {/* CTA æŒ‰é’® */}
      <button
        onClick={handleOpenInDashboard}
        className={cn(
          "mt-3 w-full flex items-center justify-center gap-2",
          "px-3 py-2 rounded-md",
          "text-sm font-medium",
          "bg-hover text-foreground",
          "hover:bg-foreground hover:text-background",
          "transition-colors"
        )}
      >
        <ExternalLink className="w-4 h-4" />
        åœ¨åŠŸèƒ½åŒºæ‰“å¼€
      </button>
    </div>
  )
}
