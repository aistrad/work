import { test, expect, Page } from '@playwright/test';

const BASE_URL = 'http://106.37.170.238:8230';

test.describe('VibeLife Frontend - Comprehensive UI/UX Review', () => {

  test.describe('Homepage Tests', () => {

    test('should load homepage successfully', async ({ page }) => {
      await page.goto(BASE_URL);
      await expect(page).toHaveTitle(/VibeLife|Home/i);

      // Screenshot for visual review
      await page.screenshot({ path: 'tests/e2e/screenshots/homepage.png', fullPage: true });
    });

    test('should have proper navigation structure', async ({ page }) => {
      await page.goto(BASE_URL);

      // Check for navigation elements
      const nav = page.locator('nav, header');
      await expect(nav).toBeVisible({ timeout: 10000 });

      // Check for key navigation links
      const links = await page.locator('a[href*="bazi"], a[href*="zodiac"]').count();
      console.log(`Found ${links} navigation links`);
    });

    test('should be responsive', async ({ page }) => {
      // Desktop
      await page.setViewportSize({ width: 1920, height: 1080 });
      await page.goto(BASE_URL);
      await page.screenshot({ path: 'tests/e2e/screenshots/homepage-desktop.png', fullPage: true });

      // Tablet
      await page.setViewportSize({ width: 768, height: 1024 });
      await page.screenshot({ path: 'tests/e2e/screenshots/homepage-tablet.png', fullPage: true });

      // Mobile
      await page.setViewportSize({ width: 375, height: 667 });
      await page.screenshot({ path: 'tests/e2e/screenshots/homepage-mobile.png', fullPage: true });
    });

    test('should have working CTA buttons', async ({ page }) => {
      await page.goto(BASE_URL);

      // Look for primary action buttons
      const buttons = page.locator('button, a[role="button"]');
      const count = await buttons.count();
      console.log(`Found ${count} interactive buttons/links`);

      for (let i = 0; i < Math.min(count, 5); i++) {
        const btn = buttons.nth(i);
        const isVisible = await btn.isVisible();
        const text = await btn.textContent();
        console.log(`Button ${i}: "${text}" - Visible: ${isVisible}`);
      }
    });

    test('should load without console errors', async ({ page }) => {
      const errors: string[] = [];
      page.on('console', msg => {
        if (msg.type() === 'error') {
          errors.push(msg.text());
        }
      });

      await page.goto(BASE_URL);
      await page.waitForLoadState('networkidle');

      console.log(`Console errors: ${errors.length}`);
      errors.forEach(err => console.log(`  - ${err}`));
    });
  });

  test.describe('Bazi Chat Page Tests', () => {

    test('should load Bazi chat page', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await expect(page).toHaveURL(/\/bazi\/chat/);

      await page.screenshot({ path: 'tests/e2e/screenshots/bazi-chat-initial.png', fullPage: true });
    });

    test('should have chat interface elements', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Check for chat input
      const input = page.locator('input[type="text"], textarea').first();
      await expect(input).toBeVisible({ timeout: 10000 });

      // Check for send button
      const sendButton = page.locator('button[type="submit"], button:has-text("发送"), button:has-text("Send")').first();
      const hasSendBtn = await sendButton.count() > 0;
      console.log(`Send button present: ${hasSendBtn}`);

      await page.screenshot({ path: 'tests/e2e/screenshots/bazi-chat-interface.png', fullPage: true });
    });

    test('should handle chat input interaction', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      const input = page.locator('input[type="text"], textarea').first();
      await input.waitFor({ state: 'visible', timeout: 10000 });

      // Type a test message
      await input.fill('你好，我想了解我的八字');

      // Check if input value is set
      const value = await input.inputValue();
      console.log(`Input value: "${value}"`);

      await page.screenshot({ path: 'tests/e2e/screenshots/bazi-chat-input-filled.png', fullPage: true });
    });

    test('should show tool UI components', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Look for tool-related UI elements (charts, fortunes, etc.)
      const toolElements = await page.locator('[class*="tool"], [class*="chart"], [class*="fortune"], [data-tool]').count();
      console.log(`Found ${toolElements} potential tool UI elements`);

      await page.screenshot({ path: 'tests/e2e/screenshots/bazi-chat-tools.png', fullPage: true });
    });

    test('should be responsive - Bazi chat', async ({ page }) => {
      // Desktop
      await page.setViewportSize({ width: 1920, height: 1080 });
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');
      await page.screenshot({ path: 'tests/e2e/screenshots/bazi-desktop.png', fullPage: true });

      // Mobile
      await page.setViewportSize({ width: 375, height: 667 });
      await page.screenshot({ path: 'tests/e2e/screenshots/bazi-mobile.png', fullPage: true });
    });
  });

  test.describe('Zodiac Chat Page Tests', () => {

    test('should load Zodiac chat page', async ({ page }) => {
      await page.goto(`${BASE_URL}/zodiac/chat`);
      await expect(page).toHaveURL(/\/zodiac\/chat/);

      await page.screenshot({ path: 'tests/e2e/screenshots/zodiac-chat-initial.png', fullPage: true });
    });

    test('should have chat interface elements', async ({ page }) => {
      await page.goto(`${BASE_URL}/zodiac/chat`);
      await page.waitForLoadState('networkidle');

      // Check for chat input
      const input = page.locator('input[type="text"], textarea').first();
      await expect(input).toBeVisible({ timeout: 10000 });

      await page.screenshot({ path: 'tests/e2e/screenshots/zodiac-chat-interface.png', fullPage: true });
    });

    test('should handle chat input interaction', async ({ page }) => {
      await page.goto(`${BASE_URL}/zodiac/chat`);
      await page.waitForLoadState('networkidle');

      const input = page.locator('input[type="text"], textarea').first();
      await input.waitFor({ state: 'visible', timeout: 10000 });

      // Type a test message
      await input.fill('我是白羊座，想了解今日运势');

      const value = await input.inputValue();
      console.log(`Input value: "${value}"`);

      await page.screenshot({ path: 'tests/e2e/screenshots/zodiac-chat-input-filled.png', fullPage: true });
    });

    test('should be responsive - Zodiac chat', async ({ page }) => {
      // Desktop
      await page.setViewportSize({ width: 1920, height: 1080 });
      await page.goto(`${BASE_URL}/zodiac/chat`);
      await page.waitForLoadState('networkidle');
      await page.screenshot({ path: 'tests/e2e/screenshots/zodiac-desktop.png', fullPage: true });

      // Mobile
      await page.setViewportSize({ width: 375, height: 667 });
      await page.screenshot({ path: 'tests/e2e/screenshots/zodiac-mobile.png', fullPage: true });
    });
  });

  test.describe('Cross-page Navigation Tests', () => {

    test('should navigate between pages smoothly', async ({ page }) => {
      // Start at homepage
      await page.goto(BASE_URL);
      await page.waitForLoadState('networkidle');

      // Try to navigate to Bazi chat
      const baziLink = page.locator('a[href*="/bazi"]').first();
      if (await baziLink.count() > 0) {
        await baziLink.click();
        await page.waitForURL(/\/bazi/, { timeout: 10000 });
        console.log('Successfully navigated to Bazi page');
      } else {
        console.log('No Bazi navigation link found on homepage');
        await page.goto(`${BASE_URL}/bazi/chat`);
      }

      await page.screenshot({ path: 'tests/e2e/screenshots/navigation-test.png', fullPage: true });
    });
  });

  test.describe('Performance & Accessibility Tests', () => {

    test('should check page load performance', async ({ page }) => {
      const startTime = Date.now();
      await page.goto(BASE_URL);
      await page.waitForLoadState('networkidle');
      const loadTime = Date.now() - startTime;

      console.log(`Homepage load time: ${loadTime}ms`);
      expect(loadTime).toBeLessThan(10000); // Should load within 10 seconds
    });

    test('should have proper semantic HTML', async ({ page }) => {
      await page.goto(BASE_URL);

      const hasMain = await page.locator('main').count() > 0;
      const hasHeader = await page.locator('header').count() > 0;
      const hasNav = await page.locator('nav').count() > 0;

      console.log(`Semantic HTML check - main: ${hasMain}, header: ${hasHeader}, nav: ${hasNav}`);
    });

    test('should have accessible form elements', async ({ page }) => {
      await page.goto(`${BASE_URL}/bazi/chat`);
      await page.waitForLoadState('networkidle');

      // Check for labels, aria-labels, or placeholders
      const inputs = page.locator('input, textarea');
      const count = await inputs.count();

      for (let i = 0; i < count; i++) {
        const input = inputs.nth(i);
        const hasLabel = await input.getAttribute('aria-label') ||
                        await input.getAttribute('placeholder') ||
                        await page.locator(`label[for="${await input.getAttribute('id')}"]`).count() > 0;
        console.log(`Input ${i} has accessible label: ${!!hasLabel}`);
      }
    });
  });

  test.describe('Visual Consistency Tests', () => {

    test('should have consistent color scheme', async ({ page }) => {
      await page.goto(BASE_URL);

      // Check computed styles of body
      const bodyBg = await page.evaluate(() => {
        return window.getComputedStyle(document.body).backgroundColor;
      });

      console.log(`Body background color: ${bodyBg}`);

      await page.goto(`${BASE_URL}/bazi/chat`);
      const chatBg = await page.evaluate(() => {
        return window.getComputedStyle(document.body).backgroundColor;
      });

      console.log(`Chat page background color: ${chatBg}`);
      console.log(`Color consistency: ${bodyBg === chatBg ? 'PASS' : 'REVIEW NEEDED'}`);
    });

    test('should have consistent typography', async ({ page }) => {
      const pages = [BASE_URL, `${BASE_URL}/bazi/chat`, `${BASE_URL}/zodiac/chat`];
      const fontInfo: any[] = [];

      for (const url of pages) {
        await page.goto(url);
        const font = await page.evaluate(() => {
          return {
            family: window.getComputedStyle(document.body).fontFamily,
            size: window.getComputedStyle(document.body).fontSize
          };
        });
        fontInfo.push({ url, ...font });
      }

      console.log('Typography across pages:');
      fontInfo.forEach(info => console.log(`  ${info.url}: ${info.family} (${info.size})`));
    });
  });
});
