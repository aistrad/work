#!/usr/bin/env python3
"""
Real User Scenario Tests - Post Migration 021-023
Tests real-world user flows after data architecture refactoring
"""
import asyncio
import json
import logging
from datetime import datetime, timedelta
from pathlib import Path
import sys

sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection
from stores.user_repo import UserRepository
from stores.unified_profile_repo import UnifiedProfileRepository

logging.basicConfig(level=logging.INFO, format='%(message)s')
logger = logging.getLogger(__name__)


class ScenarioTester:
    """Real user scenario tester"""

    def __init__(self):
        self.test_users = []
        self.results = []

    async def cleanup(self):
        """Cleanup test users"""
        async with get_connection() as conn:
            for user_id in self.test_users:
                await conn.execute("DELETE FROM unified_profiles WHERE user_id = $1", user_id)
                await conn.execute("DELETE FROM vibe_users WHERE id = $1", user_id)

    def log_result(self, scenario: str, status: str, details: str = ""):
        """Log test result"""
        result = {
            "scenario": scenario,
            "status": status,
            "details": details,
            "timestamp": datetime.now().isoformat()
        }
        self.results.append(result)
        emoji = "âœ…" if status == "PASS" else "âŒ"
        logger.info(f"{emoji} {scenario}: {status}")
        if details:
            logger.info(f"   {details}")

    # ========================================================================
    # Scenario 1: æ–°ç”¨æˆ·å®Œæ•´æ³¨å†Œæµç¨‹
    # ========================================================================
    async def scenario_new_user_onboarding(self):
        """
        åœºæ™¯1: æ–°ç”¨æˆ·å®Œæ•´æ³¨å†Œæµç¨‹
        - åˆ›å»ºè´¦æˆ·
        - è®¾ç½®ä¸ªäººèµ„æ–™
        - è®¢é˜…é»˜è®¤ Skills
        - éªŒè¯æ•°æ®ä¸€è‡´æ€§
        """
        logger.info("\n" + "=" * 70)
        logger.info("åœºæ™¯ 1: æ–°ç”¨æˆ·å®Œæ•´æ³¨å†Œæµç¨‹")
        logger.info("=" * 70)

        try:
            # Step 1: åˆ›å»ºç”¨æˆ·
            user = await UserRepository.create(
                display_name="æµ‹è¯•ç”¨æˆ·-å¼ ä¸‰",
                birth_datetime=datetime(1990, 6, 15, 14, 30),
                birth_location="åŒ—äº¬å¸‚",
                gender="male",
                timezone="Asia/Shanghai",
                language="zh-CN"
            )
            user_id = user['id']
            self.test_users.append(user_id)

            self.log_result(
                "1.1 åˆ›å»ºæ–°ç”¨æˆ·",
                "PASS",
                f"ç”¨æˆ·ID: {user['vibe_id']}, å§“å: æµ‹è¯•ç”¨æˆ·-å¼ ä¸‰"
            )

            # Step 2: éªŒè¯ vibe_users è®°å½•
            async with get_connection() as conn:
                vu = await conn.fetchrow("SELECT * FROM vibe_users WHERE id = $1", user_id)
                assert vu['vibe_id'] == user['vibe_id']
                assert vu['status'] == 'active'
                assert vu['tier'] == 'free'

                self.log_result("1.2 vibe_users è®°å½•éªŒè¯", "PASS", "æ ¸å¿ƒå­—æ®µæ­£ç¡®")

                # Step 3: éªŒè¯ unified_profiles è®°å½•
                up = await conn.fetchrow("SELECT profile FROM unified_profiles WHERE user_id = $1", user_id)
                profile = json.loads(up['profile']) if isinstance(up['profile'], str) else up['profile']

                # éªŒè¯ account
                assert profile['account']['vibe_id'] == user['vibe_id']
                assert profile['account']['display_name'] == "æµ‹è¯•ç”¨æˆ·-å¼ ä¸‰"
                assert profile['account']['status'] == 'active'

                # éªŒè¯ birth_info
                assert profile['birth_info']['date'] == "1990-06-15"
                assert profile['birth_info']['time'] == "14:30"
                assert profile['birth_info']['place'] == "åŒ—äº¬å¸‚"
                assert profile['birth_info']['gender'] == "male"

                # éªŒè¯ preferences
                assert profile['preferences']['timezone'] == "Asia/Shanghai"
                assert profile['preferences']['language'] == "zh-CN"

                self.log_result(
                    "1.3 unified_profiles è®°å½•éªŒè¯",
                    "PASS",
                    "account, birth_info, preferences å…¨éƒ¨æ­£ç¡®"
                )

                # Step 4: éªŒè¯é»˜è®¤ Skill è®¢é˜…
                if 'subscribed_skills' in profile.get('preferences', {}):
                    skills = profile['preferences']['subscribed_skills']
                    default_skills = ['core', 'lifecoach', 'mindfulness']
                    subscribed = [s for s in default_skills if s in skills]

                    self.log_result(
                        "1.4 é»˜è®¤ Skill è®¢é˜…",
                        "PASS",
                        f"å·²è®¢é˜…: {subscribed}"
                    )
                else:
                    self.log_result(
                        "1.4 é»˜è®¤ Skill è®¢é˜…",
                        "WARN",
                        "subscribed_skills ä¸å­˜åœ¨ï¼ˆå¯èƒ½æ˜¯è§¦å‘å™¨æœªæ‰§è¡Œï¼‰"
                    )

                return True

        except Exception as e:
            self.log_result("åœºæ™¯ 1: æ–°ç”¨æˆ·æ³¨å†Œ", "FAIL", str(e))
            return False

    # ========================================================================
    # Scenario 2: ç”¨æˆ·æ›´æ–°ä¸ªäººèµ„æ–™
    # ========================================================================
    async def scenario_update_profile(self):
        """
        åœºæ™¯2: ç”¨æˆ·æ›´æ–°ä¸ªäººèµ„æ–™
        - æ›´æ–°æ˜¾ç¤ºåç§°
        - æ›´æ–°å¤´åƒ
        - éªŒè¯è§¦å‘å™¨åŒæ­¥
        """
        logger.info("\n" + "=" * 70)
        logger.info("åœºæ™¯ 2: ç”¨æˆ·æ›´æ–°ä¸ªäººèµ„æ–™")
        logger.info("=" * 70)

        try:
            # ä½¿ç”¨åœºæ™¯1åˆ›å»ºçš„ç”¨æˆ·
            if not self.test_users:
                await self.scenario_new_user_onboarding()

            user_id = self.test_users[0]

            # Step 1: æ›´æ–°æ˜¾ç¤ºåç§°
            await UnifiedProfileRepository.update_account_info(
                user_id,
                display_name="å¼ ä¸‰-å·²æ›´æ–°",
                avatar_url="https://example.com/avatar.jpg"
            )

            # Step 2: éªŒè¯æ›´æ–°
            async with get_connection() as conn:
                up = await conn.fetchrow("SELECT profile FROM unified_profiles WHERE user_id = $1", user_id)
                profile = json.loads(up['profile']) if isinstance(up['profile'], str) else up['profile']

                assert profile['account']['display_name'] == "å¼ ä¸‰-å·²æ›´æ–°"
                assert profile['account']['avatar_url'] == "https://example.com/avatar.jpg"

                self.log_result(
                    "2.1 æ›´æ–°æ˜¾ç¤ºåç§°å’Œå¤´åƒ",
                    "PASS",
                    "unified_profiles å·²æ›´æ–°"
                )

                # Step 3: éªŒè¯ç¼“å­˜å¤±æ•ˆ
                # (è¿™é‡Œåº”è¯¥æµ‹è¯• Redis ç¼“å­˜ï¼Œæš‚æ—¶è·³è¿‡)

                return True

        except Exception as e:
            self.log_result("åœºæ™¯ 2: æ›´æ–°ä¸ªäººèµ„æ–™", "FAIL", str(e))
            return False

    # ========================================================================
    # Scenario 3: è·¨ Skill æ•°æ®ä¸€è‡´æ€§
    # ========================================================================
    async def scenario_cross_skill_data_consistency(self):
        """
        åœºæ™¯3: è·¨ Skill æ•°æ®ä¸€è‡´æ€§
        - ç”¨æˆ·ä½¿ç”¨å…«å­— Skillï¼ˆéœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼‰
        - ç”¨æˆ·ä½¿ç”¨æ˜Ÿåº§ Skillï¼ˆéœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼‰
        - éªŒè¯ä¸¤ä¸ª Skill è·å–çš„å‡ºç”Ÿä¿¡æ¯ä¸€è‡´
        """
        logger.info("\n" + "=" * 70)
        logger.info("åœºæ™¯ 3: è·¨ Skill æ•°æ®ä¸€è‡´æ€§")
        logger.info("=" * 70)

        try:
            if not self.test_users:
                await self.scenario_new_user_onboarding()

            user_id = self.test_users[0]

            # Step 1: è·å– Profile
            async with get_connection() as conn:
                up = await conn.fetchrow("SELECT profile FROM unified_profiles WHERE user_id = $1", user_id)
                profile = json.loads(up['profile']) if isinstance(up['profile'], str) else up['profile']

            # Step 2: éªŒè¯å…«å­— Skill è·å–çš„å‡ºç”Ÿä¿¡æ¯
            birth_info = profile.get('birth_info', {})
            assert birth_info.get('date') == "1990-06-15"
            assert birth_info.get('time') == "14:30"
            assert birth_info.get('place') == "åŒ—äº¬å¸‚"

            self.log_result(
                "3.1 å…«å­— Skill å‡ºç”Ÿä¿¡æ¯",
                "PASS",
                f"å‡ºç”Ÿ: {birth_info.get('date')} {birth_info.get('time')} @{birth_info.get('place')}"
            )

            # Step 3: éªŒè¯æ˜Ÿåº§ Skill è·å–çš„å‡ºç”Ÿä¿¡æ¯ï¼ˆåº”è¯¥ä¸€è‡´ï¼‰
            # æ˜Ÿåº§åªéœ€è¦æ—¥æœŸï¼Œä½†åº”è¯¥ä»åŒä¸€ä¸ª birth_info è¯»å–
            zodiac_date = birth_info.get('date')
            assert zodiac_date == "1990-06-15"

            self.log_result(
                "3.2 æ˜Ÿåº§ Skill å‡ºç”Ÿä¿¡æ¯",
                "PASS",
                f"å‡ºç”Ÿæ—¥æœŸ: {zodiac_date}ï¼ˆä¸å…«å­—ä¸€è‡´ï¼‰"
            )

            # Step 4: éªŒè¯æ•°æ®åªå­˜å‚¨ä¸€æ¬¡ï¼ˆä¸é‡å¤ï¼‰
            assert 'bazi' not in profile.get('skill_data', {}).keys() or \
                   'birth_datetime' not in profile.get('skill_data', {}).get('bazi', {})

            self.log_result(
                "3.3 æ•°æ®ä¸é‡å¤å­˜å‚¨",
                "PASS",
                "birth_info åªå­˜å‚¨åœ¨ profile.birth_infoï¼Œæœªåœ¨ skill_data ä¸­é‡å¤"
            )

            return True

        except Exception as e:
            self.log_result("åœºæ™¯ 3: è·¨ Skill æ•°æ®ä¸€è‡´æ€§", "FAIL", str(e))
            return False

    # ========================================================================
    # Scenario 4: è§¦å‘å™¨åŒå‘åŒæ­¥
    # ========================================================================
    async def scenario_trigger_bidirectional_sync(self):
        """
        åœºæ™¯4: è§¦å‘å™¨åŒå‘åŒæ­¥
        - æ›´æ–° vibe_users.status â†’ éªŒè¯åŒæ­¥åˆ° unified_profiles
        - æ›´æ–° unified_profiles.status â†’ éªŒè¯åŒæ­¥åˆ° vibe_users
        """
        logger.info("\n" + "=" * 70)
        logger.info("åœºæ™¯ 4: è§¦å‘å™¨åŒå‘åŒæ­¥")
        logger.info("=" * 70)

        try:
            if not self.test_users:
                await self.scenario_new_user_onboarding()

            user_id = self.test_users[0]

            async with get_connection() as conn:
                # Step 1: æ­£å‘åŒæ­¥æµ‹è¯•ï¼ˆvibe_users â†’ unified_profilesï¼‰
                await conn.execute("UPDATE vibe_users SET status = 'pending_deletion' WHERE id = $1", user_id)

                up_status = await conn.fetchval(
                    "SELECT profile->'account'->>'status' FROM unified_profiles WHERE user_id = $1",
                    user_id
                )

                if up_status == 'pending_deletion':
                    self.log_result(
                        "4.1 æ­£å‘åŒæ­¥ (vibe_users â†’ unified_profiles)",
                        "PASS",
                        "status åŒæ­¥æˆåŠŸ"
                    )
                else:
                    self.log_result(
                        "4.1 æ­£å‘åŒæ­¥ (vibe_users â†’ unified_profiles)",
                        "FAIL",
                        f"Expected: pending_deletion, Got: {up_status}"
                    )

                # Step 2: åå‘åŒæ­¥æµ‹è¯•ï¼ˆunified_profiles â†’ vibe_usersï¼‰
                await conn.execute(
                    """
                    UPDATE unified_profiles
                    SET profile = jsonb_set(profile, '{account, status}', to_jsonb('active'::text))
                    WHERE user_id = $1
                    """,
                    user_id
                )

                vu_status = await conn.fetchval("SELECT status FROM vibe_users WHERE id = $1", user_id)

                if vu_status == 'active':
                    self.log_result(
                        "4.2 åå‘åŒæ­¥ (unified_profiles â†’ vibe_users)",
                        "PASS",
                        "status åå‘åŒæ­¥æˆåŠŸ"
                    )
                else:
                    self.log_result(
                        "4.2 åå‘åŒæ­¥ (unified_profiles â†’ vibe_users)",
                        "FAIL",
                        f"Expected: active, Got: {vu_status}"
                    )

                return True

        except Exception as e:
            self.log_result("åœºæ™¯ 4: è§¦å‘å™¨åŒå‘åŒæ­¥", "FAIL", str(e))
            return False

    # ========================================================================
    # Scenario 5: è´¦æˆ·åˆ é™¤æµç¨‹
    # ========================================================================
    async def scenario_account_deletion(self):
        """
        åœºæ™¯5: è´¦æˆ·åˆ é™¤æµç¨‹
        - ç”¨æˆ·è¯·æ±‚åˆ é™¤è´¦æˆ·
        - éªŒè¯ 30 å¤©å®½é™æœŸ
        - æ‰§è¡Œç¡¬åˆ é™¤
        - éªŒè¯æ•°æ®æ¸…ç†
        """
        logger.info("\n" + "=" * 70)
        logger.info("åœºæ™¯ 5: è´¦æˆ·åˆ é™¤æµç¨‹")
        logger.info("=" * 70)

        try:
            # åˆ›å»ºä¸€ä¸ªä¸“é—¨ç”¨äºåˆ é™¤æµ‹è¯•çš„ç”¨æˆ·
            user = await UserRepository.create(
                display_name="å¾…åˆ é™¤ç”¨æˆ·",
                timezone="Asia/Shanghai"
            )
            delete_user_id = user['id']

            # Step 1: è¯·æ±‚åˆ é™¤
            await UnifiedProfileRepository.update_deletion_status(
                delete_user_id,
                status='pending_deletion',
                deletion_requested_at=datetime.now(),
                deletion_scheduled_at=datetime.now() + timedelta(days=30)
            )

            async with get_connection() as conn:
                # éªŒè¯çŠ¶æ€
                vu = await conn.fetchrow("SELECT status FROM vibe_users WHERE id = $1", delete_user_id)
                assert vu['status'] == 'pending_deletion'

                up = await conn.fetchrow("SELECT profile FROM unified_profiles WHERE user_id = $1", delete_user_id)
                profile = json.loads(up['profile']) if isinstance(up['profile'], str) else up['profile']
                assert profile['account']['deletion_requested_at'] is not None

                self.log_result(
                    "5.1 è¯·æ±‚åˆ é™¤è´¦æˆ·",
                    "PASS",
                    "status = pending_deletion, deletion_requested_at å·²è®¾ç½®"
                )

                # Step 2: ç¡¬åˆ é™¤ï¼ˆæ¸…ç†æ•°æ®ï¼‰
                await conn.execute("DELETE FROM unified_profiles WHERE user_id = $1", delete_user_id)
                await conn.execute("UPDATE vibe_users SET status = 'deleted', daily_quota = 0 WHERE id = $1", delete_user_id)

                # éªŒè¯åˆ é™¤
                vu_after = await conn.fetchrow("SELECT status, daily_quota FROM vibe_users WHERE id = $1", delete_user_id)
                assert vu_after['status'] == 'deleted'
                assert vu_after['daily_quota'] == 0

                up_after = await conn.fetchrow("SELECT * FROM unified_profiles WHERE user_id = $1", delete_user_id)
                assert up_after is None

                self.log_result(
                    "5.2 ç¡¬åˆ é™¤æ‰§è¡Œ",
                    "PASS",
                    "unified_profiles å·²åˆ é™¤, vibe_users æ ‡è®°ä¸º deletedï¼ˆtombstoneï¼‰"
                )

                # æ¸…ç†
                await conn.execute("DELETE FROM vibe_users WHERE id = $1", delete_user_id)

                return True

        except Exception as e:
            self.log_result("åœºæ™¯ 5: è´¦æˆ·åˆ é™¤æµç¨‹", "FAIL", str(e))
            return False

    # ========================================================================
    # Scenario 6: å¹¶å‘æ›´æ–°æµ‹è¯•
    # ========================================================================
    async def scenario_concurrent_updates(self):
        """
        åœºæ™¯6: å¹¶å‘æ›´æ–°æµ‹è¯•
        - åŒæ—¶æ›´æ–° vibe_users å’Œ unified_profiles
        - éªŒè¯æœ€ç»ˆä¸€è‡´æ€§
        """
        logger.info("\n" + "=" * 70)
        logger.info("åœºæ™¯ 6: å¹¶å‘æ›´æ–°æµ‹è¯•")
        logger.info("=" * 70)

        try:
            if not self.test_users:
                await self.scenario_new_user_onboarding()

            user_id = self.test_users[0]

            # ä½¿ç”¨ä¸¤ä¸ªä¸åŒçš„è¿æ¥é¿å…"another operation is in progress"é”™è¯¯
            conn1 = await get_connection().__aenter__()
            conn2 = await get_connection().__aenter__()

            try:
                # å¹¶å‘æ›´æ–°
                await asyncio.gather(
                    conn1.execute("UPDATE vibe_users SET tier = 'pro' WHERE id = $1", user_id),
                    conn2.execute(
                        """
                        UPDATE unified_profiles
                        SET profile = jsonb_set(profile, '{account, display_name}', to_jsonb('å¹¶å‘æ›´æ–°æµ‹è¯•'::text))
                        WHERE user_id = $1
                        """,
                        user_id
                    )
                )

                # ç­‰å¾…è§¦å‘å™¨æ‰§è¡Œ
                await asyncio.sleep(0.1)

                # éªŒè¯ä¸€è‡´æ€§
                vu = await conn1.fetchrow("SELECT tier FROM vibe_users WHERE id = $1", user_id)
                up = await conn1.fetchrow("SELECT profile FROM unified_profiles WHERE user_id = $1", user_id)
                profile = json.loads(up['profile']) if isinstance(up['profile'], str) else up['profile']

                assert vu['tier'] == 'pro'
                assert profile['account']['tier'] == 'pro'  # è§¦å‘å™¨åº”è¯¥åŒæ­¥
                assert profile['account']['display_name'] == 'å¹¶å‘æ›´æ–°æµ‹è¯•'

                self.log_result(
                    "6.1 å¹¶å‘æ›´æ–°ä¸€è‡´æ€§",
                    "PASS",
                    "tier åŒæ­¥æ­£ç¡®, display_name æ›´æ–°æ­£ç¡®"
                )

                return True

            finally:
                await conn1.close()
                await conn2.close()

        except Exception as e:
            self.log_result("åœºæ™¯ 6: å¹¶å‘æ›´æ–°æµ‹è¯•", "FAIL", str(e))
            return False

    # ========================================================================
    # Main Test Runner
    # ========================================================================
    async def run_all_scenarios(self):
        """Run all scenarios"""
        logger.info("\n" + "="* 70)
        logger.info("ğŸš€ çœŸå®ç”¨æˆ·åœºæ™¯æµ‹è¯• - Post Migration 021-023")
        logger.info("=" * 70)
        logger.info(f"æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        logger.info("=" * 70)

        scenarios = [
            ("åœºæ™¯ 1: æ–°ç”¨æˆ·å®Œæ•´æ³¨å†Œæµç¨‹", self.scenario_new_user_onboarding()),
            ("åœºæ™¯ 2: ç”¨æˆ·æ›´æ–°ä¸ªäººèµ„æ–™", self.scenario_update_profile()),
            ("åœºæ™¯ 3: è·¨ Skill æ•°æ®ä¸€è‡´æ€§", self.scenario_cross_skill_data_consistency()),
            ("åœºæ™¯ 4: è§¦å‘å™¨åŒå‘åŒæ­¥", self.scenario_trigger_bidirectional_sync()),
            ("åœºæ™¯ 5: è´¦æˆ·åˆ é™¤æµç¨‹", self.scenario_account_deletion()),
            ("åœºæ™¯ 6: å¹¶å‘æ›´æ–°æµ‹è¯•", self.scenario_concurrent_updates()),
        ]

        for name, scenario in scenarios:
            try:
                await scenario
            except Exception as e:
                logger.exception(f"Scenario failed: {name}")

        # Cleanup
        await self.cleanup()

        # Summary Report
        self.print_summary()

    def print_summary(self):
        """Print test summary"""
        logger.info("\n" + "=" * 70)
        logger.info("ğŸ“Š æµ‹è¯•æ‘˜è¦")
        logger.info("=" * 70)

        passed = sum(1 for r in self.results if r['status'] == 'PASS')
        failed = sum(1 for r in self.results if r['status'] == 'FAIL')
        warned = sum(1 for r in self.results if r['status'] == 'WARN')

        logger.info(f"æ€»è®¡: {len(self.results)} é¡¹æµ‹è¯•")
        logger.info(f"âœ… é€šè¿‡: {passed}")
        logger.info(f"âŒ å¤±è´¥: {failed}")
        logger.info(f"âš ï¸  è­¦å‘Š: {warned}")

        if failed == 0:
            logger.info("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!")
        else:
            logger.info("\nâš ï¸  å­˜åœ¨å¤±è´¥çš„æµ‹è¯•:")
            for r in self.results:
                if r['status'] == 'FAIL':
                    logger.info(f"   âŒ {r['scenario']}: {r['details']}")

        # Save results to file
        report_dir = Path(__file__).parent.parent.parent.parent / "docs"
        report_dir.mkdir(exist_ok=True)
        report_file = report_dir / "real-user-scenario-test-report.json"
        with open(report_file, 'w', encoding='utf-8') as f:
            json.dump({
                'timestamp': datetime.now().isoformat(),
                'summary': {
                    'total': len(self.results),
                    'passed': passed,
                    'failed': failed,
                    'warned': warned
                },
                'results': self.results
            }, f, indent=2, ensure_ascii=False)

        logger.info(f"\nğŸ“„ è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜: {report_file}")


async def main():
    """Main entry point"""
    tester = ScenarioTester()
    await tester.run_all_scenarios()


if __name__ == "__main__":
    asyncio.run(main())
