#!/usr/bin/env python3
"""
Run Migration 022: Cleanup vibe_users - Remove business fields
DESTRUCTIVE MIGRATION - Run after thorough testing
"""
import asyncio
import logging
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


async def run_migration():
    """Execute Migration 022 - DESTRUCTIVE"""
    logger.info("=" * 60)
    logger.info("Running Migration 022: Cleanup vibe_users")
    logger.info("⚠️  WARNING: This is a DESTRUCTIVE migration!")
    logger.info("=" * 60)

    migration_file = Path(__file__).parent.parent / "stores" / "migrations" / "022_cleanup_vibe_users.sql"

    if not migration_file.exists():
        logger.error(f"Migration file not found: {migration_file}")
        return False

    # Read migration SQL
    sql = migration_file.read_text()

    try:
        async with get_connection() as conn:
            # Pre-flight check: Verify Migration 021 is complete
            migration_021 = await conn.fetchrow("""
                SELECT executed_at
                FROM migration_log
                WHERE migration_name = '021_migrate_to_unified_profile'
            """)

            if not migration_021:
                logger.error("❌ Migration 021 not found! Cannot proceed.")
                logger.error("   You must run Migration 021 first.")
                return False

            logger.info(f"✓ Migration 021 confirmed: {migration_021['executed_at']}")

            # Count users
            user_count = await conn.fetchval("SELECT COUNT(*) FROM vibe_users")
            logger.info(f"✓ Found {user_count} users in vibe_users")

            # Execute the migration
            logger.info("\nExecuting migration...")
            logger.info("  → Creating reverse sync trigger")
            logger.info("  → Running safety checks")
            logger.info("  → Dropping business columns")
            logger.info("  → Verifying final schema")

            await conn.execute(sql)
            logger.info("✓ Migration executed successfully")

            # Verify final state
            result = await conn.fetchrow("""
                SELECT executed_at
                FROM migration_log
                WHERE migration_name = '022_cleanup_vibe_users'
                ORDER BY executed_at DESC
                LIMIT 1
            """)

            if result:
                logger.info(f"✓ Migration logged at: {result['executed_at']}")
            else:
                logger.warning("⚠ Migration not found in migration_log")

            # Check final column count
            col_count = await conn.fetchval("""
                SELECT COUNT(*)
                FROM information_schema.columns
                WHERE table_name = 'vibe_users'
            """)

            logger.info(f"\n✓ Final vibe_users column count: {col_count}")

            if col_count == 8:
                logger.info("  Expected: 8 columns (id, vibe_id, status, tier, daily_quota, billing_summary, created_at, updated_at)")
            else:
                logger.warning(f"  ⚠ Expected 8 columns, got {col_count}")

            return True

    except Exception as e:
        logger.exception(f"Migration failed: {e}")
        return False


async def main():
    """Main entry point"""
    success = await run_migration()

    if success:
        logger.info("\n" + "=" * 60)
        logger.info("✅ Migration 022 completed successfully!")
        logger.info("=" * 60)
        logger.info("\nvibe_users is now a pure account core table.")
        logger.info("All business data is in unified_profiles.")
        logger.info("\nNext steps:")
        logger.info("  1. Run final integration tests")
        logger.info("  2. Monitor application logs")
        logger.info("  3. Test critical user flows")
        logger.info("  4. Monitor query performance")
        return 0
    else:
        logger.error("\n" + "=" * 60)
        logger.error("❌ Migration 022 failed!")
        logger.error("=" * 60)
        return 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    exit(exit_code)
