# Email Auth System with 3-Layer Defense

## Overview
Add email authentication to existing OAuth system (Google/Apple/WeChat) with:
1. **Cloudflare Turnstile** - Invisible bot protection
2. **Disposable Email Blocking** - Block temporary emails
3. **Redis Rate Limiting** - 5 requests/hour/IP

## Flow
```
Email Input → Turnstile → Disposable Check → Rate Limit → Send Magic Link
                                                              ↓
User clicks link → Verify Token → Create/Login User → Issue JWT
```

## Files to Create

### Backend
| File | Purpose |
|------|---------|
| `apps/api/services/identity/email_auth.py` | Core service with 3-layer defense |
| `apps/api/stores/redis_client.py` | Redis connection pool |
| `migrations/026_email_auth.sql` | `email_auth_tokens` table |

### Frontend
| File | Purpose |
|------|---------|
| `apps/web/src/components/auth/EmailAuthForm.tsx` | Form with Turnstile widget |
| `apps/web/src/app/auth/verify/page.tsx` | Magic link verification page |
| `apps/web/src/app/api/auth/email/send-link/route.ts` | Proxy to backend |
| `apps/web/src/app/api/auth/email/verify/route.ts` | Proxy to backend |

## Files to Modify

### Backend
- `apps/api/routes/account.py` - Add `/auth/email/send-link` and `/auth/email/verify`
- `apps/api/services/identity/__init__.py` - Export EmailAuthService
- `apps/api/requirements.txt` - Add `redis`, `disposable-email-domains`
- `apps/api/main.py` - Redis lifecycle management

### Frontend
- `apps/web/package.json` - Add `@marsidev/react-turnstile`
- `apps/web/src/components/auth/OAuthButtons.tsx` - Add email option

## Database Migration
```sql
CREATE TABLE email_auth_tokens (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) NOT NULL UNIQUE,
    token VARCHAR(64) NOT NULL UNIQUE,
    expires_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## Environment Variables
```env
# Backend
CF_SECRET_KEY=xxx
REDIS_URL=redis://localhost:6379/0
SENDGRID_API_KEY=xxx
SENDGRID_FROM=noreply@vibelife.app

# Frontend
NEXT_PUBLIC_CF_SITE_KEY=xxx
```

## Key Implementation Details

### EmailAuthService (Python)
- `verify_turnstile(token, ip)` - POST to Cloudflare API
- `is_disposable_email(email)` - Check against blocklist
- `check_rate_limit(ip)` - Redis INCR with 1-hour TTL
- `send_magic_link(email, token, ip)` - 15-min expiry tokens
- `verify_magic_link(token)` - Create/login user, issue JWT

### Single Auth Policy
- Same as OAuth: one email = one auth method
- If email registered with Google, block email auth (and vice versa)

## Verification
1. Unit tests for disposable email detection
2. Integration test for full magic link flow
3. Manual test: Turnstile widget renders, blocks bots
4. Manual test: Rate limit triggers after 5 requests

## Unresolved Questions
1. Email provider: SendGrid vs Resend?
2. Redis: Already deployed or need setup?
3. Magic Link only, or also support OTP?
