# VibeLife é¡¹ç›®æ¶æ„åˆ†æ

## æ¦‚è¿°

VibeLife æ˜¯ä¸€ä¸ªé‡‡ç”¨ **pnpm monorepo + Turbo** æ„å»ºçš„å¤š Skill å¹³å°ï¼Œé€šè¿‡ "Skill éš”ç¦»" æ¨¡å¼å®ç°å¤šç«™ç‚¹è®¾è®¡ã€‚

---

## æ¶æ„æ€»è§ˆ

```
vibelife/
â”œâ”€â”€ apps/                    # åº”ç”¨å±‚
â”‚   â”œâ”€â”€ api/                 # FastAPI åç«¯ (Python)
â”‚   â”œâ”€â”€ web/                 # Next.js å‰ç«¯ (v14)
â”‚   â””â”€â”€ id/                  # è®¤è¯ä¸­å¿ƒ (å¾…å¼€å‘)
â”œâ”€â”€ packages/                # å…±äº«åŒ…
â”‚   â”œâ”€â”€ shared/              # ç±»å‹+å·¥å…·
â”‚   â”œâ”€â”€ knowledge/           # çŸ¥è¯†åº“æ•°æ®
â”‚   â”œâ”€â”€ skills/              # Skill å¼•æ“ (å¾…å®ç°)
â”‚   â””â”€â”€ ui/                  # UI ç»„ä»¶åº“ (å¾…å®ç°)
â”œâ”€â”€ knowledge/               # RAG çŸ¥è¯†æ–‡ä»¶
â”œâ”€â”€ migrations/              # æ•°æ®åº“è¿ç§»
â””â”€â”€ deploy/                  # éƒ¨ç½²é…ç½®
```

---

## ç«™ç‚¹/åŸŸåè®¾è®¡

| ç«™ç‚¹ | åŸŸå | è¯´æ˜ |
|------|------|------|
| ä¸»ç«™ | `vibelife.app` | Landing + Hub |
| å…«å­— | `bazi.vibelife.app` | å…«å­—å‘½ç† Skill |
| æ˜Ÿåº§ | `zodiac.vibelife.app` | æ˜Ÿåº§å æ˜Ÿ Skill |
| MBTI | `mbti.vibelife.app` | æ€§æ ¼åˆ†æ Skill |
| ID | `id.vibelife.app` | SSO è®¤è¯ä¸­å¿ƒ |
| API | `api.vibelife.app` | åç«¯ API |

---

## å…±äº«ç»„ä»¶ vs Skill ç‹¬æœ‰ç»„ä»¶

### ğŸ”· å…±äº«ç»„ä»¶ï¼ˆæ‰€æœ‰ç«™ç‚¹é€šç”¨ï¼‰

#### åç«¯å…±äº« (`apps/api/`)

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| Agent å¼•æ“ | `services/agent/` | æ¶ˆæ¯å¤„ç†ã€æ„å›¾è·¯ç”±ã€äººæ ¼ç®¡ç† |
| Vibe Engine | `services/vibe_engine/` | ç”¨æˆ·ç”»åƒã€æƒ…ç»ªåˆ†æã€æ´å¯Ÿç”Ÿæˆ |
| çŸ¥è¯†æ£€ç´¢ | `services/knowledge/` | Gemini åµŒå…¥ + Pinecone RAG |
| è®¤è¯ç³»ç»Ÿ | `services/identity/` | SSO å•ç‚¹ç™»å½•ã€JWT ä»¤ç‰Œ |
| æ”¯ä»˜ç³»ç»Ÿ | `services/billing/` | Stripe è®¢é˜…ç®¡ç† |
| æé†’ç³»ç»Ÿ | `services/reminder/` | æé†’ç”Ÿæˆå’Œæ¨é€ |
| Mirror å›é¡¾ | `services/mirror/` | å‘¨/æœˆå›é¡¾å¡ç‰‡ |
| æ•°æ®æ¨¡å‹ | `models/` | Userã€Skillã€Knowledgeã€Subscription |
| æ•°æ®è®¿é—® | `stores/` | PostgreSQL Repository æ¨¡å¼ |
| å…±äº«å·¥å…· | `tools/shared/` | æ—¥æœŸã€å†œå†è½¬æ¢ |

#### å‰ç«¯å…±äº« (`apps/web/src/`)

| ç»„ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| æ ¸å¿ƒè§†è§‰ç»„ä»¶ | `components/core/` | VibeGlyphã€BreathAuraã€InsightSealã€LuminousPaper |
| UI ç»„ä»¶åº“ | `components/ui/` | Buttonã€Inputã€Cardã€Dialog ç­‰ |
| èŠå¤©ç»„ä»¶ | `components/chat/` | ChatContainerã€ChatMessage |
| æ´å¯Ÿç»„ä»¶ | `components/insight/` | æ´å¯Ÿå¡ç‰‡å±•ç¤º |
| API å®¢æˆ·ç«¯ | `lib/api.ts` | ç»Ÿä¸€ API è°ƒç”¨ |
| æ ¹å¸ƒå±€ | `app/layout.tsx` | å…¨å±€æ ·å¼å’Œé…ç½® |

#### å…±äº«åŒ… (`packages/`)

| åŒ… | è·¯å¾„ | è¯´æ˜ |
|---|------|------|
| @vibelife/shared | `packages/shared/` | ç±»å‹å®šä¹‰ã€å·¥å…·å‡½æ•° |
| å…±äº«çŸ¥è¯† | `packages/knowledge/shared/` | é€šç”¨çŸ¥è¯†æ•°æ® |

---

### ğŸ”¶ Skill ç‹¬æœ‰ç»„ä»¶

#### åç«¯ Skill å·¥å…· (`apps/api/tools/`)

| Skill | è·¯å¾„ | å†…å®¹ |
|-------|------|------|
| å…«å­— | `tools/bazi/` | `calculator.py` å¤©å¹²åœ°æ”¯è®¡ç®—ã€`transit.py` å¤§è¿æµå¹´ã€`analysis.py` æ ¼å±€åˆ†æ |
| æ˜Ÿåº§ | `tools/zodiac/` | `chart.py` æ˜Ÿç›˜ç”Ÿæˆã€`transit.py` è¡Œæ˜Ÿè¡Œè¿ã€`events.py` å¤©æ–‡äº‹ä»¶ |
| MBTI | `tools/mbti/` | (å¾…å®ç°) |

#### åç«¯ Skill é…ç½®

| é…ç½®é¡¹ | æ–‡ä»¶ | è¯´æ˜ |
|--------|------|------|
| Skill äººæ ¼ | `services/agent/persona.py` | `SKILL_PERSONAS = {"bazi": "...", "zodiac": "..."}` |
| æ„å›¾åˆ†ç±» | `services/agent/router.py` | `Intent.BAZI_CHART`ã€`Intent.ZODIAC_NATAL` ç­‰ |
| SSO ç«™ç‚¹ | `services/identity/sso.py` | `VALID_SITES = {"bazi", "zodiac", "mbti"}` |

#### å‰ç«¯ Skill é¡µé¢ (`apps/web/src/app/`)

| Skill | è·¯å¾„ | å†…å®¹ |
|-------|------|------|
| å…«å­— | `app/bazi/` | `page.tsx` Landingã€`chat/page.tsx` èŠå¤© |
| æ˜Ÿåº§ | `app/zodiac/` | `page.tsx` Landingã€`chat/page.tsx` èŠå¤© |
| MBTI | `app/mbti/` | `page.tsx` Landingã€`chat/page.tsx` èŠå¤© |
| é€šç”¨èŠå¤© | `app/chat/[skillId]/` | åŠ¨æ€è·¯ç”±æ”¯æŒæ‰€æœ‰ Skill |

#### çŸ¥è¯†åº“æ•°æ® (`packages/knowledge/`)

| Skill | è·¯å¾„ | å†…å®¹ |
|-------|------|------|
| å…«å­— | `knowledge/bazi/` | å…«å­—æ–‡çŒ®ã€å‘½ç†å­¦èµ„æ–™ |
| æ˜Ÿåº§ | `knowledge/zodiac/` | å æ˜Ÿå­¦ã€æ˜Ÿåº§èµ„æ–™ |
| MBTI | `knowledge/mbti/` | MBTI ç†è®ºã€ç±»å‹èµ„æ–™ |

---

## æ•°æ®éš”ç¦»ç­–ç•¥

### æ•°æ®åº“è¡¨è®¾è®¡

æ‰€æœ‰ä¸ Skill ç›¸å…³çš„è¡¨éƒ½ä½¿ç”¨ `skill_id` å­—æ®µéš”ç¦»ï¼š

```sql
-- conversations è¡¨
skill_id VARCHAR  -- "bazi" | "zodiac" | "mbti"

-- user_portraits è¡¨ (æŒ‰ Skill å­˜å‚¨ç”»åƒ)
skill_id VARCHAR

-- insights è¡¨ (æŒ‰ Skill å­˜å‚¨æ´å¯Ÿ)
skill_id VARCHAR
```

### è®¢é˜…æ¨¡å‹

```python
class SubscriptionTier:
    FREE = "free"
    SKILL_SINGLE = "skill_single"    # å• Skill è®¢é˜…
    SKILL_BUNDLE = "skill_bundle"    # å¤š Skill æ†ç»‘
    VIBELIFE_ALL = "vibelife_all"    # å…¨ç«™è®¢é˜…
```

---

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. Skill å‚æ•°åŒ–

æ‰€æœ‰ä¸»è¦ç»„ä»¶æ¥å— `skill` å‚æ•°ï¼š

```typescript
// å‰ç«¯ç»„ä»¶
interface WithSkill {
  skill?: "bazi" | "zodiac" | "mbti";
}

// Skill é…ç½®å­—å…¸
const SKILL_COLORS = { bazi: {...}, zodiac: {...}, mbti: {...} };
const SKILL_EMPTY_STATE = { ... };
const SKILL_QUICK_PROMPTS = { ... };
```

```python
# åç«¯é…ç½®
SKILL_PERSONAS = {"bazi": "...", "zodiac": "...", "mbti": "..."}
SKILL_INTENTS = {"bazi": [...], "zodiac": [...], ...}
```

### 2. SSO è·¨ç«™è®¤è¯

```
1. ä¸»ç«™ç™»å½• â†’ ç”Ÿæˆ access_token + refresh_token
2. å¯¼èˆªåˆ° Skill ç«™ç‚¹ â†’ éªŒè¯ token
3. å¯é€‰ SSO token (5åˆ†é’Ÿæœ‰æ•ˆ) â†’ è·¨åŸŸèº«ä»½éªŒè¯
4. /auth/sso-callback â†’ æ¢å– Skill ä¸“ç”¨ token
```

---

## å…³é”®æ–‡ä»¶è·¯å¾„é€ŸæŸ¥

| åŠŸèƒ½ | è·¯å¾„ |
|------|------|
| SSO é…ç½® | `apps/api/services/identity/sso.py` |
| Agent å¼•æ“ | `apps/api/services/agent/runtime.py` |
| Skill äººæ ¼ | `apps/api/services/agent/persona.py` |
| æ„å›¾è·¯ç”± | `apps/api/services/agent/router.py` |
| è®¢é˜…ç®¡ç† | `apps/api/services/billing/subscription.py` |
| æ•°æ®æ¨¡å‹ | `apps/api/models/` |
| å…«å­—å·¥å…· | `apps/api/tools/bazi/` |
| æ˜Ÿåº§å·¥å…· | `apps/api/tools/zodiac/` |
| æ ¸å¿ƒç»„ä»¶ | `apps/web/src/components/core/` |
| Skill é¡µé¢ | `apps/web/src/app/{bazi,zodiac,mbti}/` |
| çŸ¥è¯†åº“ | `packages/knowledge/{bazi,zodiac,mbti}/` |

---

## å¾…å®Œæˆçš„å…±äº«å±‚

- ğŸ”² `packages/skills/` - Skill å¼•æ“åŒ…
- ğŸ”² `packages/ui/` - UI ç»„ä»¶åº“åŒ…
- ğŸ”² `apps/id/` - ä¸“ç”¨è®¤è¯ä¸­å¿ƒåº”ç”¨
- ğŸ”² Phase 1.5: Insight è·¨ Skill æ£€ç´¢
- ğŸ”² Phase 2: Global Portrait å…¨å±€ç”»åƒ
