/**
 * BaziChartCard - å…«å­—å‘½ç›˜å¡ç‰‡
 *
 * ä» show-bazi-chart.tsx æå–çš„çº¯æ¸²æŸ“ç»„ä»¶
 * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "bazi_chart" è§¦å‘
 */

"use client";

import { useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface Pillar {
  stem: string;
  branch: string;
}

interface BaziChartData {
  birthInfo?: { date?: string; time?: string; gender?: string };
  birth_info?: { date?: string; time?: string; gender?: string };
  fourPillars?: { year?: Pillar; month?: Pillar; day?: Pillar; hour?: Pillar | null };
  four_pillars?: { year?: Pillar; month?: Pillar; day?: Pillar; hour?: Pillar | null };
  dayMaster?: { element?: string; stem?: string; description?: string };
  day_master?: { element?: string; stem?: string; description?: string };
  fiveElements?: Record<string, number>;
  five_elements?: Record<string, number>;
  pattern?: { name?: string; description?: string };
}

interface BaziChartCardProps {
  data: BaziChartData;
  cardProps?: Record<string, unknown>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PILLAR_LABELS = {
  year: "å¹´æŸ±",
  month: "æœˆæŸ±",
  day: "æ—¥æŸ±",
  hour: "æ—¶æŸ±",
} as const;

const ELEMENT_EMOJI: Record<string, string> = {
  æœ¨: "ğŸŒ²",
  ç«: "ğŸ”¥",
  åœŸ: "ğŸ”ï¸",
  é‡‘: "âš”ï¸",
  æ°´: "ğŸ’§",
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getElementColor(element: "wood" | "fire" | "earth" | "metal" | "water"): string {
  const colors = {
    wood: "#22c55e",
    fire: "#ef4444",
    earth: "#eab308",
    metal: "#f5f5f5",
    water: "#3b82f6",
  };
  return colors[element];
}

function getElementChinese(element: "wood" | "fire" | "earth" | "metal" | "water"): string {
  const chinese = { wood: "æœ¨", fire: "ç«", earth: "åœŸ", metal: "é‡‘", water: "æ°´" };
  return chinese[element];
}

function getStemElement(stem: string): string | null {
  const stemElements: Record<string, string> = {
    ç”²: "æœ¨", ä¹™: "æœ¨", ä¸™: "ç«", ä¸: "ç«",
    æˆŠ: "åœŸ", å·±: "åœŸ", åºš: "é‡‘", è¾›: "é‡‘",
    å£¬: "æ°´", ç™¸: "æ°´",
  };
  return stemElements[stem] || null;
}

function getBranchElement(branch: string): string | null {
  const branchElements: Record<string, string> = {
    å¯…: "æœ¨", å¯: "æœ¨", å·³: "ç«", åˆ: "ç«",
    è¾°: "åœŸ", æˆŒ: "åœŸ", ä¸‘: "åœŸ", æœª: "åœŸ",
    ç”³: "é‡‘", é…‰: "é‡‘", äº¥: "æ°´", å­: "æ°´",
  };
  return branchElements[branch] || null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function BaziChartCard({ data }: BaziChartCardProps) {
  const [expandedPillar, setExpandedPillar] = useState<string | null>(null);

  // V7: é”™è¯¯çŠ¶æ€æ£€æŸ¥ - ä¸æ¸²æŸ“é”™è¯¯å¡ç‰‡
  if ((data as any)?.status === "error" || (data as any)?.need_info) {
    return null;
  }

  // V7: å…¼å®¹å¤šç§æ•°æ®æ¥æº
  // 1. show_bazi_chart å§”æ‰˜æ¨¡å¼: { fourPillars, dayMaster, ... }
  // 2. calculate_bazi ç›´æ¥è¿”å›: { status, chart: { four_pillars, ... }, message }
  const chartData = (data as any)?.chart || data;

  // å…¼å®¹ snake_case å’Œ camelCase
  const birthInfo = chartData.birthInfo || chartData.birth_info || data.birthInfo || data.birth_info || {};
  const fourPillars = chartData.fourPillars || chartData.four_pillars || {};
  const dayMaster = chartData.dayMaster || chartData.day_master || {};
  const fiveElements = chartData.fiveElements || chartData.five_elements || {};
  const pattern = chartData.pattern || {};

  // V7: æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥ - æ²¡æœ‰å››æŸ±æ•°æ®ä¸æ¸²æŸ“
  const hasPillars = fourPillars.year || fourPillars.month || fourPillars.day || fourPillars.hour;
  if (!hasPillars) {
    return null;
  }

  // è®¡ç®—äº”è¡Œæ€»æ•°ç”¨äºç™¾åˆ†æ¯”
  const totalElements = Object.values(fiveElements).reduce((sum: number, val) => sum + (Number(val) || 0), 0) || 1;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      className="bazi-chart-card bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 rounded-2xl border border-amber-200 dark:border-amber-800 p-5 my-2 overflow-hidden shadow-[var(--shadow-card)]"
    >
      {/* Header */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.2 }}
        className="flex items-center justify-between mb-4"
      >
        <h3 className="text-lg font-semibold text-accent-900 dark:text-accent-100 flex items-center gap-2">
          <span>ğŸ›ï¸</span>
          <span>å…«å­—å‘½ç›˜</span>
        </h3>
        <span className="text-sm text-accent-700 dark:text-accent-300">
          {birthInfo.date || ""}
        </span>
      </motion.div>

      {/* Four Pillars */}
      <div className="grid grid-cols-4 gap-2 mb-4">
        {(["year", "month", "day", "hour"] as const).map((pillar, index) => {
          const pillarData = fourPillars[pillar];
          const isExpanded = expandedPillar === pillar;
          const stemElement = pillarData?.stem ? getStemElement(pillarData.stem) : null;
          const branchElement = pillarData?.branch ? getBranchElement(pillarData.branch) : null;

          return (
            <motion.div
              key={pillar}
              initial={{ opacity: 0, scale: 0.8 }}
              animate={{ opacity: 1, scale: 1 }}
              transition={{ delay: 0.3 + index * 0.1, duration: 0.3 }}
              onClick={() => pillarData && setExpandedPillar(isExpanded ? null : pillar)}
              className={`text-center p-2 bg-white/50 dark:bg-black/20 rounded-lg cursor-pointer transition-all duration-200 ${
                pillarData ? "hover:bg-white/80 dark:hover:bg-black/40 hover:shadow-md" : ""
              } ${isExpanded ? "ring-2 ring-amber-400" : ""}`}
            >
              <div className="text-xs text-muted-foreground mb-1">
                {PILLAR_LABELS[pillar]}
              </div>
              {pillarData ? (
                <>
                  <motion.div
                    className="text-lg font-medium flex items-center justify-center gap-1"
                    whileHover={{ scale: 1.05 }}
                  >
                    <span>{pillarData.stem}</span>
                    {stemElement && <span className="text-sm">{ELEMENT_EMOJI[stemElement]}</span>}
                  </motion.div>
                  <motion.div
                    className="text-lg flex items-center justify-center gap-1"
                    whileHover={{ scale: 1.05 }}
                  >
                    <span>{pillarData.branch}</span>
                    {branchElement && <span className="text-sm">{ELEMENT_EMOJI[branchElement]}</span>}
                  </motion.div>
                </>
              ) : (
                <div className="text-lg text-muted-foreground">?</div>
              )}
            </motion.div>
          );
        })}
      </div>

      {/* Expanded Pillar Detail */}
      <AnimatePresence>
        {expandedPillar && fourPillars[expandedPillar as keyof typeof fourPillars] && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: "auto", opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="mb-4 overflow-hidden"
          >
            <div className="bg-accent-100/50 dark:bg-accent-900/20 rounded-lg p-3 text-sm">
              <div className="font-medium mb-1">
                {PILLAR_LABELS[expandedPillar as keyof typeof PILLAR_LABELS]} è¯¦è§£
              </div>
              <div className="text-muted-foreground">
                ç‚¹å‡»å…¶ä»–æŸ±ä½æŸ¥çœ‹è¯¦æƒ…ï¼Œæˆ–å†æ¬¡ç‚¹å‡»æ”¶èµ·ã€‚
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Day Master */}
      <motion.div
        initial={{ opacity: 0, x: -20 }}
        animate={{ opacity: 1, x: 0 }}
        transition={{ delay: 0.7 }}
        className="bg-white/60 dark:bg-black/30 rounded-lg p-3 mb-4"
      >
        <div className="flex items-center gap-2 mb-1">
          <span className="text-sm font-medium">æ—¥ä¸»</span>
          <span className="px-2 py-0.5 bg-accent-200 dark:bg-accent-800 rounded text-sm font-medium">
            {dayMaster.stem || ""} ({dayMaster.element || ""})
          </span>
        </div>
        <p className="text-sm text-muted-foreground">{dayMaster.description || ""}</p>
      </motion.div>

      {/* Five Elements */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.9 }}
        className="mb-4"
      >
        <div className="text-sm font-medium mb-2">äº”è¡Œåˆ†å¸ƒ</div>
        <div className="space-y-1.5">
          {(["wood", "fire", "earth", "metal", "water"] as const).map((element, index) => {
            const count = fiveElements[element] || 0;
            const percentage = Math.round((count / totalElements) * 100);
            return (
              <div key={element} className="flex items-center gap-2">
                <span className="w-6 text-center">{getElementChinese(element)}</span>
                <div className="flex-1 h-4 bg-white/50 dark:bg-black/20 rounded-full overflow-hidden">
                  <motion.div
                    initial={{ width: 0 }}
                    animate={{ width: `${percentage}%` }}
                    transition={{ delay: 1 + index * 0.1, duration: 0.5 }}
                    className="h-full rounded-full"
                    style={{ backgroundColor: getElementColor(element) }}
                  />
                </div>
                <span className="w-10 text-xs text-right text-muted-foreground">{percentage}%</span>
              </div>
            );
          })}
        </div>
      </motion.div>

      {/* Pattern */}
      {pattern?.name && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1.5 }}
          className="text-sm bg-accent-100 dark:bg-accent-900/30 rounded-lg p-2"
        >
          <span className="font-medium">æ ¼å±€ï¼š</span>
          <span>{pattern.name}</span>
          {pattern.description && (
            <p className="text-xs text-muted-foreground mt-1">{pattern.description}</p>
          )}
        </motion.div>
      )}

      {/* Hint */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 1.8 }}
        className="mt-3 text-xs text-center text-muted-foreground"
      >
        ğŸ’¡ ç‚¹å‡»æŸ±ä½æŸ¥çœ‹è¯¦ç»†è§£è¯»
      </motion.div>
    </motion.div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("bazi_chart", BaziChartCard);

export default BaziChartCard;
