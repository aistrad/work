/**
 * SynastryOverviewCard - åˆç›˜æ€»è§ˆå¡ç‰‡
 *
 * å±•ç¤ºåˆç›˜åˆ†æçš„ç»¼åˆç»“æœï¼š
 * - ç»¼åˆè¯„åˆ†å’Œè¯„ä»·
 * - å„ç»´åº¦è¯„åˆ†æ‘˜è¦
 * - å…³ç³»äº®ç‚¹å’ŒæŒ‘æˆ˜
 * - ç›¸å¤„å»ºè®®
 */

"use client";

import { memo, useState } from "react";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface Person {
  name: string;
  avatar?: string;
}

interface Dimension {
  skill: string;
  name: string;
  icon: string;
  score: number;
  summary: string;
}

interface SynastryOverviewData {
  person1: Person;
  person2: Person;
  relationshipType: string;
  overallScore: number;
  overallLabel: string;
  dimensions: Dimension[];
  strengths?: string[];
  challenges?: string[];
  advice?: string[];
  onDimensionClick?: (dimension: Dimension) => void;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SCORE_COLORS: Record<string, { bg: string; text: string; glow: string }> = {
  high: {
    bg: "from-green-400 to-emerald-500",
    text: "text-green-600 dark:text-green-400",
    glow: "shadow-green-500/30",
  },
  medium: {
    bg: "from-blue-400 to-cyan-500",
    text: "text-blue-600 dark:text-blue-400",
    glow: "shadow-blue-500/30",
  },
  low: {
    bg: "from-amber-400 to-orange-500",
    text: "text-amber-600 dark:text-amber-400",
    glow: "shadow-amber-500/30",
  },
};

const getScoreColorKey = (score: number): string => {
  if (score >= 70) return "high";
  if (score >= 50) return "medium";
  return "low";
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub-components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PersonAvatar = memo(function PersonAvatar({
  person,
  side,
}: {
  person: Person;
  side: "left" | "right";
}) {
  return (
    <div className={`flex flex-col items-center ${side === "right" ? "order-2" : ""}`}>
      <div className="w-16 h-16 rounded-full bg-gradient-to-br from-pink-200 to-purple-200 dark:from-pink-800 dark:to-purple-800 flex items-center justify-center text-2xl font-semibold text-pink-700 dark:text-pink-200">
        {person.name.charAt(0)}
      </div>
      <span className="mt-2 text-sm font-medium text-slate-700 dark:text-slate-300">
        {person.name}
      </span>
    </div>
  );
});

const ScoreCircle = memo(function ScoreCircle({
  score,
  label,
}: {
  score: number;
  label: string;
}) {
  const colorKey = getScoreColorKey(score);
  const colors = SCORE_COLORS[colorKey];

  return (
    <div className={`relative w-24 h-24 rounded-full bg-gradient-to-br ${colors.bg} shadow-lg ${colors.glow} flex flex-col items-center justify-center`}>
      <span className="text-3xl font-bold text-white">{score}</span>
      <span className="text-xs text-white/80">{label}</span>
    </div>
  );
});

const DimensionBar = memo(function DimensionBar({
  dimension,
  onClick,
}: {
  dimension: Dimension;
  onClick?: () => void;
}) {
  const colorKey = getScoreColorKey(dimension.score);

  return (
    <button
      onClick={onClick}
      className="w-full flex items-center gap-3 p-3 bg-white/60 dark:bg-slate-800/60 rounded-lg hover:bg-white dark:hover:bg-slate-800 transition-all text-left"
    >
      {/* Icon */}
      <span className="text-xl">{dimension.icon}</span>

      {/* Content */}
      <div className="flex-1 min-w-0">
        <div className="flex items-center justify-between mb-1">
          <span className="text-sm font-medium text-slate-700 dark:text-slate-300">
            {dimension.name}
          </span>
          <span className={`text-sm font-semibold ${SCORE_COLORS[colorKey].text}`}>
            {dimension.score}
          </span>
        </div>

        {/* Progress Bar */}
        <div className="h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
          <div
            className={`h-full rounded-full bg-gradient-to-r ${SCORE_COLORS[colorKey].bg} transition-all duration-500`}
            style={{ width: `${dimension.score}%` }}
          />
        </div>

        {/* Summary */}
        <p className="text-xs text-slate-500 dark:text-slate-400 mt-1 truncate">
          {dimension.summary}
        </p>
      </div>

      {/* Arrow */}
      <svg
        className="w-4 h-4 text-slate-400 flex-shrink-0"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          strokeLinecap="round"
          strokeLinejoin="round"
          strokeWidth={2}
          d="M9 5l7 7-7 7"
        />
      </svg>
    </button>
  );
});

const InsightSection = memo(function InsightSection({
  title,
  icon,
  items,
  colorClass,
}: {
  title: string;
  icon: string;
  items: string[];
  colorClass: string;
}) {
  if (!items || items.length === 0) return null;

  return (
    <div className={`p-3 rounded-lg ${colorClass}`}>
      <div className="flex items-center gap-2 mb-2">
        <span>{icon}</span>
        <span className="text-sm font-medium">{title}</span>
      </div>
      <ul className="space-y-1">
        {items.slice(0, 3).map((item, i) => (
          <li key={i} className="text-sm text-slate-600 dark:text-slate-300 flex items-start gap-1">
            <span className="text-slate-400">â€¢</span>
            <span>{item}</span>
          </li>
        ))}
      </ul>
    </div>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function SynastryOverviewCard({
  person1,
  person2,
  overallScore,
  overallLabel,
  dimensions = [],
  strengths = [],
  challenges = [],
  advice = [],
  onDimensionClick,
}: SynastryOverviewData) {
  const [expanded, setExpanded] = useState(false);

  return (
    <div className="synastry-overview-card bg-gradient-to-br from-pink-50 to-purple-50 dark:from-pink-950/30 dark:to-purple-950/30 rounded-2xl border border-pink-200 dark:border-pink-800 overflow-hidden my-2 fade-in shadow-[var(--shadow-card)]">
      {/* Header - Two Persons with Score */}
      <div className="p-5 pb-4">
        <div className="flex items-center justify-center gap-4 mb-4">
          <PersonAvatar person={person1} side="left" />

          <div className="flex flex-col items-center">
            <ScoreCircle score={overallScore} label={overallLabel} />
          </div>

          <PersonAvatar person={person2} side="right" />
        </div>

        <p className="text-center text-sm text-slate-500 dark:text-slate-400">
          ğŸ’• ä½ ä»¬çš„å…³ç³»ç”»åƒ
        </p>
      </div>

      {/* Dimensions */}
      <div className="px-5 pb-4">
        <h4 className="text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
          å„ç»´åº¦è¯„åˆ†
        </h4>
        <div className="space-y-2">
          {dimensions.map((dim) => (
            <DimensionBar
              key={dim.skill}
              dimension={dim}
              onClick={() => onDimensionClick?.(dim)}
            />
          ))}
        </div>
      </div>

      {/* Insights */}
      {(strengths.length > 0 || challenges.length > 0) && (
        <div className="px-5 pb-4 grid grid-cols-2 gap-3">
          <InsightSection
            title="ä½ ä»¬çš„äº®ç‚¹"
            icon="âœ¨"
            items={strengths}
            colorClass="bg-green-50 dark:bg-green-900/20"
          />
          <InsightSection
            title="éœ€è¦æ³¨æ„"
            icon="âš¡"
            items={challenges}
            colorClass="bg-amber-50 dark:bg-amber-900/20"
          />
        </div>
      )}

      {/* Advice (Expandable) */}
      {advice.length > 0 && (
        <div className="px-5 pb-4">
          <button
            onClick={() => setExpanded(!expanded)}
            className="w-full flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg"
          >
            <div className="flex items-center gap-2">
              <span>ğŸ’¡</span>
              <span className="text-sm font-medium text-blue-700 dark:text-blue-300">
                ç›¸å¤„å»ºè®®
              </span>
            </div>
            <svg
              className={`w-4 h-4 text-blue-500 transition-transform ${expanded ? "rotate-180" : ""}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </button>

          {expanded && (
            <div className="mt-2 p-3 bg-blue-50/50 dark:bg-blue-900/10 rounded-lg">
              <ul className="space-y-2">
                {advice.map((item, i) => (
                  <li
                    key={i}
                    className="text-sm text-slate-600 dark:text-slate-300 flex items-start gap-2"
                  >
                    <span className="text-blue-500">â€¢</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}
        </div>
      )}

      {/* Footer Hint */}
      <div className="px-5 pb-4">
        <p className="text-xs text-center text-slate-400">
          ğŸ’¡ ç‚¹å‡»å„ç»´åº¦æŸ¥çœ‹è¯¦ç»†åˆ†æ
        </p>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("synastry_overview", SynastryOverviewCard);

export default SynastryOverviewCard;
