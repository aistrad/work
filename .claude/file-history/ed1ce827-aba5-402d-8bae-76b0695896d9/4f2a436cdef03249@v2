/**
 * SkillIntroCard - Skill 介绍导航卡片
 *
 * 作为用户了解和使用 Skill 的中央入口，支持三种变体：
 * - full: 完整版，包含所有 sections
 * - compact: 精简版，适合对话中展示
 * - mini: 迷你版，只有标题和 CTA
 */

'use client';

import React, { useMemo } from 'react';
import Header from './Header';
import FeatureList from './FeatureList';
import QuickStart from './QuickStart';
import PricingSection from './PricingSection';
import SettingsSection from './SettingsSection';
import { useSkillIntro, useSubscribe, useUpdateSettings, useMarkFirstUse } from './hooks/useSkillIntro';
import type {
  SkillIntroCardProps,
  SectionType,
  IntroCardAction,
  SkillFeature,
} from './types';

// 变体对应的默认 sections
const VARIANT_SECTIONS: Record<string, SectionType[]> = {
  full: ['header', 'features', 'quickstart', 'pricing', 'settings'],
  compact: ['header', 'features', 'quickstart'],
  mini: ['header'],
};

const SkillIntroCard: React.FC<SkillIntroCardProps> = ({
  skillId,
  variant = 'compact',
  sections: customSections,
  dismissible = false,
  onAction,
  className = '',
  initialData,
  reason,
}) => {
  // 数据获取
  const { data, isLoading, error } = useSkillIntro(skillId);
  const introData = initialData || data;

  // Mutations
  const { subscribe: doSubscribe } = useSubscribe(skillId);
  const { update: doUpdateSettings } = useUpdateSettings(skillId);
  const { mark: doMarkFirstUse } = useMarkFirstUse(skillId);

  // 确定要显示的 sections
  const activeSections = useMemo(() => {
    if (customSections) return customSections;
    if (introData?.skill.intro_card?.default_sections) {
      return introData.skill.intro_card.default_sections;
    }
    return VARIANT_SECTIONS[variant] || VARIANT_SECTIONS.compact;
  }, [customSections, introData, variant]);

  // 处理 Action
  const handleAction = (action: IntroCardAction) => {
    onAction?.(action);
  };

  // 处理 Feature 点击
  const handleFeatureClick = (feature: SkillFeature) => {
    handleAction({ type: 'expand_feature', featureId: feature.name });
  };

  // 处理 "试试看" 点击
  const handleTryClick = (feature: SkillFeature) => {
    if (feature.demo_prompt) {
      handleAction({ type: 'send_prompt', prompt: feature.demo_prompt });
    }
  };

  // 处理 QuickStart prompt 点击
  const handlePromptClick = (prompt: string) => {
    handleAction({ type: 'send_prompt', prompt });
  };

  // 处理订阅
  const handleSubscribe = async () => {
    try {
      await doSubscribe(true);
      handleAction({ type: 'subscribe', skillId });
    } catch (err) {
      console.error('Subscribe failed:', err);
    }
  };

  // 处理管理订阅
  const handleManage = () => {
    // TODO: 导航到订阅管理页面
    handleAction({ type: 'navigate', target: 'scenario', id: 'subscription-manage' });
  };

  // 处理设置变更
  const handleSettingChange = async (key: string, value: unknown) => {
    try {
      await doUpdateSettings({ [key]: value });
      handleAction({ type: 'toggle_setting', key, value });
    } catch (err) {
      console.error('Update setting failed:', err);
    }
  };

  // 处理关闭
  const handleDismiss = () => {
    // 标记首次使用
    if (introData?.is_first_use) {
      doMarkFirstUse();
    }
    handleAction({ type: 'dismiss' });
  };

  // Loading 状态
  if (isLoading && !introData) {
    return (
      <div className={`rounded-2xl bg-[var(--bg-card)] border border-[var(--border-default)] overflow-hidden animate-pulse shadow-[var(--shadow-card)] ${className}`}>
        <div className="p-6">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-[var(--bg-tertiary)] rounded-lg" />
            <div className="flex-1">
              <div className="h-5 bg-[var(--bg-tertiary)] rounded w-1/3 mb-2" />
              <div className="h-4 bg-[var(--bg-tertiary)] rounded w-2/3" />
            </div>
          </div>
        </div>
        <div className="px-6 pb-6">
          <div className="grid grid-cols-3 gap-3">
            {[1, 2, 3].map((i) => (
              <div key={i} className="h-20 bg-[var(--bg-secondary)] rounded-lg" />
            ))}
          </div>
        </div>
      </div>
    );
  }

  // Error 状态
  if (error || !introData) {
    return (
      <div className={`rounded-2xl bg-[var(--bg-card)] border border-red-200 dark:border-red-800 p-6 shadow-[var(--shadow-card)] ${className}`}>
        <p className="text-red-600 dark:text-red-400 text-sm">加载失败，请稍后重试</p>
      </div>
    );
  }

  const { skill, subscription, settings } = introData;

  // Mini 变体
  if (variant === 'mini') {
    return (
      <div className={`rounded-2xl bg-[var(--bg-card)] border border-[var(--border-default)] overflow-hidden shadow-[var(--shadow-card)] ${className}`}>
        <div className="flex items-center justify-between p-3">
          <div className="flex items-center gap-2">
            <span className="text-xl">{skill.icon}</span>
            <span className="font-medium text-[var(--text-primary)]">{skill.name}</span>
            <span className="text-[var(--text-secondary)] text-sm">· {skill.showcase.tagline}</span>
          </div>
          <button
            onClick={() => handleAction({ type: 'navigate', target: 'scenario', id: 'intro' })}
            className="px-3 py-1 text-sm font-medium text-white rounded-lg transition-colors"
            style={{ backgroundColor: skill.color }}
          >
            开始使用 →
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className={`rounded-2xl bg-[var(--bg-card)] border border-[var(--border-default)] overflow-hidden shadow-[var(--shadow-card)] relative ${className}`}>
      {/* 展示原因 */}
      {reason && (
        <div className="px-4 sm:px-6 py-2 bg-blue-50 dark:bg-blue-950/30 border-b border-blue-100 dark:border-blue-800">
          <p className="text-sm text-blue-700 dark:text-blue-300">{reason}</p>
        </div>
      )}

      {/* 关闭按钮 */}
      {dismissible && (
        <button
          onClick={handleDismiss}
          className="absolute top-3 right-3 p-1 rounded-full hover:bg-[var(--bg-secondary)] text-[var(--text-tertiary)] hover:text-[var(--text-primary)] transition-colors z-10"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      )}

      {/* Header */}
      {activeSections.includes('header') && (
        <Header skill={skill} subscription={subscription} variant={variant} />
      )}

      {/* Features */}
      {activeSections.includes('features') && skill.features.length > 0 && (
        <FeatureList
          features={skill.features}
          variant={variant}
          onFeatureClick={handleFeatureClick}
          onTryClick={handleTryClick}
        />
      )}

      {/* QuickStart */}
      {activeSections.includes('quickstart') && skill.showcase.demo_prompts.length > 0 && (
        <QuickStart
          prompts={skill.showcase.demo_prompts}
          onPromptClick={handlePromptClick}
        />
      )}

      {/* Pricing */}
      {activeSections.includes('pricing') && (
        <PricingSection
          pricing={skill.pricing}
          subscription={subscription}
          skillId={skillId}
          ctaText={skill.intro_card?.cta_text}
          onSubscribe={handleSubscribe}
          onManage={handleManage}
        />
      )}

      {/* Settings */}
      {activeSections.includes('settings') && skill.settings && (
        <SettingsSection
          settings={skill.settings}
          userSettings={settings}
          subscription={subscription}
          onSettingChange={handleSettingChange}
        />
      )}
    </div>
  );
};

export default SkillIntroCard;
