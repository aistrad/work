/**
 * ZodiacSynastryDetailCard - æ˜Ÿåº§åˆç›˜è¯¦æƒ…å¡ç‰‡
 *
 * å±•ç¤ºæ˜Ÿåº§åˆç›˜çš„è¯¦ç»†ä¿¡æ¯ï¼š
 * - åˆ†ç»´åº¦è¯„åˆ†ï¼ˆæ²Ÿé€šã€æƒ…æ„Ÿã€å¸å¼•åŠ›ã€ä»·å€¼è§‚ï¼‰
 * - ç›¸ä½åˆ—è¡¨ï¼ˆå¯å±•å¼€ï¼‰
 * - æ·±åº¦è§£è¯»
 */

"use client";

import { memo, useState } from "react";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface Category {
  name: string;
  score: number;
  description: string;
}

interface Aspect {
  person1_planet: string;
  person2_planet: string;
  aspect_type: string;
  aspect_name: string;
  orb: number;
  influence: "positive" | "challenging" | "neutral";
  description: string;
}

interface Person {
  name?: string;
  sun_sign_chinese?: string;
  moon_sign_chinese?: string;
}

interface ZodiacSynastryDetailData {
  person1?: Person;
  person2?: Person;
  overall_score?: number;
  categories?: Category[];
  aspects?: Aspect[];
  strengths?: string[];
  challenges?: string[];
  advice?: string;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const INFLUENCE_STYLES = {
  positive: {
    bg: "bg-green-50 dark:bg-green-900/20",
    border: "border-green-200 dark:border-green-800",
    text: "text-green-700 dark:text-green-300",
    icon: "âœ¨",
  },
  challenging: {
    bg: "bg-amber-50 dark:bg-amber-900/20",
    border: "border-amber-200 dark:border-amber-800",
    text: "text-amber-700 dark:text-amber-300",
    icon: "âš¡",
  },
  neutral: {
    bg: "bg-slate-50 dark:bg-slate-800/50",
    border: "border-slate-200 dark:border-slate-700",
    text: "text-slate-700 dark:text-slate-300",
    icon: "â—‹",
  },
};

const ASPECT_MEANING: Record<string, { meaning: string; color: string }> = {
  conjunction: { meaning: "åˆç›¸ - èƒ½é‡èåˆï¼Œç›¸äº’å½±å“", color: "text-blue-500" },
  trine: { meaning: "ä¸‰åˆ†ç›¸ - å’Œè°æµåŠ¨ï¼Œè‡ªç„¶äº’è¡¥", color: "text-green-500" },
  sextile: { meaning: "å…­åˆ†ç›¸ - æœºä¼šåä½œï¼Œç›¸äº’æ”¯æŒ", color: "text-emerald-500" },
  square: { meaning: "åˆ‘ç›¸ - å¼ åŠ›æŒ‘æˆ˜ï¼Œä¿ƒè¿›æˆé•¿", color: "text-amber-500" },
  opposition: { meaning: "å†²ç›¸ - å¯¹ç«‹äº’è¡¥ï¼Œéœ€è¦å¹³è¡¡", color: "text-red-500" },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub-components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CategorySection = memo(function CategorySection({
  categories,
}: {
  categories: Category[];
}) {
  return (
    <div className="space-y-3">
      <h4 className="text-sm font-medium text-slate-600 dark:text-slate-400 flex items-center gap-2">
        <span>ğŸ“Š</span> ç»´åº¦è¯„åˆ†
      </h4>
      <div className="grid grid-cols-2 gap-3">
        {categories.map((cat) => (
          <div
            key={cat.name}
            className="p-3 rounded-lg bg-white/60 dark:bg-slate-800/60"
          >
            <div className="flex items-center justify-between mb-1">
              <span className="text-sm font-medium text-slate-700 dark:text-slate-300">
                {cat.name}
              </span>
              <span
                className={`text-sm font-bold ${
                  cat.score >= 70
                    ? "text-green-600 dark:text-green-400"
                    : cat.score >= 50
                    ? "text-blue-600 dark:text-blue-400"
                    : "text-amber-600 dark:text-amber-400"
                }`}
              >
                {cat.score}
              </span>
            </div>
            <div className="h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
              <div
                className={`h-full rounded-full transition-all duration-500 ${
                  cat.score >= 70
                    ? "bg-gradient-to-r from-green-400 to-emerald-500"
                    : cat.score >= 50
                    ? "bg-gradient-to-r from-blue-400 to-cyan-500"
                    : "bg-gradient-to-r from-amber-400 to-orange-500"
                }`}
                style={{ width: `${cat.score}%` }}
              />
            </div>
            <p className="text-xs text-slate-500 dark:text-slate-400 mt-1.5 line-clamp-2">
              {cat.description}
            </p>
          </div>
        ))}
      </div>
    </div>
  );
});

const AspectItem = memo(function AspectItem({ aspect }: { aspect: Aspect }) {
  const style = INFLUENCE_STYLES[aspect.influence];
  const aspectInfo = ASPECT_MEANING[aspect.aspect_type] || {
    meaning: aspect.aspect_name,
    color: "text-slate-500",
  };

  return (
    <div
      className={`p-3 rounded-lg ${style.bg} border ${style.border} transition-all`}
    >
      <div className="flex items-start justify-between gap-2">
        <div className="flex-1">
          {/* Planets involved */}
          <div className="flex items-center gap-2 text-sm font-medium text-slate-700 dark:text-slate-200">
            <span>{aspect.person1_planet}</span>
            <span className={aspectInfo.color}>{aspect.aspect_name}</span>
            <span>{aspect.person2_planet}</span>
          </div>

          {/* Aspect description */}
          <p className="text-xs text-slate-500 dark:text-slate-400 mt-1">
            {aspect.description}
          </p>

          {/* Aspect meaning */}
          <p className={`text-xs mt-1 ${aspectInfo.color}`}>
            {aspectInfo.meaning}
          </p>
        </div>

        {/* Influence indicator */}
        <div className="flex flex-col items-center">
          <span className="text-lg">{style.icon}</span>
          <span className={`text-[10px] ${style.text}`}>
            {aspect.influence === "positive"
              ? "å’Œè°"
              : aspect.influence === "challenging"
              ? "æŒ‘æˆ˜"
              : "ä¸­æ€§"}
          </span>
        </div>
      </div>
    </div>
  );
});

const AspectsSection = memo(function AspectsSection({
  aspects,
}: {
  aspects: Aspect[];
}) {
  const [expanded, setExpanded] = useState(false);
  const displayAspects = expanded ? aspects : aspects.slice(0, 3);

  // Group aspects by influence
  const positiveCount = aspects.filter((a) => a.influence === "positive").length;
  const challengingCount = aspects.filter((a) => a.influence === "challenging").length;

  return (
    <div className="space-y-3">
      <div className="flex items-center justify-between">
        <h4 className="text-sm font-medium text-slate-600 dark:text-slate-400 flex items-center gap-2">
          <span>ğŸ”®</span> è¡Œæ˜Ÿç›¸ä½ ({aspects.length})
        </h4>
        <div className="flex items-center gap-2 text-xs">
          <span className="text-green-600 dark:text-green-400">
            âœ¨ {positiveCount}
          </span>
          <span className="text-amber-600 dark:text-amber-400">
            âš¡ {challengingCount}
          </span>
        </div>
      </div>

      <div className="space-y-2">
        {displayAspects.map((aspect, i) => (
          <AspectItem key={i} aspect={aspect} />
        ))}
      </div>

      {aspects.length > 3 && (
        <button
          onClick={() => setExpanded(!expanded)}
          className="w-full py-2 text-sm text-pink-600 dark:text-pink-400 hover:underline"
        >
          {expanded ? "æ”¶èµ·" : `æŸ¥çœ‹å…¨éƒ¨ ${aspects.length} ä¸ªç›¸ä½`}
        </button>
      )}
    </div>
  );
});

const InsightSection = memo(function InsightSection({
  strengths,
  challenges,
  advice,
}: {
  strengths?: string[];
  challenges?: string[];
  advice?: string;
}) {
  return (
    <div className="space-y-3">
      <h4 className="text-sm font-medium text-slate-600 dark:text-slate-400 flex items-center gap-2">
        <span>ğŸ’¡</span> æ·±åº¦æ´å¯Ÿ
      </h4>

      <div className="grid grid-cols-2 gap-3">
        {/* Strengths */}
        {strengths && strengths.length > 0 && (
          <div className="p-3 rounded-lg bg-green-50 dark:bg-green-900/20">
            <p className="text-xs font-medium text-green-700 dark:text-green-300 mb-2">
              å…³ç³»äº®ç‚¹
            </p>
            <ul className="space-y-1">
              {strengths.map((s, i) => (
                <li
                  key={i}
                  className="text-xs text-slate-600 dark:text-slate-300 flex items-start gap-1"
                >
                  <span className="text-green-500">â€¢</span>
                  <span>{s}</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Challenges */}
        {challenges && challenges.length > 0 && (
          <div className="p-3 rounded-lg bg-amber-50 dark:bg-amber-900/20">
            <p className="text-xs font-medium text-amber-700 dark:text-amber-300 mb-2">
              éœ€è¦å…³æ³¨
            </p>
            <ul className="space-y-1">
              {challenges.map((c, i) => (
                <li
                  key={i}
                  className="text-xs text-slate-600 dark:text-slate-300 flex items-start gap-1"
                >
                  <span className="text-amber-500">â€¢</span>
                  <span>{c}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>

      {/* Advice */}
      {advice && (
        <div className="p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20">
          <p className="text-xs font-medium text-blue-700 dark:text-blue-300 mb-1">
            ç›¸å¤„å»ºè®®
          </p>
          <p className="text-sm text-slate-600 dark:text-slate-300">{advice}</p>
        </div>
      )}
    </div>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function ZodiacSynastryDetailCard({
  person1,
  person2,
  overall_score = 70,
  categories = [],
  aspects = [],
  strengths = [],
  challenges = [],
  advice = "",
}: ZodiacSynastryDetailData) {
  return (
    <div className="zodiac-synastry-detail-card bg-gradient-to-br from-pink-50 to-purple-50 dark:from-pink-950/30 dark:to-purple-950/30 rounded-2xl border border-pink-200 dark:border-pink-800 overflow-hidden my-2 fade-in shadow-[var(--shadow-card)]">
      {/* Header */}
      <div className="p-5 border-b border-pink-200 dark:border-pink-800">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <span className="text-xl">â™ˆ</span>
            <h3 className="text-base font-semibold text-slate-700 dark:text-slate-200">
              æ˜Ÿåº§åˆç›˜è¯¦æƒ…
            </h3>
          </div>
          <div
            className={`px-3 py-1 rounded-full text-sm font-medium ${
              overall_score >= 70
                ? "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300"
                : overall_score >= 50
                ? "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300"
                : "bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300"
            }`}
          >
            {overall_score}åˆ†
          </div>
        </div>

        {/* Person signs */}
        {person1 && person2 && (
          <div className="flex items-center justify-center gap-4 mt-3 text-sm text-slate-600 dark:text-slate-400">
            <span>
              å¤ªé˜³{person1.sun_sign_chinese} Ã— å¤ªé˜³{person2.sun_sign_chinese}
            </span>
          </div>
        )}
      </div>

      {/* Content */}
      <div className="p-4 space-y-5">
        {/* Categories */}
        {categories.length > 0 && <CategorySection categories={categories} />}

        {/* Aspects */}
        {aspects.length > 0 && <AspectsSection aspects={aspects} />}

        {/* Insights */}
        {(strengths.length > 0 || challenges.length > 0 || advice) && (
          <InsightSection
            strengths={strengths}
            challenges={challenges}
            advice={advice}
          />
        )}
      </div>

      {/* Footer */}
      <div className="px-4 pb-4">
        <p className="text-xs text-center text-slate-400">
          åŸºäºè¡Œæ˜Ÿç›¸ä½åˆ†æç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ
        </p>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("zodiac_synastry_detail", ZodiacSynastryDetailCard);

export default ZodiacSynastryDetailCard;
