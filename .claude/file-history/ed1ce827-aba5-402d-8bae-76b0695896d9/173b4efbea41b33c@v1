/**
 * ProgressStreakCard - è¿ç»­ç­¾åˆ°å’Œè¿›åº¦ç»Ÿè®¡å¡ç‰‡
 *
 * å±•ç¤ºç”¨æˆ·çš„ç­¾åˆ°è®°å½•å’Œè¿›åº¦ç»Ÿè®¡
 * card_type: "progress_streak"
 */

"use client";

import { motion } from "framer-motion";
import { registerCard } from "@/skills/CardRegistry";

interface MonthlyStats {
  levers_completed?: number;
  rocks_completed?: number;
  insights_gained?: number;
}

interface Achievement {
  id: string;
  name: string;
  icon: string;
  earned_at?: string;
}

interface ProgressStreakData {
  current_streak: number;
  longest_streak?: number;
  total_checkins?: number;
  weekly_completion_rate?: number;
  monthly_stats?: MonthlyStats;
  achievements?: Achievement[];
  motivation?: string;
  generated_at?: string;
}

interface ProgressStreakCardProps {
  data: ProgressStreakData;
}

function ProgressStreakCard({ data }: ProgressStreakCardProps) {
  const {
    current_streak,
    longest_streak,
    total_checkins,
    weekly_completion_rate,
    monthly_stats,
    achievements,
    motivation
  } = data;

  // ç”Ÿæˆç«ç„°å›¾æ ‡æ•°é‡
  const getFlameCount = (streak: number) => {
    if (streak >= 30) return 5;
    if (streak >= 14) return 4;
    if (streak >= 7) return 3;
    if (streak >= 3) return 2;
    return 1;
  };

  const flames = getFlameCount(current_streak);

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.5 }}
      className="progress-streak-card bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-950/30 dark:to-blue-950/30 rounded-2xl border border-cyan-200 dark:border-cyan-800 p-5 my-2 overflow-hidden shadow-[var(--shadow-card)]"
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <span className="text-2xl">ğŸ”¥</span>
          <h3 className="text-lg font-semibold text-rose-900 dark:text-rose-100">
            è¿ç»­ç­¾åˆ°
          </h3>
        </div>
        {longest_streak && longest_streak > current_streak && (
          <span className="text-xs text-muted-foreground">
            æœ€é•¿è®°å½•: {longest_streak}å¤©
          </span>
        )}
      </div>

      {/* Streak Display */}
      <motion.div
        initial={{ scale: 0.8, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        transition={{ delay: 0.2, type: "spring" }}
        className="flex flex-col items-center justify-center py-6 bg-white/50 dark:bg-black/20 rounded-xl mb-4"
      >
        <div className="flex items-center gap-1 mb-2">
          {Array.from({ length: flames }).map((_, i) => (
            <motion.span
              key={i}
              initial={{ scale: 0, rotate: -20 }}
              animate={{ scale: 1, rotate: 0 }}
              transition={{ delay: 0.3 + i * 0.1, type: "spring" }}
              className="text-2xl"
            >
              ğŸ”¥
            </motion.span>
          ))}
        </div>
        <motion.div
          initial={{ scale: 0 }}
          animate={{ scale: 1 }}
          transition={{ delay: 0.5, type: "spring" }}
          className="text-5xl font-bold text-rose-600 dark:text-rose-400"
        >
          {current_streak}
        </motion.div>
        <div className="text-sm text-muted-foreground mt-1">
          è¿ç»­å¤©æ•°
        </div>
      </motion.div>

      {/* Stats Grid */}
      <motion.div
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        transition={{ delay: 0.6 }}
        className="grid grid-cols-3 gap-2 mb-4"
      >
        <div className="text-center p-2 bg-white/30 dark:bg-black/10 rounded-lg">
          <div className="text-lg font-semibold">{total_checkins || 0}</div>
          <div className="text-xs text-muted-foreground">æ€»ç­¾åˆ°</div>
        </div>
        <div className="text-center p-2 bg-white/30 dark:bg-black/10 rounded-lg">
          <div className="text-lg font-semibold">{weekly_completion_rate || 0}%</div>
          <div className="text-xs text-muted-foreground">å‘¨å®Œæˆç‡</div>
        </div>
        <div className="text-center p-2 bg-white/30 dark:bg-black/10 rounded-lg">
          <div className="text-lg font-semibold">{longest_streak || current_streak}</div>
          <div className="text-xs text-muted-foreground">æœ€é•¿è¿ç»­</div>
        </div>
      </motion.div>

      {/* Monthly Stats */}
      {monthly_stats && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.7 }}
          className="flex justify-around py-2 border-t border-rose-200 dark:border-rose-800 mb-4"
        >
          {monthly_stats.levers_completed !== undefined && (
            <div className="text-center">
              <div className="text-sm font-medium">{monthly_stats.levers_completed}</div>
              <div className="text-xs text-muted-foreground">æ æ†å®Œæˆ</div>
            </div>
          )}
          {monthly_stats.rocks_completed !== undefined && (
            <div className="text-center">
              <div className="text-sm font-medium">{monthly_stats.rocks_completed}</div>
              <div className="text-xs text-muted-foreground">å¤§çŸ³å¤´</div>
            </div>
          )}
          {monthly_stats.insights_gained !== undefined && (
            <div className="text-center">
              <div className="text-sm font-medium">{monthly_stats.insights_gained}</div>
              <div className="text-xs text-muted-foreground">æ´å¯Ÿ</div>
            </div>
          )}
        </motion.div>
      )}

      {/* Achievements */}
      {achievements && achievements.length > 0 && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ delay: 0.8 }}
          className="flex flex-wrap gap-2 mb-4"
        >
          {achievements.slice(0, 5).map((achievement, index) => (
            <motion.span
              key={achievement.id}
              initial={{ scale: 0 }}
              animate={{ scale: 1 }}
              transition={{ delay: 0.9 + index * 0.1 }}
              className="px-2 py-1 bg-rose-100 dark:bg-rose-900/50 rounded-full text-xs flex items-center gap-1"
              title={achievement.name}
            >
              <span>{achievement.icon}</span>
              <span>{achievement.name}</span>
            </motion.span>
          ))}
        </motion.div>
      )}

      {/* Motivation */}
      {motivation && (
        <motion.div
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 1 }}
          className="text-center text-sm text-rose-700 dark:text-rose-300 italic"
        >
          {`"${motivation}"`}
        </motion.div>
      )}
    </motion.div>
  );
}

registerCard("progress_streak", ProgressStreakCard);

export default ProgressStreakCard;
