/**
 * BaziFortuneCard - 大运流年卡片
 *
 * 从 show-fortune.tsx 提取的纯渲染组件
 * 通过 CardRegistry 注册，由 card_type: "bazi_fortune" 触发
 */

"use client";

import { cn } from "@/lib/utils";
import { registerCard } from "@/skills/CardRegistry";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface MajorCycle {
  start_year: number;
  end_year: number;
  element?: string;
  polarity?: string;
  phase?: string;
  theme: string;
  description?: string;
  fortune_score: number;
}

interface AnnualFortune {
  year: number;
  element?: string;
  polarity?: string;
  influence?: string;
  fortune_score: number;
  theme: string;
  highlights?: string[];
  cautions?: string[];
}

interface BaziFortuneData {
  user_id?: string;
  userId?: string;
  year?: number;
  cycles?: MajorCycle[];
  annual?: AnnualFortune | null;
}

interface BaziFortuneCardProps {
  data: BaziFortuneData;
  cardProps?: Record<string, unknown>;
}

// ═══════════════════════════════════════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════════════════════════════════════

function scoreBadge(score: number) {
  if (score >= 85) return { label: "偏强", className: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-200" };
  if (score >= 70) return { label: "稳健", className: "bg-sky-100 text-sky-800 dark:bg-sky-900/30 dark:text-sky-200" };
  if (score >= 55) return { label: "平稳", className: "bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-200" };
  if (score >= 40) return { label: "偏紧", className: "bg-accent-100 text-accent-800 dark:bg-accent-900/30 dark:text-accent-200" };
  return { label: "多变", className: "bg-rose-100 text-rose-800 dark:bg-rose-900/30 dark:text-rose-200" };
}

// ═══════════════════════════════════════════════════════════════════════════
// Component
// ═══════════════════════════════════════════════════════════════════════════

function BaziFortuneCard({ data }: BaziFortuneCardProps) {
  const currentYear = data.year || new Date().getFullYear();
  const cycles = data.cycles || [];
  const annual = data.annual;

  const currentCycle =
    cycles.find((c) => currentYear >= c.start_year && currentYear <= c.end_year) || cycles[0];
  const cycleScore = currentCycle?.fortune_score ?? 60;
  const cycleBadge = scoreBadge(cycleScore);
  const annualScore = annual?.fortune_score ?? 60;
  const annualBadge = scoreBadge(annualScore);

  return (
    <div className="fortune-card bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 rounded-2xl border border-amber-200 dark:border-amber-800 p-5 my-2 shadow-[var(--shadow-card)]">
      <div className="flex items-center justify-between gap-3 mb-4">
        <h3 className="text-lg font-semibold text-amber-900 dark:text-amber-100">
          大运与流年
        </h3>
        <span className={cn("px-2 py-1 rounded text-xs font-medium", annualBadge.className)}>
          {currentYear} · {annualBadge.label} {annualScore}/100
        </span>
      </div>

      {currentCycle && (
        <div className="bg-white/60 dark:bg-black/30 rounded-lg p-3 mb-3">
          <div className="flex items-center justify-between gap-3 mb-1">
            <span className="text-sm font-medium">当前大运</span>
            <span className={cn("px-2 py-0.5 rounded text-xs font-medium", cycleBadge.className)}>
              {cycleBadge.label} {cycleScore}/100
            </span>
          </div>
          <p className="text-sm text-foreground">
            {currentCycle.start_year}-{currentCycle.end_year} · {currentCycle.theme}
          </p>
          {currentCycle.description && (
            <p className="text-xs text-muted-foreground mt-1">
              {currentCycle.description}
            </p>
          )}
        </div>
      )}

      <div className="mb-3">
        <div className="text-sm font-medium text-amber-700 dark:text-amber-300 mb-2">
          大运周期
        </div>
        <div className="flex overflow-x-auto gap-2 pb-2">
          {cycles.slice(0, 10).map((cycle) => {
            const isCurrent = currentYear >= cycle.start_year && currentYear <= cycle.end_year;
            const badge = scoreBadge(cycle.fortune_score);
            return (
              <div
                key={`${cycle.start_year}-${cycle.end_year}`}
                className={cn(
                  "flex-shrink-0 px-3 py-2 rounded-lg text-center min-w-[84px] border",
                  isCurrent
                    ? "bg-amber-100/70 dark:bg-amber-900/30 border-amber-300 dark:border-amber-700"
                    : "bg-white/60 dark:bg-black/20 border-border/40"
                )}
              >
                <div className="text-[10px] text-muted-foreground">
                  {cycle.start_year}–{cycle.end_year}
                </div>
                <div className="text-xs font-medium mt-0.5">{cycle.theme}</div>
                <div className={cn("inline-flex mt-1 px-1.5 py-0.5 rounded text-[10px] font-medium", badge.className)}>
                  {cycle.fortune_score}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {annual && (
        <div className="bg-gradient-to-r from-amber-100 to-orange-100 dark:from-amber-900/30 dark:to-orange-900/30 rounded-lg p-3">
          <div className="flex items-center justify-between gap-3 mb-2">
            <div className="text-sm font-medium">流年主题</div>
            <span className={cn("px-2 py-0.5 rounded text-xs font-medium", annualBadge.className)}>
              {annualBadge.label}
            </span>
          </div>
          <p className="text-sm text-foreground">{annual.theme}</p>
          {(annual.highlights?.length || annual.cautions?.length) ? (
            <div className="grid grid-cols-2 gap-3 mt-3 text-xs">
              <div className="bg-white/60 dark:bg-black/20 rounded p-2">
                <div className="font-medium mb-1">机会</div>
                <ul className="space-y-0.5 text-muted-foreground">
                  {(annual.highlights || []).slice(0, 3).map((item) => (
                    <li key={item}>• {item}</li>
                  ))}
                </ul>
              </div>
              <div className="bg-white/60 dark:bg-black/20 rounded p-2">
                <div className="font-medium mb-1">提醒</div>
                <ul className="space-y-0.5 text-muted-foreground">
                  {(annual.cautions || []).slice(0, 3).map((item) => (
                    <li key={item}>• {item}</li>
                  ))}
                </ul>
              </div>
            </div>
          ) : null}
        </div>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Register to CardRegistry
// ═══════════════════════════════════════════════════════════════════════════

registerCard("bazi_fortune", BaziFortuneCard);

export default BaziFortuneCard;
