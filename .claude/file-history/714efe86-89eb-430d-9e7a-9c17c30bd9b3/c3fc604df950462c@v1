# Fortune AI å‰ç«¯è®¾è®¡æ–¹æ¡ˆ

**ç‰ˆæœ¬**ï¼šv4.2ï¼ˆ2026-01-01ï¼ŒVercel AI SDK Editionï¼‰

> **å®šä½**: åŸºäº Notion ç¾å­¦çš„ AI æ™ºèƒ½å·¥ä½œç©ºé—´
>
> **åç«¯æ¶æ„**: Vercel AI SDK Driven / Pluggable Skillsï¼ˆå‚è§ [os_design_v3.md Â§1.4](./os_design_v3.md#14-è¿›åŒ–è®°å¿†æ¶æ„-vercel-ai-sdk-edition---v42)ï¼‰
>
> **å…¥å£**: http://106.37.170.238:8231/new
>
> **æœ¬ç‰ˆæ›´æ–°**: é‡‡ç”¨ Vercel AI SDK 6 `useChat()` Hook å®ç°ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“

---

## 0. ä¿®è®¢è¯´æ˜

### 0.0 å‰ç«¯ä¸åç«¯æ¶æ„å±‚äº¤äº’ (v4.2 Vercel AI SDK Edition)

v4.2 é‡‡ç”¨ **Vercel AI SDK** ä½œä¸ºç»Ÿä¸€ Agent Runtimeï¼Œå‰ç«¯é€šè¿‡ `useChat()` Hook ä¸ Next.js API Route äº¤äº’ï¼š

```
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚                           Frontend (Next.js + Vercel AI SDK)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      Zone A (Chat)                â”‚           Zone B (Dashboard)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ useChat() Hook              â”‚  â”‚  â”‚ Tabs: Overview/Status/Trends/Tasks  â”‚  â”‚
â”‚  â”‚ â”œâ”€ messages (æµå¼æ¸²æŸ“)       â”‚  â”‚  â”‚ æ•°æ®å±•ç¤º â† GET FastAPI               â”‚  â”‚
â”‚  â”‚ â”œâ”€ input / setInput         â”‚  â”‚  â”‚ â˜… Tool Result è§¦å‘ Tab è”åŠ¨         â”‚  â”‚
â”‚  â”‚ â”œâ”€ handleSubmit             â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ â””â”€ toolInvocations (A2UI)   â”‚  â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                           â”‚
â”‚  â”‚ CommandPalette              â”‚  â”‚                                           â”‚
â”‚  â”‚ â””â”€ /divine /heal /grow      â”‚  â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ useChat() â†’ POST /api/chat (HTTP Stream)
                    â–¼
â”Œâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”
â”‚  Agent Runtime Layer (Next.js API Route)                         NEW in v4.2  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  streamText({                                                                  â”‚
â”‚    model: selectModel(),      // GLM-4.5 / Gemini / Claude                    â”‚
â”‚    system: buildSystemPrompt(context),                                        â”‚
â”‚    tools: { calculate_bazi, log_perma, covey_matrix, ... },                   â”‚
â”‚    maxSteps: 5,               // Agent Loop å¤šæ­¥æ¨ç†                          â”‚
â”‚  }) â†’ toDataStreamResponse()                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ Tool execute: fetch() è°ƒç”¨ Python API
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI (Python) - Data Service Only                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  /api/bazi/calculate  â†’ L1 å…«å­—æ’ç›˜                                            â”‚
â”‚  /api/perma/log       â†’ L1 PERMA è®°å½•                                          â”‚
â”‚  /api/goals/create    â†’ L1 ç›®æ ‡ç®¡ç†                                            â”‚
â”‚  /api/user/context    â†’ L0+L1 ä¸Šä¸‹æ–‡èšåˆ                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**v4.2 æ ¸å¿ƒå˜åŒ–**:

| v4.0/v4.1 | v4.2 (Vercel AI SDK) | è¯´æ˜ |
|-----------|----------------------|------|
| è‡ªå®šä¹‰ SSE `/api/chat/stream` | `useChat()` + `toDataStreamResponse()` | æ ‡å‡†åŒ–æµå¼åè®® |
| `lib/api.ts` æ‰‹åŠ¨ fetch | `ai/react` å†…ç½® Hook | ç®€åŒ–å‰ç«¯ä»£ç  |
| A2UI JSON å—æ‰‹åŠ¨è§£æ | `toolInvocations` è‡ªåŠ¨è§£æ | Tool Result åŸç”Ÿæ”¯æŒ |
| CSRF Token æ‰‹åŠ¨å¤„ç† | Next.js API Route åŒæº | æ— è·¨åŸŸé—®é¢˜ |
| Python `glm_client.py` | TypeScript `streamText()` | AI é€»è¾‘è¿ç§»åˆ° TS |

### 0.1 è®¾è®¡ vs å®ç°å¯¹æ¯”æ€»è§ˆ

| æ¨¡å— | è®¾è®¡çŠ¶æ€ | å®ç°çŠ¶æ€ | å·®è· | å¯¹åº”æ¶æ„å±‚ |
|------|----------|----------|------|------------|
| åŒæ å¸ƒå±€ | âœ… Zone A + Zone B | âœ… å·²å®ç° | æ—  | - |
| é»„é‡‘åˆ†å‰²æ¯”ä¾‹ | âœ… 61.8% : 38.2% | âœ… å·²å®ç° | æ—  | - |
| Resizer æ‹–æ‹½ | âœ… å¯è°ƒæ•´å®½åº¦ | âš ï¸ éƒ¨åˆ†å®ç° | åŒå‡»æ¢å¤é»˜è®¤ | - |
| Tab ç³»ç»Ÿ | âœ… 6 ä¸ª Tab | âœ… å·²å®ç° | æ—  | L1 Module Data |
| A2UI æ¸²æŸ“ | âœ… action_buttons | âš ï¸ éƒ¨åˆ†å®ç° | æŒ‰é’®ç‚¹å‡»å¤„ç† | Context Mgmt |
| CSRF å¤„ç† | âœ… X-CSRF-Token | âš ï¸ é—®é¢˜ | å‰ç«¯æœªç»Ÿä¸€ | - |
| éª¨æ¶å± | âœ… Shimmer åŠ è½½ | âš ï¸ éƒ¨åˆ†å®ç° | éœ€å®Œå–„ | - |

---

## 1. æ•´ä½“æ¶æ„ (Mermaid)

> **å‘½åè§„èŒƒ**: å‚è§ [GLOSSARY.md](../GLOSSARY.md)
> **åç«¯æ¶æ„**: Dynamic Profiling & Evolutionary Loopï¼ˆå‚è§ [os_design_v3.md Â§1.4](../os/os_design_v3.md#14-è¿›åŒ–è®°å¿†æ¶æ„-evolutionary-memory-view---v40)ï¼‰
> **å…¥å£**: `/new` (basePath="/new")ï¼Œæ—§å…¥å£ `/main` `/login` `/register` å‡ 307 é‡å®šå‘

### 1.1 å‰ç«¯ç»„ä»¶æ¶æ„å›¾

> **v4.1 æ–°å¢**: Zone A çš„ ChatInput ç»„ä»¶é›†æˆ Command Paletteï¼Œæ”¯æŒ `/command` å¿«æ·æŒ‡ä»¤

```mermaid
graph TB
    subgraph Browser["ğŸŒ Browser"]
        direction TB
        URL["URL: /new"]
    end

    subgraph NextJS["ğŸ“± Next.js (:8231)"]
        subgraph AppRouter["App Router"]
            RootLayout["layout.tsx<br/>Providers"]
            NewLayout["new/layout.tsx<br/>åŒæ å®¹å™¨"]
            NewPage["new/page.tsx<br/>ä¸»ç•Œé¢"]
            LoginPage["new/login/page.tsx"]
            RegisterPage["new/register/page.tsx"]
        end

        subgraph Components["Components"]
            subgraph ZoneA["Zone A (61.8%)"]
                ChatPanel["chat-panel.tsx"]
                MessageList["message-list.tsx"]
                MessageItem["message-item.tsx"]
                BlockRenderer["blocks/index.tsx"]
                subgraph InputArea["Input Area (v4.1)"]
                    ChatInput["chat-input.tsx"]
                    CmdTrigger["/ Trigger Detection"]
                    CmdMenu["CommandPalette<br/>/divine /heal /grow"]
                end
            end

            subgraph ZoneB["Zone B (38.2%)"]
                DashPanel["dashboard-panel.tsx"]
                TabBar["Tab åˆ‡æ¢"]
                OverviewTab["overview-tab.tsx"]
                StatusTab["status-tab.tsx"]
                TrendsTab["trends-tab.tsx"]
                QuestsTab["quests-tab.tsx"]
            end
        end

        subgraph State["State Management"]
            AppStore["Zustand<br/>app-store.ts"]
            ApiClient["lib/api.ts<br/>+ csrfHeaders()"]
        end
    end

    subgraph Backend["ğŸ”§ FastAPI (:8230)"]
        API["/api/*"]
        CmdRouter["Command Router<br/>(Skill Dispatch)"]
    end

    URL --> RootLayout
    RootLayout --> NewLayout
    NewLayout --> NewPage
    NewLayout --> LoginPage
    NewLayout --> RegisterPage

    NewPage --> ChatPanel
    NewPage --> DashPanel

    ChatPanel --> MessageList
    MessageList --> MessageItem
    MessageItem --> BlockRenderer

    ChatInput -->|"è¾“å…¥ /"| CmdTrigger
    CmdTrigger -->|"æ˜¾ç¤ºèœå•"| CmdMenu
    CmdMenu -->|"é€‰æ‹©æŒ‡ä»¤"| ChatInput

    DashPanel --> TabBar
    TabBar --> OverviewTab
    TabBar --> StatusTab
    TabBar --> TrendsTab
    TabBar --> QuestsTab

    ChatPanel --> AppStore
    DashPanel --> AppStore
    AppStore --> ApiClient
    ApiClient -->|"fetch + X-CSRF-Token"| API
    API -->|"/cmd è¯·æ±‚"| CmdRouter

    style InputArea fill:#e3f2fd,stroke:#1976d2
    style CmdMenu fill:#e3f2fd,stroke:#1976d2
    style CmdRouter fill:#e3f2fd,stroke:#1976d2
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                             Next.js å‰ç«¯ç»„ä»¶æ¶æ„                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   Browser: /new         â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚     App Router          â”‚
                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                          â”‚  â”‚ layout.tsx       â”‚   â”‚
                          â”‚  â”‚ (Providers)      â”‚   â”‚
                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                          â”‚           â”‚             â”‚
                          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                          â”‚  â”‚ new/layout.tsx   â”‚   â”‚
                          â”‚  â”‚ (åŒæ å®¹å™¨)       â”‚   â”‚
                          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                                       â”‚
          â–¼                                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Zone A (61.8% é»„é‡‘åˆ†å‰²)        â”‚       â”‚   Zone B (38.2% é»„é‡‘åˆ†å‰²)            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ chat-panel.tsx              â”‚ â”‚       â”‚ â”‚ dashboard-panel.tsx             â”‚ â”‚
â”‚ â”‚ â”œâ”€ message-list.tsx         â”‚ â”‚       â”‚ â”‚ â”œâ”€ Tab åˆ‡æ¢æ                    â”‚ â”‚
â”‚ â”‚ â”‚  â””â”€ message-item.tsx      â”‚ â”‚       â”‚ â”‚ â”‚  â”œâ”€ overview-tab.tsx         â”‚ â”‚
â”‚ â”‚ â”‚     â””â”€ blocks/index.tsx   â”‚ â”‚       â”‚ â”‚ â”‚  â”œâ”€ status-tab.tsx           â”‚ â”‚
â”‚ â”‚ â”‚        (A2UI æ¸²æŸ“)        â”‚ â”‚       â”‚ â”‚ â”‚  â”œâ”€ trends-tab.tsx           â”‚ â”‚
â”‚ â”‚ â””â”€ chat-input.tsx           â”‚ â”‚       â”‚ â”‚ â”‚  â””â”€ quests-tab.tsx           â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                                           â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  State Management   â”‚
                          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                          â”‚ â”‚ Zustand        â”‚  â”‚
                          â”‚ â”‚ app-store.ts   â”‚  â”‚
                          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                          â”‚         â”‚           â”‚
                          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                          â”‚ â”‚ lib/api.ts     â”‚  â”‚
                          â”‚ â”‚ + csrfHeaders()â”‚  â”‚
                          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ FastAPI (:8230)     â”‚
                          â”‚ /api/*              â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

### 1.2 æŠ€æœ¯æ ˆ (v4.2 Vercel AI SDK Edition)

| å±‚çº§ | æŠ€æœ¯ | çŠ¶æ€ | v4.2 å˜åŒ– |
|------|------|:----:|-----------|
| æ¡†æ¶ | Next.js 14 (App Router) + React 18 + TypeScript | âœ“ | - |
| **AI Runtime** | **Vercel AI SDK 6 (`ai` package)** | âš ï¸ å¾…å¼•å…¥ | **NEW** |
| **Chat Hook** | **`useChat()` from `ai/react`** | âš ï¸ å¾…é‡æ„ | **NEW** |
| **Tool Calling** | **Zod Schema + `tool()` function** | âš ï¸ å¾…å®ç° | **NEW** |
| æ ·å¼ | Tailwind CSS + shadcn/ui + Radix UI | âœ“ | - |
| çŠ¶æ€ | Zustand (UI state) | âœ“ | - |
| æ•°æ®è·å– | `useChat()` (Chat) + TanStack Query (Dashboard) | âš ï¸ å¾…è¿ç§» | `useChat` æ›¿ä»£æ‰‹åŠ¨ fetch |
| å›¾è¡¨ | Recharts | âœ“ | - |
| åŠ¨æ•ˆ | CSS transitions (Framer Motion å¯é€‰) | âœ“ | - |
| è™šæ‹Ÿæ»šåŠ¨ | æœªå®ç° (å»ºè®® react-virtual) | â³ | - |

**v4.2 æ–°å¢ä¾èµ–**:

```json
{
  "dependencies": {
    "ai": "^4.0.0",
    "@ai-sdk/google": "^1.0.0",
    "zod": "^3.22.0"
  }
}
```

### 1.2 å½“å‰å®ç°æ¶æ„æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å½“å‰å®ç°ï¼šNext.js App Router                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  web-app/src/
  â”œâ”€â”€ app/
  â”‚   â”œâ”€â”€ layout.tsx              â† Root Layout (providers)
  â”‚   â”œâ”€â”€ page.tsx                â† / é‡å®šå‘åˆ° /new
  â”‚   â”œâ”€â”€ new/
  â”‚   â”‚   â”œâ”€â”€ layout.tsx          â† âœ… åŒæ å¸ƒå±€å®¹å™¨
  â”‚   â”‚   â”œâ”€â”€ page.tsx            â† âœ… ä¸»ç•Œé¢
  â”‚   â”‚   â”œâ”€â”€ login/page.tsx      â† âœ… ç™»å½•é¡µ
  â”‚   â”‚   â””â”€â”€ register/page.tsx   â† âœ… æ³¨å†Œé¡µ
  â”‚   â””â”€â”€ settings/page.tsx       â† âš ï¸ å¾…å®Œå–„
  â”‚
  â”œâ”€â”€ components/
  â”‚   â”œâ”€â”€ chat/
  â”‚   â”‚   â”œâ”€â”€ chat-panel.tsx      â† âœ… Zone A èŠå¤©é¢æ¿
  â”‚   â”‚   â”œâ”€â”€ message-list.tsx    â† âœ… æ¶ˆæ¯åˆ—è¡¨
  â”‚   â”‚   â”œâ”€â”€ message-item.tsx    â† âš ï¸ A2UI æ¸²æŸ“å¾…å®Œå–„
  â”‚   â”‚   â””â”€â”€ chat-input.tsx      â† âœ… è¾“å…¥æ¡†
  â”‚   â”‚
  â”‚   â”œâ”€â”€ dashboard/
  â”‚   â”‚   â”œâ”€â”€ dashboard-panel.tsx â† âœ… Zone B é¢æ¿
  â”‚   â”‚   â””â”€â”€ tabs/
  â”‚   â”‚       â”œâ”€â”€ overview-tab.tsx   â† âœ… æ¦‚è§ˆ
  â”‚   â”‚       â”œâ”€â”€ status-tab.tsx     â† âœ… çŠ¶æ€
  â”‚   â”‚       â”œâ”€â”€ trends-tab.tsx     â† âœ… è¶‹åŠ¿
  â”‚   â”‚       â”œâ”€â”€ tasks-tab.tsx      â† âš ï¸ CSRF é—®é¢˜
  â”‚   â”‚       â”œâ”€â”€ relations-tab.tsx  â† âœ… å…³ç³»
  â”‚   â”‚       â””â”€â”€ explore-tab.tsx    â† âœ… æ¢ç´¢
  â”‚   â”‚
  â”‚   â””â”€â”€ ui/                     â† shadcn/ui ç»„ä»¶
  â”‚
  â””â”€â”€ lib/
      â”œâ”€â”€ api.ts                  â† âš ï¸ CSRF å¤„ç†éœ€ä¿®å¤
      â””â”€â”€ hooks/                  â† è‡ªå®šä¹‰ Hooks

  å®ç°çŠ¶æ€:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ âœ… Next.js 14 App Router                                              â”‚
  â”‚ âœ… React 18 + TypeScript                                              â”‚
  â”‚ âœ… Tailwind CSS + è‡ªå®šä¹‰ä¸»é¢˜                                          â”‚
  â”‚ âš ï¸ shadcn/ui éƒ¨åˆ†ä½¿ç”¨                                                 â”‚
  â”‚ âš ï¸ è™šæ‹Ÿæ»šåŠ¨æœªå®ç°                                                     â”‚
  â”‚ âš ï¸ Framer Motion æœªå¼•å…¥                                               â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 æœ€ä¼˜æ¶æ„æµç¨‹å›¾ï¼ˆç»¼åˆåˆ†æå»ºè®®ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ€ä¼˜æ–¹æ¡ˆï¼šå®Œå–„çš„åŒæ ¸å“åº”å¼æ¶æ„                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                           /new (ä¸»ç•Œé¢)                                  â”‚
  â”‚                                                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚                    é¡¶éƒ¨å¯¼èˆªæ  (å¯é€‰æ˜¾ç¤º)                            â”‚  â”‚
  â”‚  â”‚  Fortune AI    [ä¼šè¯åˆ‡æ¢â–¾]    [è®¾ç½®] [ç”¨æˆ·â–¾]                       â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â”‚                                                                         â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
  â”‚  â”‚      Zone A (å¯è°ƒ)        â”‚Râ”‚       Zone B (å¯è°ƒ)                  â”‚  â”‚
  â”‚  â”‚                           â”‚eâ”‚                                     â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚sâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
  â”‚  â”‚  â”‚    å¿«æ·æŒ‰é’®æ         â”‚ â”‚iâ”‚  â”‚  [æ¦‚è§ˆ][çŠ¶æ€][è¶‹åŠ¿][ä»»åŠ¡]...    â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚ [çŠ¶æ€] [æ‰“å¡] [ä»»åŠ¡] â”‚ â”‚zâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚eâ”‚                                     â”‚  â”‚
  â”‚  â”‚                           â”‚râ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  â”‚                                 â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚   æ¶ˆæ¯æµ (è™šæ‹Ÿæ»šåŠ¨)  â”‚ â”‚åŒâ”‚  â”‚       Tab å†…å®¹åŒº               â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚                      â”‚ â”‚å‡»â”‚  â”‚                                 â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚æ¢â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚ ç”¨æˆ·æ¶ˆæ¯       â”‚ â”‚ â”‚å¤â”‚  â”‚  â”‚ å¡ç‰‡/å›¾è¡¨/åˆ—è¡¨ç»„ä»¶      â”‚   â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚é»˜â”‚  â”‚  â”‚                         â”‚   â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚                      â”‚ â”‚è®¤â”‚  â”‚  â”‚ â€¢ éª¨æ¶å±åŠ è½½            â”‚   â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚  â”‚  â”‚ â€¢ ä¹è§‚UIæ›´æ–°            â”‚   â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚ AI å›å¤        â”‚ â”‚ â”‚ â”‚  â”‚  â”‚ â€¢ é”™è¯¯è¾¹ç•Œå¤„ç†          â”‚   â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚ â”œâ”€ markdown    â”‚ â”‚ â”‚ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚ â”œâ”€ If-Thenå¤„æ–¹ â”‚ â”‚ â”‚ â”‚  â”‚                                 â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â”‚ â””â”€ è¡ŒåŠ¨æŒ‰é’® â†â”€â”€â”¼â”€â”¼â”€â”¼â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€ ç‚¹å‡» â†’ API â†’ åˆ·æ–°Tab      â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚  â”‚                                 â”‚ â”‚  â”‚
  â”‚  â”‚  â”‚                      â”‚ â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                                     â”‚  â”‚
  â”‚  â”‚                           â”‚ â”‚                                     â”‚  â”‚
  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚                                     â”‚  â”‚
  â”‚  â”‚  â”‚     Omnibar          â”‚ â”‚ â”‚                                     â”‚  â”‚
  â”‚  â”‚  â”‚ [+] è¾“å…¥æ¶ˆæ¯... [â¤] â”‚ â”‚ â”‚                                     â”‚  â”‚
  â”‚  â”‚  â”‚ /help /checkin       â”‚ â”‚ â”‚                                     â”‚  â”‚
  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚                                     â”‚  â”‚
  â”‚  â”‚                           â”‚ â”‚                                     â”‚  â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç§»åŠ¨ç«¯é€‚é…:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ < 768px: åº•éƒ¨ Tab åˆ‡æ¢ (Chat | Dashboard)                             â”‚
  â”‚ â€¢ Chat å…¨å±æ¨¡å¼                                                       â”‚
  â”‚ â€¢ Dashboard å…¨å±æ¨¡å¼                                                  â”‚
  â”‚ â€¢ æ‰‹åŠ¿æ”¯æŒ (å·¦å³æ»‘åŠ¨åˆ‡æ¢)                                              â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  å…³é”®ä¼˜åŒ–:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ [P0] CSRF ç»Ÿä¸€å¤„ç†                                                    â”‚
  â”‚      - åˆ›å»º api-client.ts å°è£…æ‰€æœ‰è¯·æ±‚                                â”‚
  â”‚      - è‡ªåŠ¨ä» cookie è¯»å– fortune_csrf                                â”‚
  â”‚      - æ¯æ¬¡ POST/PUT/DELETE è‡ªåŠ¨é™„åŠ  X-CSRF-Token                     â”‚
  â”‚                                                                       â”‚
  â”‚ [P0] action_buttons å®Œæ•´æ¸²æŸ“                                          â”‚
  â”‚      - è§£æ A2UI action ç»“æ„                                          â”‚
  â”‚      - å®ç° start_task / schedule_task / open_panel å¤„ç†              â”‚
  â”‚      - æˆåŠŸååˆ·æ–°å¯¹åº” Tab                                              â”‚
  â”‚                                                                       â”‚
  â”‚ [P1] è™šæ‹Ÿæ»šåŠ¨                                                         â”‚
  â”‚      - ä½¿ç”¨ @tanstack/react-virtual                                   â”‚
  â”‚      - æ¶ˆæ¯åˆ—è¡¨ä¼˜åŒ– (100+ æ¶ˆæ¯æ— å¡é¡¿)                                  â”‚
  â”‚                                                                       â”‚
  â”‚ [P2] éª¨æ¶å±å®Œå–„                                                       â”‚
  â”‚      - æ¯ä¸ª Tab ç‹¬ç«‹éª¨æ¶å±                                             â”‚
  â”‚      - Shimmer åŠ¨æ•ˆ                                                   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. æ•°æ®æµ (Mermaid æ—¶åºå›¾)

> **å‘½åè§„èŒƒ**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§4 A2UI ç»„ä»¶ç±»å‹

### 2.1 Chat å‘é€æ—¶åºå›¾ (è®¾è®¡ç›®æ ‡)

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant ZoneA as Zone A<br/>(ChatPanel)
    participant API as FastAPI<br/>(:8230)
    participant DB as PostgreSQL
    participant ZoneB as Zone B<br/>(Dashboard)

    User->>ZoneA: è¾“å…¥æ¶ˆæ¯
    ZoneA->>ZoneA: æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    ZoneA->>API: POST /api/chat/send<br/>+ X-CSRF-Token
    API->>DB: INSERT conversation_message
    API->>API: Context Driven å¤„ç†<br/>(L0â†’L1â†’L2â†’Interaction)
    API-->>ZoneA: A2UI å“åº”<br/>{blocks: [...], suggested_tasks: [...]}

    ZoneA->>ZoneA: æ¸²æŸ“ markdown_text
    ZoneA->>ZoneA: æ¸²æŸ“ action_buttons

    Note over ZoneA,ZoneB: suggested_tasks è§¦å‘ Zone B åˆ·æ–°
    ZoneA->>ZoneB: store.notify('tasks_updated')
    ZoneB->>API: GET /api/dashboard/tasks
    API-->>ZoneB: ä»»åŠ¡åˆ—è¡¨ (å« suggested çŠ¶æ€)
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Chat å‘é€æ—¶åºå›¾                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   ç”¨æˆ·         Zone A           API          DB          Zone B
    â”‚          (ChatPanel)     (FastAPI)   (PostgreSQL)  (Dashboard)
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚â”€â”€[1]è¾“å…¥â”€â”€â”€â”€â–¶â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚â”€â”€æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯â”‚             â”‚             â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚â”€â”€[2]POST /api/chat/sendâ”€â”€â–¶â”‚             â”‚
    â”‚              â”‚   + X-CSRF-Token         â”‚             â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚              â”‚â”€â”€INSERT conversation_msgâ–¶â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚              â”‚â”€â”€Context Drivenâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚â—€â”€â”€[3]A2UI å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
    â”‚              â”‚   {blocks, suggested_tasks}            â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚â”€â”€[4]æ¸²æŸ“ markdown_text    â”‚             â”‚
    â”‚              â”‚â”€â”€[5]æ¸²æŸ“ action_buttons   â”‚             â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚         suggested_tasks è§¦å‘åˆ·æ–°        â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚â”€â”€[6]store.notify('tasks_updated')â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
    â”‚              â”‚              â”‚             â”‚â—€â”€â”€GET /api/dashboard/tasks
    â”‚              â”‚              â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚
    â”‚              â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€ä»»åŠ¡åˆ—è¡¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
    â”‚              â”‚              â”‚             â”‚             â”‚
```
</details>

### 2.2 action_button ç‚¹å‡»æ—¶åºå›¾ (å…³é”®æµç¨‹)

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant Btn as ActionButton
    participant Client as api-client.ts
    participant API as FastAPI
    participant DB as PostgreSQL
    participant Store as Zustand Store
    participant ZoneB as Zone B Tab
    participant Toast as Toast UI

    User->>Btn: ç‚¹å‡» "ç«‹å³æ‰§è¡Œ"
    Btn->>Btn: action.type = 'start_task'

    Btn->>Client: handleAction(action)
    Client->>Client: getCSRFToken()<br/>from cookie
    Client->>API: POST /api/dashboard/task/accept<br/>+ X-CSRF-Token

    alt æˆåŠŸ (200)
        API->>DB: UPDATE commitment SET status='active'
        API-->>Client: {ok: true, commitment_id}
        Client->>Store: taskStore.invalidate()
        Store->>ZoneB: è§¦å‘ re-fetch
        ZoneB->>API: GET /api/dashboard/tasks
        API-->>ZoneB: æ›´æ–°åçš„ä»»åŠ¡åˆ—è¡¨
        Client->>Toast: toast.success("ä»»åŠ¡å·²å¼€å§‹")
    else å¤±è´¥ (4xx/5xx)
        API-->>Client: {error: "..."}
        Client->>Toast: toast.error("æ“ä½œå¤±è´¥")
        Client->>Btn: æ¢å¤æŒ‰é’®çŠ¶æ€
    end
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    action_button ç‚¹å‡»æ—¶åºå›¾                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·    ActionButton   api-client.ts   FastAPI      DB       Store    Zone B   Toast
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚â”€â”€ç‚¹å‡»â”€â”€â–¶ â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚  "ç«‹å³æ‰§è¡Œ"              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚â”€â”€action.type='start_task'  â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚â”€â”€handleAction(action)â”€â”€â”€â”€â”€â–¶â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚â”€â”€getCSRFToken()        â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚  (from cookie)         â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚â”€â”€POST /api/dashboard/task/acceptâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚        â”‚
   â”‚          â”‚              â”‚   + X-CSRF-Token       â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•
   â”‚          â”‚              â”‚  æˆåŠŸ (200) â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚â”€â”€UPDATE commitmentâ”€â–¶â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚â—€â”€{ok, commitment_id}â”€â”€â”€â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚â”€â”€taskStore.invalidate()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚â”€â”€re-fetchâ”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚â—€â”€GET /api/dashboard/tasksâ”€â”€â”‚
   â”‚          â”‚              â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€æ›´æ–°åˆ—è¡¨â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚â”€â”€toast.success("ä»»åŠ¡å·²å¼€å§‹")â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•
   â”‚          â”‚              â”‚  å¤±è´¥ (4xx) â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚â—€â”€{error}â”€â”€â”€â”€â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚â”€â”€toast.error("æ“ä½œå¤±è´¥")â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚          â”‚â—€â”€æ¢å¤æŒ‰é’®çŠ¶æ€â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
   â”‚          â”‚              â”‚             â”‚          â”‚          â”‚        â”‚        â”‚
```
</details>

### 2.3 action.type æ˜ å°„è¡¨

| action.type | è°ƒç”¨ç«¯ç‚¹ | æˆåŠŸè¡Œä¸º | å¤±è´¥è¡Œä¸º |
|-------------|----------|----------|----------|
| `start_task` | `POST /api/dashboard/task/accept` | invalidate tasks â†’ refetch â†’ toast âœ“ | toast.error + æ¢å¤æŒ‰é’® |
| `schedule_task` | `POST /api/dashboard/task/accept` | åŒä¸Š | åŒä¸Š |
| `open_panel` | æ—  API è°ƒç”¨ | `uiStore.setActiveTab(panel)` | N/A |
| `opt_out` | å‰ç«¯è®°å½• | æœ¬åœ°å­˜å‚¨ + å…³é—­æŒ‰é’® | N/A |
| `checkin` | å‰ç«¯äº‹ä»¶ | æ‰“å¼€æ‰“å¡ Modal | N/A |

### 2.4 å½“å‰å®ç°é—®é¢˜

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant Btn as ActionButton
    participant Client as lib/api.ts
    participant API as FastAPI

    User->>Btn: ç‚¹å‡»æŒ‰é’®
    Btn->>Client: POST request

    Note right of Client: âš ï¸ é—®é¢˜1: ç¼ºå°‘ X-CSRF-Token
    Client->>API: POST /api/dashboard/task/accept
    API-->>Client: 403 csrf_invalid

    Note right of Btn: âš ï¸ é—®é¢˜2: æ— é”™è¯¯å¤„ç†
    Note right of Btn: âš ï¸ é—®é¢˜3: Zone B ä¸åˆ·æ–°
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å½“å‰å®ç°é—®é¢˜ (å¾…ä¿®å¤)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·         ActionButton        lib/api.ts         FastAPI
   â”‚               â”‚                   â”‚                 â”‚
   â”‚â”€â”€ç‚¹å‡»æŒ‰é’®â”€â”€â”€â”€â–¶â”‚                   â”‚                 â”‚
   â”‚               â”‚                   â”‚                 â”‚
   â”‚               â”‚â”€â”€POST requestâ”€â”€â”€â”€â–¶â”‚                 â”‚
   â”‚               â”‚                   â”‚                 â”‚
   â”‚               â”‚                   â”‚  âš ï¸ é—®é¢˜1:      â”‚
   â”‚               â”‚                   â”‚  ç¼ºå°‘ X-CSRF-Token
   â”‚               â”‚                   â”‚                 â”‚
   â”‚               â”‚                   â”‚â”€â”€POST /api/dashboard/task/accept
   â”‚               â”‚                   â”‚   (æ—  CSRF Header)
   â”‚               â”‚                   â”‚                 â”‚
   â”‚               â”‚                   â”‚â—€â”€â”€â”€â”€403 csrf_invalid
   â”‚               â”‚                   â”‚                 â”‚
   â”‚               â”‚                   â”‚  âš ï¸ é—®é¢˜2:      â”‚
   â”‚               â”‚  âš ï¸ æ— é”™è¯¯å¤„ç†    â”‚  æ—  toast æç¤º  â”‚
   â”‚               â”‚                   â”‚                 â”‚
   â”‚               â”‚  âš ï¸ é—®é¢˜3:        â”‚                 â”‚
   â”‚               â”‚  Zone B ä¸åˆ·æ–°    â”‚                 â”‚
   â”‚               â”‚  (ä»»åŠ¡çŠ¶æ€ä¸æ›´æ–°) â”‚                 â”‚
   â”‚               â”‚                   â”‚                 â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ä¿®å¤æ–¹æ¡ˆ:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. lib/api.ts æ·»åŠ  csrfHeaders() ç»Ÿä¸€å¤„ç†                               â”‚
  â”‚ 2. æ‰€æœ‰ POST è¯·æ±‚é™„åŠ  X-CSRF-Token header                               â”‚
  â”‚ 3. blocks/index.tsx æˆåŠŸåè°ƒç”¨ invalidateQueries('tasks')              â”‚
  â”‚ 4. æ·»åŠ  toast æˆåŠŸ/å¤±è´¥æç¤º                                             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

**é—®é¢˜æ¸…å•**:
| é—®é¢˜ | ä½ç½® | å½±å“ | ä¿®å¤ä¼˜å…ˆçº§ |
|------|------|------|-----------|
| CSRF token æœªé™„åŠ  | `lib/api.ts` | æ‰€æœ‰ POST å¤±è´¥ | P0 |
| æ—  store é€šçŸ¥æœºåˆ¶ | å…¨å±€ | Zone B éœ€æ‰‹åŠ¨åˆ·æ–° | P1 |
| æ— é”™è¯¯ toast | `blocks/index.tsx` | ç”¨æˆ·æ— åé¦ˆ | P1 |

### 2.5 Zustand Store ç»“æ„ (å»ºè®®)

```
store/
â”œâ”€â”€ chat-store.ts      â† æ¶ˆæ¯/ä¼šè¯çŠ¶æ€
â”œâ”€â”€ task-store.ts      â† ä»»åŠ¡çŠ¶æ€ + invalidate()
â”œâ”€â”€ status-store.ts    â† PERMA/çŠ¶æ€æ•°æ®
â””â”€â”€ ui-store.ts        â† activeTab / modals
```

**å…³é”® API Client å®ç°**:

```typescript
// lib/api-client.ts
export const apiClient = {
  getCSRFToken(): string {
    return getCookie('fortune_csrf') || '';
  },

  async post<T>(url: string, data: unknown): Promise<T> {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': this.getCSRFToken(),  // â† å…³é”®
      },
      credentials: 'include',
      body: JSON.stringify(data),
    });
    if (!res.ok) throw new ApiError(res.status, await res.json());
    return res.json();
  }
};
```

### 2.6 Chat æµå¼äº¤äº’æµç¨‹ (v4.2 Vercel AI SDK)

> **ç›®æ ‡**: ä½¿ç”¨ `useChat()` Hook å®ç°ç±»ä¼¼ Claude Artifacts çš„æµå¼ Tool Calling ä½“éªŒ
> **åç«¯æ¶æ„**: å‚è§ [os_design_v3.md Â§1.5](./os_design_v3.md#15-agent-runtime--skills-vercel-ai-sdk-implementation---v42)

#### 2.6.1 Command Palette ç»„ä»¶è®¾è®¡

```mermaid
graph TB
    subgraph ZoneA["Zone A (Chat Panel)"]
        MessageList["MessageList"]

        subgraph InputArea["Input Area"]
            ChatInput["chat-input.tsx"]
            CmdTrigger["/ Trigger Detection"]
            CmdMenu["Command Palette (Popover)<br/>â€¢ /divine (ç„å­¦æµ‹ç®—)<br/>â€¢ /heal (å¿ƒç†ç–—æ„ˆ)<br/>â€¢ /grow (æˆé•¿æ•™ç»ƒ)<br/>â€¢ /status (çŠ¶æ€æŸ¥çœ‹)<br/>â€¢ /help (å¸®åŠ©)"]
        end
    end

    ChatInput -->|"è¾“å…¥ /"| CmdTrigger
    CmdTrigger -->|"æ˜¾ç¤ºèœå•"| CmdMenu
    CmdMenu -->|"é€‰æ‹©æŒ‡ä»¤"| ChatInput

    style CmdMenu fill:#e3f2fd,stroke:#1976d2
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Zone A (Chat Panel)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Message List                                              â”‚  â”‚
â”‚  â”‚  ...                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Input Area                                                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  [+] / è¾“å…¥æ¶ˆæ¯æˆ–æŒ‡ä»¤...                    [â¤]    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                      â†‘                                     â”‚  â”‚
â”‚  â”‚                      â”‚ è¾“å…¥ "/" è§¦å‘                       â”‚  â”‚
â”‚  â”‚                      â–¼                                     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚  Command Palette (æ‚¬æµ®èœå•)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ”® /divine  ç„å­¦æµ‹ç®— - å…«å­—/ç´«å¾®/æ˜Ÿåº§       â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ’š /heal    å¿ƒç†ç–—æ„ˆ - æƒ…ç»ªæ‰“å¡/CBTé‡æ„     â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸŒ± /grow    æˆé•¿æ•™ç»ƒ - ç›®æ ‡/ä»»åŠ¡/å¤ç›˜       â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ ğŸ“Š /status  çŠ¶æ€æŸ¥çœ‹ - å½“å‰çŠ¶æ€/è¶‹åŠ¿        â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â”‚ â“ /help    å¸®åŠ©åˆ—è¡¨ - æ‰€æœ‰å¯ç”¨æŒ‡ä»¤         â”‚    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

#### 2.6.2 Command äº¤äº’æ—¶åºå›¾

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯ (CommandPalette)
    participant API as FastAPI
    participant Router as Command Router
    participant Agent as L2 Agent

    U->>FE: è¾“å…¥ "/"
    FE->>FE: å¼¹å‡º Command Menu<br/>(åˆ—å‡ºå¯ç”¨ Skills)
    U->>FE: é€‰æ‹© "/divine" (ç„å­¦æµ‹ç®—)
    FE->>U: æç¤ºè¾“å…¥: "/divine [type]"
    U->>FE: è¡¥å…¨å¹¶å‘é€: "/divine type=bazi"

    FE->>API: POST /api/chat/command<br/>{cmd: "divine", args: {type: "bazi"}}

    API->>Router: è§£æ Command
    Note over Router: å¼ºåˆ¶è·¯ç”±æ¨¡å¼ (Bypass Intent)

    Router->>Agent: Invoke Metaphysics Agent<br/>With Skill: "calculate_bazi"

    Agent->>Agent: æ‰§è¡Œ Skill (è¯»å– L1)
    Agent-->>API: è¿”å›ç»“æœ (JSON + Analysis)

    API-->>FE: A2UI å“åº”<br/>(åŒ…å«ç‰¹å®šçš„ Widget ç»„ä»¶)
    FE->>FE: æ¸²æŸ“ç»“æœå¡ç‰‡
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Slash Command äº¤äº’æ—¶åº                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·        å‰ç«¯ (CommandPalette)       FastAPI       Command Router     L2 Agent
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚â”€â”€[1]è¾“å…¥ "/"â”€â”€â–¶â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚â”€â”€å¼¹å‡º Command Menu    â”‚                â”‚               â”‚
   â”‚                â”‚  (åˆ—å‡ºå¯ç”¨ Skills)    â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚â”€â”€[2]é€‰æ‹© /divineâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚â—€â”€â”€æç¤º: "/divine [type]"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚â”€â”€[3]å‘é€: "/divine type=bazi"â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚â”€â”€POST /api/chat/commandâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚
   â”‚                â”‚   {cmd: "divine", args: {type: "bazi"}}                â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚â”€â”€è§£æ Commandâ”€â–¶â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚   å¼ºåˆ¶è·¯ç”±æ¨¡å¼ (Bypass Intent) â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚â”€â”€Invoke Agentâ”€â–¶â”‚
   â”‚                â”‚                       â”‚                â”‚  Skill: calculate_bazi
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚â—€â”€â”€æ‰§è¡Œç»“æœâ”€â”€â”€â”€â”‚
   â”‚                â”‚                       â”‚â—€â”€â”€è¿”å› A2UIâ”€â”€â”€â”€â”‚               â”‚
   â”‚                â”‚â—€â”€â”€A2UI å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚â”€â”€æ¸²æŸ“ç»“æœå¡ç‰‡â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚               â”‚
   â”‚â—€â”€â”€æ˜¾ç¤ºç»“æœâ”€â”€â”€â”€â”‚                       â”‚                â”‚               â”‚
   â”‚                â”‚                       â”‚                â”‚               â”‚
```
</details>

#### 2.6.3 Command ç±»å‹æ˜ å°„è¡¨

| æŒ‡ä»¤ | API ç«¯ç‚¹ | ç›®æ ‡ Agent | è°ƒç”¨ Skill | æˆåŠŸå“åº” |
|------|----------|------------|------------|----------|
| `/divine` | `POST /api/chat/command` | Metaphysics | `calculate_bazi` | å…«å­—å¡ç‰‡ + è¿åŠ¿åˆ†æ |
| `/divine type=ziwei` | åŒä¸Š | Metaphysics | `calculate_ziwei` | ç´«å¾®å‘½ç›˜ |
| `/heal` | åŒä¸Š | Psychology | `mood_checkin` | æƒ…ç»ªæ‰“å¡ Modal |
| `/heal mode=reframe` | åŒä¸Š | Psychology | `cbt_reframe` | CBT è®¤çŸ¥é‡æ„å¼•å¯¼ |
| `/grow` | åŒä¸Š | Growth | `goal_setting` | ç›®æ ‡è®¾å®šå‘å¯¼ |
| `/grow action=review` | åŒä¸Š | Growth | `weekly_review` | å‘¨å¤ç›˜å¼•å¯¼ |
| `/status` | `GET /api/dashboard/status` | - | - | çŠ¶æ€å¡ç‰‡åˆ·æ–° |
| `/help` | å‰ç«¯æœ¬åœ°å¤„ç† | - | - | æ˜¾ç¤ºæŒ‡ä»¤å¸®åŠ© |

#### 2.6.4 å‰ç«¯å®ç°å…³é”®ä»£ç  (v4.2 Vercel AI SDK)

**Chat ç»„ä»¶ - useChat Hook é›†æˆ**:

```typescript
// components/chat/chat-panel.tsx
'use client';
import { useChat } from 'ai/react';
import { useState, useCallback } from 'react';
import { MessageList } from './message-list';
import { ChatInput } from './chat-input';
import { CommandPalette, COMMANDS, type CommandOption } from './command-palette';

interface ChatPanelProps {
  userId: string;
}

export function ChatPanel({ userId }: ChatPanelProps) {
  const [command, setCommand] = useState<string | null>(null);
  const [showCommandPalette, setShowCommandPalette] = useState(false);
  const [commandFilter, setCommandFilter] = useState('');

  // Vercel AI SDK useChat Hook
  const {
    messages,
    input,
    setInput,
    handleSubmit,
    handleInputChange: baseHandleInputChange,
    isLoading,
    error,
  } = useChat({
    api: '/api/chat',
    body: { userId, command },  // ä¼ é€’ command æ¨¡å¼
    onFinish: (message) => {
      setCommand(null);  // é‡ç½® command çŠ¶æ€
      // æ£€æŸ¥ Tool è°ƒç”¨ç»“æœï¼Œè§¦å‘ Dashboard åˆ·æ–°
      if (message.toolInvocations?.length) {
        refreshDashboard(message.toolInvocations);
      }
    },
    onError: (err) => {
      toast.error(`å‘é€å¤±è´¥: ${err.message}`);
    },
  });

  // æ‰©å±• handleInputChange ä»¥æ”¯æŒ Command Palette
  const handleInputChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    baseHandleInputChange(e);

    if (value.startsWith('/')) {
      setShowCommandPalette(true);
      setCommandFilter(value.slice(1));
    } else {
      setShowCommandPalette(false);
    }
  }, [baseHandleInputChange]);

  const handleCommandSelect = useCallback((cmd: CommandOption) => {
    setCommand(`/${cmd.command}`);
    setInput('');  // æ¸…ç©ºè¾“å…¥ï¼Œå‡†å¤‡æ¥æ”¶åç»­å‚æ•°
    setShowCommandPalette(false);
  }, [setInput]);

  return (
    <div className="chat-panel flex flex-col h-full">
      {/* æ¶ˆæ¯åˆ—è¡¨ - è‡ªåŠ¨æ»šåŠ¨ */}
      <MessageList messages={messages} isLoading={isLoading} />

      {/* Command Palette æ‚¬æµ®èœå• */}
      <CommandPalette
        isOpen={showCommandPalette}
        filter={commandFilter}
        onSelect={handleCommandSelect}
        onClose={() => setShowCommandPalette(false)}
      />

      {/* è¾“å…¥åŒºåŸŸ */}
      <ChatInput
        input={input}
        command={command}
        isLoading={isLoading}
        onChange={handleInputChange}
        onSubmit={handleSubmit}
        onClearCommand={() => setCommand(null)}
      />

      {/* é”™è¯¯æç¤º */}
      {error && <div className="error-toast">{error.message}</div>}
    </div>
  );
}
```

**æ¶ˆæ¯åˆ—è¡¨ - Tool Invocations æ¸²æŸ“**:

```typescript
// components/chat/message-list.tsx
import type { Message } from 'ai/react';
import { MessageItem } from './message-item';
import { ToolResultCard } from './tool-result-card';

interface MessageListProps {
  messages: Message[];
  isLoading: boolean;
}

export function MessageList({ messages, isLoading }: MessageListProps) {
  return (
    <div className="message-list flex-1 overflow-y-auto p-4 space-y-4">
      {messages.map((message) => (
        <div key={message.id} className={`message ${message.role}`}>
          {/* æ–‡æœ¬å†…å®¹ */}
          <MessageItem content={message.content} role={message.role} />

          {/* Tool Invocations (A2UI æ¸²æŸ“) */}
          {message.toolInvocations?.map((tool) => (
            <ToolResultCard key={tool.toolCallId} tool={tool} />
          ))}
        </div>
      ))}

      {/* åŠ è½½æŒ‡ç¤ºå™¨ */}
      {isLoading && (
        <div className="typing-indicator">
          <span className="dot" /><span className="dot" /><span className="dot" />
        </div>
      )}
    </div>
  );
}
```

**Tool Result å¡ç‰‡æ¸²æŸ“å™¨**:

```typescript
// components/chat/tool-result-card.tsx
import type { ToolInvocation } from 'ai';
import { BaziCard } from '@/components/cards/bazi-card';
import { PermaCard } from '@/components/cards/perma-card';
import { TaskCard } from '@/components/cards/task-card';

interface ToolResultCardProps {
  tool: ToolInvocation;
}

export function ToolResultCard({ tool }: ToolResultCardProps) {
  // ç­‰å¾… Tool æ‰§è¡Œå®Œæˆ
  if (tool.state !== 'result') {
    return (
      <div className="tool-loading">
        æ­£åœ¨æ‰§è¡Œ {tool.toolName}...
      </div>
    );
  }

  const result = tool.result;

  // æ ¹æ® Tool åç§°é€‰æ‹©æ¸²æŸ“ç»„ä»¶
  switch (tool.toolName) {
    case 'calculate_bazi':
      return <BaziCard data={result} />;
    case 'log_perma':
      return <PermaCard data={result} />;
    case 'covey_matrix':
    case 'goal_setting':
      return <TaskCard data={result} />;
    case 'mood_checkin':
      return <CheckinCard data={result} />;
    default:
      // é»˜è®¤ JSON æ¸²æŸ“
      return (
        <pre className="tool-result-json">
          {JSON.stringify(result, null, 2)}
        </pre>
      );
  }
}
```

**Command Palette ç»„ä»¶**:

```typescript
// components/chat/command-palette.tsx
import { Popover, PopoverContent } from '@/components/ui/popover';

export interface CommandOption {
  command: string;
  label: string;
  description: string;
  icon: string;
}

export const COMMANDS: CommandOption[] = [
  { command: 'divine', label: 'ç„å­¦æµ‹ç®—', description: 'å…«å­—/ç´«å¾®/æ˜Ÿåº§å‘½ç†åˆ†æ', icon: 'ğŸ”®' },
  { command: 'heal', label: 'å¿ƒç†ç–—æ„ˆ', description: 'æƒ…ç»ªæ‰“å¡/CBTè®¤çŸ¥é‡æ„', icon: 'ğŸ’š' },
  { command: 'grow', label: 'æˆé•¿æ•™ç»ƒ', description: 'ç›®æ ‡è®¾å®š/ä»»åŠ¡ç®¡ç†/å¤ç›˜', icon: 'ğŸŒ±' },
  { command: 'status', label: 'çŠ¶æ€æŸ¥çœ‹', description: 'æŸ¥çœ‹å½“å‰çŠ¶æ€ä¸è¶‹åŠ¿', icon: 'ğŸ“Š' },
  { command: 'help', label: 'å¸®åŠ©', description: 'æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æŒ‡ä»¤', icon: 'â“' },
];

interface CommandPaletteProps {
  isOpen: boolean;
  filter: string;
  onSelect: (cmd: CommandOption) => void;
  onClose: () => void;
}

export function CommandPalette({ isOpen, filter, onSelect, onClose }: CommandPaletteProps) {
  const filtered = COMMANDS.filter(cmd =>
    cmd.command.includes(filter) || cmd.label.includes(filter)
  );

  return (
    <Popover open={isOpen} onOpenChange={onClose}>
      <PopoverContent className="command-palette w-80 p-2" align="start">
        {filtered.map(cmd => (
          <button
            key={cmd.command}
            onClick={() => onSelect(cmd)}
            className="command-item w-full flex items-center gap-3 p-2 rounded hover:bg-muted"
          >
            <span className="text-xl">{cmd.icon}</span>
            <div className="flex-1 text-left">
              <div className="font-medium">/{cmd.command}</div>
              <div className="text-sm text-muted-foreground">{cmd.description}</div>
            </div>
          </button>
        ))}
      </PopoverContent>
    </Popover>
  );
}
```

#### 2.6.5 å®ç°çŠ¶æ€ (v4.2)

| ç»„ä»¶ | è®¾è®¡ | TypeScript | è¯´æ˜ |
|------|:----:|:----------:|------|
| `useChat()` Hook é›†æˆ | âœ… | âš ï¸ | éœ€å¼•å…¥ `ai/react` |
| `app/api/chat/route.ts` | âœ… | âš ï¸ | Agent Runtime API Route |
| `ToolResultCard` æ¸²æŸ“å™¨ | âœ… | âš ï¸ | æ ¹æ® toolName é€‰æ‹©å¡ç‰‡ |
| `CommandPalette` ç»„ä»¶ | âœ… | âš ï¸ | å¾…å®ç°æ‚¬æµ®èœå• |
| `BaziCard` / `PermaCard` | âœ… | âš ï¸ | Tool Result ä¸“å±å¡ç‰‡ |
| `refreshDashboard()` | âœ… | âš ï¸ | Tool å®Œæˆåè§¦å‘ Tab åˆ·æ–° |

---

## 3. ç»„ä»¶å®ç°çŠ¶æ€

### 3.1 Zone A ç»„ä»¶

| ç»„ä»¶ | è®¾è®¡ | å®ç° | å·®è· |
|------|------|------|------|
| `ChatPanel` | âœ… | âœ… | æ—  |
| `MessageList` | âœ… è™šæ‹Ÿæ»šåŠ¨ | âš ï¸ æ™®é€šæ»šåŠ¨ | éœ€ä¼˜åŒ– |
| `MessageItem` | âœ… A2UI æ¸²æŸ“ | âš ï¸ éƒ¨åˆ† | action_buttons |
| `ChatInput` | âœ… Omnibar + Command | âš ï¸ éƒ¨åˆ† | éœ€æ·»åŠ  / è§¦å‘æ£€æµ‹ |
| `CommandPalette` | âœ… v4.1 æ–°å¢ | âš ï¸ å¾…å®ç° | æ‚¬æµ®èœå•ç»„ä»¶ |
| `TypingIndicator` | âœ… | âœ… | æ—  |

### 3.2 Zone B ç»„ä»¶

| ç»„ä»¶ | è®¾è®¡ | å®ç° | å·®è· |
|------|------|------|------|
| `DashboardPanel` | âœ… | âœ… | æ—  |
| `TabNavigation` | âœ… | âœ… | æ—  |
| `OverviewTab` | âœ… | âœ… | æ—  |
| `StatusTab` | âœ… L0/L1 | âœ… | æ—  |
| `TrendsTab` | âœ… å›¾è¡¨ | âœ… | å¯å¢å¼º K çº¿ |
| `TasksTab` | âœ… CRUD | âš ï¸ | CSRF é—®é¢˜ |
| `RelationsTab` | âœ… å¥½å‹/åˆç›˜ | âœ… | æ—  |
| `ExploreTab` | âœ… æŠ¥å‘Š/è®¡åˆ’ | âœ… | æ—  |

### 3.3 é€šç”¨ç»„ä»¶

| ç»„ä»¶ | è®¾è®¡ | å®ç° | å·®è· |
|------|------|------|------|
| `Skeleton` | âœ… Shimmer | âš ï¸ åŸºç¡€ | éœ€å¢å¼º |
| `Toast` | âœ… åº•éƒ¨æç¤º | âœ… | æ—  |
| `Modal` | âœ… | âœ… | æ—  |
| `Card` | âœ… æ— è¾¹æ¡† | âœ… | æ—  |

---

## 4. æ ·å¼ Token å®ç°çŠ¶æ€

### 4.1 é¢œè‰²ç³»ç»Ÿ

| Token | è®¾è®¡å€¼ | å®ç°å€¼ | çŠ¶æ€ |
|-------|--------|--------|------|
| `--background` | `0 0% 100%` / `0 0% 10%` | âœ… | ä¸€è‡´ |
| `--foreground` | `42 8% 20%` / `0 0% 83%` | âœ… | ä¸€è‡´ |
| `--sidebar` | `40 9% 98%` / `0 0% 13%` | âœ… | ä¸€è‡´ |
| `--border` | `40 5% 91%` / `0 0% 22%` | âœ… | ä¸€è‡´ |
| `--mystic` | `292 47% 95%` | âš ï¸ | å¾…æ·»åŠ  |
| `--advice` | `207 89% 94%` | âš ï¸ | å¾…æ·»åŠ  |

### 4.2 å­—ä½“ç³»ç»Ÿ

| Token | è®¾è®¡å€¼ | å®ç°å€¼ | çŠ¶æ€ |
|-------|--------|--------|------|
| H1 | 30px / 1.2 / 600 | âœ… | ä¸€è‡´ |
| H2 | 24px / 1.3 / 600 | âœ… | ä¸€è‡´ |
| Body | 16px / 1.6 / 400 | âœ… | ä¸€è‡´ |
| Caption | 14px / 1.5 / 400 | âœ… | ä¸€è‡´ |

---

## 5. å¾…ä¼˜åŒ–é¡¹æ±‡æ€»

### 5.1 P0ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

```typescript
// é—®é¢˜1: CSRF Token æœªæ­£ç¡®ä¼ é€’
// ä½ç½®: web-app/src/lib/api.ts

// ä¿®å¤æ–¹æ¡ˆ:
export async function apiPost(url: string, data: any) {
  const csrfToken = getCookie('fortune_csrf');  // â† æ·»åŠ 
  
  const response = await fetch(url, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken || '',  // â† æ·»åŠ 
    },
    credentials: 'include',
    body: JSON.stringify(data),
  });
  
  return response.json();
}
```

```typescript
// é—®é¢˜2: action_buttons æœªæ¸²æŸ“ç‚¹å‡»å¤„ç†
// ä½ç½®: web-app/src/components/chat/message-item.tsx

// ä¿®å¤æ–¹æ¡ˆ:
function ActionButton({ action, label }: { action: Action; label: string }) {
  const handleClick = async () => {
    switch (action.type) {
      case 'start_task':
        await apiPost('/api/dashboard/task/accept', {
          task_id: action.task_id,
          commitment_type: 'start_task',
        });
        toast.success('ä»»åŠ¡å·²å¼€å§‹');
        // è§¦å‘ä»»åŠ¡åˆ—è¡¨åˆ·æ–°
        break;
        
      case 'open_panel':
        // åˆ‡æ¢åˆ°å¯¹åº” Tab
        setActiveTab(action.panel);
        break;
    }
  };
  
  return <Button onClick={handleClick}>{label}</Button>;
}
```

### 5.2 P1ï¼ˆåº”å°½å¿«å¤„ç†ï¼‰

- [ ] æ·»åŠ è™šæ‹Ÿæ»šåŠ¨ (`@tanstack/react-virtual`)
- [ ] å®Œå–„éª¨æ¶å±åŠ è½½çŠ¶æ€
- [ ] æ·»åŠ  Zustand çŠ¶æ€ç®¡ç†
- [ ] å®ç° Zone A â†” Zone B è‡ªåŠ¨è”åŠ¨

### 5.3 P2ï¼ˆåç»­ä¼˜åŒ–ï¼‰

- [ ] æ·»åŠ  Framer Motion åŠ¨æ•ˆ
- [ ] å®ç° K çº¿èœ¡çƒ›å›¾ç»„ä»¶
- [ ] æ·»åŠ  PWA æ”¯æŒ
- [ ] ä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ

---

## 6. æ€»ç»“

### 6.1 è®¾è®¡ vs å®ç°ä¸€è‡´æ€§

```
=== å‰ç«¯ç»„ä»¶ ===
æ•´ä½“å¸ƒå±€:      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%
ç»„ä»¶å®Œæˆåº¦:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%
æ ·å¼ä¸€è‡´æ€§:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%
äº¤äº’å®Œæ•´æ€§:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%

=== åç«¯æ¶æ„å±‚å¯¹æ¥ ===
Interaction Layer:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%  â† æ¨¡å‹åˆ‡æ¢ UI å¾…å®ç°
Context Management: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%  â† A2UI æ¸²æŸ“åŸºæœ¬å°±ç»ª
L2 Style Agents:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%  â† é£æ ¼åˆ‡æ¢å·²å®ç°
L1 Module Data:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%  â† Kçº¿ç»„ä»¶å¾…å®ç°
L0 Base Data:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% â† ç”¨æˆ·æ•°æ®å±•ç¤ºå®Œæ•´
```

### 6.2 å…³é”®å·®è·

| å·®è· | å½±å“ | ä¼˜å…ˆçº§ | å¯¹åº”æ¶æ„å±‚ |
|------|------|--------|------------|
| CSRF å¤„ç† | ä»»åŠ¡åŠŸèƒ½ä¸å¯ç”¨ | P0 | - |
| action_buttons | ç”¨æˆ·æ— æ³•ä¸€é”®è¡ŒåŠ¨ | P0 | Context Mgmt |
| è™šæ‹Ÿæ»šåŠ¨ | é•¿å¯¹è¯æ€§èƒ½é—®é¢˜ | P1 | - |
| çŠ¶æ€è”åŠ¨ | éœ€æ‰‹åŠ¨åˆ·æ–° | P1 | - |
| Kçº¿èœ¡çƒ›å›¾ | è¶‹åŠ¿å¯è§†åŒ–ä¸å®Œæ•´ | P1 | L1 Module Data |
| æ¨¡å‹åˆ‡æ¢ UI | ç”¨æˆ·æ— æ³•é€‰æ‹©æ¨¡å‹ | P2 | Interaction Layer |

### 6.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **P0**: ä¿®å¤ lib/api.ts çš„ CSRF å¤„ç†
2. **P0**: å®Œå–„ message-item.tsx çš„ action å¤„ç† (Context Mgmt å¯¹æ¥)
3. **P1**: å¼•å…¥ Zustand çŠ¶æ€ç®¡ç†
4. **P1**: æ·»åŠ è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–
5. **P1**: Kçº¿èœ¡çƒ›å›¾ç»„ä»¶ (L1 Module Data å¯è§†åŒ–)
6. **P2**: æ¨¡å‹/é£æ ¼åˆ‡æ¢ UI (Interaction Layer é…ç½®)

---

*æ–‡æ¡£ç‰ˆæœ¬: v4.2 (Vercel AI SDK Edition)*
*æ›´æ–°æ—¥æœŸ: 2026-01-01*
*æ ¸å¿ƒæŠ€æœ¯: Vercel AI SDK 6 + useChat() Hook + Tool Calling*
*æµ‹è¯•ç¯å¢ƒ: http://106.37.170.238:8231/new*
