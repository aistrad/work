"use client"

import { useState, useRef, useCallback, useEffect } from "react"
import { cn } from "@/lib/utils"
import { Plus, Send, Mic, Image as ImageIcon, FileText, Sparkles } from "lucide-react"

interface OmnibarProps {
  onSend: (message: string) => void
  onCommand?: (command: string) => void
  isStreaming?: boolean
  className?: string
}

const SLASH_COMMANDS = [
  { command: "/status", label: "查询当前状态", icon: Sparkles },
  { command: "/tarot", label: "塔罗牌占卜", icon: Sparkles },
  { command: "/learn", label: "推荐今日课程", icon: FileText },
  { command: "/reset", label: "重置上下文", icon: Sparkles },
]

export function Omnibar({ onSend, onCommand, isStreaming, className }: OmnibarProps) {
  const [value, setValue] = useState("")
  const [showCommands, setShowCommands] = useState(false)
  const [showMultiModal, setShowMultiModal] = useState(false)
  const textareaRef = useRef<HTMLTextAreaElement>(null)
  const minHeight = 32

  // 自动调整高度 - 仅在有内容时调整
  const adjustHeight = useCallback(() => {
    const textarea = textareaRef.current
    if (!textarea) return

    const maxHeight = Math.min(220, Math.floor(window.innerHeight * 0.24)) // 上限更紧凑

    if (value) {
      textarea.style.height = "auto"
      const nextHeight = Math.max(minHeight, Math.min(textarea.scrollHeight, maxHeight))
      textarea.style.height = `${nextHeight}px`
      textarea.style.overflowY = textarea.scrollHeight > maxHeight ? "auto" : "hidden"
    } else {
      textarea.style.height = `${minHeight}px`
      textarea.style.overflowY = "hidden"
    }
  }, [value, minHeight])

  useEffect(() => {
    adjustHeight()
  }, [value, adjustHeight])

  // 处理输入
  const handleChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
    const newValue = e.target.value
    setValue(newValue)

    // 检测 slash command
    if (newValue.startsWith("/")) {
      setShowCommands(true)
    } else {
      setShowCommands(false)
    }
  }

  // 处理发送
  const handleSend = () => {
    if (!value.trim() || isStreaming) return

    if (value.startsWith("/") && onCommand) {
      onCommand(value)
    } else {
      onSend(value)
    }

    setValue("")
    setShowCommands(false)
  }

  // 处理快捷键
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }

  // 选择命令
  const selectCommand = (command: string) => {
    setValue(command + " ")
    setShowCommands(false)
    textareaRef.current?.focus()
  }

  const filteredCommands = SLASH_COMMANDS.filter((cmd) =>
    cmd.command.startsWith(value.toLowerCase())
  )

  return (
    <div className={cn("relative px-4 pb-3", className)}>
      {/* Slash Commands Menu */}
      {showCommands && filteredCommands.length > 0 && (
        <div
          className={cn(
            "absolute bottom-full left-4 right-4 mb-2",
            "bg-background border border-border rounded-lg shadow-float",
            "overflow-hidden"
          )}
        >
          {filteredCommands.map((cmd) => (
            <button
              key={cmd.command}
              onClick={() => selectCommand(cmd.command)}
              className={cn(
                "w-full flex items-center gap-3 px-4 py-3",
                "text-left hover:bg-hover transition-colors"
              )}
            >
              <cmd.icon className="w-4 h-4 text-muted-foreground" />
              <div>
                <div className="text-sm font-medium">{cmd.command}</div>
                <div className="text-xs text-muted-foreground">{cmd.label}</div>
              </div>
            </button>
          ))}
        </div>
      )}

      {/* Multi-Modal Menu */}
      {showMultiModal && (
        <div
          className={cn(
            "absolute bottom-full left-4 mb-2",
            "bg-background border border-border rounded-lg shadow-float",
            "overflow-hidden"
          )}
        >
          <button className="w-full flex items-center gap-3 px-4 py-3 hover:bg-hover transition-colors">
            <ImageIcon className="w-4 h-4 text-muted-foreground" />
            <span className="text-sm">上传图片</span>
          </button>
          <button className="w-full flex items-center gap-3 px-4 py-3 hover:bg-hover transition-colors">
            <Mic className="w-4 h-4 text-muted-foreground" />
            <span className="text-sm">语音输入</span>
          </button>
          <button className="w-full flex items-center gap-3 px-4 py-3 hover:bg-hover transition-colors">
            <FileText className="w-4 h-4 text-muted-foreground" />
            <span className="text-sm">文件分析</span>
          </button>
        </div>
      )}

      {/* Omnibar 主体 */}
      <div
        className={cn(
          "flex items-end gap-2",
          "bg-background border border-border rounded-xl",
          "shadow-float",
          "p-2",
          "transition-shadow focus-within:shadow-[0_0_0_2px_hsl(var(--foreground)/0.1)]"
        )}
      >
        {/* 多模态按钮 */}
        <button
          type="button"
          onClick={() => setShowMultiModal(!showMultiModal)}
          className={cn(
            "flex-shrink-0 h-11 w-11 inline-flex items-center justify-center rounded-lg",
            "text-muted-foreground hover:text-foreground hover:bg-hover",
            "transition-colors",
            "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-foreground/20",
            "focus-visible:ring-offset-2 focus-visible:ring-offset-background"
          )}
          aria-label="打开多模态菜单"
        >
          <Plus className="w-5 h-5" />
        </button>

        {/* 输入区 */}
        <textarea
          ref={textareaRef}
          value={value}
          onChange={handleChange}
          onKeyDown={handleKeyDown}
          onFocus={() => setShowMultiModal(false)}
          placeholder="输入消息，或输入 / 使用命令..."
          rows={1}
          className={cn(
            "flex-1 resize-none bg-transparent",
            "text-foreground placeholder:text-muted-foreground",
            "focus:outline-none",
            "py-1 px-1 leading-6",
            "min-h-[32px] max-h-[220px]"
          )}
        />

        {/* 发送按钮 */}
        <button
          type="button"
          onClick={handleSend}
          disabled={!value.trim() || isStreaming}
          className={cn(
            "flex-shrink-0 h-11 w-11 inline-flex items-center justify-center rounded-lg",
            "transition-all duration-150",
            "focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-foreground/20",
            "focus-visible:ring-offset-2 focus-visible:ring-offset-background",
            value.trim() && !isStreaming
              ? "bg-foreground text-background hover:opacity-90"
              : "text-muted-foreground cursor-not-allowed"
          )}
          aria-label="发送消息"
        >
          <Send className="w-5 h-5" />
        </button>
      </div>
    </div>
  )
}
