#!/usr/bin/env python
"""
Core Agent + Core Skill ç«¯åˆ°ç«¯æµ‹è¯•
çœŸå®è¿æ¥æ•°æ®åº“ï¼Œæµ‹è¯•å®Œæ•´å¯¹è¯æµç¨‹

ç”¨æ³•:
    cd apps/api
    python scripts/test_core_agent.py
"""
import asyncio
import json
import os
import sys
from datetime import datetime
from uuid import UUID, uuid4

# åŠ è½½æµ‹è¯•ç¯å¢ƒ
os.environ.setdefault("VIBELIFE_ENV", "test")

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from pathlib import Path
from dotenv import load_dotenv

# åŠ è½½é¡¹ç›®æ ¹ç›®å½•çš„ .env.test
_project_root = Path(__file__).resolve().parents[3]  # scripts -> api -> apps -> project root
load_dotenv(_project_root / ".env.test")


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•åœºæ™¯
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TEST_SCENARIOS = [
    {
        "name": "åœºæ™¯1: æ—¥å¸¸é—®å€™ (Core Skill æƒ…æ„Ÿæ”¯æŒ)",
        "message": "ä½ å¥½ï¼Œæœ€è¿‘æˆ‘æœ‰ç‚¹è¿·èŒ«ï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆåŠ",
        "skill": "core",  # æ˜ç¡®æŒ‡å®š Core Skill
        "expected_behavior": "Core Skill æä¾›æƒ…æ„Ÿæ”¯æŒå’Œå€¾å¬"
    },
    {
        "name": "åœºæ™¯2: ç›®æ ‡è®¾å®š (Core Skill ç›®æ ‡è¿½è¸ª)",
        "message": "æˆ‘æƒ³è®¾å®šä¸€ä¸ªå¹´åº¦ç›®æ ‡ï¼šä»Šå¹´å­¦ä¼šæ¸¸æ³³ï¼Œä½ å¸®æˆ‘è®°å½•ä¸€ä¸‹",
        "skill": "core",  # æ˜ç¡®æŒ‡å®š Core Skill
        "expected_behavior": "è§¦å‘ç›®æ ‡è¿½è¸ªåœºæ™¯ï¼Œä½¿ç”¨ write_user_data å·¥å…·"
    },
    {
        "name": "åœºæ™¯3: ç›®æ ‡æŸ¥è¯¢ (Core Skill æ•°æ®è¯»å–)",
        "message": "çœ‹çœ‹æˆ‘è®¾å®šçš„ç›®æ ‡æœ‰å“ªäº›",
        "skill": "core",
        "expected_behavior": "è°ƒç”¨ query_user_data å·¥å…·æŸ¥è¯¢ç”¨æˆ·ç›®æ ‡"
    },
    {
        "name": "åœºæ™¯4: è®¾ç½®æé†’ (Core Skill Trigger)",
        "message": "å¸®æˆ‘è®¾ç½®ä¸€ä¸ªæ¯å¤©æ—©ä¸Š8ç‚¹çš„æ‰“å¡æé†’",
        "skill": "core",
        "expected_behavior": "è°ƒç”¨ create_trigger å·¥å…·åˆ›å»ºæé†’"
    },
    {
        "name": "åœºæ™¯5: Skill è·¯ç”±æµ‹è¯•",
        "message": "å¸®æˆ‘ç®—ä¸€ä¸‹å…«å­—çœ‹çœ‹äº‹ä¸šè¿",
        "skill": None,  # ä¸æŒ‡å®š skillï¼Œæµ‹è¯•è·¯ç”±
        "expected_behavior": "è°ƒç”¨ use_skill å·¥å…·æ¿€æ´» bazi skill"
    }
]


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•ç”¨æˆ·æ•°æ®
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TEST_USER = {
    "user_id": "test-user-core-001",
    "user_tier": "paid",
    "profile": {
        "display_name": "å°æ˜",
        "gender": "male",
        "birth_info": {
            "datetime": "1995-06-15T10:30:00",
            "location": "åŒ—äº¬",
            "timezone": "Asia/Shanghai"
        },
        "extracted": {
            "personality_traits": ["å†…å‘", "æ€è€ƒå‹", "è¿½æ±‚å®Œç¾"],
            "life_challenges": ["èŒä¸šæ–¹å‘ä¸æ¸…æ™°", "äººé™…å…³ç³»å‹åŠ›"],
            "values": ["æˆé•¿", "ç¨³å®š", "è‡ªç”±"]
        }
    },
    "skill_data": {
        "bazi": {
            "calculated": True,
            "pillars": {
                "year": {"heavenly_stem": "ä¹™", "earthly_branch": "äº¥"},
                "month": {"heavenly_stem": "å£¬", "earthly_branch": "åˆ"},
                "day": {"heavenly_stem": "ä¸™", "earthly_branch": "ç”³"},
                "hour": {"heavenly_stem": "ç™¸", "earthly_branch": "å·³"}
            },
            "day_master": "ä¸™ç«",
            "five_elements": {"é‡‘": 2, "æœ¨": 1, "æ°´": 3, "ç«": 2, "åœŸ": 0}
        }
    },
    "portrait": "ä¸€ä¸ª1995å¹´å‡ºç”Ÿçš„90åï¼Œæ€§æ ¼å†…æ•›ä½†æœ‰è¿½æ±‚ï¼Œç›®å‰åœ¨èŒä¸šå‘å±•ä¸Šé¢ä¸´é€‰æ‹©ã€‚"
}


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# æµ‹è¯•æ‰§è¡Œå™¨
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async def test_single_scenario(scenario: dict, user_data: dict):
    """æµ‹è¯•å•ä¸ªåœºæ™¯"""
    from services.agent import CoreAgent, AgentContext, create_agent

    print(f"\n{'='*70}")
    print(f"ğŸ“ {scenario['name']}")
    print(f"{'='*70}")

    # æ„å»ºä¸Šä¸‹æ–‡
    context = AgentContext(
        user_id=user_data["user_id"],
        user_tier=user_data["user_tier"],
        profile=user_data["profile"],
        skill_data=user_data["skill_data"],
        history=[],
        skill=scenario.get("skill"),
        voice_mode="warm",
        portrait=user_data.get("portrait")
    )

    print(f"\nğŸ”¹ ç”¨æˆ·è¾“å…¥: {scenario['message']}")
    print(f"ğŸ”¹ æœŸæœ›è¡Œä¸º: {scenario['expected_behavior']}")
    print(f"\n{'â”€'*70}")

    # åˆ›å»º Agent
    agent = create_agent(max_iterations=5)

    # æ”¶é›†äº‹ä»¶
    events = []
    tool_calls = []
    content_parts = []

    print("\nğŸ“¤ Agent è¾“å‡º:")
    print()

    try:
        async for event in agent.run(scenario["message"], context):
            events.append(event)

            if event.type == "thinking":
                print(f"  ğŸ’­ æ€è€ƒä¸­ (è¿­ä»£ {event.data.get('iteration', 0) + 1})...")

            elif event.type == "sop_phase":
                data = event.data
                print(f"  ğŸ“‹ SOP: skill={data.get('skill')}, scenario={data.get('scenario')}, action={data.get('action')}")

            elif event.type == "tool_call":
                data = event.data
                tool_calls.append(data)
                print(f"  ğŸ”§ è°ƒç”¨å·¥å…·: {data['name']}")
                args = data.get('arguments', '{}')
                if isinstance(args, str):
                    try:
                        args = json.loads(args)
                    except:
                        pass
                print(f"     å‚æ•°: {json.dumps(args, ensure_ascii=False, indent=6)[:200]}")

            elif event.type == "tool_result":
                data = event.data
                result = data.get('result', {})
                status = result.get('status', 'unknown') if isinstance(result, dict) else 'ok'
                print(f"  âœ… å·¥å…·ç»“æœ: status={status}")

            elif event.type == "content":
                content = event.data.get("content", "")
                content_parts.append(content)
                # å®æ—¶æ‰“å°å†…å®¹
                print(content, end="", flush=True)

            elif event.type == "done":
                if not content_parts:
                    # å¦‚æœæ²¡æœ‰æµå¼å†…å®¹ï¼Œæ‰“å°æœ€ç»ˆå†…å®¹
                    final = event.data.get("content", "")
                    if final:
                        print(final)

            elif event.type == "error":
                print(f"\n  âŒ é”™è¯¯: {event.data.get('error')}")

    except Exception as e:
        print(f"\nâŒ æ‰§è¡Œå¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()

    print(f"\n\n{'â”€'*70}")
    print("ğŸ“Š æ‰§è¡Œç»Ÿè®¡:")
    print(f"  â€¢ äº‹ä»¶æ€»æ•°: {len(events)}")
    print(f"  â€¢ å·¥å…·è°ƒç”¨: {len(tool_calls)}")
    if tool_calls:
        print(f"  â€¢ å·¥å…·åˆ—è¡¨: {', '.join([tc['name'] for tc in tool_calls])}")
    print(f"  â€¢ Token ä½¿ç”¨: {agent.usage}")

    return {
        "scenario": scenario["name"],
        "events": len(events),
        "tool_calls": tool_calls,
        "content": "".join(content_parts),
        "usage": agent.usage
    }


async def run_all_tests():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\n" + "â•"*70)
    print("ğŸš€ Core Agent + Core Skill ç«¯åˆ°ç«¯æµ‹è¯•")
    print("â•"*70)
    print(f"ğŸ“… æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ”§ ç¯å¢ƒ: {os.environ.get('VIBELIFE_ENV', 'unknown')}")
    print(f"ğŸ“¦ æ•°æ®åº“: {os.environ.get('VIBELIFE_DB_HOST', 'unknown')}:{os.environ.get('VIBELIFE_DB_PORT', 'unknown')}")

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    print("\nğŸ”Œ æµ‹è¯•æ•°æ®åº“è¿æ¥...")
    try:
        from stores.db import get_connection
        async with get_connection() as conn:
            result = await conn.fetchval("SELECT 1")
            print(f"  âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
    except Exception as e:
        print(f"  âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return

    # è¿è¡Œæµ‹è¯•åœºæ™¯
    results = []
    for i, scenario in enumerate(TEST_SCENARIOS, 1):
        try:
            result = await test_single_scenario(scenario, TEST_USER)
            results.append(result)
        except Exception as e:
            print(f"\nâŒ åœºæ™¯ {i} å¤±è´¥: {e}")
            import traceback
            traceback.print_exc()

    # æ±‡æ€»æŠ¥å‘Š
    print("\n\n" + "â•"*70)
    print("ğŸ“ˆ æµ‹è¯•æ±‡æ€»æŠ¥å‘Š")
    print("â•"*70)

    total_tokens = {"prompt_tokens": 0, "completion_tokens": 0}
    for r in results:
        usage = r.get("usage", {})
        total_tokens["prompt_tokens"] += usage.get("prompt_tokens", 0)
        total_tokens["completion_tokens"] += usage.get("completion_tokens", 0)

        tool_names = [tc["name"] for tc in r.get("tool_calls", [])]
        print(f"\n{r['scenario']}")
        print(f"  å·¥å…·: {tool_names if tool_names else 'æ— '}")
        print(f"  Tokens: {usage}")

    print(f"\n{'â”€'*70}")
    print(f"æ€»è®¡ Token æ¶ˆè€—: {total_tokens}")
    print("â•"*70)


if __name__ == "__main__":
    asyncio.run(run_all_tests())
