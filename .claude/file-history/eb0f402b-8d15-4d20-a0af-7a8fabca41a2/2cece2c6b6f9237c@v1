#!/bin/bash
# ═══════════════════════════════════════════════════════════════
# Let's Encrypt SSL 证书申请脚本
# ═══════════════════════════════════════════════════════════════

set -e

# 从环境变量读取配置，提供默认值
DOMAIN="${SSL_DOMAIN:-api.vibelife.app}"
EMAIL="${SSL_EMAIL:-admin@vibelife.app}"
NGINX_SSL_DIR="${NGINX_SSL_DIR:-./nginx/ssl}"

echo "🔐 申请 SSL 证书: $DOMAIN"

# ─────────────────────────────────────────────────────────────────
# 1. 安装 certbot (如果未安装)
# ─────────────────────────────────────────────────────────────────
if ! command -v certbot &> /dev/null; then
    echo "📦 安装 certbot..."
    sudo apt-get update
    sudo apt-get install -y certbot
fi

# ─────────────────────────────────────────────────────────────────
# 2. 申请证书 (standalone 模式)
# ─────────────────────────────────────────────────────────────────
# 注意: 需要先停止占用 80 端口的服务
echo "⏸️  停止 Nginx..."
docker-compose stop nginx 2>/dev/null || true

echo "📜 申请证书..."
sudo certbot certonly \
    --standalone \
    --non-interactive \
    --agree-tos \
    --email $EMAIL \
    -d $DOMAIN

# ─────────────────────────────────────────────────────────────────
# 3. 复制证书到 Nginx 目录
# ─────────────────────────────────────────────────────────────────
echo "📋 复制证书..."
mkdir -p $NGINX_SSL_DIR
sudo cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem $NGINX_SSL_DIR/
sudo cp /etc/letsencrypt/live/$DOMAIN/privkey.pem $NGINX_SSL_DIR/
sudo chown -R $USER:$USER $NGINX_SSL_DIR

# ─────────────────────────────────────────────────────────────────
# 4. 重启 Nginx
# ─────────────────────────────────────────────────────────────────
echo "▶️  启动 Nginx..."
docker-compose up -d nginx

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo "✅ SSL 证书配置完成!"
echo ""
echo "证书路径: $NGINX_SSL_DIR"
echo "有效期: 90 天"
echo ""
echo "自动续期命令 (添加到 crontab):"
echo "0 0 1 * * certbot renew --quiet && cp /etc/letsencrypt/live/$DOMAIN/*.pem $NGINX_SSL_DIR/ && docker-compose restart nginx"
echo "═══════════════════════════════════════════════════════════════"
