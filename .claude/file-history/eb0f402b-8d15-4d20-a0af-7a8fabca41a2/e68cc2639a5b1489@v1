#!/usr/bin/env python3
"""
Skill Distill CLI - 从知识库提炼 Skill 的命令行工具

用法:
    python -m services.skill_distill.cli distill bazi --knowledge-dir /path/to/knowledge
    python -m services.skill_distill.cli preview bazi --knowledge-dir /path/to/knowledge
    python -m services.skill_distill.cli extract-file /path/to/file.md
"""
import asyncio
import argparse
import logging
import json
from pathlib import Path

logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")
logger = logging.getLogger(__name__)

# 默认知识库目录 (从环境变量或相对路径获取)
import os
_project_root = Path(__file__).resolve().parents[4]  # apps/api/services/skill_distill -> project root
_knowledge_root = Path(os.getenv("VIBELIFE_KNOWLEDGE_ROOT", _project_root / "knowledge"))
DEFAULT_KNOWLEDGE_DIRS = {
    "bazi": _knowledge_root / "bazi",
    "zodiac": _knowledge_root / "zodiac",
}

# 默认描述
DEFAULT_DESCRIPTIONS = {
    "bazi": "八字命理分析专家。提供命盘排盘、日主分析、十神解读、大运流年分析。",
    "zodiac": "西方占星分析专家。提供本命星盘解读、行星位置分析、行运预测。",
}


async def cmd_distill(args):
    """执行完整提炼流程"""
    from .distiller import SkillDistiller, DistillConfig

    knowledge_dir = Path(args.knowledge_dir) if args.knowledge_dir else DEFAULT_KNOWLEDGE_DIRS.get(args.skill_name)
    if not knowledge_dir or not knowledge_dir.exists():
        logger.error(f"知识库目录不存在: {knowledge_dir}")
        return

    description = args.description or DEFAULT_DESCRIPTIONS.get(args.skill_name, f"{args.skill_name} 专业分析")

    config = DistillConfig(
        skill_name=args.skill_name,
        skill_description=description,
        knowledge_dir=knowledge_dir,
        output_dir=Path(args.output_dir) if args.output_dir else None,
        file_pattern=args.pattern,
        merge_qa=not args.no_merge
    )

    distiller = SkillDistiller()
    result = await distiller.distill(config)

    print("\n" + "=" * 60)
    print("提炼完成！")
    print("=" * 60)
    print(f"Skill 名称: {result.skill_name}")
    print(f"处理文件数: {result.total_files}")
    print(f"提取问答对: {result.total_qa_pairs}")
    print(f"合并后问答对: {result.merged_qa_pairs}")
    print(f"输出文件: {result.skill_path}")
    print("=" * 60)


async def cmd_preview(args):
    """预览提炼结果（不生成文件）"""
    from .distiller import SkillDistiller, DistillConfig

    knowledge_dir = Path(args.knowledge_dir) if args.knowledge_dir else DEFAULT_KNOWLEDGE_DIRS.get(args.skill_name)
    if not knowledge_dir or not knowledge_dir.exists():
        logger.error(f"知识库目录不存在: {knowledge_dir}")
        return

    config = DistillConfig(
        skill_name=args.skill_name,
        skill_description="",
        knowledge_dir=knowledge_dir,
        file_pattern=args.pattern,
        merge_qa=not args.no_merge
    )

    distiller = SkillDistiller()
    qa_pairs = await distiller.preview(config)

    print("\n" + "=" * 60)
    print(f"预览结果：共 {len(qa_pairs)} 个问答对")
    print("=" * 60)

    # 按类别分组显示
    from collections import defaultdict
    grouped = defaultdict(list)
    for qa in qa_pairs:
        grouped[qa.category].append(qa)

    for category, pairs in grouped.items():
        print(f"\n### {category} ({len(pairs)} 个)")
        for i, qa in enumerate(pairs[:3], 1):  # 每类最多显示 3 个
            print(f"\n{i}. Q: {qa.question}")
            print(f"   A: {qa.answer[:100]}..." if len(qa.answer) > 100 else f"   A: {qa.answer}")

        if len(pairs) > 3:
            print(f"   ... 还有 {len(pairs) - 3} 个")


async def cmd_extract_file(args):
    """从单个文件提取问答对"""
    from .qa_extractor import QAExtractor

    file_path = Path(args.file_path)
    if not file_path.exists():
        logger.error(f"文件不存在: {file_path}")
        return

    extractor = QAExtractor()
    qa_pairs = await extractor.extract_from_file(file_path)

    print("\n" + "=" * 60)
    print(f"从 {file_path.name} 提取了 {len(qa_pairs)} 个问答对")
    print("=" * 60)

    for i, qa in enumerate(qa_pairs, 1):
        print(f"\n{i}. [{qa.category}]")
        print(f"   Q: {qa.question}")
        print(f"   A: {qa.answer}")

    if args.output:
        output_path = Path(args.output)
        with open(output_path, "w", encoding="utf-8") as f:
            json.dump([qa.to_dict() for qa in qa_pairs], f, ensure_ascii=False, indent=2)
        print(f"\n已保存到: {output_path}")


def main():
    parser = argparse.ArgumentParser(
        description="Skill Distill CLI - 从知识库提炼 Skill",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    subparsers = parser.add_subparsers(dest="command", help="命令")

    # distill 命令
    distill_parser = subparsers.add_parser("distill", help="执行完整提炼流程")
    distill_parser.add_argument("skill_name", help="Skill 名称 (bazi/zodiac)")
    distill_parser.add_argument("--knowledge-dir", "-k", help="知识库目录")
    distill_parser.add_argument("--output-dir", "-o", help="输出目录")
    distill_parser.add_argument("--description", "-d", help="Skill 描述")
    distill_parser.add_argument("--pattern", "-p", default="*.md", help="文件匹配模式")
    distill_parser.add_argument("--no-merge", action="store_true", help="不合并去重问答对")

    # preview 命令
    preview_parser = subparsers.add_parser("preview", help="预览提炼结果")
    preview_parser.add_argument("skill_name", help="Skill 名称")
    preview_parser.add_argument("--knowledge-dir", "-k", help="知识库目录")
    preview_parser.add_argument("--pattern", "-p", default="*.md", help="文件匹配模式")
    preview_parser.add_argument("--no-merge", action="store_true", help="不合并去重")

    # extract-file 命令
    extract_parser = subparsers.add_parser("extract-file", help="从单个文件提取问答对")
    extract_parser.add_argument("file_path", help="文件路径")
    extract_parser.add_argument("--output", "-o", help="输出 JSON 文件路径")

    args = parser.parse_args()

    if args.command == "distill":
        asyncio.run(cmd_distill(args))
    elif args.command == "preview":
        asyncio.run(cmd_preview(args))
    elif args.command == "extract-file":
        asyncio.run(cmd_extract_file(args))
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
