"""CoreAgent + DeepSeek V3 (Anthropic 兼容模式) 测试
三组对话场景：闲聊、技能调用、复杂需求
"""
import asyncio
import os
import sys
import logging

from pathlib import Path
_script_dir = Path(__file__).resolve().parent
sys.path.insert(0, str(_script_dir.parent))

# 加载 .env.test 配置 (项目根目录，强制覆盖已有环境变量)
from dotenv import load_dotenv
_project_root = _script_dir.parents[2]  # scripts -> api -> apps -> project root
load_dotenv(_project_root / '.env.test', override=True)

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

from services.agent.core import CoreAgent, AgentContext
from services.llm.client import LLMClient, LLMMessage


class DeepSeekClient(LLMClient):
    """使用 DeepSeek V3 Anthropic 兼容模式的 LLM Client"""

    async def stream(self, messages, tools=None, user_tier="free", task="chat",
                     model=None, temperature=0.7, max_tokens=4096):
        """使用 DeepSeek Anthropic 兼容模式"""
        async for chunk in self._stream_claude(
            model="deepseek-chat",
            messages=messages,
            tools=tools,
            max_tokens=max_tokens,
            provider="deepseek"
        ):
            yield chunk


async def run_test(agent: CoreAgent, context: AgentContext, question: str) -> dict:
    """运行单个测试，返回结果"""
    content = ""
    tool_calls = []

    try:
        async for event in agent.run(question, context):
            if event.type == "content":
                chunk = event.data.get("content", "")
                content += chunk
                print(chunk, end="", flush=True)
            elif event.type == "tool_call":
                tool_calls.append(event.data)
            elif event.type == "tool_result":
                pass  # 静默处理
            elif event.type == "done":
                break
            elif event.type == "error":
                print(f"\n[ERROR: {event.data}]")
                return {"success": False, "error": str(event.data)}

        print()
        return {
            "success": True,
            "content": content,
            "tool_calls": tool_calls,
            "usage": agent.usage
        }

    except Exception as e:
        logger.exception(f"测试异常: {e}")
        return {"success": False, "error": str(e)}


async def main():
    """运行三组对话测试"""
    print("=" * 70)
    print("CoreAgent + DeepSeek V3 (Anthropic 兼容模式) 测试")
    print("=" * 70)

    # 初始化
    llm = DeepSeekClient()
    agent = CoreAgent(llm=llm, max_iterations=5)

    context = AgentContext(
        user_id="test_deepseek",
        user_tier="paid",
        profile={"basic": {"name": "小明", "gender": "male"}},
        skill_data={}
    )

    # 三组测试对话
    test_cases = [
        {
            "name": "组1: 闲聊测试",
            "desc": "验证基础对话能力和人格表现",
            "question": "你好呀，能介绍一下你自己吗？你有什么特别的能力？"
        },
        {
            "name": "组2: 技能选择测试",
            "desc": "验证 use_skill 工具调用能力",
            "question": "我想看看我的八字命盘，我是1990年8月15日上午10点出生的"
        },
        {
            "name": "组3: 复杂需求测试",
            "desc": "验证理解复杂意图和建议能力",
            "question": "最近工作压力很大，想换个行业，但又怕跳槽失败，你觉得我该怎么办？"
        }
    ]

    results = []

    for i, tc in enumerate(test_cases):
        print(f"\n{'='*70}")
        print(f"【{tc['name']}】")
        print(f"描述: {tc['desc']}")
        print(f"{'='*70}")
        print(f"\nQ: {tc['question']}\n")
        print("A: ", end="", flush=True)

        result = await run_test(agent, context, tc["question"])
        results.append({**tc, **result})

        if result.get("tool_calls"):
            tools = [t.get("name") for t in result["tool_calls"]]
            print(f"\n[工具调用: {tools}]")

        if result.get("usage"):
            u = result["usage"]
            print(f"[Token: 输入={u.get('input_tokens', 0)}, 输出={u.get('output_tokens', 0)}]")

    # 汇总
    print("\n" + "=" * 70)
    print("测试结果汇总")
    print("=" * 70)

    for r in results:
        status = "✅ 通过" if r.get("success") else f"❌ 失败: {r.get('error')}"
        tools = [t.get("name") for t in r.get("tool_calls", [])]
        tools_str = f" → 工具: {tools}" if tools else ""
        print(f"{r['name']}: {status}{tools_str}")


if __name__ == "__main__":
    asyncio.run(main())
