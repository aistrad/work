#!/bin/bash
# Start API server and run tests

# cd /opt/vibelife/
# mkdir -p ~/logs

# cd /opt/vibelife/apps/api
# python3 -m venv venv
# source venv/bin/activate
# pip install --upgrade pip
# pip install -r requirements.txt

# cp /opt/vibelife/.env .

cd /opt/vibelife/apps/api
source .env

# 注意: 所有敏感配置必须从 .env 文件读取，不要在此硬编码
# 必需的环境变量 (来自 .env):
#   - GLM_API_KEY
#   - VIBELIFE_DB_URL
# 可选的环境变量:
#   - VIBELIFE_API_PORT (默认 8231)
#   - VIBELIFE_API_HOST (默认 0.0.0.0)

# 验证必需的环境变量
if [ -z "$GLM_API_KEY" ]; then
    echo "ERROR: GLM_API_KEY not set. Please configure in .env file."
    exit 1
fi

if [ -z "$VIBELIFE_DB_URL" ]; then
    echo "ERROR: VIBELIFE_DB_URL not set. Please configure in .env file."
    exit 1
fi

# Kill any existing server
pkill -f "uvicorn main:app" 2>/dev/null || true
sleep 2

# Start server
echo "Starting API server..."
nohup python3 -m uvicorn main:app --host 0.0.0.0 --port 8231 > /opt/vibelife/logs/vibelife_api.log 2>&1 &
SERVER_PID=$!
echo "Server PID: $SERVER_PID"

# Wait for server to start
sleep 5

# Check if server is running
if ! kill -0 $SERVER_PID 2>/dev/null; then
    echo "Server failed to start. Log output:"
    cat /opt/vibelife/logs/vibelife_api.log
    exit 1
fi

# Test endpoints
echo ""
echo "Testing health endpoint..."
curl -s http://localhost:8231/health

echo ""
echo "Testing chat/guest endpoint..."
curl -s -X POST http://localhost:8231/api/v1/chat/guest \
    -H "Content-Type: application/json" \
    -d '{"message": "你好，我想了解一下八字", "skill": "bazi"}'

echo ""
echo "Server is running. Log:"
tail -20 /opt/vibelife/logs/vibelife_api.log

# cp -rf /home/aiscend/.cache/vibelife/models /data/vibelife/
# chmod -R 777 /data/vibelife/
