/**
 * QuestionCard - é—®ç­”å¡ç‰‡
 *
 * ç”¨äº ask_user_question å·¥å…·ï¼Œæ”¯æŒé€‰é¡¹é€‰æ‹©å’Œè‡ªç”±æ–‡æœ¬è¾“å…¥
 * card_type: "question_card"
 */

"use client";

import { useState } from "react";
import { motion } from "framer-motion";
import { registerCard } from "@/skills/CardRegistry";

interface QuestionCardProps {
  data: {
    question: string;
    options?: string[];
    placeholder?: string;
    allowFreeText?: boolean;
  };
  onSubmit?: (answer: string) => void;
}

function QuestionCard({ data, onSubmit }: QuestionCardProps) {
  const { question, options = [], placeholder = "è¾“å…¥ä½ çš„å›ç­”...", allowFreeText = true } = data;
  const [selectedOption, setSelectedOption] = useState<string | null>(null);
  const [freeText, setFreeText] = useState("");
  const [showFreeText, setShowFreeText] = useState(false);
  const [submitted, setSubmitted] = useState(false);

  const handleOptionClick = (option: string) => {
    if (submitted) return;
    setSelectedOption(option);
    setShowFreeText(false);
  };

  const handleSubmit = () => {
    if (submitted) return;

    const answer = showFreeText ? freeText : selectedOption;
    if (!answer) return;

    setSubmitted(true);
    onSubmit?.(answer);
  };

  const handleFreeTextToggle = () => {
    setShowFreeText(true);
    setSelectedOption(null);
  };

  if (!question) return null;

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.4 }}
      className="question-card bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-slate-800 dark:to-indigo-900 rounded-xl border border-indigo-200 dark:border-indigo-500/30 p-4 my-2"
    >
      {/* Question */}
      <div className="flex items-start gap-2 mb-4">
        <span className="text-xl">ğŸ’¬</span>
        <p className="text-base font-medium text-gray-800 dark:text-white leading-relaxed">
          {question}
        </p>
      </div>

      {/* Options */}
      {options.length > 0 && !submitted && (
        <div className="space-y-2 mb-4">
          {options.map((option, index) => (
            <motion.button
              key={index}
              initial={{ opacity: 0, x: -10 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: index * 0.1 }}
              onClick={() => handleOptionClick(option)}
              className={`w-full text-left px-4 py-3 rounded-lg border transition-all ${
                selectedOption === option
                  ? "bg-indigo-500 text-white border-indigo-500"
                  : "bg-white dark:bg-slate-700 text-gray-700 dark:text-gray-200 border-gray-200 dark:border-slate-600 hover:border-indigo-300 dark:hover:border-indigo-500"
              }`}
            >
              <span className="flex items-center gap-2">
                <span className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${
                  selectedOption === option
                    ? "border-white bg-white"
                    : "border-gray-300 dark:border-gray-500"
                }`}>
                  {selectedOption === option && (
                    <span className="w-2.5 h-2.5 rounded-full bg-indigo-500" />
                  )}
                </span>
                {option}
              </span>
            </motion.button>
          ))}

          {/* Free text option */}
          {allowFreeText && (
            <motion.button
              initial={{ opacity: 0, x: -10 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: options.length * 0.1 }}
              onClick={handleFreeTextToggle}
              className={`w-full text-left px-4 py-3 rounded-lg border transition-all ${
                showFreeText
                  ? "bg-indigo-500 text-white border-indigo-500"
                  : "bg-white dark:bg-slate-700 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-slate-600 hover:border-indigo-300 dark:hover:border-indigo-500"
              }`}
            >
              <span className="flex items-center gap-2">
                <span className="text-lg">âœï¸</span>
                è‡ªå·±è¾“å…¥...
              </span>
            </motion.button>
          )}
        </div>
      )}

      {/* Free text input */}
      {showFreeText && !submitted && (
        <motion.div
          initial={{ opacity: 0, height: 0 }}
          animate={{ opacity: 1, height: "auto" }}
          className="mb-4"
        >
          <textarea
            value={freeText}
            onChange={(e) => setFreeText(e.target.value)}
            placeholder={placeholder}
            className="w-full px-4 py-3 rounded-lg border border-gray-200 dark:border-slate-600 bg-white dark:bg-slate-700 text-gray-800 dark:text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"
            rows={3}
            autoFocus
          />
        </motion.div>
      )}

      {/* Submit button */}
      {!submitted && (selectedOption || (showFreeText && freeText.trim())) && (
        <motion.button
          initial={{ opacity: 0, y: 10 }}
          animate={{ opacity: 1, y: 0 }}
          onClick={handleSubmit}
          className="w-full py-3 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-medium transition-colors"
        >
          ç¡®è®¤
        </motion.button>
      )}

      {/* Submitted state */}
      {submitted && (
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          className="flex items-center gap-2 text-green-600 dark:text-green-400"
        >
          <span>âœ“</span>
          <span>å·²æäº¤: {showFreeText ? freeText : selectedOption}</span>
        </motion.div>
      )}
    </motion.div>
  );
}

registerCard("question_card", QuestionCard);

export default QuestionCard;
