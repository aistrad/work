---
id: tool-definition
name: 工具定义规范
impact: HIGH
tags: tools.yaml, handlers.py, 工具定义
---

# 工具定义规范 v10.3

---

## 1. 工具分类

| 类别 | 前缀 | 说明 | 示例 |
|-----|------|------|------|
| 收集 | `collect_` | 收集用户信息 | `collect_zodiac_info` |
| 计算 | `calculate_` | 内部计算，返回数据 | `calculate_zodiac` |
| 展示 | `show_` | 展示卡片 | `show_zodiac_chart` |
| 检索 | `search_` | 检索知识库 | `search_db` |
| 请求 | `request_` | 请求补充信息 | `request_info` |
| 保存 | `save_` | 保存用户数据 | `save_birth_info` |

---

## 2. tools.yaml 结构

```yaml
version: "1.0"
skill_id: {skill_id}

# 按类别组织
compute:
  - name: calculate_xxx
    description: |
      计算描述...
    card_type: xxx_chart
    when_to_call: |
      - 用户提供了信息后需要计算时
    parameters:
      - name: param1
        type: string
        required: true
        description: 参数描述

collect:
  - name: collect_xxx_info
    description: |
      收集用户信息...
    card_type: collect_form
    when_to_call: 用户未提供信息时
    parameters: [...]

display:
  - name: show_xxx_chart
    description: |
      展示图表卡片...
    card_type: xxx_chart
    when_to_call: 用户想看图表时
    parameters: [...]
```

---

## 3. handlers.py 结构

```python
"""
{Skill Name} Tool Handlers

使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
"""
import logging
from typing import Dict, Any

from services.agent.tool_registry import tool_handler, ToolContext

logger = logging.getLogger(__name__)


# ═══════════════════════════════════════════════════════════════════════════════
# 计算工具
# ═══════════════════════════════════════════════════════════════════════════════

@tool_handler("calculate_xxx")
async def execute_calculate_xxx(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    计算 xxx - 核心计算工具
    """
    from services.agent.tool_registry import ToolRegistry
    from skills.xxx.services import calculate_xxx

    profile = context.profile or {}
    identity = profile.get("identity", {})
    birth_info = identity.get("birth_info", {})

    # 优先使用 args，否则从 profile 读取
    param1 = args.get("param1") or birth_info.get("param1")

    if not param1:
        return {
            "status": "error",
            "error": "需要参数才能计算",
            "action": "collect_xxx_info"
        }

    try:
        # 计算
        result = calculate_xxx(param1=param1)

        # 构建卡片数据
        card_data = {
            "userId": context.user_id,
            "field1": result.get("field1"),
            "field2": result.get("field2"),
        }

        # 展示卡片
        return await ToolRegistry.execute(
            "show_card",
            {
                "card_type": "custom",
                "data_source": {"type": "inline", "data": card_data},
                "options": {"componentId": "xxx_chart"}
            },
            context
        )

    except Exception as e:
        logger.error(f"calculate_xxx failed: {e}")
        return {
            "status": "error",
            "error": f"计算失败: {str(e)}",
        }


# ═══════════════════════════════════════════════════════════════════════════════
# 收集工具
# ═══════════════════════════════════════════════════════════════════════════════

@tool_handler("collect_xxx_info")
async def execute_collect_xxx_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """收集用户信息"""
    fields = [
        {"id": "field1", "label": "字段1", "type": "text", "required": True},
        {"id": "field2", "label": "字段2", "type": "date", "required": True},
    ]

    return {
        "status": "collecting",
        "cardType": "collect_form",
        "formType": "xxx_info",
        "title": "请填写信息",
        "description": "描述说明",
        "fields": fields,
    }


# ═══════════════════════════════════════════════════════════════════════════════
# 展示工具
# ═══════════════════════════════════════════════════════════════════════════════

@tool_handler("show_xxx_chart")
async def execute_show_xxx_chart(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示图表卡片"""
    from services.agent.tool_registry import ToolRegistry

    # 从 args 或 context 获取数据
    data = args.get("data") or context.skill_data.get("xxx", {})

    if not data:
        return {
            "status": "error",
            "error": "没有数据，请先计算",
            "action": "calculate_xxx"
        }

    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {"type": "inline", "data": data},
            "options": {"componentId": "xxx_chart"}
        },
        context
    )
```

---

## 4. ToolContext 说明

```python
@dataclass
class ToolContext:
    user_id: str              # 用户 ID
    conversation_id: str      # 会话 ID
    skill_id: str             # 当前 Skill ID
    profile: Optional[Dict]   # 用户 Profile
    skill_data: Optional[Dict] # Skill 专属数据
```

### 4.1 从 Profile 读取数据

```python
profile = context.profile or {}
identity = profile.get("identity", {})
birth_info = identity.get("birth_info", {})

birth_date = birth_info.get("date")
birth_time = birth_info.get("time", "12:00")
birth_place = birth_info.get("place", "Shanghai")
```

### 4.2 从 skill_data 读取数据

```python
skill_data = context.skill_data or {}
zodiac_data = skill_data.get("zodiac", {})
chart = zodiac_data.get("chart", {})
```

---

## 5. 全局工具

以下工具在 `skills/core/tools/` 中定义，所有 Skill 共享：

| 工具 | 用途 | 示例 |
|-----|------|------|
| `search_db` | 检索知识库 | `search_db(query="xxx", skill_id="zodiac")` |
| `show_card` | 通用卡片展示 | 委托展示任意卡片 |
| `show_insight` | 洞察卡片 | 展示 3-5 条洞察 |
| `request_info` | 请求信息 | 通用信息收集 |
| `save_birth_info` | 保存出生信息 | 保存到 profile |
| `activate_skill` | 激活 Skill | Phase 1 路由 |
| `recommend_skills` | 推荐 Skills | 不明确时推荐 |
| `ask_user_question` | 问用户问题 | 交互式问答 |

---

## 6. 复用其他 Skill 的工具

### 6.1 在 SKILL.md frontmatter 声明

```yaml
---
name: jungastro
external_tools: [calculate_zodiac]  # 从 zodiac 导入
---
```

### 6.2 在 handlers.py 中调用

```python
@tool_handler("show_psychological_portrait")
async def handle_show_psychological_portrait(args, context):
    # 调用 zodiac 的计算函数
    from skills.zodiac.services import calculate_zodiac

    chart = calculate_zodiac(
        birth_date=birth_date,
        birth_time=birth_time,
        birth_place=birth_place
    )
    # ...
```

---

## 7. 检查清单

创建工具时：

- [ ] tools.yaml 定义完整（name, description, parameters, when_to_call）
- [ ] handlers.py 使用 `@tool_handler` 装饰器
- [ ] 函数签名为 `async def xxx(args: Dict, context: ToolContext)`
- [ ] 错误情况返回 `{status: "error", error: "...", action: "..."}`
- [ ] 展示工具使用 `ToolRegistry.execute("show_card", ...)` 委托
- [ ] 从 `context.profile` 正确读取用户数据
- [ ] 添加适当的日志记录
