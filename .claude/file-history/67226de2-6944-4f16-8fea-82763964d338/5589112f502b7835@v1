"use client";

/**
 * ProtocolContainer - åè®®æ‰§è¡Œå®¹å™¨
 *
 * ç®¡ç†åè®®çš„å®Œæ•´æµç¨‹ï¼š
 * 1. åŠ è½½åè®®é…ç½®
 * 2. æ˜¾ç¤ºå½“å‰æ­¥éª¤
 * 3. å¤„ç†ç”¨æˆ·å›ç­”
 * 4. æ˜¾ç¤º AI å›åº”
 * 5. æ§åˆ¶æ­¥éª¤æµè½¬
 */

import { memo, useState, useCallback, useRef, useEffect } from "react";
import { useRouter } from "next/navigation";
import { cn } from "@/lib/utils";
import { ProtocolProgress } from "./ProtocolProgress";
import { ProtocolStep, type StepConfig } from "./ProtocolStep";

// UUID ç”Ÿæˆå‡½æ•°ï¼ˆå…¼å®¹ä¸æ”¯æŒ crypto.randomUUID çš„ç¯å¢ƒï¼‰
function generateUUID(): string {
  if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
    return crypto.randomUUID();
  }
  // Fallback: ä½¿ç”¨ crypto.getRandomValues
  if (typeof crypto !== "undefined" && typeof crypto.getRandomValues === "function") {
    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
      const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15) >> (c === "x" ? 0 : 3);
      return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
    });
  }
  // Fallback: Math.random (ä¸æ¨èï¼Œä½†ä½œä¸ºæœ€åæ‰‹æ®µ)
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0;
    return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
  });
}

// åè®®é…ç½®ï¼ˆä»åç«¯åŒæ­¥ï¼‰
const PROTOCOL_CONFIGS: Record<string, {
  id: string;
  name: string;
  description: string;
  totalSteps: number;
  estimatedTime: string;
  welcomeMessage: string;
  steps: Record<number, StepConfig>;
}> = {
  dankoe: {
    id: "dankoe",
    name: "Dan Koe å¿«é€Ÿé‡ç½®",
    description: "10åˆ†é’Ÿå®Œæˆäººç”Ÿé‡ç½®ï¼Œé€šè¿‡åæ„¿æ™¯é©±åŠ¨å’Œèº«ä»½è½¬æ¢å®ç°å¿«é€Ÿè½¬å˜",
    totalSteps: 6,
    estimatedTime: "10åˆ†é’Ÿ",
    welcomeMessage: "å¥½çš„ï¼Œæˆ‘ä»¬æ¥åšä¸€æ¬¡ Dan Koe çš„å¿«é€Ÿé‡ç½®ã€‚\næ•´ä¸ªè¿‡ç¨‹å¤§çº¦10åˆ†é’Ÿï¼Œæˆ‘ä¼šé—®ä½ 6ä¸ªé—®é¢˜ã€‚\næ ¸å¿ƒæ˜¯ï¼šå…ˆçœ‹æ¸…ä½ ä¸æƒ³è¦çš„äººç”Ÿï¼Œå†è®¾è®¡ä½ æƒ³è¦çš„ã€‚\n\nå‡†å¤‡å¥½äº†å—ï¼Ÿ",
    steps: {
      1: {
        phase: "Phase 1: è§‰é†’",
        name: "æŒç»­çš„ä¸æ»¡",
        question: "è¿‡å»ä¸€å¹´ï¼Œä½ å­¦ä¼šå¿å—çš„ã€æŒç»­çš„ä¸æ»¡æ˜¯ä»€ä¹ˆï¼Ÿ\nä¸æ˜¯æ·±å±‚ç—›è‹¦ï¼Œè€Œæ˜¯ä½ å·²ç»ä¹ æƒ¯çš„ä¸èˆ’æœã€‚",
        placeholder: "æè¿°é‚£äº›ä½ å·²ç»éº»æœ¨ä½†å…¶å®å¾ˆä¸çˆ½çš„äº‹...",
        minLength: 30,
        hints: ["å·¥ä½œä¸Šçš„...", "äººé™…å…³ç³»ä¸­çš„...", "å¯¹è‡ªå·±çš„..."],
      },
      2: {
        phase: "Phase 1: è§‰é†’",
        name: "åæ„¿æ™¯åœºæ™¯",
        question: "å¦‚æœæ¥ä¸‹æ¥5å¹´ä»€ä¹ˆéƒ½ä¸æ”¹å˜ï¼Œæè¿°ä¸€ä¸ªæ™®é€šçš„å‘¨äºŒï¼š\n- ä½ åœ¨å“ªé‡Œé†’æ¥ï¼Ÿ\n- èº«ä½“æ„Ÿè§‰å¦‚ä½•ï¼Ÿ\n- 9ç‚¹åˆ°6ç‚¹åœ¨åšä»€ä¹ˆï¼Ÿ\n- æ™šä¸Š10ç‚¹çš„æ„Ÿè§‰æ˜¯ä»€ä¹ˆï¼Ÿ",
        placeholder: "ç”¨ç¬¬ä¸€äººç§°æè¿°ï¼Œè¶Šå…·ä½“è¶Šæœ‰åŠ›é‡...",
        minLength: 50,
      },
      3: {
        phase: "Phase 1: è§‰é†’",
        name: "æ„¿æ™¯åœºæ™¯",
        question: "å¿˜è®°å¯è¡Œæ€§ã€‚å¦‚æœ3å¹´åä½ è¿‡ä¸Šå®Œå…¨ä¸åŒçš„ç”Ÿæ´»ï¼Œ\nä¸€ä¸ªæ™®é€šçš„å‘¨äºŒä¼šæ˜¯ä»€ä¹ˆæ ·ï¼ŸåŒæ ·çš„ç»†èŠ‚ï¼š\n- åœ¨å“ªé‡Œé†’æ¥ï¼Ÿ\n- èº«ä½“æ„Ÿè§‰å¦‚ä½•ï¼Ÿ\n- ä¸€å¤©æ€ä¹ˆåº¦è¿‡ï¼Ÿ\n- æ™šä¸Šçš„æ„Ÿè§‰æ˜¯ä»€ä¹ˆï¼Ÿ",
        placeholder: "å¤§èƒ†æƒ³è±¡ï¼Œä¸è¦è‡ªæˆ‘è®¾é™...",
        minLength: 50,
      },
      4: {
        phase: "Phase 2: è®¾è®¡",
        name: "æ”¾å¼ƒçš„èº«ä»½",
        question: `è¦çœŸæ­£æ”¹å˜ï¼Œä½ å¿…é¡»æ”¾å¼ƒä»€ä¹ˆèº«ä»½ï¼Ÿ
ç”¨"æˆ‘æ˜¯é‚£ç§ä¼š..."æ¥æè¿°ã€‚

æ¯”å¦‚ï¼š
- "æˆ‘æ˜¯é‚£ç§ä¼šæ‹–å»¶çš„äºº"
- "æˆ‘æ˜¯é‚£ç§ä¸æ•¢å†’é™©çš„äºº"
- "æˆ‘æ˜¯é‚£ç§æ€»æ˜¯ç…§é¡¾åˆ«äººçš„äºº"`,
        placeholder: "æˆ‘æ˜¯é‚£ç§ä¼š...",
        minLength: 20,
        hints: ["æˆ‘æ˜¯é‚£ç§ä¼šæ‹–å»¶çš„äºº", "æˆ‘æ˜¯é‚£ç§å®³æ€•å¤±è´¥çš„äºº", "æˆ‘æ˜¯é‚£ç§ä¸å¤Ÿè‡ªä¿¡çš„äºº"],
      },
      5: {
        phase: "Phase 2: è®¾è®¡",
        name: "æ–°èº«ä»½å®£è¨€",
        question: `ä½ æƒ³æˆä¸ºä»€ä¹ˆæ ·çš„äººï¼Ÿ
ç”¨"æˆ‘æ˜¯é‚£ç§..."æ¥å¡«ç©ºã€‚

è¿™ä¸æ˜¯ä½ "åº”è¯¥"æˆä¸ºçš„äººï¼Œ
è€Œæ˜¯è¿‡ç€ä½ åˆšæ‰æè¿°çš„é‚£ç§ç”Ÿæ´»çš„äººï¼Œ
ä»–ä¼šæ€ä¹ˆæè¿°è‡ªå·±ï¼Ÿ`,
        placeholder: "æˆ‘æ˜¯é‚£ç§...",
        minLength: 20,
        hints: ["æˆ‘æ˜¯é‚£ç§æ•¢äºè¡ŒåŠ¨çš„äºº", "æˆ‘æ˜¯é‚£ç§ç›¸ä¿¡è‡ªå·±çš„äºº", "æˆ‘æ˜¯é‚£ç§åˆ›é€ ä»·å€¼çš„äºº"],
      },
      6: {
        phase: "Phase 3: å¯åŠ¨",
        name: "æœ¬å‘¨è¡ŒåŠ¨",
        question: `å¦‚æœä½ å·²ç»æ˜¯é‚£ä¸ªäººï¼Œè¿™å‘¨ä½ ä¼šåšä»€ä¹ˆï¼Ÿ
ä¸æ˜¯"åº”è¯¥åš"ï¼Œè€Œæ˜¯é‚£ä¸ªäºº"è‡ªç„¶ä¼šåš"çš„äº‹ã€‚
1-3ä»¶å…·ä½“çš„äº‹å°±å¤Ÿäº†ã€‚`,
        placeholder: "1. ...\n2. ...\n3. ...",
        minLength: 30,
      },
    },
  },
};

interface Message {
  role: "user" | "assistant";
  content: string;
}

interface ProtocolState {
  protocol_id: string;
  step: number;
  next_step: number | null;
  progress: string;
  is_completed: boolean;
  data_saved: boolean;
}

export interface ProtocolContainerProps {
  protocolId: string;
  conversationId?: string;
  className?: string;
}

export const ProtocolContainer = memo(function ProtocolContainer({
  protocolId,
  conversationId,
  className,
}: ProtocolContainerProps) {
  const router = useRouter();
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // åè®®é…ç½®
  const config = PROTOCOL_CONFIGS[protocolId];

  // çŠ¶æ€
  const [currentStep, setCurrentStep] = useState(0); // 0 = æ¬¢è¿é¡µ
  const [messages, setMessages] = useState<Message[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [isCompleted, setIsCompleted] = useState(false);
  const [convId, setConvId] = useState(conversationId || "");

  // æ»šåŠ¨åˆ°åº•éƒ¨
  const scrollToBottom = useCallback(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, []);

  useEffect(() => {
    scrollToBottom();
  }, [messages, scrollToBottom]);

  // ç”Ÿæˆ conversation ID
  useEffect(() => {
    if (!convId) {
      setConvId(generateUUID());
    }
  }, [convId]);

  // å¼€å§‹åè®®
  const handleStart = useCallback(() => {
    setCurrentStep(1);
  }, []);

  // æäº¤å›ç­”
  const handleSubmit = useCallback(async (answer: string) => {
    if (isLoading || !config) return;

    setIsLoading(true);

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
    setMessages((prev) => [...prev, { role: "user", content: answer }]);

    try {
      // è°ƒç”¨åç«¯ API
      const response = await fetch("/api/chat/v5/stream", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          message: answer,
          conversation_id: convId,
          skill: "lifecoach",
          protocol: {
            id: protocolId,
            step: currentStep,
          },
        }),
      });

      if (!response.ok) {
        throw new Error("API request failed");
      }

      // è§£æ SSE æµ
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      let assistantContent = "";
      let protocolState: ProtocolState | null = null;

      if (reader) {
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          const chunk = decoder.decode(value);
          const lines = chunk.split("\n");

          for (const line of lines) {
            if (line.startsWith("0:")) {
              // æ–‡æœ¬å†…å®¹
              try {
                const content = JSON.parse(line.slice(2));
                if (typeof content === "string" && !content.startsWith("[[TOOL:")) {
                  assistantContent += content;
                  // å®æ—¶æ›´æ–°æ¶ˆæ¯
                  setMessages((prev) => {
                    const newMessages = [...prev];
                    const lastMsg = newMessages[newMessages.length - 1];
                    if (lastMsg?.role === "assistant") {
                      lastMsg.content = assistantContent;
                    } else {
                      newMessages.push({ role: "assistant", content: assistantContent });
                    }
                    return newMessages;
                  });
                }
              } catch {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            } else if (line.startsWith("2:")) {
              // æ•°æ®éƒ¨åˆ†ï¼ˆprotocol_stateï¼‰
              try {
                const data = JSON.parse(line.slice(2));
                if (Array.isArray(data) && data[0] === "protocol_state") {
                  protocolState = data[1] as ProtocolState;
                }
              } catch {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            }
          }
        }
      }

      // å¤„ç†åè®®çŠ¶æ€
      if (protocolState) {
        if (protocolState.is_completed) {
          setIsCompleted(true);
        } else if (protocolState.next_step) {
          setCurrentStep(protocolState.next_step);
        }
      } else {
        // å¦‚æœæ²¡æœ‰æ”¶åˆ° protocol_stateï¼Œæ‰‹åŠ¨é€’å¢
        if (currentStep < config.totalSteps) {
          setCurrentStep(currentStep + 1);
        } else {
          setIsCompleted(true);
        }
      }
    } catch (error) {
      console.error("Protocol API error:", error);
      // æ·»åŠ é”™è¯¯æ¶ˆæ¯
      setMessages((prev) => [
        ...prev,
        { role: "assistant", content: "æŠ±æ­‰ï¼Œå‡ºç°äº†ä¸€äº›é—®é¢˜ã€‚è¯·ç¨åé‡è¯•ã€‚" },
      ]);
    } finally {
      setIsLoading(false);
    }
  }, [isLoading, config, convId, protocolId, currentStep]);

  // å®Œæˆåè¿”å›
  const handleComplete = useCallback(() => {
    router.push("/chat?skill=lifecoach");
  }, [router]);

  // åè®®ä¸å­˜åœ¨
  if (!config) {
    return (
      <div className="flex flex-col items-center justify-center h-full p-8">
        <p className="text-muted-foreground">åè®®ä¸å­˜åœ¨: {protocolId}</p>
        <button
          onClick={() => router.back()}
          className="mt-4 text-sm text-emerald-500 hover:underline"
        >
          è¿”å›
        </button>
      </div>
    );
  }

  const currentStepConfig = config.steps[currentStep];

  return (
    <div className={cn("flex flex-col h-full", className)}>
      {/* Header */}
      <header className="flex-shrink-0 px-4 py-4 border-b border-border bg-background/80 backdrop-blur-sm">
        <div className="max-w-2xl mx-auto">
          <div className="flex items-center justify-between mb-3">
            <h1 className="text-lg font-semibold text-foreground">
              {config.name}
            </h1>
            <span className="text-xs text-muted-foreground">
              çº¦ {config.estimatedTime}
            </span>
          </div>
          {currentStep > 0 && (
            <ProtocolProgress
              currentStep={currentStep}
              totalSteps={config.totalSteps}
              phaseName={currentStepConfig?.phase}
            />
          )}
        </div>
      </header>

      {/* Content */}
      <main className="flex-1 overflow-y-auto">
        <div className="max-w-2xl mx-auto px-4 py-6">
          {/* æ¬¢è¿é¡µ */}
          {currentStep === 0 && (
            <div className="text-center py-8">
              <div className="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center">
                <span className="text-3xl">ğŸ§­</span>
              </div>
              <h2 className="text-xl font-semibold text-foreground mb-2">
                {config.name}
              </h2>
              <p className="text-muted-foreground mb-6 max-w-md mx-auto">
                {config.description}
              </p>
              <div className="bg-muted/50 rounded-xl p-4 mb-6 text-left">
                <p className="text-sm text-foreground whitespace-pre-line">
                  {config.welcomeMessage}
                </p>
              </div>
              <button
                onClick={handleStart}
                className={cn(
                  "px-8 py-3 rounded-xl font-medium",
                  "bg-gradient-to-r from-emerald-500 to-teal-500",
                  "text-white shadow-lg shadow-emerald-500/25",
                  "hover:shadow-xl hover:shadow-emerald-500/30",
                  "active:scale-[0.98] transition-all duration-200"
                )}
              >
                å‡†å¤‡å¥½äº†ï¼Œå¼€å§‹ â†’
              </button>
            </div>
          )}

          {/* åè®®æ­¥éª¤ */}
          {currentStep > 0 && !isCompleted && (
            <>
              {/* å†å²æ¶ˆæ¯ */}
              {messages.length > 0 && (
                <div className="space-y-4 mb-6">
                  {messages.map((msg, idx) => (
                    <div
                      key={idx}
                      className={cn(
                        "p-4 rounded-xl",
                        msg.role === "user"
                          ? "bg-emerald-500/10 ml-8"
                          : "bg-muted mr-8"
                      )}
                    >
                      <p className="text-sm text-foreground whitespace-pre-line">
                        {msg.content}
                      </p>
                    </div>
                  ))}
                </div>
              )}

              {/* å½“å‰æ­¥éª¤ */}
              {currentStepConfig && (
                <ProtocolStep
                  step={currentStep}
                  config={currentStepConfig}
                  isLoading={isLoading}
                  onSubmit={handleSubmit}
                />
              )}

              <div ref={messagesEndRef} />
            </>
          )}

          {/* å®Œæˆé¡µ */}
          {isCompleted && (
            <div className="text-center py-8">
              <div className="w-16 h-16 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-emerald-500 to-teal-500 flex items-center justify-center">
                <span className="text-3xl">ğŸ‰</span>
              </div>
              <h2 className="text-xl font-semibold text-foreground mb-2">
                åè®®å®Œæˆï¼
              </h2>
              <p className="text-muted-foreground mb-6">
                ä½ çš„äººç”Ÿæ¸¸æˆå·²ç»è®¾å®šå¥½äº†ã€‚è®°ä½ï¼Œä½ ä¸æ˜¯åœ¨&ldquo;åŠªåŠ›æˆä¸º&rdquo;é‚£ä¸ªäººï¼Œä½ å·²ç»æ˜¯äº†ã€‚
              </p>

              {/* æœ€åçš„ AI å›åº” */}
              {messages.length > 0 && (
                <div className="bg-muted rounded-xl p-4 mb-6 text-left max-w-md mx-auto">
                  <p className="text-sm text-foreground whitespace-pre-line">
                    {messages[messages.length - 1]?.content}
                  </p>
                </div>
              )}

              <button
                onClick={handleComplete}
                className={cn(
                  "px-8 py-3 rounded-xl font-medium",
                  "bg-gradient-to-r from-emerald-500 to-teal-500",
                  "text-white shadow-lg shadow-emerald-500/25",
                  "hover:shadow-xl hover:shadow-emerald-500/30",
                  "active:scale-[0.98] transition-all duration-200"
                )}
              >
                å¼€å§‹æ–°çš„å¯¹è¯ â†’
              </button>
            </div>
          )}
        </div>
      </main>
    </div>
  );
});

export default ProtocolContainer;
