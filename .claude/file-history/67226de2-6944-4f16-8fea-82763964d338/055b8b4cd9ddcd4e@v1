---
id: card-integration
name: 前端卡片集成
impact: HIGH
tags: 卡片, 前端, CardRegistry, 集成
---

# 前端卡片集成规范 v10.3

---

## 1. 工具 → 卡片 数据流

```
┌─────────────────────────────────────────────────────────────────┐
│ 后端 (Python)                                                   │
├─────────────────────────────────────────────────────────────────┤
│ handlers.py                                                     │
│                                                                 │
│ @tool_handler("calculate_zodiac")                               │
│ async def execute_calculate_zodiac(args, context):              │
│     # 1. 计算数据                                               │
│     chart = calc_zodiac(birth_date, birth_time, birth_place)    │
│                                                                 │
│     # 2. 返回卡片数据                                            │
│     return await ToolRegistry.execute(                          │
│         "show_card",                                            │
│         {                                                       │
│             "card_type": "custom",                              │
│             "data_source": {"type": "inline", "data": card_data},│
│             "options": {"componentId": "zodiac_chart"}          │
│         },                                                      │
│         context                                                 │
│     )                                                           │
└─────────────────────────────────────────────────────────────────┘
                          │
                          │ SSE Stream
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│ 前端 (React/Next.js)                                            │
├─────────────────────────────────────────────────────────────────┤
│ ChatMessage.tsx → ToolCardRenderer                              │
│                                                                 │
│ 1. 从消息中解析工具调用: [[TOOL:xxx:{"cardType":"yyy",...}]]     │
│ 2. 获取 cardType                                                │
│ 3. 从 CardRegistry 获取组件                                      │
│ 4. 渲染卡片                                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 后端工具返回格式

### 2.1 使用 show_card 委托

```python
from services.agent.tool_registry import ToolRegistry

@tool_handler("show_xxx_chart")
async def execute_show_xxx_chart(args, context):
    # 构建卡片数据
    card_data = {
        "userId": context.user_id,
        "field1": "value1",
        "field2": "value2",
    }

    # 委托 show_card 渲染
    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {"type": "inline", "data": card_data},
            "options": {"componentId": "xxx_chart"}  # 前端组件 ID
        },
        context
    )
```

### 2.2 直接返回 cardType

```python
@tool_handler("collect_xxx_info")
async def execute_collect_xxx_info(args, context):
    return {
        "status": "collecting",
        "cardType": "collect_form",  # 前端卡片类型
        "formType": "birth_info",
        "title": "请填写信息",
        "fields": [...],
    }
```

---

## 3. 前端卡片注册

### 3.1 创建卡片组件

```tsx
// apps/web/src/skills/{skill}/cards/{CardName}.tsx

"use client";

import { registerCard } from "@/skills/CardRegistry";

interface XxxCardProps {
  data: {
    field1: string;
    field2: string;
  };
  onSubmit?: (answer: string) => void;  // 可选：用于交互式卡片
}

function XxxCard({ data, onSubmit }: XxxCardProps) {
  const { field1, field2 } = data;

  return (
    <div className="xxx-card ...">
      {/* 卡片内容 */}
    </div>
  );
}

// 注册到 CardRegistry
registerCard("xxx_card", XxxCard);

export default XxxCard;
```

### 3.2 在 initCards.ts 中导入

```tsx
// apps/web/src/skills/initCards.ts

// 导入即注册
import './xxx/cards';  // 会执行所有 registerCard 调用
```

### 3.3 CardRegistry API

```typescript
// 注册卡片
registerCard(cardType: string, Component: React.FC<any>): void

// 检查是否注册
CardRegistry.has(cardType: string): boolean

// 渲染卡片
CardRegistry.render(cardType: string, props: any): ReactNode
```

---

## 4. 交互式卡片

### 4.1 问答卡片 (QuestionCard)

```tsx
// QuestionCard.tsx
interface QuestionCardProps {
  data: {
    question: string;
    options?: string[];
  };
  onSubmit?: (answer: string) => void;
}

function QuestionCard({ data, onSubmit }: QuestionCardProps) {
  const [answer, setAnswer] = useState("");

  const handleSubmit = () => {
    onSubmit?.(answer);  // 发送到聊天
  };

  return (
    <div>
      <p>{data.question}</p>
      {data.options?.map(opt => (
        <button onClick={() => onSubmit?.(opt)}>{opt}</button>
      ))}
      <textarea value={answer} onChange={e => setAnswer(e.target.value)} />
      <button onClick={handleSubmit}>提交</button>
    </div>
  );
}
```

### 4.2 在 ChatMessage 中传递 onSubmit

```tsx
// ChatMessage.tsx → ToolCardRenderer

const handleQuestionSubmit = (answer: string) => {
  if (onSendMessage) {
    onSendMessage(answer);  // 发送到聊天 API
  }
};

const adaptedProps = cardType === 'question_card' ? {
  data: toolData,
  onSubmit: handleQuestionSubmit,
} : {
  // 其他卡片类型的 props
};

return CardRegistry.render(cardType, adaptedProps);
```

---

## 5. 常见卡片类型

| cardType | 用途 | 后端返回 |
|----------|------|---------|
| `collect_form` | 收集用户信息 | `{cardType, formType, fields}` |
| `question_card` | 问答交互 | `{cardType, question, options}` |
| `zodiac_chart` | 星盘展示 | `{componentId: "zodiac_chart", data}` |
| `bazi_chart` | 八字命盘 | `{componentId: "bazi_chart", data}` |
| `insight_card` | 洞察卡片 | `{cardType, title, points}` |
| `skill_intro` | Skill 介绍 | `{cardType, skillId, variant}` |
| `skill_list` | Skill 列表 | `{cardType, skills}` |

---

## 6. 调试技巧

### 6.1 检查卡片是否注册

```tsx
// 在浏览器控制台
import { getRegisteredCardTypes } from '@/skills/CardRegistry';
console.log(getRegisteredCardTypes());
```

### 6.2 检查工具返回

查看 API 日志中的工具返回值：
```
[PERF Agent] Tool calculate_zodiac: 123ms
```

### 6.3 检查 SSE 流

在浏览器开发者工具 Network 面板查看 SSE 响应：
```
0:"[[TOOL:calculate_zodiac:{\"cardType\":\"custom\",\"componentId\":\"zodiac_chart\",...}]]"
```

---

## 7. 检查清单

创建新卡片时：

- [ ] 在 `apps/web/src/skills/{skill}/cards/` 创建组件
- [ ] 调用 `registerCard(cardType, Component)`
- [ ] 在 `initCards.ts` 中导入卡片目录
- [ ] 后端工具返回正确的 `cardType` 或 `componentId`
- [ ] 如果是交互式卡片，实现 `onSubmit` 回调
- [ ] 测试卡片在聊天中正常显示
