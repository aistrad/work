-- Migration 018: Unified Usage Events Table for Billing
-- 统一用量表，支持计费

-- ═══════════════════════════════════════════════════════════════
-- 1. 新建统一用量表
-- ═══════════════════════════════════════════════════════════════

CREATE TABLE IF NOT EXISTS usage_events (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL,

    -- 事件类型: llm_call, skill_use, tool_call, conversation
    event_type VARCHAR(20) NOT NULL,

    -- LLM 维度
    model VARCHAR(50),
    input_tokens INT DEFAULT 0,
    output_tokens INT DEFAULT 0,
    estimated_cost DECIMAL(10,6) DEFAULT 0,

    -- Skill 维度
    skill_id VARCHAR(30),

    -- Tool 维度
    tool_name VARCHAR(50),

    -- 会话关联
    conversation_id UUID,

    -- 通用元数据
    metadata JSONB,

    created_at TIMESTAMP DEFAULT NOW()
);

-- 索引优化
CREATE INDEX IF NOT EXISTS idx_usage_events_user_date
    ON usage_events(user_id, created_at);

CREATE INDEX IF NOT EXISTS idx_usage_events_type
    ON usage_events(event_type, created_at);

CREATE INDEX IF NOT EXISTS idx_usage_events_skill
    ON usage_events(skill_id, created_at) WHERE skill_id IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_usage_events_billing
    ON usage_events(user_id, event_type, created_at);

-- 月度汇总索引 (计费查询优化)
CREATE INDEX IF NOT EXISTS idx_usage_events_monthly
    ON usage_events(user_id, DATE_TRUNC('month', created_at));

-- ═══════════════════════════════════════════════════════════════
-- 2. 废弃旧表 (添加 _deprecated 后缀，保留数据)
-- ═══════════════════════════════════════════════════════════════

-- 重命名旧表而非删除，保留历史数据
ALTER TABLE IF EXISTS user_usage RENAME TO user_usage_deprecated;
ALTER TABLE IF EXISTS usage_records RENAME TO usage_records_deprecated;

-- ═══════════════════════════════════════════════════════════════
-- 3. 注释
-- ═══════════════════════════════════════════════════════════════

COMMENT ON TABLE usage_events IS '统一用量事件表 - 支持 LLM/Skill/Tool 计费';
COMMENT ON COLUMN usage_events.event_type IS 'llm_call=LLM调用, skill_use=技能使用, tool_call=工具调用, conversation=对话';
COMMENT ON COLUMN usage_events.estimated_cost IS '估算成本 (USD)';
