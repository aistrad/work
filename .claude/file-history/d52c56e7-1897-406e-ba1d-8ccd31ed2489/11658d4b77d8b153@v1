"""
UsageTracker - 简化版使用量追踪器 (内存)
实际持久化由 UsageService 处理
"""
from dataclasses import dataclass, field
from typing import Any, Dict, List, Optional


@dataclass
class UsageSummary:
    """使用量摘要"""
    llm_calls: int = 0
    input_tokens: int = 0
    output_tokens: int = 0
    tool_calls: Dict[str, int] = field(default_factory=dict)
    estimated_cost: float = 0.0

    def to_dict(self) -> Dict[str, Any]:
        return {
            "llm_calls": self.llm_calls,
            "input_tokens": self.input_tokens,
            "output_tokens": self.output_tokens,
            "total_tokens": self.input_tokens + self.output_tokens,
            "tool_calls": self.tool_calls,
            "estimated_cost": round(self.estimated_cost, 6)
        }


class UsageTracker:
    """内存使用量追踪器 (用于单次请求)"""

    def __init__(self):
        self.summary = UsageSummary()

    def record_llm_call(self, response) -> None:
        """记录 LLM 调用"""
        self.summary.llm_calls += 1

        usage = getattr(response, "usage", None) or {}
        input_tokens = usage.get("input_tokens", 0) or usage.get("prompt_tokens", 0)
        output_tokens = usage.get("output_tokens", 0) or usage.get("completion_tokens", 0)

        self.summary.input_tokens += input_tokens
        self.summary.output_tokens += output_tokens

    def record_llm_call_simple(self, model: str = "default") -> None:
        """记录 LLM 调用 (简化版，流式模式)"""
        self.summary.llm_calls += 1

    def record_tool_call(self, tool_name: str) -> None:
        """记录工具调用"""
        if tool_name not in self.summary.tool_calls:
            self.summary.tool_calls[tool_name] = 0
        self.summary.tool_calls[tool_name] += 1

    def get_summary(self) -> Dict[str, Any]:
        """获取使用量摘要"""
        return self.summary.to_dict()

    def merge(self, other: "UsageTracker") -> None:
        """合并另一个 UsageTracker"""
        self.summary.llm_calls += other.summary.llm_calls
        self.summary.input_tokens += other.summary.input_tokens
        self.summary.output_tokens += other.summary.output_tokens

        for tool_name, count in other.summary.tool_calls.items():
            if tool_name not in self.summary.tool_calls:
                self.summary.tool_calls[tool_name] = 0
            self.summary.tool_calls[tool_name] += count


class AggregatedUsageTracker:
    """聚合使用量追踪器 (用于 Orchestrator)"""

    def __init__(self):
        self.trackers: Dict[str, UsageTracker] = {}
        self.total = UsageTracker()

    def add_tracker(self, agent_id: str, tracker: UsageTracker) -> None:
        """添加一个 Agent 的追踪器"""
        self.trackers[agent_id] = tracker
        self.total.merge(tracker)

    def get_by_agent(self, agent_id: str) -> Optional[Dict[str, Any]]:
        """获取指定 Agent 的使用量"""
        tracker = self.trackers.get(agent_id)
        return tracker.get_summary() if tracker else None

    def get_total(self) -> Dict[str, Any]:
        """获取总使用量"""
        return self.total.get_summary()
