# VibeLife è®¢é˜…ä¸æƒé™ç³»ç»Ÿæ¶æ„è®¾è®¡

> **ç‰ˆæœ¬**: v1.0
> **æ—¥æœŸ**: 2026-01-15
> **çŠ¶æ€**: è®¾è®¡æ–‡æ¡£

---

## ä¸€ã€ç°çŠ¶åˆ†æ

### 1.1 ç°æœ‰ç»„ä»¶æ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç°æœ‰è®¢é˜…/æƒé™ç›¸å…³ç»„ä»¶                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  services/                                                                      â”‚
â”‚  â”œâ”€â”€ billing/                                                                   â”‚
â”‚  â”‚   â”œâ”€â”€ subscription.py       # SubscriptionService (480è¡Œï¼ŒåŠŸèƒ½å®Œæ•´)          â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ create_prepaid_subscription()     âœ… å·²å®ç°                       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ create_stripe_subscription()      âœ… å·²å®ç°                       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ check_expiring_subscriptions()    âœ… å·²å®ç°                       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ expire_overdue_subscriptions()    âœ… å·²å®ç°                       â”‚
â”‚  â”‚   â”‚   â””â”€â”€ check_feature_access()            âœ… å·²å®ç°                       â”‚
â”‚  â”‚   â”‚                                                                         â”‚
â”‚  â”‚   â””â”€â”€ stripe_service.py     # Stripe API å°è£…                               â”‚
â”‚  â”‚                                                                             â”‚
â”‚  â”œâ”€â”€ entitlement/                                                              â”‚
â”‚  â”‚   â””â”€â”€ service.py            # EntitlementService (157è¡Œ)                    â”‚
â”‚  â”‚       â”œâ”€â”€ get_entitlements()               âœ… å·²å®ç°                        â”‚
â”‚  â”‚       â”œâ”€â”€ check_can_chat()                 âœ… å·²å®ç°                        â”‚
â”‚  â”‚       â”œâ”€â”€ consume_conversation()           âœ… å·²å®ç°                        â”‚
â”‚  â”‚       â”œâ”€â”€ upgrade_to_paid()                âœ… å·²å®ç°                        â”‚
â”‚  â”‚       â””â”€â”€ downgrade_to_free()              âœ… å·²å®ç°                        â”‚
â”‚  â”‚                                                                             â”‚
â”‚  â””â”€â”€ identity/                                                                 â”‚
â”‚      â””â”€â”€ usage_limits.py       # UsageLimitsService (137è¡Œ)                    â”‚
â”‚          â”œâ”€â”€ check_limit()                    âœ… å·²å®ç°                        â”‚
â”‚          â”œâ”€â”€ record_usage()                   âœ… å·²å®ç°                        â”‚
â”‚          â””â”€â”€ get_all_limits()                 âœ… å·²å®ç°                        â”‚
â”‚                                                                                â”‚
â”‚  stores/                                                                       â”‚
â”‚  â”œâ”€â”€ subscription_repo.py      # SubscriptionRepository (260è¡Œ)                â”‚
â”‚  â””â”€â”€ usage_repo.py             # UsageRepository                               â”‚
â”‚                                                                                â”‚
â”‚  routes/                                                                       â”‚
â”‚  â””â”€â”€ payment.py                # Webhook handlers (905è¡Œ)                      â”‚
â”‚      â””â”€â”€ _handle_checkout_completed()  âš ï¸ æœªè°ƒç”¨ SubscriptionService           â”‚
â”‚                                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒé—®é¢˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ ¸å¿ƒé—®é¢˜è¯Šæ–­                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  ğŸ”´ é—®é¢˜1: Webhook æ–­é“¾                                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä½ç½®: routes/payment.py:743-779                                                â”‚
â”‚                                                                                 â”‚
â”‚  ç°çŠ¶ä»£ç :                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  async def _handle_checkout_completed(session):                             â”‚â”‚
â”‚  â”‚      # ...                                                                  â”‚â”‚
â”‚  â”‚      if region == "CN":                                                     â”‚â”‚
â”‚  â”‚          logger.info(f"Prepaid activation: user={user_id}, ...")            â”‚â”‚
â”‚  â”‚          # TODO: Update user subscription in database        <-- âš ï¸ æœªå®ç°  â”‚â”‚
â”‚  â”‚          # await subscription_repo.create_or_extend_prepaid(...)            â”‚â”‚
â”‚  â”‚      else:                                                                  â”‚â”‚
â”‚  â”‚          logger.info(f"Subscription activation: user={user_id}, ...")       â”‚â”‚
â”‚  â”‚          # TODO: Update user subscription in database        <-- âš ï¸ æœªå®ç°  â”‚â”‚
â”‚  â”‚          # await subscription_repo.create_subscription(...)                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  å½±å“: ç”¨æˆ·ä»˜æ¬¾æˆåŠŸä½†æ•°æ®åº“æ— è®°å½•ï¼Œæƒé™æ— æ³•ç”Ÿæ•ˆ                                    â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”´ é—®é¢˜2: æœåŠ¡èŒè´£é‡å                                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  SubscriptionService          EntitlementService        UsageLimitsService  â”‚â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚â”‚
â”‚  â”‚  Â· è®¢é˜…åˆ›å»º/ç»­æœŸ              Â· æ¯æ—¥å¯¹è¯é™åˆ¶            Â· å¤šç±»å‹ä½¿ç”¨é™åˆ¶      â”‚â”‚
â”‚  â”‚  Â· è®¢é˜…çŠ¶æ€ç®¡ç†               Â· tier ç®¡ç†               Â· ä»˜è´¹ç”¨æˆ·æ£€æŸ¥        â”‚â”‚
â”‚  â”‚  Â· åˆ°æœŸæ£€æŸ¥                   Â· upgrade/downgrade       Â· ä½¿ç”¨é‡è®°å½•          â”‚â”‚
â”‚  â”‚  Â· Stripe åŒæ­¥                                                              â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  é‡å ç‚¹:                                                                    â”‚â”‚
â”‚  â”‚  Â· éƒ½æœ‰ "ä»˜è´¹ç”¨æˆ·æ£€æŸ¥" é€»è¾‘                                                 â”‚â”‚
â”‚  â”‚  Â· éƒ½æ¶‰åŠ "æ¯æ—¥é™åˆ¶" æ¦‚å¿µ                                                   â”‚â”‚
â”‚  â”‚  Â· æ•°æ®æ¥æºä¸ç»Ÿä¸€ (subscriptions vs user_entitlements vs user_usage)        â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”´ é—®é¢˜3: CurrentUser ç¼ºå°‘æƒé™ä¿¡æ¯                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  ç°çŠ¶ (services/identity/auth.py:25-41):                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  class CurrentUser:                                                         â”‚â”‚
â”‚  â”‚      user_id: UUID                                                          â”‚â”‚
â”‚  â”‚      vibe_id: str                                                           â”‚â”‚
â”‚  â”‚      display_name: Optional[str]                                            â”‚â”‚
â”‚  â”‚      email: Optional[str]                                                   â”‚â”‚
â”‚  â”‚      # âŒ æ—  tier                                                           â”‚â”‚
â”‚  â”‚      # âŒ æ—  subscription                                                   â”‚â”‚
â”‚  â”‚      # âŒ æ—  can() æ–¹æ³•                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  å½±å“: æ¯ä¸ªéœ€è¦æ£€æŸ¥æƒé™çš„ endpoint éƒ½è¦å•ç‹¬æŸ¥è¯¢è®¢é˜…çŠ¶æ€                            â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ç›®æ ‡æ¶æ„è®¾è®¡

### 2.1 æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç›®æ ‡æ¶æ„: åˆ†å±‚èŒè´£æ¸…æ™°                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                          API Layer (Routes)                                 â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  routes/auth.py     routes/payment.py     routes/chat.py    routes/...     â”‚â”‚
â”‚  â”‚       â”‚                    â”‚                    â”‚                          â”‚â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚â”‚
â”‚  â”‚                            â”‚                                               â”‚â”‚
â”‚  â”‚                            â–¼                                               â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚  â”‚  â”‚                    CurrentUser (Enriched)                           â”‚   â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚   â”‚â”‚
â”‚  â”‚  â”‚  user_id, vibe_id, display_name                                    â”‚   â”‚â”‚
â”‚  â”‚  â”‚  tier: "guest" | "free" | "premium"                                â”‚   â”‚â”‚
â”‚  â”‚  â”‚  subscription: Optional[Subscription]                              â”‚   â”‚â”‚
â”‚  â”‚  â”‚  can(feature) -> bool                                              â”‚   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                       Service Layer (Business Logic)                        â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚â”‚
â”‚  â”‚  â”‚   SubscriptionService    â”‚  â”‚    EntitlementService    â”‚                â”‚â”‚
â”‚  â”‚  â”‚   (è®¢é˜…ç”Ÿå‘½å‘¨æœŸç®¡ç†)      â”‚  â”‚    (æƒé™æ£€æŸ¥ç»Ÿä¸€å…¥å£)     â”‚                â”‚â”‚
â”‚  â”‚  â”‚                          â”‚  â”‚                          â”‚                â”‚â”‚
â”‚  â”‚  â”‚  Â· create_prepaid()      â”‚  â”‚  Â· get_user_tier()       â”‚                â”‚â”‚
â”‚  â”‚  â”‚  Â· create_subscription() â”‚  â”‚  Â· check_feature()       â”‚                â”‚â”‚
â”‚  â”‚  â”‚  Â· extend_prepaid()      â”‚  â”‚  Â· check_usage_limit()   â”‚                â”‚â”‚
â”‚  â”‚  â”‚  Â· cancel()              â”‚  â”‚  Â· consume_usage()       â”‚                â”‚â”‚
â”‚  â”‚  â”‚  Â· sync_stripe()         â”‚  â”‚  Â· get_remaining()       â”‚                â”‚â”‚
â”‚  â”‚  â”‚  Â· get_expiring()        â”‚  â”‚                          â”‚                â”‚â”‚
â”‚  â”‚  â”‚  Â· expire_overdue()      â”‚  â”‚                          â”‚                â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚â”‚
â”‚  â”‚              â”‚                             â”‚                               â”‚â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚â”‚
â”‚  â”‚                             â”‚                                              â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚â”‚
â”‚  â”‚  â”‚                   NotificationService                   â”‚               â”‚â”‚
â”‚  â”‚  â”‚                   (ç»Ÿä¸€é€šçŸ¥å‡ºå£)                         â”‚               â”‚â”‚
â”‚  â”‚  â”‚                                                         â”‚               â”‚â”‚
â”‚  â”‚  â”‚  Â· send_email(to, template, data)                      â”‚               â”‚â”‚
â”‚  â”‚  â”‚  Â· send_push(user_id, title, body)                     â”‚               â”‚â”‚
â”‚  â”‚  â”‚  Â· send_renewal_reminder(user_id, days_left)           â”‚               â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                       â”‚                                         â”‚
â”‚                                       â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                        Data Layer (Repositories)                            â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚â”‚
â”‚  â”‚  â”‚SubscriptionRepo  â”‚  â”‚ EntitlementRepo  â”‚  â”‚    UsageRepo     â”‚          â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚          â”‚â”‚
â”‚  â”‚  â”‚ Â· subscriptions  â”‚  â”‚ Â· user_          â”‚  â”‚ Â· user_usage     â”‚          â”‚â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚   entitlements   â”‚  â”‚                  â”‚          â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ•°æ®æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ ¸å¿ƒæ•°æ®æ¨¡å‹è®¾è®¡                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                        subscriptions è¡¨ (ç°æœ‰)                              â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  id                    UUID PRIMARY KEY                                     â”‚â”‚
â”‚  â”‚  user_id               UUID FK â†’ vibe_users                                 â”‚â”‚
â”‚  â”‚  plan_code             VARCHAR  -- cn_1m, cn_3m, global_monthly, etc       â”‚â”‚
â”‚  â”‚  status                VARCHAR  -- active, expired, cancelled, suspended   â”‚â”‚
â”‚  â”‚  vip_type              VARCHAR  -- prepaid, subscription                   â”‚â”‚
â”‚  â”‚  region                VARCHAR  -- CN, GLOBAL                              â”‚â”‚
â”‚  â”‚  started_at            TIMESTAMPTZ                                         â”‚â”‚
â”‚  â”‚  expires_at            TIMESTAMPTZ  -- é¢„ä»˜åˆ°æœŸæ—¶é—´ / è®¢é˜…å‘¨æœŸç»“æŸæ—¶é—´       â”‚â”‚
â”‚  â”‚  stripe_subscription_id VARCHAR  -- è®¢é˜…æ¨¡å¼ä¸“ç”¨                            â”‚â”‚
â”‚  â”‚  stripe_customer_id    VARCHAR  -- è®¢é˜…æ¨¡å¼ä¸“ç”¨                             â”‚â”‚
â”‚  â”‚  payment_failed_count  INT DEFAULT 0  -- ç»­è´¹å¤±è´¥è®¡æ•°                       â”‚â”‚
â”‚  â”‚  source                VARCHAR  -- payment, admin, promotion               â”‚â”‚
â”‚  â”‚  created_at            TIMESTAMPTZ DEFAULT NOW()                           â”‚â”‚
â”‚  â”‚  updated_at            TIMESTAMPTZ DEFAULT NOW()                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                     user_entitlements è¡¨ (ç°æœ‰)                             â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  id                    UUID PRIMARY KEY                                     â”‚â”‚
â”‚  â”‚  user_id               UUID FK â†’ vibe_users UNIQUE                          â”‚â”‚
â”‚  â”‚  tier                  VARCHAR  -- free, paid                              â”‚â”‚
â”‚  â”‚  daily_conversations_limit  INT                                             â”‚â”‚
â”‚  â”‚  daily_conversations_used   INT DEFAULT 0                                   â”‚â”‚
â”‚  â”‚  daily_reset_at        DATE  -- æ¯æ—¥é‡ç½®æ—¥æœŸ                                â”‚â”‚
â”‚  â”‚  subscription_expires_at TIMESTAMPTZ  -- å†—ä½™å­—æ®µï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥è¯¢              â”‚â”‚
â”‚  â”‚  created_at            TIMESTAMPTZ DEFAULT NOW()                           â”‚â”‚
â”‚  â”‚  updated_at            TIMESTAMPTZ DEFAULT NOW()                           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                        user_usage è¡¨ (ç°æœ‰)                                 â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  id                    UUID PRIMARY KEY                                     â”‚â”‚
â”‚  â”‚  user_id               UUID FK â†’ vibe_users                                 â”‚â”‚
â”‚  â”‚  usage_type            VARCHAR  -- chat_message, relationship_analysis, etcâ”‚â”‚
â”‚  â”‚  count                 INT DEFAULT 0                                        â”‚â”‚
â”‚  â”‚  period_start          DATE                                                 â”‚â”‚
â”‚  â”‚  period_type           VARCHAR  -- daily, monthly, total                   â”‚â”‚
â”‚  â”‚  UNIQUE(user_id, usage_type, period_start, period_type)                    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å…³ç³»ä¸èŒè´£è¾¹ç•Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            èŒè´£è¾¹ç•Œåˆ’åˆ†                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SubscriptionService (è®¢é˜…ç”Ÿå‘½å‘¨æœŸ)                                       â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  èŒè´£:                                                                   â”‚  â”‚
â”‚  â”‚  Â· è®¢é˜…çš„åˆ›å»ºã€ç»­æœŸã€å–æ¶ˆã€è¿‡æœŸ                                           â”‚  â”‚
â”‚  â”‚  Â· åŒè½¨åˆ¶é€»è¾‘ (é¢„ä»˜ vs è®¢é˜…)                                              â”‚  â”‚
â”‚  â”‚  Â· Stripe çŠ¶æ€åŒæ­¥                                                       â”‚  â”‚
â”‚  â”‚  Â· åˆ°æœŸæ£€æŸ¥ (ä¾›å®šæ—¶ä»»åŠ¡è°ƒç”¨)                                              â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  ä¸è´Ÿè´£:                                                                  â”‚  â”‚
â”‚  â”‚  Â· âŒ æƒé™æ£€æŸ¥ (ç”± EntitlementService)                                   â”‚  â”‚
â”‚  â”‚  Â· âŒ ä½¿ç”¨é‡ç»Ÿè®¡ (ç”± EntitlementService)                                 â”‚  â”‚
â”‚  â”‚  Â· âŒ å‘é€é€šçŸ¥ (ç”± NotificationService)                                  â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  è§¦å‘è”åŠ¨:                                                                â”‚  â”‚
â”‚  â”‚  Â· åˆ›å»ºè®¢é˜… â†’ è°ƒç”¨ EntitlementService.upgrade_to_paid()                  â”‚  â”‚
â”‚  â”‚  Â· è®¢é˜…è¿‡æœŸ â†’ è°ƒç”¨ EntitlementService.downgrade_to_free()                â”‚  â”‚
â”‚  â”‚  Â· å³å°†åˆ°æœŸ â†’ è°ƒç”¨ NotificationService.send_renewal_reminder()           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  EntitlementService (æƒé™ä¸é…é¢)                                          â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  èŒè´£:                                                                   â”‚  â”‚
â”‚  â”‚  Â· ç”¨æˆ· tier ç®¡ç† (guest/free/premium)                                   â”‚  â”‚
â”‚  â”‚  Â· æ¯æ—¥å¯¹è¯é™é¢æ£€æŸ¥ä¸æ¶ˆè´¹                                                 â”‚  â”‚
â”‚  â”‚  Â· åŠŸèƒ½æƒé™æ£€æŸ¥ (can_use_feature)                                        â”‚  â”‚
â”‚  â”‚  Â· ä½¿ç”¨é‡è®°å½•ä¸æŸ¥è¯¢                                                       â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  ä¸è´Ÿè´£:                                                                  â”‚  â”‚
â”‚  â”‚  Â· âŒ è®¢é˜…åˆ›å»º/ç»­æœŸ (ç”± SubscriptionService)                             â”‚  â”‚
â”‚  â”‚  Â· âŒ æ”¯ä»˜å¤„ç† (ç”± payment route)                                        â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  æ•°æ®æº:                                                                  â”‚  â”‚
â”‚  â”‚  Â· user_entitlements (tier, daily_limit)                                 â”‚  â”‚
â”‚  â”‚  Â· user_usage (å„ç±»ä½¿ç”¨é‡)                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  NotificationService (é€šçŸ¥å‘é€)                                           â”‚  â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  èŒè´£:                                                                   â”‚  â”‚
â”‚  â”‚  Â· é‚®ä»¶å‘é€ (å¯†ç é‡ç½®ã€ç»­è´¹æé†’ã€å‘¨æŠ¥)                                    â”‚  â”‚
â”‚  â”‚  Â· App å†…æ¨é€ (è¿åŠ¿æé†’ã€åˆ°æœŸæé†’)                                        â”‚  â”‚
â”‚  â”‚  Â· æœªæ¥: çŸ­ä¿¡ã€å¾®ä¿¡æœåŠ¡å·                                                 â”‚  â”‚
â”‚  â”‚                                                                          â”‚  â”‚
â”‚  â”‚  ä¸è´Ÿè´£:                                                                  â”‚  â”‚
â”‚  â”‚  Â· âŒ å†³å®šä½•æ—¶å‘é€ (ç”±è°ƒç”¨æ–¹å†³å®š)                                        â”‚  â”‚
â”‚  â”‚  Â· âŒ å†…å®¹ç”Ÿæˆ (æ¥æ”¶æ¸²æŸ“å¥½çš„å†…å®¹)                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ ¸å¿ƒç±»è®¾è®¡

### 3.1 Subscription æ•°æ®ç±»

```python
# services/subscription/models.py

from dataclasses import dataclass
from datetime import datetime
from typing import Optional, Literal
from uuid import UUID


SubscriptionStatus = Literal["active", "expired", "cancelled", "suspended"]
VipType = Literal["prepaid", "subscription"]
Region = Literal["CN", "GLOBAL"]


@dataclass
class Subscription:
    """è®¢é˜…æ•°æ®ç±»"""
    id: UUID
    user_id: UUID
    plan_code: str           # cn_1m, cn_3m, global_monthly, etc
    status: SubscriptionStatus
    vip_type: VipType
    region: Region
    started_at: datetime
    expires_at: datetime
    stripe_subscription_id: Optional[str] = None
    stripe_customer_id: Optional[str] = None
    payment_failed_count: int = 0

    @property
    def is_active(self) -> bool:
        return self.status == "active" and self.expires_at > datetime.now()

    @property
    def is_prepaid(self) -> bool:
        return self.vip_type == "prepaid"

    @property
    def days_until_expiry(self) -> int:
        if self.expires_at < datetime.now():
            return 0
        return (self.expires_at - datetime.now()).days


@dataclass
class UserTier:
    """ç”¨æˆ·å±‚çº§æ•°æ®ç±»"""
    tier: Literal["guest", "free", "premium"]
    daily_limit: int
    daily_used: int
    subscription: Optional[Subscription] = None

    @property
    def daily_remaining(self) -> int:
        if self.tier == "premium":
            return -1  # Unlimited
        return max(0, self.daily_limit - self.daily_used)

    @property
    def is_premium(self) -> bool:
        return self.tier == "premium"
```

### 3.2 CurrentUser å¢å¼º

```python
# services/identity/auth.py (ä¿®æ”¹)

from dataclasses import dataclass
from typing import Optional, Literal
from uuid import UUID

from services.subscription.models import Subscription


# åŠŸèƒ½æƒé™é…ç½®
FREE_FEATURES = {
    "basic_chat",
    "daily_fortune",
    "basic_chart",
}

PREMIUM_FEATURES = {
    "unlimited_chat",
    "full_report",
    "ai_poster",
    "relationship_analysis",
    "life_kline",
    "all_skills",
}


@dataclass
class CurrentUser:
    """å½“å‰ç”¨æˆ· (åŒ…å«æƒé™ä¿¡æ¯)"""
    user_id: UUID
    vibe_id: str
    display_name: Optional[str] = None
    email: Optional[str] = None

    # æ–°å¢å­—æ®µ
    tier: Literal["guest", "free", "premium"] = "free"
    subscription: Optional[Subscription] = None
    daily_remaining: int = 0

    def can(self, feature: str) -> bool:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥ä½¿ç”¨æŸåŠŸèƒ½"""
        if self.tier == "premium":
            return True
        if self.tier == "guest":
            return feature in {"basic_chat", "onboarding"}
        return feature in FREE_FEATURES

    def can_chat(self) -> bool:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦è¿˜èƒ½å¯¹è¯"""
        if self.tier == "premium":
            return True
        return self.daily_remaining > 0

    @property
    def is_premium(self) -> bool:
        return self.tier == "premium"

    @property
    def is_guest(self) -> bool:
        return self.tier == "guest"
```

### 3.3 SubscriptionService æ¥å£å®šä¹‰

```python
# services/subscription/subscription_service.py

from abc import ABC, abstractmethod
from datetime import datetime
from typing import Optional, List
from uuid import UUID

from .models import Subscription


class ISubscriptionService(ABC):
    """è®¢é˜…æœåŠ¡æ¥å£"""

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # æŸ¥è¯¢æ–¹æ³•
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def get_active(self, user_id: UUID) -> Optional[Subscription]:
        """è·å–ç”¨æˆ·å½“å‰æœ‰æ•ˆè®¢é˜…"""
        pass

    @abstractmethod
    async def get_history(self, user_id: UUID, limit: int = 10) -> List[Subscription]:
        """è·å–ç”¨æˆ·è®¢é˜…å†å²"""
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # åˆ›å»ºæ–¹æ³• (åŒè½¨åˆ¶)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def create_prepaid(
        self,
        user_id: UUID,
        plan_code: str,
        service_days: int,
        payment_session_id: str,
        region: str = "CN"
    ) -> Subscription:
        """
        åˆ›å»ºé¢„ä»˜è®¢é˜… (å¤§é™†/é¦™æ¸¯ç”¨æˆ·)

        - å¦‚æœ‰ç°æœ‰è®¢é˜…ï¼Œè‡ªåŠ¨å»¶æœŸ
        - è”åŠ¨: è°ƒç”¨ EntitlementService.upgrade_to_paid()
        """
        pass

    @abstractmethod
    async def create_subscription(
        self,
        user_id: UUID,
        plan_code: str,
        stripe_subscription_id: str,
        stripe_customer_id: str,
        current_period_end: datetime
    ) -> Subscription:
        """
        åˆ›å»º Stripe è®¢é˜… (æµ·å¤–ç”¨æˆ·)

        - è”åŠ¨: è°ƒç”¨ EntitlementService.upgrade_to_paid()
        """
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ç”Ÿå‘½å‘¨æœŸæ–¹æ³•
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def extend_prepaid(self, user_id: UUID, days: int) -> Subscription:
        """å»¶é•¿é¢„ä»˜è®¢é˜…"""
        pass

    @abstractmethod
    async def cancel(self, user_id: UUID) -> bool:
        """
        å–æ¶ˆè®¢é˜…

        - é¢„ä»˜: ç«‹å³æ ‡è®°ä¸º cancelled
        - è®¢é˜…: è°ƒç”¨ Stripe APIï¼Œå‘¨æœŸç»“æŸåå–æ¶ˆ
        - è”åŠ¨: åˆ°æœŸåè°ƒç”¨ EntitlementService.downgrade_to_free()
        """
        pass

    @abstractmethod
    async def suspend(self, stripe_subscription_id: str) -> bool:
        """æš‚åœè®¢é˜… (æ”¯ä»˜å¤±è´¥3æ¬¡å)"""
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Stripe åŒæ­¥æ–¹æ³•
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def sync_stripe_status(self, stripe_subscription_id: str) -> Optional[Subscription]:
        """ä» Stripe åŒæ­¥è®¢é˜…çŠ¶æ€"""
        pass

    @abstractmethod
    async def handle_payment_failed(self, stripe_subscription_id: str) -> int:
        """
        å¤„ç†æ”¯ä»˜å¤±è´¥

        è¿”å›: ç´¯è®¡å¤±è´¥æ¬¡æ•°
        - å¤±è´¥3æ¬¡ â†’ è°ƒç”¨ suspend()
        """
        pass

    @abstractmethod
    async def handle_payment_succeeded(self, stripe_subscription_id: str) -> None:
        """å¤„ç†æ”¯ä»˜æˆåŠŸ (é‡ç½®å¤±è´¥è®¡æ•°)"""
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # å®šæ—¶ä»»åŠ¡æ–¹æ³•
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def get_expiring_soon(self, days_before: int = 7) -> List[Subscription]:
        """
        è·å–å³å°†åˆ°æœŸçš„é¢„ä»˜è®¢é˜…

        ç”¨äº: ç»­è´¹æé†’å®šæ—¶ä»»åŠ¡
        """
        pass

    @abstractmethod
    async def expire_overdue(self) -> int:
        """
        å°†å·²è¿‡æœŸè®¢é˜…æ ‡è®°ä¸º expired

        ç”¨äº: æ¯æ—¥å®šæ—¶ä»»åŠ¡
        è¿”å›: å¤„ç†æ•°é‡
        - è”åŠ¨: è°ƒç”¨ EntitlementService.downgrade_to_free()
        """
        pass
```

### 3.4 EntitlementService æ¥å£å®šä¹‰

```python
# services/entitlement/entitlement_service.py

from abc import ABC, abstractmethod
from datetime import datetime
from typing import Optional, Dict, Any
from uuid import UUID

from services.subscription.models import UserTier


class IEntitlementService(ABC):
    """æƒé™æœåŠ¡æ¥å£"""

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ç”¨æˆ·å±‚çº§
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def get_user_tier(self, user_id: UUID) -> UserTier:
        """
        è·å–ç”¨æˆ·å±‚çº§ä¿¡æ¯

        è¿”å›: UserTier(tier, daily_limit, daily_used, subscription)
        """
        pass

    @abstractmethod
    async def upgrade_to_paid(self, user_id: UUID, expires_at: datetime) -> bool:
        """å‡çº§ä¸ºä»˜è´¹ç”¨æˆ·"""
        pass

    @abstractmethod
    async def downgrade_to_free(self, user_id: UUID) -> bool:
        """é™çº§ä¸ºå…è´¹ç”¨æˆ·"""
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # æƒé™æ£€æŸ¥
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def can_use_feature(self, user_id: UUID, feature: str) -> bool:
        """æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥ä½¿ç”¨æŸåŠŸèƒ½"""
        pass

    @abstractmethod
    async def check_can_chat(self, user_id: UUID) -> Dict[str, Any]:
        """
        æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å¯ä»¥å‘é€æ¶ˆæ¯

        è¿”å›: {"can_chat": bool, "remaining": int, "tier": str}
        """
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ä½¿ç”¨é‡ç®¡ç†
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def consume_chat(self, user_id: UUID) -> bool:
        """
        æ¶ˆè´¹ä¸€æ¬¡å¯¹è¯é…é¢

        è¿”å›: æ˜¯å¦æˆåŠŸ (å¤±è´¥è¡¨ç¤ºå·²è¾¾é™é¢)
        """
        pass

    @abstractmethod
    async def check_usage_limit(
        self,
        user_id: UUID,
        usage_type: str
    ) -> Dict[str, Any]:
        """
        æ£€æŸ¥æŸç±»ä½¿ç”¨é‡é™åˆ¶

        usage_type: chat_message, relationship_analysis, life_kline, report_generation
        è¿”å›: {"allowed": bool, "remaining": int, "limit": int, "is_premium": bool}
        """
        pass

    @abstractmethod
    async def record_usage(self, user_id: UUID, usage_type: str) -> None:
        """è®°å½•ä½¿ç”¨é‡"""
        pass

    @abstractmethod
    async def get_all_limits(self, user_id: UUID) -> Dict[str, Any]:
        """è·å–ç”¨æˆ·æ‰€æœ‰ä½¿ç”¨é‡é™åˆ¶"""
        pass
```

### 3.5 NotificationService æ¥å£å®šä¹‰

```python
# services/notification/notification_service.py

from abc import ABC, abstractmethod
from typing import Optional, Dict, Any
from uuid import UUID


class INotificationService(ABC):
    """é€šçŸ¥æœåŠ¡æ¥å£"""

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # é‚®ä»¶
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def send_email(
        self,
        to: str,
        template: str,
        data: Dict[str, Any],
        subject: Optional[str] = None
    ) -> bool:
        """
        å‘é€é‚®ä»¶

        template: password_reset, renewal_reminder, weekly_report, etc
        """
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # App æ¨é€
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def send_push(
        self,
        user_id: UUID,
        title: str,
        body: str,
        data: Optional[Dict[str, Any]] = None
    ) -> bool:
        """å‘é€ App å†…æ¨é€"""
        pass

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ä¸šåŠ¡åœºæ™¯å°è£…
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    @abstractmethod
    async def send_password_reset(self, email: str, reset_url: str) -> bool:
        """å‘é€å¯†ç é‡ç½®é‚®ä»¶"""
        pass

    @abstractmethod
    async def send_renewal_reminder(
        self,
        user_id: UUID,
        days_left: int,
        plan_name: str,
        renew_url: str
    ) -> bool:
        """
        å‘é€ç»­è´¹æé†’

        æ¸ é“: App æ¨é€ + é‚®ä»¶ (å¦‚æœ‰)
        """
        pass

    @abstractmethod
    async def send_subscription_expired(self, user_id: UUID) -> bool:
        """å‘é€è®¢é˜…åˆ°æœŸé€šçŸ¥"""
        pass

    @abstractmethod
    async def send_payment_failed(
        self,
        user_id: UUID,
        attempt_count: int
    ) -> bool:
        """å‘é€æ”¯ä»˜å¤±è´¥é€šçŸ¥"""
        pass
```

---

## å››ã€å…³é”®æµç¨‹è®¾è®¡

### 4.1 Webhook æ”¯ä»˜å®Œæˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Webhook: checkout.session.completed                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  Stripe                                                                         â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â”‚ POST /payment/webhook                                                     â”‚
â”‚    â”‚ event: checkout.session.completed                                         â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â–¼                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  routes/payment.py: _handle_checkout_completed(session)                 â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  1. è§£æ metadata: user_id, region, plan_code, service_days             â”‚   â”‚
â”‚  â”‚  2. æ›´æ–° payments è¡¨: status = 'success'                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â”‚                    region?                                                â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚    â”‚ CN (é¢„ä»˜)                                                   â”‚ GLOBAL     â”‚
â”‚    â–¼                                                             â”‚ (è®¢é˜…)     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚             â”‚
â”‚  â”‚  SubscriptionService.create_prepaid(                      â”‚   â”‚             â”‚
â”‚  â”‚      user_id,                                             â”‚   â”‚             â”‚
â”‚  â”‚      plan_code,                                           â”‚   â”‚             â”‚
â”‚  â”‚      service_days,                                        â”‚   â”‚             â”‚
â”‚  â”‚      session_id,                                          â”‚   â”‚             â”‚
â”‚  â”‚      region="CN"                                          â”‚   â”‚             â”‚
â”‚  â”‚  )                                                        â”‚   â”‚             â”‚
â”‚  â”‚                                                           â”‚   â”‚             â”‚
â”‚  â”‚  å†…éƒ¨é€»è¾‘:                                                â”‚   â”‚             â”‚
â”‚  â”‚  1. æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰è®¢é˜… â†’ å»¶æœŸ or æ–°å»º                      â”‚   â”‚             â”‚
â”‚  â”‚  2. å†™å…¥ subscriptions è¡¨                                 â”‚   â”‚             â”‚
â”‚  â”‚  3. è°ƒç”¨ EntitlementService.upgrade_to_paid()            â”‚   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚             â”‚
â”‚                                                                   â”‚             â”‚
â”‚                                                                   â–¼             â”‚
â”‚                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                                               â”‚ SubscriptionService.          â”‚â”‚
â”‚                                               â”‚   create_subscription(        â”‚â”‚
â”‚                                               â”‚     user_id,                  â”‚â”‚
â”‚                                               â”‚     plan_code,                â”‚â”‚
â”‚                                               â”‚     stripe_subscription_id,   â”‚â”‚
â”‚                                               â”‚     stripe_customer_id,       â”‚â”‚
â”‚                                               â”‚     current_period_end        â”‚â”‚
â”‚                                               â”‚ )                             â”‚â”‚
â”‚                                               â”‚                               â”‚â”‚
â”‚                                               â”‚ å†…éƒ¨é€»è¾‘:                     â”‚â”‚
â”‚                                               â”‚ 1. å†™å…¥ subscriptions è¡¨      â”‚â”‚
â”‚                                               â”‚ 2. è°ƒç”¨ EntitlementService.  â”‚â”‚
â”‚                                               â”‚    upgrade_to_paid()          â”‚â”‚
â”‚                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                                â”‚  EntitlementService.upgrade_to_paid(          â”‚â”‚
â”‚                                â”‚      user_id,                                 â”‚â”‚
â”‚                                â”‚      expires_at                               â”‚â”‚
â”‚                                â”‚  )                                            â”‚â”‚
â”‚                                â”‚                                               â”‚â”‚
â”‚                                â”‚  å†…éƒ¨é€»è¾‘:                                    â”‚â”‚
â”‚                                â”‚  1. æ›´æ–° user_entitlements.tier = 'paid'     â”‚â”‚
â”‚                                â”‚  2. æ›´æ–° daily_limit = 200                   â”‚â”‚
â”‚                                â”‚  3. æ›´æ–° subscription_expires_at              â”‚â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ¯æ—¥å®šæ—¶ä»»åŠ¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æ¯æ—¥å®šæ—¶ä»»åŠ¡ (å‡Œæ™¨ 3:00)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Task 1: è¿‡æœŸè®¢é˜…å¤„ç†                                                       â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  expired_count = await SubscriptionService.expire_overdue()                 â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  å†…éƒ¨é€»è¾‘:                                                                  â”‚â”‚
â”‚  â”‚  1. UPDATE subscriptions SET status='expired' WHERE expires_at < NOW()     â”‚â”‚
â”‚  â”‚  2. å¯¹æ¯ä¸ªè¿‡æœŸç”¨æˆ·:                                                         â”‚â”‚
â”‚  â”‚     await EntitlementService.downgrade_to_free(user_id)                    â”‚â”‚
â”‚  â”‚     await NotificationService.send_subscription_expired(user_id)           â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Task 2: ç»­è´¹æé†’ (7å¤©å†…åˆ°æœŸ)                                               â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  expiring_7d = await SubscriptionService.get_expiring_soon(days_before=7)  â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  for sub in expiring_7d:                                                    â”‚â”‚
â”‚  â”‚      if sub.days_until_expiry == 7:                                         â”‚â”‚
â”‚  â”‚          await NotificationService.send_renewal_reminder(                   â”‚â”‚
â”‚  â”‚              user_id=sub.user_id,                                           â”‚â”‚
â”‚  â”‚              days_left=7,                                                   â”‚â”‚
â”‚  â”‚              plan_name=sub.plan_code,                                       â”‚â”‚
â”‚  â”‚              renew_url=f"https://vibelife.app/pricing?renew={sub.id}"       â”‚â”‚
â”‚  â”‚          )                                                                  â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Task 3: ç»­è´¹æé†’ (3å¤©å†…åˆ°æœŸï¼Œå«ä¼˜æƒ )                                        â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  expiring_3d = await SubscriptionService.get_expiring_soon(days_before=3)  â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  for sub in expiring_3d:                                                    â”‚â”‚
â”‚  â”‚      if sub.days_until_expiry <= 3:                                         â”‚â”‚
â”‚  â”‚          await NotificationService.send_renewal_reminder(                   â”‚â”‚
â”‚  â”‚              user_id=sub.user_id,                                           â”‚â”‚
â”‚  â”‚              days_left=sub.days_until_expiry,                               â”‚â”‚
â”‚  â”‚              plan_name=sub.plan_code,                                       â”‚â”‚
â”‚  â”‚              renew_url=f"https://vibelife.app/pricing?renew={sub.id}&promo=1"â”‚
â”‚  â”‚          )                                                                  â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Task 4: Stripe è®¢é˜…çŠ¶æ€åŒæ­¥                                                â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  stripe_subs = await SubscriptionService.get_all_stripe_subscriptions()    â”‚â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â”‚  for sub in stripe_subs:                                                    â”‚â”‚
â”‚  â”‚      await SubscriptionService.sync_stripe_status(sub.stripe_subscription_id)â”‚
â”‚  â”‚                                                                             â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 API è¯·æ±‚æƒé™æ£€æŸ¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           API è¯·æ±‚æƒé™æ£€æŸ¥æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  Client                                                                         â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â”‚ GET /api/v1/chat/message                                                  â”‚
â”‚    â”‚ Authorization: Bearer <access_token>                                      â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â–¼                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FastAPI Dependency: get_current_user_with_entitlements()               â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  1. éªŒè¯ JWT â†’ è·å– user_id, vibe_id                                    â”‚   â”‚
â”‚  â”‚  2. æŸ¥è¯¢ user åŸºæœ¬ä¿¡æ¯                                                  â”‚   â”‚
â”‚  â”‚  3. è°ƒç”¨ EntitlementService.get_user_tier(user_id)                     â”‚   â”‚
â”‚  â”‚  4. æ„é€  CurrentUser(                                                   â”‚   â”‚
â”‚  â”‚         user_id, vibe_id, display_name,                                â”‚   â”‚
â”‚  â”‚         tier, subscription, daily_remaining                            â”‚   â”‚
â”‚  â”‚     )                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚    â”‚                                                                           â”‚
â”‚    â–¼                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Route Handler: send_message()                                          â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  async def send_message(                                                â”‚   â”‚
â”‚  â”‚      current_user: CurrentUser = Depends(get_current_user_with_entitlements)â”‚
â”‚  â”‚  ):                                                                     â”‚   â”‚
â”‚  â”‚      # æ–¹å¼1: ä½¿ç”¨ CurrentUser.can() æ–¹æ³•                               â”‚   â”‚
â”‚  â”‚      if not current_user.can("unlimited_chat"):                        â”‚   â”‚
â”‚  â”‚          if not current_user.can_chat():                               â”‚   â”‚
â”‚  â”‚              raise HTTPException(403, "Daily limit reached")           â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚      # æ–¹å¼2: ç›´æ¥æ£€æŸ¥ tier                                             â”‚   â”‚
â”‚  â”‚      if current_user.tier == "guest":                                  â”‚   â”‚
â”‚  â”‚          raise HTTPException(401, "Please register")                   â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚      # æ¶ˆè´¹é…é¢                                                         â”‚   â”‚
â”‚  â”‚      if not current_user.is_premium:                                   â”‚   â”‚
â”‚  â”‚          await EntitlementService.consume_chat(current_user.user_id)   â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚      # å¤„ç†ä¸šåŠ¡é€»è¾‘...                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å®æ–½è®¡åˆ’

### 5.1 æ–‡ä»¶å˜æ›´æ¸…å•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®æ–½æ–‡ä»¶æ¸…å•                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  æ–°å»ºæ–‡ä»¶                                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  services/subscription/                                                         â”‚
â”‚  â”œâ”€â”€ __init__.py                                                               â”‚
â”‚  â”œâ”€â”€ models.py                 # Subscription, UserTier æ•°æ®ç±»                  â”‚
â”‚  â””â”€â”€ subscription_service.py   # SubscriptionService å®ç°                       â”‚
â”‚                                (åˆå¹¶ç°æœ‰ billing/subscription.py åŠŸèƒ½)          â”‚
â”‚                                                                                 â”‚
â”‚  services/notification/                                                         â”‚
â”‚  â”œâ”€â”€ __init__.py                                                               â”‚
â”‚  â”œâ”€â”€ notification_service.py   # NotificationService æ¥å£ä¸å®ç°                 â”‚
â”‚  â”œâ”€â”€ email_provider.py         # é‚®ä»¶å‘é€ (Resend/SendGrid)                    â”‚
â”‚  â””â”€â”€ templates/                # é‚®ä»¶æ¨¡æ¿                                       â”‚
â”‚      â”œâ”€â”€ password_reset.html                                                   â”‚
â”‚      â”œâ”€â”€ renewal_reminder.html                                                 â”‚
â”‚      â””â”€â”€ subscription_expired.html                                             â”‚
â”‚                                                                                 â”‚
â”‚  workers/subscription_tasks.py  # å®šæ—¶ä»»åŠ¡ (åˆ°æœŸå¤„ç†ã€ç»­è´¹æé†’)                  â”‚
â”‚                                                                                 â”‚
â”‚  ä¿®æ”¹æ–‡ä»¶                                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  services/identity/auth.py                                                      â”‚
â”‚  â””â”€â”€ æ‰©å±• CurrentUser ç±»ï¼Œæ·»åŠ  tier, subscription, can() æ–¹æ³•                  â”‚
â”‚                                                                                 â”‚
â”‚  services/identity/__init__.py                                                  â”‚
â”‚  â””â”€â”€ æ–°å¢ get_current_user_with_entitlements å¯¼å‡º                              â”‚
â”‚                                                                                 â”‚
â”‚  services/entitlement/service.py                                                â”‚
â”‚  â””â”€â”€ ç®€åŒ–ï¼Œç§»é™¤ä¸ SubscriptionService é‡å çš„é€»è¾‘                                â”‚
â”‚                                                                                 â”‚
â”‚  routes/payment.py                                                              â”‚
â”‚  â””â”€â”€ _handle_checkout_completed() è°ƒç”¨ SubscriptionService                     â”‚
â”‚  â””â”€â”€ _handle_subscription_* è°ƒç”¨ SubscriptionService                           â”‚
â”‚                                                                                 â”‚
â”‚  routes/auth.py                                                                 â”‚
â”‚  â””â”€â”€ request_password_reset() è°ƒç”¨ NotificationService.send_password_reset()  â”‚
â”‚                                                                                 â”‚
â”‚  scripts/crontab.example                                                        â”‚
â”‚  â””â”€â”€ æ·»åŠ  subscription_tasks å®šæ—¶ä»»åŠ¡                                          â”‚
â”‚                                                                                 â”‚
â”‚  åˆ é™¤/åºŸå¼ƒæ–‡ä»¶                                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                                 â”‚
â”‚  services/billing/subscription.py                                               â”‚
â”‚  â””â”€â”€ åŠŸèƒ½è¿ç§»åˆ° services/subscription/subscription_service.py ååˆ é™¤           â”‚
â”‚                                                                                 â”‚
â”‚  services/identity/usage_limits.py                                              â”‚
â”‚  â””â”€â”€ åŠŸèƒ½åˆå¹¶åˆ° EntitlementService ååˆ é™¤                                       â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å®æ–½æ­¥éª¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®æ–½æ­¥éª¤                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  Step 1: åˆ›å»ºæ•°æ®æ¨¡å‹ (30åˆ†é’Ÿ)                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Â· åˆ›å»º services/subscription/models.py                                         â”‚
â”‚  Â· å®šä¹‰ Subscription, UserTier æ•°æ®ç±»                                           â”‚
â”‚                                                                                 â”‚
â”‚  Step 2: é‡æ„ SubscriptionService (2å°æ—¶)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Â· åˆ›å»º services/subscription/subscription_service.py                           â”‚
â”‚  Â· è¿ç§» billing/subscription.py æ ¸å¿ƒé€»è¾‘                                        â”‚
â”‚  Â· æ·»åŠ  create_prepaid, create_subscription è”åŠ¨ EntitlementService            â”‚
â”‚  Â· æ·»åŠ  expire_overdue è”åŠ¨ EntitlementService.downgrade_to_free               â”‚
â”‚                                                                                 â”‚
â”‚  Step 3: æ‰©å±• CurrentUser (1å°æ—¶)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Â· ä¿®æ”¹ services/identity/auth.py                                               â”‚
â”‚  Â· æ·»åŠ  tier, subscription, daily_remaining å­—æ®µ                                â”‚
â”‚  Â· æ·»åŠ  can(), can_chat(), is_premium æ–¹æ³•                                      â”‚
â”‚  Â· åˆ›å»º get_current_user_with_entitlements() ä¾èµ–                               â”‚
â”‚                                                                                 â”‚
â”‚  Step 4: è¿æ¥ Webhook (1å°æ—¶)                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Â· ä¿®æ”¹ routes/payment.py                                                       â”‚
â”‚  Â· _handle_checkout_completed è°ƒç”¨ SubscriptionService                          â”‚
â”‚  Â· _handle_subscription_updated/deleted è°ƒç”¨ SubscriptionService                â”‚
â”‚  Â· _handle_payment_failed è°ƒç”¨ SubscriptionService.handle_payment_failed        â”‚
â”‚                                                                                 â”‚
â”‚  Step 5: åˆ›å»º NotificationService (2å°æ—¶)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Â· åˆ›å»º services/notification/ ç›®å½•ç»“æ„                                          â”‚
â”‚  Â· å®ç° send_email (é›†æˆ Resend æˆ– SendGrid)                                    â”‚
â”‚  Â· å®ç° send_push (App å†…é€šçŸ¥è¡¨)                                                â”‚
â”‚  Â· å®ç° send_renewal_reminder, send_password_reset                              â”‚
â”‚  Â· ä¿®æ”¹ routes/auth.py è°ƒç”¨ NotificationService                                 â”‚
â”‚                                                                                 â”‚
â”‚  Step 6: åˆ›å»ºå®šæ—¶ä»»åŠ¡ (1å°æ—¶)                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Â· åˆ›å»º workers/subscription_tasks.py                                           â”‚
â”‚  Â· å®ç° expire_overdue_subscriptions ä»»åŠ¡                                       â”‚
â”‚  Â· å®ç° send_renewal_reminders ä»»åŠ¡                                             â”‚
â”‚  Â· æ›´æ–° scripts/crontab.example                                                 â”‚
â”‚                                                                                 â”‚
â”‚  Step 7: æ¸…ç†ä¸æµ‹è¯• (2å°æ—¶)                                                      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Â· åˆ é™¤æ—§æ–‡ä»¶ (billing/subscription.py, identity/usage_limits.py)               â”‚
â”‚  Â· æ›´æ–°æ‰€æœ‰ import å¼•ç”¨                                                         â”‚
â”‚  Â· ç¼–å†™é›†æˆæµ‹è¯•                                                                 â”‚
â”‚  Â· ç«¯åˆ°ç«¯æµ‹è¯•æ”¯ä»˜æµç¨‹                                                           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€é…ç½®è¦æ±‚

### 6.1 ç¯å¢ƒå˜é‡

```bash
# é‚®ä»¶æœåŠ¡ (é€‰æ‹©ä¸€ä¸ª)
RESEND_API_KEY=re_xxx                    # Resend
# æˆ–
SENDGRID_API_KEY=SG.xxx                  # SendGrid

# é‚®ä»¶å‘ä»¶äºº
EMAIL_FROM=noreply@vibelife.app
EMAIL_FROM_NAME=VibeLife

# Stripe Price ID (å¿…é¡»é…ç½®)
STRIPE_PRICE_PREPAID_1M_HKD=price_xxx
STRIPE_PRICE_PREPAID_3M_HKD=price_xxx
STRIPE_PRICE_PREPAID_12M_HKD=price_xxx
STRIPE_PRICE_SUB_MONTHLY_USD=price_xxx
STRIPE_PRICE_SUB_QUARTERLY_USD=price_xxx
STRIPE_PRICE_SUB_YEARLY_USD=price_xxx
```

### 6.2 Crontab é…ç½®

```bash
# æ¯æ—¥å‡Œæ™¨ 3:00 - è®¢é˜…åˆ°æœŸå¤„ç† + ç»­è´¹æé†’
0 3 * * * cd /opt/vibelife && python -m workers.subscription_tasks expire_and_notify

# æ¯å°æ—¶ - Stripe çŠ¶æ€åŒæ­¥ (å¯é€‰ï¼Œwebhook åº”è¯¥è¶³å¤Ÿ)
# 0 * * * * cd /opt/vibelife && python -m workers.subscription_tasks sync_stripe
```

---

## é™„å½•: æ•°æ®åº“è¿ç§»

```sql
-- migrations/019_subscription_improvements.sql

-- ç¡®ä¿ subscriptions è¡¨æœ‰æ‰€æœ‰å¿…éœ€å­—æ®µ
ALTER TABLE subscriptions
ADD COLUMN IF NOT EXISTS payment_failed_count INT DEFAULT 0;

-- ä¸ºåˆ°æœŸæŸ¥è¯¢æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_subscriptions_expires_at
ON subscriptions (expires_at)
WHERE status = 'active' AND vip_type = 'prepaid';

-- ä¸º Stripe è®¢é˜…åŒæ­¥æ·»åŠ ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_subscriptions_stripe_subscription_id
ON subscriptions (stripe_subscription_id)
WHERE stripe_subscription_id IS NOT NULL;

-- ç¡®ä¿ user_entitlements æœ‰ subscription_expires_at å­—æ®µ
ALTER TABLE user_entitlements
ADD COLUMN IF NOT EXISTS subscription_expires_at TIMESTAMPTZ;
```
