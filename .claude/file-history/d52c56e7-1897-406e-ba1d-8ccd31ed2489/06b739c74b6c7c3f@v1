"""
Entitlement Service - 兼容层
委托到 SubscriptionService，保持 API 不变
"""
from datetime import datetime
from uuid import UUID
import logging

logger = logging.getLogger(__name__)


class EntitlementService:
    """兼容层 - 委托给 SubscriptionService"""

    @staticmethod
    async def _get_service():
        """获取 SubscriptionService 实例"""
        from services.billing.subscription import SubscriptionService
        from stores.db import get_db_pool
        pool = await get_db_pool()
        return SubscriptionService(pool)

    @staticmethod
    async def check_can_chat(user_id: UUID) -> dict:
        """检查用户是否可以对话"""
        svc = await EntitlementService._get_service()
        return await svc.check_can_chat(str(user_id))

    @staticmethod
    async def consume_conversation(user_id: UUID) -> bool:
        """消耗一次对话额度"""
        # usage 通过 UsageService 自动记录
        return True

    @staticmethod
    async def get_entitlements(user_id: UUID) -> dict:
        """获取用户权益"""
        svc = await EntitlementService._get_service()
        return await svc.get_entitlements(str(user_id))

    @staticmethod
    async def upgrade_to_paid(user_id: UUID, expires_at: datetime) -> bool:
        """升级到付费"""
        svc = await EntitlementService._get_service()
        return await svc.upgrade_to_paid(str(user_id), expires_at)

    @staticmethod
    async def downgrade_to_free(user_id: UUID) -> bool:
        """降级到免费"""
        svc = await EntitlementService._get_service()
        return await svc.downgrade_to_free(str(user_id))


__all__ = ["EntitlementService"]
