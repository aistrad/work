"""
Agent Framework - V6 Architecture
CoreAgent with LLM-based skill selection (Claude Agent SDK style)

V6 Changes:
- CoreAgent replaces Orchestrator + SkillAgents
- LLM-based skill selection (no keyword matching)
- SkillLoader loads SKILL.md files
- Unified tool schema from YAML
- SOP state persistence with Redis
- Skill validation for CI
"""

# Core Agent
from .core import CoreAgent, AgentContext, AgentEvent, AgentState, create_agent
from .skill_loader import load_skill, build_system_prompt, get_available_skills, SkillConfig
from .subagent import SkillSubAgent

# Tier limits (简化版，完整配额管理使用 model_router.quota)
TIER_LIMITS = {
    "free": {"calls": 50, "tokens": 100000},
    "paid": {"calls": 500, "tokens": 1000000},
    "vip": {"calls": -1, "tokens": -1},
}


class QuotaTracker:
    """简化配额追踪 - 委托到 UsageService"""

    @classmethod
    async def check(cls, user_id: str, tier: str):
        """检查配额"""
        if tier == "vip":
            return True, ""

        from services.usage import UsageService
        from uuid import UUID

        try:
            usage = await UsageService.get_monthly_usage(UUID(user_id))
            limits = TIER_LIMITS.get(tier, TIER_LIMITS["free"])

            if limits["calls"] > 0 and usage["llm_calls"] >= limits["calls"]:
                return False, "本月对话次数已用完"
            return True, ""
        except Exception:
            return True, ""

    @classmethod
    async def record(cls, user_id: str, usage: dict):
        """记录用量 - 已由 UsageService 处理"""
        pass

# Stream Adapters
from .stream_adapter import (
    BaseStreamAdapter,
    AISDKv6Adapter,
    LegacySSEAdapter,
    StreamConfig,
    get_adapter,
)

# V6 新增: 统一工具定义
from .tool_schema import (
    ToolDef,
    ToolParam,
    load_skill_tools,
    get_skill_tools_openai,
    get_global_tools_openai,
    get_all_tools_for_skill,
    get_tool_card_type,
)

# V6 新增: 统一工具注册表
from .tool_registry import (
    ToolRegistry,
    ToolContext,
    tool_handler,
)

# V6 新增: SOP 状态持久化
from .sop_state import (
    SOPState,
    SOPStateManager,
    get_sop_manager,
)

# V6 新增: SOP 引擎
from .sop_engine import (
    SOPEngine,
    SOPPhase,
    SOPAction,
    create_sop_engine,
    check_sop_requirements,
)

# V6 新增: Skill 校验
from .skill_validator import (
    validate_skill,
    validate_all_skills,
    ValidationResult,
    ValidationError,
)

__all__ = [
    # Core Agent
    "CoreAgent",
    "AgentContext",
    "AgentEvent",
    "AgentState",
    "SkillConfig",
    "SkillSubAgent",
    "QuotaTracker",
    "TIER_LIMITS",
    "create_agent",
    "load_skill",
    "build_system_prompt",
    "get_available_skills",
    # Stream Adapters
    "BaseStreamAdapter",
    "AISDKv6Adapter",
    "LegacySSEAdapter",
    "StreamConfig",
    "get_adapter",
    # Tool Schema
    "ToolDef",
    "ToolParam",
    "load_skill_tools",
    "get_skill_tools_openai",
    "get_global_tools_openai",
    "get_all_tools_for_skill",
    "get_tool_card_type",
    # Tool Registry
    "ToolRegistry",
    "ToolContext",
    "tool_handler",
    # SOP State
    "SOPState",
    "SOPStateManager",
    "get_sop_manager",
    # SOP Engine
    "SOPEngine",
    "SOPPhase",
    "SOPAction",
    "create_sop_engine",
    "check_sop_requirements",
    # Skill Validator
    "validate_skill",
    "validate_all_skills",
    "ValidationResult",
    "ValidationError",
]
