# VibeLife 订阅 + 计费系统迁移完成报告
> 2026-01-15

---

## 迁移状态: ✅ 完成

### 代码验证

```
✅ Python 语法检查通过
✅ 所有核心模块导入成功
✅ UsageService 工作正常
✅ EntitlementService 兼容层工作正常
✅ SubscriptionService 工作正常
✅ QuotaTracker 工作正常
✅ Routes 导入正常
```

---

## 需要手动执行

### 1. 数据库迁移

```bash
# 在生产环境执行
psql $DATABASE_URL -f migrations/018_usage_events.sql
```

迁移内容:
- 创建 `usage_events` 表 (统一用量，支持计费)
- 重命名旧表: `user_usage` → `user_usage_deprecated`
- 重命名旧表: `usage_records` → `usage_records_deprecated`

### 2. 验证支付流程

```bash
# 测试 webhook
curl -X POST http://localhost:8000/payment/webhook \
  -H "Content-Type: application/json" \
  -H "Stripe-Signature: test" \
  -d '{"type": "checkout.session.completed", ...}'
```

---

## 变更文件汇总

### 新增
- `migrations/018_usage_events.sql`

### 重写
- `services/usage/service.py` - 统一用量服务
- `services/entitlement/__init__.py` - 兼容层
- `services/agent/__init__.py` - 内联 QuotaTracker
- `services/agent/usage_tracker.py` - 简化版

### 修改
- `routes/payment.py` - 修复 webhook
- `routes/chat.py` - 精确用量记录
- `routes/context.py` - 导入路径
- `services/billing/subscription.py` - 添加 entitlement 方法
- `services/identity/__init__.py` - 移除旧导入

### 删除
- `services/entitlement/service.py`
- `services/identity/usage_limits.py`
- `services/agent/quota.py`
- `stores/usage_repo.py`

---

## 新架构图

```
┌──────────────────────────────────────────────────────────┐
│                       API Routes                         │
│  payment.py ──→ SubscriptionService (订阅激活)           │
│  chat.py    ──→ UsageService (用量记录)                  │
│  entitlement.py ──→ EntitlementService (兼容层)          │
└──────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────┐
│                      Services                            │
│  ┌─────────────────┐    ┌─────────────────┐             │
│  │SubscriptionSvc  │◄───│EntitlementSvc   │             │
│  │ (订阅 + 权益)   │    │ (兼容层)        │             │
│  └─────────────────┘    └─────────────────┘             │
│                                                          │
│  ┌─────────────────┐                                     │
│  │ UsageService    │  ← 统一用量，支持计费               │
│  │ - record_llm_call(tokens, cost)                      │
│  │ - record_skill_use(skill_id)                         │
│  │ - record_tool_call(tool_name)                        │
│  │ - get_billing_summary()                              │
│  └─────────────────┘                                     │
└──────────────────────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────┐
│                      Database                            │
│  subscriptions      - 订阅记录                           │
│  usage_events       - 用量事件 (支持计费)                │
└──────────────────────────────────────────────────────────┘
```

---

## 计费 API

```python
# 获取月度账单
GET /billing/usage/summary?month=2026-01
{
    "llm_calls": 150,
    "total_tokens": 500000,
    "total_cost": 0.15,
    "skill_uses": 45,
    "tool_calls": 80
}

# 按 Skill 统计
GET /billing/usage/by-skill?month=2026-01
[
    {"skill_id": "bazi", "calls": 80, "tokens": 300000, "cost": 0.09},
    {"skill_id": "zodiac", "calls": 70, "tokens": 200000, "cost": 0.06}
]

# 按模型统计
GET /billing/usage/by-model?month=2026-01
[
    {"model": "glm-4-flash", "calls": 120, "cost": 0.05},
    {"model": "deepseek-chat", "calls": 30, "cost": 0.10}
]
```

---

## 回滚方案

如果需要回滚:

```bash
# 恢复旧文件
git checkout HEAD~1 -- apps/api/services/entitlement/service.py
git checkout HEAD~1 -- apps/api/services/identity/usage_limits.py
git checkout HEAD~1 -- apps/api/services/agent/quota.py
git checkout HEAD~1 -- apps/api/stores/usage_repo.py

# 恢复旧表
ALTER TABLE user_usage_deprecated RENAME TO user_usage;
ALTER TABLE usage_records_deprecated RENAME TO usage_records;
```
