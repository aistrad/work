# VibeLife 复杂组合指令工具设计方案

> 目标：让用户能完成 "年目标拆解 + 每日计划 + 持续监督" 等复杂指令

---

## 核心设计思路

**Agent-Native 文件系统**：给用户"写入能力"和"个性化文件"，构建 User-Owned Data Store

```
用户说 "这是我的年目标，帮我拆解"
    ↓
1. LLM 理解目标 → decompose_goal 工具分解
2. 生成结构化计划 → 存入 user_files + user_goals 表
3. 用户可编辑 Markdown 文件 → 修改自己的计划
4. 定时提醒 → proactive worker 每日推送
```

---

## 实现方案

### 1. 数据模型

**新增 3 张表**:

| 表名 | 用途 |
|------|------|
| `user_goals` | 层级目标 (year/quarter/month/week/day) |
| `user_tasks` | 原子任务 (可调度、可复选) |
| `user_files` | 用户 Markdown 文件 (可编辑的计划文档) |

**Profile 扩展**:
```json
{
  "goal_tracking": {
    "last_checkin": "2026-01-17",
    "streak_days": 5,
    "reminder_time": "08:00"
  }
}
```

### 2. 新增 Goals Skill

**目录**: `skills/goals/`

```
skills/goals/
├── SKILL.md              # 目标教练角色定义
├── tools/
│   ├── tools.yaml        # 工具定义
│   └── handlers.py       # 工具处理器
├── services/
│   ├── goal_service.py   # 目标 CRUD
│   ├── decomposer.py     # LLM 目标分解
│   ├── planner.py        # 每日计划生成
│   └── file_service.py   # 文件读写
├── scenarios/
│   ├── set_goal.md       # 设定目标
│   └── daily_review.md   # 每日复盘
└── reminders.yaml        # 定时提醒配置
```

### 3. 核心工具设计

| 工具 | 类型 | 用途 |
|------|------|------|
| `collect_goal_info` | collect | 收集目标信息表单 |
| `create_goal` | action | 创建目标 |
| `decompose_goal` | compute | LLM 分解大目标为子目标/任务 |
| `generate_daily_plan` | compute | 生成每日计划 (结合命理) |
| `show_goal_tree` | display | 展示目标树 |
| `show_daily_plan` | display | 展示今日计划 |
| `show_checkin_form` | display | 打卡复盘表单 |
| `complete_task` | action | 标记任务完成 |
| `read_user_file` | action | 读取用户文件 |
| `save_user_file` | action | 保存用户文件 |

### 4. 用户文件系统

**虚拟路径结构**:
```
/users/{user_id}/
├── goals/2026/
│   ├── year_goal.md       # 年度目标文档
│   └── months/01.md       # 月度分解
├── plans/daily/
│   └── 2026-01-18.md      # 每日计划
└── reflections/
    └── week_01.md         # 周复盘
```

**文件格式** (Markdown + YAML Frontmatter):
```markdown
---
id: goal_2026_001
title: 2026年职业突破
level: year
status: active
progress: 15
---

# 2026年职业突破

## 关键成果
1. [ ] Q1: 完成认证
2. [ ] Q2: 主导项目

## 我的笔记
...可自由编辑...
```

### 5. 定时提醒配置

**`skills/goals/reminders.yaml`**:

| 提醒 | 触发 | 内容 |
|------|------|------|
| 每日计划 | 早8点 | 今日任务预览 + 命理提示 |
| 每日复盘 | 晚9点 | 打卡提醒 |
| 周复盘 | 周日晚8点 | 本周总结 |
| 里程碑 | 截止前 7/3/1 天 | 目标到期提醒 |
| 连续打卡 | 7/14/21/30 天 | 庆祝激励 |

### 6. 前端卡片

| 卡片 | 功能 |
|------|------|
| `GoalTreeCard` | 可折叠目标树，进度条，快捷操作 |
| `DailyPlanCard` | 时间轴布局，任务勾选，拖拽排序 |
| `CheckinFormCard` | 任务完成勾选，精力评分，反思 |
| `GoalFileEditor` | Markdown 编辑器，实时预览 |

---

## 关键文件清单

**需修改**:
- `apps/api/stores/migrations/` - 新增数据库迁移
- `apps/api/services/proactive/trigger_detector.py` - 添加目标截止检测

**需新建**:
- `apps/api/skills/goals/` - 整个 Goals Skill 目录
- `apps/web/src/skills/goals/` - 前端组件

**参考文件**:
- `apps/api/skills/bazi/tools/tools.yaml` - 工具定义模板
- `apps/api/services/agent/tool_registry.py` - 工具注册机制
- `apps/api/services/proactive/engine.py` - 提醒引擎

---

## 实现阶段

| 阶段 | 内容 | 产出 |
|------|------|------|
| P1 | 数据模型 + 基础 CRUD | 能创建/查询目标 |
| P2 | LLM 分解 + 计划生成 | 能分解目标、生成每日计划 |
| P3 | 文件系统 + 编辑能力 | 用户可读写自己的计划文件 |
| P4 | 定时提醒 | 每日推送 |
| P5 | 前端卡片 | 完整 UI |

---

## 待澄清问题

1. **文件同步策略**: Markdown 修改后立即同步到数据库，还是需要显式"保存"？
2. **LLM 模型选择**: 目标分解用 DeepSeek (成本) 还是 Claude (质量)？
3. **命理整合深度**: 目标建议要深度结合八字/星座分析，还是仅作参考提示？
4. **提醒时间自定义**: 允许每个目标单独设置提醒时间，还是使用全局偏好？
