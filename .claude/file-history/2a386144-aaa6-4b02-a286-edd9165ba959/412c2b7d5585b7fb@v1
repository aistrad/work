# VibeLife v9 - 统一架构设计

> Version: 9.0 | 2026-01-21
> 设计原则：极简框架 + 完全 LLM 驱动 + Cron 可控触发

---

## 一、核心设计哲学

```
┌─────────────────────────────────────────────────────────────────┐
│                          v9 设计原则                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 极简框架                                                     │
│     • 无新增模块，复用现有架构                                    │
│     • 无新增数据表，扩展 unified_profiles.profile.extracted      │
│     • 无新增 Worker，扩展现有 ProfileExtractor                   │
│                                                                 │
│  2. 完全 LLM 驱动                                                │
│     • 抽取逻辑：LLM Prompt（非规则引擎）                         │
│     • 推送判断：LLM 评估（非 if-else）                           │
│     • 内容生成：LLM 融合（非模板拼接）                           │
│                                                                 │
│  3. Cron 可控触发                                                │
│     • ProfileExtractor: 每日凌晨3点批量抽取                     │
│     • ProactiveEngine: 每日早8点评估推送                        │
│     • 成本可控，资源池化，不阻塞对话流                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、整体架构流程

```
┌───────────────────────────────────────────────────────────────────────────┐
│                          v9 数据流架构                                     │
└───────────────────────────────────────────────────────────────────────────┘

        用户对话
           │
           ▼
    ┌──────────────┐
    │  CoreAgent   │ ◄──── Skills (bazi, zodiac, lifecoach, vibe_id...)
    │   + Skills   │
    └──────┬───────┘
           │ 对话结束保存
           ▼
    ┌──────────────┐
    │ conversations│  (对话历史存储)
    │   messages   │
    └──────┬───────┘
           │
           │
    ┌──────┴────────────────────────────────────────┐
    │                                                │
    │  Cron: 每日凌晨3点              Cron: 每日早8点 │
    │                                                │
    ▼                                                ▼
┌────────────────┐                        ┌──────────────────┐
│ProfileExtractor│  (LLM 批量抽取)        │ ProactiveEngine  │ (LLM 评估推送)
│                │                        │                  │
│ • 分析最近7天  │                        │ • 读取 extracted │
│ • 多维度抽取   │                        │ • LLM 评估需求   │
│ • 更新画像     │                        │ • 生成推送内容   │
└────────┬───────┘                        └────────┬─────────┘
         │                                         │
         ▼                                         ▼
┌─────────────────────────────────────────────────────────┐
│         unified_profiles.profile.extracted              │  (统一数据源)
│                                                         │
│  {                                                      │
│    // 现有字段                                           │
│    topics, personality_traits, life_events, preferences │
│                                                         │
│    // v9 新增                                           │
│    emotion: {...},          // 情绪状态 + 历史          │
│    behavior: {...},         // 行为模式                │
│    topic_heat: {...},       // 话题热度                │
│    archetype: {...},        // 原型权重 + 趋势         │
│    insights: [...]          // 融合洞察                │
│  }                                                      │
└───────────┬─────────────────────────────────────────────┘
            │
            │ (读取消费)
            │
    ┌───────┴──────────────────┐
    │                          │
    ▼                          ▼
┌────────┐              ┌──────────┐
│ Me 页  │              │Journey 页│
│        │              │          │
│融合洞察 │              │智能排序  │
│原型演化 │              │目标热度  │
│情绪轨迹 │              │进度管理  │
└────────┘              └──────────┘

    ┌──────────────────────────┐
    │                          │
    ▼                          ▼
 Chat 推送              通知推送 (App/小程序)
```

---

## 三、核心组件职责

### 3.1 ProfileExtractor（画像抽取器）

**职责：**
- 定时批量处理，从对话中抽取多维度信息
- 完全 LLM 驱动，无规则引擎

**触发机制：**
```
Cron: 每日凌晨3点
执行逻辑：
  1. 获取最近7天有对话的活跃用户
  2. 对每个用户，调用 LLM 分析最近对话
  3. 抽取：emotion, behavior, topic_heat, archetype_signals
  4. 增量更新 unified_profiles.profile.extracted
  5. 必要时生成融合洞察（跨维度 LLM 生成）
```

**LLM Prompt 策略：**
- 输入：最近 N 天对话 + 现有画像
- 输出：JSON 格式的多维度抽取结果
- 增量更新：平滑合并，非覆盖

---

### 3.2 ProactiveEngine（主动推送引擎）

**职责：**
- 完全 LLM 驱动的推送决策
- 移除所有硬编码规则

**触发机制：**
```
Cron: 每日早8点（用户活跃时段）
执行逻辑：
  1. 获取活跃用户列表
  2. 对每个用户：
     a. 读取 extracted 画像
     b. LLM 评估：今天是否需要推送？原因？类型？
     c. 如需推送 → LLM 生成推送内容
     d. 发送通知（App Push / 小程序）
```

**LLM Prompt 策略：**
- 评估维度：情绪、行为、话题热度、原型变化、时间上下文
- 推送场景：关怀、提醒、洞察、庆祝、唤醒
- 内容生成：温暖、自然、引导对话

**从规则到 LLM 的迁移：**
```
旧设计：
  if days_since_last_chat >= 3:
      send("好久不见，来聊聊？")

新设计：
  LLM Prompt:
    - 用户画像：{emotion, behavior, topic_heat}
    - 上下文：距离上次对话 N 天
    - 评估规则参考（非强制）：
      • 连续3天未对话 → 考虑唤醒
      • 情绪低落 → 考虑关怀
      • 热点目标未讨论 → 考虑提醒
    - 输出：是否推送 + 原因 + 内容
```

---

### 3.3 VibeID 和目标进度管理

#### 数据归属

**VibeID（身份标识）：**
- 位置：`unified_profiles.profile.extracted.archetype`
- 性质：**画像数据**，由 ProfileExtractor 抽取维护
- 内容：4种原型权重 + 演化趋势
- 消费者：Me 页、ProactiveEngine

**目标进度（Goals/Journey）：**
- 位置：**Lifecoach Skill 数据结构**
- 性质：业务数据，独立管理
- 内容：目标列表、完成状态、打卡记录
- 关联：Journey 页根据 `topic_heat` 智能排序目标

#### 设计原则

```
画像层（VibeProfile）：
  • extracted.archetype → VibeID 权重
  • extracted.topic_heat → 目标相关性评分

业务层（Skills）：
  • lifecoach.goals → 目标数据
  • lifecoach.check_ins → 打卡记录
  • bazi/zodiac.birth_charts → 命理数据

融合层（LLM）：
  • ProfileExtractor: 从对话抽取 archetype 信号
  • ProactiveEngine: 融合 VibeID + 目标状态 → 推送
```

---

## 四、数据结构设计

### 4.1 unified_profiles.profile.extracted（扩展）

```json
{
  // ========== 现有字段保留 ==========
  "topics": ["事业", "健康", "关系"],
  "personality_traits": ["善于思考", "注重细节"],
  "life_events": [{"date": "2026-01", "event": "换工作"}],
  "preferences": {"communication_style": "直接"},

  // ========== v9 新增字段 ==========

  // 1. 情绪状态
  "emotion": {
    "current": "calm",           // 当前主导情绪
    "intensity": 0.6,            // 强度 0-1
    "history": [                 // 最近30天历史
      {"date": "2026-01-21", "avg": 0.7, "dominant": "calm"}
    ]
  },

  // 2. 行为模式
  "behavior": {
    "dominant": "problem_solving",  // 主要模式
    "patterns": ["exploring", "planning"]  // 次要模式
  },

  // 3. 话题热度（用于 Journey 智能排序）
  "topic_heat": {
    "career": 0.8,      // 事业
    "health": 0.1,      // 健康
    "relationship": 0.1, // 关系
    "growth": 0.5,      // 成长
    "finance": 0.3      // 财富
  },

  // 4. 原型分布（VibeID）
  "archetype": {
    "weights": {
      "creator": 0.3,   // 创造者
      "healer": 0.4,    // 疗愈者
      "pioneer": 0.2,   // 开拓者
      "sage": 0.1       // 智者
    },
    "trend": {
      "rising": "pioneer",  // 上升趋势
      "delta": 0.05         // 变化量
    }
  },

  // 5. 融合洞察（LLM 跨维度生成）
  "insights": [
    {
      "type": "fusion",
      "content": "你的命盘显示表达力强，而你最近频繁讨论写作计划，这可能是你的创造者原型在觉醒。",
      "sources": ["bazi", "behavior", "archetype"],
      "generated_at": "2026-01-21T03:00:00Z"
    }
  ]
}
```

**设计要点：**
- ✅ 无需新表，仅扩展 JSONB 字段
- ✅ 增量更新，保留历史数据（如 emotion.history）
- ✅ 自包含，无外键依赖

---

### 4.2 Lifecoach Skill 数据（目标管理）

**位置：** `apps/api/skills/lifecoach/data/` 或 skill 专属表

**结构示例：**
```json
{
  "goals": [
    {
      "id": "goal_001",
      "title": "完成产品上线",
      "tags": ["career", "growth"],  // ← 关联 topic_heat
      "status": "in_progress",
      "created_at": "2026-01-10",
      "check_ins": [
        {"date": "2026-01-15", "note": "完成了设计稿"}
      ]
    }
  ]
}
```

**Journey 页智能排序逻辑：**
```
对每个 goal：
  relevance = sum(topic_heat[tag] for tag in goal.tags)
  sort by relevance desc
```

---

## 五、前端页面架构

### 5.1 Me 页（个人画像）

**数据源：** `GET /api/v1/me/dashboard`

**展示内容：**
```
┌───────────────────────────────┐
│       融合洞察卡片             │
│  "你的命盘显示..."             │
│  [来源: bazi + behavior]       │
└───────────────────────────────┘

┌───────────────────────────────┐
│      VibeID 原型演化           │
│  [创造者 ████████ 30%]         │
│  [疗愈者 ██████████ 40%]  ↑   │
│  [开拓者 ████ 20%]        ↑   │
│  [智者   ██ 10%]               │
└───────────────────────────────┘

┌───────────────────────────────┐
│       情绪轨迹图               │
│  [7天折线图]                   │
└───────────────────────────────┘
```

---

### 5.2 Journey 页（目标管理）

**数据源：** `GET /api/v1/journey/goals?sort=intelligent`

**展示内容：**
```
排序方式: [智能排序 ▼]

┌─────────────────────────────────┐
│ 🔥 完成产品上线                  │  ← 高热度（career 0.8）
│    进度: 60%  |  5天前更新        │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│ 🌟 坚持每日冥想                  │  ← 中热度（health 0.5）
│    进度: 80%  |  今天打卡         │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│    学习投资理财                  │  ← 低热度（finance 0.3）
│    进度: 20%  |  2周前更新        │
└─────────────────────────────────┘
```

**智能排序说明：**
- 基于 `extracted.topic_heat` 和 goal.tags 计算相关性
- 高热度目标优先展示，提示"当前关注重点"

---

### 5.3 Chat 页（对话 + 推送）

**推送显示：**
```
系统消息（主动推送）:
┌────────────────────────────────┐
│ 💬 Vibe                         │
│                                 │
│ 你已经3天没打卡了，需要聊聊吗？  │
│                                 │
│ [开始对话]                      │
└────────────────────────────────┘
```

---

## 六、实施路线图

### Phase 1: 数据层（2天）

```
Day 1: 扩展 ProfileExtractor
  - 扩展抽取 Prompt（emotion, behavior, topic_heat, archetype）
  - 添加 Cron 入口
  - 实现增量更新逻辑

Day 2: 测试验证
  - 运行抽取任务
  - 验证 extracted 数据质量
```

---

### Phase 2: 推送引擎（2天）

```
Day 3: 重构 ProactiveEngine
  - 实现 LLM 评估推送需求
  - 实现 LLM 生成推送内容
  - 移除旧规则代码

Day 4: Cron 集成
  - 配置定时任务
  - 推送测试
```

---

### Phase 3: 前端 API（2天）

```
Day 5: 后端 API
  - GET /api/v1/me/dashboard
  - GET /api/v1/journey/goals?sort=intelligent

Day 6: 前端对接
  - Me 页组件
  - Journey 页组件
  - 端到端测试
```

**总计：6天完成核心功能**

---

## 七、迁移策略

### 7.1 ProfileExtractor 迁移

| 阶段 | 现状 | v9 目标 |
|------|------|---------|
| **触发时机** | 对话结束时同步调用 | Cron 每日凌晨3点 |
| **数据范围** | 当前对话 | 最近7天对话 |
| **抽取维度** | 4维（topics, traits, events, preferences） | 8维（+ emotion, behavior, topic_heat, archetype） |

**并行期策略：**
1. 保留旧触发（兼容期1周）
2. 部署 Cron 任务，观察数据质量
3. 验证通过后，移除对话结束时的调用

---

### 7.2 ProactiveEngine 迁移

| 维度 | 旧设计（规则） | v9 设计（LLM） |
|------|---------------|---------------|
| **触发判断** | Python if-else | LLM 评估 Prompt |
| **内容生成** | 模板 + 少量 LLM | 纯 LLM |
| **扩展性** | 需修改代码 | 仅修改 Prompt |

**迁移步骤：**
```
Week 1: 整理现有规则 → 转为 LLM Prompt 参考
Week 2: 新旧系统并行运行，对比效果
Week 3: 修正 Prompt，全量切换 LLM
Week 4: 移除旧规则代码
```

---

## 八、验收标准

### 功能验收

- [ ] Cron 定时任务正常执行（凌晨3点 + 早8点）
- [ ] extracted 覆盖8个维度
- [ ] Me 页显示融合洞察
- [ ] Me 页显示原型演化
- [ ] Journey 页智能排序工作
- [ ] LLM 推送评估准确
- [ ] 推送内容温暖自然

### 性能验收

- [ ] ProfileExtractor < 2s/用户
- [ ] ProactiveEngine < 1s/用户
- [ ] Me/Journey API < 200ms
- [ ] Cron 任务不阻塞主服务

---

## 九、成本估算

### LLM 调用成本

**ProfileExtractor（每日凌晨3点）：**
- 假设100活跃用户
- 每用户1次调用（分析最近对话）
- 每次 ~2k tokens（输入） + ~500 tokens（输出）
- DeepSeek: ¥0.001/1k tokens
- **日成本：100 × 2.5k × 0.001 = ¥0.25**

**ProactiveEngine（每日早8点）：**
- 假设100活跃用户
- 每用户1次评估 + 约20%需生成内容
- 评估：~1k tokens/次
- 生成：~2k tokens/次
- **日成本：100 × 1k × 0.001 + 20 × 2k × 0.001 = ¥0.14**

**月总成本：** (0.25 + 0.14) × 30 = **¥11.7**

---

## 十、未解决问题

### Q1: VibeID 如何初始化？

**选项：**
1. 用户首次对话时，从八字/星座推导初始权重
2. 默认均分（25% × 4），随对话演化
3. 引导式问卷（"你更像创造者还是疗愈者？"）

**建议：** 方案2（极简），初始均分，3-5次对话后自然分化。

---

### Q2: Proactive 推送频率如何控制？

**现状问题：**
- LLM 可能每天都判断"需要推送"
- 用户可能觉得打扰

**解决方案：**
1. LLM Prompt 中加入"上次推送时间"上下文
2. 推送间隔 >= 2天（硬规则）
3. 用户可配置"免打扰时段"

---

### Q3: Journey 目标如何关联 topic_heat？

**方案：**
- 目标创建时，用户选择标签（career/health/relationship...）
- 或 LLM 自动从目标描述中推断标签
- 后端根据 `goal.tags` 和 `extracted.topic_heat` 计算相关性

---

## 十一、总结

### 核心优势

✅ **极简**：无新增模块/表，270行代码
✅ **智能**：完全 LLM 驱动，无硬编码规则
✅ **可控**：Cron 触发，成本月<¥20
✅ **实用**：Me/Journey 页直接消费，推送自然

### 关键决策

1. **Cron vs 实时**：选 Cron（成本、稳定）
2. **规则 vs LLM**：选 LLM（灵活、可维护）
3. **新表 vs 扩展**：选扩展（极简、快速）
4. **VibeID 归属**：画像层（extracted），非独立模块

### 下一步

1. 启动 Phase 1（2天）
2. 验证抽取质量
3. 迭代 LLM Prompt
