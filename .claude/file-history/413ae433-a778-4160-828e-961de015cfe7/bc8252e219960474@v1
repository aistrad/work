-- ═══════════════════════════════════════════════════════════════
-- VIBELIFE DATABASE SCHEMA - INITIAL MIGRATION
-- Version: 001
-- Description: Core tables for Vibe ID and Skill system
-- ═══════════════════════════════════════════════════════════════

-- Enable extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "vector";

-- ─────────────────────────────────────────────────────────────────
-- VIBE ID TABLES
-- ─────────────────────────────────────────────────────────────────

-- Users core table
CREATE TABLE IF NOT EXISTS vibe_users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vibe_id VARCHAR(20) UNIQUE NOT NULL,
    display_name VARCHAR(100),
    avatar_url VARCHAR(500),
    birth_datetime TIMESTAMPTZ,
    birth_location VARCHAR(255),
    birth_location_coords POINT,
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    language VARCHAR(10) DEFAULT 'zh-CN',
    status VARCHAR(20) DEFAULT 'active',
    email_verified BOOLEAN DEFAULT false,
    phone_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- User authentication methods
CREATE TABLE IF NOT EXISTS vibe_user_auth (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    auth_type VARCHAR(20) NOT NULL,  -- 'email', 'phone', 'wechat', 'apple', 'google'
    auth_identifier VARCHAR(255) NOT NULL,
    auth_credential TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(auth_type, auth_identifier)
);

-- Data sharing consent
CREATE TABLE IF NOT EXISTS vibe_data_consents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    source_skill VARCHAR(50) NOT NULL,
    target_skill VARCHAR(50) NOT NULL,
    data_type VARCHAR(50) NOT NULL,
    consent_granted BOOLEAN DEFAULT false,
    granted_at TIMESTAMPTZ,
    revoked_at TIMESTAMPTZ,
    UNIQUE(user_id, source_skill, target_skill, data_type)
);

-- ─────────────────────────────────────────────────────────────────
-- SKILL DATA TABLES
-- ─────────────────────────────────────────────────────────────────

-- Skill profiles (per user per skill)
CREATE TABLE IF NOT EXISTS skill_profiles (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    profile_data JSONB NOT NULL DEFAULT '{}',
    first_use_at TIMESTAMPTZ DEFAULT NOW(),
    last_use_at TIMESTAMPTZ DEFAULT NOW(),
    total_sessions INTEGER DEFAULT 0,
    UNIQUE(user_id, skill_id)
);

-- Conversations
CREATE TABLE IF NOT EXISTS skill_conversations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    started_at TIMESTAMPTZ DEFAULT NOW(),
    ended_at TIMESTAMPTZ,
    message_count INTEGER DEFAULT 0,
    entry_point VARCHAR(50),
    referrer VARCHAR(255),
    status VARCHAR(20) DEFAULT 'active'
);

-- Messages
CREATE TABLE IF NOT EXISTS skill_messages (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    conversation_id UUID REFERENCES skill_conversations(id) ON DELETE CASCADE,
    role VARCHAR(20) NOT NULL,
    content TEXT NOT NULL,
    intent VARCHAR(100),
    tools_used VARCHAR(100)[],
    knowledge_used VARCHAR(100)[],
    insight_generated BOOLEAN DEFAULT false,
    insight_id UUID,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Insights
CREATE TABLE IF NOT EXISTS skill_insights (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    conversation_id UUID REFERENCES skill_conversations(id),
    insight_type VARCHAR(50) NOT NULL,  -- 'discovery', 'pattern', 'timing', 'growth'
    title VARCHAR(255),
    content TEXT NOT NULL,
    evidence JSONB,
    confidence FLOAT,
    user_reaction VARCHAR(20),  -- 'helpful', 'not_helpful', 'saved'
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ─────────────────────────────────────────────────────────────────
-- SUBSCRIPTION TABLES
-- ─────────────────────────────────────────────────────────────────

-- Subscription plans
CREATE TABLE IF NOT EXISTS subscription_plans (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    plan_type VARCHAR(20) NOT NULL,  -- 'skill_single', 'skill_bundle', 'vibelife_all'
    skill_ids VARCHAR(50)[],
    price_monthly INTEGER,
    price_yearly INTEGER,
    currency VARCHAR(10) DEFAULT 'CNY',
    features JSONB,
    is_active BOOLEAN DEFAULT true
);

-- User subscriptions
CREATE TABLE IF NOT EXISTS user_subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    plan_id VARCHAR(50) REFERENCES subscription_plans(id),
    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'cancelled', 'expired'
    started_at TIMESTAMPTZ DEFAULT NOW(),
    current_period_end TIMESTAMPTZ,
    cancelled_at TIMESTAMPTZ,
    payment_provider VARCHAR(50),
    payment_subscription_id VARCHAR(255),
    source_skill VARCHAR(50),
    source_campaign VARCHAR(100)
);

-- ─────────────────────────────────────────────────────────────────
-- KNOWLEDGE TABLES
-- ─────────────────────────────────────────────────────────────────

-- Knowledge chunks (with vector embedding)
CREATE TABLE IF NOT EXISTS knowledge_chunks (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    skill_id VARCHAR(50) NOT NULL,
    source_file VARCHAR(255),
    source_section VARCHAR(255),
    content TEXT NOT NULL,
    content_type VARCHAR(50),  -- 'theory', 'pattern', 'case', 'qa'
    metadata JSONB,
    embedding vector(3072),  -- Gemini embedding dimension
    search_vector TSVECTOR,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- QA pairs
CREATE TABLE IF NOT EXISTS knowledge_qa_pairs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    skill_id VARCHAR(50) NOT NULL,
    chunk_id UUID REFERENCES knowledge_chunks(id),
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    question_embedding vector(3072),
    verified BOOLEAN DEFAULT false,
    usage_count INTEGER DEFAULT 0,
    helpfulness_score FLOAT
);

-- ─────────────────────────────────────────────────────────────────
-- REMINDER TABLES
-- ─────────────────────────────────────────────────────────────────

-- Fortune events calendar
CREATE TABLE IF NOT EXISTS fortune_events (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    event_type VARCHAR(50) NOT NULL,
    name VARCHAR(100) NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE,
    event_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Reminder settings per user
CREATE TABLE IF NOT EXISTS reminder_settings (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    bazi_month_enabled BOOLEAN DEFAULT true,
    bazi_month_advance_days INTEGER DEFAULT 2,
    bazi_year_enabled BOOLEAN DEFAULT true,
    bazi_year_advance_days INTEGER DEFAULT 5,
    mercury_retrograde_enabled BOOLEAN DEFAULT true,
    mercury_retrograde_advance_days INTEGER DEFAULT 3,
    weekly_fortune_enabled BOOLEAN DEFAULT false,
    weekly_fortune_time VARCHAR(10) DEFAULT '20:00',
    quiet_start_time VARCHAR(10) DEFAULT '22:00',
    quiet_end_time VARCHAR(10) DEFAULT '08:00',
    in_app_enabled BOOLEAN DEFAULT true,
    push_enabled BOOLEAN DEFAULT true,
    wechat_enabled BOOLEAN DEFAULT false,
    UNIQUE(user_id)
);

-- User notifications
CREATE TABLE IF NOT EXISTS user_notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    notification_type VARCHAR(50) NOT NULL,
    title VARCHAR(255),
    content TEXT,
    read BOOLEAN DEFAULT false,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ─────────────────────────────────────────────────────────────────
-- INDEXES
-- ─────────────────────────────────────────────────────────────────

CREATE INDEX IF NOT EXISTS idx_vibe_users_vibe_id ON vibe_users(vibe_id);
CREATE INDEX IF NOT EXISTS idx_vibe_users_status ON vibe_users(status);
CREATE INDEX IF NOT EXISTS idx_vibe_user_auth_user ON vibe_user_auth(user_id);
CREATE INDEX IF NOT EXISTS idx_vibe_user_auth_type ON vibe_user_auth(auth_type, auth_identifier);

CREATE INDEX IF NOT EXISTS idx_skill_profiles_user ON skill_profiles(user_id);
CREATE INDEX IF NOT EXISTS idx_skill_profiles_skill ON skill_profiles(skill_id);
CREATE INDEX IF NOT EXISTS idx_skill_conversations_user ON skill_conversations(user_id, skill_id);
CREATE INDEX IF NOT EXISTS idx_skill_conversations_status ON skill_conversations(status);
CREATE INDEX IF NOT EXISTS idx_skill_messages_convo ON skill_messages(conversation_id);
CREATE INDEX IF NOT EXISTS idx_skill_messages_created ON skill_messages(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_skill_insights_user ON skill_insights(user_id, skill_id);
CREATE INDEX IF NOT EXISTS idx_skill_insights_type ON skill_insights(insight_type);

CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user ON user_subscriptions(user_id);
CREATE INDEX IF NOT EXISTS idx_user_subscriptions_status ON user_subscriptions(status);

CREATE INDEX IF NOT EXISTS idx_knowledge_chunks_skill ON knowledge_chunks(skill_id);
CREATE INDEX IF NOT EXISTS idx_knowledge_chunks_type ON knowledge_chunks(content_type);
CREATE INDEX IF NOT EXISTS idx_knowledge_chunks_search ON knowledge_chunks USING GIN(search_vector);

CREATE INDEX IF NOT EXISTS idx_fortune_events_date ON fortune_events(start_date);
CREATE INDEX IF NOT EXISTS idx_fortune_events_type ON fortune_events(event_type);
CREATE INDEX IF NOT EXISTS idx_user_notifications_user ON user_notifications(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_user_notifications_read ON user_notifications(user_id, read);

-- ─────────────────────────────────────────────────────────────────
-- TRIGGER: Auto-update updated_at
-- ─────────────────────────────────────────────────────────────────

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_vibe_users_updated_at
    BEFORE UPDATE ON vibe_users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- ─────────────────────────────────────────────────────────────────
-- SEED DATA: Subscription Plans
-- ─────────────────────────────────────────────────────────────────

INSERT INTO subscription_plans (id, name, plan_type, skill_ids, price_monthly, price_yearly, features, is_active)
VALUES
    ('free', '免费版', 'free', NULL, 0, 0, '{"daily_questions": 3, "basic_analysis": true}', true),
    ('bazi_pro', '八字会员', 'skill_single', ARRAY['bazi'], 29, 199, '{"unlimited_questions": true, "deep_analysis": true, "monthly_report": true}', true),
    ('zodiac_pro', '星座会员', 'skill_single', ARRAY['zodiac'], 29, 199, '{"unlimited_questions": true, "weekly_report": true, "transit_alerts": true}', true),
    ('mbti_pro', 'MBTI会员', 'skill_single', ARRAY['mbti'], 29, 199, '{"unlimited_questions": true, "deep_analysis": true, "compatibility": true}', true),
    ('vibelife_all', 'VibeLife 全能', 'vibelife_all', ARRAY['bazi', 'zodiac', 'mbti'], 59, 399, '{"all_skills": true, "cross_skill_insights": true, "priority_support": true}', true)
ON CONFLICT (id) DO NOTHING;

-- Done
SELECT 'VibeLife schema initialized successfully' as result;
