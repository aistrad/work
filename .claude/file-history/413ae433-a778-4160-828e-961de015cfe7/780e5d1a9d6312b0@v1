"""
VibeLife Database Connection
PostgreSQL with asyncpg
"""
import os
from typing import Optional
from contextlib import asynccontextmanager

import asyncpg


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Global Connection Pool
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

_pool: Optional[asyncpg.Pool] = None


def get_db_url() -> str:
    """Get database URL from environment"""
    return os.getenv(
        "VIBELIFE_DB_URL",
        "postgresql://postgres:password@localhost:5432/vibelife"
    )


async def init_db():
    """Initialize database connection pool"""
    global _pool

    if _pool is not None:
        return

    db_url = get_db_url()

    _pool = await asyncpg.create_pool(
        db_url,
        min_size=2,
        max_size=20,
        command_timeout=60,
    )

    # Test connection
    async with _pool.acquire() as conn:
        version = await conn.fetchval("SELECT version()")
        print(f"ðŸ“¦ PostgreSQL: {version[:50]}...")


async def close_db():
    """Close database connection pool"""
    global _pool

    if _pool is not None:
        await _pool.close()
        _pool = None


async def get_db() -> asyncpg.Pool:
    """Get database pool (for dependency injection)"""
    if _pool is None:
        await init_db()
    return _pool


@asynccontextmanager
async def get_connection():
    """Get a database connection from pool"""
    pool = await get_db()
    async with pool.acquire() as conn:
        yield conn


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Utility Functions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async def execute(query: str, *args):
    """Execute a query"""
    async with get_connection() as conn:
        return await conn.execute(query, *args)


async def fetch(query: str, *args):
    """Fetch all rows"""
    async with get_connection() as conn:
        return await conn.fetch(query, *args)


async def fetchrow(query: str, *args):
    """Fetch one row"""
    async with get_connection() as conn:
        return await conn.fetchrow(query, *args)


async def fetchval(query: str, *args):
    """Fetch one value"""
    async with get_connection() as conn:
        return await conn.fetchval(query, *args)
