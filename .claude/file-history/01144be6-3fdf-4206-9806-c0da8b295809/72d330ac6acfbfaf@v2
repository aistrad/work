# Soul OS å¿ƒç†æ¶æ„è®¾è®¡

**ç‰ˆæœ¬**ï¼šv4.2ï¼ˆ2026-01-01ï¼ŒVercel AI SDK Editionï¼‰
**æ–‡æ¡£ç±»å‹**ï¼šOperating System Psychological Architecture
**å®šä½**ï¼šåŸºäºæ·±åº¦å¿ƒç†å­¦çš„ç²¾ç¥æ•°å­—å­ªç”Ÿæ“ä½œç³»ç»Ÿ
**æ ¸å¿ƒæ¶æ„**ï¼šVercel AI SDK Driven / Pluggable Skills / Evolutionary Loop
**ç†è®ºæ¡†æ¶**ï¼šè£æ ¼åˆ†æå¿ƒç†å­¦ Ã— ç§¯æå¿ƒç†å­¦ Ã— è¡Œä¸ºç§‘å­¦ Ã— è‡ªæˆ‘å†³å®šç†è®º
**Agent Runtime**ï¼šVercel AI SDK 6 (`ai` library) + Multi-Model Providers

---

## 0. ä¿®è®¢è¯´æ˜

### 0.0 v4.2 æ¶æ„å‡çº§è¦ç‚¹ (Vercel AI SDK Edition)

æœ¬ç‰ˆæœ¬é‡‡ç”¨ **Vercel AI SDK** ä½œä¸ºç»Ÿä¸€ Agent Runtimeï¼Œæ ¸å¿ƒå˜æ›´ï¼š

1. **Agent Runtime ç»Ÿä¸€åŒ–**ï¼š
   - **å¼ƒç”¨**: `glm_client.py` ç›´æ¥ API è°ƒç”¨
   - **å¼•å…¥**: Vercel AI SDK `streamText()` + `tool()` æ ‡å‡†åŒ–æ¥å£
   - **æ”¯æŒ**: GLM-4.5 / Gemini / Claude å¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢

2. **Skills æ ‡å‡†åŒ– (Tool Calling)**ï¼š
   - L2 Expert Agents é‡æ„ä¸º **Vercel Tools** (Zod Schema + Execute Function)
   - æ”¯æŒ `maxSteps` å¤šæ­¥æ¨ç†ï¼ˆAgent Loop è‡ªåŠ¨åŒ–ï¼‰
   - `/command` æ˜¾å¼è§¦å‘ + è‡ªç„¶è¯­è¨€éšå¼è§¦å‘åŒæ¨¡å¼

3. **å‰åç«¯èŒè´£é‡æ„**ï¼š
   - **Next.js API Route**: æ‰¿è½½ AI æ¨ç†é€»è¾‘ (`streamText`)
   - **FastAPI (Python)**: é™çº§ä¸ºçº¯æ•°æ®æœåŠ¡å±‚ (L0/L1 CRUD)
   - **useChat Hook**: å‰ç«¯æµå¼æ¸²æŸ“æ ‡å‡†åŒ–

4. **æµå¼å¤„ç†æ ‡å‡†åŒ–**ï¼š
   - å¼ƒç”¨è‡ªå®šä¹‰ SSE æ ¼å¼
   - é‡‡ç”¨ `toDataStreamResponse()` + Message Annotations

### 0.0.1 v4.0 â†’ v4.2 æ¶æ„æ¼”è¿›

| v4.0/v4.1 ç»„ä»¶ | v4.2 ç»„ä»¶ | å˜åŒ–è¯´æ˜ |
|----------------|-----------|----------|
| `glm_client.py` | `@ai-sdk/google` / Vercel AI Gateway | **åˆ é™¤** Python LLM å®¢æˆ·ç«¯ |
| `build_system_prompt()` | `system` param in `streamText()` | **è¿ç§»**åˆ° TypeScript |
| L2 Expert Agents (Python) | `tool({ ... })` definitions (TS) | **é‡å†™**ä¸º Tool Definitions |
| è‡ªå®šä¹‰ SSE `/api/chat/stream` | `toDataStreamResponse()` | **æ›¿æ¢**ä¸ºæ ‡å‡†æµ |
| A2UI JSON blocks | Stream + Message Annotations | **é€‚é…**æµå¼æ ¼å¼ |
| Context Manager | ä¿ç•™ Python APIï¼ŒTS è°ƒç”¨è·å– | **ä¿ç•™**æ•°æ®èšåˆé€»è¾‘ |

### 0.0.2 v3.x â†’ v4.0 å±‚æ¬¡æ˜ å°„ (å†å²å‚è€ƒ)

| v3.x å±‚æ¬¡ | v4.0 å±‚æ¬¡ | å˜åŒ– |
|-----------|-----------|------|
| Interaction Layer | Interaction Layer | æ— å˜åŒ– |
| Context Management | Context Manager v4.0 | å¢åŠ  History å‘é‡æ£€ç´¢ |
| L2 Agents | L2 Agents + Insight Agent | æ–°å¢åå°æ´å¯Ÿç®—å­ |
| L1 Module Data | L1 Module Data (å¯åå†™) | æ”¯æŒ Cold Path æ›´æ–° |
| L0 Base Data | L0 Base Data (å¯åå†™) | æ”¯æŒç”»åƒåŠ¨æ€ä¸°æ»¡ |

### 0.1 è®¾è®¡ vs å®ç°å¯¹æ¯”

| æ¨¡å— | è®¾è®¡çŠ¶æ€ | å®ç°çŠ¶æ€ | å·®è·åˆ†æ |
|------|----------|----------|----------|
| L0 Base Data | âœ… å®Œæ•´è®¾è®¡ | âœ… å®Œæ•´å®ç° | å…«å­—è®¡ç®—ç²¾ç¡® |
| L1 Module Data | âœ… å¯æ’æ‹”è®¾è®¡ | âœ… å·²å®ç° | å…«å­—/PERMA æ¨¡å—å°±ç»ª |
| L2 Expert Agents | âœ… å¤šæ¨¡å—è®¾è®¡ | âš ï¸ éƒ¨åˆ†å®ç° | ä»…å…«å­— Agentï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç° |
| L2 Style Agents | âœ… ä¸‰é£æ ¼è®¾è®¡ | âœ… å·²å®ç° | standard/warm/roast |
| Context Management | âœ… ç»„è£…å·¥å‚ | âœ… GLM æ•´åˆ | å·¥ä½œæ­£å¸¸ |
| Interaction Layer | âœ… å¤šæ¨¡å‹æ”¯æŒ | âš ï¸ éƒ¨åˆ†å®ç° | GLM ä¸ºä¸»ï¼ŒGemini/Claude å¤‡é€‰ |
| Goal æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
| Reflection æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
| anti-dependency | âœ… ç­–ç•¥è®¾è®¡ | âš ï¸ å¾…ä¼˜åŒ– | æ–°ç”¨æˆ·è±å…å¾…å®ç° |
| A2UI æ¸²æŸ“ | âœ… action_buttons | âš ï¸ å‰ç«¯é—®é¢˜ | CSRF é—®é¢˜ |

---

## 1. å¤šå±‚æ¶æ„æµç¨‹å›¾å¯¹æ¯”

> **æœ¯è¯­å®šä¹‰**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§7 Soul OS æ¶æ„
> **æ ¸å¿ƒæ¶æ„**: Context Driven / Pluggable Modulesï¼ˆè§ Â§1.4ï¼‰

### 1.1 è®¾è®¡æ¶æ„ (å››å±‚å¿ƒç†æ¶æ„) âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä¿ç•™ä½œä¸º v2 æ¶æ„çš„å†å²å‚è€ƒã€‚
> **âœ… å½“å‰è§„èŒƒ**: è¯·ä½¿ç”¨ [Â§1.4 Context é©±åŠ¨æ¶æ„](#14-context-é©±åŠ¨æ¶æ„-å¯æ’æ‹”æ¨¡å—è§†å›¾) ä½œä¸ºå”¯ä¸€å®ç°ä¾æ®ã€‚
>
> | æ—§æœ¯è¯­ | æ–°æ¶æ„æ˜ å°„ |
> |--------|------------|
> | L0 Firmware (å®šæ•°/æœ¬æˆ‘) | L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ) |
> | L1 Schema (ç‰¹è´¨/å›¾å¼) | L1 Module Data (å¯æ’æ‹”æ•°æ®å±‚) |
> | L2 Agents (ç­–ç•¥/è¶…æˆ‘) | L2 Expert + Style Agents (åŒåˆ†æ”¯) |
> | L3 Synthesis (æ„è¯†/è‡ªæˆ‘) | Context Management + Interaction Layer |

```mermaid
graph TB
    subgraph User["ğŸ‘¤ ç”¨æˆ·äº¤äº’"]
        Input["è¾“å…¥æ¶ˆæ¯"]
    end

    subgraph L3["L3: Synthesis (æ„è¯†/è‡ªæˆ‘)"]
        GLM["å…ƒè®¤çŸ¥ä»²è£å™¨<br/>(GLM Agent)"]
        A2UI["A2UI JSON è¾“å‡º<br/>ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·"]
    end

    subgraph L2["L2: Agents (ç­–ç•¥/è¶…æˆ‘)"]
        BaziAgent["å…«å­—è§£è¯» Agent<br/>æ ¼å±€/å¤§è¿/ç¥ç…"]
        PsyAgent["å¿ƒç†å­¦ Agent<br/>PERMA/CBT/æƒ…ç»ª"]
        ActionAgent["è¡ŒåŠ¨æ•™ç»ƒ Agent<br/>å¤„æ–¹/æ—¶é—´/éš¾åº¦"]
    end

    subgraph L1["L1: Schema (ç‰¹è´¨/å›¾å¼)"]
        PERMA["PERMA äº”ç»´<br/>P-E-R-M-A"]
        StateScore["State Score<br/>æƒ…ç»ª40%+è¡ŒåŠ¨35%+æˆé•¿25%"]
    end

    subgraph L0["L0: Firmware (å®šæ•°/æœ¬æˆ‘)"]
        Bazi["å…«å­—ç¡®å®šæ€§è®¡ç®—<br/>å››æŸ±/åç¥/ç¥ç…/å¤§è¿"]
        Profile["ç”¨æˆ·æ¡£æ¡ˆ<br/>åŸºç¡€ä¿¡æ¯+åå¥½+å†å²"]
    end

    Input --> L3
    GLM --> A2UI

    L2 --> GLM
    BaziAgent --> GLM
    PsyAgent --> GLM
    ActionAgent --> GLM

    L1 --> L2
    PERMA --> BaziAgent
    StateScore --> PsyAgent

    L0 --> L1
    Bazi --> PERMA
    Profile --> StateScore

    style L3 fill:#e8f5e9,stroke:#4caf50
    style L2 fill:#e3f2fd,stroke:#2196f3
    style L1 fill:#fff3e0,stroke:#ff9800
    style L0 fill:#fce4ec,stroke:#e91e63
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Soul OS å››å±‚å¿ƒç†æ¶æ„                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚     ç”¨æˆ·äº¤äº’        â”‚
                           â”‚     è¾“å…¥æ¶ˆæ¯        â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3: Synthesis (æ„è¯†/è‡ªæˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    å…ƒè®¤çŸ¥ä»²è£å™¨          â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    A2UI JSON è¾“å‡º            â”‚        â”‚
â”‚  â”‚    (GLM Agent)          â”‚        â”‚    ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2: Agents (ç­–ç•¥/è¶…æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚              â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                                                          â”‚              â”‚
â”‚  â–¼                          â–¼                          â–¼    â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚
â”‚  â”‚ å…«å­—è§£è¯»Agent â”‚    â”‚ å¿ƒç†å­¦ Agent â”‚    â”‚ è¡ŒåŠ¨æ•™ç»ƒAgent â”‚   â”‚              â”‚
â”‚  â”‚ æ ¼å±€/å¤§è¿/ç¥ç…â”‚    â”‚ PERMA/CBT/æƒ…ç»ªâ”‚    â”‚ å¤„æ–¹/æ—¶é—´/éš¾åº¦â”‚   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                   â”‚                   â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1: Schema (ç‰¹è´¨/å›¾å¼) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚          â”‚                   â”‚                   â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                 â”‚   â”‚                                    â”‚              â”‚
â”‚  â–¼                 â–¼   â”‚                                    â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚ PERMA äº”ç»´       â”‚  â”‚    â”‚ State Score               â”‚  â”‚              â”‚
â”‚  â”‚ P-E-R-M-A       â”‚  â”‚    â”‚ æƒ…ç»ª40% + è¡ŒåŠ¨35% + æˆé•¿25%â”‚  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚           â”‚                   â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L0: Firmware (å®šæ•°/æœ¬æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚           â”‚           â”‚                   â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å…«å­—ç¡®å®šæ€§è®¡ç®—                  â”‚  â”‚ ç”¨æˆ·æ¡£æ¡ˆ                    â”‚       â”‚
â”‚  â”‚ å››æŸ± / åç¥ / ç¥ç… / å¤§è¿       â”‚  â”‚ åŸºç¡€ä¿¡æ¯ + åå¥½ + å†å²       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

**PERMA äº”ç»´å®šä¹‰**:

| ç»´åº¦ | è‹±æ–‡ | å«ä¹‰ | æ•°æ®æ¥æº |
|------|------|------|----------|
| P | Positive Emotion | ç§¯ææƒ…ç»ª | fortune_checkin |
| E | Engagement | æŠ•å…¥ | ä»»åŠ¡å®Œæˆç‡ |
| R | Relationships | å…³ç³» | ç¤¾äº¤äº’åŠ¨ |
| M | Meaning | æ„ä¹‰ | ç›®æ ‡å…³è”åº¦ |
| A | Accomplishment | æˆå°± | ç´¯è®¡å®Œæˆä»»åŠ¡ |

### 1.2 å½“å‰å®ç°æ¶æ„ âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä½¿ç”¨ v2 å››å±‚æœ¯è¯­ï¼Œä¿ç•™ä½œä¸ºä»£ç å®ç°çš„å‚è€ƒæ˜ å°„ã€‚
> **âœ… æ–°æœ¯è¯­**: L0â†’L0 Base, L1â†’L1 Module, L2â†’L2 Expert, L3â†’Interaction Layer

```mermaid
graph LR
    subgraph Services["services/"]
        SoulOS["soul_os.py<br/>æ ¸å¿ƒåè°ƒå™¨"]

        subgraph L0_Impl["L0 å®ç° âœ…"]
            L0Facts["get_l0_facts()"]
            BaziSvc["bazi_service.py"]
        end

        subgraph L1_Impl["L1 å®ç° âœ…"]
            L1Schema["get_l1_schema()"]
            PERMA_Calc["calculate_perma()"]
            StateCalc["calculate_state_score()"]
        end

        subgraph L2_Impl["L2 å®ç° âš ï¸"]
            KBSearch["search_knowledge_base()"]
            AntiDep["check_anti_dependency()"]
        end

        subgraph L3_Impl["L3 å®ç° âœ…"]
            PromptBuild["build_system_prompt()"]
            GLMClient["glm_client.py"]
        end
    end

    SoulOS --> L0Facts
    SoulOS --> L1Schema
    SoulOS --> KBSearch
    SoulOS --> PromptBuild

    L0Facts --> BaziSvc
    L1Schema --> PERMA_Calc
    L1Schema --> StateCalc
    PromptBuild --> GLMClient

    style L0_Impl fill:#d4edda
    style L1_Impl fill:#d4edda
    style L2_Impl fill:#fff3cd
    style L3_Impl fill:#d4edda
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å½“å‰å®ç°æ¶æ„ (services/)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      soul_os.py (æ ¸å¿ƒåè°ƒå™¨)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚     â”‚     â”‚     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                            â”‚     â”‚                            â”‚
    â–¼                            â–¼     â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L0 å®ç° âœ…         â”‚  â”‚ L1 å®ç° âœ…         â”‚  â”‚ L2 å®ç° âš ï¸                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ get_l0_facts()â”‚ â”‚  â”‚ â”‚ get_l1_schemaâ”‚ â”‚  â”‚ â”‚ search_knowledge_base()â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚         â”‚  â”‚         â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â–¼         â”‚  â”‚         â–¼         â”‚  â”‚ â”‚ check_anti_dependency()â”‚   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”‚ bazi_service  â”‚ â”‚  â”‚ â”‚ calculate_    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ .py           â”‚ â”‚  â”‚ â”‚ perma()       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚
                       â”‚ â”‚ calculate_    â”‚ â”‚            â”‚
                       â”‚ â”‚ state_score() â”‚ â”‚            â–¼
                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ L3 å®ç° âœ…                    â”‚
                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                              â”‚ â”‚ build_system_prompt()  â”‚   â”‚
                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                              â”‚             â–¼                â”‚
                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                              â”‚ â”‚ glm_client.py          â”‚   â”‚
                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹: âœ… å®Œæ•´å®ç° | âš ï¸ éƒ¨åˆ†å®ç°
```
</details>

**å®ç°çŠ¶æ€çŸ©é˜µ**:

| å±‚çº§ | ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|:----:|------|
| L0 | çœŸå¤ªé˜³æ—¶æ ¡æ­£ | âœ… | swisseph |
| L0 | å››æŸ±æ’ç›˜ | âœ… | lunar_python |
| L0 | åç¥/ç¥ç…/å¤§è¿ | âœ… | å®Œæ•´å®ç° |
| L0 | facts_hash | âœ… | å¯è¿½æº¯ |
| L1 | PERMA äº”ç»´ | âœ… | è®¡ç®—æ­£ç¡® |
| L1 | State Score | âœ… | èšåˆæ­£ç¡® |
| L1 | è¡Œä¸ºè¯æ®å…³è” | âš ï¸ | å¾…å¢å¼º |
| L2 | çŸ¥è¯†åº“æ£€ç´¢ | âœ… | FTS + trgm |
| L2 | å¤šAgentå¹¶è¡Œ | âš ï¸ | ä»…å…«å­—Agent |
| L3 | GLM è¾“å‡º | âœ… | A2UI JSON |
| L3 | If-Then å¤„æ–¹ | âœ… | æ ¼å¼æ­£ç¡® |

### 1.3 æœ€ä¼˜æ¶æ„ (å®Œæ•´å››å±‚ + ç›®æ ‡/å¤ç›˜é—­ç¯) âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚å±•ç¤º v2 å››å±‚æ—¶åºæµç¨‹ï¼Œä¿ç•™ä½œä¸ºå¯¹è¯æµç¨‹çš„å‚è€ƒã€‚
> **âœ… æ–°æ¶æ„æ˜ å°„**:
> - L0æ•°å­¦è„‘ â†’ L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ)
> - L1å¿ƒç†è„‘ â†’ L1 Module Data (PERMA/å…«å­—ç­‰å¯æ’æ‹”æ•°æ®)
> - L2çŸ¥è¯†è„‘ â†’ L2 Expert Agents (å…«å­—Agent/CBT Agentç­‰)
> - L3è¯­è¨€è„‘ â†’ Context Management + Interaction Layer (å¤šæ¨¡å‹)

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯<br/>(Zone A/B)
    participant API as FastAPI<br/>/api/*
    participant OS as Soul OS<br/>åè°ƒå™¨
    participant L0 as L0 æ•°å­¦è„‘
    participant L1 as L1 å¿ƒç†è„‘
    participant L2 as L2 çŸ¥è¯†è„‘
    participant L3 as L3 è¯­è¨€è„‘
    participant DB as PostgreSQL

    U->>FE: è¾“å…¥æ¶ˆæ¯
    FE->>API: POST /api/chat/send

    rect rgb(240, 248, 255)
        Note over OS,L2: get_full_context(user_id)
        API->>OS: è¯·æ±‚ä¸Šä¸‹æ–‡
        OS->>L0: get_l0_facts()
        L0-->>OS: å…«å­— facts
        OS->>L1: get_l1_schema()
        L1-->>OS: PERMA + State Score
        OS->>L2: search_knowledge_base()
        L2-->>OS: kb_refs + rule_ids
        OS->>DB: get_active_goals()
        DB-->>OS: æ´»è·ƒç›®æ ‡åˆ—è¡¨
    end

    rect rgb(255, 248, 240)
        Note over OS,L3: L3 Synthesis
        OS->>L3: System Prompt + context
        L3-->>OS: A2UI JSON<br/>(â‰¤3 If-Then å¤„æ–¹)
    end

    OS->>DB: INSERT conversation_message
    OS->>DB: INSERT commitment (suggested)
    OS-->>FE: A2UI å“åº”

    FE->>FE: Zone A æ¸²æŸ“æ¶ˆæ¯
    FE->>FE: Zone B åˆ·æ–°ä»»åŠ¡
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ€ä¼˜å››å±‚æ¶æ„ + ç›®æ ‡/å¤ç›˜é—­ç¯                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·    å‰ç«¯Zone    FastAPI    SoulOS    L0æ•°å­¦    L1å¿ƒç†    L2çŸ¥è¯†    L3è¯­è¨€    DB
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚â”€â”€è¾“å…¥â”€â–¶â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€POSTâ”€â”€â”€â”€â–¶â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚ chat/send â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚ get_full_context(user_id)     â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€è¯·æ±‚ä¸Šä¸‹æ–‡â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_l0_facts()â”€â”€â–¶â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€å…«å­— factsâ”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_l1_schema()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€PERMA + State Scoreâ”€â”€â”€â”€â”€â”€â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€search_kb()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€kb_refs + rule_idsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_active_goals()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€ç›®æ ‡åˆ—è¡¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚ L3 Synthesis        â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€System Prompt + contextâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€A2UI JSON (â‰¤3 If-Then å¤„æ–¹)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT conversation_messageâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT commitment (suggested)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â—€â”€â”€A2UI å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€Zone A æ¸²æŸ“æ¶ˆæ¯      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€Zone B åˆ·æ–°ä»»åŠ¡      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
```
</details>

**ä¼˜åŒ–é¡¹**:

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | è¯´æ˜ |
|:------:|--------|------|
| P0 | action_buttons + CSRF | å‰ç«¯ç‚¹å‡»å¤„ç† |
| P1 | anti-dependency è±å… | æ–°ç”¨æˆ· 7 å¤©è±å… |
| P1 | å¤„æ–¹å…³è”ç›®æ ‡ | è‡ªåŠ¨å…³è”æ´»è·ƒç›®æ ‡ |
| P2 | å¤šAgentå¹¶è¡Œ | å…«å­—/å¿ƒç†/è¡ŒåŠ¨ Agent |
| P2 | å…¨é“¾è·¯è¿½è¸ª | correlation_id |

### 1.4 è¿›åŒ–è®°å¿†æ¶æ„ (Vercel AI SDK Edition) - v4.2

> **v4.2 æ ¸å¿ƒ**: Vercel AI SDK ç»Ÿä¸€ Agent Runtime + åŒè·¯å¾„è®¾è®¡ (Hot Path + Cold Path)
> **é‡æ„æ–¹æ¡ˆ**: è¯¦è§ [restructure_v3.md](./restructure_v3.md)

```
+============================================================================================+
|                            Soul OS Architecture v4.2                                        |
|                       (Vercel AI SDK Driven / Pluggable Skills)                             |
+============================================================================================+
                                            ^
                            1. æµå¼å“åº” (Stream Response)
+--------------------------------------------------------------------------------------------+
|  Frontend Layer (React / Next.js)                                                          |
+--------------------------------------------------------------------------------------------+
|  [ useChat() Hook ]  â†â†’  [ toDataStreamResponse() ]  â†â†’  [ Message Annotations ]          |
|  [ CommandPalette ]  â†â†’  [ /command Parser ]        â†â†’  [ A2UI Renderer ]                 |
+--------------------------------------------------------------------------------------------+
                                            ^
                                            | HTTP Stream (text/event-stream)
+--------------------------------------------------------------------------------------------+
|  Agent Runtime Layer (Next.js API Route)                                     NEW in v4.2   |
+--------------------------------------------------------------------------------------------+
|  [ Vercel AI SDK `streamText()` ]                                                          |
|  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
|  â”‚  const result = await streamText({                                                   â”‚  |
|  â”‚    model: selectModel(user.preference),  // GLM-4.5 / Gemini / Claude               â”‚  |
|  â”‚    system: buildSystemPrompt(context),   // Context Manager ç»„è£…                    â”‚  |
|  â”‚    messages: history,                                                               â”‚  |
|  â”‚    tools: getToolsForMode(mode),         // Skills Registry ç­›é€‰                    â”‚  |
|  â”‚    maxSteps: 5,                          // Agent Loop å¤šæ­¥æ¨ç†                     â”‚  |
|  â”‚  });                                                                                 â”‚  |
|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  |
+--------------------------------------------------------------------------------------------+
        |                           |                               |
        | Model Provider            | Tools (Skills)                | Context
        v                           v                               v
+------------------+  +---------------------------+  +----------------------------------+
| Multi-Model Hub  |  | Skills Registry (Tools)   |  | Context Manager v4.2             |
+------------------+  +---------------------------+  +----------------------------------+
| @ai-sdk/google   |  | Divine Skills:            |  | L0 Base Data (Profile/Status)   |
|   â””â”€ Gemini 2.0  |  |   - calculate_bazi        |  | L1 Module Data (PERMA/Covey)    |
| Vercel Gateway   |  |   - calculate_ziwei       |  | Vector History (Long-term Mem)  |
|   â””â”€ GLM-4.5     |  | Heal Skills:              |  | User Input + Command            |
| @ai-sdk/anthropic|  |   - log_perma             |  +----------------------------------+
|   â””â”€ Claude      |  |   - cbt_reframe           |            |
+------------------+  | Grow Skills:              |            | fetch()
                      |   - covey_matrix          |            v
                      |   - goal_setting          |  +----------------------------------+
                      +---------------------------+  | FastAPI (Python) - Data Service  |
                                |                    +----------------------------------+
                                | Tool Execute       | GET  /api/bazi/calculate        |
                                | fetch() call       | GET  /api/user/context          |
                                v                    | POST /api/perma/log             |
                      +---------------------------+  | GET  /api/goals/active          |
                      | Python Data Layer         |  +----------------------------------+
                      +---------------------------+
                      | L1 Module Services:       |
                      |   bazi_service.py         |
                      |   perma_service.py        |
                      |   goal_service.py         |
                      +---------------------------+
                      | L0 Base Services:         |
                      |   twin_service.py         |
                      |   fortune_db.py           |
                      +---------------------------+
                                ^
                                | 2. Cold Path (å¼‚æ­¥æ´å¯Ÿ)
+-------------------------------+--------------------------------------------------------+
| Insight & Memory Agent (Cold Path Worker)                                               |
+-----------------------------------------------------------------------------------------+
|  [ åå° Cron / Queue Worker ]                                                           |
|  - åˆ†æå¯¹è¯å†å²ï¼Œæå–äº‹å®/åå¥½/çŠ¶æ€                                                     |
|  - åå†™ L0 Profile (job, tags, status)                                                  |
|  - åå†™ L1 Module Data (PERMA scores, CBT triggers)                                     |
+-----------------------------------------------------------------------------------------+
```

**æ¶æ„å±‚æ¬¡è¯´æ˜ (v4.2)**:

| å±‚çº§ | å®šä¹‰ | æŠ€æœ¯å®ç° | è¿è¡Œç¯å¢ƒ | èŒè´£ |
|------|------|----------|----------|------|
| **Frontend** | UI äº¤äº’å±‚ | `useChat()` Hook | Next.js Client | æµå¼æ¸²æŸ“ã€Command è§£æ |
| **Agent Runtime** | AI æ¨ç†å±‚ | `streamText()` + `tool()` | Next.js API Route | **æ ¸å¿ƒ**: LLM è°ƒç”¨ä¸ Tool Calling |
| **Multi-Model Hub** | æ¨¡å‹æä¾›å±‚ | Vercel AI Gateway | Serverless | GLM-4.5 / Gemini / Claude åŠ¨æ€åˆ‡æ¢ |
| **Skills Registry** | æŠ€èƒ½æ³¨å†Œå±‚ | Zod Schema + Execute | TypeScript | å¯æ’æ‹” Tools å®šä¹‰ |
| **Context Manager** | ä¸Šä¸‹æ–‡ç»„è£… | Python API + TS fetch | Hybrid | L0+L1+History èšåˆ |
| **Data Service** | æ•°æ®æœåŠ¡å±‚ | FastAPI | Python | L0/L1 CRUD + ä¸šåŠ¡é€»è¾‘ |
| **Insight Agent** | æ´å¯Ÿç®—å­ | Cron Worker | Python | Cold Path æ•°æ®æ²‰æ·€ |

**å…³é”®è®¾è®¡åŸåˆ™ (v4.2)**:

1. **Agent Runtime ç»Ÿä¸€**: æ‰€æœ‰ AI æ¨ç†é€»è¾‘é›†ä¸­åœ¨ Next.js API Routeï¼Œä½¿ç”¨ Vercel AI SDK æ ‡å‡†åŒ–æ¥å£
2. **Tool Calling æ ‡å‡†åŒ–**: L2 Expert Agents é‡æ„ä¸º `tool({ description, parameters, execute })` æ ¼å¼
3. **æµå¼ä¼˜å…ˆ**: `toDataStreamResponse()` + `useChat()` å®ç°ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“
4. **è·¨è¯­è¨€æ¡¥æ¥**: Tool execute å‡½æ•°é€šè¿‡ `fetch()` è°ƒç”¨ Python FastAPIï¼Œä¿ç•™ç°æœ‰æ•°æ®æœåŠ¡
5. **å¤šæ¨¡å‹çƒ­åˆ‡æ¢**: é€šè¿‡ `selectModel()` æ ¹æ®ç”¨æˆ·åå¥½æˆ–åŠŸèƒ½éœ€æ±‚åŠ¨æ€é€‰æ‹© GLM/Gemini/Claude
6. **maxSteps å¤šæ­¥æ¨ç†**: å¯ç”¨ Agent Loopï¼Œå•æ¬¡è¯·æ±‚å¯å¤šæ¬¡ Tool è°ƒç”¨åç»¼åˆè¾“å‡º

### 1.5 Agent Runtime & Skills (Vercel AI SDK Implementation) - v4.2

> **è®¾è®¡ç†å¿µ**: ä½¿ç”¨ Vercel AI SDK 6 ä½œä¸ºç»Ÿä¸€ Agent Runtimeï¼Œå°† L2 Agents é‡æ„ä¸ºæ ‡å‡†åŒ–çš„ `tool()` å®šä¹‰ï¼Œå®ç°ç±»å‹å®‰å…¨çš„ Tool Callingã€‚
> **æ ¸å¿ƒä»·å€¼**: ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“ + å¤šæ¨¡å‹çƒ­åˆ‡æ¢ + maxSteps å¤šæ­¥æ¨ç†

#### 1.5.1 Skills Registry (Vercel Tools)

Skills ä½¿ç”¨ Vercel AI SDK çš„ `tool()` å‡½æ•°å®šä¹‰ï¼Œé‡‡ç”¨ Zod Schema è¿›è¡Œç±»å‹éªŒè¯ï¼š

```typescript
// lib/skills/divine-skills.ts
import { tool } from 'ai';
import { z } from 'zod';

export const divineSkills = {
  calculate_bazi: tool({
    description: 'è®¡ç®—ç”¨æˆ·çš„å…«å­—å‘½ç›˜ï¼Œè¿”å›å››æŸ±ã€äº”è¡Œã€åç¥ã€ç¥ç…ç­‰ä¿¡æ¯',
    parameters: z.object({
      birth_datetime: z.string().describe('å‡ºç”Ÿæ—¥æœŸæ—¶é—´ (ISO 8601)'),
      timezone: z.string().default('Asia/Shanghai').describe('æ—¶åŒºæ ‡è¯†'),
      include_dayun: z.boolean().default(true).describe('æ˜¯å¦åŒ…å«å¤§è¿ä¿¡æ¯'),
    }),
    execute: async ({ birth_datetime, timezone, include_dayun }) => {
      // è°ƒç”¨ Python FastAPI åç«¯
      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),
      });
      return res.json();
    },
  }),

  calculate_ziwei: tool({
    description: 'è®¡ç®—ç´«å¾®æ–—æ•°å‘½ç›˜ï¼Œè¿”å›å‘½å®«ã€åäºŒå®«ä½ã€æµå¹´ä¿¡æ¯',
    parameters: z.object({
      birth_datetime: z.string(),
      gender: z.enum(['male', 'female']),
    }),
    execute: async ({ birth_datetime, gender }) => {
      const res = await fetch(`${FASTAPI_URL}/api/ziwei/calculate`, {
        method: 'POST',
        body: JSON.stringify({ birth_datetime, gender }),
      });
      return res.json();
    },
  }),
};
```

```typescript
// lib/skills/heal-skills.ts
export const healSkills = {
  log_perma: tool({
    description: 'è®°å½•æˆ–æŸ¥è¯¢ç”¨æˆ·çš„ PERMA äº”ç»´å¿ƒç†çŠ¶æ€åˆ†æ•°',
    parameters: z.object({
      action: z.enum(['log', 'query']),
      dimension: z.enum(['P', 'E', 'R', 'M', 'A']).optional(),
      score_delta: z.number().min(-1).max(1).optional(),
    }),
    execute: async ({ action, dimension, score_delta }) => {
      const res = await fetch(`${FASTAPI_URL}/api/perma/${action}`, {
        method: action === 'log' ? 'POST' : 'GET',
        body: action === 'log' ? JSON.stringify({ dimension, score_delta }) : undefined,
      });
      return res.json();
    },
  }),

  cbt_reframe: tool({
    description: 'ä½¿ç”¨ CBT ABC æ¨¡å‹è¿›è¡Œè®¤çŸ¥é‡æ„å¼•å¯¼',
    parameters: z.object({
      activating_event: z.string().describe('è§¦å‘äº‹ä»¶ (A)'),
      belief: z.string().optional().describe('ä¿¡å¿µ/æƒ³æ³• (B)'),
      consequence: z.string().optional().describe('æƒ…ç»ª/è¡Œä¸ºåæœ (C)'),
    }),
    execute: async (params) => {
      // è¿”å› CBT å¼•å¯¼æ¡†æ¶ï¼Œè®© LLM ç»§ç»­å¼•å¯¼ç”¨æˆ·
      return {
        framework: 'ABC',
        guidance: `è®©æˆ‘ä»¬ç”¨ ABC æ¨¡å‹æ¥åˆ†æè¿™ä¸ªæƒ…å†µ...`,
        params,
      };
    },
  }),

  mood_checkin: tool({
    description: 'å¿«é€Ÿæƒ…ç»ªæ‰“å¡ï¼Œè®°å½•å½“å‰å¿ƒæƒ…å’Œå½’å› ',
    parameters: z.object({
      mood_score: z.number().min(1).max(10).describe('å¿ƒæƒ…åˆ†æ•° 1-10'),
      tags: z.array(z.string()).optional().describe('æƒ…ç»ªæ ‡ç­¾'),
      note: z.string().optional().describe('ç®€çŸ­å¤‡æ³¨'),
    }),
    execute: async ({ mood_score, tags, note }) => {
      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {
        method: 'POST',
        body: JSON.stringify({ mood_score, tags, note }),
      });
      return res.json();
    },
  }),
};
```

```typescript
// lib/skills/grow-skills.ts
export const growSkills = {
  covey_matrix: tool({
    description: 'ä½¿ç”¨é«˜æ•ˆèƒ½äººå£«æ—¶é—´ç®¡ç†çŸ©é˜µåˆ†ç±»ä»»åŠ¡',
    parameters: z.object({
      task_content: z.string().describe('ä»»åŠ¡æè¿°'),
      urgency: z.enum(['urgent', 'not_urgent']),
      importance: z.enum(['important', 'not_important']),
    }),
    execute: async ({ task_content, urgency, importance }) => {
      const quadrant =
        urgency === 'urgent' && importance === 'important' ? 'Q1' :
        urgency === 'not_urgent' && importance === 'important' ? 'Q2' :
        urgency === 'urgent' && importance === 'not_important' ? 'Q3' : 'Q4';

      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {
        method: 'POST',
        body: JSON.stringify({ task_content, quadrant }),
      });
      return { quadrant, ...await res.json() };
    },
  }),

  goal_setting: tool({
    description: 'ä½¿ç”¨ WOOP æ¨¡å‹è®¾å®šç›®æ ‡ (Wish-Outcome-Obstacle-Plan)',
    parameters: z.object({
      wish: z.string().describe('æ„¿æœ›/ç›®æ ‡'),
      outcome: z.string().optional().describe('æœ€ä½³ç»“æœ'),
      obstacle: z.string().optional().describe('å†…åœ¨éšœç¢'),
      plan: z.string().optional().describe('If-Then è®¡åˆ’'),
    }),
    execute: async (params) => {
      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {
        method: 'POST',
        body: JSON.stringify(params),
      });
      return res.json();
    },
  }),
};
```

**Skills åˆ†ç±»è¡¨**:

| ç±»åˆ« | è§¦å‘æŒ‡ä»¤ | Tool Name | Python API Endpoint | åŠŸèƒ½ |
|------|----------|-----------|---------------------|------|
| **Divine** | `/divine` | `calculate_bazi` | `/api/bazi/calculate` | å…«å­—æ’ç›˜è®¡ç®— |
|  |  | `calculate_ziwei` | `/api/ziwei/calculate` | ç´«å¾®æ–—æ•°è®¡ç®— |
|  |  | `astro_chart` | `/api/astro/chart` | æ˜Ÿåº§æ˜Ÿç›˜ |
| **Heal** | `/heal` | `log_perma` | `/api/perma/{action}` | PERMA çŠ¶æ€è®°å½• |
|  |  | `cbt_reframe` | - (LLM å†…ç½®) | è®¤çŸ¥é‡æ„å¼•å¯¼ |
|  |  | `mood_checkin` | `/api/checkin/mood` | æƒ…ç»ªæ‰“å¡ |
| **Grow** | `/grow` | `covey_matrix` | `/api/tasks/create` | æ—¶é—´ç®¡ç†çŸ©é˜µ |
|  |  | `goal_setting` | `/api/goals/create` | WOOP ç›®æ ‡è®¾å®š |

#### 1.5.2 Agent Runtime API Route

æ ¸å¿ƒ API Route ä½¿ç”¨ `streamText()` å¤„ç†èŠå¤©è¯·æ±‚ï¼š

```typescript
// app/api/chat/route.ts
import { streamText, tool } from 'ai';
import { createGoogleGenerativeAI } from '@ai-sdk/google';
import { divineSkills } from '@/lib/skills/divine-skills';
import { healSkills } from '@/lib/skills/heal-skills';
import { growSkills } from '@/lib/skills/grow-skills';

// Multi-Model Provider Setup
const providers = {
  gemini: createGoogleGenerativeAI({ apiKey: process.env.GOOGLE_API_KEY }),
  // GLM via Vercel AI Gateway
  glm: createGoogleGenerativeAI({
    baseURL: 'https://gateway.ai.cloudflare.com/v1/xxx/glm',
    apiKey: process.env.GLM_API_KEY
  }),
};

export async function POST(req: Request) {
  const { messages, userId, mode, command } = await req.json();

  // 1. è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ (è°ƒç”¨ Python FastAPI)
  const context = await fetch(`${FASTAPI_URL}/api/user/${userId}/context`).then(r => r.json());

  // 2. æ„å»º System Prompt
  const systemPrompt = buildSystemPrompt(context, mode, command);

  // 3. æ ¹æ®æ¨¡å¼ç­›é€‰ Tools
  const tools = getToolsForMode(mode, command);

  // 4. é€‰æ‹©æ¨¡å‹
  const model = selectModel(context.user_preference);

  // 5. æµå¼ç”Ÿæˆ
  const result = await streamText({
    model,
    system: systemPrompt,
    messages,
    tools,
    maxSteps: 5,  // å¯ç”¨å¤šæ­¥æ¨ç†
    onStepFinish: async ({ stepType, toolCalls, toolResults }) => {
      // è®°å½• Tool è°ƒç”¨æ—¥å¿—
      if (toolCalls) {
        await logToolCalls(userId, toolCalls, toolResults);
      }
    },
  });

  return result.toDataStreamResponse();
}

// æ ¹æ®æ¨¡å¼ç­›é€‰ Tools
function getToolsForMode(mode: string, command?: string) {
  const allTools = { ...divineSkills, ...healSkills, ...growSkills };

  if (command) {
    // Command Mode: åªæš´éœ²å¯¹åº”ç±»åˆ«çš„ Tools
    const toolMap: Record<string, string[]> = {
      '/divine': ['calculate_bazi', 'calculate_ziwei', 'astro_chart'],
      '/heal': ['log_perma', 'cbt_reframe', 'mood_checkin'],
      '/grow': ['covey_matrix', 'goal_setting'],
    };
    const allowedTools = toolMap[command] || [];
    return Object.fromEntries(
      Object.entries(allTools).filter(([name]) => allowedTools.includes(name))
    );
  }

  // Chat Mode: æš´éœ²æ‰€æœ‰ Toolsï¼Œè®© LLM è‡ªè¡Œé€‰æ‹©
  return allTools;
}

// é€‰æ‹©æ¨¡å‹
function selectModel(preference?: string) {
  const modelMap: Record<string, any> = {
    'glm': providers.glm('glm-4'),
    'gemini': providers.gemini('gemini-2.0-flash'),
    'default': providers.gemini('gemini-2.0-flash'),
  };
  return modelMap[preference || 'default'];
}
```

#### 1.5.3 Frontend Integration (useChat Hook)

å‰ç«¯ä½¿ç”¨ `useChat` Hook å®ç°æµå¼æ¸²æŸ“ï¼š

```typescript
// components/chat.tsx
'use client';
import { useChat } from 'ai/react';
import { useState } from 'react';
import { CommandPalette } from './command-palette';

export function Chat({ userId }: { userId: string }) {
  const [command, setCommand] = useState<string | null>(null);

  const { messages, input, setInput, handleSubmit, isLoading } = useChat({
    api: '/api/chat',
    body: { userId, command },
    onFinish: (message) => {
      // æ¸…é™¤ command çŠ¶æ€
      setCommand(null);
    },
  });

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setInput(value);

    // æ£€æµ‹ / æŒ‡ä»¤
    if (value.startsWith('/')) {
      // æ˜¾ç¤º CommandPalette
    }
  };

  const handleCommandSelect = (cmd: string) => {
    setCommand(cmd);
    setInput('');  // æ¸…ç©ºè¾“å…¥æ¡†
  };

  return (
    <div className="chat-container">
      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <div className="messages">
        {messages.map((m) => (
          <div key={m.id} className={`message ${m.role}`}>
            {m.content}
            {/* æ¸²æŸ“ Tool è°ƒç”¨ç»“æœ */}
            {m.toolInvocations?.map((tool) => (
              <ToolResultRenderer key={tool.toolCallId} tool={tool} />
            ))}
          </div>
        ))}
      </div>

      {/* Command Palette */}
      <CommandPalette
        visible={input.startsWith('/')}
        onSelect={handleCommandSelect}
      />

      {/* è¾“å…¥æ¡† */}
      <form onSubmit={handleSubmit}>
        <input
          value={input}
          onChange={handleInputChange}
          placeholder={command ? `${command} æ¨¡å¼å·²æ¿€æ´»...` : 'è¾“å…¥æ¶ˆæ¯æˆ– / æŒ‡ä»¤...'}
        />
        <button type="submit" disabled={isLoading}>
          {isLoading ? 'æ€è€ƒä¸­...' : 'å‘é€'}
        </button>
      </form>
    </div>
  );
}
```

#### 1.5.4 Command Protocol (v4.2)

Command æ¨¡å¼åœ¨ v4.2 ä¸­é€šè¿‡ **Tool ç­›é€‰ + System Prompt æ³¨å…¥** å®ç°ï¼š

```typescript
// Command Mode: æ„å»ºå¼ºåˆ¶æ‰§è¡Œçš„ System Prompt
function buildSystemPrompt(context: UserContext, mode: string, command?: string) {
  let prompt = BASE_SYSTEM_PROMPT;

  // æ³¨å…¥ç”¨æˆ·ä¸Šä¸‹æ–‡
  prompt += `\n\n## ç”¨æˆ·æ¡£æ¡ˆ\n${JSON.stringify(context.profile)}`;
  prompt += `\n\n## å½“å‰çŠ¶æ€\n${JSON.stringify(context.status)}`;

  if (command) {
    // Command Mode: å¼ºåˆ¶ä½¿ç”¨ç‰¹å®š Tool
    const commandConfig: Record<string, string> = {
      '/divine': `ç”¨æˆ·æ˜¾å¼è§¦å‘äº†ã€ç„å­¦æµ‹ç®—ã€‘æ¨¡å¼ã€‚ä½ å¿…é¡»ä½¿ç”¨ calculate_bazi æˆ–ç›¸å…³å·¥å…·è¿›è¡Œåˆ†æã€‚`,
      '/heal': `ç”¨æˆ·æ˜¾å¼è§¦å‘äº†ã€å¿ƒç†ç–—æ„ˆã€‘æ¨¡å¼ã€‚ä¼˜å…ˆä½¿ç”¨ mood_checkin æˆ– cbt_reframe å·¥å…·ã€‚`,
      '/grow': `ç”¨æˆ·æ˜¾å¼è§¦å‘äº†ã€æˆé•¿æ•™ç»ƒã€‘æ¨¡å¼ã€‚ä½¿ç”¨ goal_setting æˆ– covey_matrix å·¥å…·å¸®åŠ©ç”¨æˆ·ã€‚`,
    };
    prompt += `\n\n## æŒ‡ä»¤æ¨¡å¼\n${commandConfig[command] || ''}`;
  }

  return prompt;
}
```

**Command åè®®è¡¨**:

| æŒ‡ä»¤ | æ¨¡å¼åç§° | ç­›é€‰ Tools | System Prompt æ³¨å…¥ |
|------|----------|------------|-------------------|
| `/divine` | ç„å­¦æµ‹ç®— | `calculate_bazi`, `calculate_ziwei`, `astro_chart` | å¼ºåˆ¶ä½¿ç”¨ç„å­¦åˆ†æå·¥å…· |
| `/heal` | å¿ƒç†ç–—æ„ˆ | `log_perma`, `cbt_reframe`, `mood_checkin` | ä¼˜å…ˆæƒ…ç»ªå…³æ€€ä¸è®¤çŸ¥é‡æ„ |
| `/grow` | æˆé•¿æ•™ç»ƒ | `covey_matrix`, `goal_setting` | èšç„¦ç›®æ ‡ä¸ä»»åŠ¡ç®¡ç† |
| `/status` | çŠ¶æ€æŸ¥è¯¢ | `log_perma` (query mode) | è¿”å›å½“å‰å¿ƒç†çŠ¶æ€æ‘˜è¦ |

#### 1.5.5 æµå¼å“åº”ä¸ A2UI é€‚é…

v4.2 ä½¿ç”¨ `toDataStreamResponse()` æ ‡å‡†åŒ–æµå¼è¾“å‡ºï¼ŒA2UI å—é€šè¿‡ Message Annotations ä¼ é€’ï¼š

```typescript
// A2UI æ ¼å¼é€šè¿‡ Tool Result è¿”å›ï¼Œå‰ç«¯è§£ææ¸²æŸ“
// ç¤ºä¾‹: calculate_bazi è¿”å›ç»“æ„åŒ–æ•°æ®

// Tool execute è¿”å›
return {
  type: 'a2ui_card',
  data: {
    title: 'å…«å­—å‘½ç›˜åˆ†æ',
    sections: [
      { type: 'text', content: 'æ‚¨çš„æ—¥ä¸»ä¸ºã€ç”²æœ¨ã€‘...' },
      { type: 'chart', data: baziChart },
      { type: 'action_buttons', buttons: [
        { label: 'æŸ¥çœ‹å¤§è¿', action: 'divine', params: { include_dayun: true } },
        { label: 'æƒ…ç»ªæ‰“å¡', action: 'heal', params: { mode: 'checkin' } },
      ]},
    ],
  },
};
```

```typescript
// å‰ç«¯ A2UI æ¸²æŸ“å™¨
function ToolResultRenderer({ tool }: { tool: ToolInvocation }) {
  if (tool.state !== 'result') return null;

  const result = tool.result;
  if (result.type === 'a2ui_card') {
    return <A2UICard data={result.data} />;
  }

  // é»˜è®¤ JSON æ¸²æŸ“
  return <pre>{JSON.stringify(result, null, 2)}</pre>;
}
```

#### 1.5.6 å®ç°çŠ¶æ€ (v4.2)

| ç»„ä»¶ | è®¾è®¡ | TypeScript | Python API | è¯´æ˜ |
|------|:----:|:----------:|:----------:|------|
| Agent Runtime | âœ… | âš ï¸ | - | Next.js API Route å¾…åˆ›å»º |
| `divineSkills` | âœ… | âš ï¸ | âœ… | å…«å­— API å·²å°±ç»ª |
| `healSkills` | âœ… | âš ï¸ | âš ï¸ | PERMA/CBT API å¾…å®Œå–„ |
| `growSkills` | âœ… | âš ï¸ | âœ… | Goal API å·²å°±ç»ª |
| `useChat` Hook | âœ… | âš ï¸ | - | å‰ç«¯å¾…é‡æ„ |
| Command Parser | âœ… | âš ï¸ | - | å‰ç«¯ CommandPalette å¾…å®ç° |
| Multi-Model Hub | âœ… | âš ï¸ | - | Vercel AI Gateway é…ç½®å¾…å®Œæˆ |
| A2UI Streaming | âœ… | âš ï¸ | - | Tool Result æ ¼å¼å¾…é€‚é… |

---

## 2. è®°å¿†æ²‰æ·€ä¸è¿›åŒ–å›è·¯ (Memory Sedimentation & Evolutionary Loop)

> **v4.0 æ ¸å¿ƒå‡çº§**: Soul OS ä¸å†æ˜¯å•å‘çš„"è¯»å–æ•°æ® â†’ ç”Ÿæˆå›ç­”"ï¼Œè€Œæ˜¯åŒå‘é—­ç¯çš„**è¿›åŒ–ç³»ç»Ÿ**ã€‚
> **æ‰¿è¯ºçŠ¶æ€æœº**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§5
> **åŒ—ææ˜ŸæŒ‡æ ‡**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§10 WCG

### 2.1 åŒè·¯å¾„æ¶æ„ (Hot Path + Cold Path)

| è·¯å¾„ | ç±»å‹ | èŒè´£ | å»¶è¿Ÿè¦æ±‚ |
|------|------|------|----------|
| **Hot Path** | åŒæ­¥ | è¯»å– L0/L1 â†’ ç»„è£… Context â†’ ç”Ÿæˆå›å¤ | <2s (è¿½æ±‚ä½å»¶è¿Ÿ) |
| **Cold Path** | å¼‚æ­¥ | åˆ†æäº¤äº’å†å² â†’ æå–äº‹å®/åå¥½/çŠ¶æ€ â†’ åå†™ L0/L1 | åå°å¤„ç† |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                               Soul OS Architecture v4.0                                 â”‚
â”‚                       (Dynamic Profiling & Evolutionary Loop)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                            ^
                                            |  1. äº¤äº’/å“åº” (Response)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Interaction Layer (äº¤äº’å±‚ - Vercel SDK / Chat UI)                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [LLM Core: GLM/GPT] â”‚  <-- å®æ—¶å¯¹è¯æµ (Stream) -->   â”‚  2. å¼‚æ­¥æŠ•é€’ (Async Queue)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           ^                                                              |
           | 3. æ³¨å…¥ Context                                              v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Manager (ä¸Šä¸‹æ–‡ç»„è£…å·¥å‚)        â”‚         â”‚  Memory & Insight Pipeline         â”‚
â”‚  (Prompt Engineering / Context Window)   â”‚         â”‚  (æ•°æ®æ²‰æ·€/ETLæµæ°´çº¿)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    ^                   ^                            â”‚  * ç‹¬ç«‹è¿è¡Œçš„åå° Agent            â”‚
    | (Load Prompts)    | (Load Data)                â”‚  * ä»»åŠ¡: æå–äº‹å®, æ„ŸçŸ¥æƒ…ç»ª        â”‚
â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  * å·¥å…·: NLP / Classification      â”‚
â”‚ L2: Agents Layer (Prompt/Strategy)       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                           |
â”‚ â”‚ Style Agents   â”‚  â”‚ Expert Agents    â”‚ â”‚                           |
â”‚ â”‚ (Tone/Persona) â”‚  â”‚ (Domain Know.)   â”‚ â”‚                           |
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                           |
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           |
                                                                       |
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            |  4. Data Write Back (æ•°æ®åå†™/æ›´æ–°)
            |  (ç»“æ„åŒ–æå– -> æ˜ å°„åˆ°å¯¹åº” Schema)
            v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L1: Module Data Layer (å‚ç±»æ•°æ®å±‚)  <-- [Update by Insight Agent]                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ›´æ–°é€»è¾‘: æå–ç‰¹å®šé¢†åŸŸçš„åŠ¨æ€æ•°æ®]                                                      â”‚
â”‚                                                                                         â”‚
â”‚  â”œâ”€â–º (Update) [å…«å­—/ç´«å¾®] ä¿®æ­£å‡ºç”Ÿæ—¶é—´ï¼Œè®°å½•æµæœˆè¿åŠ¿éªŒè¯åé¦ˆ                             â”‚
â”‚  â”œâ”€â–º (Update) [PERMA]    è¯†åˆ«ç”¨æˆ·å½“ä¸‹çš„ E/R ç»´åº¦å¾—åˆ†å˜åŒ–ï¼Œæ›´æ–°åˆ†æ•°                       â”‚
â”‚  â”œâ”€â–º (Update) [Covey]    è¯†åˆ«ç”¨æˆ·å®Œæˆäº†"è¦äº‹ç¬¬ä¸€"çš„ä»»åŠ¡ï¼Œæ‰“é’©/æ›´æ–°è¿›åº¦                   â”‚
â”‚  â””â”€â–º (Update) [CBT/æƒ…ç»ª] è®°å½•æœ¬æ¬¡ Trigger äº‹ä»¶ï¼Œå½’æ¡£åˆ°æƒ…ç»ªæ—¥å¿—                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            |
            v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  L0: Base Data Layer (ç”¨æˆ·åŸºåº§) <-- [Update by Insight Agent]                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ›´æ–°é€»è¾‘: å…¨å±€é€šç”¨ä¿¡æ¯çš„æ²‰æ·€]                                                          â”‚
â”‚                                                                                         â”‚
â”‚  â”œâ”€â–º (Update) [åŸºç¡€ä¿¡æ¯] ç”¨æˆ·æ— æ„ä¸­æåˆ°"æˆ‘ä¸‹å‘¨å»ä¸Šæµ·" â†’ æ›´æ–° Location/Plan               â”‚
â”‚  â”œâ”€â–º (Update) [åå¥½/Tags] ç”¨æˆ·è¯´"åˆ«ç»™æˆ‘è®²å¤§é“ç†" â†’ Tag: Hate_Preaching                   â”‚
â”‚  â”œâ”€â–º (Update) [å½“å‰çŠ¶æ€] è¿ç»­3æ¬¡å¯¹è¯è¯­æ°”ä½è½ â†’ Status: Depressed â†’ å½±å“L2ç­–ç•¥            â”‚
â”‚  â””â”€â–º (Update) [å†å²æ‘˜è¦] å°†é•¿å¯¹è¯ Summary å­˜å…¥ Long-term Memory                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒä»·å€¼**: Soul OS å…·å¤‡**æˆé•¿æ€§**ã€‚å®ƒè¶Šç”¨è¶Šæ‡‚ç”¨æˆ·ï¼Œè¶Šç”¨æ•°æ®è¶Šåšã€‚

### 2.2 Insight & Memory Agent (æ´å¯Ÿä¸è®°å¿†ç®—å­)

> **æ–°æ ¸å¿ƒç»„ä»¶**: åœ¨åå°è¿è¡Œï¼Œè´Ÿè´£ä»éç»“æ„åŒ–å¯¹è¯ä¸­"èƒå–"ç»“æ„åŒ–æ•°æ®ã€‚

```mermaid
sequenceDiagram
    autonumber
    participant User as ç”¨æˆ·
    participant Chat as Chat API
    participant LLM as Interaction Layer
    participant Queue as Async Queue
    participant Insight as Insight Agent
    participant L1 as L1 Module Data
    participant L0 as L0 Base Data

    User->>Chat: å‘é€æ¶ˆæ¯
    Chat->>LLM: Hot Path (åŒæ­¥)
    LLM-->>Chat: A2UI å“åº”
    Chat-->>User: è¿”å›å›å¤

    Note over Chat,Queue: Cold Path å¼€å§‹ (å¼‚æ­¥)
    Chat->>Queue: æŠ•é€’å¯¹è¯è®°å½•

    Queue->>Insight: è§¦å‘åˆ†æ
    Insight->>Insight: NLP æå–äº‹å®/æƒ…ç»ª/åå¥½

    alt å‘ç°é¢†åŸŸæ•°æ®
        Insight->>L1: æ›´æ–° PERMA/Covey/å…«å­—
    end

    alt å‘ç°é€šç”¨ä¿¡æ¯
        Insight->>L0: æ›´æ–° Profile/Tags/Status
    end
```

**Insight Agent é…ç½®**:

| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
|--------|-----|------|
| è§¦å‘æ—¶æœº | å¯¹è¯ç»“æŸ / ç´¯è®¡ N è½® | é¿å…å®æ—¶åˆ†æå¡é¡¿ |
| æ‰§è¡Œæ¨¡å‹ | GLM-3-Turbo / GPT-3.5 | è½»é‡æ¨¡å‹èŠ‚çœæˆæœ¬ |
| æ ¸å¿ƒ Prompt | è§ä¸‹æ–¹ | ç»“æ„åŒ–æå–æŒ‡ä»¤ |

**Insight Agent System Prompt**:

```
åˆ†æåˆšæ‰çš„å¯¹è¯ã€‚è¯·è¾“å‡º JSON æ ¼å¼çš„æ›´æ–°æŒ‡ä»¤ï¼š
{
  "l0_updates": {
    "profile": { "location": "ä¸Šæµ·", "upcoming_event": "ä¸‹å‘¨å‡ºå·®" },
    "tags": ["Hate_Preaching", "Prefer_Direct"],
    "status": "stressed",
    "summary": "ç”¨æˆ·æ­£åœ¨å¤„ç†å·¥ä½œå‹åŠ›ï¼Œå¯¹é•¿ç¯‡å¤§è®ºåæ„Ÿ"
  },
  "l1_updates": {
    "perma": { "E": -0.1, "R": 0 },
    "covey": { "task_id": "xxx", "status": "done" },
    "emotion_log": { "trigger": "deadline_pressure", "intensity": 0.7 }
  }
}

è§„åˆ™ï¼š
1. ç”¨æˆ·æ˜¯å¦æä¾›äº†æ–°çš„ä¸ªäººä¿¡æ¯ï¼Ÿ
2. ç”¨æˆ·æ˜¯å¦è¡¨è¾¾äº†å¯¹æŸä¸ªå»ºè®®çš„å–œå¥½ï¼Ÿ
3. ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€å¦‚ä½•ï¼Ÿ
4. ç”¨æˆ·æ˜¯å¦å®Œæˆäº†æŸä¸ª L1 æ¨¡å—çš„ä»»åŠ¡ï¼Ÿ
5. ä»…è¾“å‡ºæœ‰å˜åŒ–çš„å­—æ®µ
```

### 2.3 L1 åŠ¨æ€æ›´æ–°åœºæ™¯

| åœºæ™¯ | ç”¨æˆ·è¾“å…¥ | Insight Agent Action |
|------|----------|---------------------|
| **Covey ä»»åŠ¡å®Œæˆ** | "æˆ‘ç»ˆäºæŠŠé‚£ä¸ªéš¾æçš„æŠ¥å‘Šå†™å®Œäº†" | è°ƒç”¨ L1 Covey APIï¼ŒTask â†’ Done |
| **è¿åŠ¿éªŒè¯åé¦ˆ** | "ä½ è¯´æˆ‘è¿™å‘¨è¿åŠ¿å·®ï¼Œç¡®å®ä¸¢äº†é’±åŒ…" | L1 è¿åŠ¿è®°å½•æ ‡è®° `User_Feedback: Validated` |
| **PERMA å˜åŒ–** | "æœ€è¿‘å’ŒåŒäº‹å…³ç³»å¥½å¤šäº†" | L1 PERMA `R` ç»´åº¦ +0.2 |
| **CBT æƒ…ç»ªå½’æ¡£** | "ä¸€æƒ³åˆ°æ±‡æŠ¥å°±ç„¦è™‘" | L1 CBT è®°å½• Trigger: presentation_anxiety |

### 2.4 L0 ç”»åƒä¸°æ»¡æœºåˆ¶

| ç±»å‹ | æå–æ–¹å¼ | ç¤ºä¾‹ |
|------|----------|------|
| **æ˜¾æ€§æå–** | ç”¨æˆ·ç›´æ¥é™ˆè¿° | "æˆ‘æ˜¯äº§å“ç»ç†" â†’ `job: PM` |
| **éšæ€§æ¨æ–­** | å¤šæ¬¡è¡Œä¸ºåˆ†æ | å¤šæ¬¡å¯¹ Roast æ¨¡å¼ååº”ç§¯æ â†’ `style_preference: { roast: 0.8 }` |
| **çŠ¶æ€æ„ŸçŸ¥** | æƒ…ç»ªè¯†åˆ« | è¿ç»­ 3 æ¬¡ä½è½è¯­æ°” â†’ `current_status: depressed` |

**Status å­—æ®µçš„å½±å“**:

```
L0.current_status = "depressed"
    â†“
Context Manager è¯»å– Status
    â†“
å¼ºåˆ¶è·¯ç”±åˆ° L2 Style Agents (Warm æ¨¡å¼)
    â†“
Interaction Layer ä½¿ç”¨æ¸©æš–è¯­æ°”å›å¤
```

### 2.5 Context Manager è¿›åŒ–

| ç‰ˆæœ¬ | Context ç»„æˆ |
|------|--------------|
| **v3.x** | `System Prompt + User Input` |
| **v4.0** | `System Prompt + L0(Status) + L1(Relevant Module) + Vector Search(History) + User Input` |

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Manager v4.0 ç»„è£…æµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. è¯»å– L0 Status/Tags        â†’ å…¨å±€çŠ¶æ€ + åå¥½                 â”‚
â”‚  2. è¯»å– L1 Relevant Module    â†’ å½“å‰è¯é¢˜ç›¸å…³çš„æ¨¡å—æ•°æ®          â”‚
â”‚  3. Vector Search History      â†’ ç›¸å…³å†å²å¯¹è¯ (Long-term Memory) â”‚
â”‚  4. ç”¨æˆ·å½“å‰è¾“å…¥               â†’ User Input                      â”‚
â”‚                                                                  â”‚
â”‚        â†“ æ‹¼è£…                                                    â”‚
â”‚                                                                  â”‚
â”‚  Final Context = [L0 Status] + [L1 Data] + [History] + [Input]  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.6 WCG é—­ç¯éªŒæ”¶ (ä¿ç•™)

> **æ‰¿è¯ºçŠ¶æ€æœº**: suggested â†’ active â†’ done

| æ­¥éª¤ | Hot/Cold | è¯´æ˜ |
|------|----------|------|
| 1. Clarify | Hot | Context Manager ç»„è£… |
| 2. Insight | Hot | L2 Expert Agents åˆ†æ |
| 3. Prescription | Hot | ç”Ÿæˆ If-Then å¤„æ–¹ |
| 4. Commitment | Hot | action_button è§¦å‘ |
| 5. Action | - | ç”¨æˆ·æ‰§è¡Œ |
| 6. Reflection | Cold | Insight Agent åˆ†æç»“æœ |
| 7. Memory | Cold | åå†™ L0/L1 |

**WCG éªŒæ”¶æ ‡å‡†**: æ¯å‘¨ â‰¥1 æ¬¡å®Œæ•´é—­ç¯ (Clarify â†’ Prescription â†’ Commitment â†’ Action â†’ Reflection)

---

## 3. API å®ç°çŠ¶æ€æ˜ å°„

### 3.1 Goal æ¨¡å—

| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
|------|------|------|------|
| `POST /api/goal/create` | âœ… | âœ… | åˆ›å»ºç›®æ ‡ |
| `GET /api/goal/list` | âœ… | âœ… | ç›®æ ‡åˆ—è¡¨ |
| `GET /api/goal/{goal_id}` | âœ… | âœ… | ç›®æ ‡è¯¦æƒ… |
| `PUT /api/goal/{goal_id}` | âœ… | âœ… | æ›´æ–°ç›®æ ‡ |
| `POST /api/goal/{goal_id}/link` | âœ… | âš ï¸ | å¾…å®Œå–„ |

### 3.2 Reflection æ¨¡å—

| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
|------|------|------|------|
| `POST /api/reflection/create` | âœ… | âœ… | åˆ›å»ºå¤ç›˜ |
| `GET /api/reflection/list` | âœ… | âœ… | å¤ç›˜åˆ—è¡¨ |
| `GET /api/reflection/prompt` | âœ… | âœ… | è·å–å¼•å¯¼é—®é¢˜ |

---

## 4. éªŒæ”¶æŒ‡æ ‡å¯¹æ¯”

### 4.1 WCG æŒ‡æ ‡

```sql
-- è®¾è®¡: WCG éªŒæ”¶æŸ¥è¯¢
WITH weekly_loop AS (
  SELECT
    user_id,
    DATE_TRUNC('week', created_at) AS week,
    BOOL_OR(accepted_at IS NOT NULL) AS has_commitment,
    BOOL_OR(status = 'done') AS has_action
  FROM fortune_commitment
  GROUP BY user_id, DATE_TRUNC('week', created_at)
)
SELECT
  user_id,
  week,
  (has_commitment AND has_action) AS wcg_achieved
FROM weekly_loop;

-- å½“å‰çŠ¶æ€: åç«¯æ•°æ®å¯æŸ¥è¯¢, å‰ç«¯é—­ç¯å¾…ä¿®å¤
```

### 4.2 æ–°å¢éªŒæ”¶æŒ‡æ ‡

| æŒ‡æ ‡ | å®šä¹‰ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|------|------|------|----------|
| ç›®æ ‡è®¾å®šç‡ | 7å¤©å†…è®¾å®šâ‰¥1ç›®æ ‡ | â‰¥30% | âš ï¸ å¾…ç»Ÿè®¡ |
| å¤ç›˜å®Œæˆç‡ | æ¯å‘¨â‰¥1æ¬¡å¤ç›˜ | â‰¥20% | âš ï¸ å¾…ç»Ÿè®¡ |
| Check-in ä½¿ç”¨ç‡ | æ¯å‘¨â‰¥1æ¬¡æ‰“å¡ | â‰¥40% | âœ… åç«¯å¯ç”¨ |
| A2UI ç‚¹å‡»ç‡ | action_buttons è¢«ç‚¹å‡» | â‰¥50% | âš ï¸ å‰ç«¯é—®é¢˜ |

---

## 5. æ€»ç»“

### 5.1 è®¾è®¡ vs å®ç°ä¸€è‡´æ€§

```
L0 Base Data:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
L1 Module Data:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%   â† å…«å­—/PERMA å°±ç»ªï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç°
L2 Expert Agents:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%   â† ä»…å…«å­— Agent
L2 Style Agents:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%   â† standard/warm/roast
Context Management: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
Interaction Layer:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%   â† GLM ä¸ºä¸»ï¼Œå¤šæ¨¡å‹å¾…å®Œå–„
Goal æ¨¡å—:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
Reflection:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
å‰ç«¯é—­ç¯:           â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40%   â† ä¸»è¦å·®è·
```

### 5.2 å…³é”®å·®è·

| å·®è· | å½±å“ | ä¼˜å…ˆçº§ | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|----------|
| å‰ç«¯ CSRF | é—­ç¯æ–­è£‚ | P0 | ä¿®å¤ api.ts |
| action_buttons | æ— æ³•ç‚¹å‡» | P0 | å®Œå–„æ¸²æŸ“ |
| anti-dependency | æ–°ç”¨æˆ·è¢«æˆªæ–­ | P1 | æ·»åŠ è±å… |
| L2 Expert æ¨¡å— | ä»…å…«å­— Agent | P2 | æ·»åŠ ç´«å¾®/æ˜Ÿåº§/CBT Agent |
| Interaction å¤šæ¨¡å‹ | GLM å•ä¸€ | P2 | å®Œå–„ Gemini/Claude åˆ‡æ¢ |

### 5.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **P0**: ä¿®å¤å‰ç«¯ CSRF â†’ æ¢å¤é—­ç¯
2. **P0**: å®Œå–„ action_buttons å¤„ç†
3. **P1**: å®ç° anti-dependency æ–°ç”¨æˆ·è±å…
4. **P1**: æ·»åŠ å¤ç›˜å…¥å£åˆ° Dashboard
5. **P2**: æ‰©å±• L2 Expert Agentsï¼ˆç´«å¾®/æ˜Ÿåº§/CBTï¼‰
6. **P2**: Interaction Layer å¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢

---

*æ–‡æ¡£ç‰ˆæœ¬: v4.2 (Vercel AI SDK Edition)*
*æ›´æ–°æ—¥æœŸ: 2026-01-01*
*æ¶æ„æ ¸å¿ƒ: Vercel AI SDK 6 + Pluggable Skills + Multi-Model Hub*
*æµ‹è¯•ç¯å¢ƒ: http://106.37.170.238:8231/new*
