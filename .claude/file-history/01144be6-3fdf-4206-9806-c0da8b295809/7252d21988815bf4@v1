/**
 * Grow Skills (成长技能)
 *
 * Tools for goal setting, task management, and personal growth tracking.
 */
import { tool } from 'ai';
import { z } from 'zod';

const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';

// Create commitment/goal tool
export const createCommitment = tool({
  description: '创建用户的承诺或目标。当用户表达想要做某事、设定目标、或接受教练建议时使用。',
  parameters: z.object({
    title: z.string().describe('承诺/目标标题'),
    description: z.string().optional().describe('详细描述'),
    commitment_type: z.enum(['task', 'habit', 'goal']).describe('类型：任务/习惯/目标'),
    due_date: z.string().optional().describe('截止日期，格式：YYYY-MM-DD'),
    if_then: z.string().optional().describe('如果-那么规则，如：如果早上起床→那么先喝一杯水'),
  }),
  execute: async ({ title, description, commitment_type, due_date, if_then }) => {
    // Generate a temporary ID (in production, this comes from the backend)
    const tempId = `commitment-${Date.now()}`;

    return {
      type: 'a2ui_card' as const,
      card_type: 'goal_created',
      data: {
        goal_id: tempId,
        title,
        description: description || '',
        commitment_type,
        status: 'active',
        due_date: due_date || null,
        if_then: if_then || null,
        created_at: new Date().toISOString(),
      },
      actions: [
        {
          label: '现在开始',
          action: 'api_call',
          params: { endpoint: '/api/goal/start', goal_id: tempId },
        },
        {
          label: '稍后提醒我',
          action: 'api_call',
          params: { endpoint: '/api/goal/schedule', goal_id: tempId },
        },
      ],
    };
  },
});

// Complete task tool
export const completeTask = tool({
  description: '标记任务/承诺为已完成。当用户报告完成了某项任务或目标时使用。',
  parameters: z.object({
    task_id: z.string().describe('任务ID'),
    reflection: z.string().optional().describe('完成后的反思或感受'),
    difficulty: z.enum(['easy', 'medium', 'hard']).optional().describe('难度评价'),
  }),
  execute: async ({ task_id, reflection, difficulty }) => {
    return {
      type: 'a2ui_card' as const,
      card_type: 'task_completed',
      data: {
        goal_id: task_id,
        title: '任务已完成',
        status: 'completed',
        completed_at: new Date().toISOString(),
        reflection: reflection || '',
        difficulty: difficulty || 'medium',
        // Add XP/reward info
        reward: {
          xp: 10,
          streak_bonus: false,
        },
      },
      actions: [
        {
          label: '查看进度',
          action: 'navigate',
          params: { path: '/dashboard/goals' },
        },
      ],
    };
  },
});

// List active goals tool
export const listGoals = tool({
  description: '列出用户当前活跃的目标和任务。当用户询问"我有什么任务"、"我的目标是什么"时使用。',
  parameters: z.object({
    status: z.enum(['active', 'completed', 'all']).optional().describe('筛选状态'),
    limit: z.number().optional().describe('返回数量限制'),
  }),
  execute: async ({ status, limit }) => {
    // In production, this would fetch from FastAPI
    // For now, return a placeholder response

    return {
      type: 'a2ui_card' as const,
      card_type: 'goal_list',
      data: {
        status_filter: status || 'active',
        goals: [],
        total_count: 0,
        message: '暂无活跃目标。想要创建一个新目标吗？',
      },
      actions: [
        {
          label: '创建新目标',
          action: 'navigate',
          params: { path: '/goals/new' },
        },
      ],
    };
  },
});

// Weekly review tool
export const weeklyReview = tool({
  description: '生成用户的周度回顾报告。当用户请求周报或进行周回顾时使用。',
  parameters: z.object({
    week_start: z.string().optional().describe('周起始日期，格式：YYYY-MM-DD，默认上周一'),
  }),
  execute: async ({ week_start }) => {
    const startDate = week_start || getLastMonday();

    return {
      type: 'a2ui_card' as const,
      card_type: 'weekly_review',
      data: {
        week_start: startDate,
        summary: {
          tasks_completed: 0,
          goals_progress: [],
          mood_average: 0,
          perma_scores: null,
        },
        highlights: [],
        challenges: [],
        next_week_focus: [],
        message: '正在生成周度回顾...',
      },
      actions: [
        {
          label: '查看完整报告',
          action: 'navigate',
          params: { path: `/reports/weekly/${startDate}` },
        },
      ],
    };
  },
});

// Helper function to get last Monday's date
function getLastMonday(): string {
  const today = new Date();
  const dayOfWeek = today.getDay();
  const daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
  const lastMonday = new Date(today);
  lastMonday.setDate(today.getDate() - daysToSubtract - 7);
  return lastMonday.toISOString().split('T')[0];
}

// Start task timer tool
export const startTaskTimer = tool({
  description: '开始一个专注计时器。当用户说"开始"、"计时"、或需要专注工作时使用。',
  parameters: z.object({
    task_id: z.string().optional().describe('关联的任务ID'),
    duration_minutes: z.number().min(1).max(120).describe('专注时长（分钟）'),
    task_name: z.string().optional().describe('任务名称'),
  }),
  execute: async ({ task_id, duration_minutes, task_name }) => {
    return {
      type: 'a2ui_card' as const,
      card_type: 'timer_started',
      data: {
        timer_id: `timer-${Date.now()}`,
        task_id: task_id || null,
        task_name: task_name || '专注时间',
        duration_minutes,
        started_at: new Date().toISOString(),
        ends_at: new Date(Date.now() + duration_minutes * 60 * 1000).toISOString(),
      },
      actions: [
        {
          label: '暂停',
          action: 'api_call',
          params: { endpoint: '/api/timer/pause' },
        },
        {
          label: '结束',
          action: 'api_call',
          params: { endpoint: '/api/timer/stop' },
        },
      ],
    };
  },
});

// Export all grow skills
export const growSkills = {
  create_commitment: createCommitment,
  complete_task: completeTask,
  list_goals: listGoals,
  weekly_review: weeklyReview,
  start_task_timer: startTaskTimer,
};
