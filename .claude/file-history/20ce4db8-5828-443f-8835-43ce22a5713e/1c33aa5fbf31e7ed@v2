'use client'

/**
 * Loading Step - Phase 2: 洞察 (15-45秒)
 *
 * v7.0 重构:
 * - ✅ Variant-aware: 仅调用当前 Skill 的 API
 * - ✅ 40% 起始进度 (Goal-Gradient 心理学)
 * - ✅ Skill 个性化 loading 步骤
 * - ✅ dankoe 跳过此步骤直接到 Chat
 *
 * 变体支持:
 * - bazi: 调用 /bazi/chart API
 * - zodiac: 调用 /zodiac/chart API
 * - dankoe: 跳过 loading 直接到 embeddedChat
 */

import { useEffect, useState, useRef, useMemo } from 'react'
import { useOnboarding } from '../context'
import { SKILL_CONFIGS, type SkillVariant } from '../types'

const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1'

// Goal-Gradient: 起始 40% 让用户感觉已经完成大部分
const INITIAL_PROGRESS_PERCENT = 40
const PRE_COMPLETED_STEPS = 2 // 前 2 步预设为已完成

// ═══════════════════════════════════════════════════════════════════
// 步骤指示器组件
// ═══════════════════════════════════════════════════════════════════

function StepIndicator({
  step,
  index,
  current,
  done,
  preCompleted
}: {
  step: string
  index: number
  current: number
  done: number[]
  preCompleted: number
}) {
  const isDone = done.includes(index) || index < preCompleted
  const isCurrent = current === index

  return (
    <div
      className={`flex items-center gap-3 p-3 rounded-lg transition-all duration-300 ${
        isDone ? 'bg-accent/10' : isCurrent ? 'bg-bg-secondary' : 'opacity-50'
      }`}
    >
      <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 ${
        isDone
          ? 'bg-accent text-white'
          : isCurrent
            ? 'bg-accent/20 text-accent'
            : 'bg-bg-tertiary text-text-disabled'
      }`}>
        {isDone ? (
          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
          </svg>
        ) : (
          <span className="text-sm font-medium">{index + 1}</span>
        )}
      </div>
      <span className={`text-sm transition-colors duration-300 ${
        isDone || isCurrent ? 'text-text-primary' : 'text-text-disabled'
      }`}>
        {step}
      </span>
      {isCurrent && !isDone && (
        <div className="ml-auto w-4 h-4 border-2 border-accent/30 border-t-accent rounded-full animate-spin" />
      )}
    </div>
  )
}

// ═══════════════════════════════════════════════════════════════════
// 进度条组件
// ═══════════════════════════════════════════════════════════════════

function ProgressBar({ progress }: { progress: number }) {
  return (
    <div className="w-full h-2 bg-bg-tertiary rounded-full overflow-hidden">
      <div
        className="h-full bg-accent rounded-full transition-all duration-500 ease-out relative"
        style={{ width: `${progress}%` }}
      >
        {/* Shimmer 光泽效果 */}
        <div className="absolute inset-0 shimmer-gradient animate-shimmer" />
      </div>
    </div>
  )
}

// ═══════════════════════════════════════════════════════════════════
// 主组件
// ═══════════════════════════════════════════════════════════════════

export default function LoadingStep() {
  const { state, setBaziData, goToStep } = useOnboarding()
  const { variant } = state

  // 映射 variant 到 SkillVariant
  const skillVariant: SkillVariant = variant === 'jungastro' ? 'zodiac' : (variant as SkillVariant)
  const skillConfig = SKILL_CONFIGS[skillVariant] || SKILL_CONFIGS.bazi
  const loadingSteps = skillConfig.loadingSteps

  // dankoe 跳过 loading 直接到 chat
  useEffect(() => {
    if (skillVariant === 'dankoe') {
      goToStep('embeddedChat')
    }
  }, [skillVariant, goToStep])

  const [current, setCurrent] = useState(PRE_COMPLETED_STEPS) // 从第 3 步开始
  const [done, setDone] = useState<number[]>([])
  const [apiResult, setApiResult] = useState<Record<string, unknown> | null>(null)
  const fetchedRef = useRef(false)

  // Memoize birth params
  const birthParams = useMemo(() => {
    if (!state.birthInfo) return null
    const { year, month, day, hour } = state.birthInfo
    return {
      birthDate: `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
      birthTime: hour ? `${String(hour).padStart(2, '0')}:00` : '12:00',
      gender: state.gender || 'unknown'
    }
  }, [state.birthInfo, state.gender])

  // 计算进度百分比 (40% 起始)
  const progress = useMemo(() => {
    if (loadingSteps.length === 0) return 100
    const completedCount = done.length + PRE_COMPLETED_STEPS
    const remainingPercent = 100 - INITIAL_PROGRESS_PERCENT
    return INITIAL_PROGRESS_PERCENT + ((completedCount / loadingSteps.length) * remainingPercent)
  }, [done, loadingSteps.length])

  useEffect(() => {
    // dankoe 不需要 loading
    if (skillVariant === 'dankoe') return

    if (!birthParams || fetchedRef.current) {
      if (!birthParams) goToStep('landing')
      return
    }
    fetchedRef.current = true

    const { birthDate, birthTime, gender } = birthParams

    // Variant-aware API 调用 (v7.0: 正确的 skills 路径和 args 格式)
    const fetchData = async () => {
      try {
        if (skillVariant === 'bazi') {
          // 八字 API: /api/v1/skills/bazi/chart
          const res = await fetch(`${API_BASE}/skills/bazi/chart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ args: { birth_date: birthDate, birth_time: birthTime, gender } })
          })
          if (res.ok) {
            const data = await res.json()
            if (data.status === 'success' && data.chart) {
              setApiResult(data.chart)
            }
          }
        } else if (skillVariant === 'zodiac') {
          // 星座 API: /api/v1/skills/zodiac/chart
          const res = await fetch(`${API_BASE}/skills/zodiac/chart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ args: { birth_date: birthDate, birth_time: birthTime, birth_place: 'Shanghai' } })
          })
          if (res.ok) {
            const data = await res.json()
            if (data.status === 'success' && data.chart) {
              setApiResult(data.chart)
            }
          }
        }
      } catch (err) {
        console.error(`${skillVariant} API error:`, err)
      }

      // 模拟剩余步骤进度
      const remainingSteps = loadingSteps.length - PRE_COMPLETED_STEPS
      for (let i = 0; i < remainingSteps; i++) {
        await new Promise(resolve => setTimeout(resolve, 800))
        setDone(prev => [...prev, PRE_COMPLETED_STEPS + i])
        if (i < remainingSteps - 1) {
          setCurrent(PRE_COMPLETED_STEPS + i + 1)
        }
      }
    }

    fetchData()
  }, [birthParams, goToStep, skillVariant, loadingSteps.length])

  // 完成后跳转
  useEffect(() => {
    // dankoe 不需要等待
    if (skillVariant === 'dankoe') return

    const totalStepsToComplete = loadingSteps.length - PRE_COMPLETED_STEPS
    if (done.length === totalStepsToComplete && totalStepsToComplete > 0) {
      const timer = setTimeout(() => {
        if (skillVariant === 'bazi' && apiResult) {
          const pillars = apiResult.four_pillars as Record<string, { stem: string; branch: string }> | undefined
          const dayMaster = apiResult.day_master as { stem?: string; element?: string } | undefined

          const elementMap: Record<string, string> = {
            wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
          }

          setBaziData({
            yearPillar: pillars?.year || { stem: '甲', branch: '午' },
            monthPillar: pillars?.month || { stem: '丙', branch: '寅' },
            dayPillar: pillars?.day || { stem: '戊', branch: '申' },
            hourPillar: state.birthInfo?.hour ? (pillars?.hour || { stem: '壬', branch: '子' }) : null,
            dayMaster: dayMaster?.stem
              ? `${dayMaster.stem}${elementMap[dayMaster.element || ''] || '土'}`
              : '戊土',
            dayMasterElement: dayMaster?.element || '土',
            insight: '你是一个需要稳定感的人，却总被内心的不安驱动着去追求更多。',
            fortune: { score: 78, luckyColor: '深蓝', luckyNumber: 7, advice: '今日适合处理重要决策' },
          })
        } else if (skillVariant === 'zodiac' && apiResult) {
          setBaziData({
            yearPillar: { stem: '甲', branch: '午' },
            monthPillar: { stem: '丙', branch: '寅' },
            dayPillar: { stem: '戊', branch: '申' },
            hourPillar: null,
            dayMaster: '戊土',
            dayMasterElement: '土',
            insight: '你的内心世界丰富而敏感，总能捕捉到他人忽略的细节。',
            fortune: { score: 82, luckyColor: '靛蓝', luckyNumber: 3, advice: '今日适合表达内心想法' },
            sunSign: (apiResult.sun_sign_chinese as string) || '金牛座',
            moonSign: (apiResult.moon_sign_chinese as string) || '巨蟹座',
            risingSign: (apiResult.rising_sign_chinese as string) || '天蝎座',
          })
        }
        goToStep('embeddedChat')
      }, 600)
      return () => clearTimeout(timer)
    }
  }, [done, apiResult, state.birthInfo?.hour, setBaziData, goToStep, skillVariant, loadingSteps.length])

  // dankoe 不渲染 loading UI
  if (skillVariant === 'dankoe') {
    return null
  }

  return (
    <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center px-4">
      {/* Header */}
      <div className="text-center mb-8 animate-fade-in">
        <h2 className="font-serif text-2xl text-text-primary mb-2">
          {skillVariant === 'bazi' ? '正在解读你的命盘' : '正在解读你的星盘'}
        </h2>
        <p className="text-sm text-text-secondary">
          {skillVariant === 'bazi' ? '东方命理智慧正在为你解码...' : '星空的秘密正在向你揭晓...'}
        </p>
      </div>

      {/* 进度条 */}
      <div className="w-full md:max-w-[500px] mb-6">
        <ProgressBar progress={progress} />
        <p className="text-xs text-text-tertiary text-right mt-1">{Math.round(progress)}%</p>
      </div>

      {/* 步骤列表 */}
      <div className="card w-full md:max-w-[500px] p-4 animate-spring-scale">
        <div className="space-y-2">
          {loadingSteps.map((step, index) => (
            <StepIndicator
              key={step}
              step={step}
              index={index}
              current={current}
              done={done}
              preCompleted={PRE_COMPLETED_STEPS}
            />
          ))}
        </div>
      </div>

      {/* 进度提示 */}
      <p className="text-xs text-text-disabled mt-6 animate-fade-in">
        请稍候，正在为你解读命盘...
      </p>
    </div>
  )
}
