'use client'

/**
 * Landing Step - Phase 1: 相遇 (0-15秒)
 *
 * v7.0 重构:
 * - ✅ BreathAura 层级修复 (z-0 + pointer-events-none)
 * - ✅ Curiosity Hook 组件
 * - ✅ 垂直输入布局优化
 * - ✅ Skill 个性化主题色
 *
 * 变体支持:
 * - bazi: 八字命理入口
 * - zodiac: 星座占星入口
 * - dankoe: 人生重置入口（跳过此步骤）
 */

import { useState, useRef, useMemo, type ChangeEvent } from 'react'
import { useOnboarding } from '../context'
import { VARIANT_DEFAULTS, SKILL_CONFIGS, type SkillVariant } from '../types'

// ═══════════════════════════════════════════════════════════════════════
// 主组件
// ═══════════════════════════════════════════════════════════════════════

export default function LandingStep() {
  const { state, setBirthInfo, nextStep } = useOnboarding()
  const { variant } = state
  const [year, setYear] = useState('')
  const [month, setMonth] = useState('')
  const [day, setDay] = useState('')
  const [hour, setHour] = useState('')
  const [showHour, setShowHour] = useState(false)

  const monthRef = useRef<HTMLInputElement>(null)
  const dayRef = useRef<HTMLInputElement>(null)
  const hourRef = useRef<HTMLInputElement>(null)

  // 获取变体特定内容
  const landing = VARIANT_DEFAULTS[variant]
  // 映射 variant 到 SkillVariant (jungastro -> zodiac)
  const skillVariant: SkillVariant = variant === 'jungastro' ? 'zodiac' : (variant as SkillVariant)
  const skillConfig = SKILL_CONFIGS[skillVariant] || SKILL_CONFIGS.bazi

  // ═══════════════════════════════════════════════════════════════════
  // Memoized 验证逻辑
  // ═══════════════════════════════════════════════════════════════════
  const isValid = useMemo(() => {
    const y = parseInt(year)
    const m = parseInt(month)
    const d = parseInt(day)

    return (
      year.length === 4 && y >= 1900 && y <= 2100 &&
      m >= 1 && m <= 12 &&
      d >= 1 && d <= 31
    )
  }, [year, month, day])

  // ═══════════════════════════════════════════════════════════════════
  // 事件驱动的输入处理
  // ═══════════════════════════════════════════════════════════════════
  const handleYearChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setYear(value)
    if (value.length === 4) {
      monthRef.current?.focus()
    }
  }

  const handleMonthChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setMonth(value)
    if (value.length === 2) {
      dayRef.current?.focus()
    }
  }

  const handleDayChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    setDay(value)
    if (value.length === 2 && showHour) {
      hourRef.current?.focus()
    }
  }

  const handleHourChange = (e: ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value.replace(/\D/g, '')
    if (parseInt(value) <= 23 || value === '') {
      setHour(value)
    }
  }

  const handleSubmit = () => {
    if (!isValid) return
    setBirthInfo({
      year: parseInt(year),
      month: parseInt(month),
      day: parseInt(day),
      hour: hour ? parseInt(hour) : null
    })
    nextStep()
  }

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && isValid) {
      handleSubmit()
    }
  }

  return (
    <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center px-4 relative overflow-hidden">
      {/* BreathAura - 修复: z-0 + pointer-events-none + blur-3xl */}
      <div className="absolute inset-0 z-0 pointer-events-none flex items-center justify-center">
        <div
          className="w-[400px] h-[400px] md:w-[500px] md:h-[500px] rounded-full blur-3xl animate-pulse-slow"
          style={{
            background: `radial-gradient(circle, ${skillConfig.glowColor} 0%, transparent 70%)`
          }}
        />
      </div>

      {/* 内容容器 - z-10 确保在 BreathAura 上方 */}
      <div className="relative z-10 w-full max-w-md flex flex-col items-center">
        {/* Curiosity Hook - 核心吸引点 */}
        <div className="text-center mb-8 animate-fade-in">
          <p className="text-lg md:text-xl text-text-primary font-serif mb-2">
            {skillConfig.curiosityHook}
          </p>
          <p className="text-sm text-text-secondary">
            {skillConfig.subtext}
          </p>
        </div>

        {/* 表单卡片 - 垂直布局 */}
        <div className="card w-full p-6 animate-spring-scale" style={{ animationDelay: '100ms' }}>
          {/* 标题 */}
          <div className="text-center mb-6">
            <h1 className="font-serif text-xl md:text-2xl text-text-primary mb-1">
              {landing.headline}
            </h1>
            <p className="text-xs text-text-secondary">
              {landing.subheadline}
            </p>
          </div>

          {/* 垂直输入布局 - 大字体 */}
          <div className="space-y-4 mb-6">
            {/* 年份 - 单独一行,大字体 */}
            <div>
              <input
                type="text"
                inputMode="numeric"
                maxLength={4}
                placeholder="1990"
                value={year}
                onChange={handleYearChange}
                onKeyDown={handleKeyDown}
                className="input text-center text-2xl md:text-3xl font-medium tracking-wide h-14 transition-all duration-normal"
                autoFocus
                aria-label="出生年份"
              />
              <span className="block text-xs text-text-secondary text-center mt-1">年</span>
            </div>

            {/* 月/日 - 水平排列 */}
            <div className="flex items-center gap-3">
              <div className="flex-1">
                <input
                  ref={monthRef}
                  type="text"
                  inputMode="numeric"
                  maxLength={2}
                  placeholder="5"
                  value={month}
                  onChange={handleMonthChange}
                  onKeyDown={handleKeyDown}
                  className="input text-center text-xl md:text-2xl font-medium h-12 transition-all duration-normal"
                  aria-label="出生月份"
                />
                <span className="block text-xs text-text-secondary text-center mt-1">月</span>
              </div>
              <div className="flex-1">
                <input
                  ref={dayRef}
                  type="text"
                  inputMode="numeric"
                  maxLength={2}
                  placeholder="15"
                  value={day}
                  onChange={handleDayChange}
                  onKeyDown={handleKeyDown}
                  className="input text-center text-xl md:text-2xl font-medium h-12 transition-all duration-normal"
                  aria-label="出生日期"
                />
                <span className="block text-xs text-text-secondary text-center mt-1">日</span>
              </div>
            </div>
          </div>

          {/* 时辰输入 (可选) */}
          {!showHour ? (
            <button
              onClick={() => setShowHour(true)}
              className="w-full text-sm text-text-secondary hover:text-accent mb-6 transition-colors duration-normal"
            >
              + 添加出生时间（可选，更精准）
            </button>
          ) : (
            <div className="mb-6 text-center animate-fade-in">
              <input
                ref={hourRef}
                type="text"
                inputMode="numeric"
                maxLength={2}
                placeholder="08"
                value={hour}
                onChange={handleHourChange}
                onKeyDown={handleKeyDown}
                className="input w-24 text-center text-xl font-medium h-12 transition-all duration-normal"
                aria-label="出生时辰"
              />
              <span className="block text-xs text-text-secondary mt-1">时（0-23）· 不知道也没关系</span>
            </div>
          )}

          {/* 提交按钮 */}
          <button
            onClick={handleSubmit}
            disabled={!isValid}
            className={`w-full h-12 text-base font-medium rounded-lg transition-all duration-normal ${
              isValid
                ? 'btn-primary hover:scale-[1.02] active:scale-[0.98]'
                : 'bg-bg-secondary text-text-disabled cursor-not-allowed'
            }`}
          >
            {landing.cta}
          </button>
        </div>
      </div>
    </div>
  )
}
