# VibeLife 测试环境部署指南

> **版本**: v6.8 | **环境**: 测试 (aiscend) | **更新**: 2026-01-17

## 环境信息

| 项目 | 值 |
|------|-----|
| 用户 | `aiscend` |
| 工作目录 | `/home/aiscend/work/vibelife` |
| 后端端口 | `8100` |
| 前端端口 | `8232` |
| 数据库端口 | `8224` |

## 快速启动

### 1. 启动后端 API (端口 8100)

```bash
cd /home/aiscend/work/vibelife/apps/api

# 激活虚拟环境
source venv/bin/activate

# 使用测试环境配置
cp /home/aiscend/work/vibelife/.env.test .env

# 启动 (开发模式)
uvicorn main:app --host 0.0.0.0 --port 8100 --reload

# 或后台运行
nohup uvicorn main:app --host 0.0.0.0 --port 8100 > /tmp/vibelife-api.log 2>&1 &
```

### 2. 启动前端 Web (端口 8232)

```bash
cd /home/aiscend/work/vibelife/apps/web

# 开发模式
NEXT_PUBLIC_API_URL=http://106.37.170.238:8100 \
NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1 \
pnpm dev --port 8232

# 或生产模式
pnpm build
NEXT_PUBLIC_API_URL=http://106.37.170.238:8100 \
pnpm start -H 0.0.0.0 -p 8232
```

### 3. 一键启动脚本

创建 `~/start-test.sh`:

```bash
#!/bin/bash
# VibeLife 测试环境启动脚本

cd /home/aiscend/work/vibelife

# 启动后端
echo "Starting API on port 8100..."
cd apps/api
source venv/bin/activate
nohup uvicorn main:app --host 0.0.0.0 --port 8100 > /tmp/vibelife-api.log 2>&1 &
API_PID=$!
echo "API PID: $API_PID"

# 等待 API 启动
sleep 3

# 启动前端
echo "Starting Web on port 8232..."
cd ../web
NEXT_PUBLIC_API_URL=http://106.37.170.238:8100 \
NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1 \
nohup pnpm dev --port 8232 > /tmp/vibelife-web.log 2>&1 &
WEB_PID=$!
echo "Web PID: $WEB_PID"

echo ""
echo "=== VibeLife Test Environment ==="
echo "API: http://106.37.170.238:8100"
echo "Web: http://106.37.170.238:8232"
echo ""
echo "Logs:"
echo "  API: tail -f /tmp/vibelife-api.log"
echo "  Web: tail -f /tmp/vibelife-web.log"
```

```bash
chmod +x ~/start-test.sh
~/start-test.sh
```

## 停止服务

```bash
# 查找进程
ps aux | grep -E "(uvicorn|next-server)" | grep -v grep

# 停止后端
pkill -f "uvicorn main:app.*8100"

# 停止前端
pkill -f "next-server.*8232"

# 或一键停止
pkill -f "uvicorn main:app" && pkill -f "next-server"
```

## 健康检查

```bash
# API 健康检查
curl http://106.37.170.238:8100/health
# 预期: {"status":"ok","service":"vibelife-api","version":"6.8.0","database":"ok"}

# 前端检查
curl -I http://106.37.170.238:8232
# 预期: HTTP/1.1 200 OK

# 数据库检查
psql postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife -c "SELECT 1"
```

## 查看日志

```bash
# API 日志
tail -f /tmp/vibelife-api.log

# Web 日志
tail -f /tmp/vibelife-web.log

# API 请求日志
tail -f /data/vibelife/logs/api_requests.log
```

## 端口检查

```bash
# 检查端口占用
lsof -i :8100  # API
lsof -i :8232  # Web
lsof -i :8224  # PostgreSQL

# 检查所有 vibelife 相关端口
netstat -tuln | grep -E "(8100|8232|8224)"
```

## 常见问题

### 端口被占用

```bash
# 查找占用进程
lsof -i :8100
# 杀死进程
kill -9 <PID>
```

### API 启动失败

```bash
# 检查虚拟环境
cd /home/aiscend/work/vibelife/apps/api
source venv/bin/activate
python -c "import fastapi; print('OK')"

# 检查环境变量
cat .env | grep VIBELIFE_DB_URL

# 检查数据库连接
psql $VIBELIFE_DB_URL -c "SELECT 1"
```

### 前端构建失败

```bash
cd /home/aiscend/work/vibelife
pnpm install
cd apps/web
pnpm build
```

### Embedding 模型加载失败

```bash
# 检查模型目录
ls -la /home/aiscend/.cache/vibelife/models/bge-m3

# 检查 CUDA
python -c "import torch; print(torch.cuda.is_available())"
```

## 测试命令

```bash
# 测试对话 API
curl -X POST http://106.37.170.238:8100/api/v1/chat/v5/stream \
  -H "Content-Type: application/json" \
  -d '{"message": "你好", "skill": "bazi"}'

# 测试工具 Schema
curl http://106.37.170.238:8100/api/v1/tools/schema

# 测试 Skill 列表
curl http://106.37.170.238:8100/api/v1/skills
```

## 与生产环境对比

| 项目 | 测试环境 | 生产环境 |
|------|----------|----------|
| 用户 | aiscend | vibelife |
| API 端口 | 8100 | 8000 |
| Web 端口 | 8232 | 8230 |
| 工作目录 | /home/aiscend/work/vibelife | /home/vibelife/vibelife |
| 启动方式 | 手动/脚本 | Systemd |
