# VibeLife 生产环境部署指南

> 最后更新: 2026-01-19 | v6.9 已验证 | 生产环境

---

## 部署架构

### 生产环境架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户浏览器                                      │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                      ┌───────────┴───────────┐
                      │     Cloudflare        │
                      │  vibelife.app 域名    │
                      │  DNS + CDN + SSL      │
                      └───────────┬───────────┘
                                  │
          ┌───────────────────────┴───────────────────────┐
          │                                               │
          ▼                                               ▼
┌─────────────────────────────┐           ┌─────────────────────────────────┐
│   Vercel / 阿里云香港        │           │      aiscend 服务器              │
│   (前端 - Next.js)          │           │      106.37.170.238             │
│                             │           │                                 │
│  vibelife.app               │   HTTPS   │  api.vibelife.app               │
│  bazi.vibelife.app     ─────┼───────────┼──► FastAPI (port 8000)          │
│  zodiac.vibelife.app        │   API     │     │                           │
│                             │           │     ▼                           │
│                             │           │  PostgreSQL 16 (port 8224)      │
└─────────────────────────────┘           └─────────────────────────────────┘
```

### 服务分布

| 组件 | 位置 | 端口 | 运行模式 |
|------|------|------|----------|
| 前端 (Next.js) | Vercel / 阿里云香港 | 8230 | Production (`pnpm start`) |
| 后端 (FastAPI) | aiscend 服务器 | 8000 | Systemd |
| 数据库 (PostgreSQL 16) | aiscend 服务器 | 8224 | - |

---

## 快速启动

### 1. 启动后端 API (端口 8000)

```bash
cd /home/vibelife/vibelife/apps/api

# 激活虚拟环境
source venv/bin/activate

# 使用生产环境配置
cp /home/vibelife/vibelife/.env .env

# 启动服务
uvicorn main:app --port 8000 --host 0.0.0.0

# 或使用 Systemd
sudo systemctl start vibelife-api
```

### 2. 启动前端 Web (端口 8230)

> **重要**: 必须使用生产模式运行，开发模式会导致静态资源 404 错误

```bash
cd /home/vibelife/vibelife/apps/web

# 步骤 1: 构建生产版本 (必需)
pnpm build

# 步骤 2: 启动生产服务器
pnpm start -H 0.0.0.0 -p 8230

# 或使用 Systemd
sudo systemctl start vibelife-web
```

> 注意: 不要使用 `pnpm dev` 运行生产环境，会导致 `/_next/static/*` 资源 404

### 3. Systemd 服务配置

创建 `/etc/systemd/system/vibelife-api.service`:

```ini
[Unit]
Description=VibeLife API
After=network.target

[Service]
Type=simple
User=vibelife
WorkingDirectory=/home/vibelife/vibelife/apps/api
EnvironmentFile=/home/vibelife/vibelife/.env
ExecStart=/usr/bin/python3 -m uvicorn main:app --port 8000 --host 0.0.0.0
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

创建 `/etc/systemd/system/vibelife-web.service`:

```ini
[Unit]
Description=VibeLife Web
After=network.target

[Service]
Type=simple
User=vibelife
WorkingDirectory=/home/vibelife/vibelife/apps/web
ExecStart=/usr/bin/pnpm start -H 0.0.0.0 -p 8230
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

```bash
sudo systemctl daemon-reload
sudo systemctl enable vibelife-api vibelife-web
sudo systemctl start vibelife-api vibelife-web
```

---

## 停止服务

```bash
# 使用 Systemd
sudo systemctl stop vibelife-api
sudo systemctl stop vibelife-web

# 或手动停止
pkill -f "uvicorn main:app.*8000"
pkill -f "next.*8230"
```

---

## 环境要求

### 系统要求
- Node.js 18+
- Python 3.11+
- PostgreSQL 16+ (with pgvector extension)
- CUDA (可选，用于 GPU 加速 embedding)

### 云服务
- Cloudflare (域名 + CDN)
- Stripe 账户 (支付)
- 智谱 API (LLM)
- DeepSeek API (LLM)

---

## 环境变量配置

### 后端环境变量 (.env)

```bash
# ─────────────────────────────────────────────────────────────────
# 数据库
# ─────────────────────────────────────────────────────────────────
VIBELIFE_DB_URL=postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife
VIBELIFE_DB_HOST=106.37.170.238
VIBELIFE_DB_PORT=8224
VIBELIFE_DB_NAME=vibelife
VIBELIFE_DB_USER=postgres
VIBELIFE_DB_PASSWORD=<PASSWORD>

# ─────────────────────────────────────────────────────────────────
# JWT 认证
# ─────────────────────────────────────────────────────────────────
VIBELIFE_JWT_SECRET=your-jwt-secret-key
VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30

# ─────────────────────────────────────────────────────────────────
# API 配置 (生产环境端口)
# ─────────────────────────────────────────────────────────────────
VIBELIFE_API_HOST=0.0.0.0
VIBELIFE_API_PORT=8000
VIBELIFE_DEV=0

# ─────────────────────────────────────────────────────────────────
# CORS (生产环境)
# ─────────────────────────────────────────────────────────────────
VIBELIFE_CORS_ORIGINS=https://vibelife.app,https://bazi.vibelife.app,https://zodiac.vibelife.app

# ─────────────────────────────────────────────────────────────────
# LLM 服务 - DeepSeek (主力)
# ─────────────────────────────────────────────────────────────────
DEEPSEEK_API_KEY=your-deepseek-api-key

# ─────────────────────────────────────────────────────────────────
# LLM 服务 - 智谱 GLM (备选)
# ─────────────────────────────────────────────────────────────────
GLM_API_KEY=your-glm-api-key
GLM_CHAT_MODEL=glm-4.7
GLM_VISION_MODEL=glm-4.6v
GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4

# ─────────────────────────────────────────────────────────────────
# Claude (备选)
# ─────────────────────────────────────────────────────────────────
CLAUDE_API_KEY=your-claude-api-key

# ─────────────────────────────────────────────────────────────────
# 数据目录 (独立数据盘)
# ─────────────────────────────────────────────────────────────────
VIBELIFE_DATA_ROOT=/data/vibelife
VIBELIFE_KNOWLEDGE_ROOT=/data/vibelife/knowledge
VIBELIFE_UPLOADS_ROOT=/data/vibelife/uploads
VIBELIFE_CACHE_ROOT=/data/vibelife/cache
VIBELIFE_LOGS_ROOT=/data/vibelife/logs

# ─────────────────────────────────────────────────────────────────
# Embedding - BAAI/bge-m3 (本地)
# ─────────────────────────────────────────────────────────────────
EMBEDDING_MODEL_NAME=BAAI/bge-m3
EMBEDDING_DIMENSION=1024
EMBEDDING_DEVICE=cuda

# ─────────────────────────────────────────────────────────────────
# Stripe 支付
# ─────────────────────────────────────────────────────────────────
STRIPE_SECRET_KEY=sk_live_...
STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# 海外订阅 Price IDs (USD, Recurring)
STRIPE_PRICE_SUB_MONTHLY_USD=price_xxx
STRIPE_PRICE_SUB_QUARTERLY_USD=price_xxx
STRIPE_PRICE_SUB_YEARLY_USD=price_xxx

# 大陆/香港预付 Price IDs (HKD, One-time)
STRIPE_PRICE_PREPAID_1M_HKD=price_xxx
STRIPE_PRICE_PREPAID_3M_HKD=price_xxx
STRIPE_PRICE_PREPAID_12M_HKD=price_xxx

# 支付回调 URLs
PAYMENT_SUCCESS_URL=https://vibelife.app/payment/success
PAYMENT_CANCEL_URL=https://vibelife.app/pricing
```

### 前端环境变量

```bash
# 生产环境
NEXT_PUBLIC_API_URL=https://api.vibelife.app
NEXT_PUBLIC_API_BASE=https://api.vibelife.app/api/v1
NEXT_PUBLIC_WS_URL=wss://api.vibelife.app/ws

# Stripe 公钥
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_xxx
```

---

## 数据库初始化

### 运行 Schema 迁移

```bash
# 连接数据库
PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife

# 运行迁移
PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
  -f /home/vibelife/vibelife/apps/api/stores/migrations/001_init.sql
```

### 验证表创建

```bash
PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
  -c "SELECT tablename FROM pg_tables WHERE schemaname = 'public' ORDER BY tablename;"
```

---

## DNS 配置 (Cloudflare)

| 记录类型 | 名称 | 内容 | 代理状态 |
|----------|------|------|----------|
| A | api | 106.37.170.238 | DNS only |
| CNAME | @ | cname.vercel-dns.com | Proxied |
| CNAME | bazi | cname.vercel-dns.com | Proxied |
| CNAME | zodiac | cname.vercel-dns.com | Proxied |

---

## 健康检查

```bash
# API 健康检查
curl https://api.vibelife.app/health
# 期望输出: {"status":"ok","service":"vibelife-api","version":"6.9.0","database":"ok"}

# 前端检查
curl -I https://vibelife.app
# 期望: HTTP/2 200

# 数据库检查
psql postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife -c "SELECT 1"
```

---

## API 端点验证

部署完成后，验证以下核心端点:

```bash
# 1. 健康检查
curl https://api.vibelife.app/health

# 2. 对话 API (SSE)
curl -X POST https://api.vibelife.app/api/v1/chat/v5/stream \
  -H "Content-Type: application/json" \
  -d '{"message": "你好", "skill": "bazi"}'

# 3. 工具 Schema
curl https://api.vibelife.app/api/v1/tools/schema

# 4. Skill 列表
curl https://api.vibelife.app/api/v1/skills
```

---

## 查看日志

```bash
# Systemd 日志
journalctl -u vibelife-api -f
journalctl -u vibelife-web -f

# 应用日志
tail -f /data/vibelife/logs/api_requests.log
```

---

## 端口检查

```bash
# 检查端口占用
lsof -i :8000  # API
lsof -i :8230  # Web
lsof -i :8224  # PostgreSQL

# 检查所有 vibelife 相关端口
netstat -tuln | grep -E "(8000|8230|8224)"
```

---

## 故障排查

### 1. API 无法访问

```bash
# 检查 Systemd 服务状态
systemctl status vibelife-api

# 检查端口
netstat -tlnp | grep 8000

# 检查防火墙
sudo ufw status
```

### 2. 数据库连接失败

```bash
# 测试连接
PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife -c "SELECT 1"

# 检查 PostgreSQL 状态
systemctl status postgresql
```

### 3. LLM 调用失败

```bash
# 检查环境变量
echo $DEEPSEEK_API_KEY
echo $GLM_API_KEY

# 查看 config/models.yaml 配置
cat /home/vibelife/vibelife/apps/api/config/models.yaml
```

### 4. 前端无法调用 API

- 检查 CORS 配置是否包含前端域名
- 检查 `NEXT_PUBLIC_API_URL` 是否正确
- 查看浏览器 Network 面板的错误信息
- 确保 API 服务器在运行

### 5. 静态资源 404 错误

如果浏览器控制台出现 `/_next/static/*` 404 错误：

```bash
# 原因: 使用了开发模式运行，或构建产物过期

# 解决方案:
cd /home/vibelife/vibelife/apps/web

# 1. 停止旧进程
sudo systemctl stop vibelife-web

# 2. 重新构建
pnpm build

# 3. 重新启动
sudo systemctl start vibelife-web
```

### 6. TypeScript 构建错误

```bash
# 清理缓存
cd /home/vibelife/vibelife/apps/web
rm -rf .next
pnpm build
```

---

## 与测试环境对比

| 项目 | 生产环境 | 测试环境 |
|------|----------|----------|
| 用户 | vibelife | aiscend |
| API 端口 | 8000 | 8100 |
| Web 端口 | 8230 | 8232 |
| 工作目录 | /home/vibelife/vibelife | /home/aiscend/work/vibelife |
| 启动方式 | Systemd | 手动/脚本 |
| 前端模式 | Production (`pnpm start`) | Production |
| 域名 | vibelife.app | IP:Port |

---

## 安全建议

1. **API 密钥**: 使用环境变量，不要提交到代码库
2. **HTTPS**: 正式环境必须使用 HTTPS (Cloudflare 提供)
3. **CORS**: 限制允许的来源域名
4. **防火墙**: 只开放必要端口 (8000, 8224)
5. **日志脱敏**: 不要记录敏感信息
6. **定期更新**: 保持依赖包更新
7. **数据库**: 使用强密码，限制访问 IP

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v6.9 | 2026-01-19 | 与 deployment-test.md 统一结构，添加静态资源404修复指南 |
| v3.1 | 2026-01-11 | 支付系统双轨制 (Stripe HK)，移除 Airwallex |
| v3.0 | 2026-01-07 | Schema v3.0, LLM 配置优化, 前端 Suspense 修复 |
| v2.0 | 2026-01-05 | 初始部署配置 |
