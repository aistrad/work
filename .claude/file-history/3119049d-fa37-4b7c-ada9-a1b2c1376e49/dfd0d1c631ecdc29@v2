# VibeLife 测试环境部署指南

> **版本**: v6.9 | **环境**: 测试 (aiscend) | **更新**: 2026-01-19

## 环境信息

| 项目 | 值 |
|------|-----|
| 用户 | `aiscend` |
| 工作目录 | `/home/aiscend/work/vibelife` |
| 后端端口 | `8100` |
| 前端端口 | `8232` |
| 数据库端口 | `8224` |

## 快速启动

### 1. 启动后端 API (端口 8100)

```bash
cd /home/aiscend/work/vibelife/apps/api

# 激活虚拟环境
source venv/bin/activate

# 使用测试环境配置
cp /home/aiscend/work/vibelife/.env.test .env

# 启动 (开发模式)
uvicorn main:app --host 0.0.0.0 --port 8100 --reload

# 或后台运行
nohup uvicorn main:app --host 0.0.0.0 --port 8100 > /tmp/vibelife-api.log 2>&1 &
```

### 2. 启动前端 Web (端口 8232)

> **重要**: 必须使用生产模式运行，开发模式会导致静态资源 404 错误

```bash
cd /home/aiscend/work/vibelife/apps/web

# 步骤 1: 构建生产版本 (必需)
pnpm build

# 步骤 2: 启动生产服务器
pnpm start -H 0.0.0.0 -p 8232

# 后台运行
nohup pnpm start -H 0.0.0.0 -p 8232 > /tmp/vibelife-web-8232.log 2>&1 &
```

> 注意: 不要使用 `pnpm dev` 运行测试环境，会导致 `/_next/static/*` 资源 404

### 3. 一键启动脚本

创建 `~/start-test.sh`:

```bash
#!/bin/bash
# VibeLife 测试环境启动脚本 v2.0

set -e

cd /home/aiscend/work/vibelife

# 启动后端
echo "Starting API on port 8100..."
cd apps/api
source venv/bin/activate
nohup uvicorn main:app --host 0.0.0.0 --port 8100 > /tmp/vibelife-api.log 2>&1 &
API_PID=$!
echo "API PID: $API_PID"

# 等待 API 启动
sleep 3

# 启动前端 (生产模式)
echo "Starting Web on port 8232 (production mode)..."
cd ../web

# 检查是否需要重新构建
if [ ! -d ".next" ] || [ "$(find src -newer .next -type f | head -1)" ]; then
    echo "Building frontend..."
    pnpm build
fi

nohup pnpm start -H 0.0.0.0 -p 8232 > /tmp/vibelife-web-8232.log 2>&1 &
WEB_PID=$!
echo "Web PID: $WEB_PID"

# 等待服务启动
sleep 5

echo ""
echo "=== VibeLife Test Environment ==="
echo "API: http://106.37.170.238:8100"
echo "Web: http://106.37.170.238:8232"
echo ""
echo "Health Check:"
curl -s http://localhost:8100/health | head -1 || echo "API not ready"
curl -s -o /dev/null -w "Web: %{http_code}\n" http://localhost:8232 || echo "Web not ready"
echo ""
echo "Logs:"
echo "  API: tail -f /tmp/vibelife-api.log"
echo "  Web: tail -f /tmp/vibelife-web-8232.log"
```

```bash
chmod +x ~/start-test.sh
~/start-test.sh
```

## 停止服务

```bash
# 查找进程
ps aux | grep -E "(uvicorn|next-server)" | grep -v grep

# 停止后端
pkill -f "uvicorn main:app.*8100"

# 停止前端
pkill -f "next-server.*8232"

# 或一键停止
pkill -f "uvicorn main:app" && pkill -f "next-server"
```

## 健康检查

```bash
# API 健康检查
curl http://106.37.170.238:8100/health
# 预期: {"status":"ok","service":"vibelife-api","version":"6.8.0","database":"ok"}

# 前端检查
curl -I http://106.37.170.238:8232
# 预期: HTTP/1.1 200 OK

# 数据库检查
psql postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife -c "SELECT 1"
```

## 查看日志

```bash
# API 日志
tail -f /tmp/vibelife-api.log

# Web 日志
tail -f /tmp/vibelife-web.log

# API 请求日志
tail -f /data/vibelife/logs/api_requests.log
```

## 端口检查

```bash
# 检查端口占用
lsof -i :8100  # API
lsof -i :8232  # Web
lsof -i :8224  # PostgreSQL

# 检查所有 vibelife 相关端口
netstat -tuln | grep -E "(8100|8232|8224)"
```

## 常见问题

### 端口被占用

```bash
# 查找占用进程
lsof -i :8100
# 杀死进程
kill -9 <PID>
```

### API 启动失败

```bash
# 检查虚拟环境
cd /home/aiscend/work/vibelife/apps/api
source venv/bin/activate
python -c "import fastapi; print('OK')"

# 检查环境变量
cat .env | grep VIBELIFE_DB_URL

# 检查数据库连接
psql $VIBELIFE_DB_URL -c "SELECT 1"
```

### 前端构建失败

```bash
cd /home/aiscend/work/vibelife
pnpm install
cd apps/web
pnpm build
```

### 静态资源 404 错误

如果浏览器控制台出现 `/_next/static/*` 404 错误：

```bash
# 原因: 使用了开发模式运行，或构建产物过期

# 解决方案:
cd /home/aiscend/work/vibelife/apps/web

# 1. 停止旧进程
pkill -f "next.*8232"

# 2. 重新构建
pnpm build

# 3. 以生产模式启动
nohup pnpm start -H 0.0.0.0 -p 8232 > /tmp/vibelife-web-8232.log 2>&1 &

# 4. 验证
curl -I http://106.37.170.238:8232/_next/static/css/*.css
# 应返回 200 OK
```

### Embedding 模型加载失败

```bash
# 检查模型目录
ls -la /home/aiscend/.cache/vibelife/models/bge-m3

# 检查 CUDA
python -c "import torch; print(torch.cuda.is_available())"
```

## 测试命令

```bash
# 测试对话 API
curl -X POST http://106.37.170.238:8100/api/v1/chat/v5/stream \
  -H "Content-Type: application/json" \
  -d '{"message": "你好", "skill": "bazi"}'

# 测试工具 Schema
curl http://106.37.170.238:8100/api/v1/tools/schema

# 测试 Skill 列表
curl http://106.37.170.238:8100/api/v1/skills
```

## 与生产环境对比

| 项目 | 测试环境 | 生产环境 |
|------|----------|----------|
| 用户 | aiscend | vibelife |
| API 端口 | 8100 | 8000 |
| Web 端口 | 8232 | 8230 |
| 工作目录 | /home/aiscend/work/vibelife | /home/vibelife/vibelife |
| 启动方式 | 手动/脚本 | Systemd |
| 前端模式 | Production (`pnpm start`) | Production |

## 更新历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v6.9 | 2026-01-19 | 修复静态资源404问题，强制使用生产模式运行前端 |
| v6.8 | 2026-01-17 | 初始版本 |
