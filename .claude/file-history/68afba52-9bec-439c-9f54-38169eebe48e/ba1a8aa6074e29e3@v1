# Everything Claude Code 适配新版 Skill 规范的调整计划

## 背景

Claude Code 最新更新将 **commands 和 skills 合并**。关键变化：
- `.claude/commands/review.md` 和 `.claude/skills/review/SKILL.md` 都会创建 `/review` 命令
- 现有 `.claude/commands/` 文件继续工作，无需强制迁移
- Skills 提供更多可选功能：目录支持文件、frontmatter 控制调用方式、Claude 自动加载

## 当前状态分析

### Commands 目录（15 个文件）
| 状态 | 数量 | 说明 |
|------|------|------|
| 有 frontmatter | 3 | tdd.md, plan.md, e2e.md, setup-pm.md |
| 无 frontmatter | 12 | 其余文件 |

### Skills 目录（11 个文件）
| 状态 | 数量 | 说明 |
|------|------|------|
| 有 frontmatter | 8 | 大部分技能 |
| 无 frontmatter | 3 | verification-loop, eval-harness, project-guidelines-example |

### 重名/关联对
| 命令 | 技能 | 关系 |
|------|------|------|
| tdd.md | tdd-workflow/ | 命令引用技能 |
| eval.md | eval-harness/ | 功能互补 |
| learn.md | continuous-learning/ | 手动 vs 自动 |
| verify.md | verification-loop/ | 命令 vs 完整系统 |

## 新规范 Frontmatter 字段

| 字段 | 类型 | 说明 |
|------|------|------|
| `name` | string | 技能名称，用于 `/name` 调用 |
| `description` | string | **推荐**，Claude 用于判断何时加载 |
| `argument-hint` | string | 自动补全提示，如 `[issue-number]` |
| `disable-model-invocation` | bool | 阻止 Claude 自动调用 |
| `user-invocable` | bool | 控制 `/` 菜单可见性 |
| `allowed-tools` | string | 限制可用工具，如 `Read, Grep, Glob` |
| `model` | string | 指定使用的模型 |
| `context` | string | `fork` 表示在子代理中运行 |
| `agent` | string | 与 `context: fork` 配合，指定代理类型 |
| `hooks` | object | 技能生命周期钩子 |

### 新的字符串替换
- `$ARGUMENTS` - 调用时传递的参数
- `${CLAUDE_SESSION_ID}` - 当前会话 ID
- `!`command`` - 动态上下文注入（运行 shell 命令）

---

## 推荐调整方案

### 方案：渐进式增强（推荐）

**原则**：保持向后兼容，逐步增强功能

#### 第一步：补全 Commands Frontmatter

为 12 个缺少 frontmatter 的 commands 添加基本元数据：

```yaml
---
description: 命令描述
---
```

**需要添加的文件**：
- commands/learn.md
- commands/code-review.md
- commands/verify.md
- commands/orchestrate.md
- commands/refactor-clean.md
- commands/test-coverage.md
- commands/eval.md
- commands/build-fix.md
- commands/checkpoint.md
- commands/update-codemaps.md
- commands/update-docs.md

#### 第二步：补全 Skills Frontmatter

为 3 个缺少 frontmatter 的 skills 添加元数据：

```yaml
---
name: skill-name
description: 技能描述
---
```

**需要添加的文件**：
- skills/verification-loop/SKILL.md
- skills/eval-harness/SKILL.md
- skills/project-guidelines-example/SKILL.md

#### 第三步：增强关键 Skills

为适合在子代理中运行的技能添加 `context: fork`：

| 技能 | 建议配置 |
|------|----------|
| security-review | `context: fork`, `agent: Plan` |
| tdd-workflow | 保持内联（需要交互） |
| continuous-learning | `disable-model-invocation: true`（只在会话结束时运行）|

#### 第四步：统一命令和技能的交叉引用

确保相关的命令和技能正确互相引用：
- tdd.md 应明确引用 tdd-workflow skill
- verify.md 应引用 verification-loop skill
- eval.md 应引用 eval-harness skill

---

## 具体修改清单

### Commands 修改

| 文件 | 修改内容 |
|------|----------|
| learn.md | 添加 `description`, `disable-model-invocation: true` |
| code-review.md | 添加 `description` |
| verify.md | 添加 `description` |
| orchestrate.md | 添加 `description`, `disable-model-invocation: true` |
| refactor-clean.md | 添加 `description` |
| test-coverage.md | 添加 `description` |
| eval.md | 添加 `description` |
| build-fix.md | 添加 `description` |
| checkpoint.md | 添加 `description`, `disable-model-invocation: true` |
| update-codemaps.md | 添加 `description` |
| update-docs.md | 添加 `description` |

### Skills 修改

| 文件 | 修改内容 |
|------|----------|
| verification-loop/SKILL.md | 添加 `name`, `description` |
| eval-harness/SKILL.md | 添加 `name`, `description` |
| project-guidelines-example/SKILL.md | 添加 `name`, `description`, `user-invocable: false` |
| security-review/SKILL.md | 添加 `context: fork`, `agent: Plan` |
| continuous-learning/SKILL.md | 添加 `disable-model-invocation: true` |

---

## 验证步骤

1. **语法验证**：检查所有 YAML frontmatter 格式正确
2. **加载测试**：在 Claude Code 中运行 `What skills are available?`
3. **调用测试**：测试 `/tdd`, `/plan`, `/code-review` 等命令
4. **自动加载测试**：询问相关问题，验证 Claude 是否自动加载技能

---

## 注意事项

1. **无需迁移 commands 到 skills**：现有 commands 继续工作
2. **避免重名冲突**：如果 command 和 skill 同名，skill 优先
3. **description 重要**：Claude 用它决定何时自动加载
4. **context: fork 谨慎使用**：只用于可独立运行的任务

---

## 文件路径

- 仓库位置: `/home/aiscend/work/everything-claude-code`
- Commands: `/home/aiscend/work/everything-claude-code/commands/`
- Skills: `/home/aiscend/work/everything-claude-code/skills/`
