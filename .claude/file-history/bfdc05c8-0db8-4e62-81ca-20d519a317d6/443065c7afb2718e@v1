/**
 * useVibeChat - AI SDK 6 useChat wrapper for VibeLife
 *
 * Provides streaming chat with skill and voice mode support
 * Uses AI SDK 6 Data Stream Protocol with custom transport
 */

'use client';

import { useChat } from '@ai-sdk/react';
import { DefaultChatTransport } from 'ai';
import { useCallback, useMemo } from 'react';
import { getTokens } from '@/lib/api';

export type SkillId = 'bazi' | 'zodiac' | 'mbti' | 'attach' | 'career';
export type VoiceMode = 'warm' | 'sarcastic';

export interface UseVibeChatOptions {
  skillId: SkillId;
  voiceMode?: VoiceMode;
  conversationId?: string;
  onConversationStart?: (id: string) => void;
  onError?: (error: Error) => void;
  onFinish?: () => void;
}

export function useVibeChat({
  skillId,
  voiceMode = 'warm',
  conversationId,
  onConversationStart,
  onError,
  onFinish,
}: UseVibeChatOptions) {
  // Create transport with custom headers and body
  const transport = useMemo(() => {
    const { accessToken } = getTokens();
    return new DefaultChatTransport({
      api: '/api/chat',
      headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : undefined,
      body: {
        skill: skillId,
        voice_mode: voiceMode,
        conversation_id: conversationId,
      },
    });
  }, [skillId, voiceMode, conversationId]);

  // AI SDK 6 useChat hook
  const chat = useChat({
    id: conversationId,
    transport,
    onFinish: (message) => {
      // Extract conversation_id from metadata if available
      // @ts-expect-error - metadata is available but not typed
      const metadata = message?.metadata;
      if (metadata?.conversation_id && onConversationStart) {
        onConversationStart(metadata.conversation_id);
      }
      onFinish?.();
    },
    onError: (error) => {
      console.error('Chat error:', error);
      onError?.(error);
    },
  });

  // Wrapper for sendMessage that includes skill and voice_mode
  const sendVibeMessage = useCallback(
    async (content: string) => {
      // AI SDK 5+/6 sendMessage takes an object with text property
      return chat.sendMessage({ text: content });
    },
    [chat]
  );

  // Clear messages and send (for quick prompts)
  const sendQuickPrompt = useCallback(
    async (content: string) => {
      chat.setMessages([]);
      return sendVibeMessage(content);
    },
    [chat, sendVibeMessage]
  );

  // Compute isLoading from status
  const isLoading = chat.status === 'submitted' || chat.status === 'streaming';

  return {
    // Core state
    messages: chat.messages,
    status: chat.status,
    isLoading,
    error: chat.error,

    // Actions
    sendMessage: sendVibeMessage,
    sendQuickPrompt,
    stop: chat.stop,
    clearError: chat.clearError,

    // For advanced use
    setMessages: chat.setMessages,
    regenerate: chat.regenerate,

    // Metadata
    conversationId,
    skillId,
    voiceMode,
  };
}

export default useVibeChat;
