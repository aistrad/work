'use client'

/**
 * Onboarding Page - v5.0
 *
 * 增强混合方案：相遇 → 洞察 → 首次相遇对话 → 期待
 *
 * 优化 v2.0:
 * - ✅ 动态导入步骤组件 (Vercel best practice: bundle-dynamic-imports)
 * - ✅ Suspense 边界实现流式加载 (Vercel best practice: async-suspense-boundaries)
 * - ✅ 减少首屏 bundle 大小
 */

import { Suspense } from 'react'
import dynamic from 'next/dynamic'
import { useOnboarding } from './context'

// ═══════════════════════════════════════════════════════════════════
// 动态导入步骤组件 - 减少首屏 bundle (Vercel best practice: bundle-dynamic-imports)
// ═══════════════════════════════════════════════════════════════════

// LandingStep 不动态导入,因为它是首屏必需
import LandingStep from './steps/LandingStep'

// 其他步骤动态导入,只在需要时加载
const LoadingStep = dynamic(() => import('./steps/LoadingStep'), {
  loading: () => <LoadingSkeleton />,
  ssr: false
})

const EmbeddedChatStep = dynamic(() => import('./steps/EmbeddedChatStep'), {
  loading: () => <LoadingSkeleton />,
  ssr: false
})

const ConversionStep = dynamic(() => import('./steps/ConversionStep'), {
  loading: () => <LoadingSkeleton />,
  ssr: false
})

// ═══════════════════════════════════════════════════════════════════
// Loading Skeleton - Suspense fallback
// ═══════════════════════════════════════════════════════════════════

function LoadingSkeleton() {
  return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="flex flex-col items-center gap-4">
        <div className="w-16 h-16 rounded-full border-4 border-accent-primary/20 border-t-accent-primary animate-spin" />
        <p className="text-sm text-text-secondary">加载中...</p>
      </div>
    </div>
  )
}

// ═══════════════════════════════════════════════════════════════════
// 主组件 - 使用 Suspense 边界
// ═══════════════════════════════════════════════════════════════════

export default function OnboardingPage() {
  const { state } = useOnboarding()

  // LandingStep 无需 Suspense,因为它已经在客户端
  if (state.step === 'landing') {
    return <LandingStep />
  }

  // 其他步骤使用 Suspense 边界,实现流式加载
  return (
    <Suspense fallback={<LoadingSkeleton />}>
      {state.step === 'loading' && <LoadingStep />}
      {state.step === 'embeddedChat' && <EmbeddedChatStep />}
      {state.step === 'conversion' && <ConversionStep />}
    </Suspense>
  )
}
