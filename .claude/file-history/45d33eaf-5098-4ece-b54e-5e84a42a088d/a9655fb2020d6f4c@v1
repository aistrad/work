import json
import os
import types

import pytest

pytest.importorskip("lunar_python")

from fastapi.testclient import TestClient

import os as _os
_os.environ["STUB_DB"] = "1"
import api.main as api_main


def _stub_submit_bazi_task_v2(payload, correlation_id=None):
    # simulate created job 101 and user 9
    return 101, 9, False, types.SimpleNamespace(
        year_pillar="甲子", month_pillar="乙丑", day_pillar="丙寅", hour_pillar="丁卯", wuxing="金木水火土",
        used_default_location=False, location={"name": "北京", "longitude": 116.4, "latitude": 39.9},
        calculated_at=None,
    )


def test_v2_submit_and_report(monkeypatch):
    monkeypatch.setattr("services.task_service.submit_bazi_task_v2", _stub_submit_bazi_task_v2)

    client = TestClient(api_main.app)

    payload = {
        "openid": "wx_123",
        "src": "wechat",
        "birth_data": {
            "name": "张三",
            "gender": "M",
            "year": 1990,
            "month": 1,
            "day": 1,
            "hour": 12,
            "minute": 0,
            "longitude": 116.4,
            "latitude": 39.9,
            "location_name": "北京"
        }
    }

    res = client.post("/api/v2/submit", json=payload)
    assert res.status_code == 200
    data = res.json()
    assert data["job_id"] == 101
    assert data["status"] == "processing"


def test_a2ui_validation_ok():
    from common.a2ui import validate_a2ui, example_payload

    validate_a2ui(example_payload())
