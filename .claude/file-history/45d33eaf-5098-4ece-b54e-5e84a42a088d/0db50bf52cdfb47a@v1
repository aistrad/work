import os
import json
from fastapi.testclient import TestClient

os.environ["STUB_DB"] = "1"
os.environ["GEMINI_STUB"] = "1"
os.environ["LLM_STANDARD_ENDPOINT"] = ""

import api.main as api_main


def test_route_main_ok_and_bazi2_redirect():
    client = TestClient(api_main.app)
    r = client.get("/main")
    assert r.status_code == 200
    assert "ui-layout" in r.text and "ui-thread" in r.text
    assert "/static/ui.css?v=" in r.text
    assert "/static/ui.js?v=" in r.text
    r2 = client.get("/bazi2", follow_redirects=False)
    assert r2.status_code in (307, 308)
    assert r2.headers.get("location") == "/main"


def test_bazi_ask_sync_basic(monkeypatch):
    # Ensure lunar_python is available in test env; the repo requires it
    from services import bazi_engine

    client = TestClient(api_main.app)
    payload = {
        "name": "测试",
        "gender": "男",
        "date": "1990-01-01",
        "time": "12:00:00",
        "question": "今年事业如何？",
    }
    r = client.post("/api/bazi/ask", json=payload)
    assert r.status_code == 200
    data = r.json()
    assert data.get("status") == "ok"
    assert isinstance(data.get("answer_md"), str)
    assert data.get("audit_id")


def test_conversations_endpoints_stubbed_db_safe(tmp_path, monkeypatch):
    # Avoid touching real disk layout; exercise "no user found" paths.
    monkeypatch.chdir(tmp_path)
    client = TestClient(api_main.app)
    r = client.get("/api/user/by-name", params={"name": "不存在"})
    assert r.status_code == 200
    assert r.json() == {"found": False}

    r2 = client.get("/api/conversations", params={"name": "不存在"})
    assert r2.status_code == 200
    assert r2.json() == {"sessions": []}

    r3 = client.get("/api/conversations/detail", params={"name": "不存在", "session_id": "../evil"})
    assert r3.status_code == 400


def test_chat_ask_basic(monkeypatch):
    monkeypatch.setenv("DEMO_MODE", "1")
    client = TestClient(api_main.app)
    payload = {
        "name": "测试",
        "session_id": "123",
        "system_prompt": "你是一个专业的占星师。",
        "messages": [{"role": "user", "text": "你好"}],
        "model": "standard",
    }
    r = client.post("/api/chat/ask", json=payload)
    assert r.status_code == 200
    data = r.json()
    assert data.get("status") == "processing"
    assert data.get("job_id")
    assert data.get("audit_id")
