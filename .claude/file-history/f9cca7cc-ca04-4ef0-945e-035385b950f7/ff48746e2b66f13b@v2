#!/usr/bin/env python3
"""
v11 HTTP æµ‹è¯•è„šæœ¬

é€šè¿‡ HTTP API æµ‹è¯• v11 åŠŸèƒ½
"""
import asyncio
import json
import sys
import httpx
from datetime import datetime

BASE_URL = "http://localhost:8100"
results = []


def log_test(name: str, passed: bool, detail: str = ""):
    """è®°å½•æµ‹è¯•ç»“æœ"""
    status = "âœ… PASS" if passed else "âŒ FAIL"
    results.append({"name": name, "passed": passed, "detail": detail})
    print(f"{status}: {name}")
    if detail:
        print(f"   â””â”€ {detail[:100]}")


async def test_health():
    """æµ‹è¯• API å¥åº·çŠ¶æ€"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 1: API å¥åº·æ£€æŸ¥")
    print("=" * 60)

    async with httpx.AsyncClient(base_url=BASE_URL, timeout=10.0) as client:
        response = await client.get("/health")
        log_test(
            "å¥åº·æ£€æŸ¥",
            response.status_code == 200,
            f"status: {response.json().get('status')}"
        )


async def test_skills_list():
    """æµ‹è¯• Skill åˆ—è¡¨"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 2: Skill åˆ—è¡¨")
    print("=" * 60)

    async with httpx.AsyncClient(base_url=BASE_URL, timeout=10.0) as client:
        response = await client.get("/api/v1/skills")
        data = response.json()

        log_test(
            "è·å– Skill åˆ—è¡¨",
            response.status_code == 200 and "skills" in data,
            f"count: {len(data.get('skills', []))}"
        )

        skills = data.get("skills", [])
        skill_ids = [s.get("id") for s in skills]

        log_test(
            "åŒ…å« core skill",
            "core" in skill_ids,
            f"skills: {skill_ids[:5]}"
        )


async def test_chat_phase1():
    """æµ‹è¯• Phase 1 è·¯ç”±ï¼ˆé€šè¿‡å¯¹è¯ï¼‰"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 3: Phase 1 è·¯ç”±å¯¹è¯")
    print("=" * 60)

    async with httpx.AsyncClient(base_url=BASE_URL, timeout=60.0) as client:
        # å‘é€èŠå¤©è¯·æ±‚
        response = await client.post(
            "/api/v5/chat",
            json={
                "message": "ä½ å¥½",
                "conversation_id": None,
            },
            headers={"Content-Type": "application/json"}
        )

        log_test(
            "Phase 1 å¯¹è¯è¯·æ±‚",
            response.status_code == 200,
            f"status: {response.status_code}"
        )

        # æ£€æŸ¥å“åº”
        if response.status_code == 200:
            content_type = response.headers.get("content-type", "")
            is_sse = "text/event-stream" in content_type

            if is_sse:
                # è§£æ SSE æµ
                text = response.text
                events = [line for line in text.split("\n") if line.startswith("data:")]

                log_test(
                    "è¿”å› SSE äº‹ä»¶",
                    len(events) > 0,
                    f"events: {len(events)}"
                )

                # æ£€æŸ¥æ˜¯å¦æœ‰ tool_call äº‹ä»¶ï¼ˆè¯´æ˜ LLM åœ¨è°ƒç”¨å·¥å…·ï¼‰
                tool_events = [e for e in events if "tool" in e.lower()]
                log_test(
                    "Phase 1 è§¦å‘å·¥å…·è°ƒç”¨",
                    len(tool_events) > 0 or len(events) > 0,
                    f"tool_events: {len(tool_events)}"
                )
            else:
                log_test(
                    "è¿”å› JSON å“åº”",
                    True,
                    f"response: {response.text[:100]}"
                )


async def test_chat_with_skill():
    """æµ‹è¯• Phase 2 Skill æ‰§è¡Œ"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 4: Phase 2 Skill æ‰§è¡Œ")
    print("=" * 60)

    async with httpx.AsyncClient(base_url=BASE_URL, timeout=60.0) as client:
        # ç›´æ¥è¯·æ±‚ bazi skill
        response = await client.post(
            "/api/v5/chat",
            json={
                "message": "å¸®æˆ‘ç®—å…«å­—",
                "conversation_id": None,
            },
            headers={"Content-Type": "application/json"}
        )

        log_test(
            "Skill æ¿€æ´»è¯·æ±‚",
            response.status_code == 200,
            f"status: {response.status_code}"
        )

        if response.status_code == 200:
            text = response.text
            # æ£€æŸ¥æ˜¯å¦è§¦å‘äº† skill æ¿€æ´»
            has_skill_ref = "bazi" in text.lower() or "skill" in text.lower() or "activate" in text.lower()
            log_test(
                "å“åº”åŒ…å« skill ç›¸å…³å†…å®¹",
                has_skill_ref or len(text) > 50,
                f"response length: {len(text)}"
            )


async def test_routing_config():
    """æµ‹è¯•è·¯ç”±é…ç½®åŠ è½½"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 5: è·¯ç”±é…ç½®")
    print("=" * 60)

    # é€šè¿‡æ£€æŸ¥ skill è¯¦æƒ…æ¥éªŒè¯é…ç½®
    async with httpx.AsyncClient(base_url=BASE_URL, timeout=10.0) as client:
        response = await client.get("/api/v1/skills/bazi")

        if response.status_code == 200:
            data = response.json()
            skill = data.get("skill", {})

            log_test(
                "è·å– bazi skill è¯¦æƒ…",
                bool(skill),
                f"name: {skill.get('name')}"
            )

            log_test(
                "skill æœ‰ triggers",
                bool(skill.get("triggers")),
                f"triggers: {skill.get('triggers', [])[:3]}"
            )
        else:
            log_test("è·å– skill è¯¦æƒ…", False, f"status: {response.status_code}")


def print_summary():
    """æ‰“å°æµ‹è¯•æ€»ç»“"""
    print("\n" + "=" * 60)
    print("æµ‹è¯•æ€»ç»“")
    print("=" * 60)

    passed = sum(1 for r in results if r["passed"])
    total = len(results)

    for r in results:
        status = "âœ…" if r["passed"] else "âŒ"
        print(f"  {status} {r['name']}")

    print(f"\né€šè¿‡: {passed}/{total}")

    if passed == total:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
        return 0
    else:
        print("\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥")
        return 1


async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("=" * 60)
    print("VibeLife v11 HTTP æµ‹è¯•")
    print(f"æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"API: {BASE_URL}")
    print("=" * 60)

    await test_health()
    await test_skills_list()
    await test_chat_phase1()
    await test_chat_with_skill()
    await test_routing_config()

    return print_summary()


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
