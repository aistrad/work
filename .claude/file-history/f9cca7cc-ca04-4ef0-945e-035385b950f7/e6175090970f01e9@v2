# Vibe 同步配置 - v11
#
# Vibe 层主动控制从哪些 Skill 抽取哪些数据
# 修改此配置无需改代码，重启服务即可生效
#
# 数据流：
#   Skill 工具调用 → update_skill_data → sync_skill_to_vibe → Vibe 层更新
#
# 文档：docs/archive/v9/LLM_DRIVEN_ARCHITECTURE.md#15

version: "1.0"

# ═══════════════════════════════════════════════════════════════
# Vibe.insight 的数据来源（我是谁）
# ═══════════════════════════════════════════════════════════════

insight:
  # 本质 (essence)
  essence:
    # 原型 (archetype) - 多来源，按优先级
    archetype:
      sources:
        - skill: bazi
          trigger: chart.day_master  # 当此路径有值时触发
          priority: 1  # 优先级最高
          transform: element_to_archetype
          mapping:
            wood: { primary: "成长者", traits: ["创新", "进取", "仁慈"] }
            fire: { primary: "表达者", traits: ["热情", "领导", "直觉"] }
            earth: { primary: "稳定者", traits: ["务实", "包容", "信守"] }
            metal: { primary: "完善者", traits: ["精准", "公正", "坚韧"] }
            water: { primary: "智慧者", traits: ["灵活", "深思", "洞察"] }
        - skill: zodiac
          trigger: chart.sun_sign
          priority: 2
          transform: sign_to_archetype
          mapping:
            aries: { primary: "开拓者", traits: ["勇敢", "主动", "独立"] }
            taurus: { primary: "稳定者", traits: ["稳定", "务实", "享受"] }
            gemini: { primary: "沟通者", traits: ["灵活", "沟通", "好奇"] }
            cancer: { primary: "守护者", traits: ["敏感", "关怀", "保护"] }
            leo: { primary: "领袖者", traits: ["自信", "慷慨", "创造"] }
            virgo: { primary: "完善者", traits: ["细致", "服务", "分析"] }
            libra: { primary: "和谐者", traits: ["和谐", "公正", "社交"] }
            scorpio: { primary: "洞察者", traits: ["深度", "洞察", "转化"] }
            sagittarius: { primary: "探索者", traits: ["乐观", "探索", "哲学"] }
            capricorn: { primary: "成就者", traits: ["务实", "责任", "成就"] }
            aquarius: { primary: "创新者", traits: ["创新", "独立", "人道"] }
            pisces: { primary: "直觉者", traits: ["直觉", "同情", "艺术"] }
        - skill: jungastro
          trigger: analysis.archetype
          priority: 3
          transform: direct  # 直接使用
          path: analysis.archetype

    # 命盘特征 (chart_features)
    chart_features:
      bazi:
        trigger: chart
        fields:
          - source: chart.day_master
            dest: bazi.day_master
          - source: chart.pillars
            dest: bazi.pillars
          - source: chart.five_elements
            dest: bazi.five_elements
          - source: chart.pattern
            dest: bazi.pattern
      zodiac:
        trigger: chart
        fields:
          - source: chart.sun_sign
            dest: zodiac.sun_sign
          - source: chart.moon_sign
            dest: zodiac.moon_sign
          - source: chart.rising_sign
            dest: zodiac.rising_sign
          - source: chart.dominant_element
            dest: zodiac.dominant_element

    # 特质 (traits) - 合并多来源
    traits:
      merge_strategy: append_unique  # 去重追加，保留 source 字段
      max_items: 5
      sources:
        - skill: bazi
          trigger: chart.day_master
          transform: extract_bazi_traits
          intensity: 0.8
        - skill: zodiac
          trigger: chart.sun_sign
          transform: extract_zodiac_traits
          intensity: 0.7

  # 动态 (dynamic) - 由 ProfileExtractor 定时更新
  dynamic:
    emotion:
      source: extracted.emotion  # 从 ProfileExtractor 抽取
    energy:
      source: extracted.energy

  # 规律 (pattern) - 由 ProfileExtractor 定时更新
  pattern:
    behaviors:
      source: extracted.behaviors
    insights:
      source: extracted.insights

# ═══════════════════════════════════════════════════════════════
# Vibe.target 的数据来源（我要成为谁）
# ═══════════════════════════════════════════════════════════════

target:
  # 北极星 (north_star)
  north_star:
    skill: lifecoach
    trigger: north_star
    fields:
      - source: north_star.vision_scene
        dest: vision_scene
      - source: north_star.anti_vision
        dest: anti_vision
      - source: north_star.statement
        dest: statement

  # 目标 (goals)
  goals:
    skill: lifecoach
    trigger: goals
    fields:
      - source: goals
        dest: goals
        transform: direct

  # 聚焦 (focus)
  focus:
    skill: lifecoach
    trigger: current
    fields:
      - source: current.month.goal_id
        dest: primary
      - source: current.week.rocks
        dest: active_rocks
        transform: extract_first_goal_id

  # 里程碑 (milestones)
  milestones:
    skill: lifecoach
    trigger: progress
    fields:
      - source: progress.streak
        dest: streak
      - source: progress.total_checkins
        dest: total_checkins

# ═══════════════════════════════════════════════════════════════
# Transform 函数定义（在 sync.py 中实现）
# ═══════════════════════════════════════════════════════════════

transforms:
  element_to_archetype:
    description: "五行元素 → 人格原型"
    input: "wood | fire | earth | metal | water"
    output: "{ primary: string, traits: string[] }"

  sign_to_archetype:
    description: "星座 → 人格原型"
    input: "aries | taurus | ... | pisces"
    output: "{ primary: string, traits: string[] }"

  extract_bazi_traits:
    description: "从八字日主提取特质"
    input: "chart.day_master"
    output: "[{ trait: string, intensity: float, source: 'bazi' }]"

  extract_zodiac_traits:
    description: "从星座提取特质"
    input: "chart.sun_sign"
    output: "[{ trait: string, intensity: float, source: 'zodiac' }]"

  extract_first_goal_id:
    description: "从列表中提取第一个 goal_id"
    input: "[{ goal_id: string, ... }]"
    output: "string | null"

  direct:
    description: "直接使用，不转换"
    input: "any"
    output: "any"
