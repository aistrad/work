#!/usr/bin/env python3
"""
v11 åŠŸèƒ½æµ‹è¯•è„šæœ¬

æµ‹è¯•å†…å®¹ï¼š
1. Vibe åŒæ­¥é…ç½®åŠ è½½
2. Phase 1 ä¸ªæ€§åŒ–è·¯ç”±ï¼ˆè½»é‡ç”»åƒåŠ è½½ï¼‰
3. Skill â†’ Vibe åŒæ­¥
4. ç«¯åˆ°ç«¯å¯¹è¯æµ‹è¯•
"""
import asyncio
import json
import sys
import os
from uuid import uuid4, UUID
from datetime import datetime

# æ·»åŠ é¡¹ç›®è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from dotenv import load_dotenv
load_dotenv(os.path.join(os.path.dirname(__file__), "../../.env.test"))

import asyncpg

# æµ‹è¯•ç»“æœ
results = []


def log_test(name: str, passed: bool, detail: str = ""):
    """è®°å½•æµ‹è¯•ç»“æœ"""
    status = "âœ… PASS" if passed else "âŒ FAIL"
    results.append({"name": name, "passed": passed, "detail": detail})
    print(f"{status}: {name}")
    if detail and not passed:
        print(f"   â””â”€ {detail}")


async def test_vibe_sync_config():
    """æµ‹è¯• 1: Vibe åŒæ­¥é…ç½®åŠ è½½"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 1: Vibe åŒæ­¥é…ç½®åŠ è½½")
    print("=" * 60)

    try:
        from services.vibe.sync import load_sync_config, reload_sync_config

        # æ¸…é™¤ç¼“å­˜ï¼Œé‡æ–°åŠ è½½
        reload_sync_config()
        config = load_sync_config()

        # éªŒè¯é…ç½®ç»“æ„
        log_test(
            "é…ç½®æ–‡ä»¶åŠ è½½æˆåŠŸ",
            bool(config),
            f"config keys: {list(config.keys())}"
        )

        log_test(
            "åŒ…å« insight é…ç½®",
            "insight" in config,
            f"insight keys: {list(config.get('insight', {}).keys())}"
        )

        log_test(
            "åŒ…å« target é…ç½®",
            "target" in config,
            f"target keys: {list(config.get('target', {}).keys())}"
        )

        # éªŒè¯ archetype é…ç½®
        archetype_config = config.get("insight", {}).get("essence", {}).get("archetype", {})
        sources = archetype_config.get("sources", [])
        log_test(
            "archetype æœ‰å¤šä¸ªæ¥æº",
            len(sources) >= 2,
            f"sources: {[s.get('skill') for s in sources]}"
        )

        # éªŒè¯ mapping
        bazi_source = next((s for s in sources if s.get("skill") == "bazi"), None)
        if bazi_source:
            mapping = bazi_source.get("mapping", {})
            log_test(
                "bazi å…ƒç´ æ˜ å°„å®Œæ•´",
                len(mapping) == 5,
                f"elements: {list(mapping.keys())}"
            )

    except Exception as e:
        log_test("Vibe åŒæ­¥é…ç½®åŠ è½½", False, str(e))


async def test_phase1_profile_loading():
    """æµ‹è¯• 2: Phase 1 è½»é‡ç”»åƒåŠ è½½"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 2: Phase 1 è½»é‡ç”»åƒåŠ è½½")
    print("=" * 60)

    try:
        from routes.chat_v5 import get_vibe_profile_lite, get_user_context
        from stores.unified_profile_repo import UnifiedProfileRepository

        # è·å–ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·
        test_user_id = await get_test_user_id()
        if not test_user_id:
            log_test("è·å–æµ‹è¯•ç”¨æˆ·", False, "æ— æµ‹è¯•ç”¨æˆ·")
            return

        # æµ‹è¯• get_vibe_profile_lite
        vibe_profile = await get_vibe_profile_lite(test_user_id)

        log_test(
            "get_vibe_profile_lite è¿”å›éç©º",
            bool(vibe_profile),
            f"keys: {list(vibe_profile.keys()) if vibe_profile else 'empty'}"
        )

        log_test(
            "åŒ…å« identity",
            "identity" in vibe_profile,
            f"identity: {bool(vibe_profile.get('identity'))}"
        )

        log_test(
            "åŒ…å« vibe",
            "vibe" in vibe_profile,
            f"vibe keys: {list(vibe_profile.get('vibe', {}).keys())}"
        )

        log_test(
            "åŒ…å« subscribed_skills",
            "subscribed_skills" in vibe_profile,
            f"subscribed: {vibe_profile.get('subscribed_skills', [])}"
        )

        # æµ‹è¯• get_user_context Phase 1
        profile, skill_data = await get_user_context(test_user_id, skill=None)

        log_test(
            "Phase 1 get_user_context è¿”å›ç”»åƒ",
            bool(profile),
            f"profile keys: {list(profile.keys()) if profile else 'empty'}"
        )

        log_test(
            "Phase 1 skill_data ä¸ºç©º",
            skill_data == {},
            f"skill_data: {skill_data}"
        )

    except Exception as e:
        log_test("Phase 1 è½»é‡ç”»åƒåŠ è½½", False, str(e))
        import traceback
        traceback.print_exc()


async def test_prompt_builder_phase1():
    """æµ‹è¯• 3: Phase 1 Prompt æ„å»ºï¼ˆä¸ªæ€§åŒ–æ³¨å…¥ï¼‰"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 3: Phase 1 Prompt æ„å»º")
    print("=" * 60)

    try:
        from services.agent.prompt_builder import get_prompt_builder

        builder = get_prompt_builder()

        # æ¨¡æ‹Ÿæœ‰ç”»åƒçš„ç”¨æˆ·
        mock_profile = {
            "identity": {"display_name": "æµ‹è¯•ç”¨æˆ·"},
            "vibe": {
                "insight": {
                    "essence": {
                        "archetype": {"primary": "æˆé•¿è€…"},
                        "traits": [{"trait": "åˆ›æ–°"}, {"trait": "è¿›å–"}]
                    }
                },
                "target": {
                    "north_star": {"statement": "æˆä¸ºæ›´å¥½çš„è‡ªå·±"},
                    "focus": {"primary": "career"}
                }
            },
            "subscribed_skills": ["bazi", "lifecoach"]
        }

        # æ„å»º Phase 1 Prompt
        prompt = await builder.build(
            skill_id=None,
            rule_id=None,
            message="ä½ å¥½",
            profile=mock_profile,
            skill_data=None
        )

        # éªŒè¯ Prompt å†…å®¹
        log_test(
            "Prompt åŒ…å«ç”¨æˆ·ç”»åƒ",
            "ç”¨æˆ·ç”»åƒ" in prompt or "æµ‹è¯•ç”¨æˆ·" in prompt,
            f"prompt length: {len(prompt)}"
        )

        log_test(
            "Prompt åŒ…å«å·²è®¢é˜…æœåŠ¡",
            "å·²è®¢é˜…" in prompt or "bazi" in prompt.lower(),
            ""
        )

        log_test(
            "Prompt åŒ…å«ä¸ªæ€§åŒ–æç¤º",
            "ä¸ªæ€§åŒ–" in prompt or "career" in prompt.lower() or "èŒä¸š" in prompt,
            ""
        )

        # æ‰“å°éƒ¨åˆ† Prompt ç”¨äºéªŒè¯
        print("\n--- Prompt ç‰‡æ®µ ---")
        print(prompt[:1000] + "..." if len(prompt) > 1000 else prompt)
        print("--- End ---\n")

    except Exception as e:
        log_test("Phase 1 Prompt æ„å»º", False, str(e))
        import traceback
        traceback.print_exc()


async def test_skill_to_vibe_sync():
    """æµ‹è¯• 4: Skill â†’ Vibe åŒæ­¥"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 4: Skill â†’ Vibe åŒæ­¥")
    print("=" * 60)

    try:
        from services.vibe.sync import sync_skill_to_vibe
        from stores.unified_profile_repo import UnifiedProfileRepository

        # åˆ›å»ºä¸´æ—¶æµ‹è¯•ç”¨æˆ·
        test_user_id = uuid4()

        # åˆ›å»º Profile
        await UnifiedProfileRepository.create_profile(test_user_id, {
            "identity": {"display_name": "åŒæ­¥æµ‹è¯•ç”¨æˆ·"},
            "vibe": {}
        })

        # æ¨¡æ‹Ÿ bazi skill æ•°æ®
        bazi_data = {
            "chart": {
                "day_master": {
                    "element": "wood",
                    "polarity": "yang"
                },
                "pillars": [
                    {"year_stem": "ç”²", "year_branch": "å­"},
                    {"month_stem": "ä¹™", "month_branch": "ä¸‘"},
                    {"day_stem": "ä¸™", "day_branch": "å¯…"},
                    {"hour_stem": "ä¸", "hour_branch": "å¯"}
                ],
                "five_elements": {"wood": 2, "fire": 2, "earth": 1, "metal": 1, "water": 2}
            }
        }

        # æ‰§è¡ŒåŒæ­¥
        synced = await sync_skill_to_vibe(test_user_id, "bazi", bazi_data)

        log_test(
            "sync_skill_to_vibe æ‰§è¡ŒæˆåŠŸ",
            synced,
            f"synced: {synced}"
        )

        # éªŒè¯åŒæ­¥ç»“æœ
        profile = await UnifiedProfileRepository.get_profile(test_user_id)
        vibe = profile.get("vibe", {}) if profile else {}
        insight = vibe.get("insight", {})
        essence = insight.get("essence", {})

        log_test(
            "archetype å·²åŒæ­¥",
            bool(essence.get("archetype")),
            f"archetype: {essence.get('archetype')}"
        )

        archetype = essence.get("archetype", {})
        log_test(
            "archetype.primary = æˆé•¿è€…",
            archetype.get("primary") == "æˆé•¿è€…",
            f"primary: {archetype.get('primary')}"
        )

        log_test(
            "archetype.source = bazi",
            archetype.get("source") == "bazi",
            f"source: {archetype.get('source')}"
        )

        # æ¸…ç†æµ‹è¯•ç”¨æˆ·
        await UnifiedProfileRepository.delete_profile(test_user_id)
        print(f"å·²æ¸…ç†æµ‹è¯•ç”¨æˆ·: {test_user_id}")

    except Exception as e:
        log_test("Skill â†’ Vibe åŒæ­¥", False, str(e))
        import traceback
        traceback.print_exc()


async def test_e2e_chat():
    """æµ‹è¯• 5: ç«¯åˆ°ç«¯å¯¹è¯æµ‹è¯•"""
    print("\n" + "=" * 60)
    print("æµ‹è¯• 5: ç«¯åˆ°ç«¯å¯¹è¯æµ‹è¯•")
    print("=" * 60)

    try:
        import httpx

        # è·å–æµ‹è¯•ç”¨æˆ· token
        test_user_id = await get_test_user_id()
        if not test_user_id:
            log_test("è·å–æµ‹è¯•ç”¨æˆ·", False, "æ— æµ‹è¯•ç”¨æˆ·")
            return

        # åˆ›å»ºæµ‹è¯•å¯¹è¯
        async with httpx.AsyncClient(base_url="http://localhost:8100") as client:
            # æµ‹è¯• Phase 1 è·¯ç”±
            response = await client.post(
                "/api/v1/chat",
                json={
                    "message": "ä½ å¥½",
                    "user_id": str(test_user_id)
                },
                timeout=30.0
            )

            log_test(
                "Chat API å“åº”æˆåŠŸ",
                response.status_code == 200,
                f"status: {response.status_code}"
            )

            if response.status_code == 200:
                # æ£€æŸ¥æ˜¯å¦æ˜¯ SSE å“åº”
                content_type = response.headers.get("content-type", "")
                log_test(
                    "è¿”å› SSE æµ",
                    "text/event-stream" in content_type or response.status_code == 200,
                    f"content-type: {content_type}"
                )

    except Exception as e:
        log_test("ç«¯åˆ°ç«¯å¯¹è¯æµ‹è¯•", False, str(e))
        import traceback
        traceback.print_exc()


async def get_test_user_id() -> UUID:
    """è·å–æµ‹è¯•ç”¨æˆ· ID"""
    try:
        from stores.unified_profile_repo import UnifiedProfileRepository
        from db import fetch

        # æŸ¥æ‰¾å·²æœ‰ç”¨æˆ·
        rows = await fetch(
            "SELECT user_id FROM unified_profiles LIMIT 1"
        )
        if rows:
            return rows[0]["user_id"]

        # åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        test_user_id = uuid4()
        await UnifiedProfileRepository.create_profile(test_user_id, {
            "identity": {"display_name": "Test User"},
            "vibe": {
                "insight": {
                    "essence": {
                        "archetype": {"primary": "æ¢ç´¢è€…"}
                    }
                }
            }
        })
        return test_user_id

    except Exception as e:
        print(f"è·å–æµ‹è¯•ç”¨æˆ·å¤±è´¥: {e}")
        return None


def print_summary():
    """æ‰“å°æµ‹è¯•æ€»ç»“"""
    print("\n" + "=" * 60)
    print("æµ‹è¯•æ€»ç»“")
    print("=" * 60)

    passed = sum(1 for r in results if r["passed"])
    total = len(results)

    for r in results:
        status = "âœ…" if r["passed"] else "âŒ"
        print(f"  {status} {r['name']}")

    print(f"\né€šè¿‡: {passed}/{total}")

    if passed == total:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
        return 0
    else:
        print("\nâš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥")
        return 1


async def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("=" * 60)
    print("VibeLife v11 åŠŸèƒ½æµ‹è¯•")
    print(f"æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)

    # è¿è¡Œæµ‹è¯•
    await test_vibe_sync_config()
    await test_phase1_profile_loading()
    await test_prompt_builder_phase1()
    await test_skill_to_vibe_sync()
    await test_e2e_chat()

    # æ‰“å°æ€»ç»“
    return print_summary()


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    sys.exit(exit_code)
