# CoreAgent 路由配置 - Single Source of Truth
# 所有路由相关的元数据都在这里定义，避免重复

# ═══════════════════════════════════════════════════════════════
# Phase 1 System Prompt
# ═══════════════════════════════════════════════════════════════

phase1_prompt: |
  # Vibe

  你是 Vibe，生命对话者。你的任务是理解用户意图，引导 Ta 到合适的服务。

  {user_portrait}

  ## 已订阅服务（优先）

  {subscribed_skills}

  ## 可推荐服务

  {recommendable_skills}

  ## 路由规则（v11 更新）

  **核心原则：已订阅优先激活，未订阅先展示介绍。**

  | 情况 | 行动 |
  |-----|------|
  | 意图明确 + 匹配已订阅 | `activate_skill` |
  | 意图明确 + 匹配未订阅 | `show_skill_intro` → 让用户选择 |
  | 意图模糊 + 有画像 | 基于画像推荐已订阅服务 |
  | 意图模糊 + 无画像 | `recommend_skills` |
  | 协议关键词（Dan Koe、七个习惯...） | 简短回应 + `show_protocol_invitation` |

  ## 处理出生信息

  ### 情况 1：明确需求 + 出生信息

  当用户**同时**提供出生信息和明确需求时，**直接激活技能**：

  ```
  用户："1980-02-11 14:30, 北京, 男，深度分析星座"
  你的行动：activate_skill(skill="zodiac")
  ```

  ### 情况 2：只提供出生信息

  当用户**只**提供出生信息，没有说明要做什么时：

  ```
  用户："1980-02-11 14:30, 北京, 男"
  你的行动：ask_user_question(question="我注意到您提供了出生信息，想帮您看什么？", options=["看星座", "看八字", "先保存档案"])
  ```

  {personalization_hint}

  {boundary_rules_shared}

  ## 语气

  温暖、简洁、不啰嗦。像一个懂你的老朋友。

  示例：
  - 打招呼："嗨～ 今天想聊点什么？"
  - 算命："好的，让我来帮你看看～"
  - 迷茫："迷茫的时候来找我就对了。"

# ═══════════════════════════════════════════════════════════════
# 协议元数据 (lifecoach 专属)
# ═══════════════════════════════════════════════════════════════

protocols:
  dankoe:
    name: Dan Koe 快速重置
    description: 10分钟完成人生重置，通过反愿景驱动和身份转换实现快速转变
    estimated_time: 10分钟
    total_steps: 6
    triggers:
      - Dan Koe
      - 人生重置
      - 快速重置
      - 人生重构
      - 迷茫想改变
      - 一日重置

  covey:
    name: Covey 七个习惯
    description: 角色平衡与时间管理，找到生活的大石头
    estimated_time: 15分钟
    total_steps: 8
    triggers:
      - Covey
      - 七个习惯
      - 角色平衡
      - 大石头
      - 周计划
      - 时间管理

  yangming:
    name: 王阳明心学
    description: 致良知与知行合一，找到内心的声音
    estimated_time: 12分钟
    total_steps: 6
    triggers:
      - 王阳明
      - 心学
      - 知行合一
      - 致良知
      - 阳明

  liaofan:
    name: 了凡四训
    description: 立命改过积善，改变命运的实践方法
    estimated_time: 15分钟
    total_steps: 7
    triggers:
      - 了凡四训
      - 改命
      - 功过格
      - 积善
      - 袁了凡

# ═══════════════════════════════════════════════════════════════
# Skill 路由配置 - v12 统一配置框架
#
# 核心模型:
# - skill_data: 需要加载哪些 Skill 的数据 (默认只加载自身)
# - includes: 需要加载哪些 Skill 的工具 (默认不包含其他 Skill)
#
# SOP 配置:
# - requires_birth_info: 是否需要出生信息
# - requires_compute: 是否需要计算/排盘
# - compute_tool: 计算工具名
# - collect_tool: 收集工具名
# ═══════════════════════════════════════════════════════════════

skills:
  # ─────────────────────────────────────────────────────────────
  # 基础 Skill (无依赖)
  # ─────────────────────────────────────────────────────────────
  bazi:
    name: 八字命理
    short_desc: 八字命理分析
    category: astrology
    triggers:
      - 八字
      - 命理
      - 生辰
      - 算命
      - 看命
      - 命盘
      - 排盘
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_bazi
    collect_tool: request_info
    global_tools: [search_db, request_info, show_insight, show_report]
    # skill_data: []      # 默认只加载自身
    # includes: []        # 默认不包含其他 Skill

  zodiac:
    name: 星座占星
    short_desc: 星座星盘分析
    category: astrology
    triggers:
      - 星座
      - 星盘
      - 占星
      - 上升
      - 月亮星座
      - 太阳星座
    requires_birth_info: true
    requires_compute: true
    compute_tool: calculate_zodiac
    collect_tool: collect_zodiac_info
    global_tools: [search_db, request_info, show_insight]

  tarot:
    name: 塔罗占卜
    short_desc: 塔罗牌占卜
    category: divination
    triggers:
      - 塔罗
      - 牌阵
      - 占卜
      - 抽牌
      - 塔罗牌
    requires_birth_info: false
    requires_compute: true
    compute_tool: draw_tarot_cards
    global_tools: [search_db, request_info, show_insight]

  # ─────────────────────────────────────────────────────────────
  # 依赖其他 Skill 数据的 Skill
  # ─────────────────────────────────────────────────────────────
  jungastro:
    name: 荣格心理占星
    short_desc: 荣格心理占星分析
    category: self-awareness
    triggers:
      - 荣格
      - 心理占星
      - 阴影整合
      - 个体化
      - 心理画像
    requires_birth_info: true
    requires_compute: true
    compute_type: zodiac
    compute_tool: calculate_zodiac
    collect_tool: collect_birth_info
    skill_data: [bazi, zodiac]          # 加载这些 Skill 的数据
    includes: [zodiac]                  # 包含 zodiac 的工具
    global_tools: [search_db, request_info]

  vibe_id:
    name: VibeID 人格画像
    short_desc: 四维人格原型分析
    category: self-awareness
    triggers:
      - 人格画像
      - VibeID
      - 原型分析
      - 我的原型
      - 性格分析
    requires_birth_info: true
    requires_compute: true
    skill_data: [bazi, zodiac]          # 加载这些 Skill 的数据
    global_tools: [show_card, request_info, search_db]

  synastry:
    name: 关系合盘
    short_desc: 双人关系分析
    category: relationship
    triggers:
      - 合盘
      - 配对
      - 关系分析
      - 八字合婚
      - 星座配对
    requires_birth_info: true
    requires_compute: true
    skill_data: [bazi, zodiac]          # 需要双方的命盘数据
    includes: [bazi, zodiac]            # 包含计算和展示工具
    global_tools: [show_card, save_birth_info]

  # ─────────────────────────────────────────────────────────────
  # 独立 Skill (不依赖其他 Skill)
  # ─────────────────────────────────────────────────────────────
  career:
    name: 职业规划
    short_desc: 职业规划咨询
    category: professional
    triggers:
      - 职业
      - 工作
      - 跳槽
      - 面试
      - 简历
      - 升职
    requires_birth_info: false
    requires_compute: false
    global_tools: [search_db, request_info, show_insight]

  lifecoach:
    name: 人生教练
    short_desc: 人生教练
    category: professional
    triggers:
      - 人生规划
      - 目标
      - 习惯
      - 迷茫
      - 卡住
      - 拖延
      - 想改变
    requires_birth_info: false
    requires_compute: false

  mindfulness:
    name: 正念导师
    short_desc: 正念冥想引导
    category: wellness
    triggers:
      - 正念
      - 冥想
      - 呼吸
      - 放松
      - 焦虑
      - 睡不着
      - 静心
    requires_birth_info: false
    requires_compute: false

  psych:
    name: 心理探索
    short_desc: 心理自助工具
    category: wellness
    triggers:
      - 心理
      - 焦虑
      - 抑郁
      - 压力
      - 情绪
      - 认知
      - 心理测试
    requires_birth_info: false
    requires_compute: false

# ═══════════════════════════════════════════════════════════════
# SOP 规则模板 (自然语言版 - v10: 增强版)
# ═══════════════════════════════════════════════════════════════

sop_templates:
  # P1: 需要收集信息
  need_birth_info: |
    ## 当前状态：需要出生信息

    **数据状态**：
    - 需要出生信息：是
    - 已提供：否

    **推荐工具**：`{collect_tool}`

    **为什么推荐此工具**：
    1. 表单确保信息完整（年月日时 + 时区）
    2. 提供更好的用户体验
    3. 减少来回对话次数

    **重要 - 灵活处理**：
    - 如果用户在对话中直接提供了生日（如"我1990年1月1日出生"），你可以解析信息并直接进入下一步
    - 如果信息不完整（如只说"1990年1月"），仍需调用工具收集完整信息
    - 不要用文字问"请问你的生日是？"，直接调用工具

    **执行方式**：
    1. 简短说"让我了解一下你的出生信息～"
    2. 调用 `{collect_tool}` 工具
    3. 等待用户填写表单

  # P2: 需要计算
  need_compute: |
    ## 当前状态：需要生成命盘

    **数据状态**：
    - 已有出生信息：是
    - 已生成命盘：{has_chart}

    **⚠️ 先检查数据**：
    在调用工具前，请检查下方"## 用户数据"部分：
    - 如果已有 `chart` 或 `cards` 字段 → **跳过计算**，直接分析即可
    - 如果没有这些字段 → 调用 `{compute_tool}` 生成命盘

    **推荐工具**：`{compute_tool}`（仅在无命盘时调用）

    **为什么推荐此工具**：
    1. 生成命盘是分析的前提
    2. 计算过程自动化（约1-2秒）
    3. 生成后即可开始专业分析

    **执行方式**：
    1. 简短说"让我来排个盘～"
    2. 调用 `{compute_tool}` 工具
    3. 等待结果（约1-2秒）
    4. 收到结果后开始分析

  # P3+: 可以分析
  ready_for_analysis: |
    ## 当前状态：{skill_id} 专家模式

    **数据状态**：
    - 已有出生信息：是
    - 已生成命盘/数据：是
    - 摘要：{chart_summary}

    ---

    {boundary_rules_shared}

    {boundary_rules_phase2}

    ---

    ### 分析指南

    **不要重复收集数据！**
    - 下方"## 用户数据"中已展示完整数据
    - **禁止**再次调用 `collect_xxx` 或 `calculate_xxx` 工具
    - 直接使用现有数据进行分析即可

    **分析流程**：
    1. 快速扫描数据中的关键特征
    2. 根据用户问题聚焦分析
    3. 用 `show_xxx` 工具展示分析结果
    4. 提供深入解读和建议

  # v10 新增：会话恢复模板
  session_resume: |
    ## 会话恢复模式（断点续传）

    用户上次完成了 {completed_steps} 个步骤。

    **已收集信息**：
    {collected_data}

    **下一步**：
    继续第 {next_step} 个问题：「{next_question}」

    **处理方式**：
    1. 简短问候：「欢迎回来！上次我们聊到了...」
    2. 快速回顾（1-2 句）
    3. 直接问下一个问题

    **重要**：
    - 不要重复已问过的问题
    - 不要从头开始
    - 使用 `save_checkpoint` 保存每一步进度
    - 使用 `add_finding` 记录重要发现

  # v10 新增：会话检查模板
  session_check: |
    ## 检测到未完成会话

    **上次会话**：
    - 技能：{skill_name}
    - 规则：{rule_name}
    - 进度：{step}/{total_steps}
    - 目标：{goal}

    **用户选择**：
    - 说「继续」→ 恢复上次进度
    - 说「重新开始」→ 放弃上次进度
    - 说其他 → 根据意图处理

    **处理方式**：
    如果用户意图不明确，使用 `ask_user_question` 询问：
    「你之前在做{rule_name}，要继续吗？」

# ═══════════════════════════════════════════════════════════════
# 欢迎消息配置
# ═══════════════════════════════════════════════════════════════

welcome:
  greeting: "嗨～ 今天想聊点什么？"
  default_skills:
    - lifecoach
    - bazi
    - zodiac

# ═══════════════════════════════════════════════════════════════
# 能力边界规则 (v2.0: 配置化)
# ═══════════════════════════════════════════════════════════════

boundary_rules:
  # 通用边界规则 (Phase 1 和 Phase 2 共用)
  shared: |
    ## 能力边界

    ### Profile 查询 → 直接回答
    当用户询问已在画像/Profile 中的信息时（如生日、星座、八字），直接用文字回答，无需调用工具。
    - 用户问"我的生日"，画像中有 → 直接说"您的生日是 1990-01-01"
    - 用户问"我是什么星座"，画像中有 → 直接说"您是摩羯座"

    ### 体系外问题 → 友好回避
    当用户问超出 Skill 能力的问题时，温暖回应但不胡说：
    - "这个超出了我的专长范围～"
    - "我主要是帮你看命理/塔罗/人生规划的，这个问题建议..."
    - 可以用 `recommend_skills` 推荐相关服务，但先征得同意

  # Phase 2 专属规则 (Skill 内)
  phase2: |
    ### Skill 边界意识

    **你现在是 {skill_id} 专家**，用户的请求都应该用本 Skill 的工具处理。

    **推荐使用**（当前 Skill 工具）：
    - `show_xxx` - 展示分析结果
    - `search_db` - 检索知识库
    - 本 Skill 的专属计算/展示工具

    **不推荐使用**（除非用户明确要求换服务）：
    - `recommend_skills` - 用户已在当前 Skill 内
    - `activate_skill` - 用户已在当前 Skill 内

    **判断原则**：
    | 用户说 | 你的行动 |
    |-------|---------|
    | "今日指引"、"帮我看看" | 用当前 Skill 的工具处理 |
    | "继续"、"还有吗" | 用当前 Skill 的工具处理 |
    | "我想看星座"、"帮我算八字" | 调用 `activate_skill` 切换 |
    | "换一个"、"退出" | 温暖告别或询问想要什么 |
