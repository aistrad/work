"use client";

/**
 * MePanel - Me Tab çš„å³ä¾§ Panel å†…å®¹ï¼ˆv9.1é‡æ„ï¼‰
 * å®šä½ï¼šSelf-Discovery Hubï¼ˆè‡ªæˆ‘è®¤çŸ¥ä¸­å¿ƒï¼‰
 *
 * ä¼˜åŒ–å†…å®¹ï¼š
 * 1. æ•´åˆ VibeIDã€å…«å­—ã€æ˜Ÿåº§ç­‰"äº†è§£è‡ªå·±"çš„å†…å®¹
 * 2. è®¾ç½®é¡¹æŠ˜å ï¼Œé™ä½è§†è§‰æƒé‡
 * 3. åº”ç”¨ VibeID çš„ç²¾ç¾è®¾è®¡é£æ ¼
 *
 * React Best Practices Applied:
 * - 6.3: Hoist static JSX (settings structure)
 * - 5.5: Functional setState for stable callbacks
 */

import { useState } from "react";
import { useRouter } from "next/navigation";
import { cn } from "@/lib/utils";
import { type SkillType } from "@/components/core";
import {
  User,
  Settings,
  CreditCard,
  Bell,
  ChevronDown,
  ChevronUp,
  LogOut,
  Crown,
  Check,
} from "lucide-react";
import { VibeIDCard } from "@/skills/vibe-id/components/VibeIDCard";
import {
  BaziSummaryCard,
  type BaziData,
} from "@/components/me/BaziSummaryCard";
import {
  ZodiacSummaryCard,
  type ZodiacData,
} from "@/components/me/ZodiacSummaryCard";

// Note: VibeIDDisplay should be imported from vibe-id types when available
// import { type VibeIDDisplay } from "@/types/vibe-id";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface UserProfile {
  name?: string;
  email?: string;
  avatar?: string;
  isPro?: boolean;
  subscriptionEndDate?: string;
  tagline?: string; // ç”¨æˆ·æ ‡ç­¾ï¼Œå¦‚ "åˆ›é€ è€… Â· æ¢ç´¢è€… Â· æ€è€ƒè€…"
}

interface MePanelProps {
  skill: SkillType;
  user?: UserProfile | null;
  vibeIdData?: any; // TODO: Replace with VibeIDDisplay when type is available
  baziData?: BaziData | null;
  zodiacData?: ZodiacData | null;
  voiceMode?: "warm" | "sarcastic" | "wise";
  onVoiceModeChange?: (mode: "warm" | "sarcastic" | "wise") => void;
  onEditProfile?: () => void;
  onManageSubscription?: () => void;
  onNotificationSettings?: () => void;
  onLogout?: () => void;
  className?: string;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub-components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function UserCard({ user, onEdit }: { user?: UserProfile | null; onEdit?: () => void }) {
  if (!user) {
    return (
      <div className="bg-bg-card border border-subtle shadow-soft rounded-xl p-4 text-center">
        <User className="w-12 h-12 text-muted-foreground mx-auto mb-2" />
        <p className="text-sm text-muted-foreground mb-3">
          ç™»å½•åå¯ä¿å­˜ä½ çš„æ•°æ®
        </p>
        <button className="px-4 py-2 bg-skill-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity">
          ç™»å½• / æ³¨å†Œ
        </button>
      </div>
    );
  }

  return (
    <div className="bg-gradient-to-br from-vellum-50/30 to-white border border-vellum-200/30 shadow-soft rounded-xl p-5">
      <div className="flex items-center gap-3 mb-3">
        <div className="w-14 h-14 rounded-full bg-muted flex items-center justify-center overflow-hidden">
          {user.avatar ? (
            <img src={user.avatar} alt={user.name} className="w-full h-full object-cover" />
          ) : (
            <User className="w-7 h-7 text-muted-foreground" />
          )}
        </div>
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <span className="font-serif text-lg font-semibold text-foreground">{user.name || "ç”¨æˆ·"}</span>
            {user.isPro && (
              <span className="flex items-center gap-1 px-1.5 py-0.5 bg-accent-100 dark:bg-accent-900/30 text-accent-700 dark:text-accent-300 rounded text-xs">
                <Crown className="w-3 h-3" />
                Pro
              </span>
            )}
          </div>
          <p className="text-xs text-muted-foreground">{user.email}</p>
        </div>
      </div>
      {user.tagline && (
        <p className="text-sm text-ink-600 text-center mb-2">
          {user.tagline}
        </p>
      )}
      {onEdit && (
        <button
          onClick={onEdit}
          className="mt-2 w-full text-center text-sm text-skill-primary hover:underline"
        >
          ç¼–è¾‘èµ„æ–™
        </button>
      )}
    </div>
  );
}

function SubscriptionCard({
  user,
  onManage,
}: {
  user?: UserProfile | null;
  onManage?: () => void;
}) {
  if (!user) return null;

  return (
    <div className="bg-bg-card border border-subtle shadow-soft rounded-xl p-4">
      <div className="flex items-center gap-2 mb-3">
        <CreditCard className="w-4 h-4 text-skill-primary" />
        <span className="text-sm font-medium text-foreground">è®¢é˜…ç®¡ç†</span>
      </div>

      {user.isPro ? (
        <div className="space-y-2">
          <div className="flex items-center gap-2 text-sm">
            <Check className="w-4 h-4 text-emerald-500" />
            <span className="text-foreground">Pro ä¼šå‘˜</span>
          </div>
          {user.subscriptionEndDate && (
            <p className="text-xs text-muted-foreground">
              æœ‰æ•ˆæœŸè‡³ {user.subscriptionEndDate}
            </p>
          )}
          <button
            onClick={onManage}
            className="w-full mt-2 px-3 py-2 border border-border rounded-lg text-sm text-foreground hover:bg-muted transition-colors"
          >
            ç®¡ç†è®¢é˜…
          </button>
        </div>
      ) : (
        <div className="space-y-2">
          <p className="text-sm text-muted-foreground">
            å‡çº§åˆ° Pro è§£é”å…¨éƒ¨åŠŸèƒ½
          </p>
          <button
            onClick={onManage}
            className="w-full px-3 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity"
          >
            <Crown className="w-4 h-4 inline mr-1" />
            å‡çº§ Pro
          </button>
        </div>
      )}
    </div>
  );
}

function SettingItem({
  icon: Icon,
  label,
  description,
  onClick,
  rightContent,
}: {
  icon: typeof Settings;
  label: string;
  description?: string;
  onClick?: () => void;
  rightContent?: React.ReactNode;
}) {
  return (
    <button
      onClick={onClick}
      className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted transition-colors text-left"
    >
      <Icon className="w-5 h-5 text-muted-foreground flex-shrink-0" />
      <div className="flex-1">
        <div className="text-sm font-medium text-foreground">{label}</div>
        {description && (
          <p className="text-xs text-muted-foreground">{description}</p>
        )}
      </div>
      {rightContent || <ChevronRight className="w-4 h-4 text-muted-foreground" />}
    </button>
  );
}

function VoiceModeToggle({
  value,
  onChange,
}: {
  value: "warm" | "sarcastic" | "wise";
  onChange?: (mode: "warm" | "sarcastic" | "wise") => void;
}) {
  return (
    <div className="flex gap-1 p-1 bg-muted rounded-lg">
      <button
        onClick={() => onChange?.("warm")}
        className={cn(
          "flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all",
          value === "warm"
            ? "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300"
            : "text-muted-foreground hover:text-foreground"
        )}
      >
        ğŸŒ æ¸©æš–
      </button>
      <button
        onClick={() => onChange?.("sarcastic")}
        className={cn(
          "flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all",
          value === "sarcastic"
            ? "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300"
            : "text-muted-foreground hover:text-foreground"
        )}
      >
        ğŸ˜ˆ åæ§½
      </button>
      <button
        onClick={() => onChange?.("wise")}
        className={cn(
          "flex-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all",
          value === "wise"
            ? "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300"
            : "text-muted-foreground hover:text-foreground"
        )}
      >
        ğŸ§™ ç¿æ™º
      </button>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MePanel Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export function MePanel({
  skill,
  user,
  vibeIdData,
  baziData,
  zodiacData,
  voiceMode = "warm",
  onVoiceModeChange,
  onEditProfile,
  onManageSubscription,
  onNotificationSettings,
  onLogout,
  className,
}: MePanelProps) {
  const router = useRouter();
  const [settingsExpanded, setSettingsExpanded] = useState(false);

  return (
    <div className={cn("h-full overflow-y-auto p-5 space-y-5", className)}>
      {/* User Info Section */}
      <section>
        <UserCard user={user} onEdit={onEditProfile} />
      </section>

      {/* Self-Discovery Section */}
      <section className="space-y-4">
        <h2 className="font-serif text-lg font-semibold text-foreground">
          äº†è§£è‡ªå·±
        </h2>

        {/* VibeID Card */}
        {vibeIdData ? (
          <VibeIDCard
            data={vibeIdData}
            variant="compact"
            onExplore={() => router.push("/skills/vibe-id")}
          />
        ) : null}

        {/* Bazi Summary */}
        <BaziSummaryCard
          data={baziData}
          onExplore={() => router.push("/chat?skill=bazi&prompt=çœ‹çœ‹æˆ‘çš„å‘½ç›˜")}
        />

        {/* Zodiac Summary */}
        <ZodiacSummaryCard
          data={zodiacData}
          onExplore={() => router.push("/chat?skill=zodiac&prompt=åˆ†ææˆ‘çš„æ˜Ÿç›˜")}
        />
      </section>

      {/* Settings Section (Collapsible) */}
      {user ? (
        <section>
          <button
            onClick={() => setSettingsExpanded((prev) => !prev)}
            className="w-full flex items-center justify-between py-2 hover:opacity-80 transition-opacity"
          >
            <h2 className="font-serif text-lg font-semibold text-foreground">
              è®¾ç½®
            </h2>
            {settingsExpanded ? (
              <ChevronUp className="w-5 h-5 text-muted-foreground" />
            ) : (
              <ChevronDown className="w-5 h-5 text-muted-foreground" />
            )}
          </button>

          {settingsExpanded ? (
            <div className="mt-3 space-y-4 animate-fade-in">
              {/* Subscription */}
              <SubscriptionCard user={user} onManage={onManageSubscription} />

              {/* Preferences */}
              <div className="bg-bg-card border border-subtle shadow-soft rounded-xl divide-y divide-border overflow-hidden">
                {/* Voice Mode */}
                <div className="p-3">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <Settings className="w-4 h-4 text-muted-foreground" />
                      <span className="text-sm font-medium text-foreground">
                        è¯­æ°”æ¨¡å¼
                      </span>
                    </div>
                  </div>
                  <VoiceModeToggle value={voiceMode} onChange={onVoiceModeChange} />
                </div>

                {/* Notifications */}
                <SettingItem
                  icon={Bell}
                  label="é€šçŸ¥è®¾ç½®"
                  description="ç®¡ç†æ¨é€é€šçŸ¥"
                  onClick={onNotificationSettings}
                />
              </div>
            </div>
          ) : null}
        </section>
      ) : null}

      {/* Logout */}
      {user ? (
        <section>
          <button
            onClick={onLogout}
            className="w-full flex items-center justify-center gap-2 px-4 py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors"
          >
            <LogOut className="w-4 h-4" />
            <span className="text-sm font-medium">é€€å‡ºç™»å½•</span>
          </button>
        </section>
      ) : null}
    </div>
  );
}
