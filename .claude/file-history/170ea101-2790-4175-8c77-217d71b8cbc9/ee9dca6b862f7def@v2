"use client";

import { useState, useCallback } from "react";
import { cn } from "@/lib/utils";
import type { StatusData } from "@/types/dashboard";

interface AmbientStatusBarProps {
  status: StatusData;
  onCheckIn: () => Promise<unknown>;
  className?: string;
}

/**
 * AmbientStatusBar - Chat ç©ºçŠ¶æ€ä¸­çš„ç®€åŒ–ç‰ˆ Ambient
 *
 * æ¨ªå‘å±•ç¤ºæ ¸å¿ƒæŒ‡æ ‡ï¼šè¿ç»­å¤©æ•°ã€èƒ½é‡ã€ç­¾åˆ°çŠ¶æ€
 * èåˆåˆ° Chat ç©ºçŠ¶æ€ï¼Œä¸é‡å¤æ˜¾ç¤ºé—®å€™å’Œåè¨€
 */
export function AmbientStatusBar({
  status,
  onCheckIn,
  className,
}: AmbientStatusBarProps) {
  const [isCheckingIn, setIsCheckingIn] = useState(false);

  const handleCheckIn = useCallback(async () => {
    if (status.checkedIn || isCheckingIn) return;

    setIsCheckingIn(true);
    try {
      await onCheckIn();
    } finally {
      setIsCheckingIn(false);
    }
  }, [onCheckIn, status.checkedIn, isCheckingIn]);

  const { streak, checkedIn, energy } = status;

  // æ ¹æ®è¿ç»­å¤©æ•°æ˜¾ç¤ºç«ç„°æ•°é‡
  const getFlameCount = (days: number) => {
    if (days >= 30) return 5;
    if (days >= 14) return 4;
    if (days >= 7) return 3;
    if (days >= 3) return 2;
    return 1;
  };

  const flames = "ğŸ”¥".repeat(getFlameCount(streak));

  return (
    <div
      className={cn(
        "flex items-center justify-between px-4 py-3 rounded-lg",
        className
      )}
      style={{
        background: 'var(--bg-card)',
        border: '1px solid var(--border-subtle)',
      }}
    >
      {/* å·¦ä¾§ï¼šçŠ¶æ€æŒ‡æ ‡ */}
      <div className="flex items-center gap-6">
        {/* Streak */}
        <div className="flex items-center gap-1.5">
          <span className="text-lg">{flames}</span>
          <span className="text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>
            {streak}å¤©è¿ç»­
          </span>
        </div>

        {/* Energy */}
        {energy !== undefined && (
          <div className="flex items-center gap-1.5">
            <span className="text-lg">ğŸ’ª</span>
            <span className="text-sm font-medium" style={{ color: 'var(--text-secondary)' }}>
              èƒ½é‡ {energy}%
            </span>
          </div>
        )}

        {/* Checked In Status */}
        <div className="flex items-center gap-1.5">
          <span style={{ color: checkedIn ? 'var(--color-success)' : 'var(--text-disabled)' }}>
            {checkedIn ? "âœ“" : "â–¡"}
          </span>
          <span
            className="text-sm font-medium"
            style={{ color: checkedIn ? 'var(--color-success)' : 'var(--text-tertiary)' }}
          >
            {checkedIn ? "å·²ç­¾åˆ°" : "æœªç­¾åˆ°"}
          </span>
        </div>
      </div>

      {/* å³ä¾§ï¼šç­¾åˆ°æŒ‰é’® */}
      {!checkedIn && (
        <button
          onClick={handleCheckIn}
          disabled={isCheckingIn}
          className="px-4 py-1.5 rounded-lg text-sm font-medium text-white disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105"
          style={{
            background: 'linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%)',
            boxShadow: 'var(--shadow-soft)',
          }}
        >
          {isCheckingIn ? "ç­¾åˆ°ä¸­..." : "å¼€å§‹ä»Šå¤©"}
        </button>
      )}
    </div>
  );
}
