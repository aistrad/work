"use client";

import { useCallback, useMemo } from "react";
import { useRouter } from "next/navigation";
import { cn } from "@/lib/utils";
import type { SkillType } from "@/components/core";
import type { DashboardDTO } from "@/types/dashboard";
import { DailyGreeting } from "@/components/greeting/DailyGreeting";
import { VibeGlyph, BreathAura } from "@/components/core";
import { AmbientStatusBar } from "./AmbientStatusBar";
import { LifecoachQuickView } from "./LifecoachQuickView";
import { SkillCarousel } from "@/components/dashboard/skills/SkillCarousel";
import { Skeleton } from "@/components/ui/Skeleton";

interface ChatEmptyStateWithDashboardProps {
  skill: SkillType;
  dashboardData?: DashboardDTO | null;
  isDashboardLoading?: boolean;
  onQuickPrompt?: (prompt: string) => void;
  onCheckIn: () => Promise<void>;
  onToggleLever: (leverId: string) => Promise<void>;
  onToggleRock: (rockId: string) => Promise<void>;
  // DailyGreeting props
  dailyGreeting: {
    greeting: string;
    solarTerm?: string | null;
    timeOfDay: string;
    date: string;
    todayTip: string;
    baziHint?: string;
    fortuneScore: number;
    fortuneHint: string;
    actionText: string;
    actionCompleted: boolean;
    onActionToggle: () => void;
    shareText: string;
  };
  className?: string;
}

/**
 * ChatEmptyStateWithDashboard - Chat 空状态（整合 Dashboard）
 *
 * 布局：
 * 1. DailyGreeting（保留原样）
 * 2. VibeGlyph（居中）
 * 3. AmbientStatusBar（状态条）
 * 4. LifecoachQuickView（可展开）
 * 5. MySkillsCarousel（横滑，点击发送 prompt）
 */
export function ChatEmptyStateWithDashboard({
  skill,
  dashboardData,
  isDashboardLoading,
  onQuickPrompt,
  onCheckIn,
  onToggleLever,
  onToggleRock,
  dailyGreeting,
  className,
}: ChatEmptyStateWithDashboardProps) {
  const router = useRouter();

  // Skill 卡片点击：发送预设 prompt
  const handleSkillCardClick = useCallback(
    (skillId: string) => {
      const promptMap: Record<string, string> = {
        bazi: "帮我看看今日运势",
        zodiac: "查看我的星盘运势",
        tarot: "帮我抽一张塔罗牌",
        career: "分析我的职业发展",
        lifecoach: "查看我的人生仪表盘",
      };

      const prompt = promptMap[skillId] || `切换到 ${skillId}`;
      onQuickPrompt?.(prompt);
    },
    [onQuickPrompt]
  );

  const handleNorthStarClick = useCallback(() => {
    onQuickPrompt?.("查看我的北极星愿景");
  }, [onQuickPrompt]);

  return (
    <div className={cn("flex flex-col items-center w-full md:max-w-xl mx-auto px-4 py-6 space-y-6", className)}>
      {/* 1. DailyGreeting */}
      <DailyGreeting
        greeting={dailyGreeting.greeting}
        solarTerm={dailyGreeting.solarTerm}
        timeOfDay={dailyGreeting.timeOfDay}
        date={dailyGreeting.date}
        todayTip={dailyGreeting.todayTip}
        baziHint={dailyGreeting.baziHint}
        fortuneScore={dailyGreeting.fortuneScore}
        fortuneHint={dailyGreeting.fortuneHint}
        actionItem={{
          text: dailyGreeting.actionText,
          completed: dailyGreeting.actionCompleted,
        }}
        onActionToggle={dailyGreeting.onActionToggle}
        shareText={dailyGreeting.shareText}
        className="w-full"
      />

      {/* 2. VibeGlyph */}
      <div className="relative flex items-center justify-center">
        {/* Outer pulsing rings */}
        <div className="absolute w-16 h-16 rounded-full border border-skill-primary/20 animate-pulse-slow" />
        <div className="absolute w-24 h-24 rounded-full border border-skill-primary/10 animate-pulse-slower" />

        {/* Breath aura */}
        <BreathAura
          skill={skill}
          size="sm"
          position="center"
          intensity="medium"
          className="opacity-40"
        />

        {/* Central glyph */}
        <VibeGlyph
          size="sm"
          skill={skill}
          showAura={true}
          animate={true}
          className="relative z-10"
        />
      </div>

      {/* Dashboard 数据加载状态 */}
      {isDashboardLoading ? (
        <DashboardLoadingSkeleton />
      ) : dashboardData ? (
        <>
          {/* 3. AmbientStatusBar */}
          <AmbientStatusBar
            status={dashboardData.status}
            onCheckIn={onCheckIn}
            className="w-full"
          />

          {/* 4. LifecoachQuickView */}
          <LifecoachQuickView
            data={dashboardData.lifecoach}
            onToggleLever={onToggleLever}
            onToggleRock={onToggleRock}
            onClickNorthStar={handleNorthStarClick}
            className="w-full"
          />

          {/* 5. MySkillsCarousel */}
          {dashboardData.mySkills && dashboardData.mySkills.length > 0 && (
            <div className="w-full">
              <h3 className="text-sm font-semibold mb-3 px-1" style={{ color: 'var(--text-tertiary)' }}>
                我的 Skills
              </h3>
              <SkillCarousel
                skills={dashboardData.mySkills}
                onCardClick={handleSkillCardClick}
              />
            </div>
          )}
        </>
      ) : null}
    </div>
  );
}

// Loading skeleton
function DashboardLoadingSkeleton() {
  return (
    <div className="w-full space-y-4">
      <Skeleton className="h-16 w-full rounded-lg" />
      <Skeleton className="h-24 w-full rounded-lg" />
      <Skeleton className="h-32 w-full rounded-lg" />
    </div>
  );
}
