# Agentic Skill System 设计方案 v1.0

版本: 1.0 | 日期: 2026-01-18
状态: 设计稿

---

## 1. 概述

### 1.1 背景

当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：
- 100+ 预定义 Scenario 文件
- 触发词匹配路由
- 固定 SOP 流程执行

问题：
- 场景数量爆炸，难以维护
- 触发词冲突，路由不准确
- LLM 抽取的 SOP 质量参差不齐
- 缺乏灵活性，无法处理预定义之外的需求

### 1.2 目标

设计 Agentic + 分析框架 的新架构：
- 删除 100+ Scenario 文件
- LLM 自主理解用户意图，自主决策服务策略
- 通过"分析框架"确保专业性和完整性
- 知识库作为 RAG 支撑，按需检索

### 1.3 核心原则

┌──────────────┬──────────────────────────────────────┐
│     原则     │                 说明                 │
├──────────────┼──────────────────────────────────────┤
│ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │
├──────────────┼──────────────────────────────────────┤
│ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │
├──────────────┼──────────────────────────────────────┤
│ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │
├──────────────┼──────────────────────────────────────┤
│ 工具优先     │ 用工具展示结果，而非纯文字           │
└──────────────┴──────────────────────────────────────┘

---

## 2. 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Agentic Skill System                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                      SKILL.md (精简版)                       │   │
│  │                                                              │   │
│  │  • 专家身份 (Expert Persona)                                 │   │
│  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │
│  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │
│  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │
│  │  • 伦理边界 (Ethics)                                         │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│                              ▼                                      │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     CoreAgent (LLM)                          │   │
│  │                                                              │   │
│  │  System Prompt = SKILL.md + User Context                     │   │
│  │                                                              │   │
│  │  Agentic Loop:                                               │   │
│  │  1. 理解用户意图                                             │   │
│  │  2. 匹配核心能力，获取分析框架                               │   │
│  │  3. 按框架规划分析步骤                                       │   │
│  │  4. 按需检索知识 (search_db)                                 │   │
│  │  5. 调用工具展示结果                                         │   │
│  │  6. 引导后续对话                                             │   │
│  │                                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                      │
│              ┌───────────────┼───────────────┐                     │
│              ▼               ▼               ▼                     │
│         ┌────────┐     ┌──────────┐    ┌────────┐                 │
│         │ Tools  │     │Knowledge │    │ Cases  │                 │
│         │        │     │  (RAG)   │    │        │                 │
│         └────────┘     └──────────┘    └────────┘                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 与传统架构对比

┌──────────┬──────────────────────────┬────────────────────────────────┐
│   维度   │    传统 Scenario 架构    │          Agentic 架构          │
├──────────┼──────────────────────────┼────────────────────────────────┤
│ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │
├──────────┼──────────────────────────┼────────────────────────────────┤
│ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │
├──────────┼──────────────────────────┼────────────────────────────────┤
│ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │
├──────────┼──────────────────────────┼────────────────────────────────┤
│ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │
├──────────┼──────────────────────────┼────────────────────────────────┤
│ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │
├──────────┼──────────────────────────┼────────────────────────────────┤
│ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │
├──────────┼──────────────────────────┼────────────────────────────────┤
│ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │
└──────────┴──────────────────────────┴────────────────────────────────┘

### 2.3 目录结构变化

```
# 变更前
skills/bazi/
├── SKILL.md                    # 复杂，包含场景目录
├── scenarios/                  # 100+ 场景文件
│   ├── basic_reading.md
│   ├── career.md
│   ├── relationship.md
│   └── ... (100+ files)
└── tools/
    ├── tools.yaml
    └── handlers.py

# 变更后
skills/bazi/
├── SKILL.md                    # 精简版，包含分析框架
├── scenarios/                  # 删除或归档
└── tools/
    ├── tools.yaml
    └── handlers.py
```

---

## 3. SKILL.md 模板设计

### 3.1 结构概览

```yaml
---
id: {skill_id}
name: {skill_name}
version: {version}
description: {description}
---
```

```markdown
# {Skill Name}

## 专家身份

## 核心能力与分析框架

## 工具列表与调用指南

## 知识检索指南

## 服务原则

## 伦理边界
```

### 3.2 Bazi SKILL.md 完整示例

```yaml
---
id: bazi
name: 八字命理
version: 3.0.0
description: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师
---
```

# 八字命理 Skill

## 专家身份

我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。

**核心理念**：
- 以用神为纲、调候为急、格局为本、十神生克为用
- 不故弄玄虚，用现代语言解读古老智慧
- 命理是趋势分析，不是宿命论

**知识来源优先级**：
1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）
2. 知识库检索结果
3. 实战验证案例
4. 通用命理知识

---

## 核心能力与分析框架

### 能力 1: 命盘解读

**适用场景**: 用户想了解自己的命盘、第一次算命、基础分析

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 日主强弱判断 | "{日主}日主 {月令} 强弱判断" |
| 2 | 格局识别 | "{日主} {月令} 格局" |
| 3 | 用神取用 | "{日主} {月令} 用神 调候" |
| 4 | 关键十神状态 | 根据命盘特点检索 |

**输出要求**:
- 必须调用 `show_bazi_chart` 展示命盘
- 必须调用 `show_insight` 展示核心洞察（不超过 4 点）
- 引导用户深入探索

---

### 能力 2: 事业分析

**适用场景**: 事业发展、职业方向、跳槽时机、升职

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 官杀状态 | "官杀分析 事业" |
| 2 | 财星状态 | "财星分析 收入" |
| 3 | 印星状态 | "印星分析 贵人 学习" |
| 4 | 食伤状态 | "食伤分析 才华 创业" |
| 5 | 大运流年影响 | "{当前大运} {流年} 事业" |
| 6 | 时机建议 | 综合以上给出建议 |

**输出要求**:
- 调用 `show_bazi_chart` 展示命盘
- 调用 `show_bazi_fortune` 展示大运流年
- 调用 `show_insight` 展示事业洞察
- 给出具体可操作的建议

---

### 能力 3: 感情婚姻

**适用场景**: 感情运势、婚姻状况、桃花、配偶特征

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 夫妻宫状态 | "日支 夫妻宫 婚姻" |
| 2 | 配偶星状态 | "正财/正官 配偶星" (男/女) |
| 3 | 桃花状态 | "桃花 感情" |
| 4 | 大运流年影响 | "{大运} {流年} 感情 婚姻" |
| 5 | 婚姻建议 | 综合以上给出建议 |

**性别差异**:
- 男命: 正财为妻星，偏财为情人
- 女命: 正官为夫星，七杀为情人

---

### 能力 4: 财运分析

**适用场景**: 财运走势、投资方向、求财时机

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 财星状态 | "正财 偏财 财运" |
| 2 | 财星与日主关系 | "身强/身弱 财运" |
| 3 | 食伤生财 | "食伤生财 求财方式" |
| 4 | 大运流年财运 | "{大运} {流年} 财运" |
| 5 | 求财建议 | 综合以上给出建议 |

---

### 能力 5: 运势预测

**适用场景**: 大运分析、流年运势、特定年份预测

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 大运主题 | "{大运干支} 大运 主题" |
| 2 | 流年细节 | "{流年干支} 流年 {日主}" |
| 3 | 大运流年交互 | "大运流年 交互 影响" |
| 4 | 关键月份 | 根据流年地支判断 |
| 5 | 趋吉避凶建议 | 综合以上给出建议 |

**输出要求**:
- 必须调用 `show_bazi_fortune` 展示大运流年
- 可选调用 `show_bazi_kline` 展示运势趋势图

---

### 能力 6: 合婚配对

**适用场景**: 双方八字合婚、配对分析

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 日主配合 | "合婚 日主 配合" |
| 2 | 用神互补 | "合婚 用神 互补" |
| 3 | 年柱纳音 | "合婚 纳音 年柱" |
| 4 | 冲合关系 | "合婚 冲合 地支" |
| 5 | 综合评分 | 综合以上给出评分和建议 |

**前置要求**: 必须收集双方出生信息

---

## 工具列表与调用指南

### 信息收集工具

| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |
| `request_info` | 请求补充信息 | 需要更多信息时 |

### 计算工具

| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |

### 展示工具

| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |
| `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |
| `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |
| `show_insight` | 展示洞察卡片 | 总结分析结果时 |
| `show_report` | 展示完整报告 | 深度分析完成时 |

### 检索工具

| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `search_db` | 检索知识/案例 | 需要专业知识支撑时 |

### 调用原则

1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集
2. **检索支撑**: 分析前先 `search_db` 获取相关知识
3. **工具展示**: 用工具呈现结果，比纯文字更直观
4. **框架完整**: 按分析框架覆盖所有要点

---

## 知识检索指南

### 检索策略

1. 理论知识: query = "{概念} 理论 原理"
2. 分析方法: query = "{主题} 分析方法 步骤"
3. 规则依据: query = "{主题} 规则 原则"
4. 参考案例: query = "{特征} 案例"
5. 经典引用: query = "{书名} {主题}"

### 检索示例

| 需要什么 | query 示例 |
|---------|-----------|
| 日主强弱理论 | "日主强弱 判断方法" |
| 格局判断方法 | "格局 判断 正格 变格" |
| 用神取用规则 | "用神 取用 扶抑 调候" |
| 十神生克规则 | "十神 生克 关系" |
| 事业分析案例 | "官杀 事业 案例" |
| 经典引用 | "滴天髓 用神" |

### 检索原则

1. **不确定时先检索**: 专业问题先查知识库
2. **query 要具体**: 描述清楚需要什么
3. **多次检索**: 复杂问题可分多次检索
4. **结果作为依据**: 检索结果用于支撑分析

---

## 服务原则

### 1. 框架完整
按分析框架覆盖关键要点，不遗漏重要分析。

### 2. 知识支撑
重要结论必须有知识库检索结果支撑，不凭空编造。

### 3. 工具优先
用工具展示结果（命盘图、洞察卡片），而非纯文字描述。

### 4. 引导深入
分析后引导用户探索更多方面，提供后续选项。

### 5. 语言亲和
用现代语言解读，避免过多术语，必要时解释专业概念。

---

## 伦理边界

### 绝对禁止
- 预测具体事件发生的确切日期
- 给出"命中注定"的定论
- 涉及健康诊断的具体预测
- 替用户做重大人生决定
- 预测死亡、重大灾难

### 表达原则
- 命理是趋势分析，不是宿命论
- 困难时期是成长机会，不是灾难预言
- 人的主观能动性可以改变命运轨迹
- 提供建议而非决定

### 敏感话题处理

| 话题 | 处理方式 |
|-----|---------|
| 健康 | 只分析五行倾向，建议咨询医生 |
| 寿命 | 不预测，转向生活质量建议 |
| 灾难 | 转化为"需要注意的时期" |
| 离婚 | 分析挑战，提供改善建议 |

### 3.3 Zodiac SKILL.md 完整示例

```yaml
---
id: zodiac
name: 西方占星
version: 3.0.0
description: 融合现代心理占星与传统占星的专业占星师
---
```

# 西方占星 Skill

## 专家身份

我是融合现代心理占星与传统占星的专业占星师。

**核心理念**：
- 星盘是潜能地图，不是命运判决书
- 行星能量可以有多种表达方式
- 占星是自我认知的工具

**知识来源优先级**：
1. 知识库检索结果
2. 心理占星理论
3. 传统占星规则
4. 通用占星知识

---

## 核心能力与分析框架

### 能力 1: 本命盘解读

**适用场景**: 了解自己的星盘、性格分析、人生主题

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 太阳星座 | "{太阳星座} 太阳 核心自我" |
| 2 | 月亮星座 | "{月亮星座} 月亮 情感需求" |
| 3 | 上升星座 | "{上升星座} 上升 外在形象" |
| 4 | 主要相位 | "{相位类型} 相位 含义" |
| 5 | 宫位分布 | 根据星盘特点检索 |

**输出要求**:
- 必须调用 `show_zodiac_chart` 展示星盘
- 必须调用 `show_insight` 展示核心洞察

---

### 能力 2: 行运分析

**适用场景**: 当前运势、行星过境影响、时机选择

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 外行星行运 | "{行星} 过境 {宫位}" |
| 2 | 行运相位 | "{行运行星} {相位} {本命行星}" |
| 3 | 影响领域 | 根据宫位判断 |
| 4 | 时间周期 | 根据行星速度判断 |
| 5 | 应对建议 | 综合以上给出建议 |

**输出要求**:
- 调用 `show_zodiac_transit` 展示行运
- 调用 `show_insight` 展示行运洞察

---

### 能力 3: 合盘分析

**适用场景**: 感情配对、关系分析、合作关系

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 日月相位 | "合盘 日月 相位 情感基础" |
| 2 | 金火相位 | "合盘 金星 火星 吸引力" |
| 3 | 土星相位 | "合盘 土星 承诺 挑战" |
| 4 | 宫位重叠 | "合盘 宫位 重叠" |
| 5 | 综合评估 | 综合以上给出评估 |

**输出要求**:
- 调用 `show_zodiac_synastry` 展示合盘
- 调用 `show_insight` 展示关系洞察

---

### 能力 4: 流年预测

**适用场景**: 年度运势、太阳回归、重要时间点

**分析框架** (必须覆盖):
| 步骤 | 分析要点 | 知识检索 query |
|-----|---------|---------------|
| 1 | 太阳回归盘 | "太阳回归 {年份} 主题" |
| 2 | 外行星行运 | "{行星} 行运 {年份}" |
| 3 | 日月食影响 | "日月食 {星座} 影响" |
| 4 | 关键时间点 | 根据行运判断 |
| 5 | 年度建议 | 综合以上给出建议 |

---

## 工具列表与调用指南

### 信息收集工具

| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |

### 展示工具

| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |
| `show_zodiac_transit` | 展示行运 | 用户问运势时 |
| `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |
| `show_insight` | 展示洞察 | 总结分析时 |

### 检索工具

| 工具 | 用途 | 何时调用 |
|-----|------|---------|
| `search_db` | 检索知识 | 需要专业知识时 |

---

## 知识检索指南

| 需要什么 | query 示例 |
|---------|-----------|
| 星座特质 | "{星座} 特质 性格" |
| 行星含义 | "{行星} 含义 能量" |
| 相位解读 | "{相位} 解读 影响" |
| 宫位意义 | "第{N}宫 意义 领域" |
| 行运影响 | "{行星} 过境 {宫位}" |

---

## 服务原则

1. **框架完整**: 按分析框架覆盖关键要点
2. **知识支撑**: 重要结论有检索结果支撑
3. **工具优先**: 用工具展示星盘和洞察
4. **心理导向**: 强调自我认知和成长

---

## 伦理边界

### 绝对禁止
- 预测具体事件日期
- 给出宿命论断言
- 健康诊断预测
- 替用户做决定

### 表达原则
- 星盘是潜能地图，不是命运判决
- 行星能量有多种表达方式
- 强调自由意志和选择

---

## 4. 知识库设计

### 4.1 知识库角色转变

传统角色: Scenario 指定检索 → 固定知识
新角色: LLM 按需检索 → 动态知识支撑

### 4.2 知识库结构

```sql
-- knowledge_chunks 表 (保持不变)
CREATE TABLE knowledge_chunks (
    id              UUID PRIMARY KEY,
    skill_id        VARCHAR(50) NOT NULL,
    document_id     UUID REFERENCES knowledge_documents(id),
    chunk_index     INT NOT NULL,
    content         TEXT NOT NULL,
    section_path    TEXT,
    section_title   VARCHAR(255),
    embedding       VECTOR(1024),
    search_text_preprocessed TEXT,
    metadata        JSONB,
    created_at      TIMESTAMP DEFAULT NOW()
);

-- cases 表 (保持不变)
CREATE TABLE cases (
    id              VARCHAR(50) PRIMARY KEY,
    skill_id        VARCHAR(50) NOT NULL,
    scenario_ids    VARCHAR[],  -- 可选，用于分类
    name            VARCHAR(255) NOT NULL,
    core_data       JSONB NOT NULL,
    features        JSONB NOT NULL,
    tags            VARCHAR[] NOT NULL,
    analysis        JSONB NOT NULL,
    conclusion      JSONB NOT NULL,
    authority       VARCHAR(20) DEFAULT 'medium',
    created_at      TIMESTAMP DEFAULT NOW()
);
```

### 4.3 检索接口

```python
# search_db 工具实现
async def search_db(
    table: str,           # "knowledge_chunks" 或 "cases"
    query: str,           # LLM 描述的检索需求
    skill_id: str,        # 限定 skill
    top_k: int = 5,       # 返回数量
    filters: dict = None  # 可选过滤条件
) -> List[Dict]:
    """
    语义检索知识或案例。

    LLM 通过 query 描述需求，向量检索返回相关内容。
    """
    embedding = await embed(query)

    if table == "knowledge_chunks":
        return await search_knowledge(skill_id, query, embedding, top_k)
    elif table == "cases":
        return await search_cases(skill_id, query, embedding, top_k, filters)
```

### 4.4 知识库质量要求

┌────────────┬───────────────────┬──────────────────┐
│    指标    │       目标        │       说明       │
├────────────┼───────────────────┼──────────────────┤
│ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │
├────────────┼───────────────────┼──────────────────┤
│ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │
├────────────┼───────────────────┼──────────────────┤
│ 检索准确率 │ ≥70%              │ Top-5 结果相关   │
└────────────┴───────────────────┴──────────────────┘

---

## 5. CoreAgent 调整

### 5.1 System Prompt 构建

```python
def build_system_prompt(
    skill_id: str,
    user_context: Optional[Dict] = None
) -> str:
    """
    构建 System Prompt。

    变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。
    """
    parts = []

    # 1. 加载 SKILL.md 全文
    skill_md = load_skill_md(skill_id)
    parts.append(skill_md)

    # 2. 注入用户上下文 (如果有)
    if user_context:
        ctx_text = format_user_context(user_context)
        parts.append(f"\n---\n\n## 用户上下文\n\n{ctx_text}")

    return "\n".join(parts)
```
