"use client";

/**
 * AppShell - ä¸‰æ å¸ƒå±€å®¹å™¨ v7.1
 * Based on: vibelife spec v6.8 + å‰ç«¯è§„èŒƒ v7.1
 *
 * å“åº”å¼æ–­ç‚¹ï¼ˆä¸ tailwind.config.ts ä¿æŒä¸€è‡´ï¼‰ï¼š
 * - PC â‰¥1024px (lg): ä¸‰æ å¸ƒå±€
 * - Tablet+Mobile <1024px: å•æ  + TabBar
 *
 * PCç«¯å¸ƒå±€ (â‰¥1024px):
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ NavBar â”‚         ä¸»å†…å®¹åŒºåŸŸ             â”‚   Insight Panel        â”‚
 * â”‚ (64px) â”‚       (flex-1, å·¦å¯¹é½)         â”‚    (320-600px å¯è°ƒ)    â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * ä¼˜åŒ–:
 * - å³ä¾§è¾¹æ æ”¯æŒæ‹–æ‹½è°ƒèŠ‚å®½åº¦ (320px - 600px)
 * - åŒå‡»æŠ˜å /å±•å¼€
 * - è®°ä½ç”¨æˆ·åå¥½
 * - é¢„è®¾å°ºå¯¸å¿«æ·åˆ‡æ¢ (S/M/L)
 *
 * Tablet+ç§»åŠ¨ç«¯å¸ƒå±€ (<1024px):
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  Header                                  â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  å†…å®¹åŒºåŸŸ (æ ¹æ®Tabå®Œå…¨åˆ‡æ¢)              â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  ğŸ’¬ Chat â”‚ ğŸ“Š Chart â”‚ ğŸ›¤ Journey â”‚ ğŸ‘¤ Me â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

import { useState, createContext, useContext, ReactNode } from "react";
import { cn } from "@/lib/utils";
import { type SkillType } from "@/components/core";
import { NavBar } from "./NavBar";
import { MobileTabBar } from "./MobileTabBar";
import { MobileHeader } from "./MobileHeader";
import { ResizablePanel } from "./ResizablePanel";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export type TabType = "chat" | "chart" | "journey" | "me";

interface AppShellContextValue {
  skill: SkillType;
  activeTab: TabType;
  setActiveTab: (tab: TabType) => void;
  voiceMode: "warm" | "sarcastic";
  setVoiceMode: (mode: "warm" | "sarcastic") => void;
}

const AppShellContext = createContext<AppShellContextValue | null>(null);

export function useAppShell() {
  const context = useContext(AppShellContext);
  if (!context) {
    throw new Error("useAppShell must be used within AppShell");
  }
  return context;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AppShell Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AppShellProps {
  skill: SkillType;
  children: ReactNode;
  /** å³ä¾§ Panel å†…å®¹ - æ ¹æ® activeTab ä¼ å…¥ä¸åŒå†…å®¹ */
  panelContent?: ReactNode;
  /** åˆå§‹æ¿€æ´»çš„ Tab */
  defaultTab?: TabType;
}

export function AppShell({
  skill,
  children,
  panelContent,
  defaultTab = "chat",
}: AppShellProps) {
  const [activeTab, setActiveTab] = useState<TabType>(defaultTab);
  const [voiceMode, setVoiceMode] = useState<"warm" | "sarcastic">("warm");

  const contextValue: AppShellContextValue = {
    skill,
    activeTab,
    setActiveTab,
    voiceMode,
    setVoiceMode,
  };

  return (
    <AppShellContext.Provider value={contextValue}>
      <div className="h-screen flex flex-col bg-background">
        {/* Mobile Header - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
        <div className="lg:hidden">
          <MobileHeader skill={skill} />
        </div>

        {/* Main Content Area */}
        <div className="flex-1 flex overflow-hidden">
          {/* Left NavBar - ä»… PC ç«¯æ˜¾ç¤º */}
          <div className="hidden lg:block">
            <NavBar
              skill={skill}
              activeTab={activeTab}
              onTabChange={setActiveTab}
            />
          </div>

          {/* Center - ä¸»å†…å®¹åŒºåŸŸ (PCç«¯å§‹ç»ˆæ˜¯Chatï¼Œç§»åŠ¨ç«¯æ ¹æ®Tabåˆ‡æ¢) */}
          <main className="flex-1 min-h-0 flex flex-col">
            {/* PCç«¯: å§‹ç»ˆæ˜¾ç¤º children (Chat) */}
            <div className="hidden lg:flex lg:flex-col h-full min-h-0">
              {children}
            </div>

            {/* ç§»åŠ¨ç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
            <div className="lg:hidden h-full min-h-0 flex flex-col">
              <MobileContent
                activeTab={activeTab}
                chatContent={children}
                panelContent={panelContent}
              />
            </div>
          </main>

          {/* Right Panel - ä»… PC ç«¯æ˜¾ç¤º, å¯è°ƒèŠ‚å®½åº¦ */}
          <div className="hidden lg:block">
            <ResizablePanel
              defaultWidth={400}
              minWidth={320}
              maxWidth={600}
            >
              {panelContent}
            </ResizablePanel>
          </div>
        </div>

        {/* Mobile TabBar - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
        <div className="lg:hidden">
          <MobileTabBar activeTab={activeTab} onTabChange={setActiveTab} />
        </div>
      </div>
    </AppShellContext.Provider>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MobileContent - ç§»åŠ¨ç«¯å†…å®¹åˆ‡æ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface MobileContentProps {
  activeTab: TabType;
  chatContent: ReactNode;
  panelContent?: ReactNode;
}

function MobileContent({ activeTab, chatContent, panelContent }: MobileContentProps) {
  // ç§»åŠ¨ç«¯æ ¹æ® Tab å®Œå…¨åˆ‡æ¢å†…å®¹
  switch (activeTab) {
    case "chat":
      return <div className="h-full">{chatContent}</div>;
    case "chart":
    case "journey":
    case "me":
      return (
        <div className="h-full overflow-y-auto">
          {panelContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              {activeTab === "chart" && "å›¾è¡¨/æŠ¥å‘Š"}
              {activeTab === "journey" && "å›é¡¾/æ—¶é—´çº¿"}
              {activeTab === "me" && "ä¸ªäººè®¾ç½®"}
            </div>
          )}
        </div>
      );
    default:
      return null;
  }
}
