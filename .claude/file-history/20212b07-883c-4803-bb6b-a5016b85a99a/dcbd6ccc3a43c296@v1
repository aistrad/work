# VibeLife 复杂组合指令工具设计文档

> 目标：让用户能完成 "年目标拆解 + 每日计划 + 持续监督" 等复杂指令

---

## 核心设计思路

**两层架构**：Core Skill 提供原子工具，子技能组合使用

```
Core Skill (基础层)
├── 原子化工具
│   ├── read_user_data    # 读取用户数据
│   ├── write_user_data   # 写入用户数据
│   ├── query_user_data   # 查询用户数据
│   ├── schedule_reminder # 设置提醒
│   └── cancel_reminder   # 取消提醒
│
└── 子技能 (组合层) - 在 scenarios/ 中定义
    ├── goal_tracking     # 目标追踪 - 组合 read/write/schedule
    ├── relationship_calc # 关系计算 - 组合 read/query + bazi/zodiac
    └── time_window       # 时间窗口推荐 - 组合 query + bazi/zodiac
```

**执行流程**:
```
用户说 "这是我的年目标，帮我拆解"
    ↓
1. Core Skill 路由到 goal_tracking 子技能
2. LLM 调用 write_user_data 存储目标
3. LLM 调用 decompose 逻辑分解目标
4. LLM 调用 schedule_reminder 设置每日提醒
5. 用户可通过 read_user_data / write_user_data 编辑计划
```

---

## 数据模型

### user_data_store 表

用户个性化数据存储，支持 JSON 文件 + 数据库双向同步。

```sql
CREATE TABLE user_data_store (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id     UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    data_type   VARCHAR(50) NOT NULL,  -- goals, tasks, checkins, files
    data_path   VARCHAR(500) NOT NULL, -- 虚拟路径: goals/2026/year.json
    content     JSONB NOT NULL,        -- JSON 数据
    version     INTEGER DEFAULT 1,
    created_at  TIMESTAMP DEFAULT NOW(),
    updated_at  TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, data_path)
);
```

### 虚拟文件系统

```
/users/{user_id}/
├── goals/2026/
│   ├── year_goal.md       # 年度目标文档
│   └── months/01.md       # 月度分解
├── plans/daily/
│   └── 2026-01-18.md      # 每日计划
└── reflections/
    └── week_01.md         # 周复盘
```

### Profile 扩展

```json
{
  "goal_tracking": {
    "last_checkin": "2026-01-17",
    "streak_days": 5,
    "reminder_time": "08:00",
    "enable_fortune_insights": true
  }
}
```

---

## 原子工具设计

### 数据工具 (Core Skill)

| 工具 | 类型 | 用途 |
|------|------|------|
| `read_user_data` | action | 读取用户 JSON 数据 |
| `write_user_data` | action | 写入用户 JSON 数据 |
| `query_user_data` | action | 查询用户数据 (支持过滤) |
| `delete_user_data` | action | 删除用户数据 |

### 提醒工具

| 工具 | 类型 | 用途 |
|------|------|------|
| `schedule_reminder` | action | 设置定时提醒 |
| `list_reminders` | action | 列出用户的提醒 |
| `cancel_reminder` | action | 取消提醒 |

### 展示工具 (子技能特定)

| 工具 | 类型 | 用途 | 子技能 |
|------|------|------|-------|
| `show_goal_tree` | display | 展示目标树 | goal_tracking |
| `show_daily_plan` | display | 展示今日计划 | goal_tracking |
| `show_checkin_form` | display | 打卡复盘表单 | goal_tracking |

---

## 子技能设计

### goal_tracking (目标追踪)

**触发词**: 目标, 计划, 任务, 监督我, 打卡

**工具组合**:
- `write_user_data` - 存储目标
- `read_user_data` - 读取进度
- `schedule_reminder` - 设置提醒
- `show_goal_tree` - 展示目标树

**流程**:
1. 收集年度目标
2. 智能分解为季度/月度/周度任务
3. 设置每日提醒
4. 每日打卡和复盘

### relationship_calc (关系计算)

**触发词**: 合盘, 关系分析, 缘分, 匹配度

**工具组合**:
- `read_user_data` - 读取双方信息
- `calculate_bazi` - 八字计算
- `calculate_zodiac` - 星座计算
- `show_compatibility` - 展示匹配结果

### time_window (时间窗口)

**触发词**: 最佳时间, 什么时候适合, 择日

**工具组合**:
- `query_user_data` - 查询用户偏好
- `calculate_bazi` - 八字运势
- `calculate_zodiac` - 行星运势
- `show_time_windows` - 展示推荐时间

---

## 定时提醒配置

| 提醒 | 触发 | 内容 |
|------|------|------|
| 每日计划 | 早8点 | 今日任务预览 + 命理提示 |
| 每日复盘 | 晚9点 | 打卡提醒 |
| 周复盘 | 周日晚8点 | 本周总结 |
| 里程碑 | 截止前 7/3/1 天 | 目标到期提醒 |
| 连续打卡 | 7/14/21/30 天 | 庆祝激励 |

---

## 文件清单

### 需新建

- `apps/api/stores/migrations/007_user_data_store.sql` - 数据库迁移
- `apps/api/skills/core/services/user_data.py` - 用户数据服务
- `apps/api/skills/core/services/reminder.py` - 提醒服务
- `apps/api/skills/core/scenarios/goal_tracking.md` - 目标追踪子技能
- `apps/api/skills/core/scenarios/relationship.md` - 关系计算子技能
- `apps/api/skills/core/scenarios/time_window.md` - 时间窗口子技能

### 需修改

- `apps/api/skills/core/tools/tools.yaml` - 新增原子工具
- `apps/api/skills/core/tools/handlers.py` - 新增处理器
- `apps/api/skills/core/SKILL.md` - 添加子技能描述
- `apps/api/skills/core/reminders.yaml` - 添加目标相关提醒

---

## 实现阶段

| 阶段 | 内容 | 产出 |
|------|------|------|
| P1 | 数据模型 + 原子工具 | user_data_store 表 + read/write/query 工具 |
| P2 | goal_tracking 子技能 | 目标分解、每日计划生成 |
| P3 | 提醒工具 + Worker | schedule_reminder + 每日推送 |
| P4 | 前端卡片 | goal_tree, daily_plan, checkin 卡片 |
| P5 | 扩展子技能 | relationship, time_window |
