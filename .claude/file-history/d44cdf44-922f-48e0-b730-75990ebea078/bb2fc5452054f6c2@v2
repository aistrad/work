# VibeLife 合盘功能设计文档

> Version: 1.0 | 2026-01-22
> Author: Claude + Product Team
> Status: Draft

---

## 1. 产品定位

**「合盘」是 VibeLife 的跨 Skill 关系分析功能**，通过融合多维度命理系统（星座、八字、荣格心理占星等），为用户提供全面的关系洞察。

### 1.1 核心价值

| 差异化 | 说明 |
|--------|------|
| **跨维度融合** | 不只是星座配对，而是星座+八字+荣格的多维分析 |
| **多关系类型** | 支持恋爱、亲子、合伙人、朋友等多种关系 |
| **简单易用** | 输入对方生辰即可，无需对方注册 |
| **关系管理** | 可保存多个关系对象，随时查看合盘 |

### 1.2 用户场景

| 场景 | 说明 | 优先级 |
|------|------|--------|
| 恋爱配对 | 想了解和 TA 的缘分、相处模式 | P0 |
| 亲子关系 | 理解孩子性格，改善亲子沟通 | P1 |
| 合伙人评估 | 找合伙人前先看看合不合 | P1 |
| 朋友理解 | 深入了解朋友的相处模式 | P2 |
| 家人关系 | 理解兄弟姐妹、父母的相处之道 | P2 |

---

## 2. 功能设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Synastry Feature Architecture                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   用户: "想看和 TA 的合盘"                                               │
│       │                                                                  │
│       ▼                                                                  │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                      Synastry Skill                               │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │  │
│   │  │ collect_    │  │ select_     │  │ calculate_  │               │  │
│   │  │ synastry_   │  │ relationship│  │ synastry    │               │  │
│   │  │ info        │  │             │  │             │               │  │
│   │  └─────────────┘  └─────────────┘  └─────────────┘               │  │
│   │         │                │                │                       │  │
│   │         └────────────────┴────────────────┘                       │  │
│   │                          │                                        │  │
│   │                          ▼                                        │  │
│   │            ┌─────────────────────────────┐                        │  │
│   │            │      SynastryEngine         │                        │  │
│   │            │  (轻度融合 - 各 Skill 独立)  │                        │  │
│   │            └─────────────────────────────┘                        │  │
│   │                          │                                        │  │
│   │    ┌─────────────────────┼─────────────────────┐                  │  │
│   │    ▼                     ▼                     ▼                  │  │
│   │ ┌────────┐          ┌────────┐          ┌──────────┐              │  │
│   │ │Zodiac  │          │ Bazi   │          │Jungastro │              │  │
│   │ │Synastry│          │Synastry│          │ Synastry │              │  │
│   │ └────────┘          └────────┘          └──────────┘              │  │
│   │    │                     │                     │                  │  │
│   │    └─────────────────────┴─────────────────────┘                  │  │
│   │                          │                                        │  │
│   │                          ▼                                        │  │
│   │                   AI 综合解读                                     │  │
│   │                          │                                        │  │
│   └──────────────────────────┼───────────────────────────────────────┘  │
│                              │                                          │
│                              ▼                                          │
│   ┌──────────────────────────────────────────────────────────────────┐  │
│   │                      前端卡片展示                                  │  │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │  │
│   │  │ ZodiacSyn.   │  │ BaziSyn.     │  │JungastroSyn. │            │  │
│   │  │ Card         │  │ Card [NEW]   │  │ Card [NEW]   │            │  │
│   │  └──────────────┘  └──────────────┘  └──────────────┘            │  │
│   │                              +                                    │  │
│   │                    SynastryOverviewCard                          │  │
│   └──────────────────────────────────────────────────────────────────┘  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 用户流程

```
用户说「想看和 TA 的合盘」
    │
    ├─ LLM 调用 activate_skill("synastry")
    │
    ▼
检查用户是否已保存「关系对象」
    │
    ├─ 有 → 展示 SelectRelationshipCard
    │       用户选择已有对象 或 点击「添加新的」
    │
    └─ 无 → 直接进入收集流程
    │
    ▼
CollectSynastryInfoCard（收集对方信息）
    │
    │ 必填字段：
    │   - 姓名/昵称
    │   - 关系类型（恋人/配偶/亲子/兄弟姐妹/合伙人/朋友）
    │   - 出生日期
    │   - 出生地点
    │
    │ 可选字段：
    │   - 出生时间（不填则使用正午 12:00）
    │   - 备注
    │
    ▼
询问是否保存关系对象（可选）
    │
    ├─ 保存 → 调用 save_relationship 工具
    └─ 不保存 → 继续
    │
    ▼
调用 calculate_synastry 计算合盘
    │
    │ 根据用户已订阅的 Skill 生成对应维度分析：
    │   - zodiac 已订阅 → 计算星座合盘
    │   - bazi 已订阅 → 计算八字合婚
    │   - jungastro 已订阅 → 计算荣格关系
    │
    ▼
按顺序展示卡片
    │
    ├─ SynastryOverviewCard（综合总览 - 评分+摘要）
    │
    ├─ ZodiacSynastryCard（星座合盘详情）
    │
    ├─ BaziSynastryCard（八字合婚详情）
    │
    └─ JungastroSynastryCard（荣格关系详情）
    │
    ▼
AI 综合解读（文本形式的深度分析和建议）
```

### 2.3 关系类型定义

```typescript
type RelationshipType =
  | 'romantic'      // 恋爱/约会对象
  | 'spouse'        // 配偶/伴侣
  | 'parent_child'  // 亲子
  | 'sibling'       // 兄弟姐妹
  | 'business'      // 合伙人/同事
  | 'friend';       // 朋友

const RELATIONSHIP_CONFIG: Record<RelationshipType, RelationshipMeta> = {
  romantic: {
    label: '恋人/约会对象',
    icon: '💕',
    analysisEmphasis: ['passion', 'emotional', 'communication'],
    description: '正在约会或发展恋爱关系'
  },
  spouse: {
    label: '配偶/伴侣',
    icon: '💍',
    analysisEmphasis: ['stability', 'emotional', 'growth'],
    description: '已婚或长期稳定伴侣'
  },
  parent_child: {
    label: '亲子',
    icon: '👨‍👧',
    analysisEmphasis: ['communication', 'growth', 'understanding'],
    description: '父母与子女的关系'
  },
  sibling: {
    label: '兄弟姐妹',
    icon: '👫',
    analysisEmphasis: ['understanding', 'cooperation', 'rivalry'],
    description: '同胞兄弟姐妹'
  },
  business: {
    label: '合伙人/同事',
    icon: '🤝',
    analysisEmphasis: ['cooperation', 'trust', 'complementary'],
    description: '工作伙伴或商业合作'
  },
  friend: {
    label: '朋友',
    icon: '👥',
    analysisEmphasis: ['compatibility', 'fun', 'support'],
    description: '朋友关系'
  }
};
```

---

## 3. 数据结构设计

### 3.1 VibeProfile 扩展

在现有 VibeProfile 结构中新增 `relationships` 字段：

```yaml
profile:
  account: { ... }
  identity: { ... }
  skills: { ... }
  vibe: { ... }
  preferences: { ... }

  # 新增：关系对象列表
  relationships:
    - id: "rel_abc123"
      name: "小明"
      relationship_type: "romantic"
      birth_info:
        date: "1990-05-15"
        time: "14:30"           # 可选，null 表示未知
        place: "上海"
        timezone: "Asia/Shanghai"
      created_at: "2026-01-22T10:00:00Z"
      updated_at: "2026-01-22T10:00:00Z"
      last_synastry_at: "2026-01-22T10:30:00Z"
      notes: "大学同学，在一起3年了"   # 用户备注，可选
      synastry_count: 5                 # 合盘次数统计

    - id: "rel_def456"
      name: "爸爸"
      relationship_type: "parent_child"
      birth_info:
        date: "1965-08-20"
        time: null              # 不知道具体时间
        place: "北京"
        timezone: "Asia/Shanghai"
      created_at: "2026-01-20T08:00:00Z"
      updated_at: "2026-01-20T08:00:00Z"
      last_synastry_at: null
      notes: null
      synastry_count: 0
```

### 3.2 Relationship 数据模型

```python
from dataclasses import dataclass
from datetime import datetime
from typing import Optional
from enum import Enum

class RelationshipType(str, Enum):
    ROMANTIC = "romantic"
    SPOUSE = "spouse"
    PARENT_CHILD = "parent_child"
    SIBLING = "sibling"
    BUSINESS = "business"
    FRIEND = "friend"

@dataclass
class RelationshipBirthInfo:
    date: str                      # YYYY-MM-DD
    place: str                     # 城市名
    time: Optional[str] = None     # HH:MM，可选
    timezone: str = "Asia/Shanghai"

@dataclass
class Relationship:
    id: str
    name: str
    relationship_type: RelationshipType
    birth_info: RelationshipBirthInfo
    created_at: datetime
    updated_at: datetime
    last_synastry_at: Optional[datetime] = None
    notes: Optional[str] = None
    synastry_count: int = 0
```

### 3.3 合盘结果数据模型

```python
@dataclass
class SynastryDimensionResult:
    """单个维度（Skill）的合盘结果"""
    skill_id: str                  # zodiac | bazi | jungastro
    score: int                     # 0-100
    summary: str                   # 一句话总结
    data: dict                     # 详细数据（用于卡片渲染）

@dataclass
class SynastryResult:
    """完整合盘结果"""
    person1: dict                  # 用户信息摘要
    person2: dict                  # 对方信息摘要
    relationship_type: RelationshipType
    overall_score: int             # 综合评分
    dimensions: list[SynastryDimensionResult]
    ai_summary: Optional[str] = None  # AI 综合解读（由 LLM 生成）
    calculated_at: datetime = None
```

### 3.4 数据库无需新增表

关系对象存储在 `unified_profiles.profile` 的 JSONB 字段中，无需新增独立表。

合盘结果不持久化存储，仅存在于会话消息中。

---

## 4. API 设计

### 4.1 UnifiedProfileRepository 扩展

```python
class UnifiedProfileRepository:
    """扩展方法 - 关系对象管理"""

    # 读取
    async def get_relationships(self, user_id: str) -> list[dict]:
        """获取用户的所有关系对象"""

    async def get_relationship(self, user_id: str, relationship_id: str) -> Optional[dict]:
        """获取单个关系对象"""

    # 写入
    async def add_relationship(self, user_id: str, relationship: dict) -> str:
        """添加关系对象，返回生成的 ID"""

    async def update_relationship(self, user_id: str, relationship_id: str, updates: dict):
        """更新关系对象"""

    async def delete_relationship(self, user_id: str, relationship_id: str):
        """删除关系对象"""

    async def record_synastry(self, user_id: str, relationship_id: str):
        """记录一次合盘，更新 last_synastry_at 和 synastry_count"""
```

### 4.2 工具定义

```yaml
# apps/api/skills/synastry/tools/tools.yaml
version: "1.0"
skill_id: synastry

collect:
  - name: collect_synastry_info
    description: |
      收集合盘对象的出生信息。
      当用户想要查看合盘但未指定对方信息时调用此工具。
    card_type: collect_synastry_info
    parameters:
      - name: relationship_type
        type: string
        enum: [romantic, spouse, parent_child, sibling, business, friend]
        required: true
        description: 关系类型
      - name: person_name
        type: string
        required: true
        description: 对方姓名或昵称
      - name: birth_date
        type: string
        format: date
        required: true
        description: 出生日期 (YYYY-MM-DD)
      - name: birth_time
        type: string
        format: time
        required: false
        description: 出生时间 (HH:MM)，不填则默认正午
      - name: birth_place
        type: string
        required: true
        description: 出生地点（城市名）
      - name: notes
        type: string
        required: false
        description: 备注信息

  - name: select_relationship
    description: |
      展示已保存的关系对象列表，让用户选择。
      当用户已保存过关系对象时优先调用此工具。
    card_type: select_relationship
    parameters:
      - name: relationships
        type: array
        required: true
        description: 关系对象列表（从 Profile 读取）

compute:
  - name: calculate_synastry
    description: |
      计算两人的合盘分析。
      会根据用户已订阅的 Skill 自动计算对应维度。
    parameters:
      - name: person2_birth_info
        type: object
        required: true
        description: 对方的出生信息
        properties:
          date: { type: string, format: date }
          time: { type: string, format: time }
          place: { type: string }
      - name: relationship_type
        type: string
        enum: [romantic, spouse, parent_child, sibling, business, friend]
        required: true
      - name: relationship_id
        type: string
        required: false
        description: 已保存的关系对象 ID（如果是从已保存对象发起）

display:
  - name: show_synastry_overview
    description: 展示合盘总览卡片
    card_type: synastry_overview
    parameters:
      - name: overview_data
        type: object
        required: true

  - name: show_zodiac_synastry
    description: 展示星座合盘详情
    card_type: zodiac_synastry
    parameters:
      - name: synastry_data
        type: object
        required: true

  - name: show_bazi_synastry
    description: 展示八字合婚详情
    card_type: bazi_synastry
    parameters:
      - name: synastry_data
        type: object
        required: true

  - name: show_jungastro_synastry
    description: 展示荣格关系分析
    card_type: jungastro_synastry
    parameters:
      - name: synastry_data
        type: object
        required: true

action:
  - name: save_relationship
    description: 保存关系对象到用户档案
    parameters:
      - name: name
        type: string
        required: true
      - name: relationship_type
        type: string
        required: true
      - name: birth_info
        type: object
        required: true
      - name: notes
        type: string
        required: false
```

---

## 5. 合盘计算引擎

### 5.1 SynastryEngine 设计

```python
# apps/api/skills/synastry/services/synastry_engine.py

from dataclasses import dataclass
from typing import Optional
from datetime import datetime

@dataclass
class SynastryDimensionResult:
    skill_id: str
    score: int
    summary: str
    data: dict

@dataclass
class SynastryResult:
    person1: dict
    person2: dict
    relationship_type: str
    overall_score: int
    dimensions: list[SynastryDimensionResult]
    calculated_at: datetime

class SynastryEngine:
    """
    轻度融合的合盘引擎

    设计原则：
    1. 各 Skill 独立计算，互不依赖
    2. 综合评分取加权平均
    3. AI 综合解读由 LLM 在对话中生成
    """

    def __init__(self):
        self.zodiac_calculator = ZodiacSynastryCalculator()
        self.bazi_calculator = BaziSynastryCalculator()
        self.jungastro_calculator = JungastroSynastryCalculator()

    async def calculate(
        self,
        user_profile: dict,
        partner_birth_info: dict,
        relationship_type: str,
        subscribed_skills: list[str]
    ) -> SynastryResult:
        """
        计算合盘

        Args:
            user_profile: 用户完整 Profile（包含 skills 数据）
            partner_birth_info: 对方出生信息
            relationship_type: 关系类型
            subscribed_skills: 用户已订阅的 Skill 列表

        Returns:
            SynastryResult: 完整合盘结果
        """
        dimensions = []
        total_score = 0
        skill_count = 0

        # 1. 星座合盘
        if "zodiac" in subscribed_skills:
            user_zodiac = user_profile.get("skills", {}).get("zodiac", {})
            if user_zodiac.get("chart"):
                result = await self._calc_zodiac_synastry(
                    user_zodiac["chart"],
                    partner_birth_info,
                    relationship_type
                )
                dimensions.append(result)
                total_score += result.score
                skill_count += 1

        # 2. 八字合婚
        if "bazi" in subscribed_skills:
            user_bazi = user_profile.get("skills", {}).get("bazi", {})
            if user_bazi.get("chart"):
                result = await self._calc_bazi_synastry(
                    user_bazi["chart"],
                    partner_birth_info,
                    relationship_type
                )
                dimensions.append(result)
                total_score += result.score
                skill_count += 1

        # 3. 荣格关系分析
        if "jungastro" in subscribed_skills:
            user_jungastro = user_profile.get("skills", {}).get("jungastro", {})
            if user_jungastro:
                result = await self._calc_jungastro_synastry(
                    user_jungastro,
                    partner_birth_info,
                    relationship_type
                )
                dimensions.append(result)
                total_score += result.score
                skill_count += 1

        # 4. 计算综合评分
        overall_score = round(total_score / skill_count) if skill_count > 0 else 0

        return SynastryResult(
            person1=self._extract_person_summary(user_profile),
            person2={"name": "TA", "birth_info": partner_birth_info},
            relationship_type=relationship_type,
            overall_score=overall_score,
            dimensions=dimensions,
            calculated_at=datetime.utcnow()
        )

    async def _calc_zodiac_synastry(
        self,
        user_chart: dict,
        partner_birth_info: dict,
        relationship_type: str
    ) -> SynastryDimensionResult:
        """计算星座合盘"""
        # 1. 计算对方星盘
        partner_chart = await self.zodiac_calculator.calculate_chart(partner_birth_info)

        # 2. 计算合盘相位
        synastry_data = await self.zodiac_calculator.calculate_synastry(
            user_chart, partner_chart, relationship_type
        )

        return SynastryDimensionResult(
            skill_id="zodiac",
            score=synastry_data["compatibility"]["overall"],
            summary=synastry_data.get("summary", "星盘相位分析完成"),
            data=synastry_data
        )

    async def _calc_bazi_synastry(
        self,
        user_chart: dict,
        partner_birth_info: dict,
        relationship_type: str
    ) -> SynastryDimensionResult:
        """计算八字合婚"""
        # 1. 计算对方八字
        partner_chart = await self.bazi_calculator.calculate_chart(partner_birth_info)

        # 2. 计算合婚
        synastry_data = await self.bazi_calculator.calculate_synastry(
            user_chart, partner_chart, relationship_type
        )

        return SynastryDimensionResult(
            skill_id="bazi",
            score=synastry_data["compatibility"]["overall"],
            summary=synastry_data.get("summary", "八字合婚分析完成"),
            data=synastry_data
        )

    async def _calc_jungastro_synastry(
        self,
        user_jungastro: dict,
        partner_birth_info: dict,
        relationship_type: str
    ) -> SynastryDimensionResult:
        """计算荣格关系分析"""
        # 基于用户的心理画像和对方星盘推导关系动力
        synastry_data = await self.jungastro_calculator.analyze_relationship(
            user_jungastro, partner_birth_info, relationship_type
        )

        return SynastryDimensionResult(
            skill_id="jungastro",
            score=synastry_data.get("harmony_score", 70),
            summary=synastry_data.get("summary", "荣格关系分析完成"),
            data=synastry_data
        )

    def _extract_person_summary(self, profile: dict) -> dict:
        """提取用户摘要信息"""
        identity = profile.get("identity", {})
        return {
            "name": profile.get("account", {}).get("display_name", "你"),
            "birth_info": identity.get("birth_info", {})
        }
```

### 5.2 各 Skill 合盘计算器

#### 5.2.1 星座合盘计算器（复用现有）

```python
# apps/api/skills/zodiac/services/synastry.py
# 已有实现，复用

class ZodiacSynastryCalculator:
    async def calculate_synastry(self, chart1, chart2, relationship_type):
        """
        计算两个星盘的合盘相位

        Returns:
            {
                "person1": { "sunSign", "moonSign", "risingSign", ... },
                "person2": { "sunSign", "moonSign", "risingSign", ... },
                "aspects": [
                    { "planet1", "planet2", "type", "orb", "isHarmonious" }
                ],
                "compatibility": {
                    "overall": 75,
                    "emotional": 80,
                    "communication": 70,
                    "passion": 85,
                    "stability": 65
                },
                "strengths": [...],
                "challenges": [...],
                "summary": "..."
            }
        """
```

#### 5.2.2 八字合婚计算器（新增）

```python
# apps/api/skills/bazi/services/synastry.py

class BaziSynastryCalculator:
    """
    八字合婚计算器

    主要分析维度：
    1. 日主相合：日干之间的生克关系
    2. 五行互补：两人五行的平衡与互补
    3. 十神互动：食神、财星、官杀等的互动
    4. 神煞配对：桃花、红鸾、天喜等婚姻相关神煞
    """

    async def calculate_synastry(
        self,
        chart1: dict,
        chart2: dict,
        relationship_type: str
    ) -> dict:
        """
        计算八字合婚

        Args:
            chart1: 用户八字命盘
            chart2: 对方八字命盘
            relationship_type: 关系类型

        Returns:
            {
                "person1": { "dayMaster", "fourPillars", ... },
                "person2": { "dayMaster", "fourPillars", ... },
                "compatibility": {
                    "overall": 78,
                    "dayMasterHarmony": 85,     # 日主相合
                    "fiveElementBalance": 72,   # 五行互补
                    "tenGodInteraction": 80,    # 十神互动
                    "specialStars": 75          # 神煞配对
                },
                "analysis": {
                    "dayMasterRelation": "相生",  # 相生/相克/比肩/...
                    "complementaryElements": ["水", "木"],
                    "conflictElements": ["火"],
                    "strengths": ["日主甲木与日主癸水相生，感情和谐", ...],
                    "challenges": ["双方火旺，需注意情绪管理", ...],
                    "advice": ["适合在春季举办重要活动", ...]
                },
                "summary": "从八字来看，两人日主相生，是较为和谐的组合..."
            }
        """

        # 1. 提取日主
        dm1 = chart1["day_master"]
        dm2 = chart2["day_master"]

        # 2. 计算日主关系
        dm_relation = self._calc_day_master_relation(dm1, dm2)
        dm_score = self._score_day_master_relation(dm_relation, relationship_type)

        # 3. 计算五行互补
        elements1 = chart1["five_elements"]
        elements2 = chart2["five_elements"]
        element_analysis = self._calc_element_complement(elements1, elements2)
        element_score = element_analysis["score"]

        # 4. 计算十神互动
        ten_gods1 = chart1["ten_gods"]
        ten_gods2 = chart2["ten_gods"]
        ten_god_analysis = self._calc_ten_god_interaction(ten_gods1, ten_gods2, relationship_type)
        ten_god_score = ten_god_analysis["score"]

        # 5. 计算神煞配对（婚姻相关）
        special_stars_score = self._calc_special_stars(chart1, chart2, relationship_type)

        # 6. 综合评分
        overall_score = self._weighted_average([
            (dm_score, 0.3),
            (element_score, 0.25),
            (ten_god_score, 0.25),
            (special_stars_score, 0.2)
        ])

        return {
            "person1": self._extract_chart_summary(chart1),
            "person2": self._extract_chart_summary(chart2),
            "compatibility": {
                "overall": overall_score,
                "dayMasterHarmony": dm_score,
                "fiveElementBalance": element_score,
                "tenGodInteraction": ten_god_score,
                "specialStars": special_stars_score
            },
            "analysis": {
                "dayMasterRelation": dm_relation,
                "complementaryElements": element_analysis["complementary"],
                "conflictElements": element_analysis["conflict"],
                "strengths": self._generate_strengths(dm_relation, element_analysis, ten_god_analysis),
                "challenges": self._generate_challenges(dm_relation, element_analysis, ten_god_analysis),
                "advice": self._generate_advice(relationship_type, overall_score)
            },
            "summary": self._generate_summary(dm_relation, overall_score, relationship_type)
        }
```

#### 5.2.3 荣格关系分析器（扩展）

```python
# apps/api/skills/jungastro/services/synastry.py

class JungastroSynastryCalculator:
    """
    荣格关系分析器

    基于双方的心理画像分析关系动力
    """

    async def analyze_relationship(
        self,
        user_jungastro: dict,
        partner_birth_info: dict,
        relationship_type: str
    ) -> dict:
        """
        分析两人的关系动力

        Returns:
            {
                "attachmentDynamics": {
                    "person1Style": "secure",
                    "person2Style": "anxious",
                    "interaction": "安全型与焦虑型的组合..."
                },
                "shadowInterplay": {
                    "person1Projects": [...],
                    "person2Projects": [...],
                    "growthOpportunities": [...]
                },
                "animaAnimusMatch": {
                    "compatibility": "high",
                    "description": "..."
                },
                "relationshipPatterns": [...],
                "harmony_score": 72,
                "summary": "..."
            }
        """
```

---

## 6. 前端卡片设计

### 6.1 CollectSynastryInfoCard

```typescript
// apps/web/src/skills/synastry/cards/CollectSynastryInfoCard.tsx

interface CollectSynastryInfoCardProps {
  onSubmit: (data: SynastryInfoInput) => void;
  onSkip?: () => void;
}

interface SynastryInfoInput {
  personName: string;
  relationshipType: RelationshipType;
  birthDate: string;
  birthTime?: string;
  birthPlace: string;
  notes?: string;
}

// UI 设计要点：
// 1. 关系类型使用 Chip 选择，带 icon
// 2. 日期选择器，支持公历/农历切换
// 3. 时间选择器，有"不确定"选项
// 4. 地点使用城市搜索
// 5. 底部有"保存此人"checkbox
```

### 6.2 SelectRelationshipCard

```typescript
// apps/web/src/skills/synastry/cards/SelectRelationshipCard.tsx

interface SelectRelationshipCardProps {
  relationships: Relationship[];
  onSelect: (relationship: Relationship) => void;
  onAddNew: () => void;
}

// UI 设计要点：
// 1. 列表展示已保存的关系对象
// 2. 每行显示：头像占位 + 姓名 + 关系类型 + 最后合盘时间
// 3. 底部有"添加新的"按钮
// 4. 支持删除/编辑操作
```

### 6.3 SynastryOverviewCard

```typescript
// apps/web/src/skills/synastry/cards/SynastryOverviewCard.tsx

interface SynastryOverviewData {
  person1: { name: string; avatar?: string };
  person2: { name: string; avatar?: string };
  relationshipType: RelationshipType;
  overallScore: number;
  dimensions: Array<{
    skill: 'zodiac' | 'bazi' | 'jungastro';
    name: string;
    icon: string;
    score: number;
    summary: string;
  }>;
}

// UI 设计要点：
// 1. 顶部：两人头像 + 姓名，中间爱心/关系 icon
// 2. 综合评分：大数字 + 评价文案（如"较为和谐"）
// 3. 各维度评分：进度条 + 分数 + 一句话总结
// 4. 点击维度可展开详情或跳转到对应卡片
```

### 6.4 BaziSynastryCard（新增）

```typescript
// apps/web/src/skills/synastry/cards/BaziSynastryCard.tsx

interface BaziSynastryData {
  person1: {
    name: string;
    dayMaster: { stem: string; element: string };
    fourPillars: FourPillars;
  };
  person2: {
    name: string;
    dayMaster: { stem: string; element: string };
    fourPillars: FourPillars;
  };
  compatibility: {
    overall: number;
    dayMasterHarmony: number;
    fiveElementBalance: number;
    tenGodInteraction: number;
    specialStars: number;
  };
  analysis: {
    dayMasterRelation: string;
    strengths: string[];
    challenges: string[];
    advice: string[];
  };
  summary: string;
}

// UI 设计要点：
// 1. 双人四柱对比展示
// 2. 日主关系图示（相生/相克/比肩等）
// 3. 四维评分雷达图或进度条
// 4. 优势/挑战/建议列表
// 5. 配色使用八字 Skill 的视觉风格
```

---

## 7. Skill 配置

### 7.1 SKILL.md

```markdown
# apps/api/skills/synastry/SKILL.md

---
skill_id: synastry
name: 关系合盘
category: professional
price_tier: premium
version: "1.0"
---

## 专家身份

你是一位跨文化关系分析专家，精通西方占星、东方命理和荣格心理学。
你能够从多个维度分析两人之间的关系动力，提供深入的洞察和建议。

## 触发词

- 合盘
- 配对
- 和TA合不合
- 缘分
- 关系分析
- 八字合婚
- 星座配对

## 配置

requires_birth_info: true
requires_partner_birth_info: true
requires_compute: true

## 全局工具

- show_card
- save_birth_info

## 依赖 Skill

# 至少需要订阅以下一个 Skill 才能使用对应维度的合盘
optional_dependencies:
  - zodiac    # 星座合盘
  - bazi      # 八字合婚
  - jungastro # 荣格关系

## 工作流

### Phase 1: 收集对方信息

1. 检查用户是否已保存关系对象
   - 有：调用 select_relationship 展示选择
   - 无：调用 collect_synastry_info 收集信息

### Phase 2: 计算合盘

1. 调用 calculate_synastry 计算合盘
2. 根据用户订阅的 Skill 展示对应维度卡片

### Phase 3: 综合解读

1. 展示 SynastryOverviewCard（总览）
2. 展示各维度详情卡片
3. 提供 AI 综合解读和建议
```

---

## 8. 订阅与付费

### 8.1 订阅策略

| 用户等级 | 合盘功能 |
|---------|---------|
| 免费用户 | 3 次试用机会，展示简化结果（只有总分，无详情） |
| synastry 订阅 | 解锁完整合盘功能 |
| 需额外订阅对应 Skill | 才能看到该维度详情 |

**示例**：
- 用户订阅了 synastry + zodiac → 可以看总览 + 星座合盘详情
- 用户订阅了 synastry + zodiac + bazi → 可以看总览 + 星座合盘 + 八字合婚详情
- 用户只订阅了 synastry → 只能看简化总览

### 8.2 定价建议

```yaml
synastry:
  price_tier: premium
  monthly_price: 29.9
  yearly_price: 199

# 合盘 + 全 Skill 套餐
all_in_one:
  includes: [synastry, zodiac, bazi, jungastro]
  monthly_price: 59.9
  yearly_price: 399
```

---

## 9. 实现计划

### Phase 1: MVP (2 周)

| 任务 | 说明 | 优先级 |
|------|------|--------|
| 数据层扩展 | VibeProfile 新增 relationships 字段 | P0 |
| UnifiedProfileRepository | 添加关系对象 CRUD 方法 | P0 |
| Synastry Skill | SKILL.md + tools.yaml + handlers.py | P0 |
| CollectSynastryInfoCard | 收集对方信息表单 | P0 |
| SynastryEngine 基础框架 | 调用现有 zodiac synastry | P0 |
| SynastryOverviewCard | 合盘总览卡片 | P0 |
| 复用 ZodiacSynastryCard | 星座合盘详情 | P0 |

### Phase 2: 八字合婚 (1 周)

| 任务 | 说明 | 优先级 |
|------|------|--------|
| BaziSynastryCalculator | 八字合婚算法 | P1 |
| BaziSynastryCard | 八字合婚卡片 | P1 |

### Phase 3: 荣格关系 (1 周)

| 任务 | 说明 | 优先级 |
|------|------|--------|
| JungastroSynastryCalculator | 荣格关系分析 | P1 |
| JungastroSynastryCard | 荣格关系卡片（或复用） | P1 |

### Phase 4: 增强功能 (后期)

| 任务 | 说明 | 优先级 |
|------|------|--------|
| SelectRelationshipCard | 选择已保存对象 | P2 |
| 邀请注册功能 | 对方注册后关联 | P2 |
| 关系发展追踪 | 时间线、阶段变化 | P3 |

---

## 10. 关键文件清单

| 类型 | 文件路径 | 操作 |
|------|---------|------|
| **数据层** | | |
| Repository | `apps/api/stores/unified_profile_repo.py` | 修改 |
| **后端 Skill** | | |
| Skill 配置 | `apps/api/skills/synastry/SKILL.md` | 新增 |
| 工具定义 | `apps/api/skills/synastry/tools/tools.yaml` | 新增 |
| 工具执行器 | `apps/api/skills/synastry/tools/handlers.py` | 新增 |
| 合盘引擎 | `apps/api/skills/synastry/services/synastry_engine.py` | 新增 |
| 规则文件 | `apps/api/skills/synastry/rules/synastry-analysis.md` | 新增 |
| **八字扩展** | | |
| 八字合婚 | `apps/api/skills/bazi/services/synastry.py` | 新增 |
| **前端卡片** | | |
| 收集表单 | `apps/web/src/skills/synastry/cards/CollectSynastryInfoCard.tsx` | 新增 |
| 选择对象 | `apps/web/src/skills/synastry/cards/SelectRelationshipCard.tsx` | 新增 |
| 合盘总览 | `apps/web/src/skills/synastry/cards/SynastryOverviewCard.tsx` | 新增 |
| 八字合婚 | `apps/web/src/skills/synastry/cards/BaziSynastryCard.tsx` | 新增 |
| 卡片注册 | `apps/web/src/skills/initCards.ts` | 修改 |
| 卡片入口 | `apps/web/src/skills/synastry/cards/index.ts` | 新增 |

---

## 11. 验证计划

### 11.1 单元测试

```python
# tests/skills/synastry/test_synastry_engine.py

class TestSynastryEngine:
    def test_calc_zodiac_synastry(self):
        """测试星座合盘计算"""

    def test_calc_bazi_synastry(self):
        """测试八字合婚计算"""

    def test_overall_score_calculation(self):
        """测试综合评分计算"""

    def test_empty_subscriptions(self):
        """测试无订阅时的处理"""
```

### 11.2 集成测试

```python
# tests/integration/test_synastry_flow.py

class TestSynastryFlow:
    async def test_full_synastry_flow(self):
        """完整合盘流程：收集 → 计算 → 展示"""

    async def test_save_relationship(self):
        """保存关系对象"""

    async def test_select_existing_relationship(self):
        """选择已保存对象"""
```

### 11.3 端到端测试（Playwright）

```typescript
// tests/e2e/synastry.spec.ts

test('用户完成合盘流程', async ({ page }) => {
  // 1. 发送"想看和TA的合盘"
  // 2. 填写对方信息表单
  // 3. 验证展示合盘结果卡片
});

test('用户选择已保存的关系对象', async ({ page }) => {
  // 1. 发送合盘请求
  // 2. 选择已保存对象
  // 3. 验证跳过收集步骤
});
```

---

## 12. 未解决问题

| 问题 | 说明 | 解决方案建议 |
|------|------|-------------|
| 八字合婚算法 | 是否有现成算法库？ | 调研 lunar-python 等库，或自研 |
| 荣格关系推导 | 如何从单人画像推导两人动力？ | 基于依附理论 + 投射理论建模 |
| 评分权重分配 | 各维度权重如何确定？ | 初期均等，后期根据用户反馈调整 |
| 隐私声明 | 存储他人信息的合规性 | 在收集时添加隐私提示 |
| 农历支持 | 八字需要农历，表单是否支持？ | 前端添加公历/农历切换 |

---

## 13. 产品亮点总结

| 亮点 | 说明 |
|------|------|
| **跨维度融合** | 业界首个融合东西方命理的合盘系统 |
| **多关系场景** | 不只是恋爱，还有亲子、合伙人、朋友 |
| **关系管理** | 保存重要的人，随时查看合盘 |
| **AI 综合解读** | 不只是分数，还有 AI 的深度解读和建议 |
| **隐私友好** | 无需对方注册，保护双方隐私 |
| **渐进式付费** | 基础功能门槛低，深度分析按需付费 |

---

## 附录 A: UI 原型草图

### A.1 CollectSynastryInfoCard

```
┌────────────────────────────────────────────┐
│ 💕 添加合盘对象                             │
├────────────────────────────────────────────┤
│                                            │
│  TA 是你的？                               │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐              │
│  │💕  │ │💍  │ │👨‍👧 │ │🤝  │ ...          │
│  │恋人│ │伴侣│ │亲子│ │合伙│              │
│  └────┘ └────┘ └────┘ └────┘              │
│                                            │
│  TA 的名字                                 │
│  ┌────────────────────────────────────┐   │
│  │ 小明                                │   │
│  └────────────────────────────────────┘   │
│                                            │
│  TA 的生日                                 │
│  ┌────────────────────────────────────┐   │
│  │ 1990-05-15              📅 公历 ▼  │   │
│  └────────────────────────────────────┘   │
│                                            │
│  TA 的出生时间（可选）                      │
│  ┌────────────────────────────────────┐   │
│  │ 14:30                   不确定 □   │   │
│  └────────────────────────────────────┘   │
│                                            │
│  TA 的出生地点                             │
│  ┌────────────────────────────────────┐   │
│  │ 上海 🔍                             │   │
│  └────────────────────────────────────┘   │
│                                            │
│  ☑ 保存 TA 的信息，方便下次查看合盘        │
│                                            │
│        ┌────────────────────┐             │
│        │    开始合盘分析     │             │
│        └────────────────────┘             │
└────────────────────────────────────────────┘
```

### A.2 SynastryOverviewCard

```
┌────────────────────────────────────────────┐
│              💕 你们的合盘                  │
├────────────────────────────────────────────┤
│                                            │
│    ┌───┐          💫          ┌───┐       │
│    │ 你 │    ←─────────────→   │ TA │       │
│    │   │                      │   │       │
│    └───┘                      └───┘       │
│   天蝎座                      双鱼座       │
│                                            │
│        综合契合度                          │
│     ╔══════════════════╗                  │
│     ║      78%        ║                  │
│     ║   "较为和谐"     ║                  │
│     ╚══════════════════╝                  │
│                                            │
│  各维度评分                                │
│  ───────────────────────                   │
│  ♈ 星座   ████████░░  82%  相位和谐       │
│  ☯ 八字   ███████░░░  72%  日主相生       │
│  🧠 荣格   ████████░░  80%  互补成长       │
│                                            │
│  💡 点击各维度查看详细分析                  │
└────────────────────────────────────────────┘
```

---

## 附录 B: 参考资料

1. 现有实现
   - `ZodiacSynastryCard.tsx` - 星座合盘卡片
   - `JungastroRelationshipDynamicsCard.tsx` - 荣格关系动力

2. 依附理论参考
   - Bowlby 依附理论
   - 安全型/焦虑型/回避型/混乱型

3. 八字合婚参考
   - 日主生克关系
   - 五行互补理论
   - 神煞配对（桃花、红鸾、天喜等）
