/**
 * CollectSynastryInfoCard - æ”¶é›†åˆç›˜å¯¹è±¡ä¿¡æ¯
 *
 * æ”¶é›†å¯¹æ–¹çš„å‡ºç”Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
 * - å…³ç³»ç±»å‹ï¼ˆå¿…å¡«ï¼‰
 * - å§“å/æ˜µç§°ï¼ˆå¿…å¡«ï¼‰
 * - å‡ºç”Ÿæ—¥æœŸï¼ˆå¿…å¡«ï¼‰
 * - å‡ºç”Ÿæ—¶é—´ï¼ˆå¯é€‰ï¼‰
 * - å‡ºç”Ÿåœ°ç‚¹ï¼ˆå¿…å¡«ï¼‰
 * - æ˜¯å¦ä¿å­˜ï¼ˆå¯é€‰ï¼‰
 */

"use client";

import { memo, useState, useCallback } from "react";
import { registerCard } from "@/skills/CardRegistry";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface RelationshipOption {
  value: string;
  label: string;
  icon: string;
}

interface CollectSynastryInfoCardProps {
  title?: string;
  onSubmit?: (data: SynastryInfoData) => void;
}

interface SynastryInfoData {
  relationship_type: string;
  person_name: string;
  birth_date: string;
  birth_time?: string;
  birth_place: string;
  save_relationship: boolean;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const RELATIONSHIP_OPTIONS: RelationshipOption[] = [
  { value: "romantic", label: "æ‹äºº", icon: "ğŸ’•" },
  { value: "spouse", label: "ä¼´ä¾£", icon: "ğŸ’" },
  { value: "parent_child", label: "äº²å­", icon: "ğŸ‘¨â€ğŸ‘§" },
  { value: "sibling", label: "å…„å¼Ÿå§å¦¹", icon: "ğŸ‘«" },
  { value: "business", label: "åˆä¼™äºº", icon: "ğŸ¤" },
  { value: "friend", label: "æœ‹å‹", icon: "ğŸ‘¥" },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sub-components
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const RelationshipTypeSelector = memo(function RelationshipTypeSelector({
  value,
  onChange,
}: {
  value: string;
  onChange: (value: string) => void;
}) {
  return (
    <div className="mb-4">
      <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
        TA æ˜¯ä½ çš„...
      </label>
      <div className="grid grid-cols-3 gap-2">
        {RELATIONSHIP_OPTIONS.map((option) => (
          <button
            key={option.value}
            type="button"
            onClick={() => onChange(option.value)}
            className={`flex flex-col items-center justify-center p-3 rounded-xl border-2 transition-all ${
              value === option.value
                ? "border-pink-500 bg-pink-50 dark:bg-pink-900/20"
                : "border-slate-200 dark:border-slate-700 hover:border-pink-300"
            }`}
          >
            <span className="text-2xl mb-1">{option.icon}</span>
            <span className="text-xs text-slate-600 dark:text-slate-400">
              {option.label}
            </span>
          </button>
        ))}
      </div>
    </div>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Main Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function CollectSynastryInfoCard({
  title = "å‘Šè¯‰æˆ‘ TA çš„ä¿¡æ¯",
  onSubmit,
}: CollectSynastryInfoCardProps) {
  const [formData, setFormData] = useState<SynastryInfoData>({
    relationship_type: "",
    person_name: "",
    birth_date: "",
    birth_time: "",
    birth_place: "",
    save_relationship: true,
  });

  const [errors, setErrors] = useState<Record<string, string>>({});

  const handleChange = useCallback(
    (field: keyof SynastryInfoData, value: string | boolean) => {
      setFormData((prev) => ({ ...prev, [field]: value }));
      // Clear error when field is modified
      if (errors[field]) {
        setErrors((prev) => {
          const next = { ...prev };
          delete next[field];
          return next;
        });
      }
    },
    [errors]
  );

  const validate = useCallback((): boolean => {
    const newErrors: Record<string, string> = {};

    if (!formData.relationship_type) {
      newErrors.relationship_type = "è¯·é€‰æ‹©å…³ç³»ç±»å‹";
    }
    if (!formData.person_name.trim()) {
      newErrors.person_name = "è¯·è¾“å…¥å§“å";
    }
    if (!formData.birth_date) {
      newErrors.birth_date = "è¯·é€‰æ‹©å‡ºç”Ÿæ—¥æœŸ";
    }
    if (!formData.birth_place.trim()) {
      newErrors.birth_place = "è¯·è¾“å…¥å‡ºç”Ÿåœ°ç‚¹";
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [formData]);

  const handleSubmit = useCallback(
    (e: React.FormEvent) => {
      e.preventDefault();

      if (!validate()) {
        return;
      }

      if (onSubmit) {
        onSubmit(formData);
      }
    },
    [formData, onSubmit, validate]
  );

  return (
    <div className="collect-synastry-card bg-gradient-to-br from-pink-50 to-purple-50 dark:from-pink-950/30 dark:to-purple-950/30 rounded-xl border border-pink-200 dark:border-pink-800 p-5 my-2 animate-fade-in">
      {/* Header */}
      <div className="flex items-center gap-3 mb-5">
        <div className="w-10 h-10 rounded-xl bg-pink-500/20 flex items-center justify-center">
          <span className="text-xl">ğŸ’•</span>
        </div>
        <h3 className="text-lg font-semibold text-pink-900 dark:text-pink-100">
          {title}
        </h3>
      </div>

      <form onSubmit={handleSubmit}>
        {/* Relationship Type */}
        <RelationshipTypeSelector
          value={formData.relationship_type}
          onChange={(value) => handleChange("relationship_type", value)}
        />
        {errors.relationship_type && (
          <p className="text-red-500 text-xs mt-1 -mt-2 mb-3">
            {errors.relationship_type}
          </p>
        )}

        {/* Name */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
            TA å«ä»€ä¹ˆï¼Ÿ
          </label>
          <input
            type="text"
            value={formData.person_name}
            onChange={(e) => handleChange("person_name", e.target.value)}
            placeholder="å§“åæˆ–æ˜µç§°"
            className={`w-full px-4 py-2.5 rounded-lg border bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-pink-500 ${
              errors.person_name
                ? "border-red-500"
                : "border-slate-200 dark:border-slate-700"
            }`}
          />
          {errors.person_name && (
            <p className="text-red-500 text-xs mt-1">{errors.person_name}</p>
          )}
        </div>

        {/* Birth Date */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
            TA ä»€ä¹ˆæ—¶å€™å‡ºç”Ÿï¼Ÿ
          </label>
          <input
            type="date"
            value={formData.birth_date}
            onChange={(e) => handleChange("birth_date", e.target.value)}
            className={`w-full px-4 py-2.5 rounded-lg border bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-pink-500 ${
              errors.birth_date
                ? "border-red-500"
                : "border-slate-200 dark:border-slate-700"
            }`}
          />
          {errors.birth_date && (
            <p className="text-red-500 text-xs mt-1">{errors.birth_date}</p>
          )}
        </div>

        {/* Birth Time (Optional) */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
            å‡ºç”Ÿæ—¶é—´{" "}
            <span className="text-slate-400 font-normal">ï¼ˆå¯é€‰ï¼‰</span>
          </label>
          <input
            type="time"
            value={formData.birth_time}
            onChange={(e) => handleChange("birth_time", e.target.value)}
            placeholder="ä¸ç¡®å®šå¯ä»¥ä¸å¡«"
            className="w-full px-4 py-2.5 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 focus:outline-none focus:ring-2 focus:ring-pink-500"
          />
          <p className="text-slate-400 text-xs mt-1">
            ä¸ç¡®å®šå¯ä»¥ä¸å¡«ï¼Œç³»ç»Ÿä¼šä½¿ç”¨æ­£åˆæ—¶é—´
          </p>
        </div>

        {/* Birth Place */}
        <div className="mb-4">
          <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
            TA åœ¨å“ªé‡Œå‡ºç”Ÿï¼Ÿ
          </label>
          <input
            type="text"
            value={formData.birth_place}
            onChange={(e) => handleChange("birth_place", e.target.value)}
            placeholder="æœç´¢åŸå¸‚..."
            className={`w-full px-4 py-2.5 rounded-lg border bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-pink-500 ${
              errors.birth_place
                ? "border-red-500"
                : "border-slate-200 dark:border-slate-700"
            }`}
          />
          {errors.birth_place && (
            <p className="text-red-500 text-xs mt-1">{errors.birth_place}</p>
          )}
        </div>

        {/* Save Checkbox */}
        <div className="mb-5">
          <label className="flex items-center gap-2 cursor-pointer">
            <input
              type="checkbox"
              checked={formData.save_relationship}
              onChange={(e) =>
                handleChange("save_relationship", e.target.checked)
              }
              className="w-4 h-4 rounded border-slate-300 text-pink-500 focus:ring-pink-500"
            />
            <span className="text-sm text-slate-600 dark:text-slate-400">
              ä¿å­˜ TAï¼Œæ–¹ä¾¿ä¸‹æ¬¡æŸ¥çœ‹
            </span>
          </label>
        </div>

        {/* Submit Button */}
        <button
          type="submit"
          className="w-full py-3 px-4 bg-gradient-to-r from-pink-500 to-purple-500 text-white font-medium rounded-xl hover:from-pink-600 hover:to-purple-600 transition-all shadow-lg shadow-pink-500/25"
        >
          å¼€å§‹åˆ†æ
        </button>
      </form>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("collect_synastry_info", CollectSynastryInfoCard);

export default CollectSynastryInfoCard;
