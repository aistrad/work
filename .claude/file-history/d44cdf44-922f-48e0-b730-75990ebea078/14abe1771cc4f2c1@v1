"""
Synastry Skill å·¥å…·æ‰§è¡Œå™¨

å®ç°åˆç›˜åŠŸèƒ½çš„æ ¸å¿ƒå·¥å…·ï¼š
- collect_synastry_info: æ”¶é›†å¯¹æ–¹ä¿¡æ¯
- select_relationship: é€‰æ‹©å·²ä¿å­˜çš„å…³ç³»å¯¹è±¡
- calculate_synastry: è®¡ç®—åˆç›˜
- show_synastry_overview: å±•ç¤ºåˆç›˜æ€»è§ˆ
- save_relationship: ä¿å­˜å…³ç³»å¯¹è±¡
- save_synastry_insight: ä¿å­˜åˆç›˜æ´å¯Ÿ
"""

import logging
from typing import Dict, Any
from datetime import datetime, timezone

from services.tool_registry import tool_handler, ToolContext, ToolRegistry
from stores.unified_profile_repo import UnifiedProfileRepository

logger = logging.getLogger(__name__)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Collect Tools
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@tool_handler("collect_synastry_info")
async def execute_collect_synastry_info(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    æ”¶é›†åˆç›˜å¯¹è±¡çš„å‡ºç”Ÿä¿¡æ¯

    å±•ç¤º CollectSynastryInfoCard è¡¨å•
    """
    return await ToolRegistry.execute("show_card", {
        "cardType": "collect_synastry_info",
        "title": "å‘Šè¯‰æˆ‘ TA çš„ä¿¡æ¯",
        "fields": [
            {
                "name": "relationship_type",
                "type": "select",
                "label": "TA æ˜¯ä½ çš„...",
                "required": True,
                "options": [
                    {"value": "romantic", "label": "æ‹äºº/çº¦ä¼šå¯¹è±¡", "icon": "ğŸ’•"},
                    {"value": "spouse", "label": "é…å¶/ä¼´ä¾£", "icon": "ğŸ’"},
                    {"value": "parent_child", "label": "äº²å­", "icon": "ğŸ‘¨â€ğŸ‘§"},
                    {"value": "sibling", "label": "å…„å¼Ÿå§å¦¹", "icon": "ğŸ‘«"},
                    {"value": "business", "label": "åˆä¼™äºº/åŒäº‹", "icon": "ğŸ¤"},
                    {"value": "friend", "label": "æœ‹å‹", "icon": "ğŸ‘¥"},
                ]
            },
            {
                "name": "person_name",
                "type": "text",
                "label": "TA å«ä»€ä¹ˆï¼Ÿ",
                "placeholder": "å§“åæˆ–æ˜µç§°",
                "required": True
            },
            {
                "name": "birth_date",
                "type": "date",
                "label": "TA ä»€ä¹ˆæ—¶å€™å‡ºç”Ÿï¼Ÿ",
                "required": True
            },
            {
                "name": "birth_time",
                "type": "time",
                "label": "å‡ºç”Ÿæ—¶é—´ï¼ˆå¯é€‰ï¼‰",
                "required": False,
                "placeholder": "ä¸ç¡®å®šå¯ä»¥ä¸å¡«"
            },
            {
                "name": "birth_place",
                "type": "location",
                "label": "TA åœ¨å“ªé‡Œå‡ºç”Ÿï¼Ÿ",
                "placeholder": "æœç´¢åŸå¸‚...",
                "required": True
            },
            {
                "name": "save_relationship",
                "type": "checkbox",
                "label": "ä¿å­˜ TAï¼Œæ–¹ä¾¿ä¸‹æ¬¡æŸ¥çœ‹",
                "default": True
            }
        ],
        "submitLabel": "å¼€å§‹åˆ†æ"
    }, context)


@tool_handler("select_relationship")
async def execute_select_relationship(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    å±•ç¤ºå·²ä¿å­˜çš„å…³ç³»å¯¹è±¡åˆ—è¡¨

    è®©ç”¨æˆ·é€‰æ‹©å·²æœ‰å¯¹è±¡æˆ–æ·»åŠ æ–°çš„
    """
    # ä» Profile è·å–å…³ç³»åˆ—è¡¨
    user_id = context.user_id
    relationships = await UnifiedProfileRepository.get_relationships(user_id)

    # æ ¼å¼åŒ–å…³ç³»åˆ—è¡¨
    formatted_relationships = []
    for rel in relationships:
        formatted_relationships.append({
            "id": rel.get("id"),
            "name": rel.get("name"),
            "type": rel.get("relationship_type"),
            "typeLabel": _get_relationship_type_label(rel.get("relationship_type")),
            "typeIcon": _get_relationship_type_icon(rel.get("relationship_type")),
            "lastSynastryAt": rel.get("last_synastry_at"),
            "synastryCount": rel.get("synastry_count", 0)
        })

    return await ToolRegistry.execute("show_card", {
        "cardType": "select_relationship",
        "title": "ä½ æƒ³çœ‹å’Œè°çš„åˆç›˜ï¼Ÿ",
        "relationships": formatted_relationships,
        "allowAddNew": True,
        "addNewLabel": "æ·»åŠ æ–°çš„äºº"
    }, context)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Compute Tools
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@tool_handler("calculate_synastry")
async def execute_calculate_synastry(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    è®¡ç®—åˆç›˜åˆ†æ

    æ ¹æ®ç”¨æˆ·å·²è®¢é˜…çš„ Skill è‡ªåŠ¨è®¡ç®—å¯¹åº”ç»´åº¦
    """
    from skills.synastry.services.synastry_engine import SynastryEngine

    user_id = context.user_id
    profile = context.profile
    person2_birth_info = args.get("person2_birth_info", {})
    relationship_type = args.get("relationship_type", "romantic")
    relationship_id = args.get("relationship_id")
    person_name = args.get("person_name", "TA")

    # è·å–ç”¨æˆ·å·²è®¢é˜…çš„ Skill
    subscribed_skills = await UnifiedProfileRepository.get_subscribed_skill_ids(user_id)

    # è®¡ç®—åˆç›˜
    engine = SynastryEngine()
    result = await engine.calculate(
        user_profile=profile,
        partner_birth_info=person2_birth_info,
        relationship_type=relationship_type,
        subscribed_skills=subscribed_skills
    )

    # å¦‚æœæœ‰ relationship_idï¼Œè®°å½•åˆç›˜
    if relationship_id:
        await UnifiedProfileRepository.record_synastry(user_id, relationship_id)

    # æ„å»ºè¿”å›æ•°æ®
    return {
        "success": True,
        "result": {
            "person1": {
                "name": profile.get("account", {}).get("display_name", "ä½ "),
            },
            "person2": {
                "name": person_name,
                "birthInfo": person2_birth_info
            },
            "relationshipType": relationship_type,
            "overallScore": result.overall_score,
            "dimensions": [
                {
                    "skill": dim.skill_id,
                    "name": _get_skill_display_name(dim.skill_id),
                    "icon": _get_skill_icon(dim.skill_id),
                    "score": dim.score,
                    "summary": dim.summary,
                    "data": dim.data
                }
                for dim in result.dimensions
            ],
            "relationshipId": relationship_id
        },
        "_hint": {
            "action": "show_synastry_results",
            "message": "åˆç›˜è®¡ç®—å®Œæˆï¼Œè¯·å±•ç¤º SynastryOverviewCard å’Œå„ç»´åº¦è¯¦æƒ…å¡ç‰‡"
        }
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Display Tools
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@tool_handler("show_synastry_overview")
async def execute_show_synastry_overview(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    å±•ç¤ºåˆç›˜æ€»è§ˆå¡ç‰‡
    """
    return await ToolRegistry.execute("show_card", {
        "cardType": "synastry_overview",
        "person1": args.get("person1"),
        "person2": args.get("person2"),
        "relationshipType": args.get("relationship_type"),
        "overallScore": args.get("overall_score"),
        "overallLabel": _get_score_label(args.get("overall_score", 0)),
        "dimensions": args.get("dimensions", []),
        "strengths": args.get("strengths", []),
        "challenges": args.get("challenges", []),
        "advice": args.get("advice", [])
    }, context)


@tool_handler("show_zodiac_synastry")
async def execute_show_zodiac_synastry(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    å±•ç¤ºæ˜Ÿåº§åˆç›˜è¯¦æƒ…ï¼ˆå¤ç”¨ç°æœ‰å¡ç‰‡ï¼‰
    """
    return await ToolRegistry.execute("show_card", {
        "cardType": "zodiac_synastry",
        **args.get("synastry_data", {})
    }, context)


@tool_handler("show_bazi_synastry")
async def execute_show_bazi_synastry(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    å±•ç¤ºå…«å­—åˆå©šè¯¦æƒ…
    """
    return await ToolRegistry.execute("show_card", {
        "cardType": "bazi_synastry",
        **args.get("synastry_data", {})
    }, context)


@tool_handler("show_jungastro_synastry")
async def execute_show_jungastro_synastry(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    å±•ç¤ºè£æ ¼å…³ç³»åˆ†æï¼ˆå¤ç”¨ç°æœ‰å¡ç‰‡ï¼‰
    """
    return await ToolRegistry.execute("show_card", {
        "cardType": "jungastro_relationship",
        **args.get("synastry_data", {})
    }, context)


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Action Tools
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@tool_handler("save_relationship")
async def execute_save_relationship(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    ä¿å­˜å…³ç³»å¯¹è±¡åˆ°ç”¨æˆ·æ¡£æ¡ˆ
    """
    user_id = context.user_id

    relationship_data = {
        "name": args.get("name"),
        "relationship_type": args.get("relationship_type"),
        "birth_info": args.get("birth_info"),
        "notes": args.get("notes")
    }

    relationship_id = await UnifiedProfileRepository.add_relationship(
        user_id, relationship_data
    )

    return {
        "success": True,
        "relationshipId": relationship_id,
        "message": f"å·²ä¿å­˜ {args.get('name')} çš„ä¿¡æ¯"
    }


@tool_handler("save_synastry_insight")
async def execute_save_synastry_insight(
    args: Dict[str, Any],
    context: ToolContext
) -> Dict[str, Any]:
    """
    ä¿å­˜åˆç›˜æ´å¯Ÿåˆ° vibeRelationship
    """
    user_id = context.user_id
    relationship_id = args.get("relationship_id")
    insight = args.get("insight", {})
    is_primary = args.get("is_primary", False)

    # è·å–å…³ç³»å¯¹è±¡ä¿¡æ¯
    relationship = await UnifiedProfileRepository.get_relationship(user_id, relationship_id)
    if not relationship:
        return {"success": False, "error": "å…³ç³»å¯¹è±¡ä¸å­˜åœ¨"}

    # æ„å»ºæ´å¯Ÿæ•°æ®
    insight_data = {
        "personId": relationship_id,
        "name": relationship.get("name"),
        "type": relationship.get("relationship_type"),
        "overallHarmony": insight.get("overallScore"),
        "coreInsight": insight.get("coreInsight", ""),
        "strengths": insight.get("strengths", []),
        "growthAreas": insight.get("challenges", []),
    }

    # ä¿å­˜åˆ° vibeRelationship
    if is_primary:
        await UnifiedProfileRepository.update_primary_partner(user_id, insight_data)
    else:
        await UnifiedProfileRepository.add_key_relationship(user_id, insight_data)

    return {
        "success": True,
        "message": "åˆç›˜æ´å¯Ÿå·²ä¿å­˜"
    }


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Helper Functions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

def _get_relationship_type_label(rel_type: str) -> str:
    """è·å–å…³ç³»ç±»å‹çš„æ˜¾ç¤ºæ ‡ç­¾"""
    labels = {
        "romantic": "æ‹äºº",
        "spouse": "ä¼´ä¾£",
        "parent_child": "äº²å­",
        "sibling": "å…„å¼Ÿå§å¦¹",
        "business": "åˆä¼™äºº",
        "friend": "æœ‹å‹"
    }
    return labels.get(rel_type, rel_type)


def _get_relationship_type_icon(rel_type: str) -> str:
    """è·å–å…³ç³»ç±»å‹çš„å›¾æ ‡"""
    icons = {
        "romantic": "ğŸ’•",
        "spouse": "ğŸ’",
        "parent_child": "ğŸ‘¨â€ğŸ‘§",
        "sibling": "ğŸ‘«",
        "business": "ğŸ¤",
        "friend": "ğŸ‘¥"
    }
    return icons.get(rel_type, "ğŸ‘¤")


def _get_skill_display_name(skill_id: str) -> str:
    """è·å– Skill çš„æ˜¾ç¤ºåç§°"""
    names = {
        "zodiac": "æ˜Ÿåº§",
        "bazi": "å…«å­—",
        "jungastro": "è£æ ¼"
    }
    return names.get(skill_id, skill_id)


def _get_skill_icon(skill_id: str) -> str:
    """è·å– Skill çš„å›¾æ ‡"""
    icons = {
        "zodiac": "â™ˆ",
        "bazi": "â˜¯",
        "jungastro": "ğŸ§ "
    }
    return icons.get(skill_id, "âœ¨")


def _get_score_label(score: int) -> str:
    """æ ¹æ®åˆ†æ•°è·å–è¯„ä»·æ ‡ç­¾"""
    if score >= 85:
        return "å¤©ä½œä¹‹åˆ"
    elif score >= 70:
        return "é»˜å¥‘ç»„åˆ"
    elif score >= 55:
        return "éœ€è¦ç£¨åˆ"
    elif score >= 40:
        return "äº’è¡¥æˆé•¿"
    else:
        return "æŒ‘æˆ˜è¾ƒå¤š"
