# Bazi Skill 知识库构建计划

## 概述

执行 Stage 4a (案例提取) 和 Stage 4b (场景优化)，按用户指定顺序处理知识源。

**关键结论：Stage 4a 和 Stage 4b 可以并行执行**
- 两者都从 `knowledge_chunks` 读取，输出到不同表
- 无数据依赖关系

---

## 当前状态

| 指标 | 当前值 | 目标值 |
|------|--------|--------|
| knowledge_chunks | 3478 | ≥300 ✅ |
| cases | 0 | ≥50 |
| scenarios | 11 文件 | 已完整 ✅ |

---

## 执行计划

### Phase 1: Stage 4a - 案例提取 (按指定顺序)

#### 1.1 手动整理章节 (14章) - 结构化知识
- 文件位置: `/data/vibelife/knowledge/bazi/converted/manual/`
- 重点: 第十三章 (5个完整八步分析案例)
- 预计产出: 5-10 个高质量案例

#### 1.2 东方代码启示录 - 现代案例
- 文件: `《东方代码启示录》概念篇+八字教学基础版本.converted.md` (552KB)
- 格式: 内联格式 `（甲子．乙丑．丙寅．丁卯）`
- 预计产出: ~41 个案例

#### 1.3 古籍经典 - 历史案例
按顺序处理:
1. **滴天髓阐微** (385KB) - ~520 案例
2. **三命通会** (741KB) - ~50-100 案例
3. **千里命稿** (334KB) - ~100-150 案例
4. **子平真诠** (276KB) - ~142 案例

### Phase 2: Stage 4b - 场景审核/优化 (可与 Phase 1 并行)

现有 11 个 scenarios 已完整，主要任务:
1. 审核现有 scenario 的 SOP 流程
2. 检查与 cases 的关联配置
3. 优化触发词和输出模板

### Phase 3: 质量检查 (Stage 6)

运行质量检查脚本，验证:
- 案例数量 ≥50
- 案例分布覆盖所有 scenarios
- 检索质量 ≥70%

---

## 案例提取方法

### 识别特征

1. **现代格式** (手动章节):
```
年柱：甲子
月柱：乙丑
日柱：丙寅
时柱：丁卯
```

2. **古籍连排格式**:
```
八字：辛卯 丁酉 庚午 丙子
大运：丙申 乙未 癸巳 壬辰
```

3. **内联格式** (东方代码):
```
（甲子．乙丑．丙寅．丁卯）
```

### 输出结构

```json
{
  "name": "案例名称",
  "skill_id": "bazi",
  "core_data": {
    "year": "甲子",
    "month": "乙丑",
    "day": "丙寅",
    "hour": "丁卯",
    "gender": "男"
  },
  "features": {
    "daymaster": "丙火",
    "strength": "身强",
    "pattern": "正官格",
    "key_gods": ["正官", "正印"]
  },
  "tags": ["事业", "财运"],
  "scenario_ids": ["basic_reading", "career"]
}
```

---

## 关键文件

- 案例提取模板: `/home/aiscend/work/vibelife/.claude/skills/vibelife-skill/templates/prompts/CASE_EXTRACTION_PROMPT.md`
- 数据库 Schema: `/home/aiscend/work/vibelife/.claude/skills/vibelife-skill/templates/schemas/DATABASE_SCHEMAS.sql`
- Skill Schema: `/home/aiscend/work/vibelife/.claude/skills/vibelife-skill/templates/schemas/SKILL_SCHEMAS.md`
- 现有 Scenarios: `/home/aiscend/work/vibelife/apps/api/skills/bazi/scenarios/`

---

## 验证方法

```bash
# 检查案例数量
PGPASSWORD=xxx psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
  -c "SELECT COUNT(*) FROM cases WHERE skill_id = 'bazi';"

# 检查案例分布
PGPASSWORD=xxx psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
  -c "SELECT unnest(scenario_ids) as scenario, COUNT(*) FROM cases WHERE skill_id = 'bazi' GROUP BY scenario;"

# 质量检查
python /home/aiscend/work/vibelife/apps/api/scripts/build_knowledge.py --skill bazi --stages 6
```

---

## 执行确认

用户确认后，将按以下顺序执行:

1. **Phase 1.1**: 从手动章节提取案例 (第十三章优先)
2. **Phase 1.2**: 从东方代码启示录提取案例
3. **Phase 1.3**: 从古籍提取案例 (滴天髓阐微 → 三命通会 → 千里命稿 → 子平真诠)
4. **Phase 2**: 审核/优化现有 scenarios (可并行)
5. **Phase 3**: 运行质量检查
