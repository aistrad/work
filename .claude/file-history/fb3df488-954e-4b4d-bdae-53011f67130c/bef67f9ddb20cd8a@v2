"""
Currency System Pydantic Models.

REQ: REQ-PAY-001 ~ REQ-PAY-005
Design: §5.1.3
"""

from __future__ import annotations

from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Literal, Optional

from pydantic import BaseModel, Field


class CurrencyType(str, Enum):
    """Types of currency."""
    COINS = "coins"  # Purchasable currency
    AURA = "aura"    # Action-earned only


class LedgerCategory(str, Enum):
    """Categories for ledger entries."""
    PURCHASE = "purchase"      # Bought with real money
    EARN = "earn"              # Earned through actions
    SPEND = "spend"            # Spent on features
    TRANSFER_IN = "transfer_in"   # Received from another user
    TRANSFER_OUT = "transfer_out" # Sent to another user
    REFUND = "refund"          # Refunded
    ADMIN = "admin"            # Admin adjustment


# =============================================================================
# Balance Models
# =============================================================================

class UserBalance(BaseModel):
    """User's currency balance."""
    user_id: int
    coins: int = Field(default=0, ge=0, description="可购买货币")
    aura: int = Field(default=0, ge=0, description="行动赚取货币")
    updated_at: Optional[datetime] = None


class BalanceResponse(BaseModel):
    """Response for balance query."""
    coins: int
    aura: int
    total_value: int  # coins + aura


# =============================================================================
# Ledger Models
# =============================================================================

class CurrencyLedgerEntry(BaseModel):
    """A single ledger entry."""
    entry_id: Optional[int] = None
    user_id: int
    currency_type: CurrencyType
    amount: int  # Positive for credit, negative for debit
    balance_after: int
    category: LedgerCategory
    reason: str
    ref_type: Optional[str] = None  # 'commitment', 'chain', 'buff', 'purchase', etc.
    ref_id: Optional[str] = None
    description: Optional[str] = None
    created_at: Optional[datetime] = None


class LedgerHistoryResponse(BaseModel):
    """Response for ledger history query."""
    entries: List[CurrencyLedgerEntry]
    total_count: int
    limit: int
    offset: int


# =============================================================================
# Transaction Models
# =============================================================================

class AddCurrencyRequest(BaseModel):
    """Request to add currency to user."""
    user_id: int
    currency_type: CurrencyType
    amount: int = Field(..., gt=0, description="Amount to add")
    category: LedgerCategory
    reason: str
    ref_type: Optional[str] = None
    ref_id: Optional[str] = None
    description: Optional[str] = None


class DeductCurrencyRequest(BaseModel):
    """Request to deduct currency from user."""
    user_id: int
    currency_type: CurrencyType
    amount: int = Field(..., gt=0, description="Amount to deduct")
    category: LedgerCategory
    reason: str
    ref_type: Optional[str] = None
    ref_id: Optional[str] = None
    description: Optional[str] = None


class TransferRequest(BaseModel):
    """Request to transfer currency between users."""
    from_user_id: int
    to_user_id: int
    currency_type: CurrencyType
    amount: int = Field(..., gt=0, description="Amount to transfer")
    reason: str
    ref_type: Optional[str] = None
    ref_id: Optional[str] = None


class TransactionResult(BaseModel):
    """Result of a currency transaction."""
    success: bool
    entry_id: Optional[int] = None
    new_balance: int
    message: str


# =============================================================================
# Earning Rules Models
# =============================================================================

class EarningRule(BaseModel):
    """Rule for earning currency."""
    rule_id: str
    name: str
    description: str
    currency_type: CurrencyType
    amount: int
    trigger: str  # 'commitment_complete', 'checkin', 'chain_join', etc.
    cooldown_hours: Optional[int] = None
    daily_limit: Optional[int] = None
    enabled: bool = True


class EarningRulesResponse(BaseModel):
    """Response for earning rules query."""
    rules: List[EarningRule]
