/**
 * Fortune AI Agent Service - Main Entry Point
 *
 * Express server that exposes the Agent Service API.
 *
 * REQ: REQ-AGENT-001
 * Design: ยง4.2
 */

import 'dotenv/config';
import express, { Request, Response } from 'express';
import { CoreMessage } from 'ai';
import { runCoachAgent } from './agents/index.js';

const app = express();
app.use(express.json());

const PORT = process.env.AGENT_SERVICE_PORT || 3000;

// Health check
app.get('/health', (_req: Request, res: Response) => {
  res.json({ status: 'ok', service: 'fortune-ai-agent-service' });
});

// Chat endpoint
interface ChatRequest {
  userId: number;
  messages: CoreMessage[];
  stream?: boolean;
}

app.post('/api/chat', async (req: Request<object, object, ChatRequest>, res: Response) => {
  try {
    const { userId, messages, stream = false } = req.body;

    if (!userId || !messages || !Array.isArray(messages)) {
      res.status(400).json({ error: 'Invalid request: userId and messages required' });
      return;
    }

    if (stream) {
      // Streaming response
      res.setHeader('Content-Type', 'text/event-stream');
      res.setHeader('Cache-Control', 'no-cache');
      res.setHeader('Connection', 'keep-alive');

      const result = await runCoachAgent({
        userId,
        messages,
        onStream: (chunk) => {
          res.write(`data: ${JSON.stringify({ type: 'text', content: chunk })}\n\n`);
        },
      });

      // Send final result
      res.write(`data: ${JSON.stringify({ type: 'done', text: result.text, toolCalls: result.toolCalls })}\n\n`);
      res.end();
    } else {
      // Non-streaming response
      const result = await runCoachAgent({
        userId,
        messages,
      });

      res.json({
        text: result.text,
        toolCalls: result.toolCalls,
      });
    }
  } catch (error) {
    console.error('Chat error:', error);
    res.status(500).json({
      error: 'Internal server error',
      message: error instanceof Error ? error.message : 'Unknown error',
    });
  }
});

// Start server
app.listen(PORT, () => {
  console.log(`Fortune AI Agent Service running on port ${PORT}`);
  console.log(`Health check: http://localhost:${PORT}/health`);
});

export default app;
