"""
JITAI (Just-In-Time Adaptive Interventions) Pydantic Models.

REQ: REQ-JITAI-001 ~ REQ-JITAI-004
Design: §5.1.4
"""

from __future__ import annotations

from datetime import datetime, time
from enum import Enum
from typing import Any, Dict, List, Literal, Optional

from pydantic import BaseModel, Field


class InterventionType(str, Enum):
    """Types of JITAI interventions."""
    PUSH = "push"
    IN_APP = "in_app"
    EMAIL = "email"


class TriggerCategory(str, Enum):
    """Categories of JITAI triggers."""
    TIME_BASED = "time_based"
    STATE_BASED = "state_based"
    EVENT_BASED = "event_based"
    ASTRO_BASED = "astro_based"


# =============================================================================
# Trigger Configuration Models
# =============================================================================

class TimeCondition(BaseModel):
    """Time-based condition for triggers."""
    type: Literal["time_range", "specific_time", "day_of_week"]
    start_time: Optional[time] = None
    end_time: Optional[time] = None
    specific_time: Optional[time] = None
    days: Optional[List[int]] = None  # 0=Monday, 6=Sunday


class StateCondition(BaseModel):
    """State-based condition for triggers."""
    type: Literal["twin_field", "streak", "balance"]
    field_path: Optional[str] = None  # e.g., "dimension_scores.energy"
    operator: Literal["lt", "gt", "eq", "lte", "gte", "between"]
    value: Any
    value_max: Optional[Any] = None  # For "between" operator


class EventCondition(BaseModel):
    """Event-based condition for triggers."""
    type: Literal["no_activity", "commitment_due", "plan_day"]
    hours_since: Optional[int] = None
    event_type: Optional[str] = None


class JITAICondition(BaseModel):
    """A single condition for JITAI trigger."""
    condition_type: Literal["time", "state", "event"]
    time_condition: Optional[TimeCondition] = None
    state_condition: Optional[StateCondition] = None
    event_condition: Optional[EventCondition] = None


class JITAITrigger(BaseModel):
    """
    Configuration for a JITAI trigger.

    REQ: REQ-JITAI-001, REQ-JITAI-002
    """
    trigger_id: str = Field(..., description="唯一触发器ID")
    name: str = Field(..., description="触发器名称")
    description: Optional[str] = None
    category: TriggerCategory
    conditions: List[JITAICondition] = Field(default_factory=list)
    conditions_logic: Literal["all", "any"] = "all"  # AND or OR
    intervention_type: InterventionType = InterventionType.PUSH
    intervention_template: Dict[str, Any] = Field(default_factory=dict)
    priority: int = Field(default=5, ge=1, le=10, description="优先级 1-10")
    cooldown_hours: int = Field(default=24, ge=1, description="冷却时间(小时)")
    enabled: bool = True


# =============================================================================
# Intervention Models
# =============================================================================

class JITAIIntervention(BaseModel):
    """
    A JITAI intervention record.

    REQ: REQ-JITAI-003
    """
    intervention_id: Optional[int] = None
    user_id: int
    trigger_id: str
    intervention_type: InterventionType
    content: Dict[str, Any]
    priority: int = 5
    delivered_at: Optional[datetime] = None
    clicked_at: Optional[datetime] = None
    dismissed_at: Optional[datetime] = None


class JITAICooldown(BaseModel):
    """Cooldown state for a trigger."""
    user_id: int
    trigger_id: str
    expires_at: datetime


# =============================================================================
# Evaluation Models
# =============================================================================

class TriggerEvaluationResult(BaseModel):
    """Result of evaluating a single trigger."""
    trigger_id: str
    triggered: bool
    conditions_met: List[str] = Field(default_factory=list)
    conditions_failed: List[str] = Field(default_factory=list)
    cooldown_active: bool = False
    intervention: Optional[JITAIIntervention] = None


class JITAIEvaluationResult(BaseModel):
    """Result of evaluating all triggers for a user."""
    user_id: int
    evaluated_at: datetime
    triggers_evaluated: int
    triggers_fired: int
    interventions: List[JITAIIntervention] = Field(default_factory=list)


# =============================================================================
# Cron Models
# =============================================================================

class JITAICronResult(BaseModel):
    """Result of JITAI cron job."""
    evaluated: int
    intervened: int
    errors: int
    duration_ms: int
    interventions_by_trigger: Dict[str, int] = Field(default_factory=dict)
