"""
Social Network Pydantic Models.

REQ: REQ-SOCIAL-001 ~ REQ-SOCIAL-005
Design: §5.1.2
"""

from __future__ import annotations

from datetime import datetime
from enum import Enum
from typing import Any, Dict, List, Literal, Optional
from uuid import UUID

from pydantic import BaseModel, Field, field_validator


class RelationshipType(str, Enum):
    """Types of social relationships."""
    FRIEND = "friend"
    FAMILY = "family"
    COLLEAGUE = "colleague"


class RelationshipStatus(str, Enum):
    """Status of a relationship."""
    PENDING = "pending"
    ACCEPTED = "accepted"
    BLOCKED = "blocked"


class BuffType(str, Enum):
    """Types of energy buffs."""
    ENERGY = "energy"
    LUCK = "luck"
    CALM = "calm"
    FOCUS = "focus"


class ChainStatus(str, Enum):
    """Status of a luck chain."""
    ACTIVE = "active"
    COMPLETED = "completed"
    EXPIRED = "expired"


class RitualType(str, Enum):
    """Types of chain rituals."""
    GRATITUDE = "gratitude"
    WISH = "wish"
    BLESSING = "blessing"
    CHALLENGE = "challenge"


class CardType(str, Enum):
    """Types of share cards."""
    DAILY_GUIDANCE = "daily_guidance"
    INSIGHT = "insight"
    ACHIEVEMENT = "achievement"
    CHAIN_INVITE = "chain_invite"


# =============================================================================
# Friend Request Models
# =============================================================================

class FriendRequest(BaseModel):
    """Model for friend request."""
    user_id: int = Field(..., description="发起请求的用户ID")
    peer_user_id: int = Field(..., description="目标用户ID")
    relationship_type: RelationshipType = Field(
        default=RelationshipType.FRIEND,
        description="关系类型"
    )
    message: Optional[str] = Field(default=None, max_length=200, description="请求消息")

    @field_validator("peer_user_id")
    @classmethod
    def validate_not_self(cls, v: int, info) -> int:
        if "user_id" in info.data and v == info.data["user_id"]:
            raise ValueError("Cannot send friend request to yourself")
        return v


class FriendRequestResponse(BaseModel):
    """Response for friend request operations."""
    success: bool
    status: RelationshipStatus
    message: str


class SocialEdge(BaseModel):
    """Model for social relationship edge."""
    user_id: int
    peer_user_id: int
    relationship_type: RelationshipType
    status: RelationshipStatus
    compatibility_score: Optional[float] = Field(default=None, ge=0, le=100)
    compatibility_data: Optional[Dict[str, Any]] = None
    created_at: Optional[datetime] = None
    updated_at: Optional[datetime] = None


class FriendListResponse(BaseModel):
    """Response for friend list query."""
    friends: List[SocialEdge]
    total_count: int


# =============================================================================
# Energy Buff Models
# =============================================================================

class EnergyBuffRequest(BaseModel):
    """Request to send energy buff."""
    to_user_id: int = Field(..., description="接收者用户ID")
    buff_type: BuffType = Field(..., description="Buff类型")
    amount: int = Field(..., gt=0, le=1000, description="数量")
    message: Optional[str] = Field(default=None, max_length=200, description="附言")


class EnergyBuff(BaseModel):
    """Model for energy buff record."""
    buff_id: int
    from_user_id: int
    to_user_id: int
    buff_type: BuffType
    amount: int
    message: Optional[str] = None
    source: Literal["app", "agent", "system"] = "app"
    created_at: Optional[datetime] = None


class EnergyBuffResponse(BaseModel):
    """Response for energy buff operation."""
    buff_id: int
    success: bool
    new_balance: int
    message: str


# =============================================================================
# Luck Chain Models
# =============================================================================

class CreateChainRequest(BaseModel):
    """Request to create a luck chain."""
    title: str = Field(..., min_length=1, max_length=100, description="接龙标题")
    description: Optional[str] = Field(default=None, max_length=500, description="描述")
    ritual_type: RitualType = Field(..., description="仪式类型")
    base_reward: int = Field(default=10, ge=1, le=100, description="基础奖励")
    expires_hours: Optional[int] = Field(default=24, ge=1, le=168, description="过期时间(小时)")


class JoinChainRequest(BaseModel):
    """Request to join a luck chain."""
    chain_id: int = Field(..., description="接龙ID")
    contribution: Optional[str] = Field(default=None, max_length=200, description="贡献内容")


class LuckChain(BaseModel):
    """Model for luck chain."""
    chain_id: int
    creator_user_id: int
    title: str
    description: Optional[str] = None
    ritual_type: RitualType
    base_reward: int
    participant_count: int = 0
    status: ChainStatus = ChainStatus.ACTIVE
    expires_at: Optional[datetime] = None
    created_at: Optional[datetime] = None


class ChainParticipant(BaseModel):
    """Model for chain participant."""
    chain_id: int
    user_id: int
    position: int
    contribution: Optional[str] = None
    reward_earned: Optional[int] = None
    created_at: Optional[datetime] = None


class JoinChainResponse(BaseModel):
    """Response for joining a chain."""
    position: int
    reward: int
    total_participants: int
    chain_strength: float
    message: str


class ChainDetailResponse(BaseModel):
    """Response for chain detail query."""
    chain: LuckChain
    participants: List[ChainParticipant]
    my_participation: Optional[ChainParticipant] = None


# =============================================================================
# Share Card Models
# =============================================================================

class CreateShareCardRequest(BaseModel):
    """Request to create a share card."""
    card_type: CardType = Field(..., description="卡片类型")
    content: Dict[str, Any] = Field(..., description="卡片内容")
    expires_hours: Optional[int] = Field(default=168, ge=1, le=720, description="过期时间(小时)")


class ShareCard(BaseModel):
    """Model for share card."""
    card_id: UUID
    user_id: int
    card_type: CardType
    content: Dict[str, Any]
    share_url: Optional[str] = None
    view_count: int = 0
    expires_at: Optional[datetime] = None
    created_at: Optional[datetime] = None


class ShareCardResponse(BaseModel):
    """Response for share card creation."""
    card_id: str
    share_url: str
    qr_data: Optional[str] = None


# =============================================================================
# Compatibility Models
# =============================================================================

class CompatibilityRequest(BaseModel):
    """Request for compatibility analysis."""
    peer_user_id: int = Field(..., description="对方用户ID")
    analysis_type: Literal["basic", "detailed"] = Field(
        default="basic",
        description="分析类型"
    )


class CompatibilityResult(BaseModel):
    """Result of compatibility analysis."""
    overall_score: float = Field(..., ge=0, le=100)
    dimensions: Dict[str, float] = Field(default_factory=dict)
    insights: List[str] = Field(default_factory=list)
    recommendations: List[str] = Field(default_factory=list)
    cached: bool = False


class CompatibilityResponse(BaseModel):
    """Response for compatibility analysis."""
    user_id: int
    peer_user_id: int
    result: CompatibilityResult
    analyzed_at: datetime
