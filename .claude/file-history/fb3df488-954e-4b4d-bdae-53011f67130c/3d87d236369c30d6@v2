-- Fortune AI Claude MVP v1.1 Schema Migration
-- Date: 2025-12-30
-- REQ: REQ-TWIN-001, REQ-SOCIAL-001, REQ-PAY-001, REQ-JITAI-001, REQ-AGENT-001
-- HOS-REF: design.md §5.1.1 ~ §5.1.6
--
-- This file is idempotent (safe to re-run).
-- Requires: 20251229_final_mvp.sql to be applied first.

-- Enable pgvector extension for KB embeddings
CREATE EXTENSION IF NOT EXISTS vector;

--------------------------------------------------------------------------------
-- 5.1.1 数字孪生表 (Digital Twin)
--------------------------------------------------------------------------------

-- 孪生主表
CREATE TABLE IF NOT EXISTS fortune_digital_twin (
    twin_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL UNIQUE REFERENCES fortune_user(user_id) ON DELETE CASCADE,

    -- L1 元数据层 (Metadata Layer)
    metadata_astrology JSONB NOT NULL DEFAULT '{}',   -- 八字/命盘数据
    metadata_psychology JSONB NOT NULL DEFAULT '{}',  -- 心理测评结果
    metadata_memory JSONB NOT NULL DEFAULT '{}',      -- 长期记忆/偏好

    -- L2 动态状态层 (Dynamic State Layer)
    dynamic_astro JSONB NOT NULL DEFAULT '{}',        -- 当前运势/流年
    dynamic_bio JSONB NOT NULL DEFAULT '{}',          -- 生理状态 (睡眠/运动)
    dynamic_social JSONB NOT NULL DEFAULT '{}',       -- 社交状态
    dynamic_emotional JSONB NOT NULL DEFAULT '{}',    -- 情绪状态

    -- L3 聚合指标 (Aggregated Metrics)
    aura_points INTEGER NOT NULL DEFAULT 0,
    overall_wellbeing NUMERIC(5,2) NOT NULL DEFAULT 50.00,
    growth_streak INTEGER NOT NULL DEFAULT 0,
    dimension_scores JSONB NOT NULL DEFAULT
        '{"energy":50,"clarity":50,"connection":50,"growth":50,"balance":50}',

    -- 元信息
    compute_version TEXT NOT NULL DEFAULT 'v1.0',
    last_full_refresh TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_twin_user ON fortune_digital_twin(user_id);

-- 孪生更新日志
CREATE TABLE IF NOT EXISTS fortune_twin_update_log (
    log_id BIGSERIAL PRIMARY KEY,
    twin_id BIGINT NOT NULL REFERENCES fortune_digital_twin(twin_id) ON DELETE CASCADE,
    trigger_type TEXT NOT NULL,  -- 'chat_insight', 'checkin', 'commitment_done', 'social_event', 'cron'
    layer TEXT NOT NULL CHECK (layer IN ('L1', 'L2', 'L3')),
    path TEXT NOT NULL,          -- JSON path, e.g., 'dynamic_emotional.current_mood'
    old_value JSONB,
    new_value JSONB NOT NULL,
    confidence NUMERIC(3,2) NOT NULL CHECK (confidence >= 0 AND confidence <= 1),
    source TEXT NOT NULL,        -- 'user', 'agent', 'system'
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_twin_log_twin ON fortune_twin_update_log(twin_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_twin_log_trigger ON fortune_twin_update_log(trigger_type, created_at DESC);

--------------------------------------------------------------------------------
-- 5.1.2 社交关系表 (Social Network)
--------------------------------------------------------------------------------

-- 好友关系
CREATE TABLE IF NOT EXISTS fortune_social_edge (
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    peer_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    relationship_type TEXT NOT NULL DEFAULT 'friend' CHECK (relationship_type IN ('friend', 'family', 'colleague')),
    status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'blocked')),
    compatibility_score NUMERIC(5,2),
    compatibility_data JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (user_id, peer_user_id),
    CHECK (user_id != peer_user_id)
);

CREATE INDEX IF NOT EXISTS idx_social_edge_peer ON fortune_social_edge(peer_user_id, status);

-- 能量打赏
CREATE TABLE IF NOT EXISTS fortune_energy_buff (
    buff_id BIGSERIAL PRIMARY KEY,
    from_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    to_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    buff_type TEXT NOT NULL CHECK (buff_type IN ('energy', 'luck', 'calm', 'focus')),
    amount INTEGER NOT NULL CHECK (amount > 0),
    message TEXT,
    source TEXT NOT NULL DEFAULT 'app' CHECK (source IN ('app', 'agent', 'system')),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_buff_to_user ON fortune_energy_buff(to_user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_buff_from_user ON fortune_energy_buff(from_user_id, created_at DESC);

-- 好运接龙
CREATE TABLE IF NOT EXISTS fortune_luck_chain (
    chain_id BIGSERIAL PRIMARY KEY,
    creator_user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT,
    ritual_type TEXT NOT NULL CHECK (ritual_type IN ('gratitude', 'wish', 'blessing', 'challenge')),
    base_reward INTEGER NOT NULL DEFAULT 10 CHECK (base_reward > 0),
    participant_count INTEGER NOT NULL DEFAULT 0,
    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'completed', 'expired')),
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_chain_status ON fortune_luck_chain(status, created_at DESC);

CREATE TABLE IF NOT EXISTS fortune_luck_chain_participant (
    chain_id BIGINT NOT NULL REFERENCES fortune_luck_chain(chain_id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    position INTEGER NOT NULL CHECK (position > 0),
    contribution TEXT,
    reward_earned INTEGER,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    PRIMARY KEY (chain_id, user_id)
);

CREATE INDEX IF NOT EXISTS idx_chain_participant_user ON fortune_luck_chain_participant(user_id, created_at DESC);

--------------------------------------------------------------------------------
-- 5.1.3 货币系统表 (Currency System)
--------------------------------------------------------------------------------

-- 用户余额
CREATE TABLE IF NOT EXISTS fortune_user_balance (
    user_id BIGINT PRIMARY KEY REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    coins INTEGER NOT NULL DEFAULT 0 CHECK (coins >= 0),
    aura INTEGER NOT NULL DEFAULT 0 CHECK (aura >= 0),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 货币账本
CREATE TABLE IF NOT EXISTS fortune_currency_ledger (
    entry_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    currency_type TEXT NOT NULL CHECK (currency_type IN ('coins', 'aura')),
    amount INTEGER NOT NULL,  -- positive for credit, negative for debit
    balance_after INTEGER NOT NULL CHECK (balance_after >= 0),
    category TEXT NOT NULL CHECK (category IN ('purchase', 'earn', 'spend', 'transfer_in', 'transfer_out', 'refund', 'admin')),
    reason TEXT NOT NULL,
    ref_type TEXT,  -- 'commitment', 'chain', 'buff', 'purchase', etc.
    ref_id TEXT,
    description TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_ledger_user ON fortune_currency_ledger(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_ledger_category ON fortune_currency_ledger(category, created_at DESC);

--------------------------------------------------------------------------------
-- 5.1.4 JITAI 表 (Just-In-Time Adaptive Interventions)
--------------------------------------------------------------------------------

-- JITAI 干预记录
CREATE TABLE IF NOT EXISTS fortune_jitai_intervention (
    intervention_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    trigger_id TEXT NOT NULL,  -- 'low_energy', 'streak_break', 'social_isolation', etc.
    intervention_type TEXT NOT NULL CHECK (intervention_type IN ('push', 'in_app', 'email')),
    content JSONB NOT NULL,
    priority INTEGER NOT NULL DEFAULT 5 CHECK (priority BETWEEN 1 AND 10),
    delivered_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    clicked_at TIMESTAMPTZ,
    dismissed_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_jitai_user ON fortune_jitai_intervention(user_id, delivered_at DESC);
CREATE INDEX IF NOT EXISTS idx_jitai_trigger ON fortune_jitai_intervention(trigger_id, delivered_at DESC);

-- JITAI 冷却状态
CREATE TABLE IF NOT EXISTS fortune_jitai_cooldown (
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    trigger_id TEXT NOT NULL,
    expires_at TIMESTAMPTZ NOT NULL,
    PRIMARY KEY (user_id, trigger_id)
);

CREATE INDEX IF NOT EXISTS idx_jitai_cooldown_expires ON fortune_jitai_cooldown(expires_at);

--------------------------------------------------------------------------------
-- 5.1.5 Agent 审计表 (Agent Audit)
--------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS fortune_agent_run (
    run_id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,
    agent_name TEXT NOT NULL,  -- 'coach', 'analyst', 'expert_bazi', etc.
    prompt_version TEXT NOT NULL,
    facts_hash TEXT,
    input JSONB NOT NULL,
    output JSONB NOT NULL,
    tool_calls JSONB,  -- [{tool_name, params, result, latency_ms}]
    usage JSONB,       -- {prompt_tokens, completion_tokens, total_tokens}
    latency_ms INTEGER,
    error TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_agent_run_user ON fortune_agent_run(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_agent_run_agent ON fortune_agent_run(agent_name, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_agent_run_session ON fortune_agent_run(session_id);

--------------------------------------------------------------------------------
-- 5.1.6 知识库表 (Knowledge Base with pgvector)
--------------------------------------------------------------------------------

-- KB chunk 表 (with vector embeddings)
CREATE TABLE IF NOT EXISTS fortune_kb_chunk (
    chunk_id BIGSERIAL PRIMARY KEY,
    collection TEXT NOT NULL,  -- 'bazi', 'tieban', 'psychology', etc.
    source_doc TEXT NOT NULL,
    title TEXT,
    content TEXT NOT NULL,
    embedding vector(1536),    -- OpenAI ada-002 dimension
    meta JSONB NOT NULL DEFAULT '{}',
    content_tsv TSVECTOR GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_kb_collection ON fortune_kb_chunk(collection);
CREATE INDEX IF NOT EXISTS idx_kb_tsv ON fortune_kb_chunk USING GIN(content_tsv);
-- Note: ivfflat index requires data to be present first, create after initial load
-- CREATE INDEX IF NOT EXISTS idx_kb_embedding ON fortune_kb_chunk USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);

-- 用户 KB 解锁
CREATE TABLE IF NOT EXISTS fortune_user_kb_unlock (
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    kb_id TEXT NOT NULL,  -- 'premium_bazi', 'advanced_tieban', etc.
    unlocked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    unlock_source TEXT NOT NULL DEFAULT 'purchase' CHECK (unlock_source IN ('purchase', 'gift', 'subscription', 'admin')),
    PRIMARY KEY (user_id, kb_id)
);

--------------------------------------------------------------------------------
-- 5.1.7 分享卡表 (Share Cards)
--------------------------------------------------------------------------------

CREATE TABLE IF NOT EXISTS fortune_share_card (
    card_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    card_type TEXT NOT NULL CHECK (card_type IN ('daily_guidance', 'insight', 'achievement', 'chain_invite')),
    content JSONB NOT NULL,
    share_url TEXT,
    view_count INTEGER NOT NULL DEFAULT 0,
    expires_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_share_card_user ON fortune_share_card(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_share_card_type ON fortune_share_card(card_type, created_at DESC);

--------------------------------------------------------------------------------
-- Update fortune_commitment table to support agent source
--------------------------------------------------------------------------------

-- Add 'agent' to source check constraint if not already present
DO $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM pg_constraint
        WHERE conrelid = 'fortune_commitment'::regclass
        AND conname = 'fortune_commitment_source_check'
    ) THEN
        ALTER TABLE fortune_commitment DROP CONSTRAINT fortune_commitment_source_check;
    END IF;

    ALTER TABLE fortune_commitment
        ADD CONSTRAINT fortune_commitment_source_check
        CHECK (source IN ('chat', 'bento', 'push', 'agent'));
EXCEPTION WHEN others THEN
    NULL;
END $$;

-- Add category column to fortune_commitment if not exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'fortune_commitment' AND column_name = 'category'
    ) THEN
        ALTER TABLE fortune_commitment ADD COLUMN category TEXT DEFAULT 'general';
    END IF;
END $$;

-- Add aura_reward column to fortune_commitment if not exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'fortune_commitment' AND column_name = 'aura_reward'
    ) THEN
        ALTER TABLE fortune_commitment ADD COLUMN aura_reward INTEGER DEFAULT 0;
    END IF;
END $$;

--------------------------------------------------------------------------------
-- Verification query
--------------------------------------------------------------------------------

SELECT 'Claude MVP v1.1 migration completed successfully' AS result;
