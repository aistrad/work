/**
 * Fortune AI Agent Service - Coach Agent
 *
 * Main conversational agent for user interactions.
 * Uses Vercel AI SDK streamText for streaming responses.
 *
 * REQ: REQ-AGENT-002, REQ-AGENT-003
 * Design: §4.2
 */

import { streamText, CoreMessage } from 'ai';
import { getDefaultChatModel } from '../config/models.js';
import { fastAPITools } from '../tools/index.js';

// System prompt for coach agent
const COACH_SYSTEM_PROMPT = `你是 Fortune AI 的智慧教练，一个融合东方命理智慧与现代心理学的 AI 助手。

## 你的角色
- 你是用户的个人成长伙伴，帮助他们理解自己、做出更好的决策
- 你结合八字命理、心理学和行为科学，提供个性化的指导
- 你的语气温暖、支持性强，但也会在需要时给出直接的建议

## 你的能力
1. **理解用户状态**: 通过对话了解用户的情绪、需求和目标
2. **提供洞察**: 基于用户的命理数据和当前状态，提供有价值的见解
3. **建议行动**: 推荐具体、可执行的小步骤来改善用户状态
4. **创建承诺**: 帮助用户设定并追踪行动承诺
5. **更新孪生**: 记录用户状态变化到数字孪生

## 交互原则
- 每次回复控制在 200 字以内，除非用户要求详细解释
- 优先使用工具获取用户上下文，而不是假设
- 当用户表达情绪时，先共情，再提供建议
- 建议的行动要具体、可量化、有时间限制
- 适时使用 updateTwin 记录用户的重要状态变化

## 输出格式
使用 A2UI 协议格式化输出，包括：
- text: 主要回复文本
- cards: 可选的卡片组件（如建议、洞察）
- actions: 可选的快捷操作按钮
`;

export interface CoachAgentOptions {
  userId: number;
  messages: CoreMessage[];
  onStream?: (chunk: string) => void;
}

export interface CoachAgentResult {
  text: string;
  toolCalls?: Array<{
    toolName: string;
    args: Record<string, unknown>;
    result: unknown;
  }>;
}

/**
 * Run the coach agent with streaming
 */
export async function runCoachAgent(options: CoachAgentOptions): Promise<CoachAgentResult> {
  const { messages, onStream } = options;

  // Prepare tools with userId context
  const tools = {
    getUserContext: fastAPITools.getUserContext,
    createCommitment: fastAPITools.createCommitment,
    updateTwin: fastAPITools.updateTwin,
    createShareCard: fastAPITools.createShareCard,
    getBaziFacts: fastAPITools.getBaziFacts,
  };

  // Run streamText
  const result = await streamText({
    model: getDefaultChatModel(),
    system: COACH_SYSTEM_PROMPT,
    messages,
    tools,
    maxSteps: 5, // Allow up to 5 tool calls
    onChunk: ({ chunk }) => {
      if (chunk.type === 'text-delta' && onStream) {
        onStream(chunk.textDelta);
      }
    },
  });

  // Collect full response
  let fullText = '';
  const toolCalls: CoachAgentResult['toolCalls'] = [];

  for await (const part of result.fullStream) {
    if (part.type === 'text-delta') {
      fullText += part.textDelta;
    } else if (part.type === 'tool-call') {
      toolCalls.push({
        toolName: part.toolName,
        args: part.args as Record<string, unknown>,
        result: undefined,
      });
    } else if (part.type === 'tool-result') {
      const lastCall = toolCalls[toolCalls.length - 1];
      if (lastCall) {
        lastCall.result = part.result;
      }
    }
  }

  return {
    text: fullText,
    toolCalls: toolCalls.length > 0 ? toolCalls : undefined,
  };
}
