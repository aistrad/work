"""
Currency System API Routes.

REQ: REQ-PAY-001 ~ REQ-PAY-005
Design: ยง5.1.3
"""

from __future__ import annotations

from typing import Any, Dict, List, Optional

from fastapi import APIRouter, Depends, HTTPException, Query, Request
from pydantic import BaseModel, Field

from api.deps import require_auth, require_csrf
from models.currency import CurrencyType, LedgerCategory
from services import currency_service

router = APIRouter(prefix="/api/currency", tags=["Currency"])


# =============================================================================
# Balance Endpoints
# =============================================================================

@router.get("/balance")
async def get_balance(
    request: Request,
    auth: Dict[str, Any] = Depends(require_auth),
) -> Dict[str, Any]:
    """
    Get current user's currency balance.

    REQ: REQ-PAY-001
    """
    user_id = auth["user_id"]
    balance = currency_service.get_balance(user_id)

    return {
        "coins": balance.coins,
        "aura": balance.aura,
        "total_value": balance.coins + balance.aura,
    }


# =============================================================================
# Ledger Endpoints
# =============================================================================

@router.get("/ledger")
async def get_ledger_history(
    request: Request,
    currency_type: Optional[str] = Query(default=None, description="Filter by currency type"),
    category: Optional[str] = Query(default=None, description="Filter by category"),
    limit: int = Query(default=20, ge=1, le=100),
    offset: int = Query(default=0, ge=0),
    auth: Dict[str, Any] = Depends(require_auth),
) -> Dict[str, Any]:
    """
    Get user's transaction history.

    REQ: REQ-PAY-005
    """
    user_id = auth["user_id"]

    # Validate filters
    ct = None
    if currency_type:
        try:
            ct = CurrencyType(currency_type)
        except ValueError:
            raise HTTPException(status_code=400, detail="Invalid currency type")

    cat = None
    if category:
        try:
            cat = LedgerCategory(category)
        except ValueError:
            raise HTTPException(status_code=400, detail="Invalid category")

    result = currency_service.get_ledger_history(
        user_id=user_id,
        currency_type=ct,
        category=cat,
        limit=limit,
        offset=offset,
    )

    return {
        "entries": [
            {
                "entry_id": e.entry_id,
                "currency_type": e.currency_type.value,
                "amount": e.amount,
                "balance_after": e.balance_after,
                "category": e.category.value,
                "reason": e.reason,
                "ref_type": e.ref_type,
                "ref_id": e.ref_id,
                "description": e.description,
                "created_at": e.created_at.isoformat() if e.created_at else None,
            }
            for e in result["entries"]
        ],
        "total_count": result["total_count"],
        "limit": result["limit"],
        "offset": result["offset"],
    }


# =============================================================================
# Earning Rules Endpoint
# =============================================================================

@router.get("/earning-rules")
async def get_earning_rules(
    request: Request,
    auth: Dict[str, Any] = Depends(require_auth),
) -> Dict[str, Any]:
    """
    Get available earning rules.

    REQ: REQ-PAY-003
    """
    rules = currency_service.get_earning_rules()

    return {
        "rules": [
            {
                "rule_id": r.rule_id,
                "name": r.name,
                "description": r.description,
                "currency_type": r.currency_type.value,
                "amount": r.amount,
                "trigger": r.trigger,
                "daily_limit": r.daily_limit,
            }
            for r in rules
        ],
    }


# =============================================================================
# Admin Endpoints (for testing/admin use)
# =============================================================================

class AdminAddRequest(BaseModel):
    amount: int = Field(..., gt=0, le=10000)
    currency_type: str = "coins"
    reason: str = "admin_grant"


@router.post("/admin/add")
async def admin_add_currency(
    request: Request,
    body: AdminAddRequest,
    auth: Dict[str, Any] = Depends(require_auth),
) -> Dict[str, Any]:
    """
    Admin endpoint to add currency (for testing).

    In production, this should be restricted to admin users.
    """
    require_csrf(request, auth)
    user_id = auth["user_id"]

    try:
        ct = CurrencyType(body.currency_type)
    except ValueError:
        raise HTTPException(status_code=400, detail="Invalid currency type")

    entry = currency_service.add_currency(
        user_id=user_id,
        currency_type=ct,
        amount=body.amount,
        category=LedgerCategory.ADMIN,
        reason=body.reason,
    )

    return {
        "success": True,
        "entry_id": entry.entry_id,
        "new_balance": entry.balance_after,
    }
