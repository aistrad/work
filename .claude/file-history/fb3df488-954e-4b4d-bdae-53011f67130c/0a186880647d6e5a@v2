"""
Tests for Digital Twin API Routes.

TASK-1.3.1~1.3.3: 孪生路由测试
REQ: REQ-TWIN-002, REQ-TWIN-005
"""

import pytest
from unittest.mock import MagicMock, patch

from fastapi.testclient import TestClient


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def mock_auth():
    """Mock authentication dependency."""
    return {"user_id": 100, "email": "test@example.com"}


@pytest.fixture
def mock_twin_service():
    """Mock twin_service module."""
    with patch("api.twin_routes.twin_service") as mock:
        yield mock


@pytest.fixture
def client(mock_auth):
    """Create test client with mocked auth."""
    from api.main import app
    from api import deps

    # Override auth dependency
    app.dependency_overrides[deps.require_auth] = lambda: mock_auth

    client = TestClient(app)
    yield client

    # Clean up
    app.dependency_overrides.clear()


# =============================================================================
# Test GET /api/twin (TASK-1.3.1)
# =============================================================================

class TestGetTwin:
    """Tests for GET /api/twin endpoint."""

    def test_get_twin_api_requires_auth(self):
        """Test that endpoint requires authentication."""
        from api.main import app

        # Clear any overrides
        app.dependency_overrides.clear()

        client = TestClient(app)
        response = client.get("/api/twin")

        assert response.status_code == 401

    def test_get_twin_api_all_layers(self, client, mock_twin_service):
        """Test getting twin with all layers."""
        from models.twin import TwinData, DimensionScores
        from datetime import datetime

        mock_twin = TwinData(
            twin_id=1,
            user_id=100,
            metadata_astrology={"bazi": "甲子"},
            dynamic_emotional={"mood": "calm"},
            dimension_scores=DimensionScores(energy=60),
            updated_at=datetime.now(),
        )
        mock_twin_service.get_twin.return_value = mock_twin

        response = client.get("/api/twin")

        assert response.status_code == 200
        data = response.json()
        assert "twin" in data
        assert "last_updated" in data

    def test_get_twin_api_with_layer(self, client, mock_twin_service):
        """Test getting twin with specific layer."""
        from models.twin import TwinData, DimensionScores
        from datetime import datetime

        mock_twin = TwinData(
            twin_id=1,
            user_id=100,
            metadata_astrology={"bazi": "甲子"},
            updated_at=datetime.now(),
        )
        mock_twin_service.get_twin.return_value = mock_twin

        response = client.get("/api/twin?layer=L1")

        assert response.status_code == 200
        data = response.json()
        assert "twin" in data
        # L1 should have metadata_astrology
        assert "metadata_astrology" in data["twin"]

    def test_get_twin_api_invalid_layer(self, client, mock_twin_service):
        """Test that invalid layer returns 400."""
        from models.twin import TwinData

        mock_twin = TwinData(twin_id=1, user_id=100)
        mock_twin_service.get_twin.return_value = mock_twin

        response = client.get("/api/twin?layer=invalid")

        assert response.status_code == 400


# =============================================================================
# Test GET /api/twin/history (TASK-1.3.2)
# =============================================================================

class TestGetTwinHistory:
    """Tests for GET /api/twin/history endpoint."""

    def test_get_history_default_params(self, client, mock_twin_service):
        """Test getting history with default parameters."""
        from models.twin import TwinHistoryResponse

        mock_twin_service.get_twin_history.return_value = TwinHistoryResponse(
            entries=[],
            total_count=0,
            limit=20,
            offset=0,
        )

        response = client.get("/api/twin/history")

        assert response.status_code == 200
        data = response.json()
        assert "entries" in data
        assert "total_count" in data
        assert data["limit"] == 20
        assert data["offset"] == 0

    def test_get_history_with_pagination(self, client, mock_twin_service):
        """Test getting history with pagination."""
        from models.twin import TwinHistoryResponse

        mock_twin_service.get_twin_history.return_value = TwinHistoryResponse(
            entries=[],
            total_count=100,
            limit=10,
            offset=20,
        )

        response = client.get("/api/twin/history?limit=10&offset=20")

        assert response.status_code == 200
        data = response.json()
        assert data["limit"] == 10
        assert data["offset"] == 20

    def test_get_history_with_filters(self, client, mock_twin_service):
        """Test getting history with filters."""
        from models.twin import TwinHistoryResponse, TwinLayer

        mock_twin_service.get_twin_history.return_value = TwinHistoryResponse(
            entries=[],
            total_count=5,
            limit=20,
            offset=0,
        )

        response = client.get("/api/twin/history?trigger_type=chat_insight&layer=L2")

        assert response.status_code == 200
        # Verify service was called with correct filters
        mock_twin_service.get_twin_history.assert_called_once()
        call_kwargs = mock_twin_service.get_twin_history.call_args[1]
        assert call_kwargs["trigger_type"] == "chat_insight"
        assert call_kwargs["layer"] == TwinLayer.L2

    def test_get_history_invalid_layer(self, client, mock_twin_service):
        """Test that invalid layer filter returns 400."""
        response = client.get("/api/twin/history?layer=invalid")

        assert response.status_code == 400


# =============================================================================
# Test GET /api/twin/dimensions
# =============================================================================

class TestGetDimensions:
    """Tests for GET /api/twin/dimensions endpoint."""

    def test_get_dimensions(self, client, mock_twin_service):
        """Test getting dimension scores."""
        from models.twin import TwinData, DimensionScores

        mock_twin = TwinData(
            twin_id=1,
            user_id=100,
            dimension_scores=DimensionScores(energy=70, clarity=65),
            overall_wellbeing=68.0,
            aura_points=150,
            growth_streak=7,
        )
        mock_twin_service.get_twin.return_value = mock_twin

        response = client.get("/api/twin/dimensions")

        assert response.status_code == 200
        data = response.json()
        assert "dimension_scores" in data
        assert data["dimension_scores"]["energy"] == 70
        assert data["overall_wellbeing"] == 68.0
        assert data["aura_points"] == 150
        assert data["growth_streak"] == 7


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
