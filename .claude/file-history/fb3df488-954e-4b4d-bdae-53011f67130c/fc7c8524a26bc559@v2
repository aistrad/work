"""
JITAI API Routes.

REQ: REQ-JITAI-003
Design: ยง3.5.1
"""

from __future__ import annotations

import hmac
import os
from typing import Any, Dict

from fastapi import APIRouter, Depends, Header, HTTPException, Request

from api.deps import require_auth
from common.logging import get_logger
from services import jitai_service

logger = get_logger(__name__)

router = APIRouter(prefix="/api/jitai", tags=["JITAI"])


# =============================================================================
# Cron Authentication
# =============================================================================

def verify_cron_secret(authorization: str = Header(...)) -> bool:
    """Verify cron secret for scheduled tasks."""
    if not authorization.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Invalid authorization format")

    token = authorization[7:]
    expected = os.getenv("CRON_SECRET", "").strip()

    if not expected:
        raise HTTPException(status_code=500, detail="CRON_SECRET not configured")

    if not hmac.compare_digest(token, expected):
        logger.warning("jitai_cron_auth_fail")
        raise HTTPException(status_code=401, detail="Unauthorized")

    return True


# =============================================================================
# Cron Endpoint (TASK-6.2.1)
# =============================================================================

@router.get("/cron")
async def run_jitai_cron(
    _auth: bool = Depends(verify_cron_secret),
) -> Dict[str, Any]:
    """
    Run JITAI evaluation for all active users.

    REQ: REQ-JITAI-003
    Design: ยง3.5.1

    This endpoint should be called by a cron job (e.g., every 15 minutes).
    Requires CRON_SECRET authentication.
    """
    try:
        result = jitai_service.run_jitai_cron()
        return result
    except Exception as e:
        logger.error("jitai_cron_error: %s", str(e))
        raise HTTPException(status_code=500, detail=str(e))


# =============================================================================
# User Endpoints
# =============================================================================

@router.get("/interventions")
async def get_pending_interventions(
    request: Request,
    auth: Dict[str, Any] = Depends(require_auth),
) -> Dict[str, Any]:
    """Get pending interventions for current user."""
    user_id = auth["user_id"]

    # Evaluate triggers for this user
    interventions = jitai_service.evaluate_jitai(user_id)

    return {
        "interventions": [
            {
                "trigger_id": i.trigger_id,
                "type": i.intervention_type.value,
                "content": i.content,
                "priority": i.priority,
            }
            for i in interventions
        ],
    }


@router.post("/interventions/{intervention_id}/click")
async def mark_intervention_clicked(
    intervention_id: int,
    request: Request,
    auth: Dict[str, Any] = Depends(require_auth),
) -> Dict[str, Any]:
    """Mark an intervention as clicked."""
    jitai_service.mark_intervention_clicked(intervention_id)
    return {"success": True}


@router.post("/interventions/{intervention_id}/dismiss")
async def mark_intervention_dismissed(
    intervention_id: int,
    request: Request,
    auth: Dict[str, Any] = Depends(require_auth),
) -> Dict[str, Any]:
    """Mark an intervention as dismissed."""
    jitai_service.mark_intervention_dismissed(intervention_id)
    return {"success": True}
