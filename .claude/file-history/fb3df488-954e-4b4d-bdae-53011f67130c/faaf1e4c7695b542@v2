"""
Tests for Agent Tool API Routes.

TASK-2.1.1~2.2.6: Tool API 端点测试
REQ: REQ-TOOL-001 ~ REQ-TOOL-006
"""

import os
import pytest
from unittest.mock import MagicMock, patch

from fastapi.testclient import TestClient


# =============================================================================
# Fixtures
# =============================================================================

@pytest.fixture
def service_token():
    """Test service token."""
    return "test_service_token_12345"


@pytest.fixture
def mock_env(service_token):
    """Mock environment variables."""
    with patch.dict(os.environ, {"AGENT_SERVICE_TOKEN": service_token}):
        yield


@pytest.fixture
def mock_fortune_db():
    """Mock fortune_db module."""
    with patch("api.agent_tool.fortune_db") as mock:
        yield mock


@pytest.fixture
def mock_twin_service():
    """Mock twin_service module."""
    with patch("api.agent_tool.twin_service") as mock:
        yield mock


@pytest.fixture
def client(mock_env):
    """Create test client."""
    from api.main import app
    return TestClient(app)


@pytest.fixture
def auth_headers(service_token):
    """Authorization headers with valid token."""
    return {"Authorization": f"Bearer {service_token}"}


# =============================================================================
# Test Authentication (TASK-2.1.1)
# =============================================================================

class TestToolApiAuth:
    """Tests for Tool API authentication."""

    def test_tool_api_no_token(self, client, mock_env):
        """Test that missing token returns 422 (validation error)."""
        response = client.get("/api/agent/tool/context?user_id=1")
        # FastAPI returns 422 for missing required header
        assert response.status_code == 422

    def test_tool_api_invalid_format(self, client, mock_env):
        """Test that invalid token format returns 401."""
        response = client.get(
            "/api/agent/tool/context?user_id=1",
            headers={"Authorization": "InvalidFormat token"}
        )
        assert response.status_code == 401

    def test_tool_api_invalid_token(self, client, mock_env):
        """Test that wrong token returns 401."""
        response = client.get(
            "/api/agent/tool/context?user_id=1",
            headers={"Authorization": "Bearer wrong_token"}
        )
        assert response.status_code == 401

    def test_tool_api_valid_token(self, client, auth_headers, mock_fortune_db, mock_twin_service):
        """Test that valid token allows access."""
        from models.twin import TwinData

        mock_twin_service.get_twin.return_value = TwinData(user_id=1)
        mock_fortune_db.fetch_all.return_value = []
        mock_fortune_db.fetch_one.return_value = None

        response = client.get(
            "/api/agent/tool/context?user_id=1",
            headers=auth_headers
        )
        assert response.status_code == 200


# =============================================================================
# Test GET /context (TASK-2.2.1)
# =============================================================================

class TestToolContext:
    """Tests for GET /api/agent/tool/context endpoint."""

    def test_tool_context_response_structure(self, client, auth_headers, mock_fortune_db, mock_twin_service):
        """Test context response has correct structure."""
        from models.twin import TwinData

        mock_twin_service.get_twin.return_value = TwinData(
            user_id=1,
            metadata_astrology={"bazi": "test"},
        )
        mock_fortune_db.fetch_all.return_value = []
        mock_fortune_db.fetch_one.return_value = None

        response = client.get(
            "/api/agent/tool/context?user_id=1",
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert "twin" in data
        assert "recent_messages" in data
        assert "active_commitments" in data
        assert "facts_hash" in data

    def test_tool_context_facts_hash(self, client, auth_headers, mock_fortune_db, mock_twin_service):
        """Test that facts_hash is 16 characters."""
        from models.twin import TwinData

        mock_twin_service.get_twin.return_value = TwinData(
            user_id=1,
            metadata_astrology={"bazi": {"day_master": "甲"}},
        )
        mock_fortune_db.fetch_all.return_value = []
        mock_fortune_db.fetch_one.return_value = None

        response = client.get(
            "/api/agent/tool/context?user_id=1",
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert len(data["facts_hash"]) == 16


# =============================================================================
# Test POST /commitment (TASK-2.2.2)
# =============================================================================

class TestToolCommitment:
    """Tests for POST /api/agent/tool/commitment endpoint."""

    def test_tool_create_commitment(self, client, auth_headers, mock_fortune_db):
        """Test creating a commitment."""
        mock_fortune_db.execute.return_value = 1

        response = client.post(
            "/api/agent/tool/commitment",
            headers=auth_headers,
            json={
                "user_id": 1,
                "title": "3分钟冥想",
                "category": "energy_boost",
                "aura_reward": 10,
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "commitment_id" in data
        assert data["status"] == "created"

    def test_tool_commitment_validation(self, client, auth_headers):
        """Test commitment validation."""
        response = client.post(
            "/api/agent/tool/commitment",
            headers=auth_headers,
            json={
                "user_id": 1,
                "title": "",  # Empty title should fail
            }
        )

        assert response.status_code == 422


# =============================================================================
# Test POST /twin_update (TASK-2.2.3)
# =============================================================================

class TestToolTwinUpdate:
    """Tests for POST /api/agent/tool/twin_update endpoint."""

    def test_tool_twin_update(self, client, auth_headers, mock_twin_service):
        """Test updating twin data."""
        from models.twin import TwinUpdateResult

        mock_twin_service.update_twin.return_value = TwinUpdateResult(
            updated=True,
            log_id=123,
            new_value="calm",
        )

        response = client.post(
            "/api/agent/tool/twin_update",
            headers=auth_headers,
            json={
                "user_id": 1,
                "layer": "L2",
                "path": "dynamic_emotional.current_mood",
                "new_value": "calm",
                "confidence": 0.85,
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert data["updated"] is True
        assert "log_id" in data

    def test_tool_twin_update_invalid_layer(self, client, auth_headers):
        """Test that invalid layer returns 400."""
        response = client.post(
            "/api/agent/tool/twin_update",
            headers=auth_headers,
            json={
                "user_id": 1,
                "layer": "invalid",
                "path": "dynamic_emotional.mood",
                "new_value": "happy",
            }
        )

        assert response.status_code == 400


# =============================================================================
# Test POST /share_card (TASK-2.2.4)
# =============================================================================

class TestToolShareCard:
    """Tests for POST /api/agent/tool/share_card endpoint."""

    def test_tool_create_share_card(self, client, auth_headers, mock_fortune_db):
        """Test creating a share card."""
        mock_fortune_db.execute.return_value = 1

        response = client.post(
            "/api/agent/tool/share_card",
            headers=auth_headers,
            json={
                "user_id": 1,
                "card_type": "daily_guidance",
                "content": {"title": "今日指引", "body": "保持积极心态"},
            }
        )

        assert response.status_code == 200
        data = response.json()
        assert "card_id" in data
        assert "share_url" in data

    def test_tool_share_card_invalid_type(self, client, auth_headers):
        """Test that invalid card type returns 422."""
        response = client.post(
            "/api/agent/tool/share_card",
            headers=auth_headers,
            json={
                "user_id": 1,
                "card_type": "invalid_type",
                "content": {},
            }
        )

        assert response.status_code == 422


# =============================================================================
# Test GET /facts/{user_id} (TASK-2.2.5)
# =============================================================================

class TestToolFacts:
    """Tests for GET /api/agent/tool/facts/{user_id} endpoint."""

    def test_tool_get_facts(self, client, auth_headers, mock_fortune_db):
        """Test getting bazi facts."""
        mock_fortune_db.fetch_one.return_value = {
            "facts": {"day_master": "甲", "month_branch": "子"},
            "facts_hash": "abc123def456",
        }

        response = client.get(
            "/api/agent/tool/facts/1",
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert data["user_id"] == 1
        assert data["bazi"] is not None
        assert data["facts_hash"] == "abc123def456"

    def test_tool_get_facts_no_data(self, client, auth_headers, mock_fortune_db):
        """Test getting facts when no bazi data exists."""
        mock_fortune_db.fetch_one.return_value = None

        response = client.get(
            "/api/agent/tool/facts/999",
            headers=auth_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert data["user_id"] == 999
        assert data["bazi"] is None
        assert data["facts_hash"] is None


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
