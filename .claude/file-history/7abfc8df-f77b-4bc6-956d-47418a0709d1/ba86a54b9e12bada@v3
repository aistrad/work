"""
ContentGenerator - ä¸ªæ€§åŒ–å†…å®¹ç”Ÿæˆå™¨ (v9.0)

ç‰¹ç‚¹:
1. åŸºäº VibeProfile ä¸‰å±‚æ¶æ„ä¸ªæ€§åŒ–
2. æ”¯æŒå¤šç§è¯­æ°”é£æ ¼ (voice_mode)
3. ä½¿ç”¨ LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€å†…å®¹
4. æ”¯æŒå¤ç”¨ rules/ æ¶æ„ç”Ÿæˆå†…å®¹
5. æ”¯æŒå¯¹è¯å¼•å¯¼é…ç½®
6. æ”¯æŒçº¯æ¨¡æ¿é…ç½®ï¼ˆæ— éœ€ LLMï¼‰

è®¾è®¡åŸåˆ™:
- ä» unified_profiles è¯»å–ç”¨æˆ·ç”»åƒ
- æ”¯æŒ Skill çº§å†…å®¹æ¨¡æ¿
- æ™ºèƒ½åŒ–: åŸºäºç”¨æˆ·å…³æ³¨ç‚¹å’Œç›®æ ‡ä¸ªæ€§åŒ–
- å¤ç”¨ rules/*.md çš„åˆ†æè¦ç‚¹å’Œæ£€ç´¢ Query

v9.0 æ•°æ®è·å–ï¼ˆä¸‰å±‚æ¶æ„ï¼‰:
- profile.identity: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- profile.skills.{skill_id}: Skill æ•°æ®
- profile.vibe.insight: ç”¨æˆ·ç”»åƒ
- profile.vibe.target: ç”¨æˆ·ç›®æ ‡

ç”Ÿæˆç­–ç•¥ä¼˜å…ˆçº§:
1. rules/ æ¶æ„ - generator æŒ‡å‘ rules/*.mdï¼Œä½¿ç”¨ Rule + LLM ç”Ÿæˆ
2. templates é…ç½® - æœ‰ templates ä½†æ—  generatorï¼Œçº¯æ¨¡æ¿å˜é‡æ›¿æ¢
3. ä¸“ç”¨ç”Ÿæˆå™¨ - ä½¿ç”¨ç¡¬ç¼–ç ç”Ÿæˆå™¨ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
4. é»˜è®¤ç”Ÿæˆå™¨ - ä½¿ç”¨ config.name/description
"""

import json
import logging
from datetime import date
from typing import Dict, Any, List

from services.llm import LLMService
from services.knowledge.rag_service import RAGService
from services.agent.skill_loader import load_rule
from .engine import ReminderTask, ReminderContent

logger = logging.getLogger(__name__)


def get_skill_data_compat(profile: Dict[str, Any], skill_id: str) -> Dict[str, Any]:
    """
    è·å– Skill æ•°æ®

    v9.0: åªä» skills.{skill_id} è¯»å–
    """
    return profile.get("skills", {}).get(skill_id, {})


def get_user_context_compat(profile: Dict[str, Any]) -> Dict[str, Any]:
    """
    è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡

    v9.0: åªä» vibe è¯»å–
    """
    result = {
        "concerns": [],
        "goals": [],
        "current_focus": "career",
    }

    vibe = profile.get("vibe", {})
    target = vibe.get("target", {})

    if target:
        goals = target.get("goals", [])
        if goals:
            result["goals"] = [g.get("title", "") for g in goals if g.get("status") == "in_progress"][:3]

        focus = target.get("focus", {})
        if focus.get("primary"):
            result["current_focus"] = focus["primary"]

        # ä» vibe.insight.pattern è¯»å– concerns
        insight = vibe.get("insight", {})
        pattern = insight.get("pattern", {})
        if pattern.get("concerns"):
            result["concerns"] = pattern["concerns"][:3]

    return result


class ContentGenerator:
    """ä¸ªæ€§åŒ–å†…å®¹ç”Ÿæˆå™¨"""

    def __init__(self):
        self._llm_service = None

    @property
    def llm_service(self):
        """å»¶è¿ŸåŠ è½½ LLM æœåŠ¡"""
        if self._llm_service is None:
            self._llm_service = LLMService()
        return self._llm_service

    def _get_template(
        self,
        config: Dict[str, Any],
        key: str,
        default: str,
        **format_args,
    ) -> str:
        """
        ä»é…ç½®æ¨¡æ¿ä¸­è·å–æ–‡æ¡ˆ

        Args:
            config: æé†’é…ç½®
            key: æ¨¡æ¿é”®å (å¦‚ "title", "body", "body_day0")
            default: é»˜è®¤å€¼
            **format_args: æ ¼å¼åŒ–å‚æ•°

        Returns:
            æ ¼å¼åŒ–åçš„æ–‡æ¡ˆ
        """
        content_config = config.get("content", {})
        templates = content_config.get("templates", {})
        template = templates.get(key, default)

        try:
            return template.format(**format_args) if format_args else template
        except KeyError:
            # å¦‚æœæ ¼å¼åŒ–å¤±è´¥ï¼Œè¿”å›åŸæ¨¡æ¿
            return template

    async def generate(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """
        ç”Ÿæˆä¸ªæ€§åŒ–æé†’å†…å®¹

        Args:
            task: æé†’ä»»åŠ¡
            profile: ç”¨æˆ·ç”»åƒ (from unified_profiles)
            config: æé†’é…ç½® (from reminders.yaml)

        Returns:
            ReminderContent

        ç”Ÿæˆç­–ç•¥ä¼˜å…ˆçº§:
        1. rules/ æ¶æ„ - ä½¿ç”¨ Rule æ–‡ä»¶ + LLM ç”Ÿæˆ
        2. templates é…ç½® - ä½¿ç”¨é…ç½®æ¨¡æ¿ + å˜é‡æ›¿æ¢
        3. ä¸“ç”¨ç”Ÿæˆå™¨ - ä½¿ç”¨ç¡¬ç¼–ç ç”Ÿæˆå™¨ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
        4. é»˜è®¤ç”Ÿæˆå™¨ - ä½¿ç”¨ config.name/description
        """
        reminder_type = task.reminder_type
        content_config = config.get("content", {})
        generator_path = content_config.get("generator", "")
        templates = content_config.get("templates", {})

        # ç­–ç•¥1: rules/ æ¶æ„
        if generator_path.startswith("rules/"):
            content = await self._generate_from_rule(
                task=task,
                profile=profile,
                config=config,
                generator_path=generator_path,
            )
        # ç­–ç•¥2: çº¯æ¨¡æ¿é…ç½®ï¼ˆæœ‰ templates ä½†æ—  rules/ï¼‰
        elif templates and not generator_path:
            content = await self._generate_from_template(
                task=task,
                profile=profile,
                config=config,
            )
        # ç­–ç•¥3: ä¸“ç”¨ç”Ÿæˆå™¨ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
        else:
            generator_map = {
                # Bazi
                "daily_fortune": self._generate_daily_fortune,
                "dayun_transition": self._generate_dayun_transition,
                "fortune_alert": self._generate_fortune_alert,
                # Zodiac
                "daily_horoscope": self._generate_daily_horoscope,
                "transit_alert": self._generate_transit_alert,
                "lunar_phase": self._generate_lunar_phase,
                "solar_term": self._generate_solar_term,
                # Core
                "weekly_summary": self._generate_weekly_summary,
                "monthly_report": self._generate_monthly_report,
                # Common
                "birthday": self._generate_birthday,
                "liunian": self._generate_liunian,
            }

            generator = generator_map.get(reminder_type)
            if generator:
                content = await generator(task, profile, config)
            else:
                # ç­–ç•¥4: é»˜è®¤ç”Ÿæˆå™¨
                content = await self._generate_default(task, profile, config)

        # é™„åŠ å¯¹è¯å¼•å¯¼é…ç½®
        content.suggested_prompt = content_config.get("suggested_prompt")
        content.quick_actions = content_config.get("quick_actions", [])
        content.card_type = content_config.get("card_type")

        return content

    async def _generate_from_template(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """
        åŸºäºé…ç½®æ¨¡æ¿ç”Ÿæˆå†…å®¹ï¼ˆçº¯æ¨¡æ¿æ›¿æ¢ï¼Œä¸ä½¿ç”¨ LLMï¼‰

        é€‚ç”¨äºç®€å•çš„é€šçŸ¥åœºæ™¯ï¼Œç›´æ¥ä½¿ç”¨ templates é…ç½®ä¸­çš„æ–‡æ¡ˆ
        """
        event_info = task.metadata.get("event_info", {})
        user_context = get_user_context_compat(profile)
        skill_data = get_skill_data_compat(profile, task.skill_id)
        chart = skill_data.get("chart", {})

        # æ„å»ºæ¨¡æ¿å˜é‡
        template_vars = {
            # äº‹ä»¶ä¿¡æ¯
            "event_name": event_info.get("event_name", ""),
            "days_until": event_info.get("days_until", 0),
            "phase": event_info.get("phase", ""),
            "description": event_info.get("description", ""),
            "score": event_info.get("value", 0),
            "threshold": event_info.get("threshold", 0),
            # ç”¨æˆ·ä¿¡æ¯
            "sun_sign": chart.get("sun_sign", ""),
            "moon_sign": chart.get("moon_sign", ""),
            "element": chart.get("day_master", {}).get("element", ""),
            # æ—¥æœŸ
            "date": date.today().strftime("%Yå¹´%mæœˆ%dæ—¥"),
            "year": date.today().year,
            "month_name": date.today().strftime("%Yå¹´%mæœˆ"),
        }

        # è·å–æ¨¡æ¿é…ç½®
        content_config = config.get("content", {})
        templates = content_config.get("templates", {})

        # é€‰æ‹©åˆé€‚çš„æ¨¡æ¿é”®
        days_until = template_vars.get("days_until", 0)
        phase = template_vars.get("phase", "")

        # æ ‡é¢˜æ¨¡æ¿é€‰æ‹©
        if days_until == 0 and "title_day0" in templates:
            title_key = "title_day0"
        elif days_until == 7 and "title_day7" in templates:
            title_key = "title_day7"
        else:
            title_key = "title"

        # æ­£æ–‡æ¨¡æ¿é€‰æ‹©
        if days_until == 0 and "body_day0" in templates:
            body_key = "body_day0"
        elif days_until == 7 and "body_day7" in templates:
            body_key = "body_day7"
        elif phase == "new_moon" and "body_new_moon" in templates:
            body_key = "body_new_moon"
        elif phase == "full_moon" and "body_full_moon" in templates:
            body_key = "body_full_moon"
        elif "body_default" in templates:
            body_key = "body_default"
        else:
            body_key = "body"

        # è·å–å¹¶æ ¼å¼åŒ–æ¨¡æ¿
        title = self._get_template(config, title_key, config.get("name", "é€šçŸ¥"), **template_vars)
        body = self._get_template(config, body_key, config.get("description", ""), **template_vars)

        # æ„å»º data
        data = {
            "event_name": template_vars.get("event_name"),
            "days_until": template_vars.get("days_until"),
            "concerns": user_context.get("concerns", [])[:3],
        }

        # æ·»åŠ  suggestionsï¼ˆå¦‚æœé…ç½®ä¸­æœ‰ï¼‰
        if "suggestions" in templates:
            data["suggestions"] = templates["suggestions"]

        return ReminderContent(
            title=title,
            body=body,
            data=data,
        )

    async def _generate_from_rule(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
        generator_path: str,
    ) -> ReminderContent:
        """
        åŸºäº Rule æ–‡ä»¶ç”Ÿæˆå†…å®¹

        æµç¨‹:
        1. åŠ è½½ rule æ–‡ä»¶
        2. æå–åˆ†æè¦ç‚¹å’Œæ£€ç´¢ Query
        3. æ‰§è¡ŒçŸ¥è¯†æ£€ç´¢
        4. è°ƒç”¨ LLM ç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹
        """
        skill_id = task.skill_id

        # è§£æ rule è·¯å¾„: rules/daily-fortune.md -> daily-fortune
        rule_id = generator_path.replace("rules/", "").replace(".md", "")

        # åŠ è½½ rule
        rule = load_rule(skill_id, rule_id)
        if not rule:
            logger.warning(f"Rule not found: {skill_id}/{rule_id}, falling back to default")
            return await self._generate_default(task, profile, config)

        # æ‰§è¡ŒçŸ¥è¯†æ£€ç´¢
        knowledge_context = []
        for step in rule.analysis_steps:
            query = step.get("query", "").strip('"')
            if query and step.get("priority") in ["å¿…é¡»", "æ¨è"]:
                try:
                    chunks = await RAGService.get_knowledge(
                        query=query,
                        skill_id=skill_id,
                        top_k=3,
                    )
                    # è½¬æ¢ä¸ºå…¼å®¹æ ¼å¼
                    for chunk in chunks:
                        knowledge_context.append({
                            "content": chunk.content,
                            "section_title": chunk.section_title,
                        })
                except Exception as e:
                    logger.warning(f"Knowledge search failed for query '{query}': {e}")

        # è·å–ç”¨æˆ·ç‰¹å¾ (v8.0 å…¼å®¹å±‚)
        user_context = get_user_context_compat(profile)
        preferences = profile.get("preferences", {})
        voice_mode = preferences.get("voice_mode", "warm")

        # æ„å»º prompt
        context_str = "\n".join([
            f"- {chunk.get('content', '')[:200]}"
            for chunk in knowledge_context[:5]
        ]) if knowledge_context else "æ— ç›¸å…³çŸ¥è¯†"

        concerns = user_context.get("concerns", [])
        goals = user_context.get("goals", [])

        # ä½¿ç”¨ LLM ç”Ÿæˆå†…å®¹
        llm_result = await self._generate_with_llm(
            template_type="rule_based",
            context={
                "rule_name": rule.name,
                "rule_content": rule.content[:1000],  # æˆªæ–­é¿å…è¿‡é•¿
                "knowledge_context": context_str,
                "concerns": concerns[:3] if concerns else [],
                "goals": goals[:2] if goals else [],
                "date": date.today().strftime("%Yå¹´%mæœˆ%dæ—¥"),
            },
            voice_mode=voice_mode,
        )

        # ä½¿ç”¨é…ç½®æ¨¡æ¿è·å– title/bodyï¼ŒLLM ç»“æœä½œä¸º fallback
        title = self._get_template(config, "title", config.get("name", rule.name))
        body = llm_result.get("greeting") or self._get_template(
            config, "body_default", f"å…³äº{rule.name}çš„æ´å¯Ÿ"
        )

        return ReminderContent(
            title=title,
            body=body,
            data={
                "rule_id": rule_id,
                "fortune_hint": llm_result.get("fortune_hint", ""),
                "action_tip": llm_result.get("action_tip", ""),
            },
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Bazi å†…å®¹ç”Ÿæˆå™¨
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async def _generate_daily_fortune(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """
        ç”Ÿæˆæ¯æ—¥è¿åŠ¿

        v2.0 ä¼˜åŒ–ï¼š
        - æ ¹æ® life_context.current_focus ä¸ªæ€§åŒ– headline
        - ç”Ÿæˆè¡ŒåŠ¨å¯¼å‘çš„ insightsï¼ˆå…·ä½“æ—¶é—´ + è¡ŒåŠ¨ï¼‰
        - ä½¿ç”¨èƒ½é‡æ›²çº¿æä¾›æœ€ä½³æ—¶æ®µå»ºè®®
        """
        # æå–ç”¨æˆ·ç‰¹å¾ (v8.0 å…¼å®¹å±‚)
        identity = profile.get("identity", {})
        birth_info = identity.get("birth_info", {})
        user_context = get_user_context_compat(profile)
        preferences = profile.get("preferences", {})
        skill_data = get_skill_data_compat(profile, "bazi")

        # è·å–æ—¥ä¸»å…ƒç´ 
        chart = skill_data.get("chart", {})
        day_master = chart.get("day_master", {})
        day_master_element = day_master.get("element", "wood")

        # v2.0: è·å–ç”¨æˆ·å½“å‰å…³æ³¨é¢†åŸŸ
        current_focus = user_context.get("current_focus", "career")  # career | wealth | romance | health
        concerns = user_context.get("concerns", [])
        goals = user_context.get("goals", [])
        voice_mode = preferences.get("voice_mode", "warm")

        # è®¡ç®—ä»Šæ—¥è¿åŠ¿
        from skills.bazi.services import BaziComputer
        computer = BaziComputer()
        daily_fortune = await computer.calculate_daily_fortune(profile)

        # v2.0: æå–æ–°å¢çš„æ•°æ®
        energy_curve = daily_fortune.get("energy_curve", [])
        area_scores = daily_fortune.get("area_scores", {})

        # v2.0: ç”Ÿæˆä¸ªæ€§åŒ– headline
        headline = self._generate_personalized_headline(
            current_focus=current_focus,
            area_scores=area_scores,
            day_element=daily_fortune.get("element", "wood"),
        )

        # v2.0: ç”Ÿæˆè¡ŒåŠ¨å¯¼å‘ insights
        insights = self._generate_action_insights(
            current_focus=current_focus,
            energy_curve=energy_curve,
            area_scores=area_scores,
            highlights=daily_fortune.get("highlights", []),
        )

        # v2.0: æ„å»º focused_area æ•°æ®ï¼ˆå‰ç«¯å±•ç¤ºç”¨ï¼‰
        focused_area = {
            "name": self._get_focus_name(current_focus),
            "score": area_scores.get(current_focus, daily_fortune.get("score", 60)) // 20,  # è½¬ä¸º 1-5 åˆ†
            "emoji": self._get_focus_emoji(current_focus),
            "tip": headline,
        }

        return ReminderContent(
            title=self._get_template(config, "title", "ä»Šæ—¥è¿åŠ¿"),
            body=headline,  # v2.0: ä½¿ç”¨ä¸ªæ€§åŒ– headline
            data={
                "headline": headline,
                "insights": insights,
                "rating": {
                    "overall": daily_fortune.get("score", 60) // 20,  # è½¬ä¸º 1-5 åˆ†
                    "focused_area": focused_area,
                    "details": {
                        "äº‹ä¸š": area_scores.get("career", 60) // 20,
                        "è´¢è¿": area_scores.get("wealth", 60) // 20,
                        "æ„Ÿæƒ…": area_scores.get("romance", 60) // 20,
                        "å¥åº·": area_scores.get("health", 60) // 20,
                    }
                },
                "energy_curve": energy_curve,
                "fortune_score": daily_fortune.get("score", 60),
                "element": day_master_element,
            },
        )

    def _generate_personalized_headline(
        self,
        current_focus: str,
        area_scores: Dict[str, int],
        day_element: str,
    ) -> str:
        """ç”Ÿæˆä¸ªæ€§åŒ– headline"""
        focus_score = area_scores.get(current_focus, 60)

        # å…ƒç´ å¯¹åº”ä¸»é¢˜
        element_themes = {
            "wood": "æˆé•¿",
            "fire": "å±•ç°",
            "earth": "ç§¯ç´¯",
            "metal": "æ”¶è·",
            "water": "æ€è€ƒ",
        }
        theme = element_themes.get(day_element, "è¡ŒåŠ¨")

        # æ ¹æ®åˆ†æ•°å’Œå…³æ³¨é¢†åŸŸç”Ÿæˆ headline
        if focus_score >= 80:
            return f"ä»Šå¤©å¾ˆé€‚åˆæ¨è¿›ä½ çš„{self._get_focus_name(current_focus)}ç›®æ ‡"
        elif focus_score >= 60:
            return f"ä»Šå¤©æ˜¯{theme}çš„å¥½æ—¶æœºï¼Œä¸“æ³¨{self._get_focus_name(current_focus)}"
        else:
            return f"ä»Šå¤©é€‚åˆä¼‘æ•´ï¼Œä¸º{self._get_focus_name(current_focus)}ç§¯è“„èƒ½é‡"

    def _generate_action_insights(
        self,
        current_focus: str,
        energy_curve: List[Dict],
        area_scores: Dict[str, int],
        highlights: List[str],
    ) -> List[str]:
        """ç”Ÿæˆè¡ŒåŠ¨å¯¼å‘çš„ insights"""
        insights = []

        # 1. æ ¹æ®èƒ½é‡æ›²çº¿æ‰¾åˆ°æœ€ä½³æ—¶æ®µ
        if energy_curve:
            best_hour = max(energy_curve, key=lambda x: x.get("energy", 0))
            hour = best_hour.get("hour", 9)
            energy = best_hour.get("energy", 60)

            if energy >= 70:
                time_range = f"{hour:02d}:00-{hour+2:02d}:00"
                insights.append(f"ä¸Šåˆ {time_range} èƒ½é‡æœ€ä½³ï¼Œå®‰æ’é‡è¦å·¥ä½œ")

        # 2. æ ¹æ®å…³æ³¨é¢†åŸŸæä¾›å…·ä½“å»ºè®®
        focus_score = area_scores.get(current_focus, 60)

        if current_focus == "career":
            if focus_score >= 70:
                insights.append("é€‚åˆä¸»åŠ¨æ²Ÿé€šã€æ¨è¿›é¡¹ç›®ã€å±•ç¤ºæˆæœ")
            else:
                insights.append("é€‚åˆå®ŒæˆåŸºç¡€ä»»åŠ¡ã€æ•´ç†æ€è·¯")
        elif current_focus == "wealth":
            if focus_score >= 70:
                insights.append("è´¢è¿é¡ºç•…ï¼Œé€‚åˆå•†åŠ¡æ´½è°ˆã€æŠ•èµ„å†³ç­–")
            else:
                insights.append("ä¿å®ˆä¸ºå®œï¼Œé¿å…å†²åŠ¨æ¶ˆè´¹")
        elif current_focus == "romance":
            if focus_score >= 70:
                insights.append("æ„Ÿæƒ…è¿ä½³ï¼Œä¸»åŠ¨è¡¨è¾¾èƒ½è·å¾—ç§¯æå›åº”")
            else:
                insights.append("å¤šå€¾å¬å°‘äº‰æ‰§ï¼Œç»™å½¼æ­¤ç©ºé—´")
        elif current_focus == "health":
            if focus_score >= 70:
                insights.append("èº«ä½“çŠ¶æ€è‰¯å¥½ï¼Œé€‚åˆè¿åŠ¨é”»ç‚¼")
            else:
                insights.append("æ³¨æ„ä¼‘æ¯ï¼Œé¿å…è¿‡åº¦åŠ³ç´¯")

        # 3. è¡¥å……é€šç”¨å»ºè®®ï¼ˆæœ€å¤š 3 æ¡ï¼‰
        if len(insights) < 3 and highlights:
            insights.append(highlights[0])

        return insights[:3]  # æœ€å¤šè¿”å› 3 æ¡

    def _get_focus_name(self, focus: str) -> str:
        """è·å–å…³æ³¨é¢†åŸŸçš„ä¸­æ–‡åç§°"""
        names = {
            "career": "äº‹ä¸š",
            "wealth": "è´¢å¯Œ",
            "romance": "æ„Ÿæƒ…",
            "health": "å¥åº·",
        }
        return names.get(focus, "ç»¼åˆ")

    def _get_focus_emoji(self, focus: str) -> str:
        """è·å–å…³æ³¨é¢†åŸŸçš„ emoji"""
        emojis = {
            "career": "ğŸ’¼",
            "wealth": "ğŸ’°",
            "romance": "ğŸ’•",
            "health": "ğŸ’ª",
        }
        return emojis.get(focus, "ğŸŒŸ")

    async def _generate_dayun_transition(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆå¤§è¿äº¤æ¥æé†’"""
        event_info = task.metadata.get("event_info", {})
        event_name = event_info.get("event_name", "å¤§è¿äº¤æ¥")
        days_until = event_info.get("days_until", 0)

        user_context = get_user_context_compat(profile)
        concerns = user_context.get("concerns", [])

        # æ ¹æ® days_until é€‰æ‹©æ¨¡æ¿
        if days_until == 0:
            title = self._get_template(config, "title_day0", "å¤§è¿äº¤æ¥æ—¥")
            body = self._get_template(
                config, "body_day0",
                "ä»Šå¤©æ˜¯æ‚¨çš„{event_name}ï¼Œè¿™æ˜¯äººç”Ÿé‡è¦çš„è½¬æŠ˜ç‚¹ã€‚æ–°çš„åå¹´å‘¨æœŸå¼€å§‹ï¼ŒæŠŠæ¡æœºé‡ï¼Œè¿æ¥å˜åŒ–ã€‚",
                event_name=event_name,
            )
        elif days_until == 7:
            title = self._get_template(config, "title_day7", "å¤§è¿äº¤æ¥å€’è®¡æ—¶")
            body = self._get_template(
                config, "body_day7",
                "è¿˜æœ‰7å¤©ï¼Œæ‚¨å°†è¿æ¥{event_name}ã€‚è¿™æ˜¯äººç”Ÿçš„é‡è¦èŠ‚ç‚¹ï¼Œå»ºè®®æå‰åšå¥½å¿ƒç†å‡†å¤‡ã€‚",
                event_name=event_name,
            )
        else:
            title = self._get_template(config, "title_default", "å¤§è¿äº¤æ¥é¢„å‘Š")
            body = self._get_template(
                config, "body_default",
                "è¿˜æœ‰{days_until}å¤©ï¼Œæ‚¨å°†è¿æ¥{event_name}ã€‚æ–°çš„å‘¨æœŸå³å°†å¼€å§‹ï¼Œæ˜¯æ—¶å€™è§„åˆ’æœªæ¥äº†ã€‚",
                event_name=event_name,
                days_until=days_until,
            )

        return ReminderContent(
            title=title,
            body=body,
            data={
                "event_name": event_name,
                "days_until": days_until,
                "concerns": concerns[:3] if concerns else [],
            },
        )

    async def _generate_fortune_alert(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆè¿åŠ¿é¢„è­¦"""
        event_info = task.metadata.get("event_info", {})
        score = event_info.get("value", 40)
        threshold = event_info.get("threshold", 40)

        user_context = get_user_context_compat(profile)
        concerns = user_context.get("concerns", [])

        # ä»é…ç½®è·å– suggestions
        content_config = config.get("content", {})
        templates = content_config.get("templates", {})
        suggestions = templates.get("suggestions", ["é¿å…å†²åŠ¨å†³ç­–", "æ³¨æ„ä¼‘æ¯", "å¤šä¸äº²å‹äº¤æµ"])

        return ReminderContent(
            title=self._get_template(config, "title", "è¿åŠ¿æé†’"),
            body=self._get_template(
                config, "body",
                "è¿‘æœŸè¿åŠ¿èƒ½é‡è¾ƒä½ï¼ˆ{score}åˆ†ï¼‰ï¼Œå»ºè®®æ”¾æ…¢è„šæ­¥ï¼Œé¿å…é‡å¤§å†³ç­–ã€‚è¿™æ˜¯è°ƒæ•´å’Œç§¯è“„èƒ½é‡çš„å¥½æ—¶æœºã€‚",
                score=score,
            ),
            data={
                "fortune_score": score,
                "threshold": threshold,
                "concerns": concerns[:3] if concerns else [],
                "suggestions": suggestions,
            },
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Zodiac å†…å®¹ç”Ÿæˆå™¨
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async def _generate_daily_horoscope(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆæ¯æ—¥æ˜Ÿåº§è¿åŠ¿ (v8.0 å…¼å®¹å±‚)"""
        skill_data = get_skill_data_compat(profile, "zodiac")
        chart = skill_data.get("chart", {})

        sun_sign = chart.get("sun_sign", "")
        moon_sign = chart.get("moon_sign", "")

        user_context = get_user_context_compat(profile)
        concerns = user_context.get("concerns", [])

        return ReminderContent(
            title=self._get_template(config, "title", "ä»Šæ—¥æ˜Ÿåº§è¿åŠ¿"),
            body=self._get_template(
                config, "body",
                "ä½œä¸º{sun_sign}åº§ï¼Œä»Šå¤©çš„èƒ½é‡é€‚åˆä¸“æ³¨å†…å¿ƒï¼Œå€¾å¬ç›´è§‰ã€‚",
                sun_sign=sun_sign,
            ),
            data={
                "sun_sign": sun_sign,
                "moon_sign": moon_sign,
                "concerns": concerns[:3] if concerns else [],
            },
        )

    async def _generate_transit_alert(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆè¡Œè¿æé†’"""
        event_info = task.metadata.get("event_info", {})
        event_name = event_info.get("event_name", "è¡Œæ˜Ÿè¿‡å¢ƒ")
        transit_type = event_info.get("transit_type", "")

        return ReminderContent(
            title=self._get_template(
                config, "title", "æ˜Ÿè±¡æé†’ï¼š{event_name}",
                event_name=event_name,
            ),
            body=self._get_template(
                config, "body",
                "ä»Šæ—¥{event_name}å¼€å§‹ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦çš„å®‡å®™èƒ½é‡è½¬æ¢æœŸã€‚",
                event_name=event_name,
            ),
            data={
                "event_name": event_name,
                "transit_type": transit_type,
            },
        )

    async def _generate_lunar_phase(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆæœˆç›¸æé†’"""
        event_info = task.metadata.get("event_info", {})
        event_name = event_info.get("event_name", "æœˆç›¸")
        phase = event_info.get("phase", "")

        # æ ¹æ® phase é€‰æ‹©æ¨¡æ¿
        if phase == "new_moon":
            body = self._get_template(
                config, "body_new_moon",
                "æ–°æœˆæ˜¯æ’­ç§æ„å›¾çš„å¥½æ—¶æœºã€‚å†™ä¸‹ä½ çš„æ„¿æœ›ï¼Œè®¾å®šæ–°çš„ç›®æ ‡ã€‚",
            )
        elif phase == "full_moon":
            body = self._get_template(
                config, "body_full_moon",
                "æ»¡æœˆæ˜¯æ”¶è·å’Œé‡Šæ”¾çš„æ—¶åˆ»ã€‚åº†ç¥ä½ çš„æˆå°±ï¼Œæ”¾ä¸‹ä¸å†éœ€è¦çš„ã€‚",
            )
        else:
            body = self._get_template(
                config, "body_default",
                "ä»Šæ—¥{event_name}ï¼Œæ˜¯è°ƒæ•´èƒ½é‡çš„å¥½æ—¶æœºã€‚",
                event_name=event_name,
            )

        return ReminderContent(
            title=self._get_template(
                config, "title", "æœˆç›¸æé†’ï¼š{event_name}",
                event_name=event_name,
            ),
            body=body,
            data={
                "event_name": event_name,
                "phase": phase,
            },
        )

    async def _generate_solar_term(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”ŸæˆèŠ‚æ°”æé†’"""
        event_info = task.metadata.get("event_info", {})
        event_name = event_info.get("event_name", "èŠ‚æ°”")
        description = event_info.get("description", "")

        return ReminderContent(
            title=self._get_template(
                config, "title", "èŠ‚æ°”ï¼š{event_name}",
                event_name=event_name,
            ),
            body=description or self._get_template(
                config, "body",
                "ä»Šæ—¥{event_name}ï¼Œé¡ºåº”è‡ªç„¶èŠ‚å¾‹ï¼Œè°ƒæ•´ç”Ÿæ´»ä½œæ¯ã€‚",
                event_name=event_name,
            ),
            data={
                "event_name": event_name,
                "description": description,
            },
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # Core å†…å®¹ç”Ÿæˆå™¨
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async def _generate_weekly_summary(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆæ¯å‘¨æ€»ç»“ (v8.0 å…¼å®¹å±‚)"""
        user_context = get_user_context_compat(profile)
        concerns = user_context.get("concerns", [])
        goals = user_context.get("goals", [])

        return ReminderContent(
            title=self._get_template(config, "title", "æœ¬å‘¨è¿åŠ¿å›é¡¾"),
            body=self._get_template(config, "body", "æ–°çš„ä¸€å‘¨å¼€å§‹äº†ï¼å›é¡¾è¿‡å»ï¼Œå±•æœ›æœªæ¥ï¼Œä¿æŒç§¯æå¿ƒæ€ã€‚"),
            data={
                "concerns": concerns[:3] if concerns else [],
                "goals": goals[:2] if goals else [],
            },
        )

    async def _generate_monthly_report(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆæ¯æœˆæŠ¥å‘Š"""
        today = date.today()
        month_name = today.strftime("%Yå¹´%mæœˆ")

        return ReminderContent(
            title=self._get_template(
                config, "title", "{month_name}è¿åŠ¿æŠ¥å‘Š",
                month_name=month_name,
            ),
            body=self._get_template(
                config, "body",
                "æ–°çš„æœˆä»½å¼€å§‹äº†ï¼{month_name}çš„èƒ½é‡ä¸»é¢˜æ˜¯æˆé•¿ä¸çªç ´ã€‚",
                month_name=month_name,
            ),
            data={
                "month": today.month,
                "year": today.year,
            },
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # é€šç”¨å†…å®¹ç”Ÿæˆå™¨
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async def _generate_birthday(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆç”Ÿæ—¥æé†’"""
        event_info = task.metadata.get("event_info", {})
        days_until = event_info.get("days_until", 0)

        if days_until == 0:
            return ReminderContent(
                title=self._get_template(config, "title_day0", "ç”Ÿæ—¥å¿«ä¹ï¼"),
                body=self._get_template(config, "body_day0", "ç¥æ‚¨ç”Ÿæ—¥å¿«ä¹ï¼æ–°çš„ä¸€å²ï¼Œæ–°çš„å¼€å§‹ï¼Œæ„¿æ‚¨å¿ƒæƒ³äº‹æˆï¼"),
                data={"days_until": 0},
            )
        else:
            return ReminderContent(
                title=self._get_template(config, "title_countdown", "ç”Ÿæ—¥å€’è®¡æ—¶"),
                body=self._get_template(
                    config, "body_countdown",
                    "æ‚¨çš„ç”Ÿæ—¥è¿˜æœ‰{days_until}å¤©ï¼æ–°çš„ä¸€å²å³å°†å¼€å§‹ã€‚",
                    days_until=days_until,
                ),
                data={"days_until": days_until},
            )

    async def _generate_liunian(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """ç”Ÿæˆæµå¹´è¿åŠ¿"""
        from skills.bazi.services import BaziComputer

        computer = BaziComputer()
        year = date.today().year
        annual_fortune = await computer.calculate_annual_fortune(profile, year)
        theme = annual_fortune.get("theme", "ç¨³æ­¥å‰è¿›")

        return ReminderContent(
            title=self._get_template(
                config, "title", "{year}å¹´è¿åŠ¿",
                year=year,
            ),
            body=self._get_template(
                config, "body",
                "æ–°çš„ä¸€å¹´ä¸»é¢˜ï¼š{theme}",
                theme=theme,
            ),
            data={
                "year": year,
                "theme": theme,
                "highlights": annual_fortune.get("highlights", []),
                "cautions": annual_fortune.get("cautions", []),
            },
        )

    async def _generate_default(
        self,
        task: ReminderTask,
        profile: Dict[str, Any],
        config: Dict[str, Any],
    ) -> ReminderContent:
        """é»˜è®¤å†…å®¹ç”Ÿæˆå™¨"""
        return ReminderContent(
            title=config.get("name", "é€šçŸ¥"),
            body=config.get("description", "æ‚¨æœ‰ä¸€æ¡æ–°æ¶ˆæ¯"),
            data={},
        )

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # LLM å†…å®¹ç”Ÿæˆ
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async def _generate_with_llm(
        self,
        template_type: str,
        context: Dict[str, Any],
        voice_mode: str = "warm",
    ) -> Dict[str, Any]:
        """ä½¿ç”¨ LLM ç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹"""
        from services.llm import create_system_message, create_user_message

        # æ„å»º prompt
        system_prompt = self._get_system_prompt(template_type, voice_mode)
        user_prompt = self._get_user_prompt(template_type, context)

        try:
            messages = [
                create_system_message(system_prompt),
                create_user_message(user_prompt),
            ]
            response = await self.llm_service.chat(messages=messages)

            # è§£æ JSON å“åº”
            content = response.content.strip()
            # å¤„ç†å¯èƒ½çš„ markdown ä»£ç å—
            if content.startswith("```json"):
                content = content[7:]
            if content.startswith("```"):
                content = content[3:]
            if content.endswith("```"):
                content = content[:-3]

            return json.loads(content.strip())
        except Exception as e:
            logger.error(f"LLM generation failed: {e}")
            # è¿”å›é»˜è®¤å†…å®¹
            return self._get_fallback_content(template_type, context)

    def _get_system_prompt(self, template_type: str, voice_mode: str) -> str:
        """è·å–ç³»ç»Ÿæç¤ºè¯"""
        voice_styles = {
            "warm": "ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªæ¸©æš–ã€å…±æƒ…ã€æ”¯æŒçš„ AI çŸ¥å·±ã€‚ç”¨æ¸©æš–çš„è¯­æ°”ä¸ç”¨æˆ·äº¤æµã€‚",
            "sarcastic": "ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªç›´æ¥ã€çŠ€åˆ©ä½†æœ‰è¶£çš„ AI æŸå‹ã€‚ç”¨å¹½é»˜çš„æ–¹å¼ç»™å‡ºå»ºè®®ã€‚",
            "wise": "ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªç†æ€§ã€æ·±åº¦ã€åƒé•¿è¾ˆä¸€æ ·çš„ AI å¯¼å¸ˆã€‚ç”¨ç¿æ™ºçš„æ–¹å¼æŒ‡ç‚¹è¿·æ´¥ã€‚",
        }

        base_prompt = voice_styles.get(voice_mode, voice_styles["warm"])

        if template_type == "daily_fortune":
            return f"""{base_prompt}

ç°åœ¨è¦ä¸ºç”¨æˆ·ç”Ÿæˆä¸€æ¡ä¸ªæ€§åŒ–çš„æ¯æ—¥è¿åŠ¿æé†’ã€‚

è¾“å‡º JSON æ ¼å¼ï¼š
{{
    "greeting": "é—®å€™è¯­ï¼ˆä¸è¶…è¿‡50å­—ï¼‰",
    "fortune_hint": "ä»Šæ—¥è¿åŠ¿æç¤ºï¼ˆä¸è¶…è¿‡30å­—ï¼‰",
    "action_tip": "å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®ï¼ˆä¸è¶…è¿‡30å­—ï¼‰"
}}"""

        if template_type == "rule_based":
            return f"""{base_prompt}

ç°åœ¨è¦åŸºäºä¸“ä¸šè§„åˆ™ä¸ºç”¨æˆ·ç”Ÿæˆä¸€æ¡ä¸ªæ€§åŒ–çš„æ´å¯Ÿæé†’ã€‚

è¾“å‡º JSON æ ¼å¼ï¼š
{{
    "greeting": "é—®å€™è¯­ï¼ˆåŒ…å«æ ¸å¿ƒæ´å¯Ÿï¼Œä¸è¶…è¿‡80å­—ï¼‰",
    "fortune_hint": "å…³é”®æç¤ºï¼ˆä¸è¶…è¿‡40å­—ï¼‰",
    "action_tip": "å…·ä½“å¯æ‰§è¡Œçš„å»ºè®®ï¼ˆä¸è¶…è¿‡40å­—ï¼‰"
}}"""

        return base_prompt

    def _get_user_prompt(self, template_type: str, context: Dict[str, Any]) -> str:
        """è·å–ç”¨æˆ·æç¤ºè¯"""
        if template_type == "daily_fortune":
            concerns = context.get("concerns", [])
            goals = context.get("goals", [])
            concerns_str = "ã€".join(concerns) if concerns else "æ— ç‰¹åˆ«å…³æ³¨"
            goals_str = "ã€".join(goals) if goals else "æ— ç‰¹åˆ«ç›®æ ‡"

            return f"""ä¸ºç”¨æˆ·ç”Ÿæˆä»Šæ—¥é—®å€™ï¼š
- æ—¥æœŸï¼š{context.get('date', '')}
- æ—¥ä¸»å…ƒç´ ï¼š{context.get('day_master_element', 'wood')}
- ä»Šæ—¥è¿åŠ¿åˆ†æ•°ï¼š{context.get('daily_fortune', {}).get('score', 60)}
- ç”¨æˆ·å…³æ³¨ï¼š{concerns_str}
- ç”¨æˆ·ç›®æ ‡ï¼š{goals_str}"""

        if template_type == "rule_based":
            concerns = context.get("concerns", [])
            goals = context.get("goals", [])
            concerns_str = "ã€".join(concerns) if concerns else "æ— ç‰¹åˆ«å…³æ³¨"
            goals_str = "ã€".join(goals) if goals else "æ— ç‰¹åˆ«ç›®æ ‡"

            return f"""åŸºäºä»¥ä¸‹è§„åˆ™å’ŒçŸ¥è¯†ä¸ºç”¨æˆ·ç”Ÿæˆæ´å¯Ÿï¼š

## è§„åˆ™: {context.get('rule_name', '')}

{context.get('rule_content', '')[:500]}

## ç›¸å…³çŸ¥è¯†
{context.get('knowledge_context', 'æ— ')}

## ç”¨æˆ·ä¿¡æ¯
- æ—¥æœŸï¼š{context.get('date', '')}
- ç”¨æˆ·å…³æ³¨ï¼š{concerns_str}
- ç”¨æˆ·ç›®æ ‡ï¼š{goals_str}

è¯·åŸºäºä»¥ä¸Šä¿¡æ¯ç”Ÿæˆä¸ªæ€§åŒ–çš„æ´å¯Ÿæé†’ã€‚"""

        return str(context)

    def _get_fallback_content(self, template_type: str, context: Dict[str, Any]) -> Dict[str, Any]:
        """è·å–é™çº§å†…å®¹"""
        if template_type == "daily_fortune":
            return {
                "greeting": "æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹ï¼æ„¿ä»Šå¤©ä¸€åˆ‡é¡ºåˆ©ã€‚",
                "fortune_hint": "ä¿æŒç§¯æå¿ƒæ€",
                "action_tip": "ä¸“æ³¨å½“ä¸‹ï¼Œä¸€æ­¥ä¸€æ­¥æ¥",
            }
        if template_type == "rule_based":
            rule_name = context.get("rule_name", "æ´å¯Ÿ")
            return {
                "greeting": f"å…³äº{rule_name}ï¼Œæœ‰ä¸€äº›å€¼å¾—å…³æ³¨çš„ä¿¡æ¯ã€‚",
                "fortune_hint": "ä¿æŒè§‰å¯Ÿï¼Œé¡ºåŠ¿è€Œä¸º",
                "action_tip": "ç‚¹å‡»äº†è§£æ›´å¤šè¯¦æƒ…",
            }
        return {"message": "æ‚¨æœ‰ä¸€æ¡æ–°æ¶ˆæ¯"}
