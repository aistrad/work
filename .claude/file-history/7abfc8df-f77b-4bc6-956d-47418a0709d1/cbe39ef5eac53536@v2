-- Migration 024: VibeProfile v8.0 三层架构迁移
--
-- 目标: 将现有数据迁移到三层架构
-- - skill_data.* → skills.*
-- - life_context._paths.lifecoach.content → skills.lifecoach
-- - 初始化 vibe.insight 和 vibe.target
--
-- 此迁移是幂等的，可以多次执行

-- ═══════════════════════════════════════════════════════════════════════════
-- Step 1: 将 skill_data 复制到 skills
-- ═══════════════════════════════════════════════════════════════════════════
UPDATE unified_profiles
SET profile = jsonb_set(
    COALESCE(profile, '{}'::jsonb),
    '{skills}',
    COALESCE(profile -> 'skill_data', '{}'::jsonb)
)
WHERE profile ? 'skill_data'
  AND (NOT profile ? 'skills' OR profile -> 'skills' = '{}'::jsonb);

-- ═══════════════════════════════════════════════════════════════════════════
-- Step 2: 将 life_context._paths.lifecoach.content 复制到 skills.lifecoach
-- ═══════════════════════════════════════════════════════════════════════════
UPDATE unified_profiles
SET profile = jsonb_set(
    jsonb_set(
        COALESCE(profile, '{}'::jsonb),
        '{skills}',
        COALESCE(profile -> 'skills', '{}'::jsonb)
    ),
    '{skills, lifecoach}',
    profile -> 'life_context' -> '_paths' -> 'lifecoach' -> 'content'
)
WHERE profile -> 'life_context' -> '_paths' -> 'lifecoach' -> 'content' IS NOT NULL
  AND jsonb_typeof(profile -> 'life_context' -> '_paths' -> 'lifecoach' -> 'content') = 'object'
  AND (
      NOT profile -> 'skills' ? 'lifecoach'
      OR profile -> 'skills' -> 'lifecoach' = '{}'::jsonb
  );

-- ═══════════════════════════════════════════════════════════════════════════
-- Step 3: 初始化 vibe 结构
-- ═══════════════════════════════════════════════════════════════════════════
UPDATE unified_profiles
SET profile = jsonb_set(
    COALESCE(profile, '{}'::jsonb),
    '{vibe}',
    jsonb_build_object(
        'insight', jsonb_build_object(
            'essence', '{}'::jsonb,
            'dynamic', '{}'::jsonb,
            'pattern', '{}'::jsonb
        ),
        'target', jsonb_build_object(
            'north_star', COALESCE(profile -> 'skills' -> 'lifecoach' -> 'north_star', '{}'::jsonb),
            'goals', COALESCE(profile -> 'skills' -> 'lifecoach' -> 'goals', '[]'::jsonb),
            'focus', jsonb_build_object(
                'primary', NULL,
                'active_goal', NULL,
                'heat_map', '{}'::jsonb
            ),
            'milestones', jsonb_build_object(
                'streak', COALESCE(profile -> 'skills' -> 'lifecoach' -> 'progress', '{}'::jsonb)
            )
        )
    )
)
WHERE NOT profile ? 'vibe' OR profile -> 'vibe' = '{}'::jsonb;

-- ═══════════════════════════════════════════════════════════════════════════
-- Step 4: 确保 identity 结构存在
-- ═══════════════════════════════════════════════════════════════════════════
UPDATE unified_profiles
SET profile = jsonb_set(
    COALESCE(profile, '{}'::jsonb),
    '{identity}',
    jsonb_build_object(
        'display_name', COALESCE(profile -> 'account' -> 'display_name', NULL),
        'birth_info', COALESCE(profile -> 'birth_info', '{}'::jsonb)
    )
)
WHERE NOT profile ? 'identity'
   OR (profile -> 'identity' = '{}'::jsonb AND profile ? 'birth_info');

-- ═══════════════════════════════════════════════════════════════════════════
-- Step 5: 更新 updated_at
-- ═══════════════════════════════════════════════════════════════════════════
UPDATE unified_profiles
SET updated_at = NOW()
WHERE profile ? 'skills' OR profile ? 'vibe';

-- ═══════════════════════════════════════════════════════════════════════════
-- 验证迁移结果
-- ═══════════════════════════════════════════════════════════════════════════
-- SELECT
--     user_id,
--     profile ? 'skills' as has_skills,
--     profile ? 'vibe' as has_vibe,
--     profile -> 'skills' ? 'lifecoach' as has_lifecoach_in_skills,
--     profile -> 'life_context' -> '_paths' ? 'lifecoach' as has_lifecoach_in_life_context
-- FROM unified_profiles
-- LIMIT 10;
