"""
ZodiacComputer - 星座计算器

从 unified_profiles 读取数据，提供星座相关计算。

功能:
1. 每日星座运势
2. 行运分析
3. 月相影响
"""

import logging
from datetime import date, datetime
from typing import Dict, Any, List, Optional

from skills.zodiac.services.events import ZodiacEvents

logger = logging.getLogger(__name__)


class ZodiacComputer:
    """星座计算器"""

    # 星座日期范围
    ZODIAC_DATES = [
        ("capricorn", 12, 22, 1, 19),    # 摩羯座
        ("aquarius", 1, 20, 2, 18),      # 水瓶座
        ("pisces", 2, 19, 3, 20),        # 双鱼座
        ("aries", 3, 21, 4, 19),         # 白羊座
        ("taurus", 4, 20, 5, 20),        # 金牛座
        ("gemini", 5, 21, 6, 20),        # 双子座
        ("cancer", 6, 21, 7, 22),        # 巨蟹座
        ("leo", 7, 23, 8, 22),           # 狮子座
        ("virgo", 8, 23, 9, 22),         # 处女座
        ("libra", 9, 23, 10, 22),        # 天秤座
        ("scorpio", 10, 23, 11, 21),     # 天蝎座
        ("sagittarius", 11, 22, 12, 21), # 射手座
    ]

    # 星座中文名
    ZODIAC_NAMES = {
        "aries": "白羊座",
        "taurus": "金牛座",
        "gemini": "双子座",
        "cancer": "巨蟹座",
        "leo": "狮子座",
        "virgo": "处女座",
        "libra": "天秤座",
        "scorpio": "天蝎座",
        "sagittarius": "射手座",
        "capricorn": "摩羯座",
        "aquarius": "水瓶座",
        "pisces": "双鱼座",
    }

    # 元素分组
    ELEMENTS = {
        "fire": ["aries", "leo", "sagittarius"],
        "earth": ["taurus", "virgo", "capricorn"],
        "air": ["gemini", "libra", "aquarius"],
        "water": ["cancer", "scorpio", "pisces"],
    }

    async def calculate_daily_horoscope(
        self,
        profile: Dict[str, Any],
    ) -> Dict[str, Any]:
        """计算每日星座运势"""
        sun_sign = self._get_sun_sign(profile)
        moon_sign = self._get_moon_sign(profile)

        today = date.today()

        # 基于日期生成稳定的运势分数
        seed = today.year * 10000 + today.month * 100 + today.day
        base_score = 60 + (seed % 31) - 15  # 45-75

        # 根据星座元素调整
        element = self._get_element(sun_sign)
        element_bonus = self._get_element_bonus(element, today)

        score = max(30, min(95, base_score + element_bonus))

        # 生成主题和建议
        theme = self._generate_daily_theme(sun_sign, score)
        highlights, cautions = self._generate_daily_advice(sun_sign, moon_sign, score)

        return {
            "date": today.isoformat(),
            "sun_sign": sun_sign,
            "sun_sign_name": self.ZODIAC_NAMES.get(sun_sign, sun_sign),
            "moon_sign": moon_sign,
            "score": score,
            "theme": theme,
            "highlights": highlights,
            "cautions": cautions,
        }

    async def get_upcoming_events(
        self,
        days: int = 7,
    ) -> List[Dict[str, Any]]:
        """获取即将到来的星象事件"""
        today = date.today()

        try:
            events = ZodiacEvents.get_upcoming_events(today, days=days)
            return [
                {
                    "name": event.name,
                    "event_type": event.event_type,
                    "start_date": event.start_date.isoformat(),
                    "end_date": event.end_date.isoformat() if event.end_date else None,
                    "description": event.description,
                }
                for event in events
            ]
        except Exception as e:
            logger.error(f"Failed to get upcoming events: {e}")
            return []

    async def calculate_transit_influence(
        self,
        profile: Dict[str, Any],
        transit_type: str,
    ) -> Dict[str, Any]:
        """计算行运影响"""
        sun_sign = self._get_sun_sign(profile)

        # 不同行运类型的影响
        influences = {
            "mercury_retrograde": {
                "theme": "沟通与反思",
                "advice": "避免签署重要合同，适合回顾过去",
                "intensity": 7,
            },
            "new_moon": {
                "theme": "新的开始",
                "advice": "适合设定新目标，播种意图",
                "intensity": 6,
            },
            "full_moon": {
                "theme": "收获与释放",
                "advice": "庆祝成就，放下不需要的",
                "intensity": 6,
            },
            "eclipse": {
                "theme": "重大转变",
                "advice": "保持开放，接受变化",
                "intensity": 9,
            },
        }

        influence = influences.get(transit_type, {
            "theme": "能量转换",
            "advice": "保持觉察",
            "intensity": 5,
        })

        return {
            "transit_type": transit_type,
            "sun_sign": sun_sign,
            **influence,
        }

    # ═══════════════════════════════════════════════════════════════════════
    # 内部方法
    # ═══════════════════════════════════════════════════════════════════════

    def _get_sun_sign(self, profile: Dict[str, Any]) -> str:
        """从 profile 获取太阳星座"""
        # v9.0: 只从 skills 读取
        skill_data = profile.get("skills", {}).get("zodiac", {})
        chart = skill_data.get("chart", {})

        if chart.get("sun_sign"):
            return chart["sun_sign"]

        # 从出生日期计算
        identity = profile.get("identity", {})
        birth_info = identity.get("birth_info", {})
        birth_date_str = birth_info.get("date", "")

        if birth_date_str:
            try:
                birth_date = datetime.strptime(birth_date_str, "%Y-%m-%d").date()
                return self._calculate_sun_sign(birth_date)
            except ValueError:
                pass

        return "aries"  # 默认

    def _get_moon_sign(self, profile: Dict[str, Any]) -> str:
        """从 profile 获取月亮星座"""
        # v9.0: 只从 skills 读取
        skill_data = profile.get("skills", {}).get("zodiac", {})
        chart = skill_data.get("chart", {})
        return chart.get("moon_sign", "")

    def _calculate_sun_sign(self, birth_date: date) -> str:
        """根据出生日期计算太阳星座"""
        month = birth_date.month
        day = birth_date.day

        for sign, start_month, start_day, end_month, end_day in self.ZODIAC_DATES:
            if start_month == end_month:
                if month == start_month and start_day <= day <= end_day:
                    return sign
            else:
                if (month == start_month and day >= start_day) or \
                   (month == end_month and day <= end_day):
                    return sign

        return "capricorn"  # 默认

    def _get_element(self, sign: str) -> str:
        """获取星座元素"""
        for element, signs in self.ELEMENTS.items():
            if sign in signs:
                return element
        return "fire"

    def _get_element_bonus(self, element: str, today: date) -> int:
        """根据元素和日期计算加成"""
        # 简化逻辑：根据月份和元素关系
        month = today.month

        # 火象星座在夏季加成
        if element == "fire" and month in [6, 7, 8]:
            return 5
        # 土象星座在秋季加成
        elif element == "earth" and month in [9, 10, 11]:
            return 5
        # 风象星座在春季加成
        elif element == "air" and month in [3, 4, 5]:
            return 5
        # 水象星座在冬季加成
        elif element == "water" and month in [12, 1, 2]:
            return 5

        return 0

    def _generate_daily_theme(self, sun_sign: str, score: int) -> str:
        """生成每日主题"""
        if score >= 75:
            return "能量充沛，适合行动"
        elif score >= 60:
            return "平稳顺利，保持节奏"
        elif score >= 45:
            return "稳扎稳打，避免冲动"
        else:
            return "休养生息，积蓄能量"

    def _generate_daily_advice(
        self,
        sun_sign: str,
        moon_sign: str,
        score: int,
    ) -> tuple:
        """生成每日建议"""
        element = self._get_element(sun_sign)

        highlights = []
        cautions = []

        if element == "fire":
            highlights = ["行动力强", "领导力突出"]
            cautions = ["避免冲动", "注意耐心"]
        elif element == "earth":
            highlights = ["稳定可靠", "实际务实"]
            cautions = ["避免固执", "保持灵活"]
        elif element == "air":
            highlights = ["思维活跃", "沟通顺畅"]
            cautions = ["避免分心", "落实行动"]
        else:  # water
            highlights = ["直觉敏锐", "情感丰富"]
            cautions = ["避免情绪化", "保持理性"]

        return highlights, cautions
