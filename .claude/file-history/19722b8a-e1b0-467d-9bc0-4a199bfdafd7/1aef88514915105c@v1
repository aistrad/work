# VibeLife â†’ VibeID å‡çº§æ–¹æ¡ˆ

> åŸºäº VibeIDè®¾è®¡-v4.md çš„ç³»ç»Ÿå‡çº§å®æ–½æ–¹æ¡ˆ
> ç‰ˆæœ¬: 1.1 | æ›´æ–°æ—¥æœŸ: 2026-01-16

---

## ä¸€ã€æ¶æ„è®¾è®¡

### 1.1 VibeID çš„åŒé‡èº«ä»½

VibeID é‡‡ç”¨ **ç‰¹æ®Š Skill + åŸºç¡€è®¾æ–½** çš„åŒé‡èº«ä»½ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      VibeLife ç³»ç»Ÿæ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    CoreAgent                            â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   use_skill("vibeid") â”€â”€â”                               â”‚   â”‚
â”‚   â”‚   use_skill("bazi")  â”€â”€â”€â”¼â”€â”€â†’ Skill Router               â”‚   â”‚
â”‚   â”‚   use_skill("zodiac") â”€â”€â”¤                               â”‚   â”‚
â”‚   â”‚   use_skill("tarot") â”€â”€â”€â”¤                               â”‚   â”‚
â”‚   â”‚   use_skill("career") â”€â”€â”˜                               â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                   â”‚
â”‚                              â–¼                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚ VibeID  â”‚  â”‚  Bazi   â”‚  â”‚ Zodiac  â”‚  â”‚  Tarot  â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  Skill  â”‚  â”‚  Skill  â”‚  â”‚  Skill  â”‚  â”‚  Skill  â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚        â”‚            â”‚            â”‚                      â”‚   â”‚
â”‚   â”‚        â”‚      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚   â”‚        â”‚      â”‚                                         â”‚   â”‚
â”‚   â”‚        â–¼      â–¼                                         â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚           VibeID Profile (åŸºç¡€è®¾æ–½)             â”‚   â”‚   â”‚
â”‚   â”‚   â”‚                                                 â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â€¢ å››ç»´åŸå‹ (Core/Inner/Outer/Shadow)           â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â€¢ 12åŸå‹å¾—åˆ†                                   â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â€¢ æ¯æ—¥ Vibe æ•°æ®                               â”‚   â”‚   â”‚
â”‚   â”‚   â”‚  â€¢ æˆé•¿è®°å½•                                     â”‚   â”‚   â”‚
â”‚   â”‚   â”‚                                                 â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡ç†ç”±ï¼š**
1. **ä½œä¸º Skill**: ç”¨æˆ·å¯é€šè¿‡å¯¹è¯è§¦å‘ VibeID åŠŸèƒ½ï¼ˆ"å¸®æˆ‘ç”Ÿæˆ VibeID"ã€"ä»Šå¤©çš„ Vibe æ€ä¹ˆæ ·"ï¼‰
2. **ä½œä¸ºåŸºç¡€è®¾æ–½**: Bazi/Zodiac Skill å¯è¯»å–ç”¨æˆ·çš„ VibeID Profileï¼Œæä¾›æ›´ä¸ªæ€§åŒ–çš„è§£è¯»

### 1.2 ç›®å½•ç»“æ„

```
apps/api/skills/vibeid/
â”œâ”€â”€ SKILL.md                    # Skill å®šä¹‰æ–‡æ¡£
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ archetype_calculator.py # åŸå‹è®¡ç®—ï¼ˆè°ƒç”¨ bazi/zodiac servicesï¼‰
â”‚   â”œâ”€â”€ vibe_calculator.py      # æ¯æ—¥ Vibe å€¼è®¡ç®—
â”‚   â”œâ”€â”€ transit_calculator.py   # è¡Œè¿å…±æŒ¯è®¡ç®—
â”‚   â”œâ”€â”€ qa_engine.py            # é—®ç­”ç¡®è®¤å¼•æ“
â”‚   â””â”€â”€ content_generator.py    # å†…å®¹ç”Ÿæˆï¼ˆå‹‡æ°”é‚€è¯·ã€æ·±åº¦æ—¥ç­‰ï¼‰
â”œâ”€â”€ tools/
â”‚   â”œâ”€â”€ tools.yaml              # å·¥å…·å®šä¹‰
â”‚   â””â”€â”€ handlers.py             # å·¥å…·æ‰§è¡Œå™¨
â”œâ”€â”€ scenarios/
â”‚   â”œâ”€â”€ create_vibeid.yaml      # åˆ›å»º VibeID åœºæ™¯
â”‚   â”œâ”€â”€ daily_vibe.yaml         # æ¯æ—¥ Vibe åœºæ™¯
â”‚   â”œâ”€â”€ deep_day.yaml           # æ·±åº¦æ—¥åœºæ™¯
â”‚   â”œâ”€â”€ growth_journey.yaml     # æˆé•¿é™ªä¼´åœºæ™¯
â”‚   â””â”€â”€ archetype_explore.yaml  # åŸå‹æ¢ç´¢åœºæ™¯
â””â”€â”€ reminders.yaml              # æé†’å®šä¹‰ï¼ˆæ¯æ—¥ Vibe æ¨é€ï¼‰

apps/api/routes/
â””â”€â”€ vibeid.py                   # VibeID ç‹¬ç«‹ APIï¼ˆé chatï¼‰
    â”œâ”€â”€ POST /vibeid/create     # åˆ›å»º VibeID
    â”œâ”€â”€ GET  /vibeid/profile    # è·å– VibeID Profile
    â”œâ”€â”€ GET  /vibeid/daily      # è·å–æ¯æ—¥ Vibe
    â”œâ”€â”€ POST /vibeid/qa         # é—®ç­”ç¡®è®¤
    â””â”€â”€ POST /vibeid/feedback   # ç”¨æˆ·åé¦ˆ
```

---

## äºŒã€æ•°æ®æ¨¡å‹è®¾è®¡

### 2.1 å¤ç”¨ unified_profiles ç°æœ‰æ¶æ„

VibeID æ•°æ®å­˜å‚¨åœ¨ `unified_profiles.profile.skill_data.vibeid` è·¯å¾„ä¸‹ï¼Œ**å®Œå…¨å¤ç”¨ç°æœ‰æ¶æ„**ï¼Œæ— éœ€æ–°å¢å­—æ®µã€‚

**ç°æœ‰ unified_profiles ç»“æ„ï¼š**
```json
{
  "birth_info": { ... },
  "life_context": { ... },
  "identity_prism": { ... },
  "preferences": { "voice_mode": "warm", "language": "zh-CN" },
  "skill_data": {
    "bazi": { ... },
    "zodiac": { ... },
    "vibeid": { ... }  // â† VibeID æ•°æ®å­˜å‚¨ä½ç½®
  }
}
```

**VibeID æ•°æ®ç»“æ„ (`profile.skill_data.vibeid`)ï¼š**

```json
{
  "version": "1.0",
  "created_at": "2026-01-16T10:00:00Z",
  "updated_at": "2026-01-16T10:00:00Z",

  "archetypes": {
    "core": {
      "primary": "Creator",
      "secondary": "Outlaw",
      "confidence": "high",
      "source": {
        "bazi_contribution": "Creator",
        "sun_contribution": "Outlaw"
      }
    },
    "inner": {
      "archetype": "Magician",
      "emotional_traits": ["æƒ…æ„Ÿå¼ºçƒˆ", "éœ€è¦æ·±åº¦"]
    },
    "outer": {
      "archetype": "Caregiver",
      "social_style": ["æ¸©å’Œ", "ä½“è´´", "ä¿æŠ¤æ€§"]
    },
    "shadow": {
      "primary_tendency": "Regular",
      "alternative_tendencies": ["Innocent"],
      "confidence": "medium",
      "user_confirmed": false
    }
  },

  "archetype_scores": {
    "Innocent": 45,
    "Explorer": 62,
    "Sage": 58,
    "Hero": 55,
    "Outlaw": 78,
    "Magician": 72,
    "Regular": 35,
    "Lover": 60,
    "Jester": 48,
    "Caregiver": 65,
    "Creator": 85,
    "Ruler": 52
  },

  "layer_consistency": {
    "type": "social_adaptation",
    "name": "ç¤¾ä¼šé€‚åº”å‹",
    "description": "ä½ çš„å†…å¿ƒä¸–ç•Œä¸å¤–åœ¨å‘ˆç°æœ‰æ‰€ä¸åŒ"
  },

  "growth_data": {
    "deep_days_count": 0,
    "last_deep_day": null,
    "courage_invitations_accepted": 0,
    "current_stage": "persona_awareness",
    "stage_scores": {
      "persona_awareness": 0.3,
      "shadow_integration": 0.1,
      "energy_balance": 0.2,
      "self_realization": 0.1
    }
  },

  "qa_history": [
    {
      "question_type": "feature_validation",
      "target_archetype": "Creator",
      "answer": "å¤ªå‡†äº†",
      "timestamp": "2026-01-16T10:05:00Z"
    }
  ]
}
```

**æ•°æ®è®¿é—®æ–¹å¼ï¼ˆå¤ç”¨ç°æœ‰ Repositoryï¼‰ï¼š**

```python
from stores.unified_profile_repo import UnifiedProfileRepository

# è¯»å– VibeID æ•°æ®
vibeid = await UnifiedProfileRepository.get_skill_data(user_id, "vibeid")

# å†™å…¥ VibeID æ•°æ®
await UnifiedProfileRepository.update_skill_data(user_id, "vibeid", vibeid_data)
```

### 2.2 æ–°å»º daily_vibes è¡¨

```sql
CREATE TABLE daily_vibes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES vibe_users(id),
  date DATE NOT NULL,

  -- Vibe å€¼
  vibe_score INTEGER NOT NULL CHECK (vibe_score >= 0 AND vibe_score <= 100),
  energy_zone VARCHAR(20) NOT NULL, -- high_energy/vibrant/stable/reflective/deep

  -- è¡Œè¿æ•°æ®
  transit JSONB NOT NULL,
  -- {
  --   "activated_archetype": "Explorer",
  --   "resonance_value": 15,
  --   "bazi_transit": {"day_gan": "ç”²", "day_zhi": "å­"},
  --   "astro_transit": {"moon_sign": "Aries", "major_aspects": [...]}
  -- }

  -- æ˜¯å¦æ·±åº¦æ—¥
  is_deep_day BOOLEAN DEFAULT FALSE,

  -- ç”Ÿæˆçš„å†…å®¹
  content JSONB NOT NULL,
  -- {
  --   "greeting": "æ—©å®‰ï¼Œå°æ˜...",
  --   "core_message": "...",
  --   "courage_invitation": {...},
  --   "shadow_content": {...}  -- ä»…æ·±åº¦æ—¥
  -- }

  -- ç”¨æˆ·åé¦ˆ
  user_feedback JSONB DEFAULT NULL,
  -- {
  --   "mood_rating": 4,
  --   "reflection": "...",
  --   "courage_action_taken": true
  -- }

  created_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(user_id, date)
);

-- ç´¢å¼•ä¼˜åŒ–
CREATE INDEX idx_daily_vibes_user_date ON daily_vibes(user_id, date DESC);
CREATE INDEX idx_daily_vibes_date ON daily_vibes(date);
CREATE INDEX idx_daily_vibes_deep_day ON daily_vibes(user_id, is_deep_day) WHERE is_deep_day = TRUE;
```

### 2.3 è·¨ Skill æ•°æ®è®¿é—®è§„èŒƒ

VibeID ä½œä¸ºåŸºç¡€è®¾æ–½ï¼Œå…¶ä»– Skill å¯ä»¥è¯»å–ç”¨æˆ·çš„ VibeID Profile æ¥æä¾›ä¸ªæ€§åŒ–æœåŠ¡ã€‚

**è®¿é—®æƒé™çŸ©é˜µï¼š**

| Skill | å¯è¯»å–çš„ VibeID å­—æ®µ | ç”¨é€” |
|-------|---------------------|------|
| bazi | `archetypes.core`, `archetype_scores` | åŸºäºåŸå‹ä¸ªæ€§åŒ–è§£è¯» |
| zodiac | `archetypes.core`, `archetypes.inner` | ç»“åˆæœˆäº®åŸå‹è§£è¯»æƒ…æ„Ÿ |
| tarot | `archetypes.shadow`, `growth_data` | é˜´å½±æ•´åˆå¼•å¯¼ |
| career | `archetypes.core`, `layer_consistency` | èŒä¸šåŒ¹é…å»ºè®® |

**ç³»ç»Ÿçº§è®¿é—®æ¥å£ï¼š**

```python
# services/agent/skill_loader.py ä¸­æ·»åŠ 

async def get_vibeid_for_skill(user_id: UUID, skill: str) -> Optional[Dict]:
    """
    è·å–å½“å‰ç”¨æˆ·çš„ VibeID æ•°æ®ï¼ˆä¾›å…¶ä»– Skill ä½¿ç”¨ï¼‰

    æ ¹æ® skill ç±»å‹è¿”å›å…è®¸è®¿é—®çš„å­—æ®µå­é›†
    """
    vibeid = await UnifiedProfileRepository.get_skill_data(user_id, "vibeid")
    if not vibeid:
        return None

    # å®šä¹‰å„ Skill å¯è®¿é—®çš„å­—æ®µ
    SKILL_ACCESS_RULES = {
        "bazi": ["archetypes.core", "archetype_scores"],
        "zodiac": ["archetypes.core", "archetypes.inner"],
        "tarot": ["archetypes.shadow", "growth_data"],
        "career": ["archetypes.core", "layer_consistency"],
    }

    allowed_fields = SKILL_ACCESS_RULES.get(skill, [])
    return filter_vibeid_fields(vibeid, allowed_fields)
```

**åœ¨ Skill System Prompt ä¸­æ³¨å…¥ VibeID ä¸Šä¸‹æ–‡ï¼š**

```python
# skill_loader.py build_system_prompt() ä¸­

if user_vibeid := await get_vibeid_for_skill(user_id, skill):
    context_parts.append(f"""
## ç”¨æˆ·äººæ ¼ç”»åƒ (VibeID)
- çµé­‚åŸå‹: {user_vibeid['archetypes']['core']['primary']}
- æ¬¡è¦èƒ½é‡: {user_vibeid['archetypes']['core'].get('secondary', 'æ— ')}

è¯·åœ¨è§£è¯»ä¸­èå…¥ç”¨æˆ·çš„åŸå‹ç‰¹è´¨ï¼Œæä¾›æ›´ä¸ªæ€§åŒ–çš„å»ºè®®ã€‚
""")
```

---

## ä¸‰ã€æ ¸å¿ƒæœåŠ¡å®ç°

### 3.1 åŸå‹è®¡ç®—æœåŠ¡

**æ–‡ä»¶**: `apps/api/skills/vibeid/services/archetype_calculator.py`

```python
from typing import Dict, Any
from dataclasses import dataclass
from enum import Enum

# å¤ç”¨ç°æœ‰è®¡ç®—æœåŠ¡
from skills.bazi.services import BaziCalculator
from skills.zodiac.services import ZodiacCalculator


class ArchetypeType(str, Enum):
    INNOCENT = "Innocent"
    EXPLORER = "Explorer"
    SAGE = "Sage"
    HERO = "Hero"
    OUTLAW = "Outlaw"
    MAGICIAN = "Magician"
    REGULAR = "Regular"
    LOVER = "Lover"
    JESTER = "Jester"
    CAREGIVER = "Caregiver"
    CREATOR = "Creator"
    RULER = "Ruler"


# å…«å­—æ ¼å±€ â†’ åŸå‹æ˜ å°„
BAZI_PATTERN_MAPPING = {
    "æ­£å®˜æ ¼": (ArchetypeType.RULER, ArchetypeType.HERO),
    "ä¸ƒæ€æ ¼": (ArchetypeType.HERO, ArchetypeType.OUTLAW),
    "æ­£å°æ ¼": (ArchetypeType.SAGE, ArchetypeType.CAREGIVER),
    "åå°æ ¼": (ArchetypeType.MAGICIAN, ArchetypeType.SAGE),
    "æ¯”è‚©æ ¼": (ArchetypeType.REGULAR, ArchetypeType.HERO),
    "åŠ«è´¢æ ¼": (ArchetypeType.OUTLAW, ArchetypeType.EXPLORER),
    "é£Ÿç¥æ ¼": (ArchetypeType.JESTER, ArchetypeType.CREATOR),
    "ä¼¤å®˜æ ¼": (ArchetypeType.CREATOR, ArchetypeType.OUTLAW),
    "æ­£è´¢æ ¼": (ArchetypeType.REGULAR, ArchetypeType.RULER),
    "åè´¢æ ¼": (ArchetypeType.EXPLORER, ArchetypeType.LOVER),
}

# å¤ªé˜³æ˜Ÿåº§ â†’ åŸå‹æ˜ å°„
SUN_SIGN_MAPPING = {
    "Aries": (ArchetypeType.HERO, ArchetypeType.EXPLORER),
    "Taurus": (ArchetypeType.REGULAR, ArchetypeType.LOVER),
    "Gemini": (ArchetypeType.JESTER, ArchetypeType.SAGE),
    "Cancer": (ArchetypeType.CAREGIVER, ArchetypeType.LOVER),
    "Leo": (ArchetypeType.RULER, ArchetypeType.CREATOR),
    "Virgo": (ArchetypeType.SAGE, ArchetypeType.CAREGIVER),
    "Libra": (ArchetypeType.LOVER, ArchetypeType.REGULAR),
    "Scorpio": (ArchetypeType.MAGICIAN, ArchetypeType.OUTLAW),
    "Sagittarius": (ArchetypeType.EXPLORER, ArchetypeType.SAGE),
    "Capricorn": (ArchetypeType.RULER, ArchetypeType.HERO),
    "Aquarius": (ArchetypeType.OUTLAW, ArchetypeType.MAGICIAN),
    "Pisces": (ArchetypeType.INNOCENT, ArchetypeType.LOVER),
}

# æœˆäº®æ˜Ÿåº§ â†’ Inner åŸå‹æ˜ å°„
MOON_SIGN_MAPPING = {
    "Aries": ArchetypeType.HERO,
    "Taurus": ArchetypeType.REGULAR,
    "Gemini": ArchetypeType.JESTER,
    "Cancer": ArchetypeType.CAREGIVER,
    "Leo": ArchetypeType.CREATOR,
    "Virgo": ArchetypeType.SAGE,
    "Libra": ArchetypeType.LOVER,
    "Scorpio": ArchetypeType.MAGICIAN,
    "Sagittarius": ArchetypeType.EXPLORER,
    "Capricorn": ArchetypeType.RULER,
    "Aquarius": ArchetypeType.OUTLAW,
    "Pisces": ArchetypeType.INNOCENT,
}

# Shadow å¯¹åº”å…³ç³»
SHADOW_MAPPING = {
    ArchetypeType.INNOCENT: ArchetypeType.HERO,
    ArchetypeType.HERO: ArchetypeType.INNOCENT,
    ArchetypeType.SAGE: ArchetypeType.JESTER,
    ArchetypeType.JESTER: ArchetypeType.SAGE,
    ArchetypeType.CAREGIVER: ArchetypeType.EXPLORER,
    ArchetypeType.EXPLORER: ArchetypeType.CAREGIVER,
    ArchetypeType.CREATOR: ArchetypeType.REGULAR,
    ArchetypeType.REGULAR: ArchetypeType.CREATOR,
    ArchetypeType.LOVER: ArchetypeType.MAGICIAN,
    ArchetypeType.MAGICIAN: ArchetypeType.LOVER,
    ArchetypeType.RULER: ArchetypeType.OUTLAW,
    ArchetypeType.OUTLAW: ArchetypeType.RULER,
}


@dataclass
class VibeIDResult:
    """VibeID è®¡ç®—ç»“æœ"""
    archetypes: Dict[str, Any]
    archetype_scores: Dict[str, int]
    layer_consistency: Dict[str, str]
    bazi_data: Dict[str, Any]
    natal_chart: Dict[str, Any]


class ArchetypeCalculator:
    """åŸå‹è®¡ç®—å™¨ - èåˆå…«å­—å’Œæ˜Ÿåº§"""

    def __init__(self):
        self.bazi_calculator = BaziCalculator()
        self.zodiac_calculator = ZodiacCalculator()

    async def calculate(
        self,
        birth_year: int,
        birth_month: int,
        birth_day: int,
        birth_hour: int = 12,
        birth_minute: int = 0,
        birth_city: str = "åŒ—äº¬",
        gender: str = "male"
    ) -> VibeIDResult:
        """è®¡ç®—å®Œæ•´çš„ VibeID"""

        # 1. è°ƒç”¨å…«å­—è®¡ç®—
        bazi_data = await self._calculate_bazi(
            birth_year, birth_month, birth_day, birth_hour, gender
        )

        # 2. è°ƒç”¨æ˜Ÿç›˜è®¡ç®—
        natal_chart = await self._calculate_natal_chart(
            birth_year, birth_month, birth_day,
            birth_hour, birth_minute, birth_city
        )

        # 3. è®¡ç®— Core åŸå‹ (å…«å­— 60% + å¤ªé˜³ 40%)
        core = self._calculate_core(bazi_data, natal_chart)

        # 4. è®¡ç®— Inner åŸå‹ (æœˆäº®æ˜Ÿåº§)
        inner = self._calculate_inner(natal_chart)

        # 5. è®¡ç®— Outer åŸå‹ (ä¸Šå‡æ˜Ÿåº§)
        outer = self._calculate_outer(natal_chart)

        # 6. è®¡ç®— Shadow åŸå‹
        shadow = self._calculate_shadow(core["primary"])

        # 7. è®¡ç®— 12 åŸå‹å¾—åˆ†
        archetype_scores = self._calculate_all_scores(bazi_data, natal_chart)

        # 8. åˆ†æå±‚é—´ä¸€è‡´æ€§
        layer_consistency = self._analyze_layer_consistency(
            core["primary"], inner["archetype"], outer["archetype"]
        )

        return VibeIDResult(
            archetypes={
                "core": core,
                "inner": inner,
                "outer": outer,
                "shadow": shadow
            },
            archetype_scores=archetype_scores,
            layer_consistency=layer_consistency,
            bazi_data=bazi_data,
            natal_chart=natal_chart
        )

    def _calculate_core(self, bazi_data: Dict, natal_chart: Dict) -> Dict:
        """è®¡ç®— Core åŸå‹ (å…«å­— 60% + å¤ªé˜³ 40%)"""
        pattern = bazi_data.get("pattern", "æ¯”è‚©æ ¼")
        bazi_primary, bazi_secondary = BAZI_PATTERN_MAPPING.get(
            pattern, (ArchetypeType.REGULAR, ArchetypeType.HERO)
        )

        sun_sign = natal_chart.get("sun_sign", "Aries")
        sun_primary, sun_secondary = SUN_SIGN_MAPPING.get(
            sun_sign, (ArchetypeType.HERO, ArchetypeType.EXPLORER)
        )

        if bazi_primary == sun_primary:
            return {
                "primary": bazi_primary.value,
                "secondary": bazi_secondary.value,
                "confidence": "high",
                "source": {
                    "bazi_contribution": bazi_primary.value,
                    "sun_contribution": sun_primary.value
                }
            }
        else:
            return {
                "primary": bazi_primary.value,
                "secondary": sun_primary.value,
                "confidence": "medium",
                "source": {
                    "bazi_contribution": bazi_primary.value,
                    "sun_contribution": sun_primary.value
                }
            }

    def _calculate_inner(self, natal_chart: Dict) -> Dict:
        """è®¡ç®— Inner åŸå‹ (æœˆäº®æ˜Ÿåº§)"""
        moon_sign = natal_chart.get("moon_sign", "Cancer")
        archetype = MOON_SIGN_MAPPING.get(moon_sign, ArchetypeType.CAREGIVER)
        return {
            "archetype": archetype.value,
            "emotional_traits": self._get_emotional_traits(archetype)
        }

    def _calculate_outer(self, natal_chart: Dict) -> Dict:
        """è®¡ç®— Outer åŸå‹ (ä¸Šå‡æ˜Ÿåº§)"""
        rising_sign = natal_chart.get("rising_sign", "Libra")
        archetype = MOON_SIGN_MAPPING.get(rising_sign, ArchetypeType.LOVER)
        return {
            "archetype": archetype.value,
            "social_style": self._get_social_style(archetype)
        }

    def _calculate_shadow(self, core_primary: str) -> Dict:
        """è®¡ç®— Shadow åŸå‹"""
        core_type = ArchetypeType(core_primary)
        shadow_type = SHADOW_MAPPING.get(core_type, ArchetypeType.REGULAR)
        return {
            "primary_tendency": shadow_type.value,
            "alternative_tendencies": [],
            "confidence": "medium",
            "user_confirmed": False
        }

    def _analyze_layer_consistency(
        self, core: str, inner: str, outer: str
    ) -> Dict[str, str]:
        """åˆ†æå±‚é—´ä¸€è‡´æ€§"""
        if core == inner == outer:
            return {
                "type": "highly_integrated",
                "name": "é«˜åº¦æ•´åˆå‹",
                "description": "ä½ çš„å†…å¤–é«˜åº¦ç»Ÿä¸€ï¼Œå±•ç°å‡ºçœŸå®ä¸€è‡´çš„è‡ªæˆ‘"
            }
        elif core == inner and inner != outer:
            return {
                "type": "social_adaptation",
                "name": "ç¤¾ä¼šé€‚åº”å‹",
                "description": "ä½ çš„å†…å¿ƒä¸–ç•Œä¸å¤–åœ¨å‘ˆç°æœ‰æ‰€ä¸åŒ"
            }
        elif core != inner:
            return {
                "type": "self_perception_gap",
                "name": "è‡ªæˆ‘è®¤çŸ¥åå·®å‹",
                "description": "ä½ çš„è‡ªæˆ‘è®¤çŸ¥ä¸æ·±å±‚é©±åŠ¨å­˜åœ¨å·®å¼‚"
            }
        else:
            return {
                "type": "complex",
                "name": "å¤æ‚å‹",
                "description": "ä½ çš„äººæ ¼ç»“æ„ä¸°å¯Œå¤šå…ƒ"
            }
```

### 3.2 æ¯æ—¥ Vibe è®¡ç®—æœåŠ¡

**æ–‡ä»¶**: `apps/api/skills/vibeid/services/vibe_calculator.py`

```python
from datetime import date
from typing import Dict, Any

from .archetype_calculator import ArchetypeType, SHADOW_MAPPING


class VibeCalculator:
    """æ¯æ—¥ Vibe å€¼è®¡ç®—å™¨"""

    def calculate_daily_vibe(
        self,
        user_vibeid: Dict[str, Any],
        target_date: date
    ) -> Dict[str, Any]:
        """è®¡ç®—æŒ‡å®šæ—¥æœŸçš„ Vibe å€¼"""

        # 1. è®¡ç®—è¡Œè¿
        transit = self._calculate_transit(target_date)

        # 2. è®¡ç®—å…±æŒ¯å€¼
        resonance = self._calculate_resonance(
            user_core=user_vibeid["archetypes"]["core"]["primary"],
            user_shadow=user_vibeid["archetypes"]["shadow"]["primary_tendency"],
            activated_archetype=transit["activated_archetype"]
        )

        # 3. åˆ¤æ–­æ˜¯å¦æ·±åº¦æ—¥
        is_deep_day = self._should_trigger_deep_day(
            user_vibeid, transit["activated_archetype"], target_date
        )

        # 4. è®¡ç®—æœ€ç»ˆ Vibe å€¼
        vibe_score = 50 + resonance
        vibe_score = max(0, min(100, vibe_score))

        # 5. ç¡®å®šèƒ½é‡åŒºé—´
        energy_zone = self._get_energy_zone(vibe_score, is_deep_day)

        return {
            "date": target_date.isoformat(),
            "vibe_score": vibe_score,
            "energy_zone": energy_zone["zone"],
            "energy_name": energy_zone["name"],
            "transit": transit,
            "resonance_value": resonance,
            "is_deep_day": is_deep_day
        }

    def _get_energy_zone(self, score: int, is_deep_day: bool) -> Dict[str, str]:
        """ç¡®å®šèƒ½é‡åŒºé—´"""
        if is_deep_day:
            return {"zone": "deep", "name": "æ·±åº¦æ—¥", "color": "#6B46C1"}
        elif score >= 80:
            return {"zone": "high_energy", "name": "é«˜èƒ½é‡", "color": "#F59E0B"}
        elif score >= 60:
            return {"zone": "vibrant", "name": "æ´»åŠ›æœŸ", "color": "#10B981"}
        elif score >= 40:
            return {"zone": "stable", "name": "å¹³ç¨³æœŸ", "color": "#3B82F6"}
        else:
            return {"zone": "reflective", "name": "å†…çœæœŸ", "color": "#8B5CF6"}
```

### 3.3 é—®ç­”ç¡®è®¤å¼•æ“

**æ–‡ä»¶**: `apps/api/skills/vibeid/services/qa_engine.py`

```python
from typing import Dict, Any, List, Optional
from dataclasses import dataclass
from enum import Enum


class QuestionType(str, Enum):
    CORE_VALIDATION = "core_validation"      # CoreåŸå‹éªŒè¯
    SHADOW_SELECTION = "shadow_selection"    # Shadowé€‰æ‹©
    FEATURE_VALIDATION = "feature_validation" # ç‰¹å¾éªŒè¯
    LAYER_CONSISTENCY = "layer_consistency"  # å±‚é—´ä¸€è‡´æ€§ç¡®è®¤


@dataclass
class MagicQuestion:
    """é­”æ³•é—®é¢˜"""
    question_type: QuestionType
    question_text: str
    options: List[Dict[str, Any]]
    target_archetype: Optional[str] = None


class QAEngine:
    """é—®ç­”ç¡®è®¤å¼•æ“"""

    def generate_core_validation_question(
        self,
        core_archetype: str,
        confidence: str
    ) -> MagicQuestion:
        """ç”Ÿæˆ Core åŸå‹éªŒè¯é—®é¢˜"""

        archetype_questions = {
            "Creator": {
                "question": "å½“ä½ æœ‰ä¸€ä¸ªåˆ›æ„æƒ³æ³•æ—¶ï¼Œä½ é€šå¸¸ä¼šï¼š",
                "options": [
                    {"label": "ç«‹åˆ»å¼€å§‹è¡ŒåŠ¨ï¼Œè¾¹åšè¾¹æƒ³", "score": 3},
                    {"label": "å…ˆè§„åˆ’å¥½å†åŠ¨æ‰‹", "score": 2},
                    {"label": "ç­‰å¾…åˆé€‚çš„æ—¶æœºå’Œèµ„æº", "score": 1},
                    {"label": "å¯»æ±‚ä»–äººçš„æ„è§å’Œæ”¯æŒ", "score": 0}
                ]
            },
            "Explorer": {
                "question": "é¢å¯¹æœªçŸ¥çš„é¢†åŸŸï¼Œä½ çš„ç¬¬ä¸€ååº”æ˜¯ï¼š",
                "options": [
                    {"label": "å…´å¥‹ï¼è¿™æ˜¯æ¢ç´¢çš„å¥½æœºä¼š", "score": 3},
                    {"label": "å¥½å¥‡ä½†ä¼šå…ˆåšäº›è°ƒç ”", "score": 2},
                    {"label": "æœ‰äº›ç´§å¼ ï¼Œéœ€è¦å‡†å¤‡å……åˆ†", "score": 1},
                    {"label": "å€¾å‘äºå¾…åœ¨èˆ’é€‚åŒº", "score": 0}
                ]
            },
            # ... å…¶ä»–åŸå‹çš„é—®é¢˜
        }

        q = archetype_questions.get(core_archetype, archetype_questions["Creator"])

        return MagicQuestion(
            question_type=QuestionType.CORE_VALIDATION,
            question_text=q["question"],
            options=q["options"],
            target_archetype=core_archetype
        )

    def generate_shadow_selection_question(
        self,
        shadow_candidates: List[str]
    ) -> MagicQuestion:
        """ç”Ÿæˆ Shadow é€‰æ‹©é—®é¢˜"""

        return MagicQuestion(
            question_type=QuestionType.SHADOW_SELECTION,
            question_text="åœ¨å‹åŠ›æˆ–å›°å¢ƒä¸­ï¼Œä½ æœ€å®¹æ˜“å‡ºç°å“ªç§å€¾å‘ï¼Ÿ",
            options=[
                {
                    "label": self._get_shadow_label(candidate),
                    "archetype": candidate
                }
                for candidate in shadow_candidates[:4]
            ]
        )

    def process_answer(
        self,
        question: MagicQuestion,
        user_answer: Dict[str, Any],
        current_vibeid: Dict[str, Any]
    ) -> Dict[str, Any]:
        """å¤„ç†ç”¨æˆ·å›ç­”ï¼Œè¿”å›è°ƒæ•´åçš„ VibeID"""

        if question.question_type == QuestionType.CORE_VALIDATION:
            return self._process_core_validation(
                question, user_answer, current_vibeid
            )
        elif question.question_type == QuestionType.SHADOW_SELECTION:
            return self._process_shadow_selection(
                question, user_answer, current_vibeid
            )

        return current_vibeid
```

---

## å››ã€å·¥å…·å®šä¹‰

**æ–‡ä»¶**: `apps/api/skills/vibeid/tools/tools.yaml`

```yaml
tools:
  - name: create_vibeid
    description: ä¸ºç”¨æˆ·åˆ›å»º VibeID äººæ ¼ç”»åƒ
    parameters:
      type: object
      properties:
        birth_year:
          type: integer
          description: å‡ºç”Ÿå¹´ä»½
        birth_month:
          type: integer
          description: å‡ºç”Ÿæœˆä»½
        birth_day:
          type: integer
          description: å‡ºç”Ÿæ—¥æœŸ
        birth_hour:
          type: integer
          description: å‡ºç”Ÿæ—¶è¾°ï¼ˆ0-23ï¼‰
        birth_minute:
          type: integer
          description: å‡ºç”Ÿåˆ†é’Ÿ
        birth_city:
          type: string
          description: å‡ºç”ŸåŸå¸‚
        gender:
          type: string
          enum: [male, female]
          description: æ€§åˆ«
      required: [birth_year, birth_month, birth_day]

  - name: get_daily_vibe
    description: è·å–ç”¨æˆ·ä»Šæ—¥çš„ Vibe å€¼å’Œèƒ½é‡çŠ¶æ€
    parameters:
      type: object
      properties:
        date:
          type: string
          format: date
          description: æ—¥æœŸï¼ˆé»˜è®¤ä»Šå¤©ï¼‰

  - name: show_vibeid_card
    description: å±•ç¤ºç”¨æˆ·çš„ VibeID å¡ç‰‡
    parameters:
      type: object
      properties:
        style:
          type: string
          enum: [full, mini, share]
          description: å¡ç‰‡æ ·å¼

  - name: ask_magic_question
    description: å‘ç”¨æˆ·æå‡ºé­”æ³•é—®é¢˜è¿›è¡Œç¡®è®¤
    parameters:
      type: object
      properties:
        question_type:
          type: string
          enum: [core_validation, shadow_selection, feature_validation]
        context:
          type: string
          description: é—®é¢˜ä¸Šä¸‹æ–‡

  - name: trigger_courage_invitation
    description: å‘èµ·å‹‡æ°”é‚€è¯·
    parameters:
      type: object
      properties:
        invitation_type:
          type: string
          enum: [daily, deep_day, growth]
        archetype_focus:
          type: string
          description: èšç„¦çš„åŸå‹

  - name: record_growth_action
    description: è®°å½•ç”¨æˆ·çš„æˆé•¿è¡ŒåŠ¨
    parameters:
      type: object
      properties:
        action_type:
          type: string
          enum: [courage_taken, reflection_done, shadow_acknowledged]
        description:
          type: string
        archetype:
          type: string
```

---

## äº”ã€åœºæ™¯å®šä¹‰

### 5.1 åˆ›å»º VibeID åœºæ™¯

**æ–‡ä»¶**: `apps/api/skills/vibeid/scenarios/create_vibeid.yaml`

```yaml
name: create_vibeid
trigger:
  keywords:
    - åˆ›å»ºvibeid
    - ç”Ÿæˆæˆ‘çš„äººæ ¼
    - å¸®æˆ‘ç®—ç®—
    - æˆ‘æƒ³äº†è§£è‡ªå·±
  intent: create_personality_profile

flow:
  - step: collect_birth_info
    prompt: |
      æˆ‘æ¥å¸®ä½ åˆ›å»ºä¸“å±çš„ VibeID äººæ ¼ç”»åƒï¼

      ä¸ºäº†å‡†ç¡®è®¡ç®—ï¼Œæˆ‘éœ€è¦çŸ¥é“ä½ çš„å‡ºç”Ÿä¿¡æ¯ï¼š
      - å‡ºç”Ÿæ—¥æœŸï¼ˆå¹´æœˆæ—¥ï¼‰
      - å‡ºç”Ÿæ—¶é—´ï¼ˆå¦‚æœçŸ¥é“çš„è¯ï¼‰
      - å‡ºç”ŸåŸå¸‚
    required_fields: [birth_year, birth_month, birth_day]

  - step: calculate_vibeid
    action: create_vibeid

  - step: present_core
    prompt: |
      ğŸ­ ä½ çš„çµé­‚åŸå‹æ˜¯ **{core.primary}**

      {core_description}

      {if core.confidence == "medium"}
      æˆ‘æ³¨æ„åˆ°ä½ çš„å…«å­—å’Œæ˜Ÿç›˜æ˜¾ç¤ºäº†ä¸€äº›ä¸åŒçš„ç‰¹è´¨ï¼Œ
      è®©æˆ‘é—®ä½ ä¸€ä¸ªé—®é¢˜æ¥ç¡®è®¤...
      {/if}

  - step: magic_question
    condition: core.confidence != "high"
    action: ask_magic_question
    params:
      question_type: core_validation

  - step: present_full
    action: show_vibeid_card
    params:
      style: full

  - step: shadow_intro
    prompt: |
      æ¯ä¸ªäººéƒ½æœ‰é˜´å½±é¢ã€‚ä½ çš„é˜´å½±å€¾å‘æ˜¯ **{shadow.primary_tendency}**ã€‚

      è¿™ä¸æ˜¯"å"çš„ä¸€é¢ï¼Œè€Œæ˜¯ä½ å°šæœªå……åˆ†å‘å±•çš„æ½œåŠ›ã€‚

      æƒ³è¦äº†è§£æ›´å¤šå—ï¼Ÿ
```

### 5.2 æ¯æ—¥ Vibe åœºæ™¯

**æ–‡ä»¶**: `apps/api/skills/vibeid/scenarios/daily_vibe.yaml`

```yaml
name: daily_vibe
trigger:
  keywords:
    - ä»Šå¤©çš„vibe
    - ä»Šæ—¥è¿åŠ¿
    - ä»Šå¤©æ€ä¹ˆæ ·
  schedule:
    time: "08:00"
    timezone: user_timezone

flow:
  - step: calculate_daily
    action: get_daily_vibe

  - step: present_vibe
    template: |
      {greeting}, {user_name}ï¼

      ğŸ“Š ä»Šæ—¥ Vibe å€¼ï¼š**{vibe_score}**
      ğŸŒˆ èƒ½é‡çŠ¶æ€ï¼š**{energy_name}**

      {if is_deep_day}
      âš¡ ä»Šå¤©æ˜¯ä½ çš„ **æ·±åº¦æ—¥**

      å½“å‰è¡Œè¿æ¿€æ´»äº†ä½ çš„ {shadow.primary_tendency} èƒ½é‡ã€‚
      è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æœºä¼šå»è§‰å¯Ÿå’Œæ•´åˆè¿™éƒ¨åˆ†è‡ªå·±ã€‚

      {shadow_guidance}
      {else}
      ä»Šå¤©çš„å®‡å®™èƒ½é‡æ¿€æ´»äº† **{transit.activated_archetype}** åŸå‹ã€‚

      {daily_guidance}
      {/if}

  - step: courage_invitation
    action: trigger_courage_invitation
    params:
      invitation_type: daily
```

### 5.3 æ·±åº¦æ—¥åœºæ™¯

**æ–‡ä»¶**: `apps/api/skills/vibeid/scenarios/deep_day.yaml`

```yaml
name: deep_day
trigger:
  condition: is_deep_day == true

content:
  opening:
    template: |
      ğŸŒ™ ä»Šå¤©æ˜¯ä½ çš„ **æ·±åº¦æ—¥**

      è¿™æ˜¯ä¸€ä¸ªå‘å†…æ¢ç´¢çš„ç‰¹æ®Šæ—¶åˆ»ã€‚
      å½“å‰çš„å®‡å®™èƒ½é‡æ­£åœ¨ç…§äº®ä½ çš„ {shadow.primary_tendency} é¢å‘ã€‚

  shadow_guidance:
    by_archetype:
      Regular:
        message: |
          ä½ å†…å¿ƒæ·±å¤„å¯èƒ½æ¸´æœ›æ›´å¤šçš„å½’å±æ„Ÿå’Œè¢«æ¥çº³ã€‚
          ä»Šå¤©ï¼Œè¯•ç€è§‰å¯Ÿè¿™ç§æ¸´æœ›ï¼Œè€Œä¸æ˜¯é€ƒé¿å®ƒã€‚
        invitation: |
          å‹‡æ°”é‚€è¯·ï¼šä»Šå¤©æ‰¾ä¸€ä¸ªæœºä¼šï¼ŒçœŸå®åœ°è¡¨è¾¾ä½ çš„éœ€æ±‚ã€‚

      Creator:
        message: |
          ä½ å¯èƒ½æ„Ÿåˆ°åˆ›é€ åŠ›è¢«å‹æŠ‘ï¼Œæˆ–è€…å®³æ€•è‡ªå·±çš„ä½œå“ä¸å¤Ÿå¥½ã€‚
          è¿™äº›æ„Ÿå—éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå®ƒä»¬åœ¨æé†’ä½ å†…åœ¨çš„åˆ›é€ ç«èŠ±ã€‚
        invitation: |
          å‹‡æ°”é‚€è¯·ï¼šä»Šå¤©ç”¨5åˆ†é’Ÿï¼Œåˆ›é€ ä¸€äº›"ä¸å®Œç¾"çš„ä¸œè¥¿ã€‚

      # ... å…¶ä»–åŸå‹

  closing:
    template: |
      è®°ä½ï¼Œé˜´å½±ä¸æ˜¯æ•Œäººï¼Œè€Œæ˜¯ç­‰å¾…è¢«æ•´åˆçš„æ½œåŠ›ã€‚

      ä»Šæ™šï¼Œä½ å¯ä»¥å›æ¥å’Œæˆ‘åˆ†äº«ä½ çš„ä½“éªŒã€‚
```

---

## å…­ã€API è·¯ç”±è®¾è®¡

**æ–‡ä»¶**: `apps/api/routes/vibeid.py`

```python
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from typing import Optional
from datetime import date

from services.auth import get_current_user
from skills.vibeid.services import (
    ArchetypeCalculator,
    VibeCalculator,
    QAEngine,
    ContentGenerator
)

router = APIRouter(prefix="/vibeid", tags=["vibeid"])


class CreateVibeIDRequest(BaseModel):
    birth_year: int
    birth_month: int
    birth_day: int
    birth_hour: Optional[int] = 12
    birth_minute: Optional[int] = 0
    birth_city: Optional[str] = "åŒ—äº¬"
    gender: Optional[str] = "male"


class QAAnswerRequest(BaseModel):
    question_id: str
    answer: dict


@router.post("/create")
async def create_vibeid(
    request: CreateVibeIDRequest,
    user = Depends(get_current_user)
):
    """åˆ›å»ºç”¨æˆ·çš„ VibeID"""
    calculator = ArchetypeCalculator()

    result = await calculator.calculate(
        birth_year=request.birth_year,
        birth_month=request.birth_month,
        birth_day=request.birth_day,
        birth_hour=request.birth_hour,
        birth_minute=request.birth_minute,
        birth_city=request.birth_city,
        gender=request.gender
    )

    # ä¿å­˜åˆ° unified_profiles
    await save_vibeid_to_profile(user.id, result)

    return {
        "success": True,
        "vibeid": result.__dict__
    }


@router.get("/profile")
async def get_vibeid_profile(user = Depends(get_current_user)):
    """è·å–ç”¨æˆ·çš„ VibeID Profile"""
    profile = await get_user_vibeid(user.id)

    if not profile:
        raise HTTPException(
            status_code=404,
            detail="VibeID not found. Please create one first."
        )

    return profile


@router.get("/daily")
async def get_daily_vibe(
    target_date: Optional[date] = None,
    user = Depends(get_current_user)
):
    """è·å–æ¯æ—¥ Vibe"""
    vibeid = await get_user_vibeid(user.id)

    if not vibeid:
        raise HTTPException(
            status_code=404,
            detail="VibeID not found"
        )

    calculator = VibeCalculator()
    target = target_date or date.today()

    daily_vibe = calculator.calculate_daily_vibe(vibeid, target)

    # ç”Ÿæˆå†…å®¹
    generator = ContentGenerator()
    content = await generator.generate_daily_content(
        vibeid, daily_vibe
    )

    return {
        **daily_vibe,
        "content": content
    }


@router.post("/qa")
async def submit_qa_answer(
    request: QAAnswerRequest,
    user = Depends(get_current_user)
):
    """æäº¤é—®ç­”ç¡®è®¤ç­”æ¡ˆ"""
    engine = QAEngine()

    # è·å–é—®é¢˜
    question = await get_pending_question(user.id, request.question_id)

    # å¤„ç†ç­”æ¡ˆ
    current_vibeid = await get_user_vibeid(user.id)
    updated_vibeid = engine.process_answer(
        question, request.answer, current_vibeid
    )

    # ä¿å­˜æ›´æ–°
    await save_vibeid_to_profile(user.id, updated_vibeid)

    return {
        "success": True,
        "updated_fields": ["archetypes", "archetype_scores"]
    }


@router.post("/feedback")
async def submit_daily_feedback(
    mood_rating: int,
    reflection: Optional[str] = None,
    courage_action_taken: bool = False,
    user = Depends(get_current_user)
):
    """æäº¤æ¯æ—¥åé¦ˆ"""
    await save_daily_feedback(
        user_id=user.id,
        date=date.today(),
        feedback={
            "mood_rating": mood_rating,
            "reflection": reflection,
            "courage_action_taken": courage_action_taken
        }
    )

    # æ›´æ–°æˆé•¿æ•°æ®
    if courage_action_taken:
        await increment_courage_count(user.id)

    return {"success": True}
```

---

## ä¸ƒã€å‰ç«¯ç»„ä»¶è®¾è®¡

### 7.1 VibeID å¡ç‰‡ç»„ä»¶

**æ–‡ä»¶**: `apps/web/src/skills/vibeid/cards/VibeIDCard.tsx`

```tsx
import React from 'react';

interface VibeIDCardProps {
  vibeid: {
    archetypes: {
      core: { primary: string; secondary: string };
      inner: { archetype: string };
      outer: { archetype: string };
      shadow: { primary_tendency: string };
    };
    archetype_scores: Record<string, number>;
    layer_consistency: { name: string; description: string };
  };
  style?: 'full' | 'mini' | 'share';
}

export const VibeIDCard: React.FC<VibeIDCardProps> = ({ vibeid, style = 'full' }) => {
  const { archetypes, archetype_scores, layer_consistency } = vibeid;

  if (style === 'mini') {
    return (
      <div className="vibeid-card-mini">
        <div className="core-badge">
          {archetypes.core.primary}
        </div>
      </div>
    );
  }

  return (
    <div className="vibeid-card">
      {/* å››ç»´åŸå‹å±•ç¤º */}
      <div className="archetypes-grid">
        <div className="archetype-item core">
          <span className="label">çµé­‚åŸå‹</span>
          <span className="value">{archetypes.core.primary}</span>
          {archetypes.core.secondary && (
            <span className="secondary">+ {archetypes.core.secondary}</span>
          )}
        </div>

        <div className="archetype-item inner">
          <span className="label">å†…åœ¨ä¸–ç•Œ</span>
          <span className="value">{archetypes.inner.archetype}</span>
        </div>

        <div className="archetype-item outer">
          <span className="label">å¤–åœ¨å‘ˆç°</span>
          <span className="value">{archetypes.outer.archetype}</span>
        </div>

        <div className="archetype-item shadow">
          <span className="label">é˜´å½±å€¾å‘</span>
          <span className="value">{archetypes.shadow.primary_tendency}</span>
        </div>
      </div>

      {/* 12åŸå‹é›·è¾¾å›¾ */}
      <ArchetypeRadar scores={archetype_scores} />

      {/* å±‚é—´ä¸€è‡´æ€§ */}
      <div className="layer-consistency">
        <span className="type">{layer_consistency.name}</span>
        <p>{layer_consistency.description}</p>
      </div>
    </div>
  );
};
```

### 7.2 æ¯æ—¥ Vibe ç»„ä»¶

**æ–‡ä»¶**: `apps/web/src/skills/vibeid/cards/DailyVibeCard.tsx`

```tsx
import React from 'react';

interface DailyVibeCardProps {
  dailyVibe: {
    vibe_score: number;
    energy_zone: string;
    energy_name: string;
    is_deep_day: boolean;
    content: {
      greeting: string;
      core_message: string;
      courage_invitation?: {
        type: string;
        message: string;
      };
    };
  };
}

export const DailyVibeCard: React.FC<DailyVibeCardProps> = ({ dailyVibe }) => {
  const { vibe_score, energy_zone, energy_name, is_deep_day, content } = dailyVibe;

  return (
    <div className={`daily-vibe-card ${energy_zone} ${is_deep_day ? 'deep-day' : ''}`}>
      {/* Vibe å€¼åœ†ç¯ */}
      <div className="vibe-score-ring">
        <svg viewBox="0 0 100 100">
          <circle
            cx="50" cy="50" r="45"
            fill="none"
            stroke="#e5e7eb"
            strokeWidth="8"
          />
          <circle
            cx="50" cy="50" r="45"
            fill="none"
            stroke="currentColor"
            strokeWidth="8"
            strokeDasharray={`${vibe_score * 2.83} 283`}
            transform="rotate(-90 50 50)"
          />
        </svg>
        <div className="score-text">
          <span className="number">{vibe_score}</span>
          <span className="label">Vibe</span>
        </div>
      </div>

      {/* èƒ½é‡çŠ¶æ€ */}
      <div className="energy-badge">
        {is_deep_day && <span className="deep-day-icon">ğŸŒ™</span>}
        {energy_name}
      </div>

      {/* å†…å®¹åŒº */}
      <div className="content">
        <p className="greeting">{content.greeting}</p>
        <p className="message">{content.core_message}</p>

        {content.courage_invitation && (
          <div className="courage-invitation">
            <h4>âœ¨ å‹‡æ°”é‚€è¯·</h4>
            <p>{content.courage_invitation.message}</p>
            <button className="accept-btn">æ¥å—é‚€è¯·</button>
          </div>
        )}
      </div>
    </div>
  );
};
```

---

## å…«ã€å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€è®¾æ–½ (Week 1-2)

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | ä¾èµ– |
|------|--------|------|
| æ•°æ®åº“è¡¨ç»“æ„è¿ç§» | P0 | - |
| ArchetypeCalculator æœåŠ¡ | P0 | bazi/zodiac services |
| åŸºç¡€ API è·¯ç”± | P0 | ArchetypeCalculator |
| VibeID Profile å­˜å‚¨ | P0 | æ•°æ®åº“ |

### Phase 2: æ ¸å¿ƒåŠŸèƒ½ (Week 3-4)

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | ä¾èµ– |
|------|--------|------|
| VibeCalculator æ¯æ—¥è®¡ç®— | P0 | ArchetypeCalculator |
| QAEngine é—®ç­”ç¡®è®¤ | P1 | - |
| ContentGenerator å†…å®¹ç”Ÿæˆ | P1 | - |
| VibeID Skill å®šä¹‰ | P0 | æ‰€æœ‰ services |

### Phase 3: å‰ç«¯é›†æˆ (Week 5-6)

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | ä¾èµ– |
|------|--------|------|
| VibeIDCard ç»„ä»¶ | P0 | API |
| DailyVibeCard ç»„ä»¶ | P0 | API |
| åˆ›å»º VibeID æµç¨‹ | P0 | QAEngine |
| æ·±åº¦æ—¥ç‰¹æ®Šç•Œé¢ | P1 | DailyVibeCard |

### Phase 4: é«˜çº§åŠŸèƒ½ (Week 7-8)

| ä»»åŠ¡ | ä¼˜å…ˆçº§ | ä¾èµ– |
|------|--------|------|
| å‹‡æ°”é‚€è¯·ç³»ç»Ÿ | P1 | ContentGenerator |
| æˆé•¿è¿½è¸ª | P1 | æ•°æ®åº“ |
| æ¯æ—¥æ¨é€ | P2 | VibeCalculator |
| åˆ†äº«åŠŸèƒ½ | P2 | VibeIDCard |

---

## ä¹ã€å¾…è§£å†³é—®é¢˜

1. **è¡Œè¿è®¡ç®—ç²¾åº¦**: éœ€è¦ç¡®è®¤ bazi/zodiac è¡Œè¿è®¡ç®—çš„å‡†ç¡®æ€§å’Œæ€§èƒ½
2. **é—®ç­”æµç¨‹ UX**: å¦‚ä½•åœ¨æµå¼å“åº”ä¸­ä¼˜é›…åœ°æ’å…¥é—®ç­”ç¡®è®¤
3. **æ·±åº¦æ—¥é¢‘ç‡**: æ¯æœˆ 2-4 æ¬¡çš„æ§åˆ¶é€»è¾‘éœ€è¦ç»†åŒ–
4. **æ¨é€æœºåˆ¶**: éœ€è¦è¯„ä¼°æ¨é€æœåŠ¡çš„æŠ€æœ¯é€‰å‹ï¼ˆFCM/APNs/WebPushï¼‰
5. **æ•°æ®éšç§**: äººæ ¼æ•°æ®çš„åŠ å¯†å’Œè®¿é—®æ§åˆ¶ç­–ç•¥

---

## åã€éªŒæ”¶æ ‡å‡†

### MVP éªŒæ”¶æ¸…å•

- [ ] ç”¨æˆ·å¯ä»¥é€šè¿‡å‡ºç”Ÿä¿¡æ¯åˆ›å»º VibeID
- [ ] ç³»ç»Ÿæ­£ç¡®è®¡ç®—å››ç»´åŸå‹ï¼ˆCore/Inner/Outer/Shadowï¼‰
- [ ] ç³»ç»Ÿæ­£ç¡®è®¡ç®— 12 åŸå‹å¾—åˆ†
- [ ] ç”¨æˆ·å¯ä»¥æŸ¥çœ‹ VibeID å¡ç‰‡
- [ ] é—®ç­”ç¡®è®¤æµç¨‹æ­£å¸¸å·¥ä½œ
- [ ] æ¯æ—¥ Vibe å€¼æ­£ç¡®è®¡ç®—
- [ ] æ·±åº¦æ—¥æ­£ç¡®è§¦å‘
- [ ] å‹‡æ°”é‚€è¯·æ­£å¸¸å±•ç¤º
- [ ] æˆé•¿æ•°æ®æ­£ç¡®è®°å½•

### æ€§èƒ½æŒ‡æ ‡

- VibeID åˆ›å»ºå“åº”æ—¶é—´ < 3s
- æ¯æ—¥ Vibe è®¡ç®—å“åº”æ—¶é—´ < 500ms
- API å¯ç”¨æ€§ > 99.9%
