# Plan: VibeID v7.0 体验增强升级

## 目标
在现有 VibeID v6.0 基础上增强体验层，不造新概念，让首次揭晓有仪式感，四维展示更完整。

## 已完成的设计文档
- `docs/archive/v9/VIBEID-UPGRADE-V7.md` - 完整升级设计

---

## 升级内容

### 后端 (4 个文件)

| 文件 | 改动 |
|------|------|
| `apps/api/skills/vibe_id/services/explainer.py` | 新增 `generate_reveal()` |
| `apps/api/skills/vibe_id/services/service.py` | 返回数据增加 `reveal` 字段 |
| `apps/api/skills/vibe_id/tools/handlers.py` | 新增 `show_vibe_id_reveal` 工具 |
| `apps/api/skills/vibe_id/tools/tools.yaml` | 注册新工具 |

### 前端 (4 个文件)

| 文件 | 改动 |
|------|------|
| `apps/web/src/skills/vibe-id/components/VibeIDReveal.tsx` | 首次揭晓组件（新建）|
| `apps/web/src/skills/vibe-id/components/CoreTraits.tsx` | 三个特质组件（新建）|
| `apps/web/src/skills/vibe-id/components/FourDimensionView.tsx` | 四维展示（新建）|
| `apps/web/src/skills/vibe-id/tools/show-vibe-id-reveal.tsx` | 揭晓工具卡片（新建）|

---

## 核心改动详情

### 1. Explainer 增强

```python
# explainer.py 新增

def generate_reveal(self, archetypes, bazi_analysis, zodiac_analysis):
    return {
        "core_traits": self._generate_core_traits(archetypes["core"]["primary"]),
        "ai_first_words": self._generate_ai_first_words(archetypes, bazi_analysis, zodiac_analysis),
    }

def _generate_core_traits(self, archetype_id):
    """[优点, 优点, 隐秘恐惧]"""
    info = get_archetype_info(archetype_id)
    superpowers = info.get("superpowers", [])[:2]
    fear_trait = self._fear_to_trait(info.get("core_fear", ""))
    return superpowers + [fear_trait]

def _fear_to_trait(self, fear):
    """转换恐惧为特质形式"""
    mapping = {
        "害怕软弱或无能": "害怕平庸",
        "害怕空虚或被困住": "害怕被困住",
        # ... 完整映射见设计文档
    }
    return mapping.get(fear, fear)

def _generate_ai_first_words(self, archetypes, bazi, zodiac):
    """生成温暖的 AI 第一句话"""
    # 模板: "我看到你是一个{昵称}。你的八字{格局}...但我也看到，你内心深处..."
```

### 2. Service 升级

```python
# service.py calculate() 返回增加

vibe_id_data = {
    "version": "7.0",
    # ... 现有字段不变
    "reveal": self.explainer.generate_reveal(  # 新增
        fusion_result["archetypes"], bazi_analysis, zodiac_analysis
    ),
}
```

### 3. 新工具 show_vibe_id_reveal

```python
@tool_handler("show_vibe_id_reveal")
async def execute_show_vibe_id_reveal(args, context):
    """首次揭晓展示（带仪式感）"""
    # 使用 componentId: "vibe_id_reveal"
    # 前端展示揭晓动画
```

### 4. 前端揭晓组件

```tsx
// VibeIDReveal.tsx
// Phase 1: 命盘计算动画 (2秒)
// Phase 2: 原型图腾 + 三个特质淡入 (1秒)
// Phase 3: AI 第一句话 + 四维概览
```

---

## 验证

1. 首次计算 VibeID 时，使用揭晓动画展示
2. 三个特质正确显示（优点+优点+隐秘恐惧）
3. AI 第一句话温暖且个性化
4. 再次查看时使用普通卡片（无动画）

---

## 不变的部分

- 四维计算算法
- 12原型元数据
- 现有 show_vibe_id 工具
- 现有 VibeIDCard 组件
- 数据存储结构（只增加 reveal 字段）
