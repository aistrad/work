#!/usr/bin/env python3
"""
Run Migration 021: Migrate business data to unified_profiles
"""
import asyncio
import logging
import os
import sys
from pathlib import Path

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent.parent))

from stores.db import get_connection

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


async def run_migration():
    """Execute Migration 021"""
    logger.info("=" * 60)
    logger.info("Running Migration 021: Migrate to unified_profile")
    logger.info("=" * 60)

    migration_file = Path(__file__).parent.parent / "stores" / "migrations" / "021_migrate_to_unified_profile.sql"

    if not migration_file.exists():
        logger.error(f"Migration file not found: {migration_file}")
        return False

    # Read migration SQL
    sql = migration_file.read_text()

    try:
        async with get_connection() as conn:
            # Execute the entire migration in one transaction (it has BEGIN/COMMIT)
            logger.info("Executing migration...")
            await conn.execute(sql)
            logger.info("✓ Migration executed successfully")

            # Check migration log
            result = await conn.fetchrow("""
                SELECT executed_at
                FROM migration_log
                WHERE migration_name = '021_migrate_to_unified_profile'
                ORDER BY executed_at DESC
                LIMIT 1
            """)

            if result:
                logger.info(f"✓ Migration logged at: {result['executed_at']}")
            else:
                logger.warning("⚠ Migration not found in migration_log")

            return True

    except Exception as e:
        logger.exception(f"Migration failed: {e}")
        return False


async def main():
    """Main entry point"""
    success = await run_migration()

    if success:
        logger.info("\n" + "=" * 60)
        logger.info("✅ Migration 021 completed successfully!")
        logger.info("=" * 60)
        logger.info("\nNext steps:")
        logger.info("  1. Run: python scripts/verify_migration_021.py")
        logger.info("  2. Test critical API endpoints")
        logger.info("  3. If all checks pass, proceed with Migration 022")
        return 0
    else:
        logger.error("\n" + "=" * 60)
        logger.error("❌ Migration 021 failed!")
        logger.error("=" * 60)
        return 1


if __name__ == "__main__":
    exit_code = asyncio.run(main())
    exit(exit_code)
