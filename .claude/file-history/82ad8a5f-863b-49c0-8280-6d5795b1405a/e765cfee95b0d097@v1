"""
Soul OS å®Œæ•´åŠŸèƒ½éªŒæ”¶æµ‹è¯•
åŸºäº os_design_claude_mvp.md éªŒæ”¶æ ‡å‡†
"""

import os
import sys

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

os.environ.setdefault("FORTUNE_AI_DB_URL", "postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/fortune_ai")


def test_four_layer_architecture():
    """éªŒè¯å››å±‚æ¶æ„å®ç°"""
    print("\n=== 1. å››å±‚æ¶æ„éªŒè¯ ===")
    from services import soul_os

    user_id = 1

    # L0: Firmware - å…«å­—äº‹å®
    l0 = soul_os.get_l0_facts(user_id)
    assert "facts" in l0, "L0: Missing facts"
    assert "facts_hash" in l0, "L0: Missing facts_hash"
    print("  âœ“ L0 Firmware: å…«å­—äº‹å®å¿«ç…§")

    # L1: Schema - PERMA å›¾å¼
    l1 = soul_os.get_l1_schema(user_id)
    schema = l1.to_dict()
    assert "perma_snapshot" in schema, "L1: Missing PERMA"
    perma = schema["perma_snapshot"]
    for dim in ["positive_emotion", "engagement", "relationships", "meaning", "accomplishment"]:
        assert dim in perma, f"L1: Missing PERMA dimension {dim}"
    print("  âœ“ L1 Schema: PERMA äº”ç»´æ¨¡å‹")

    # L2: Agents - çŸ¥è¯†åº“æ£€ç´¢
    kb_results = soul_os.search_knowledge_base("å…«å­—")
    assert isinstance(kb_results, list), "L2: KB search should return list"
    perspectives = soul_os.get_advisor_perspectives("é—®é¢˜", {})
    assert len(perspectives) == 4, "L2: Should have 4 advisor perspectives"
    print("  âœ“ L2 Agents: çŸ¥è¯†åº“æ£€ç´¢ + å››è§†è§’é¡¾é—®")

    # L3: Synthesis - System Prompt + A2UI
    prompt = soul_os.build_system_prompt(user_id, "warm")
    assert len(prompt) > 500, "L3: System prompt too short"
    assert "A2UI JSON" in prompt, "L3: Missing A2UI format in prompt"
    print("  âœ“ L3 Synthesis: GLM Prompt + A2UI æ ¼å¼")

    return True


def test_state_score():
    """éªŒè¯ State Score è®¡ç®—ï¼ˆSection 7ï¼‰"""
    print("\n=== 2. State Score éªŒè¯ ===")
    from services import soul_os

    score = soul_os.calculate_state_score(1)

    # éªŒè¯ä¸‰ä¿¡å·è®¡ç®—
    assert 0 <= score.score <= 100, "Score out of range"
    assert 0 <= score.emotion_signal <= 40, "Emotion signal out of range"
    assert 0 <= score.action_signal <= 40, "Action signal out of range"
    assert 0 <= score.streak_signal <= 20, "Streak signal out of range"
    print(f"  âœ“ ä¸‰ä¿¡å·è®¡ç®—: emotion={score.emotion_signal}, action={score.action_signal}, streak={score.streak_signal}")

    # éªŒè¯è¡¥æ•‘åŠ¨ä½œ
    assert score.recovery_action, "Missing recovery action"
    print(f"  âœ“ è¡¥æ•‘åŠ¨ä½œ: {score.recovery_action[:40]}...")

    return True


def test_jitai_actions():
    """éªŒè¯ JITAI è°ƒèŠ‚åŠ¨ä½œåº“ï¼ˆSection 8ï¼‰"""
    print("\n=== 3. JITAI è°ƒèŠ‚åŠ¨ä½œåº“éªŒè¯ ===")
    from services import soul_os

    # éªŒè¯è®¾è®¡æ–‡æ¡£ä¸­å®šä¹‰çš„æ‰€æœ‰æƒ…ç»ªç±»å‹
    test_cases = [
        ("ç„¦è™‘", 8, "å‘¼å¸"),
        ("ä½è½", 9, "æœ€å°è¡ŒåŠ¨"),
        ("æ„¤æ€’", 7, "æ¡æ‹³"),
        ("å›°æƒ‘", 6, "é€‰é¡¹"),
        ("å…´å¥‹", 8, "æ¥æº"),
        ("å¹³é™", 5, "ä¿æŒ"),
    ]

    for mood, intensity, keyword in test_cases:
        action = soul_os.get_jitai_action(mood, intensity)
        assert action, f"No action for {mood}"
        assert keyword in action, f"Action for {mood} missing keyword '{keyword}'"
        print(f"  âœ“ {mood}({intensity}): åŒ…å«å…³é”®è¯ '{keyword}'")

    return True


def test_anti_dependency():
    """éªŒè¯åä¾èµ–æœºåˆ¶ï¼ˆSection 9ï¼‰"""
    print("\n=== 4. åä¾èµ–æœºåˆ¶éªŒè¯ ===")
    from services import soul_os

    state = soul_os.check_anti_dependency(1, "æµ‹è¯•é—®é¢˜")

    # éªŒè¯è¿½è¸ªå­—æ®µ
    assert hasattr(state, "daily_consult_count"), "Missing daily_consult_count"
    assert hasattr(state, "last_action_days"), "Missing last_action_days"
    assert hasattr(state, "should_intervene"), "Missing should_intervene"
    print(f"  âœ“ æ¯æ—¥å’¨è¯¢è®¡æ•°: {state.daily_consult_count}")
    print(f"  âœ“ æ— è¡ŒåŠ¨å¤©æ•°: {state.last_action_days}")
    print(f"  âœ“ æ˜¯å¦å¹²é¢„: {state.should_intervene}")

    # éªŒè¯å¹²é¢„ç±»å‹
    if state.should_intervene:
        assert state.intervention_type in ["repeated_question", "daily_limit", "no_action"], "Unknown intervention type"
        assert state.intervention_message, "Missing intervention message"
        print(f"  âœ“ å¹²é¢„ç±»å‹: {state.intervention_type}")

    return True


def test_commitment_types():
    """éªŒè¯ Commitment å››ç±»å‹ï¼ˆSection 6ï¼‰"""
    print("\n=== 5. Commitment ç±»å‹éªŒè¯ ===")
    from services.soul_os import CommitmentType

    expected_types = ["start_task", "schedule_task", "ask_followup", "opt_out"]
    for t in expected_types:
        assert hasattr(CommitmentType, t.upper()), f"Missing CommitmentType: {t}"
        print(f"  âœ“ {t}")

    return True


def test_persona_styles():
    """éªŒè¯ä¸‰ç§äººæ ¼é£æ ¼ï¼ˆSection 10ï¼‰"""
    print("\n=== 6. äººæ ¼é£æ ¼éªŒè¯ ===")
    from services.soul_os import PersonaStyle

    expected_styles = ["standard", "warm", "roast"]
    for s in expected_styles:
        assert hasattr(PersonaStyle, s.upper()), f"Missing PersonaStyle: {s}"
        print(f"  âœ“ {s}")

    return True


def test_guidance_card_a2ui():
    """éªŒè¯ Guidance Card åˆ° A2UI è½¬æ¢ï¼ˆSection 5.4ï¼‰"""
    print("\n=== 7. Guidance Card A2UI éªŒè¯ ===")
    from services import soul_os

    card = {
        "card_id": "test",
        "type": "daily_guidance",
        "conclusion": "ä»Šæ—¥ç»“è®º",
        "why": "å¿ƒç†å­¦ä¾æ®",
        "prescriptions": [
            {"content": "ä»»åŠ¡1", "if_then": "å¦‚æœXâ†’é‚£ä¹ˆY"},
            {"content": "ä»»åŠ¡2", "if_then": "å¦‚æœAâ†’é‚£ä¹ˆB"},
        ],
        "time_window": {"type": "intervention", "value": "7å¤©", "confidence": "high"},
        "risk_boundary": "ä¸æ›¿ä»£åŒ»ç–—å»ºè®®",
        "commitment_ask": "ä½ æ„¿æ„åšå“ªä¸ªï¼Ÿ",
        "actions": [
            {"type": "start_task", "task_id": "uuid1", "label": "å¼€å§‹"},
            {"type": "opt_out", "label": "æš‚ä¸"},
        ],
    }

    a2ui = soul_os.guidance_card_to_a2ui(card)

    # éªŒè¯ç»“æ„
    assert "meta" in a2ui, "Missing meta"
    assert "summary" in a2ui["meta"], "Missing summary"
    assert "ui_components" in a2ui, "Missing ui_components"
    assert len(a2ui["ui_components"]) >= 2, "Need at least 2 components"

    # éªŒè¯ç»„ä»¶ç±»å‹
    types = [c["type"] for c in a2ui["ui_components"]]
    assert "markdown_text" in types, "Missing markdown_text component"
    assert "action_buttons" in types, "Missing action_buttons component"

    print("  âœ“ A2UI ç»“æ„æ­£ç¡®")
    print("  âœ“ åŒ…å« markdown_text ç»„ä»¶")
    print("  âœ“ åŒ…å« action_buttons ç»„ä»¶")

    return True


def test_dashboard_routes():
    """éªŒè¯ Dashboard è·¯ç”±ï¼ˆSection 11.4ï¼‰"""
    print("\n=== 8. Dashboard è·¯ç”±éªŒè¯ ===")
    from api.dashboard_routes import router

    routes = {r.path: r for r in router.routes if hasattr(r, 'path')}

    expected = [
        "/overview",
        "/status",
        "/trends",
        "/tasks",
        "/task/accept",
        "/task/done",
        "/task/skip",
        "/checkin",
        "/relations",
        "/explore",
    ]

    for path in expected:
        full_path = f"/api/dashboard{path}"
        # Check if path exists (accounting for prefix)
        found = any(path in r for r in routes.keys())
        if found:
            print(f"  âœ“ {path}")
        else:
            print(f"  âœ— {path} NOT FOUND")

    return True


def test_chat_integration():
    """éªŒè¯ Chat API é›†æˆ"""
    print("\n=== 9. Chat API é›†æˆéªŒè¯ ===")
    from api import chat_routes
    from services import soul_os

    # éªŒè¯ soul_os å¯¼å…¥
    assert hasattr(chat_routes, 'soul_os'), "soul_os not imported in chat_routes"
    print("  âœ“ soul_os å·²å¯¼å…¥åˆ° chat_routes")

    # éªŒè¯å®Œæ•´ä¸Šä¸‹æ–‡
    context = soul_os.get_full_context_for_chat(1, "æµ‹è¯•")
    required = ["system_prompt", "persona_style", "user_context", "evidence", "anti_dependency"]
    for key in required:
        assert key in context, f"Missing context key: {key}"
        print(f"  âœ“ {key} å­˜åœ¨")

    return True


def test_psychology_translation():
    """éªŒè¯å¿ƒç†å­¦ç¿»è¯‘è§„åˆ™ï¼ˆSection 2.3ï¼‰"""
    print("\n=== 10. å¿ƒç†å­¦ç¿»è¯‘éªŒè¯ ===")
    from services import soul_os

    # æ¨¡æ‹Ÿå…«å­—äº‹å®
    facts = {
        "bazi": {
            "strength": {"status": "weak"},
            "shensha": [
                {"name": "æ¡ƒèŠ±", "hit": True},
                {"name": "é©¿é©¬", "hit": True},
            ],
        }
    }

    translations = soul_os.translate_bazi_to_psychology(facts)
    assert len(translations) >= 1, "Should have translations"

    for t in translations:
        assert "concept" in t, "Missing concept"
        assert "translation" in t, "Missing translation"
        assert "action" in t, "Missing action"
        print(f"  âœ“ {t['concept']}: {t['translation'][:30]}...")

    return True


def run_all_tests():
    """è¿è¡Œæ‰€æœ‰éªŒæ”¶æµ‹è¯•"""
    print("=" * 70)
    print("Soul OS å®Œæ•´åŠŸèƒ½éªŒæ”¶æµ‹è¯•")
    print("åŸºäº os_design_claude_mvp.md éªŒæ”¶æ ‡å‡†")
    print("=" * 70)

    tests = [
        ("å››å±‚æ¶æ„", test_four_layer_architecture),
        ("State Score", test_state_score),
        ("JITAI è°ƒèŠ‚åŠ¨ä½œåº“", test_jitai_actions),
        ("åä¾èµ–æœºåˆ¶", test_anti_dependency),
        ("Commitment ç±»å‹", test_commitment_types),
        ("äººæ ¼é£æ ¼", test_persona_styles),
        ("Guidance Card A2UI", test_guidance_card_a2ui),
        ("Dashboard è·¯ç”±", test_dashboard_routes),
        ("Chat API é›†æˆ", test_chat_integration),
        ("å¿ƒç†å­¦ç¿»è¯‘", test_psychology_translation),
    ]

    results = []
    for name, test_fn in tests:
        try:
            result = test_fn()
            results.append((name, "PASS" if result else "FAIL"))
        except Exception as e:
            print(f"\n[ERROR] {name}: {e}")
            import traceback
            traceback.print_exc()
            results.append((name, f"ERROR"))

    print("\n" + "=" * 70)
    print("éªŒæ”¶æµ‹è¯•ç»“æœæ±‡æ€»")
    print("=" * 70)

    passed = sum(1 for _, r in results if r == "PASS")
    failed = len(results) - passed

    for name, result in results:
        status = "âœ“" if result == "PASS" else "âœ—"
        print(f"  {status} {name}: {result}")

    print("=" * 70)
    print(f"Total: {len(results)} tests, {passed} passed, {failed} failed")

    if failed == 0:
        print("\nğŸ‰ æ‰€æœ‰éªŒæ”¶æµ‹è¯•é€šè¿‡ï¼Soul OS åŠŸèƒ½å®Œæ•´å®ç°ã€‚")
    else:
        print(f"\nâš ï¸ {failed} ä¸ªæµ‹è¯•æœªé€šè¿‡ï¼Œéœ€è¦æ£€æŸ¥ã€‚")

    print("=" * 70)

    return failed == 0


if __name__ == "__main__":
    success = run_all_tests()
    sys.exit(0 if success else 1)
