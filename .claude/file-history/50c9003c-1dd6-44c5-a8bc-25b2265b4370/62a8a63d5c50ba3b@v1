"use client";

/**
 * useProfileData - 获取Me页面所需的所有数据
 *
 * 包括：
 * - VibeID数据
 * - 八字命盘摘要
 * - 星座星图摘要
 *
 * React Best Practices Applied:
 * - 使用SWR进行数据获取和缓存
 * - 自动请求去重
 */

import useSWR from "swr";
import { apiClient } from "@/lib/api";
import { type BaziData, type ZodiacData } from "@/components/me";

// ═══════════════════════════════════════════════════════════════════════════
// Fetchers
// ═══════════════════════════════════════════════════════════════════════════

async function fetchBaziSummary(userId: string): Promise<BaziData | null> {
  try {
    const response = await apiClient.get(`/skills/bazi/profile/${userId}/summary`);
    const data = response.data;

    if (!data) return null;

    return {
      dayMaster: data.day_master || "未知",
      pattern: data.pattern || "未知格局",
      todayFortune: data.today_fortune || "今日运势平稳",
      fortuneLevel: (data.fortune_level || 3) as 1 | 2 | 3 | 4 | 5,
    };
  } catch (error) {
    console.error("Failed to fetch bazi summary:", error);
    return null;
  }
}

async function fetchZodiacSummary(userId: string): Promise<ZodiacData | null> {
  try {
    const response = await apiClient.get(`/skills/zodiac/profile/${userId}/summary`);
    const data = response.data;

    if (!data) return null;

    return {
      sunSign: data.sun_sign || "未知",
      ascendant: data.ascendant || "未知",
      todayEnergy: data.today_energy || "今日能量平稳",
      energyLevel: (data.energy_level || 3) as 1 | 2 | 3 | 4 | 5,
    };
  } catch (error) {
    console.error("Failed to fetch zodiac summary:", error);
    return null;
  }
}

async function fetchVibeId(userId: string): Promise<any | null> {
  try {
    const response = await apiClient.get(`/skills/vibe-id/profile/${userId}`);
    return response.data || null;
  } catch (error) {
    console.error("Failed to fetch vibe-id:", error);
    return null;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// Hook
// ═══════════════════════════════════════════════════════════════════════════

export interface UseProfileDataReturn {
  baziData: BaziData | null | undefined;
  zodiacData: ZodiacData | null | undefined;
  vibeIdData: any | null | undefined;
  isLoading: boolean;
  isError: boolean;
}

/**
 * 获取Me页面所需的所有数据
 *
 * @param userId - 用户ID，如果为空则不获取数据
 * @returns 包含所有数据的对象
 */
export function useProfileData(userId: string | null | undefined): UseProfileDataReturn {
  // React Best Practice 4.2: Use SWR for Automatic Deduplication
  // SWR会自动去重相同的请求，并提供缓存
  const { data: baziData, error: baziError } = useSWR<BaziData | null>(
    userId ? `/profile-data/bazi/${userId}` : null,
    () => fetchBaziSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000, // 60秒内不重复请求
    }
  );

  const { data: zodiacData, error: zodiacError } = useSWR<ZodiacData | null>(
    userId ? `/profile-data/zodiac/${userId}` : null,
    () => fetchZodiacSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000,
    }
  );

  const { data: vibeIdData, error: vibeIdError } = useSWR<any | null>(
    userId ? `/profile-data/vibe-id/${userId}` : null,
    () => fetchVibeId(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 300000, // VibeID变化较少，5分钟内不重复请求
    }
  );

  const isLoading = (!baziData && !baziError) || (!zodiacData && !zodiacError) || (!vibeIdData && !vibeIdError);
  const isError = !!baziError || !!zodiacError || !!vibeIdError;

  return {
    baziData,
    zodiacData,
    vibeIdData,
    isLoading,
    isError,
  };
}

/**
 * 单独获取八字数据
 */
export function useBaziData(userId: string | null | undefined) {
  return useSWR<BaziData | null>(
    userId ? `/profile-data/bazi/${userId}` : null,
    () => fetchBaziSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000,
    }
  );
}

/**
 * 单独获取星座数据
 */
export function useZodiacData(userId: string | null | undefined) {
  return useSWR<ZodiacData | null>(
    userId ? `/profile-data/zodiac/${userId}` : null,
    () => fetchZodiacSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000,
    }
  );
}

/**
 * 单独获取VibeID数据
 */
export function useVibeIdData(userId: string | null | undefined) {
  return useSWR<any | null>(
    userId ? `/profile-data/vibe-id/${userId}` : null,
    () => fetchVibeId(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 300000,
    }
  );
}
