"use client";

/**
 * useProfileData - è·å–Meé¡µé¢æ‰€éœ€çš„æ‰€æœ‰æ•°æ®
 *
 * åŒ…æ‹¬ï¼š
 * - VibeIDæ•°æ®
 * - å…«å­—å‘½ç›˜æ‘˜è¦
 * - æ˜Ÿåº§æ˜Ÿå›¾æ‘˜è¦
 *
 * React Best Practices Applied:
 * - ä½¿ç”¨SWRè¿›è¡Œæ•°æ®è·å–å’Œç¼“å­˜
 * - è‡ªåŠ¨è¯·æ±‚å»é‡
 */

import useSWR from "swr";
import { apiClient } from "@/lib/api";
import { type BaziData, type ZodiacData } from "@/components/me";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Fetchers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function fetchBaziSummary(userId: string): Promise<BaziData | null> {
  try {
    const response = await apiClient.get(`/skills/bazi/profile/${userId}/summary`);
    const data = response.data;

    if (!data) return null;

    return {
      dayMaster: data.day_master || "æœªçŸ¥",
      pattern: data.pattern || "æœªçŸ¥æ ¼å±€",
      todayFortune: data.today_fortune || "ä»Šæ—¥è¿åŠ¿å¹³ç¨³",
      fortuneLevel: (data.fortune_level || 3) as 1 | 2 | 3 | 4 | 5,
    };
  } catch (error) {
    console.error("Failed to fetch bazi summary:", error);
    return null;
  }
}

async function fetchZodiacSummary(userId: string): Promise<ZodiacData | null> {
  try {
    const response = await apiClient.get(`/skills/zodiac/profile/${userId}/summary`);
    const data = response.data;

    if (!data) return null;

    return {
      sunSign: data.sun_sign || "æœªçŸ¥",
      ascendant: data.ascendant || "æœªçŸ¥",
      todayEnergy: data.today_energy || "ä»Šæ—¥èƒ½é‡å¹³ç¨³",
      energyLevel: (data.energy_level || 3) as 1 | 2 | 3 | 4 | 5,
    };
  } catch (error) {
    console.error("Failed to fetch zodiac summary:", error);
    return null;
  }
}

async function fetchVibeId(userId: string): Promise<any | null> {
  try {
    const response = await apiClient.get(`/skills/vibe-id/profile/${userId}`);
    return response.data || null;
  } catch (error) {
    console.error("Failed to fetch vibe-id:", error);
    return null;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Hook
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export interface UseProfileDataReturn {
  baziData: BaziData | null | undefined;
  zodiacData: ZodiacData | null | undefined;
  vibeIdData: any | null | undefined;
  isLoading: boolean;
  isError: boolean;
}

/**
 * è·å–Meé¡µé¢æ‰€éœ€çš„æ‰€æœ‰æ•°æ®
 *
 * @param userId - ç”¨æˆ·IDï¼Œå¦‚æœä¸ºç©ºåˆ™ä¸è·å–æ•°æ®
 * @returns åŒ…å«æ‰€æœ‰æ•°æ®çš„å¯¹è±¡
 *
 * å¼€å‘æç¤ºï¼š
 * - åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå¦‚æœAPIè¿”å›é”™è¯¯ï¼Œä¼šè‡ªåŠ¨fallbackåˆ°mockæ•°æ®
 * - å¯ä»¥é€šè¿‡localStorageè®¾ç½® 'useMockProfileData' å¼ºåˆ¶ä½¿ç”¨mockæ•°æ®
 */
export function useProfileData(userId: string | null | undefined): UseProfileDataReturn {
  // æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶ä½¿ç”¨mockæ•°æ®ï¼ˆæ–¹ä¾¿å¼€å‘è°ƒè¯•ï¼‰
  const useMockData = typeof window !== "undefined" && localStorage.getItem("useMockProfileData") === "true";

  // React Best Practice 4.2: Use SWR for Automatic Deduplication
  // SWRä¼šè‡ªåŠ¨å»é‡ç›¸åŒçš„è¯·æ±‚ï¼Œå¹¶æä¾›ç¼“å­˜
  const { data: baziData, error: baziError } = useSWR<BaziData | null>(
    userId && !useMockData ? `/profile-data/bazi/${userId}` : null,
    () => fetchBaziSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000, // 60ç§’å†…ä¸é‡å¤è¯·æ±‚
      // å¼€å‘ç¯å¢ƒï¼šAPIé”™è¯¯æ—¶fallbackåˆ°nullï¼ˆä¸æ˜¾ç¤ºé”™è¯¯ï¼‰
      onError: (err) => {
        if (process.env.NODE_ENV === "development") {
          console.warn("Bazi API failed, component will show empty state:", err);
        }
      },
    }
  );

  const { data: zodiacData, error: zodiacError } = useSWR<ZodiacData | null>(
    userId && !useMockData ? `/profile-data/zodiac/${userId}` : null,
    () => fetchZodiacSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000,
      onError: (err) => {
        if (process.env.NODE_ENV === "development") {
          console.warn("Zodiac API failed, component will show empty state:", err);
        }
      },
    }
  );

  const { data: vibeIdData, error: vibeIdError } = useSWR<any | null>(
    userId && !useMockData ? `/profile-data/vibe-id/${userId}` : null,
    () => fetchVibeId(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 300000, // VibeIDå˜åŒ–è¾ƒå°‘ï¼Œ5åˆ†é’Ÿå†…ä¸é‡å¤è¯·æ±‚
      onError: (err) => {
        if (process.env.NODE_ENV === "development") {
          console.warn("VibeID API failed, component will show empty state:", err);
        }
      },
    }
  );

  // å¼€å‘ç¯å¢ƒæç¤ºï¼šå¦‚ä½•ä½¿ç”¨mockæ•°æ®
  if (process.env.NODE_ENV === "development" && !useMockData && !userId) {
    console.info(
      "ğŸ’¡ å¼€å‘æç¤ºï¼šè¦æµ‹è¯•Meé¡µé¢UIï¼Œå¯ä»¥åœ¨æ§åˆ¶å°è¿è¡Œï¼š\n" +
        "localStorage.setItem('useMockProfileData', 'true')\n" +
        "ç„¶ååˆ·æ–°é¡µé¢ã€‚"
    );
  }

  const isLoading = (!baziData && !baziError) || (!zodiacData && !zodiacError) || (!vibeIdData && !vibeIdError);
  const isError = !!baziError || !!zodiacError || !!vibeIdError;

  return {
    baziData,
    zodiacData,
    vibeIdData,
    isLoading,
    isError,
  };
}

/**
 * å•ç‹¬è·å–å…«å­—æ•°æ®
 */
export function useBaziData(userId: string | null | undefined) {
  return useSWR<BaziData | null>(
    userId ? `/profile-data/bazi/${userId}` : null,
    () => fetchBaziSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000,
    }
  );
}

/**
 * å•ç‹¬è·å–æ˜Ÿåº§æ•°æ®
 */
export function useZodiacData(userId: string | null | undefined) {
  return useSWR<ZodiacData | null>(
    userId ? `/profile-data/zodiac/${userId}` : null,
    () => fetchZodiacSummary(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 60000,
    }
  );
}

/**
 * å•ç‹¬è·å–VibeIDæ•°æ®
 */
export function useVibeIdData(userId: string | null | undefined) {
  return useSWR<any | null>(
    userId ? `/profile-data/vibe-id/${userId}` : null,
    () => fetchVibeId(userId!),
    {
      revalidateOnFocus: false,
      dedupingInterval: 300000,
    }
  );
}
