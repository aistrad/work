"""
VibeLife Frontend E2E Test Script
Tests all major frontend functionality
"""
from playwright.sync_api import sync_playwright
import os
import json

SCREENSHOTS_DIR = "/tmp/vibelife_screenshots"
os.makedirs(SCREENSHOTS_DIR, exist_ok=True)

BASE_URL = "http://106.37.170.238:8230"

def test_homepage(page):
    """Test homepage loads correctly"""
    print("\n=== Testing Homepage ===")
    page.goto(BASE_URL)
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/01_homepage.png", full_page=True)

    title = page.title()
    print(f"Title: {title}")

    # Check for key elements
    body_text = page.locator('body').inner_text()
    print(f"Page loaded: {len(body_text)} characters")

    return True

def test_chat_page(page):
    """Test chat page and components"""
    print("\n=== Testing Chat Page ===")
    page.goto(f"{BASE_URL}/chat")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/02_chat_page.png", full_page=True)

    # Check for chat components
    # Look for DailyGreeting
    greeting_exists = page.locator('text=早安').count() > 0 or \
                      page.locator('text=午后').count() > 0 or \
                      page.locator('text=晚间').count() > 0
    print(f"DailyGreeting component: {'✅' if greeting_exists else '⚠️ Not visible (time-dependent)'}")

    # Look for quick prompts
    prompts = page.locator('button:has-text("我是1990")').count()
    print(f"Quick prompts found: {prompts > 0}")

    # Look for chat input
    input_exists = page.locator('textarea, input[type="text"]').count() > 0
    print(f"Chat input: {'✅' if input_exists else '❌'}")

    return True

def test_chat_bazi(page):
    """Test bazi chat skill page"""
    print("\n=== Testing Bazi Chat ===")
    page.goto(f"{BASE_URL}/chat/bazi")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/03_chat_bazi.png", full_page=True)

    # Check for bazi-specific content
    bazi_text = page.locator('text=八字').count() > 0 or \
                page.locator('text=命理').count() > 0
    print(f"Bazi content: {'✅' if bazi_text else '❌'}")

    return True

def test_chat_zodiac(page):
    """Test zodiac chat skill page"""
    print("\n=== Testing Zodiac Chat ===")
    page.goto(f"{BASE_URL}/chat/zodiac")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/04_chat_zodiac.png", full_page=True)

    # Check for zodiac-specific content
    zodiac_text = page.locator('text=星座').count() > 0 or \
                  page.locator('text=星辰').count() > 0
    print(f"Zodiac content: {'✅' if zodiac_text else '❌'}")

    return True

def test_me_page(page):
    """Test user profile page"""
    print("\n=== Testing Me Page ===")
    page.goto(f"{BASE_URL}/me")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/05_me_page.png", full_page=True)

    body_text = page.locator('body').inner_text()
    print(f"Me page loaded: {len(body_text)} characters")

    return True

def test_chart_page(page):
    """Test chart page"""
    print("\n=== Testing Chart Page ===")
    page.goto(f"{BASE_URL}/chart")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/06_chart_page.png", full_page=True)

    body_text = page.locator('body').inner_text()
    print(f"Chart page loaded: {len(body_text)} characters")

    return True

def test_kline_page(page):
    """Test K-Line chart page"""
    print("\n=== Testing K-Line Page ===")
    page.goto(f"{BASE_URL}/chart/kline")
    page.wait_for_load_state('networkidle')
    page.wait_for_timeout(1000)  # Wait for chart to render
    page.screenshot(path=f"{SCREENSHOTS_DIR}/07_kline_page.png", full_page=True)

    # Check for SVG or canvas (chart element)
    chart_exists = page.locator('svg, canvas').count() > 0
    print(f"Chart element: {'✅' if chart_exists else '⚠️'}")

    return True

def test_relationship_page(page):
    """Test relationship analysis page"""
    print("\n=== Testing Relationship Page ===")
    page.goto(f"{BASE_URL}/relationship")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/08_relationship_page.png", full_page=True)

    # Look for relationship content
    rel_text = page.locator('text=关系').count() > 0
    print(f"Relationship content: {'✅' if rel_text else '⚠️'}")

    return True

def test_journey_page(page):
    """Test journey page"""
    print("\n=== Testing Journey Page ===")
    page.goto(f"{BASE_URL}/journey")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/09_journey_page.png", full_page=True)

    body_text = page.locator('body').inner_text()
    print(f"Journey page loaded: {len(body_text)} characters")

    return True

def test_auth_pages(page):
    """Test auth pages"""
    print("\n=== Testing Auth Pages ===")

    # Login page
    page.goto(f"{BASE_URL}/auth/login")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/10_login_page.png", full_page=True)

    login_form = page.locator('input[type="email"], input[type="text"], button').count() > 0
    print(f"Login page: {'✅' if login_form else '⚠️'}")

    # Register page
    page.goto(f"{BASE_URL}/auth/register")
    page.wait_for_load_state('networkidle')
    page.screenshot(path=f"{SCREENSHOTS_DIR}/11_register_page.png", full_page=True)

    register_form = page.locator('input, button').count() > 0
    print(f"Register page: {'✅' if register_form else '⚠️'}")

    return True

def test_chat_interaction(page):
    """Test chat interaction (send message)"""
    print("\n=== Testing Chat Interaction ===")
    page.goto(f"{BASE_URL}/chat")
    page.wait_for_load_state('networkidle')
    page.wait_for_timeout(500)

    # Try clicking a quick prompt button
    quick_prompt = page.locator('button:has-text("1990")').first
    if quick_prompt.count() > 0:
        print("Found quick prompt button, clicking...")
        quick_prompt.click()
        page.wait_for_timeout(2000)  # Wait for response
        page.screenshot(path=f"{SCREENSHOTS_DIR}/12_chat_interaction.png", full_page=True)
        print("Chat interaction: ✅ Message sent")
    else:
        # Try typing in input
        input_field = page.locator('textarea').first
        if input_field.count() > 0:
            input_field.fill("你好")
            page.screenshot(path=f"{SCREENSHOTS_DIR}/12_chat_input.png", full_page=True)
            print("Chat input: ✅ Text entered")
        else:
            print("Chat interaction: ⚠️ No input found")

    return True

def main():
    print("=" * 60)
    print("VibeLife Frontend E2E Tests")
    print("=" * 60)

    results = {}

    with sync_playwright() as p:
        browser = p.chromium.launch(headless=True)
        context = browser.new_context(
            viewport={'width': 375, 'height': 812},  # Mobile viewport
            user_agent='Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15'
        )
        page = context.new_page()

        # Enable console logging
        page.on('console', lambda msg: print(f"[Console] {msg.type}: {msg.text}") if msg.type == 'error' else None)

        tests = [
            ("Homepage", test_homepage),
            ("Chat Page", test_chat_page),
            ("Bazi Chat", test_chat_bazi),
            ("Zodiac Chat", test_chat_zodiac),
            ("Me Page", test_me_page),
            ("Chart Page", test_chart_page),
            ("K-Line Page", test_kline_page),
            ("Relationship Page", test_relationship_page),
            ("Journey Page", test_journey_page),
            ("Auth Pages", test_auth_pages),
            ("Chat Interaction", test_chat_interaction),
        ]

        for name, test_fn in tests:
            try:
                result = test_fn(page)
                results[name] = "✅ PASS" if result else "❌ FAIL"
            except Exception as e:
                results[name] = f"❌ ERROR: {str(e)[:50]}"
                print(f"Error in {name}: {e}")

        browser.close()

    # Summary
    print("\n" + "=" * 60)
    print("Test Summary")
    print("=" * 60)
    for name, result in results.items():
        print(f"  {name}: {result}")

    print(f"\nScreenshots saved to: {SCREENSHOTS_DIR}")

    passed = sum(1 for r in results.values() if r.startswith("✅"))
    total = len(results)
    print(f"\nResults: {passed}/{total} tests passed")

if __name__ == "__main__":
    main()
