"use client";

/**
 * AppShell - ä¸‰æ å¸ƒå±€å®¹å™¨
 * Based on: vibelife spec v3.0
 *
 * PCç«¯å¸ƒå±€:
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚ NavBar â”‚         ä¸»å†…å®¹åŒºåŸŸ             â”‚    Insight Panel       â”‚
 * â”‚ (64px) â”‚          (flex-1)              â”‚       (360px)          â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 *
 * ç§»åŠ¨ç«¯å¸ƒå±€:
 * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 * â”‚  Header                                  â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  å†…å®¹åŒºåŸŸ (æ ¹æ®Tabå®Œå…¨åˆ‡æ¢)              â”‚
 * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 * â”‚  ğŸ’¬ Chat â”‚ ğŸ“Š Chart â”‚ ğŸ›¤ Journey â”‚ ğŸ‘¤ Me â”‚
 * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
 */

import { useState, createContext, useContext, ReactNode } from "react";
import { usePathname } from "next/navigation";
import { cn } from "@/lib/utils";
import { type SkillType } from "@/components/core";
import { NavBar } from "./NavBar";
import { MobileTabBar } from "./MobileTabBar";
import { MobileHeader } from "./MobileHeader";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export type TabType = "chat" | "chart" | "journey" | "me";

interface AppShellContextValue {
  skill: SkillType;
  activeTab: TabType;
  setActiveTab: (tab: TabType) => void;
  voiceMode: "warm" | "sarcastic";
  setVoiceMode: (mode: "warm" | "sarcastic") => void;
}

const AppShellContext = createContext<AppShellContextValue | null>(null);

export function useAppShell() {
  const context = useContext(AppShellContext);
  if (!context) {
    throw new Error("useAppShell must be used within AppShell");
  }
  return context;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AppShell Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface AppShellProps {
  skill: SkillType;
  children: ReactNode;
  /** å³ä¾§ Panel å†…å®¹ - æ ¹æ® activeTab ä¼ å…¥ä¸åŒå†…å®¹ */
  panelContent?: ReactNode;
  /** åˆå§‹æ¿€æ´»çš„ Tab */
  defaultTab?: TabType;
}

export function AppShell({
  skill,
  children,
  panelContent,
  defaultTab = "chat",
}: AppShellProps) {
  const [activeTab, setActiveTab] = useState<TabType>(defaultTab);
  const [voiceMode, setVoiceMode] = useState<"warm" | "sarcastic">("warm");

  const contextValue: AppShellContextValue = {
    skill,
    activeTab,
    setActiveTab,
    voiceMode,
    setVoiceMode,
  };

  return (
    <AppShellContext.Provider value={contextValue}>
      <div className="h-screen flex flex-col bg-background">
        {/* Mobile Header - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
        <div className="lg:hidden">
          <MobileHeader skill={skill} />
        </div>

        {/* Main Content Area */}
        <div className="flex-1 flex overflow-hidden">
          {/* Left NavBar - ä»… PC ç«¯æ˜¾ç¤º */}
          <div className="hidden lg:block">
            <NavBar
              skill={skill}
              activeTab={activeTab}
              onTabChange={setActiveTab}
            />
          </div>

          {/* Center - ä¸»å†…å®¹åŒºåŸŸ (PCç«¯å§‹ç»ˆæ˜¯Chatï¼Œç§»åŠ¨ç«¯æ ¹æ®Tabåˆ‡æ¢) */}
          <main className="flex-1 overflow-hidden">
            {/* PCç«¯: å§‹ç»ˆæ˜¾ç¤º children (Chat) */}
            <div className="hidden lg:block h-full">
              {children}
            </div>

            {/* ç§»åŠ¨ç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
            <div className="lg:hidden h-full">
              <MobileContent
                activeTab={activeTab}
                chatContent={children}
                panelContent={panelContent}
              />
            </div>
          </main>

          {/* Right Panel - ä»… PC ç«¯æ˜¾ç¤º */}
          <aside className="hidden lg:block w-[360px] flex-shrink-0 border-l border-border overflow-y-auto">
            {panelContent}
          </aside>
        </div>

        {/* Mobile TabBar - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
        <div className="lg:hidden">
          <MobileTabBar activeTab={activeTab} onTabChange={setActiveTab} />
        </div>
      </div>
    </AppShellContext.Provider>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MobileContent - ç§»åŠ¨ç«¯å†…å®¹åˆ‡æ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface MobileContentProps {
  activeTab: TabType;
  chatContent: ReactNode;
  panelContent?: ReactNode;
}

function MobileContent({ activeTab, chatContent, panelContent }: MobileContentProps) {
  // ç§»åŠ¨ç«¯æ ¹æ® Tab å®Œå…¨åˆ‡æ¢å†…å®¹
  switch (activeTab) {
    case "chat":
      return <div className="h-full">{chatContent}</div>;
    case "chart":
    case "journey":
    case "me":
      return (
        <div className="h-full overflow-y-auto">
          {panelContent || (
            <div className="flex items-center justify-center h-full text-muted-foreground">
              {activeTab === "chart" && "å›¾è¡¨/æŠ¥å‘Š"}
              {activeTab === "journey" && "å›é¡¾/æ—¶é—´çº¿"}
              {activeTab === "me" && "ä¸ªäººè®¾ç½®"}
            </div>
          )}
        </div>
      );
    default:
      return null;
  }
}
