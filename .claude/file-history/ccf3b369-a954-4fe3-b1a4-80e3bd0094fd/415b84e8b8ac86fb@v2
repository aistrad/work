"use client";
import { useRef, useEffect, useMemo } from "react";
import ReactECharts from "echarts-for-react";
import type { EChartsOption } from "echarts";
import { cn } from "@/lib/utils";

/**
 * LifeKLine - 人生运势 K 线图
 *
 * 用途: 可视化人生不同阶段的运势起伏
 * 特性:
 *   - 支持年运/大运切换
 *   - 当前位置高亮
 *   - 点击查看详情
 *   - 墨色主题适配
 */

export interface FortuneDataPoint {
  /** 时间标签 (年份或大运区间) */
  label: string;
  /** 开始值 (用于 K 线) */
  open: number;
  /** 最高值 */
  high: number;
  /** 最低值 */
  low: number;
  /** 结束值 */
  close: number;
  /** 是否为当前周期 */
  isCurrent?: boolean;
  /** 简要描述 */
  summary?: string;
  /** 详细信息 */
  detail?: {
    keywords: string[];
    advice?: string;
  };
}

export interface LifeKLineProps {
  /** 运势数据 */
  data: FortuneDataPoint[];
  /** 图表标题 */
  title?: string;
  /** 时间维度 */
  dimension?: "year" | "dayun";
  /** 高度 */
  height?: number;
  /** 点击回调 */
  onPointClick?: (point: FortuneDataPoint, index: number) => void;
  /** 额外 className */
  className?: string;
}

// 墨色主题配色
const THEME = {
  // 背景与边框
  bg: "rgba(15, 15, 15, 0.6)",
  border: "rgba(255, 255, 255, 0.1)",
  // 文字
  textPrimary: "rgba(255, 255, 255, 0.9)",
  textSecondary: "rgba(255, 255, 255, 0.5)",
  // K 线颜色
  bullish: "#10b981", // 翠绿 - 上涨
  bearish: "#ef4444", // 朱红 - 下跌
  bullishBg: "rgba(16, 185, 129, 0.2)",
  bearishBg: "rgba(239, 68, 68, 0.2)",
  // 高亮
  highlight: "#fbbf24", // 琥珀 - 当前
  highlightBg: "rgba(251, 191, 36, 0.3)",
  // 网格
  grid: "rgba(255, 255, 255, 0.05)",
  // 辅助线
  line: "rgba(255, 255, 255, 0.2)",
};

export function LifeKLine({
  data,
  title,
  dimension = "year",
  height = 320,
  onPointClick,
  className,
}: LifeKLineProps) {
  const chartRef = useRef<ReactECharts>(null);

  // 找到当前位置索引
  const currentIndex = useMemo(
    () => data.findIndex((d) => d.isCurrent),
    [data]
  );

  // 转换为 ECharts 数据格式
  const chartData = useMemo(() => {
    return data.map((d) => [d.open, d.close, d.low, d.high]);
  }, [data]);

  // 标记当前位置
  const markPointData = useMemo(() => {
    if (currentIndex < 0) return [];
    const current = data[currentIndex];
    return [
      {
        name: "current",
        coord: [currentIndex, current.high],
        value: "当前",
        itemStyle: { color: THEME.highlight },
      },
    ];
  }, [data, currentIndex]);

  // 构建 ECharts 配置
  const option: EChartsOption = useMemo(
    () => ({
      backgroundColor: "transparent",
      title: title
        ? {
            text: title,
            left: "center",
            top: 8,
            textStyle: {
              color: THEME.textPrimary,
              fontSize: 14,
              fontWeight: 500,
            },
          }
        : undefined,
      tooltip: {
        trigger: "axis",
        backgroundColor: THEME.bg,
        borderColor: THEME.border,
        borderWidth: 1,
        textStyle: {
          color: THEME.textPrimary,
          fontSize: 12,
        },
        formatter: (params: any) => {
          const idx = params[0]?.dataIndex;
          if (idx === undefined || !data[idx]) return "";
          const d = data[idx];
          return `
            <div style="padding: 4px 0;">
              <div style="font-weight: 500; margin-bottom: 4px;">${d.label}${d.isCurrent ? " <span style='color: #fbbf24;'>(当前)</span>" : ""}</div>
              <div style="color: rgba(255,255,255,0.6); font-size: 11px;">
                高: ${d.high} | 低: ${d.low}<br/>
                ${d.summary || ""}
              </div>
            </div>
          `;
        },
      },
      grid: {
        left: 40,
        right: 20,
        top: title ? 50 : 20,
        bottom: 40,
      },
      xAxis: {
        type: "category",
        data: data.map((d) => d.label),
        axisLine: { lineStyle: { color: THEME.line } },
        axisTick: { show: false },
        axisLabel: {
          color: THEME.textSecondary,
          fontSize: 10,
          interval: dimension === "year" ? "auto" : 0,
          rotate: dimension === "year" ? 0 : 30,
        },
        splitLine: { show: false },
      },
      yAxis: {
        type: "value",
        min: 0,
        max: 100,
        splitNumber: 4,
        axisLine: { show: false },
        axisTick: { show: false },
        axisLabel: {
          color: THEME.textSecondary,
          fontSize: 10,
          formatter: "{value}",
        },
        splitLine: {
          lineStyle: {
            color: THEME.grid,
            type: "dashed",
          },
        },
      },
      series: [
        {
          name: "运势",
          type: "candlestick",
          data: chartData,
          itemStyle: {
            color: THEME.bullish, // 上涨填充色
            color0: THEME.bearish, // 下跌填充色
            borderColor: THEME.bullish, // 上涨边框
            borderColor0: THEME.bearish, // 下跌边框
          },
          markPoint: {
            symbol: "pin",
            symbolSize: 30,
            data: markPointData,
            label: {
              color: "#000",
              fontSize: 10,
              fontWeight: 500,
            },
          },
          markLine:
            currentIndex >= 0
              ? {
                  silent: true,
                  symbol: "none",
                  lineStyle: {
                    color: THEME.highlight,
                    type: "dashed",
                    width: 1,
                    opacity: 0.6,
                  },
                  data: [{ xAxis: currentIndex }],
                }
              : undefined,
        },
        // 背景高亮区域
        {
          name: "highlight",
          type: "scatter",
          symbolSize: 0,
          data:
            currentIndex >= 0
              ? [[currentIndex, data[currentIndex].close]]
              : [],
          markArea:
            currentIndex >= 0
              ? {
                  silent: true,
                  itemStyle: {
                    color: THEME.highlightBg,
                  },
                  data: [
                    [
                      { xAxis: currentIndex - 0.5 },
                      { xAxis: currentIndex + 0.5 },
                    ],
                  ],
                }
              : undefined,
        },
      ],
      // 数据缩放
      dataZoom:
        data.length > 12
          ? [
              {
                type: "inside",
                start: Math.max(0, ((currentIndex - 6) / data.length) * 100),
                end: Math.min(100, ((currentIndex + 6) / data.length) * 100),
              },
            ]
          : undefined,
    }),
    [data, chartData, currentIndex, markPointData, title, dimension]
  );

  // 点击事件
  const onEvents = useMemo(
    () => ({
      click: (params: any) => {
        if (params.dataIndex !== undefined && onPointClick) {
          onPointClick(data[params.dataIndex], params.dataIndex);
        }
      },
    }),
    [data, onPointClick]
  );

  return (
    <div
      className={cn(
        "rounded-xl border border-white/10 bg-black/40 backdrop-blur-sm overflow-hidden",
        className
      )}
    >
      <ReactECharts
        ref={chartRef}
        option={option}
        style={{ height, width: "100%" }}
        onEvents={onEvents}
        opts={{ renderer: "canvas" }}
        notMerge={true}
      />

      {/* 图例说明 */}
      <div className="flex items-center justify-center gap-6 pb-3 text-xs text-white/50">
        <div className="flex items-center gap-1.5">
          <div className="w-3 h-3 rounded-sm bg-emerald-500/60" />
          <span>上升期</span>
        </div>
        <div className="flex items-center gap-1.5">
          <div className="w-3 h-3 rounded-sm bg-red-500/60" />
          <span>回调期</span>
        </div>
        <div className="flex items-center gap-1.5">
          <div className="w-3 h-3 rounded-sm bg-amber-400/60" />
          <span>当前</span>
        </div>
      </div>
    </div>
  );
}

// ============ Demo 数据生成 ============

/**
 * 生成示例大运数据
 */
export function generateDayunData(
  birthYear: number,
  count: number = 8
): FortuneDataPoint[] {
  const currentYear = new Date().getFullYear();
  const result: FortuneDataPoint[] = [];

  for (let i = 0; i < count; i++) {
    const startAge = 2 + i * 10;
    const endAge = startAge + 9;
    const startYear = birthYear + startAge;
    const endYear = birthYear + endAge;

    // 随机生成运势值
    const base = 40 + Math.random() * 30;
    const fluctuation = 15 + Math.random() * 20;

    const open = Math.round(base + (Math.random() - 0.5) * 10);
    const close = Math.round(base + (Math.random() - 0.5) * 10);
    const high = Math.round(Math.max(open, close) + fluctuation * Math.random());
    const low = Math.round(
      Math.min(open, close) - fluctuation * Math.random()
    );

    const isCurrent =
      currentYear >= startYear && currentYear <= endYear;

    result.push({
      label: `${startAge}-${endAge}岁`,
      open: Math.max(10, Math.min(90, open)),
      high: Math.max(10, Math.min(95, high)),
      low: Math.max(5, Math.min(85, low)),
      close: Math.max(10, Math.min(90, close)),
      isCurrent,
      summary: isCurrent ? "当前大运周期" : undefined,
    });
  }

  return result;
}

/**
 * 生成示例流年数据
 */
export function generateYearData(
  startYear: number,
  count: number = 10
): FortuneDataPoint[] {
  const currentYear = new Date().getFullYear();
  const result: FortuneDataPoint[] = [];

  for (let i = 0; i < count; i++) {
    const year = startYear + i;
    const base = 45 + Math.sin(i * 0.8) * 20 + Math.random() * 10;

    const open = Math.round(base + (Math.random() - 0.5) * 8);
    const close = Math.round(base + (Math.random() - 0.5) * 8);
    const high = Math.round(Math.max(open, close) + 5 + Math.random() * 10);
    const low = Math.round(Math.min(open, close) - 5 - Math.random() * 10);

    result.push({
      label: `${year}`,
      open: Math.max(10, Math.min(90, open)),
      high: Math.max(10, Math.min(95, high)),
      low: Math.max(5, Math.min(85, low)),
      close: Math.max(10, Math.min(90, close)),
      isCurrent: year === currentYear,
      summary: year === currentYear ? "今年" : undefined,
    });
  }

  return result;
}

export default LifeKLine;
