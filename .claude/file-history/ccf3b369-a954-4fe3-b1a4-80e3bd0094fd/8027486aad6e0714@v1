"use client";

/**
 * ChatPanel - Chat Tab 的右侧 Panel 内容
 * 显示: 命盘/星盘摘要 + 洞察卡片列表 + 关系模拟器入口
 */

import { useState } from "react";
import { cn } from "@/lib/utils";
import { VibeGlyph, type SkillType } from "@/components/core";
import { InsightCard, MiniInsightCard, type InsightType } from "@/components/insight/InsightCard";
import { Users, ChevronRight } from "lucide-react";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface ProfileData {
  // Bazi
  dayMaster?: string;
  pattern?: string;
  currentLuck?: string;
  pillars?: {
    year: { stem: string; branch: string };
    month: { stem: string; branch: string };
    day: { stem: string; branch: string };
    hour?: { stem: string; branch: string };
  };
  // Zodiac
  sunSign?: string;
  moonSign?: string;
  risingSign?: string;
  // MBTI
  mbtiType?: string;
}

interface InsightItem {
  id: string;
  type: InsightType;
  title: string;
  content: string;
}

interface ChatPanelProps {
  skill: SkillType;
  profile?: ProfileData | null;
  insights?: InsightItem[];
  onViewFullProfile?: () => void;
  onInsightClick?: (insight: InsightItem) => void;
  onOpenRelationship?: () => void;
  className?: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Skill Profile Labels
// ═══════════════════════════════════════════════════════════════════════════

const SKILL_LABELS: Record<SkillType, { title: string; viewLabel: string }> = {
  bazi: { title: "你的命盘", viewLabel: "查看完整命盘" },
  zodiac: { title: "你的星盘", viewLabel: "查看完整星盘" },
  mbti: { title: "你的人格档案", viewLabel: "查看完整档案" },
  attach: { title: "你的依恋档案", viewLabel: "查看完整档案" },
  career: { title: "你的职业档案", viewLabel: "查看完整档案" },
};

// ═══════════════════════════════════════════════════════════════════════════
// Profile Cards
// ═══════════════════════════════════════════════════════════════════════════

function BaziProfileCard({ profile, onViewFull }: { profile: ProfileData; onViewFull?: () => void }) {
  if (!profile.pillars) return null;

  return (
    <div className="glass-card rounded-xl p-4 space-y-4">
      <div className="grid grid-cols-3 gap-2 text-center">
        <div className="space-y-1">
          <span className="text-xs text-muted-foreground">年柱</span>
          <div className="font-serif text-lg text-foreground">{profile.pillars.year.stem}</div>
          <div className="font-serif text-base text-muted-foreground">{profile.pillars.year.branch}</div>
        </div>
        <div className="space-y-1">
          <span className="text-xs text-muted-foreground">月柱</span>
          <div className="font-serif text-lg text-foreground">{profile.pillars.month.stem}</div>
          <div className="font-serif text-base text-muted-foreground">{profile.pillars.month.branch}</div>
        </div>
        <div className="space-y-1">
          <span className="text-xs text-muted-foreground">日柱</span>
          <div className="font-serif text-lg text-foreground">{profile.pillars.day.stem}</div>
          <div className="font-serif text-base text-muted-foreground">{profile.pillars.day.branch}</div>
        </div>
      </div>

      <div className="space-y-1.5 text-sm">
        {profile.dayMaster && (
          <div className="flex justify-between">
            <span className="text-muted-foreground">日主</span>
            <span className="font-medium text-foreground">{profile.dayMaster}</span>
          </div>
        )}
        {profile.pattern && (
          <div className="flex justify-between">
            <span className="text-muted-foreground">格局</span>
            <span className="font-medium text-foreground">{profile.pattern}</span>
          </div>
        )}
        {profile.currentLuck && (
          <div className="flex justify-between">
            <span className="text-muted-foreground">当前大运</span>
            <span className="font-medium text-foreground">{profile.currentLuck}</span>
          </div>
        )}
      </div>

      {onViewFull && (
        <button
          onClick={onViewFull}
          className="w-full text-center text-sm text-skill-primary hover:underline py-2"
        >
          查看完整命盘
        </button>
      )}
    </div>
  );
}

function ZodiacProfileCard({ profile, onViewFull }: { profile: ProfileData; onViewFull?: () => void }) {
  return (
    <div className="glass-card rounded-xl p-4 space-y-4">
      <div className="grid grid-cols-3 gap-2 text-center">
        {profile.sunSign && (
          <div className="space-y-1">
            <span className="text-xs text-muted-foreground">太阳</span>
            <div className="font-serif text-lg text-foreground">{profile.sunSign}</div>
          </div>
        )}
        {profile.moonSign && (
          <div className="space-y-1">
            <span className="text-xs text-muted-foreground">月亮</span>
            <div className="font-serif text-lg text-foreground">{profile.moonSign}</div>
          </div>
        )}
        {profile.risingSign && (
          <div className="space-y-1">
            <span className="text-xs text-muted-foreground">上升</span>
            <div className="font-serif text-lg text-foreground">{profile.risingSign}</div>
          </div>
        )}
      </div>

      {onViewFull && (
        <button
          onClick={onViewFull}
          className="w-full text-center text-sm text-skill-primary hover:underline py-2"
        >
          查看完整星盘
        </button>
      )}
    </div>
  );
}

function MbtiProfileCard({ profile, onViewFull }: { profile: ProfileData; onViewFull?: () => void }) {
  return (
    <div className="glass-card rounded-xl p-4 space-y-4">
      <div className="text-center">
        <div className="font-serif text-3xl font-bold text-foreground tracking-wider">
          {profile.mbtiType}
        </div>
      </div>

      {onViewFull && (
        <button
          onClick={onViewFull}
          className="w-full text-center text-sm text-skill-primary hover:underline py-2"
        >
          查看完整档案
        </button>
      )}
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// ChatPanel Component
// ═══════════════════════════════════════════════════════════════════════════

export function ChatPanel({
  skill,
  profile,
  insights = [],
  onViewFullProfile,
  onInsightClick,
  onOpenRelationship,
  className,
}: ChatPanelProps) {
  const labels = SKILL_LABELS[skill];

  const renderProfileCard = () => {
    if (!profile) {
      return (
        <div className="glass-card rounded-xl p-4 text-center">
          <VibeGlyph size="md" skill={skill} className="mx-auto mb-3" />
          <p className="text-sm text-muted-foreground">
            开始对话后，这里会显示你的档案摘要
          </p>
        </div>
      );
    }

    switch (skill) {
      case "bazi":
        return <BaziProfileCard profile={profile} onViewFull={onViewFullProfile} />;
      case "zodiac":
        return <ZodiacProfileCard profile={profile} onViewFull={onViewFullProfile} />;
      case "mbti":
        return <MbtiProfileCard profile={profile} onViewFull={onViewFullProfile} />;
      default:
        return null;
    }
  };

  return (
    <div className={cn("h-full overflow-y-auto p-5 space-y-6", className)}>
      {/* Profile Section */}
      <section>
        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
          {labels.title}
        </h2>
        {renderProfileCard()}
      </section>

      {/* Relationship Simulator Entry */}
      <section>
        <button
          onClick={onOpenRelationship}
          className="w-full flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-pink-50 to-purple-50 dark:from-pink-900/20 dark:to-purple-900/20 border border-pink-200/50 dark:border-pink-800/30 hover:shadow-md transition-all"
        >
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-pink-100 dark:bg-pink-900/40 flex items-center justify-center">
              <Users className="w-5 h-5 text-pink-600 dark:text-pink-400" />
            </div>
            <div className="text-left">
              <div className="font-medium text-foreground">关系模拟器</div>
              <div className="text-xs text-muted-foreground">分析你与TA的关系契合度</div>
            </div>
          </div>
          <ChevronRight className="w-5 h-5 text-muted-foreground" />
        </button>
      </section>

      {/* Insights Section */}
      {insights.length > 0 && (
        <section>
          <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
            洞察卡片
          </h2>
          <div className="space-y-3">
            {insights.map((insight) => (
              <MiniInsightCard
                key={insight.id}
                type={insight.type}
                title={insight.title}
                onClick={() => onInsightClick?.(insight)}
              />
            ))}
          </div>
        </section>
      )}
    </div>
  );
}
