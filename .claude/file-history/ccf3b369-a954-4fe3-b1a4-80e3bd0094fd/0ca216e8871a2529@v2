"use client";
import { useState, useMemo } from "react";
import { motion, AnimatePresence } from "framer-motion";
import Image from "next/image";
import { cn } from "@/lib/utils";
import {
  Heart,
  Users,
  Briefcase,
  Sparkles,
  AlertTriangle,
  ChevronDown,
  ArrowRight,
  Zap,
} from "lucide-react";

/**
 * RelationshipCard - 关系分析卡片
 *
 * 用途: 展示两人关系的契合度与互动建议
 * 特性:
 *   - 多维度评分展示
 *   - 关系类型标签
 *   - 展开查看详情
 *   - 建议话术
 */

export interface PersonProfile {
  name: string;
  avatar?: string;
  birthDate?: string;
  sign?: string; // 星座/生肖
  element?: string; // 五行属性
}

export interface DimensionScore {
  /** 维度名称 */
  name: string;
  /** 评分 0-100 */
  score: number;
  /** 简要说明 */
  comment?: string;
  /** 图标类型 */
  icon?: "heart" | "work" | "spark" | "alert";
}

export interface RelationshipCardProps {
  /** 主体人物 */
  person1: PersonProfile;
  /** 对象人物 */
  person2: PersonProfile;
  /** 关系类型 */
  relationType: "romantic" | "friend" | "business" | "family";
  /** 总体契合度 0-100 */
  overallScore: number;
  /** 分维度评分 */
  dimensions: DimensionScore[];
  /** 关系关键词 */
  keywords?: string[];
  /** 互动建议 */
  suggestions?: string[];
  /** 注意事项 */
  warnings?: string[];
  /** 额外 className */
  className?: string;
}

// 关系类型配置
const RELATION_CONFIG: Record<
  string,
  { label: string; color: string; bgColor: string }
> = {
  romantic: {
    label: "情感关系",
    color: "text-pink-400",
    bgColor: "bg-pink-500/20",
  },
  friend: {
    label: "友谊关系",
    color: "text-blue-400",
    bgColor: "bg-blue-500/20",
  },
  business: {
    label: "事业伙伴",
    color: "text-amber-400",
    bgColor: "bg-amber-500/20",
  },
  family: {
    label: "家庭关系",
    color: "text-emerald-400",
    bgColor: "bg-emerald-500/20",
  },
};

// 图标映射
const ICON_MAP = {
  heart: Heart,
  work: Briefcase,
  spark: Sparkles,
  alert: AlertTriangle,
};

// 评分等级颜色
function getScoreColor(score: number): string {
  if (score >= 80) return "text-emerald-400";
  if (score >= 60) return "text-blue-400";
  if (score >= 40) return "text-amber-400";
  return "text-red-400";
}

function getScoreBarColor(score: number): string {
  if (score >= 80) return "bg-emerald-500";
  if (score >= 60) return "bg-blue-500";
  if (score >= 40) return "bg-amber-500";
  return "bg-red-500";
}

function getScoreLabel(score: number): string {
  if (score >= 85) return "绝佳";
  if (score >= 70) return "良好";
  if (score >= 55) return "一般";
  if (score >= 40) return "需磨合";
  return "挑战";
}

export function RelationshipCard({
  person1,
  person2,
  relationType,
  overallScore,
  dimensions,
  keywords = [],
  suggestions = [],
  warnings = [],
  className,
}: RelationshipCardProps) {
  const [expanded, setExpanded] = useState(false);

  const relationConfig = RELATION_CONFIG[relationType] || RELATION_CONFIG.friend;

  // 头像占位
  const Avatar = ({ name, avatar }: { name: string; avatar?: string }) => (
    <div className="relative">
      {avatar ? (
        <Image
          src={avatar}
          alt={name}
          width={56}
          height={56}
          className="w-14 h-14 rounded-full object-cover border-2 border-white/20"
        />
      ) : (
        <div className="w-14 h-14 rounded-full bg-white/10 border-2 border-white/20 flex items-center justify-center">
          <span className="text-lg font-medium text-white/80">
            {name.charAt(0)}
          </span>
        </div>
      )}
    </div>
  );

  return (
    <motion.div
      layout
      className={cn(
        "rounded-xl border border-white/10 bg-black/40 backdrop-blur-sm overflow-hidden",
        className
      )}
    >
      {/* 头部: 人物对比 */}
      <div className="p-4">
        <div className="flex items-center justify-between">
          {/* 人物1 */}
          <div className="flex flex-col items-center gap-1">
            <Avatar name={person1.name} avatar={person1.avatar} />
            <span className="text-sm text-white/90">{person1.name}</span>
            {person1.sign && (
              <span className="text-xs text-white/50">{person1.sign}</span>
            )}
          </div>

          {/* 关系连接 */}
          <div className="flex-1 flex flex-col items-center gap-2 px-4">
            {/* 关系类型标签 */}
            <span
              className={cn(
                "px-3 py-1 rounded-full text-xs font-medium",
                relationConfig.bgColor,
                relationConfig.color
              )}
            >
              {relationConfig.label}
            </span>

            {/* 连接线 */}
            <div className="w-full flex items-center gap-2">
              <div className="flex-1 h-px bg-gradient-to-r from-transparent via-white/30 to-transparent" />
              <motion.div
                animate={{ scale: [1, 1.1, 1] }}
                transition={{ duration: 2, repeat: Infinity }}
              >
                <Zap className="w-4 h-4 text-amber-400" />
              </motion.div>
              <div className="flex-1 h-px bg-gradient-to-r from-transparent via-white/30 to-transparent" />
            </div>

            {/* 总体评分 */}
            <div className="text-center">
              <span className={cn("text-2xl font-bold", getScoreColor(overallScore))}>
                {overallScore}
              </span>
              <span className="text-white/40 text-sm ml-1">/ 100</span>
              <div className="text-xs text-white/50 mt-0.5">
                {getScoreLabel(overallScore)}
              </div>
            </div>
          </div>

          {/* 人物2 */}
          <div className="flex flex-col items-center gap-1">
            <Avatar name={person2.name} avatar={person2.avatar} />
            <span className="text-sm text-white/90">{person2.name}</span>
            {person2.sign && (
              <span className="text-xs text-white/50">{person2.sign}</span>
            )}
          </div>
        </div>

        {/* 关键词标签 */}
        {keywords.length > 0 && (
          <div className="flex flex-wrap gap-2 mt-4 justify-center">
            {keywords.map((keyword, i) => (
              <span
                key={i}
                className="px-2 py-0.5 rounded-md bg-white/5 text-xs text-white/60 border border-white/10"
              >
                {keyword}
              </span>
            ))}
          </div>
        )}
      </div>

      {/* 分维度评分 */}
      <div className="px-4 pb-3">
        <div className="grid grid-cols-2 gap-3">
          {dimensions.slice(0, 4).map((dim, i) => {
            const Icon = dim.icon ? ICON_MAP[dim.icon] : Sparkles;
            return (
              <div
                key={i}
                className="flex items-center gap-2 p-2 rounded-lg bg-white/5"
              >
                <Icon className="w-4 h-4 text-white/40 flex-shrink-0" />
                <div className="flex-1 min-w-0">
                  <div className="flex items-center justify-between text-xs mb-1">
                    <span className="text-white/70 truncate">{dim.name}</span>
                    <span className={cn("font-medium", getScoreColor(dim.score))}>
                      {dim.score}
                    </span>
                  </div>
                  <div className="h-1 bg-white/10 rounded-full overflow-hidden">
                    <motion.div
                      className={cn("h-full rounded-full", getScoreBarColor(dim.score))}
                      initial={{ width: 0 }}
                      animate={{ width: `${dim.score}%` }}
                      transition={{ duration: 0.8, delay: i * 0.1 }}
                    />
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* 展开按钮 */}
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full py-2 flex items-center justify-center gap-1 text-xs text-white/50 hover:text-white/70 hover:bg-white/5 transition-colors border-t border-white/5"
      >
        <span>{expanded ? "收起详情" : "查看建议"}</span>
        <motion.div animate={{ rotate: expanded ? 180 : 0 }}>
          <ChevronDown className="w-4 h-4" />
        </motion.div>
      </button>

      {/* 展开内容 */}
      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: "auto", opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.3 }}
            className="overflow-hidden"
          >
            <div className="p-4 pt-0 space-y-4">
              {/* 互动建议 */}
              {suggestions.length > 0 && (
                <div>
                  <h4 className="text-xs text-white/50 mb-2 flex items-center gap-1">
                    <Sparkles className="w-3 h-3" />
                    互动建议
                  </h4>
                  <ul className="space-y-2">
                    {suggestions.map((suggestion, i) => (
                      <li
                        key={i}
                        className="flex items-start gap-2 text-sm text-white/70"
                      >
                        <ArrowRight className="w-3 h-3 mt-1 text-emerald-400 flex-shrink-0" />
                        <span>{suggestion}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {/* 注意事项 */}
              {warnings.length > 0 && (
                <div>
                  <h4 className="text-xs text-white/50 mb-2 flex items-center gap-1">
                    <AlertTriangle className="w-3 h-3" />
                    注意事项
                  </h4>
                  <ul className="space-y-2">
                    {warnings.map((warning, i) => (
                      <li
                        key={i}
                        className="flex items-start gap-2 text-sm text-amber-400/80"
                      >
                        <span className="w-1.5 h-1.5 rounded-full bg-amber-400 mt-1.5 flex-shrink-0" />
                        <span>{warning}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {/* 各维度详细说明 */}
              {dimensions.some((d) => d.comment) && (
                <div>
                  <h4 className="text-xs text-white/50 mb-2 flex items-center gap-1">
                    <Users className="w-3 h-3" />
                    维度解读
                  </h4>
                  <div className="space-y-2">
                    {dimensions
                      .filter((d) => d.comment)
                      .map((dim, i) => (
                        <div
                          key={i}
                          className="p-2 rounded-lg bg-white/5 text-xs"
                        >
                          <span className="text-white/70 font-medium">
                            {dim.name}:
                          </span>{" "}
                          <span className="text-white/50">{dim.comment}</span>
                        </div>
                      ))}
                  </div>
                </div>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </motion.div>
  );
}

// ============ Demo 数据 ============

export const DEMO_RELATIONSHIP: RelationshipCardProps = {
  person1: {
    name: "小明",
    sign: "天蝎座 · 属龙",
    element: "水",
  },
  person2: {
    name: "小红",
    sign: "巨蟹座 · 属鼠",
    element: "水",
  },
  relationType: "romantic",
  overallScore: 78,
  dimensions: [
    { name: "情感共鸣", score: 85, icon: "heart", comment: "水水相生,情感默契度高" },
    { name: "沟通顺畅", score: 72, icon: "spark", comment: "表达方式略有差异,需要耐心" },
    { name: "价值观", score: 80, icon: "work", comment: "核心价值观一致" },
    { name: "长期稳定", score: 75, icon: "heart", comment: "双方都重视安全感" },
  ],
  keywords: ["水象共鸣", "情感细腻", "重视家庭", "需要空间"],
  suggestions: [
    "多进行深度对话,分享内心感受",
    "给彼此适当的独处空间",
    "共同规划未来目标,增强安全感",
  ],
  warnings: [
    "避免情绪化沟通,冷静后再讨论分歧",
    "注意保持个人独立性,避免过度依赖",
  ],
};

export default RelationshipCard;
