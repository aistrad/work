'use client'

/**
 * LifeKLine - Life K-Line visualization component
 * Based on: vibelife spec v3.0, section 2.2.5
 *
 * Features:
 * - Interactive K-Line chart
 * - Click on inflection points for details
 * - Current year indicator
 * - Phase markers
 */

import React, { useState, useMemo } from 'react'
import { motion, AnimatePresence } from 'framer-motion'

// Types
interface DataPoint {
  year: number
  score: number
  is_current: boolean
  phase?: string
  label?: string
}

interface Phase {
  start_year: number
  end_year: number
  phase: string
  label: string
  description: string
  fortune_trend: string
}

interface InflectionPoint {
  year: number
  type: string
  significance: number
  title: string
  explanation: string
  is_past: boolean
}

interface KLineData {
  id: string
  data_points: DataPoint[]
  phases: Phase[]
  inflection_points: InflectionPoint[]
  current_year: number
  current_phase?: Phase
  next_inflection?: InflectionPoint
  now_summary: string
  next_summary: string
}

interface LifeKLineProps {
  data: KLineData
  onYearClick?: (year: number) => void
  className?: string
}

// Phase colors
const PHASE_COLORS: Record<string, string> = {
  accumulation: '#4CAF50',  // Green
  breakthrough: '#FF9800',  // Orange
  peak: '#F44336',          // Red
  adjustment: '#9C27B0',    // Purple
  transition: '#2196F3',    // Blue
  foundation: '#795548',    // Brown
}

// Phase Chinese names
const PHASE_NAMES: Record<string, string> = {
  accumulation: '积累期',
  breakthrough: '突破期',
  peak: '高峰期',
  adjustment: '调整期',
  transition: '过渡期',
  foundation: '基础期',
}

export default function LifeKLine({
  data,
  onYearClick,
  className = '',
}: LifeKLineProps) {
  const [selectedYear, setSelectedYear] = useState<number | null>(null)
  const [hoveredPoint, setHoveredPoint] = useState<number | null>(null)

  // Calculate chart dimensions
  const chartWidth = 800
  const chartHeight = 300
  const padding = { top: 40, right: 40, bottom: 60, left: 60 }
  const innerWidth = chartWidth - padding.left - padding.right
  const innerHeight = chartHeight - padding.top - padding.bottom

  // Get visible range (centered on current year, +/- 20 years)
  const [visibleRange, setVisibleRange] = useState<[number, number]>(() => {
    const current = data.current_year
    return [current - 15, current + 15]
  })

  // Filter data points to visible range
  const visiblePoints = useMemo(() => {
    return data.data_points.filter(
      p => p.year >= visibleRange[0] && p.year <= visibleRange[1]
    )
  }, [data.data_points, visibleRange])

  // Scale functions
  const xScale = (year: number) => {
    const range = visibleRange[1] - visibleRange[0]
    return padding.left + ((year - visibleRange[0]) / range) * innerWidth
  }

  const yScale = (score: number) => {
    return padding.top + innerHeight - (score / 100) * innerHeight
  }

  // Generate path
  const pathData = useMemo(() => {
    if (visiblePoints.length === 0) return ''

    return visiblePoints
      .map((point, i) => {
        const x = xScale(point.year)
        const y = yScale(point.score)
        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`
      })
      .join(' ')
  }, [visiblePoints, xScale, yScale])

  // Generate area fill
  const areaData = useMemo(() => {
    if (visiblePoints.length === 0) return ''

    const path = visiblePoints
      .map((point, i) => {
        const x = xScale(point.year)
        const y = yScale(point.score)
        return `${i === 0 ? 'M' : 'L'} ${x} ${y}`
      })
      .join(' ')

    const lastX = xScale(visiblePoints[visiblePoints.length - 1].year)
    const firstX = xScale(visiblePoints[0].year)
    const bottomY = padding.top + innerHeight

    return `${path} L ${lastX} ${bottomY} L ${firstX} ${bottomY} Z`
  }, [visiblePoints, xScale, yScale, padding.top, innerHeight])

  // Handle year selection
  const handlePointClick = (year: number) => {
    setSelectedYear(year)
    onYearClick?.(year)
  }

  // Get inflection point for year
  const getInflectionForYear = (year: number) => {
    return data.inflection_points.find(p => p.year === year)
  }

  // Get selected point details
  const selectedPointData = useMemo(() => {
    if (!selectedYear) return null
    const point = data.data_points.find(p => p.year === selectedYear)
    const inflection = data.inflection_points.find(p => p.year === selectedYear)
    return { point, inflection }
  }, [selectedYear, data])

  return (
    <div className={`bg-[#FBF7F1] rounded-2xl overflow-hidden ${className}`}>
      {/* Header */}
      <div className="p-6 border-b border-[#1C1A17]/10">
        <h2 className="text-xl font-semibold text-[#1C1A17]">你的人生 K 线</h2>
        <p className="text-[#1C1A17]/60 mt-1">{data.now_summary}</p>
      </div>

      {/* Chart */}
      <div className="p-4 overflow-x-auto">
        <svg
          viewBox={`0 0 ${chartWidth} ${chartHeight}`}
          className="w-full min-w-[600px]"
        >
          {/* Grid lines */}
          {[0, 25, 50, 75, 100].map(score => (
            <g key={score}>
              <line
                x1={padding.left}
                y1={yScale(score)}
                x2={chartWidth - padding.right}
                y2={yScale(score)}
                stroke="#1C1A17"
                strokeOpacity={0.1}
                strokeDasharray={score === 50 ? '0' : '4 4'}
              />
              <text
                x={padding.left - 10}
                y={yScale(score)}
                textAnchor="end"
                alignmentBaseline="middle"
                className="text-xs fill-[#1C1A17]/50"
              >
                {score}
              </text>
            </g>
          ))}

          {/* Year labels */}
          {visiblePoints
            .filter((_, i) => i % 5 === 0)
            .map(point => (
              <text
                key={point.year}
                x={xScale(point.year)}
                y={chartHeight - padding.bottom + 20}
                textAnchor="middle"
                className="text-xs fill-[#1C1A17]/50"
              >
                {point.year}
              </text>
            ))}

          {/* Area fill */}
          <path
            d={areaData}
            fill="url(#areaGradient)"
            opacity={0.3}
          />

          {/* Line */}
          <path
            d={pathData}
            fill="none"
            stroke="#B88A44"
            strokeWidth={2}
            strokeLinecap="round"
            strokeLinejoin="round"
          />

          {/* Inflection points */}
          {data.inflection_points
            .filter(ip => ip.year >= visibleRange[0] && ip.year <= visibleRange[1])
            .map(ip => {
              const point = data.data_points.find(p => p.year === ip.year)
              if (!point) return null

              return (
                <g key={ip.year}>
                  <circle
                    cx={xScale(ip.year)}
                    cy={yScale(point.score)}
                    r={6}
                    fill={ip.is_past ? '#1C1A17' : '#B88A44'}
                    stroke="white"
                    strokeWidth={2}
                    className="cursor-pointer"
                    onClick={() => handlePointClick(ip.year)}
                  />
                  {/* Label */}
                  <text
                    x={xScale(ip.year)}
                    y={yScale(point.score) - 12}
                    textAnchor="middle"
                    className="text-[10px] fill-[#1C1A17]/70"
                  >
                    {ip.title.split(' - ')[0]}
                  </text>
                </g>
              )
            })}

          {/* Current year marker */}
          <g>
            <line
              x1={xScale(data.current_year)}
              y1={padding.top}
              x2={xScale(data.current_year)}
              y2={chartHeight - padding.bottom}
              stroke="#B88A44"
              strokeWidth={2}
              strokeDasharray="4 4"
            />
            <text
              x={xScale(data.current_year)}
              y={chartHeight - padding.bottom + 35}
              textAnchor="middle"
              className="text-xs font-medium fill-[#B88A44]"
            >
              现在
            </text>
          </g>

          {/* Gradient definition */}
          <defs>
            <linearGradient id="areaGradient" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stopColor="#B88A44" stopOpacity={0.4} />
              <stop offset="100%" stopColor="#B88A44" stopOpacity={0} />
            </linearGradient>
          </defs>
        </svg>
      </div>

      {/* Current Phase Info */}
      {data.current_phase && (
        <div className="px-6 py-4 border-t border-[#1C1A17]/10">
          <div className="flex items-center gap-2 mb-2">
            <span
              className="w-3 h-3 rounded-full"
              style={{ backgroundColor: PHASE_COLORS[data.current_phase.phase] }}
            />
            <span className="font-medium text-[#1C1A17]">
              当前阶段：{PHASE_NAMES[data.current_phase.phase]}
            </span>
          </div>
          <p className="text-sm text-[#1C1A17]/70">
            {data.current_phase.description}
          </p>
        </div>
      )}

      {/* Next Milestone */}
      {data.next_inflection && (
        <div className="px-6 py-4 border-t border-[#1C1A17]/10 bg-[#B88A44]/5">
          <p className="text-sm text-[#B88A44]">
            下一关键节点：{data.next_summary}
          </p>
        </div>
      )}

      {/* Selected Point Detail */}
      <AnimatePresence>
        {selectedPointData && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 20 }}
            className="px-6 py-4 border-t border-[#1C1A17]/10 bg-white"
          >
            <div className="flex justify-between items-start">
              <div>
                <h3 className="font-semibold text-[#1C1A17]">
                  {selectedYear}年
                </h3>
                {selectedPointData.inflection && (
                  <p className="text-sm text-[#B88A44] mt-1">
                    {selectedPointData.inflection.title}
                  </p>
                )}
              </div>
              <button
                onClick={() => setSelectedYear(null)}
                className="text-[#1C1A17]/50 hover:text-[#1C1A17]"
              >
                <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
            {selectedPointData.inflection && (
              <p className="text-sm text-[#1C1A17]/70 mt-2">
                {selectedPointData.inflection.explanation}
              </p>
            )}
          </motion.div>
        )}
      </AnimatePresence>

      {/* Legend */}
      <div className="px-6 py-4 border-t border-[#1C1A17]/10 flex flex-wrap gap-4">
        {Object.entries(PHASE_NAMES).map(([key, name]) => (
          <div key={key} className="flex items-center gap-1.5 text-xs text-[#1C1A17]/60">
            <span
              className="w-2.5 h-2.5 rounded-full"
              style={{ backgroundColor: PHASE_COLORS[key] }}
            />
            {name}
          </div>
        ))}
      </div>
    </div>
  )
}
