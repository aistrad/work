"use client";

import { cn } from "@/lib/utils";

/**
 * BaziChart - 八字命盘可视化
 *
 * 展示四柱八字: 年/月/日/时
 * 包含: 天干 + 地支 + 五行 + 十神
 */

// 五行类型
type Element = "wood" | "fire" | "earth" | "metal" | "water";

// 天干地支数据
interface Pillar {
  stem: string; // 天干: 甲乙丙丁...
  branch: string; // 地支: 子丑寅卯...
  element: Element; // 五行
  tenGod?: string; // 十神: 比肩, 劫财, 食神...
}

interface BaziChartProps {
  pillars: {
    year: Pillar;
    month: Pillar;
    day: Pillar;
    hour?: Pillar; // 时柱可选
  };
  dayMaster?: string; // 日主
  showTenGods?: boolean;
  showElements?: boolean;
  size?: "sm" | "md" | "lg";
  variant?: "compact" | "full";
  className?: string;
}

// 五行颜色映射
const ELEMENT_COLORS: Record<Element, string> = {
  wood: "text-green-600 bg-green-50 border-green-200",
  fire: "text-red-600 bg-red-50 border-red-200",
  earth: "text-amber-600 bg-amber-50 border-amber-200",
  metal: "text-slate-500 bg-slate-50 border-slate-200",
  water: "text-blue-600 bg-blue-50 border-blue-200",
};

const ELEMENT_NAMES: Record<Element, string> = {
  wood: "木",
  fire: "火",
  earth: "土",
  metal: "金",
  water: "水",
};

type PillarKey = "year" | "month" | "day" | "hour";

const PILLAR_NAMES: Record<PillarKey, string> = {
  year: "年柱",
  month: "月柱",
  day: "日柱",
  hour: "时柱",
};

// 单个柱子组件
function PillarColumn({
  pillar,
  label,
  isDayMaster = false,
  showTenGod = true,
  showElement = true,
  size = "md",
}: {
  pillar: Pillar;
  label: string;
  isDayMaster?: boolean;
  showTenGod?: boolean;
  showElement?: boolean;
  size?: "sm" | "md" | "lg";
}) {
  const sizeClasses = {
    sm: "w-14 text-xs",
    md: "w-20 text-sm",
    lg: "w-24 text-base",
  };

  return (
    <div
      className={cn(
        "flex flex-col items-center gap-1",
        sizeClasses[size],
        isDayMaster && "relative"
      )}
    >
      {/* 柱名 */}
      <span className="text-muted-foreground text-[10px] uppercase tracking-wider">
        {label}
      </span>

      {/* 天干 */}
      <div
        className={cn(
          "w-full aspect-square rounded-lg border-2 flex items-center justify-center font-serif font-bold",
          ELEMENT_COLORS[pillar.element],
          isDayMaster && "ring-2 ring-antique-gold ring-offset-2"
        )}
      >
        {pillar.stem}
      </div>

      {/* 地支 */}
      <div
        className={cn(
          "w-full aspect-square rounded-lg border flex items-center justify-center font-serif",
          "bg-muted/30 border-border/50"
        )}
      >
        {pillar.branch}
      </div>

      {/* 五行 */}
      {showElement && (
        <span className={cn("text-[10px]", ELEMENT_COLORS[pillar.element].split(" ")[0])}>
          ({ELEMENT_NAMES[pillar.element]})
        </span>
      )}

      {/* 十神 */}
      {showTenGod && pillar.tenGod && (
        <span className="text-[10px] text-muted-foreground bg-muted/50 px-1.5 py-0.5 rounded">
          {pillar.tenGod}
        </span>
      )}

      {/* 日主标记 */}
      {isDayMaster && (
        <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-[9px] text-antique-gold font-medium">
          日主
        </span>
      )}
    </div>
  );
}

export function BaziChart({
  pillars,
  showTenGods = true,
  showElements = true,
  size = "md",
  variant = "full",
  className,
}: BaziChartProps) {
  const pillarEntries = [
    { key: "year", data: pillars.year },
    { key: "month", data: pillars.month },
    { key: "day", data: pillars.day },
    ...(pillars.hour ? [{ key: "hour", data: pillars.hour }] : []),
  ] as const;

  if (variant === "compact") {
    return (
      <div className={cn("space-y-2", className)}>
        {pillarEntries.map(({ key, data }) => (
          <div key={key} className="flex items-center gap-2 text-sm">
            <span className="w-8 text-muted-foreground">
              {PILLAR_NAMES[key].charAt(0)}:
            </span>
            <span className="font-serif font-medium">
              {data.stem}
              {data.branch}
            </span>
            <span className={cn("text-xs", ELEMENT_COLORS[data.element].split(" ")[0])}>
              ({ELEMENT_NAMES[data.element]})
            </span>
            {data.tenGod && (
              <span className="text-xs text-muted-foreground">[{data.tenGod}]</span>
            )}
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className={cn("flex justify-center gap-3 pt-6", className)}>
      {pillarEntries.map(({ key, data }) => (
        <PillarColumn
          key={key}
          pillar={data}
          label={PILLAR_NAMES[key]}
          isDayMaster={key === "day"}
          showTenGod={showTenGods}
          showElement={showElements}
          size={size}
        />
      ))}
    </div>
  );
}

export default BaziChart;
