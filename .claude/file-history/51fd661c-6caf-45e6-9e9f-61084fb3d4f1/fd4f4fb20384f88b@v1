/**
 * ProgressCard - Skill 构建进度卡片
 *
 * 展示 vibelife-skill 构建流程的进度
 * 通过 CardRegistry 注册，由 card_type: "vibelife_skill_progress" 触发
 */

"use client";

import { cn } from "@/lib/utils";
import { registerCard } from "@/skills/CardRegistry";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface ProgressDetails {
  processed?: number;
  total?: number;
  errors?: number;
  documents_processed?: number;
  chunks_created?: number;
  vectors_generated?: number;
  cases_extracted?: number;
  rules_extracted?: number;
}

interface ProgressCardData {
  skill_id: string;
  stage: string;
  stage_name?: string;
  progress: number;
  message?: string;
  details?: ProgressDetails;
}

interface ProgressCardProps {
  data: ProgressCardData;
  cardProps?: Record<string, unknown>;
}

// ═══════════════════════════════════════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════════════════════════════════════

const STAGE_ICONS: Record<string, string> = {
  preprocessing: "document-text",
  chunking: "scissors",
  vectorizing: "cube",
  indexing: "database",
  extracting: "sparkles",
  quality_check: "check-badge",
  completed: "check-circle",
};

const STAGE_COLORS: Record<string, string> = {
  preprocessing: "text-blue-500",
  chunking: "text-purple-500",
  vectorizing: "text-indigo-500",
  indexing: "text-cyan-500",
  extracting: "text-amber-500",
  quality_check: "text-emerald-500",
  completed: "text-green-500",
};

function getProgressBarColor(progress: number): string {
  if (progress === 100) return "bg-green-500";
  if (progress >= 75) return "bg-emerald-500";
  if (progress >= 50) return "bg-blue-500";
  if (progress >= 25) return "bg-indigo-500";
  return "bg-purple-500";
}

// ═══════════════════════════════════════════════════════════════════════════
// Component
// ═══════════════════════════════════════════════════════════════════════════

function ProgressCard({ data }: ProgressCardProps) {
  const {
    skill_id,
    stage,
    stage_name,
    progress,
    message,
    details,
  } = data;

  const displayStageName = stage_name || stage;
  const stageColor = STAGE_COLORS[stage] || "text-gray-500";
  const progressBarColor = getProgressBarColor(progress);

  return (
    <div className="rounded-xl border border-border/50 bg-card p-4 shadow-sm">
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <div className={cn("text-lg font-semibold", stageColor)}>
            {displayStageName}
          </div>
          <span className="text-xs text-muted-foreground bg-muted px-2 py-0.5 rounded-full">
            {skill_id}
          </span>
        </div>
        <span className="text-sm font-medium text-muted-foreground">
          {progress}%
        </span>
      </div>

      {/* Progress Bar */}
      <div className="w-full bg-muted rounded-full h-2 mb-3">
        <div
          className={cn("h-2 rounded-full transition-all duration-500", progressBarColor)}
          style={{ width: `${progress}%` }}
        />
      </div>

      {/* Message */}
      {message && (
        <p className="text-sm text-muted-foreground mb-3">{message}</p>
      )}

      {/* Details */}
      {details && Object.keys(details).length > 0 && (
        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mt-3 pt-3 border-t border-border/30">
          {details.documents_processed !== undefined && (
            <div className="text-center p-2 bg-muted/30 rounded-lg">
              <div className="text-lg font-semibold">{details.documents_processed}</div>
              <div className="text-xs text-muted-foreground">文档处理</div>
            </div>
          )}
          {details.chunks_created !== undefined && (
            <div className="text-center p-2 bg-muted/30 rounded-lg">
              <div className="text-lg font-semibold">{details.chunks_created}</div>
              <div className="text-xs text-muted-foreground">文本块</div>
            </div>
          )}
          {details.vectors_generated !== undefined && (
            <div className="text-center p-2 bg-muted/30 rounded-lg">
              <div className="text-lg font-semibold">{details.vectors_generated}</div>
              <div className="text-xs text-muted-foreground">向量</div>
            </div>
          )}
          {details.cases_extracted !== undefined && (
            <div className="text-center p-2 bg-muted/30 rounded-lg">
              <div className="text-lg font-semibold">{details.cases_extracted}</div>
              <div className="text-xs text-muted-foreground">案例</div>
            </div>
          )}
          {details.rules_extracted !== undefined && (
            <div className="text-center p-2 bg-muted/30 rounded-lg">
              <div className="text-lg font-semibold">{details.rules_extracted}</div>
              <div className="text-xs text-muted-foreground">规则</div>
            </div>
          )}
          {details.errors !== undefined && details.errors > 0 && (
            <div className="text-center p-2 bg-red-50 dark:bg-red-900/20 rounded-lg">
              <div className="text-lg font-semibold text-red-600 dark:text-red-400">
                {details.errors}
              </div>
              <div className="text-xs text-red-500 dark:text-red-400">错误</div>
            </div>
          )}
        </div>
      )}

      {/* Completed State */}
      {progress === 100 && (
        <div className="flex items-center gap-2 mt-3 pt-3 border-t border-border/30">
          <div className="w-5 h-5 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
            <svg className="w-3 h-3 text-green-600 dark:text-green-400" fill="currentColor" viewBox="0 0 20 20">
              <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
            </svg>
          </div>
          <span className="text-sm text-green-600 dark:text-green-400 font-medium">
            构建完成
          </span>
        </div>
      )}
    </div>
  );
}

// 注册到 CardRegistry
registerCard("vibelife_skill_progress", ProgressCard);

export default ProgressCard;
