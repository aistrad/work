"use client";

/**
 * MePanel - Me Tab 的右侧 Panel 内容（v10.0 Self-Discovery Hub 重构）
 *
 * 定位：Self-Discovery Hub（自我认知中心）
 *
 * 数据级别：
 * - Level A: 完整数据（八字 + 星座 + 原型）
 * - Level B: 有对话但无命理（行为洞察 + 引导）
 * - Level C: 新用户（Onboarding 引导）
 *
 * React Best Practices Applied:
 * - 6.3: Hoist static JSX
 * - 6.7: Explicit conditional rendering
 */

import { useRouter, useSearchParams } from "next/navigation";
import { cn } from "@/lib/utils";
import { useMeData, type DataLevel } from "@/hooks/useMeData";
import {
  UserInfoCard,
  UserInfoCardSkeleton,
  BaziSummaryCard,
  BaziSummaryCardSkeleton,
  ZodiacSummaryCard,
  ZodiacSummaryCardSkeleton,
  ArchetypeCard,
  ArchetypeCardSkeleton,
  BehaviorInsightCard,
  BehaviorInsightCardSkeleton,
  MeEmptyState,
  MeEmptyStateSkeleton,
} from "@/components/me";
import { Settings, ChevronDown, ChevronUp, Bell, LogOut, CreditCard, Crown, Check } from "lucide-react";
import { useState } from "react";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface MePanelProps {
  mockDataLevel?: DataLevel;
  onEditProfile?: () => void;
  onLogout?: () => void;
  className?: string;
}

// ═══════════════════════════════════════════════════════════════════════════
// Sub-components
// ═══════════════════════════════════════════════════════════════════════════

function SettingsSection({
  onNotifications,
  onSubscription,
  onLogout,
}: {
  onNotifications?: () => void;
  onSubscription?: () => void;
  onLogout?: () => void;
}) {
  const [expanded, setExpanded] = useState(false);

  return (
    <section>
      <button
        onClick={() => setExpanded((prev) => !prev)}
        className="w-full flex items-center justify-between py-2 hover:opacity-80 transition-opacity"
      >
        <h2 className="font-serif text-base font-semibold text-foreground flex items-center gap-2">
          <Settings className="w-4 h-4 text-muted-foreground" />
          设置
        </h2>
        {expanded ? (
          <ChevronUp className="w-5 h-5 text-muted-foreground" />
        ) : (
          <ChevronDown className="w-5 h-5 text-muted-foreground" />
        )}
      </button>

      {expanded ? (
        <div className="mt-3 space-y-2 animate-fade-in">
          <button
            onClick={onSubscription}
            className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted transition-colors text-left"
          >
            <CreditCard className="w-5 h-5 text-muted-foreground" />
            <span className="text-sm text-foreground">订阅管理</span>
          </button>
          <button
            onClick={onNotifications}
            className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-muted transition-colors text-left"
          >
            <Bell className="w-5 h-5 text-muted-foreground" />
            <span className="text-sm text-foreground">通知设置</span>
          </button>
          <button
            onClick={onLogout}
            className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors text-left text-red-600 dark:text-red-400"
          >
            <LogOut className="w-5 h-5" />
            <span className="text-sm">退出登录</span>
          </button>
        </div>
      ) : null}
    </section>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Loading Skeleton
// ═══════════════════════════════════════════════════════════════════════════

function MePanelSkeleton() {
  return (
    <div className="h-full overflow-y-auto p-5 space-y-5">
      <UserInfoCardSkeleton />
      <div className="space-y-4">
        <div className="h-6 bg-vellum-200 rounded w-24 animate-pulse" />
        <BaziSummaryCardSkeleton />
        <ZodiacSummaryCardSkeleton />
        <ArchetypeCardSkeleton />
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Level A Content - Full Discovery
// ═══════════════════════════════════════════════════════════════════════════

function LevelAContent({
  data,
  onExploreBazi,
  onExploreZodiac,
  onExploreArchetype,
}: {
  data: NonNullable<ReturnType<typeof useMeData>["data"]>;
  onExploreBazi: () => void;
  onExploreZodiac: () => void;
  onExploreArchetype: () => void;
}) {
  // Transform data for components
  const baziData = data.bazi_summary ? {
    dayMaster: {
      element: data.bazi_summary.day_master.element,
      character: data.bazi_summary.day_master.character,
      description: data.bazi_summary.day_master.description,
    },
    fiveElements: data.bazi_summary.five_elements,
    dailyFortune: data.bazi_summary.daily_fortune,
  } : null;

  const zodiacData = data.zodiac_summary ? {
    sun: data.zodiac_summary.sun,
    moon: data.zodiac_summary.moon,
    rising: data.zodiac_summary.rising,
    transitHighlight: data.zodiac_summary.transit_highlight,
  } : null;

  return (
    <section className="space-y-4">
      <h2 className="font-serif text-lg font-semibold text-foreground">
        了解自己
      </h2>

      {/* Bazi Card */}
      <BaziSummaryCard
        data={baziData}
        onExplore={onExploreBazi}
      />

      {/* Zodiac Card */}
      <ZodiacSummaryCard
        data={zodiacData}
        onExplore={onExploreZodiac}
      />

      {/* Archetype Card */}
      <ArchetypeCard
        data={data.archetype}
        onExplore={onExploreArchetype}
      />
    </section>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Level B Content - Behavior Insight
// ═══════════════════════════════════════════════════════════════════════════

function LevelBContent({
  data,
  onExploreBazi,
  onExploreZodiac,
}: {
  data: NonNullable<ReturnType<typeof useMeData>["data"]>;
  onExploreBazi: () => void;
  onExploreZodiac: () => void;
}) {
  if (!data.behavior_insight) return null;

  return (
    <section className="space-y-4">
      <BehaviorInsightCard
        data={data.behavior_insight}
        onExploreBazi={onExploreBazi}
        onExploreZodiac={onExploreZodiac}
      />
    </section>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Level C Content - Empty State
// ═══════════════════════════════════════════════════════════════════════════

function LevelCContent({
  onStartChat,
  onExploreBazi,
  onExploreZodiac,
}: {
  onStartChat: () => void;
  onExploreBazi: () => void;
  onExploreZodiac: () => void;
}) {
  return (
    <MeEmptyState
      onStartChat={onStartChat}
      onExploreBazi={onExploreBazi}
      onExploreZodiac={onExploreZodiac}
    />
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// MePanel Component
// ═══════════════════════════════════════════════════════════════════════════

export function MePanel({
  mockDataLevel = "A",
  onEditProfile,
  onLogout,
  className,
}: MePanelProps) {
  const router = useRouter();
  const searchParams = useSearchParams();

  // Support query parameter for testing different data levels
  // Usage: /chat?me_level=B or /chat?me_level=C
  const queryLevel = searchParams.get("me_level") as DataLevel | null;
  const effectiveLevel = queryLevel || mockDataLevel;

  const { data, isLoading, error, refresh } = useMeData({ mockLevel: effectiveLevel });

  // Navigation handlers
  const handleExploreBazi = () => {
    router.push("/chat?skill=bazi&prompt=深入了解我的命盘");
  };

  const handleExploreZodiac = () => {
    router.push("/chat?skill=zodiac&prompt=分析我的星盘");
  };

  const handleExploreArchetype = () => {
    router.push("/chat?skill=vibe_id&prompt=深入了解我的原型");
  };

  const handleStartChat = () => {
    router.push("/chat");
  };

  // Loading state
  if (isLoading) {
    return <MePanelSkeleton />;
  }

  // Error state
  if (error) {
    return (
      <div className={cn("h-full overflow-y-auto p-5", className)}>
        <div className="text-center py-10">
          <p className="text-sm text-muted-foreground mb-4">
            加载失败，请重试
          </p>
          <button
            onClick={refresh}
            className="px-4 py-2 bg-vellum-100 hover:bg-vellum-200 text-vellum-700 rounded-lg text-sm font-medium transition-colors"
          >
            重新加载
          </button>
        </div>
      </div>
    );
  }

  // No data (shouldn't happen, but handle gracefully)
  if (!data) {
    return <MePanelSkeleton />;
  }

  return (
    <div className={cn("h-full overflow-y-auto p-5 space-y-5", className)}>
      {/* User Info Section */}
      <section>
        <UserInfoCard
          displayName={data.user.display_name}
          avatarUrl={data.user.avatar_url}
          tagline={data.user.tagline}
          onEditProfile={onEditProfile}
        />
      </section>

      {/* Content based on data level */}
      {data.data_level === "A" ? (
        <LevelAContent
          data={data}
          onExploreBazi={handleExploreBazi}
          onExploreZodiac={handleExploreZodiac}
          onExploreArchetype={handleExploreArchetype}
        />
      ) : data.data_level === "B" ? (
        <LevelBContent
          data={data}
          onExploreBazi={handleExploreBazi}
          onExploreZodiac={handleExploreZodiac}
        />
      ) : (
        <LevelCContent
          onStartChat={handleStartChat}
          onExploreBazi={handleExploreBazi}
          onExploreZodiac={handleExploreZodiac}
        />
      )}

      {/* Settings Section (only for logged-in users) */}
      {data.data_level !== "C" ? (
        <SettingsSection
          onLogout={onLogout}
        />
      ) : null}
    </div>
  );
}

export default MePanel;
