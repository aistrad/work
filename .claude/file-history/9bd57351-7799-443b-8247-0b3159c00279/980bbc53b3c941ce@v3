"use client";

/**
 * Chat Page - v7.1 ç»Ÿä¸€å¯¹è¯å…¥å£
 *
 * v7.1 ä¼˜åŒ–:
 * - ç§»é™¤åŒæ¸²æŸ“æ¨¡å¼ï¼Œä½¿ç”¨ CSS åª’ä½“æŸ¥è¯¢ç»Ÿä¸€å“åº”å¼
 * - PC ä¸‰æ : Chat + SidePanel (VibeID/ä»Šæ—¥Vibe/å¿«æ·æ“ä½œ)
 * - Mobile: å•æ  + Skill Tabs + Bottom Nav
 * - Suspense è¾¹ç•Œ (Vercel rule: async-suspense-boundaries)
 * - memo ç»„ä»¶ (Vercel rule: rerender-memo)
 * - åŠ¨æ€åŠ è½½ SidePanel (Vercel rule: bundle-dynamic-imports)
 */

import { useMemo, Suspense, memo, useCallback, useEffect, useState } from "react";
import dynamic from "next/dynamic";
import { useRouter, useSearchParams } from "next/navigation";
import { useSkill } from "@/providers";
import { useAuth } from "@/providers/AuthProvider";
import { useProfileData } from "@/hooks/useProfileData";
import { useDashboard } from "@/hooks/useDashboard";
import { AppShell, useAppShell } from "@/components/layout";
import { ChatPanel } from "@/components/layout/panels";
import { LuminousPaper, BreathAura } from "@/components/core";
import { Card } from "@/components/ui/Card";
import { Skeleton } from "@/components/ui/Skeleton";

// åŠ¨æ€å¯¼å…¥é‡å‹ç»„ä»¶ï¼Œå‡å°‘åˆå§‹ bundle å¤§å° (Vercel rule: bundle-dynamic-imports)
const ChatContainer = dynamic(
  () => import("@/components/chat/ChatContainer").then(mod => ({ default: mod.ChatContainer })),
  { ssr: false }
);

const MePanel = dynamic(
  () => import("@/components/layout/panels").then(mod => ({ default: mod.MePanel })),
  { ssr: false }
);

const JourneyContentComponent = dynamic(
  () => import("@/components/journey").then(mod => ({ default: mod.JourneyContent })),
  { ssr: false }
);

const DiscoverContentComponent = dynamic(
  () => import("@/components/discover").then(mod => ({ default: mod.DiscoverContent })),
  { ssr: false }
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Loading Fallbacks
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ChatLoadingFallback = memo(function ChatLoadingFallback() {
  return (
    <div className="flex-1 flex items-center justify-center bg-bg-primary">
      <div className="flex flex-col items-center gap-3">
        <div className="w-12 h-12 rounded-full bg-accent-primary/10 animate-pulse flex items-center justify-center">
          <span className="text-2xl">ğŸ’¬</span>
        </div>
        <p className="text-text-secondary text-sm">åŠ è½½å¯¹è¯...</p>
      </div>
    </div>
  );
});

const PanelLoadingFallback = memo(function PanelLoadingFallback() {
  return (
    <div className="p-4 space-y-4">
      <Skeleton className="h-8 w-1/2 rounded-lg" />
      <Skeleton className="h-32 w-full rounded-xl" />
      <Skeleton className="h-24 w-full rounded-xl" />
    </div>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Side Panel Quick Actions - v7.1 æ ·å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface QuickAction {
  id: string;
  icon: string;
  label: string;
  description: string;
  onClick: () => void;
}

const QuickActionsCard = memo(function QuickActionsCard({ actions }: { actions: QuickAction[] }) {
  return (
    <Card variant="default" padding="md" hover={false} className="mb-4">
      <h3 className="text-sm font-semibold text-text-primary mb-3">å¿«æ·æ“ä½œ</h3>
      <div className="space-y-2">
        {actions.map((action) => (
          <button
            key={action.id}
            onClick={action.onClick}
            className="w-full flex items-center gap-3 p-2.5 rounded-lg text-left hover:bg-bg-secondary transition-colors duration-fast"
          >
            <span className="text-lg">{action.icon}</span>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-text-primary truncate">{action.label}</p>
              <p className="text-xs text-text-tertiary truncate">{action.description}</p>
            </div>
            <span className="text-text-disabled">â†’</span>
          </button>
        ))}
      </div>
    </Card>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Today's Vibe Card - v7.1 æ ·å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TodayVibeCard = memo(function TodayVibeCard({ skill }: { skill: string }) {
  const vibeData = useMemo(() => {
    if (skill === "bazi") {
      return {
        title: "ä»Šæ—¥è¿åŠ¿",
        icon: "ğŸŒŸ",
        summary: "ç”²å­æ—¥ï¼Œæ°´æ°”æ—ºç››",
        advice: "é€‚åˆå¤„ç†æ²Ÿé€šã€å­¦ä¹ ç›¸å…³äº‹åŠ¡",
        score: 78,
      };
    }
    return {
      title: "ä»Šæ—¥æ˜Ÿè±¡",
      icon: "ğŸ”®",
      summary: "æœˆäº®è¿›å…¥å¤©èåº§",
      advice: "é€‚åˆæ·±åº¦æ€è€ƒä¸å†…çœ",
      score: 72,
    };
  }, [skill]);

  return (
    <Card variant="default" padding="md" hover={false} className="mb-4">
      <div className="flex items-start justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-xl">{vibeData.icon}</span>
          <h3 className="text-sm font-semibold text-text-primary">{vibeData.title}</h3>
        </div>
        <div className="flex items-center gap-1 px-2 py-0.5 rounded-full bg-accent-primary/10">
          <span className="text-xs font-medium text-accent-primary">{vibeData.score}</span>
          <span className="text-xs text-text-tertiary">åˆ†</span>
        </div>
      </div>
      <p className="text-sm text-text-primary mb-1">{vibeData.summary}</p>
      <p className="text-xs text-text-secondary">{vibeData.advice}</p>
    </Card>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VibeID Preview Card - v7.1 æ ·å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const VibeIDPreviewCard = memo(function VibeIDPreviewCard({ onClick }: { onClick: () => void }) {
  return (
    <Card
      variant="elevated"
      padding="md"
      hover
      className="mb-4 cursor-pointer"
      onClick={onClick}
    >
      <div className="flex items-center gap-3 mb-3">
        <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-mystic-400 to-mystic-600 flex items-center justify-center">
          <span className="text-xl">ğŸ’</span>
        </div>
        <div>
          <h3 className="text-sm font-semibold text-text-primary">æˆ‘çš„ VibeID</h3>
          <p className="text-xs text-text-secondary">å››ç»´åŸå‹ç”»åƒ</p>
        </div>
      </div>
      <div className="flex items-center justify-between">
        <div className="flex -space-x-1">
          {["ğŸŒ¸", "ğŸ§­", "ğŸ­", "ğŸ”¥"].map((emoji, i) => (
            <span
              key={i}
              className="w-6 h-6 rounded-full bg-bg-secondary flex items-center justify-center text-xs border-2 border-bg-card"
            >
              {emoji}
            </span>
          ))}
        </div>
        <span className="text-xs text-accent-primary font-medium">æŸ¥çœ‹è¯¦æƒ… â†’</span>
      </div>
    </Card>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Panel Content - æ ¹æ® Tab åˆ‡æ¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const PanelContent = memo(function PanelContent() {
  const router = useRouter();
  const { activeTab, voiceMode, setVoiceMode } = useAppShell();
  const { skill } = useSkill();
  const { user, logout } = useAuth();

  // React Best Practice 4.2: Use SWR for Automatic Deduplication
  // è·å–Meé¡µé¢æ‰€éœ€çš„æ‰€æœ‰æ•°æ®
  const { baziData, zodiacData, vibeIdData } = useProfileData(user?.user_id);

  const handleOpenRelationship = useCallback(() => {
    router.push("/relationship");
  }, [router]);

  const handleGenerateReport = useCallback(() => {
    router.push("/interview?returnTo=/report");
  }, [router]);

  const handleViewKLine = useCallback(() => {
    router.push("/chat?view=kline");
  }, [router]);

  const handleViewIdentity = useCallback(() => {
    router.push("/identity");
  }, [router]);

  const quickActions = useMemo<QuickAction[]>(() => [
    {
      id: "relationship",
      icon: "ğŸ’‘",
      label: "å…³ç³»åŒ¹é…",
      description: "æŸ¥çœ‹ä¸ä»–äººçš„å¥‘åˆåº¦",
      onClick: handleOpenRelationship,
    },
    {
      id: "report",
      icon: "ğŸ“Š",
      label: "ç”ŸæˆæŠ¥å‘Š",
      description: "è·å–è¯¦ç»†åˆ†ææŠ¥å‘Š",
      onClick: handleGenerateReport,
    },
    {
      id: "kline",
      icon: "ğŸ“ˆ",
      label: "è¿åŠ¿æ›²çº¿",
      description: "æŸ¥çœ‹è¿åŠ¿èµ°åŠ¿å›¾",
      onClick: handleViewKLine,
    },
  ], [handleOpenRelationship, handleGenerateReport, handleViewKLine]);

  switch (activeTab) {
    case "chat":
      return (
        <div className="h-full overflow-y-auto p-4">
          <VibeIDPreviewCard onClick={handleViewIdentity} />
          <TodayVibeCard skill={skill} />
          <QuickActionsCard actions={quickActions} />
        </div>
      );
    case "me":
      return (
        <MePanel
          onLogout={logout}
        />
      );
    default:
      return null;
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Chat Content - ä¸»èŠå¤©åŒºåŸŸ
// æ”¯æŒ URL å‚æ•°ï¼š?skill=xxx&prompt=xxx (ç”¨äºä»é€šçŸ¥è·³è½¬å¼€å§‹å¯¹è¯)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ChatContent = memo(function ChatContent() {
  const searchParams = useSearchParams();
  const router = useRouter();
  const { voiceMode } = useAppShell();
  const { skill, setSkill } = useSkill();

  // Dashboard æ•°æ®ï¼ˆç”¨äºç©ºçŠ¶æ€ï¼‰
  const {
    dashboard,
    isLoading: isDashboardLoading,
    checkIn: checkInFn,
    toggleLever,
    toggleRock,
  } = useDashboard();

  // Wrapper for checkIn to return void
  const checkIn = useCallback(async () => {
    await checkInFn();
  }, [checkInFn]);

  // ä» URL å‚æ•°è·å– skillã€scenario å’Œ prompt
  const urlSkill = searchParams.get("skill");
  const urlScenario = searchParams.get("scenario");
  const urlPrompt = searchParams.get("prompt");
  const [initialPrompt, setInitialPrompt] = useState<string | null>(null);
  const [scenario, setScenario] = useState<string | null>(null);

  // å¤„ç† URL å‚æ•°
  useEffect(() => {
    // å¦‚æœ URL æŒ‡å®šäº† skillï¼Œåˆ‡æ¢åˆ°è¯¥ skill
    if (urlSkill && urlSkill !== skill) {
      setSkill(urlSkill as typeof skill);
    }

    // å¦‚æœ URL æŒ‡å®šäº† scenarioï¼Œè®¾ç½® scenario
    if (urlScenario) {
      setScenario(urlScenario);
    }

    // å¦‚æœ URL æŒ‡å®šäº† promptï¼Œè®¾ç½®åˆå§‹æ¶ˆæ¯
    if (urlPrompt) {
      const decoded = decodeURIComponent(urlPrompt);
      setInitialPrompt(decoded);

      // æ¸…ç† URL å‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤å‘é€
      const newUrl = window.location.pathname;
      router.replace(newUrl, { scroll: false });
    }
  }, [urlSkill, urlScenario, urlPrompt, skill, setSkill, router]);

  return (
    <LuminousPaper skill={skill} variant="default" className="h-full relative">
      <BreathAura skill={skill} size="xl" position="top" intensity="low" className="opacity-20" />
      {/*
        v7.2: è‡ªåŠ¨è·¯ç”±æ¨¡å¼
        - ä¸ä¼  skillIdï¼Œè®©åç«¯ CoreAgent é€šè¿‡ LLM è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·æ„å›¾
        - skill ä»…ç”¨äº UI å±•ç¤ºï¼ˆä¸»é¢˜ã€ç©ºçŠ¶æ€ç­‰ï¼‰
        - ç”¨æˆ·è¯´"æ˜Ÿåº§åˆ†æ"ä¼šè‡ªåŠ¨è·¯ç”±åˆ° zodiacï¼Œè¯´"å…«å­—"ä¼šè·¯ç”±åˆ° bazi
        - initialPrompt: ä»é€šçŸ¥è·³è½¬æ—¶çš„é¢„è®¾æ¶ˆæ¯
        - scenario: ä» URL ä¼ å…¥çš„ scenario/rule ID

        v9: Dashboard æ•´åˆ
        - ç©ºçŠ¶æ€å±•ç¤º Dashboard ç»„ä»¶ï¼ˆAmbientã€Lifecoachã€MySkillsï¼‰
        - é¢„åŠ è½½ Dashboard æ•°æ®ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
      */}
      <ChatContainer
        skill={skill}
        scenario={scenario || undefined}
        voiceMode={voiceMode}
        initialPrompt={initialPrompt}
        onInitialPromptSent={() => setInitialPrompt(null)}
        dashboardData={dashboard}
        isDashboardLoading={isDashboardLoading}
        onCheckIn={checkIn}
        onToggleLever={toggleLever}
        onToggleRock={toggleRock}
      />
    </LuminousPaper>
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Journey Content - æˆ‘çš„æ—…ç¨‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const JourneyLoadingFallback = memo(function JourneyLoadingFallback() {
  return (
    <div className="p-4 space-y-4 animate-pulse">
      <div className="h-40 bg-muted rounded-xl" />
      <div className="h-32 bg-muted rounded-xl" />
      <div className="h-24 bg-muted rounded-xl" />
    </div>
  );
});

const JourneyContent = memo(function JourneyContent() {
  return <JourneyContentComponent />;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Discover Content - æ¢ç´¢ Skills
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const DiscoverLoadingFallback = memo(function DiscoverLoadingFallback() {
  return (
    <div className="p-4 space-y-4 animate-pulse">
      <div className="h-32 bg-muted rounded-xl" />
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="h-48 bg-muted rounded-xl" />
        <div className="h-48 bg-muted rounded-xl" />
      </div>
    </div>
  );
});

const DiscoverContent = memo(function DiscoverContent() {
  return <DiscoverContentComponent />;
});

// Me Content - ä¸ªäººä¸­å¿ƒå†…å®¹
const MeContent = memo(function MeContent() {
  const { logout } = useAuth();

  return (
    <MePanel
      onLogout={logout}
    />
  );
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Chat Page - ä¸»ç»„ä»¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

export default function ChatPage() {
  const { skill } = useSkill();

  return (
    <AppShell
      skill={skill}
      journeyContent={
        <Suspense fallback={<JourneyLoadingFallback />}>
          <JourneyContent />
        </Suspense>
      }
      discoverContent={
        <Suspense fallback={<DiscoverLoadingFallback />}>
          <DiscoverContent />
        </Suspense>
      }
      meContent={
        <Suspense fallback={<PanelLoadingFallback />}>
          <MeContent />
        </Suspense>
      }
    >
      <Suspense fallback={<ChatLoadingFallback />}>
        <ChatContent />
      </Suspense>
    </AppShell>
  );
}
