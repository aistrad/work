# CoreAgent + Skill 基于 VibeProfile V8 架构更新方案

## 概述

基于 VibeProfile V8 三层架构更新 CoreAgent 和 Skill 系统：
1. **删除 Cold Layer** - 废弃的架构冗余
2. **Vibe Layer 双向同步** - skill ↔ vibe 自动同步
3. **数据访问权限控制** - Skill 只能写自己的数据

## Part 1: 删除 Cold Layer

### 删除文件/代码

| 位置 | 操作 |
|-----|------|
| `stores/migrations/020_cold_layer_tables.sql` | 删除文件 |
| `stores/unified_profile_repo.py` | 删除 `ColdLayerRepository` 类 + `ProfileInsight` / `TimelineEvent` dataclass |
| `workers/profile_extractor.py` | 删除 `timeline_events` 写入逻辑 |

### 数据库清理

```sql
DROP TABLE IF EXISTS vibe_profile_insights;
DROP TABLE IF EXISTS vibe_profile_timeline;
```

## Part 2: Vibe 同步增强

### 改动点

| 文件 | 改动 |
|-----|------|
| `stores/unified_profile_repo.py` | 新增 `sync_bazi_to_vibe_insight()` |
| `stores/unified_profile_repo.py` | 新增 `sync_zodiac_to_vibe_insight()` |
| `stores/unified_profile_repo.py` | 修改 `update_skill_data()` 触发同步 |

### 同步逻辑

```
bazi.chart 更新 → 提取日主 → 映射原型 → 写入 vibe.insight.essence.archetype
zodiac.chart 更新 → 提取太阳/上升 → 写入 vibe.insight.essence.traits
lifecoach 更新 → 已有同步到 vibe.target（保留）
```

## Part 3: 访问控制（可选）

### 权限规则

| Skill | 可写 |
|-------|------|
| core | state, extracted |
| lifecoach | skills.lifecoach, vibe.target |
| bazi | skills.bazi |
| zodiac | skills.zodiac |
| tarot | skills.tarot |
| career | skills.career |

### 实现方式

新建 `services/agent/access_control.py`，在 ToolExecutor 写入前校验。

## 关键文件

1. `stores/unified_profile_repo.py` - 删除 Cold Layer + 新增 Vibe 同步
2. `workers/profile_extractor.py` - 删除 timeline 写入
3. `services/agent/access_control.py` - 新建权限控制（可选）

## 验证

```bash
# 删除后检查
psql -c "SELECT count(*) FROM vibe_profile_insights" # 应报错：表不存在

# Vibe 同步验证
python scripts/test_coreagent_claude.py --skill bazi --check-vibe-sync
```

## 未解决问题

1. **历史数据迁移** - Cold Layer 表中是否有需要保留的数据？
2. **profile_extractor 精简** - 删除 timeline 后是否需要进一步精简？
