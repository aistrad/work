# CoreAgent + Skill 基于 VibeProfile V8 架构更新方案

## 概述

基于 VibeProfile V8 三层架构，彻底更新 CoreAgent 和 Skill 系统，实现：
- Cold Layer 完整集成（洞察/时间线）
- Vibe Layer 双向同步（skill ↔ vibe）
- 数据访问权限控制

## 核心改动

### 1. Cold Layer 集成

| 文件 | 改动 |
|-----|------|
| `services/agent/context_manager.py` | 新增 `get_cold_layer_context()` 读取 insights + timeline |
| `services/agent/prompt_builder.py` | 新增 `_build_cold_layer_context()` 注入到 System Prompt |
| `services/agent/tool_executor.py` | 新增 `_write_to_cold_layer()` 工具执行后写入 |

### 2. Vibe 同步增强

| 文件 | 改动 |
|-----|------|
| `stores/unified_profile_repo.py` | 新增 `sync_bazi_to_vibe_insight()` |
| `stores/unified_profile_repo.py` | 新增 `sync_zodiac_to_vibe_insight()` |
| `stores/unified_profile_repo.py` | 修改 `update_skill_data()` 触发同步 |

### 3. 访问控制

| 文件 | 改动 |
|-----|------|
| `services/agent/access_control.py` | **新建** - 定义 SKILL_DATA_ACCESS 规则 |
| `services/agent/tool_executor.py` | 写入前调用 `check_write_access()` |

## 数据流

```
API → CoreAgent.run()
        │
        ├─ ContextManager.get_profile_context()
        │    ├─ Layer 1: identity
        │    ├─ Layer 2: skills.{skill_id}
        │    ├─ Layer 3: vibe.insight + vibe.target
        │    └─ Cold Layer: insights + timeline (新增)
        │
        ├─ PromptBuilder.build()
        │    └─ 完整三层 + Cold Layer 注入
        │
        └─ ToolExecutor.execute()
             ├─ check_write_access() (新增)
             ├─ 写入 skill_data
             ├─ 触发 vibe 同步 (增强)
             └─ 写入 Cold Layer (新增)
```

## 权限规则

| Skill | 可读 | 可写 |
|-------|------|------|
| core | * | state, extracted |
| lifecoach | * | skills.lifecoach, vibe.target |
| bazi | identity, state, skills.bazi, vibe.insight | skills.bazi |
| zodiac | identity, state, skills.zodiac, vibe.insight | skills.zodiac |
| tarot | identity, state, skills.tarot | skills.tarot |
| career | identity, state, skills.career, vibe.target | skills.career |
| jungastro | identity, state, skills.bazi, skills.zodiac, vibe.insight | skills.jungastro |

## 关键文件

1. `/apps/api/services/agent/context_manager.py` - Cold Layer 读取
2. `/apps/api/services/agent/prompt_builder.py` - Prompt 注入
3. `/apps/api/services/agent/tool_executor.py` - 工具执行 + 写入
4. `/apps/api/stores/unified_profile_repo.py` - Vibe 同步
5. `/apps/api/services/agent/access_control.py` - 权限控制（新建）

## 验证

```bash
# Cold Layer 集成
python scripts/test_coreagent_claude.py --skill lifecoach --check-cold-layer

# Vibe 同步
python scripts/test_coreagent_claude.py --skill bazi --check-vibe-sync

# 权限校验
python scripts/test_access_control.py
```

## 未解决问题

1. Cold Layer 数据清理策略（建议保留 1 年）
2. vibe 同步时机（建议实时同步）
3. 跨 Skill 数据读取校验（当前通过 SKILL.md 配置）
4. 性能影响（建议 Cold Layer 加 5 分钟缓存）
