"use client"

import { cn } from "@/lib/utils"
import { motion } from "framer-motion"

export type OrbSize = "xs" | "sm" | "md" | "lg" | "xl"
export type OrbElement = "wood" | "fire" | "earth" | "metal" | "water" | "default"
export type OrbStatus = "balanced" | "low" | "high" | "pulsing"

interface OrbIndicatorProps {
  size?: OrbSize
  element?: OrbElement
  status?: OrbStatus
  className?: string
  showLabel?: boolean
  label?: string
  animate?: boolean
}

const sizeMap: Record<OrbSize, { container: string; orb: string; blur: string }> = {
  xs: { container: "w-4 h-4", orb: "w-3 h-3", blur: "blur-[2px]" },
  sm: { container: "w-8 h-8", orb: "w-6 h-6", blur: "blur-[4px]" },
  md: { container: "w-12 h-12", orb: "w-10 h-10", blur: "blur-[6px]" },
  lg: { container: "w-20 h-20", orb: "w-16 h-16", blur: "blur-[10px]" },
  xl: { container: "w-32 h-32", orb: "w-28 h-28", blur: "blur-[16px]" }
}

const elementGradients: Record<OrbElement, string> = {
  wood: "from-element-wood to-element-wood-dark",
  fire: "from-element-fire to-element-fire-dark",
  earth: "from-element-earth to-element-earth-dark",
  metal: "from-element-metal to-element-metal-dark",
  water: "from-element-water to-element-water-dark",
  default: "from-[hsl(var(--orb-from))] to-[hsl(var(--orb-to))]"
}

const elementLabels: Record<OrbElement, string> = {
  wood: "木",
  fire: "火",
  earth: "土",
  metal: "金",
  water: "水",
  default: ""
}

export function OrbIndicator({
  size = "sm",
  element = "default",
  status = "balanced",
  className,
  showLabel = false,
  label,
  animate = true
}: OrbIndicatorProps) {
  const sizeStyles = sizeMap[size]
  const gradient = elementGradients[element]

  // Animation variants based on status
  const pulseVariants = {
    balanced: {
      scale: [1, 1.02, 1],
      opacity: [1, 0.95, 1]
    },
    low: {
      scale: [1, 0.98, 1],
      opacity: [0.7, 0.6, 0.7]
    },
    high: {
      scale: [1, 1.05, 1],
      opacity: [1, 1, 1]
    },
    pulsing: {
      scale: [1, 1.1, 1],
      opacity: [0.8, 1, 0.8]
    }
  }

  const glowVariants = {
    balanced: {
      opacity: [0.3, 0.5, 0.3]
    },
    low: {
      opacity: [0.1, 0.2, 0.1]
    },
    high: {
      opacity: [0.5, 0.7, 0.5]
    },
    pulsing: {
      opacity: [0.4, 0.8, 0.4]
    }
  }

  const transitionConfig = {
    balanced: { duration: 4, ease: "easeInOut", repeat: Infinity },
    low: { duration: 6, ease: "easeInOut", repeat: Infinity },
    high: { duration: 2, ease: "easeInOut", repeat: Infinity },
    pulsing: { duration: 1.5, ease: "easeInOut", repeat: Infinity }
  }

  return (
    <div
      className={cn(
        "relative flex items-center justify-center",
        sizeStyles.container,
        className
      )}
      role="img"
      aria-label={`能量状态: ${status}, 元素: ${element !== 'default' ? elementLabels[element] : '默认'}`}
    >
      {/* Glow effect */}
      {animate ? (
        <motion.div
          className={cn(
            "absolute inset-0 rounded-full bg-gradient-to-br",
            gradient,
            sizeStyles.blur
          )}
          animate={glowVariants[status]}
          transition={transitionConfig[status]}
        />
      ) : (
        <div
          className={cn(
            "absolute inset-0 rounded-full bg-gradient-to-br opacity-30",
            gradient,
            sizeStyles.blur
          )}
        />
      )}

      {/* Main orb */}
      {animate ? (
        <motion.div
          className={cn(
            "relative rounded-full bg-gradient-to-br shadow-lg",
            gradient,
            sizeStyles.orb
          )}
          animate={pulseVariants[status]}
          transition={transitionConfig[status]}
        >
          {/* Inner highlight */}
          <div className="absolute inset-[15%] rounded-full bg-white/20" />

          {/* Label */}
          {showLabel && (label || element !== 'default') && (
            <span className="absolute inset-0 flex items-center justify-center text-white font-serif font-medium text-[0.6em]">
              {label || elementLabels[element]}
            </span>
          )}
        </motion.div>
      ) : (
        <div
          className={cn(
            "relative rounded-full bg-gradient-to-br shadow-lg",
            gradient,
            sizeStyles.orb
          )}
        >
          {/* Inner highlight */}
          <div className="absolute inset-[15%] rounded-full bg-white/20" />

          {/* Label */}
          {showLabel && (label || element !== 'default') && (
            <span className="absolute inset-0 flex items-center justify-center text-white font-serif font-medium text-[0.6em]">
              {label || elementLabels[element]}
            </span>
          )}
        </div>
      )}
    </div>
  )
}

// Loading Orb - 专用于加载状态
export function LoadingOrb({ size = "md", className }: { size?: OrbSize; className?: string }) {
  return (
    <OrbIndicator
      size={size}
      status="pulsing"
      element="default"
      className={className}
      animate={true}
    />
  )
}

// Empty State Orb - 专用于空态
export function EmptyStateOrb({ className }: { className?: string }) {
  return (
    <div className={cn("flex flex-col items-center gap-4", className)}>
      <OrbIndicator
        size="xl"
        status="balanced"
        element="default"
        animate={true}
      />
      <p className="text-text-secondary text-sm font-sans">
        开始一段对话，探索内心宇宙
      </p>
    </div>
  )
}

// Header Mini Orb - 用于 Header 的小型状态指示器
export function HeaderOrb({
  element = "default",
  status = "balanced",
  label,
  className
}: {
  element?: OrbElement
  status?: OrbStatus
  label?: string
  className?: string
}) {
  return (
    <OrbIndicator
      size="sm"
      element={element}
      status={status}
      showLabel={true}
      label={label}
      className={className}
      animate={true}
    />
  )
}

export default OrbIndicator
