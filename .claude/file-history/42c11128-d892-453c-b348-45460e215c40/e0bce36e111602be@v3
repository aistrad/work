-- SSOT Store Migration
-- Migrate conversation_store, prompt_store, rectification_store from local files to PostgreSQL

-- ============================================================================
-- Conversation Store: Job Index & Conversation Messages
-- ============================================================================

-- Job index (was job_index.json)
CREATE TABLE IF NOT EXISTS job_index (
    job_id BIGINT PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_job_index_user ON job_index(user_id);

-- Conversation messages (was user/{user_id}/conversations/{job_id}.jsonl)
CREATE TABLE IF NOT EXISTS conversation_messages (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    job_id TEXT NOT NULL,  -- Can be string or numeric
    role TEXT NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
    content TEXT NOT NULL,
    model TEXT,
    doc_url TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_conv_msg_user_job ON conversation_messages(user_id, job_id);
CREATE INDEX IF NOT EXISTS idx_conv_msg_created ON conversation_messages(created_at DESC);

-- ============================================================================
-- Prompt Store: User Prompt History
-- ============================================================================

-- Prompt history (was user/prompts/openid_{key}/prompts.json)
CREATE TABLE IF NOT EXISTS prompt_history (
    id BIGSERIAL PRIMARY KEY,
    openid TEXT NOT NULL,
    text TEXT NOT NULL,
    model TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Unique constraint to prevent duplicates (same openid + text)
CREATE UNIQUE INDEX IF NOT EXISTS uq_prompt_history_openid_text ON prompt_history(openid, md5(text));
CREATE INDEX IF NOT EXISTS idx_prompt_history_openid ON prompt_history(openid, created_at DESC);

-- ============================================================================
-- Rectification Store: Calibration Records
-- ============================================================================

-- Rectification runs (was user/{user_id}/rectification/runs.jsonl + last.json)
CREATE TABLE IF NOT EXISTS rectification_runs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    request_payload JSONB NOT NULL DEFAULT '{}',
    result_payload JSONB NOT NULL DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_rectification_user ON rectification_runs(user_id, created_at DESC);

-- View for "last rectification" per user (avoids subquery in app)
CREATE OR REPLACE VIEW v_last_rectification AS
SELECT DISTINCT ON (user_id) *
FROM rectification_runs
ORDER BY user_id, created_at DESC;

-- ============================================================================
-- Data Migration Helpers (optional, run manually if needed)
-- ============================================================================

-- COMMENT: After running this migration, the application will use DB.
-- Existing file-based data can be migrated with a one-time script if needed.
-- File-based stores can be kept as backup during transition period.

SELECT 'SSOT stores migration complete' AS result;
