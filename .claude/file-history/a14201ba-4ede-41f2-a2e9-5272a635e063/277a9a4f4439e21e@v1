-- Fortune AI Goal & Enhanced Reflection Schema
-- Date: 2026-01-01
-- Purpose: Add Goal setting module and enhance Reflection for complete OS loop

-- =============================================================================
-- 1. Goal Setting Module (目标设定)
-- REQ: os_design_claude_mvp v1.md §3
-- =============================================================================

CREATE TABLE IF NOT EXISTS fortune_goal (
    goal_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    parent_goal_id UUID REFERENCES fortune_goal(goal_id) ON DELETE SET NULL,
    type TEXT NOT NULL CHECK (type IN ('annual','quarterly','monthly','weekly')),
    title TEXT NOT NULL,
    outcome_measure TEXT,
    lead_measures JSONB DEFAULT '[]',
    assumptions JSONB DEFAULT '[]',
    dimension TEXT DEFAULT 'mixed' CHECK (dimension IN ('cognition','time','capital','mixed')),
    checkpoints JSONB DEFAULT '[]',
    status TEXT DEFAULT 'active' CHECK (status IN ('active','achieved','abandoned','revised')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_goal_user_status ON fortune_goal(user_id, status);
CREATE INDEX IF NOT EXISTS idx_goal_parent ON fortune_goal(parent_goal_id) WHERE parent_goal_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_goal_type ON fortune_goal(user_id, type, created_at DESC);

-- =============================================================================
-- 2. Goal-Commitment Link (目标-任务关联)
-- =============================================================================

-- Add goal_id to fortune_commitment if not exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'fortune_commitment' AND column_name = 'goal_id'
    ) THEN
        ALTER TABLE fortune_commitment ADD COLUMN goal_id UUID REFERENCES fortune_goal(goal_id) ON DELETE SET NULL;
        CREATE INDEX IF NOT EXISTS idx_commitment_goal ON fortune_commitment(goal_id) WHERE goal_id IS NOT NULL;
    END IF;
END $$;

-- =============================================================================
-- 3. Enhanced Reflection Table (增强版复盘)
-- REQ: os_design_claude_mvp v1.md §4
-- =============================================================================

-- Check if fortune_reflection exists and migrate to new schema
DO $$
BEGIN
    -- If the table exists but lacks new columns, add them
    IF EXISTS (
        SELECT 1 FROM information_schema.tables
        WHERE table_name = 'fortune_reflection'
    ) THEN
        -- Add new columns if they don't exist
        IF NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_name = 'fortune_reflection' AND column_name = 'four_questions'
        ) THEN
            ALTER TABLE fortune_reflection
                ADD COLUMN IF NOT EXISTS period_start DATE,
                ADD COLUMN IF NOT EXISTS period_end DATE,
                ADD COLUMN IF NOT EXISTS related_goal_id UUID REFERENCES fortune_goal(goal_id) ON DELETE SET NULL,
                ADD COLUMN IF NOT EXISTS facts JSONB DEFAULT '{}',
                ADD COLUMN IF NOT EXISTS decision_review JSONB DEFAULT '{}',
                ADD COLUMN IF NOT EXISTS four_questions JSONB DEFAULT '{}',
                ADD COLUMN IF NOT EXISTS upgrades JSONB DEFAULT '{}',
                ADD COLUMN IF NOT EXISTS next_focus TEXT;

            -- Migrate existing data: set period_start/end from reflection_date
            UPDATE fortune_reflection
            SET period_start = reflection_date,
                period_end = reflection_date
            WHERE period_start IS NULL AND reflection_date IS NOT NULL;

            -- Set defaults for remaining nulls
            UPDATE fortune_reflection
            SET period_start = COALESCE(period_start, created_at::date),
                period_end = COALESCE(period_end, created_at::date);

            -- Now make period_start/end NOT NULL
            ALTER TABLE fortune_reflection ALTER COLUMN period_start SET NOT NULL;
            ALTER TABLE fortune_reflection ALTER COLUMN period_end SET NOT NULL;
        END IF;

        -- Update type check constraint if needed (period -> type)
        IF EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_name = 'fortune_reflection' AND column_name = 'period'
        ) AND NOT EXISTS (
            SELECT 1 FROM information_schema.columns
            WHERE table_name = 'fortune_reflection' AND column_name = 'type'
        ) THEN
            ALTER TABLE fortune_reflection RENAME COLUMN period TO type;
        END IF;

        -- Add 'monthly' and 'checkpoint' to type check if needed
        -- Drop and recreate constraint
        ALTER TABLE fortune_reflection DROP CONSTRAINT IF EXISTS fortune_reflection_period_check;
        ALTER TABLE fortune_reflection DROP CONSTRAINT IF EXISTS fortune_reflection_type_check;
        ALTER TABLE fortune_reflection ADD CONSTRAINT fortune_reflection_type_check
            CHECK (type IN ('daily','weekly','monthly','checkpoint'));
    END IF;
END $$;

-- Create index on reflection type and user
CREATE INDEX IF NOT EXISTS idx_reflection_user_type ON fortune_reflection(user_id, type, period_start DESC);
CREATE INDEX IF NOT EXISTS idx_reflection_goal ON fortune_reflection(related_goal_id) WHERE related_goal_id IS NOT NULL;

-- =============================================================================
-- 4. User Onboarding Status (新用户豁免)
-- =============================================================================

-- Add onboarding_completed to fortune_user if not exists
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.columns
        WHERE table_name = 'fortune_user' AND column_name = 'onboarding_completed'
    ) THEN
        ALTER TABLE fortune_user ADD COLUMN onboarding_completed BOOLEAN DEFAULT FALSE;
    END IF;
END $$;
