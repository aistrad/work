from __future__ import annotations

import json
from datetime import date, datetime, time, timedelta, timezone
from typing import Any, Dict, List, Optional, Tuple
from uuid import uuid4

from zoneinfo import ZoneInfo

from common.logging import get_logger
from services import bazi_facts, plan_service
from stores import fortune_db


logger = get_logger(__name__)


def _now_utc() -> datetime:
    return datetime.now(timezone.utc)


def _today_for_user(user_id: int) -> date:
    prefs = fortune_db.fetch_one("SELECT push_timezone FROM fortune_user_preferences WHERE user_id=%s", (int(user_id),)) or {}
    tz_name = str(prefs.get("push_timezone") or "Asia/Shanghai")
    try:
        tz = ZoneInfo(tz_name)
    except Exception:
        tz = ZoneInfo("Asia/Shanghai")
    return datetime.now(tz).date()


def _insert_commitment(
    *,
    user_id: int,
    session_id: Optional[str],
    card_id: str,
    source: str,
    commitment_type: str,
    title: str,
    details: Dict[str, Any],
    due_at: Optional[datetime] = None,
) -> str:
    task_id = str(uuid4())
    fortune_db.execute(
        """
        INSERT INTO fortune_commitment (task_id, user_id, session_id, card_id, source, commitment_type, title, details, status, due_at)
        VALUES (%s::uuid, %s, %s::uuid, %s::uuid, %s, %s, %s, %s::jsonb, 'suggested', %s)
        """,
        (
            task_id,
            int(user_id),
            session_id,
            card_id,
            source,
            commitment_type,
            (title or "")[:200],
            json.dumps(details or {}, ensure_ascii=False),
            due_at,
        ),
    )
    return task_id


def _guidance_card_to_a2ui(card: Dict[str, Any]) -> Dict[str, Any]:
    title = "ä»Šæ—¥æŒ‡å¼•"
    conclusion = str(card.get("conclusion") or "")
    why = str(card.get("why") or "")
    prescriptions = card.get("prescriptions") or []
    tw = card.get("time_window") or {}
    commitment_ask = str(card.get("commitment_ask") or "ä½ æ„¿æ„å…ˆåšå“ªä¸€ä¸ªï¼Ÿ")
    risk = str(card.get("risk_boundary") or "ä¸æ›¿ä»£åŒ»ç–—/æ³•å¾‹/æŠ•èµ„å»ºè®®")

    lines: List[str] = []
    lines.append("### ç»“è®ºè¦ç‚¹")
    if conclusion:
        lines.append(f"- {conclusion}")
    lines.append("")
    if why:
        lines.append("### ä¸ºä»€ä¹ˆï¼ˆæ•™ç»ƒè§†è§’ï¼‰")
        lines.append(why)
        lines.append("")
    if prescriptions:
        lines.append("### è¡ŒåŠ¨å¤„æ–¹ï¼ˆâ‰¤3æ¡ï¼‰")
        for i, p in enumerate(prescriptions[:3], start=1):
            lines.append(f"{i}) {p.get('content')}")
        lines.append("")
    if tw:
        lines.append("### æ—¶é—´çª—å£")
        lines.append(f"- {tw.get('value') or ''}ï¼ˆ{tw.get('confidence') or ''}ï¼‰")
        lines.append("")
    lines.append("### é£é™©è¾¹ç•Œ")
    lines.append(risk)
    lines.append("")
    lines.append("### æ‰¿è¯º")
    lines.append(commitment_ask)

    actions = []
    for a in card.get("actions") or []:
        if not isinstance(a, dict):
            continue
        label = str(a.get("label") or "")
        payload = {"type": str(a.get("type") or "")}
        if a.get("task_id"):
            payload["task_id"] = str(a["task_id"])
        actions.append({"label": label, "action": payload})

    return {
        "meta": {"summary": conclusion[:80] or title},
        "ui_components": [
            {"type": "markdown_text", "title": title, "data": "\n".join(lines).strip()},
            {"type": "action_buttons", "title": "ä¸‹ä¸€æ­¥", "data": actions},
        ],
    }


def get_today_guidance(user_id: int) -> Dict[str, Any]:
    today = _today_for_user(user_id)
    existing = fortune_db.fetch_one(
        "SELECT card FROM fortune_daily_guidance WHERE user_id=%s AND guidance_date=%s",
        (int(user_id), today),
    )
    if existing and existing.get("card"):
        card = existing["card"]
        return {"guidance_date": str(today), "card": card, "a2ui": _guidance_card_to_a2ui(card)}

    snap = bazi_facts.ensure_snapshot_for_user(user_id)
    facts_hash = str(snap.get("facts_hash") or "")

    enrollment = plan_service.get_active_enrollment(user_id)
    plan_id = None
    plan_name = None
    day_no = None
    title = ""
    instruction = ""

    if enrollment:
        # sync current_day based on user's local date (today)
        try:
            plan_service.sync_enrollment_current_day(int(enrollment["enrollment_id"]), today=today)
        except Exception:
            pass
        enrollment = plan_service.get_active_enrollment(user_id) or enrollment
        plan_id = str(enrollment.get("plan_id") or "")
        plan_name = str(enrollment.get("name") or "")
        day_no = int(enrollment.get("current_day") or 1)
        day = plan_service.get_plan_day(plan_id, day_no) or {}
        title = str(day.get("title") or "")
        instruction = str(day.get("instruction") or "")

    if not instruction:
        plan_id = ""
        plan_name = ""
        day_no = None
        title = "ä¸‰åˆ†é’Ÿé™å™ªåè®®"
        instruction = "è®¡æ—¶3åˆ†é’Ÿï¼š1åˆ†é’Ÿå‘¼å¸â†’1åˆ†é’Ÿèº«ä½“æ„Ÿå—â†’1åˆ†é’Ÿé€‰æ‹©ä¸‹ä¸€æ­¥ï¼ˆä¸€ä¸ªå°åŠ¨ä½œï¼‰ã€‚"

    card_id = str(uuid4())
    task_id = _insert_commitment(
        user_id=user_id,
        session_id=None,
        card_id=card_id,
        source="bento",
        commitment_type="start_task",
        title=title or "ä»Šæ—¥è¡ŒåŠ¨",
        details={"plan_id": plan_id, "plan_name": plan_name, "day_no": day_no, "instruction": instruction},
        due_at=None,
    )

    checkpoint = (today + timedelta(days=7)).isoformat()
    card = {
        "card_id": card_id,
        "type": "daily_guidance",
        "conclusion": f"ä»Šå¤©å…ˆåšä¸€ä¸ªæœ€å°åŠ¨ä½œï¼š{title}" if title else "ä»Šå¤©å…ˆåšä¸€ä¸ªæœ€å°åŠ¨ä½œ",
        "why": f"æŠŠä¸ç¡®å®šæ€§æ”¶æ•›åˆ°ä¸€ä¸ªå¯æ‰§è¡ŒåŠ¨ä½œï¼Œä½ ä¼šæ›´å¿«è·å¾—å¯æ§æ„Ÿã€‚{('æ¥è‡ªè®¡åˆ’ï¼š'+plan_name) if plan_name else ''}".strip(),
        "prescriptions": [{"task_id": task_id, "content": instruction, "estimated_minutes": 5}],
        "time_window": {"type": "intervention", "value": "7å¤©è¯•è¡Œ", "confidence": "high", "checkpoint_date": checkpoint},
        "risk_boundary": "ä¸æ›¿ä»£åŒ»ç–—/æ³•å¾‹/æŠ•èµ„å»ºè®®",
        "commitment_ask": "ä½ æ„¿æ„ç°åœ¨å¼€å§‹ï¼Œè¿˜æ˜¯å…ˆåŠ å…¥ä»Šæ—¥è®¡åˆ’ï¼Ÿ",
        "actions": [
            {"type": "start_task", "task_id": task_id, "label": "å¼€å§‹ï¼ˆ2-5åˆ†é’Ÿï¼‰"},
            {"type": "schedule_task", "task_id": task_id, "label": "åŠ å…¥ä»Šæ—¥è®¡åˆ’"},
            {"type": "open_panel", "label": "æ‰“å¼€è¡ŒåŠ¨å¤„æ–¹"},
            {"type": "opt_out", "label": "å…ˆä¸éœ€è¦"},
        ],
        "evidence": {"plugin": "bazi", "rule_ids": [], "kb_refs": [], "facts_hash": facts_hash},
        "created_at": _now_utc().isoformat().replace("+00:00", "Z"),
    }

    fortune_db.execute(
        """
        INSERT INTO fortune_daily_guidance (user_id, guidance_date, card)
        VALUES (%s, %s, %s::jsonb)
        ON CONFLICT (user_id, guidance_date) DO NOTHING
        """,
        (int(user_id), today, json.dumps(card, ensure_ascii=False)),
    )

    logger.info(
        "today guidance created",
        extra={"operation": "bento_today", "user_id": int(user_id), "guidance_date": str(today), "card_id": card_id, "task_id": task_id},
    )

    return {"guidance_date": str(today), "card": card, "a2ui": _guidance_card_to_a2ui(card)}


def list_commitments(user_id: int, *, status: List[str], limit: int = 10) -> List[Dict[str, Any]]:
    lim = int(limit or 10)
    if lim < 1:
        lim = 1
    if lim > 50:
        lim = 50
    sts = status or ["suggested", "active"]
    rows = fortune_db.fetch_all(
        """
        SELECT task_id, status, commitment_type, title, details, source, accepted_at, due_at, done_at, created_at
        FROM fortune_commitment
        WHERE user_id=%s AND status = ANY(%s)
        ORDER BY created_at DESC
        LIMIT %s
        """,
        (int(user_id), sts, lim),
    )
    items = []
    for r in rows or []:
        items.append(
            {
                "task_id": str(r["task_id"]),
                "status": str(r.get("status") or ""),
                "commitment_type": str(r.get("commitment_type") or ""),
                "title": str(r.get("title") or ""),
                "details": r.get("details") or {},
                "source": str(r.get("source") or ""),
                "accepted_at": (str(r["accepted_at"]) if r.get("accepted_at") else None),
                "due_at": (str(r["due_at"]) if r.get("due_at") else None),
                "done_at": (str(r["done_at"]) if r.get("done_at") else None),
                "created_at": str(r.get("created_at") or ""),
            }
        )
    return items


def recommend_action(mood: str, intensity: int) -> str:
    m = (mood or "").strip()[:20]
    x = int(intensity)
    if x < 0:
        x = 0
    if x > 10:
        x = 10

    if "ç„¦è™‘" in m:
        return "3åˆ†é’Ÿé™å™ªåè®®ï¼š1åˆ†é’Ÿå‘¼å¸â†’1åˆ†é’Ÿèº«ä½“æ„Ÿå—â†’1åˆ†é’Ÿé€‰æ‹©ä¸‹ä¸€æ­¥ï¼ˆä¸€ä¸ªå°åŠ¨ä½œï¼‰ã€‚"
    if "ä½è½" in m or "éš¾è¿‡" in m:
        return "ä¸¤åˆ†é’Ÿè‡ªæˆ‘åŒæƒ…ï¼šå¯¹è‡ªå·±è¯´â€œæˆ‘æ­£åœ¨ç»å†å›°éš¾ï¼›è¿™å¾ˆæ­£å¸¸ï¼›æˆ‘å¯ä»¥å…ˆåšä¸€ä¸ªæœ€å°åŠ¨ä½œâ€ã€‚"
    if "æ„¤æ€’" in m or "ç”Ÿæ°”" in m:
        return "20ç§’å»¶è¿Ÿï¼šå…ˆç¦»å¼€å†²çªç°åœºâ†’åš5æ¬¡æ·±å‘¼å¸â†’å†™ä¸‹â€œæˆ‘çš„åº•çº¿æ˜¯ä»€ä¹ˆâ€ã€‚"
    if "å…´å¥‹" in m:
        return "æŠŠèƒ½é‡è½¬æˆä¸€ä¸ªå°è¡ŒåŠ¨ï¼šç«‹åˆ»åšä¸€ä¸ª2åˆ†é’Ÿç‰ˆæœ¬ï¼Œå¹¶æŠŠä¸‹ä¸€æ­¥å†™è¿›å¾…åŠã€‚"
    if "å¹³é™" in m:
        return "ä¿æŒä¼˜åŠ¿ï¼šå†™ä¸‹ä»Šå¤©æœ€æƒ³ä¿ç•™çš„ä¸€ä¸ªåšæ³•ï¼Œå¹¶å®‰æ’ä¸€ä¸ª5åˆ†é’Ÿçš„å»¶ç»­åŠ¨ä½œã€‚"

    if x >= 7:
        return "å…ˆåš3åˆ†é’Ÿå‘¼å¸é”šç‚¹ï¼Œå†å†³å®šä¸‹ä¸€æ­¥ã€‚"
    return "å†™ä¸‹ï¼šæˆ‘ç°åœ¨æœ€éœ€è¦è¢«æ»¡è¶³çš„ä¸€ä¸ªéœ€æ±‚æ˜¯ä»€ä¹ˆï¼Ÿç„¶ååšä¸€ä¸ª2åˆ†é’Ÿç‰ˆæœ¬ã€‚"


def create_checkin(user_id: int, *, mood: str, intensity: int, note: str) -> Dict[str, Any]:
    action = recommend_action(mood, intensity)
    fortune_db.execute(
        """
        INSERT INTO fortune_checkin (user_id, mood, intensity, note, recommended_action)
        VALUES (%s, %s, %s, %s, %s)
        """,
        (int(user_id), (mood or "")[:50], int(intensity), (note or "")[:1000], action),
    )
    task_id = str(uuid4())
    fortune_db.execute(
        """
        INSERT INTO fortune_commitment (task_id, user_id, source, commitment_type, title, details, status)
        VALUES (%s::uuid, %s, 'bento', 'start_task', %s, %s::jsonb, 'suggested')
        """,
        (
            task_id,
            int(user_id),
            (action[:200] if action else "æƒ…ç»ªè°ƒèŠ‚åŠ¨ä½œ"),
            json.dumps({"from": "checkin", "mood": mood, "intensity": int(intensity)}, ensure_ascii=False),
        ),
    )
    return {"recommended_action": action, "task_id": task_id}


# =============================================================================
# Decision Brief - å†³ç­–æ¨¡æ¿
# =============================================================================

def create_decision_brief(
    user_id: int,
    *,
    session_id: Optional[str],
    topic: str,
    options: List[str],
    constraints: List[str],
    time_horizon_days: int = 30,
) -> Dict[str, Any]:
    """
    åˆ›å»ºå†³ç­–ç®€æŠ¥ (Decision Brief)

    åŸºäº Options/Constraints/Risks/Next Experiment ç»“æ„ï¼Œ
    å¸®åŠ©ç”¨æˆ·ç»“æ„åŒ–é‡å¤§å†³ç­–ï¼Œé™ä½ Prompt Anxietyã€‚

    Args:
        user_id: ç”¨æˆ·ID
        session_id: ä¼šè¯IDï¼ˆå¯é€‰ï¼‰
        topic: å†³ç­–ä¸»é¢˜ï¼ˆå¦‚"æ˜¯å¦æ¢å·¥ä½œ"ï¼‰
        options: å¤‡é€‰æ–¹æ¡ˆåˆ—è¡¨
        constraints: çº¦æŸæ¡ä»¶åˆ—è¡¨
        time_horizon_days: å†³ç­–æ—¶é—´çª—å£ï¼ˆå¤©ï¼‰

    Returns:
        åŒ…å«å†³ç­–ç®€æŠ¥å’Œæ¨èå®éªŒä»»åŠ¡çš„å­—å…¸
    """
    topic = (topic or "").strip()[:200]
    options = [str(o).strip()[:100] for o in (options or []) if str(o).strip()][:5]
    constraints = [str(c).strip()[:100] for c in (constraints or []) if str(c).strip()][:5]
    time_horizon_days = max(1, min(365, int(time_horizon_days or 30)))

    if not topic:
        raise ValueError("topic is required")
    if not options or len(options) < 2:
        raise ValueError("at least 2 options required")

    # åˆ†æé£é™©ï¼ˆåŸºäºçº¦æŸæ¡ä»¶ï¼‰
    risks = _analyze_decision_risks(options, constraints)

    # ç”Ÿæˆæœ€å°éªŒè¯å®éªŒ
    next_experiment = _generate_next_experiment(topic, options, constraints, time_horizon_days)

    # ç”Ÿæˆå¯æ§/ä¸å¯æ§åˆ†æ
    controllable, uncontrollable = _split_controllable(constraints)

    # åˆ›å»ºå†³ç­–ç®€æŠ¥
    brief_id = str(uuid4())
    brief = {
        "brief_id": brief_id,
        "topic": topic,
        "options": options,
        "constraints": constraints,
        "risks": risks,
        "controllable": controllable,
        "uncontrollable": uncontrollable,
        "time_horizon_days": time_horizon_days,
        "next_experiment": next_experiment,
        "created_at": _now_utc().isoformat().replace("+00:00", "Z"),
    }

    # åˆ›å»ºå®éªŒä»»åŠ¡
    task_id = _insert_commitment(
        user_id=user_id,
        session_id=session_id,
        card_id=brief_id,
        source="decision_brief",
        commitment_type="start_task",
        title=next_experiment["title"],
        details={
            "brief_id": brief_id,
            "topic": topic,
            "experiment": next_experiment,
        },
        due_at=None,
    )

    # ç”Ÿæˆ A2UI
    a2ui = _decision_brief_to_a2ui(brief, task_id)

    logger.info(
        "decision brief created",
        extra={"operation": "decision_brief", "user_id": int(user_id), "brief_id": brief_id, "topic": topic},
    )

    return {"brief": brief, "task_id": task_id, "a2ui": a2ui}


def _analyze_decision_risks(options: List[str], constraints: List[str]) -> List[Dict[str, Any]]:
    """åˆ†ææ¯ä¸ªé€‰é¡¹çš„é£é™©"""
    risks = []
    for opt in options:
        opt_lower = opt.lower()
        risk_level = "low"
        risk_note = "æ ‡å‡†é£é™©èŒƒå›´"

        # ç®€å•çš„é£é™©è¯„ä¼°è§„åˆ™
        if any(kw in opt_lower for kw in ["ç¦»èŒ", "è·³æ§½", "è¾èŒ", "æ¢å·¥ä½œ"]):
            risk_level = "medium"
            risk_note = "æ”¶å…¥ä¸­æ–­é£é™©ï¼Œå»ºè®®æœ‰3-6ä¸ªæœˆå‚¨å¤‡"
        elif any(kw in opt_lower for kw in ["åˆ›ä¸š", "è‡ªå·±åš", "å•å¹²"]):
            risk_level = "high"
            risk_note = "é«˜ä¸ç¡®å®šæ€§ï¼Œå»ºè®®å…ˆåšæœ€å°å¯è¡ŒéªŒè¯"
        elif any(kw in opt_lower for kw in ["ç•™ä¸‹", "ä¸åŠ¨", "ç»´æŒ"]):
            risk_level = "low"
            risk_note = "æœºä¼šæˆæœ¬é£é™©ï¼Œæ³¨æ„é•¿æœŸå‘å±•"
        elif any(kw in opt_lower for kw in ["åˆ†æ‰‹", "ç¦»å©š", "åˆ†å¼€"]):
            risk_level = "medium"
            risk_note = "æƒ…æ„Ÿæˆæœ¬ï¼Œå»ºè®®å…ˆæ˜ç¡®æ ¸å¿ƒéœ€æ±‚"

        risks.append({
            "option": opt,
            "level": risk_level,
            "note": risk_note,
        })
    return risks


def _split_controllable(constraints: List[str]) -> Tuple[List[str], List[str]]:
    """å°†çº¦æŸåˆ†ä¸ºå¯æ§å’Œä¸å¯æ§"""
    controllable = []
    uncontrollable = []

    uncontrollable_keywords = ["ç»æµ", "å¸‚åœº", "å¤§ç¯å¢ƒ", "æ”¿ç­–", "ä»–äºº", "å¯¹æ–¹", "è€æ¿", "å…¬å¸", "è¡Œä¸š"]
    controllable_keywords = ["æ—¶é—´", "ç²¾åŠ›", "å­¦ä¹ ", "å‡†å¤‡", "æ²Ÿé€š", "æ€åº¦", "é€‰æ‹©", "æŠ€èƒ½"]

    for c in constraints:
        c_lower = c.lower()
        if any(kw in c_lower for kw in uncontrollable_keywords):
            uncontrollable.append(c)
        elif any(kw in c_lower for kw in controllable_keywords):
            controllable.append(c)
        else:
            # é»˜è®¤å½’ç±»ä¸ºå¯æ§ï¼ˆé¼“åŠ±ç”¨æˆ·æŒæ§æ„Ÿï¼‰
            controllable.append(c)

    return controllable, uncontrollable


def _generate_next_experiment(
    topic: str,
    options: List[str],
    constraints: List[str],
    time_horizon_days: int,
) -> Dict[str, Any]:
    """ç”Ÿæˆä¸‹ä¸€æ­¥æœ€å°éªŒè¯å®éªŒ"""
    topic_lower = topic.lower()

    # æ ¹æ®ä¸»é¢˜ç±»å‹ç”Ÿæˆå®éªŒ
    if any(kw in topic_lower for kw in ["å·¥ä½œ", "èŒä¸š", "è·³æ§½", "ç¦»èŒ"]):
        return {
            "title": "48å°æ—¶å†…æ‰¾1ä½ç›®æ ‡é¢†åŸŸçš„äººèŠ15åˆ†é’Ÿ",
            "description": "æ”¶é›†çœŸå®ä¿¡æ¯ï¼Œé™ä½ä¸ç¡®å®šæ€§ç„¦è™‘",
            "estimated_minutes": 15,
            "success_criteria": "è·å¾—è‡³å°‘1ä¸ªæ–°è§†è§’æˆ–ä¿¡æ¯ç‚¹",
        }
    elif any(kw in topic_lower for kw in ["æ„Ÿæƒ…", "å…³ç³»", "åˆ†æ‰‹", "ç»“å©š"]):
        return {
            "title": "å†™ä¸‹3ä¸ªæ ¸å¿ƒéœ€æ±‚å¹¶æ’åº",
            "description": "æ˜ç¡®è‡ªå·±çš„åº•çº¿å’Œéè°ˆåˆ¤é¡¹",
            "estimated_minutes": 10,
            "success_criteria": "æ¸…æ™°åˆ—å‡ºä¼˜å…ˆçº§æ’åº",
        }
    elif any(kw in topic_lower for kw in ["å­¦ä¹ ", "è€ƒè¯•", "æŠ€èƒ½"]):
        return {
            "title": "ç”¨25åˆ†é’Ÿåšä¸€ä¸ªæœ€å°ç‰ˆæœ¬çš„å°è¯•",
            "description": "éªŒè¯è‡ªå·±å¯¹è¿™ä»¶äº‹çš„çœŸå®å…´è¶£å’Œé€‚é…åº¦",
            "estimated_minutes": 25,
            "success_criteria": "ä½“éªŒåå†™ä¸‹æ„Ÿå—ï¼šæ˜¯å¦æƒ³ç»§ç»­",
        }
    elif any(kw in topic_lower for kw in ["æŠ•èµ„", "ä¹°æˆ¿", "ç†è´¢"]):
        return {
            "title": "åˆ—å‡º3ä¸ªå¯é‡åŒ–çš„å†³ç­–æ ‡å‡†",
            "description": "æŠŠæ¨¡ç³Šåˆ¤æ–­å˜æˆå¯æ¯”è¾ƒçš„æŒ‡æ ‡",
            "estimated_minutes": 15,
            "success_criteria": "æ¯ä¸ªé€‰é¡¹æŒ‰æ ‡å‡†æ‰“åˆ†",
        }
    else:
        return {
            "title": f"ç”¨10åˆ†é’Ÿå†™ä¸‹{options[0]}çš„æœ€å°éªŒè¯æ–¹å¼",
            "description": "æ‰¾åˆ°ä¸€ä¸ª24å°æ—¶å†…å¯ä»¥åšçš„å°åŠ¨ä½œæ¥æ”¶é›†ä¿¡æ¯",
            "estimated_minutes": 10,
            "success_criteria": "äº§å‡ºä¸€ä¸ªæ˜å¤©å¯ä»¥æ‰§è¡Œçš„å…·ä½“æ­¥éª¤",
        }


def _decision_brief_to_a2ui(brief: Dict[str, Any], task_id: str) -> Dict[str, Any]:
    """å°†å†³ç­–ç®€æŠ¥è½¬æ¢ä¸º A2UI æ ¼å¼"""
    topic = brief.get("topic", "")
    options = brief.get("options", [])
    constraints = brief.get("constraints", [])
    risks = brief.get("risks", [])
    controllable = brief.get("controllable", [])
    uncontrollable = brief.get("uncontrollable", [])
    experiment = brief.get("next_experiment", {})
    time_horizon = brief.get("time_horizon_days", 30)

    lines = []
    lines.append(f"## å†³ç­–ç®€æŠ¥ï¼š{topic}")
    lines.append("")
    lines.append("### å¤‡é€‰æ–¹æ¡ˆ")
    for i, opt in enumerate(options, 1):
        risk = risks[i - 1] if i <= len(risks) else {}
        risk_emoji = {"low": "ğŸŸ¢", "medium": "ğŸŸ¡", "high": "ğŸ”´"}.get(risk.get("level", "low"), "âšª")
        lines.append(f"{i}. {opt} {risk_emoji}")
    lines.append("")
    lines.append("### çº¦æŸæ¡ä»¶")
    if controllable:
        lines.append("**å¯æ§å› ç´ ï¼š**")
        for c in controllable:
            lines.append(f"- âœ… {c}")
    if uncontrollable:
        lines.append("**ä¸å¯æ§å› ç´ ï¼š**")
        for u in uncontrollable:
            lines.append(f"- âš ï¸ {u}")
    lines.append("")
    lines.append("### é£é™©è¯„ä¼°")
    for r in risks:
        lines.append(f"- **{r.get('option')}**ï¼š{r.get('note', '')}")
    lines.append("")
    lines.append(f"### å†³ç­–çª—å£ï¼š{time_horizon}å¤©")
    lines.append("")
    lines.append("### ä¸‹ä¸€æ­¥å®éªŒ")
    lines.append(f"**{experiment.get('title', '')}**")
    lines.append(f"- {experiment.get('description', '')}")
    lines.append(f"- é¢„è®¡æ—¶é—´ï¼š{experiment.get('estimated_minutes', 10)}åˆ†é’Ÿ")
    lines.append(f"- æˆåŠŸæ ‡å‡†ï¼š{experiment.get('success_criteria', '')}")

    return {
        "meta": {"summary": f"å†³ç­–ç®€æŠ¥ï¼š{topic[:40]}"},
        "ui_components": [
            {"type": "markdown_text", "title": "å†³ç­–ç®€æŠ¥", "data": "\n".join(lines)},
            {
                "type": "action_buttons",
                "title": "ä¸‹ä¸€æ­¥",
                "data": [
                    {"label": "å¼€å§‹å®éªŒ", "action": {"type": "start_task", "task_id": task_id}},
                    {"label": "åŠ å…¥ä»Šæ—¥è®¡åˆ’", "action": {"type": "schedule_task", "task_id": task_id}},
                    {"label": "æš‚ä¸å†³å®š", "action": {"type": "opt_out"}},
                ],
            },
        ],
    }


# =============================================================================
# Script Generator - è¯æœ¯ç”Ÿæˆå™¨
# =============================================================================

# è¯æœ¯åœºæ™¯æ¨¡æ¿
SCRIPT_TEMPLATES = {
    "æ²Ÿé€š": {
        "intro": "å½“ä½ éœ€è¦å¼€å¯ä¸€æ®µé‡è¦å¯¹è¯æ—¶",
        "structure": ["æˆ‘è§‚å¯Ÿåˆ°â€¦", "æˆ‘æ„Ÿè§‰â€¦", "æˆ‘éœ€è¦â€¦", "ä½ æ„¿æ„â€¦å—ï¼Ÿ"],
        "example": "æˆ‘è§‚å¯Ÿåˆ°æœ€è¿‘æˆ‘ä»¬äº¤æµå˜å°‘äº†ã€‚æˆ‘æ„Ÿè§‰æœ‰ç‚¹ç–è¿œã€‚æˆ‘éœ€è¦æ›´å¤šçš„è¿æ¥æ„Ÿã€‚ä½ æ„¿æ„ä»Šæ™šä¸€èµ·åƒé¥­èŠèŠå—ï¼Ÿ",
    },
    "è¾¹ç•Œ": {
        "intro": "å½“ä½ éœ€è¦è®¾ç«‹æˆ–ç»´æŠ¤è¾¹ç•Œæ—¶",
        "structure": ["æˆ‘ç†è§£ä½ çš„éœ€æ±‚â€¦", "åŒæ—¶æˆ‘çš„è¾¹ç•Œæ˜¯â€¦", "æˆ‘èƒ½æ¥å—çš„æ˜¯â€¦", "ä¸èƒ½æ¥å—çš„æ˜¯â€¦"],
        "example": "æˆ‘ç†è§£ä½ å¸Œæœ›æˆ‘èƒ½å¸®å¿™ã€‚åŒæ—¶æˆ‘çš„è¾¹ç•Œæ˜¯å‘¨æœ«éœ€è¦ä¼‘æ¯ã€‚æˆ‘èƒ½æ¥å—å·¥ä½œæ—¥å¶å°”åŠ ç­ï¼Œä¸èƒ½æ¥å—æ¯å‘¨éƒ½å ç”¨ä¼‘æ¯æ—¶é—´ã€‚",
    },
    "æ‹’ç»": {
        "intro": "å½“ä½ éœ€è¦è¯´ã€Œä¸ã€è€Œä¸ä¼¤å®³å…³ç³»æ—¶",
        "structure": ["æ„Ÿè°¢ä½ æƒ³åˆ°æˆ‘â€¦", "è¿™æ¬¡æˆ‘æ²¡åŠæ³•â€¦", "åŸå› æ˜¯â€¦", "ä¸‹æ¬¡å¦‚æœâ€¦"],
        "example": "æ„Ÿè°¢ä½ é‚€è¯·æˆ‘å‚åŠ ã€‚è¿™æ¬¡æˆ‘æ²¡åŠæ³•æ¥ã€‚åŸå› æ˜¯æˆ‘å·²ç»æœ‰å…¶ä»–å®‰æ’äº†ã€‚ä¸‹æ¬¡å¦‚æœæå‰ä¸€å‘¨é€šçŸ¥ï¼Œæˆ‘ä¼šæ›´å®¹æ˜“å®‰æ’ã€‚",
    },
    "è°ˆåˆ¤": {
        "intro": "å½“ä½ éœ€è¦äº‰å–è‡ªå·±çš„åˆ©ç›Šæ—¶",
        "structure": ["æˆ‘ç†è§£ä½ çš„ç«‹åœºæ˜¯â€¦", "æˆ‘çš„æœŸæœ›æ˜¯â€¦", "æˆ‘ä»¬èƒ½å¦æ¢è®¨â€¦", "å¦‚æœâ€¦é‚£ä¹ˆâ€¦"],
        "example": "æˆ‘ç†è§£å…¬å¸ç›®å‰çš„é¢„ç®—å‹åŠ›ã€‚æˆ‘çš„æœŸæœ›æ˜¯èƒ½è·å¾—20%çš„æ¶¨å¹…ã€‚æˆ‘ä»¬èƒ½å¦æ¢è®¨å…¶ä»–è¡¥å¿æ–¹å¼ï¼Ÿå¦‚æœç°é‡‘æœ‰å›°éš¾ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥è€ƒè™‘æœŸæƒæˆ–æ›´çµæ´»çš„å·¥ä½œæ—¶é—´ï¼Ÿ",
    },
    "é“æ­‰": {
        "intro": "å½“ä½ éœ€è¦çœŸè¯šé“æ­‰å¹¶ä¿®å¤å…³ç³»æ—¶",
        "structure": ["æˆ‘åšäº†â€¦", "è¿™å¯¹ä½ é€ æˆäº†â€¦", "æˆ‘èƒ½ç†è§£ä½ ä¼šæ„Ÿåˆ°â€¦", "æˆ‘ä¼šâ€¦æ¥å¼¥è¡¥"],
        "example": "æˆ‘å¿˜äº†æˆ‘ä»¬çš„çº¦å®šï¼Œè¿™å¯¹ä½ é€ æˆäº†æ—¶é—´å’ŒæœŸå¾…ä¸Šçš„æµªè´¹ã€‚æˆ‘èƒ½ç†è§£ä½ ä¼šæ„Ÿåˆ°å¤±æœ›å’Œä¸è¢«é‡è§†ã€‚æˆ‘ä¼šè®¾ç½®æé†’ï¼Œç¡®ä¿ä¸å†å‘ç”Ÿç±»ä¼¼çš„äº‹ã€‚",
    },
    "è¯·æ±‚": {
        "intro": "å½“ä½ éœ€è¦å‘ä»–äººå¯»æ±‚å¸®åŠ©æ—¶",
        "structure": ["æˆ‘æ­£åœ¨â€¦", "æˆ‘éœ€è¦â€¦æ–¹é¢çš„å¸®åŠ©", "ä½ èƒ½å¦â€¦", "è¿™å¯¹æˆ‘æ„å‘³ç€â€¦"],
        "example": "æˆ‘æ­£åœ¨å‡†å¤‡ä¸€ä¸ªé‡è¦çš„é¢è¯•ã€‚æˆ‘éœ€è¦æ¨¡æ‹Ÿé—®ç­”æ–¹é¢çš„å¸®åŠ©ã€‚ä½ èƒ½å¦è¿™å‘¨èŠ±30åˆ†é’Ÿå¸®æˆ‘ç»ƒä¹ ï¼Ÿè¿™å¯¹æˆ‘æ„å‘³ç€èƒ½æ›´æœ‰ä¿¡å¿ƒåœ°åº”å¯¹é¢è¯•ã€‚",
    },
}


def generate_script(
    user_id: int,
    *,
    session_id: Optional[str],
    scene_type: str,
    context: str,
    target_person: Optional[str] = None,
    tone: str = "å¹³å’Œ",
) -> Dict[str, Any]:
    """
    ç”Ÿæˆå¯¹è¯è¯æœ¯è„šæœ¬

    Args:
        user_id: ç”¨æˆ·ID
        session_id: ä¼šè¯IDï¼ˆå¯é€‰ï¼‰
        scene_type: åœºæ™¯ç±»å‹ï¼ˆæ²Ÿé€š/è¾¹ç•Œ/æ‹’ç»/è°ˆåˆ¤/é“æ­‰/è¯·æ±‚ï¼‰
        context: å…·ä½“æƒ…å¢ƒæè¿°
        target_person: å¯¹è¯å¯¹è±¡ï¼ˆå¦‚"è€æ¿"ã€"ä¼´ä¾£"ï¼‰
        tone: è¯­æ°”é£æ ¼ï¼ˆå¹³å’Œ/åšå®š/æ¸©æŸ”/æ­£å¼ï¼‰

    Returns:
        åŒ…å«è¯æœ¯è„šæœ¬å’Œç»ƒä¹ ä»»åŠ¡çš„å­—å…¸
    """
    scene_type = (scene_type or "æ²Ÿé€š").strip()[:20]
    context = (context or "").strip()[:500]
    target_person = (target_person or "å¯¹æ–¹").strip()[:50]
    tone = (tone or "å¹³å’Œ").strip()[:20]

    if scene_type not in SCRIPT_TEMPLATES:
        scene_type = "æ²Ÿé€š"

    template = SCRIPT_TEMPLATES[scene_type]

    # ç”Ÿæˆå®šåˆ¶è¯æœ¯
    script = _generate_custom_script(scene_type, context, target_person, tone, template)

    # åˆ›å»ºç»ƒä¹ ä»»åŠ¡
    task_id = _insert_commitment(
        user_id=user_id,
        session_id=session_id,
        card_id=str(uuid4()),
        source="script",
        commitment_type="start_task",
        title=f"ç»ƒä¹ {scene_type}è¯æœ¯ï¼ˆ2åˆ†é’Ÿï¼‰",
        details={
            "scene_type": scene_type,
            "context": context,
            "target_person": target_person,
            "script": script,
        },
        due_at=None,
    )

    # ç”Ÿæˆ A2UI
    a2ui = _script_to_a2ui(scene_type, script, template, task_id)

    logger.info(
        "script generated",
        extra={"operation": "script_generate", "user_id": int(user_id), "scene_type": scene_type},
    )

    return {
        "scene_type": scene_type,
        "script": script,
        "structure": template["structure"],
        "tips": _get_script_tips(scene_type, tone),
        "task_id": task_id,
        "a2ui": a2ui,
    }


def _generate_custom_script(
    scene_type: str,
    context: str,
    target_person: str,
    tone: str,
    template: Dict[str, Any],
) -> str:
    """ç”Ÿæˆå®šåˆ¶è¯æœ¯"""
    structure = template["structure"]

    # ç®€å•çš„ä¸Šä¸‹æ–‡æ›¿æ¢ï¼ˆç”Ÿäº§ç¯å¢ƒå¯æ¥å…¥ LLMï¼‰
    if context:
        # åŸºäºåœºæ™¯ç”Ÿæˆè¯æœ¯éª¨æ¶
        if scene_type == "æ²Ÿé€š":
            return f"æˆ‘æ³¨æ„åˆ°{context}ã€‚æˆ‘æƒ³å’Œ{target_person}è°ˆè°ˆè¿™ä»¶äº‹ã€‚æˆ‘å¸Œæœ›æˆ‘ä»¬èƒ½æ‰¾åˆ°ä¸€ä¸ªåŒæ–¹éƒ½æ»¡æ„çš„æ–¹å¼ã€‚ä½ æ„¿æ„èŠèŠå—ï¼Ÿ"
        elif scene_type == "è¾¹ç•Œ":
            return f"å…³äº{context}ï¼Œæˆ‘éœ€è¦æ˜ç¡®ä¸€ä¸‹æˆ‘çš„è¾¹ç•Œã€‚æˆ‘ç†è§£{target_person}çš„éœ€æ±‚ï¼ŒåŒæ—¶æˆ‘ä¹Ÿéœ€è¦ä¿æŠ¤è‡ªå·±çš„æ—¶é—´/ç²¾åŠ›ã€‚æˆ‘èƒ½æ¥å—çš„èŒƒå›´æ˜¯â€¦"
        elif scene_type == "æ‹’ç»":
            return f"è°¢è°¢{target_person}æƒ³åˆ°æˆ‘ã€‚å…³äº{context}ï¼Œè¿™æ¬¡æˆ‘æ²¡åŠæ³•ç­”åº”ã€‚ä¸æ˜¯å› ä¸ºæˆ‘ä¸é‡è§†ï¼Œè€Œæ˜¯æˆ‘éœ€è¦ä¼˜å…ˆå¤„ç†å…¶ä»–äº‹æƒ…ã€‚å¸Œæœ›ä½ èƒ½ç†è§£ã€‚"
        elif scene_type == "è°ˆåˆ¤":
            return f"å…³äº{context}ï¼Œæˆ‘ç†è§£{target_person}çš„è€ƒé‡ã€‚æˆ‘çš„æœŸæœ›æ˜¯â€¦æˆ‘ä»¬èƒ½å¦ä¸€èµ·æ¢è®¨ä¸€ä¸ªåŒèµ¢çš„æ–¹æ¡ˆï¼Ÿ"
        elif scene_type == "é“æ­‰":
            return f"å…³äº{context}ï¼Œæˆ‘éœ€è¦å‘{target_person}é“æ­‰ã€‚æˆ‘çš„è¡Œä¸ºå¯èƒ½è®©ä½ æ„Ÿåˆ°â€¦æˆ‘ä¼šâ€¦æ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚"
        elif scene_type == "è¯·æ±‚":
            return f"å…³äº{context}ï¼Œæˆ‘éœ€è¦{target_person}çš„å¸®åŠ©ã€‚ä½ èƒ½å¦â€¦è¿™å¯¹æˆ‘æ¥è¯´å¾ˆé‡è¦ã€‚"

    return template["example"]


def _get_script_tips(scene_type: str, tone: str) -> List[str]:
    """è·å–è¯æœ¯ä½¿ç”¨æç¤º"""
    tips = {
        "æ²Ÿé€š": [
            "é€‰æ‹©åŒæ–¹éƒ½æ”¾æ¾çš„æ—¶æœº",
            "é¿å…åœ¨æƒ…ç»ªæ¿€åŠ¨æ—¶å¼€å£",
            "å…ˆå¬å†è¯´ï¼Œç¡®è®¤ç†è§£",
        ],
        "è¾¹ç•Œ": [
            "è¾¹ç•Œæ˜¯ä¿æŠ¤å…³ç³»ï¼Œä¸æ˜¯æ‹’ç»å…³ç³»",
            "ç”¨ã€Œæˆ‘éœ€è¦ã€ä»£æ›¿ã€Œä½ ä¸èƒ½ã€",
            "ä¿æŒè¯­æ°”å¹³å’Œä½†ç«‹åœºåšå®š",
        ],
        "æ‹’ç»": [
            "ä¸éœ€è¦è¿‡åº¦è§£é‡ŠåŸå› ",
            "æ„Ÿè°¢å¯¹æ–¹çš„ä¿¡ä»»æ˜¯çœŸè¯šçš„",
            "æä¾›æ›¿ä»£æ–¹æ¡ˆå¯ä»¥è½¯åŒ–æ‹’ç»",
        ],
        "è°ˆåˆ¤": [
            "å…ˆç†è§£å¯¹æ–¹ç«‹åœºå†è¡¨è¾¾è‡ªå·±",
            "å…³æ³¨åˆ©ç›Šè€Œéç«‹åœº",
            "å‡†å¤‡å¥½ä½ çš„BATNAï¼ˆæœ€ä½³æ›¿ä»£æ–¹æ¡ˆï¼‰",
        ],
        "é“æ­‰": [
            "æ‰¿è®¤é”™è¯¯ï¼Œä¸æ‰¾å€Ÿå£",
            "è¡¨è¾¾ä½ ç†è§£å¯¹æ–¹çš„æ„Ÿå—",
            "æå‡ºå…·ä½“çš„å¼¥è¡¥æªæ–½",
        ],
        "è¯·æ±‚": [
            "æ˜ç¡®è¯´æ˜éœ€è¦ä»€ä¹ˆå¸®åŠ©",
            "å‘ŠçŸ¥å¯¹æ–¹è¿™å¯¹ä½ çš„æ„ä¹‰",
            "ç»™å¯¹æ–¹æ‹’ç»çš„ç©ºé—´",
        ],
    }

    base_tips = tips.get(scene_type, tips["æ²Ÿé€š"])

    # æ ¹æ®è¯­æ°”æ·»åŠ é¢å¤–æç¤º
    if tone == "åšå®š":
        base_tips.append("ä¿æŒçœ¼ç¥æ¥è§¦ï¼Œè¯­é€Ÿé€‚ä¸­")
    elif tone == "æ¸©æŸ”":
        base_tips.append("æ”¾æ…¢è¯­é€Ÿï¼Œä½¿ç”¨æ›´å¤šã€Œæˆ‘ä»¬ã€")
    elif tone == "æ­£å¼":
        base_tips.append("ä½¿ç”¨æ•¬è¯­ï¼Œä¿æŒä¸“ä¸šè·ç¦»")

    return base_tips


def _script_to_a2ui(
    scene_type: str,
    script: str,
    template: Dict[str, Any],
    task_id: str,
) -> Dict[str, Any]:
    """å°†è¯æœ¯è½¬æ¢ä¸º A2UI æ ¼å¼"""
    lines = []
    lines.append(f"## {scene_type}è¯æœ¯")
    lines.append("")
    lines.append(f"*{template['intro']}*")
    lines.append("")
    lines.append("### ç»“æ„æ¨¡æ¿")
    for i, s in enumerate(template["structure"], 1):
        lines.append(f"{i}. {s}")
    lines.append("")
    lines.append("### ä½ çš„è¯æœ¯")
    lines.append(f"> {script}")
    lines.append("")
    lines.append("### ä½¿ç”¨æç¤º")
    lines.append("- å…ˆåœ¨å¿ƒé‡Œé»˜å¿µä¸€é")
    lines.append("- å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´")
    lines.append("- å…³æ³¨å¯¹æ–¹çš„ååº”å¹¶çµæ´»åº”å¯¹")

    return {
        "meta": {"summary": f"{scene_type}è¯æœ¯"},
        "ui_components": [
            {"type": "markdown_text", "title": f"{scene_type}è¯æœ¯", "data": "\n".join(lines)},
            {
                "type": "action_buttons",
                "title": "ä¸‹ä¸€æ­¥",
                "data": [
                    {"label": "å¤åˆ¶è¯æœ¯", "action": {"type": "copy_text", "text": script}},
                    {"label": "ç»ƒä¹ ä¸€ä¸‹", "action": {"type": "start_task", "task_id": task_id}},
                    {"label": "æ¢ä¸ªåœºæ™¯", "action": {"type": "regenerate"}},
                ],
            },
        ],
    }

