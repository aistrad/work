"use client"

import { cn } from "@/lib/utils"
import { useAppStore } from "@/stores/app-store"
import { useEffect } from "react"
import { Loader2, Play, Check, Clock, X, Calendar } from "lucide-react"

export function QuestsTab() {
  const {
    activeTasks,
    suggestedTasks,
    completedTasks,
    isLoading,
    loadingTab,
    fetchTasks,
    acceptTask,
    completeTask,
    skipTask,
  } = useAppStore()

  useEffect(() => {
    fetchTasks()
  }, [fetchTasks])

  const isTabLoading = isLoading && loadingTab === 'quests'

  if (isTabLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
      </div>
    )
  }

  const totalTasks = activeTasks.length + suggestedTasks.length + completedTasks.length

  return (
    <div className="p-4 space-y-4">
      {/* 今日进度 */}
      <div className="p-4 rounded-lg bg-sidebar">
        <div className="flex items-center justify-between mb-2">
          <span className="text-sm text-muted-foreground">今日进度</span>
          <span className="text-sm font-medium">
            {completedTasks.length}/{totalTasks || 1}
          </span>
        </div>
        <div className="h-2 bg-hover rounded-full overflow-hidden">
          <div
            className="h-full bg-status-foreground rounded-full transition-all duration-500"
            style={{
              width: `${totalTasks > 0 ? (completedTasks.length / totalTasks) * 100 : 0}%`,
            }}
          />
        </div>
      </div>

      {/* 进行中的任务 */}
      <TaskSection
        title="进行中"
        tasks={activeTasks}
        onComplete={completeTask}
        onSkip={skipTask}
        emptyMessage="没有进行中的任务"
        showCompleteButton
      />

      {/* 建议任务 */}
      <TaskSection
        title="建议任务"
        tasks={suggestedTasks}
        onAccept={acceptTask}
        emptyMessage="暂无新任务建议"
        showAcceptButton
      />

      {/* 最近完成 */}
      <TaskSection
        title="最近完成"
        tasks={completedTasks}
        emptyMessage="暂无完成记录"
        isCompleted
      />
    </div>
  )
}

function TaskSection({
  title,
  tasks,
  onAccept,
  onComplete,
  onSkip,
  emptyMessage,
  showAcceptButton,
  showCompleteButton,
  isCompleted,
}: {
  title: string
  tasks: {
    task_id: string
    title: string
    status: string
    commitment_type?: string
    minutes?: number
    if_then?: string
  }[]
  onAccept?: (taskId: string, type?: 'start_task' | 'schedule_task') => void
  onComplete?: (taskId: string, note?: string) => void
  onSkip?: (taskId: string, reason?: string) => void
  emptyMessage: string
  showAcceptButton?: boolean
  showCompleteButton?: boolean
  isCompleted?: boolean
}) {
  return (
    <div className="space-y-2">
      <h3 className="text-sm font-medium text-muted-foreground uppercase tracking-wide">
        {title} ({tasks.length})
      </h3>

      {tasks.length === 0 ? (
        <div className="p-4 rounded-lg bg-sidebar">
          <p className="text-sm text-muted-foreground">{emptyMessage}</p>
        </div>
      ) : (
        <div className="space-y-2">
          {tasks.map((task) => (
            <TaskCard
              key={task.task_id}
              task={task}
              onAccept={onAccept}
              onComplete={onComplete}
              onSkip={onSkip}
              showAcceptButton={showAcceptButton}
              showCompleteButton={showCompleteButton}
              isCompleted={isCompleted}
            />
          ))}
        </div>
      )}
    </div>
  )
}

function TaskCard({
  task,
  onAccept,
  onComplete,
  onSkip,
  showAcceptButton,
  showCompleteButton,
  isCompleted,
}: {
  task: {
    task_id: string
    title: string
    status: string
    commitment_type?: string
    minutes?: number
    if_then?: string
  }
  onAccept?: (taskId: string, type?: 'start_task' | 'schedule_task') => void
  onComplete?: (taskId: string, note?: string) => void
  onSkip?: (taskId: string, reason?: string) => void
  showAcceptButton?: boolean
  showCompleteButton?: boolean
  isCompleted?: boolean
}) {
  return (
    <div
      className={cn(
        "p-4 rounded-lg bg-sidebar",
        "border border-transparent hover:border-border transition-colors",
        isCompleted && "opacity-60"
      )}
    >
      <div className="flex items-start gap-3">
        {/* Status Icon */}
        <div className="flex-shrink-0 mt-0.5">
          {isCompleted ? (
            <div className="w-5 h-5 rounded-full bg-status flex items-center justify-center">
              <Check className="w-3 h-3 text-status-foreground" />
            </div>
          ) : task.status === 'active' ? (
            <div className="w-5 h-5 rounded-full border-2 border-status-foreground" />
          ) : (
            <div className="w-5 h-5 rounded-full border-2 border-muted-foreground" />
          )}
        </div>

        {/* Content */}
        <div className="flex-1 min-w-0">
          <p className={cn(
            "text-sm text-foreground",
            isCompleted && "line-through"
          )}>
            {task.title}
          </p>

          {/* Metadata */}
          <div className="flex items-center gap-3 mt-1">
            {task.minutes && (
              <span className="flex items-center gap-1 text-xs text-muted-foreground">
                <Clock className="w-3 h-3" />
                {task.minutes}分钟
              </span>
            )}
            {task.commitment_type && (
              <span className={cn(
                "text-xs px-1.5 py-0.5 rounded",
                task.commitment_type === 'start_task' && "bg-status/20 text-status-foreground",
                task.commitment_type === 'schedule_task' && "bg-advice/20 text-advice-foreground"
              )}>
                {task.commitment_type === 'start_task' ? '立即开始' : '已计划'}
              </span>
            )}
          </div>

          {/* If-Then */}
          {task.if_then && (
            <p className="text-xs text-muted-foreground mt-2 italic">
              {task.if_then}
            </p>
          )}
        </div>

        {/* Actions */}
        <div className="flex items-center gap-1">
          {showAcceptButton && onAccept && (
            <>
              <button
                onClick={() => onAccept(task.task_id, 'start_task')}
                className="p-2 rounded-lg hover:bg-status/20 text-status-foreground transition-colors"
                title="立即开始"
              >
                <Play className="w-4 h-4" />
              </button>
              <button
                onClick={() => onAccept(task.task_id, 'schedule_task')}
                className="p-2 rounded-lg hover:bg-advice/20 text-advice-foreground transition-colors"
                title="加入计划"
              >
                <Calendar className="w-4 h-4" />
              </button>
            </>
          )}

          {showCompleteButton && onComplete && (
            <button
              onClick={() => onComplete(task.task_id)}
              className="p-2 rounded-lg hover:bg-status/20 text-status-foreground transition-colors"
              title="完成"
            >
              <Check className="w-4 h-4" />
            </button>
          )}

          {showCompleteButton && onSkip && (
            <button
              onClick={() => onSkip(task.task_id)}
              className="p-2 rounded-lg hover:bg-alert/20 text-alert-foreground transition-colors"
              title="跳过"
            >
              <X className="w-4 h-4" />
            </button>
          )}
        </div>
      </div>
    </div>
  )
}
