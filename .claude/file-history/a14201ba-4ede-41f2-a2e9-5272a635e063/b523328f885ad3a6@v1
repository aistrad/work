"use client"

import { cn } from "@/lib/utils"
import { useAppStore } from "@/stores/app-store"
import { useEffect } from "react"
import { Loader2, Brain, Sparkles, Target } from "lucide-react"

export function StatusTab() {
  const {
    l0Facts,
    l1Schema,
    stateScore,
    isLoading,
    loadingTab,
    fetchStatus,
  } = useAppStore()

  useEffect(() => {
    fetchStatus()
  }, [fetchStatus])

  const isTabLoading = isLoading && loadingTab === 'status'

  if (isTabLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <Loader2 className="w-6 h-6 animate-spin text-muted-foreground" />
      </div>
    )
  }

  return (
    <div className="p-4 space-y-4">
      {/* L0 Facts - å…«å­—äº‹å® */}
      <L0FactsCard facts={l0Facts} />

      {/* L1 Schema - PERMA + è®¤çŸ¥å›¾å¼ */}
      <L1SchemaCard schema={l1Schema} />

      {/* State Score è¯¦æƒ… */}
      <StateScoreCard stateScore={stateScore} />
    </div>
  )
}

function L0FactsCard({
  facts,
}: {
  facts: {
    dayMaster: string
    strength: string
    translations: { concept: string; translation: string; action: string }[]
  } | null
}) {
  if (!facts) {
    return (
      <div className="p-4 rounded-lg bg-sidebar">
        <div className="flex items-center gap-2 mb-3">
          <Sparkles className="w-4 h-4 text-mystic-foreground" />
          <h3 className="font-medium text-foreground">å…ˆå¤©ç‰¹è´¨ (L0)</h3>
        </div>
        <p className="text-sm text-muted-foreground">
          å°šæœªå½•å…¥å…«å­—ä¿¡æ¯ï¼Œè¯·å…ˆå®Œæˆä¸ªäººèµ„æ–™ã€‚
        </p>
      </div>
    )
  }

  return (
    <div className="p-4 rounded-lg bg-sidebar">
      <div className="flex items-center gap-2 mb-3">
        <Sparkles className="w-4 h-4 text-mystic-foreground" />
        <h3 className="font-medium text-foreground">å…ˆå¤©ç‰¹è´¨ (L0)</h3>
      </div>

      {/* æ—¥ä¸»ä¿¡æ¯ */}
      <div className="flex items-center gap-4 mb-4 p-3 bg-mystic/20 rounded-lg">
        <div>
          <span className="text-xs text-muted-foreground">æ—¥ä¸»</span>
          <p className="text-lg font-semibold text-foreground">{facts.dayMaster}</p>
        </div>
        <div>
          <span className="text-xs text-muted-foreground">å¼ºå¼±</span>
          <p className="text-lg font-semibold text-foreground">{facts.strength}</p>
        </div>
      </div>

      {/* å¿ƒç†å­¦ç¿»è¯‘ */}
      <div className="space-y-3">
        <h4 className="text-xs text-muted-foreground uppercase tracking-wide">å¿ƒç†å­¦è§£è¯»</h4>
        {facts.translations.map((t, i) => (
          <div key={i} className="p-3 bg-background rounded-lg border border-border">
            <div className="flex items-start gap-2">
              <span className="text-xs bg-mystic/30 text-mystic-foreground px-1.5 py-0.5 rounded">
                {t.concept}
              </span>
            </div>
            <p className="text-sm text-foreground mt-2">{t.translation}</p>
            <p className="text-xs text-muted-foreground mt-1">
              <span className="text-advice-foreground">â†’</span> {t.action}
            </p>
          </div>
        ))}
      </div>
    </div>
  )
}

function L1SchemaCard({
  schema,
}: {
  schema: {
    permaSnapshot: {
      positiveEmotion: { score: number; trend?: string }
      engagement: { score: number; trend?: string }
      relationships: { score: number; trend?: string }
      meaning: { score: number; trend?: string }
      accomplishment: { score: number; trend?: string }
    }
    cognitivePatterns: { identifiedSchemas: string[]; reframeCount?: number }
    strengthsInUse: string[]
  } | null
}) {
  if (!schema) {
    return (
      <div className="p-4 rounded-lg bg-sidebar">
        <div className="flex items-center gap-2 mb-3">
          <Brain className="w-4 h-4 text-advice-foreground" />
          <h3 className="font-medium text-foreground">å¿ƒç†å›¾å¼ (L1)</h3>
        </div>
        <p className="text-sm text-muted-foreground">æ•°æ®åŠ è½½ä¸­...</p>
      </div>
    )
  }

  const perma = schema.permaSnapshot

  return (
    <div className="p-4 rounded-lg bg-sidebar">
      <div className="flex items-center gap-2 mb-3">
        <Brain className="w-4 h-4 text-advice-foreground" />
        <h3 className="font-medium text-foreground">å¿ƒç†å›¾å¼ (L1)</h3>
      </div>

      {/* PERMA è¯¦æƒ… */}
      <div className="grid grid-cols-5 gap-2 mb-4">
        {[
          { key: "P", label: "ç§¯ææƒ…ç»ª", data: perma.positiveEmotion },
          { key: "E", label: "æŠ•å…¥", data: perma.engagement },
          { key: "R", label: "å…³ç³»", data: perma.relationships },
          { key: "M", label: "æ„ä¹‰", data: perma.meaning },
          { key: "A", label: "æˆå°±", data: perma.accomplishment },
        ].map((item) => (
          <div key={item.key} className="text-center p-2 bg-background rounded-lg">
            <span className="text-xs text-muted-foreground">{item.key}</span>
            <p className="text-lg font-semibold text-foreground">
              {item.data.score.toFixed(1)}
            </p>
            {item.data.trend && (
              <span className={cn(
                "text-xs",
                item.data.trend === 'up' && "text-status-foreground",
                item.data.trend === 'down' && "text-alert-foreground",
                item.data.trend === 'stable' && "text-muted-foreground"
              )}>
                {item.data.trend === 'up' ? 'â†‘' : item.data.trend === 'down' ? 'â†“' : 'â†’'}
              </span>
            )}
          </div>
        ))}
      </div>

      {/* è®¤çŸ¥å›¾å¼ */}
      {schema.cognitivePatterns.identifiedSchemas.length > 0 && (
        <div className="mb-4">
          <h4 className="text-xs text-muted-foreground uppercase tracking-wide mb-2">
            è¯†åˆ«åˆ°çš„è®¤çŸ¥æ¨¡å¼
          </h4>
          <div className="flex flex-wrap gap-2">
            {schema.cognitivePatterns.identifiedSchemas.map((s, i) => (
              <span
                key={i}
                className="text-xs bg-alert/20 text-alert-foreground px-2 py-1 rounded"
              >
                {s}
              </span>
            ))}
          </div>
          {schema.cognitivePatterns.reframeCount !== undefined && (
            <p className="text-xs text-muted-foreground mt-2">
              å·²å®Œæˆ {schema.cognitivePatterns.reframeCount} æ¬¡è®¤çŸ¥é‡æ„
            </p>
          )}
        </div>
      )}

      {/* ä½¿ç”¨ä¸­çš„ä¼˜åŠ¿ */}
      {schema.strengthsInUse.length > 0 && (
        <div>
          <h4 className="text-xs text-muted-foreground uppercase tracking-wide mb-2">
            æ´»è·ƒä¼˜åŠ¿
          </h4>
          <div className="flex flex-wrap gap-2">
            {schema.strengthsInUse.map((s, i) => (
              <span
                key={i}
                className="text-xs bg-status/20 text-status-foreground px-2 py-1 rounded"
              >
                {s}
              </span>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

function StateScoreCard({
  stateScore,
}: {
  stateScore: {
    score: number
    breakdown: { emotion: number; action: number; streak: number }
    recoveryAction: string | null
  }
}) {
  const { emotion, action, streak } = stateScore.breakdown

  return (
    <div className="p-4 rounded-lg bg-sidebar">
      <div className="flex items-center gap-2 mb-3">
        <Target className="w-4 h-4 text-status-foreground" />
        <h3 className="font-medium text-foreground">çŠ¶æ€åˆ†æ•°è¯¦æƒ…</h3>
      </div>

      {/* æ€»åˆ† */}
      <div className="flex items-center justify-center mb-4">
        <div className="relative w-24 h-24">
          <svg className="w-full h-full transform -rotate-90">
            <circle
              cx="48"
              cy="48"
              r="40"
              fill="none"
              stroke="currentColor"
              strokeWidth="8"
              className="text-hover"
            />
            <circle
              cx="48"
              cy="48"
              r="40"
              fill="none"
              stroke="currentColor"
              strokeWidth="8"
              strokeDasharray={`${(stateScore.score / 100) * 251.2} 251.2`}
              className="text-status-foreground"
            />
          </svg>
          <div className="absolute inset-0 flex items-center justify-center">
            <span className="text-2xl font-bold text-foreground">{stateScore.score}</span>
          </div>
        </div>
      </div>

      {/* ä¸‰ä¿¡å·åˆ†è§£ */}
      <div className="space-y-2">
        <div className="flex items-center justify-between">
          <span className="text-sm text-muted-foreground">æƒ…ç»ªä¿¡å· (40%)</span>
          <span className="text-sm font-medium text-foreground">{emotion}/40</span>
        </div>
        <div className="h-1.5 bg-hover rounded-full overflow-hidden">
          <div
            className="h-full bg-advice-foreground rounded-full"
            style={{ width: `${(emotion / 40) * 100}%` }}
          />
        </div>

        <div className="flex items-center justify-between">
          <span className="text-sm text-muted-foreground">è¡ŒåŠ¨ä¿¡å· (40%)</span>
          <span className="text-sm font-medium text-foreground">{action}/40</span>
        </div>
        <div className="h-1.5 bg-hover rounded-full overflow-hidden">
          <div
            className="h-full bg-status-foreground rounded-full"
            style={{ width: `${(action / 40) * 100}%` }}
          />
        </div>

        <div className="flex items-center justify-between">
          <span className="text-sm text-muted-foreground">è¿ç»­ä¿¡å· (20%)</span>
          <span className="text-sm font-medium text-foreground">{streak}/20</span>
        </div>
        <div className="h-1.5 bg-hover rounded-full overflow-hidden">
          <div
            className="h-full bg-mystic-foreground rounded-full"
            style={{ width: `${(streak / 20) * 100}%` }}
          />
        </div>
      </div>

      {/* è¡¥æ•‘åŠ¨ä½œ */}
      {stateScore.recoveryAction && (
        <div className="mt-4 p-3 bg-advice/20 rounded-lg">
          <p className="text-sm text-foreground">
            <span className="text-advice-foreground">ğŸ’¡</span> {stateScore.recoveryAction}
          </p>
        </div>
      )}
    </div>
  )
}
