"use client"

import { useState, useEffect } from "react"
import { cn } from "@/lib/utils"
import { X, Heart } from "lucide-react"
import { submitCheckin } from "@/lib/api"

// æƒ…ç»ªé€‰é¡¹
const MOOD_OPTIONS = [
  { value: "å¹³é™", label: "å¹³é™", emoji: "ğŸ˜Œ", category: "positive" },
  { value: "å¼€å¿ƒ", label: "å¼€å¿ƒ", emoji: "ğŸ˜Š", category: "positive" },
  { value: "æ»¡è¶³", label: "æ»¡è¶³", emoji: "ğŸ˜Š", category: "positive" },
  { value: "æ„Ÿæ©", label: "æ„Ÿæ©", emoji: "ğŸ™", category: "positive" },
  { value: "å…´å¥‹", label: "å…´å¥‹", emoji: "ğŸ¤©", category: "positive" },
  { value: "ç„¦è™‘", label: "ç„¦è™‘", emoji: "ğŸ˜°", category: "negative" },
  { value: "æ„¤æ€’", label: "æ„¤æ€’", emoji: "ğŸ˜ ", category: "negative" },
  { value: "æ²®ä¸§", label: "æ²®ä¸§", emoji: "ğŸ˜”", category: "negative" },
  { value: "æ‚²ä¼¤", label: "æ‚²ä¼¤", emoji: "ğŸ˜¢", category: "negative" },
  { value: "ææƒ§", label: "ææƒ§", emoji: "ğŸ˜¨", category: "negative" },
] as const

interface CheckinModalProps {
  isOpen: boolean
  onClose: () => void
  onSuccess?: () => void
}

export function CheckinModal({ isOpen, onClose, onSuccess }: CheckinModalProps) {
  const [mood, setMood] = useState<string>("")
  const [intensity, setIntensity] = useState(5)
  const [note, setNote] = useState("")
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [error, setError] = useState<string | null>(null)

  // Reset state when modal opens
  useEffect(() => {
    if (isOpen) {
      setMood("")
      setIntensity(5)
      setNote("")
      setError(null)
    }
  }, [isOpen])

  // Handle ESC key
  useEffect(() => {
    const handleEsc = (e: KeyboardEvent) => {
      if (e.key === "Escape" && isOpen) {
        onClose()
      }
    }
    window.addEventListener("keydown", handleEsc)
    return () => window.removeEventListener("keydown", handleEsc)
  }, [isOpen, onClose])

  const handleSubmit = async () => {
    if (!mood) {
      setError("è¯·é€‰æ‹©ä¸€ä¸ªæƒ…ç»ª")
      return
    }

    setIsSubmitting(true)
    setError(null)

    try {
      await submitCheckin(mood, intensity, note.trim())

      // Success
      if (onSuccess) {
        onSuccess()
      }
      onClose()
    } catch (e) {
      setError(e instanceof Error ? e.message : "æ‰“å¡å¤±è´¥")
    } finally {
      setIsSubmitting(false)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div
        className="absolute inset-0 bg-black/50 backdrop-blur-sm"
        onClick={onClose}
      />

      {/* Modal */}
      <div className="relative bg-background rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
        {/* Header */}
        <div className="flex items-center justify-between px-6 py-4 border-b border-border">
          <div className="flex items-center gap-2">
            <Heart className="w-5 h-5 text-primary" />
            <h2 className="text-lg font-semibold text-foreground">æƒ…ç»ªæ‰“å¡</h2>
          </div>
          <button
            onClick={onClose}
            className="p-1 rounded-lg hover:bg-hover transition-colors"
          >
            <X className="w-5 h-5 text-muted-foreground" />
          </button>
        </div>

        {/* Content */}
        <div className="px-6 py-6 space-y-6">
          {/* Mood Selection */}
          <div className="space-y-3">
            <label className="text-sm font-medium text-foreground">
              ç°åœ¨æ„Ÿè§‰å¦‚ä½•ï¼Ÿ
            </label>
            <div className="grid grid-cols-5 gap-2">
              {MOOD_OPTIONS.map((option) => (
                <button
                  key={option.value}
                  onClick={() => setMood(option.value)}
                  className={cn(
                    "flex flex-col items-center gap-1 p-3 rounded-xl",
                    "transition-all duration-200",
                    mood === option.value
                      ? option.category === "positive"
                        ? "bg-green-100 dark:bg-green-900/30 ring-2 ring-green-500"
                        : "bg-red-100 dark:bg-red-900/30 ring-2 ring-red-500"
                      : "bg-hover hover:bg-muted"
                  )}
                >
                  <span className="text-2xl">{option.emoji}</span>
                  <span className="text-xs text-muted-foreground">
                    {option.label}
                  </span>
                </button>
              ))}
            </div>
          </div>

          {/* Intensity Slider */}
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <label className="text-sm font-medium text-foreground">
                å¼ºåº¦ï¼ˆ1-10ï¼‰
              </label>
              <span className="text-lg font-bold text-primary">{intensity}</span>
            </div>
            <input
              type="range"
              min="1"
              max="10"
              value={intensity}
              onChange={(e) => setIntensity(Number(e.target.value))}
              className="w-full h-2 bg-muted rounded-lg appearance-none cursor-pointer accent-primary"
            />
            <div className="flex justify-between text-xs text-muted-foreground">
              <span>è½»å¾®</span>
              <span>ä¸­ç­‰</span>
              <span>å¼ºçƒˆ</span>
            </div>
          </div>

          {/* Note Input */}
          <div className="space-y-2">
            <label className="text-sm font-medium text-foreground">
              å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰
            </label>
            <textarea
              value={note}
              onChange={(e) => setNote(e.target.value)}
              placeholder="å†™ä¸€å¥è¯æè¿°å½“å‰çŠ¶æ€..."
              className={cn(
                "w-full px-4 py-3 rounded-xl resize-none",
                "bg-muted border border-border",
                "text-foreground placeholder:text-muted-foreground",
                "focus:outline-none focus:ring-2 focus:ring-primary/50"
              )}
              rows={2}
              maxLength={200}
            />
          </div>

          {/* Error Message */}
          {error && (
            <div className="text-sm text-red-500 text-center">{error}</div>
          )}
        </div>

        {/* Footer */}
        <div className="px-6 py-4 border-t border-border bg-muted/30">
          <button
            onClick={handleSubmit}
            disabled={isSubmitting || !mood}
            className={cn(
              "w-full py-3 rounded-xl font-medium",
              "transition-all duration-200",
              mood && !isSubmitting
                ? "bg-primary text-primary-foreground hover:bg-primary/90"
                : "bg-muted text-muted-foreground cursor-not-allowed"
            )}
          >
            {isSubmitting ? "æäº¤ä¸­..." : "å®Œæˆæ‰“å¡"}
          </button>
        </div>
      </div>
    </div>
  )
}
