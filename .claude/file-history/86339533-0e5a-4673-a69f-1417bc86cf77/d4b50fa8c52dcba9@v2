# Fortune AI 术语表 (Glossary) - SSOT

**版本**: v3.1
**更新日期**: 2026-01-01
**用途**: 统一命名、入口、类型定义，消除文档间歧义
**关联文档**: system_design_v3.md, frontend_v3.md, modul_core_v3.md, os_design_v3.md

---

## 1. 入口与路由

| 名称 | 路径 | 端口 | 说明 |
|------|------|------|------|
| **前端入口** | `/new` | 8231 | Next.js App Router，`basePath="/new"` |
| **旧前端** | `/main`, `/login`, `/register` | 8230 | 307 重定向到 `/new*` |
| **API 网关** | `/api/*` | 8230 | FastAPI，统一 RESTful |
| **SSE 流式** | `/api/chat/stream` | 8230 | Server-Sent Events |

### 反向代理配置 (推荐)

```nginx
server {
    listen 80;

    location /new {
        proxy_pass http://127.0.0.1:8231;
    }

    location /api {
        proxy_pass http://127.0.0.1:8230;
        proxy_http_version 1.1;
        proxy_set_header Connection "";  # SSE 需要
    }
}
```

---

## 2. Cookie 与认证

| Cookie 名称 | HttpOnly | 用途 | 有效期 |
|-------------|----------|------|--------|
| `fortune_session` | ✓ | 会话令牌 (sha256 存储) | 30 天 |
| `fortune_csrf` | ✗ | CSRF 令牌 | 30 天 |

### CSRF 校验规则

- **触发**: 所有 `POST`, `PUT`, `DELETE` 请求
- **Header**: `X-CSRF-Token: <fortune_csrf cookie 值>`
- **后端校验**: `sha256(header) == fortune_user_session.csrf_token_hash`

---

## 3. 前端 Zone 布局

| Zone | 位置 | 内容 | 组件路径 |
|------|------|------|----------|
| **Zone A** | 左侧 | 对话线程 (Chat Thread) | `components/chat/` |
| **Zone B** | 右侧 | Dashboard Tabs | `components/dashboard/` |

### Dashboard Tab 列表

| Tab ID | 名称 | 端点 | 状态 |
|--------|------|------|------|
| `overview` | 今日概览 | `/api/dashboard/overview` | ✓ 已实现 |
| `status` | 五维状态 | `/api/dashboard/status` | ✓ 已实现 |
| `trends` | 趋势/K线 | `/api/dashboard/trends`, `/api/dashboard/kline` | ✓ 已实现 |
| `quests` | 任务列表 | `/api/dashboard/tasks` | ✓ 已实现 |
| `relations` | 关系图谱 | `/api/dashboard/relations` | ✓ 已实现 |
| `explore` | 探索/课程 | `/api/dashboard/explore` | ✓ 已实现 |
| `settings` | 设置 | `/api/user/preferences` | ○ 部分实现 |

---

## 4. A2UI 组件类型

| type | 用途 | data 结构 | 必需字段 |
|------|------|-----------|----------|
| `markdown_text` | 富文本内容 | `string` (Markdown) | `title?`, `data` |
| `action_buttons` | 操作按钮组 | `ActionButton[]` | `data` |
| `callout` | 高亮提示 | `string` | `content` |
| `toggle` | 折叠详情 | `Block[]` | `content`, `children` |
| `task` | 任务项 | - | `content`, `duration` |
| `diff` | 变更预览 | `DiffChange[]` | `changes`, `status` |
| `chart` | 图表 | Chart data | `chartType`, `data` |

### ActionButton.action.type 枚举

| type | 用途 | 必需参数 | 调用端点 |
|------|------|----------|----------|
| `start_task` | 立即开始任务 | `task_id` | `POST /api/dashboard/task/accept` |
| `schedule_task` | 加入计划 | `task_id` | `POST /api/dashboard/task/accept` |
| `open_panel` | 打开面板/Tab | `panel` | 前端事件 `switchTab` |
| `opt_out` | 暂不执行 | - | 前端记录 |
| `checkin` | 情绪打卡 | - | 前端事件 `openCheckin` |

---

## 5. 承诺 (Commitment) 状态机

```
suggested ──► active ──► done
    │            │
    │            └──► skipped
    │
    └──► canceled
```

| 状态 | 含义 | 触发 |
|------|------|------|
| `suggested` | AI 建议，待用户确认 | Chat/Bento 生成 |
| `active` | 用户已接受，进行中 | `task/accept` |
| `done` | 已完成 | `task/done` |
| `skipped` | 用户跳过 | `task/skip` |
| `canceled` | 系统取消 | 超时/清理 |

---

## 6. 外部任务 (Report/Poster) 状态

| 状态 | 含义 | 前端行为 |
|------|------|----------|
| `queued` | 已提交，排队中 | 显示 spinner |
| `processing` | 执行中 | 轮询 (3s 间隔) |
| `completed` | 成功 | 显示结果 |
| `error` | 失败 | 显示错误 + 重试按钮 |

---

## 7. Soul OS Context Driven 架构 (v3.1)

> **规范文档**: [os_design_v3.md §1.4](os/os_design_v3.md#14-context-驱动架构-可插拔模块视图)

| 层级 | 名称 | 可插拔 | 职责 | 产出 |
|------|------|:------:|------|------|
| **L0** | Base Data | ✗ | 用户基础档案 (不可插拔地基) | `user_profile`, `session` |
| **L1** | Module Data | ✓ | 可插拔数据层 (八字/紫微/PERMA等) | `facts`, `facts_hash`, `perma`, `state_score` |
| **L2** | Expert Agents | ✓ | 双分支专家模块 (Style + Expert) | `kb_refs`, `rule_ids`, `tone` |
| **Context Mgmt** | 上下文组装 | - | 组装 L0-L2 数据，选择模型路由 | `full_context` |
| **Interaction** | 模型交互 | ✓ | 多模型 (GLM/Gemini/GPT-4o/Claude) | `A2UI`, `Guidance Card` |

### 旧术语映射 (Legacy → v3.1)

| 旧术语 | 新架构层级 |
|--------|------------|
| 数学脑 (L0 Firmware) | L0 Base + L1 Module |
| 心理脑 (L1 Schema) | L1 Module Data |
| 知识脑 (L2 Agents) | L2 Expert Agents |
| 语言脑 (L3 Synthesis) | Context Mgmt + Interaction Layer |

---

## 8. 数据库表清单 (SSOT)

### 核心业务表

| 表名 | 用途 | 迁移文件 | 状态 |
|------|------|----------|------|
| `fortune_user` | 用户主表 | 20251216_fortune_user.sql | ✓ |
| `fortune_user_session` | 会话令牌 | 20251229_final_mvp.sql | ✓ |
| `fortune_user_preferences` | 用户偏好 | 20251229_final_mvp.sql | ✓ |
| `fortune_bazi_snapshot` | 八字快照 | 20251229_final_mvp.sql | ✓ |
| `fortune_conversation_session` | 对话会话 | 20251229_final_mvp.sql | ✓ |
| `fortune_conversation_message` | 对话消息 | 20251229_final_mvp.sql | ✓ |
| `fortune_commitment` | 承诺/任务 | 20251229_final_mvp.sql | ✓ |
| `fortune_checkin` | 情绪打卡 | 20251229_final_mvp.sql | ✓ |
| `fortune_reflection` | 复盘记录 | 20260101_goal_reflection.sql | ✓ |
| `fortune_goal` | 目标设定 | 20260101_goal_reflection.sql | ✓ |
| `fortune_daily_guidance` | 每日指引 | 20251229_final_mvp.sql | ✓ |
| `fortune_push_event` | 推送记录 | 20251229_final_mvp.sql | ✓ |
| `fortune_plan` | 成长计划 | 20251229_final_mvp.sql | ✓ |
| `fortune_plan_enrollment` | 计划报名 | 20251229_final_mvp.sql | ✓ |
| `fortune_external_job` | 外部任务映射 | 20251229_final_mvp.sql | ✓ |
| `fortune_poster` | 海报生成 | 20260101_poster_kline.sql | ✓ |
| `fortune_kline_daily` | K线数据 | 20260101_poster_kline.sql | ✓ |
| `fortune_agent_run` | Agent 审计 | 20251230_claude_mvp.sql | ✓ |

### 知识库表

| 表名 | 用途 | 状态 |
|------|------|------|
| `bazi_kb_document` | 知识文档 | ✓ |
| `bazi_kb_chunk` | 知识分块 (FTS+trgm) | ✓ |
| `fortune_rule` | 规则库 | ✓ |

---

## 9. API 实现状态矩阵 (SSOT)

> 其他文档引用此表，不再重复定义

| 模块 | 端点 | 方法 | 状态 | 路由文件 |
|------|------|------|------|----------|
| **Auth** | `/api/auth/register` | POST | ✓ | auth_routes.py:56 |
| | `/api/auth/login` | POST | ✓ | auth_routes.py:107 |
| | `/api/auth/logout` | POST | ✓ | auth_routes.py:145 |
| | `/api/auth/me` | GET | ✓ | auth_routes.py:162 |
| | `/api/auth/preview` | POST | ✓ | auth_routes.py:185 |
| | `/api/auth/validation-points` | POST | ✗ | 待实现 |
| **Chat** | `/api/chat/send` | POST | ✓ | chat_routes.py:504 |
| | `/api/chat/stream` | GET | ✓ | chat_routes.py:786 |
| | `/api/chat/history` | GET | ✓ | chat_routes.py:850 |
| **Dashboard** | `/api/dashboard/overview` | GET | ✓ | dashboard_routes.py:72 |
| | `/api/dashboard/status` | GET | ✓ | dashboard_routes.py:144 |
| | `/api/dashboard/trends` | GET | ✓ | dashboard_routes.py:191 |
| | `/api/dashboard/kline` | GET | ✓ | dashboard_routes.py:572 |
| | `/api/dashboard/tasks` | GET | ✓ | dashboard_routes.py:295 |
| | `/api/dashboard/task/accept` | POST | ✓ | dashboard_routes.py:319 |
| | `/api/dashboard/task/done` | POST | ✓ | dashboard_routes.py:374 |
| | `/api/dashboard/task/skip` | POST | ✓ | dashboard_routes.py:424 |
| | `/api/dashboard/checkin` | POST | ✓ | dashboard_routes.py:473 |
| **Report** | `/api/report/bazi/submit` | POST | ✓ | bento_routes.py |
| | `/api/report/bazi/{job_id}` | GET | ✓ | bento_routes.py |
| | `/api/report/bazi/deep/submit` | POST | ✓ | bento_routes.py |
| **Poster** | `/api/poster/generate` | POST | ✓ | poster_routes.py |
| | `/api/poster/{poster_id}` | GET | ✓ | poster_routes.py |
| **Goal** | `/api/goal/list` | GET | ✓ | goal_routes.py |
| | `/api/goal/create` | POST | ✓ | goal_routes.py |
| | `/api/goal/{goal_id}` | GET/PUT | ✓ | goal_routes.py |
| **Reflection** | `/api/reflection/list` | GET | ✓ | reflection_routes.py |
| | `/api/reflection/create` | POST | ✓ | reflection_routes.py |

---

## 10. 北极星指标 (WCG) 分解

```
                    WCG (Weekly Closed-loop Guidance)
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
   Activation            Retention           Task Completion
   (首次闭环)            (周回访)             (任务完成率)
        │                     │                     │
   ┌────┴────┐          ┌────┴────┐          ┌────┴────┐
   │ 注册    │          │ 7日回访  │          │ 任务接受 │
   │ 首次Chat│          │ 30日回访 │          │ 任务完成 │
   │ 首次任务│          │ 打卡频率 │          │ 跳过率  │
   └────┬────┘          └────┬────┘          └────┬────┘
        │                     │                     │
   ┌────┴────────────────────┴────────────────────┴────┐
   │                    事件埋点                         │
   ├────────────────────────────────────────────────────┤
   │ user_registered      fortune_user.created_at       │
   │ first_chat           fortune_conversation_message  │
   │ commitment_made      fortune_commitment.accepted_at│
   │ task_completed       fortune_commitment.done_at    │
   │ checkin_done         fortune_checkin.created_at    │
   │ reflection_done      fortune_reflection.created_at │
   └────────────────────────────────────────────────────┘
```

### WCG 判定 SQL

```sql
-- 本周完成闭环的用户数
SELECT COUNT(DISTINCT c.user_id) AS wcg_users
FROM fortune_commitment c
WHERE c.status = 'done'
  AND c.done_at >= date_trunc('week', NOW())
  AND c.accepted_at IS NOT NULL;
```

---

## 11. 错误码规范

| HTTP | code | 说明 |
|------|------|------|
| 400 | `invalid_request` | 请求参数错误 |
| 401 | `unauthorized` | 未登录 |
| 403 | `csrf_invalid` | CSRF 校验失败 |
| 404 | `not_found` | 资源不存在 |
| 410 | `deprecated_use_new_api` | 旧接口已废弃 |
| 429 | `rate_limited` | 频率限制 |
| 500 | `internal_error` | 服务端错误 |
| 503 | `llm_unavailable` | LLM 服务不可用 |

---

## 12. 版本历史

| 日期 | 版本 | 变更 |
|------|------|------|
| 2026-01-01 | v1.0 | 初始版本，统一四份文档命名 |
| 2026-01-01 | v3.0 | 同步四份文档 v3 版本；所有文档增加 Mermaid + ASCII 双格式图表 |
| 2026-01-01 | v3.1 | §7 更新为 Context Driven 架构；添加旧术语映射表；同步 os_design_v3.md §1.4 |
