# Soul OS å¿ƒç†æ¶æ„è®¾è®¡

**ç‰ˆæœ¬**ï¼šv3.1ï¼ˆ2026-01-01ï¼ŒContext Driven + Pluggable Modulesï¼‰
**æ–‡æ¡£ç±»å‹**ï¼šOperating System Psychological Architecture
**å®šä½**ï¼šåŸºäºæ·±åº¦å¿ƒç†å­¦çš„ç²¾ç¥æ•°å­—å­ªç”Ÿæ“ä½œç³»ç»Ÿ
**æ ¸å¿ƒæ¶æ„**ï¼šContext Driven / Pluggable Modulesï¼ˆå¯æ’æ‹”æ¨¡å—åŒ–æ¶æ„ï¼‰
**ç†è®ºæ¡†æ¶**ï¼šè£æ ¼åˆ†æå¿ƒç†å­¦ Ã— ç§¯æå¿ƒç†å­¦ Ã— è¡Œä¸ºç§‘å­¦ Ã— è‡ªæˆ‘å†³å®šç†è®º

---

## 0. ä¿®è®¢è¯´æ˜

### 0.0 v3.1 æ¶æ„å‡çº§è¦ç‚¹

æœ¬ç‰ˆæœ¬é‡‡ç”¨ **Context Driven / Pluggable Modules** æ¶æ„ï¼Œæ ¸å¿ƒå˜æ›´ï¼š

1. **å±‚æ¬¡é‡æ–°å®šä¹‰**ï¼š
   - Interaction Layer: å¯é…ç½®æ¨¡å‹å±‚ï¼ˆGLM/Gemini/GPT-4o/Claude åŠ¨æ€é€‰æ‹©ï¼‰
   - Context Management: ä¸Šä¸‹æ–‡ç»„è£…å·¥å‚ï¼ˆéç®€å•è·¯ç”±ï¼‰
   - L2 åŒåˆ†æ”¯: Style Agents (é£æ ¼) + Expert Agents (ä¸“å®¶æ¨¡å—)
   - L1 Module Data: å¯æ’æ‹”æ•°æ®å±‚
   - L0 Base Data: ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆï¼ˆåœ°åŸºå±‚ï¼‰

2. **å¯æ’æ‹”è®¾è®¡**ï¼šL1 æ•°æ®å±‚å’Œ L2 ä¸“å®¶æ¨¡å—å‡æ”¯æŒç‹¬ç«‹å¢åˆ 
3. **é£æ ¼ä¸ä¸“å®¶åˆ†ç¦»**ï¼šL2 åˆ†ä¸ºè¯­æ°”æ§åˆ¶å’Œä¸šåŠ¡çŸ¥è¯†ä¸¤ä¸ªç‹¬ç«‹åˆ†æ”¯

### 0.1 è®¾è®¡ vs å®ç°å¯¹æ¯”

| æ¨¡å— | è®¾è®¡çŠ¶æ€ | å®ç°çŠ¶æ€ | å·®è·åˆ†æ |
|------|----------|----------|----------|
| L0 Base Data | âœ… å®Œæ•´è®¾è®¡ | âœ… å®Œæ•´å®ç° | å…«å­—è®¡ç®—ç²¾ç¡® |
| L1 Module Data | âœ… å¯æ’æ‹”è®¾è®¡ | âœ… å·²å®ç° | å…«å­—/PERMA æ¨¡å—å°±ç»ª |
| L2 Expert Agents | âœ… å¤šæ¨¡å—è®¾è®¡ | âš ï¸ éƒ¨åˆ†å®ç° | ä»…å…«å­— Agentï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç° |
| L2 Style Agents | âœ… ä¸‰é£æ ¼è®¾è®¡ | âœ… å·²å®ç° | standard/warm/roast |
| Context Management | âœ… ç»„è£…å·¥å‚ | âœ… GLM æ•´åˆ | å·¥ä½œæ­£å¸¸ |
| Interaction Layer | âœ… å¤šæ¨¡å‹æ”¯æŒ | âš ï¸ éƒ¨åˆ†å®ç° | GLM ä¸ºä¸»ï¼ŒGemini/Claude å¤‡é€‰ |
| Goal æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
| Reflection æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
| anti-dependency | âœ… ç­–ç•¥è®¾è®¡ | âš ï¸ å¾…ä¼˜åŒ– | æ–°ç”¨æˆ·è±å…å¾…å®ç° |
| A2UI æ¸²æŸ“ | âœ… action_buttons | âš ï¸ å‰ç«¯é—®é¢˜ | CSRF é—®é¢˜ |

---

## 1. å¤šå±‚æ¶æ„æµç¨‹å›¾å¯¹æ¯”

> **æœ¯è¯­å®šä¹‰**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§7 Soul OS æ¶æ„
> **æ ¸å¿ƒæ¶æ„**: Context Driven / Pluggable Modulesï¼ˆè§ Â§1.4ï¼‰

### 1.1 è®¾è®¡æ¶æ„ (å››å±‚å¿ƒç†æ¶æ„) âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä¿ç•™ä½œä¸º v2 æ¶æ„çš„å†å²å‚è€ƒã€‚
> **âœ… å½“å‰è§„èŒƒ**: è¯·ä½¿ç”¨ [Â§1.4 Context é©±åŠ¨æ¶æ„](#14-context-é©±åŠ¨æ¶æ„-å¯æ’æ‹”æ¨¡å—è§†å›¾) ä½œä¸ºå”¯ä¸€å®ç°ä¾æ®ã€‚
>
> | æ—§æœ¯è¯­ | æ–°æ¶æ„æ˜ å°„ |
> |--------|------------|
> | L0 Firmware (å®šæ•°/æœ¬æˆ‘) | L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ) |
> | L1 Schema (ç‰¹è´¨/å›¾å¼) | L1 Module Data (å¯æ’æ‹”æ•°æ®å±‚) |
> | L2 Agents (ç­–ç•¥/è¶…æˆ‘) | L2 Expert + Style Agents (åŒåˆ†æ”¯) |
> | L3 Synthesis (æ„è¯†/è‡ªæˆ‘) | Context Management + Interaction Layer |

```mermaid
graph TB
    subgraph User["ğŸ‘¤ ç”¨æˆ·äº¤äº’"]
        Input["è¾“å…¥æ¶ˆæ¯"]
    end

    subgraph L3["L3: Synthesis (æ„è¯†/è‡ªæˆ‘)"]
        GLM["å…ƒè®¤çŸ¥ä»²è£å™¨<br/>(GLM Agent)"]
        A2UI["A2UI JSON è¾“å‡º<br/>ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·"]
    end

    subgraph L2["L2: Agents (ç­–ç•¥/è¶…æˆ‘)"]
        BaziAgent["å…«å­—è§£è¯» Agent<br/>æ ¼å±€/å¤§è¿/ç¥ç…"]
        PsyAgent["å¿ƒç†å­¦ Agent<br/>PERMA/CBT/æƒ…ç»ª"]
        ActionAgent["è¡ŒåŠ¨æ•™ç»ƒ Agent<br/>å¤„æ–¹/æ—¶é—´/éš¾åº¦"]
    end

    subgraph L1["L1: Schema (ç‰¹è´¨/å›¾å¼)"]
        PERMA["PERMA äº”ç»´<br/>P-E-R-M-A"]
        StateScore["State Score<br/>æƒ…ç»ª40%+è¡ŒåŠ¨35%+æˆé•¿25%"]
    end

    subgraph L0["L0: Firmware (å®šæ•°/æœ¬æˆ‘)"]
        Bazi["å…«å­—ç¡®å®šæ€§è®¡ç®—<br/>å››æŸ±/åç¥/ç¥ç…/å¤§è¿"]
        Profile["ç”¨æˆ·æ¡£æ¡ˆ<br/>åŸºç¡€ä¿¡æ¯+åå¥½+å†å²"]
    end

    Input --> L3
    GLM --> A2UI

    L2 --> GLM
    BaziAgent --> GLM
    PsyAgent --> GLM
    ActionAgent --> GLM

    L1 --> L2
    PERMA --> BaziAgent
    StateScore --> PsyAgent

    L0 --> L1
    Bazi --> PERMA
    Profile --> StateScore

    style L3 fill:#e8f5e9,stroke:#4caf50
    style L2 fill:#e3f2fd,stroke:#2196f3
    style L1 fill:#fff3e0,stroke:#ff9800
    style L0 fill:#fce4ec,stroke:#e91e63
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Soul OS å››å±‚å¿ƒç†æ¶æ„                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚     ç”¨æˆ·äº¤äº’        â”‚
                           â”‚     è¾“å…¥æ¶ˆæ¯        â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3: Synthesis (æ„è¯†/è‡ªæˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    å…ƒè®¤çŸ¥ä»²è£å™¨          â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    A2UI JSON è¾“å‡º            â”‚        â”‚
â”‚  â”‚    (GLM Agent)          â”‚        â”‚    ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·        â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L2: Agents (ç­–ç•¥/è¶…æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚              â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                                                          â”‚              â”‚
â”‚  â–¼                          â–¼                          â–¼    â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚
â”‚  â”‚ å…«å­—è§£è¯»Agent â”‚    â”‚ å¿ƒç†å­¦ Agent â”‚    â”‚ è¡ŒåŠ¨æ•™ç»ƒAgent â”‚   â”‚              â”‚
â”‚  â”‚ æ ¼å±€/å¤§è¿/ç¥ç…â”‚    â”‚ PERMA/CBT/æƒ…ç»ªâ”‚    â”‚ å¤„æ–¹/æ—¶é—´/éš¾åº¦â”‚   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                   â”‚                   â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L1: Schema (ç‰¹è´¨/å›¾å¼) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚          â”‚                   â”‚                   â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚                 â”‚   â”‚                                    â”‚              â”‚
â”‚  â–¼                 â–¼   â”‚                                    â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
â”‚  â”‚ PERMA äº”ç»´       â”‚  â”‚    â”‚ State Score               â”‚  â”‚              â”‚
â”‚  â”‚ P-E-R-M-A       â”‚  â”‚    â”‚ æƒ…ç»ª40% + è¡ŒåŠ¨35% + æˆé•¿25%â”‚  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚           â”‚                   â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L0: Firmware (å®šæ•°/æœ¬æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
â”‚           â”‚           â”‚                   â”‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ å…«å­—ç¡®å®šæ€§è®¡ç®—                  â”‚  â”‚ ç”¨æˆ·æ¡£æ¡ˆ                    â”‚       â”‚
â”‚  â”‚ å››æŸ± / åç¥ / ç¥ç… / å¤§è¿       â”‚  â”‚ åŸºç¡€ä¿¡æ¯ + åå¥½ + å†å²       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
</details>

**PERMA äº”ç»´å®šä¹‰**:

| ç»´åº¦ | è‹±æ–‡ | å«ä¹‰ | æ•°æ®æ¥æº |
|------|------|------|----------|
| P | Positive Emotion | ç§¯ææƒ…ç»ª | fortune_checkin |
| E | Engagement | æŠ•å…¥ | ä»»åŠ¡å®Œæˆç‡ |
| R | Relationships | å…³ç³» | ç¤¾äº¤äº’åŠ¨ |
| M | Meaning | æ„ä¹‰ | ç›®æ ‡å…³è”åº¦ |
| A | Accomplishment | æˆå°± | ç´¯è®¡å®Œæˆä»»åŠ¡ |

### 1.2 å½“å‰å®ç°æ¶æ„ âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä½¿ç”¨ v2 å››å±‚æœ¯è¯­ï¼Œä¿ç•™ä½œä¸ºä»£ç å®ç°çš„å‚è€ƒæ˜ å°„ã€‚
> **âœ… æ–°æœ¯è¯­**: L0â†’L0 Base, L1â†’L1 Module, L2â†’L2 Expert, L3â†’Interaction Layer

```mermaid
graph LR
    subgraph Services["services/"]
        SoulOS["soul_os.py<br/>æ ¸å¿ƒåè°ƒå™¨"]

        subgraph L0_Impl["L0 å®ç° âœ…"]
            L0Facts["get_l0_facts()"]
            BaziSvc["bazi_service.py"]
        end

        subgraph L1_Impl["L1 å®ç° âœ…"]
            L1Schema["get_l1_schema()"]
            PERMA_Calc["calculate_perma()"]
            StateCalc["calculate_state_score()"]
        end

        subgraph L2_Impl["L2 å®ç° âš ï¸"]
            KBSearch["search_knowledge_base()"]
            AntiDep["check_anti_dependency()"]
        end

        subgraph L3_Impl["L3 å®ç° âœ…"]
            PromptBuild["build_system_prompt()"]
            GLMClient["glm_client.py"]
        end
    end

    SoulOS --> L0Facts
    SoulOS --> L1Schema
    SoulOS --> KBSearch
    SoulOS --> PromptBuild

    L0Facts --> BaziSvc
    L1Schema --> PERMA_Calc
    L1Schema --> StateCalc
    PromptBuild --> GLMClient

    style L0_Impl fill:#d4edda
    style L1_Impl fill:#d4edda
    style L2_Impl fill:#fff3cd
    style L3_Impl fill:#d4edda
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å½“å‰å®ç°æ¶æ„ (services/)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      soul_os.py (æ ¸å¿ƒåè°ƒå™¨)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚     â”‚     â”‚     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                            â”‚     â”‚                            â”‚
    â–¼                            â–¼     â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L0 å®ç° âœ…         â”‚  â”‚ L1 å®ç° âœ…         â”‚  â”‚ L2 å®ç° âš ï¸                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ get_l0_facts()â”‚ â”‚  â”‚ â”‚ get_l1_schemaâ”‚ â”‚  â”‚ â”‚ search_knowledge_base()â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚         â”‚  â”‚         â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚         â–¼         â”‚  â”‚         â–¼         â”‚  â”‚ â”‚ check_anti_dependency()â”‚   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â”‚ bazi_service  â”‚ â”‚  â”‚ â”‚ calculate_    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â”‚ .py           â”‚ â”‚  â”‚ â”‚ perma()       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚
                       â”‚ â”‚ calculate_    â”‚ â”‚            â”‚
                       â”‚ â”‚ state_score() â”‚ â”‚            â–¼
                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ L3 å®ç° âœ…                    â”‚
                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                              â”‚ â”‚ build_system_prompt()  â”‚   â”‚
                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                              â”‚             â–¼                â”‚
                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                              â”‚ â”‚ glm_client.py          â”‚   â”‚
                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å›¾ä¾‹: âœ… å®Œæ•´å®ç° | âš ï¸ éƒ¨åˆ†å®ç°
```
</details>

**å®ç°çŠ¶æ€çŸ©é˜µ**:

| å±‚çº§ | ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|:----:|------|
| L0 | çœŸå¤ªé˜³æ—¶æ ¡æ­£ | âœ… | swisseph |
| L0 | å››æŸ±æ’ç›˜ | âœ… | lunar_python |
| L0 | åç¥/ç¥ç…/å¤§è¿ | âœ… | å®Œæ•´å®ç° |
| L0 | facts_hash | âœ… | å¯è¿½æº¯ |
| L1 | PERMA äº”ç»´ | âœ… | è®¡ç®—æ­£ç¡® |
| L1 | State Score | âœ… | èšåˆæ­£ç¡® |
| L1 | è¡Œä¸ºè¯æ®å…³è” | âš ï¸ | å¾…å¢å¼º |
| L2 | çŸ¥è¯†åº“æ£€ç´¢ | âœ… | FTS + trgm |
| L2 | å¤šAgentå¹¶è¡Œ | âš ï¸ | ä»…å…«å­—Agent |
| L3 | GLM è¾“å‡º | âœ… | A2UI JSON |
| L3 | If-Then å¤„æ–¹ | âœ… | æ ¼å¼æ­£ç¡® |

### 1.3 æœ€ä¼˜æ¶æ„ (å®Œæ•´å››å±‚ + ç›®æ ‡/å¤ç›˜é—­ç¯) âš ï¸ LEGACY

> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚å±•ç¤º v2 å››å±‚æ—¶åºæµç¨‹ï¼Œä¿ç•™ä½œä¸ºå¯¹è¯æµç¨‹çš„å‚è€ƒã€‚
> **âœ… æ–°æ¶æ„æ˜ å°„**:
> - L0æ•°å­¦è„‘ â†’ L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ)
> - L1å¿ƒç†è„‘ â†’ L1 Module Data (PERMA/å…«å­—ç­‰å¯æ’æ‹”æ•°æ®)
> - L2çŸ¥è¯†è„‘ â†’ L2 Expert Agents (å…«å­—Agent/CBT Agentç­‰)
> - L3è¯­è¨€è„‘ â†’ Context Management + Interaction Layer (å¤šæ¨¡å‹)

```mermaid
sequenceDiagram
    autonumber
    participant U as ç”¨æˆ·
    participant FE as å‰ç«¯<br/>(Zone A/B)
    participant API as FastAPI<br/>/api/*
    participant OS as Soul OS<br/>åè°ƒå™¨
    participant L0 as L0 æ•°å­¦è„‘
    participant L1 as L1 å¿ƒç†è„‘
    participant L2 as L2 çŸ¥è¯†è„‘
    participant L3 as L3 è¯­è¨€è„‘
    participant DB as PostgreSQL

    U->>FE: è¾“å…¥æ¶ˆæ¯
    FE->>API: POST /api/chat/send

    rect rgb(240, 248, 255)
        Note over OS,L2: get_full_context(user_id)
        API->>OS: è¯·æ±‚ä¸Šä¸‹æ–‡
        OS->>L0: get_l0_facts()
        L0-->>OS: å…«å­— facts
        OS->>L1: get_l1_schema()
        L1-->>OS: PERMA + State Score
        OS->>L2: search_knowledge_base()
        L2-->>OS: kb_refs + rule_ids
        OS->>DB: get_active_goals()
        DB-->>OS: æ´»è·ƒç›®æ ‡åˆ—è¡¨
    end

    rect rgb(255, 248, 240)
        Note over OS,L3: L3 Synthesis
        OS->>L3: System Prompt + context
        L3-->>OS: A2UI JSON<br/>(â‰¤3 If-Then å¤„æ–¹)
    end

    OS->>DB: INSERT conversation_message
    OS->>DB: INSERT commitment (suggested)
    OS-->>FE: A2UI å“åº”

    FE->>FE: Zone A æ¸²æŸ“æ¶ˆæ¯
    FE->>FE: Zone B åˆ·æ–°ä»»åŠ¡
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœ€ä¼˜å››å±‚æ¶æ„ + ç›®æ ‡/å¤ç›˜é—­ç¯                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  ç”¨æˆ·    å‰ç«¯Zone    FastAPI    SoulOS    L0æ•°å­¦    L1å¿ƒç†    L2çŸ¥è¯†    L3è¯­è¨€    DB
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚â”€â”€è¾“å…¥â”€â–¶â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€POSTâ”€â”€â”€â”€â–¶â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚ chat/send â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚ get_full_context(user_id)     â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚â”€â”€è¯·æ±‚ä¸Šä¸‹æ–‡â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_l0_facts()â”€â”€â–¶â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€å…«å­— factsâ”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_l1_schema()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€PERMA + State Scoreâ”€â”€â”€â”€â”€â”€â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€search_kb()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€kb_refs + rule_idsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€get_active_goals()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€ç›®æ ‡åˆ—è¡¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚ L3 Synthesis        â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€System Prompt + contextâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â—€â”€A2UI JSON (â‰¤3 If-Then å¤„æ–¹)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT conversation_messageâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT commitment (suggested)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â—€â”€â”€A2UI å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€Zone A æ¸²æŸ“æ¶ˆæ¯      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚â”€â”€Zone B åˆ·æ–°ä»»åŠ¡      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
```
</details>

**ä¼˜åŒ–é¡¹**:

| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | è¯´æ˜ |
|:------:|--------|------|
| P0 | action_buttons + CSRF | å‰ç«¯ç‚¹å‡»å¤„ç† |
| P1 | anti-dependency è±å… | æ–°ç”¨æˆ· 7 å¤©è±å… |
| P1 | å¤„æ–¹å…³è”ç›®æ ‡ | è‡ªåŠ¨å…³è”æ´»è·ƒç›®æ ‡ |
| P2 | å¤šAgentå¹¶è¡Œ | å…«å­—/å¿ƒç†/è¡ŒåŠ¨ Agent |
| P2 | å…¨é“¾è·¯è¿½è¸ª | correlation_id |

### 1.4 Context é©±åŠ¨æ¶æ„ (å¯æ’æ‹”æ¨¡å—è§†å›¾)

```
+-----------------------------------------------------------------------------------+
|                            Soul OS Architecture v3.0                              |
|                    (Context Driven / Pluggable Modules)                           |
+-----------------------------------------------------------------------------------+
                                       ^
                                       | äº¤äº’/å“åº”
+-----------------------------------------------------------------------------------+
|  Interaction & Model Configuration (å¯é…ç½®æ¨¡å‹å±‚)                                 |
+-----------------------------------------------------------------------------------+
|  [ Framework: Vercel SDK / LangChain ]                                            |
|  [ LLM Core:  GLM-4 / Gemini / GPT-4o / Claude ]  <-- åŠ¨æ€é€‰æ‹©                    |
+-----------------------------------------------------------------------------------+
                                       ^
                                       | ç»„è£…åçš„ Context (Prompt + Data)
+-----------------------------------------------------------------------------------+
|  Context Management (ä¸Šä¸‹æ–‡ç®¡ç†ä¸è·¯ç”±)                                            |
+-----------------------------------------------------------------------------------+
|   ^                                  ^                                        ^   |
|   | (Inject Style)                   | (Inject Expert Knowledge)              |   |
+---|----------------------------------|----------------------------------------|---+
    |                                  |
+---+----------------------------+ +---+----------------------------------------+---+
| L2: Style Agents (é£æ ¼/è¯­æ°”)   | | L2: Expert Agents (ä¸“å®¶æ¨¡å—/Prompt+çŸ¥è¯†åº“)     |
| (Prompt Templates)             | | (Domain Specific Prompts + Knowledge Base)     |
+--------------------------------+ +------------------------------------------------+
|                                | | [å¯æ’æ‹”/Pluggable Modules]                     |
|  +----------+ +----------+     | |                                                |
|  | Standard | |  Warm    |     | | +--------+  +--------+  +--------+  +--------+ |
|  | (æ ‡å‡†)   | | (æ¸©æš–)   |     | | |  å…«å­—  |  |  ç´«å¾®  |  |  æ˜Ÿåº§  |  |  CBT   | |
|  +----------+ +----------+     | | | Agent  |  | Agent  |  | Agent  |  | Agent  | |
|  +----------+                  | | +--------+  +--------+  +--------+  +--------+ |
|  |  Roast   |                  | |                                                |
|  | (æ¯’èˆŒ)   |                  | | +--------+  +--------+  +--------+             |
|  +----------+                  | | | PERMA  |  | Covey  |  | ...... |             |
|                                | | | Agent  |  | (7Hab) |  | (More) |             |
|                                | | +--------+  +--------+  +--------+             |
+--------------------------------+ +------------------------------------------------+
                                       ^
                                       | è¯»å–å¯¹åº”æ¨¡å—æ•°æ®
+--------------------------------------+--------------------------------------------+
| L1: Module Data Layer (å„æ¨¡å—ç‹¬ç«‹æ•°æ®å±‚)                                          |
| (Structured Data Schemas / JSON)                                                  |
+-----------------------------------------------------------------------------------+
|  [å¯æ’æ‹”/Pluggable Data]                                                          |
|                                                                                   |
|  +-------------+   +-------------+   +-------------+   +-------------+            |
|  | å…«å­—æ’ç›˜æ•°æ®|   | ç´«å¾®æ–—æ•°ç›˜  |   | æ˜Ÿåº§/æ˜Ÿç›˜   |   | PERMA é‡è¡¨  |            |
|  | (GanZhi)    |   | (Ziwei Map) |   | (Astro map) |   | (Scores)    |            |
|  +-------------+   +-------------+   +-------------+   +-------------+            |
|                                                                                   |
|  +-------------+   +-------------+   +-------------+                              |
|  | Covey è¿›åº¦  |   | æƒ…ç»ªè®°å½•    |   | å…¶ä»–ä¸šåŠ¡æ•°æ®|                              |
|  | (Habits)    |   | (Logs)      |   | (Ext Data)  |                              |
|  +-------------+   +-------------+   +-------------+                              |
+-----------------------------------------------------------------------------------+
                                       ^
                                       | åŸºç¡€ä¾èµ–
+--------------------------------------+--------------------------------------------+
| L0: Base Data Layer (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ)                                                |
| (Global User Profile)                                                             |
+-----------------------------------------------------------------------------------+
|                                                                                   |
|   +---------------------+    +---------------------+    +---------------------+   |
|   |      åŸºç¡€ä¿¡æ¯       |    |       ç”¨æˆ·åå¥½      |    |       å½“å‰çŠ¶æ€      |   |
|   | (Basic Info: DOB/   |    | (Preferences: Tags/ |    | (Status: Mood/      |   |
|   |  Gender/Location)   |    |  Topics/Goals)      |    |  Lifecycle Stage)   |   |
|   +---------------------+    +---------------------+    +---------------------+   |
|                                                                                   |
|                       +---------------------------+                               |
|                       |         å†å²å¯¹è¯          |                               |
|                       | (Conversation History)    |                               |
|                       +---------------------------+                               |
+-----------------------------------------------------------------------------------+
```

**æ¶æ„å±‚æ¬¡è¯´æ˜**:

| å±‚çº§ | å®šä¹‰ | èŒè´£ | å¯æ’æ‹”æ€§ |
|------|------|------|----------|
| Interaction | æ¨¡å‹ä¸æ¡†æ¶é…ç½®å±‚ | GLM/Gemini åŠ¨æ€é€‰æ‹©ï¼ŒVercel SDK æ‰§è¡Œ | âœ… æ¨¡å‹å¯åˆ‡æ¢ |
| Context Mgmt | ä¸Šä¸‹æ–‡ç»„è£…å·¥å‚ | å°† L0/L1 æ•°æ®ä¸ L2 Prompt èåˆ | - |
| L2 Expert | ä¸“å®¶æ¨¡å— (Prompt + KB) | ä¸šåŠ¡é€»è¾‘/çŸ¥è¯†åº“ï¼Œå¦‚å…«å­—ã€PERMAã€CBT | âœ… å¯æ’æ‹” |
| L2 Style | é£æ ¼æ¨¡å— (Prompt) | è¾“å‡ºè¯­æ°”/äººè®¾ï¼šæ ‡å‡†ã€æ¸©æš–ã€æ¯’èˆŒ | âœ… å¯åˆ‡æ¢ |
| L1 Module Data | å„æ¨¡å—ç‹¬ç«‹æ•°æ®å±‚ | å…«å­—æ’ç›˜ã€ç´«å¾®ç›˜ã€PERMA é‡è¡¨ç­‰ | âœ… å¯æ’æ‹” |
| L0 Base Data | ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ | åŸºç¡€ä¿¡æ¯ã€åå¥½ã€å†å²ã€çŠ¶æ€ | - |

**å…³é”®è®¾è®¡åŸåˆ™**:

1. **L0 â†’ L1 â†’ L2 ä¾èµ–æ–¹å‘**: ä¸Šå±‚ä¾èµ–ä¸‹å±‚ï¼Œæ•°æ®ä»åº•å±‚æµå‘ä¸Šå±‚
2. **æ¨¡å—å¯æ’æ‹”**: L1 æ•°æ®å±‚å’Œ L2 ä¸“å®¶æ¨¡å—å‡æ”¯æŒç‹¬ç«‹å¢åˆ 
3. **Context ç»„è£…**: Context Management ä½œä¸ºç»„è£…å·¥å‚ï¼Œéç®€å•è·¯ç”±
4. **é£æ ¼ä¸ä¸“å®¶åˆ†ç¦»**: L2 åˆ†ä¸º Style Agents (è¯­æ°”) å’Œ Expert Agents (çŸ¥è¯†)
5. **æ¨¡å‹å¯é…ç½®**: Interaction å±‚æ”¯æŒ GLM/Gemini/GPT-4o/Claude åŠ¨æ€é€‰æ‹©

---

## 2. é—­ç¯æµç¨‹å¯¹æ¯”

> **æ‰¿è¯ºçŠ¶æ€æœº**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§5
> **åŒ—ææ˜ŸæŒ‡æ ‡**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§10 WCG

### 2.1 è®¾è®¡é—­ç¯æµç¨‹ (7æ­¥é—­ç¯æ¨¡å‹)

```mermaid
stateDiagram-v2
    [*] --> Clarify: ç”¨æˆ·è¾“å…¥

    state "1. Clarify<br/>é—®é¢˜æ¾„æ¸…" as Clarify
    state "2. Insight<br/>æ´å¯Ÿç”Ÿæˆ" as Insight
    state "3. Prescription<br/>å¤„æ–¹ç”Ÿæˆ" as Prescription
    state "4. Commitment<br/>æ‰¿è¯ºç¡®è®¤" as Commitment
    state "5. Action<br/>è¡ŒåŠ¨æ‰§è¡Œ" as Action
    state "6. Reflection<br/>å¤ç›˜åæ€" as Reflection
    state "7. Memory<br/>è®°å¿†æ›´æ–°" as Memory

    Clarify --> Insight: L0+L1+L2 åˆ†æ
    Insight --> Prescription: If-Then å¤„æ–¹
    Prescription --> Commitment: action_button ç‚¹å‡»
    Commitment --> Action: ç”¨æˆ·æ‰§è¡Œ
    Action --> Reflection: å‘¨æœŸæ€§å¤ç›˜
    Reflection --> Memory: PERMA/Kçº¿ æ›´æ–°
    Memory --> [*]: é—­ç¯å®Œæˆ

    note right of Commitment
        WCG å…³é”®ç‚¹:
        ä¸€å‘¨ â‰¥1 æ¬¡å®Œæ•´é—­ç¯
    end note
```

<details>
<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         7æ­¥é—­ç¯æ¨¡å‹ (è®¾è®¡ç›®æ ‡)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                              ç”¨æˆ·è¾“å…¥
                                 â”‚
                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 1. Clarify                                                            â”‚
    â”‚    é—®é¢˜æ¾„æ¸…                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ L0+L1+L2 åˆ†æ
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 2. Insight                                                            â”‚
    â”‚    æ´å¯Ÿç”Ÿæˆ                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ If-Then å¤„æ–¹
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 3. Prescription                                                       â”‚
    â”‚    å¤„æ–¹ç”Ÿæˆ                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ action_button ç‚¹å‡»
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 4. Commitment     â˜… WCG å…³é”®ç‚¹: ä¸€å‘¨ â‰¥1 æ¬¡å®Œæ•´é—­ç¯                      â”‚
    â”‚    æ‰¿è¯ºç¡®è®¤                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ ç”¨æˆ·æ‰§è¡Œ
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 5. Action                                                             â”‚
    â”‚    è¡ŒåŠ¨æ‰§è¡Œ                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ å‘¨æœŸæ€§å¤ç›˜
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 6. Reflection                                                         â”‚
    â”‚    å¤ç›˜åæ€                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ PERMA/Kçº¿ æ›´æ–°
                                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ 7. Memory                                                             â”‚
    â”‚    è®°å¿†æ›´æ–°                                                            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                              é—­ç¯å®Œæˆ âœ“
```
</details>

**WCG (Weekly Closed-loop Guidance)**: ä¸€å‘¨å†…å®Œæˆ â‰¥1 æ¬¡å®Œæ•´é—­ç¯

### 2.2 å½“å‰å®ç° (é—­ç¯æ–­è£‚åˆ†æ)

```mermaid
stateDiagram-v2
    [*] --> CIP: ç”¨æˆ·è¾“å…¥

    state "Clarify+Insight+Prescription<br/>âœ… Chat å“åº”" as CIP

    state "Commitment<br/>âš ï¸ CSRF é˜»å¡" as Commitment {
        [*] --> suggested: å¤„æ–¹ç”Ÿæˆ
        suggested --> active: ç‚¹å‡» action_button
        note right of active: âš ï¸ å‰ç«¯ CSRF é—®é¢˜<br/>æ— æ³•è§¦å‘
    }

    state "Action<br/>âš ï¸ æ— æ³•è§¦è¾¾" as Action
    state "Reflection<br/>âš ï¸ å…¥å£ä¸æ˜æ˜¾" as Reflection
    state "Memory<br/>âœ… è‡ªåŠ¨æ›´æ–°" as Memory

    CIP --> Commitment
    Commitment --> Action: é˜»å¡
    Action --> Reflection
    Reflection --> Memory
    Memory --> [*]
```

**é—­ç¯é˜»å¡ç‚¹**:

| æ­¥éª¤ | åç«¯ | å‰ç«¯ | é˜»å¡åŸå›  |
|------|:----:|:----:|----------|
| Clarify+Insight+Prescription | âœ… | âœ… | æ—  |
| Commitment | âœ… | âš ï¸ | CSRF token æœªä¼ é€’ |
| Action | âœ… | âš ï¸ | åŒä¸Š |
| Reflection | âœ… | âš ï¸ | å…¥å£ä¸æ˜æ˜¾ |
| Memory | âœ… | âœ… | æ—  |

**é˜»å¡å½±å“**: é—­ç¯æ–­è£‚åœ¨ Commitment æ­¥éª¤ï¼Œç”¨æˆ·æ— æ³•é€šè¿‡ç‚¹å‡»å®Œæˆä»»åŠ¡

### 2.3 æœ€ä¼˜é—­ç¯æµç¨‹ (ç›®æ ‡é©±åŠ¨ + 8æ­¥æ¨¡å‹)

```mermaid
stateDiagram-v2
    [*] --> GoalSet: å¯é€‰å…¥å£

    state "Step 0: GoalSet<br/>ç›®æ ‡è®¾å®š" as GoalSet
    state "Step 1: Clarify<br/>é—®é¢˜æ¾„æ¸…" as Clarify
    state "Step 2: Insight<br/>æ´å¯Ÿç”Ÿæˆ" as Insight
    state "Step 3: Prescription<br/>å¤„æ–¹ç”Ÿæˆ" as Prescription

    state "Step 4: Commitment<br/>æ‰¿è¯ºç¡®è®¤" as Commitment {
        [*] --> suggested
        suggested --> active: action_button + CSRF
    }

    state "Step 5: Action<br/>è¡ŒåŠ¨æ‰§è¡Œ" as Action {
        [*] --> doing
        doing --> done: ç‚¹å‡»å®Œæˆ
        done --> rewards: aura_earned + streak
    }

    state "Step 6: Reflection<br/>å¤ç›˜åæ€" as Reflection
    state "Step 7: Memory<br/>è®°å¿†æ›´æ–°" as Memory
    state "Step 8: GoalReview<br/>ç›®æ ‡å¤ç›˜" as GoalReview

    GoalSet --> Clarify: è·å–æ´»è·ƒç›®æ ‡
    Clarify --> Insight: L0+L1+L2 åˆ†æ
    Insight --> Prescription: If-Then å¤„æ–¹
    Prescription --> Commitment: å†™å…¥ suggested
    Commitment --> Action: ç”¨æˆ·æ‰§è¡Œ
    Action --> Reflection: å‘¨æœŸæ€§
    Reflection --> Memory: è‡ªåŠ¨èšåˆ
    Memory --> GoalReview: å‘¨æœŸæ€§
    GoalReview --> Clarify: ä¸‹ä¸€è½®
```

**æ­¥éª¤è¯¦æƒ…**:

| æ­¥éª¤ | è¯´æ˜ | äº§å‡º |
|------|------|------|
| 0. GoalSet | è®¾å®šå¹´/å­£/æœˆ/å‘¨ç›®æ ‡ | fortune_goal |
| 1. Clarify | é—®é¢˜æ¾„æ¸… + ç›®æ ‡ä¸Šä¸‹æ–‡ | ç”¨æˆ·æ„å›¾ |
| 2. Insight | L0-L3 å››å±‚åˆ†æ | ç»“æ„åŒ–æ´å¯Ÿ |
| 3. Prescription | â‰¤3 æ¡ If-Then å¤„æ–¹ | commitment (suggested) |
| 4. Commitment | ç”¨æˆ·ç‚¹å‡»ç¡®è®¤ | commitment (active) |
| 5. Action | æ‰§è¡Œ + å®Œæˆ | rewards |
| 6. Reflection | å››é—®å¿ƒæ³•å¤ç›˜ | fortune_reflection |
| 7. Memory | PERMA/Kçº¿ æ›´æ–° | è¶‹åŠ¿æ•°æ® |
| 8. GoalReview | ç›®æ ‡è¿›åº¦è¯„ä¼° | è°ƒæ•´/å…³é—­ |

**WCG éªŒæ”¶**:
- å®Œæ•´é—­ç¯ = Clarify â†’ Prescription â†’ Commitment(accepted) â†’ Action(done) â†’ Reflection
- ç›®æ ‡: æ¯å‘¨ â‰¥1 æ¬¡å®Œæ•´é—­ç¯
- å½“å‰é˜»å¡: å‰ç«¯ CSRF é—®é¢˜

---

## 3. API å®ç°çŠ¶æ€æ˜ å°„

### 3.1 Goal æ¨¡å—

| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
|------|------|------|------|
| `POST /api/goal/create` | âœ… | âœ… | åˆ›å»ºç›®æ ‡ |
| `GET /api/goal/list` | âœ… | âœ… | ç›®æ ‡åˆ—è¡¨ |
| `GET /api/goal/{goal_id}` | âœ… | âœ… | ç›®æ ‡è¯¦æƒ… |
| `PUT /api/goal/{goal_id}` | âœ… | âœ… | æ›´æ–°ç›®æ ‡ |
| `POST /api/goal/{goal_id}/link` | âœ… | âš ï¸ | å¾…å®Œå–„ |

### 3.2 Reflection æ¨¡å—

| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
|------|------|------|------|
| `POST /api/reflection/create` | âœ… | âœ… | åˆ›å»ºå¤ç›˜ |
| `GET /api/reflection/list` | âœ… | âœ… | å¤ç›˜åˆ—è¡¨ |
| `GET /api/reflection/prompt` | âœ… | âœ… | è·å–å¼•å¯¼é—®é¢˜ |

---

## 4. éªŒæ”¶æŒ‡æ ‡å¯¹æ¯”

### 4.1 WCG æŒ‡æ ‡

```sql
-- è®¾è®¡: WCG éªŒæ”¶æŸ¥è¯¢
WITH weekly_loop AS (
  SELECT
    user_id,
    DATE_TRUNC('week', created_at) AS week,
    BOOL_OR(accepted_at IS NOT NULL) AS has_commitment,
    BOOL_OR(status = 'done') AS has_action
  FROM fortune_commitment
  GROUP BY user_id, DATE_TRUNC('week', created_at)
)
SELECT
  user_id,
  week,
  (has_commitment AND has_action) AS wcg_achieved
FROM weekly_loop;

-- å½“å‰çŠ¶æ€: åç«¯æ•°æ®å¯æŸ¥è¯¢, å‰ç«¯é—­ç¯å¾…ä¿®å¤
```

### 4.2 æ–°å¢éªŒæ”¶æŒ‡æ ‡

| æŒ‡æ ‡ | å®šä¹‰ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
|------|------|------|----------|
| ç›®æ ‡è®¾å®šç‡ | 7å¤©å†…è®¾å®šâ‰¥1ç›®æ ‡ | â‰¥30% | âš ï¸ å¾…ç»Ÿè®¡ |
| å¤ç›˜å®Œæˆç‡ | æ¯å‘¨â‰¥1æ¬¡å¤ç›˜ | â‰¥20% | âš ï¸ å¾…ç»Ÿè®¡ |
| Check-in ä½¿ç”¨ç‡ | æ¯å‘¨â‰¥1æ¬¡æ‰“å¡ | â‰¥40% | âœ… åç«¯å¯ç”¨ |
| A2UI ç‚¹å‡»ç‡ | action_buttons è¢«ç‚¹å‡» | â‰¥50% | âš ï¸ å‰ç«¯é—®é¢˜ |

---

## 5. æ€»ç»“

### 5.1 è®¾è®¡ vs å®ç°ä¸€è‡´æ€§

```
L0 Base Data:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
L1 Module Data:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%   â† å…«å­—/PERMA å°±ç»ªï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç°
L2 Expert Agents:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%   â† ä»…å…«å­— Agent
L2 Style Agents:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%   â† standard/warm/roast
Context Management: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
Interaction Layer:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%   â† GLM ä¸ºä¸»ï¼Œå¤šæ¨¡å‹å¾…å®Œå–„
Goal æ¨¡å—:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
Reflection:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
å‰ç«¯é—­ç¯:           â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40%   â† ä¸»è¦å·®è·
```

### 5.2 å…³é”®å·®è·

| å·®è· | å½±å“ | ä¼˜å…ˆçº§ | è§£å†³æ–¹æ¡ˆ |
|------|------|--------|----------|
| å‰ç«¯ CSRF | é—­ç¯æ–­è£‚ | P0 | ä¿®å¤ api.ts |
| action_buttons | æ— æ³•ç‚¹å‡» | P0 | å®Œå–„æ¸²æŸ“ |
| anti-dependency | æ–°ç”¨æˆ·è¢«æˆªæ–­ | P1 | æ·»åŠ è±å… |
| L2 Expert æ¨¡å— | ä»…å…«å­— Agent | P2 | æ·»åŠ ç´«å¾®/æ˜Ÿåº§/CBT Agent |
| Interaction å¤šæ¨¡å‹ | GLM å•ä¸€ | P2 | å®Œå–„ Gemini/Claude åˆ‡æ¢ |

### 5.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **P0**: ä¿®å¤å‰ç«¯ CSRF â†’ æ¢å¤é—­ç¯
2. **P0**: å®Œå–„ action_buttons å¤„ç†
3. **P1**: å®ç° anti-dependency æ–°ç”¨æˆ·è±å…
4. **P1**: æ·»åŠ å¤ç›˜å…¥å£åˆ° Dashboard
5. **P2**: æ‰©å±• L2 Expert Agentsï¼ˆç´«å¾®/æ˜Ÿåº§/CBTï¼‰
6. **P2**: Interaction Layer å¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢

---

*æ–‡æ¡£ç‰ˆæœ¬: v3.1 (Context Driven Architecture)*
*æ›´æ–°æ—¥æœŸ: 2026-01-01*
*æµ‹è¯•ç¯å¢ƒ: http://106.37.170.238:8231/new*
