/**
 * Skill Registry - Central registration and management of all skills
 *
 * This is the single source of truth for skill configuration
 */

import type {
  SkillId,
  SkillPlugin,
  SkillRegistry,
  PanelDefinition,
  ToolDefinition,
} from "./types";

// Import skill plugins
import { baziPlugin } from "./bazi";
import { zodiacPlugin } from "./zodiac";

// Import shared tools
import { sharedTools } from "./shared-tools";

// Import shared panels
import { sharedPanels } from "./shared-panels";

// ═══════════════════════════════════════════════════════════════════════════
// Skill Registration
// ═══════════════════════════════════════════════════════════════════════════

const skillsMap = new Map<SkillId, SkillPlugin>();

// Register all skills
function registerSkill(plugin: SkillPlugin) {
  skillsMap.set(plugin.id, plugin);
}

// Register built-in skills
registerSkill(baziPlugin);
registerSkill(zodiacPlugin);

// ═══════════════════════════════════════════════════════════════════════════
// Registry Implementation
// ═══════════════════════════════════════════════════════════════════════════

export const skillRegistry: SkillRegistry = {
  getAll() {
    return Array.from(skillsMap.values());
  },

  get(id: SkillId) {
    return skillsMap.get(id);
  },

  getEnabled() {
    return Array.from(skillsMap.values()).filter((s) => s.enabled);
  },

  isEnabled(id: SkillId) {
    const skill = skillsMap.get(id);
    return skill?.enabled ?? false;
  },

  // ─── Panel Helpers ────────────────────────────────────────────────────────

  getSkillPanels(skillId: SkillId): PanelDefinition[] {
    const skill = skillsMap.get(skillId);
    return skill?.panels ?? [];
  },

  getAllPanels(skillId: SkillId): PanelDefinition[] {
    const skill = skillsMap.get(skillId);
    if (!skill) return sharedPanels;

    // Filter shared panels based on skill's sharedFeatures config
    const filteredSharedPanels = sharedPanels.filter((panel) => {
      const features = skill.sharedFeatures;
      if (!features) return true; // Default: all enabled

      switch (panel.id) {
        case "report":
          return features.report !== false;
        case "relationship":
          return features.relationship !== false;
        case "kline":
          return features.kline !== false;
        default:
          return true;
      }
    });

    // Merge and sort
    const allPanels = [...filteredSharedPanels, ...skill.panels];
    return allPanels.sort((a, b) => (a.order ?? 50) - (b.order ?? 50));
  },

  // ─── Tool Helpers ─────────────────────────────────────────────────────────

  getSkillTools(skillId: SkillId): ToolDefinition[] {
    const skill = skillsMap.get(skillId);
    return skill?.tools ?? [];
  },

  getAllTools(skillId: SkillId): ToolDefinition[] {
    const skill = skillsMap.get(skillId);
    if (!skill) return sharedTools;

    // Filter shared tools based on skill's sharedFeatures config
    const filteredSharedTools = sharedTools.filter((tool) => {
      const features = skill.sharedFeatures;
      if (!features) return true;

      // Match tool names to features
      if (tool.name.includes("report") && features.report === false) return false;
      if (tool.name.includes("relationship") && features.relationship === false) return false;
      if (tool.name.includes("interview") && features.interview === false) return false;

      return true;
    });

    return [...filteredSharedTools, ...skill.tools];
  },

  getTool(name: string): ToolDefinition | undefined {
    // Search in shared tools first
    const sharedTool = sharedTools.find((t) => t.name === name);
    if (sharedTool) return sharedTool;

    // Search in all skill tools
    const skills = Array.from(skillsMap.values());
    for (const skill of skills) {
      const skillTool = skill.tools.find((t: ToolDefinition) => t.name === name);
      if (skillTool) return skillTool;
    }

    return undefined;
  },
};

// ═══════════════════════════════════════════════════════════════════════════
// Utility Exports
// ═══════════════════════════════════════════════════════════════════════════

export function getSkillConfig(skillId: SkillId) {
  return skillRegistry.get(skillId);
}

export function getSkillTheme(skillId: SkillId) {
  const skill = skillRegistry.get(skillId);
  return skill?.theme;
}

export function getSkillTools(skillId: SkillId) {
  return skillRegistry.getAllTools(skillId);
}

export function getSkillPanels(skillId: SkillId) {
  return skillRegistry.getAllPanels(skillId);
}

// Export default
export default skillRegistry;
