"use client";

import { motion } from "framer-motion";
import { ReactNode, Suspense } from "react";
import { cn } from "@/lib/utils";
import { SimpleVibeGlyph, type SkillType } from "@/components/core";
import { skillRegistry } from "@/skills/registry";
import type { SkillId, ToolExecuteContext } from "@/skills/types";

// ═══════════════════════════════════════════════════════════════════════════
// ChatMessage - LUMINOUS PAPER Design System
// 聊天消息气泡：墨色用户消息 + 卡片助手消息
// 支持 AI SDK 6 Generative UI (toolInvocations)
// ═══════════════════════════════════════════════════════════════════════════

// Tool invocation state types from AI SDK 6
interface ToolInvocation {
  toolCallId: string;
  toolName: string;
  args: Record<string, unknown>;
  state: "partial-call" | "call" | "result";
  result?: unknown;
}

export interface ChatMessageProps {
  role: "user" | "assistant";
  content: string;
  timestamp?: string;
  isStreaming?: boolean;
  showAvatar?: boolean;
  /** AI SDK 6: Tool invocations for Generative UI */
  toolInvocations?: ToolInvocation[];
  /** Current skill for tool rendering */
  skill?: SkillType;
  /** Callback for tool approval */
  onToolApprove?: (toolCallId: string, approved: boolean) => void;
}

export function ChatMessage({
  role,
  content,
  timestamp,
  isStreaming,
  showAvatar = true,
  toolInvocations,
  skill = "bazi",
  onToolApprove,
}: ChatMessageProps) {
  const isUser = role === "user";

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3, ease: [0.16, 1, 0.3, 1] }}
      className={cn(
        "flex w-full mb-4 gap-3",
        isUser ? "flex-row-reverse" : "flex-row"
      )}
    >
      {/* Avatar */}
      {showAvatar && !isUser && (
        <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center">
          <SimpleVibeGlyph size={24} skill={skill} />
        </div>
      )}

      {/* Message content area */}
      <div className={cn("flex-1 max-w-[85%]", isUser && "flex flex-col items-end")}>
        {/* Text content bubble */}
        {content && (
          <div
            className={cn(
              isUser ? "chat-bubble-user" : "chat-bubble-assistant"
            )}
          >
            <p className="whitespace-pre-wrap leading-relaxed">{content}</p>

            {/* Streaming indicator */}
            {isStreaming && !toolInvocations?.length && (
              <span className="inline-flex items-center gap-1 ml-1">
                <span className="w-1.5 h-1.5 rounded-full bg-current animate-pulse" />
                <span className="w-1.5 h-1.5 rounded-full bg-current animate-pulse animation-delay-150" />
                <span className="w-1.5 h-1.5 rounded-full bg-current animate-pulse animation-delay-300" />
              </span>
            )}

            {/* Timestamp */}
            {timestamp && (
              <p className="chat-timestamp">
                {timestamp}
              </p>
            )}
          </div>
        )}

        {/* AI SDK 6: Tool Invocations (Generative UI) */}
        {toolInvocations?.map((invocation) => (
          <ToolInvocationRenderer
            key={invocation.toolCallId}
            invocation={invocation}
            skill={skill as SkillId}
            onApprove={onToolApprove}
          />
        ))}
      </div>

      {/* User avatar placeholder for alignment */}
      {showAvatar && isUser && (
        <div className="flex-shrink-0 w-8 h-8" />
      )}
    </motion.div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// ToolInvocationRenderer - AI SDK 6 Generative UI
// ═══════════════════════════════════════════════════════════════════════════

interface ToolInvocationRendererProps {
  invocation: ToolInvocation;
  skill: SkillId;
  onApprove?: (toolCallId: string, approved: boolean) => void;
}

function ToolInvocationRenderer({ invocation, skill, onApprove }: ToolInvocationRendererProps) {
  const { toolCallId, toolName, args, state, result } = invocation;

  // Find tool definition from registry
  const toolDef = skillRegistry.getTool(toolName);

  // Loading state (partial-call or call without result)
  if (state === "partial-call" || (state === "call" && !result)) {
    // Check if tool needs approval
    const needsApproval = toolDef?.needsApproval
      ? typeof toolDef.needsApproval === "function"
        ? toolDef.needsApproval(args)
        : toolDef.needsApproval
      : false;

    if (needsApproval && state === "call" && onApprove) {
      return (
        <ToolApprovalCard
          toolName={toolName}
          args={args}
          toolCallId={toolCallId}
          onApprove={onApprove}
        />
      );
    }

    return (
      <div className="mt-2 animate-pulse bg-muted/50 rounded-xl p-4 border border-border/50">
        <div className="flex items-center gap-2">
          <div className="w-4 h-4 rounded-full border-2 border-skill-primary border-t-transparent animate-spin" />
          <span className="text-sm text-muted-foreground">
            {getToolDisplayName(toolName)} 处理中...
          </span>
        </div>
      </div>
    );
  }

  // Result state - render using tool's render function or fallback
  if (state === "result" && result !== undefined) {
    // Use tool's custom render function if available
    if (toolDef?.render) {
      const context: ToolExecuteContext = { skillId: skill };
      return (
        <Suspense fallback={<ToolLoadingFallback />}>
          <div className="mt-2">
            {toolDef.render(result, context)}
          </div>
        </Suspense>
      );
    }

    // Fallback: render as JSON card
    return (
      <div className="mt-2 bg-muted/30 rounded-xl p-3 border border-border/30">
        <div className="text-xs text-muted-foreground mb-1">{getToolDisplayName(toolName)}</div>
        <pre className="text-xs overflow-x-auto">
          {typeof result === "string" ? result : JSON.stringify(result, null, 2)}
        </pre>
      </div>
    );
  }

  return null;
}

// ═══════════════════════════════════════════════════════════════════════════
// ToolApprovalCard - For tools that need user approval
// ═══════════════════════════════════════════════════════════════════════════

interface ToolApprovalCardProps {
  toolName: string;
  args: Record<string, unknown>;
  toolCallId: string;
  onApprove: (toolCallId: string, approved: boolean) => void;
}

function ToolApprovalCard({ toolName, args, toolCallId, onApprove }: ToolApprovalCardProps) {
  return (
    <div className="mt-2 bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800 rounded-xl p-4">
      <div className="flex items-start gap-3">
        <span className="text-xl">⚠️</span>
        <div className="flex-1">
          <p className="font-medium text-amber-900 dark:text-amber-100">
            需要确认操作
          </p>
          <p className="text-sm text-amber-800 dark:text-amber-200 mt-1">
            {getToolDisplayName(toolName)}
          </p>
          {Object.keys(args).length > 0 && (
            <div className="text-xs text-amber-700 dark:text-amber-300 mt-2 bg-amber-100 dark:bg-amber-900/30 rounded p-2">
              {Object.entries(args).map(([key, value]) => (
                <div key={key}>
                  <span className="font-medium">{key}:</span> {String(value)}
                </div>
              ))}
            </div>
          )}
          <div className="flex gap-2 mt-3">
            <button
              onClick={() => onApprove(toolCallId, true)}
              className="px-4 py-1.5 bg-amber-600 hover:bg-amber-700 text-white text-sm rounded-lg transition-colors"
            >
              确认
            </button>
            <button
              onClick={() => onApprove(toolCallId, false)}
              className="px-4 py-1.5 bg-white dark:bg-amber-900 hover:bg-amber-50 dark:hover:bg-amber-800 text-amber-900 dark:text-amber-100 text-sm rounded-lg border border-amber-300 dark:border-amber-700 transition-colors"
            >
              取消
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Helpers
// ═══════════════════════════════════════════════════════════════════════════

function ToolLoadingFallback() {
  return (
    <div className="mt-2 animate-pulse bg-muted/30 rounded-xl p-4">
      <div className="h-4 bg-muted rounded w-1/3 mb-2" />
      <div className="h-20 bg-muted rounded" />
    </div>
  );
}

function getToolDisplayName(toolName: string): string {
  const displayNames: Record<string, string> = {
    show_bazi_chart: "展示命盘",
    show_bazi_kline: "展示人生K线",
    show_bazi_fortune: "展示大运流年",
    show_zodiac_chart: "展示星盘",
    show_transit: "展示天象推运",
    show_synastry: "展示合盘分析",
    show_report: "展示报告",
    show_relationship: "关系分析",
    show_insight: "展示洞察",
    request_info: "收集信息",
  };
  return displayNames[toolName] || toolName;
}

// ═══════════════════════════════════════════════════════════════════════════
// SystemMessage - For system notifications in chat
// ═══════════════════════════════════════════════════════════════════════════

interface SystemMessageProps {
  content: string;
  className?: string;
}

export function SystemMessage({ content, className }: SystemMessageProps) {
  return (
    <div
      className={cn(
        "flex justify-center my-4",
        className
      )}
    >
      <span className="px-3 py-1.5 text-xs text-muted-foreground bg-muted/50 rounded-full">
        {content}
      </span>
    </div>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// TypingIndicator - Shows when assistant is thinking
// ═══════════════════════════════════════════════════════════════════════════

interface TypingIndicatorProps {
  className?: string;
}

export function TypingIndicator({ className }: TypingIndicatorProps) {
  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -10 }}
      className={cn("flex items-center gap-3 mb-4", className)}
    >
      <div className="flex-shrink-0 w-8 h-8 flex items-center justify-center">
        <SimpleVibeGlyph size={24} skill="bazi" />
      </div>
      <div className="chat-bubble-assistant">
        <div className="flex items-center gap-1.5">
          <span className="w-2 h-2 rounded-full bg-muted-foreground animate-bounce" style={{ animationDelay: "0ms" }} />
          <span className="w-2 h-2 rounded-full bg-muted-foreground animate-bounce" style={{ animationDelay: "150ms" }} />
          <span className="w-2 h-2 rounded-full bg-muted-foreground animate-bounce" style={{ animationDelay: "300ms" }} />
        </div>
      </div>
    </motion.div>
  );
}
