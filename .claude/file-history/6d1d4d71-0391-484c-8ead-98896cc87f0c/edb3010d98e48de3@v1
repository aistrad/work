"use client";

/**
 * SkillProvider - 提供当前 skill 上下文
 *
 * 从 cookie 或 URL 参数中读取 skill
 * 支持子域名模式: bazi.vibelife.app -> skill=bazi
 */

import {
  createContext,
  useContext,
  useState,
  useEffect,
  ReactNode,
} from "react";
import { type SkillType } from "@/components/core";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface SkillContextValue {
  skill: SkillType;
  setSkill: (skill: SkillType) => void;
}

const SkillContext = createContext<SkillContextValue | null>(null);

// ═══════════════════════════════════════════════════════════════════════════
// Hook
// ═══════════════════════════════════════════════════════════════════════════

export function useSkill() {
  const context = useContext(SkillContext);
  if (!context) {
    throw new Error("useSkill must be used within SkillProvider");
  }
  return context;
}

// ═══════════════════════════════════════════════════════════════════════════
// Helper Functions
// ═══════════════════════════════════════════════════════════════════════════

const VALID_SKILLS: SkillType[] = ["bazi", "zodiac", "mbti", "attach", "career"];
const DEFAULT_SKILL: SkillType = "bazi";

function getCookie(name: string): string | undefined {
  if (typeof document === "undefined") return undefined;
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop()?.split(";").shift();
  return undefined;
}

function getSkillFromHostname(): SkillType | null {
  if (typeof window === "undefined") return null;

  const hostname = window.location.hostname;
  const parts = hostname.split(".");

  if (parts.length >= 2) {
    const subdomain = parts[0].toLowerCase() as SkillType;
    if (VALID_SKILLS.includes(subdomain)) {
      return subdomain;
    }
  }

  return null;
}

function getInitialSkill(): SkillType {
  // 1. 首先尝试从 hostname 获取
  const hostnameSkill = getSkillFromHostname();
  if (hostnameSkill) return hostnameSkill;

  // 2. 然后尝试从 cookie 获取
  const cookieSkill = getCookie("vibelife-skill") as SkillType | undefined;
  if (cookieSkill && VALID_SKILLS.includes(cookieSkill)) {
    return cookieSkill;
  }

  // 3. 默认
  return DEFAULT_SKILL;
}

// ═══════════════════════════════════════════════════════════════════════════
// Provider
// ═══════════════════════════════════════════════════════════════════════════

interface SkillProviderProps {
  children: ReactNode;
  /** 服务端传入的初始 skill（从 middleware headers 获取） */
  initialSkill?: SkillType;
}

export function SkillProvider({ children, initialSkill }: SkillProviderProps) {
  const [skill, setSkill] = useState<SkillType>(initialSkill || DEFAULT_SKILL);

  // 客户端 hydration 后更新
  useEffect(() => {
    if (!initialSkill) {
      setSkill(getInitialSkill());
    }
  }, [initialSkill]);

  return (
    <SkillContext.Provider value={{ skill, setSkill }}>
      {children}
    </SkillContext.Provider>
  );
}
