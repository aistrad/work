/**
 * useVibeChat - AI SDK 6 useChat wrapper for VibeLife
 *
 * Provides streaming chat with skill and voice mode support
 * Uses AI SDK 6 Data Stream Protocol with DefaultChatTransport
 *
 * Supports:
 * - Tool calling and Generative UI
 * - addToolResult for tool responses
 * - Tool approval workflow
 */

'use client';

import { useChat } from '@ai-sdk/react';
import { DefaultChatTransport } from 'ai';
import { useCallback, useMemo } from 'react';
import { getTokens } from '@/lib/api';

export type SkillId = 'bazi' | 'zodiac' | 'mbti' | 'tarot' | 'attach' | 'career';
export type VoiceMode = 'warm' | 'sarcastic';

// Tool call information for approval workflow
export interface ToolCallInfo {
  toolName: string;
  args: Record<string, unknown>;
  toolCallId: string;
}

export interface UseVibeChatOptions {
  skillId: SkillId;
  voiceMode?: VoiceMode;
  conversationId?: string;
  onConversationStart?: (id: string) => void;
  onError?: (error: Error) => void;
  onFinish?: () => void;
  // AI SDK 6: Tool call callback for approval workflow
  onToolCall?: (toolCall: ToolCallInfo) => void;
}

export function useVibeChat({
  skillId,
  voiceMode = 'warm',
  conversationId,
  onConversationStart,
  onError,
  onFinish,
  onToolCall,
}: UseVibeChatOptions) {
  // Create transport with custom headers and body
  const transport = useMemo(() => {
    const { accessToken } = getTokens();
    return new DefaultChatTransport({
      api: '/api/chat',
      headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : undefined,
      body: {
        skill: skillId,
        voice_mode: voiceMode,
        conversation_id: conversationId,
      },
    });
  }, [skillId, voiceMode, conversationId]);

  // AI SDK 6 useChat hook with transport
  const chat = useChat({
    ...(conversationId ? { id: conversationId } : {}),
    transport,
    onFinish: ({ message }) => {
      // Extract conversation_id from metadata if available
      const metadata = message.metadata as { conversation_id?: string } | undefined;
      if (metadata?.conversation_id && onConversationStart) {
        onConversationStart(metadata.conversation_id);
      }
      onFinish?.();
    },
    onError: (error) => {
      console.error('Chat error:', error);
      onError?.(error);
    },
  });

  // Wrapper for sendMessage - AI SDK 6 accepts { text: string }
  const sendVibeMessage = useCallback(
    async (content: string) => {
      return chat.sendMessage({ text: content });
    },
    [chat]
  );

  // Clear messages and send (for quick prompts)
  const sendQuickPrompt = useCallback(
    async (content: string) => {
      chat.setMessages([]);
      return sendVibeMessage(content);
    },
    [chat, sendVibeMessage]
  );

  // AI SDK 6: Add tool result (for completing tool calls)
  const addToolResult = useCallback(
    (toolCallId: string, toolName: string, output: unknown) => {
      if (chat.addToolResult) {
        chat.addToolResult({ toolCallId, tool: toolName, output });
      }
    },
    [chat]
  );

  // AI SDK 6: Approve or reject tool call
  const approveToolCall = useCallback(
    (toolCallId: string, approved: boolean, toolName = 'unknown', output?: unknown) => {
      if (chat.addToolResult) {
        if (approved) {
          chat.addToolResult({ toolCallId, tool: toolName, output });
        } else {
          chat.addToolResult({
            toolCallId,
            tool: toolName,
            state: 'output-error',
            errorText: '用户已取消操作',
          });
        }
      }
    },
    [chat]
  );

  // Compute isLoading from status
  const isLoading = chat.status === 'submitted' || chat.status === 'streaming';

  return {
    // Core state
    messages: chat.messages,
    status: chat.status,
    isLoading,
    error: chat.error,

    // Actions
    sendMessage: sendVibeMessage,
    sendQuickPrompt,
    stop: chat.stop,
    clearError: chat.clearError,

    // AI SDK 6: Tool handling
    addToolResult,
    approveToolCall,

    // For advanced use
    setMessages: chat.setMessages,
    regenerate: chat.regenerate,

    // Metadata
    conversationId,
    skillId,
    voiceMode,
  };
}

export default useVibeChat;
