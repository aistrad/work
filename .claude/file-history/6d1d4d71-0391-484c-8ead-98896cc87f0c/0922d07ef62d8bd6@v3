# VibeLife 部署指南

> **当前部署地址**: http://106.37.170.238:8230/
> **实验性前端**: http://106.37.170.238:8232/
> **更新日期**: 2026-01-08
> **前端版本**: V4 (AI SDK 6 + Skill 插件系统)
> **状态**: 运行中

## 快速访问

| 功能 | URL | 说明 |
|------|-----|------|
| 首页 (Skill选择) | http://106.37.170.238:8230/ | 主入口 |
| 八字 Landing | http://106.37.170.238:8230/bazi | 八字功能入口 |
| 八字 对话 | http://106.37.170.238:8230/bazi/chat | 八字对话页面 |
| 星座 Landing | http://106.37.170.238:8230/zodiac | 星座功能入口 |
| 星座 对话 | http://106.37.170.238:8230/zodiac/chat | 星座对话页面 |
| API 健康检查 | http://106.37.170.238:8230/health | API 状态 |
| **实验性前端** | http://106.37.170.238:8232/ | 星座专属测试入口 |
| 八字专属入口 | http://106.37.170.238:8231/ | 八字专属测试入口 |

## 当前架构

```
用户访问 http://106.37.170.238:8230/
                    │
                    ▼
    ┌─────────────────────────────────────┐
    │     Next.js (:8230)                 │
    │  ├── /*           → 前端页面        │
    │  └── /api/v1/*    → rewrites 代理   │
    │      /health      → rewrites 代理   │
    └─────────────────┬───────────────────┘
                      │ (内部代理)
                      ▼
              ┌───────────────┐
              │ FastAPI:8000  │
              │ (内部访问)    │
              └───────┬───────┘
                      │
                      ▼
              ┌─────────────────┐
              │ PostgreSQL:8224 │
              │ + pgvector      │
              └─────────────────┘
```

### 多入口架构 (Nginx 代理)

```
端口 8230 (主入口)        → Next.js :3000 → 完整功能
端口 8231 (八字专属)      → 代理至 8230 + Set-Cookie: vibelife-skill=bazi
端口 8232 (星座/实验性)   → 代理至 8230 + Set-Cookie: vibelife-skill=zodiac
```

### 服务端口

| 服务 | 端口 | 说明 |
|------|------|------|
| Next.js (生产) | 8230 | 对外统一入口 |
| Next.js (开发) | 3000 | 开发服务器 |
| FastAPI | 8000 | 内部 API (通过 Next.js rewrites 代理) |
| PostgreSQL | 8224 | 数据库 |
| 八字专属入口 | 8231 | Nginx 代理至 8230 |
| 星座/实验性入口 | 8232 | Nginx 代理至 8230 |

---

## vibelife 用户后端管理

### 用户信息

vibelife 用户已创建，用于运行和管理后端服务：

```bash
# 用户信息
uid=1004(vibelife) gid=1004(vibelife) 组=1004(vibelife),27(sudo),33(www-data)
```

### 切换到 vibelife 用户

```bash
# 方式 1: 使用 su 切换
su - vibelife

# 方式 2: 使用 sudo 以 vibelife 身份执行命令
sudo -u vibelife <command>
```

### vibelife 用户目录结构 (推荐)

```bash
/home/vibelife/
├── vibelife/                    # 项目代码
│   ├── apps/
│   │   ├── api/                 # FastAPI 后端
│   │   └── web/                 # Next.js 前端
│   ├── .env                     # 环境变量
│   └── ...
├── logs/                        # 日志目录
│   ├── api.log
│   └── api-error.log
└── .bashrc                      # 用户环境配置
```

### 初始化 vibelife 用户环境

```bash
# 1. 切换到 vibelife 用户
su - vibelife

# 2. 克隆或复制项目代码
git clone https://github.com/aiscendtech/vibelife.git ~/vibelife
# 或从 aiscend 用户复制
cp -r /home/aiscend/work/vibelife ~/vibelife

# 3. 创建日志目录
mkdir -p ~/logs

# 4. 安装 Python 虚拟环境
cd ~/vibelife/apps/api
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 5. 配置环境变量
cp ~/vibelife/.env.example ~/vibelife/apps/api/.env
# 编辑 .env 文件配置数据库和 API 密钥
```

### vibelife 用户后端启动脚本

创建 `/home/vibelife/start-api.sh`:

```bash
#!/bin/bash
# VibeLife API 启动脚本 (vibelife 用户)

cd /home/vibelife/vibelife/apps/api

# 激活虚拟环境
source venv/bin/activate

# 导出环境变量
export VIBELIFE_DB_URL="postgresql://vibelife:password@localhost:8224/vibelife"
export GLM_API_KEY="your_api_key"
export EMBEDDING_MODEL_NAME="BAAI/bge-m3"
export EMBEDDING_DIMENSION="1024"

# 启动服务
echo "[$(date)] Starting VibeLife API on port 8000..."
exec uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
```

设置权限:
```bash
chmod +x /home/vibelife/start-api.sh
```

### Systemd 服务配置 (vibelife 用户)

创建 `/etc/systemd/system/vibelife-api.service`:

```ini
[Unit]
Description=VibeLife API Service (vibelife user)
After=network.target postgresql.service

[Service]
Type=simple
User=vibelife
Group=vibelife
WorkingDirectory=/home/vibelife/vibelife/apps/api
Environment="PATH=/home/vibelife/vibelife/apps/api/venv/bin:/usr/local/bin:/usr/bin"
EnvironmentFile=/home/vibelife/vibelife/apps/api/.env
ExecStart=/home/vibelife/vibelife/apps/api/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always
RestartSec=10
StandardOutput=append:/home/vibelife/logs/api.log
StandardError=append:/home/vibelife/logs/api-error.log

[Install]
WantedBy=multi-user.target
```

启用服务:
```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start vibelife-api

# 开机自启
sudo systemctl enable vibelife-api

# 查看状态
sudo systemctl status vibelife-api

# 查看日志
tail -f /home/vibelife/logs/api.log
journalctl -u vibelife-api -f
```

### 服务管理命令

```bash
# 启动
sudo systemctl start vibelife-api

# 停止
sudo systemctl stop vibelife-api

# 重启
sudo systemctl restart vibelife-api

# 查看状态
sudo systemctl status vibelife-api

# 查看实时日志
sudo journalctl -u vibelife-api -f

# 以 vibelife 用户手动启动 (调试)
sudo -u vibelife /home/vibelife/start-api.sh
```

---

## 实验性前端部署 (端口 8232)

### 概述

端口 8232 作为实验性前端入口，通过 Nginx 代理到主服务，并自动设置 `vibelife-skill=zodiac` Cookie，实现星座功能的独立入口测试。

### Nginx 配置

当前 nginx-vibelife.conf 中已包含 8232 端口配置:

```nginx
# Zodiac 专属入口 (端口 8232) - 自动设置 skill cookie
server {
    listen 8232;
    server_name _;

    location / {
        proxy_pass http://127.0.0.1:8230;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        add_header Set-Cookie "vibelife-skill=zodiac; Path=/; Max-Age=31536000";
    }
}
```

### 部署步骤

```bash
# 1. 复制 Nginx 配置到系统目录
sudo cp /home/aiscend/work/vibelife/nginx-vibelife.conf /etc/nginx/sites-available/vibelife

# 2. 创建软链接启用站点
sudo ln -sf /etc/nginx/sites-available/vibelife /etc/nginx/sites-enabled/

# 3. 测试 Nginx 配置
sudo nginx -t

# 4. 重载 Nginx
sudo systemctl reload nginx

# 5. 验证端口监听
netstat -tuln | grep -E "(8230|8231|8232)"
```

### 测试验证

```bash
# 测试主入口
curl -I http://106.37.170.238:8230/
# 预期: HTTP/1.1 200 OK

# 测试实验性前端 (端口 8232)
curl -I http://106.37.170.238:8232/
# 预期: HTTP/1.1 200 OK
# 预期 Header: Set-Cookie: vibelife-skill=zodiac; Path=/; Max-Age=31536000

# 测试 API 健康检查
curl http://106.37.170.238:8230/health
# 预期: {"status":"ok","service":"vibelife-api","version":"1.0.0","database":"ok"}

# 测试八字入口
curl -I http://106.37.170.238:8231/
# 预期: HTTP/1.1 200 OK
# 预期 Header: Set-Cookie: vibelife-skill=bazi; Path=/; Max-Age=31536000
```

### 访问地址

| 入口 | URL | 自动设置 Cookie |
|------|-----|-----------------|
| 主入口 | http://106.37.170.238:8230/ | 无 |
| 八字专属 | http://106.37.170.238:8231/ | vibelife-skill=bazi |
| 星座/实验性 | http://106.37.170.238:8232/ | vibelife-skill=zodiac |

---

## 完整部署流程

### 1. 系统准备

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装依赖
sudo apt install -y nginx git curl build-essential

# 创建 vibelife 用户 (如不存在)
sudo useradd -m -s /bin/bash vibelife
sudo usermod -aG sudo,www-data vibelife
```

### 2. 数据库部署

```bash
# 安装 PostgreSQL
sudo apt install -y postgresql-14 postgresql-contrib

# 安装 pgvector
cd /tmp
git clone --branch v0.5.0 https://github.com/pgvector/pgvector.git
cd pgvector
make && sudo make install
sudo systemctl restart postgresql

# 创建数据库
sudo -u postgres psql <<EOF
CREATE DATABASE vibelife;
CREATE USER vibelife WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE vibelife TO vibelife;
\c vibelife
CREATE EXTENSION IF NOT EXISTS vector;
EOF

# 执行迁移
psql -U vibelife -d vibelife -f /home/vibelife/vibelife/migrations/001_v3_schema.sql
```

### 3. 后端部署 (vibelife 用户)

```bash
# 切换到 vibelife 用户
su - vibelife

# 克隆项目
git clone https://github.com/aiscendtech/vibelife.git ~/vibelife

# 设置 Python 环境
cd ~/vibelife/apps/api
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 配置环境变量
cp ~/.env.example .env
# 编辑 .env 配置数据库和 API 密钥

# 测试启动
uvicorn main:app --host 0.0.0.0 --port 8000

# 配置 systemd 服务 (需要 sudo)
exit  # 退出 vibelife 用户
sudo systemctl enable vibelife-api
sudo systemctl start vibelife-api
```

### 4. 前端部署

```bash
# 安装 Node.js
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 18
npm install -g pnpm@9

# 安装依赖
cd /home/aiscend/work/vibelife
pnpm install

# 构建前端
cd apps/web
pnpm build

# 启动生产服务
pnpm start -H 0.0.0.0 -p 8230
```

### 5. Nginx 配置

```bash
# 部署 Nginx 配置
sudo cp /home/aiscend/work/vibelife/nginx-vibelife.conf /etc/nginx/sites-available/vibelife
sudo ln -sf /etc/nginx/sites-available/vibelife /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx
```

---

## 当前运行状态检查

### 快速检查脚本

```bash
#!/bin/bash
# VibeLife 状态检查脚本

echo "=== VibeLife 服务状态检查 ==="
echo ""

# 检查端口
echo "[端口检查]"
for port in 3000 8000 8230 8231 8232; do
    if netstat -tuln 2>/dev/null | grep -q ":$port "; then
        echo "  端口 $port: 运行中"
    else
        echo "  端口 $port: 未监听"
    fi
done
echo ""

# 检查进程
echo "[进程检查]"
if pgrep -f "uvicorn main:app" > /dev/null; then
    echo "  FastAPI: 运行中"
else
    echo "  FastAPI: 未运行"
fi

if pgrep -f "next-server" > /dev/null; then
    echo "  Next.js: 运行中"
else
    echo "  Next.js: 未运行"
fi
echo ""

# API 健康检查
echo "[API 健康检查]"
API_RESPONSE=$(curl -s http://127.0.0.1:8000/health 2>/dev/null)
if echo "$API_RESPONSE" | grep -q '"status":"ok"'; then
    echo "  API 状态: OK"
    echo "  响应: $API_RESPONSE"
else
    echo "  API 状态: 失败"
fi
echo ""

# 前端检查
echo "[前端检查]"
WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8230/ 2>/dev/null)
echo "  主入口 (8230): HTTP $WEB_STATUS"

BAZI_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8231/ 2>/dev/null)
echo "  八字入口 (8231): HTTP $BAZI_STATUS"

ZODIAC_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:8232/ 2>/dev/null)
echo "  星座入口 (8232): HTTP $ZODIAC_STATUS"

echo ""
echo "=== 检查完成 ==="
```

### 当前实际运行状态 (2026-01-08)

```
[端口检查]
  端口 3000: 运行中 (开发服务器)
  端口 8000: 运行中 (FastAPI)
  端口 8230: 运行中 (生产前端)

[API 健康检查]
  API 状态: OK
  响应: {"status":"ok","service":"vibelife-api","version":"1.0.0","database":"ok"}

[前端检查]
  主入口 (8230): HTTP 200
```

---

## V4 前端架构 (2026-01-08)

### 技术栈

| 组件 | 版本 | 说明 |
|------|------|------|
| AI SDK | 6.x | Vercel AI SDK，Generative UI 支持 |
| Next.js | 14.x | App Router |
| React | 18.x | 客户端组件 |
| Node.js | 22.x | 运行时 |
| Python | 3.13.x | 后端运行时 |

### Skill 插件系统

```
apps/web/src/skills/
├── types.ts              # 核心类型定义
├── registry.ts           # Skill 注册中心
├── shared-tools.tsx      # 共享 AI 工具
├── shared-panels.ts      # 共享面板
├── bazi/                 # 八字 Skill
│   ├── config.ts
│   ├── tools/            # Generative UI 工具
│   └── panels/
├── zodiac/               # 星座 Skill
│   ├── config.ts
│   ├── tools/
│   └── panels/
└── index.ts              # 统一导出
```

### AI SDK 6 集成

前端支持以下 AI SDK 6 特性：

- **UIMessageStream**: `/api/chat/route.ts` 使用 `createUIMessageStreamResponse`
- **Tool Calling**: 支持 `tool-input-available` 和 `tool-output-available` 事件
- **Generative UI**: `ChatMessage` 组件渲染工具调用结果为 React 组件
- **Tool Approval**: 支持 `needsApproval` 配置和审批 UI

### 后端 Tool 支持（已实现）

后端已实现 Tool Calling 功能，支持以下特性：

**实现模块**:
- `apps/api/services/vibe_engine/llm.py` - LLM 服务扩展，支持 tools 参数
- `apps/api/services/vibe_engine/tools.py` - Tool 定义模块
- `apps/api/routes/chat.py` - Chat 端点集成 tool calling

**Tool 事件格式**:

后端通过 SSE 返回以下事件：

```json
// 文本内容
{"type": "chunk", "content": "..."}

// Tool 调用
{"type": "tool_call", "tool_name": "show_bazi_chart", "tool_call_id": "xxx", "args": {...}}

// 完成标记
{"type": "done", "conversation_id": "...", "skill": "bazi", "voice_mode": "warm"}
```

**可用工具**:
- **共享工具** (4个): show_report, show_relationship, show_insight, request_info
- **八字工具** (3个): show_bazi_chart, show_bazi_fortune, show_bazi_kline
- **星座工具** (3个): show_zodiac_chart, show_zodiac_transit, show_zodiac_synastry

前端会自动将 tool_call 事件转换为 AI SDK 6 格式并渲染对应的 React 组件。

---

## 目录

- [服务器要求](#服务器要求)
- [数据库部署](#数据库部署)
- [后端 API 部署](#后端-api-部署)
- [前端 Web 部署](#前端-web-部署)
- [反向代理配置](#反向代理配置)
- [域名和 SSL](#域名和-ssl)
- [监控和日志](#监控和日志)
- [故障排查](#故障排查)

## 服务器要求

### 硬件配置

**最小配置（开发/测试）**
- CPU: 2 核
- 内存: 4GB
- 硬盘: 50GB SSD
- 带宽: 5Mbps

**推荐配置（生产环境）**
- CPU: 4 核+
- 内存: 8GB+
- 硬盘: 100GB+ SSD
- 带宽: 10Mbps+

### 软件依赖

```bash
# 操作系统
Ubuntu 20.04+ / CentOS 8+ / Debian 11+

# 运行时
Node.js 18.0.0+ (当前使用 22.19.0)
Python 3.11+ (当前使用 3.13.3)
PostgreSQL 14+
Redis 6.0+ (可选)

# 工具
pnpm 9.0.0+
Git
Nginx 1.18+
```

## 数据库部署

### PostgreSQL 安装

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install -y postgresql-14 postgresql-contrib

# 启动服务
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### pgvector 扩展安装

```bash
# 安装编译工具
sudo apt install -y build-essential postgresql-server-dev-14

# 克隆并编译 pgvector
cd /tmp
git clone --branch v0.5.0 https://github.com/pgvector/pgvector.git
cd pgvector
make
sudo make install

# 重启 PostgreSQL
sudo systemctl restart postgresql
```

### 数据库初始化

```bash
# 创建数据库和用户
sudo -u postgres psql <<EOF
CREATE DATABASE vibelife;
CREATE USER vibelife_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE vibelife TO vibelife_user;
\c vibelife
CREATE EXTENSION IF NOT EXISTS vector;
EOF

# 执行迁移脚本
psql -U vibelife_user -d vibelife -f migrations/001_v3_schema.sql
```

### 数据库配置优化

编辑 `/etc/postgresql/14/main/postgresql.conf`:

```conf
# 连接配置
max_connections = 200
shared_buffers = 256MB
effective_cache_size = 1GB

# WAL 配置
wal_level = replica
max_wal_size = 1GB

# 查询优化
random_page_cost = 1.1  # SSD
effective_io_concurrency = 200
```

重启 PostgreSQL:

```bash
sudo systemctl restart postgresql
```

## 后端 API 部署

### 环境准备

```bash
# 安装 Python 和依赖管理工具
sudo apt install -y python3.11 python3.11-venv python3-pip

# 创建项目目录
sudo mkdir -p /opt/vibelife
sudo chown $USER:$USER /opt/vibelife
cd /opt/vibelife

# 克隆项目
git clone https://github.com/aiscendtech/vibelife.git .
```

### Python 虚拟环境

```bash
cd /opt/vibelife/apps/api

# 创建虚拟环境
python3.11 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install --upgrade pip
pip install -r requirements.txt
```

### 环境变量配置

创建 `/opt/vibelife/apps/api/.env`:

```bash
# 数据库
DATABASE_URL=postgresql://vibelife_user:your_secure_password@localhost:5432/vibelife

# LLM 配置
ZHIPU_API_KEY=your_zhipu_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key
DEFAULT_LLM_PROVIDER=zhipu

# 嵌入模型
EMBEDDING_MODEL=bge-m3
EMBEDDING_DIM=1024

# Clerk 认证
CLERK_SECRET_KEY=your_clerk_secret_key

# 支付配置（可选）
STRIPE_SECRET_KEY=your_stripe_secret_key
STRIPE_WEBHOOK_SECRET=your_stripe_webhook_secret

# 应用配置
ENVIRONMENT=production
LOG_LEVEL=INFO
CORS_ORIGINS=https://vibelife.app,https://bazi.vibelife.app

# Redis（可选）
REDIS_URL=redis://localhost:6379/0
```

### Systemd 服务配置

创建 `/etc/systemd/system/vibelife-api.service`:

```ini
[Unit]
Description=VibeLife API Service
After=network.target postgresql.service

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/vibelife/apps/api
Environment="PATH=/opt/vibelife/apps/api/venv/bin"
EnvironmentFile=/opt/vibelife/apps/api/.env
ExecStart=/opt/vibelife/apps/api/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启动服务:

```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start vibelife-api

# 开机自启
sudo systemctl enable vibelife-api

# 查看状态
sudo systemctl status vibelife-api

# 查看日志
sudo journalctl -u vibelife-api -f
```

### 验证 API

```bash
# 检查健康状态
curl http://localhost:8000/health

# 预期输出
# {"status":"ok","service":"vibelife-api","version":"1.0.0","database":"ok"}
```

## 前端 Web 部署

### Node.js 环境

```bash
# 使用 NVM 安装 Node.js
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# 安装 Node.js
nvm install 18
nvm use 18

# 安装 pnpm
npm install -g pnpm@9
```

### 安装依赖

```bash
cd /opt/vibelife

# 安装所有依赖（Monorepo）
pnpm install
```

### 环境变量配置

创建 `/opt/vibelife/apps/web/.env.local`:

```bash
# API 配置
# 浏览器调用使用相对路径，通过 Next.js rewrites 代理到后端
NEXT_PUBLIC_API_URL=
NEXT_PUBLIC_API_BASE=/api/v1

# 服务端内部调用后端 (Next.js rewrites 使用)
VIBELIFE_API_INTERNAL=http://127.0.0.1:8000
```

### 构建生产版本

```bash
cd /opt/vibelife/apps/web

# 构建
pnpm build

# 验证构建
ls -la .next/
```

### 启动脚本

创建 `/opt/vibelife/apps/web/start_prod.sh`:

```bash
#!/bin/bash
# VibeLife Frontend Production Server
cd /opt/vibelife/apps/web

export VIBELIFE_API_INTERNAL=http://127.0.0.1:8000

echo "Starting VibeLife frontend on port 8230..."
exec pnpm start -H 0.0.0.0 -p 8230
```

设置权限:

```bash
chmod +x /opt/vibelife/apps/web/start_prod.sh
```

### Systemd 服务配置

创建 `/etc/systemd/system/vibelife-web.service`:

```ini
[Unit]
Description=VibeLife Web Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/vibelife/apps/web
ExecStart=/opt/vibelife/apps/web/start_prod.sh
Restart=always
RestartSec=10
StandardOutput=append:/var/log/vibelife-web.log
StandardError=append:/var/log/vibelife-web-error.log

[Install]
WantedBy=multi-user.target
```

启动服务:

```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start vibelife-web

# 开机自启
sudo systemctl enable vibelife-web

# 查看状态
sudo systemctl status vibelife-web

# 查看日志
sudo journalctl -u vibelife-web -f
```

### 验证前端

```bash
# 检查端口监听
netstat -tuln | grep 8230

# 测试访问
curl -I http://localhost:8230

# 预期输出
# HTTP/1.1 200 OK
```

## 反向代理配置

### Nginx 安装

```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 主站点配置

创建 `/etc/nginx/sites-available/vibelife`:

```nginx
# API 后端
upstream vibelife_api {
    server 127.0.0.1:8000;
}

# 前端应用
upstream vibelife_web {
    server 127.0.0.1:8230;
}

# HTTP -> HTTPS 重定向
server {
    listen 80;
    server_name vibelife.app *.vibelife.app;
    return 301 https://$host$request_uri;
}

# HTTPS 主站点
server {
    listen 443 ssl http2;
    server_name vibelife.app;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/vibelife.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vibelife.app/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 前端
    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API 路由
    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # 静态资源缓存
    location /_next/static/ {
        proxy_pass http://vibelife_web;
        proxy_cache_valid 200 60m;
        add_header Cache-Control "public, max-age=3600, immutable";
    }
}

# 子域名配置（bazi, zodiac, mbti 等）
server {
    listen 443 ssl http2;
    server_name bazi.vibelife.app zodiac.vibelife.app mbti.vibelife.app;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/vibelife.app/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/vibelife.app/privkey.pem;

    # 前端
    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API 路由
    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

启用站点:

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/vibelife /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重载配置
sudo systemctl reload nginx
```

### 简化配置（仅 IP 访问）

如果暂不配置域名和 SSL，使用以下简化配置：

创建 `/etc/nginx/sites-available/vibelife-simple`:

```nginx
# 后端代理
upstream vibelife_api {
    server 127.0.0.1:8000;
}

# 前端代理
upstream vibelife_web {
    server 127.0.0.1:8230;
}

server {
    listen 80;
    server_name 106.37.170.238;

    # 前端
    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # API
    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_read_timeout 300s;
    }
}
```

## 域名和 SSL

### Let's Encrypt SSL 证书

```bash
# 安装 certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取证书（示例）
sudo certbot --nginx -d vibelife.app -d www.vibelife.app \
  -d bazi.vibelife.app -d zodiac.vibelife.app -d mbti.vibelife.app

# 自动续期
sudo certbot renew --dry-run
```

### 域名解析

在 DNS 服务商添加以下记录：

```
A     vibelife.app           -> 106.37.170.238
A     www.vibelife.app       -> 106.37.170.238
A     bazi.vibelife.app      -> 106.37.170.238
A     zodiac.vibelife.app    -> 106.37.170.238
A     mbti.vibelife.app      -> 106.37.170.238
```

## 监控和日志

### 日志位置

```bash
# 后端 API
sudo journalctl -u vibelife-api -f

# 前端 Web
sudo journalctl -u vibelife-web -f
tail -f /var/log/vibelife-web.log

# Nginx
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log

# PostgreSQL
tail -f /var/log/postgresql/postgresql-14-main.log
```

### 健康检查脚本

创建 `/opt/vibelife/health_check.sh`:

```bash
#!/bin/bash

# 检查 API
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
if [ "$API_STATUS" != "200" ]; then
    echo "API health check failed: $API_STATUS"
    sudo systemctl restart vibelife-api
fi

# 检查前端
WEB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8230)
if [ "$WEB_STATUS" != "200" ]; then
    echo "Web health check failed: $WEB_STATUS"
    sudo systemctl restart vibelife-web
fi

echo "Health check completed at $(date)"
```

添加到 crontab:

```bash
chmod +x /opt/vibelife/health_check.sh

# 每 5 分钟检查一次
crontab -e
# 添加：
# */5 * * * * /opt/vibelife/health_check.sh >> /var/log/vibelife-health.log 2>&1
```

### 性能监控

```bash
# 安装监控工具
sudo apt install -y htop iotop nethogs

# 实时监控
htop              # CPU/内存
iotop             # 磁盘 I/O
nethogs           # 网络流量

# 进程监控
ps aux | grep -E "(uvicorn|next-server)"
```

## 故障排查

### API 启动失败

**问题**: API 服务无法启动

```bash
# 查看详细日志
sudo journalctl -u vibelife-api -n 100

# 常见原因：
# 1. 数据库连接失败
psql -U vibelife_user -d vibelife -c "SELECT 1;"

# 2. 端口被占用
lsof -i :8000

# 3. 虚拟环境问题
cd /opt/vibelife/apps/api
source venv/bin/activate
python -c "import fastapi; print('OK')"

# 4. 环境变量缺失
cat .env | grep -E "(DATABASE_URL|ZHIPU_API_KEY)"
```

### 前端构建失败

**问题**: Next.js 构建报错

```bash
# 常见问题：
# 1. 缺少依赖
cd /opt/vibelife/apps/web
pnpm install

# 2. TypeScript 错误
pnpm build 2>&1 | grep "error TS"

# 3. 环境变量问题
cat .env.local

# 4. 清理缓存重新构建
rm -rf .next node_modules
pnpm install
pnpm build
```

### Clerk 认证错误

**问题**: Missing publishableKey 错误

**解决方案**:

1. 禁用 Clerk 认证（推荐用于内部部署）

```bash
# 修改 middleware.ts 和 AuthProvider.tsx
# 参考已部署的版本，移除 Clerk 依赖
```

2. 或配置 Clerk 密钥

```bash
# apps/web/.env.local
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
```

### 数据库连接问题

**问题**: 无法连接到 PostgreSQL

```bash
# 检查 PostgreSQL 状态
sudo systemctl status postgresql

# 检查监听端口
sudo netstat -tuln | grep 5432

# 检查连接配置
sudo cat /etc/postgresql/14/main/pg_hba.conf

# 允许本地连接
# local   all             all                                     trust
# host    all             all             127.0.0.1/32            md5

# 重启 PostgreSQL
sudo systemctl restart postgresql
```

### 端口访问问题

**问题**: 外网无法访问服务

```bash
# 检查防火墙
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8230/tcp
sudo ufw allow 8231/tcp
sudo ufw allow 8232/tcp

# 检查监听地址
netstat -tuln | grep -E "(80|443|8230|8231|8232)"

# 确保绑定 0.0.0.0 而非 127.0.0.1
```

### 性能问题

**问题**: 响应缓慢

```bash
# 检查数据库查询
# 进入 PostgreSQL
sudo -u postgres psql vibelife

# 查看慢查询
SELECT pid, usename, query, state, wait_event_type
FROM pg_stat_activity
WHERE state != 'idle'
ORDER BY query_start;

# 检查索引
SELECT schemaname, tablename, indexname
FROM pg_indexes
WHERE schemaname = 'public';

# 优化建议：
# 1. 添加缓存（Redis）
# 2. 增加 uvicorn workers
# 3. 数据库连接池配置
# 4. CDN 加速静态资源
```

## 更新部署

### 拉取最新代码

```bash
cd /opt/vibelife

# 备份当前版本
git branch backup-$(date +%Y%m%d)

# 拉取更新
git pull origin master
```

### 更新后端

```bash
cd /opt/vibelife/apps/api

# 激活虚拟环境
source venv/bin/activate

# 更新依赖
pip install -r requirements.txt

# 执行数据库迁移（如有）
psql -U vibelife_user -d vibelife -f /path/to/new_migration.sql

# 重启服务
sudo systemctl restart vibelife-api
```

### 更新前端

```bash
cd /opt/vibelife/apps/web

# 更新依赖
pnpm install

# 重新构建
pnpm build

# 重启服务
sudo systemctl restart vibelife-web
```

## 安全建议

1. **定期更新**
   - 及时更新系统补丁
   - 升级依赖包版本

2. **密钥管理**
   - 使用强密码
   - 定期轮换 API 密钥
   - 不要将 .env 文件提交到 Git

3. **访问控制**
   - 配置防火墙规则
   - 限制数据库访问
   - 使用 fail2ban 防止暴力攻击

4. **备份策略**
   - 每日数据库备份
   - 定期全量备份
   - 异地备份存储

5. **监控告警**
   - 设置性能监控
   - 配置错误告警
   - 监控磁盘空间

## 快速部署总结

当前生产环境配置:

| 服务 | 地址 | 说明 |
|------|------|------|
| 前端 Web (主入口) | http://106.37.170.238:8230 | Next.js 应用 |
| 后端 API | http://106.37.170.238:8000 | FastAPI 应用 |
| 数据库 | localhost:8224 | PostgreSQL |
| 八字专属入口 | http://106.37.170.238:8231 | Nginx 代理 |
| 星座/实验性前端 | http://106.37.170.238:8232 | Nginx 代理 |

服务管理命令:

```bash
# 查看所有服务状态
sudo systemctl status vibelife-api vibelife-web nginx

# 重启所有服务
sudo systemctl restart vibelife-api vibelife-web nginx

# 查看日志
sudo journalctl -u vibelife-api -u vibelife-web -f

# 快速部署脚本
sudo bash /home/aiscend/work/vibelife/deploy.sh
```

---

# 正式生产环境部署方案

> **目标域名**: vibelife.app / bazi.vibelife.app / zodiac.vibelife.app
> **DNS 管理**: Cloudflare
> **前端托管**: Vercel (推荐) 或 阿里云香港
> **后端托管**: 当前服务器 (106.37.170.238) 或 阿里云香港

## 架构总览

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          正式生产架构                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  用户 ──► Cloudflare (DNS + CDN + SSL) ──► Vercel (前端)               │
│                                              │                          │
│                                              │ API 调用                 │
│                                              ▼                          │
│                                    阿里云香港 / 当前服务器              │
│                                    ├── FastAPI (:8000)                  │
│                                    ├── PostgreSQL (:8224)               │
│                                    └── Redis (可选)                     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 方案一：Vercel 前端部署 (推荐)

### 优势

- 全球 CDN，访问速度快
- 自动 CI/CD，Git 推送即部署
- 免费 SSL 证书
- 支持 Edge Functions
- 与 Next.js 深度集成

### 1. Vercel 账号配置

```bash
# 1. 注册 Vercel 账号
# 访问 https://vercel.com 使用 GitHub 登录

# 2. 安装 Vercel CLI
npm i -g vercel

# 3. 登录
vercel login
```

### 2. 项目配置

在项目根目录创建 `vercel.json`:

```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "framework": "nextjs",
  "buildCommand": "cd apps/web && pnpm build",
  "outputDirectory": "apps/web/.next",
  "installCommand": "pnpm install",
  "devCommand": "cd apps/web && pnpm dev",
  "regions": ["hkg1"],
  "env": {
    "VIBELIFE_API_URL": "@vibelife-api-url"
  },
  "rewrites": [
    {
      "source": "/api/v1/:path*",
      "destination": "https://api.vibelife.app/api/v1/:path*"
    },
    {
      "source": "/health",
      "destination": "https://api.vibelife.app/health"
    }
  ],
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-XSS-Protection", "value": "1; mode=block" }
      ]
    }
  ]
}
```

### 3. 环境变量配置

在 Vercel Dashboard 设置环境变量:

| 变量名 | Production | Preview | 说明 |
|--------|------------|---------|------|
| `VIBELIFE_API_URL` | `https://api.vibelife.app` | `https://api-staging.vibelife.app` | 后端 API 地址 |
| `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` | `pk_live_...` | `pk_test_...` | Clerk 公钥 |
| `CLERK_SECRET_KEY` | `sk_live_...` | `sk_test_...` | Clerk 密钥 |

### 4. 部署命令

```bash
# 首次部署
cd /home/aiscend/work/vibelife
vercel

# 生产部署
vercel --prod

# 查看部署状态
vercel ls

# 查看日志
vercel logs vibelife.vercel.app
```

### 5. 自动部署配置

1. 在 Vercel Dashboard 连接 GitHub 仓库
2. 设置 Production Branch: `main` 或 `master`
3. 设置 Root Directory: `./` (monorepo 根目录)
4. 启用自动部署

### 6. 域名绑定 (Vercel 侧)

```bash
# 添加自定义域名
vercel domains add vibelife.app
vercel domains add www.vibelife.app
vercel domains add bazi.vibelife.app
vercel domains add zodiac.vibelife.app
```

---

## 方案二：阿里云香港部署

### 优势

- 国内访问稳定
- 数据合规
- 成本可控
- 前后端可部署在同一区域

### 1. ECS 实例配置

**推荐配置**:

| 项目 | 配置 |
|------|------|
| 地域 | 香港 |
| 规格 | ecs.c6.xlarge (4vCPU 8GB) |
| 系统 | Ubuntu 22.04 LTS |
| 磁盘 | 100GB ESSD |
| 带宽 | 5Mbps (按量付费) |

### 2. 安全组配置

```bash
# 入站规则
TCP 22    (SSH)       - 限制 IP
TCP 80    (HTTP)      - 0.0.0.0/0
TCP 443   (HTTPS)     - 0.0.0.0/0
TCP 8000  (API)       - 限制内网或 Cloudflare IP
```

### 3. 系统初始化

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要工具
sudo apt install -y nginx certbot python3-certbot-nginx git curl

# 创建 vibelife 用户
sudo useradd -m -s /bin/bash vibelife
sudo usermod -aG sudo vibelife

# 安装 Node.js (使用 nvm)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc
nvm install 22
npm install -g pnpm@9

# 安装 Python
sudo apt install -y python3.11 python3.11-venv python3-pip
```

### 4. 前端部署

```bash
# 克隆项目
su - vibelife
git clone https://github.com/aiscendtech/vibelife.git ~/vibelife
cd ~/vibelife

# 安装依赖
pnpm install

# 配置环境变量
cat > apps/web/.env.local << 'EOF'
VIBELIFE_API_URL=http://127.0.0.1:8000
NEXT_PUBLIC_API_BASE=/api/v1
EOF

# 构建
cd apps/web
pnpm build

# 启动
pnpm start -H 0.0.0.0 -p 3000
```

### 5. Nginx 配置 (阿里云)

创建 `/etc/nginx/sites-available/vibelife`:

```nginx
# 前端
upstream vibelife_web {
    server 127.0.0.1:3000;
    keepalive 64;
}

# 后端
upstream vibelife_api {
    server 127.0.0.1:8000;
    keepalive 64;
}

# HTTP -> HTTPS 重定向
server {
    listen 80;
    server_name vibelife.app www.vibelife.app bazi.vibelife.app zodiac.vibelife.app;
    return 301 https://$host$request_uri;
}

# HTTPS 主站
server {
    listen 443 ssl http2;
    server_name vibelife.app www.vibelife.app;

    # Cloudflare Origin 证书
    ssl_certificate /etc/nginx/ssl/vibelife.app.pem;
    ssl_certificate_key /etc/nginx/ssl/vibelife.app.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;

    # Cloudflare Real IP
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    real_ip_header CF-Connecting-IP;

    # 前端
    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 60s;
        proxy_connect_timeout 60s;
    }

    # API 代理
    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;

        # SSE 支持
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
    }

    # 静态资源缓存
    location /_next/static/ {
        proxy_pass http://vibelife_web;
        proxy_cache_valid 200 365d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # Health check
    location /health {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
    }
}

# Skill 子域名
server {
    listen 443 ssl http2;
    server_name bazi.vibelife.app zodiac.vibelife.app mbti.vibelife.app;

    ssl_certificate /etc/nginx/ssl/vibelife.app.pem;
    ssl_certificate_key /etc/nginx/ssl/vibelife.app.key;

    location / {
        proxy_pass http://vibelife_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_read_timeout 300s;
        proxy_buffering off;
    }
}

# API 子域名 (可选)
server {
    listen 443 ssl http2;
    server_name api.vibelife.app;

    ssl_certificate /etc/nginx/ssl/vibelife.app.pem;
    ssl_certificate_key /etc/nginx/ssl/vibelife.app.key;

    location / {
        proxy_pass http://vibelife_api;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_buffering off;
    }
}
```

---

## Cloudflare 域名配置

### 1. DNS 记录配置

在 Cloudflare Dashboard 添加以下记录:

**Vercel 部署方案**:

| 类型 | 名称 | 内容 | 代理状态 | TTL |
|------|------|------|---------|-----|
| CNAME | @ | cname.vercel-dns.com | 已代理 | Auto |
| CNAME | www | cname.vercel-dns.com | 已代理 | Auto |
| CNAME | bazi | cname.vercel-dns.com | 已代理 | Auto |
| CNAME | zodiac | cname.vercel-dns.com | 已代理 | Auto |
| A | api | `<后端服务器IP>` | 已代理 | Auto |

**阿里云部署方案**:

| 类型 | 名称 | 内容 | 代理状态 | TTL |
|------|------|------|---------|-----|
| A | @ | `<阿里云ECS IP>` | 已代理 | Auto |
| A | www | `<阿里云ECS IP>` | 已代理 | Auto |
| A | bazi | `<阿里云ECS IP>` | 已代理 | Auto |
| A | zodiac | `<阿里云ECS IP>` | 已代理 | Auto |
| A | api | `<阿里云ECS IP>` | 已代理 | Auto |

### 2. SSL/TLS 配置

```yaml
# Cloudflare Dashboard -> SSL/TLS

加密模式: Full (strict)
始终使用 HTTPS: 开启
自动 HTTPS 重写: 开启
最低 TLS 版本: TLS 1.2
```

### 3. Origin 证书 (阿里云方案需要)

```bash
# 1. 在 Cloudflare Dashboard -> SSL/TLS -> Origin Server 创建证书
# 2. 下载证书和私钥
# 3. 保存到服务器

sudo mkdir -p /etc/nginx/ssl
sudo nano /etc/nginx/ssl/vibelife.app.pem    # 粘贴证书
sudo nano /etc/nginx/ssl/vibelife.app.key    # 粘贴私钥
sudo chmod 600 /etc/nginx/ssl/*
```

### 4. Page Rules 配置

```yaml
# 规则 1: API 缓存禁用
URL: api.vibelife.app/*
设置:
  - 缓存级别: 绕过
  - 禁用性能

# 规则 2: 静态资源缓存
URL: vibelife.app/_next/static/*
设置:
  - 缓存级别: 缓存所有内容
  - 边缘缓存 TTL: 1 个月

# 规则 3: 强制 HTTPS
URL: *vibelife.app/*
设置:
  - 始终使用 HTTPS: 开启
```

### 5. 防火墙规则

```yaml
# 规则 1: 阻止恶意请求
表达式: (cf.threat_score gt 10)
操作: 质询 (Challenge)

# 规则 2: API 速率限制
表达式: (http.request.uri.path contains "/api/")
操作: 速率限制 (100 请求/分钟)

# 规则 3: 允许 Webhook
表达式: (http.request.uri.path eq "/api/v1/webhook/stripe")
操作: 允许
```

---

## 后端 API 部署 (vibelife 用户)

### 1. 后端服务配置

由 vibelife 用户管理后端服务:

```bash
# 切换到 vibelife 用户
su - vibelife

# 克隆项目
git clone https://github.com/aiscendtech/vibelife.git ~/vibelife

# 设置 Python 环境
cd ~/vibelife/apps/api
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt

# 配置环境变量
cat > .env << 'EOF'
# 数据库
VIBELIFE_DB_URL=postgresql://vibelife:password@localhost:8224/vibelife

# LLM
GLM_API_KEY=your_glm_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key
DEFAULT_LLM_PROVIDER=glm

# 嵌入模型
EMBEDDING_MODEL_NAME=BAAI/bge-m3
EMBEDDING_DIMENSION=1024

# 认证
CLERK_SECRET_KEY=sk_live_...

# 支付
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# 环境
ENVIRONMENT=production
LOG_LEVEL=INFO
CORS_ORIGINS=https://vibelife.app,https://bazi.vibelife.app,https://zodiac.vibelife.app
EOF
```

### 2. Systemd 服务

参考文档前面的 "vibelife 用户后端管理" 章节配置 systemd 服务。

---

## 上线检查清单

### 部署前检查

- [ ] **代码准备**
  - [ ] 所有 TypeScript 错误已修复 (`pnpm build` 成功)
  - [ ] 环境变量已配置 (production 密钥)
  - [ ] 敏感信息未提交到 Git

- [ ] **后端准备**
  - [ ] 数据库迁移已执行
  - [ ] API 健康检查通过 (`/health`)
  - [ ] LLM API 密钥有效
  - [ ] Stripe Webhook 已配置

- [ ] **前端准备**
  - [ ] Clerk 生产密钥已配置
  - [ ] API URL 指向生产环境
  - [ ] 静态资源已优化

### 部署后验证

```bash
#!/bin/bash
# 上线验证脚本

echo "=== VibeLife 上线验证 ==="

# 1. DNS 解析检查
echo "[DNS 检查]"
for domain in vibelife.app www.vibelife.app bazi.vibelife.app zodiac.vibelife.app api.vibelife.app; do
    IP=$(dig +short $domain)
    echo "  $domain -> $IP"
done

# 2. SSL 证书检查
echo "[SSL 检查]"
for domain in vibelife.app api.vibelife.app; do
    CERT=$(echo | openssl s_client -servername $domain -connect $domain:443 2>/dev/null | openssl x509 -noout -dates 2>/dev/null)
    echo "  $domain: $CERT"
done

# 3. HTTP 状态检查
echo "[HTTP 检查]"
for url in https://vibelife.app https://api.vibelife.app/health; do
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" $url)
    echo "  $url -> HTTP $STATUS"
done

# 4. API 功能检查
echo "[API 功能检查]"
HEALTH=$(curl -s https://api.vibelife.app/health)
echo "  Health: $HEALTH"

# 5. 前端渲染检查
echo "[前端检查]"
TITLE=$(curl -s https://vibelife.app | grep -o '<title>.*</title>')
echo "  Title: $TITLE"

echo "=== 验证完成 ==="
```

### 监控配置

- [ ] **Uptime 监控**
  - Vercel Analytics (内置)
  - Cloudflare Analytics (内置)
  - 或第三方: UptimeRobot / Better Uptime

- [ ] **错误监控**
  - Sentry (推荐)
  - LogRocket

- [ ] **性能监控**
  - Vercel Web Analytics
  - Google Analytics

---

## 成本估算

### Vercel 方案

| 项目 | 免费额度 | Pro 方案 ($20/月) |
|------|---------|------------------|
| 带宽 | 100GB/月 | 1TB/月 |
| 构建时长 | 100小时/月 | 400小时/月 |
| 函数执行 | 100GB-Hours | 1000GB-Hours |
| 自定义域名 | 无限 | 无限 |

### 阿里云香港方案

| 项目 | 规格 | 月费用 (约) |
|------|------|------------|
| ECS (4C8G) | ecs.c6.xlarge | ¥300-500 |
| 带宽 (5Mbps) | 按量付费 | ¥100-200 |
| 云盘 (100GB) | ESSD PL1 | ¥50 |
| **总计** | - | **¥450-750** |

### Cloudflare

| 项目 | 免费 | Pro ($20/月) |
|------|------|-------------|
| DNS | 无限 | 无限 |
| SSL | 通用证书 | 高级证书 |
| CDN | 无限 | 无限 |
| DDoS 防护 | 基础 | 高级 |
| Page Rules | 3 | 20 |

---

## 回滚方案

### Vercel 回滚

```bash
# 查看部署历史
vercel ls

# 回滚到指定部署
vercel rollback <deployment-url>

# 或在 Dashboard 操作
# Vercel Dashboard -> Deployments -> ... -> Promote to Production
```

### 阿里云回滚

```bash
# 1. 备份当前版本
cd /home/vibelife/vibelife
git stash
git tag backup-$(date +%Y%m%d%H%M%S)

# 2. 回滚到指定版本
git checkout <commit-hash>

# 3. 重新构建和部署
cd apps/web && pnpm build
sudo systemctl restart vibelife-web

# 4. 回滚后端
cd apps/api
sudo systemctl restart vibelife-api
```

---

## 常见问题

### Q: Vercel 和阿里云如何选择？

**选择 Vercel**:
- 面向全球用户
- 需要快速迭代
- 团队熟悉 Git 工作流
- 预算有限 (免费额度足够)

**选择阿里云**:
- 主要面向国内用户
- 需要前后端同一服务器
- 有数据合规要求
- 需要更多控制权

### Q: Cloudflare 代理模式的优缺点？

**优点**:
- 隐藏源站 IP
- 免费 SSL 和 DDoS 防护
- 全球 CDN 加速

**缺点**:
- WebSocket 需要额外配置
- 调试时需要 Development Mode
- 部分地区可能被屏蔽

### Q: 如何处理 API 跨域问题？

在后端 `main.py` 配置:

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://vibelife.app",
        "https://bazi.vibelife.app",
        "https://zodiac.vibelife.app",
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

如有问题，请联系技术支持：tech@aiscend.tech
