"use client";

/**
 * SkillProvider - 提供当前 skill 上下文
 *
 * 功能：
 * - 从 cookie 或 URL 参数中读取 skill
 * - 支持子域名模式: bazi.vibelife.app -> skill=bazi
 * - 集成 skillRegistry 提供完整 skill 配置
 * - 注入主题 CSS 变量
 */

import {
  createContext,
  useContext,
  useState,
  useEffect,
  useMemo,
  ReactNode,
} from "react";
import { type SkillType } from "@/components/core";
import { skillRegistry, getSkillConfig, getSkillPanels, getSkillTools } from "@/skills/registry";
import type { SkillId, SkillPlugin, PanelDefinition, ToolDefinition, SkillRegistry } from "@/skills/types";

// ═══════════════════════════════════════════════════════════════════════════
// Types
// ═══════════════════════════════════════════════════════════════════════════

interface SkillContextValue {
  // Current skill state
  skill: SkillType;
  setSkill: (skill: SkillType) => void;

  // Skill configuration from registry
  skillConfig: SkillPlugin | undefined;
  panels: PanelDefinition[];
  tools: ToolDefinition[];

  // Registry access
  registry: SkillRegistry;
}

const SkillContext = createContext<SkillContextValue | null>(null);

// ═══════════════════════════════════════════════════════════════════════════
// Hooks
// ═══════════════════════════════════════════════════════════════════════════

export function useSkill() {
  const context = useContext(SkillContext);
  if (!context) {
    throw new Error("useSkill must be used within SkillProvider");
  }
  return context;
}

// Convenience hooks
export function useSkillConfig() {
  const { skillConfig } = useSkill();
  return skillConfig;
}

export function useSkillPanels() {
  const { panels } = useSkill();
  return panels;
}

export function useSkillTools() {
  const { tools } = useSkill();
  return tools;
}

export function useSkillRegistry() {
  const { registry } = useSkill();
  return registry;
}

export function useCurrentSkill() {
  const { skill } = useSkill();
  return skill as SkillId;
}

// ═══════════════════════════════════════════════════════════════════════════
// Helper Functions
// ═══════════════════════════════════════════════════════════════════════════

const VALID_SKILLS: SkillType[] = ["bazi", "zodiac", "mbti", "attach", "career"];
const DEFAULT_SKILL: SkillType = "bazi";

function getCookie(name: string): string | undefined {
  if (typeof document === "undefined") return undefined;
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop()?.split(";").shift();
  return undefined;
}

function getSkillFromHostname(): SkillType | null {
  if (typeof window === "undefined") return null;

  const hostname = window.location.hostname;
  const parts = hostname.split(".");

  if (parts.length >= 2) {
    const subdomain = parts[0].toLowerCase() as SkillType;
    if (VALID_SKILLS.includes(subdomain)) {
      return subdomain;
    }
  }

  return null;
}

function getInitialSkill(): SkillType {
  // 1. 首先尝试从 hostname 获取
  const hostnameSkill = getSkillFromHostname();
  if (hostnameSkill) return hostnameSkill;

  // 2. 然后尝试从 cookie 获取
  const cookieSkill = getCookie("vibelife-skill") as SkillType | undefined;
  if (cookieSkill && VALID_SKILLS.includes(cookieSkill)) {
    return cookieSkill;
  }

  // 3. 默认
  return DEFAULT_SKILL;
}

// ═══════════════════════════════════════════════════════════════════════════
// Provider
// ═══════════════════════════════════════════════════════════════════════════

interface SkillProviderProps {
  children: ReactNode;
  /** 服务端传入的初始 skill（从 middleware headers 获取） */
  initialSkill?: SkillType;
}

export function SkillProvider({ children, initialSkill }: SkillProviderProps) {
  const [skill, setSkill] = useState<SkillType>(initialSkill || DEFAULT_SKILL);

  // 客户端 hydration 后更新
  useEffect(() => {
    if (!initialSkill) {
      setSkill(getInitialSkill());
    }
  }, [initialSkill]);

  // Get skill configuration from registry
  const skillConfig = useMemo(() => getSkillConfig(skill as SkillId), [skill]);
  const panels = useMemo(() => getSkillPanels(skill as SkillId), [skill]);
  const tools = useMemo(() => getSkillTools(skill as SkillId), [skill]);

  // Inject theme CSS variables
  useEffect(() => {
    if (!skillConfig?.theme) return;

    const root = document.documentElement;
    const { primary, secondary, glow, gradient } = skillConfig.theme;

    root.style.setProperty("--skill-primary", primary);
    root.style.setProperty("--skill-secondary", secondary);
    root.style.setProperty("--skill-glow", glow);
    root.style.setProperty("--skill-gradient", gradient);

    // Cleanup
    return () => {
      root.style.removeProperty("--skill-primary");
      root.style.removeProperty("--skill-secondary");
      root.style.removeProperty("--skill-glow");
      root.style.removeProperty("--skill-gradient");
    };
  }, [skillConfig]);

  const contextValue: SkillContextValue = useMemo(
    () => ({
      skill,
      setSkill,
      skillConfig,
      panels,
      tools,
      registry: skillRegistry,
    }),
    [skill, skillConfig, panels, tools]
  );

  return (
    <SkillContext.Provider value={contextValue}>
      {children}
    </SkillContext.Provider>
  );
}
