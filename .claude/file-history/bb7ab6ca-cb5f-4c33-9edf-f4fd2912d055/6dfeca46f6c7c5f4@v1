"""
Notification API Routes
"""
from typing import Optional
from uuid import UUID
from fastapi import APIRouter, Depends, HTTPException, Query

from stores.db import get_db
from services.reminder.notification import NotificationService
from services.identity import get_current_user, get_optional_user, CurrentUser

router = APIRouter(prefix="/notifications", tags=["notifications"])


def get_notification_service():
    return NotificationService()


@router.get("")
async def get_notifications(
    user_id: Optional[UUID] = Query(None, description="User ID (optional if authenticated)"),
    limit: int = Query(50, ge=1, le=100),
    svc: NotificationService = Depends(get_notification_service),
    current_user: Optional[CurrentUser] = Depends(get_optional_user),
):
    """Get user notifications. Uses authenticated user if user_id not provided."""
    # 优先使用认证用户的ID
    effective_user_id = user_id
    if not effective_user_id and current_user:
        effective_user_id = current_user.user_id

    if not effective_user_id:
        raise HTTPException(status_code=401, detail="Authentication required")

    result = await svc.get_all(effective_user_id, limit)
    # 确保返回格式与前端期望一致
    if isinstance(result, dict):
        return result
    return {"items": result, "unread_count": len([n for n in result if not n.get("is_read", True)])}


@router.get("/unread")
async def get_unread_notifications(
    user_id: Optional[UUID] = Query(None),
    limit: int = Query(20, ge=1, le=100),
    svc: NotificationService = Depends(get_notification_service),
    current_user: Optional[CurrentUser] = Depends(get_optional_user),
):
    """Get unread notifications"""
    effective_user_id = user_id
    if not effective_user_id and current_user:
        effective_user_id = current_user.user_id

    if not effective_user_id:
        raise HTTPException(status_code=401, detail="Authentication required")

    return await svc.get_unread(effective_user_id, limit)


@router.post("/{notification_id}/read")
async def mark_notification_read(
    notification_id: UUID,
    svc: NotificationService = Depends(get_notification_service),
):
    """Mark notification as read"""
    success = await svc.mark_read(notification_id)
    if not success:
        raise HTTPException(status_code=404, detail="Notification not found")
    return {"success": True}


@router.get("/daily")
async def get_today_daily(
    user_id: Optional[UUID] = Query(None),
    svc: NotificationService = Depends(get_notification_service),
    current_user: Optional[CurrentUser] = Depends(get_optional_user),
):
    """Get today's daily fortune"""
    effective_user_id = user_id
    if not effective_user_id and current_user:
        effective_user_id = current_user.user_id

    if not effective_user_id:
        raise HTTPException(status_code=401, detail="Authentication required")

    result = await svc.get_today_daily(effective_user_id)
    if not result:
        raise HTTPException(status_code=404, detail="No daily fortune for today")
    return result
