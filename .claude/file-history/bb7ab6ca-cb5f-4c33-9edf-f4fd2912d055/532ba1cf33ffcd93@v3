"""
CoreAgent 集成测试
测试 CoreAgent + SkillLoader + SOPEngine 的集成

v6 架构:
- SkillLoader: 技能/场景加载
- SOPEngine: SOP 流程控制
- ToolRegistry: 工具注册与执行
"""
import pytest
from pathlib import Path
from unittest.mock import AsyncMock, MagicMock, patch
import sys

sys.path.insert(0, str(Path(__file__).parent.parent))

from services.agent.core import CoreAgent, AgentContext
from services.agent.skill_loader import load_skill, build_system_prompt
from services.agent.sop_engine import SOPAction, check_sop_requirements


# ═══════════════════════════════════════════════════════════════════════════
# Mock 数据
# ═══════════════════════════════════════════════════════════════════════════

MOCK_PROFILE_COMPLETE = {
    "basic": {"name": "测试用户"},
    "birth_info": {
        "date": "1990-05-15",
        "time": "14:30",
        "location": "北京"
    }
}

MOCK_PROFILE_NO_BIRTH = {
    "basic": {"name": "测试用户"}
}

MOCK_BAZI_DATA = {
    "bazi": {
        "chart": {
            "year": {"gan": "庚", "zhi": "午"},
            "month": {"gan": "辛", "zhi": "巳"},
            "day": {"gan": "甲", "zhi": "子"},
            "hour": {"gan": "壬", "zhi": "申"}
        }
    }
}


# ═══════════════════════════════════════════════════════════════════════════
# SkillLoader 集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestSkillLoaderIntegration:
    """测试 SkillLoader 与 CoreAgent 的集成"""

    def test_core_skill_load(self):
        """Core Skill 加载"""
        core_skill = load_skill("core")
        # core skill 存在即可
        if core_skill:
            assert core_skill.name is not None or core_skill.id is not None

    def test_bazi_skill_activation(self):
        """激活 bazi skill"""
        prompt = build_system_prompt("bazi")
        bazi_skill = load_skill("bazi")
        if bazi_skill:
            assert len(prompt) > 0

    def test_multi_skill_fusion(self):
        """多 Skill 融合"""
        # build_system_prompt 可接受单个 skill_id
        prompt_bazi = build_system_prompt("bazi")
        prompt_zodiac = build_system_prompt("zodiac")
        assert isinstance(prompt_bazi, str)
        assert isinstance(prompt_zodiac, str)

    def test_build_system_prompt_with_scenario(self):
        """带场景的 system prompt"""
        from services.agent.skill_loader import get_skill_scenarios
        scenarios = get_skill_scenarios("bazi")
        if scenarios:
            prompt = build_system_prompt("bazi", scenario_id=scenarios[0])
            assert isinstance(prompt, str)
            assert len(prompt) > 0


# ═══════════════════════════════════════════════════════════════════════════
# SOPEngine 集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestSOPEngineIntegration:
    """测试 SOPEngine 与 CoreAgent 的集成"""

    def test_sop_collect_triggers_form(self):
        """P1 触发表单收集"""
        action, context = check_sop_requirements(
            skill_id="bazi",
            profile=MOCK_PROFILE_NO_BIRTH,
            skill_data={},
            message="看看我的命盘"
        )
        assert action == SOPAction.NEED_INFO

    def test_sop_compute_triggers_calc(self):
        """P2 触发计算"""
        action, context = check_sop_requirements(
            skill_id="bazi",
            profile=MOCK_PROFILE_COMPLETE,
            skill_data={},
            message="分析我的命盘"
        )
        assert action == SOPAction.NEED_COMPUTE

    def test_sop_llm_free_after_p2(self):
        """P2 后 LLM 自由"""
        action, context = check_sop_requirements(
            skill_id="bazi",
            profile=MOCK_PROFILE_COMPLETE,
            skill_data=MOCK_BAZI_DATA,
            message="分析我的事业运"
        )
        assert action == SOPAction.READY_FOR_LLM


# ═══════════════════════════════════════════════════════════════════════════
# CoreAgent Mock 测试
# ═══════════════════════════════════════════════════════════════════════════

class TestCoreAgentWithMockLLM:
    """使用 Mock LLM 测试 CoreAgent"""

    @pytest.fixture
    def mock_llm(self):
        """创建 Mock LLM"""
        llm = MagicMock()
        llm.usage = {"input_tokens": 0, "output_tokens": 0}

        async def mock_stream(*args, **kwargs):
            yield {"type": "content", "content": "这是测试回复"}
            yield {"type": "done"}

        llm.stream = mock_stream
        return llm

    @pytest.fixture
    def agent(self, mock_llm):
        """创建带 Mock LLM 的 Agent"""
        return CoreAgent(llm=mock_llm)

    def test_agent_context_creation(self):
        """测试 AgentContext 创建"""
        context = AgentContext(
            user_id="test_user",
            profile=MOCK_PROFILE_COMPLETE,
            skill="bazi"
        )
        assert context.user_id == "test_user"
        assert context.skill == "bazi"
        assert context.profile == MOCK_PROFILE_COMPLETE

    def test_agent_creation(self, agent):
        """测试 Agent 创建"""
        assert agent is not None
        assert agent.llm is not None


# ═══════════════════════════════════════════════════════════════════════════
# 工具系统集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestToolSystemIntegration:
    """测试工具系统集成"""

    def test_tool_registry_initialization(self):
        """ToolRegistry 初始化"""
        from services.agent.tool_registry import ToolRegistry
        ToolRegistry.initialize()
        assert ToolRegistry._initialized is True

    def test_tools_available_for_bazi(self):
        """八字工具可用"""
        from services.agent.tool_registry import ToolRegistry
        ToolRegistry.initialize()
        tools = ToolRegistry.get_tools_for_skill("bazi")
        assert isinstance(tools, list)

    def test_tools_have_openai_format(self):
        """工具有 OpenAI 格式"""
        from services.agent.tool_registry import ToolRegistry
        ToolRegistry.initialize()
        tools = ToolRegistry.get_all_tools()
        for tool in tools:
            if isinstance(tool, dict):
                assert "type" in tool or "function" in tool


# ═══════════════════════════════════════════════════════════════════════════
# SOP 流程集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestSOPFlowIntegration:
    """测试完整 SOP 流程"""

    def test_new_user_bazi_flow(self):
        """新用户首次八字流程：P1 → P2 → P3-P6"""
        # Step 1: 无出生信息，需要收集
        action1, _ = check_sop_requirements(
            skill_id="bazi",
            profile={},
            skill_data={},
            message="看命盘"
        )
        assert action1 == SOPAction.NEED_INFO

        # Step 2: 有出生信息，需要计算
        action2, _ = check_sop_requirements(
            skill_id="bazi",
            profile=MOCK_PROFILE_COMPLETE,
            skill_data={},
            message="看命盘"
        )
        assert action2 == SOPAction.NEED_COMPUTE

        # Step 3: 有命盘，交给 LLM
        action3, _ = check_sop_requirements(
            skill_id="bazi",
            profile=MOCK_PROFILE_COMPLETE,
            skill_data=MOCK_BAZI_DATA,
            message="分析事业"
        )
        assert action3 == SOPAction.READY_FOR_LLM

    def test_returning_user_bazi_flow(self):
        """老用户再次八字流程：直接 P3-P6"""
        action, context = check_sop_requirements(
            skill_id="bazi",
            profile=MOCK_PROFILE_COMPLETE,
            skill_data=MOCK_BAZI_DATA,
            message="看看我今年的运势"
        )
        assert action == SOPAction.READY_FOR_LLM
        assert context.get("has_chart") is True or "has_chart" not in context

    def test_synastry_missing_partner_flow(self):
        """合盘缺对方信息流程"""
        action, _ = check_sop_requirements(
            skill_id="zodiac",
            profile={},  # 无出生信息
            skill_data={},
            message="我和他合适吗"
        )
        assert action == SOPAction.NEED_INFO


# ═══════════════════════════════════════════════════════════════════════════
# 边界情况测试
# ═══════════════════════════════════════════════════════════════════════════

class TestEdgeCases:
    """测试边界情况"""

    def test_unknown_skill_fallback(self):
        """未知 Skill 降级处理"""
        action, _ = check_sop_requirements(
            skill_id="unknown_skill",
            profile={},
            skill_data={},
            message="测试"
        )
        # 未知 skill 应该直接交给 LLM
        assert action == SOPAction.READY_FOR_LLM

    def test_empty_message(self):
        """空消息处理"""
        action, _ = check_sop_requirements(
            skill_id="bazi",
            profile=MOCK_PROFILE_COMPLETE,
            skill_data=MOCK_BAZI_DATA,
            message=""
        )
        assert action == SOPAction.READY_FOR_LLM

    def test_career_skill_no_birth_required(self):
        """Career Skill 不需要出生信息"""
        action, _ = check_sop_requirements(
            skill_id="career",
            profile={},
            skill_data={},
            message="我适合什么工作"
        )
        assert action == SOPAction.READY_FOR_LLM

    def test_tarot_skill_needs_compute(self):
        """Tarot Skill 需要抽牌（计算）"""
        action, _ = check_sop_requirements(
            skill_id="tarot",
            profile={},
            skill_data={},
            message="帮我抽一张牌"
        )
        assert action == SOPAction.NEED_COMPUTE


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
