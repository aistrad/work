"""
SkillLoader v6 单元测试
测试 Skill 加载、System Prompt 构建

v6 架构:
- SKILL.md: 核心定义（专家身份、场景目录、伦理边界）
- 简化的加载接口
"""
import pytest
from pathlib import Path

import sys
sys.path.insert(0, str(Path(__file__).parent.parent))

from services.agent.skill_loader import (
    SkillConfig, parse_frontmatter, load_skill,
    get_available_skills, get_skill_triggers,
    build_system_prompt, clear_cache
)


class TestParseFrontmatter:
    """测试 YAML frontmatter 解析"""

    def test_parse_basic_frontmatter(self):
        """测试基本 frontmatter 解析"""
        text = """---
name: test
description: Test skill
---

# Content here"""
        metadata, content = parse_frontmatter(text)
        assert metadata["name"] == "test"
        assert metadata["description"] == "Test skill"
        assert "# Content here" in content

    def test_parse_boolean_values(self):
        """测试布尔值解析"""
        text = """---
auto_collect: true
requires_birth_info: false
---
Content"""
        metadata, content = parse_frontmatter(text)
        assert metadata["auto_collect"] is True
        assert metadata["requires_birth_info"] is False

    def test_parse_list_values(self):
        """测试列表值解析"""
        text = """---
triggers:
  - 八字
  - 命理
  - 生辰
---
Content"""
        metadata, content = parse_frontmatter(text)
        assert metadata["triggers"] == ["八字", "命理", "生辰"]

    def test_no_frontmatter(self):
        """测试无 frontmatter 的情况"""
        text = "# Just content\nNo frontmatter here"
        metadata, content = parse_frontmatter(text)
        assert metadata == {}
        assert "# Just content" in content


class TestLoadSkill:
    """测试 Skill 加载"""

    def test_load_bazi_skill(self):
        """测试加载八字技能"""
        skill = load_skill("bazi")
        if skill:
            assert skill.name is not None or skill.id is not None

    def test_load_core_skill(self):
        """测试加载核心技能"""
        skill = load_skill("core")
        if skill:
            # core skill 存在即可
            assert skill.name is not None or skill.id is not None

    def test_load_nonexistent_skill(self):
        """测试加载不存在的技能"""
        skill = load_skill("nonexistent_skill_xyz")
        assert skill is None

    def test_skill_config_attributes(self):
        """测试技能配置属性"""
        skill = load_skill("bazi")
        if skill:
            # 检查 SkillConfig 的属性
            assert hasattr(skill, 'id') or hasattr(skill, 'name')


class TestGetAvailableSkills:
    """测试获取可用技能"""

    def test_get_available_skills_returns_list(self):
        """测试返回技能列表"""
        skills = get_available_skills()
        assert isinstance(skills, list)

    def test_get_available_skills_has_expected(self):
        """测试包含预期技能"""
        skills = get_available_skills()
        # 应该至少有一些技能
        assert len(skills) >= 0


class TestGetSkillTriggers:
    """测试获取技能触发词"""

    def test_get_skill_triggers_format(self):
        """测试触发词格式"""
        triggers = get_skill_triggers()
        assert isinstance(triggers, dict)
        # 每个技能应该有触发词列表
        for skill_id, trigger_list in triggers.items():
            assert isinstance(trigger_list, list)


class TestBuildSystemPrompt:
    """测试 System Prompt 构建"""

    def test_build_single_skill_prompt(self):
        """测试单技能 prompt"""
        prompt = build_system_prompt("bazi")
        assert isinstance(prompt, str)
        assert len(prompt) > 0

    def test_build_prompt_includes_content(self):
        """测试 prompt 包含内容"""
        skill = load_skill("bazi")
        if skill:
            prompt = build_system_prompt("bazi")
            # prompt 应该有内容
            assert len(prompt) > 0


class TestClearCache:
    """测试缓存清理"""

    def test_clear_cache_no_error(self):
        """测试清理缓存不报错"""
        # 先加载一些内容到缓存
        load_skill("bazi")

        # 清理缓存应该不报错
        clear_cache()

        # 再次加载应该正常工作
        skill = load_skill("bazi")
        # 只要不报错就行


class TestSkillConfig:
    """测试 SkillConfig 数据类"""

    def test_skill_config_creation(self):
        """测试 SkillConfig 创建"""
        config = SkillConfig(
            id="test",
            name="Test",
            description="Test skill",
            expert_persona="You are a test expert",
            scenarios={"entry": ["basic"], "standard": [], "professional": []},
            ethics={"forbidden": [], "sensitive": [], "principles": []},
            tools=["test_tool"]
        )
        assert config.id == "test"
        assert config.name == "Test"


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
