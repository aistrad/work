"""
V6 CoreAgent 单元测试
测试 use_skill、search_db 等工具的处理逻辑
"""
import pytest
from unittest.mock import AsyncMock, MagicMock, patch
from dataclasses import dataclass
from typing import Dict, Any, List

# 导入被测模块
from services.agent.core import CoreAgent, AgentContext, USE_SKILL_TOOL
from services.agent.tools import (
    SHARED_TOOLS, SKILL_TOOLS, ToolRegistry,
    SEARCH_DB_TOOL, ASK_USER_QUESTION_TOOL, SHOW_SERVICE_MENU_TOOL,
    get_tools_for_scenario
)


class TestUSESkillTool:
    """测试 USE_SKILL_TOOL 定义"""

    def test_use_skill_tool_structure(self):
        """验证 USE_SKILL_TOOL 包含必要参数"""
        assert USE_SKILL_TOOL["type"] == "function"
        params = USE_SKILL_TOOL["function"]["parameters"]
        required = params["required"]

        # V6: 必须包含 skill, scenario, confidence
        assert "skill" in required
        assert "scenario" in required
        assert "confidence" in required

    def test_use_skill_tool_skill_enum(self):
        """验证 skill 参数的枚举值"""
        props = USE_SKILL_TOOL["function"]["parameters"]["properties"]
        skill_enum = props["skill"]["enum"]

        assert "bazi" in skill_enum
        assert "zodiac" in skill_enum
        assert "career" in skill_enum
        assert "tarot" in skill_enum

    def test_use_skill_tool_confidence_enum(self):
        """验证 confidence 参数的枚举值"""
        props = USE_SKILL_TOOL["function"]["parameters"]["properties"]
        confidence_enum = props["confidence"]["enum"]

        assert "high" in confidence_enum
        assert "medium" in confidence_enum
        assert "low" in confidence_enum


class TestToolsRegistration:
    """测试工具注册"""

    def test_shared_tools_contains_v6_tools(self):
        """验证 SHARED_TOOLS 包含 V6 全局工具"""
        tool_names = [t["function"]["name"] for t in SHARED_TOOLS]

        assert "search_db" in tool_names
        assert "ask_user_question" in tool_names
        assert "show_service_menu" in tool_names

    def test_skill_tools_structure(self):
        """验证 SKILL_TOOLS 包含各 skill 的工具"""
        assert "bazi" in SKILL_TOOLS
        assert "zodiac" in SKILL_TOOLS
        assert "career" in SKILL_TOOLS
        assert "tarot" in SKILL_TOOLS

    def test_bazi_skill_tools(self):
        """验证 bazi skill 的工具"""
        bazi_tool_names = [t["function"]["name"] for t in SKILL_TOOLS["bazi"]]

        assert "collect_bazi_info" in bazi_tool_names
        assert "calculate_bazi" in bazi_tool_names
        assert "show_bazi_chart" in bazi_tool_names

    def test_get_tools_for_skill(self):
        """测试 ToolRegistry.get_tools_for_skill"""
        tools = ToolRegistry.get_tools_for_skill("bazi")
        tool_names = [t["function"]["name"] for t in tools]

        # 应包含共享工具
        assert "search_db" in tool_names
        # 应包含 bazi 专属工具
        assert "show_bazi_chart" in tool_names

    def test_get_tools_for_scenario(self):
        """测试 get_tools_for_scenario"""
        tools = get_tools_for_scenario("bazi", "career")
        assert len(tools) > 0

        tool_names = [t["function"]["name"] for t in tools]
        assert "search_db" in tool_names


class TestSearchDbTool:
    """测试 SEARCH_DB_TOOL 定义"""

    def test_search_db_tool_structure(self):
        """验证 SEARCH_DB_TOOL 结构"""
        assert SEARCH_DB_TOOL["type"] == "function"
        params = SEARCH_DB_TOOL["function"]["parameters"]
        required = params["required"]

        assert "table" in required
        assert "query" in required

    def test_search_db_tool_table_enum(self):
        """验证 table 参数的枚举值"""
        props = SEARCH_DB_TOOL["function"]["parameters"]["properties"]
        table_enum = props["table"]["enum"]

        assert "knowledge_chunks" in table_enum
        assert "cases" in table_enum


class TestAskUserQuestionTool:
    """测试 ASK_USER_QUESTION_TOOL 定义"""

    def test_ask_user_question_tool_structure(self):
        """验证 ASK_USER_QUESTION_TOOL 结构"""
        assert ASK_USER_QUESTION_TOOL["type"] == "function"
        params = ASK_USER_QUESTION_TOOL["function"]["parameters"]
        required = params["required"]

        assert "question" in required

    def test_ask_user_question_has_options(self):
        """验证包含 options 参数"""
        props = ASK_USER_QUESTION_TOOL["function"]["parameters"]["properties"]
        assert "options" in props
        assert props["options"]["type"] == "array"


@pytest.mark.asyncio
class TestCoreAgentHandleUseSkill:
    """测试 CoreAgent._handle_use_skill"""

    @pytest.fixture
    def mock_llm(self):
        """Mock LLM 客户端"""
        llm = MagicMock()
        llm.usage = {"input_tokens": 0, "output_tokens": 0}
        return llm

    @pytest.fixture
    def mock_knowledge_repo(self):
        """Mock 知识库"""
        repo = AsyncMock()
        repo.search_db = AsyncMock(return_value=[])
        repo.search_knowledge = AsyncMock(return_value=[])
        repo.match_cases = AsyncMock(return_value=[])
        return repo

    @pytest.fixture
    def agent(self, mock_llm, mock_knowledge_repo):
        """创建测试 Agent"""
        agent = CoreAgent(llm=mock_llm, knowledge_repo=mock_knowledge_repo)
        return agent

    async def test_use_skill_high_confidence(self, agent):
        """测试高置信度激活"""
        context = AgentContext(
            user_id="test_user",
            profile={"birth_info": {"date": "1990-01-01"}}
        )

        args = {
            "skill": "bazi",
            "scenario": "career",
            "confidence": "high",
            "topic": "career"
        }

        result = await agent._handle_use_skill(args, context)

        assert result["status"] == "activated"
        assert result["skill"] == "bazi"
        assert result["scenario"] == "career"
        assert agent._active_skill == "bazi"
        assert agent._active_scenario == "career"

    async def test_use_skill_low_confidence(self, agent):
        """测试低置信度需要确认"""
        context = AgentContext(user_id="test_user")

        args = {
            "skill": "bazi",
            "scenario": "career",
            "confidence": "low"
        }

        result = await agent._handle_use_skill(args, context)

        assert result["status"] == "need_confirm"
        assert "确认" in result["message"]

    async def test_use_skill_needs_birth_info(self, agent):
        """测试需要出生信息"""
        context = AgentContext(
            user_id="test_user",
            profile=None  # 无 profile
        )

        args = {
            "skill": "bazi",
            "scenario": "career",
            "confidence": "high"
        }

        result = await agent._handle_use_skill(args, context)

        assert result["status"] == "need_info"
        assert result["info_type"] == "birth"

    async def test_use_skill_career_no_birth_needed(self, agent):
        """测试 career skill 不需要出生信息"""
        context = AgentContext(
            user_id="test_user",
            profile=None
        )

        args = {
            "skill": "career",
            "scenario": "direction",
            "confidence": "high"
        }

        result = await agent._handle_use_skill(args, context)

        assert result["status"] == "activated"
        assert result["skill"] == "career"

    async def test_use_skill_with_birth_provided(self, agent):
        """测试消息中已包含出生信息"""
        context = AgentContext(
            user_id="test_user",
            profile=None
        )

        args = {
            "skill": "bazi",
            "scenario": "career",
            "confidence": "high",
            "birth_info_provided": True
        }

        result = await agent._handle_use_skill(args, context)

        assert result["status"] == "activated"


@pytest.mark.asyncio
class TestCoreAgentHandleSearchDb:
    """测试 CoreAgent._handle_search_db"""

    @pytest.fixture
    def mock_llm(self):
        llm = MagicMock()
        llm.usage = {"input_tokens": 0, "output_tokens": 0}
        return llm

    @pytest.fixture
    def mock_knowledge_repo(self):
        repo = AsyncMock()
        repo.search_db = AsyncMock(return_value=[
            {"id": "1", "text": "测试知识", "score": 0.9},
            {"id": "2", "text": "测试知识2", "score": 0.8}
        ])
        return repo

    @pytest.fixture
    def agent(self, mock_llm, mock_knowledge_repo):
        agent = CoreAgent(llm=mock_llm, knowledge_repo=mock_knowledge_repo)
        agent._active_skill = "bazi"
        agent._active_scenario = "career"
        return agent

    async def test_search_db_knowledge(self, agent):
        """测试知识检索"""
        context = AgentContext(user_id="test_user")

        args = {
            "table": "knowledge_chunks",
            "query": "日主",
            "top_k": 5
        }

        result = await agent._handle_search_db(args, context)

        assert result["status"] == "success"
        assert result["table"] == "knowledge_chunks"
        assert result["count"] == 2
        assert len(result["results"]) == 2

    async def test_search_db_auto_inject_skill_id(self, agent, mock_knowledge_repo):
        """测试自动注入 skill_id"""
        context = AgentContext(user_id="test_user")

        args = {
            "table": "knowledge_chunks",
            "query": "测试"
        }

        await agent._handle_search_db(args, context)

        # 验证调用时包含 skill_id
        call_args = mock_knowledge_repo.search_db.call_args
        filters = call_args.kwargs.get("filters") or call_args[1].get("filters")
        assert filters["skill_id"] == "bazi"


@pytest.mark.asyncio
class TestCoreAgentExecuteTool:
    """测试 CoreAgent._execute_tool"""

    @pytest.fixture
    def mock_llm(self):
        llm = MagicMock()
        llm.usage = {"input_tokens": 0, "output_tokens": 0}
        return llm

    @pytest.fixture
    def mock_knowledge_repo(self):
        repo = AsyncMock()
        repo.search_db = AsyncMock(return_value=[])
        return repo

    @pytest.fixture
    def agent(self, mock_llm, mock_knowledge_repo):
        return CoreAgent(llm=mock_llm, knowledge_repo=mock_knowledge_repo)

    async def test_execute_ask_user_question(self, agent):
        """测试 ask_user_question 工具执行"""
        context = AgentContext(user_id="test_user")

        tool_args = '{"question": "您想了解哪方面？", "options": ["事业", "感情", "财运"]}'

        result = await agent._execute_tool("ask_user_question", tool_args, context)

        assert result["status"] == "question"
        assert result["question"] == "您想了解哪方面？"
        assert len(result["options"]) == 3

    async def test_execute_unknown_tool(self, agent):
        """测试未知工具"""
        context = AgentContext(user_id="test_user")

        result = await agent._execute_tool("unknown_tool", "{}", context)

        assert result["status"] == "unknown_tool"


class TestToolCardMapping:
    """测试工具-卡片映射"""

    def test_get_card_type_bazi_chart(self):
        """测试 show_bazi_chart 的卡片类型"""
        card_type = ToolRegistry.get_card_type("show_bazi_chart")
        assert card_type == "bazi_chart"

    def test_get_card_type_ask_user_question(self):
        """测试 ask_user_question 的卡片类型"""
        card_type = ToolRegistry.get_card_type("ask_user_question")
        assert card_type == "question_card"

    def test_get_card_type_search_db(self):
        """测试 search_db 无卡片类型"""
        card_type = ToolRegistry.get_card_type("search_db")
        assert card_type is None

    def test_get_card_type_unknown(self):
        """测试未知工具"""
        card_type = ToolRegistry.get_card_type("unknown_tool")
        assert card_type is None
