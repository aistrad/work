"""
SkillLoader v6 å•å…ƒæµ‹è¯•
æµ‹è¯• Scenario è·¯ç”±ã€Skill åŠ è½½ã€System Prompt æž„å»º

v6 æž¶æž„:
- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€åœºæ™¯ç›®å½•ã€ä¼¦ç†è¾¹ç•Œï¼‰
- scenarios/*.md: MiniSkill åœºæ™¯æ–‡ä»¶
- tools/*.py: å·¥å…·å®šä¹‰
"""
import pytest
from pathlib import Path

import sys
sys.path.insert(0, str(Path(__file__).parent.parent))

from services.agent.skill_loader import (
    SkillConfig, ScenarioConfig, ToolMetadata, ServiceItem,
    parse_frontmatter, parse_skill_md, parse_scenario_md, parse_skill_services,
    load_skill, load_scenario, get_available_skills, get_skill_scenarios,
    get_skill_triggers, get_skill_services, build_system_prompt,
    route_scenario, clear_cache, SKILLS_DIR
)


class TestParseFrontmatter:
    """æµ‹è¯• YAML frontmatter è§£æž"""

    def test_parse_basic_frontmatter(self):
        """æµ‹è¯•åŸºæœ¬ frontmatter è§£æž"""
        text = """---
name: test
description: Test skill
---

# Content here"""
        metadata, content = parse_frontmatter(text)
        assert metadata["name"] == "test"
        assert metadata["description"] == "Test skill"
        assert "# Content here" in content

    def test_parse_boolean_values(self):
        """æµ‹è¯•å¸ƒå°”å€¼è§£æž"""
        text = """---
auto_collect: true
requires_birth_info: false
---
Content"""
        metadata, content = parse_frontmatter(text)
        assert metadata["auto_collect"] is True
        assert metadata["requires_birth_info"] is False

    def test_parse_list_values(self):
        """æµ‹è¯•åˆ—è¡¨å€¼è§£æž"""
        text = """---
triggers:
  - å…«å­—
  - å‘½ç†
  - ç”Ÿè¾°
---
Content"""
        metadata, content = parse_frontmatter(text)
        assert metadata["triggers"] == ["å…«å­—", "å‘½ç†", "ç”Ÿè¾°"]

    def test_no_frontmatter(self):
        """æµ‹è¯•æ—  frontmatter çš„æƒ…å†µ"""
        text = "# Just content\nNo frontmatter here"
        metadata, content = parse_frontmatter(text)
        assert metadata == {}
        assert "# Just content" in content


class TestParseSkillMd:
    """æµ‹è¯• SKILL.md è§£æž"""

    def test_parse_skill_md_structure(self):
        """æµ‹è¯• SKILL.md è§£æžç»“æž„"""
        text = """---
id: test_skill
name: æµ‹è¯•æŠ€èƒ½
description: æµ‹è¯•ç”¨æŠ€èƒ½
triggers:
  - æµ‹è¯•
  - è¯•éªŒ
default_scenario: basic_test
---

## ä¸“å®¶èº«ä»½

ä½ æ˜¯ä¸€ä½æµ‹è¯•ä¸“å®¶ã€‚

## åœºæ™¯ç›®å½•

### Entry

| åœºæ™¯ | æ–‡ä»¶å | æè¿° |
|------|--------|------|
| åŸºç¡€æµ‹è¯• | basic_test | åŸºç¡€åŠŸèƒ½æµ‹è¯• |

## ä¼¦ç†è¾¹ç•Œ

### ç»å¯¹ç¦æ­¢

- å±é™©æ“ä½œ
- æ¶æ„è¡Œä¸º

## å·¥å…·åˆ—è¡¨

| å·¥å…·å | ç±»åž‹ | æè¿° |
|--------|------|------|
| test_tool | display | æµ‹è¯•å·¥å…· |
"""
        result = parse_skill_md(text)

        assert result["id"] == "test_skill"
        assert result["name"] == "æµ‹è¯•æŠ€èƒ½"
        assert "æµ‹è¯•ä¸“å®¶" in result["expert_persona"]
        assert result["default_scenario"] == "basic_test"
        assert "å±é™©æ“ä½œ" in result["ethics"]["forbidden"]


class TestLoadSkill:
    """æµ‹è¯• Skill åŠ è½½"""

    def test_load_bazi_skill(self):
        """æµ‹è¯•åŠ è½½å…«å­—æŠ€èƒ½"""
        skill = load_skill("bazi")
        if skill:
            assert skill.id == "bazi"
            assert skill.name is not None
            assert len(skill.expert_persona) > 0

    def test_load_core_skill(self):
        """æµ‹è¯•åŠ è½½æ ¸å¿ƒæŠ€èƒ½"""
        skill = load_skill("core")
        if skill:
            # core skill å­˜åœ¨å³å¯ï¼Œid å¯èƒ½ä¸ºç©ºï¼ˆå–å†³äºŽ SKILL.md é…ç½®ï¼‰
            assert skill.name is not None or skill.id is not None

    def test_load_nonexistent_skill(self):
        """æµ‹è¯•åŠ è½½ä¸å­˜åœ¨çš„æŠ€èƒ½"""
        skill = load_skill("nonexistent_skill_xyz")
        assert skill is None

    def test_skill_has_scenarios(self):
        """æµ‹è¯•æŠ€èƒ½åŒ…å«åœºæ™¯"""
        skill = load_skill("bazi")
        if skill:
            assert isinstance(skill.scenarios, dict)
            # è‡³å°‘æœ‰ä¸€ä¸ªå±‚çº§æœ‰åœºæ™¯
            has_scenarios = any(len(v) > 0 for v in skill.scenarios.values())
            assert has_scenarios or skill.scenarios == {}


class TestLoadScenario:
    """æµ‹è¯• Scenario åŠ è½½"""

    def test_load_existing_scenario(self):
        """æµ‹è¯•åŠ è½½å­˜åœ¨çš„åœºæ™¯"""
        # èŽ·å–æŠ€èƒ½çš„åœºæ™¯åˆ—è¡¨
        scenarios = get_skill_scenarios("bazi")
        if scenarios:
            scenario = load_scenario("bazi", scenarios[0])
            if scenario:
                assert scenario.id == scenarios[0]
                assert scenario.name is not None

    def test_load_nonexistent_scenario(self):
        """æµ‹è¯•åŠ è½½ä¸å­˜åœ¨çš„åœºæ™¯"""
        scenario = load_scenario("bazi", "nonexistent_scenario_xyz")
        assert scenario is None


class TestGetAvailableSkills:
    """æµ‹è¯•èŽ·å–å¯ç”¨æŠ€èƒ½"""

    def test_get_available_skills_returns_list(self):
        """æµ‹è¯•è¿”å›žæŠ€èƒ½åˆ—è¡¨"""
        skills = get_available_skills()
        assert isinstance(skills, list)

    def test_get_available_skills_has_expected(self):
        """æµ‹è¯•åŒ…å«é¢„æœŸæŠ€èƒ½"""
        skills = get_available_skills()
        # åº”è¯¥è‡³å°‘æœ‰ä¸€äº›æŠ€èƒ½
        assert len(skills) > 0


class TestGetSkillScenarios:
    """æµ‹è¯•èŽ·å–æŠ€èƒ½åœºæ™¯"""

    def test_get_bazi_scenarios(self):
        """æµ‹è¯•èŽ·å–å…«å­—åœºæ™¯"""
        scenarios = get_skill_scenarios("bazi")
        assert isinstance(scenarios, list)

    def test_get_nonexistent_skill_scenarios(self):
        """æµ‹è¯•èŽ·å–ä¸å­˜åœ¨æŠ€èƒ½çš„åœºæ™¯"""
        scenarios = get_skill_scenarios("nonexistent_skill_xyz")
        assert scenarios == []


class TestGetSkillTriggers:
    """æµ‹è¯•èŽ·å–æŠ€èƒ½è§¦å‘è¯"""

    def test_get_skill_triggers_format(self):
        """æµ‹è¯•è§¦å‘è¯æ ¼å¼"""
        triggers = get_skill_triggers()
        assert isinstance(triggers, dict)
        # æ¯ä¸ªæŠ€èƒ½åº”è¯¥æœ‰è§¦å‘è¯åˆ—è¡¨
        for skill_id, trigger_list in triggers.items():
            assert isinstance(trigger_list, list)


class TestGetSkillServices:
    """æµ‹è¯•èŽ·å–æŠ€èƒ½æœåŠ¡"""

    def test_get_bazi_services(self):
        """æµ‹è¯•èŽ·å–å…«å­—æœåŠ¡"""
        services = get_skill_services("bazi")
        if services:
            assert isinstance(services, dict)
            # åº”è¯¥æœ‰æœåŠ¡å±‚çº§
            assert "services" in services or "entry" in services or len(services) > 0


class TestBuildSystemPrompt:
    """æµ‹è¯• System Prompt æž„å»º"""

    def test_build_single_skill_prompt(self):
        """æµ‹è¯•å•æŠ€èƒ½ prompt"""
        prompt = build_system_prompt("bazi")
        assert isinstance(prompt, str)
        assert len(prompt) > 0

    def test_build_prompt_with_scenario(self):
        """æµ‹è¯•å¸¦åœºæ™¯çš„ prompt"""
        scenarios = get_skill_scenarios("bazi")
        if scenarios:
            prompt = build_system_prompt("bazi", scenario_id=scenarios[0])
            assert isinstance(prompt, str)

    def test_build_prompt_includes_persona(self):
        """æµ‹è¯• prompt åŒ…å«ä¸“å®¶èº«ä»½"""
        skill = load_skill("bazi")
        if skill and skill.expert_persona:
            prompt = build_system_prompt("bazi")
            # ä¸“å®¶èº«ä»½åº”è¯¥å‡ºçŽ°åœ¨ prompt ä¸­
            assert len(prompt) > 0


class TestRouteScenario:
    """æµ‹è¯•åœºæ™¯è·¯ç”±"""

    def test_route_with_trigger(self):
        """æµ‹è¯•ä½¿ç”¨è§¦å‘è¯è·¯ç”±"""
        # èŽ·å–æŸä¸ªåœºæ™¯çš„è§¦å‘è¯
        triggers = get_skill_triggers()
        if "bazi" in triggers and triggers["bazi"]:
            result = route_scenario("bazi", triggers["bazi"][0])
            # å¯èƒ½è¿”å›žåŒ¹é…çš„åœºæ™¯æˆ– None
            assert result is None or isinstance(result, str)

    def test_route_with_random_text(self):
        """æµ‹è¯•éšæœºæ–‡æœ¬è·¯ç”±"""
        result = route_scenario("bazi", "éšæœºçš„æµ‹è¯•æ–‡æœ¬ä¸åº”è¯¥åŒ¹é…ä»»ä½•åœºæ™¯")
        # å¯èƒ½è¿”å›žé»˜è®¤åœºæ™¯æˆ– None
        assert result is None or isinstance(result, str)


class TestClearCache:
    """æµ‹è¯•ç¼“å­˜æ¸…ç†"""

    def test_clear_cache_no_error(self):
        """æµ‹è¯•æ¸…ç†ç¼“å­˜ä¸æŠ¥é”™"""
        # å…ˆåŠ è½½ä¸€äº›å†…å®¹åˆ°ç¼“å­˜
        load_skill("bazi")

        # æ¸…ç†ç¼“å­˜åº”è¯¥ä¸æŠ¥é”™
        clear_cache()

        # å†æ¬¡åŠ è½½åº”è¯¥æ­£å¸¸å·¥ä½œ
        skill = load_skill("bazi")
        if SKILLS_DIR.exists():
            # å¦‚æžœæŠ€èƒ½ç›®å½•å­˜åœ¨ï¼Œåº”è¯¥èƒ½åŠ è½½
            pass


class TestDataClasses:
    """æµ‹è¯•æ•°æ®ç±»"""

    def test_skill_config_creation(self):
        """æµ‹è¯• SkillConfig åˆ›å»º"""
        config = SkillConfig(
            id="test",
            name="Test",
            description="Test skill",
            expert_persona="You are a test expert",
            scenarios={"entry": ["basic"], "standard": [], "professional": []},
            ethics={"forbidden": [], "sensitive": [], "principles": []},
            tools=["test_tool"]
        )
        assert config.id == "test"
        assert config.name == "Test"

    def test_scenario_config_creation(self):
        """æµ‹è¯• ScenarioConfig åˆ›å»º"""
        config = ScenarioConfig(
            id="basic_test",
            name="åŸºç¡€æµ‹è¯•",
            level="entry",
            billing="free",
            description="åŸºç¡€æµ‹è¯•åœºæ™¯",
            triggers={"primary": ["æµ‹è¯•"], "secondary": []},
            prerequisites=[],
            sop=[{"phase": 1, "name": "å¼€å§‹", "content": "å¼€å§‹æµ‹è¯•"}],
            knowledge_config={},
            output_config={},
            tools=["test_tool"]
        )
        assert config.id == "basic_test"
        assert config.level == "entry"

    def test_tool_metadata_creation(self):
        """æµ‹è¯• ToolMetadata åˆ›å»º"""
        metadata = ToolMetadata(
            name="show_chart",
            description="æ˜¾ç¤ºå›¾è¡¨",
            tool_type="display",
            card_type="chart_card"
        )
        assert metadata.name == "show_chart"
        assert metadata.tool_type == "display"

    def test_service_item_creation(self):
        """æµ‹è¯• ServiceItem åˆ›å»º"""
        item = ServiceItem(
            scenario_id="basic_reading",
            name="åŸºç¡€è§£è¯»",
            icon="ðŸ“–",
            description="åŸºç¡€å‘½ç›˜è§£è¯»",
            tier="entry",
            billing="å…è´¹",
            highlights=["å¿«é€Ÿ", "å‡†ç¡®"]
        )
        assert item.scenario_id == "basic_reading"
        assert item.tier == "entry"
        assert len(item.highlights) == 2


class TestParseScenarioMd:
    """æµ‹è¯• Scenario.md è§£æž"""

    def test_parse_scenario_basic(self):
        """æµ‹è¯•åŸºæœ¬åœºæ™¯è§£æž"""
        text = """---
id: basic_reading
name: åŸºç¡€è§£è¯»
level: entry
billing: free
description: åŸºç¡€å‘½ç›˜è§£è¯»
---

## è§¦å‘æ¡ä»¶

**ä¸»è¦è§¦å‘è¯**: çœ‹å‘½ç›˜, åŸºç¡€åˆ†æž
**æ¬¡è¦è§¦å‘è¯**: å¸®æˆ‘çœ‹çœ‹, åˆ†æžä¸€ä¸‹

## å‰ç½®è¦æ±‚

- å‡ºç”Ÿæ—¥æœŸ
- å‡ºç”Ÿæ—¶é—´

### Phase 1: æ”¶é›†ä¿¡æ¯

**ç±»åž‹**: collect

æ”¶é›†ç”¨æˆ·çš„å‡ºç”Ÿä¿¡æ¯ã€‚

### Phase 2: åˆ†æž

**ç±»åž‹**: analyze

åˆ†æžå‘½ç›˜ä¿¡æ¯ã€‚
"""
        result = parse_scenario_md(text)

        assert result["id"] == "basic_reading"
        assert result["name"] == "åŸºç¡€è§£è¯»"
        assert result["level"] == "entry"
        assert "çœ‹å‘½ç›˜" in result["triggers"]["primary"]
        assert "å‡ºç”Ÿæ—¥æœŸ" in result["prerequisites"]
        assert len(result["sop"]) == 2


class TestParseSkillServices:
    """æµ‹è¯•æœåŠ¡ç›®å½•è§£æž"""

    def test_parse_skill_services_table(self):
        """æµ‹è¯•æœåŠ¡ç›®å½•è¡¨æ ¼è§£æž"""
        text = """
## åœºæ™¯ç›®å½•

### Entry

| åœºæ™¯ | æ–‡ä»¶å | æè¿° | è®¡è´¹ |
|------|--------|------|------|
| åŸºç¡€è§£è¯» | basic_reading | åŸºç¡€å‘½ç›˜è§£è¯» | å…è´¹ |
| å¿«é€Ÿåˆ†æž | quick_analysis | å¿«é€Ÿå‘½ç›˜åˆ†æž | å…è´¹ |

### Standard

| åœºæ™¯ | æ–‡ä»¶å | æè¿° | è®¡è´¹ |
|------|--------|------|------|
| æ·±åº¦åˆ†æž | deep_analysis | æ·±åº¦å‘½ç›˜åˆ†æž | åŸºç¡€ |
"""
        result = parse_skill_services(text)

        assert isinstance(result, dict)
        # åº”è¯¥æœ‰ entry æˆ– standard å±‚çº§
        assert "entry" in result or "standard" in result or len(result) >= 0


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
