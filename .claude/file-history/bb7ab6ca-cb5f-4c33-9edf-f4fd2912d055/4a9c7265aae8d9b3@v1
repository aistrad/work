"""
VibeLife Report Service Tests
Tests for Report Generation, Sections, and Serialization
Based on: vibelife spec v3.0, section 4.6
"""

import pytest
from uuid import uuid4
from datetime import datetime
from unittest.mock import AsyncMock, MagicMock, patch

from services.report.report_service import (
    ReportService,
    Report,
    ReportSection,
    ReportType,
    ReportStatus,
    ReportSkill,
    BAZI_SECTIONS,
    ZODIAC_SECTIONS,
    get_report_service,
)


class TestReportEnums:
    """Test Report enums"""

    def test_report_type_values(self):
        assert ReportType.LITE.value == "lite"
        assert ReportType.FULL.value == "full"

    def test_report_status_values(self):
        assert ReportStatus.PENDING.value == "pending"
        assert ReportStatus.GENERATING.value == "generating"
        assert ReportStatus.COMPLETED.value == "completed"
        assert ReportStatus.FAILED.value == "failed"

    def test_report_skill_values(self):
        assert ReportSkill.BAZI.value == "bazi"
        assert ReportSkill.ZODIAC.value == "zodiac"


class TestReportSections:
    """Test report section definitions"""

    def test_bazi_sections_exist(self):
        assert len(BAZI_SECTIONS) >= 4
        section_ids = [s[0] for s in BAZI_SECTIONS]
        assert "chart_structure" in section_ids
        assert "personality" in section_ids
        assert "fortune" in section_ids
        assert "action" in section_ids

    def test_zodiac_sections_exist(self):
        assert len(ZODIAC_SECTIONS) >= 4
        section_ids = [s[0] for s in ZODIAC_SECTIONS]
        assert "chart_structure" in section_ids
        assert "personality" in section_ids
        assert "cycle" in section_ids
        assert "action" in section_ids

    def test_section_structure(self):
        for section in BAZI_SECTIONS:
            assert len(section) == 3  # id, title, subtitle
            assert isinstance(section[0], str)
            assert isinstance(section[1], str)
            assert isinstance(section[2], str)


class TestReportSection:
    """Test ReportSection dataclass"""

    def test_create_section(self):
        section = ReportSection(
            id="test",
            title="测试标题",
            subtitle="测试副标题",
            content="测试内容",
        )
        assert section.id == "test"
        assert section.score is None
        assert section.highlights == []
        assert section.is_premium is False

    def test_section_with_all_fields(self):
        section = ReportSection(
            id="test",
            title="测试标题",
            subtitle="测试副标题",
            content="测试内容",
            score=85,
            highlights=["洞察1", "洞察2"],
            is_premium=True,
        )
        assert section.score == 85
        assert len(section.highlights) == 2
        assert section.is_premium is True

    def test_section_to_dict(self):
        section = ReportSection(
            id="test",
            title="测试",
            subtitle="副标题",
            content="内容",
            score=75,
        )
        data = section.to_dict()
        assert data["id"] == "test"
        assert data["title"] == "测试"
        assert data["score"] == 75


class TestReport:
    """Test Report dataclass"""

    def test_create_report(self):
        report_id = uuid4()
        user_id = uuid4()
        report = Report(
            id=report_id,
            user_id=user_id,
            skill=ReportSkill.BAZI,
            report_type=ReportType.LITE,
            status=ReportStatus.PENDING,
            prologue="测试卷首语",
        )
        assert report.id == report_id
        assert report.skill == ReportSkill.BAZI
        assert report.prologue == "测试卷首语"
        assert report.sections == []

    def test_report_to_dict(self):
        report_id = uuid4()
        user_id = uuid4()
        report = Report(
            id=report_id,
            user_id=user_id,
            skill=ReportSkill.BAZI,
            report_type=ReportType.FULL,
            status=ReportStatus.COMPLETED,
            prologue="卷首语",
            sections=[
                ReportSection(id="s1", title="标题1", subtitle="副标题1", content="内容1"),
            ],
        )
        data = report.to_dict()
        assert data["id"] == str(report_id)
        assert data["skill"] == "bazi"
        assert data["report_type"] == "full"
        assert data["status"] == "completed"
        assert len(data["sections"]) == 1

    def test_report_to_lite_dict_hides_premium(self):
        report = Report(
            id=uuid4(),
            user_id=uuid4(),
            skill=ReportSkill.BAZI,
            report_type=ReportType.LITE,
            status=ReportStatus.COMPLETED,
            prologue="卷首语",
            sections=[
                ReportSection(id="s1", title="免费章节", subtitle="副标题", content="可见内容", is_premium=False),
                ReportSection(id="s2", title="付费章节", subtitle="副标题", content="隐藏内容", is_premium=True),
            ],
        )
        lite_data = report.to_lite_dict()

        # Prologue should always be visible
        assert lite_data["prologue"] == "卷首语"

        # Free section should be visible
        assert lite_data["sections"][0]["content"] == "可见内容"

        # Premium section should be hidden
        assert lite_data["sections"][1]["content"] == "..."
        assert lite_data["sections"][1]["locked"] is True

    def test_report_to_lite_dict_hides_poster(self):
        report = Report(
            id=uuid4(),
            user_id=uuid4(),
            skill=ReportSkill.BAZI,
            report_type=ReportType.LITE,
            status=ReportStatus.COMPLETED,
            prologue="卷首语",
            poster_url="https://example.com/poster.png",
            poster_thumbnail_url="https://example.com/thumb.png",
        )
        lite_data = report.to_lite_dict()
        assert lite_data["poster_url"] is None
        assert lite_data["poster_thumbnail_url"] == "https://example.com/thumb.png"


class TestReportService:
    """Test ReportService"""

    def setup_method(self):
        self.service = ReportService()

    def test_get_sections_for_bazi(self):
        sections = self.service.get_sections_for_skill("bazi")
        assert sections == BAZI_SECTIONS

    def test_get_sections_for_zodiac(self):
        sections = self.service.get_sections_for_skill("zodiac")
        assert sections == ZODIAC_SECTIONS


class TestReportGeneration:
    """Test report generation - basic tests only"""

    def setup_method(self):
        self.service = ReportService()

    def test_service_initialization(self):
        assert self.service is not None

    def test_get_sections_returns_correct_skill(self):
        bazi_sections = self.service.get_sections_for_skill("bazi")
        zodiac_sections = self.service.get_sections_for_skill("zodiac")
        assert bazi_sections == BAZI_SECTIONS
        assert zodiac_sections == ZODIAC_SECTIONS


class TestSectionGeneration:
    """Test section generation - basic tests only"""

    def test_section_creation(self):
        section = ReportSection(
            id="test",
            title="测试标题",
            subtitle="测试副标题",
            content="测试内容",
            score=80,
            highlights=["洞察1", "洞察2"],
        )
        assert section.id == "test"
        assert section.score == 80
        assert len(section.highlights) == 2


class TestReportUpgrade:
    """Test report upgrade functionality"""

    def setup_method(self):
        self.service = ReportService()

    @pytest.mark.asyncio
    async def test_upgrade_report_raises_on_not_found(self):
        """测试升级不存在的报告时抛出错误"""
        with pytest.raises(ValueError):
            await self.service.upgrade_report(
                report_id=uuid4(),
                user_id=uuid4(),
            )


class TestGlobalInstance:
    """Test global report service instance"""

    def test_get_report_service_singleton(self):
        import services.report.report_service as module
        module._report_service = None

        service1 = get_report_service()
        service2 = get_report_service()
        assert service1 is service2


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
