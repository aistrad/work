"""
Health Check Routes 测试
测试健康检查端点

覆盖端点:
- GET /health - 完整健康检查
- GET /health/live - Kubernetes liveness probe
- GET /health/ready - Kubernetes readiness probe
"""

import pytest
from unittest.mock import AsyncMock, MagicMock, patch

pytestmark = pytest.mark.asyncio


# ═══════════════════════════════════════════════════════════════════════════
# Health Check Endpoint Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestHealthCheckEndpoint:
    """完整健康检查端点测试"""

    async def test_health_check_all_ok(self, client):
        """测试所有服务正常时的健康检查"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_pool = MagicMock()
            mock_conn = MagicMock()
            mock_conn.fetchval = AsyncMock(return_value=1)
            mock_pool.acquire = MagicMock(return_value=AsyncMock(
                __aenter__=AsyncMock(return_value=mock_conn),
                __aexit__=AsyncMock(return_value=None)
            ))
            mock_get_db.return_value = mock_pool

            response = await client.get("/health")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "ok"
        assert data["service"] == "vibelife-api"
        assert data["version"] == "1.0.0"
        assert data["database"] == "ok"

    async def test_health_check_db_error(self, client):
        """测试数据库连接失败时的健康检查"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_get_db.side_effect = Exception("Connection refused")

            response = await client.get("/health")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "degraded"
        assert "error" in data["database"]

    async def test_health_check_db_query_error(self, client):
        """测试数据库查询失败时的健康检查"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_pool = MagicMock()
            mock_conn = MagicMock()
            mock_conn.fetchval = AsyncMock(side_effect=Exception("Query timeout"))
            mock_pool.acquire = MagicMock(return_value=AsyncMock(
                __aenter__=AsyncMock(return_value=mock_conn),
                __aexit__=AsyncMock(return_value=None)
            ))
            mock_get_db.return_value = mock_pool

            response = await client.get("/health")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "degraded"
        assert "Query timeout" in data["database"]


# ═══════════════════════════════════════════════════════════════════════════
# Liveness Probe Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestLivenessProbe:
    """Kubernetes Liveness Probe 测试"""

    async def test_liveness_probe_success(self, client):
        """测试 liveness 探针返回存活状态"""
        response = await client.get("/health/live")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "alive"

    async def test_liveness_probe_no_db_check(self, client):
        """测试 liveness 探针不检查数据库"""
        # Liveness 不应该依赖数据库，即使数据库挂了也应该返回 alive
        with patch("routes.health.get_db") as mock_get_db:
            mock_get_db.side_effect = Exception("DB down")

            response = await client.get("/health/live")

        # 即使 patch 了 get_db，liveness 也不应该调用它
        assert response.status_code == 200
        assert response.json()["status"] == "alive"


# ═══════════════════════════════════════════════════════════════════════════
# Readiness Probe Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestReadinessProbe:
    """Kubernetes Readiness Probe 测试"""

    async def test_readiness_probe_ready(self, client):
        """测试服务就绪时的 readiness 探针"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_pool = MagicMock()
            mock_conn = MagicMock()
            mock_conn.fetchval = AsyncMock(return_value=1)
            mock_pool.acquire = MagicMock(return_value=AsyncMock(
                __aenter__=AsyncMock(return_value=mock_conn),
                __aexit__=AsyncMock(return_value=None)
            ))
            mock_get_db.return_value = mock_pool

            response = await client.get("/health/ready")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "ready"

    async def test_readiness_probe_not_ready_db_error(self, client):
        """测试数据库不可用时的 readiness 探针"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_get_db.side_effect = Exception("Connection refused")

            response = await client.get("/health/ready")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "not_ready"

    async def test_readiness_probe_not_ready_query_fail(self, client):
        """测试数据库查询失败时的 readiness 探针"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_pool = MagicMock()
            mock_conn = MagicMock()
            mock_conn.fetchval = AsyncMock(side_effect=Exception("Query failed"))
            mock_pool.acquire = MagicMock(return_value=AsyncMock(
                __aenter__=AsyncMock(return_value=mock_conn),
                __aexit__=AsyncMock(return_value=None)
            ))
            mock_get_db.return_value = mock_pool

            response = await client.get("/health/ready")

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "not_ready"


# ═══════════════════════════════════════════════════════════════════════════
# Response Format Tests
# ═══════════════════════════════════════════════════════════════════════════

class TestHealthResponseFormat:
    """健康检查响应格式测试"""

    async def test_health_response_contains_required_fields(self, client):
        """测试健康检查响应包含所有必需字段"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_pool = MagicMock()
            mock_conn = MagicMock()
            mock_conn.fetchval = AsyncMock(return_value=1)
            mock_pool.acquire = MagicMock(return_value=AsyncMock(
                __aenter__=AsyncMock(return_value=mock_conn),
                __aexit__=AsyncMock(return_value=None)
            ))
            mock_get_db.return_value = mock_pool

            response = await client.get("/health")

        data = response.json()
        required_fields = ["status", "service", "version", "database"]
        for field in required_fields:
            assert field in data, f"Missing required field: {field}"

    async def test_liveness_response_minimal(self, client):
        """测试 liveness 响应只包含状态"""
        response = await client.get("/health/live")

        data = response.json()
        assert "status" in data
        # Liveness 应该返回最小响应
        assert len(data) == 1

    async def test_readiness_response_minimal(self, client):
        """测试 readiness 响应只包含状态"""
        with patch("routes.health.get_db") as mock_get_db:
            mock_pool = MagicMock()
            mock_conn = MagicMock()
            mock_conn.fetchval = AsyncMock(return_value=1)
            mock_pool.acquire = MagicMock(return_value=AsyncMock(
                __aenter__=AsyncMock(return_value=mock_conn),
                __aexit__=AsyncMock(return_value=None)
            ))
            mock_get_db.return_value = mock_pool

            response = await client.get("/health/ready")

        data = response.json()
        assert "status" in data
        assert len(data) == 1
