"""
V6 集成测试
测试 Skill Service、Tool Registry、Agent 之间的协作

v6 架构:
- SkillServiceRegistry: 服务注册与调用
- ToolRegistry: 工具注册与执行
- CoreAgent: 核心 Agent 逻辑
"""
import pytest
from unittest.mock import AsyncMock, MagicMock, patch

pytestmark = pytest.mark.asyncio


# ═══════════════════════════════════════════════════════════════════════════
# ToolRegistry 集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestToolRegistryIntegration:
    """测试 ToolRegistry 集成"""

    def test_registry_initializes_handlers(self):
        """测试注册表初始化时加载处理器"""
        from services.agent.tool_registry import ToolRegistry
        import services.agent.global_handlers  # noqa: F401

        ToolRegistry.initialize()

        # 应该有已注册的处理器
        assert len(ToolRegistry._handlers) >= 0

    def test_registry_tools_match_handlers(self):
        """测试注册的工具与处理器匹配"""
        from services.agent.tool_registry import ToolRegistry

        ToolRegistry.initialize()
        tools = ToolRegistry.get_all_tools()

        for tool in tools:
            if isinstance(tool, dict) and "function" in tool:
                tool_name = tool["function"]["name"]
                # display 类型工具应该有处理器
                if tool.get("tool_type") == "display":
                    has_handler = ToolRegistry.has_handler(tool_name)
                    # 处理器可能存在也可能不存在，取决于配置
                    assert isinstance(has_handler, bool)


# ═══════════════════════════════════════════════════════════════════════════
# SkillServiceRegistry 集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestSkillServiceRegistryIntegration:
    """测试 SkillServiceRegistry 集成"""

    def test_registry_initialization(self):
        """测试服务注册表初始化"""
        from services.agent.skill_service_registry import SkillServiceRegistry

        SkillServiceRegistry.initialize()

        assert SkillServiceRegistry._initialized is True

    def test_list_skills(self):
        """测试列出可用技能"""
        from services.agent.skill_service_registry import SkillServiceRegistry

        SkillServiceRegistry.initialize()
        skills = SkillServiceRegistry.list_skills()

        assert isinstance(skills, list)

    def test_list_services_for_skill(self):
        """测试列出技能服务"""
        from services.agent.skill_service_registry import SkillServiceRegistry

        SkillServiceRegistry.initialize()
        services = SkillServiceRegistry.list_services("bazi")

        assert isinstance(services, list)

    def test_has_service(self):
        """测试检查服务存在"""
        from services.agent.skill_service_registry import SkillServiceRegistry

        SkillServiceRegistry.initialize()
        has = SkillServiceRegistry.has_service("bazi", "chart")

        assert isinstance(has, bool)

    def test_get_service(self):
        """测试获取服务"""
        from services.agent.skill_service_registry import SkillServiceRegistry

        SkillServiceRegistry.initialize()
        service = SkillServiceRegistry.get_service("bazi", "chart")

        # 可能返回 None 或服务对象
        assert service is None or service is not None


# ═══════════════════════════════════════════════════════════════════════════
# CoreAgent 集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestCoreAgentIntegration:
    """测试 CoreAgent 集成"""

    @pytest.fixture
    def mock_llm(self):
        """Mock LLM"""
        llm = MagicMock()
        llm.usage = {"input_tokens": 0, "output_tokens": 0}
        return llm

    def test_agent_with_tool_registry(self, mock_llm):
        """测试 Agent 与 ToolRegistry 协作"""
        from services.agent.core import CoreAgent
        from services.agent.tool_registry import ToolRegistry

        ToolRegistry.initialize()
        agent = CoreAgent(llm=mock_llm)

        # Agent 应该能获取工具
        tools = ToolRegistry.get_all_tools()
        assert isinstance(tools, list)

    def test_agent_with_service_registry(self, mock_llm):
        """测试 Agent 与 ServiceRegistry 协作"""
        from services.agent.core import CoreAgent
        from services.agent.skill_service_registry import SkillServiceRegistry

        SkillServiceRegistry.initialize()
        agent = CoreAgent(llm=mock_llm)

        # 应该能访问服务列表
        skills = SkillServiceRegistry.list_skills()
        assert isinstance(skills, list)


# ═══════════════════════════════════════════════════════════════════════════
# Skill Loader 集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestSkillLoaderIntegration:
    """测试 SkillLoader 集成"""

    def test_load_skill_with_scenarios(self):
        """测试加载带场景的技能"""
        from services.agent.skill_loader import load_skill, get_skill_scenarios

        skill = load_skill("bazi")
        if skill:
            scenarios = get_skill_scenarios("bazi")
            assert isinstance(scenarios, list)

    def test_build_system_prompt_with_skill(self):
        """测试构建系统提示词"""
        from services.agent.skill_loader import build_system_prompt

        prompt = build_system_prompt("bazi")
        assert isinstance(prompt, str)
        assert len(prompt) > 0


# ═══════════════════════════════════════════════════════════════════════════
# 端到端集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestEndToEndIntegration:
    """端到端集成测试"""

    def test_full_initialization_sequence(self):
        """测试完整初始化流程"""
        from services.agent.tool_registry import ToolRegistry
        from services.agent.skill_service_registry import SkillServiceRegistry
        import services.agent.global_handlers  # noqa: F401

        # 1. 初始化 ToolRegistry
        ToolRegistry.initialize()
        assert ToolRegistry._initialized is True

        # 2. 初始化 SkillServiceRegistry
        SkillServiceRegistry.initialize()
        assert SkillServiceRegistry._initialized is True

        # 3. 验证工具可用
        tools = ToolRegistry.get_all_tools()
        assert isinstance(tools, list)

        # 4. 验证服务可用
        skills = SkillServiceRegistry.list_skills()
        assert isinstance(skills, list)

    def test_tool_and_service_consistency(self):
        """测试工具和服务一致性"""
        from services.agent.tool_registry import ToolRegistry
        from services.agent.skill_service_registry import SkillServiceRegistry
        import services.agent.global_handlers  # noqa: F401

        ToolRegistry.initialize()
        SkillServiceRegistry.initialize()

        # 每个 skill 应该有对应的工具
        skills = SkillServiceRegistry.list_skills()

        for skill_id in skills:
            tools = ToolRegistry.get_tools_for_skill(skill_id)
            assert isinstance(tools, list)


# ═══════════════════════════════════════════════════════════════════════════
# 错误处理集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestErrorHandlingIntegration:
    """错误处理集成测试"""

    def test_nonexistent_skill_handling(self):
        """测试不存在的技能处理"""
        from services.agent.tool_registry import ToolRegistry
        from services.agent.skill_service_registry import SkillServiceRegistry

        ToolRegistry.initialize()
        SkillServiceRegistry.initialize()

        # 不存在的技能应该返回空列表
        tools = ToolRegistry.get_tools_for_skill("nonexistent_skill_xyz")
        assert tools == [] or isinstance(tools, list)

        services = SkillServiceRegistry.list_services("nonexistent_skill_xyz")
        assert services == [] or isinstance(services, list)

    def test_nonexistent_tool_handling(self):
        """测试不存在的工具处理"""
        from services.agent.tool_registry import ToolRegistry

        ToolRegistry.initialize()

        # 不存在的工具应该返回 None
        card_type = ToolRegistry.get_card_type("nonexistent_tool_xyz")
        assert card_type is None

        has_handler = ToolRegistry.has_handler("nonexistent_tool_xyz")
        assert has_handler is False


# ═══════════════════════════════════════════════════════════════════════════
# 性能集成测试
# ═══════════════════════════════════════════════════════════════════════════

class TestPerformanceIntegration:
    """性能集成测试"""

    def test_multiple_initializations_idempotent(self):
        """测试多次初始化幂等"""
        from services.agent.tool_registry import ToolRegistry
        import services.agent.global_handlers  # noqa: F401

        # 多次初始化不应该有问题
        ToolRegistry.initialize()
        first_tools = ToolRegistry.get_all_tools()

        ToolRegistry.initialize()
        second_tools = ToolRegistry.get_all_tools()

        assert len(first_tools) == len(second_tools)

    def test_schema_caching(self):
        """测试 Schema 缓存"""
        from services.agent.tool_registry import ToolRegistry

        ToolRegistry.initialize()

        # 多次获取应该返回相同结果
        schema1 = ToolRegistry.get_schema()
        schema2 = ToolRegistry.get_schema()

        assert schema1["version"] == schema2["version"]
        assert len(schema1["tools"]) == len(schema2["tools"])
