"""
VibeLife Vibe Engine Tests
Tests for Context Builder, Voice Mode, Topic Classification, and Profile Selection
Based on: vibelife spec v3.0, architecture-decisions.md
"""

import pytest
from uuid import uuid4

from services.vibe_engine.context import (
    ContextBuilder,
    ContextConfig,
    VoiceMode,
    Skill,
    get_context_builder,
    VIBE_PERSONA_BASE,
    BAZI_SKILL_CONTEXT,
    ZODIAC_SKILL_CONTEXT,
)


class TestVoiceModeAndSkill:
    """Test VoiceMode and Skill enums"""

    def test_voice_mode_values(self):
        assert VoiceMode.WARM.value == "warm"
        assert VoiceMode.SARCASTIC.value == "sarcastic"

    def test_skill_values(self):
        assert Skill.BAZI.value == "bazi"
        assert Skill.ZODIAC.value == "zodiac"


class TestSystemPromptBuilding:
    """Test system prompt construction"""

    def setup_method(self):
        self.builder = ContextBuilder()

    def test_bazi_warm_prompt(self):
        prompt = self.builder.build_system_prompt(Skill.BAZI, VoiceMode.WARM)
        assert "Vibe 人设" in prompt
        assert "八字命理" in prompt
        assert "暖心闺蜜" in prompt
        assert "毒舌损友" not in prompt

    def test_bazi_sarcastic_prompt(self):
        prompt = self.builder.build_system_prompt(Skill.BAZI, VoiceMode.SARCASTIC)
        assert "Vibe 人设" in prompt
        assert "八字命理" in prompt
        assert "毒舌损友" in prompt
        assert "暖心闺蜜" not in prompt

    def test_zodiac_warm_prompt(self):
        prompt = self.builder.build_system_prompt(Skill.ZODIAC, VoiceMode.WARM)
        assert "Vibe 人设" in prompt
        assert "星座占星" in prompt
        assert "暖心闺蜜" in prompt

    def test_extra_context_included(self):
        extra = "用户是VIP会员"
        prompt = self.builder.build_system_prompt(Skill.BAZI, VoiceMode.WARM, extra)
        assert "额外上下文" in prompt
        assert extra in prompt


class TestProfileFormatting:
    """Test profile context formatting"""

    def setup_method(self):
        self.builder = ContextBuilder()

    def test_format_profile_context(self):
        profile = {
            "basic": {"gender": "male", "day_master": "甲"},
            "career": {"status": "employed"},
        }
        formatted = self.builder.format_profile_context(profile)
        assert "<user_profile>" in formatted
        assert "</user_profile>" in formatted
        assert "gender: male" in formatted
        assert "day_master: 甲" in formatted

    def test_format_empty_profile(self):
        formatted = self.builder.format_profile_context({})
        assert formatted == ""

    def test_format_list_values(self):
        profile = {"traits": ["独立", "创新", "敏感"]}
        formatted = self.builder.format_profile_context(profile)
        assert "独立" in formatted
        assert "创新" in formatted


class TestKnowledgeFormatting:
    """Test knowledge context formatting"""

    def setup_method(self):
        self.builder = ContextBuilder()

    def test_format_knowledge_chunks(self):
        chunks = [
            {"content": "甲木代表参天大树", "category": "八字基础"},
            {"content": "日主是命盘的核心", "category": "八字基础"},
        ]
        formatted = self.builder.format_knowledge_context(chunks)
        assert "<knowledge>" in formatted
        assert "</knowledge>" in formatted
        assert "甲木代表参天大树" in formatted
        assert "[八字基础]" in formatted

    def test_format_empty_knowledge(self):
        formatted = self.builder.format_knowledge_context([])
        assert formatted == ""


class TestHistoryFormatting:
    """Test conversation history formatting"""

    def setup_method(self):
        self.builder = ContextBuilder()

    def test_format_history_messages(self):
        history = [
            {"role": "user", "content": "你好"},
            {"role": "assistant", "content": "你好呀！"},
            {"role": "user", "content": "帮我看看命盘"},
        ]
        formatted = self.builder.format_history(history)
        assert len(formatted) == 3
        assert formatted[0].role == "user"
        assert formatted[1].role == "assistant"

    def test_history_truncation(self):
        history = [{"role": "user", "content": f"消息{i}"} for i in range(30)]
        formatted = self.builder.format_history(history, max_messages=10)
        assert len(formatted) == 10
        # Should keep most recent
        assert "消息29" in formatted[-1].content

    def test_empty_history(self):
        formatted = self.builder.format_history([])
        assert formatted == []


class TestContextBuilding:
    """Test complete context building"""

    def setup_method(self):
        self.builder = ContextBuilder()

    @pytest.mark.asyncio
    async def test_build_basic_context(self):
        system_prompt, messages = await self.builder.build(
            skill=Skill.BAZI,
            voice_mode=VoiceMode.WARM,
            current_message="帮我看看命盘",
            profile=None,
            history=None,
        )
        assert "Vibe 人设" in system_prompt
        assert len(messages) >= 2  # system + user
        assert messages[-1].content == "帮我看看命盘"

    @pytest.mark.asyncio
    async def test_build_with_profile(self):
        profile = {
            "basic": {"day_master": "甲"},
            "life_context": {"career": {"status": "employed"}},
        }
        system_prompt, messages = await self.builder.build(
            skill=Skill.BAZI,
            voice_mode=VoiceMode.WARM,
            current_message="工作方面怎么样",
            profile=profile,
        )
        # 检查 profile 被注入到 system prompt
        assert "<user_profile>" in system_prompt
        # 检查 career 信息在 profile 中
        assert "career" in system_prompt or "employed" in system_prompt

    @pytest.mark.asyncio
    async def test_build_with_knowledge(self):
        knowledge = [{"content": "甲木特质", "category": "八字"}]
        system_prompt, messages = await self.builder.build(
            skill=Skill.BAZI,
            voice_mode=VoiceMode.WARM,
            current_message="我是甲木日主",
            knowledge_chunks=knowledge,
        )
        assert "<knowledge>" in system_prompt
        assert "甲木特质" in system_prompt

    @pytest.mark.asyncio
    async def test_build_with_history(self):
        history = [
            {"role": "user", "content": "你好"},
            {"role": "assistant", "content": "你好呀"},
        ]
        system_prompt, messages = await self.builder.build(
            skill=Skill.BAZI,
            voice_mode=VoiceMode.WARM,
            current_message="帮我看看",
            history=history,
        )
        # system + 2 history + current
        assert len(messages) == 4


class TestContextConfig:
    """Test context configuration"""

    def test_default_config(self):
        config = ContextConfig()
        assert config.max_history_messages == 20
        assert config.token_budget == 8000

    def test_custom_config(self):
        config = ContextConfig(max_history_messages=10, token_budget=4000)
        builder = ContextBuilder(config)
        assert builder.config.max_history_messages == 10
        assert builder.config.token_budget == 4000


class TestGlobalInstance:
    """Test global context builder instance"""

    def test_get_context_builder_singleton(self):
        builder1 = get_context_builder()
        builder2 = get_context_builder()
        assert builder1 is builder2


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
