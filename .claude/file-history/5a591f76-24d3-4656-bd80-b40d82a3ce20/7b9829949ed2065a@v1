"use client";

/**
 * ConversationItem - Single conversation row with actions
 */

import { useState, useRef, useEffect } from "react";
import { MoreHorizontal, Pencil, Trash2, Check, X } from "lucide-react";
import { cn } from "@/lib/utils";
import type { ConversationItem as ConversationItemType } from "@/hooks/useConversations";

interface ConversationItemProps {
  conversation: ConversationItemType;
  isActive: boolean;
  onClick: () => void;
  onRename: (title: string) => Promise<void>;
  onDelete: () => Promise<void>;
}

export function ConversationItem({
  conversation,
  isActive,
  onClick,
  onRename,
  onDelete,
}: ConversationItemProps) {
  const [isMenuOpen, setIsMenuOpen] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editTitle, setEditTitle] = useState(conversation.title || "");
  const [isDeleting, setIsDeleting] = useState(false);
  const inputRef = useRef<HTMLInputElement>(null);
  const menuRef = useRef<HTMLDivElement>(null);

  // Focus input when editing starts
  useEffect(() => {
    if (isEditing && inputRef.current) {
      inputRef.current.focus();
      inputRef.current.select();
    }
  }, [isEditing]);

  // Close menu on outside click
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsMenuOpen(false);
      }
    }
    if (isMenuOpen) {
      document.addEventListener("mousedown", handleClickOutside);
    }
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [isMenuOpen]);

  const handleRename = async () => {
    if (editTitle.trim() && editTitle !== conversation.title) {
      await onRename(editTitle.trim());
    }
    setIsEditing(false);
  };

  const handleDelete = async () => {
    setIsDeleting(true);
    try {
      await onDelete();
    } finally {
      setIsDeleting(false);
      setIsMenuOpen(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === "Enter") {
      handleRename();
    } else if (e.key === "Escape") {
      setEditTitle(conversation.title || "");
      setIsEditing(false);
    }
  };

  // Display title or fallback
  const displayTitle = conversation.title || "新对话";

  return (
    <div
      className={cn(
        "group relative flex items-center gap-2 px-3 py-2 rounded-lg cursor-pointer",
        "transition-colors duration-150",
        isActive
          ? "bg-skill-primary/10 text-skill-primary"
          : "hover:bg-muted/50 text-foreground/80 hover:text-foreground"
      )}
      onClick={() => !isEditing && onClick()}
    >
      {isEditing ? (
        <div className="flex-1 flex items-center gap-1">
          <input
            ref={inputRef}
            type="text"
            value={editTitle}
            onChange={(e) => setEditTitle(e.target.value)}
            onKeyDown={handleKeyDown}
            onBlur={handleRename}
            className={cn(
              "flex-1 px-2 py-1 text-sm rounded",
              "bg-background border border-border",
              "focus:outline-none focus:ring-1 focus:ring-skill-primary"
            )}
            onClick={(e) => e.stopPropagation()}
          />
          <button
            onClick={(e) => {
              e.stopPropagation();
              handleRename();
            }}
            className="p-1 text-green-500 hover:bg-green-500/10 rounded"
          >
            <Check className="w-3.5 h-3.5" />
          </button>
          <button
            onClick={(e) => {
              e.stopPropagation();
              setEditTitle(conversation.title || "");
              setIsEditing(false);
            }}
            className="p-1 text-red-500 hover:bg-red-500/10 rounded"
          >
            <X className="w-3.5 h-3.5" />
          </button>
        </div>
      ) : (
        <>
          <span className="flex-1 truncate text-sm">{displayTitle}</span>

          {/* Action menu button - visible on hover or when open */}
          <div
            ref={menuRef}
            className={cn(
              "relative",
              isMenuOpen ? "opacity-100" : "opacity-0 group-hover:opacity-100",
              "transition-opacity duration-150"
            )}
          >
            <button
              onClick={(e) => {
                e.stopPropagation();
                setIsMenuOpen(!isMenuOpen);
              }}
              className={cn(
                "p-1 rounded hover:bg-muted/80",
                "text-muted-foreground hover:text-foreground"
              )}
            >
              <MoreHorizontal className="w-4 h-4" />
            </button>

            {/* Dropdown menu */}
            {isMenuOpen && (
              <div
                className={cn(
                  "absolute right-0 top-full mt-1 z-50",
                  "min-w-[120px] py-1 rounded-lg shadow-lg",
                  "bg-popover border border-border"
                )}
              >
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setIsMenuOpen(false);
                    setIsEditing(true);
                  }}
                  className={cn(
                    "w-full flex items-center gap-2 px-3 py-2 text-sm",
                    "hover:bg-muted text-foreground"
                  )}
                >
                  <Pencil className="w-3.5 h-3.5" />
                  重命名
                </button>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    handleDelete();
                  }}
                  disabled={isDeleting}
                  className={cn(
                    "w-full flex items-center gap-2 px-3 py-2 text-sm",
                    "hover:bg-red-500/10 text-red-500",
                    "disabled:opacity-50"
                  )}
                >
                  <Trash2 className="w-3.5 h-3.5" />
                  {isDeleting ? "删除中..." : "删除"}
                </button>
              </div>
            )}
          </div>
        </>
      )}
    </div>
  );
}

export default ConversationItem;
