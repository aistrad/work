"use client";

/**
 * Chat Page - 主对话页面（三栏布局）
 * Based on: vibelife spec v3.0
 *
 * PC端:
 * - 左侧 NavBar (64px) - 固定导航
 * - 中间 Chat Stream (flex-1) - 对话流始终显示
 * - 右侧 Panel (360px) - 根据 NavBar Tab 切换内容
 *
 * 移动端:
 * - 顶部 Header
 * - 内容区 - 根据底部 Tab 完全切换
 * - 底部 TabBar
 */

import { useState, useMemo } from "react";
import { useSkill } from "@/providers";
import { AppShell, useAppShell, type TabType } from "@/components/layout";
import { ChatPanel, ChartPanel, JourneyPanel, MePanel } from "@/components/layout/panels";
import { ChatContainer } from "@/components/chat/ChatContainer";
import { LuminousPaper, BreathAura } from "@/components/core";

// ═══════════════════════════════════════════════════════════════════════════
// Panel Content Switcher
// ═══════════════════════════════════════════════════════════════════════════

function PanelContent() {
  const { skill, activeTab } = useAppShell();

  // Demo data - 实际应从 API 获取
  const demoProfile = useMemo(() => {
    if (skill === "bazi") {
      return {
        dayMaster: "甲木",
        pattern: "正印格",
        currentLuck: "壬寅大运",
        pillars: {
          year: { stem: "庚", branch: "午" },
          month: { stem: "戊", branch: "子" },
          day: { stem: "甲", branch: "辰" },
        },
      };
    }
    if (skill === "zodiac") {
      return {
        sunSign: "双子座",
        moonSign: "天蝎座",
        risingSign: "狮子座",
      };
    }
    return null;
  }, [skill]);

  const demoNowNext = useMemo(() => ({
    currentPhase: "积累期",
    currentTheme: "这是一个适合沉淀学习的阶段，不急于求成",
    nextMilestone: "突破期",
    nextDate: "2026年下半年",
  }), []);

  switch (activeTab) {
    case "chat":
      return (
        <ChatPanel
          skill={skill}
          profile={demoProfile}
          insights={[]}
          onOpenRelationship={() => console.log("Open relationship")}
        />
      );
    case "chart":
      return (
        <ChartPanel
          skill={skill}
          nowNextData={demoNowNext}
          klinePreview={{
            currentScore: 72,
            trend: "up",
            period: "2026年",
          }}
          onViewKLine={() => console.log("View K-Line")}
          onGenerateReport={() => console.log("Generate report")}
        />
      );
    case "journey":
      return (
        <JourneyPanel
          skill={skill}
          totalConversations={12}
          totalInsights={5}
          memberSince="2025年12月"
          timeline={[
            {
              id: "1",
              date: "今天",
              title: "关于事业方向的对话",
              summary: "探讨了未来3年的职业规划",
              type: "conversation",
            },
            {
              id: "2",
              date: "昨天",
              title: "你的核心优势",
              summary: "甲木日主，天生有领导力和创造力",
              type: "insight",
            },
          ]}
        />
      );
    case "me":
      return (
        <MePanel
          skill={skill}
          user={{
            name: "测试用户",
            email: "test@vibelife.app",
            isPro: false,
          }}
          onLogout={() => console.log("Logout")}
        />
      );
    default:
      return null;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// Chat Content (中间区域)
// ═══════════════════════════════════════════════════════════════════════════

function ChatContent() {
  const { skill, voiceMode } = useAppShell();

  return (
    <LuminousPaper skill={skill} variant="default" className="h-full relative">
      {/* Background aura */}
      <BreathAura
        skill={skill}
        size="xl"
        position="top"
        intensity="low"
        className="opacity-30"
      />

      {/* Chat Container */}
      <ChatContainer
        skillId={skill}
        skill={skill}
        voiceMode={voiceMode}
      />
    </LuminousPaper>
  );
}

// ═══════════════════════════════════════════════════════════════════════════
// Main Page Component
// ═══════════════════════════════════════════════════════════════════════════

export default function ChatPage() {
  const { skill } = useSkill();

  return (
    <AppShell skill={skill} panelContent={<PanelContent />}>
      <ChatContent />
    </AppShell>
  );
}
