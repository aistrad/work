# Build 阶段最佳实践

## 概述

Build 阶段目标是按模块/层次实现，每个模块完整交付。

**核心原则**：Module 驱动，每个模块包含代码 + 测试 + 文档，可独立验证。

---

## 1. 模块拆分原则

### 1.1 按架构层次拆分

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   推荐拆分顺序（自下而上）                                                  │
│                                                                             │
│   Phase 1: 数据层 (L5)                                                      │
│   ├── 数据库 schema                                                         │
│   ├── 数据访问层                                                            │
│   └── 基础 CRUD                                                             │
│                                                                             │
│   Phase 2: 业务逻辑层 (L3)                                                  │
│   ├── 核心服务                                                              │
│   ├── 领域模型                                                              │
│   └── 业务规则                                                              │
│                                                                             │
│   Phase 3: API 层 (L2)                                                      │
│   ├── 路由定义                                                              │
│   ├── 请求验证                                                              │
│   └── 响应序列化                                                            │
│                                                                             │
│   Phase 4: 表现层 (L1)                                                      │
│   ├── 页面组件                                                              │
│   ├── 状态管理                                                              │
│   └── 样式实现                                                              │
│                                                                             │
│   Phase 5: 集成与优化                                                       │
│   ├── 端到端测试                                                            │
│   ├── 性能优化                                                              │
│   └── 文档完善                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 模块边界定义

**好的模块应该**：

```
✅ 单一职责：只做一件事，做好
✅ 接口清晰：输入输出明确
✅ 可独立测试：不依赖其他模块的实现细节
✅ 可独立部署（如适用）
✅ 代码量适中：500-2000 行
```

**模块依赖原则**：

```
• 依赖方向：上层依赖下层，不反向依赖
• 接口抽象：通过接口而非实现依赖
• 循环依赖：严禁循环依赖
```

---

## 2. 模块实现流程

### 2.1 标准实现流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   模块实现流程（每个模块）                                                  │
│                                                                             │
│   Step 1: 设计确认                                                          │
│   ─────────────────────────────────────────────────────────────────────     │
│   □ 与 spec 设计对齐                                                        │
│   □ 接口定义明确                                                            │
│   □ 依赖模块已就绪                                                          │
│                                                                             │
│   Step 2: 测试先行（TDD）                                                   │
│   ─────────────────────────────────────────────────────────────────────     │
│   □ 编写单元测试（先失败）                                                  │
│   □ 定义验收标准                                                            │
│                                                                             │
│   Step 3: 核心实现                                                          │
│   ─────────────────────────────────────────────────────────────────────     │
│   □ 实现核心逻辑                                                            │
│   □ 通过单元测试                                                            │
│   □ 代码审查                                                                │
│                                                                             │
│   Step 4: 集成测试                                                          │
│   ─────────────────────────────────────────────────────────────────────     │
│   □ 与依赖模块集成                                                          │
│   □ 通过集成测试                                                            │
│                                                                             │
│   Step 5: 文档更新                                                          │
│   ─────────────────────────────────────────────────────────────────────     │
│   □ API 文档                                                                │
│   □ 使用示例                                                                │
│   □ 变更记录                                                                │
│                                                                             │
│   Step 6: 合入                                                              │
│   ─────────────────────────────────────────────────────────────────────     │
│   □ PR 审查通过                                                             │
│   □ 合入主分支                                                              │
│   □ 更新 roadmap 进度                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 代码质量标准

```
代码规范：
• 命名：清晰、一致、有意义
• 格式：使用 linter/formatter 自动格式化
• 注释：解释 why，不解释 what
• 复杂度：单函数不超过 50 行，圈复杂度不超过 10

测试覆盖：
• 核心业务逻辑：90%+
• API 端点：80%+
• 工具函数：70%+
• UI 组件：关键交互覆盖
```

---

## 3. 测试策略

### 3.1 测试金字塔

```
                    ╱╲
                   ╱  ╲
                  ╱ E2E╲        少量，验证关键流程
                 ╱──────╲
                ╱        ╲
               ╱ 集成测试 ╲      中量，验证模块集成
              ╱────────────╲
             ╱              ╲
            ╱    单元测试    ╲   大量，验证单元逻辑
           ╱──────────────────╲
```

### 3.2 测试类型指南

| 测试类型 | 目的 | 工具 | 频率 |
|----------|------|------|------|
| 单元测试 | 验证单元逻辑 | pytest/jest | 每次提交 |
| 集成测试 | 验证模块交互 | pytest/supertest | 每次 PR |
| E2E 测试 | 验证用户流程 | Playwright | 每次发布 |
| 性能测试 | 验证性能基线 | k6/locust | 关键节点 |

### 3.3 测试命名规范

```python
# 单元测试命名：test_<功能>_<场景>_<预期结果>
def test_create_user_with_valid_email_returns_user():
    pass

def test_create_user_with_invalid_email_raises_error():
    pass

# 测试文件组织
tests/
├── unit/
│   ├── test_user_service.py
│   └── test_payment_service.py
├── integration/
│   └── test_user_api.py
└── e2e/
    └── test_signup_flow.py
```

---

## 4. 与 Spec 一致性验证

### 4.1 一致性检查清单

每个模块完成后验证：

```
□ 功能一致性
  □ 实现了 spec 中定义的所有功能
  □ 没有实现 spec 中没有的功能
  □ 行为与 spec 描述一致

□ 接口一致性
  □ API 端点与 spec 定义一致
  □ 请求/响应结构与 spec 一致
  □ 错误码与 spec 定义一致

□ 数据一致性
  □ 数据模型与 spec 设计一致
  □ 字段类型和约束正确
  □ 关系定义正确

□ 体验一致性
  □ 用户流程与 spec 设计一致
  □ 交互行为符合预期
  □ 错误处理用户友好
```

### 4.2 差异处理

发现与 spec 不一致时：

```
1. 记录差异
   - 差异点是什么
   - 为什么产生差异

2. 评估影响
   - 是 spec 需要更新还是实现需要修改
   - 影响范围有多大

3. 决策
   - 如果 spec 错误/过时：更新 spec，记录决策原因
   - 如果实现错误：修改实现

4. 同步更新
   - 确保 spec 和实现保持一致
   - 更新 changelog
```

---

## 5. 技术债务管理

### 5.1 技术债务分类

| 类型 | 描述 | 优先级 |
|------|------|--------|
| 架构债务 | 结构问题，影响扩展 | 高 |
| 代码债务 | 代码质量问题 | 中 |
| 测试债务 | 测试覆盖不足 | 中 |
| 文档债务 | 文档缺失/过时 | 低 |

### 5.2 债务记录模板

```markdown
## 技术债务: {{标题}}

**类型**: 架构/代码/测试/文档
**优先级**: 高/中/低
**发现日期**: {{日期}}
**位置**: {{文件/模块}}

**描述**:
{{问题描述}}

**影响**:
{{对系统的影响}}

**建议解决方案**:
{{解决方案}}

**预估工作量**: {{工作量}}
```

---

## 6. Build 产出检查清单

完成 Build 后，确保以下内容已完成：

```
□ 代码实现
  □ 所有模块已实现
  □ 代码符合规范
  □ 通过 lint 检查

□ 测试
  □ 单元测试通过
  □ 集成测试通过
  □ 关键 E2E 测试通过

□ 文档
  □ API 文档已更新
  □ 使用示例已提供
  □ 变更已记录

□ 一致性
  □ 与 spec 一致性已验证
  □ 差异已处理和记录

□ 技术债务
  □ 债务已识别和记录
  □ 计划处理时间

□ roadmap 更新
  □ 进度状态已更新
  □ TODO 清单已更新
```

---

## 7. 常见陷阱

1. **跳过测试**：赶进度跳过测试，后期 debug 成本更高
2. **忽视文档**：代码写完不写文档，知识流失
3. **过度优化**：提前优化，浪费时间
4. **不及时重构**：技术债务积累，越来越难改
5. **孤立开发**：不与团队同步，集成时问题多
