The file /home/aiscend/work/fortune_ai/services/soul_os.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   898→# =============================================================================
   899→# L3 Synthesis Layer - GLM 整合 + A2UI 输出
   900→# =============================================================================
   901→
   902→def build_system_prompt(
   903→    user_id: int,
   904→    persona_style: str = "warm",
   905→    user_context: Optional[Dict[str, Any]] = None,
   906→) -> str:
   907→    """构建 GLM System Prompt（对齐 OS 设计文档附录 A）
   908→
   909→    包含用户的 L0/L1 上下文数据，使输出个性化。
   910→    """
   911→
   912→    # 构建用户上下文摘要
   913→    context_section = ""
   914→    if user_context:
   915→        # L0: 八字事实摘要
   916→        l0_facts = user_context.get("l0_facts", {})
   917→        bazi = l0_facts.get("bazi", {})
   918→
   919→        l0_summary = []
   920→        if bazi:
   921→            # 四柱
   922→            sizhu = bazi.get("sizhu", {})
   923→            if sizhu:
   924→                l0_summary.append(f"四柱：{sizhu.get('year_gan', '')}年 {sizhu.get('month_gan', '')}月 {sizhu.get('day_gan', '')}日 {sizhu.get('hour_gan', '')}时")
   925→
   926→            # 日主强弱
   927→            strength = bazi.get("strength", {})
   928→            if strength:
   929→                level = strength.get("level", "")
   930→                if level:
   931→                    l0_summary.append(f"日主：{level}")
   932→
   933→            # 当前大运
   934→            luck = bazi.get("luck", {})
   935→            current_dayun = luck.get("current_dayun", {})
   936→            if current_dayun:
   937→                l0_summary.append(f"当前大运：{current_dayun.get('gan_zhi', '')}")
   938→
   939→        # L0 心理学翻译
   940→        translations = user_context.get("l0_translations", [])
   941→        if translations:
   942→            trans_text = "; ".join([f"{t.get('concept', '')}: {t.get('translation', '')}" for t in translations[:3]])
   943→            l0_summary.append(f"性格特质：{trans_text}")
   944→
   945→        # L1: PERMA 状态
   946→        l1_schema = user_context.get("l1_schema", {})
   947→        perma = l1_schema.get("perma_snapshot", {})
   948→
   949→        l1_summary = []
   950→        if perma:
   951→            # 提取各维度分数
   952→            p_score = perma.get("positive_emotion", {}).get("score", 0)
   953→            e_score = perma.get("engagement", {}).get("score", 0)
   954→            r_score = perma.get("relationships", {}).get("score", 0)
   955→            m_score = perma.get("meaning", {}).get("score", 0)
   956→            a_score = perma.get("accomplishment", {}).get("score", 0)
   957→
   958→            # 只显示非零分数
   959→            scores = []
   960→            if p_score > 0: scores.append(f"P正向情绪:{p_score}")
   961→            if e_score > 0: scores.append(f"E投入:{e_score}")
   962→            if r_score > 0: scores.append(f"R关系:{r_score}")
   963→            if m_score > 0: scores.append(f"M意义:{m_score}")
   964→            if a_score > 0: scores.append(f"A成就:{a_score}")
   965→
   966→            if scores:
   967→                l1_summary.append(f"PERMA状态：{', '.join(scores)}")
   968→            else:
   969→                l1_summary.append("PERMA状态：新用户，尚无数据")
   970→
   971→            # 连续行动天数
   972→            streak = perma.get("accomplishment", {}).get("streak", 0)
   973→            if streak > 0:
   974→                l1_summary.append(f"连续行动：{streak}天")
   975→
   976→        # State Score
   977→        state_score = user_context.get("state_score", {})
   978→        if state_score:
   979→            score = state_score.get("score", 0)
   980→            recovery = state_score.get("recovery_action", "")
   981→            l1_summary.append(f"状态分数：{score}/100")
   982→            if recovery and score < 50:
   983→                l1_summary.append(f"建议行动：{recovery}")
   984→
   985→        # 构建上下文部分
   986→        if l0_summary or l1_summary:
   987→            context_section = f"""
   988→【用户上下文（必须参考）】
   989→{chr(10).join(f"- {s}" for s in l0_summary) if l0_summary else "- 八字信息暂无"}
   990→{chr(10).join(f"- {s}" for s in l1_summary) if l1_summary else "- 行为数据暂无"}
   991→"""
   992→
   993→    return f"""你是 Fortune AI 的对话 Agent，角色是积极心理学教练（Performance Coach）。
   994→
   995→【产品定位】
   996→人生导航 / 陪伴 / 提升。系统和交互保持"有效而极简"。
   997→
   998→【四层架构理解】
   999→- L0（定数）：用户的八字事实，作为先验约束，不做宿命论解读
  1000→- L1（特质）：用户的心理图式和当前状态，作为个性化调节
  1001→- L2（策略）：知识库和规则，作为专业依据
  1002→- L3（意识）：你的输出，作为整合与行动引导
  1003→{context_section}
  1004→【你的优先级（不可逆）】
  1005→Coach > Teaching Assistant > Customer Support > Sales
  1006→
  1007→【硬性规则（必须遵守）】
  1008→1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接"你可以做什么"的行动处方。
  1009→2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。
  1010→3) 每次回复必须包含：
  1011→   - 结论要点（针对用户具体问题）
  1012→   - 行动处方（≤3条，每条必须有 if_then 格式）
  1013→   - 承诺邀请（引导用户做出具体承诺）
  1014→4) 处方格式示例：「如果你早上醒来感到疲惫 → 那么先做3次深呼吸再起床」
  1015→5) 输出使用自然语言，不需要 JSON 格式。
  1016→6) 如果用户状态分数低或PERMA数据不足，优先引导用户做一个最小行动来建立数据。
  1017→
  1018→【语言风格 persona_style = {persona_style}】
  1019→standard：清晰、中性、专业
  1020→warm：共情、支持性（默认）
  1021→roast：轻毒舌但不羞辱、不对人格做负面定性
  1022→
  1023→【输出示例】
  1024→用户：帮我成长
  1025→回复：
  1026→### 结论要点
  1027→根据你的状态，当前最重要的是建立行动的节奏感。
  1028→
  1029→### 行动处方
  1030→1. **最小启动**：如果你现在感到迷茫 → 那么先写下今天最想完成的一件事
  1031→2. **情绪锚点**：如果你在工作中感到焦虑 → 那么做3次4-7-8呼吸（吸4秒、屏7秒、呼8秒）
  1032→3. **复盘仪式**：如果今天结束时 → 那么用1分钟写下做得好的一件事
  1033→
  1034→### 承诺
  1035→你愿意先从哪一条开始？告诉我，我帮你追踪进度。
  1036→"""
  1037→
  1038→
  1039→def build_user_context(user_id: int) -> Dict[str, Any]:
  1040→    """构建用户上下文（L0 + L1 + State Score）"""