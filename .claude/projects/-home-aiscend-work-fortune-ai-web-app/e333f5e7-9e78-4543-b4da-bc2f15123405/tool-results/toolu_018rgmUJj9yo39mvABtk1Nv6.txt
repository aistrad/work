     1→/**
     2→ * Context Builder for Fortune AI Agent Runtime
     3→ *
     4→ * Builds the system prompt from context fetched from FastAPI internal API.
     5→ * The context includes user profile, preferences, evidence, and anti-dependency check.
     6→ */
     7→
     8→export interface UserContext {
     9→  user_id: number;
    10→  system_prompt: string;
    11→  persona_style: string;
    12→  user_context: Record<string, unknown>;
    13→  evidence: Record<string, unknown>;
    14→  anti_dependency: {
    15→    should_intervene: boolean;
    16→    intervention_type: string | null;
    17→    intervention_message: string | null;
    18→  };
    19→  history: Array<{ role: string; content: string }>;
    20→}
    21→
    22→/**
    23→ * Build system prompt from context.
    24→ *
    25→ * SSOT: The system_prompt comes from FastAPI (soul_os.py), not built here.
    26→ * This ensures consistency between different chat runtimes.
    27→ *
    28→ * The FastAPI system_prompt is already formatted with:
    29→ * - Persona style rules
    30→ * - User context (facts, evidence)
    31→ * - Anti-dependency interventions
    32→ *
    33→ * We only add tools-specific instructions here if needed.
    34→ */
    35→export function buildSystemPrompt(context: UserContext): string {
    36→  // SSOT: Use system_prompt from FastAPI as-is
    37→  let prompt = context.system_prompt || '';
    38→
    39→  // If FastAPI didn't provide system_prompt, use minimal fallback
    40→  if (!prompt.trim()) {
    41→    prompt = buildFallbackSystemPrompt(context);
    42→  }
    43→
    44→  // Add tools instruction (not in FastAPI prompt)
    45→  const toolsInstruction = `
    46→
    47→【工具使用】
    48→当需要查询八字、运势、心理等功能时，使用提供的 tools 来获取数据。
    49→`;
    50→
    51→  return prompt + toolsInstruction;
    52→}
    53→
    54→/**
    55→ * Fallback system prompt when FastAPI doesn't provide one.
    56→ * This should rarely be used in production.
    57→ */
    58→function buildFallbackSystemPrompt(context: UserContext): string {
    59→  return `你是 Mentis 的对话 Agent，角色是积极心理学教练。
    60→
    61→【硬性规则】
    62→1) 禁止恐吓、羞辱、宿命论断言
    63→2) 每次输出必须包含：结论 + 依据 + ≤3条处方 + 承诺邀请
    64→3) 每条处方必须包含 if_then
    65→
    66→【语言风格】
    67→${context.persona_style || 'warm'}
    68→
    69→【用户上下文】
    70→${JSON.stringify(context.user_context, null, 2)}
    71→
    72→【依据】
    73→${JSON.stringify(context.evidence, null, 2)}
    74→${
    75→  context.anti_dependency?.should_intervene
    76→    ? `
    77→【反依赖干预】
    78→类型: ${context.anti_dependency.intervention_type}
    79→消息: ${context.anti_dependency.intervention_message}
    80→`
    81→    : ''
    82→}`;
    83→}
    84→
    85→// Convert chat history to Vercel AI SDK format
    86→export function buildMessages(
    87→  context: UserContext,
    88→  userMessage: string
    89→): Array<{ role: 'user' | 'assistant'; content: string }> {
    90→  const messages: Array<{ role: 'user' | 'assistant'; content: string }> = [];
    91→
    92→  // Add history
    93→  for (const msg of context.history) {
    94→    if (msg.role === 'user' || msg.role === 'assistant') {
    95→      messages.push({
    96→        role: msg.role as 'user' | 'assistant',
    97→        content: msg.content,
    98→      });
    99→    }
   100→  }
   101→
   102→  // Add current message
   103→  messages.push({
   104→    role: 'user',
   105→    content: userMessage,
   106→  });
   107→
   108→  return messages;
   109→}
   110→
   111→// Internal service token for secure internal API calls
   112→const INTERNAL_SERVICE_TOKEN = process.env.FORTUNE_INTERNAL_SERVICE_TOKEN || '';
   113→
   114→// Fetch context from FastAPI internal API
   115→export async function fetchContext(
   116→  sessionId: string | null,
   117→  query: string,
   118→  sessionCookie: string
   119→): Promise<UserContext> {
   120→  const fastApiUrl = process.env.FASTAPI_URL || 'http://localhost:8230';
   121→
   122→  const params = new URLSearchParams();
   123→  if (sessionId) params.set('session_id', sessionId);
   124→  if (query) params.set('query', query);
   125→
   126→  const headers: Record<string, string> = {
   127→    Cookie: `fortune_session=${sessionCookie}`,
   128→  };
   129→
   130→  // Add service token for internal API trust boundary
   131→  if (INTERNAL_SERVICE_TOKEN) {
   132→    headers['X-Service-Token'] = INTERNAL_SERVICE_TOKEN;
   133→  }
   134→
   135→  const res = await fetch(`${fastApiUrl}/internal/context?${params.toString()}`, {
   136→    headers,
   137→  });
   138→
   139→  if (!res.ok) {
   140→    throw new Error(`Failed to fetch context: ${res.status}`);
   141→  }
   142→
   143→  return res.json();
   144→}
   145→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
