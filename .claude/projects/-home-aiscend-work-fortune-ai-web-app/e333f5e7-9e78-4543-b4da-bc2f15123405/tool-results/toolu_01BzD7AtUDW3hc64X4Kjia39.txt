     1â†’# Soul OS å¿ƒç†æ¶æ„è®¾è®¡
     2â†’
     3â†’**ç‰ˆæœ¬**ï¼šv4.2ï¼ˆ2026-01-01ï¼ŒVercel AI SDK Editionï¼‰
     4â†’**æ–‡æ¡£ç±»å‹**ï¼šOperating System Psychological Architecture
     5â†’**å®šä½**ï¼šåŸºäºæ·±åº¦å¿ƒç†å­¦çš„ç²¾ç¥æ•°å­—å­ªç”Ÿæ“ä½œç³»ç»Ÿ
     6â†’**æ ¸å¿ƒæ¶æ„**ï¼šVercel AI SDK Driven / Pluggable Skills / Evolutionary Loop
     7â†’**ç†è®ºæ¡†æ¶**ï¼šè£æ ¼åˆ†æå¿ƒç†å­¦ Ã— ç§¯æå¿ƒç†å­¦ Ã— è¡Œä¸ºç§‘å­¦ Ã— è‡ªæˆ‘å†³å®šç†è®º
     8â†’**Agent Runtime**ï¼šVercel AI SDK 6 (`ai` library) + Multi-Model Providers
     9â†’
    10â†’---
    11â†’
    12â†’## 0. ä¿®è®¢è¯´æ˜
    13â†’
    14â†’### 0.0 v4.2 æ¶æ„å‡çº§è¦ç‚¹ (Vercel AI SDK Edition)
    15â†’
    16â†’æœ¬ç‰ˆæœ¬é‡‡ç”¨ **Vercel AI SDK** ä½œä¸ºç»Ÿä¸€ Agent Runtimeï¼Œæ ¸å¿ƒå˜æ›´ï¼š
    17â†’
    18â†’1. **Agent Runtime ç»Ÿä¸€åŒ–**ï¼š
    19â†’   - **å¼ƒç”¨**: `glm_client.py` ç›´æ¥ API è°ƒç”¨
    20â†’   - **å¼•å…¥**: Vercel AI SDK `streamText()` + `tool()` æ ‡å‡†åŒ–æ¥å£
    21â†’   - **æ”¯æŒ**: GLM-4.5 / Gemini / Claude å¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢
    22â†’
    23â†’2. **Skills æ ‡å‡†åŒ– (Tool Calling)**ï¼š
    24â†’   - L2 Expert Agents é‡æ„ä¸º **Vercel Tools** (Zod Schema + Execute Function)
    25â†’   - æ”¯æŒ `maxSteps` å¤šæ­¥æ¨ç†ï¼ˆAgent Loop è‡ªåŠ¨åŒ–ï¼‰
    26â†’   - `/command` æ˜¾å¼è§¦å‘ + è‡ªç„¶è¯­è¨€éšå¼è§¦å‘åŒæ¨¡å¼
    27â†’
    28â†’3. **å‰åç«¯èŒè´£é‡æ„**ï¼š
    29â†’   - **Next.js API Route**: æ‰¿è½½ AI æ¨ç†é€»è¾‘ (`streamText`)
    30â†’   - **FastAPI (Python)**: é™çº§ä¸ºçº¯æ•°æ®æœåŠ¡å±‚ (L0/L1 CRUD)
    31â†’   - **useChat Hook**: å‰ç«¯æµå¼æ¸²æŸ“æ ‡å‡†åŒ–
    32â†’
    33â†’4. **æµå¼å¤„ç†æ ‡å‡†åŒ–**ï¼š
    34â†’   - å¼ƒç”¨è‡ªå®šä¹‰ SSE æ ¼å¼
    35â†’   - é‡‡ç”¨ `toDataStreamResponse()` + Message Annotations
    36â†’
    37â†’### 0.0.1 v4.0 â†’ v4.2 æ¶æ„æ¼”è¿›
    38â†’
    39â†’| v4.0/v4.1 ç»„ä»¶ | v4.2 ç»„ä»¶ | å˜åŒ–è¯´æ˜ |
    40â†’|----------------|-----------|----------|
    41â†’| `glm_client.py` | `@ai-sdk/google` / Vercel AI Gateway | **åˆ é™¤** Python LLM å®¢æˆ·ç«¯ |
    42â†’| `build_system_prompt()` | `system` param in `streamText()` | **è¿ç§»**åˆ° TypeScript |
    43â†’| L2 Expert Agents (Python) | `tool({ ... })` definitions (TS) | **é‡å†™**ä¸º Tool Definitions |
    44â†’| è‡ªå®šä¹‰ SSE `/api/chat/stream` | `toDataStreamResponse()` | **æ›¿æ¢**ä¸ºæ ‡å‡†æµ |
    45â†’| A2UI JSON blocks | Stream + Message Annotations | **é€‚é…**æµå¼æ ¼å¼ |
    46â†’| Context Manager | ä¿ç•™ Python APIï¼ŒTS è°ƒç”¨è·å– | **ä¿ç•™**æ•°æ®èšåˆé€»è¾‘ |
    47â†’
    48â†’### 0.0.2 v3.x â†’ v4.0 å±‚æ¬¡æ˜ å°„ (å†å²å‚è€ƒ)
    49â†’
    50â†’| v3.x å±‚æ¬¡ | v4.0 å±‚æ¬¡ | å˜åŒ– |
    51â†’|-----------|-----------|------|
    52â†’| Interaction Layer | Interaction Layer | æ— å˜åŒ– |
    53â†’| Context Management | Context Manager v4.0 | å¢åŠ  History å‘é‡æ£€ç´¢ |
    54â†’| L2 Agents | L2 Agents + Insight Agent | æ–°å¢åå°æ´å¯Ÿç®—å­ |
    55â†’| L1 Module Data | L1 Module Data (å¯åå†™) | æ”¯æŒ Cold Path æ›´æ–° |
    56â†’| L0 Base Data | L0 Base Data (å¯åå†™) | æ”¯æŒç”»åƒåŠ¨æ€ä¸°æ»¡ |
    57â†’
    58â†’### 0.1 è®¾è®¡ vs å®ç°å¯¹æ¯”
    59â†’
    60â†’| æ¨¡å— | è®¾è®¡çŠ¶æ€ | å®ç°çŠ¶æ€ | å·®è·åˆ†æ |
    61â†’|------|----------|----------|----------|
    62â†’| L0 Base Data | âœ… å®Œæ•´è®¾è®¡ | âœ… å®Œæ•´å®ç° | å…«å­—è®¡ç®—ç²¾ç¡® |
    63â†’| L1 Module Data | âœ… å¯æ’æ‹”è®¾è®¡ | âœ… å·²å®ç° | å…«å­—/PERMA æ¨¡å—å°±ç»ª |
    64â†’| L2 Expert Agents | âœ… å¤šæ¨¡å—è®¾è®¡ | âš ï¸ éƒ¨åˆ†å®ç° | ä»…å…«å­— Agentï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç° |
    65â†’| L2 Style Agents | âœ… ä¸‰é£æ ¼è®¾è®¡ | âœ… å·²å®ç° | standard/warm/roast |
    66â†’| Context Management | âœ… ç»„è£…å·¥å‚ | âœ… GLM æ•´åˆ | å·¥ä½œæ­£å¸¸ |
    67â†’| Interaction Layer | âœ… å¤šæ¨¡å‹æ”¯æŒ | âš ï¸ éƒ¨åˆ†å®ç° | GLM ä¸ºä¸»ï¼ŒGemini/Claude å¤‡é€‰ |
    68â†’| Goal æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
    69â†’| Reflection æ¨¡å— | âœ… å®Œæ•´è®¾è®¡ | âœ… å·²å®ç° | è¡¨å·²åˆ›å»º |
    70â†’| anti-dependency | âœ… ç­–ç•¥è®¾è®¡ | âš ï¸ å¾…ä¼˜åŒ– | æ–°ç”¨æˆ·è±å…å¾…å®ç° |
    71â†’| A2UI æ¸²æŸ“ | âœ… action_buttons | âš ï¸ å‰ç«¯é—®é¢˜ | CSRF é—®é¢˜ |
    72â†’
    73â†’---
    74â†’
    75â†’## 1. å¤šå±‚æ¶æ„æµç¨‹å›¾å¯¹æ¯”
    76â†’
    77â†’> **æœ¯è¯­å®šä¹‰**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§7 Soul OS æ¶æ„
    78â†’> **æ ¸å¿ƒæ¶æ„**: Context Driven / Pluggable Modulesï¼ˆè§ Â§1.4ï¼‰
    79â†’
    80â†’### 1.1 è®¾è®¡æ¶æ„ (å››å±‚å¿ƒç†æ¶æ„) âš ï¸ LEGACY
    81â†’
    82â†’> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä¿ç•™ä½œä¸º v2 æ¶æ„çš„å†å²å‚è€ƒã€‚
    83â†’> **âœ… å½“å‰è§„èŒƒ**: è¯·ä½¿ç”¨ [Â§1.4 Context é©±åŠ¨æ¶æ„](#14-context-é©±åŠ¨æ¶æ„-å¯æ’æ‹”æ¨¡å—è§†å›¾) ä½œä¸ºå”¯ä¸€å®ç°ä¾æ®ã€‚
    84â†’>
    85â†’> | æ—§æœ¯è¯­ | æ–°æ¶æ„æ˜ å°„ |
    86â†’> |--------|------------|
    87â†’> | L0 Firmware (å®šæ•°/æœ¬æˆ‘) | L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ) |
    88â†’> | L1 Schema (ç‰¹è´¨/å›¾å¼) | L1 Module Data (å¯æ’æ‹”æ•°æ®å±‚) |
    89â†’> | L2 Agents (ç­–ç•¥/è¶…æˆ‘) | L2 Expert + Style Agents (åŒåˆ†æ”¯) |
    90â†’> | L3 Synthesis (æ„è¯†/è‡ªæˆ‘) | Context Management + Interaction Layer |
    91â†’
    92â†’```mermaid
    93â†’graph TB
    94â†’    subgraph User["ğŸ‘¤ ç”¨æˆ·äº¤äº’"]
    95â†’        Input["è¾“å…¥æ¶ˆæ¯"]
    96â†’    end
    97â†’
    98â†’    subgraph L3["L3: Synthesis (æ„è¯†/è‡ªæˆ‘)"]
    99â†’        GLM["å…ƒè®¤çŸ¥ä»²è£å™¨<br/>(GLM Agent)"]
   100â†’        A2UI["A2UI JSON è¾“å‡º<br/>ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·"]
   101â†’    end
   102â†’
   103â†’    subgraph L2["L2: Agents (ç­–ç•¥/è¶…æˆ‘)"]
   104â†’        BaziAgent["å…«å­—è§£è¯» Agent<br/>æ ¼å±€/å¤§è¿/ç¥ç…"]
   105â†’        PsyAgent["å¿ƒç†å­¦ Agent<br/>PERMA/CBT/æƒ…ç»ª"]
   106â†’        ActionAgent["è¡ŒåŠ¨æ•™ç»ƒ Agent<br/>å¤„æ–¹/æ—¶é—´/éš¾åº¦"]
   107â†’    end
   108â†’
   109â†’    subgraph L1["L1: Schema (ç‰¹è´¨/å›¾å¼)"]
   110â†’        PERMA["PERMA äº”ç»´<br/>P-E-R-M-A"]
   111â†’        StateScore["State Score<br/>æƒ…ç»ª40%+è¡ŒåŠ¨35%+æˆé•¿25%"]
   112â†’    end
   113â†’
   114â†’    subgraph L0["L0: Firmware (å®šæ•°/æœ¬æˆ‘)"]
   115â†’        Bazi["å…«å­—ç¡®å®šæ€§è®¡ç®—<br/>å››æŸ±/åç¥/ç¥ç…/å¤§è¿"]
   116â†’        Profile["ç”¨æˆ·æ¡£æ¡ˆ<br/>åŸºç¡€ä¿¡æ¯+åå¥½+å†å²"]
   117â†’    end
   118â†’
   119â†’    Input --> L3
   120â†’    GLM --> A2UI
   121â†’
   122â†’    L2 --> GLM
   123â†’    BaziAgent --> GLM
   124â†’    PsyAgent --> GLM
   125â†’    ActionAgent --> GLM
   126â†’
   127â†’    L1 --> L2
   128â†’    PERMA --> BaziAgent
   129â†’    StateScore --> PsyAgent
   130â†’
   131â†’    L0 --> L1
   132â†’    Bazi --> PERMA
   133â†’    Profile --> StateScore
   134â†’
   135â†’    style L3 fill:#e8f5e9,stroke:#4caf50
   136â†’    style L2 fill:#e3f2fd,stroke:#2196f3
   137â†’    style L1 fill:#fff3e0,stroke:#ff9800
   138â†’    style L0 fill:#fce4ec,stroke:#e91e63
   139â†’```
   140â†’
   141â†’<details>
   142â†’<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>
   143â†’
   144â†’```
   145â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   146â†’â”‚                         Soul OS å››å±‚å¿ƒç†æ¶æ„                                  â”‚
   147â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   148â†’
   149â†’                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   150â†’                           â”‚     ç”¨æˆ·äº¤äº’        â”‚
   151â†’                           â”‚     è¾“å…¥æ¶ˆæ¯        â”‚
   152â†’                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   153â†’                                      â”‚
   154â†’                                      â–¼
   155â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   156â†’â”‚ L3: Synthesis (æ„è¯†/è‡ªæˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
   157â†’â”‚                                                                             â”‚
   158â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
   159â†’â”‚  â”‚    å…ƒè®¤çŸ¥ä»²è£å™¨          â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    A2UI JSON è¾“å‡º            â”‚        â”‚
   160â†’â”‚  â”‚    (GLM Agent)          â”‚        â”‚    ç»“è®º+å¤„æ–¹+æ‰¿è¯ºé‚€è¯·        â”‚        â”‚
   161â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
   162â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   163â†’               â”‚
   164â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   165â†’â”‚ L2: Agents (ç­–ç•¥/è¶…æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
   166â†’â”‚              â”‚                                                              â”‚
   167â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
   168â†’â”‚  â”‚                                                          â”‚              â”‚
   169â†’â”‚  â–¼                          â–¼                          â–¼    â”‚              â”‚
   170â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚              â”‚
   171â†’â”‚  â”‚ å…«å­—è§£è¯»Agent â”‚    â”‚ å¿ƒç†å­¦ Agent â”‚    â”‚ è¡ŒåŠ¨æ•™ç»ƒAgent â”‚   â”‚              â”‚
   172â†’â”‚  â”‚ æ ¼å±€/å¤§è¿/ç¥ç…â”‚    â”‚ PERMA/CBT/æƒ…ç»ªâ”‚    â”‚ å¤„æ–¹/æ—¶é—´/éš¾åº¦â”‚   â”‚              â”‚
   173â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”˜   â”‚              â”‚
   174â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   175â†’           â”‚                   â”‚                   â”‚          â”‚
   176â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   177â†’â”‚ L1: Schema (ç‰¹è´¨/å›¾å¼) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
   178â†’â”‚          â”‚                   â”‚                   â”‚                         â”‚
   179â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
   180â†’â”‚  â”‚                 â”‚   â”‚                                    â”‚              â”‚
   181â†’â”‚  â–¼                 â–¼   â”‚                                    â”‚              â”‚
   182â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚              â”‚
   183â†’â”‚  â”‚ PERMA äº”ç»´       â”‚  â”‚    â”‚ State Score               â”‚  â”‚              â”‚
   184â†’â”‚  â”‚ P-E-R-M-A       â”‚  â”‚    â”‚ æƒ…ç»ª40% + è¡ŒåŠ¨35% + æˆé•¿25%â”‚  â”‚              â”‚
   185â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚              â”‚
   186â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   187â†’            â”‚           â”‚                   â”‚                â”‚
   188â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   189â†’â”‚ L0: Firmware (å®šæ•°/æœ¬æˆ‘) â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
   190â†’â”‚           â”‚           â”‚                   â”‚                                â”‚
   191â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   192â†’â”‚  â”‚ å…«å­—ç¡®å®šæ€§è®¡ç®—                  â”‚  â”‚ ç”¨æˆ·æ¡£æ¡ˆ                    â”‚       â”‚
   193â†’â”‚  â”‚ å››æŸ± / åç¥ / ç¥ç… / å¤§è¿       â”‚  â”‚ åŸºç¡€ä¿¡æ¯ + åå¥½ + å†å²       â”‚       â”‚
   194â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
   195â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   196â†’```
   197â†’</details>
   198â†’
   199â†’**PERMA äº”ç»´å®šä¹‰**:
   200â†’
   201â†’| ç»´åº¦ | è‹±æ–‡ | å«ä¹‰ | æ•°æ®æ¥æº |
   202â†’|------|------|------|----------|
   203â†’| P | Positive Emotion | ç§¯ææƒ…ç»ª | fortune_checkin |
   204â†’| E | Engagement | æŠ•å…¥ | ä»»åŠ¡å®Œæˆç‡ |
   205â†’| R | Relationships | å…³ç³» | ç¤¾äº¤äº’åŠ¨ |
   206â†’| M | Meaning | æ„ä¹‰ | ç›®æ ‡å…³è”åº¦ |
   207â†’| A | Accomplishment | æˆå°± | ç´¯è®¡å®Œæˆä»»åŠ¡ |
   208â†’
   209â†’### 1.2 å½“å‰å®ç°æ¶æ„ âš ï¸ LEGACY
   210â†’
   211â†’> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚ä½¿ç”¨ v2 å››å±‚æœ¯è¯­ï¼Œä¿ç•™ä½œä¸ºä»£ç å®ç°çš„å‚è€ƒæ˜ å°„ã€‚
   212â†’> **âœ… æ–°æœ¯è¯­**: L0â†’L0 Base, L1â†’L1 Module, L2â†’L2 Expert, L3â†’Interaction Layer
   213â†’
   214â†’```mermaid
   215â†’graph LR
   216â†’    subgraph Services["services/"]
   217â†’        SoulOS["soul_os.py<br/>æ ¸å¿ƒåè°ƒå™¨"]
   218â†’
   219â†’        subgraph L0_Impl["L0 å®ç° âœ…"]
   220â†’            L0Facts["get_l0_facts()"]
   221â†’            BaziSvc["bazi_service.py"]
   222â†’        end
   223â†’
   224â†’        subgraph L1_Impl["L1 å®ç° âœ…"]
   225â†’            L1Schema["get_l1_schema()"]
   226â†’            PERMA_Calc["calculate_perma()"]
   227â†’            StateCalc["calculate_state_score()"]
   228â†’        end
   229â†’
   230â†’        subgraph L2_Impl["L2 å®ç° âš ï¸"]
   231â†’            KBSearch["search_knowledge_base()"]
   232â†’            AntiDep["check_anti_dependency()"]
   233â†’        end
   234â†’
   235â†’        subgraph L3_Impl["L3 å®ç° âœ…"]
   236â†’            PromptBuild["build_system_prompt()"]
   237â†’            GLMClient["glm_client.py"]
   238â†’        end
   239â†’    end
   240â†’
   241â†’    SoulOS --> L0Facts
   242â†’    SoulOS --> L1Schema
   243â†’    SoulOS --> KBSearch
   244â†’    SoulOS --> PromptBuild
   245â†’
   246â†’    L0Facts --> BaziSvc
   247â†’    L1Schema --> PERMA_Calc
   248â†’    L1Schema --> StateCalc
   249â†’    PromptBuild --> GLMClient
   250â†’
   251â†’    style L0_Impl fill:#d4edda
   252â†’    style L1_Impl fill:#d4edda
   253â†’    style L2_Impl fill:#fff3cd
   254â†’    style L3_Impl fill:#d4edda
   255â†’```
   256â†’
   257â†’<details>
   258â†’<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>
   259â†’
   260â†’```
   261â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   262â†’â”‚                         å½“å‰å®ç°æ¶æ„ (services/)                              â”‚
   263â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   264â†’
   265â†’                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   266â†’                    â”‚      soul_os.py (æ ¸å¿ƒåè°ƒå™¨)     â”‚
   267â†’                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   268â†’                           â”‚     â”‚     â”‚     â”‚
   269â†’    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   270â†’    â”‚                            â”‚     â”‚                            â”‚
   271â†’    â–¼                            â–¼     â–¼                            â–¼
   272â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   273â†’â”‚ L0 å®ç° âœ…         â”‚  â”‚ L1 å®ç° âœ…         â”‚  â”‚ L2 å®ç° âš ï¸                    â”‚
   274â†’â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   275â†’â”‚ â”‚ get_l0_facts()â”‚ â”‚  â”‚ â”‚ get_l1_schemaâ”‚ â”‚  â”‚ â”‚ search_knowledge_base()â”‚   â”‚
   276â†’â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   277â†’â”‚         â”‚         â”‚  â”‚         â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   278â†’â”‚         â–¼         â”‚  â”‚         â–¼         â”‚  â”‚ â”‚ check_anti_dependency()â”‚   â”‚
   279â†’â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   280â†’â”‚ â”‚ bazi_service  â”‚ â”‚  â”‚ â”‚ calculate_    â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   281â†’â”‚ â”‚ .py           â”‚ â”‚  â”‚ â”‚ perma()       â”‚ â”‚
   282â†’â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚            â”‚
   283â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚            â”‚
   284â†’                       â”‚ â”‚ calculate_    â”‚ â”‚            â”‚
   285â†’                       â”‚ â”‚ state_score() â”‚ â”‚            â–¼
   286â†’                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   287â†’                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ L3 å®ç° âœ…                    â”‚
   288â†’                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   289â†’                                              â”‚ â”‚ build_system_prompt()  â”‚   â”‚
   290â†’                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   291â†’                                              â”‚             â–¼                â”‚
   292â†’                                              â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
   293â†’                                              â”‚ â”‚ glm_client.py          â”‚   â”‚
   294â†’                                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
   295â†’                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   296â†’
   297â†’å›¾ä¾‹: âœ… å®Œæ•´å®ç° | âš ï¸ éƒ¨åˆ†å®ç°
   298â†’```
   299â†’</details>
   300â†’
   301â†’**å®ç°çŠ¶æ€çŸ©é˜µ**:
   302â†’
   303â†’| å±‚çº§ | ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
   304â†’|------|------|:----:|------|
   305â†’| L0 | çœŸå¤ªé˜³æ—¶æ ¡æ­£ | âœ… | swisseph |
   306â†’| L0 | å››æŸ±æ’ç›˜ | âœ… | lunar_python |
   307â†’| L0 | åç¥/ç¥ç…/å¤§è¿ | âœ… | å®Œæ•´å®ç° |
   308â†’| L0 | facts_hash | âœ… | å¯è¿½æº¯ |
   309â†’| L1 | PERMA äº”ç»´ | âœ… | è®¡ç®—æ­£ç¡® |
   310â†’| L1 | State Score | âœ… | èšåˆæ­£ç¡® |
   311â†’| L1 | è¡Œä¸ºè¯æ®å…³è” | âš ï¸ | å¾…å¢å¼º |
   312â†’| L2 | çŸ¥è¯†åº“æ£€ç´¢ | âœ… | FTS + trgm |
   313â†’| L2 | å¤šAgentå¹¶è¡Œ | âš ï¸ | ä»…å…«å­—Agent |
   314â†’| L3 | GLM è¾“å‡º | âœ… | A2UI JSON |
   315â†’| L3 | If-Then å¤„æ–¹ | âœ… | æ ¼å¼æ­£ç¡® |
   316â†’
   317â†’### 1.3 æœ€ä¼˜æ¶æ„ (å®Œæ•´å››å±‚ + ç›®æ ‡/å¤ç›˜é—­ç¯) âš ï¸ LEGACY
   318â†’
   319â†’> **âš ï¸ å†å²å‚è€ƒ**: æ­¤èŠ‚å±•ç¤º v2 å››å±‚æ—¶åºæµç¨‹ï¼Œä¿ç•™ä½œä¸ºå¯¹è¯æµç¨‹çš„å‚è€ƒã€‚
   320â†’> **âœ… æ–°æ¶æ„æ˜ å°„**:
   321â†’> - L0æ•°å­¦è„‘ â†’ L0 Base Data (ç”¨æˆ·åŸºç¡€æ¡£æ¡ˆ)
   322â†’> - L1å¿ƒç†è„‘ â†’ L1 Module Data (PERMA/å…«å­—ç­‰å¯æ’æ‹”æ•°æ®)
   323â†’> - L2çŸ¥è¯†è„‘ â†’ L2 Expert Agents (å…«å­—Agent/CBT Agentç­‰)
   324â†’> - L3è¯­è¨€è„‘ â†’ Context Management + Interaction Layer (å¤šæ¨¡å‹)
   325â†’
   326â†’```mermaid
   327â†’sequenceDiagram
   328â†’    autonumber
   329â†’    participant U as ç”¨æˆ·
   330â†’    participant FE as å‰ç«¯<br/>(Zone A/B)
   331â†’    participant API as FastAPI<br/>/api/*
   332â†’    participant OS as Soul OS<br/>åè°ƒå™¨
   333â†’    participant L0 as L0 æ•°å­¦è„‘
   334â†’    participant L1 as L1 å¿ƒç†è„‘
   335â†’    participant L2 as L2 çŸ¥è¯†è„‘
   336â†’    participant L3 as L3 è¯­è¨€è„‘
   337â†’    participant DB as PostgreSQL
   338â†’
   339â†’    U->>FE: è¾“å…¥æ¶ˆæ¯
   340â†’    FE->>API: POST /api/chat/send
   341â†’
   342â†’    rect rgb(240, 248, 255)
   343â†’        Note over OS,L2: get_full_context(user_id)
   344â†’        API->>OS: è¯·æ±‚ä¸Šä¸‹æ–‡
   345â†’        OS->>L0: get_l0_facts()
   346â†’        L0-->>OS: å…«å­— facts
   347â†’        OS->>L1: get_l1_schema()
   348â†’        L1-->>OS: PERMA + State Score
   349â†’        OS->>L2: search_knowledge_base()
   350â†’        L2-->>OS: kb_refs + rule_ids
   351â†’        OS->>DB: get_active_goals()
   352â†’        DB-->>OS: æ´»è·ƒç›®æ ‡åˆ—è¡¨
   353â†’    end
   354â†’
   355â†’    rect rgb(255, 248, 240)
   356â†’        Note over OS,L3: L3 Synthesis
   357â†’        OS->>L3: System Prompt + context
   358â†’        L3-->>OS: A2UI JSON<br/>(â‰¤3 If-Then å¤„æ–¹)
   359â†’    end
   360â†’
   361â†’    OS->>DB: INSERT conversation_message
   362â†’    OS->>DB: INSERT commitment (suggested)
   363â†’    OS-->>FE: A2UI å“åº”
   364â†’
   365â†’    FE->>FE: Zone A æ¸²æŸ“æ¶ˆæ¯
   366â†’    FE->>FE: Zone B åˆ·æ–°ä»»åŠ¡
   367â†’```
   368â†’
   369â†’<details>
   370â†’<summary>ğŸ“‹ ASCII ç‰ˆæœ¬ (ç‚¹å‡»å±•å¼€)</summary>
   371â†’
   372â†’```
   373â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   374â†’â”‚                    æœ€ä¼˜å››å±‚æ¶æ„ + ç›®æ ‡/å¤ç›˜é—­ç¯                                   â”‚
   375â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   376â†’
   377â†’  ç”¨æˆ·    å‰ç«¯Zone    FastAPI    SoulOS    L0æ•°å­¦    L1å¿ƒç†    L2çŸ¥è¯†    L3è¯­è¨€    DB
   378â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   379â†’   â”‚â”€â”€è¾“å…¥â”€â–¶â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   380â†’   â”‚        â”‚â”€â”€POSTâ”€â”€â”€â”€â–¶â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   381â†’   â”‚        â”‚ chat/send â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   382â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   383â†’   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   384â†’   â”‚        â”‚           â”‚ get_full_context(user_id)     â”‚         â”‚         â”‚        â”‚
   385â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   386â†’   â”‚        â”‚           â”‚â”€â”€è¯·æ±‚ä¸Šä¸‹æ–‡â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚         â”‚         â”‚        â”‚
   387â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   388â†’   â”‚        â”‚           â”‚          â”‚â”€â”€get_l0_facts()â”€â”€â–¶â”‚         â”‚         â”‚        â”‚
   389â†’   â”‚        â”‚           â”‚          â”‚â—€â”€å…«å­— factsâ”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚        â”‚
   390â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   391â†’   â”‚        â”‚           â”‚          â”‚â”€â”€get_l1_schema()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚         â”‚        â”‚
   392â†’   â”‚        â”‚           â”‚          â”‚â—€â”€PERMA + State Scoreâ”€â”€â”€â”€â”€â”€â”‚         â”‚        â”‚
   393â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   394â†’   â”‚        â”‚           â”‚          â”‚â”€â”€search_kb()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚        â”‚
   395â†’   â”‚        â”‚           â”‚          â”‚â—€â”€kb_refs + rule_idsâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚        â”‚
   396â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   397â†’   â”‚        â”‚           â”‚          â”‚â”€â”€get_active_goals()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   398â†’   â”‚        â”‚           â”‚          â”‚â—€â”€ç›®æ ‡åˆ—è¡¨â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   399â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   400â†’   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   401â†’   â”‚        â”‚           â”‚ L3 Synthesis        â”‚         â”‚         â”‚         â”‚        â”‚
   402â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   403â†’   â”‚        â”‚           â”‚          â”‚â”€â”€System Prompt + contextâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   404â†’   â”‚        â”‚           â”‚          â”‚â—€â”€A2UI JSON (â‰¤3 If-Then å¤„æ–¹)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   405â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   406â†’   â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•
   407â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   408â†’   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT conversation_messageâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   409â†’   â”‚        â”‚           â”‚          â”‚â”€â”€INSERT commitment (suggested)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
   410â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   411â†’   â”‚        â”‚â—€â”€â”€A2UI å“åº”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   412â†’   â”‚        â”‚â”€â”€Zone A æ¸²æŸ“æ¶ˆæ¯      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   413â†’   â”‚        â”‚â”€â”€Zone B åˆ·æ–°ä»»åŠ¡      â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   414â†’   â”‚        â”‚           â”‚          â”‚         â”‚         â”‚         â”‚         â”‚        â”‚
   415â†’```
   416â†’</details>
   417â†’
   418â†’**ä¼˜åŒ–é¡¹**:
   419â†’
   420â†’| ä¼˜å…ˆçº§ | æ”¹è¿›é¡¹ | è¯´æ˜ |
   421â†’|:------:|--------|------|
   422â†’| P0 | action_buttons + CSRF | å‰ç«¯ç‚¹å‡»å¤„ç† |
   423â†’| P1 | anti-dependency è±å… | æ–°ç”¨æˆ· 7 å¤©è±å… |
   424â†’| P1 | å¤„æ–¹å…³è”ç›®æ ‡ | è‡ªåŠ¨å…³è”æ´»è·ƒç›®æ ‡ |
   425â†’| P2 | å¤šAgentå¹¶è¡Œ | å…«å­—/å¿ƒç†/è¡ŒåŠ¨ Agent |
   426â†’| P2 | å…¨é“¾è·¯è¿½è¸ª | correlation_id |
   427â†’
   428â†’### 1.4 è¿›åŒ–è®°å¿†æ¶æ„ (Vercel AI SDK Edition) - v4.2
   429â†’
   430â†’> **v4.2 æ ¸å¿ƒ**: Vercel AI SDK ç»Ÿä¸€ Agent Runtime + åŒè·¯å¾„è®¾è®¡ (Hot Path + Cold Path)
   431â†’> **é‡æ„æ–¹æ¡ˆ**: è¯¦è§ [restructure_v3.md](./restructure_v3.md)
   432â†’
   433â†’```
   434â†’+============================================================================================+
   435â†’|                            Soul OS Architecture v4.2                                        |
   436â†’|                       (Vercel AI SDK Driven / Pluggable Skills)                             |
   437â†’+============================================================================================+
   438â†’                                            ^
   439â†’                            1. æµå¼å“åº” (Stream Response)
   440â†’+--------------------------------------------------------------------------------------------+
   441â†’|  Frontend Layer (React / Next.js)                                                          |
   442â†’+--------------------------------------------------------------------------------------------+
   443â†’|  [ useChat() Hook ]  â†â†’  [ toDataStreamResponse() ]  â†â†’  [ Message Annotations ]          |
   444â†’|  [ CommandPalette ]  â†â†’  [ /command Parser ]        â†â†’  [ A2UI Renderer ]                 |
   445â†’+--------------------------------------------------------------------------------------------+
   446â†’                                            ^
   447â†’                                            | HTTP Stream (text/event-stream)
   448â†’+--------------------------------------------------------------------------------------------+
   449â†’|  Agent Runtime Layer (Next.js API Route)                                     NEW in v4.2   |
   450â†’+--------------------------------------------------------------------------------------------+
   451â†’|  [ Vercel AI SDK `streamText()` ]                                                          |
   452â†’|  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  |
   453â†’|  â”‚  const result = await streamText({                                                   â”‚  |
   454â†’|  â”‚    model: selectModel(user.preference),  // GLM-4.5 / Gemini / Claude               â”‚  |
   455â†’|  â”‚    system: buildSystemPrompt(context),   // Context Manager ç»„è£…                    â”‚  |
   456â†’|  â”‚    messages: history,                                                               â”‚  |
   457â†’|  â”‚    tools: getToolsForMode(mode),         // Skills Registry ç­›é€‰                    â”‚  |
   458â†’|  â”‚    maxSteps: 5,                          // Agent Loop å¤šæ­¥æ¨ç†                     â”‚  |
   459â†’|  â”‚  });                                                                                 â”‚  |
   460â†’|  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  |
   461â†’+--------------------------------------------------------------------------------------------+
   462â†’        |                           |                               |
   463â†’        | Model Provider            | Tools (Skills)                | Context
   464â†’        v                           v                               v
   465â†’+------------------+  +---------------------------+  +----------------------------------+
   466â†’| Multi-Model Hub  |  | Skills Registry (Tools)   |  | Context Manager v4.2             |
   467â†’+------------------+  +---------------------------+  +----------------------------------+
   468â†’| @ai-sdk/google   |  | Divine Skills:            |  | L0 Base Data (Profile/Status)   |
   469â†’|   â””â”€ Gemini 2.0  |  |   - calculate_bazi        |  | L1 Module Data (PERMA/Covey)    |
   470â†’| Vercel Gateway   |  |   - calculate_ziwei       |  | Vector History (Long-term Mem)  |
   471â†’|   â””â”€ GLM-4.5     |  | Heal Skills:              |  | User Input + Command            |
   472â†’| @ai-sdk/anthropic|  |   - log_perma             |  +----------------------------------+
   473â†’|   â””â”€ Claude      |  |   - cbt_reframe           |            |
   474â†’+------------------+  | Grow Skills:              |            | fetch()
   475â†’                      |   - covey_matrix          |            v
   476â†’                      |   - goal_setting          |  +----------------------------------+
   477â†’                      +---------------------------+  | FastAPI (Python) - Data Service  |
   478â†’                                |                    +----------------------------------+
   479â†’                                | Tool Execute       | GET  /api/bazi/calculate        |
   480â†’                                | fetch() call       | GET  /api/user/context          |
   481â†’                                v                    | POST /api/perma/log             |
   482â†’                      +---------------------------+  | GET  /api/goals/active          |
   483â†’                      | Python Data Layer         |  +----------------------------------+
   484â†’                      +---------------------------+
   485â†’                      | L1 Module Services:       |
   486â†’                      |   bazi_service.py         |
   487â†’                      |   perma_service.py        |
   488â†’                      |   goal_service.py         |
   489â†’                      +---------------------------+
   490â†’                      | L0 Base Services:         |
   491â†’                      |   twin_service.py         |
   492â†’                      |   fortune_db.py           |
   493â†’                      +---------------------------+
   494â†’                                ^
   495â†’                                | 2. Cold Path (å¼‚æ­¥æ´å¯Ÿ)
   496â†’+-------------------------------+--------------------------------------------------------+
   497â†’| Insight & Memory Agent (Cold Path Worker)                                               |
   498â†’+-----------------------------------------------------------------------------------------+
   499â†’|  [ åå° Cron / Queue Worker ]                                                           |
   500â†’|  - åˆ†æå¯¹è¯å†å²ï¼Œæå–äº‹å®/åå¥½/çŠ¶æ€                                                     |
   501â†’|  - åå†™ L0 Profile (job, tags, status)                                                  |
   502â†’|  - åå†™ L1 Module Data (PERMA scores, CBT triggers)                                     |
   503â†’+-----------------------------------------------------------------------------------------+
   504â†’```
   505â†’
   506â†’**æ¶æ„å±‚æ¬¡è¯´æ˜ (v4.2)**:
   507â†’
   508â†’| å±‚çº§ | å®šä¹‰ | æŠ€æœ¯å®ç° | è¿è¡Œç¯å¢ƒ | èŒè´£ |
   509â†’|------|------|----------|----------|------|
   510â†’| **Frontend** | UI äº¤äº’å±‚ | `useChat()` Hook | Next.js Client | æµå¼æ¸²æŸ“ã€Command è§£æ |
   511â†’| **Agent Runtime** | AI æ¨ç†å±‚ | `streamText()` + `tool()` | Next.js API Route | **æ ¸å¿ƒ**: LLM è°ƒç”¨ä¸ Tool Calling |
   512â†’| **Multi-Model Hub** | æ¨¡å‹æä¾›å±‚ | Vercel AI Gateway | Serverless | GLM-4.5 / Gemini / Claude åŠ¨æ€åˆ‡æ¢ |
   513â†’| **Skills Registry** | æŠ€èƒ½æ³¨å†Œå±‚ | Zod Schema + Execute | TypeScript | å¯æ’æ‹” Tools å®šä¹‰ |
   514â†’| **Context Manager** | ä¸Šä¸‹æ–‡ç»„è£… | Python API + TS fetch | Hybrid | L0+L1+History èšåˆ |
   515â†’| **Data Service** | æ•°æ®æœåŠ¡å±‚ | FastAPI | Python | L0/L1 CRUD + ä¸šåŠ¡é€»è¾‘ |
   516â†’| **Insight Agent** | æ´å¯Ÿç®—å­ | Cron Worker | Python | Cold Path æ•°æ®æ²‰æ·€ |
   517â†’
   518â†’**å…³é”®è®¾è®¡åŸåˆ™ (v4.2)**:
   519â†’
   520â†’1. **Agent Runtime ç»Ÿä¸€**: æ‰€æœ‰ AI æ¨ç†é€»è¾‘é›†ä¸­åœ¨ Next.js API Routeï¼Œä½¿ç”¨ Vercel AI SDK æ ‡å‡†åŒ–æ¥å£
   521â†’2. **Tool Calling æ ‡å‡†åŒ–**: L2 Expert Agents é‡æ„ä¸º `tool({ description, parameters, execute })` æ ¼å¼
   522â†’3. **æµå¼ä¼˜å…ˆ**: `toDataStreamResponse()` + `useChat()` å®ç°ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“
   523â†’4. **è·¨è¯­è¨€æ¡¥æ¥**: Tool execute å‡½æ•°é€šè¿‡ `fetch()` è°ƒç”¨ Python FastAPIï¼Œä¿ç•™ç°æœ‰æ•°æ®æœåŠ¡
   524â†’5. **å¤šæ¨¡å‹çƒ­åˆ‡æ¢**: é€šè¿‡ `selectModel()` æ ¹æ®ç”¨æˆ·åå¥½æˆ–åŠŸèƒ½éœ€æ±‚åŠ¨æ€é€‰æ‹© GLM/Gemini/Claude
   525â†’6. **maxSteps å¤šæ­¥æ¨ç†**: å¯ç”¨ Agent Loopï¼Œå•æ¬¡è¯·æ±‚å¯å¤šæ¬¡ Tool è°ƒç”¨åç»¼åˆè¾“å‡º
   526â†’
   527â†’### 1.5 Agent Runtime & Skills (Vercel AI SDK Implementation) - v4.2
   528â†’
   529â†’> **è®¾è®¡ç†å¿µ**: ä½¿ç”¨ Vercel AI SDK 6 ä½œä¸ºç»Ÿä¸€ Agent Runtimeï¼Œå°† L2 Agents é‡æ„ä¸ºæ ‡å‡†åŒ–çš„ `tool()` å®šä¹‰ï¼Œå®ç°ç±»å‹å®‰å…¨çš„ Tool Callingã€‚
   530â†’> **æ ¸å¿ƒä»·å€¼**: ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“ + å¤šæ¨¡å‹çƒ­åˆ‡æ¢ + maxSteps å¤šæ­¥æ¨ç†
   531â†’
   532â†’#### 1.5.1 Skills Registry (Vercel Tools)
   533â†’
   534â†’Skills ä½¿ç”¨ Vercel AI SDK çš„ `tool()` å‡½æ•°å®šä¹‰ï¼Œé‡‡ç”¨ Zod Schema è¿›è¡Œç±»å‹éªŒè¯ï¼š
   535â†’
   536â†’```typescript
   537â†’// lib/skills/divine-skills.ts
   538â†’import { tool } from 'ai';
   539â†’import { z } from 'zod';
   540â†’
   541â†’export const divineSkills = {
   542â†’  calculate_bazi: tool({
   543â†’    description: 'è®¡ç®—ç”¨æˆ·çš„å…«å­—å‘½ç›˜ï¼Œè¿”å›å››æŸ±ã€äº”è¡Œã€åç¥ã€ç¥ç…ç­‰ä¿¡æ¯',
   544â†’    parameters: z.object({
   545â†’      birth_datetime: z.string().describe('å‡ºç”Ÿæ—¥æœŸæ—¶é—´ (ISO 8601)'),
   546â†’      timezone: z.string().default('Asia/Shanghai').describe('æ—¶åŒºæ ‡è¯†'),
   547â†’      include_dayun: z.boolean().default(true).describe('æ˜¯å¦åŒ…å«å¤§è¿ä¿¡æ¯'),
   548â†’    }),
   549â†’    execute: async ({ birth_datetime, timezone, include_dayun }) => {
   550â†’      // è°ƒç”¨ Python FastAPI åç«¯
   551â†’      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
   552â†’        method: 'POST',
   553â†’        headers: { 'Content-Type': 'application/json' },
   554â†’        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),
   555â†’      });
   556â†’      return res.json();
   557â†’    },
   558â†’  }),
   559â†’
   560â†’  calculate_ziwei: tool({
   561â†’    description: 'è®¡ç®—ç´«å¾®æ–—æ•°å‘½ç›˜ï¼Œè¿”å›å‘½å®«ã€åäºŒå®«ä½ã€æµå¹´ä¿¡æ¯',
   562â†’    parameters: z.object({
   563â†’      birth_datetime: z.string(),
   564â†’      gender: z.enum(['male', 'female']),
   565â†’    }),
   566â†’    execute: async ({ birth_datetime, gender }) => {
   567â†’      const res = await fetch(`${FASTAPI_URL}/api/ziwei/calculate`, {
   568â†’        method: 'POST',
   569â†’        body: JSON.stringify({ birth_datetime, gender }),
   570â†’      });
   571â†’      return res.json();
   572â†’    },
   573â†’  }),
   574â†’};
   575â†’```
   576â†’
   577â†’```typescript
   578â†’// lib/skills/heal-skills.ts
   579â†’export const healSkills = {
   580â†’  log_perma: tool({
   581â†’    description: 'è®°å½•æˆ–æŸ¥è¯¢ç”¨æˆ·çš„ PERMA äº”ç»´å¿ƒç†çŠ¶æ€åˆ†æ•°',
   582â†’    parameters: z.object({
   583â†’      action: z.enum(['log', 'query']),
   584â†’      dimension: z.enum(['P', 'E', 'R', 'M', 'A']).optional(),
   585â†’      score_delta: z.number().min(-1).max(1).optional(),
   586â†’    }),
   587â†’    execute: async ({ action, dimension, score_delta }) => {
   588â†’      const res = await fetch(`${FASTAPI_URL}/api/perma/${action}`, {
   589â†’        method: action === 'log' ? 'POST' : 'GET',
   590â†’        body: action === 'log' ? JSON.stringify({ dimension, score_delta }) : undefined,
   591â†’      });
   592â†’      return res.json();
   593â†’    },
   594â†’  }),
   595â†’
   596â†’  cbt_reframe: tool({
   597â†’    description: 'ä½¿ç”¨ CBT ABC æ¨¡å‹è¿›è¡Œè®¤çŸ¥é‡æ„å¼•å¯¼',
   598â†’    parameters: z.object({
   599â†’      activating_event: z.string().describe('è§¦å‘äº‹ä»¶ (A)'),
   600â†’      belief: z.string().optional().describe('ä¿¡å¿µ/æƒ³æ³• (B)'),
   601â†’      consequence: z.string().optional().describe('æƒ…ç»ª/è¡Œä¸ºåæœ (C)'),
   602â†’    }),
   603â†’    execute: async (params) => {
   604â†’      // è¿”å› CBT å¼•å¯¼æ¡†æ¶ï¼Œè®© LLM ç»§ç»­å¼•å¯¼ç”¨æˆ·
   605â†’      return {
   606â†’        framework: 'ABC',
   607â†’        guidance: `è®©æˆ‘ä»¬ç”¨ ABC æ¨¡å‹æ¥åˆ†æè¿™ä¸ªæƒ…å†µ...`,
   608â†’        params,
   609â†’      };
   610â†’    },
   611â†’  }),
   612â†’
   613â†’  mood_checkin: tool({
   614â†’    description: 'å¿«é€Ÿæƒ…ç»ªæ‰“å¡ï¼Œè®°å½•å½“å‰å¿ƒæƒ…å’Œå½’å› ',
   615â†’    parameters: z.object({
   616â†’      mood_score: z.number().min(1).max(10).describe('å¿ƒæƒ…åˆ†æ•° 1-10'),
   617â†’      tags: z.array(z.string()).optional().describe('æƒ…ç»ªæ ‡ç­¾'),
   618â†’      note: z.string().optional().describe('ç®€çŸ­å¤‡æ³¨'),
   619â†’    }),
   620â†’    execute: async ({ mood_score, tags, note }) => {
   621â†’      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {
   622â†’        method: 'POST',
   623â†’        body: JSON.stringify({ mood_score, tags, note }),
   624â†’      });
   625â†’      return res.json();
   626â†’    },
   627â†’  }),
   628â†’};
   629â†’```
   630â†’
   631â†’```typescript
   632â†’// lib/skills/grow-skills.ts
   633â†’export const growSkills = {
   634â†’  covey_matrix: tool({
   635â†’    description: 'ä½¿ç”¨é«˜æ•ˆèƒ½äººå£«æ—¶é—´ç®¡ç†çŸ©é˜µåˆ†ç±»ä»»åŠ¡',
   636â†’    parameters: z.object({
   637â†’      task_content: z.string().describe('ä»»åŠ¡æè¿°'),
   638â†’      urgency: z.enum(['urgent', 'not_urgent']),
   639â†’      importance: z.enum(['important', 'not_important']),
   640â†’    }),
   641â†’    execute: async ({ task_content, urgency, importance }) => {
   642â†’      const quadrant =
   643â†’        urgency === 'urgent' && importance === 'important' ? 'Q1' :
   644â†’        urgency === 'not_urgent' && importance === 'important' ? 'Q2' :
   645â†’        urgency === 'urgent' && importance === 'not_important' ? 'Q3' : 'Q4';
   646â†’
   647â†’      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {
   648â†’        method: 'POST',
   649â†’        body: JSON.stringify({ task_content, quadrant }),
   650â†’      });
   651â†’      return { quadrant, ...await res.json() };
   652â†’    },
   653â†’  }),
   654â†’
   655â†’  goal_setting: tool({
   656â†’    description: 'ä½¿ç”¨ WOOP æ¨¡å‹è®¾å®šç›®æ ‡ (Wish-Outcome-Obstacle-Plan)',
   657â†’    parameters: z.object({
   658â†’      wish: z.string().describe('æ„¿æœ›/ç›®æ ‡'),
   659â†’      outcome: z.string().optional().describe('æœ€ä½³ç»“æœ'),
   660â†’      obstacle: z.string().optional().describe('å†…åœ¨éšœç¢'),
   661â†’      plan: z.string().optional().describe('If-Then è®¡åˆ’'),
   662â†’    }),
   663â†’    execute: async (params) => {
   664â†’      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {
   665â†’        method: 'POST',
   666â†’        body: JSON.stringify(params),
   667â†’      });
   668â†’      return res.json();
   669â†’    },
   670â†’  }),
   671â†’};
   672â†’```
   673â†’
   674â†’**Skills åˆ†ç±»è¡¨**:
   675â†’
   676â†’| ç±»åˆ« | è§¦å‘æŒ‡ä»¤ | Tool Name | Python API Endpoint | åŠŸèƒ½ |
   677â†’|------|----------|-----------|---------------------|------|
   678â†’| **Divine** | `/divine` | `calculate_bazi` | `/api/bazi/calculate` | å…«å­—æ’ç›˜è®¡ç®— |
   679â†’|  |  | `calculate_ziwei` | `/api/ziwei/calculate` | ç´«å¾®æ–—æ•°è®¡ç®— |
   680â†’|  |  | `astro_chart` | `/api/astro/chart` | æ˜Ÿåº§æ˜Ÿç›˜ |
   681â†’| **Heal** | `/heal` | `log_perma` | `/api/perma/{action}` | PERMA çŠ¶æ€è®°å½• |
   682â†’|  |  | `cbt_reframe` | - (LLM å†…ç½®) | è®¤çŸ¥é‡æ„å¼•å¯¼ |
   683â†’|  |  | `mood_checkin` | `/api/checkin/mood` | æƒ…ç»ªæ‰“å¡ |
   684â†’| **Grow** | `/grow` | `covey_matrix` | `/api/tasks/create` | æ—¶é—´ç®¡ç†çŸ©é˜µ |
   685â†’|  |  | `goal_setting` | `/api/goals/create` | WOOP ç›®æ ‡è®¾å®š |
   686â†’
   687â†’#### 1.5.2 Agent Runtime API Route
   688â†’
   689â†’æ ¸å¿ƒ API Route ä½¿ç”¨ `streamText()` å¤„ç†èŠå¤©è¯·æ±‚ï¼š
   690â†’
   691â†’```typescript
   692â†’// app/api/chat/route.ts
   693â†’import { streamText, tool } from 'ai';
   694â†’import { createGoogleGenerativeAI } from '@ai-sdk/google';
   695â†’import { divineSkills } from '@/lib/skills/divine-skills';
   696â†’import { healSkills } from '@/lib/skills/heal-skills';
   697â†’import { growSkills } from '@/lib/skills/grow-skills';
   698â†’
   699â†’// Multi-Model Provider Setup
   700â†’const providers = {
   701â†’  gemini: createGoogleGenerativeAI({ apiKey: process.env.GOOGLE_API_KEY }),
   702â†’  // GLM via Vercel AI Gateway
   703â†’  glm: createGoogleGenerativeAI({
   704â†’    baseURL: 'https://gateway.ai.cloudflare.com/v1/xxx/glm',
   705â†’    apiKey: process.env.GLM_API_KEY
   706â†’  }),
   707â†’};
   708â†’
   709â†’export async function POST(req: Request) {
   710â†’  const { messages, userId, mode, command } = await req.json();
   711â†’
   712â†’  // 1. è·å–ç”¨æˆ·ä¸Šä¸‹æ–‡ (è°ƒç”¨ Python FastAPI)
   713â†’  const context = await fetch(`${FASTAPI_URL}/api/user/${userId}/context`).then(r => r.json());
   714â†’
   715â†’  // 2. æ„å»º System Prompt
   716â†’  const systemPrompt = buildSystemPrompt(context, mode, command);
   717â†’
   718â†’  // 3. æ ¹æ®æ¨¡å¼ç­›é€‰ Tools
   719â†’  const tools = getToolsForMode(mode, command);
   720â†’
   721â†’  // 4. é€‰æ‹©æ¨¡å‹
   722â†’  const model = selectModel(context.user_preference);
   723â†’
   724â†’  // 5. æµå¼ç”Ÿæˆ
   725â†’  const result = await streamText({
   726â†’    model,
   727â†’    system: systemPrompt,
   728â†’    messages,
   729â†’    tools,
   730â†’    maxSteps: 5,  // å¯ç”¨å¤šæ­¥æ¨ç†
   731â†’    onStepFinish: async ({ stepType, toolCalls, toolResults }) => {
   732â†’      // è®°å½• Tool è°ƒç”¨æ—¥å¿—
   733â†’      if (toolCalls) {
   734â†’        await logToolCalls(userId, toolCalls, toolResults);
   735â†’      }
   736â†’    },
   737â†’  });
   738â†’
   739â†’  return result.toDataStreamResponse();
   740â†’}
   741â†’
   742â†’// æ ¹æ®æ¨¡å¼ç­›é€‰ Tools
   743â†’function getToolsForMode(mode: string, command?: string) {
   744â†’  const allTools = { ...divineSkills, ...healSkills, ...growSkills };
   745â†’
   746â†’  if (command) {
   747â†’    // Command Mode: åªæš´éœ²å¯¹åº”ç±»åˆ«çš„ Tools
   748â†’    const toolMap: Record<string, string[]> = {
   749â†’      '/divine': ['calculate_bazi', 'calculate_ziwei', 'astro_chart'],
   750â†’      '/heal': ['log_perma', 'cbt_reframe', 'mood_checkin'],
   751â†’      '/grow': ['covey_matrix', 'goal_setting'],
   752â†’    };
   753â†’    const allowedTools = toolMap[command] || [];
   754â†’    return Object.fromEntries(
   755â†’      Object.entries(allTools).filter(([name]) => allowedTools.includes(name))
   756â†’    );
   757â†’  }
   758â†’
   759â†’  // Chat Mode: æš´éœ²æ‰€æœ‰ Toolsï¼Œè®© LLM è‡ªè¡Œé€‰æ‹©
   760â†’  return allTools;
   761â†’}
   762â†’
   763â†’// é€‰æ‹©æ¨¡å‹
   764â†’function selectModel(preference?: string) {
   765â†’  const modelMap: Record<string, any> = {
   766â†’    'glm': providers.glm('glm-4'),
   767â†’    'gemini': providers.gemini('gemini-2.0-flash'),
   768â†’    'default': providers.gemini('gemini-2.0-flash'),
   769â†’  };
   770â†’  return modelMap[preference || 'default'];
   771â†’}
   772â†’```
   773â†’
   774â†’#### 1.5.3 Frontend Integration (useChat Hook)
   775â†’
   776â†’å‰ç«¯ä½¿ç”¨ `useChat` Hook å®ç°æµå¼æ¸²æŸ“ï¼š
   777â†’
   778â†’```typescript
   779â†’// components/chat.tsx
   780â†’'use client';
   781â†’import { useChat } from 'ai/react';
   782â†’import { useState } from 'react';
   783â†’import { CommandPalette } from './command-palette';
   784â†’
   785â†’export function Chat({ userId }: { userId: string }) {
   786â†’  const [command, setCommand] = useState<string | null>(null);
   787â†’
   788â†’  const { messages, input, setInput, handleSubmit, isLoading } = useChat({
   789â†’    api: '/api/chat',
   790â†’    body: { userId, command },
   791â†’    onFinish: (message) => {
   792â†’      // æ¸…é™¤ command çŠ¶æ€
   793â†’      setCommand(null);
   794â†’    },
   795â†’  });
   796â†’
   797â†’  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
   798â†’    const value = e.target.value;
   799â†’    setInput(value);
   800â†’
   801â†’    // æ£€æµ‹ / æŒ‡ä»¤
   802â†’    if (value.startsWith('/')) {
   803â†’      // æ˜¾ç¤º CommandPalette
   804â†’    }
   805â†’  };
   806â†’
   807â†’  const handleCommandSelect = (cmd: string) => {
   808â†’    setCommand(cmd);
   809â†’    setInput('');  // æ¸…ç©ºè¾“å…¥æ¡†
   810â†’  };
   811â†’
   812â†’  return (
   813â†’    <div className="chat-container">
   814â†’      {/* æ¶ˆæ¯åˆ—è¡¨ */}
   815â†’      <div className="messages">
   816â†’        {messages.map((m) => (
   817â†’          <div key={m.id} className={`message ${m.role}`}>
   818â†’            {m.content}
   819â†’            {/* æ¸²æŸ“ Tool è°ƒç”¨ç»“æœ */}
   820â†’            {m.toolInvocations?.map((tool) => (
   821â†’              <ToolResultRenderer key={tool.toolCallId} tool={tool} />
   822â†’            ))}
   823â†’          </div>
   824â†’        ))}
   825â†’      </div>
   826â†’
   827â†’      {/* Command Palette */}
   828â†’      <CommandPalette
   829â†’        visible={input.startsWith('/')}
   830â†’        onSelect={handleCommandSelect}
   831â†’      />
   832â†’
   833â†’      {/* è¾“å…¥æ¡† */}
   834â†’      <form onSubmit={handleSubmit}>
   835â†’        <input
   836â†’          value={input}
   837â†’          onChange={handleInputChange}
   838â†’          placeholder={command ? `${command} æ¨¡å¼å·²æ¿€æ´»...` : 'è¾“å…¥æ¶ˆæ¯æˆ– / æŒ‡ä»¤...'}
   839â†’        />
   840â†’        <button type="submit" disabled={isLoading}>
   841â†’          {isLoading ? 'æ€è€ƒä¸­...' : 'å‘é€'}
   842â†’        </button>
   843â†’      </form>
   844â†’    </div>
   845â†’  );
   846â†’}
   847â†’```
   848â†’
   849â†’#### 1.5.4 Command Protocol (v4.2)
   850â†’
   851â†’Command æ¨¡å¼åœ¨ v4.2 ä¸­é€šè¿‡ **Tool ç­›é€‰ + System Prompt æ³¨å…¥** å®ç°ï¼š
   852â†’
   853â†’```typescript
   854â†’// Command Mode: æ„å»ºå¼ºåˆ¶æ‰§è¡Œçš„ System Prompt
   855â†’function buildSystemPrompt(context: UserContext, mode: string, command?: string) {
   856â†’  let prompt = BASE_SYSTEM_PROMPT;
   857â†’
   858â†’  // æ³¨å…¥ç”¨æˆ·ä¸Šä¸‹æ–‡
   859â†’  prompt += `\n\n## ç”¨æˆ·æ¡£æ¡ˆ\n${JSON.stringify(context.profile)}`;
   860â†’  prompt += `\n\n## å½“å‰çŠ¶æ€\n${JSON.stringify(context.status)}`;
   861â†’
   862â†’  if (command) {
   863â†’    // Command Mode: å¼ºåˆ¶ä½¿ç”¨ç‰¹å®š Tool
   864â†’    const commandConfig: Record<string, string> = {
   865â†’      '/divine': `ç”¨æˆ·æ˜¾å¼è§¦å‘äº†ã€ç„å­¦æµ‹ç®—ã€‘æ¨¡å¼ã€‚ä½ å¿…é¡»ä½¿ç”¨ calculate_bazi æˆ–ç›¸å…³å·¥å…·è¿›è¡Œåˆ†æã€‚`,
   866â†’      '/heal': `ç”¨æˆ·æ˜¾å¼è§¦å‘äº†ã€å¿ƒç†ç–—æ„ˆã€‘æ¨¡å¼ã€‚ä¼˜å…ˆä½¿ç”¨ mood_checkin æˆ– cbt_reframe å·¥å…·ã€‚`,
   867â†’      '/grow': `ç”¨æˆ·æ˜¾å¼è§¦å‘äº†ã€æˆé•¿æ•™ç»ƒã€‘æ¨¡å¼ã€‚ä½¿ç”¨ goal_setting æˆ– covey_matrix å·¥å…·å¸®åŠ©ç”¨æˆ·ã€‚`,
   868â†’    };
   869â†’    prompt += `\n\n## æŒ‡ä»¤æ¨¡å¼\n${commandConfig[command] || ''}`;
   870â†’  }
   871â†’
   872â†’  return prompt;
   873â†’}
   874â†’```
   875â†’
   876â†’**Command åè®®è¡¨**:
   877â†’
   878â†’| æŒ‡ä»¤ | æ¨¡å¼åç§° | ç­›é€‰ Tools | System Prompt æ³¨å…¥ |
   879â†’|------|----------|------------|-------------------|
   880â†’| `/divine` | ç„å­¦æµ‹ç®— | `calculate_bazi`, `calculate_ziwei`, `astro_chart` | å¼ºåˆ¶ä½¿ç”¨ç„å­¦åˆ†æå·¥å…· |
   881â†’| `/heal` | å¿ƒç†ç–—æ„ˆ | `log_perma`, `cbt_reframe`, `mood_checkin` | ä¼˜å…ˆæƒ…ç»ªå…³æ€€ä¸è®¤çŸ¥é‡æ„ |
   882â†’| `/grow` | æˆé•¿æ•™ç»ƒ | `covey_matrix`, `goal_setting` | èšç„¦ç›®æ ‡ä¸ä»»åŠ¡ç®¡ç† |
   883â†’| `/status` | çŠ¶æ€æŸ¥è¯¢ | `log_perma` (query mode) | è¿”å›å½“å‰å¿ƒç†çŠ¶æ€æ‘˜è¦ |
   884â†’
   885â†’#### 1.5.5 æµå¼å“åº”ä¸ A2UI é€‚é…
   886â†’
   887â†’v4.2 ä½¿ç”¨ `toDataStreamResponse()` æ ‡å‡†åŒ–æµå¼è¾“å‡ºï¼ŒA2UI å—é€šè¿‡ Message Annotations ä¼ é€’ï¼š
   888â†’
   889â†’```typescript
   890â†’// A2UI æ ¼å¼é€šè¿‡ Tool Result è¿”å›ï¼Œå‰ç«¯è§£ææ¸²æŸ“
   891â†’// ç¤ºä¾‹: calculate_bazi è¿”å›ç»“æ„åŒ–æ•°æ®
   892â†’
   893â†’// Tool execute è¿”å›
   894â†’return {
   895â†’  type: 'a2ui_card',
   896â†’  data: {
   897â†’    title: 'å…«å­—å‘½ç›˜åˆ†æ',
   898â†’    sections: [
   899â†’      { type: 'text', content: 'æ‚¨çš„æ—¥ä¸»ä¸ºã€ç”²æœ¨ã€‘...' },
   900â†’      { type: 'chart', data: baziChart },
   901â†’      { type: 'action_buttons', buttons: [
   902â†’        { label: 'æŸ¥çœ‹å¤§è¿', action: 'divine', params: { include_dayun: true } },
   903â†’        { label: 'æƒ…ç»ªæ‰“å¡', action: 'heal', params: { mode: 'checkin' } },
   904â†’      ]},
   905â†’    ],
   906â†’  },
   907â†’};
   908â†’```
   909â†’
   910â†’```typescript
   911â†’// å‰ç«¯ A2UI æ¸²æŸ“å™¨
   912â†’function ToolResultRenderer({ tool }: { tool: ToolInvocation }) {
   913â†’  if (tool.state !== 'result') return null;
   914â†’
   915â†’  const result = tool.result;
   916â†’  if (result.type === 'a2ui_card') {
   917â†’    return <A2UICard data={result.data} />;
   918â†’  }
   919â†’
   920â†’  // é»˜è®¤ JSON æ¸²æŸ“
   921â†’  return <pre>{JSON.stringify(result, null, 2)}</pre>;
   922â†’}
   923â†’```
   924â†’
   925â†’#### 1.5.6 å®ç°çŠ¶æ€ (v4.2)
   926â†’
   927â†’| ç»„ä»¶ | è®¾è®¡ | TypeScript | Python API | è¯´æ˜ |
   928â†’|------|:----:|:----------:|:----------:|------|
   929â†’| Agent Runtime | âœ… | âš ï¸ | - | Next.js API Route å¾…åˆ›å»º |
   930â†’| `divineSkills` | âœ… | âš ï¸ | âœ… | å…«å­— API å·²å°±ç»ª |
   931â†’| `healSkills` | âœ… | âš ï¸ | âš ï¸ | PERMA/CBT API å¾…å®Œå–„ |
   932â†’| `growSkills` | âœ… | âš ï¸ | âœ… | Goal API å·²å°±ç»ª |
   933â†’| `useChat` Hook | âœ… | âš ï¸ | - | å‰ç«¯å¾…é‡æ„ |
   934â†’| Command Parser | âœ… | âš ï¸ | - | å‰ç«¯ CommandPalette å¾…å®ç° |
   935â†’| Multi-Model Hub | âœ… | âš ï¸ | - | Vercel AI Gateway é…ç½®å¾…å®Œæˆ |
   936â†’| A2UI Streaming | âœ… | âš ï¸ | - | Tool Result æ ¼å¼å¾…é€‚é… |
   937â†’
   938â†’---
   939â†’
   940â†’## 2. è®°å¿†æ²‰æ·€ä¸è¿›åŒ–å›è·¯ (Memory Sedimentation & Evolutionary Loop)
   941â†’
   942â†’> **v4.0 æ ¸å¿ƒå‡çº§**: Soul OS ä¸å†æ˜¯å•å‘çš„"è¯»å–æ•°æ® â†’ ç”Ÿæˆå›ç­”"ï¼Œè€Œæ˜¯åŒå‘é—­ç¯çš„**è¿›åŒ–ç³»ç»Ÿ**ã€‚
   943â†’> **æ‰¿è¯ºçŠ¶æ€æœº**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§5
   944â†’> **åŒ—ææ˜ŸæŒ‡æ ‡**: å‚è§ [GLOSSARY.md](../GLOSSARY.md) Â§10 WCG
   945â†’
   946â†’### 2.1 åŒè·¯å¾„æ¶æ„ (Hot Path + Cold Path)
   947â†’
   948â†’| è·¯å¾„ | ç±»å‹ | èŒè´£ | å»¶è¿Ÿè¦æ±‚ |
   949â†’|------|------|------|----------|
   950â†’| **Hot Path** | åŒæ­¥ | è¯»å– L0/L1 â†’ ç»„è£… Context â†’ ç”Ÿæˆå›å¤ | <2s (è¿½æ±‚ä½å»¶è¿Ÿ) |
   951â†’| **Cold Path** | å¼‚æ­¥ | åˆ†æäº¤äº’å†å² â†’ æå–äº‹å®/åå¥½/çŠ¶æ€ â†’ åå†™ L0/L1 | åå°å¤„ç† |
   952â†’
   953â†’```
   954â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   955â†’â”‚                               Soul OS Architecture v4.0                                 â”‚
   956â†’â”‚                       (Dynamic Profiling & Evolutionary Loop)                           â”‚
   957â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   958â†’                                            ^
   959â†’                                            |  1. äº¤äº’/å“åº” (Response)
   960â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   961â†’â”‚  Interaction Layer (äº¤äº’å±‚ - Vercel SDK / Chat UI)                                      â”‚
   962â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   963â†’â”‚  [LLM Core: GLM/GPT] â”‚  <-- å®æ—¶å¯¹è¯æµ (Stream) -->   â”‚  2. å¼‚æ­¥æŠ•é€’ (Async Queue)      â”‚
   964â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   965â†’           ^                                                              |
   966â†’           | 3. æ³¨å…¥ Context                                              v
   967â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   968â†’â”‚  Context Manager (ä¸Šä¸‹æ–‡ç»„è£…å·¥å‚)        â”‚         â”‚  Memory & Insight Pipeline         â”‚
   969â†’â”‚  (Prompt Engineering / Context Window)   â”‚         â”‚  (æ•°æ®æ²‰æ·€/ETLæµæ°´çº¿)              â”‚
   970â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   971â†’    ^                   ^                            â”‚  * ç‹¬ç«‹è¿è¡Œçš„åå° Agent            â”‚
   972â†’    | (Load Prompts)    | (Load Data)                â”‚  * ä»»åŠ¡: æå–äº‹å®, æ„ŸçŸ¥æƒ…ç»ª        â”‚
   973â†’â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  * å·¥å…·: NLP / Classification      â”‚
   974â†’â”‚ L2: Agents Layer (Prompt/Strategy)       â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   975â†’â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                           |
   976â†’â”‚ â”‚ Style Agents   â”‚  â”‚ Expert Agents    â”‚ â”‚                           |
   977â†’â”‚ â”‚ (Tone/Persona) â”‚  â”‚ (Domain Know.)   â”‚ â”‚                           |
   978â†’â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                           |
   979â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           |
   980â†’                                                                       |
   981â†’            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   982â†’            |  4. Data Write Back (æ•°æ®åå†™/æ›´æ–°)
   983â†’            |  (ç»“æ„åŒ–æå– -> æ˜ å°„åˆ°å¯¹åº” Schema)
   984â†’            v
   985â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   986â†’â”‚  L1: Module Data Layer (å‚ç±»æ•°æ®å±‚)  <-- [Update by Insight Agent]                      â”‚
   987â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   988â†’â”‚  [æ›´æ–°é€»è¾‘: æå–ç‰¹å®šé¢†åŸŸçš„åŠ¨æ€æ•°æ®]                                                      â”‚
   989â†’â”‚                                                                                         â”‚
   990â†’â”‚  â”œâ”€â–º (Update) [å…«å­—/ç´«å¾®] ä¿®æ­£å‡ºç”Ÿæ—¶é—´ï¼Œè®°å½•æµæœˆè¿åŠ¿éªŒè¯åé¦ˆ                             â”‚
   991â†’â”‚  â”œâ”€â–º (Update) [PERMA]    è¯†åˆ«ç”¨æˆ·å½“ä¸‹çš„ E/R ç»´åº¦å¾—åˆ†å˜åŒ–ï¼Œæ›´æ–°åˆ†æ•°                       â”‚
   992â†’â”‚  â”œâ”€â–º (Update) [Covey]    è¯†åˆ«ç”¨æˆ·å®Œæˆäº†"è¦äº‹ç¬¬ä¸€"çš„ä»»åŠ¡ï¼Œæ‰“é’©/æ›´æ–°è¿›åº¦                   â”‚
   993â†’â”‚  â””â”€â–º (Update) [CBT/æƒ…ç»ª] è®°å½•æœ¬æ¬¡ Trigger äº‹ä»¶ï¼Œå½’æ¡£åˆ°æƒ…ç»ªæ—¥å¿—                           â”‚
   994â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   995â†’            |
   996â†’            v
   997â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   998â†’â”‚  L0: Base Data Layer (ç”¨æˆ·åŸºåº§) <-- [Update by Insight Agent]                           â”‚
   999â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  1000â†’â”‚  [æ›´æ–°é€»è¾‘: å…¨å±€é€šç”¨ä¿¡æ¯çš„æ²‰æ·€]                                                          â”‚
  1001â†’â”‚                                                                                         â”‚
  1002â†’â”‚  â”œâ”€â–º (Update) [åŸºç¡€ä¿¡æ¯] ç”¨æˆ·æ— æ„ä¸­æåˆ°"æˆ‘ä¸‹å‘¨å»ä¸Šæµ·" â†’ æ›´æ–° Location/Plan               â”‚
  1003â†’â”‚  â”œâ”€â–º (Update) [åå¥½/Tags] ç”¨æˆ·è¯´"åˆ«ç»™æˆ‘è®²å¤§é“ç†" â†’ Tag: Hate_Preaching                   â”‚
  1004â†’â”‚  â”œâ”€â–º (Update) [å½“å‰çŠ¶æ€] è¿ç»­3æ¬¡å¯¹è¯è¯­æ°”ä½è½ â†’ Status: Depressed â†’ å½±å“L2ç­–ç•¥            â”‚
  1005â†’â”‚  â””â”€â–º (Update) [å†å²æ‘˜è¦] å°†é•¿å¯¹è¯ Summary å­˜å…¥ Long-term Memory                          â”‚
  1006â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  1007â†’```
  1008â†’
  1009â†’**æ ¸å¿ƒä»·å€¼**: Soul OS å…·å¤‡**æˆé•¿æ€§**ã€‚å®ƒè¶Šç”¨è¶Šæ‡‚ç”¨æˆ·ï¼Œè¶Šç”¨æ•°æ®è¶Šåšã€‚
  1010â†’
  1011â†’### 2.2 Insight & Memory Agent (æ´å¯Ÿä¸è®°å¿†ç®—å­)
  1012â†’
  1013â†’> **æ–°æ ¸å¿ƒç»„ä»¶**: åœ¨åå°è¿è¡Œï¼Œè´Ÿè´£ä»éç»“æ„åŒ–å¯¹è¯ä¸­"èƒå–"ç»“æ„åŒ–æ•°æ®ã€‚
  1014â†’
  1015â†’```mermaid
  1016â†’sequenceDiagram
  1017â†’    autonumber
  1018â†’    participant User as ç”¨æˆ·
  1019â†’    participant Chat as Chat API
  1020â†’    participant LLM as Interaction Layer
  1021â†’    participant Queue as Async Queue
  1022â†’    participant Insight as Insight Agent
  1023â†’    participant L1 as L1 Module Data
  1024â†’    participant L0 as L0 Base Data
  1025â†’
  1026â†’    User->>Chat: å‘é€æ¶ˆæ¯
  1027â†’    Chat->>LLM: Hot Path (åŒæ­¥)
  1028â†’    LLM-->>Chat: A2UI å“åº”
  1029â†’    Chat-->>User: è¿”å›å›å¤
  1030â†’
  1031â†’    Note over Chat,Queue: Cold Path å¼€å§‹ (å¼‚æ­¥)
  1032â†’    Chat->>Queue: æŠ•é€’å¯¹è¯è®°å½•
  1033â†’
  1034â†’    Queue->>Insight: è§¦å‘åˆ†æ
  1035â†’    Insight->>Insight: NLP æå–äº‹å®/æƒ…ç»ª/åå¥½
  1036â†’
  1037â†’    alt å‘ç°é¢†åŸŸæ•°æ®
  1038â†’        Insight->>L1: æ›´æ–° PERMA/Covey/å…«å­—
  1039â†’    end
  1040â†’
  1041â†’    alt å‘ç°é€šç”¨ä¿¡æ¯
  1042â†’        Insight->>L0: æ›´æ–° Profile/Tags/Status
  1043â†’    end
  1044â†’```
  1045â†’
  1046â†’**Insight Agent é…ç½®**:
  1047â†’
  1048â†’| é…ç½®é¡¹ | å€¼ | è¯´æ˜ |
  1049â†’|--------|-----|------|
  1050â†’| è§¦å‘æ—¶æœº | å¯¹è¯ç»“æŸ / ç´¯è®¡ N è½® | é¿å…å®æ—¶åˆ†æå¡é¡¿ |
  1051â†’| æ‰§è¡Œæ¨¡å‹ | GLM-3-Turbo / GPT-3.5 | è½»é‡æ¨¡å‹èŠ‚çœæˆæœ¬ |
  1052â†’| æ ¸å¿ƒ Prompt | è§ä¸‹æ–¹ | ç»“æ„åŒ–æå–æŒ‡ä»¤ |
  1053â†’
  1054â†’**Insight Agent System Prompt**:
  1055â†’
  1056â†’```
  1057â†’åˆ†æåˆšæ‰çš„å¯¹è¯ã€‚è¯·è¾“å‡º JSON æ ¼å¼çš„æ›´æ–°æŒ‡ä»¤ï¼š
  1058â†’{
  1059â†’  "l0_updates": {
  1060â†’    "profile": { "location": "ä¸Šæµ·", "upcoming_event": "ä¸‹å‘¨å‡ºå·®" },
  1061â†’    "tags": ["Hate_Preaching", "Prefer_Direct"],
  1062â†’    "status": "stressed",
  1063â†’    "summary": "ç”¨æˆ·æ­£åœ¨å¤„ç†å·¥ä½œå‹åŠ›ï¼Œå¯¹é•¿ç¯‡å¤§è®ºåæ„Ÿ"
  1064â†’  },
  1065â†’  "l1_updates": {
  1066â†’    "perma": { "E": -0.1, "R": 0 },
  1067â†’    "covey": { "task_id": "xxx", "status": "done" },
  1068â†’    "emotion_log": { "trigger": "deadline_pressure", "intensity": 0.7 }
  1069â†’  }
  1070â†’}
  1071â†’
  1072â†’è§„åˆ™ï¼š
  1073â†’1. ç”¨æˆ·æ˜¯å¦æä¾›äº†æ–°çš„ä¸ªäººä¿¡æ¯ï¼Ÿ
  1074â†’2. ç”¨æˆ·æ˜¯å¦è¡¨è¾¾äº†å¯¹æŸä¸ªå»ºè®®çš„å–œå¥½ï¼Ÿ
  1075â†’3. ç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€å¦‚ä½•ï¼Ÿ
  1076â†’4. ç”¨æˆ·æ˜¯å¦å®Œæˆäº†æŸä¸ª L1 æ¨¡å—çš„ä»»åŠ¡ï¼Ÿ
  1077â†’5. ä»…è¾“å‡ºæœ‰å˜åŒ–çš„å­—æ®µ
  1078â†’```
  1079â†’
  1080â†’### 2.3 L1 åŠ¨æ€æ›´æ–°åœºæ™¯
  1081â†’
  1082â†’| åœºæ™¯ | ç”¨æˆ·è¾“å…¥ | Insight Agent Action |
  1083â†’|------|----------|---------------------|
  1084â†’| **Covey ä»»åŠ¡å®Œæˆ** | "æˆ‘ç»ˆäºæŠŠé‚£ä¸ªéš¾æçš„æŠ¥å‘Šå†™å®Œäº†" | è°ƒç”¨ L1 Covey APIï¼ŒTask â†’ Done |
  1085â†’| **è¿åŠ¿éªŒè¯åé¦ˆ** | "ä½ è¯´æˆ‘è¿™å‘¨è¿åŠ¿å·®ï¼Œç¡®å®ä¸¢äº†é’±åŒ…" | L1 è¿åŠ¿è®°å½•æ ‡è®° `User_Feedback: Validated` |
  1086â†’| **PERMA å˜åŒ–** | "æœ€è¿‘å’ŒåŒäº‹å…³ç³»å¥½å¤šäº†" | L1 PERMA `R` ç»´åº¦ +0.2 |
  1087â†’| **CBT æƒ…ç»ªå½’æ¡£** | "ä¸€æƒ³åˆ°æ±‡æŠ¥å°±ç„¦è™‘" | L1 CBT è®°å½• Trigger: presentation_anxiety |
  1088â†’
  1089â†’### 2.4 L0 ç”»åƒä¸°æ»¡æœºåˆ¶
  1090â†’
  1091â†’| ç±»å‹ | æå–æ–¹å¼ | ç¤ºä¾‹ |
  1092â†’|------|----------|------|
  1093â†’| **æ˜¾æ€§æå–** | ç”¨æˆ·ç›´æ¥é™ˆè¿° | "æˆ‘æ˜¯äº§å“ç»ç†" â†’ `job: PM` |
  1094â†’| **éšæ€§æ¨æ–­** | å¤šæ¬¡è¡Œä¸ºåˆ†æ | å¤šæ¬¡å¯¹ Roast æ¨¡å¼ååº”ç§¯æ â†’ `style_preference: { roast: 0.8 }` |
  1095â†’| **çŠ¶æ€æ„ŸçŸ¥** | æƒ…ç»ªè¯†åˆ« | è¿ç»­ 3 æ¬¡ä½è½è¯­æ°” â†’ `current_status: depressed` |
  1096â†’
  1097â†’**Status å­—æ®µçš„å½±å“**:
  1098â†’
  1099â†’```
  1100â†’L0.current_status = "depressed"
  1101â†’    â†“
  1102â†’Context Manager è¯»å– Status
  1103â†’    â†“
  1104â†’å¼ºåˆ¶è·¯ç”±åˆ° L2 Style Agents (Warm æ¨¡å¼)
  1105â†’    â†“
  1106â†’Interaction Layer ä½¿ç”¨æ¸©æš–è¯­æ°”å›å¤
  1107â†’```
  1108â†’
  1109â†’### 2.5 Context Manager è¿›åŒ–
  1110â†’
  1111â†’| ç‰ˆæœ¬ | Context ç»„æˆ |
  1112â†’|------|--------------|
  1113â†’| **v3.x** | `System Prompt + User Input` |
  1114â†’| **v4.0** | `System Prompt + L0(Status) + L1(Relevant Module) + Vector Search(History) + User Input` |
  1115â†’
  1116â†’```
  1117â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  1118â†’â”‚  Context Manager v4.0 ç»„è£…æµç¨‹                                   â”‚
  1119â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  1120â†’â”‚                                                                  â”‚
  1121â†’â”‚  1. è¯»å– L0 Status/Tags        â†’ å…¨å±€çŠ¶æ€ + åå¥½                 â”‚
  1122â†’â”‚  2. è¯»å– L1 Relevant Module    â†’ å½“å‰è¯é¢˜ç›¸å…³çš„æ¨¡å—æ•°æ®          â”‚
  1123â†’â”‚  3. Vector Search History      â†’ ç›¸å…³å†å²å¯¹è¯ (Long-term Memory) â”‚
  1124â†’â”‚  4. ç”¨æˆ·å½“å‰è¾“å…¥               â†’ User Input                      â”‚
  1125â†’â”‚                                                                  â”‚
  1126â†’â”‚        â†“ æ‹¼è£…                                                    â”‚
  1127â†’â”‚                                                                  â”‚
  1128â†’â”‚  Final Context = [L0 Status] + [L1 Data] + [History] + [Input]  â”‚
  1129â†’â”‚                                                                  â”‚
  1130â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  1131â†’```
  1132â†’
  1133â†’### 2.6 WCG é—­ç¯éªŒæ”¶ (ä¿ç•™)
  1134â†’
  1135â†’> **æ‰¿è¯ºçŠ¶æ€æœº**: suggested â†’ active â†’ done
  1136â†’
  1137â†’| æ­¥éª¤ | Hot/Cold | è¯´æ˜ |
  1138â†’|------|----------|------|
  1139â†’| 1. Clarify | Hot | Context Manager ç»„è£… |
  1140â†’| 2. Insight | Hot | L2 Expert Agents åˆ†æ |
  1141â†’| 3. Prescription | Hot | ç”Ÿæˆ If-Then å¤„æ–¹ |
  1142â†’| 4. Commitment | Hot | action_button è§¦å‘ |
  1143â†’| 5. Action | - | ç”¨æˆ·æ‰§è¡Œ |
  1144â†’| 6. Reflection | Cold | Insight Agent åˆ†æç»“æœ |
  1145â†’| 7. Memory | Cold | åå†™ L0/L1 |
  1146â†’
  1147â†’**WCG éªŒæ”¶æ ‡å‡†**: æ¯å‘¨ â‰¥1 æ¬¡å®Œæ•´é—­ç¯ (Clarify â†’ Prescription â†’ Commitment â†’ Action â†’ Reflection)
  1148â†’
  1149â†’---
  1150â†’
  1151â†’## 3. API å®ç°çŠ¶æ€æ˜ å°„
  1152â†’
  1153â†’### 3.1 Goal æ¨¡å—
  1154â†’
  1155â†’| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
  1156â†’|------|------|------|------|
  1157â†’| `POST /api/goal/create` | âœ… | âœ… | åˆ›å»ºç›®æ ‡ |
  1158â†’| `GET /api/goal/list` | âœ… | âœ… | ç›®æ ‡åˆ—è¡¨ |
  1159â†’| `GET /api/goal/{goal_id}` | âœ… | âœ… | ç›®æ ‡è¯¦æƒ… |
  1160â†’| `PUT /api/goal/{goal_id}` | âœ… | âœ… | æ›´æ–°ç›®æ ‡ |
  1161â†’| `POST /api/goal/{goal_id}/link` | âœ… | âš ï¸ | å¾…å®Œå–„ |
  1162â†’
  1163â†’### 3.2 Reflection æ¨¡å—
  1164â†’
  1165â†’| ç«¯ç‚¹ | è®¾è®¡ | å®ç° | å¤‡æ³¨ |
  1166â†’|------|------|------|------|
  1167â†’| `POST /api/reflection/create` | âœ… | âœ… | åˆ›å»ºå¤ç›˜ |
  1168â†’| `GET /api/reflection/list` | âœ… | âœ… | å¤ç›˜åˆ—è¡¨ |
  1169â†’| `GET /api/reflection/prompt` | âœ… | âœ… | è·å–å¼•å¯¼é—®é¢˜ |
  1170â†’
  1171â†’---
  1172â†’
  1173â†’## 4. éªŒæ”¶æŒ‡æ ‡å¯¹æ¯”
  1174â†’
  1175â†’### 4.1 WCG æŒ‡æ ‡
  1176â†’
  1177â†’```sql
  1178â†’-- è®¾è®¡: WCG éªŒæ”¶æŸ¥è¯¢
  1179â†’WITH weekly_loop AS (
  1180â†’  SELECT
  1181â†’    user_id,
  1182â†’    DATE_TRUNC('week', created_at) AS week,
  1183â†’    BOOL_OR(accepted_at IS NOT NULL) AS has_commitment,
  1184â†’    BOOL_OR(status = 'done') AS has_action
  1185â†’  FROM fortune_commitment
  1186â†’  GROUP BY user_id, DATE_TRUNC('week', created_at)
  1187â†’)
  1188â†’SELECT
  1189â†’  user_id,
  1190â†’  week,
  1191â†’  (has_commitment AND has_action) AS wcg_achieved
  1192â†’FROM weekly_loop;
  1193â†’
  1194â†’-- å½“å‰çŠ¶æ€: åç«¯æ•°æ®å¯æŸ¥è¯¢, å‰ç«¯é—­ç¯å¾…ä¿®å¤
  1195â†’```
  1196â†’
  1197â†’### 4.2 æ–°å¢éªŒæ”¶æŒ‡æ ‡
  1198â†’
  1199â†’| æŒ‡æ ‡ | å®šä¹‰ | ç›®æ ‡ | å½“å‰çŠ¶æ€ |
  1200â†’|------|------|------|----------|
  1201â†’| ç›®æ ‡è®¾å®šç‡ | 7å¤©å†…è®¾å®šâ‰¥1ç›®æ ‡ | â‰¥30% | âš ï¸ å¾…ç»Ÿè®¡ |
  1202â†’| å¤ç›˜å®Œæˆç‡ | æ¯å‘¨â‰¥1æ¬¡å¤ç›˜ | â‰¥20% | âš ï¸ å¾…ç»Ÿè®¡ |
  1203â†’| Check-in ä½¿ç”¨ç‡ | æ¯å‘¨â‰¥1æ¬¡æ‰“å¡ | â‰¥40% | âœ… åç«¯å¯ç”¨ |
  1204â†’| A2UI ç‚¹å‡»ç‡ | action_buttons è¢«ç‚¹å‡» | â‰¥50% | âš ï¸ å‰ç«¯é—®é¢˜ |
  1205â†’
  1206â†’---
  1207â†’
  1208â†’## 5. æ€»ç»“
  1209â†’
  1210â†’### 5.1 è®¾è®¡ vs å®ç°ä¸€è‡´æ€§
  1211â†’
  1212â†’```
  1213â†’L0 Base Data:       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%
  1214â†’L1 Module Data:     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 85%   â† å…«å­—/PERMA å°±ç»ªï¼Œç´«å¾®/æ˜Ÿåº§å¾…å®ç°
  1215â†’L2 Expert Agents:   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘ 60%   â† ä»…å…«å­— Agent
  1216â†’L2 Style Agents:    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%   â† standard/warm/roast
  1217â†’Context Management: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
  1218â†’Interaction Layer:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘ 70%   â† GLM ä¸ºä¸»ï¼Œå¤šæ¨¡å‹å¾…å®Œå–„
  1219â†’Goal æ¨¡å—:          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
  1220â†’Reflection:         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘ 90%
  1221â†’å‰ç«¯é—­ç¯:           â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 40%   â† ä¸»è¦å·®è·
  1222â†’```
  1223â†’
  1224â†’### 5.2 å…³é”®å·®è·
  1225â†’
  1226â†’| å·®è· | å½±å“ | ä¼˜å…ˆçº§ | è§£å†³æ–¹æ¡ˆ |
  1227â†’|------|------|--------|----------|
  1228â†’| å‰ç«¯ CSRF | é—­ç¯æ–­è£‚ | P0 | ä¿®å¤ api.ts |
  1229â†’| action_buttons | æ— æ³•ç‚¹å‡» | P0 | å®Œå–„æ¸²æŸ“ |
  1230â†’| anti-dependency | æ–°ç”¨æˆ·è¢«æˆªæ–­ | P1 | æ·»åŠ è±å… |
  1231â†’| L2 Expert æ¨¡å— | ä»…å…«å­— Agent | P2 | æ·»åŠ ç´«å¾®/æ˜Ÿåº§/CBT Agent |
  1232â†’| Interaction å¤šæ¨¡å‹ | GLM å•ä¸€ | P2 | å®Œå–„ Gemini/Claude åˆ‡æ¢ |
  1233â†’
  1234â†’### 5.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨
  1235â†’
  1236â†’1. **P0**: ä¿®å¤å‰ç«¯ CSRF â†’ æ¢å¤é—­ç¯
  1237â†’2. **P0**: å®Œå–„ action_buttons å¤„ç†
  1238â†’3. **P1**: å®ç° anti-dependency æ–°ç”¨æˆ·è±å…
  1239â†’4. **P1**: æ·»åŠ å¤ç›˜å…¥å£åˆ° Dashboard
  1240â†’5. **P2**: æ‰©å±• L2 Expert Agentsï¼ˆç´«å¾®/æ˜Ÿåº§/CBTï¼‰
  1241â†’6. **P2**: Interaction Layer å¤šæ¨¡å‹åŠ¨æ€åˆ‡æ¢
  1242â†’
  1243â†’---
  1244â†’
  1245â†’*æ–‡æ¡£ç‰ˆæœ¬: v4.2 (Vercel AI SDK Edition)*
  1246â†’*æ›´æ–°æ—¥æœŸ: 2026-01-01*
  1247â†’*æ¶æ„æ ¸å¿ƒ: Vercel AI SDK 6 + Pluggable Skills + Multi-Model Hub*
  1248â†’*æµ‹è¯•ç¯å¢ƒ: http://106.37.170.238:8231/new*
  1249â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
