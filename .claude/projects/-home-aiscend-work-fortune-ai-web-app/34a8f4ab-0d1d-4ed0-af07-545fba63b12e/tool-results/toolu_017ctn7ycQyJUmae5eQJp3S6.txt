     1→/**
     2→ * Divine Skills (玄学技能)
     3→ *
     4→ * Tools for metaphysics calculations: Bazi, Tieban, Yunshi, etc.
     5→ * These tools call FastAPI backend for actual computation.
     6→ *
     7→ * Note: These tools run on Next.js server-side, so they can access
     8→ * internal APIs with service token and forward user cookies.
     9→ */
    10→import { tool } from 'ai';
    11→import { z } from 'zod/v3';
    12→
    13→const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';
    14→const INTERNAL_SERVICE_TOKEN = process.env.FORTUNE_INTERNAL_SERVICE_TOKEN || '';
    15→
    16→// API response wrapper type
    17→interface ApiResponse<T> {
    18→  ok: boolean;
    19→  data?: T;
    20→  error?: { code: string; message: string };
    21→}
    22→
    23→// Build headers for authenticated API calls
    24→function buildAuthHeaders(sessionCookie: string): Record<string, string> {
    25→  const headers: Record<string, string> = {
    26→    'Content-Type': 'application/json',
    27→    Cookie: `fortune_session=${sessionCookie}`,
    28→  };
    29→  if (INTERNAL_SERVICE_TOKEN) {
    30→    headers['X-Service-Token'] = INTERNAL_SERVICE_TOKEN;
    31→  }
    32→  return headers;
    33→}
    34→
    35→// ============================================================================
    36→// Tool Factory: Creates tools with user context (cookie)
    37→// ============================================================================
    38→
    39→export interface SkillContext {
    40→  sessionCookie: string;
    41→}
    42→
    43→/**
    44→ * Create divine skills with user context.
    45→ * This allows tools to make authenticated API calls.
    46→ */
    47→export function createDivineSkills(ctx: SkillContext) {
    48→  const authHeaders = buildAuthHeaders(ctx.sessionCookie);
    49→
    50→  return {
    51→    // Bazi calculation tool (no auth required)
    52→    calculate_bazi: tool({
    53→      description: '计算用户的八字命盘（四柱八字）。当用户询问八字、命理、生辰相关问题时使用。',
    54→      inputSchema: z.object({
    55→        birth_datetime: z.string().describe('出生日期时间，格式：YYYY-MM-DD HH:MM'),
    56→        location_name: z.string().optional().describe('出生地点名称'),
    57→        longitude: z.number().optional().describe('出生地经度'),
    58→        latitude: z.number().optional().describe('出生地纬度'),
    59→      }),
    60→      execute: async ({ birth_datetime, location_name, longitude, latitude }, { abortSignal }) => {
    61→        // Parse datetime
    62→        const [date, time] = birth_datetime.split(' ');
    63→        if (!date || !time) {
    64→          return {
    65→            type: 'a2ui_card' as const,
    66→            card_type: 'error',
    67→            data: { message: '日期时间格式错误，请使用 YYYY-MM-DD HH:MM 格式' },
    68→          };
    69→        }
    70→
    71→        const [year, month, day] = date.split('-').map(Number);
    72→        const [hour, minute] = time.split(':').map(Number);
    73→
    74→        try {
    75→          const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
    76→            method: 'POST',
    77→            headers: { 'Content-Type': 'application/json' },
    78→            body: JSON.stringify({
    79→              year,
    80→              month,
    81→              day,
    82→              hour,
    83→              minute,
    84→              location_name,
    85→              longitude,
    86→              latitude,
    87→            }),
    88→            signal: abortSignal,
    89→          });
    90→
    91→          if (!res.ok) {
    92→            throw new Error(`Bazi calculation failed: ${res.status}`);
    93→          }
    94→
    95→          const json: ApiResponse<Record<string, unknown>> = await res.json();
    96→          if (!json.ok || !json.data) {
    97→            throw new Error(json.error?.message || 'Unknown error');
    98→          }
    99→
   100→          const result = json.data;
   101→
   102→          return {
   103→            type: 'a2ui_card' as const,
   104→            card_type: 'bazi_pan',
   105→            data: {
   106→              birth_datetime,
   107→              solar_date: `${year}年${month}月${day}日`,
   108→              lunar_date: (result.lunar_date as string) || '',
   109→              four_pillars: {
   110→                year: { gan: result.year_gan, zhi: result.year_zhi },
   111→                month: { gan: result.month_gan, zhi: result.month_zhi },
   112→                day: { gan: result.day_gan, zhi: result.day_zhi },
   113→                hour: { gan: result.hour_gan, zhi: result.hour_zhi },
   114→              },
   115→              wu_xing_summary: (result.wuxing as string) || '',
   116→              day_master: result.day_master || result.day_gan,
   117→              day_master_strength: (result.day_master_strength as string) || 'balanced',
   118→            },
   119→          };
   120→        } catch (error) {
   121→          return {
   122→            type: 'a2ui_card' as const,
   123→            card_type: 'error',
   124→            data: { message: `八字计算失败: ${error instanceof Error ? error.message : '未知错误'}` },
   125→          };
   126→        }
   127→      },
   128→    }),
   129→
   130→    // Yunshi (daily fortune) tool - requires auth
   131→    get_yunshi: tool({
   132→      description: '获取用户的每日运势。当用户询问今日运势、今天运气、当日运程时使用。',
   133→      inputSchema: z.object({
   134→        date: z.string().optional().describe('查询日期，格式：YYYY-MM-DD，默认今天'),
   135→      }),
   136→      execute: async ({ date }, { abortSignal }) => {
   137→        const targetDate = date || new Date().toISOString().split('T')[0];
   138→
   139→        try {
   140→          // Use authenticated endpoint with user cookie
   141→          const res = await fetch(
   142→            `${FASTAPI_URL}/api/yunshi/daily?target_date=${targetDate}&include_a2ui=true`,
   143→            {
   144→              headers: authHeaders,
   145→              signal: abortSignal,
   146→            }
   147→          );
   148→
   149→          if (!res.ok) {
   150→            if (res.status === 401) {
   151→              throw new Error('需要登录才能查看运势');
   152→            }
   153→            throw new Error(`Yunshi fetch failed: ${res.status}`);
   154→          }
   155→
   156→          const json: ApiResponse<Record<string, unknown>> = await res.json();
   157→          if (!json.ok || !json.data) {
   158→            throw new Error(json.error?.message || 'Unknown error');
   159→          }
   160→
   161→          const result = json.data;
   162→
   163→          return {
   164→            type: 'a2ui_card' as const,
   165→            card_type: 'yunshi_daily',
   166→            data: {
   167→              date: targetDate,
   168→              day_ganzhi: result.day_ganzhi || '',
   169→              summary: result.summary || '',
   170→              score: result.score || 0,
   171→              highlights: result.highlights || [],
   172→              risks: result.risks || [],
   173→              prescriptions: result.prescriptions || [],
   174→            },
   175→          };
   176→        } catch (error) {
   177→          return {
   178→            type: 'a2ui_card' as const,
   179→            card_type: 'error',
   180→            data: { message: `运势获取失败: ${error instanceof Error ? error.message : '未知错误'}` },
   181→          };
   182→        }
   183→      },
   184→    }),
   185→
   186→    // Tieban (Iron Plate) divination tool - requires auth
   187→    init_tieban: tool({
   188→      description: '启动铁板神数推演。当用户想要进行精确的命理推算或验证生辰时使用。',
   189→      inputSchema: z.object({
   190→        birth_datetime: z.string().describe('出生日期时间，格式：YYYY-MM-DD HH:MM'),
   191→        gender: z.enum(['male', 'female']).describe('性别'),
   192→        name: z.string().describe('用户姓名'),
   193→      }),
   194→      execute: async ({ birth_datetime, gender, name }, { abortSignal }) => {
   195→        const [date, time] = birth_datetime.split(' ');
   196→        if (!date || !time) {
   197→          return {
   198→            type: 'a2ui_card' as const,
   199→            card_type: 'error',
   200→            data: { message: '日期时间格式错误' },
   201→          };
   202→        }
   203→
   204→        try {
   205→          // Note: tieban endpoint may not exist yet, gracefully handle 404
   206→          const res = await fetch(`${FASTAPI_URL}/api/tieban/init`, {
   207→            method: 'POST',
   208→            headers: authHeaders,
   209→            body: JSON.stringify({
   210→              name,
   211→              gender,
   212→              date,
   213→              time,
   214→            }),
   215→            signal: abortSignal,
   216→          });
   217→
   218→          if (res.status === 404) {
   219→            return {
   220→              type: 'a2ui_card' as const,
   221→              card_type: 'error',
   222→              data: { message: '铁板神数功能即将上线，敬请期待' },
   223→            };
   224→          }
   225→
   226→          if (!res.ok) {
   227→            throw new Error(`Tieban init failed: ${res.status}`);
   228→          }
   229→
   230→          const json: ApiResponse<Record<string, unknown>> = await res.json();
   231→          if (!json.ok || !json.data) {
   232→            throw new Error(json.error?.message || 'Unknown error');
   233→          }
   234→
   235→          const result = json.data;
   236→
   237→          return {
   238→            type: 'a2ui_card' as const,
   239→            card_type: 'tieban_init',
   240→            data: {
   241→              run_id: result.run_id,
   242→              status: result.status,
   243→              questions: result.questions || [],
   244→              message: '铁板神数推演已启动，请回答验证问题以确认生辰。',
   245→            },
   246→            actions: [
   247→              {
   248→                label: '开始验证',
   249→                action: 'navigate',
   250→                params: { path: `/tieban/${result.run_id}` },
   251→              },
   252→            ],
   253→          };
   254→        } catch (error) {
   255→          return {
   256→            type: 'a2ui_card' as const,
   257→            card_type: 'error',
   258→            data: { message: `铁板推演启动失败: ${error instanceof Error ? error.message : '未知错误'}` },
   259→          };
   260→        }
   261→      },
   262→    }),
   263→  };
   264→}
   265→
   266→// ============================================================================
   267→// Static exports for backward compatibility (no auth context)
   268→// ============================================================================
   269→
   270→// These are placeholder tools that will return auth errors when called without context
   271→export const divineSkills = createDivineSkills({ sessionCookie: '' });
   272→export const calculateBazi = divineSkills.calculate_bazi;
   273→export const getYunshi = divineSkills.get_yunshi;
   274→export const initTieban = divineSkills.init_tieban;
   275→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
