     1→"use client";
     2→
     3→import { useState, useRef, useEffect } from "react";
     4→import { ChatMessage } from "./ChatMessage";
     5→import { ChatInput } from "./ChatInput";
     6→import { InsightCard, InsightType } from "@/components/insight/InsightCard";
     7→import { VibeGlyph, BreathAura, type SkillType } from "@/components/core";
     8→import { getTokens, sendGuestMessage, sendMessage, ChatResponse } from "@/lib/api";
     9→
    10→interface Message {
    11→  id: string;
    12→  role: "user" | "assistant";
    13→  content: string;
    14→  timestamp?: string;
    15→  insight?: {
    16→    id: string;
    17→    insight_type: InsightType;
    18→    title: string;
    19→    content: string;
    20→  };
    21→}
    22→
    23→export interface ChatContainerProps {
    24→  skillId: string;
    25→  skill?: SkillType;
    26→  conversationId?: string;
    27→  onConversationStart?: (id: string) => void;
    28→}
    29→
    30→// ═══════════════════════════════════════════════════════════════════════════
    31→// ChatEmptyState - LUMINOUS PAPER Design System
    32→// 空状态：居中 VibeGlyph + 技能感知文案 + 呼吸光晕
    33→// ═══════════════════════════════════════════════════════════════════════════
    34→
    35→const SKILL_EMPTY_STATE: Record<SkillType, { title: string; subtitle: string }> = {
    36→  bazi: {
    37→    title: "探索你的命理",
    38→    subtitle: "分享你的生辰，开启八字解读之旅",
    39→  },
    40→  zodiac: {
    41→    title: "倾听星辰的声音",
    42→    subtitle: "让星盘为你揭示宇宙的密语",
    43→  },
    44→  mbti: {
    45→    title: "发现真实的自己",
    46→    subtitle: "通过对话，探索你的人格特质",
    47→  },
    48→  attach: {
    49→    title: "理解你的依恋模式",
    50→    subtitle: "探索亲密关系中的自我",
    51→  },
    52→  career: {
    53→    title: "规划你的职业蓝图",
    54→    subtitle: "让我们一起探索你的职业发展方向",
    55→  },
    56→};
    57→
    58→function ChatEmptyState({ skill }: { skill: SkillType }) {
    59→  const config = SKILL_EMPTY_STATE[skill] || SKILL_EMPTY_STATE.bazi;
    60→
    61→  return (
    62→    <div className="h-full w-full flex flex-col items-center justify-center py-20">
    63→      {/* Subtle breath aura behind the glyph */}
    64→      <div className="relative flex items-center justify-center">
    65→        <BreathAura
    66→          skill={skill}
    67→          size="xl"
    68→          position="center"
    69→          intensity="low"
    70→          className="opacity-30"
    71→        />
    72→        <VibeGlyph
    73→          size="lg"
    74→          skill={skill}
    75→          showAura={true}
    76→          animate={true}
    77→          className="relative z-10"
    78→        />
    79→      </div>
    80→
    81→      {/* Text content */}
    82→      <div className="mt-8 text-center space-y-2">
    83→        <h3 className="text-xl font-serif font-semibold text-foreground">
    84→          {config.title}
    85→        </h3>
    86→        <p className="text-sm text-muted-foreground max-w-xs">
    87→          {config.subtitle}
    88→        </p>
    89→      </div>
    90→    </div>
    91→  );
    92→}
    93→
    94→export function ChatContainer({ skillId, skill = "bazi", conversationId, onConversationStart }: ChatContainerProps) {
    95→  const [messages, setMessages] = useState<Message[]>([]);
    96→  const [isLoading, setIsLoading] = useState(false);
    97→  const [currentConvoId, setCurrentConvoId] = useState(conversationId);
    98→  const messagesEndRef = useRef<HTMLDivElement>(null);
    99→
   100→  // Map skillId to SkillType if not provided
   101→  const activeSkill: SkillType = skill || (skillId as SkillType) || "bazi";
   102→
   103→  const scrollToBottom = () => {
   104→    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
   105→  };
   106→
   107→  useEffect(() => {
   108→    scrollToBottom();
   109→  }, [messages]);
   110→
   111→  const handleSend = async (content: string) => {
   112→    // Add user message
   113→    const userMessage: Message = {
   114→      id: Date.now().toString(),
   115→      role: "user",
   116→      content,
   117→      timestamp: new Date().toLocaleTimeString(),
   118→    };
   119→    setMessages((prev) => [...prev, userMessage]);
   120→    setIsLoading(true);
   121→
   122→    try {
   123→      const { accessToken } = getTokens();
   124→
   125→      if (accessToken) {
   126→        const response: ChatResponse = await sendMessage({
   127→          message: content,
   128→          skill_id: skillId,
   129→          conversation_id: currentConvoId,
   130→        });
   131→
   132→        // Update conversation ID
   133→        if (!currentConvoId && response.conversation_id) {
   134→          setCurrentConvoId(response.conversation_id);
   135→          onConversationStart?.(response.conversation_id);
   136→        }
   137→
   138→        // Add assistant message with potential insight
   139→        const assistantMessage: Message = {
   140→          id: (Date.now() + 1).toString(),
   141→          role: "assistant",
   142→          content: response.content,
   143→          timestamp: new Date().toLocaleTimeString(),
   144→          insight: response.insight ? {
   145→            id: response.insight.id,
   146→            insight_type: response.insight.insight_type as InsightType,
   147→            title: response.insight.title,
   148→            content: response.insight.content,
   149→          } : undefined,
   150→        };
   151→        setMessages((prev) => [...prev, assistantMessage]);
   152→      } else {
   153→        // Guest mode: use the public endpoint for progressive disclosure
   154→        const response = await sendGuestMessage(content, skillId);
   155→        const assistantMessage: Message = {
   156→          id: (Date.now() + 1).toString(),
   157→          role: "assistant",
   158→          content: response.content,
   159→          timestamp: new Date().toLocaleTimeString(),
   160→        };
   161→        setMessages((prev) => [...prev, assistantMessage]);
   162→
   163→        if (response.suggestion) {
   164→          setMessages((prev) => [
   165→            ...prev,
   166→            {
   167→              id: (Date.now() + 2).toString(),
   168→              role: "assistant",
   169→              content: response.suggestion,
   170→              timestamp: new Date().toLocaleTimeString(),
   171→            },
   172→          ]);
   173→        }
   174→      }
   175→    } catch (error) {
   176→      console.error("Chat error:", error);
   177→      // Add error message
   178→      setMessages((prev) => [...prev, {
   179→        id: (Date.now() + 1).toString(),
   180→        role: "assistant",
   181→        content: "抱歉，出了点问题。请稍后再试。",
   182→      }]);
   183→    } finally {
   184→      setIsLoading(false);
   185→    }
   186→  };
   187→
   188→  return (
   189→    <div className="flex flex-col h-full" data-skill={activeSkill}>
   190→      {/* Messages */}
   191→      <div className="flex-1 overflow-y-auto p-4 relative min-h-0">
   192→        {messages.length === 0 ? (
   193→          <ChatEmptyState skill={activeSkill} />
   194→        ) : null}
   195→        {messages.map((message) => (
   196→          <div key={message.id}>
   197→            <ChatMessage
   198→              role={message.role}
   199→              content={message.content}
   200→              timestamp={message.timestamp}
   201→            />
   202→            {/* Show insight card if present */}
   203→            {message.insight && (
   204→              <div className="ml-12 mt-2 mb-4">
   205→                <InsightCard
   206→                  type={message.insight.insight_type}
   207→                  title={message.insight.title}
   208→                  content={message.insight.content}
   209→                  onSave={() => console.log("Save insight:", message.insight?.id)}
   210→                  onShare={() => console.log("Share insight:", message.insight?.id)}
   211→                />
   212→              </div>
   213→            )}
   214→          </div>
   215→        ))}
   216→        {isLoading && (
   217→          <ChatMessage
   218→            role="assistant"
   219→            content=""
   220→            isStreaming
   221→          />
   222→        )}
   223→        <div ref={messagesEndRef} />
   224→      </div>
   225→
   226→      {/* Input */}
   227→      <ChatInput onSend={handleSend} disabled={isLoading} />
   228→    </div>
   229→  );
   230→}
   231→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
