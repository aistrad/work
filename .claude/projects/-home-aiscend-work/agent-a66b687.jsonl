{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"59d0d4ba-3ce6-4814-bf5c-2a7e697cdf3e","version":"2.0.74","gitBranch":"","agentId":"a66b687","slug":"inherited-greeting-perlis","type":"user","message":{"role":"user","content":"请阅读并深入理解以下文件：\n1. /home/aiscend/work/fortune_ai/docs/architech/system_design_final_mvp.md - 系统设计最终MVP文档\n2. /home/aiscend/work/fortune_ai/docs/architech/idea business model.md - 业务模型文档\n\n总结：\n1. 产品的核心价值主张和用户体验目标\n2. 系统架构设计\n3. 当前规划的功能模块\n4. 用户交互流程设计\n5. 任何与UI/UX相关的规范或要求"},"uuid":"b18769c7-e67e-493f-8c0d-256db72f84a6","timestamp":"2025-12-30T04:13:56.664Z"}
{"parentUuid":"b18769c7-e67e-493f-8c0d-256db72f84a6","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"59d0d4ba-3ce6-4814-bf5c-2a7e697cdf3e","version":"2.0.74","gitBranch":"","agentId":"a66b687","slug":"inherited-greeting-perlis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012zBAiZkEG53Jp3dPXvtecG","type":"message","role":"assistant","content":[{"type":"text","text":"我将为您阅读并分析这两个文件，以深入理解系统设计和业务模型。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":18507,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":18507,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWcDoXr6RVabk7trQrnyQ","type":"assistant","uuid":"22e8e020-befa-4f8b-b097-91692acd7745","timestamp":"2025-12-30T04:13:58.672Z"}
{"parentUuid":"22e8e020-befa-4f8b-b097-91692acd7745","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"59d0d4ba-3ce6-4814-bf5c-2a7e697cdf3e","version":"2.0.74","gitBranch":"","agentId":"a66b687","slug":"inherited-greeting-perlis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012zBAiZkEG53Jp3dPXvtecG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01A7wixjfijVTYWWSzoaq6hX","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/docs/architech/system_design_final_mvp.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":18507,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":18507,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWcDoXr6RVabk7trQrnyQ","type":"assistant","uuid":"80c0f9c0-5763-418c-b977-ab3825731852","timestamp":"2025-12-30T04:13:59.251Z"}
{"parentUuid":"80c0f9c0-5763-418c-b977-ab3825731852","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"59d0d4ba-3ce6-4814-bf5c-2a7e697cdf3e","version":"2.0.74","gitBranch":"","agentId":"a66b687","slug":"inherited-greeting-perlis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012zBAiZkEG53Jp3dPXvtecG","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GspL1CYUXeYjH4P1rxnCU9","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/docs/architech/idea business model.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":18507,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":18507,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"}},"requestId":"req_011CWcDoXr6RVabk7trQrnyQ","type":"assistant","uuid":"34b26ea5-575a-40ec-91f1-499883777407","timestamp":"2025-12-30T04:13:59.677Z"}
{"parentUuid":"06911d72-c004-4b7d-920a-ab8d310432ad","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"59d0d4ba-3ce6-4814-bf5c-2a7e697cdf3e","version":"2.0.74","gitBranch":"","agentId":"a66b687","slug":"inherited-greeting-perlis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GspL1CYUXeYjH4P1rxnCU9","type":"tool_result","content":"     1→\n     2→本报告旨在详尽定义一款融合了\\*\\*形而上学数据（占星/命理）**与**循证心理学框架（CBT/WOOP）\\*\\*的AI产品的核心本质。我们将利用TanStack AI等前沿技术架构 3，结合小红书的“玄学审美”趋势 4 与TikTok的病毒式传播逻辑 5，构建一个高留存、高转化的用户增长闭环。报告将深入探讨如何通过“状态分数（State Score）”的游戏化机制解决留存难题，并设计一套借鉴游戏经济系统的混合变现模式。\n     3→\n     4→## ---\n     5→\n     6→**2\\. 产品核心本质与最大卖点定义**\n     7→\n     8→核心本质：基于AI智能体的精神数字孪生\n     9→1. 用户的精神数字孪生\n    10→1.1 占星学、命理学，用户自我认知的“元数据”\n    11→1.2 通过智能体交互，及各种功能模块，不断累计用户信息，并沉淀用户分析（用各种心理学，精神学建模框架）\n    12→1.3 把复杂的占星，命理，心理框架指标简化为数据指标框架，和时间序列；通过这个简化的系统能够把各种分析框架工具融合；也给用户一目了然；并提供动力和粘性。将枯燥的“心理成长”包装成RPG游戏般的“状态升级”。用户不是在“治疗”，而是在“练级”\n    13→1.4 社交功能：通过合盘，属性匹配，鼓励互动等机制促进社交，促进更新颖，精准，更深度的链接和社交\n    14→1.5 复杂的精神，心理，人际关系等变得可分析，可量化，可解释，可行动，可促进\n    15→1.6 把积极行为心理干预融入产品\n    16→1.7 与社交媒体的深度融合（小红书，微信，tiktok），如给好友提升能量状态，图片分享打赏，好运接龙，吐槽大会；这些都通过一套算法机制影响到用户的状态分数\n    17→\n    18→2. AI智能体\n    19→2.1 用户专属ai智能体通过不断与用户交互和分析，互动，反馈，进化为用户专属的心理/精神操作系统，越来越了解用户，能够给到更精准的反馈，和行为指导行为干预，各种信息和行为到用户数字孪生的管理和映射\n    20→2.2 这个智能体通过对话（chat）和功能区两个模式与用户交互；后台智能体还能把对话内容在功能区丰富展示显化\n    21→2.3 主动计算，主动推送\n    22→\n    23→在产品定义的深层逻辑上，我们要摒弃传统的“工具属性”。这款产品的本质不应被定义为“算命工具”或“冥想软件”，而应定义为\\*\\*“基于时空数据的动态心理伴侣”\\*\\*。\n    24→\n    25→\n    26→| 功能模块 | 核心描述 | 技术/心理学支撑 | 价值主张 |\n    27→| :---- | :---- | :---- | :---- |\n    28→| **全息AI占星师 (The Oracle)** | 支持实时语音/文本流式交互的AI Chatbot，能解析本命盘、流年运势。 | TanStack AI (Streaming), Kerykeion (Python Lib) | 即时解答疑惑，提供情绪价值。 |\n    29→| **状态分数系统 (State Score)** | 每日动态评分系统，基于用户打卡（WOOP）、星象能量及心理测验生成。 | Gamification Mechanics, Habitica Model 11 | 量化今日状态，激发提升欲望。 |\n    30→| **微型觉察课程 (Micro-Courses)** | 针对当前状态推荐的3-5分钟音频/视频课程（冥想、CBT、呼吸法）。 | Micro-learning, Bite-sized content 12 | 在用户最脆弱时提供即时干预。 |\n    31→| **社交合盘雷达 (Social Radar)** | 扫码生成与朋友/伴侣的详细匹配度报告及相处指南。 | Synastry Algorithms 13 | 极强的病毒传播诱饵。 |\n    32→| **视觉化能量仪表盘 (Cosmic Dashboard)** | 以Y2K/新中式赛博风格展示今日能量分布（火/土/风/水元素）。 | Neo-Chinese / Acid Graphics 4 | 满足Z世代的审美与分享需求。 |\n    33→\n    34→## ---\n    35→\n    36→**3\\. 技术架构与工程实现策略**\n    37→\n    38→作为一款旨在承载高并发、实时交互的产品，技术选型必须兼顾开发效率、类型安全与供应商中立性。\n    39→\n    40→### **3.1 基于TanStack AI的中立化底座**\n    41→\n    42→在构建AI核心时，我们应坚决避免被单一供应商（如OpenAI或Vercel）锁定。根据调研，**TanStack AI** 是目前的最佳选择，被称为“AI工具领域的瑞士” 7。\n    43→\n    44→* 供应商中立策略 (Provider Agnostic)：  \n    45→  TanStack AI 允许我们通过适配器模式（Adapter Pattern）无缝切换模型。对于简单的每日运势生成，我们可以调用成本较低的 Llama 3 (via Groq) 或 Haiku 模型；而对于复杂的心理咨询对话或WOOP引导，则动态切换至 GPT-4o 或 Claude 3.5 Sonnet 以获得更好的推理能力 3。这种架构能将运营成本（COGS）降低40%以上。  \n    46→* 端到端类型安全 (End-to-End Type Safety)：  \n    47→  利用 TypeScript 和 Zod schema，我们能确保 AI 输出的结构化数据（如星盘参数、课程推荐ID）绝对符合前端组件的要求。这消除了传统开发中AI产生幻觉导致应用崩溃的风险 3。  \n    48→* 流式响应体验 (Streaming UX)：  \n    49→  心理咨询场景对延迟极度敏感。TanStack AI 原生支持 AsyncIterable 流式传输，能让AI的回复像人类打字一样逐字浮现。这种“思考感”是建立用户信任的关键心理暗示 3。\n    50→\n    51→### **3.2 核心算法库：Kerykeion与天文计算**\n    52→\n    53→产品的“玄学”底座不能建立在虚构之上，必须基于精确的天文学数据。\n    54→\n    55→* **Kerykeion Python库集成：** 我们将在后端集成 Kerykeion 库 6。它基于瑞士星历表（Swiss Ephemeris），能精确计算行星经纬度、宫位（Placidus/Whole Sign）及相位（Aspects）。  \n    56→* **合盘算法 (Synastry Engine)：** 开发自定义的合盘评分系统。参考占星学逻辑，计算两人行星之间的相位（如金星拱火星为+10分，土星刑月亮为-15分），最终生成一个“缘分指数” 10。\n    57→\n    58→## ---\n    59→\n    60→**4\\. 基于社交媒体的用户增长策略 (User Acquisition)**\n    61→\n    62→作为用户增长专家，我们不依赖单一的买量渠道，而是构建一个\\*\\*“内容种草-病毒传播-私域沉淀”\\*\\*的增长飞轮。\n    63→\n    64→### **4.1 小红书 (Xiaohongshu)：种草与审美红利**\n    65→\n    66→小红书是本产品的核心冷启动平台，其70%的女性用户与泛心理/玄学受众高度重合 18。\n    67→\n    68→**策略核心：KFS模型 (KOL \\- Feed \\- Search)**\n    69→\n    70→1. **视觉美学：新中式赛博与Y2K酸性设计 (Neo-Chinese & Acid Graphics)**  \n    71→   * **趋势洞察：** 2025年的设计趋势正向“新丑风（New Ugly）”、“Y2K酸性图形”以及“新中式玄学”演变 4。  \n    72→   * **内容策略：** 我们的App UI设计必须具备极高的“成图率”。生成的星盘不应是枯燥的图表，而应是融合了镭射质感、毛玻璃效果（Glassmorphism）与传统符箓元素的艺术品。用户分享的不仅仅是运势，更是**审美身份** 20。  \n    73→   * **内容形式：** 制作“好运壁纸”、“水逆退散符”、“MBTI vs 星盘”等高颜值图文。  \n    74→2. **KOL/KOC矩阵投放：**  \n    75→   * **去中心化投放：** 不追求头部大V，而是批量投放1-10万粉丝的腰部博主（Mid-tier KOLs）和关键意见消费者（KOCs）。数据显示，这一层级的ROI通常比头部高出30-40% 18。  \n    76→   * **场景化叙事：** 内容脚本侧重于“解决具体问题”。例如：“分手后怎么走出来？这个App的AI陪我聊了整整三天”、“完全被说中！星盘显示我今年注定换工作”。  \n    77→3. **搜索截流 (SEO)：**  \n    78→   * 针对“塔罗”、“星座运势”、“焦虑”、“失眠”等高频关键词进行SEO优化，确保用户搜索时，我们的笔记占据前排位置 22。\n    79→\n    80→### **4.2 TikTok / Douyin：情绪共鸣与视觉钩子**\n    81→\n    82→TikTok用于通过短视频获取泛流量，核心在于\\*\\*“黄金3秒”\\*\\*的抓取力 5。\n    83→\n    84→**策略核心：情绪触发与互动滤镜**\n    85→\n    86→1. **钩子设计 (The Hook)：**  \n    87→   * 视频开头必须在3秒内通过视觉或听觉冲击留住用户。例如：“如果你是天蝎座，千万别划走！”、“AI算出了我前任的回头率，结果准得可怕” 5。  \n    88→2. **绿幕解说 (Green Screen)：**  \n    89→   * 利用TikTok的绿幕功能，背景放明星的星盘或热点事件的主角星盘，博主在前方进行“AI辅助解读”。这种内容制作成本低，但通过蹭热点（Newsjacking）能获得巨大流量 1。  \n    90→3. **互动特效开发：**  \n    91→   * 开发品牌专属的TikTok特效（Effect），如“测测你的灵性动物”或“今日能量颜色”。用户使用特效拍摄视频本身就是一种裂变传播 23。\n    92→\n    93→### **4.3 微信生态 (WeChat)：私域流量与自动化服务**\n    94→\n    95→微信不仅是流量入口，更是高价值用户的**沉淀池**。\n    96→\n    97→**策略核心：企业微信 (WeCom) \\+ 自动化私域**\n    98→\n    99→1. **企业微信承接：**  \n   100→   * 在公域（小红书/TikTok）引导用户添加“AI疗愈师”的企业微信。通过企业微信，我们可以给用户打上“失恋”、“求职”、“考研”等标签，进行精细化运营 24。  \n   101→2. **服务号AI Agent集成：**  \n   102→   * 利用微信服务号接口 26，将我们的TanStack AI Chatbot直接嵌入微信对话框。用户无需下载App即可体验核心对话功能，降低门槛。  \n   103→3. **自动化Drip Marketing：**  \n   104→   * 根据用户的星盘数据，在特定天象（如满月、新月）自动推送定制化的“能量提醒”到微信。这种“比男友更贴心”的服务能极大提升用户粘性 28。\n   105→\n   106→## ---\n   107→\n   108→**5\\. 用户留存机制：状态分数与游戏化闭环**\n   109→\n   110→要解决工具类应用“用完即走”的弊端，我们需要构建一套**内驱力驱动的游戏化系统**。\n   111→\n   112→### **5.1 核心机制：状态分数 (State Score)**\n   113→\n   114→这是一个量化用户身心状态的动态指标（0-100分），它不仅仅是记录，更是行动的指南。\n   115→\n   116→* 计算逻辑：\n   117→\n   118→  $$\\\\text{State Score} \\= (0.4 \\\\times \\\\text{Astrological Transit}) \\+ (0.3 \\\\times \\\\text{Check-in Streak}) \\+ (0.3 \\\\times \\\\text{Task Completion})$$  \n   119→  * *Astrological Transit（天象系数）：* 基于Kerykeion计算的当日行运（客观环境）。  \n   120→  * *Check-in Streak（打卡连续性）：* 用户连续记录心情的天数。  \n   121→  * *Task Completion（任务完成度）：* 完成当日推荐的微课程或冥想任务。  \n   122→* **心理学锚点：** 利用“损失厌恶（Loss Aversion）”心理，如果用户中断打卡或不进行能量维护，分数会下降，从而影响其Avatar（虚拟形象）的光泽度或装备 29。\n   123→\n   124→### **5.2 激发用户提升状态：WOOP框架的AI化**\n   125→\n   126→我们将心理学中的 **WOOP (Wish, Outcome, Obstacle, Plan)** 框架 8 植入到每日的AI对话中。\n   127→\n   128→* **交互流程：**  \n   129→  1. **Wish (愿望)：** AI询问：“基于今天的星象，你今天最想达成什么？”  \n   130→  2. **Outcome (结果)：** “达成后会有什么感觉？”（通过视觉化增强动力）。  \n   131→  3. **Obstacle (障碍)：** “你的土星受克，可能会遇到拖延，这是否是你担心的障碍？”（结合玄学数据精准提问）。  \n   132→  4. **Plan (计划)：** “如果出现拖延，我们将执行什么微行动？”（生成具体的If-Then计划）。  \n   133→* **激励机制：** 完成WOOP对话后，用户的“状态分数”显著提升，并获得“能量币”奖励。\n   134→\n   135→### **5.3 学习课程：微型学习 (Micro-learning) 与即时干预**\n   136→\n   137→针对现代人碎片化的注意力，课程设计必须遵循\\*\\*“Bite-sized（一口吃）”\\*\\*原则 12。\n   138→\n   139→* **课程形态：** 3-5分钟的音频或交互式视频。  \n   140→* **内容库：**  \n   141→  * *急救类：* “3分钟缓解水逆焦虑呼吸法”、“面试前自信冥想”。  \n   142→  * *认知类：* “CBT入门：识别情绪陷阱”、“占星学基础：认识你的月亮”。  \n   143→* **触发机制：** 当用户的“状态分数”低于60分时，系统自动推荐“能量补给包（课程）”，用户完成课程后分数即时回升。这种\\*\\*“诊断-治疗-反馈”\\*\\*的闭环极其有效。\n   144→\n   145→### **5.4 社交分享：合盘作为病毒引擎**\n   146→\n   147→* **合盘报告 (Synastry Report)：** 允许用户生成与朋友的合盘。报告不只显示分数，更显示“相处说明书”。例如：“你们的沟通（水星）很合拍，但情感需求（月亮）有冲突。” 10。  \n   148→* **状态共享 (Vibe Check)：** 用户可以选择将自己的“状态分数”展示给亲密好友。当好友分数低时，系统提示你去“Send Good Vibes”（发送能量/虚拟礼物），促进App内的社交互动 31。\n   149→\n   150→## ---\n   151→\n   152→**6\\. 收费模式设计：借鉴游戏经济系统的混合变现**\n   153→\n   154→我们将摒弃单一的SaaS订阅模式，转而采用\\*\\*“订阅+内购+激励”\\*\\*的混合游戏化变现模型。\n   155→\n   156→### **6.1 免费层 (Free Tier)：流量漏斗**\n   157→\n   158→* **权益：** 每日基础运势、本命盘查看、每日10次AI对话额度。  \n   159→* **目的：** 最大化用户获取（UA）和数据收集。\n   160→\n   161→### **6.2 会员订阅 (Subscription \\- The Battle Pass)：稳定现金流**\n   162→\n   163→* **名称：** “宇宙通行证 (Cosmic Pass)”  \n   164→* **定价：** 月卡/年卡模式。  \n   165→* **权益：**  \n   166→  * 无限次AI对话。  \n   167→  * 解锁未来30天的运势预测（Time Travel功能）。  \n   168→  * 解锁所有高级合盘（无限次查看与他人的匹配度）。  \n   169→  * 解锁所有微课程内容。\n   170→\n   171→### **6.3 特色产品收费 (In-App Purchases \\- Micro-transactions)：高ARPU值挖掘**\n   172→\n   173→借鉴游戏模式，针对非订阅用户或高净值用户提供单次购买：\n   174→\n   175→1. **深度报告 (Deep Dives)：** 单次购买一份“2025年度个人全景报告”或“职业生涯深度解析PDF”。利用AI生成20-30页的详尽内容 32。  \n   176→2. **皮肤与资产 (Skins & Assets)：** 为用户的虚拟形象（Avatar）购买“星座限定皮肤”、“光环特效”。这些虚拟资产满足了Z世代的数字身份展示需求 33。  \n   177→3. **能量加速包 (Energy Boosts)：** 购买额外的“补签卡”以维持打卡Streak，或购买“提问券”以咨询更复杂的真人占星师（如果我们引入真人专家层）34。\n   178→\n   179→### **6.4 推广奖励 (Referral Rewards)：病毒系数放大器**\n   180→\n   181→设计双向奖励机制以最大化K因子（K-factor）：\n   182→\n   183→* **机制：** 邀请一位好友注册，双方各获得 **7天高级会员体验** 或 **500个能量币**。  \n   184→* **社交裂变：** 当用户分享合盘报告给微信好友时，好友扫码查看必须注册。这是最高效的拉新手段。  \n   185→* **KOC计划：** 对于邀请超过10人的用户，自动升级为“星际大使”，获得现金返利或永久会员权益，激励他们在私域流量中推广。\n   186→\n   187→## ---\n   188→\n   189→**7\\. 结论与展望**\n   190→\n   191→这款产品的核心竞争力在于**利用AI技术将玄学的“模糊性”转化为心理服务的“确定性”，并利用游戏化机制将“自我探索”转化为“成瘾性习惯”。**\n   192→\n   193→通过TanStack AI构建灵活的技术底座，利用小红书和TikTok的审美红利获取Z世代用户，通过状态分数和WOOP框架锁住用户注意力，最后通过混合变现模式实现商业价值。这不仅是一个App，它是连接古老智慧与未来科技的桥梁，是后数字时代人类寻求精神慰藉的**认知基础设施**。\n   194→\n   195→### **关键成功指标 (KPIs) 预测：**\n   196→\n   197→* **次日留存 (Day 1 Retention)：** 目标 \\> 45% (通过每日运势推送与状态分数驱动)。  \n   198→* **病毒系数 (K-factor)：** 目标 \\> 1.2 (通过合盘分享驱动)。  \n   199→* **付费转化率 (Conversion Rate)：** 目标 \\> 5% (通过游戏化内购与会员权益驱动)。\n   200→\n   201→这是一场关于重新定义“幸福感”产业的实验，而我们正掌握着开启这扇大门的密钥。\n   202→\n   203→### ---\n   204→\n   205→**表格：变现模式对比与设计**\n   206→\n   207→| 收费模式 | 实施细节 | 心理学机制 | 预期贡献占比 |\n   208→| :---- | :---- | :---- | :---- |\n   209→| **Freemium (免费增值)** | 基础盘面/运势免费，解锁深度解读收费。 | **门槛效应**：先让用户低成本进入，形成依赖。 | \\- (流量入口) |\n   210→| **Subscription (订阅制)** | 月卡/年卡，解锁无限对话、课程、未来运势。 | **损失厌恶**：不仅是为了获得，更是为了不失去高级功能。 | 50% |\n   211→| **Micro-transactions (内购)** | 单份深度报告、皮肤、补签卡、能量币。 | **即时满足**：小额支付带来的心理负担低，易冲动消费。 | 30% |\n   212→| **Consultation (真人咨询)** | 对接真人占星师/咨询师的高客单价服务。 | **权威崇拜**：AI解决日常，真人解决重大危机。 | 20% |\n   213→\n   214→### **表格：用户增长渠道策略矩阵**\n   215→\n   216→| 渠道 (Channel) | 核心目标 | 关键战术 (Tactics) | 内容风格 (Style) |\n   217→| :---- | :---- | :---- | :---- |\n   218→| **小红书 (Xiaohongshu)** | **信任建立与种草** | KFS投放模型；图文高审美；私域引流。 | 新中式赛博、Y2K酸性设计、情感共鸣小作文。 |\n   219→| **TikTok/抖音** | **病毒传播与曝光** | 3秒钩子；绿幕解说；互动特效；蹭热点。 | 强视觉冲击、快节奏、反转剧情、神秘感。 |\n   220→| **微信/WeCom** | **留存与LTV挖掘** | AI Agent嵌入服务号；社群运营；自动化推送。 | 服务型、陪伴型、Drip Marketing。 |\n   221→\n   222→(报告结束)\n   223→\n   224→#### **Works cited**\n   225→\n   226→1. Gen Z's Digital Astrology Obsession 2025 | How AI Made the Stars Go Viral \\- The Economic Times, accessed December 30, 2025, [https://m.economictimes.com/astrology/others/gen-zs-obsession-with-astrology-in-2025-how-ai-and-social-media-made-the-stars-go-viral/articleshow/125056677.cms](https://m.economictimes.com/astrology/others/gen-zs-obsession-with-astrology-in-2025-how-ai-and-social-media-made-the-stars-go-viral/articleshow/125056677.cms)  \n   227→2. Expert comment: why is Gen Z looking to the stars for meaning? \\- Oxford Brookes University, accessed December 30, 2025, [https://www.brookes.ac.uk/about-brookes/news/news-from-2025/05/expert-comment-why-is-gen-z-looking-to-the-stars-f](https://www.brookes.ac.uk/about-brookes/news/news-from-2025/05/expert-comment-why-is-gen-z-looking-to-the-stars-f)  \n   228→3. TanStack AI: Building Type-Safe, Provider-Agnostic AI Applications \\- Better Stack, accessed December 30, 2025, [https://betterstack.com/community/guides/ai/tanstack-ai/](https://betterstack.com/community/guides/ai/tanstack-ai/)  \n   229→4. Xpiritualism on Xiaohongshu: Decoding China's Post-Internet Taoism \\- RADII, accessed December 30, 2025, [https://radii.co/article/xpiritualism-on-xiaohongshu](https://radii.co/article/xpiritualism-on-xiaohongshu)  \n   230→5. TikTok Content Strategy: How to Plan, Post, and Grow in 2025 \\- SEO Sherpa, accessed December 30, 2025, [https://seosherpa.com/tiktok-content-strategy/](https://seosherpa.com/tiktok-content-strategy/)  \n   231→6. kerykeion \\- PyPI, accessed December 30, 2025, [https://pypi.org/project/kerykeion/](https://pypi.org/project/kerykeion/)  \n   232→7. The Switzerland of AI Tooling: Inside TanStack AI's Bold New Approach \\- DEV Community, accessed December 30, 2025, [https://dev.to/usman\\_awan/the-switzerland-of-ai-tooling-inside-tanstack-ais-bold-new-approach-1cbb](https://dev.to/usman_awan/the-switzerland-of-ai-tooling-inside-tanstack-ais-bold-new-approach-1cbb)  \n   233→8. WOOP Goal Setting: The Secrets Behind the Method and How to Apply It \\- Deel, accessed December 30, 2025, [https://www.deel.com/blog/woop-goal-setting/](https://www.deel.com/blog/woop-goal-setting/)  \n   234→9. Why Personalized Astrology Apps Are Appealing to Gen Z \\- Time Magazine, accessed December 30, 2025, [https://time.com/6083293/astrology-apps-personalized/](https://time.com/6083293/astrology-apps-personalized/)  \n   235→10. Will someone pls explain how zodiac compatibility works? : r/astrology \\- Reddit, accessed December 30, 2025, [https://www.reddit.com/r/astrology/comments/1cpfxm6/will\\_someone\\_pls\\_explain\\_how\\_zodiac\\_compatibility/](https://www.reddit.com/r/astrology/comments/1cpfxm6/will_someone_pls_explain_how_zodiac_compatibility/)  \n   236→11. Gamification | Habitica Wiki | Fandom, accessed December 30, 2025, [https://habitica.fandom.com/wiki/Gamification](https://habitica.fandom.com/wiki/Gamification)  \n   237→12. Bite-size workshops and webinars — Minds That Work \\- Workplace mental wellbeing training and consultancy, accessed December 30, 2025, [https://mindsthatwork.com/services/bite-size](https://mindsthatwork.com/services/bite-size)  \n   238→13. Astrological Compatibility Scores | PDF \\- Scribd, accessed December 30, 2025, [https://www.scribd.com/document/787514232/romantic-scores](https://www.scribd.com/document/787514232/romantic-scores)  \n   239→14. Graphic design trends for 2025 \\- Adobe, accessed December 30, 2025, [https://www.adobe.com/express/learn/blog/design-trends-2025](https://www.adobe.com/express/learn/blog/design-trends-2025)  \n   240→15. TanStack AI Review: A Better Vercel AI SDK Alternative? | Stork.AI, accessed December 30, 2025, [https://www.stork.ai/blog/tanstack-ai-the-vercel-killer-we-needed](https://www.stork.ai/blog/tanstack-ai-the-vercel-killer-we-needed)  \n   241→16. The Vercel AI SDK Killer? Why Tanstack AI is the Next Big Thing for AI Agent Development, accessed December 30, 2025, [https://innohub.powerweave.com/?p=529](https://innohub.powerweave.com/?p=529)  \n   242→17. kerykeion \\- Codesandbox, accessed December 30, 2025, [http://codesandbox.io/p/github/mettaversesociety/kerykeion](http://codesandbox.io/p/github/mettaversesociety/kerykeion)  \n   243→18. The Complete Guide to Xiaohongshu Marketing for Businesses \\- Hashmeta, accessed December 30, 2025, [https://hashmeta.com/blog/the-complete-guide-to-xiaohongshu-marketing-for-businesses/](https://hashmeta.com/blog/the-complete-guide-to-xiaohongshu-marketing-for-businesses/)  \n   244→19. Decoding China's \"New Ugly\" Graphic Design: The Rise of Intentional Imperfection \\- RADII, accessed December 30, 2025, [https://radii.co/article/decoding-chinas-new-ugly-graphic-design](https://radii.co/article/decoding-chinas-new-ugly-graphic-design)  \n   245→20. UI/UX design trends for 2025 \\- iterates, accessed December 30, 2025, [https://www.iterates.be/en/ui-ux-design-trends/](https://www.iterates.be/en/ui-ux-design-trends/)  \n   246→21. Best UI/UX Design Trends to Follow in 2025 | by Rahim Ladhani \\- Medium, accessed December 30, 2025, [https://nevinainfotech25.medium.com/best-ui-ux-design-trends-to-follow-in-2025-c31d3e62779c](https://nevinainfotech25.medium.com/best-ui-ux-design-trends-to-follow-in-2025-c31d3e62779c)  \n   247→22. A Guide to Understanding the Xiaohongshu Algorithm in 2025 \\- Aceninja Pte Ltd, accessed December 30, 2025, [https://www.aceninja.sg/insights/2025/01/02/a-guide-to-understanding-the-xiaohongshu-algorithm-in-2025](https://www.aceninja.sg/insights/2025/01/02/a-guide-to-understanding-the-xiaohongshu-algorithm-in-2025)  \n   248→23. Educational TikTok Ideas: Upgrade Your Higher Education TikTok Strategy \\- Juicer Social, accessed December 30, 2025, [https://www.juicer.io/blog/tiktok-ideas-higher-education](https://www.juicer.io/blog/tiktok-ideas-higher-education)  \n   249→24. Guide to WeCom (Wechat Work) Registration and Verification for Chinese and Overseas, accessed December 30, 2025, [https://www.lotussocialagency.com/blog/guide-to-wecom-wechat-work-registration-and-verification-for-chinese-and-overseas-enterprises](https://www.lotussocialagency.com/blog/guide-to-wecom-wechat-work-registration-and-verification-for-chinese-and-overseas-enterprises)  \n   250→25. Everything You Should Know About WeChat Work (WeCom) \\- Oxygen Strategic Partners, accessed December 30, 2025, [https://www.chooseoxygen.com/en/blog/everything-you-should-know-about-wechat-work](https://www.chooseoxygen.com/en/blog/everything-you-should-know-about-wechat-work)  \n   251→26. WeChat Official Account \\- Apps Documentation, accessed December 30, 2025, [https://apps.make.com/wechat?\\_gl=1\\*1i8ucl0\\*\\_gcl\\_au\\*MTkxNzM1NDk0OS4xNzQ5Njg0NTMz\\*\\_ga\\*MzUyNDk0NTY0LjE3NDE3NzA3OTY.\\*\\_ga\\_MY0CJTCDSF\\*czE3NTIwMjk5MTgkbzkxJGcwJHQxNzUyMDI5OTE4JGo2MCRsMCRoMA..](https://apps.make.com/wechat?_gl=1*1i8ucl0*_gcl_au*MTkxNzM1NDk0OS4xNzQ5Njg0NTMz*_ga*MzUyNDk0NTY0LjE3NDE3NzA3OTY.*_ga_MY0CJTCDSF*czE3NTIwMjk5MTgkbzkxJGcwJHQxNzUyMDI5OTE4JGo2MCRsMCRoMA..)  \n   252→27. How to configure the WeChat gateway interface? \\- Tencent Cloud, accessed December 30, 2025, [https://www.tencentcloud.com/techpedia/117919](https://www.tencentcloud.com/techpedia/117919)  \n   253→28. WeChat Official Account Guide for Business \\- Omnichat Blog, accessed December 30, 2025, [https://blog.omnichat.ai/wechat-official-account/](https://blog.omnichat.ai/wechat-official-account/)  \n   254→29. 5 Incredible Examples of Top Gamification Apps \\- Purchasely, accessed December 30, 2025, [https://www.purchasely.com/blog/5-incredible-examples-of-top-gamification-apps](https://www.purchasely.com/blog/5-incredible-examples-of-top-gamification-apps)  \n   255→30. Improving Student Concentration with Microlearning \\- Teacher Certification Test Prep, accessed December 30, 2025, [https://teachinglicense.study.com/resources/microlearning-teacher-guide](https://teachinglicense.study.com/resources/microlearning-teacher-guide)  \n   256→31. Frequently Asked Questions about Co–Star Astrology Society, accessed December 30, 2025, [https://www.costarastrology.com/faq](https://www.costarastrology.com/faq)  \n   257→32. How Do Astrology Apps Make Money | Monetization Model \\- IMG Global Infotech, accessed December 30, 2025, [https://www.imgglobalinfotech.com/blog/how-astrology-apps-make-money](https://www.imgglobalinfotech.com/blog/how-astrology-apps-make-money)  \n   258→33. Y2k Astrology Print \\- Etsy, accessed December 30, 2025, [https://www.etsy.com/market/y2k\\_astrology\\_print](https://www.etsy.com/market/y2k_astrology_print)  \n   259→34. AstroTalk Business Model Explained — Learn How It Generates Millions, accessed December 30, 2025, [https://miracuves.com/blog/astrotalk-clone-revenue-model/](https://miracuves.com/blog/astrotalk-clone-revenue-model/)\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"155a7ec6-aa6e-407e-bb77-9b0be11d0801","timestamp":"2025-12-30T04:14:00.049Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/docs/architech/idea business model.md","content":"\n本报告旨在详尽定义一款融合了\\*\\*形而上学数据（占星/命理）**与**循证心理学框架（CBT/WOOP）\\*\\*的AI产品的核心本质。我们将利用TanStack AI等前沿技术架构 3，结合小红书的“玄学审美”趋势 4 与TikTok的病毒式传播逻辑 5，构建一个高留存、高转化的用户增长闭环。报告将深入探讨如何通过“状态分数（State Score）”的游戏化机制解决留存难题，并设计一套借鉴游戏经济系统的混合变现模式。\n\n## ---\n\n**2\\. 产品核心本质与最大卖点定义**\n\n核心本质：基于AI智能体的精神数字孪生\n1. 用户的精神数字孪生\n1.1 占星学、命理学，用户自我认知的“元数据”\n1.2 通过智能体交互，及各种功能模块，不断累计用户信息，并沉淀用户分析（用各种心理学，精神学建模框架）\n1.3 把复杂的占星，命理，心理框架指标简化为数据指标框架，和时间序列；通过这个简化的系统能够把各种分析框架工具融合；也给用户一目了然；并提供动力和粘性。将枯燥的“心理成长”包装成RPG游戏般的“状态升级”。用户不是在“治疗”，而是在“练级”\n1.4 社交功能：通过合盘，属性匹配，鼓励互动等机制促进社交，促进更新颖，精准，更深度的链接和社交\n1.5 复杂的精神，心理，人际关系等变得可分析，可量化，可解释，可行动，可促进\n1.6 把积极行为心理干预融入产品\n1.7 与社交媒体的深度融合（小红书，微信，tiktok），如给好友提升能量状态，图片分享打赏，好运接龙，吐槽大会；这些都通过一套算法机制影响到用户的状态分数\n\n2. AI智能体\n2.1 用户专属ai智能体通过不断与用户交互和分析，互动，反馈，进化为用户专属的心理/精神操作系统，越来越了解用户，能够给到更精准的反馈，和行为指导行为干预，各种信息和行为到用户数字孪生的管理和映射\n2.2 这个智能体通过对话（chat）和功能区两个模式与用户交互；后台智能体还能把对话内容在功能区丰富展示显化\n2.3 主动计算，主动推送\n\n在产品定义的深层逻辑上，我们要摒弃传统的“工具属性”。这款产品的本质不应被定义为“算命工具”或“冥想软件”，而应定义为\\*\\*“基于时空数据的动态心理伴侣”\\*\\*。\n\n\n| 功能模块 | 核心描述 | 技术/心理学支撑 | 价值主张 |\n| :---- | :---- | :---- | :---- |\n| **全息AI占星师 (The Oracle)** | 支持实时语音/文本流式交互的AI Chatbot，能解析本命盘、流年运势。 | TanStack AI (Streaming), Kerykeion (Python Lib) | 即时解答疑惑，提供情绪价值。 |\n| **状态分数系统 (State Score)** | 每日动态评分系统，基于用户打卡（WOOP）、星象能量及心理测验生成。 | Gamification Mechanics, Habitica Model 11 | 量化今日状态，激发提升欲望。 |\n| **微型觉察课程 (Micro-Courses)** | 针对当前状态推荐的3-5分钟音频/视频课程（冥想、CBT、呼吸法）。 | Micro-learning, Bite-sized content 12 | 在用户最脆弱时提供即时干预。 |\n| **社交合盘雷达 (Social Radar)** | 扫码生成与朋友/伴侣的详细匹配度报告及相处指南。 | Synastry Algorithms 13 | 极强的病毒传播诱饵。 |\n| **视觉化能量仪表盘 (Cosmic Dashboard)** | 以Y2K/新中式赛博风格展示今日能量分布（火/土/风/水元素）。 | Neo-Chinese / Acid Graphics 4 | 满足Z世代的审美与分享需求。 |\n\n## ---\n\n**3\\. 技术架构与工程实现策略**\n\n作为一款旨在承载高并发、实时交互的产品，技术选型必须兼顾开发效率、类型安全与供应商中立性。\n\n### **3.1 基于TanStack AI的中立化底座**\n\n在构建AI核心时，我们应坚决避免被单一供应商（如OpenAI或Vercel）锁定。根据调研，**TanStack AI** 是目前的最佳选择，被称为“AI工具领域的瑞士” 7。\n\n* 供应商中立策略 (Provider Agnostic)：  \n  TanStack AI 允许我们通过适配器模式（Adapter Pattern）无缝切换模型。对于简单的每日运势生成，我们可以调用成本较低的 Llama 3 (via Groq) 或 Haiku 模型；而对于复杂的心理咨询对话或WOOP引导，则动态切换至 GPT-4o 或 Claude 3.5 Sonnet 以获得更好的推理能力 3。这种架构能将运营成本（COGS）降低40%以上。  \n* 端到端类型安全 (End-to-End Type Safety)：  \n  利用 TypeScript 和 Zod schema，我们能确保 AI 输出的结构化数据（如星盘参数、课程推荐ID）绝对符合前端组件的要求。这消除了传统开发中AI产生幻觉导致应用崩溃的风险 3。  \n* 流式响应体验 (Streaming UX)：  \n  心理咨询场景对延迟极度敏感。TanStack AI 原生支持 AsyncIterable 流式传输，能让AI的回复像人类打字一样逐字浮现。这种“思考感”是建立用户信任的关键心理暗示 3。\n\n### **3.2 核心算法库：Kerykeion与天文计算**\n\n产品的“玄学”底座不能建立在虚构之上，必须基于精确的天文学数据。\n\n* **Kerykeion Python库集成：** 我们将在后端集成 Kerykeion 库 6。它基于瑞士星历表（Swiss Ephemeris），能精确计算行星经纬度、宫位（Placidus/Whole Sign）及相位（Aspects）。  \n* **合盘算法 (Synastry Engine)：** 开发自定义的合盘评分系统。参考占星学逻辑，计算两人行星之间的相位（如金星拱火星为+10分，土星刑月亮为-15分），最终生成一个“缘分指数” 10。\n\n## ---\n\n**4\\. 基于社交媒体的用户增长策略 (User Acquisition)**\n\n作为用户增长专家，我们不依赖单一的买量渠道，而是构建一个\\*\\*“内容种草-病毒传播-私域沉淀”\\*\\*的增长飞轮。\n\n### **4.1 小红书 (Xiaohongshu)：种草与审美红利**\n\n小红书是本产品的核心冷启动平台，其70%的女性用户与泛心理/玄学受众高度重合 18。\n\n**策略核心：KFS模型 (KOL \\- Feed \\- Search)**\n\n1. **视觉美学：新中式赛博与Y2K酸性设计 (Neo-Chinese & Acid Graphics)**  \n   * **趋势洞察：** 2025年的设计趋势正向“新丑风（New Ugly）”、“Y2K酸性图形”以及“新中式玄学”演变 4。  \n   * **内容策略：** 我们的App UI设计必须具备极高的“成图率”。生成的星盘不应是枯燥的图表，而应是融合了镭射质感、毛玻璃效果（Glassmorphism）与传统符箓元素的艺术品。用户分享的不仅仅是运势，更是**审美身份** 20。  \n   * **内容形式：** 制作“好运壁纸”、“水逆退散符”、“MBTI vs 星盘”等高颜值图文。  \n2. **KOL/KOC矩阵投放：**  \n   * **去中心化投放：** 不追求头部大V，而是批量投放1-10万粉丝的腰部博主（Mid-tier KOLs）和关键意见消费者（KOCs）。数据显示，这一层级的ROI通常比头部高出30-40% 18。  \n   * **场景化叙事：** 内容脚本侧重于“解决具体问题”。例如：“分手后怎么走出来？这个App的AI陪我聊了整整三天”、“完全被说中！星盘显示我今年注定换工作”。  \n3. **搜索截流 (SEO)：**  \n   * 针对“塔罗”、“星座运势”、“焦虑”、“失眠”等高频关键词进行SEO优化，确保用户搜索时，我们的笔记占据前排位置 22。\n\n### **4.2 TikTok / Douyin：情绪共鸣与视觉钩子**\n\nTikTok用于通过短视频获取泛流量，核心在于\\*\\*“黄金3秒”\\*\\*的抓取力 5。\n\n**策略核心：情绪触发与互动滤镜**\n\n1. **钩子设计 (The Hook)：**  \n   * 视频开头必须在3秒内通过视觉或听觉冲击留住用户。例如：“如果你是天蝎座，千万别划走！”、“AI算出了我前任的回头率，结果准得可怕” 5。  \n2. **绿幕解说 (Green Screen)：**  \n   * 利用TikTok的绿幕功能，背景放明星的星盘或热点事件的主角星盘，博主在前方进行“AI辅助解读”。这种内容制作成本低，但通过蹭热点（Newsjacking）能获得巨大流量 1。  \n3. **互动特效开发：**  \n   * 开发品牌专属的TikTok特效（Effect），如“测测你的灵性动物”或“今日能量颜色”。用户使用特效拍摄视频本身就是一种裂变传播 23。\n\n### **4.3 微信生态 (WeChat)：私域流量与自动化服务**\n\n微信不仅是流量入口，更是高价值用户的**沉淀池**。\n\n**策略核心：企业微信 (WeCom) \\+ 自动化私域**\n\n1. **企业微信承接：**  \n   * 在公域（小红书/TikTok）引导用户添加“AI疗愈师”的企业微信。通过企业微信，我们可以给用户打上“失恋”、“求职”、“考研”等标签，进行精细化运营 24。  \n2. **服务号AI Agent集成：**  \n   * 利用微信服务号接口 26，将我们的TanStack AI Chatbot直接嵌入微信对话框。用户无需下载App即可体验核心对话功能，降低门槛。  \n3. **自动化Drip Marketing：**  \n   * 根据用户的星盘数据，在特定天象（如满月、新月）自动推送定制化的“能量提醒”到微信。这种“比男友更贴心”的服务能极大提升用户粘性 28。\n\n## ---\n\n**5\\. 用户留存机制：状态分数与游戏化闭环**\n\n要解决工具类应用“用完即走”的弊端，我们需要构建一套**内驱力驱动的游戏化系统**。\n\n### **5.1 核心机制：状态分数 (State Score)**\n\n这是一个量化用户身心状态的动态指标（0-100分），它不仅仅是记录，更是行动的指南。\n\n* 计算逻辑：\n\n  $$\\\\text{State Score} \\= (0.4 \\\\times \\\\text{Astrological Transit}) \\+ (0.3 \\\\times \\\\text{Check-in Streak}) \\+ (0.3 \\\\times \\\\text{Task Completion})$$  \n  * *Astrological Transit（天象系数）：* 基于Kerykeion计算的当日行运（客观环境）。  \n  * *Check-in Streak（打卡连续性）：* 用户连续记录心情的天数。  \n  * *Task Completion（任务完成度）：* 完成当日推荐的微课程或冥想任务。  \n* **心理学锚点：** 利用“损失厌恶（Loss Aversion）”心理，如果用户中断打卡或不进行能量维护，分数会下降，从而影响其Avatar（虚拟形象）的光泽度或装备 29。\n\n### **5.2 激发用户提升状态：WOOP框架的AI化**\n\n我们将心理学中的 **WOOP (Wish, Outcome, Obstacle, Plan)** 框架 8 植入到每日的AI对话中。\n\n* **交互流程：**  \n  1. **Wish (愿望)：** AI询问：“基于今天的星象，你今天最想达成什么？”  \n  2. **Outcome (结果)：** “达成后会有什么感觉？”（通过视觉化增强动力）。  \n  3. **Obstacle (障碍)：** “你的土星受克，可能会遇到拖延，这是否是你担心的障碍？”（结合玄学数据精准提问）。  \n  4. **Plan (计划)：** “如果出现拖延，我们将执行什么微行动？”（生成具体的If-Then计划）。  \n* **激励机制：** 完成WOOP对话后，用户的“状态分数”显著提升，并获得“能量币”奖励。\n\n### **5.3 学习课程：微型学习 (Micro-learning) 与即时干预**\n\n针对现代人碎片化的注意力，课程设计必须遵循\\*\\*“Bite-sized（一口吃）”\\*\\*原则 12。\n\n* **课程形态：** 3-5分钟的音频或交互式视频。  \n* **内容库：**  \n  * *急救类：* “3分钟缓解水逆焦虑呼吸法”、“面试前自信冥想”。  \n  * *认知类：* “CBT入门：识别情绪陷阱”、“占星学基础：认识你的月亮”。  \n* **触发机制：** 当用户的“状态分数”低于60分时，系统自动推荐“能量补给包（课程）”，用户完成课程后分数即时回升。这种\\*\\*“诊断-治疗-反馈”\\*\\*的闭环极其有效。\n\n### **5.4 社交分享：合盘作为病毒引擎**\n\n* **合盘报告 (Synastry Report)：** 允许用户生成与朋友的合盘。报告不只显示分数，更显示“相处说明书”。例如：“你们的沟通（水星）很合拍，但情感需求（月亮）有冲突。” 10。  \n* **状态共享 (Vibe Check)：** 用户可以选择将自己的“状态分数”展示给亲密好友。当好友分数低时，系统提示你去“Send Good Vibes”（发送能量/虚拟礼物），促进App内的社交互动 31。\n\n## ---\n\n**6\\. 收费模式设计：借鉴游戏经济系统的混合变现**\n\n我们将摒弃单一的SaaS订阅模式，转而采用\\*\\*“订阅+内购+激励”\\*\\*的混合游戏化变现模型。\n\n### **6.1 免费层 (Free Tier)：流量漏斗**\n\n* **权益：** 每日基础运势、本命盘查看、每日10次AI对话额度。  \n* **目的：** 最大化用户获取（UA）和数据收集。\n\n### **6.2 会员订阅 (Subscription \\- The Battle Pass)：稳定现金流**\n\n* **名称：** “宇宙通行证 (Cosmic Pass)”  \n* **定价：** 月卡/年卡模式。  \n* **权益：**  \n  * 无限次AI对话。  \n  * 解锁未来30天的运势预测（Time Travel功能）。  \n  * 解锁所有高级合盘（无限次查看与他人的匹配度）。  \n  * 解锁所有微课程内容。\n\n### **6.3 特色产品收费 (In-App Purchases \\- Micro-transactions)：高ARPU值挖掘**\n\n借鉴游戏模式，针对非订阅用户或高净值用户提供单次购买：\n\n1. **深度报告 (Deep Dives)：** 单次购买一份“2025年度个人全景报告”或“职业生涯深度解析PDF”。利用AI生成20-30页的详尽内容 32。  \n2. **皮肤与资产 (Skins & Assets)：** 为用户的虚拟形象（Avatar）购买“星座限定皮肤”、“光环特效”。这些虚拟资产满足了Z世代的数字身份展示需求 33。  \n3. **能量加速包 (Energy Boosts)：** 购买额外的“补签卡”以维持打卡Streak，或购买“提问券”以咨询更复杂的真人占星师（如果我们引入真人专家层）34。\n\n### **6.4 推广奖励 (Referral Rewards)：病毒系数放大器**\n\n设计双向奖励机制以最大化K因子（K-factor）：\n\n* **机制：** 邀请一位好友注册，双方各获得 **7天高级会员体验** 或 **500个能量币**。  \n* **社交裂变：** 当用户分享合盘报告给微信好友时，好友扫码查看必须注册。这是最高效的拉新手段。  \n* **KOC计划：** 对于邀请超过10人的用户，自动升级为“星际大使”，获得现金返利或永久会员权益，激励他们在私域流量中推广。\n\n## ---\n\n**7\\. 结论与展望**\n\n这款产品的核心竞争力在于**利用AI技术将玄学的“模糊性”转化为心理服务的“确定性”，并利用游戏化机制将“自我探索”转化为“成瘾性习惯”。**\n\n通过TanStack AI构建灵活的技术底座，利用小红书和TikTok的审美红利获取Z世代用户，通过状态分数和WOOP框架锁住用户注意力，最后通过混合变现模式实现商业价值。这不仅是一个App，它是连接古老智慧与未来科技的桥梁，是后数字时代人类寻求精神慰藉的**认知基础设施**。\n\n### **关键成功指标 (KPIs) 预测：**\n\n* **次日留存 (Day 1 Retention)：** 目标 \\> 45% (通过每日运势推送与状态分数驱动)。  \n* **病毒系数 (K-factor)：** 目标 \\> 1.2 (通过合盘分享驱动)。  \n* **付费转化率 (Conversion Rate)：** 目标 \\> 5% (通过游戏化内购与会员权益驱动)。\n\n这是一场关于重新定义“幸福感”产业的实验，而我们正掌握着开启这扇大门的密钥。\n\n### ---\n\n**表格：变现模式对比与设计**\n\n| 收费模式 | 实施细节 | 心理学机制 | 预期贡献占比 |\n| :---- | :---- | :---- | :---- |\n| **Freemium (免费增值)** | 基础盘面/运势免费，解锁深度解读收费。 | **门槛效应**：先让用户低成本进入，形成依赖。 | \\- (流量入口) |\n| **Subscription (订阅制)** | 月卡/年卡，解锁无限对话、课程、未来运势。 | **损失厌恶**：不仅是为了获得，更是为了不失去高级功能。 | 50% |\n| **Micro-transactions (内购)** | 单份深度报告、皮肤、补签卡、能量币。 | **即时满足**：小额支付带来的心理负担低，易冲动消费。 | 30% |\n| **Consultation (真人咨询)** | 对接真人占星师/咨询师的高客单价服务。 | **权威崇拜**：AI解决日常，真人解决重大危机。 | 20% |\n\n### **表格：用户增长渠道策略矩阵**\n\n| 渠道 (Channel) | 核心目标 | 关键战术 (Tactics) | 内容风格 (Style) |\n| :---- | :---- | :---- | :---- |\n| **小红书 (Xiaohongshu)** | **信任建立与种草** | KFS投放模型；图文高审美；私域引流。 | 新中式赛博、Y2K酸性设计、情感共鸣小作文。 |\n| **TikTok/抖音** | **病毒传播与曝光** | 3秒钩子；绿幕解说；互动特效；蹭热点。 | 强视觉冲击、快节奏、反转剧情、神秘感。 |\n| **微信/WeCom** | **留存与LTV挖掘** | AI Agent嵌入服务号；社群运营；自动化推送。 | 服务型、陪伴型、Drip Marketing。 |\n\n(报告结束)\n\n#### **Works cited**\n\n1. Gen Z's Digital Astrology Obsession 2025 | How AI Made the Stars Go Viral \\- The Economic Times, accessed December 30, 2025, [https://m.economictimes.com/astrology/others/gen-zs-obsession-with-astrology-in-2025-how-ai-and-social-media-made-the-stars-go-viral/articleshow/125056677.cms](https://m.economictimes.com/astrology/others/gen-zs-obsession-with-astrology-in-2025-how-ai-and-social-media-made-the-stars-go-viral/articleshow/125056677.cms)  \n2. Expert comment: why is Gen Z looking to the stars for meaning? \\- Oxford Brookes University, accessed December 30, 2025, [https://www.brookes.ac.uk/about-brookes/news/news-from-2025/05/expert-comment-why-is-gen-z-looking-to-the-stars-f](https://www.brookes.ac.uk/about-brookes/news/news-from-2025/05/expert-comment-why-is-gen-z-looking-to-the-stars-f)  \n3. TanStack AI: Building Type-Safe, Provider-Agnostic AI Applications \\- Better Stack, accessed December 30, 2025, [https://betterstack.com/community/guides/ai/tanstack-ai/](https://betterstack.com/community/guides/ai/tanstack-ai/)  \n4. Xpiritualism on Xiaohongshu: Decoding China's Post-Internet Taoism \\- RADII, accessed December 30, 2025, [https://radii.co/article/xpiritualism-on-xiaohongshu](https://radii.co/article/xpiritualism-on-xiaohongshu)  \n5. TikTok Content Strategy: How to Plan, Post, and Grow in 2025 \\- SEO Sherpa, accessed December 30, 2025, [https://seosherpa.com/tiktok-content-strategy/](https://seosherpa.com/tiktok-content-strategy/)  \n6. kerykeion \\- PyPI, accessed December 30, 2025, [https://pypi.org/project/kerykeion/](https://pypi.org/project/kerykeion/)  \n7. The Switzerland of AI Tooling: Inside TanStack AI's Bold New Approach \\- DEV Community, accessed December 30, 2025, [https://dev.to/usman\\_awan/the-switzerland-of-ai-tooling-inside-tanstack-ais-bold-new-approach-1cbb](https://dev.to/usman_awan/the-switzerland-of-ai-tooling-inside-tanstack-ais-bold-new-approach-1cbb)  \n8. WOOP Goal Setting: The Secrets Behind the Method and How to Apply It \\- Deel, accessed December 30, 2025, [https://www.deel.com/blog/woop-goal-setting/](https://www.deel.com/blog/woop-goal-setting/)  \n9. Why Personalized Astrology Apps Are Appealing to Gen Z \\- Time Magazine, accessed December 30, 2025, [https://time.com/6083293/astrology-apps-personalized/](https://time.com/6083293/astrology-apps-personalized/)  \n10. Will someone pls explain how zodiac compatibility works? : r/astrology \\- Reddit, accessed December 30, 2025, [https://www.reddit.com/r/astrology/comments/1cpfxm6/will\\_someone\\_pls\\_explain\\_how\\_zodiac\\_compatibility/](https://www.reddit.com/r/astrology/comments/1cpfxm6/will_someone_pls_explain_how_zodiac_compatibility/)  \n11. Gamification | Habitica Wiki | Fandom, accessed December 30, 2025, [https://habitica.fandom.com/wiki/Gamification](https://habitica.fandom.com/wiki/Gamification)  \n12. Bite-size workshops and webinars — Minds That Work \\- Workplace mental wellbeing training and consultancy, accessed December 30, 2025, [https://mindsthatwork.com/services/bite-size](https://mindsthatwork.com/services/bite-size)  \n13. Astrological Compatibility Scores | PDF \\- Scribd, accessed December 30, 2025, [https://www.scribd.com/document/787514232/romantic-scores](https://www.scribd.com/document/787514232/romantic-scores)  \n14. Graphic design trends for 2025 \\- Adobe, accessed December 30, 2025, [https://www.adobe.com/express/learn/blog/design-trends-2025](https://www.adobe.com/express/learn/blog/design-trends-2025)  \n15. TanStack AI Review: A Better Vercel AI SDK Alternative? | Stork.AI, accessed December 30, 2025, [https://www.stork.ai/blog/tanstack-ai-the-vercel-killer-we-needed](https://www.stork.ai/blog/tanstack-ai-the-vercel-killer-we-needed)  \n16. The Vercel AI SDK Killer? Why Tanstack AI is the Next Big Thing for AI Agent Development, accessed December 30, 2025, [https://innohub.powerweave.com/?p=529](https://innohub.powerweave.com/?p=529)  \n17. kerykeion \\- Codesandbox, accessed December 30, 2025, [http://codesandbox.io/p/github/mettaversesociety/kerykeion](http://codesandbox.io/p/github/mettaversesociety/kerykeion)  \n18. The Complete Guide to Xiaohongshu Marketing for Businesses \\- Hashmeta, accessed December 30, 2025, [https://hashmeta.com/blog/the-complete-guide-to-xiaohongshu-marketing-for-businesses/](https://hashmeta.com/blog/the-complete-guide-to-xiaohongshu-marketing-for-businesses/)  \n19. Decoding China's \"New Ugly\" Graphic Design: The Rise of Intentional Imperfection \\- RADII, accessed December 30, 2025, [https://radii.co/article/decoding-chinas-new-ugly-graphic-design](https://radii.co/article/decoding-chinas-new-ugly-graphic-design)  \n20. UI/UX design trends for 2025 \\- iterates, accessed December 30, 2025, [https://www.iterates.be/en/ui-ux-design-trends/](https://www.iterates.be/en/ui-ux-design-trends/)  \n21. Best UI/UX Design Trends to Follow in 2025 | by Rahim Ladhani \\- Medium, accessed December 30, 2025, [https://nevinainfotech25.medium.com/best-ui-ux-design-trends-to-follow-in-2025-c31d3e62779c](https://nevinainfotech25.medium.com/best-ui-ux-design-trends-to-follow-in-2025-c31d3e62779c)  \n22. A Guide to Understanding the Xiaohongshu Algorithm in 2025 \\- Aceninja Pte Ltd, accessed December 30, 2025, [https://www.aceninja.sg/insights/2025/01/02/a-guide-to-understanding-the-xiaohongshu-algorithm-in-2025](https://www.aceninja.sg/insights/2025/01/02/a-guide-to-understanding-the-xiaohongshu-algorithm-in-2025)  \n23. Educational TikTok Ideas: Upgrade Your Higher Education TikTok Strategy \\- Juicer Social, accessed December 30, 2025, [https://www.juicer.io/blog/tiktok-ideas-higher-education](https://www.juicer.io/blog/tiktok-ideas-higher-education)  \n24. Guide to WeCom (Wechat Work) Registration and Verification for Chinese and Overseas, accessed December 30, 2025, [https://www.lotussocialagency.com/blog/guide-to-wecom-wechat-work-registration-and-verification-for-chinese-and-overseas-enterprises](https://www.lotussocialagency.com/blog/guide-to-wecom-wechat-work-registration-and-verification-for-chinese-and-overseas-enterprises)  \n25. Everything You Should Know About WeChat Work (WeCom) \\- Oxygen Strategic Partners, accessed December 30, 2025, [https://www.chooseoxygen.com/en/blog/everything-you-should-know-about-wechat-work](https://www.chooseoxygen.com/en/blog/everything-you-should-know-about-wechat-work)  \n26. WeChat Official Account \\- Apps Documentation, accessed December 30, 2025, [https://apps.make.com/wechat?\\_gl=1\\*1i8ucl0\\*\\_gcl\\_au\\*MTkxNzM1NDk0OS4xNzQ5Njg0NTMz\\*\\_ga\\*MzUyNDk0NTY0LjE3NDE3NzA3OTY.\\*\\_ga\\_MY0CJTCDSF\\*czE3NTIwMjk5MTgkbzkxJGcwJHQxNzUyMDI5OTE4JGo2MCRsMCRoMA..](https://apps.make.com/wechat?_gl=1*1i8ucl0*_gcl_au*MTkxNzM1NDk0OS4xNzQ5Njg0NTMz*_ga*MzUyNDk0NTY0LjE3NDE3NzA3OTY.*_ga_MY0CJTCDSF*czE3NTIwMjk5MTgkbzkxJGcwJHQxNzUyMDI5OTE4JGo2MCRsMCRoMA..)  \n27. How to configure the WeChat gateway interface? \\- Tencent Cloud, accessed December 30, 2025, [https://www.tencentcloud.com/techpedia/117919](https://www.tencentcloud.com/techpedia/117919)  \n28. WeChat Official Account Guide for Business \\- Omnichat Blog, accessed December 30, 2025, [https://blog.omnichat.ai/wechat-official-account/](https://blog.omnichat.ai/wechat-official-account/)  \n29. 5 Incredible Examples of Top Gamification Apps \\- Purchasely, accessed December 30, 2025, [https://www.purchasely.com/blog/5-incredible-examples-of-top-gamification-apps](https://www.purchasely.com/blog/5-incredible-examples-of-top-gamification-apps)  \n30. Improving Student Concentration with Microlearning \\- Teacher Certification Test Prep, accessed December 30, 2025, [https://teachinglicense.study.com/resources/microlearning-teacher-guide](https://teachinglicense.study.com/resources/microlearning-teacher-guide)  \n31. Frequently Asked Questions about Co–Star Astrology Society, accessed December 30, 2025, [https://www.costarastrology.com/faq](https://www.costarastrology.com/faq)  \n32. How Do Astrology Apps Make Money | Monetization Model \\- IMG Global Infotech, accessed December 30, 2025, [https://www.imgglobalinfotech.com/blog/how-astrology-apps-make-money](https://www.imgglobalinfotech.com/blog/how-astrology-apps-make-money)  \n33. Y2k Astrology Print \\- Etsy, accessed December 30, 2025, [https://www.etsy.com/market/y2k\\_astrology\\_print](https://www.etsy.com/market/y2k_astrology_print)  \n34. AstroTalk Business Model Explained — Learn How It Generates Millions, accessed December 30, 2025, [https://miracuves.com/blog/astrotalk-clone-revenue-model/](https://miracuves.com/blog/astrotalk-clone-revenue-model/)","numLines":259,"startLine":1,"totalLines":259}}}
{"parentUuid":"155a7ec6-aa6e-407e-bb77-9b0be11d0801","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"59d0d4ba-3ce6-4814-bf5c-2a7e697cdf3e","version":"2.0.74","gitBranch":"","agentId":"a66b687","slug":"inherited-greeting-perlis","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01A7wixjfijVTYWWSzoaq6hX","type":"tool_result","content":"     1→# Fortune AI 最终 MVP 系统设计（Web 可落地 / PostgreSQL / GLM）\n     2→\n     3→**文档类型**：Final MVP System Design  \n     4→**产品代号**：`Fortune AI`  \n     5→**版本**：Final MVP v1.0  \n     6→**日期**：2025-12-29  \n     7→**核心定位**：AI 驱动的“人生导航 / 陪伴 / 提升系统”（有效而极简）  \n     8→**硬约束**：纯 AI（不引入真人服务）/ 不做社区 / Web 端可落地 / **Fortune AI 业务数据仅使用 PostgreSQL（DB=fortune_ai）**；深度报告支持 `backend=cli|gemini`：`gemini` 仅在调用 gemini 报告链路时连接 `DB=gemini`（`gemini_job/gemini_task`），`cli` 仅调用 `cli_worker` 的执行与状态查询（业务 SSOT 仍写入 `fortune_ai`）  \n     9→**LLM**：**GLM（Z.AI / /api/paas/v4/chat/completions）**  \n    10→**入口**：`/main`（**两栏**：左=对话（含会话切换/历史抽屉）右=Workbench（顶部结果 Viewer + 下方 Tabs 输入/配置）；未登录跳转 `/login`）  \n    11→\n    12→---\n    13→\n    14→## 0. 一页结论（给产品 & 开发）\n    15→\n    16→### 0.1 MVP 交付目标\n    17→\n    18→在 Web 端跑通一个可重复、可度量、可追溯的“陪跑闭环”：\n    19→\n    20→`Clarify → Insight → Prescription → Commitment → Action → Reflection → Memory Update`\n    21→\n    22→并用最小交互承载三大价值：\n    23→- **导航**：把问题结构化成 `Options / Constraints / Risk Boundary / Next Experiment`\n    24→- **陪伴**：以积极心理学 / Performance Coach 话术承接情绪（不恐吓、不宿命）\n    25→- **提升**：把输出收敛为可执行行动与能力训练轨道（30 天计划 + 复盘）\n    26→\n    27→### 0.2 北极星指标（统一口径）\n    28→\n    29→`WCG`（Weekly Closed-loop Guidance）  \n    30→定义：用户在一周内完成 ≥1 次“触发 → 指引 → 行动 → 反馈”闭环。\n    31→\n    32→### 0.3 最终合并决策（Codex MVP × Claude MVP）\n    33→\n    34→| 决策点 | 最终方案（Final MVP） | 取舍理由 |\n    35→|---|---|---|\n    36→| 闭环核心 | 引入 `Commitment`（4 类承诺） | 没有承诺就没有闭环；与“提升”一致 |\n    37→| 交互效率 | “三点击原则”作为验收标准 | 可验收、可迭代、可控复杂度 |\n    38→| 布局 | **两栏**（对话 + 功能区；会话历史为抽屉/弹层） | 保持极简与高效；多会话仍可用但不占常驻空间 |\n    39→| Bento | 卡片为内容 + Tab 为容器 | 卡片可复用、Tab 可组织复杂度 |\n    40→| 计划 | 4 个预设计划开箱即用 + 30 天轨道统一口径 | 降低选择成本，同时保证“提升”可度量 |\n    41→| 知识库 | **PostgreSQL FTS + pg_trgm**（不引入其他 DB） | 可真实落地、可运维、可追溯 |\n    42→| LLM | GLM（Z.AI / ChatGLM-4） | 统一对话与文本生成后端，便于治理 |\n    43→\n    44→---\n    45→\n    46→## 1. 产品原则（硬规则，可验收）\n    47→\n    48→### 1.1 三点击原则\n    49→\n    50→任何核心价值都必须在 ≤3 次点击内完成：\n    51→- 打开 `/main` → 看今日指引 → 选择一个行动（Commitment）\n    52→- 点“情绪打卡” → 选情绪/强度 → 获得一个调节动作并开始\n    53→- 点“决策模板” → 选问题类型 → 生成下一步实验并加入待办\n    54→\n    55→### 1.2 每次交互必落到 Commitment\n    56→\n    57→`commitment_type`（仅 4 类）：\n    58→- `start_task`：立刻开始（≤5 分钟优先）\n    59→- `schedule_task`：加入今日/本周并设提醒\n    60→- `ask_followup`：选择一个澄清问题继续（减少开放式追问）\n    61→- `opt_out`：暂停/关闭（推送与反依赖的必要出口）\n    62→\n    63→### 1.3 反依赖机制（防玄学依赖）\n    64→\n    65→| 触发条件 | 系统响应（默认温和） |\n    66→|---|---|\n    67→| 连续 3 次问同一问题 | 强制给“现实行动实验”（5–15 分钟）后再继续；提供“我愿意执行/稍后/不再提示” |\n    68→| 当日咨询 > 5 次 | 提示“信息足够，先行动”；给 1 个最小任务并结束回合 |\n    69→| 轨道达标毕业 | 主动降频推送；强调自我掌控；引导进入维护期或换轨道 |\n    70→\n    71→### 1.4 Agent 角色优先级（不可逆）\n    72→\n    73→`Coach > Teaching Assistant > Customer Support > Sales`\n    74→\n    75→销售规则：**先交付价值，再给升级路径**；禁止恐吓式转化。\n    76→\n    77→---\n    78→\n    79→## 2. 前端交互（Web /main：两栏 + Bento）\n    80→\n    81→### 2.1 登录与用户管理（无游客模式）\n    82→\n    83→- 未登录访问 `/main` 时，服务端返回 `302` 跳转到 `/login`。\n    84→- `/login`：邮箱 + 密码登录（成功后写入会话 Cookie）。\n    85→- `/register`：邮箱 + 密码注册（注册即登录），并在同一流程内完成最小 Profile（姓名/性别/出生信息/地点）。\n    86→- `设置` Tab 必须包含：\n    87→  - 修改密码\n    88→  - 退出登录\n    89→  - 注销账户（软删除，清空会话）\n    90→\n    91→### 2.2 页面结构\n    92→\n    93→`/main` 两栏布局（极简且可落地）：\n    94→- 左：对话线程（Chat Thread，SSOT）+ 顶部会话切换；会话历史以**抽屉/弹层**呈现（不常驻）\n    95→- 右：功能区（Bento/Workbench，承载所有非语言交互）\n    96→\n    97→**ASCII（桌面端 /main 结构）**\n    98→\n    99→```text\n   100→┌──────────────────────────────────────────────────────────────────────────┐\n   101→│ Fortune AI | 会话 ▼ | 风格: warm | 设置 | 退出                              │\n   102→├───────────────────────────────┬──────────────────────────────────────────┤\n   103→│ Chat Thread (SSOT)             │ Bento / Workbench                         │\n   104→│ ─────────────────────────────  │ Tabs: [Bento] [工具] [设置]               │\n   105→│ · 会话历史（抽屉/弹层，按需开） │                                           │\n   106→│ · 消息流（用户/教练）          │ 6 张核心卡片（1 tap 启动）                 │\n   107→│ · 输入框 + 快捷动作            │ + 工具：八字报告/校准/铁板                 │\n   108→│                                │ + 设置：push/静默/隐私/语言风格           │\n   109→└───────────────────────────────┴──────────────────────────────────────────┘\n   110→```\n   111→\n   112→### 2.3 右侧 Bento（Tab 作为容器，卡片为内容）\n   113→\n   114→右侧固定 3 个 Tab：\n   115→- `Bento`（默认）：6 张核心卡片\n   116→- `工具`：八字报告 / 出生校准 / 铁板神算\n   117→- `设置`：语言风格 / 推送与静默时段 / 隐私与数据管理\n   118→\n   119→**Bento 6 张核心卡片（全部 1 tap 启动）**\n   120→1) `今日指引`：结论 + 1 个动作（按钮）  \n   121→2) `行动处方`：最多 3 个进行中任务（完成/跳过/复盘）  \n   122→3) `情绪打卡`：情绪 + 强度（0–10）→ 归因 + 1 个调节动作  \n   123→4) `成长计划`：预设计划（4 个）+ 30 天游程轨道（统一进度口径）  \n   124→5) `决策模板`：Decision Brief（Options/Constraints/Risks/Next Experiment）  \n   125→6) `话术生成`：场景 → 可复制模板（沟通/边界/拒绝/谈判）  \n   126→\n   127→### 2.4 语言风格（表达层）\n   128→\n   129→`persona_style`：\n   130→- `standard`：清晰、中性、专业\n   131→- `warm`：共情、支持性（默认）\n   132→- `roast`：轻毒舌但不羞辱、不做人身定性\n   133→\n   134→---\n   135→\n   136→## 3. Chat Agent（GLM）设计\n   137→\n   138→### 3.1 “后端专业分析”到“教练表达”的翻译规则\n   139→\n   140→后端产出两类输入给 LLM：\n   141→- `facts`：确定性事实（八字计算、用户偏好、计划进度、历史反馈）\n   142→- `evidence`：证据（规则 ID + 知识库引用 + `facts_hash`）\n   143→\n   144→LLM 只做三件事：\n   145→1) 共情承接（积极心理学）\n   146→2) 结构化解释（把问题拆成可控/不可控/需澄清）\n   147→3) 生成行动处方 + 承诺邀请（≤3 条处方）\n   148→\n   149→LLM 禁止做：\n   150→- 自行推断八字事实、编造经典出处、输出确定性宿命论断言\n   151→\n   152→### 3.2 统一对话结构（6 步）\n   153→\n   154→1) 情绪确认  \n   155→2) 结构解释（导航）  \n   156→3) 行动处方（≤3）  \n   157→4) 时间窗口（默认干预窗口）  \n   158→5) 风险边界（医疗/法律/投资等）  \n   159→6) 承诺邀请（Commitment）  \n   160→\n   161→### 3.3 GLM 接入方式（Z.AI OpenAI-compat）\n   162→\n   163→配置来源：`/home/aiscend/work/docs/apikey.md`\n   164→\n   165→**必须环境变量（不在文档中写明密钥值）**\n   166→- `GLM_BASE_URL=https://api.z.ai/api/paas/v4`\n   167→- `GLM_API_KEY=$ZAI_GLM_KEY`\n   168→- `FORTUNE_AI_GLM_MODEL=glm-4.7`\n   169→- `FORTUNE_AI_GLM_THINKING=disabled`（`enabled|disabled`）\n   170→\n   171→**请求协议（Chat Completions）**\n   172→- `POST ${GLM_BASE_URL}/chat/completions`\n   173→- Header：\n   174→  - `Content-Type: application/json`\n   175→  - `Authorization: Bearer ${GLM_API_KEY}`\n   176→- Body：`model`, `messages`, `max_tokens`, `temperature`, `thinking.type`, `stream`\n   177→\n   178→**请求示例（非流式）**\n   179→\n   180→```bash\n   181→curl -sS \"$GLM_BASE_URL/chat/completions\" \\\n   182→  -H \"Content-Type: application/json\" \\\n   183→  -H \"Authorization: Bearer $GLM_API_KEY\" \\\n   184→  -d '{\n   185→    \"model\": \"'\"$FORTUNE_AI_GLM_MODEL\"'\",\n   186→    \"max_tokens\": 1200,\n   187→    \"temperature\": 0.6,\n   188→    \"stream\": false,\n   189→    \"thinking\": {\"type\":\"disabled\"},\n   190→    \"messages\": [\n   191→      {\"role\":\"system\",\"content\":\"你是 Fortune AI 的 Performance Coach。请严格仅输出 A2UI JSON（不要代码块/不要多余文本）。\"},\n   192→      {\"role\":\"user\",\"content\":\"我最近很焦虑，工作要不要换？\"}\n   193→    ]\n   194→  }'\n   195→```\n   196→\n   197→**注意**\n   198→- 若设置 `thinking.type=enabled`，Z.AI 可能仅返回 `reasoning_content` 且 `content` 为空。\n   199→- 后端会在检测到 `content` 为空时自动降级重试（`thinking=disabled`）以保证有可展示输出。\n   200→\n   201→**输出格式要求（强制）**\n   202→- 返回 **A2UI JSON**，首组件必须为 `markdown_text`，确保前端可渲染。\n   203→\n   204→### 3.4 GLM System Prompt（最终模板，直接用于实现）\n   205→\n   206→> 目标：把“命理/知识库/规则”的专业分析，翻译成“积极心理学/绩效教练”的行动闭环输出；并强制结构化与可追溯。\n   207→\n   208→```text\n   209→你是 Fortune AI 的对话 Agent，角色是积极心理学教练（Performance Coach）。\n   210→\n   211→【产品定位】\n   212→人生导航 / 陪伴 / 提升。系统和交互保持“有效而极简”。\n   213→\n   214→【你的优先级（不可逆）】\n   215→Coach > Teaching Assistant > Customer Support > Sales\n   216→\n   217→【硬性规则（必须遵守）】\n   218→1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接“你可以做什么”的行动处方。\n   219→2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。\n   220→3) 每次输出必须包含：结论(conclusion) + 依据(why) + ≤3条处方(prescriptions) + 承诺邀请(commitment_ask)。\n   221→4) 时间窗口默认只给干预窗口（intervention）；forecast 只能条件句+低置信度。\n   222→5) 输出必须是 A2UI JSON，且第一组件必须是 markdown_text。\n   223→6) 必须给出可点击 actions（start_task / schedule_task / open_panel / opt_out）。\n   224→\n   225→【语言风格 persona_style】\n   226→standard：清晰、中性、专业\n   227→warm：共情、支持性（默认）\n   228→roast：轻毒舌但不羞辱、不对人格做负面定性\n   229→\n   230→【输入】\n   231→- persona_style 取值：standard / warm / roast\n   232→- user_context：用户基础信息与偏好（来自 PostgreSQL）\n   233→- facts：八字确定性事实 + 计划进度 + 历史反馈（来自 PostgreSQL）\n   234→- evidence：rule_ids + kb_refs + facts_hash（来自 PostgreSQL）\n   235→- user_message：用户本轮输入（来自对话）\n   236→\n   237→【输出（A2UI JSON）】\n   238→- meta.summary：一句话摘要\n   239→- ui_components[0]：markdown_text（必须，包含：结论要点/依据/处方/时间窗口/边界/承诺邀请）\n   240→- ui_components[1]：action_buttons（必须，包含：开始行动/加入计划/查看Bento等按钮）\n   241→```\n   242→\n   243→---\n   244→\n   245→## 4. 交付契约（Guidance Card + A2UI）\n   246→\n   247→### 4.1 Guidance Card（服务端 SSOT）\n   248→\n   249→```json\n   250→{\n   251→  \"card_id\": \"b3a28c14-7a04-4b6c-8a37-8f4b0bb4c0f3\",\n   252→  \"type\": \"daily_guidance\",\n   253→  \"conclusion\": \"≤50字结论\",\n   254→  \"why\": \"依据（用心理学/教练语言重构）\",\n   255→  \"prescriptions\": [\n   256→    {\"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\", \"content\": \"行动1\", \"estimated_minutes\": 5},\n   257→    {\"task_id\": \"d1d6b1f3-1c1a-4d0f-9a64-2e4a91bfe5d2\", \"content\": \"行动2\", \"estimated_minutes\": 10}\n   258→  ],\n   259→  \"time_window\": {\n   260→    \"type\": \"intervention\",\n   261→    \"value\": \"7天试行\",\n   262→    \"confidence\": \"high\",\n   263→    \"checkpoint_date\": \"2026-01-05\"\n   264→  },\n   265→  \"risk_boundary\": \"不替代医疗/法律/投资建议\",\n   266→  \"commitment_ask\": \"你愿意先做哪一个？\",\n   267→  \"actions\": [\n   268→    {\"type\": \"start_task\", \"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\", \"label\": \"开始行动1\"},\n   269→    {\"type\": \"schedule_task\", \"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\", \"label\": \"加入今日计划\"}\n   270→  ],\n   271→  \"evidence\": {\n   272→    \"plugin\": \"bazi\",\n   273→    \"rule_ids\": [\"RULE-TS-001\", \"RULE-PATTERN-004\"],\n   274→    \"kb_refs\": [\"kb:doc:2:page:45:chunk:3\"],\n   275→    \"facts_hash\": \"sha256:3b9e8b9a1ad0b2f92b2d4e8c5a2d9b4c1f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c\"\n   276→  },\n   277→  \"created_at\": \"2025-12-29T10:00:00Z\"\n   278→}\n   279→```\n   280→\n   281→### 4.2 A2UI（前端渲染）\n   282→\n   283→```json\n   284→{\n   285→  \"meta\": {\"summary\": \"一句话摘要\"},\n   286→  \"ui_components\": [\n   287→    {\"type\": \"markdown_text\", \"title\": \"输出\", \"data\": \"### 结论要点\\n- 你现在的焦虑主要来自不确定性与信息过载。\\n\\n### 行动处方（≤3条）\\n1) 用决策模板写清选项/约束（10分钟）\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\n3) 情绪峰值先做3分钟降噪再决策\\n\\n### 承诺\\n你愿意先做哪一个？\"},\n   288→    {\"type\": \"action_buttons\", \"title\": \"下一步\", \"data\": [{\"label\": \"开始行动1\", \"action\": {\"type\": \"start_task\", \"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\"}}]}\n   289→  ]\n   290→}\n   291→```\n   292→\n   293→---\n   294→\n   295→## 5. 后端架构（数学脑 / 知识脑 / 语言脑）\n   296→\n   297→```\n   298→Client (/main)\n   299→  → API (FastAPI)\n   300→      → [数学脑] 八字确定性计算（facts + facts_hash）\n   301→      → [知识脑] PostgreSQL FTS 检索知识库（kb_refs）\n   302→      → [语言脑] GLM 生成 A2UI + Guidance Card\n   303→      → PostgreSQL SSOT（用户/会话/计划/承诺/反馈/推送/知识库）\n   304→```\n   305→\n   306→### 5.1 数学脑：八字确定性计算（真太阳时，直接实现）\n   307→\n   308→**输入（来自用户 Profile）**\n   309→- `birthday_local`: `YYYY-MM-DD HH:MM:SS`（用户当地标准时间）\n   310→- `tz_offset_hours`: 例如 `8.0`\n   311→- `location`: `{ \"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042 }`\n   312→\n   313→**真太阳时校正（用于时柱/跨日边界）**\n   314→\n   315→1) 时区中央经线：`tz_meridian_deg = tz_offset_hours * 15`\n   316→2) 经度校正（分钟）：`lon_corr_min = (longitude - tz_meridian_deg) * 4`\n   317→3) 均时差（Equation of Time，分钟）：\n   318→   - `birthday_utc = birthday_local - tz_offset_hours`\n   319→   - `jd_ut = swisseph.julday(birthday_utc.year, birthday_utc.month, birthday_utc.day, hour_decimal_utc)`\n   320→   - `e_days = swisseph.time_equ(jd_ut)`（返回“真太阳时 - 平太阳时”，单位天）\n   321→   - `eot_min = e_days * 1440`\n   322→4) 真太阳时（本地）：`true_solar_time_local = birthday_local + lon_corr_min + eot_min`\n   323→\n   324→**排盘（lunar_python）**\n   325→\n   326→以 `true_solar_time_local` 为排盘时间：\n   327→- `Solar.fromYmdHms(Y,M,D,hh,mm,ss) -> Lunar -> EightChar`\n   328→- 四柱：\n   329→  - `EightChar.getYear()/getMonth()/getDay()/getTime()`\n   330→- 十神（天干 + 地支）：\n   331→  - `getYearShiShenGan/getMonthShiShenGan/getDayShiShenGan/getTimeShiShenGan`\n   332→  - `getYearShiShenZhi/getMonthShiShenZhi/getDayShiShenZhi/getTimeShiShenZhi`\n   333→- 纳音：`getYearNaYin/getMonthNaYin/getDayNaYin/getTimeNaYin`\n   334→- 地势：`getYearDiShi/getMonthDiShi/getDayDiShi/getTimeDiShi`\n   335→- 大运/流年：\n   336→  - `yun = EightChar.getYun(gender_code)`（`男=1`，`女=0`）\n   337→  - `da_yun_list = yun.getDaYun(10)`（取 10 步大运；过滤 `getGanZhi()==''` 的条目）\n   338→  - 每步大运：`getStartAge/getEndAge/getStartYear/getEndYear/getGanZhi/getXun/getXunKong`\n   339→  - 流年：`DaYun.getLiuNian()`（取当年与未来 5 年用于 MVP）\n   340→\n   341→### 5.2 `facts`（LLM 唯一事实输入，固定字段）\n   342→\n   343→`facts` 写入 `fortune_bazi_snapshot.facts`，并作为 GLM 生成的唯一事实来源。\n   344→\n   345→示例（北京，1990-05-12 14:00，男）：\n   346→\n   347→```json\n   348→{\n   349→  \"profile\": {\n   350→    \"name\": \"张三\",\n   351→    \"gender\": \"男\",\n   352→    \"birthday_local\": \"1990-05-12 14:00:00\",\n   353→    \"tz_offset_hours\": 8.0,\n   354→    \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n   355→  },\n   356→  \"solar_time\": {\n   357→    \"tz_meridian_deg\": 120.0,\n   358→    \"lon_corr_min\": -14.3704,\n   359→    \"eot_min\": 3.6845,\n   360→    \"true_solar_time_local\": \"1990-05-12 13:49:19\"\n   361→  },\n   362→  \"bazi\": {\n   363→    \"pillars\": {\"year\": \"庚午\", \"month\": \"辛巳\", \"day\": \"丁丑\", \"hour\": \"丁未\"},\n   364→    \"day_master\": {\"gan\": \"丁\", \"element\": \"火\"},\n   365→    \"wuxing_count\": {\"金\": 2, \"木\": 0, \"水\": 0, \"火\": 4, \"土\": 2},\n   366→    \"shi_shen_gan\": {\"year\": \"正财\", \"month\": \"偏财\", \"day\": \"日主\", \"hour\": \"比肩\"},\n   367→    \"shi_shen_zhi\": {\n   368→      \"year\": [\"比肩\", \"食神\"],\n   369→      \"month\": [\"劫财\", \"正财\", \"伤官\"],\n   370→      \"day\": [\"食神\", \"七杀\", \"偏财\"],\n   371→      \"hour\": [\"食神\", \"比肩\", \"偏印\"]\n   372→    },\n   373→    \"na_yin\": {\"year\": \"路旁土\", \"month\": \"白蜡金\", \"day\": \"涧下水\", \"hour\": \"天河水\"},\n   374→    \"di_shi\": {\"year\": \"临官\", \"month\": \"帝旺\", \"day\": \"墓\", \"hour\": \"冠带\"},\n   375→    \"luck\": {\n   376→      \"forward\": true,\n   377→      \"start_age_year\": 8,\n   378→      \"da_yun\": [\n   379→        {\"index\": 1, \"start_age\": 9, \"end_age\": 18, \"start_year\": 1998, \"end_year\": 2007, \"gan_zhi\": \"壬午\", \"xun\": \"甲申\", \"xun_kong\": \"戌亥\"},\n   380→        {\"index\": 2, \"start_age\": 19, \"end_age\": 28, \"start_year\": 2008, \"end_year\": 2017, \"gan_zhi\": \"癸未\", \"xun\": \"乙酉\", \"xun_kong\": \"戌亥\"}\n   381→      ],\n   382→      \"liu_nian_next5\": [\n   383→        {\"year\": 2026, \"gan_zhi\": \"丙午\"},\n   384→        {\"year\": 2027, \"gan_zhi\": \"丁未\"},\n   385→        {\"year\": 2028, \"gan_zhi\": \"戊申\"},\n   386→        {\"year\": 2029, \"gan_zhi\": \"己酉\"},\n   387→        {\"year\": 2030, \"gan_zhi\": \"庚戌\"}\n   388→      ]\n   389→    },\n   390→    \"shensha\": [\n   391→      {\"name\": \"桃花\", \"hit\": true, \"note\": \"以日支/年支推咸池\"},\n   392→      {\"name\": \"驿马\", \"hit\": false, \"note\": \"以日支/年支推驿马\"},\n   393→      {\"name\": \"天乙贵人\", \"hit\": true, \"note\": \"以日干推贵人\"}\n   394→    ]\n   395→  },\n   396→  \"version\": {\n   397→    \"compute_version\": \"bazi-tts-v1\",\n   398→    \"facts_hash\": \"sha256:9a59e0f36b8f4c8b0b0e0e7b1c3c0d9610e14aa0f0e2d1d6b1f31c1a4d0f9a64\"\n   399→  }\n   400→}\n   401→```\n   402→\n   403→### 5.3 旺衰与喜用（MVP 确定性算法，输出可解释）\n   404→\n   405→**日主五行映射（按日干）**\n   406→- 甲乙=木；丙丁=火；戊己=土；庚辛=金；壬癸=水\n   407→\n   408→**月令季节五行（按月支）**\n   409→- 寅卯辰=木（春）；巳午未=火（夏）；申酉戌=金（秋）；亥子丑=水（冬）\n   410→\n   411→**强弱评分（score）**\n   412→- `support = count(day_master) + count(generator_of_day_master)`\n   413→- `drain = count(produced_by_day_master) + count(controller_of_day_master)`\n   414→- `score = support - drain + season_bonus`\n   415→- `season_bonus`：\n   416→  - 月令同五行：`+2`\n   417→  - 月令生日主：`+1`\n   418→  - 月令克日主：`-1`\n   419→  - 月令被日主克：`-1`\n   420→\n   421→**判定**\n   422→- `score >= 2` → `strong`\n   423→- `score <= -2` → `weak`\n   424→- 其余 → `neutral`\n   425→\n   426→**喜用输出**\n   427→- `weak`：喜 `日主五行 + 生扶五行`\n   428→- `strong`：喜 `泄耗五行 + 财五行 + 官杀五行`\n   429→- `neutral`：优先补“最少的五行”\n   430→\n   431→### 5.4 神煞（MVP 固定计算范围与规则）\n   432→\n   433→固定计算：`桃花(咸池)`、`驿马`、`华盖`、`天乙贵人`、`文昌`\n   434→\n   435→**三合局分组（以年支/日支所属局为准）**\n   436→- 申子辰局 → 桃花=酉，驿马=寅，华盖=辰\n   437→- 亥卯未局 → 桃花=子，驿马=巳，华盖=未\n   438→- 寅午戌局 → 桃花=卯，驿马=申，华盖=戌\n   439→- 巳酉丑局 → 桃花=午，驿马=亥，华盖=丑\n   440→\n   441→**天乙贵人（按日干）**\n   442→- 甲/戊/庚：丑、未\n   443→- 乙/己：子、申\n   444→- 丙/丁：亥、酉\n   445→- 辛：寅、午\n   446→- 壬/癸：卯、巳\n   447→\n   448→**文昌（按日干）**\n   449→- 甲乙：巳、午\n   450→- 丙丁：申、酉\n   451→- 戊己：申、酉\n   452→- 庚辛：亥、子\n   453→- 壬癸：寅、卯\n   454→\n   455→命中判定：若四柱地支出现对应地支，则 `hit=true`。\n   456→\n   457→---\n   458→\n   459→## 6. 数据库设计（PostgreSQL / DB=fortune_ai，全部可执行）\n   460→\n   461→> 说明：本节为最终 schema（不使用任何其他数据库）。连接凭据参考 `docs/apikey.md`，将 DB 名替换为 `fortune_ai`。\n   462→\n   463→**决策（回答 DB 名称冲突）**\n   464→- 在同一 PostgreSQL 实例中新建数据库 `fortune_ai`，Fortune AI 所有业务表只创建在该库内。\n   465→- 深度报告支持 `backend=cli|gemini`：`gemini` 数据库保持原样，仅在 `backend=gemini` 时作为报告引擎的 job/task 存储（读写 `gemini_job/gemini_task`）；`backend=cli` 通过 `cli_worker` 的执行链路提交与轮询（不访问 `gemini` DB）。\n   466→\n   467→**运行时连接（必须）**\n   468→- Fortune AI 业务库（DB=fortune_ai）：使用 `FORTUNE_DB_HOST/FORTUNE_DB_PORT/FORTUNE_DB_NAME/FORTUNE_DB_USER/FORTUNE_DB_PASSWORD`（与现有代码一致，`FORTUNE_DB_NAME=fortune_ai`）；也可用单一连接串 `FORTUNE_AI_DB_URL`（libpq URL 形式）。\n   469→- `backend=gemini`：Gemini 报告服务库使用 `.env.example` 同名变量 `GEMINI_DB_HOST/GEMINI_DB_PORT/GEMINI_DB_NAME/GEMINI_DB_USER/GEMINI_DB_PASSWORD` 连接 `gemini`；**仅** `integrations/gemini_repo.py`（以及其依赖的 gemini_tool）允许访问该库，用于创建与轮询 `gemini_job/gemini_task`。\n   470→- `backend=cli`：CLI Worker 使用 `CLI_WORKER_DB_URL`（或本地 sqlite fallback）查询任务状态；任务提交通过 `cli_worker` 项目接口执行（由 `integrations/cli_worker_repo.py` 封装）。\n   471→\n   472→### 6.1 初始化（数据库与扩展）\n   473→\n   474→```sql\n   475→CREATE DATABASE fortune_ai;\n   476→\n   477→\\\\c fortune_ai;\n   478→\n   479→CREATE EXTENSION IF NOT EXISTS pgcrypto;\n   480→CREATE EXTENSION IF NOT EXISTS pg_trgm;\n   481→```\n   482→\n   483→### 6.2 用户与偏好\n   484→\n   485→```sql\n   486→CREATE TABLE IF NOT EXISTS fortune_user (\n   487→  user_id BIGSERIAL PRIMARY KEY,\n   488→  email TEXT NOT NULL,\n   489→  password_hash TEXT NOT NULL,          -- bcrypt\n   490→  name TEXT NOT NULL,                   -- 昵称/显示名\n   491→  gender TEXT NOT NULL CHECK (gender IN ('男','女')),\n   492→  birthday_local TIMESTAMP NOT NULL,    -- 用户当地标准时间（不含时区）\n   493→  birthday_utc TIMESTAMPTZ NOT NULL,    -- 统一存 UTC 时间（由 birthday_local + tz_offset_hours 推导）\n   494→  tz_offset_hours NUMERIC(4,1) NOT NULL DEFAULT 8.0,\n   495→  location JSONB NOT NULL,              -- {name, longitude, latitude}\n   496→  bazi_digest TEXT,\n   497→  last_login_at TIMESTAMPTZ,\n   498→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   499→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   500→  deleted_at TIMESTAMPTZ\n   501→);\n   502→CREATE UNIQUE INDEX IF NOT EXISTS idx_fortune_user_email_lower ON fortune_user ((lower(email))) WHERE deleted_at IS NULL;\n   503→CREATE INDEX IF NOT EXISTS idx_fortune_user_name ON fortune_user (name) WHERE deleted_at IS NULL;\n   504→\n   505→CREATE TABLE IF NOT EXISTS fortune_user_preferences (\n   506→  user_id BIGINT PRIMARY KEY REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   507→  persona_style TEXT NOT NULL DEFAULT 'warm' CHECK (persona_style IN ('standard','warm','roast')),\n   508→  push_enabled BOOLEAN NOT NULL DEFAULT TRUE,\n   509→  push_time TIME NOT NULL DEFAULT '08:00:00',\n   510→  push_timezone TEXT NOT NULL DEFAULT 'Asia/Shanghai',\n   511→  quiet_hours_start TIME NOT NULL DEFAULT '22:00:00',\n   512→  quiet_hours_end TIME NOT NULL DEFAULT '07:00:00',\n   513→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   514→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   515→);\n   516→\n   517→CREATE TABLE IF NOT EXISTS fortune_user_session (\n   518→  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   519→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   520→  token_hash TEXT NOT NULL,             -- sha256(base64url_token)\n   521→  csrf_token_hash TEXT NOT NULL,        -- sha256(csrf_token)\n   522→  ip TEXT NOT NULL DEFAULT '',\n   523→  user_agent TEXT NOT NULL DEFAULT '',\n   524→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   525→  expires_at TIMESTAMPTZ NOT NULL,      -- now() + interval '30 days'\n   526→  revoked_at TIMESTAMPTZ\n   527→);\n   528→CREATE UNIQUE INDEX IF NOT EXISTS idx_user_session_token_hash ON fortune_user_session (token_hash);\n   529→CREATE INDEX IF NOT EXISTS idx_user_session_user_active ON fortune_user_session (user_id, expires_at DESC) WHERE revoked_at IS NULL;\n   530→```\n   531→\n   532→### 6.3 会话与消息（SSOT，不落本地文件）\n   533→\n   534→```sql\n   535→CREATE TABLE IF NOT EXISTS fortune_conversation_session (\n   536→  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   537→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   538→  title TEXT NOT NULL DEFAULT '',\n   539→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   540→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   541→);\n   542→CREATE INDEX IF NOT EXISTS idx_conv_session_user_updated ON fortune_conversation_session (user_id, updated_at DESC);\n   543→\n   544→CREATE TABLE IF NOT EXISTS fortune_conversation_message (\n   545→  message_id BIGSERIAL PRIMARY KEY,\n   546→  session_id UUID NOT NULL REFERENCES fortune_conversation_session(session_id) ON DELETE CASCADE,\n   547→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   548→  role TEXT NOT NULL CHECK (role IN ('user','assistant','system')),\n   549→  content TEXT NOT NULL,\n   550→  a2ui JSONB,                            -- assistant 输出（可空）\n   551→  model TEXT NOT NULL,\n   552→  prompt_tokens INTEGER NOT NULL DEFAULT 0,\n   553→  completion_tokens INTEGER NOT NULL DEFAULT 0,\n   554→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   555→);\n   556→CREATE INDEX IF NOT EXISTS idx_conv_msg_session_time ON fortune_conversation_message (session_id, created_at);\n   557→```\n   558→\n   559→### 6.4 八字事实快照（可追溯一致性）\n   560→\n   561→```sql\n   562→CREATE TABLE IF NOT EXISTS fortune_bazi_snapshot (\n   563→  snapshot_id BIGSERIAL PRIMARY KEY,\n   564→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   565→  compute_version TEXT NOT NULL,\n   566→  facts JSONB NOT NULL,\n   567→  facts_hash TEXT NOT NULL,\n   568→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   569→  UNIQUE (user_id, compute_version, facts_hash)\n   570→);\n   571→CREATE INDEX IF NOT EXISTS idx_bazi_snapshot_user_time ON fortune_bazi_snapshot (user_id, created_at DESC);\n   572→```\n   573→\n   574→### 6.5 承诺与行动（闭环核心）\n   575→\n   576→```sql\n   577→CREATE TABLE IF NOT EXISTS fortune_commitment (\n   578→  task_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   579→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   580→  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,\n   581→  card_id UUID,                         -- 生成该建议的交付卡 ID（可空）\n   582→  source TEXT NOT NULL CHECK (source IN ('chat','bento','push')),\n   583→  commitment_type TEXT NOT NULL CHECK (commitment_type IN ('start_task','schedule_task','ask_followup','opt_out')),\n   584→  title TEXT NOT NULL,\n   585→  details JSONB NOT NULL DEFAULT '{}'::jsonb,\n   586→  status TEXT NOT NULL DEFAULT 'suggested' CHECK (status IN ('suggested','active','done','skipped','canceled')),\n   587→  accepted_at TIMESTAMPTZ,              -- 用户确认承诺的时间（commitment_made 以此判定）\n   588→  due_at TIMESTAMPTZ,\n   589→  done_at TIMESTAMPTZ,\n   590→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   591→);\n   592→CREATE INDEX IF NOT EXISTS idx_commitment_user_status ON fortune_commitment (user_id, status, created_at DESC);\n   593→```\n   594→\n   595→### 6.6 情绪打卡与复盘（反馈闭环）\n   596→\n   597→```sql\n   598→CREATE TABLE IF NOT EXISTS fortune_checkin (\n   599→  checkin_id BIGSERIAL PRIMARY KEY,\n   600→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   601→  mood TEXT NOT NULL,                    -- 例：焦虑/低落/平静/兴奋\n   602→  intensity INTEGER NOT NULL CHECK (intensity BETWEEN 0 AND 10),\n   603→  note TEXT NOT NULL DEFAULT '',\n   604→  recommended_action TEXT NOT NULL,      -- 系统给出的 1 个动作（可执行）\n   605→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   606→);\n   607→CREATE INDEX IF NOT EXISTS idx_checkin_user_time ON fortune_checkin (user_id, created_at DESC);\n   608→\n   609→CREATE TABLE IF NOT EXISTS fortune_reflection (\n   610→  reflection_id BIGSERIAL PRIMARY KEY,\n   611→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   612→  period TEXT NOT NULL CHECK (period IN ('daily','weekly')),\n   613→  reflection_date DATE NOT NULL,\n   614→  input JSONB NOT NULL,                 -- 用户回答（结构化）\n   615→  output_card JSONB NOT NULL,           -- Guidance Card\n   616→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   617→  UNIQUE (user_id, period, reflection_date)\n   618→);\n   619→```\n   620→\n   621→### 6.7 成长计划（4 个预设 + 用户进度）\n   622→\n   623→```sql\n   624→CREATE TABLE IF NOT EXISTS fortune_plan (\n   625→  plan_id TEXT PRIMARY KEY,\n   626→  name TEXT NOT NULL,\n   627→  duration_days INTEGER NOT NULL CHECK (duration_days > 0),\n   628→  theory TEXT NOT NULL,\n   629→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   630→);\n   631→\n   632→CREATE TABLE IF NOT EXISTS fortune_plan_day (\n   633→  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE CASCADE,\n   634→  day_no INTEGER NOT NULL CHECK (day_no > 0),\n   635→  title TEXT NOT NULL,\n   636→  instruction TEXT NOT NULL,\n   637→  PRIMARY KEY (plan_id, day_no)\n   638→);\n   639→\n   640→CREATE TABLE IF NOT EXISTS fortune_plan_enrollment (\n   641→  enrollment_id BIGSERIAL PRIMARY KEY,\n   642→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   643→  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE RESTRICT,\n   644→  start_date DATE NOT NULL,\n   645→  current_day INTEGER NOT NULL DEFAULT 1,\n   646→  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','paused','completed','abandoned')),\n   647→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   648→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   649→  UNIQUE (user_id, plan_id, start_date)\n   650→);\n   651→CREATE INDEX IF NOT EXISTS idx_plan_enroll_user_status ON fortune_plan_enrollment (user_id, status, updated_at DESC);\n   652→\n   653→CREATE TABLE IF NOT EXISTS fortune_plan_record (\n   654→  record_id BIGSERIAL PRIMARY KEY,\n   655→  enrollment_id BIGINT NOT NULL REFERENCES fortune_plan_enrollment(enrollment_id) ON DELETE CASCADE,\n   656→  day_no INTEGER NOT NULL,\n   657→  completed BOOLEAN NOT NULL DEFAULT FALSE,\n   658→  note TEXT NOT NULL DEFAULT '',\n   659→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   660→  UNIQUE (enrollment_id, day_no)\n   661→);\n   662→```\n   663→\n   664→**预设计划固定为 4 个（开箱即用，写入 DB）**\n   665→\n   666→```sql\n   667→INSERT INTO fortune_plan (plan_id, name, duration_days, theory) VALUES\n   668→  ('gratitude_21', '21天感恩练习', 21, '积极心理学'),\n   669→  ('mindfulness_7', '7天正念入门', 7, '正念冥想'),\n   670→  ('habit_30', '30天习惯养成挑战', 30, '行为科学/原子习惯'),\n   671→  ('strength_14', '14天优势发现之旅', 14, 'VIA优势理论')\n   672→ON CONFLICT (plan_id) DO NOTHING;\n   673→```\n   674→\n   675→**预设计划任务（`fortune_plan_day`，固定内容，直接写入 DB）**\n   676→\n   677→```sql\n   678→-- 21天感恩练习\n   679→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n   680→('gratitude_21', 1, '启动：三件好事', '写下今天发生的3件值得感恩/欣赏的小事；每件用1句话写清“发生了什么”和“我为什么感激”。'),\n   681→('gratitude_21', 2, '细化：把好事写具体', '从昨天的3件好事里任选1件，补充3个细节（人/地点/动作/感受），让它更可回忆。'),\n   682→('gratitude_21', 3, '人际：感谢一个人', '给一个人发一条感谢信息（不需长），明确说出：对方做了什么→对你产生了什么影响。'),\n   683→('gratitude_21', 4, '逆境：找出一个转折', '回想最近一个不顺，写下：最难的点是什么？我从中学到的一件事是什么？'),\n   684→('gratitude_21', 5, '身体：感谢身体', '写下今天身体为你做好的3件事（例如呼吸、走路、恢复），并做一次1分钟伸展。'),\n   685→('gratitude_21', 6, '环境：感谢一处空间', '选一个你常待的空间（工位/卧室），写下它带给你的1个好处，并整理1个小角落。'),\n   686→('gratitude_21', 7, '一周复盘：我更容易看见什么', '写下这一周你更容易注意到的“好”是什么（人/事/能力/资源），以及下周你想继续强化的1点。'),\n   687→('gratitude_21', 8, '行为：把感谢变成行动', '选择一个你感激的人或资源，做一个5分钟的小行动来回馈（例如主动帮一次忙）。'),\n   688→('gratitude_21', 9, '优势：感谢自己的一个优点', '写下你最近做对的一件事，并标注它体现了你哪种能力/品质（例如专注、勇气、耐心）。'),\n   689→('gratitude_21', 10, '情绪：感谢一次情绪提醒', '回想今天一次负面情绪，写下：它提醒了我什么需求？我能用一个健康方式满足它是什么？'),\n   690→('gratitude_21', 11, '关系：修复一个小摩擦', '选择一个小摩擦场景，写下你能做的一个小修复动作（例如道歉、解释、感谢）。'),\n   691→('gratitude_21', 12, '时间：感谢一次坚持', '写下你最近坚持了3天以上的一件事，并说明它让你得到的一个好处。'),\n   692→('gratitude_21', 13, '工作：感谢一个机会', '写下你当前工作/学习里一个可利用的机会或资源，并写下你明天会做的一个最小利用动作。'),\n   693→('gratitude_21', 14, '两周复盘：我的变化', '用0-10分给“情绪稳定/行动一致/关系满意”各打分，并写下各自提升/下降的原因。'),\n   694→('gratitude_21', 15, '表达：把感谢说出口', '当面或语音对一个人表达感谢（30秒即可）：具体行为→影响→你的感受。'),\n   695→('gratitude_21', 16, '愿景：感谢未来的自己', '写一段给30天后的自己的话：你希望他/她保持什么？你感谢他/她会做到什么？'),\n   696→('gratitude_21', 17, '学习：感谢一次输入', '选一段你今天学到的内容（文章/视频/对话），写下1句可执行的收获（明天怎么用）。'),\n   697→('gratitude_21', 18, '金钱：感谢一笔支出', '挑一笔你最近的支出，写下它解决了什么问题/带来了什么价值；避免自责式语言。'),\n   698→('gratitude_21', 19, '勇气：感谢一次不完美行动', '写下你做过的一次“虽然不完美但仍然去做”的行动；标注它体现的勇气。'),\n   699→('gratitude_21', 20, '整合：我的感谢清单', '把前19天里你最想保留的5条感谢整理成清单，并写下你将如何持续（每周一次）。'),\n   700→('gratitude_21', 21, '毕业：把感谢变成习惯', '写下：这21天最有效的一个做法；以及你未来4周的最小维持频率（例如每周3天）。')\n   701→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n   702→\n   703→-- 7天正念入门\n   704→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n   705→('mindfulness_7', 1, '呼吸锚点（3分钟）', '计时3分钟：只关注呼吸的进出；走神时温和拉回；结束后给自己一句鼓励。'),\n   706→('mindfulness_7', 2, '身体扫描（5分钟）', '从头到脚扫描身体感受；只描述“紧/松/热/冷”，不评判好坏。'),\n   707→('mindfulness_7', 3, '情绪命名（2分钟）', '当下情绪用一个词命名（例如焦虑/烦躁）；再用一句话描述它在身体的感觉。'),\n   708→('mindfulness_7', 4, '正念进食（5分钟）', '选一小口食物：观察颜色/气味/口感；放慢咀嚼；注意冲动与满足的变化。'),\n   709→('mindfulness_7', 5, '正念行走（5分钟）', '走5分钟：注意脚掌触地、身体重心移动；不听信息流。'),\n   710→('mindfulness_7', 6, '3分钟降噪协议', '遇到强情绪时执行：1分钟呼吸→1分钟身体感受→1分钟选择下一步（一个小动作）。'),\n   711→('mindfulness_7', 7, '毕业复盘', '写下：本周最有效的练习是哪一个？你准备在未来两周以什么频率继续？')\n   712→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n   713→\n   714→-- 30天习惯养成挑战\n   715→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n   716→('habit_30', 1, '定义一个最小习惯', '选择一个你想养成的习惯，把它缩小到“2分钟版本”（例如做5个俯卧撑/写50字）。'),\n   717→('habit_30', 2, '设置触发器', '为习惯选择一个固定触发器（起床后/刷牙后/下班到家后），写成一句话，例如：“当我刷牙后，我就做2分钟版本”。'),\n   718→('habit_30', 3, '准备环境', '把执行习惯需要的物品/环境准备好（例如把瑜伽垫放出来）；让开始成本≤30秒。'),\n   719→('habit_30', 4, '记录一次完成', '今天完成一次2分钟版本，并记录：我在什么时刻做的？完成后感觉如何（0-10）？'),\n   720→('habit_30', 5, '加入一个奖励', '为完成后加一个小奖励（1分钟伸展/一杯热水/听一首歌），强化闭环。'),\n   721→('habit_30', 6, '识别阻碍', '写下你今天最可能失败的原因（时间/情绪/环境），并给一个应对预案。'),\n   722→('habit_30', 7, '一周复盘', '统计本周完成天数；写下最有效的触发器与最大阻碍；调整一次触发器或时间。'),\n   723→('habit_30', 8, '提高可见性', '把习惯放到更可见的位置（便签/桌面/日历），让你更容易想起它。'),\n   724→('habit_30', 9, '缩短启动时间', '把“开始动作”进一步缩短（例如只做1个俯卧撑也算开始），确保今天不会零。'),\n   725→('habit_30', 10, '提高一致性', '把习惯固定到同一时间段；如果做不到，就固定“同一触发器”。'),\n   726→('habit_30', 11, '建立替代方案', '准备一个“低能量版本”（例如累时做30秒），保证情绪低谷也能完成。'),\n   727→('habit_30', 12, '消除一个摩擦', '找到一个让你不想做的摩擦点（准备麻烦/太远），今天把它消掉。'),\n   728→('habit_30', 13, '把习惯和身份绑定', '写一句身份宣言：我是谁→我会做什么（例如“我是重视健康的人，所以我每天动2分钟”）。'),\n   729→('habit_30', 14, '两周复盘', '统计14天完成率；写下你最常见的失败场景，并更新一个更现实的预案。'),\n   730→('habit_30', 15, '提升一点难度', '把2分钟版本提升10%-20%（仍然很小），例如从写50字到写60字。'),\n   731→('habit_30', 16, '让它更有趣', '给习惯加一点乐趣（音乐/计时挑战/打卡视觉化），让你更愿意开始。'),\n   732→('habit_30', 17, '建立“如果-那么”计划', '写下两条：如果我加班→那么我做低能量版本；如果我忘了→那么我睡前补一次。'),\n   733→('habit_30', 18, '加入社交承诺', '找一个朋友或对话里做一个承诺：我将坚持到第30天；并写下你希望被如何提醒。'),\n   734→('habit_30', 19, '连续3天挑战', '目标：连续3天不间断完成（允许低能量版本）。'),\n   735→('habit_30', 20, '复盘奖励机制', '写下奖励是否有效；如果无效，换一个更适合你的奖励（不靠刷短视频）。'),\n   736→('habit_30', 21, '三周复盘', '统计21天完成率；写下你完成最多的时间段；把习惯固定到那个时间段。'),\n   737→('habit_30', 22, '减少自责', '写下：我失败时常说的自责句；把它改写成教练句（例如“下一次我做更小”）。'),\n   738→('habit_30', 23, '优化提醒', '设置一个具体提醒（闹钟/日历），并写上行动文案（不是“别忘了”，而是“现在做2分钟版本”）。'),\n   739→('habit_30', 24, '把习惯连到目标', '写下：这个习惯最终服务什么目标？它让你更接近目标的证据是什么？'),\n   740→('habit_30', 25, '应对突发', '假设明天有突发事件，写下你仍能完成的最小动作是什么，并承诺执行。'),\n   741→('habit_30', 26, '连续7天维护', '目标：连续7天都完成（允许低能量版本）；只追求“不断”。'),\n   742→('habit_30', 27, '整理成果', '写下本月你累计完成了多少次；你感觉最大的变化是什么（哪怕很小）。'),\n   743→('habit_30', 28, '建立复盘仪式', '选择一个每周固定的复盘时刻（例如周日20:00），写下你将检查的3个问题。'),\n   744→('habit_30', 29, '准备长期版本', '为下个月定义一个可持续版本（不比现在更难），并确定触发器与提醒方式。'),\n   745→('habit_30', 30, '毕业：写一封给自己的信', '写下：我靠什么坚持了30天？我下个月继续的最小频率是多少？')\n   746→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n   747→\n   748→-- 14天优势发现之旅\n   749→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n   750→('strength_14', 1, '列出5次高光时刻', '写下你过去1-2年里5次“做得很顺/很投入”的时刻；每次写清场景与结果。'),\n   751→('strength_14', 2, '提炼3个优势', '从高光时刻里提炼3个反复出现的优势（例如组织、表达、洞察、执行），并各写一句证据。'),\n   752→('strength_14', 3, '优势命名', '给每个优势起一个你喜欢的名字（更个人化），并写下它在你身上的表现。'),\n   753→('strength_14', 4, '优势应用：工作', '选择一个工作/学习任务，刻意用一个优势完成它；记录结果与感受。'),\n   754→('strength_14', 5, '优势应用：关系', '选择一个关系场景，用一个优势改善沟通（例如倾听/表达/边界），并记录反馈。'),\n   755→('strength_14', 6, '识别优势的阴影面', '为每个优势写下它的“过度使用”会带来的问题（例如过度负责、过度挑剔）。'),\n   756→('strength_14', 7, '一周复盘：优势最有用的时刻', '写下本周优势最有帮助的一次经历；以及下一周你想在哪个场景继续用它。'),\n   757→('strength_14', 8, '优势组合', '挑两个优势做组合：它们如何互补？写下一个你想尝试的组合行动。'),\n   758→('strength_14', 9, '优势补短', '选一个你经常卡住的弱项，写下用哪个优势可以“绕过去”（例如用结构化代替拖延）。'),\n   759→('strength_14', 10, '优势与目标对齐', '写下你当前一个目标；把它拆成3步，并标注每步使用哪个优势最省力。'),\n   760→('strength_14', 11, '请求支持', '找一个人描述你的一个优势，并请对方给一个你可以更好发挥的建议。'),\n   761→('strength_14', 12, '优势表达为价值', '写一段30秒自我介绍：我擅长什么→能为别人带来什么价值（避免空话）。'),\n   762→('strength_14', 13, '优势在压力下的使用', '回想一次压力情境，写下你可以如何用优势稳定自己，并设计一个下次的应对句。'),\n   763→('strength_14', 14, '毕业：优势使用计划', '写下未来4周你要刻意使用的1个优势；设定每周至少2次的应用场景。')\n   764→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n   765→```\n   766→\n   767→### 6.8 每日指引（今日卡 SSOT）\n   768→\n   769→```sql\n   770→CREATE TABLE IF NOT EXISTS fortune_daily_guidance (\n   771→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   772→  guidance_date DATE NOT NULL,\n   773→  card JSONB NOT NULL,                    -- Guidance Card\n   774→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   775→  PRIMARY KEY (user_id, guidance_date)\n   776→);\n   777→```\n   778→\n   779→### 6.9 推送调度与发送记录（可审计）\n   780→\n   781→```sql\n   782→CREATE TABLE IF NOT EXISTS fortune_push_event (\n   783→  push_id BIGSERIAL PRIMARY KEY,\n   784→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   785→  push_type TEXT NOT NULL CHECK (push_type IN ('plan_daily','weekly_reflection','milestone')),\n   786→  scheduled_at TIMESTAMPTZ NOT NULL,\n   787→  sent_at TIMESTAMPTZ,\n   788→  status TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled','sent','skipped','failed')),\n   789→  payload JSONB NOT NULL,\n   790→  error TEXT NOT NULL DEFAULT '',\n   791→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   792→);\n   793→CREATE INDEX IF NOT EXISTS idx_push_user_scheduled ON fortune_push_event (user_id, scheduled_at DESC);\n   794→```\n   795→\n   796→### 6.10 八字知识库（PDF 入库 → PostgreSQL 检索）\n   797→\n   798→```sql\n   799→CREATE TABLE IF NOT EXISTS bazi_kb_document (\n   800→  doc_id BIGSERIAL PRIMARY KEY,\n   801→  file_name TEXT NOT NULL,\n   802→  sha256 TEXT NOT NULL,\n   803→  title TEXT NOT NULL DEFAULT '',\n   804→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   805→  UNIQUE (sha256)\n   806→);\n   807→\n   808→CREATE TABLE IF NOT EXISTS bazi_kb_chunk (\n   809→  chunk_id BIGSERIAL PRIMARY KEY,\n   810→  doc_id BIGINT NOT NULL REFERENCES bazi_kb_document(doc_id) ON DELETE CASCADE,\n   811→  page_no INTEGER NOT NULL CHECK (page_no > 0),\n   812→  chunk_no INTEGER NOT NULL CHECK (chunk_no > 0),\n   813→  content TEXT NOT NULL,\n   814→  content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED,\n   815→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   816→  UNIQUE (doc_id, page_no, chunk_no)\n   817→);\n   818→CREATE INDEX IF NOT EXISTS idx_kb_chunk_tsv ON bazi_kb_chunk USING GIN (content_tsv);\n   819→CREATE INDEX IF NOT EXISTS idx_kb_chunk_trgm ON bazi_kb_chunk USING GIN (content gin_trgm_ops);\n   820→```\n   821→\n   822→检索（用于 Structured RAG）：\n   823→```sql\n   824→-- 关键词检索（FTS）\n   825→SELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,\n   826→       ts_rank(c.content_tsv, plainto_tsquery('simple', :q)) AS rank,\n   827→       c.content\n   828→FROM bazi_kb_chunk c\n   829→WHERE c.content_tsv @@ plainto_tsquery('simple', :q)\n   830→ORDER BY rank DESC\n   831→LIMIT 12;\n   832→\n   833→-- 中文场景补充：trgm 相似度\n   834→SELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,\n   835→       similarity(c.content, :q) AS sim,\n   836→       c.content\n   837→FROM bazi_kb_chunk c\n   838→WHERE c.content % :q\n   839→ORDER BY sim DESC\n   840→LIMIT 12;\n   841→```\n   842→\n   843→### 6.10.1 知识库入库流程（PDF → 文本 → chunk → PostgreSQL）\n   844→\n   845→**输入目录**\n   846→- `fortune_ai/knowledge/bazi/*.pdf`\n   847→\n   848→**依赖（Python）**\n   849→- `pypdf`（用于 PDF 文本抽取）\n   850→\n   851→**入库规则（固定）**\n   852→- `bazi_kb_document.sha256` 唯一，保证幂等：同一 PDF 重复导入不会产生重复文档。\n   853→- chunk 参数固定：\n   854→  - `chunk_size_chars = 800`\n   855→  - `chunk_overlap_chars = 120`\n   856→- `kb_ref` 统一格式：`kb:doc:{doc_id}:page:{page_no}:chunk:{chunk_no}`\n   857→\n   858→**入库步骤（脚本执行顺序）**\n   859→1) 遍历 PDF：计算文件 `sha256`，写入/复用 `bazi_kb_document`。\n   860→2) 逐页抽取文本：保留 `page_no`；清理多余空白与重复换行。\n   861→3) 分段切分：\n   862→   - 先按段落（空行）拆分\n   863→   - 再按字符数合并成 chunk（800 字），相邻 chunk 120 字重叠\n   864→4) 写入 `bazi_kb_chunk`（`doc_id + page_no + chunk_no` 唯一）\n   865→\n   866→### 6.11 规则库（`rule_ids` SSOT，可追溯）\n   867→\n   868→```sql\n   869→CREATE TABLE IF NOT EXISTS fortune_rule (\n   870→  rule_id TEXT PRIMARY KEY,\n   871→  category TEXT NOT NULL,\n   872→  name TEXT NOT NULL,\n   873→  body JSONB NOT NULL,\n   874→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   875→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n   876→);\n   877→CREATE INDEX IF NOT EXISTS idx_rule_category ON fortune_rule (category);\n   878→```\n   879→\n   880→写入 MVP 必备规则（与 §5.3/§5.4 保持一致）：\n   881→\n   882→```sql\n   883→INSERT INTO fortune_rule (rule_id, category, name, body) VALUES\n   884→('RULE-STRENGTH-SCORE-V1', 'bazi_strength', '旺衰评分算法', '{\n   885→  \"season_map\": {\"寅\":\"木\",\"卯\":\"木\",\"辰\":\"木\",\"巳\":\"火\",\"午\":\"火\",\"未\":\"火\",\"申\":\"金\",\"酉\":\"金\",\"戌\":\"金\",\"亥\":\"水\",\"子\":\"水\",\"丑\":\"水\"},\n   886→  \"day_master_map\": {\"甲\":\"木\",\"乙\":\"木\",\"丙\":\"火\",\"丁\":\"火\",\"戊\":\"土\",\"己\":\"土\",\"庚\":\"金\",\"辛\":\"金\",\"壬\":\"水\",\"癸\":\"水\"},\n   887→  \"threshold\": {\"strong\": 2, \"weak\": -2}\n   888→}'::jsonb),\n   889→('RULE-SHENSHA-TAOHUA-V1', 'bazi_shensha', '桃花（咸池）', '{\n   890→  \"group_map\": {\"申子辰\":\"酉\",\"亥卯未\":\"子\",\"寅午戌\":\"卯\",\"巳酉丑\":\"午\"},\n   891→  \"basis\": \"year_or_day_branch\"\n   892→}'::jsonb),\n   893→('RULE-SHENSHA-YIMA-V1', 'bazi_shensha', '驿马', '{\n   894→  \"group_map\": {\"申子辰\":\"寅\",\"亥卯未\":\"巳\",\"寅午戌\":\"申\",\"巳酉丑\":\"亥\"},\n   895→  \"basis\": \"year_or_day_branch\"\n   896→}'::jsonb),\n   897→('RULE-SHENSHA-HUAGAI-V1', 'bazi_shensha', '华盖', '{\n   898→  \"group_map\": {\"申子辰\":\"辰\",\"亥卯未\":\"未\",\"寅午戌\":\"戌\",\"巳酉丑\":\"丑\"},\n   899→  \"basis\": \"year_or_day_branch\"\n   900→}'::jsonb),\n   901→('RULE-SHENSHA-TIANYI-V1', 'bazi_shensha', '天乙贵人', '{\n   902→  \"day_gan_map\": {\"甲\":[\"丑\",\"未\"],\"戊\":[\"丑\",\"未\"],\"庚\":[\"丑\",\"未\"],\"乙\":[\"子\",\"申\"],\"己\":[\"子\",\"申\"],\"丙\":[\"亥\",\"酉\"],\"丁\":[\"亥\",\"酉\"],\"辛\":[\"寅\",\"午\"],\"壬\":[\"卯\",\"巳\"],\"癸\":[\"卯\",\"巳\"]}\n   903→}'::jsonb),\n   904→('RULE-SHENSHA-WENCHANG-V1', 'bazi_shensha', '文昌', '{\n   905→  \"day_gan_map\": {\"甲\":[\"巳\",\"午\"],\"乙\":[\"巳\",\"午\"],\"丙\":[\"申\",\"酉\"],\"丁\":[\"申\",\"酉\"],\"戊\":[\"申\",\"酉\"],\"己\":[\"申\",\"酉\"],\"庚\":[\"亥\",\"子\"],\"辛\":[\"亥\",\"子\"],\"壬\":[\"寅\",\"卯\"],\"癸\":[\"寅\",\"卯\"]}\n   906→}'::jsonb)\n   907→ON CONFLICT (rule_id) DO UPDATE SET\n   908→  category = EXCLUDED.category,\n   909→  name = EXCLUDED.name,\n   910→  body = EXCLUDED.body,\n   911→  updated_at = now();\n   912→```\n   913→\n   914→### 6.12 外部任务映射（报告 Job：backend=cli|gemini）\n   915→\n   916→目标：Fortune AI 的业务闭环与权限在 `fortune_ai` 库内完成；报告生成的执行与状态可来自 `backend=cli|gemini`，本表负责在两者之间建立“用户 ↔ provider_job_id”的可审计映射。\n   917→\n   918→```sql\n   919→CREATE TABLE IF NOT EXISTS fortune_external_job (\n   920→  id BIGSERIAL PRIMARY KEY,\n   921→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n   922→  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,\n   923→  provider TEXT NOT NULL CHECK (provider IN ('cli','gemini')),\n   924→  job_type TEXT NOT NULL CHECK (job_type IN ('bazi_report')),\n   925→  provider_job_id BIGINT NOT NULL,\n   926→  status TEXT NOT NULL CHECK (status IN ('processing','completed','error')),\n   927→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   928→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n   929→  last_polled_at TIMESTAMPTZ,\n   930→  output_url TEXT NOT NULL DEFAULT '',\n   931→  output_a2ui JSONB,\n   932→  error TEXT NOT NULL DEFAULT '',\n   933→  UNIQUE (provider, provider_job_id)\n   934→);\n   935→CREATE INDEX IF NOT EXISTS idx_external_job_user_time ON fortune_external_job (user_id, created_at DESC);\n   936→CREATE INDEX IF NOT EXISTS idx_external_job_status ON fortune_external_job (status, updated_at DESC);\n   937→```\n   938→\n   939→---\n   940→\n   941→## 7. API 设计（统一命名，直接实现）\n   942→\n   943→### 7.0 认证与通用约定（必须）\n   944→\n   945→**无游客模式**\n   946→- 只有以下接口不需要登录：\n   947→  - `POST /api/auth/register`\n   948→  - `POST /api/auth/login`\n   949→- 其余所有接口都要求有效登录态，否则返回 `401`。\n   950→\n   951→**登录态（Cookie 会话）**\n   952→- Cookie：\n   953→  - `fortune_session`：`base64url` 随机 token（HttpOnly，`SameSite=Lax`，`Path=/`）\n   954→  - `fortune_csrf`：随机 CSRF token（非 HttpOnly，`SameSite=Lax`，`Path=/`）\n   955→- 服务端校验：\n   956→  - `fortune_session` → `sha256(token)` 匹配 `fortune_user_session.token_hash`，且 `revoked_at IS NULL AND expires_at > now()`\n   957→  - 对所有 `POST/PUT/DELETE`：要求请求头 `X-CSRF-Token`，其 `sha256` 必须匹配 `fortune_user_session.csrf_token_hash`\n   958→\n   959→**统一响应结构**\n   960→\n   961→成功：\n   962→```json\n   963→{\"ok\": true, \"data\": {}}\n   964→```\n   965→\n   966→失败：\n   967→```json\n   968→{\"ok\": false, \"error\": {\"code\": \"invalid_request\", \"message\": \"missing_field: birthday_local\", \"detail\": {\"field\": \"birthday_local\"}}}\n   969→```\n   970→\n   971→### 7.1 认证与用户管理\n   972→\n   973→`POST /api/auth/register`（注册即登录）\n   974→\n   975→请求：\n   976→```json\n   977→{\n   978→  \"email\": \"zhangsan@example.com\",\n   979→  \"password\": \"S3curePassw0rd!\",\n   980→  \"name\": \"张三\",\n   981→  \"gender\": \"男\",\n   982→  \"birthday_local\": \"1990-05-12 14:00:00\",\n   983→  \"tz_offset_hours\": 8.0,\n   984→  \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n   985→}\n   986→```\n   987→\n   988→行为：\n   989→- 创建 `fortune_user`（`email` 统一转小写存储；`password_hash` 使用 bcrypt）\n   990→- upsert `fortune_user_preferences`（默认 `persona_style=warm`）\n   991→- 创建会话：插入 `fortune_user_session`，下发 `fortune_session` 与 `fortune_csrf` Cookie\n   992→- 计算并写入 `fortune_bazi_snapshot`（`compute_version=bazi-tts-v1`）\n   993→\n   994→响应：\n   995→```json\n   996→{\n   997→  \"ok\": true,\n   998→  \"data\": {\n   999→    \"user_id\": 123,\n  1000→    \"email\": \"zhangsan@example.com\",\n  1001→    \"profile_summary\": {\"name\": \"张三\", \"gender\": \"男\", \"location_name\": \"北京\"}\n  1002→  }\n  1003→}\n  1004→```\n  1005→\n  1006→`POST /api/auth/login`\n  1007→\n  1008→请求：\n  1009→```json\n  1010→{\"email\":\"zhangsan@example.com\",\"password\":\"S3curePassw0rd!\"}\n  1011→```\n  1012→\n  1013→行为：\n  1014→- 校验密码（bcrypt）\n  1015→- 更新 `fortune_user.last_login_at`\n  1016→- 创建 `fortune_user_session` 并下发 Cookie\n  1017→\n  1018→响应：\n  1019→```json\n  1020→{\"ok\": true, \"data\": {\"user_id\": 123, \"email\": \"zhangsan@example.com\", \"name\": \"张三\"}}\n  1021→```\n  1022→\n  1023→`GET /api/auth/me`\n  1024→\n  1025→响应：\n  1026→```json\n  1027→{\"ok\": true, \"data\": {\"user_id\": 123, \"email\": \"zhangsan@example.com\", \"name\": \"张三\", \"persona_style\": \"warm\"}}\n  1028→```\n  1029→\n  1030→`POST /api/auth/logout`\n  1031→- 行为：将当前 `fortune_user_session.revoked_at = now()`，并清空 Cookie\n  1032→\n  1033→`GET /api/auth/sessions`\n  1034→响应：\n  1035→```json\n  1036→{\n  1037→  \"ok\": true,\n  1038→  \"data\": {\n  1039→    \"sessions\": [\n  1040→      {\"session_id\":\"a9c55f2f-2d2b-4f02-9c35-7f5a0d6d9a1c\",\"created_at\":\"2025-12-29T10:00:00Z\",\"expires_at\":\"2026-01-28T10:00:00Z\",\"ip\":\"106.37.170.238\",\"user_agent\":\"Mozilla/5.0\"}\n  1041→    ]\n  1042→  }\n  1043→}\n  1044→```\n  1045→\n  1046→`POST /api/auth/logout-all`\n  1047→- 行为：将该用户所有未过期 session 标记 `revoked_at = now()`，并清空当前 Cookie\n  1048→\n  1049→`PUT /api/auth/password`\n  1050→\n  1051→请求：\n  1052→```json\n  1053→{\"old_password\":\"S3curePassw0rd!\",\"new_password\":\"N3wS3curePassw0rd!\"}\n  1054→```\n  1055→\n  1056→行为：\n  1057→- 校验旧密码 → 更新 `fortune_user.password_hash`\n  1058→- 退出所有登录态：`logout-all`\n  1059→\n  1060→`DELETE /api/auth/account`\n  1061→\n  1062→请求：\n  1063→```json\n  1064→{\"password\":\"N3wS3curePassw0rd!\"}\n  1065→```\n  1066→\n  1067→行为：\n  1068→- 校验密码 → `fortune_user.deleted_at = now()`\n  1069→- 退出所有登录态：`logout-all`\n  1070→\n  1071→### 7.2 用户资料（Profile）\n  1072→\n  1073→`GET /api/user/profile`\n  1074→\n  1075→响应：\n  1076→```json\n  1077→{\n  1078→  \"ok\": true,\n  1079→  \"data\": {\n  1080→    \"profile\": {\n  1081→      \"name\": \"张三\",\n  1082→      \"gender\": \"男\",\n  1083→      \"birthday_local\": \"1990-05-12 14:00:00\",\n  1084→      \"tz_offset_hours\": 8.0,\n  1085→      \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n  1086→    },\n  1087→    \"preferences\": {\"persona_style\":\"warm\",\"push_enabled\":true,\"push_time\":\"08:00:00\",\"quiet_hours_start\":\"22:00:00\",\"quiet_hours_end\":\"07:00:00\"}\n  1088→  }\n  1089→}\n  1090→```\n  1091→\n  1092→`PUT /api/user/profile`（更新出生信息会触发重算）\n  1093→\n  1094→请求：\n  1095→```json\n  1096→{\n  1097→  \"name\": \"张三\",\n  1098→  \"gender\": \"男\",\n  1099→  \"birthday_local\": \"1990-05-12 13:50:00\",\n  1100→  \"tz_offset_hours\": 8.0,\n  1101→  \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n  1102→}\n  1103→```\n  1104→\n  1105→行为：\n  1106→- 更新 `fortune_user` 的 Profile 字段\n  1107→- 写入新的 `fortune_bazi_snapshot`（重算并生成新 `facts_hash`）\n  1108→\n  1109→### 7.3 会话\n  1110→\n  1111→`POST /api/session/new`\n  1112→```json\n  1113→{\"title\": \"新对话\"}\n  1114→```\n  1115→\n  1116→响应：\n  1117→```json\n  1118→{\"ok\": true, \"data\": {\"session_id\": \"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\", \"title\": \"新对话\"}}\n  1119→```\n  1120→\n  1121→`GET /api/session/list`\n  1122→```json\n  1123→{\"ok\": true, \"data\": {\"sessions\": [{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"title\":\"新对话\",\"updated_at\":\"2025-12-29T10:00:00Z\",\"preview\":\"我最近很焦虑，工作要不要换？\"}]}}\n  1124→```\n  1125→\n  1126→`GET /api/session/{session_id}`\n  1127→```json\n  1128→{\"ok\": true, \"data\": {\"messages\": [{\"role\":\"user\",\"content\":\"我最近很焦虑，工作要不要换？\"},{\"role\":\"assistant\",\"content\":\"（已用A2UI返回）\",\"a2ui\":{\"meta\":{\"summary\":\"把问题写清并做最小验证\"},\"ui_components\":[{\"type\":\"markdown_text\",\"title\":\"输出\",\"data\":\"### 结论要点\\\\n- 你现在的焦虑主要来自不确定性与信息过载。\\\\n\\\\n### 行动处方（≤3条）\\\\n1) 用决策模板写清选项/约束（10分钟）\\\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\\\n3) 情绪峰值先做3分钟降噪再决策\\\\n\\\\n### 承诺\\\\n你愿意先做哪一个？\"}]}}}]}}\n  1129→```\n  1130→\n  1131→### 7.4 Chat（GLM，写入会话 + 生成“建议承诺”）\n  1132→\n  1133→`POST /api/chat/send`\n  1134→\n  1135→请求：\n  1136→```json\n  1137→{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"text\":\"我最近很焦虑，工作要不要换？\"}\n  1138→```\n  1139→\n  1140→行为：\n  1141→- 写入 `fortune_conversation_message(role=user)`\n  1142→- 读取最新 `fortune_bazi_snapshot` + `fortune_user_preferences` + 计划/承诺/打卡摘要\n  1143→- 检索知识库 `bazi_kb_chunk`（FTS + trgm，top-k=12）得到 `kb_refs`\n  1144→- 调用 GLM 输出 A2UI（必须含 actions）\n  1145→- 写入 `fortune_conversation_message(role=assistant, a2ui=GLM输出的A2UI JSON)`\n  1146→- 将 A2UI 中的处方写入 `fortune_commitment(status=suggested, source=chat, card_id=card.card_id)`\n  1147→\n  1148→响应：\n  1149→```json\n  1150→{\"ok\": true, \"data\": {\"assistant_message\": {\"role\":\"assistant\",\"a2ui\":{\"meta\":{\"summary\":\"先把问题写清，再做最小验证\"},\"ui_components\":[{\"type\":\"markdown_text\",\"title\":\"输出\",\"data\":\"### 结论要点\\\\n- 你现在的焦虑主要来自不确定性与信息过载。\\\\n\\\\n### 行动处方（≤3条）\\\\n1) 用决策模板写清选项/约束（10分钟）\\\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\\\n3) 情绪峰值先做3分钟降噪再决策\\\\n\\\\n### 承诺\\\\n你愿意先做哪一个？\"},{\"type\":\"action_buttons\",\"title\":\"下一步\",\"data\":[{\"label\":\"生成决策模板\",\"action\":{\"type\":\"open_panel\",\"panel\":\"decision_brief\"}},{\"label\":\"开始行动1\",\"action\":{\"type\":\"accept_task\",\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\"}}]}]}},\"suggested_tasks\":[{\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\",\"title\":\"用决策模板写清选项/约束（10分钟）\"}]}}\n  1151→```\n  1152→\n  1153→### 7.5 Bento（非语言交互）\n  1154→\n  1155→`GET /api/bento/today`\n  1156→- 返回今日指引卡；并 upsert `fortune_daily_guidance(user_id, today)`\n  1157→\n  1158→`POST /api/bento/checkin`\n  1159→```json\n  1160→{\"mood\":\"焦虑\",\"intensity\":7,\"note\":\"总担心选错\"}\n  1161→```\n  1162→- 写入 `fortune_checkin`\n  1163→- 返回一个“调节动作” + card（并带 actions 以便生成承诺）\n  1164→\n  1165→`POST /api/bento/commitment/accept`\n  1166→```json\n  1167→{\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\",\"due_at\":\"2025-12-29T13:00:00Z\"}\n  1168→```\n  1169→- 将该 task 从 `suggested` 变为 `active`，写入 `accepted_at`\n  1170→\n  1171→`POST /api/bento/commitment/done`\n  1172→```json\n  1173→{\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\",\"note\":\"已完成，感觉更清晰了\"}\n  1174→```\n  1175→- `status=done`，写 `done_at`\n  1176→\n  1177→`POST /api/bento/decision-brief`\n  1178→```json\n  1179→{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"topic\":\"是否换工作\",\"options\":[\"留下\",\"跳槽\"],\"constraints\":[\"经济压力\",\"学习成本\"],\"time_horizon_days\":30}\n  1180→```\n  1181→\n  1182→`POST /api/bento/script`\n  1183→```json\n  1184→{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"scenario\":\"和领导谈涨薪\",\"tone\":\"professional\",\"constraints\":[\"不引战\",\"清晰边界\"],\"length\":\"short\"}\n  1185→```\n  1186→\n  1187→`POST /api/bento/reflect`\n  1188→```json\n  1189→{\"period\":\"weekly\",\"reflection_date\":\"2025-12-29\",\"input\":{\"wins\":[\"按计划完成了2分钟习惯\"],\"pain_points\":[\"中途差点放弃\"],\"next_week_focus\":[\"把触发器固定到刷牙后\"]}}\n  1190→```\n  1191→\n  1192→### 7.6 计划（固定 4 个）\n  1193→\n  1194→`GET /api/plan/list`：返回 `fortune_plan`\n  1195→\n  1196→`POST /api/plan/join`\n  1197→```json\n  1198→{\"plan_id\":\"habit_30\",\"start_date\":\"2025-12-29\"}\n  1199→```\n  1200→\n  1201→`POST /api/plan/record`\n  1202→```json\n  1203→{\"plan_id\":\"habit_30\",\"day_no\":1,\"completed\":true,\"note\":\"完成2分钟版本\"}\n  1204→```\n  1205→\n  1206→### 7.7 偏好与推送\n  1207→\n  1208→`GET /api/user/preferences`：读取 `fortune_user_preferences`\n  1209→\n  1210→`PUT /api/user/preferences`\n  1211→```json\n  1212→{\"persona_style\":\"warm\",\"push_enabled\":true,\"push_time\":\"08:00:00\",\"quiet_hours_start\":\"22:00:00\",\"quiet_hours_end\":\"07:00:00\"}\n  1213→```\n  1214→\n  1215→`POST /api/push/pause`\n  1216→```json\n  1217→{\"push_enabled\": false}\n  1218→```\n  1219→\n  1220→### 7.8 八字深度报告（backend=cli|gemini）\n  1221→\n  1222→定位：作为 `工具` Tab 的可选能力（长文报告、阅读模式），不影响主闭环（主闭环用 GLM）。\n  1223→\n  1224→**边界（DB 使用）**\n  1225→- Fortune AI 业务数据与权限控制：`fortune_ai`（本项目所有表）\n  1226→- `backend=cli`：调用 `cli_worker` 执行与状态查询（不访问 `gemini` DB）\n  1227→- `backend=gemini`：复用现有 gemini job/task 流程（仅此处会访问 `gemini` DB，见 `.env.example` 的 `GEMINI_DB_*`）\n  1228→\n  1229→**对外 API（绑定登录用户，权限可控）**\n  1230→\n  1231→`POST /api/report/bazi/submit`\n  1232→\n  1233→请求：\n  1234→```json\n  1235→{\"backend\":\"cli\",\"model\":\"deep_research\",\"system_prompt\":\"你是一个八字大师，请以建设性、可执行的方式输出。\"}\n  1236→```\n  1237→\n  1238→行为：\n  1239→- 从 `fortune_user` 读取该用户的出生信息（不允许前端随意覆盖）\n  1240→- 默认 `backend=cli`：调用 `cli_worker` 执行链路提交与轮询任务\n  1241→- 当 `backend=gemini`：调用现有报告引擎（内部仍走 `/api/v2/submit` 与 `task_service.submit_bazi_task_v2` 的逻辑）\n  1242→- 在 `fortune_ai` 写入 `fortune_external_job` 记录（user_id ↔ provider_job_id ↔ backend ↔ session_id 可选）\n  1243→\n  1244→响应：\n  1245→```json\n  1246→{\"ok\": true, \"data\": {\"job_id\": 101, \"backend\": \"cli\", \"status\": \"processing\"}}\n  1247→```\n  1248→\n  1249→`GET /api/report/bazi/{job_id}?backend=cli|gemini`\n  1250→\n  1251→响应（processing）：\n  1252→```json\n  1253→{\"ok\": true, \"data\": {\"job_id\": 101, \"backend\": \"cli\", \"status\": \"processing\"}}\n  1254→```\n  1255→\n  1256→响应（completed）：\n  1257→```json\n  1258→{\"ok\": true, \"data\": {\"job_id\": 101, \"backend\": \"cli\", \"status\": \"completed\", \"a2ui\": {\"meta\": {\"summary\": \"八字深度报告\"}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": \"### 结论要点\\\\n- 你属于偏火土的结构，做事更适合先定节奏再推进。\\\\n\\\\n### 行动处方（≤3条）\\\\n1) 本周只做一个最小目标（写清楚并公开承诺）\\\\n2) 每天固定一个30分钟深度专注块\\\\n3) 情绪上头时先做3分钟降噪再沟通\"}]}}}\n  1259→```\n  1260→\n  1261→**内部保留接口（不建议前端直接调用）**\n  1262→- `POST /api/v2/submit`\n  1263→- `GET /api/v2/report/{job_id}`\n  1264→\n  1265→---\n  1266→\n  1267→## 8. 主动服务（Push）实现（订阅制、可审计）\n  1268→\n  1269→### 8.1 触发与频控（固定）\n  1270→\n  1271→| push_type | 触发 | 频率上限 |\n  1272→|---|---|---:|\n  1273→| `plan_daily` | 用户加入任一计划后，每日到点 | 每日 1 次 |\n  1274→| `weekly_reflection` | 每周固定一天到点 | 每周 1 次 |\n  1275→| `milestone` | streak/毕业/关键里程碑 | 达成即推 |\n  1276→\n  1277→### 8.2 发送规则（执行时检查）\n  1278→\n  1279→发送前必须同时满足：\n  1280→- `fortune_user_preferences.push_enabled = true`\n  1281→- 不在静默时段\n  1282→- 同类 push 当日未发送过（以 `fortune_push_event` 去重）\n  1283→\n  1284→---\n  1285→\n  1286→## 9. 验收（可运行、可统计、可回放）\n  1287→\n  1288→### 9.1 事件口径（WCG）\n  1289→\n  1290→| 事件 | 写入表 | 判定 |\n  1291→|---|---|---|\n  1292→| trigger | `fortune_push_event` / `fortune_conversation_message` | 用户打开/点击/发起 |\n  1293→| guidance_shown | `fortune_daily_guidance` / message.a2ui | 已展示 card |\n  1294→| commitment_made | `fortune_commitment` | `accepted_at IS NOT NULL` |\n  1295→| action_done | `fortune_commitment.status='done'` | 完成 ≥1 |\n  1296→| feedback | `fortune_checkin` / `fortune_reflection` | 有打卡/复盘 |\n  1297→\n  1298→### 9.2 关键验收标准\n  1299→\n  1300→- 三点击路径全部可走通（今日指引/情绪打卡/决策模板/话术生成）\n  1301→- 每次 Chat 输出都有 `commitment_ask` 与可点击 `actions`\n  1302→- 任何负面提示都包含“你可以做什么”的行动处方\n  1303→- 所有输出可追溯：`facts_hash + kb_refs + rule_ids`\n  1304→\n  1305→---\n  1306→\n  1307→## 10. 4 周交付计划（Final MVP）\n  1308→\n  1309→1) Week 1：PostgreSQL schema（fortune_ai）+ 登录/会话（注册/登录/用户管理）+ 会话/消息 SSOT + `/login`/`/register`/`/main` 路由落地  \n  1310→2) Week 2：八字事实完整版（facts + facts_hash）+ 知识库入库脚本（PDF→chunk→PG）+ 检索接口  \n  1311→3) Week 3：GLM 对话 `/api/chat/send` + Guidance Card/A2UI 输出 + Bento 6 卡片 API  \n  1312→4) Week 4：计划（4 个预设）+ Push 调度器（写 `fortune_push_event`）+ WCG 指标统计与回放  \n  1313→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"412dd364-0985-4f9a-844b-0ffd61360edf","timestamp":"2025-12-30T04:14:00.961Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/docs/architech/system_design_final_mvp.md","content":"# Fortune AI 最终 MVP 系统设计（Web 可落地 / PostgreSQL / GLM）\n\n**文档类型**：Final MVP System Design  \n**产品代号**：`Fortune AI`  \n**版本**：Final MVP v1.0  \n**日期**：2025-12-29  \n**核心定位**：AI 驱动的“人生导航 / 陪伴 / 提升系统”（有效而极简）  \n**硬约束**：纯 AI（不引入真人服务）/ 不做社区 / Web 端可落地 / **Fortune AI 业务数据仅使用 PostgreSQL（DB=fortune_ai）**；深度报告支持 `backend=cli|gemini`：`gemini` 仅在调用 gemini 报告链路时连接 `DB=gemini`（`gemini_job/gemini_task`），`cli` 仅调用 `cli_worker` 的执行与状态查询（业务 SSOT 仍写入 `fortune_ai`）  \n**LLM**：**GLM（Z.AI / /api/paas/v4/chat/completions）**  \n**入口**：`/main`（**两栏**：左=对话（含会话切换/历史抽屉）右=Workbench（顶部结果 Viewer + 下方 Tabs 输入/配置）；未登录跳转 `/login`）  \n\n---\n\n## 0. 一页结论（给产品 & 开发）\n\n### 0.1 MVP 交付目标\n\n在 Web 端跑通一个可重复、可度量、可追溯的“陪跑闭环”：\n\n`Clarify → Insight → Prescription → Commitment → Action → Reflection → Memory Update`\n\n并用最小交互承载三大价值：\n- **导航**：把问题结构化成 `Options / Constraints / Risk Boundary / Next Experiment`\n- **陪伴**：以积极心理学 / Performance Coach 话术承接情绪（不恐吓、不宿命）\n- **提升**：把输出收敛为可执行行动与能力训练轨道（30 天计划 + 复盘）\n\n### 0.2 北极星指标（统一口径）\n\n`WCG`（Weekly Closed-loop Guidance）  \n定义：用户在一周内完成 ≥1 次“触发 → 指引 → 行动 → 反馈”闭环。\n\n### 0.3 最终合并决策（Codex MVP × Claude MVP）\n\n| 决策点 | 最终方案（Final MVP） | 取舍理由 |\n|---|---|---|\n| 闭环核心 | 引入 `Commitment`（4 类承诺） | 没有承诺就没有闭环；与“提升”一致 |\n| 交互效率 | “三点击原则”作为验收标准 | 可验收、可迭代、可控复杂度 |\n| 布局 | **两栏**（对话 + 功能区；会话历史为抽屉/弹层） | 保持极简与高效；多会话仍可用但不占常驻空间 |\n| Bento | 卡片为内容 + Tab 为容器 | 卡片可复用、Tab 可组织复杂度 |\n| 计划 | 4 个预设计划开箱即用 + 30 天轨道统一口径 | 降低选择成本，同时保证“提升”可度量 |\n| 知识库 | **PostgreSQL FTS + pg_trgm**（不引入其他 DB） | 可真实落地、可运维、可追溯 |\n| LLM | GLM（Z.AI / ChatGLM-4） | 统一对话与文本生成后端，便于治理 |\n\n---\n\n## 1. 产品原则（硬规则，可验收）\n\n### 1.1 三点击原则\n\n任何核心价值都必须在 ≤3 次点击内完成：\n- 打开 `/main` → 看今日指引 → 选择一个行动（Commitment）\n- 点“情绪打卡” → 选情绪/强度 → 获得一个调节动作并开始\n- 点“决策模板” → 选问题类型 → 生成下一步实验并加入待办\n\n### 1.2 每次交互必落到 Commitment\n\n`commitment_type`（仅 4 类）：\n- `start_task`：立刻开始（≤5 分钟优先）\n- `schedule_task`：加入今日/本周并设提醒\n- `ask_followup`：选择一个澄清问题继续（减少开放式追问）\n- `opt_out`：暂停/关闭（推送与反依赖的必要出口）\n\n### 1.3 反依赖机制（防玄学依赖）\n\n| 触发条件 | 系统响应（默认温和） |\n|---|---|\n| 连续 3 次问同一问题 | 强制给“现实行动实验”（5–15 分钟）后再继续；提供“我愿意执行/稍后/不再提示” |\n| 当日咨询 > 5 次 | 提示“信息足够，先行动”；给 1 个最小任务并结束回合 |\n| 轨道达标毕业 | 主动降频推送；强调自我掌控；引导进入维护期或换轨道 |\n\n### 1.4 Agent 角色优先级（不可逆）\n\n`Coach > Teaching Assistant > Customer Support > Sales`\n\n销售规则：**先交付价值，再给升级路径**；禁止恐吓式转化。\n\n---\n\n## 2. 前端交互（Web /main：两栏 + Bento）\n\n### 2.1 登录与用户管理（无游客模式）\n\n- 未登录访问 `/main` 时，服务端返回 `302` 跳转到 `/login`。\n- `/login`：邮箱 + 密码登录（成功后写入会话 Cookie）。\n- `/register`：邮箱 + 密码注册（注册即登录），并在同一流程内完成最小 Profile（姓名/性别/出生信息/地点）。\n- `设置` Tab 必须包含：\n  - 修改密码\n  - 退出登录\n  - 注销账户（软删除，清空会话）\n\n### 2.2 页面结构\n\n`/main` 两栏布局（极简且可落地）：\n- 左：对话线程（Chat Thread，SSOT）+ 顶部会话切换；会话历史以**抽屉/弹层**呈现（不常驻）\n- 右：功能区（Bento/Workbench，承载所有非语言交互）\n\n**ASCII（桌面端 /main 结构）**\n\n```text\n┌──────────────────────────────────────────────────────────────────────────┐\n│ Fortune AI | 会话 ▼ | 风格: warm | 设置 | 退出                              │\n├───────────────────────────────┬──────────────────────────────────────────┤\n│ Chat Thread (SSOT)             │ Bento / Workbench                         │\n│ ─────────────────────────────  │ Tabs: [Bento] [工具] [设置]               │\n│ · 会话历史（抽屉/弹层，按需开） │                                           │\n│ · 消息流（用户/教练）          │ 6 张核心卡片（1 tap 启动）                 │\n│ · 输入框 + 快捷动作            │ + 工具：八字报告/校准/铁板                 │\n│                                │ + 设置：push/静默/隐私/语言风格           │\n└───────────────────────────────┴──────────────────────────────────────────┘\n```\n\n### 2.3 右侧 Bento（Tab 作为容器，卡片为内容）\n\n右侧固定 3 个 Tab：\n- `Bento`（默认）：6 张核心卡片\n- `工具`：八字报告 / 出生校准 / 铁板神算\n- `设置`：语言风格 / 推送与静默时段 / 隐私与数据管理\n\n**Bento 6 张核心卡片（全部 1 tap 启动）**\n1) `今日指引`：结论 + 1 个动作（按钮）  \n2) `行动处方`：最多 3 个进行中任务（完成/跳过/复盘）  \n3) `情绪打卡`：情绪 + 强度（0–10）→ 归因 + 1 个调节动作  \n4) `成长计划`：预设计划（4 个）+ 30 天游程轨道（统一进度口径）  \n5) `决策模板`：Decision Brief（Options/Constraints/Risks/Next Experiment）  \n6) `话术生成`：场景 → 可复制模板（沟通/边界/拒绝/谈判）  \n\n### 2.4 语言风格（表达层）\n\n`persona_style`：\n- `standard`：清晰、中性、专业\n- `warm`：共情、支持性（默认）\n- `roast`：轻毒舌但不羞辱、不做人身定性\n\n---\n\n## 3. Chat Agent（GLM）设计\n\n### 3.1 “后端专业分析”到“教练表达”的翻译规则\n\n后端产出两类输入给 LLM：\n- `facts`：确定性事实（八字计算、用户偏好、计划进度、历史反馈）\n- `evidence`：证据（规则 ID + 知识库引用 + `facts_hash`）\n\nLLM 只做三件事：\n1) 共情承接（积极心理学）\n2) 结构化解释（把问题拆成可控/不可控/需澄清）\n3) 生成行动处方 + 承诺邀请（≤3 条处方）\n\nLLM 禁止做：\n- 自行推断八字事实、编造经典出处、输出确定性宿命论断言\n\n### 3.2 统一对话结构（6 步）\n\n1) 情绪确认  \n2) 结构解释（导航）  \n3) 行动处方（≤3）  \n4) 时间窗口（默认干预窗口）  \n5) 风险边界（医疗/法律/投资等）  \n6) 承诺邀请（Commitment）  \n\n### 3.3 GLM 接入方式（Z.AI OpenAI-compat）\n\n配置来源：`/home/aiscend/work/docs/apikey.md`\n\n**必须环境变量（不在文档中写明密钥值）**\n- `GLM_BASE_URL=https://api.z.ai/api/paas/v4`\n- `GLM_API_KEY=$ZAI_GLM_KEY`\n- `FORTUNE_AI_GLM_MODEL=glm-4.7`\n- `FORTUNE_AI_GLM_THINKING=disabled`（`enabled|disabled`）\n\n**请求协议（Chat Completions）**\n- `POST ${GLM_BASE_URL}/chat/completions`\n- Header：\n  - `Content-Type: application/json`\n  - `Authorization: Bearer ${GLM_API_KEY}`\n- Body：`model`, `messages`, `max_tokens`, `temperature`, `thinking.type`, `stream`\n\n**请求示例（非流式）**\n\n```bash\ncurl -sS \"$GLM_BASE_URL/chat/completions\" \\\n  -H \"Content-Type: application/json\" \\\n  -H \"Authorization: Bearer $GLM_API_KEY\" \\\n  -d '{\n    \"model\": \"'\"$FORTUNE_AI_GLM_MODEL\"'\",\n    \"max_tokens\": 1200,\n    \"temperature\": 0.6,\n    \"stream\": false,\n    \"thinking\": {\"type\":\"disabled\"},\n    \"messages\": [\n      {\"role\":\"system\",\"content\":\"你是 Fortune AI 的 Performance Coach。请严格仅输出 A2UI JSON（不要代码块/不要多余文本）。\"},\n      {\"role\":\"user\",\"content\":\"我最近很焦虑，工作要不要换？\"}\n    ]\n  }'\n```\n\n**注意**\n- 若设置 `thinking.type=enabled`，Z.AI 可能仅返回 `reasoning_content` 且 `content` 为空。\n- 后端会在检测到 `content` 为空时自动降级重试（`thinking=disabled`）以保证有可展示输出。\n\n**输出格式要求（强制）**\n- 返回 **A2UI JSON**，首组件必须为 `markdown_text`，确保前端可渲染。\n\n### 3.4 GLM System Prompt（最终模板，直接用于实现）\n\n> 目标：把“命理/知识库/规则”的专业分析，翻译成“积极心理学/绩效教练”的行动闭环输出；并强制结构化与可追溯。\n\n```text\n你是 Fortune AI 的对话 Agent，角色是积极心理学教练（Performance Coach）。\n\n【产品定位】\n人生导航 / 陪伴 / 提升。系统和交互保持“有效而极简”。\n\n【你的优先级（不可逆）】\nCoach > Teaching Assistant > Customer Support > Sales\n\n【硬性规则（必须遵守）】\n1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接“你可以做什么”的行动处方。\n2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。\n3) 每次输出必须包含：结论(conclusion) + 依据(why) + ≤3条处方(prescriptions) + 承诺邀请(commitment_ask)。\n4) 时间窗口默认只给干预窗口（intervention）；forecast 只能条件句+低置信度。\n5) 输出必须是 A2UI JSON，且第一组件必须是 markdown_text。\n6) 必须给出可点击 actions（start_task / schedule_task / open_panel / opt_out）。\n\n【语言风格 persona_style】\nstandard：清晰、中性、专业\nwarm：共情、支持性（默认）\nroast：轻毒舌但不羞辱、不对人格做负面定性\n\n【输入】\n- persona_style 取值：standard / warm / roast\n- user_context：用户基础信息与偏好（来自 PostgreSQL）\n- facts：八字确定性事实 + 计划进度 + 历史反馈（来自 PostgreSQL）\n- evidence：rule_ids + kb_refs + facts_hash（来自 PostgreSQL）\n- user_message：用户本轮输入（来自对话）\n\n【输出（A2UI JSON）】\n- meta.summary：一句话摘要\n- ui_components[0]：markdown_text（必须，包含：结论要点/依据/处方/时间窗口/边界/承诺邀请）\n- ui_components[1]：action_buttons（必须，包含：开始行动/加入计划/查看Bento等按钮）\n```\n\n---\n\n## 4. 交付契约（Guidance Card + A2UI）\n\n### 4.1 Guidance Card（服务端 SSOT）\n\n```json\n{\n  \"card_id\": \"b3a28c14-7a04-4b6c-8a37-8f4b0bb4c0f3\",\n  \"type\": \"daily_guidance\",\n  \"conclusion\": \"≤50字结论\",\n  \"why\": \"依据（用心理学/教练语言重构）\",\n  \"prescriptions\": [\n    {\"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\", \"content\": \"行动1\", \"estimated_minutes\": 5},\n    {\"task_id\": \"d1d6b1f3-1c1a-4d0f-9a64-2e4a91bfe5d2\", \"content\": \"行动2\", \"estimated_minutes\": 10}\n  ],\n  \"time_window\": {\n    \"type\": \"intervention\",\n    \"value\": \"7天试行\",\n    \"confidence\": \"high\",\n    \"checkpoint_date\": \"2026-01-05\"\n  },\n  \"risk_boundary\": \"不替代医疗/法律/投资建议\",\n  \"commitment_ask\": \"你愿意先做哪一个？\",\n  \"actions\": [\n    {\"type\": \"start_task\", \"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\", \"label\": \"开始行动1\"},\n    {\"type\": \"schedule_task\", \"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\", \"label\": \"加入今日计划\"}\n  ],\n  \"evidence\": {\n    \"plugin\": \"bazi\",\n    \"rule_ids\": [\"RULE-TS-001\", \"RULE-PATTERN-004\"],\n    \"kb_refs\": [\"kb:doc:2:page:45:chunk:3\"],\n    \"facts_hash\": \"sha256:3b9e8b9a1ad0b2f92b2d4e8c5a2d9b4c1f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c\"\n  },\n  \"created_at\": \"2025-12-29T10:00:00Z\"\n}\n```\n\n### 4.2 A2UI（前端渲染）\n\n```json\n{\n  \"meta\": {\"summary\": \"一句话摘要\"},\n  \"ui_components\": [\n    {\"type\": \"markdown_text\", \"title\": \"输出\", \"data\": \"### 结论要点\\n- 你现在的焦虑主要来自不确定性与信息过载。\\n\\n### 行动处方（≤3条）\\n1) 用决策模板写清选项/约束（10分钟）\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\n3) 情绪峰值先做3分钟降噪再决策\\n\\n### 承诺\\n你愿意先做哪一个？\"},\n    {\"type\": \"action_buttons\", \"title\": \"下一步\", \"data\": [{\"label\": \"开始行动1\", \"action\": {\"type\": \"start_task\", \"task_id\": \"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\"}}]}\n  ]\n}\n```\n\n---\n\n## 5. 后端架构（数学脑 / 知识脑 / 语言脑）\n\n```\nClient (/main)\n  → API (FastAPI)\n      → [数学脑] 八字确定性计算（facts + facts_hash）\n      → [知识脑] PostgreSQL FTS 检索知识库（kb_refs）\n      → [语言脑] GLM 生成 A2UI + Guidance Card\n      → PostgreSQL SSOT（用户/会话/计划/承诺/反馈/推送/知识库）\n```\n\n### 5.1 数学脑：八字确定性计算（真太阳时，直接实现）\n\n**输入（来自用户 Profile）**\n- `birthday_local`: `YYYY-MM-DD HH:MM:SS`（用户当地标准时间）\n- `tz_offset_hours`: 例如 `8.0`\n- `location`: `{ \"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042 }`\n\n**真太阳时校正（用于时柱/跨日边界）**\n\n1) 时区中央经线：`tz_meridian_deg = tz_offset_hours * 15`\n2) 经度校正（分钟）：`lon_corr_min = (longitude - tz_meridian_deg) * 4`\n3) 均时差（Equation of Time，分钟）：\n   - `birthday_utc = birthday_local - tz_offset_hours`\n   - `jd_ut = swisseph.julday(birthday_utc.year, birthday_utc.month, birthday_utc.day, hour_decimal_utc)`\n   - `e_days = swisseph.time_equ(jd_ut)`（返回“真太阳时 - 平太阳时”，单位天）\n   - `eot_min = e_days * 1440`\n4) 真太阳时（本地）：`true_solar_time_local = birthday_local + lon_corr_min + eot_min`\n\n**排盘（lunar_python）**\n\n以 `true_solar_time_local` 为排盘时间：\n- `Solar.fromYmdHms(Y,M,D,hh,mm,ss) -> Lunar -> EightChar`\n- 四柱：\n  - `EightChar.getYear()/getMonth()/getDay()/getTime()`\n- 十神（天干 + 地支）：\n  - `getYearShiShenGan/getMonthShiShenGan/getDayShiShenGan/getTimeShiShenGan`\n  - `getYearShiShenZhi/getMonthShiShenZhi/getDayShiShenZhi/getTimeShiShenZhi`\n- 纳音：`getYearNaYin/getMonthNaYin/getDayNaYin/getTimeNaYin`\n- 地势：`getYearDiShi/getMonthDiShi/getDayDiShi/getTimeDiShi`\n- 大运/流年：\n  - `yun = EightChar.getYun(gender_code)`（`男=1`，`女=0`）\n  - `da_yun_list = yun.getDaYun(10)`（取 10 步大运；过滤 `getGanZhi()==''` 的条目）\n  - 每步大运：`getStartAge/getEndAge/getStartYear/getEndYear/getGanZhi/getXun/getXunKong`\n  - 流年：`DaYun.getLiuNian()`（取当年与未来 5 年用于 MVP）\n\n### 5.2 `facts`（LLM 唯一事实输入，固定字段）\n\n`facts` 写入 `fortune_bazi_snapshot.facts`，并作为 GLM 生成的唯一事实来源。\n\n示例（北京，1990-05-12 14:00，男）：\n\n```json\n{\n  \"profile\": {\n    \"name\": \"张三\",\n    \"gender\": \"男\",\n    \"birthday_local\": \"1990-05-12 14:00:00\",\n    \"tz_offset_hours\": 8.0,\n    \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n  },\n  \"solar_time\": {\n    \"tz_meridian_deg\": 120.0,\n    \"lon_corr_min\": -14.3704,\n    \"eot_min\": 3.6845,\n    \"true_solar_time_local\": \"1990-05-12 13:49:19\"\n  },\n  \"bazi\": {\n    \"pillars\": {\"year\": \"庚午\", \"month\": \"辛巳\", \"day\": \"丁丑\", \"hour\": \"丁未\"},\n    \"day_master\": {\"gan\": \"丁\", \"element\": \"火\"},\n    \"wuxing_count\": {\"金\": 2, \"木\": 0, \"水\": 0, \"火\": 4, \"土\": 2},\n    \"shi_shen_gan\": {\"year\": \"正财\", \"month\": \"偏财\", \"day\": \"日主\", \"hour\": \"比肩\"},\n    \"shi_shen_zhi\": {\n      \"year\": [\"比肩\", \"食神\"],\n      \"month\": [\"劫财\", \"正财\", \"伤官\"],\n      \"day\": [\"食神\", \"七杀\", \"偏财\"],\n      \"hour\": [\"食神\", \"比肩\", \"偏印\"]\n    },\n    \"na_yin\": {\"year\": \"路旁土\", \"month\": \"白蜡金\", \"day\": \"涧下水\", \"hour\": \"天河水\"},\n    \"di_shi\": {\"year\": \"临官\", \"month\": \"帝旺\", \"day\": \"墓\", \"hour\": \"冠带\"},\n    \"luck\": {\n      \"forward\": true,\n      \"start_age_year\": 8,\n      \"da_yun\": [\n        {\"index\": 1, \"start_age\": 9, \"end_age\": 18, \"start_year\": 1998, \"end_year\": 2007, \"gan_zhi\": \"壬午\", \"xun\": \"甲申\", \"xun_kong\": \"戌亥\"},\n        {\"index\": 2, \"start_age\": 19, \"end_age\": 28, \"start_year\": 2008, \"end_year\": 2017, \"gan_zhi\": \"癸未\", \"xun\": \"乙酉\", \"xun_kong\": \"戌亥\"}\n      ],\n      \"liu_nian_next5\": [\n        {\"year\": 2026, \"gan_zhi\": \"丙午\"},\n        {\"year\": 2027, \"gan_zhi\": \"丁未\"},\n        {\"year\": 2028, \"gan_zhi\": \"戊申\"},\n        {\"year\": 2029, \"gan_zhi\": \"己酉\"},\n        {\"year\": 2030, \"gan_zhi\": \"庚戌\"}\n      ]\n    },\n    \"shensha\": [\n      {\"name\": \"桃花\", \"hit\": true, \"note\": \"以日支/年支推咸池\"},\n      {\"name\": \"驿马\", \"hit\": false, \"note\": \"以日支/年支推驿马\"},\n      {\"name\": \"天乙贵人\", \"hit\": true, \"note\": \"以日干推贵人\"}\n    ]\n  },\n  \"version\": {\n    \"compute_version\": \"bazi-tts-v1\",\n    \"facts_hash\": \"sha256:9a59e0f36b8f4c8b0b0e0e7b1c3c0d9610e14aa0f0e2d1d6b1f31c1a4d0f9a64\"\n  }\n}\n```\n\n### 5.3 旺衰与喜用（MVP 确定性算法，输出可解释）\n\n**日主五行映射（按日干）**\n- 甲乙=木；丙丁=火；戊己=土；庚辛=金；壬癸=水\n\n**月令季节五行（按月支）**\n- 寅卯辰=木（春）；巳午未=火（夏）；申酉戌=金（秋）；亥子丑=水（冬）\n\n**强弱评分（score）**\n- `support = count(day_master) + count(generator_of_day_master)`\n- `drain = count(produced_by_day_master) + count(controller_of_day_master)`\n- `score = support - drain + season_bonus`\n- `season_bonus`：\n  - 月令同五行：`+2`\n  - 月令生日主：`+1`\n  - 月令克日主：`-1`\n  - 月令被日主克：`-1`\n\n**判定**\n- `score >= 2` → `strong`\n- `score <= -2` → `weak`\n- 其余 → `neutral`\n\n**喜用输出**\n- `weak`：喜 `日主五行 + 生扶五行`\n- `strong`：喜 `泄耗五行 + 财五行 + 官杀五行`\n- `neutral`：优先补“最少的五行”\n\n### 5.4 神煞（MVP 固定计算范围与规则）\n\n固定计算：`桃花(咸池)`、`驿马`、`华盖`、`天乙贵人`、`文昌`\n\n**三合局分组（以年支/日支所属局为准）**\n- 申子辰局 → 桃花=酉，驿马=寅，华盖=辰\n- 亥卯未局 → 桃花=子，驿马=巳，华盖=未\n- 寅午戌局 → 桃花=卯，驿马=申，华盖=戌\n- 巳酉丑局 → 桃花=午，驿马=亥，华盖=丑\n\n**天乙贵人（按日干）**\n- 甲/戊/庚：丑、未\n- 乙/己：子、申\n- 丙/丁：亥、酉\n- 辛：寅、午\n- 壬/癸：卯、巳\n\n**文昌（按日干）**\n- 甲乙：巳、午\n- 丙丁：申、酉\n- 戊己：申、酉\n- 庚辛：亥、子\n- 壬癸：寅、卯\n\n命中判定：若四柱地支出现对应地支，则 `hit=true`。\n\n---\n\n## 6. 数据库设计（PostgreSQL / DB=fortune_ai，全部可执行）\n\n> 说明：本节为最终 schema（不使用任何其他数据库）。连接凭据参考 `docs/apikey.md`，将 DB 名替换为 `fortune_ai`。\n\n**决策（回答 DB 名称冲突）**\n- 在同一 PostgreSQL 实例中新建数据库 `fortune_ai`，Fortune AI 所有业务表只创建在该库内。\n- 深度报告支持 `backend=cli|gemini`：`gemini` 数据库保持原样，仅在 `backend=gemini` 时作为报告引擎的 job/task 存储（读写 `gemini_job/gemini_task`）；`backend=cli` 通过 `cli_worker` 的执行链路提交与轮询（不访问 `gemini` DB）。\n\n**运行时连接（必须）**\n- Fortune AI 业务库（DB=fortune_ai）：使用 `FORTUNE_DB_HOST/FORTUNE_DB_PORT/FORTUNE_DB_NAME/FORTUNE_DB_USER/FORTUNE_DB_PASSWORD`（与现有代码一致，`FORTUNE_DB_NAME=fortune_ai`）；也可用单一连接串 `FORTUNE_AI_DB_URL`（libpq URL 形式）。\n- `backend=gemini`：Gemini 报告服务库使用 `.env.example` 同名变量 `GEMINI_DB_HOST/GEMINI_DB_PORT/GEMINI_DB_NAME/GEMINI_DB_USER/GEMINI_DB_PASSWORD` 连接 `gemini`；**仅** `integrations/gemini_repo.py`（以及其依赖的 gemini_tool）允许访问该库，用于创建与轮询 `gemini_job/gemini_task`。\n- `backend=cli`：CLI Worker 使用 `CLI_WORKER_DB_URL`（或本地 sqlite fallback）查询任务状态；任务提交通过 `cli_worker` 项目接口执行（由 `integrations/cli_worker_repo.py` 封装）。\n\n### 6.1 初始化（数据库与扩展）\n\n```sql\nCREATE DATABASE fortune_ai;\n\n\\\\c fortune_ai;\n\nCREATE EXTENSION IF NOT EXISTS pgcrypto;\nCREATE EXTENSION IF NOT EXISTS pg_trgm;\n```\n\n### 6.2 用户与偏好\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_user (\n  user_id BIGSERIAL PRIMARY KEY,\n  email TEXT NOT NULL,\n  password_hash TEXT NOT NULL,          -- bcrypt\n  name TEXT NOT NULL,                   -- 昵称/显示名\n  gender TEXT NOT NULL CHECK (gender IN ('男','女')),\n  birthday_local TIMESTAMP NOT NULL,    -- 用户当地标准时间（不含时区）\n  birthday_utc TIMESTAMPTZ NOT NULL,    -- 统一存 UTC 时间（由 birthday_local + tz_offset_hours 推导）\n  tz_offset_hours NUMERIC(4,1) NOT NULL DEFAULT 8.0,\n  location JSONB NOT NULL,              -- {name, longitude, latitude}\n  bazi_digest TEXT,\n  last_login_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  deleted_at TIMESTAMPTZ\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_fortune_user_email_lower ON fortune_user ((lower(email))) WHERE deleted_at IS NULL;\nCREATE INDEX IF NOT EXISTS idx_fortune_user_name ON fortune_user (name) WHERE deleted_at IS NULL;\n\nCREATE TABLE IF NOT EXISTS fortune_user_preferences (\n  user_id BIGINT PRIMARY KEY REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  persona_style TEXT NOT NULL DEFAULT 'warm' CHECK (persona_style IN ('standard','warm','roast')),\n  push_enabled BOOLEAN NOT NULL DEFAULT TRUE,\n  push_time TIME NOT NULL DEFAULT '08:00:00',\n  push_timezone TEXT NOT NULL DEFAULT 'Asia/Shanghai',\n  quiet_hours_start TIME NOT NULL DEFAULT '22:00:00',\n  quiet_hours_end TIME NOT NULL DEFAULT '07:00:00',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE TABLE IF NOT EXISTS fortune_user_session (\n  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  token_hash TEXT NOT NULL,             -- sha256(base64url_token)\n  csrf_token_hash TEXT NOT NULL,        -- sha256(csrf_token)\n  ip TEXT NOT NULL DEFAULT '',\n  user_agent TEXT NOT NULL DEFAULT '',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  expires_at TIMESTAMPTZ NOT NULL,      -- now() + interval '30 days'\n  revoked_at TIMESTAMPTZ\n);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_user_session_token_hash ON fortune_user_session (token_hash);\nCREATE INDEX IF NOT EXISTS idx_user_session_user_active ON fortune_user_session (user_id, expires_at DESC) WHERE revoked_at IS NULL;\n```\n\n### 6.3 会话与消息（SSOT，不落本地文件）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_conversation_session (\n  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  title TEXT NOT NULL DEFAULT '',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCREATE INDEX IF NOT EXISTS idx_conv_session_user_updated ON fortune_conversation_session (user_id, updated_at DESC);\n\nCREATE TABLE IF NOT EXISTS fortune_conversation_message (\n  message_id BIGSERIAL PRIMARY KEY,\n  session_id UUID NOT NULL REFERENCES fortune_conversation_session(session_id) ON DELETE CASCADE,\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  role TEXT NOT NULL CHECK (role IN ('user','assistant','system')),\n  content TEXT NOT NULL,\n  a2ui JSONB,                            -- assistant 输出（可空）\n  model TEXT NOT NULL,\n  prompt_tokens INTEGER NOT NULL DEFAULT 0,\n  completion_tokens INTEGER NOT NULL DEFAULT 0,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCREATE INDEX IF NOT EXISTS idx_conv_msg_session_time ON fortune_conversation_message (session_id, created_at);\n```\n\n### 6.4 八字事实快照（可追溯一致性）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_bazi_snapshot (\n  snapshot_id BIGSERIAL PRIMARY KEY,\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  compute_version TEXT NOT NULL,\n  facts JSONB NOT NULL,\n  facts_hash TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE (user_id, compute_version, facts_hash)\n);\nCREATE INDEX IF NOT EXISTS idx_bazi_snapshot_user_time ON fortune_bazi_snapshot (user_id, created_at DESC);\n```\n\n### 6.5 承诺与行动（闭环核心）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_commitment (\n  task_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,\n  card_id UUID,                         -- 生成该建议的交付卡 ID（可空）\n  source TEXT NOT NULL CHECK (source IN ('chat','bento','push')),\n  commitment_type TEXT NOT NULL CHECK (commitment_type IN ('start_task','schedule_task','ask_followup','opt_out')),\n  title TEXT NOT NULL,\n  details JSONB NOT NULL DEFAULT '{}'::jsonb,\n  status TEXT NOT NULL DEFAULT 'suggested' CHECK (status IN ('suggested','active','done','skipped','canceled')),\n  accepted_at TIMESTAMPTZ,              -- 用户确认承诺的时间（commitment_made 以此判定）\n  due_at TIMESTAMPTZ,\n  done_at TIMESTAMPTZ,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCREATE INDEX IF NOT EXISTS idx_commitment_user_status ON fortune_commitment (user_id, status, created_at DESC);\n```\n\n### 6.6 情绪打卡与复盘（反馈闭环）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_checkin (\n  checkin_id BIGSERIAL PRIMARY KEY,\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  mood TEXT NOT NULL,                    -- 例：焦虑/低落/平静/兴奋\n  intensity INTEGER NOT NULL CHECK (intensity BETWEEN 0 AND 10),\n  note TEXT NOT NULL DEFAULT '',\n  recommended_action TEXT NOT NULL,      -- 系统给出的 1 个动作（可执行）\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCREATE INDEX IF NOT EXISTS idx_checkin_user_time ON fortune_checkin (user_id, created_at DESC);\n\nCREATE TABLE IF NOT EXISTS fortune_reflection (\n  reflection_id BIGSERIAL PRIMARY KEY,\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  period TEXT NOT NULL CHECK (period IN ('daily','weekly')),\n  reflection_date DATE NOT NULL,\n  input JSONB NOT NULL,                 -- 用户回答（结构化）\n  output_card JSONB NOT NULL,           -- Guidance Card\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE (user_id, period, reflection_date)\n);\n```\n\n### 6.7 成长计划（4 个预设 + 用户进度）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_plan (\n  plan_id TEXT PRIMARY KEY,\n  name TEXT NOT NULL,\n  duration_days INTEGER NOT NULL CHECK (duration_days > 0),\n  theory TEXT NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\n\nCREATE TABLE IF NOT EXISTS fortune_plan_day (\n  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE CASCADE,\n  day_no INTEGER NOT NULL CHECK (day_no > 0),\n  title TEXT NOT NULL,\n  instruction TEXT NOT NULL,\n  PRIMARY KEY (plan_id, day_no)\n);\n\nCREATE TABLE IF NOT EXISTS fortune_plan_enrollment (\n  enrollment_id BIGSERIAL PRIMARY KEY,\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE RESTRICT,\n  start_date DATE NOT NULL,\n  current_day INTEGER NOT NULL DEFAULT 1,\n  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','paused','completed','abandoned')),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE (user_id, plan_id, start_date)\n);\nCREATE INDEX IF NOT EXISTS idx_plan_enroll_user_status ON fortune_plan_enrollment (user_id, status, updated_at DESC);\n\nCREATE TABLE IF NOT EXISTS fortune_plan_record (\n  record_id BIGSERIAL PRIMARY KEY,\n  enrollment_id BIGINT NOT NULL REFERENCES fortune_plan_enrollment(enrollment_id) ON DELETE CASCADE,\n  day_no INTEGER NOT NULL,\n  completed BOOLEAN NOT NULL DEFAULT FALSE,\n  note TEXT NOT NULL DEFAULT '',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE (enrollment_id, day_no)\n);\n```\n\n**预设计划固定为 4 个（开箱即用，写入 DB）**\n\n```sql\nINSERT INTO fortune_plan (plan_id, name, duration_days, theory) VALUES\n  ('gratitude_21', '21天感恩练习', 21, '积极心理学'),\n  ('mindfulness_7', '7天正念入门', 7, '正念冥想'),\n  ('habit_30', '30天习惯养成挑战', 30, '行为科学/原子习惯'),\n  ('strength_14', '14天优势发现之旅', 14, 'VIA优势理论')\nON CONFLICT (plan_id) DO NOTHING;\n```\n\n**预设计划任务（`fortune_plan_day`，固定内容，直接写入 DB）**\n\n```sql\n-- 21天感恩练习\nINSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n('gratitude_21', 1, '启动：三件好事', '写下今天发生的3件值得感恩/欣赏的小事；每件用1句话写清“发生了什么”和“我为什么感激”。'),\n('gratitude_21', 2, '细化：把好事写具体', '从昨天的3件好事里任选1件，补充3个细节（人/地点/动作/感受），让它更可回忆。'),\n('gratitude_21', 3, '人际：感谢一个人', '给一个人发一条感谢信息（不需长），明确说出：对方做了什么→对你产生了什么影响。'),\n('gratitude_21', 4, '逆境：找出一个转折', '回想最近一个不顺，写下：最难的点是什么？我从中学到的一件事是什么？'),\n('gratitude_21', 5, '身体：感谢身体', '写下今天身体为你做好的3件事（例如呼吸、走路、恢复），并做一次1分钟伸展。'),\n('gratitude_21', 6, '环境：感谢一处空间', '选一个你常待的空间（工位/卧室），写下它带给你的1个好处，并整理1个小角落。'),\n('gratitude_21', 7, '一周复盘：我更容易看见什么', '写下这一周你更容易注意到的“好”是什么（人/事/能力/资源），以及下周你想继续强化的1点。'),\n('gratitude_21', 8, '行为：把感谢变成行动', '选择一个你感激的人或资源，做一个5分钟的小行动来回馈（例如主动帮一次忙）。'),\n('gratitude_21', 9, '优势：感谢自己的一个优点', '写下你最近做对的一件事，并标注它体现了你哪种能力/品质（例如专注、勇气、耐心）。'),\n('gratitude_21', 10, '情绪：感谢一次情绪提醒', '回想今天一次负面情绪，写下：它提醒了我什么需求？我能用一个健康方式满足它是什么？'),\n('gratitude_21', 11, '关系：修复一个小摩擦', '选择一个小摩擦场景，写下你能做的一个小修复动作（例如道歉、解释、感谢）。'),\n('gratitude_21', 12, '时间：感谢一次坚持', '写下你最近坚持了3天以上的一件事，并说明它让你得到的一个好处。'),\n('gratitude_21', 13, '工作：感谢一个机会', '写下你当前工作/学习里一个可利用的机会或资源，并写下你明天会做的一个最小利用动作。'),\n('gratitude_21', 14, '两周复盘：我的变化', '用0-10分给“情绪稳定/行动一致/关系满意”各打分，并写下各自提升/下降的原因。'),\n('gratitude_21', 15, '表达：把感谢说出口', '当面或语音对一个人表达感谢（30秒即可）：具体行为→影响→你的感受。'),\n('gratitude_21', 16, '愿景：感谢未来的自己', '写一段给30天后的自己的话：你希望他/她保持什么？你感谢他/她会做到什么？'),\n('gratitude_21', 17, '学习：感谢一次输入', '选一段你今天学到的内容（文章/视频/对话），写下1句可执行的收获（明天怎么用）。'),\n('gratitude_21', 18, '金钱：感谢一笔支出', '挑一笔你最近的支出，写下它解决了什么问题/带来了什么价值；避免自责式语言。'),\n('gratitude_21', 19, '勇气：感谢一次不完美行动', '写下你做过的一次“虽然不完美但仍然去做”的行动；标注它体现的勇气。'),\n('gratitude_21', 20, '整合：我的感谢清单', '把前19天里你最想保留的5条感谢整理成清单，并写下你将如何持续（每周一次）。'),\n('gratitude_21', 21, '毕业：把感谢变成习惯', '写下：这21天最有效的一个做法；以及你未来4周的最小维持频率（例如每周3天）。')\nON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n\n-- 7天正念入门\nINSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n('mindfulness_7', 1, '呼吸锚点（3分钟）', '计时3分钟：只关注呼吸的进出；走神时温和拉回；结束后给自己一句鼓励。'),\n('mindfulness_7', 2, '身体扫描（5分钟）', '从头到脚扫描身体感受；只描述“紧/松/热/冷”，不评判好坏。'),\n('mindfulness_7', 3, '情绪命名（2分钟）', '当下情绪用一个词命名（例如焦虑/烦躁）；再用一句话描述它在身体的感觉。'),\n('mindfulness_7', 4, '正念进食（5分钟）', '选一小口食物：观察颜色/气味/口感；放慢咀嚼；注意冲动与满足的变化。'),\n('mindfulness_7', 5, '正念行走（5分钟）', '走5分钟：注意脚掌触地、身体重心移动；不听信息流。'),\n('mindfulness_7', 6, '3分钟降噪协议', '遇到强情绪时执行：1分钟呼吸→1分钟身体感受→1分钟选择下一步（一个小动作）。'),\n('mindfulness_7', 7, '毕业复盘', '写下：本周最有效的练习是哪一个？你准备在未来两周以什么频率继续？')\nON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n\n-- 30天习惯养成挑战\nINSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n('habit_30', 1, '定义一个最小习惯', '选择一个你想养成的习惯，把它缩小到“2分钟版本”（例如做5个俯卧撑/写50字）。'),\n('habit_30', 2, '设置触发器', '为习惯选择一个固定触发器（起床后/刷牙后/下班到家后），写成一句话，例如：“当我刷牙后，我就做2分钟版本”。'),\n('habit_30', 3, '准备环境', '把执行习惯需要的物品/环境准备好（例如把瑜伽垫放出来）；让开始成本≤30秒。'),\n('habit_30', 4, '记录一次完成', '今天完成一次2分钟版本，并记录：我在什么时刻做的？完成后感觉如何（0-10）？'),\n('habit_30', 5, '加入一个奖励', '为完成后加一个小奖励（1分钟伸展/一杯热水/听一首歌），强化闭环。'),\n('habit_30', 6, '识别阻碍', '写下你今天最可能失败的原因（时间/情绪/环境），并给一个应对预案。'),\n('habit_30', 7, '一周复盘', '统计本周完成天数；写下最有效的触发器与最大阻碍；调整一次触发器或时间。'),\n('habit_30', 8, '提高可见性', '把习惯放到更可见的位置（便签/桌面/日历），让你更容易想起它。'),\n('habit_30', 9, '缩短启动时间', '把“开始动作”进一步缩短（例如只做1个俯卧撑也算开始），确保今天不会零。'),\n('habit_30', 10, '提高一致性', '把习惯固定到同一时间段；如果做不到，就固定“同一触发器”。'),\n('habit_30', 11, '建立替代方案', '准备一个“低能量版本”（例如累时做30秒），保证情绪低谷也能完成。'),\n('habit_30', 12, '消除一个摩擦', '找到一个让你不想做的摩擦点（准备麻烦/太远），今天把它消掉。'),\n('habit_30', 13, '把习惯和身份绑定', '写一句身份宣言：我是谁→我会做什么（例如“我是重视健康的人，所以我每天动2分钟”）。'),\n('habit_30', 14, '两周复盘', '统计14天完成率；写下你最常见的失败场景，并更新一个更现实的预案。'),\n('habit_30', 15, '提升一点难度', '把2分钟版本提升10%-20%（仍然很小），例如从写50字到写60字。'),\n('habit_30', 16, '让它更有趣', '给习惯加一点乐趣（音乐/计时挑战/打卡视觉化），让你更愿意开始。'),\n('habit_30', 17, '建立“如果-那么”计划', '写下两条：如果我加班→那么我做低能量版本；如果我忘了→那么我睡前补一次。'),\n('habit_30', 18, '加入社交承诺', '找一个朋友或对话里做一个承诺：我将坚持到第30天；并写下你希望被如何提醒。'),\n('habit_30', 19, '连续3天挑战', '目标：连续3天不间断完成（允许低能量版本）。'),\n('habit_30', 20, '复盘奖励机制', '写下奖励是否有效；如果无效，换一个更适合你的奖励（不靠刷短视频）。'),\n('habit_30', 21, '三周复盘', '统计21天完成率；写下你完成最多的时间段；把习惯固定到那个时间段。'),\n('habit_30', 22, '减少自责', '写下：我失败时常说的自责句；把它改写成教练句（例如“下一次我做更小”）。'),\n('habit_30', 23, '优化提醒', '设置一个具体提醒（闹钟/日历），并写上行动文案（不是“别忘了”，而是“现在做2分钟版本”）。'),\n('habit_30', 24, '把习惯连到目标', '写下：这个习惯最终服务什么目标？它让你更接近目标的证据是什么？'),\n('habit_30', 25, '应对突发', '假设明天有突发事件，写下你仍能完成的最小动作是什么，并承诺执行。'),\n('habit_30', 26, '连续7天维护', '目标：连续7天都完成（允许低能量版本）；只追求“不断”。'),\n('habit_30', 27, '整理成果', '写下本月你累计完成了多少次；你感觉最大的变化是什么（哪怕很小）。'),\n('habit_30', 28, '建立复盘仪式', '选择一个每周固定的复盘时刻（例如周日20:00），写下你将检查的3个问题。'),\n('habit_30', 29, '准备长期版本', '为下个月定义一个可持续版本（不比现在更难），并确定触发器与提醒方式。'),\n('habit_30', 30, '毕业：写一封给自己的信', '写下：我靠什么坚持了30天？我下个月继续的最小频率是多少？')\nON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n\n-- 14天优势发现之旅\nINSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES\n('strength_14', 1, '列出5次高光时刻', '写下你过去1-2年里5次“做得很顺/很投入”的时刻；每次写清场景与结果。'),\n('strength_14', 2, '提炼3个优势', '从高光时刻里提炼3个反复出现的优势（例如组织、表达、洞察、执行），并各写一句证据。'),\n('strength_14', 3, '优势命名', '给每个优势起一个你喜欢的名字（更个人化），并写下它在你身上的表现。'),\n('strength_14', 4, '优势应用：工作', '选择一个工作/学习任务，刻意用一个优势完成它；记录结果与感受。'),\n('strength_14', 5, '优势应用：关系', '选择一个关系场景，用一个优势改善沟通（例如倾听/表达/边界），并记录反馈。'),\n('strength_14', 6, '识别优势的阴影面', '为每个优势写下它的“过度使用”会带来的问题（例如过度负责、过度挑剔）。'),\n('strength_14', 7, '一周复盘：优势最有用的时刻', '写下本周优势最有帮助的一次经历；以及下一周你想在哪个场景继续用它。'),\n('strength_14', 8, '优势组合', '挑两个优势做组合：它们如何互补？写下一个你想尝试的组合行动。'),\n('strength_14', 9, '优势补短', '选一个你经常卡住的弱项，写下用哪个优势可以“绕过去”（例如用结构化代替拖延）。'),\n('strength_14', 10, '优势与目标对齐', '写下你当前一个目标；把它拆成3步，并标注每步使用哪个优势最省力。'),\n('strength_14', 11, '请求支持', '找一个人描述你的一个优势，并请对方给一个你可以更好发挥的建议。'),\n('strength_14', 12, '优势表达为价值', '写一段30秒自我介绍：我擅长什么→能为别人带来什么价值（避免空话）。'),\n('strength_14', 13, '优势在压力下的使用', '回想一次压力情境，写下你可以如何用优势稳定自己，并设计一个下次的应对句。'),\n('strength_14', 14, '毕业：优势使用计划', '写下未来4周你要刻意使用的1个优势；设定每周至少2次的应用场景。')\nON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;\n```\n\n### 6.8 每日指引（今日卡 SSOT）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_daily_guidance (\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  guidance_date DATE NOT NULL,\n  card JSONB NOT NULL,                    -- Guidance Card\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  PRIMARY KEY (user_id, guidance_date)\n);\n```\n\n### 6.9 推送调度与发送记录（可审计）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_push_event (\n  push_id BIGSERIAL PRIMARY KEY,\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  push_type TEXT NOT NULL CHECK (push_type IN ('plan_daily','weekly_reflection','milestone')),\n  scheduled_at TIMESTAMPTZ NOT NULL,\n  sent_at TIMESTAMPTZ,\n  status TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled','sent','skipped','failed')),\n  payload JSONB NOT NULL,\n  error TEXT NOT NULL DEFAULT '',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCREATE INDEX IF NOT EXISTS idx_push_user_scheduled ON fortune_push_event (user_id, scheduled_at DESC);\n```\n\n### 6.10 八字知识库（PDF 入库 → PostgreSQL 检索）\n\n```sql\nCREATE TABLE IF NOT EXISTS bazi_kb_document (\n  doc_id BIGSERIAL PRIMARY KEY,\n  file_name TEXT NOT NULL,\n  sha256 TEXT NOT NULL,\n  title TEXT NOT NULL DEFAULT '',\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE (sha256)\n);\n\nCREATE TABLE IF NOT EXISTS bazi_kb_chunk (\n  chunk_id BIGSERIAL PRIMARY KEY,\n  doc_id BIGINT NOT NULL REFERENCES bazi_kb_document(doc_id) ON DELETE CASCADE,\n  page_no INTEGER NOT NULL CHECK (page_no > 0),\n  chunk_no INTEGER NOT NULL CHECK (chunk_no > 0),\n  content TEXT NOT NULL,\n  content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  UNIQUE (doc_id, page_no, chunk_no)\n);\nCREATE INDEX IF NOT EXISTS idx_kb_chunk_tsv ON bazi_kb_chunk USING GIN (content_tsv);\nCREATE INDEX IF NOT EXISTS idx_kb_chunk_trgm ON bazi_kb_chunk USING GIN (content gin_trgm_ops);\n```\n\n检索（用于 Structured RAG）：\n```sql\n-- 关键词检索（FTS）\nSELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,\n       ts_rank(c.content_tsv, plainto_tsquery('simple', :q)) AS rank,\n       c.content\nFROM bazi_kb_chunk c\nWHERE c.content_tsv @@ plainto_tsquery('simple', :q)\nORDER BY rank DESC\nLIMIT 12;\n\n-- 中文场景补充：trgm 相似度\nSELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,\n       similarity(c.content, :q) AS sim,\n       c.content\nFROM bazi_kb_chunk c\nWHERE c.content % :q\nORDER BY sim DESC\nLIMIT 12;\n```\n\n### 6.10.1 知识库入库流程（PDF → 文本 → chunk → PostgreSQL）\n\n**输入目录**\n- `fortune_ai/knowledge/bazi/*.pdf`\n\n**依赖（Python）**\n- `pypdf`（用于 PDF 文本抽取）\n\n**入库规则（固定）**\n- `bazi_kb_document.sha256` 唯一，保证幂等：同一 PDF 重复导入不会产生重复文档。\n- chunk 参数固定：\n  - `chunk_size_chars = 800`\n  - `chunk_overlap_chars = 120`\n- `kb_ref` 统一格式：`kb:doc:{doc_id}:page:{page_no}:chunk:{chunk_no}`\n\n**入库步骤（脚本执行顺序）**\n1) 遍历 PDF：计算文件 `sha256`，写入/复用 `bazi_kb_document`。\n2) 逐页抽取文本：保留 `page_no`；清理多余空白与重复换行。\n3) 分段切分：\n   - 先按段落（空行）拆分\n   - 再按字符数合并成 chunk（800 字），相邻 chunk 120 字重叠\n4) 写入 `bazi_kb_chunk`（`doc_id + page_no + chunk_no` 唯一）\n\n### 6.11 规则库（`rule_ids` SSOT，可追溯）\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_rule (\n  rule_id TEXT PRIMARY KEY,\n  category TEXT NOT NULL,\n  name TEXT NOT NULL,\n  body JSONB NOT NULL,\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()\n);\nCREATE INDEX IF NOT EXISTS idx_rule_category ON fortune_rule (category);\n```\n\n写入 MVP 必备规则（与 §5.3/§5.4 保持一致）：\n\n```sql\nINSERT INTO fortune_rule (rule_id, category, name, body) VALUES\n('RULE-STRENGTH-SCORE-V1', 'bazi_strength', '旺衰评分算法', '{\n  \"season_map\": {\"寅\":\"木\",\"卯\":\"木\",\"辰\":\"木\",\"巳\":\"火\",\"午\":\"火\",\"未\":\"火\",\"申\":\"金\",\"酉\":\"金\",\"戌\":\"金\",\"亥\":\"水\",\"子\":\"水\",\"丑\":\"水\"},\n  \"day_master_map\": {\"甲\":\"木\",\"乙\":\"木\",\"丙\":\"火\",\"丁\":\"火\",\"戊\":\"土\",\"己\":\"土\",\"庚\":\"金\",\"辛\":\"金\",\"壬\":\"水\",\"癸\":\"水\"},\n  \"threshold\": {\"strong\": 2, \"weak\": -2}\n}'::jsonb),\n('RULE-SHENSHA-TAOHUA-V1', 'bazi_shensha', '桃花（咸池）', '{\n  \"group_map\": {\"申子辰\":\"酉\",\"亥卯未\":\"子\",\"寅午戌\":\"卯\",\"巳酉丑\":\"午\"},\n  \"basis\": \"year_or_day_branch\"\n}'::jsonb),\n('RULE-SHENSHA-YIMA-V1', 'bazi_shensha', '驿马', '{\n  \"group_map\": {\"申子辰\":\"寅\",\"亥卯未\":\"巳\",\"寅午戌\":\"申\",\"巳酉丑\":\"亥\"},\n  \"basis\": \"year_or_day_branch\"\n}'::jsonb),\n('RULE-SHENSHA-HUAGAI-V1', 'bazi_shensha', '华盖', '{\n  \"group_map\": {\"申子辰\":\"辰\",\"亥卯未\":\"未\",\"寅午戌\":\"戌\",\"巳酉丑\":\"丑\"},\n  \"basis\": \"year_or_day_branch\"\n}'::jsonb),\n('RULE-SHENSHA-TIANYI-V1', 'bazi_shensha', '天乙贵人', '{\n  \"day_gan_map\": {\"甲\":[\"丑\",\"未\"],\"戊\":[\"丑\",\"未\"],\"庚\":[\"丑\",\"未\"],\"乙\":[\"子\",\"申\"],\"己\":[\"子\",\"申\"],\"丙\":[\"亥\",\"酉\"],\"丁\":[\"亥\",\"酉\"],\"辛\":[\"寅\",\"午\"],\"壬\":[\"卯\",\"巳\"],\"癸\":[\"卯\",\"巳\"]}\n}'::jsonb),\n('RULE-SHENSHA-WENCHANG-V1', 'bazi_shensha', '文昌', '{\n  \"day_gan_map\": {\"甲\":[\"巳\",\"午\"],\"乙\":[\"巳\",\"午\"],\"丙\":[\"申\",\"酉\"],\"丁\":[\"申\",\"酉\"],\"戊\":[\"申\",\"酉\"],\"己\":[\"申\",\"酉\"],\"庚\":[\"亥\",\"子\"],\"辛\":[\"亥\",\"子\"],\"壬\":[\"寅\",\"卯\"],\"癸\":[\"寅\",\"卯\"]}\n}'::jsonb)\nON CONFLICT (rule_id) DO UPDATE SET\n  category = EXCLUDED.category,\n  name = EXCLUDED.name,\n  body = EXCLUDED.body,\n  updated_at = now();\n```\n\n### 6.12 外部任务映射（报告 Job：backend=cli|gemini）\n\n目标：Fortune AI 的业务闭环与权限在 `fortune_ai` 库内完成；报告生成的执行与状态可来自 `backend=cli|gemini`，本表负责在两者之间建立“用户 ↔ provider_job_id”的可审计映射。\n\n```sql\nCREATE TABLE IF NOT EXISTS fortune_external_job (\n  id BIGSERIAL PRIMARY KEY,\n  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,\n  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,\n  provider TEXT NOT NULL CHECK (provider IN ('cli','gemini')),\n  job_type TEXT NOT NULL CHECK (job_type IN ('bazi_report')),\n  provider_job_id BIGINT NOT NULL,\n  status TEXT NOT NULL CHECK (status IN ('processing','completed','error')),\n  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),\n  last_polled_at TIMESTAMPTZ,\n  output_url TEXT NOT NULL DEFAULT '',\n  output_a2ui JSONB,\n  error TEXT NOT NULL DEFAULT '',\n  UNIQUE (provider, provider_job_id)\n);\nCREATE INDEX IF NOT EXISTS idx_external_job_user_time ON fortune_external_job (user_id, created_at DESC);\nCREATE INDEX IF NOT EXISTS idx_external_job_status ON fortune_external_job (status, updated_at DESC);\n```\n\n---\n\n## 7. API 设计（统一命名，直接实现）\n\n### 7.0 认证与通用约定（必须）\n\n**无游客模式**\n- 只有以下接口不需要登录：\n  - `POST /api/auth/register`\n  - `POST /api/auth/login`\n- 其余所有接口都要求有效登录态，否则返回 `401`。\n\n**登录态（Cookie 会话）**\n- Cookie：\n  - `fortune_session`：`base64url` 随机 token（HttpOnly，`SameSite=Lax`，`Path=/`）\n  - `fortune_csrf`：随机 CSRF token（非 HttpOnly，`SameSite=Lax`，`Path=/`）\n- 服务端校验：\n  - `fortune_session` → `sha256(token)` 匹配 `fortune_user_session.token_hash`，且 `revoked_at IS NULL AND expires_at > now()`\n  - 对所有 `POST/PUT/DELETE`：要求请求头 `X-CSRF-Token`，其 `sha256` 必须匹配 `fortune_user_session.csrf_token_hash`\n\n**统一响应结构**\n\n成功：\n```json\n{\"ok\": true, \"data\": {}}\n```\n\n失败：\n```json\n{\"ok\": false, \"error\": {\"code\": \"invalid_request\", \"message\": \"missing_field: birthday_local\", \"detail\": {\"field\": \"birthday_local\"}}}\n```\n\n### 7.1 认证与用户管理\n\n`POST /api/auth/register`（注册即登录）\n\n请求：\n```json\n{\n  \"email\": \"zhangsan@example.com\",\n  \"password\": \"S3curePassw0rd!\",\n  \"name\": \"张三\",\n  \"gender\": \"男\",\n  \"birthday_local\": \"1990-05-12 14:00:00\",\n  \"tz_offset_hours\": 8.0,\n  \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n}\n```\n\n行为：\n- 创建 `fortune_user`（`email` 统一转小写存储；`password_hash` 使用 bcrypt）\n- upsert `fortune_user_preferences`（默认 `persona_style=warm`）\n- 创建会话：插入 `fortune_user_session`，下发 `fortune_session` 与 `fortune_csrf` Cookie\n- 计算并写入 `fortune_bazi_snapshot`（`compute_version=bazi-tts-v1`）\n\n响应：\n```json\n{\n  \"ok\": true,\n  \"data\": {\n    \"user_id\": 123,\n    \"email\": \"zhangsan@example.com\",\n    \"profile_summary\": {\"name\": \"张三\", \"gender\": \"男\", \"location_name\": \"北京\"}\n  }\n}\n```\n\n`POST /api/auth/login`\n\n请求：\n```json\n{\"email\":\"zhangsan@example.com\",\"password\":\"S3curePassw0rd!\"}\n```\n\n行为：\n- 校验密码（bcrypt）\n- 更新 `fortune_user.last_login_at`\n- 创建 `fortune_user_session` 并下发 Cookie\n\n响应：\n```json\n{\"ok\": true, \"data\": {\"user_id\": 123, \"email\": \"zhangsan@example.com\", \"name\": \"张三\"}}\n```\n\n`GET /api/auth/me`\n\n响应：\n```json\n{\"ok\": true, \"data\": {\"user_id\": 123, \"email\": \"zhangsan@example.com\", \"name\": \"张三\", \"persona_style\": \"warm\"}}\n```\n\n`POST /api/auth/logout`\n- 行为：将当前 `fortune_user_session.revoked_at = now()`，并清空 Cookie\n\n`GET /api/auth/sessions`\n响应：\n```json\n{\n  \"ok\": true,\n  \"data\": {\n    \"sessions\": [\n      {\"session_id\":\"a9c55f2f-2d2b-4f02-9c35-7f5a0d6d9a1c\",\"created_at\":\"2025-12-29T10:00:00Z\",\"expires_at\":\"2026-01-28T10:00:00Z\",\"ip\":\"106.37.170.238\",\"user_agent\":\"Mozilla/5.0\"}\n    ]\n  }\n}\n```\n\n`POST /api/auth/logout-all`\n- 行为：将该用户所有未过期 session 标记 `revoked_at = now()`，并清空当前 Cookie\n\n`PUT /api/auth/password`\n\n请求：\n```json\n{\"old_password\":\"S3curePassw0rd!\",\"new_password\":\"N3wS3curePassw0rd!\"}\n```\n\n行为：\n- 校验旧密码 → 更新 `fortune_user.password_hash`\n- 退出所有登录态：`logout-all`\n\n`DELETE /api/auth/account`\n\n请求：\n```json\n{\"password\":\"N3wS3curePassw0rd!\"}\n```\n\n行为：\n- 校验密码 → `fortune_user.deleted_at = now()`\n- 退出所有登录态：`logout-all`\n\n### 7.2 用户资料（Profile）\n\n`GET /api/user/profile`\n\n响应：\n```json\n{\n  \"ok\": true,\n  \"data\": {\n    \"profile\": {\n      \"name\": \"张三\",\n      \"gender\": \"男\",\n      \"birthday_local\": \"1990-05-12 14:00:00\",\n      \"tz_offset_hours\": 8.0,\n      \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n    },\n    \"preferences\": {\"persona_style\":\"warm\",\"push_enabled\":true,\"push_time\":\"08:00:00\",\"quiet_hours_start\":\"22:00:00\",\"quiet_hours_end\":\"07:00:00\"}\n  }\n}\n```\n\n`PUT /api/user/profile`（更新出生信息会触发重算）\n\n请求：\n```json\n{\n  \"name\": \"张三\",\n  \"gender\": \"男\",\n  \"birthday_local\": \"1990-05-12 13:50:00\",\n  \"tz_offset_hours\": 8.0,\n  \"location\": {\"name\": \"北京\", \"longitude\": 116.4074, \"latitude\": 39.9042}\n}\n```\n\n行为：\n- 更新 `fortune_user` 的 Profile 字段\n- 写入新的 `fortune_bazi_snapshot`（重算并生成新 `facts_hash`）\n\n### 7.3 会话\n\n`POST /api/session/new`\n```json\n{\"title\": \"新对话\"}\n```\n\n响应：\n```json\n{\"ok\": true, \"data\": {\"session_id\": \"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\", \"title\": \"新对话\"}}\n```\n\n`GET /api/session/list`\n```json\n{\"ok\": true, \"data\": {\"sessions\": [{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"title\":\"新对话\",\"updated_at\":\"2025-12-29T10:00:00Z\",\"preview\":\"我最近很焦虑，工作要不要换？\"}]}}\n```\n\n`GET /api/session/{session_id}`\n```json\n{\"ok\": true, \"data\": {\"messages\": [{\"role\":\"user\",\"content\":\"我最近很焦虑，工作要不要换？\"},{\"role\":\"assistant\",\"content\":\"（已用A2UI返回）\",\"a2ui\":{\"meta\":{\"summary\":\"把问题写清并做最小验证\"},\"ui_components\":[{\"type\":\"markdown_text\",\"title\":\"输出\",\"data\":\"### 结论要点\\\\n- 你现在的焦虑主要来自不确定性与信息过载。\\\\n\\\\n### 行动处方（≤3条）\\\\n1) 用决策模板写清选项/约束（10分钟）\\\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\\\n3) 情绪峰值先做3分钟降噪再决策\\\\n\\\\n### 承诺\\\\n你愿意先做哪一个？\"}]}}}]}}\n```\n\n### 7.4 Chat（GLM，写入会话 + 生成“建议承诺”）\n\n`POST /api/chat/send`\n\n请求：\n```json\n{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"text\":\"我最近很焦虑，工作要不要换？\"}\n```\n\n行为：\n- 写入 `fortune_conversation_message(role=user)`\n- 读取最新 `fortune_bazi_snapshot` + `fortune_user_preferences` + 计划/承诺/打卡摘要\n- 检索知识库 `bazi_kb_chunk`（FTS + trgm，top-k=12）得到 `kb_refs`\n- 调用 GLM 输出 A2UI（必须含 actions）\n- 写入 `fortune_conversation_message(role=assistant, a2ui=GLM输出的A2UI JSON)`\n- 将 A2UI 中的处方写入 `fortune_commitment(status=suggested, source=chat, card_id=card.card_id)`\n\n响应：\n```json\n{\"ok\": true, \"data\": {\"assistant_message\": {\"role\":\"assistant\",\"a2ui\":{\"meta\":{\"summary\":\"先把问题写清，再做最小验证\"},\"ui_components\":[{\"type\":\"markdown_text\",\"title\":\"输出\",\"data\":\"### 结论要点\\\\n- 你现在的焦虑主要来自不确定性与信息过载。\\\\n\\\\n### 行动处方（≤3条）\\\\n1) 用决策模板写清选项/约束（10分钟）\\\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\\\n3) 情绪峰值先做3分钟降噪再决策\\\\n\\\\n### 承诺\\\\n你愿意先做哪一个？\"},{\"type\":\"action_buttons\",\"title\":\"下一步\",\"data\":[{\"label\":\"生成决策模板\",\"action\":{\"type\":\"open_panel\",\"panel\":\"decision_brief\"}},{\"label\":\"开始行动1\",\"action\":{\"type\":\"accept_task\",\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\"}}]}]}},\"suggested_tasks\":[{\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\",\"title\":\"用决策模板写清选项/约束（10分钟）\"}]}}\n```\n\n### 7.5 Bento（非语言交互）\n\n`GET /api/bento/today`\n- 返回今日指引卡；并 upsert `fortune_daily_guidance(user_id, today)`\n\n`POST /api/bento/checkin`\n```json\n{\"mood\":\"焦虑\",\"intensity\":7,\"note\":\"总担心选错\"}\n```\n- 写入 `fortune_checkin`\n- 返回一个“调节动作” + card（并带 actions 以便生成承诺）\n\n`POST /api/bento/commitment/accept`\n```json\n{\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\",\"due_at\":\"2025-12-29T13:00:00Z\"}\n```\n- 将该 task 从 `suggested` 变为 `active`，写入 `accepted_at`\n\n`POST /api/bento/commitment/done`\n```json\n{\"task_id\":\"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1\",\"note\":\"已完成，感觉更清晰了\"}\n```\n- `status=done`，写 `done_at`\n\n`POST /api/bento/decision-brief`\n```json\n{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"topic\":\"是否换工作\",\"options\":[\"留下\",\"跳槽\"],\"constraints\":[\"经济压力\",\"学习成本\"],\"time_horizon_days\":30}\n```\n\n`POST /api/bento/script`\n```json\n{\"session_id\":\"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d\",\"scenario\":\"和领导谈涨薪\",\"tone\":\"professional\",\"constraints\":[\"不引战\",\"清晰边界\"],\"length\":\"short\"}\n```\n\n`POST /api/bento/reflect`\n```json\n{\"period\":\"weekly\",\"reflection_date\":\"2025-12-29\",\"input\":{\"wins\":[\"按计划完成了2分钟习惯\"],\"pain_points\":[\"中途差点放弃\"],\"next_week_focus\":[\"把触发器固定到刷牙后\"]}}\n```\n\n### 7.6 计划（固定 4 个）\n\n`GET /api/plan/list`：返回 `fortune_plan`\n\n`POST /api/plan/join`\n```json\n{\"plan_id\":\"habit_30\",\"start_date\":\"2025-12-29\"}\n```\n\n`POST /api/plan/record`\n```json\n{\"plan_id\":\"habit_30\",\"day_no\":1,\"completed\":true,\"note\":\"完成2分钟版本\"}\n```\n\n### 7.7 偏好与推送\n\n`GET /api/user/preferences`：读取 `fortune_user_preferences`\n\n`PUT /api/user/preferences`\n```json\n{\"persona_style\":\"warm\",\"push_enabled\":true,\"push_time\":\"08:00:00\",\"quiet_hours_start\":\"22:00:00\",\"quiet_hours_end\":\"07:00:00\"}\n```\n\n`POST /api/push/pause`\n```json\n{\"push_enabled\": false}\n```\n\n### 7.8 八字深度报告（backend=cli|gemini）\n\n定位：作为 `工具` Tab 的可选能力（长文报告、阅读模式），不影响主闭环（主闭环用 GLM）。\n\n**边界（DB 使用）**\n- Fortune AI 业务数据与权限控制：`fortune_ai`（本项目所有表）\n- `backend=cli`：调用 `cli_worker` 执行与状态查询（不访问 `gemini` DB）\n- `backend=gemini`：复用现有 gemini job/task 流程（仅此处会访问 `gemini` DB，见 `.env.example` 的 `GEMINI_DB_*`）\n\n**对外 API（绑定登录用户，权限可控）**\n\n`POST /api/report/bazi/submit`\n\n请求：\n```json\n{\"backend\":\"cli\",\"model\":\"deep_research\",\"system_prompt\":\"你是一个八字大师，请以建设性、可执行的方式输出。\"}\n```\n\n行为：\n- 从 `fortune_user` 读取该用户的出生信息（不允许前端随意覆盖）\n- 默认 `backend=cli`：调用 `cli_worker` 执行链路提交与轮询任务\n- 当 `backend=gemini`：调用现有报告引擎（内部仍走 `/api/v2/submit` 与 `task_service.submit_bazi_task_v2` 的逻辑）\n- 在 `fortune_ai` 写入 `fortune_external_job` 记录（user_id ↔ provider_job_id ↔ backend ↔ session_id 可选）\n\n响应：\n```json\n{\"ok\": true, \"data\": {\"job_id\": 101, \"backend\": \"cli\", \"status\": \"processing\"}}\n```\n\n`GET /api/report/bazi/{job_id}?backend=cli|gemini`\n\n响应（processing）：\n```json\n{\"ok\": true, \"data\": {\"job_id\": 101, \"backend\": \"cli\", \"status\": \"processing\"}}\n```\n\n响应（completed）：\n```json\n{\"ok\": true, \"data\": {\"job_id\": 101, \"backend\": \"cli\", \"status\": \"completed\", \"a2ui\": {\"meta\": {\"summary\": \"八字深度报告\"}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": \"### 结论要点\\\\n- 你属于偏火土的结构，做事更适合先定节奏再推进。\\\\n\\\\n### 行动处方（≤3条）\\\\n1) 本周只做一个最小目标（写清楚并公开承诺）\\\\n2) 每天固定一个30分钟深度专注块\\\\n3) 情绪上头时先做3分钟降噪再沟通\"}]}}}\n```\n\n**内部保留接口（不建议前端直接调用）**\n- `POST /api/v2/submit`\n- `GET /api/v2/report/{job_id}`\n\n---\n\n## 8. 主动服务（Push）实现（订阅制、可审计）\n\n### 8.1 触发与频控（固定）\n\n| push_type | 触发 | 频率上限 |\n|---|---|---:|\n| `plan_daily` | 用户加入任一计划后，每日到点 | 每日 1 次 |\n| `weekly_reflection` | 每周固定一天到点 | 每周 1 次 |\n| `milestone` | streak/毕业/关键里程碑 | 达成即推 |\n\n### 8.2 发送规则（执行时检查）\n\n发送前必须同时满足：\n- `fortune_user_preferences.push_enabled = true`\n- 不在静默时段\n- 同类 push 当日未发送过（以 `fortune_push_event` 去重）\n\n---\n\n## 9. 验收（可运行、可统计、可回放）\n\n### 9.1 事件口径（WCG）\n\n| 事件 | 写入表 | 判定 |\n|---|---|---|\n| trigger | `fortune_push_event` / `fortune_conversation_message` | 用户打开/点击/发起 |\n| guidance_shown | `fortune_daily_guidance` / message.a2ui | 已展示 card |\n| commitment_made | `fortune_commitment` | `accepted_at IS NOT NULL` |\n| action_done | `fortune_commitment.status='done'` | 完成 ≥1 |\n| feedback | `fortune_checkin` / `fortune_reflection` | 有打卡/复盘 |\n\n### 9.2 关键验收标准\n\n- 三点击路径全部可走通（今日指引/情绪打卡/决策模板/话术生成）\n- 每次 Chat 输出都有 `commitment_ask` 与可点击 `actions`\n- 任何负面提示都包含“你可以做什么”的行动处方\n- 所有输出可追溯：`facts_hash + kb_refs + rule_ids`\n\n---\n\n## 10. 4 周交付计划（Final MVP）\n\n1) Week 1：PostgreSQL schema（fortune_ai）+ 登录/会话（注册/登录/用户管理）+ 会话/消息 SSOT + `/login`/`/register`/`/main` 路由落地  \n2) Week 2：八字事实完整版（facts + facts_hash）+ 知识库入库脚本（PDF→chunk→PG）+ 检索接口  \n3) Week 3：GLM 对话 `/api/chat/send` + Guidance Card/A2UI 输出 + Bento 6 卡片 API  \n4) Week 4：计划（4 个预设）+ Push 调度器（写 `fortune_push_event`）+ WCG 指标统计与回放  \n","numLines":1313,"startLine":1,"totalLines":1313}}}
{"parentUuid":"412dd364-0985-4f9a-844b-0ffd61360edf","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"59d0d4ba-3ce6-4814-bf5c-2a7e697cdf3e","version":"2.0.74","gitBranch":"","agentId":"a66b687","slug":"inherited-greeting-perlis","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BjJBqLYzZLqhdZVDFfvBBg","type":"message","role":"assistant","content":[{"type":"text","text":"完成。我已深入阅读并理解了这两份文件。现在为您完整总结：\n\n---\n\n## Fortune AI 系统深度总结\n\n### 1. 产品核心价值主张与UX目标\n\n**核心定位**：\n- **系统定义**：AI驱动的\"人生导航/陪伴/提升系统\"（极简且可落地）\n- **精神层面**：基于AI智能体的精神数字孪生——把用户的占星/命理/心理数据量化为可执行的行动系统\n- **UX目标**：用\"陪跑闭环\"替代传统占卜工具的一次性解读\n\n**完整闭环流程**：\n```\nClarify → Insight → Prescription → Commitment → Action → Reflection → Memory Update\n```\n\n**三大价值交付**：\n- **导航**：把问题结构化为Options/Constraints/Risk Boundary/Next Experiment\n- **陪伴**：积极心理学语言承接情绪（不恐吓、不宿命）\n- **提升**：输出可执行行动与30天能力训练轨道\n\n---\n\n### 2. 系统架构设计\n\n**技术三脑架构**（后端核心）：\n\n```\nClient (/main)\n  ↓\nFastAPI\n  ├─ [数学脑] 八字确定性计算（真太阳时校正 + lunar_python排盘）\n  │  └─ facts + facts_hash（唯一事实源）\n  │\n  ├─ [知识脑] PostgreSQL FTS + pg_trgm知识库检索\n  │  └─ kb_refs（可追溯证据链）\n  │\n  └─ [语言脑] GLM (Z.AI/ChatGLM-4) 生成A2UI\n     └─ 积极心理学教练话术 + Guidance Card\n```\n\n**前端布局**（Web /main）：\n```\n┌─────────────────────────────────────┐\n│ Fortune AI | 会话▼| 风格:warm | 设置 │\n├──────────────┬────────────────────────┤\n│ Chat Thread  │ Bento / Workbench     │\n│ (SSOT)       │ Tabs: [Bento][工具]   │\n│              │ 6卡片 + 工具 + 设置   │\n└──────────────┴────────────────────────┘\n```\n\n---\n\n### 3. 当前规划的功能模块\n\n**Bento 6张核心卡片**（1tap启动）：\n| # | 卡片 | 功能 | 交付物 |\n|---|---|---|---|\n| 1 | 今日指引 | 结论+1个动作 | Guidance Card |\n| 2 | 行动处方 | 进行中任务（完成/跳过/复盘） | Task 管理 |\n| 3 | 情绪打卡 | 情绪+强度(0-10) → 调节动作 | Checkin 记录 |\n| 4 | 成长计划 | 4个预设计划 + 30天轨道 | Plan 进度 |\n| 5 | 决策模板 | Decision Brief (Options/Constraints/Risks/Experiment) | 结构化决策 |\n| 6 | 话术生成 | 场景→可复制模板(沟通/边界/拒绝) | 脚本 |\n\n**工具Tab**：\n- 八字深度报告（backend=cli|gemini）\n- 出生校准\n- 铁板神算\n\n**后端功能支撑**：\n- 八字计算（真太阳时校正、四柱、十神、纳音、神煞）\n- 旺衰评分与喜用算法\n- 知识库PDF入库→FTS检索\n- 规则库（旺衰评分、五神煞）\n- 承诺追踪与反依赖机制\n- 推送调度系统\n- 会话与消息SSOT\n\n---\n\n### 4. 用户交互流程设计\n\n**核心原则：三点击原则**（任何核心价值≤3次点击）\n\n**典型交互示例**：\n\n**路径A - 今日指引**：\n```\n打开 /main → 看Bento的\"今日指引\" → 选1个行动按钮（start_task/schedule_task）\n```\n\n**路径B - 情绪管理**：\n```\n点\"情绪打卡\" → 选情绪+强度 → 系统返回1个调节动作+actions\n```\n\n**路径C - 决策**：\n```\n点\"决策模板\" → 填Options/Constraints → GLM生成Decision Brief → 选下一步实验\n```\n\n**反依赖触发机制**（防玄学依赖）：\n| 触发 | 系统响应 |\n|---|---|\n| 连续3次问同一问题 | 强制\"现实行动实验\"后再继续 |\n| 当日咨询>5次 | 提示\"信息足够，先行动\" + 1个最小任务 |\n| 轨道达标毕业 | 主动降频推送 + 引导维护期 |\n\n**Chat交互结构（6步统一）**：\n1. 情绪确认\n2. 结构解释（导航）\n3. 行动处方（≤3条）\n4. 时间窗口（干预窗口）\n5. 风险边界（医疗/法律/投资声明）\n6. 承诺邀请（Commitment Ask）\n\n**承诺类型（4类，必须落到Commitment）**：\n- `start_task`：立刻开始（≤5分钟优先）\n- `schedule_task`：加入今日/本周+设提醒\n- `ask_followup`：选择澄清问题继续\n- `opt_out`：暂停/关闭（出口机制）\n\n---\n\n### 5. UI/UX规范与要求\n\n**语言风格（表达层 persona_style）**：\n- `standard`：清晰、中性、专业\n- `warm`：共情、支持性（默认）\n- `roast`：轻毒舌但不羞辱、不人身定性\n\n**Agent角色优先级**（不可逆）：\n```\nCoach > Teaching Assistant > Customer Support > Sales\n```\n\n**禁止行为**：\n- 禁止恐吓、宿命论断言；负面信息必须紧接\"你可以做什么\"\n- 禁止自行计算八字事实；只能基于提供的facts+evidence\n- 禁止编造经典出处、输出确定性推断\n\n**输出约定**：\n- **统一格式**：A2UI JSON（首组件必须是markdown_text）\n- **必须含**：\n  - `meta.summary`（一句话摘要）\n  - `ui_components[0]`：markdown_text（包含结论/依据/处方/时间窗口/边界/承诺邀请）\n  - `ui_components[1]`：action_buttons（可点击动作）\n  - `evidence`：rule_ids + kb_refs + facts_hash（追溯链）\n\n**视觉设计建议**（来自业务模型）：\n- **审美方向**：新中式赛博 + Y2K酸性设计（镭射质感、毛玻璃效果、传统符箓融合）\n- **成图率优先**：生成的内容应具备高分享价值（满足Z世代审美身份展示需求）\n- **交互效率**：两栏布局极简、会话历史为抽屉/弹层、卡片为内容容器\n\n**移动适配考虑**：\n- 虽然当前设计是Web优先，但Bento卡片与Chat需支持响应式\n- 最小化交互步数（三点击原则）在小屏更关键\n\n**北极星指标**：\n```\nWCG（Weekly Closed-loop Guidance）\n= 用户在一周内完成≥1次\"触发 → 指引 → 行动 → 反馈\"完整闭环\n```\n\n---\n\n## 关键差异化对比\n\n| 维度 | 系统设计最终MVP | 业务模型 |\n|---|---|---|\n| **核心产品** | 极简陪跑闭环（导航/陪伴/提升） | 精神数字孪生 + 游戏化留存 |\n| **架构** | Web纯AI（PostgreSQL+GLM） | TanStack AI + Kerykeion + 社交融合 |\n| **用户获取** | 产品本身（推送/反依赖) | 小红书/TikTok/微信增长飞轮 |\n| **留存机制** | Commitment追踪 + 反依赖触发 | 状态分数(State Score)游戏化 |\n| **变现** | 暂未在MVP中规划 | Freemium + 订阅(Cosmic Pass) + 内购 + 合盘社交 |\n| **核心交付** | Guidance Card + 闭环完成 | State Score + Avatar + 深度报告 |\n\n---\n\n## 实施建议\n\n1. **数据模型**：使用fortune_ai库完全独立，深度报告可选支持backend=cli|gemini\n2. **LLM调用**：GLM强制为SSOT（通过facts_hash保证可追溯），禁止编造\n3. **前端优先级**：先做对话SSOT + Bento 6卡片，再做计划与推送\n4. **验收标准**：三点击路径可走通 + 每次输出都有Commitment Ask + 所有建议可追溯（facts_hash+kb_refs+rule_ids）\n\n这个设计的核心创新是通过\"陪跑闭环\"把占星/命理的模糊性转化为心理教练的确定性行动，同时用反依赖机制防止用户沦为\"玄学依赖者\"。"}],"stop_reason":"end_turn","stop_sequence":null,"usage":{"input_tokens":10948,"cache_creation_input_tokens":28959,"cache_read_input_tokens":18507,"cache_creation":{"ephemeral_5m_input_tokens":28959,"ephemeral_1h_input_tokens":0},"output_tokens":2841,"service_tier":"standard"}},"requestId":"req_011CWcDou6XftEPNATGrUAUv","type":"assistant","uuid":"9637d676-6684-4208-b838-2352780b47d1","timestamp":"2025-12-30T04:14:38.169Z"}
