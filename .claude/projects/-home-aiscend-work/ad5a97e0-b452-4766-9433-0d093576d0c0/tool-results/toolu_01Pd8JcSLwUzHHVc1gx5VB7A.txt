     1→# VibeLife - 资源配置
     2→
     3→> 最后更新: 2026-01-07 | v3.0 Schema 已部署
     4→
     5→---
     6→
     7→## 0. 部署架构
     8→
     9→### 正式部署 (Production)
    10→
    11→```
    12→┌─────────────────────────────────────────────────────────────────────────────┐
    13→│                              用户浏览器                                      │
    14→└─────────────────────────────────┬───────────────────────────────────────────┘
    15→                                  │
    16→                      ┌───────────┴───────────┐
    17→                      │     Cloudflare        │
    18→                      │  (DNS + CDN + SSL)    │
    19→                      │  vibelife.app 域名    │
    20→                      └───────────┬───────────┘
    21→                                  │
    22→          ┌───────────────────────┴───────────────────────┐
    23→          │                                               │
    24→          ▼                                               ▼
    25→┌─────────────────────────────┐           ┌─────────────────────────────────┐
    26→│   Vercel / 阿里云香港        │           │      aiscend 服务器              │
    27→│   (前端)                     │           │      (后端 + 数据库)             │
    28→│                             │           │                                 │
    29→│  vibelife.app        ───────┼───────────┼───► api.vibelife.app            │
    30→│  bazi.vibelife.app          │   HTTPS   │     FastAPI + PostgreSQL        │
    31→│  zodiac.vibelife.app        │   API     │     106.37.170.238              │
    32→│  mbti.vibelife.app          │           │                                 │
    33→└─────────────────────────────┘           └─────────────────────────────────┘
    34→```
    35→
    36→| 组件 | 提供商 | 说明 |
    37→|------|--------|------|
    38→| **域名** | Cloudflare | `vibelife.app` 注册和 DNS 管理 |
    39→| **前端** | Vercel 或 阿里云香港 | Next.js SSR/SSG |
    40→| **后端** | aiscend 服务器 | FastAPI + Docker |
    41→| **数据库** | aiscend 服务器 | PostgreSQL 16 + pgvector |
    42→| **CDN** | Cloudflare | 全球加速 + SSL |
    43→
    44→### 域名规划
    45→
    46→| 域名 | 用途 | 部署位置 |
    47→|------|------|----------|
    48→| `vibelife.app` | 主站 Landing | Vercel/阿里云 |
    49→| `api.vibelife.app` | API 服务 | aiscend |
    50→| `bazi.vibelife.app` | 八字站点 | Vercel/阿里云 |
    51→| `zodiac.vibelife.app` | 星座站点 | Vercel/阿里云 |
    52→| `mbti.vibelife.app` | MBTI 站点 (P1) | Vercel/阿里云 |
    53→| `id.vibelife.app` | Vibe ID 认证中心 | Vercel/阿里云 |
    54→
    55→---
    56→
    57→## 0.1 临时测试部署
    58→
    59→**服务器**: `106.37.170.238` (aiscend)
    60→
    61→| 服务 | 端口 | 访问地址 |
    62→|------|------|----------|
    63→| **API 后端** | 8000 | `http://106.37.170.238:8000` |
    64→| **主站 (vibelife)** | 8230 | `http://106.37.170.238:8230` |
    65→| **八字站 (bazi)** | 8231 | `http://106.37.170.238:8231` |
    66→| **星座站 (zodiac)** | 8232 | `http://106.37.170.238:8232` |
    67→
    68→**测试启动命令**:
    69→```bash
    70→# 后端 API
    71→cd /home/aiscend/work/vibelife/apps/api
    72→export GLM_API_KEY="your-key"
    73→export GLM_CHAT_MODEL="glm-4.7"
    74→export GLM_BASE_URL="https://open.bigmodel.cn/api/paas/v4"
    75→export DEFAULT_LLM_PROVIDER="glm"
    76→export VIBELIFE_DB_URL="postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife"
    77→uvicorn main:app --port 8000 --host 0.0.0.0
    78→
    79→# 主站前端
    80→cd /home/aiscend/work/vibelife/apps/web
    81→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
    82→NEXT_PUBLIC_SITE_ID=vibelife \
    83→pnpm dev --port 8230
    84→
    85→# 八字站前端
    86→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
    87→NEXT_PUBLIC_SITE_ID=bazi \
    88→pnpm dev --port 8231
    89→
    90→# 星座站前端
    91→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
    92→NEXT_PUBLIC_SITE_ID=zodiac \
    93→pnpm dev --port 8232
    94→```
    95→
    96→---
    97→
    98→## 1. 数据库
    99→
   100→**PostgreSQL 16 (aiscend 服务器)** ✅ 已验证
   101→
   102→| 配置项 | 值 |
   103→|--------|-----|
   104→| 主机 | `106.37.170.238` |
   105→| 端口 | `8224` |
   106→| 用户 | `postgres` |
   107→| 密码 | `<REDACTED>` |
   108→| 数据库 | `vibelife` |
   109→| 连接字符串 | `postgresql://postgres:<REDACTED>@106.37.170.238:8224/vibelife` |
   110→
   111→**v3.0 Schema 表 (核心)**:
   112→
   113→| 表名 | 说明 |
   114→|------|------|
   115→| `users` | 用户核心表 (vibe_id) |
   116→| `user_auth` | 认证方式表 (email, phone, wechat, apple, google) |
   117→| `user_profiles` | 用户画像 (JSONB, 版本化) |
   118→| `conversations` | 对话会话 |
   119→| `messages` | 消息记录 |
   120→| `reports` | 生成的报告 |
   121→| `relationships` | 关系分析 |
   122→| `insights` | LLM 生成的洞察 |
   123→| `knowledge_chunks` | 知识库 (pgvector 1024维) |
   124→| `subscription_plans` | 订阅计划 |
   125→| `subscriptions` | 用户订阅 |
   126→| `payments` | 支付记录 |
   127→| `daily_greetings` | 每日问候缓存 |
   128→| `user_events` | 用户事件 |
   129→
   130→**Migration 文件**: `migrations/001_v3_schema.sql`
   131→
   132→## 2. 智谱 GLM (对话/图片)
   133→
   134→**API 控制台**: https://bigmodel.cn/usercenter/equity-mgmt/user-rights
   135→
   136→| 配置项 | 值 |
   137→|--------|-----|
   138→| API Key | `<REDACTED>` (环境变量: `GLM_API_KEY`) |
   139→| 对话模型 | `glm-4.7` ✅ (最新旗舰) |
   140→| 图片理解 | `glm-4.6v` ✅ (最新视觉) |
   141→| Base URL | `https://open.bigmodel.cn/api/paas/v4` |
   142→
   143→**API 文档**: https://docs.bigmodel.cn/cn/guide/models/text/glm-4.7
   144→
   145→**代码支持**: LLM 配置同时支持 `GLM_*` 和 `ZHIPU_*` 环境变量前缀
   146→
   147→## 3. Claude (备选)
   148→
   149→| 配置项 | 值 |
   150→|--------|-----|
   151→| API Key | 需配置 `CLAUDE_API_KEY` |
   152→| 模型 | `claude-3-5-sonnet-20241022` |
   153→
   154→## 4. Embedding (默认 BAAI/bge-m3)
   155→
   156→| 配置项 | 值 |
   157→|--------|-----|
   158→| 默认模型 | `BAAI/bge-m3` |
   159→| 推理 | 本地 SentenceTransformers |
   160→| **维度** | **1024** (pgvector vector) |
   161→| 设备 | `cuda` (GPU 加速) |
   162→
   163→## 5. Pinecone (向量存储 - 可选)
   164→
   165→**控制台**: https://app.pinecone.io/
   166→
   167→| 配置项 | 值 |
   168→|--------|-----|
   169→| API Key | `<REDACTED>` |
   170→| 索引 | `vibelife-knowledge` |
   171→| Host | `mentis-streams-nkchadl.svc.aped-4627-b74a.pinecone.io` |
   172→| 维度 | 1024 |
   173→| Metric | `cosine` |
   174→
   175→## 6. Stripe (支付)
   176→
   177→| 配置项 | 值 |
   178→|--------|-----|
   179→| Secret Key | 需配置 `STRIPE_SECRET_KEY` |
   180→| Publishable Key | 需配置 `STRIPE_PUBLISHABLE_KEY` |
   181→| Webhook Secret | 需配置 `STRIPE_WEBHOOK_SECRET` |
   182→| 控制台 | https://dashboard.stripe.com |
   183→
   184→## 7. 服务分工总览
   185→
   186→| 服务 | 提供商 | 模型/规格 | 状态 |
   187→|------|--------|----------|------|
   188→| 对话生成 | GLM | glm-4.7 | ✅ 已验证 |
   189→| 图片理解 | GLM | glm-4.6v | ✅ 已配置 |
   190→| 向量嵌入 | BGE | BAAI/bge-m3 (1024维) | ✅ 已验证 |
   191→| 向量存储 | PostgreSQL pgvector | 1024维 | ✅ 已验证 |
   192→| 星盘计算 | swisseph | Swiss Ephemeris | ✅ 已配置 |
   193→| 支付 | Stripe | Checkout + Subscription | ⏳ 待配置 |
   194→
   195→## 8. 环境变量
   196→
   197→完整环境变量已配置在 `/home/aiscend/work/vibelife/.env`
   198→
   199→```bash
   200→# ─────────────────────────────────────────────────────────────────
   201→# VIBELIFE 环境变量 (v3.0)
   202→# ─────────────────────────────────────────────────────────────────
   203→
   204→# 数据库
   205→VIBELIFE_DB_URL=postgresql://postgres:<REDACTED>@106.37.170.238:8224/vibelife
   206→
   207→# JWT
   208→VIBELIFE_JWT_SECRET=<REDACTED>
   209→VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
   210→VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30
   211→
   212→# API 配置
   213→VIBELIFE_API_PORT=8000
   214→VIBELIFE_API_HOST=0.0.0.0
   215→VIBELIFE_DEV=1
   216→
   217→# CORS (测试环境)
   218→VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8230,http://106.37.170.238:8231,http://106.37.170.238:8232,http://localhost:3000
   219→
   220→# 智谱 GLM (对话/图片) - 支持 GLM_* 或 ZHIPU_* 前缀
   221→GLM_API_KEY=<REDACTED>
   222→GLM_CHAT_MODEL=glm-4.7
   223→GLM_VISION_MODEL=glm-4.6v
   224→GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
   225→
   226→# Claude (备选)
   227→CLAUDE_API_KEY=your-claude-api-key
   228→
   229→# Embedding (默认 bge-m3)
   230→EMBEDDING_MODEL_NAME=BAAI/bge-m3
   231→EMBEDDING_DIMENSION=1024
   232→EMBEDDING_DEVICE=cuda
   233→EMBEDDING_LOCAL_DIR=/home/aiscend/.cache/vibelife/models/bge-m3
   234→
   235→# Pinecone (可选)
   236→PINECONE_API_KEY=<REDACTED>
   237→PINECONE_HOST=mentis-streams-nkchadl.svc.aped-4627-b74a.pinecone.io
   238→
   239→# 默认 LLM 提供商 (支持 'glm' 或 'zhipu')
   240→DEFAULT_LLM_PROVIDER=glm
   241→
   242→# Stripe
   243→STRIPE_SECRET_KEY=sk_test_xxx
   244→STRIPE_PUBLISHABLE_KEY=pk_test_xxx
   245→STRIPE_WEBHOOK_SECRET=whsec_xxx
   246→
   247→# 前端配置
   248→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000
   249→NEXT_PUBLIC_API_BASE=http://106.37.170.238:8000/api/v1
   250→```
   251→
   252→## 9. API 端点测试结果
   253→
   254→| 端点 | 方法 | 状态 |
   255→|------|------|------|
   256→| `/health` | GET | ✅ 通过 |
   257→| `/api/v1/chat/guest` | POST | ✅ 通过 (LLM 响应) |
   258→| `/api/v1/chat/interview/start` | POST | ✅ 通过 |
   259→| `/api/v1/chat/interview/answer` | POST | ✅ 通过 |
   260→| `/api/v1/fortune/cycles` | GET | ✅ 通过 |
   261→| `/api/v1/fortune/greeting` | POST | ✅ 通过 |
   262→| `/api/v1/fortune/kline` | POST | ✅ 通过 |
   263→| `/api/v1/relationship/analyze` | POST | ✅ 通过 |
   264→| `/api/v1/report/preview` | POST | ✅ 通过 |
   265→
   266→## 10. 启动命令
   267→
   268→### 测试环境 (单机多端口)
   269→
   270→```bash
   271→# 1. 启动后端 API (端口 8000)
   272→cd /home/aiscend/work/vibelife/apps/api
   273→source /home/aiscend/work/vibelife/.env
   274→uvicorn main:app --port 8000 --host 0.0.0.0 --reload
   275→
   276→# 2. 启动主站前端 (端口 8230)
   277→cd /home/aiscend/work/vibelife/apps/web
   278→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 pnpm dev --port 8230
   279→
   280→# 3. 启动八字站 (端口 8231) - 新终端
   281→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
   282→NEXT_PUBLIC_SITE_ID=bazi pnpm dev --port 8231
   283→
   284→# 4. 启动星座站 (端口 8232) - 新终端
   285→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
   286→NEXT_PUBLIC_SITE_ID=zodiac pnpm dev --port 8232
   287→```
   288→
   289→### 健康检查
   290→
   291→```bash
   292→# API
   293→curl http://106.37.170.238:8000/health
   294→
   295→# 主站
   296→curl http://106.37.170.238:8230
   297→
   298→# 八字站
   299→curl http://106.37.170.238:8231
   300→
   301→# 星座站
   302→curl http://106.37.170.238:8232
   303→```
   304→
   305→## 11. 项目结构
   306→
   307→```
   308→/home/aiscend/work/vibelife/
   309→├── apps/
   310→│   ├── api/                     # FastAPI 后端
   311→│   │   ├── main.py              # 应用入口 (74 路由)
   312→│   │   ├── requirements.txt     # Python 依赖
   313→│   │   ├── routes/              # API 路由
   314→│   │   │   ├── auth.py          # 认证
   315→│   │   │   ├── chat.py          # 对话 (核心)
   316→│   │   │   ├── report.py        # 报告生成
   317→│   │   │   ├── fortune.py       # 运势/K-Line
   318→│   │   │   ├── relationship.py  # 关系分析
   319→│   │   │   └── ...
   320→│   │   ├── services/            # 业务服务
   321→│   │   │   ├── vibe_engine/     # 核心 AI 引擎
   322→│   │   │   │   ├── llm.py       # LLM 服务
   323→│   │   │   │   ├── context.py   # 上下文构建
   324→│   │   │   │   └── portrait.py  # 用户画像
   325→│   │   │   ├── interview/       # 访谈系统
   326→│   │   │   ├── report/          # 报告生成
   327→│   │   │   ├── fortune/         # 运势计算
   328→│   │   │   ├── greeting/        # 每日问候
   329→│   │   │   └── relationship/    # 关系分析
   330→│   │   ├── stores/              # 数据存储
   331→│   │   │   ├── db.py            # 数据库连接
   332→│   │   │   ├── conversation_repo.py
   333→│   │   │   ├── message_repo.py
   334→│   │   │   └── profile_repo.py
   335→│   │   └── tools/               # 专业工具
   336→│   │       ├── bazi/            # 八字计算
   337→│   │       └── zodiac/          # 星盘计算
   338→│   │
   339→│   └── web/                     # Next.js 14 前端
   340→│       ├── package.json
   341→│       ├── tailwind.config.ts
   342→│       └── src/
   343→│           ├── app/             # 14 页面路由
   344→│           ├── components/      # 37 组件文件
   345→│           │   ├── core/        # LUMINOUS PAPER 设计系统
   346→│           │   ├── chat/        # 对话组件
   347→│           │   ├── ui/          # UI 基础组件
   348→│           │   └── insight/     # 洞察面板
   349→│           └── lib/             # API 客户端
   350→│
   351→├── migrations/
   352→│   └── 001_v3_schema.sql        # v3.0 数据库 Schema
   353→│
   354→├── deploy/
   355→│   ├── aiscend/                 # 后端部署配置
   356→│   └── aliyun/                  # 前端部署配置
   357→│
   358→├── docs/                        # 文档
   359→│   ├── vibelife spec v3.0.md   # 产品规格
   360→│   ├── config.md               # 本文件
   361→│   └── deployment.md           # 部署指南
   362→│
   363→├── .env                         # 环境变量
   364→└── docker-compose.yml           # 本地开发
   365→```
   366→
   367→## 12. 功能状态
   368→
   369→### P0 (核心功能) - ✅ 已完成
   370→
   371→- [x] 多技能对话系统 (Bazi/Zodiac)
   372→- [x] SSE 流式响应
   373→- [x] 语音模式切换 (温暖/吐槽)
   374→- [x] 智能访谈系统
   375→- [x] 报告生成 (Lite/Full Preview)
   376→- [x] 人生 K-Line 可视化
   377→- [x] 大运周期计算
   378→- [x] 每日问候
   379→- [x] 关系分析 & Vibe Link
   380→- [x] 文件上传提取
   381→
   382→### P1 (待开发)
   383→
   384→- [ ] 主动推送 (Daily Push)
   385→- [ ] Mirror 周/月回顾
   386→- [ ] MBTI 技能
   387→- [ ] 语音交互
   388→
   389→## 13. 下一步
   390→
   391→1. **测试部署**: 在 aiscend 服务器上启动测试环境
   392→2. **域名配置**: Cloudflare 配置 vibelife.app DNS
   393→3. **SSL 证书**: Let's Encrypt 申请证书
   394→4. **正式部署**: 前端部署到 Vercel/阿里云
   395→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
