     1→# VibeLife 部署指南
     2→
     3→> 最后更新: 2026-01-07 | v3.0 已验证
     4→
     5→---
     6→
     7→## 部署架构
     8→
     9→### 正式部署架构 (Production)
    10→
    11→```
    12→┌─────────────────────────────────────────────────────────────────────────────┐
    13→│                              用户浏览器                                      │
    14→└─────────────────────────────────┬───────────────────────────────────────────┘
    15→                                  │
    16→                      ┌───────────┴───────────┐
    17→                      │     Cloudflare        │
    18→                      │  vibelife.app 域名    │
    19→                      │  DNS + CDN + SSL      │
    20→                      └───────────┬───────────┘
    21→                                  │
    22→          ┌───────────────────────┴───────────────────────┐
    23→          │                                               │
    24→          ▼                                               ▼
    25→┌─────────────────────────────┐           ┌─────────────────────────────────┐
    26→│   Vercel / 阿里云香港        │           │      aiscend 服务器              │
    27→│   (前端 - Next.js)          │           │      106.37.170.238             │
    28→│                             │           │                                 │
    29→│  vibelife.app               │   HTTPS   │  api.vibelife.app               │
    30→│  bazi.vibelife.app     ─────┼───────────┼──► FastAPI (port 8000)          │
    31→│  zodiac.vibelife.app        │   API     │     │                           │
    32→│  mbti.vibelife.app          │           │     ▼                           │
    33→│                             │           │  PostgreSQL 16 (port 8224)      │
    34→└─────────────────────────────┘           └─────────────────────────────────┘
    35→```
    36→
    37→### 服务分布
    38→
    39→| 组件 | 位置 | 域名/端口 |
    40→|------|------|-----------|
    41→| 域名管理 | Cloudflare | `vibelife.app` |
    42→| 前端 (Next.js) | Vercel / 阿里云香港 | `vibelife.app`, `bazi.vibelife.app` 等 |
    43→| 后端 (FastAPI) | aiscend 服务器 | `api.vibelife.app` / `106.37.170.238:8000` |
    44→| 数据库 (PostgreSQL 16) | aiscend 服务器 | `106.37.170.238:8224` |
    45→
    46→---
    47→
    48→## 临时测试部署
    49→
    50→在正式域名配置完成前，可使用 IP + 端口方式进行测试。
    51→
    52→### 测试环境配置
    53→
    54→| 服务 | 端口 | 访问地址 |
    55→|------|------|----------|
    56→| **API 后端** | 8000 | `http://106.37.170.238:8000` |
    57→| **主站 (vibelife)** | 8230 | `http://106.37.170.238:8230` |
    58→| **八字站 (bazi)** | 8231 | `http://106.37.170.238:8231` |
    59→| **星座站 (zodiac)** | 8232 | `http://106.37.170.238:8232` |
    60→
    61→### 测试启动命令
    62→
    63→**终端 1 - 后端 API:**
    64→```bash
    65→cd /home/aiscend/work/vibelife/apps/api
    66→
    67→# 设置环境变量
    68→export GLM_API_KEY="your-glm-api-key"
    69→export GLM_CHAT_MODEL="glm-4.7"
    70→export GLM_BASE_URL="https://open.bigmodel.cn/api/paas/v4"
    71→export DEFAULT_LLM_PROVIDER="glm"
    72→export VIBELIFE_DB_URL="postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife"
    73→
    74→# 启动服务
    75→uvicorn main:app --port 8000 --host 0.0.0.0 --reload
    76→```
    77→
    78→**终端 2 - 主站前端:**
    79→```bash
    80→cd /home/aiscend/work/vibelife/apps/web
    81→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
    82→NEXT_PUBLIC_SITE_ID=vibelife \
    83→pnpm dev --port 8230 --hostname 0.0.0.0
    84→```
    85→
    86→**终端 3 - 八字站:**
    87→```bash
    88→cd /home/aiscend/work/vibelife/apps/web
    89→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
    90→NEXT_PUBLIC_SITE_ID=bazi \
    91→pnpm dev --port 8231 --hostname 0.0.0.0
    92→```
    93→
    94→**终端 4 - 星座站:**
    95→```bash
    96→cd /home/aiscend/work/vibelife/apps/web
    97→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000 \
    98→NEXT_PUBLIC_SITE_ID=zodiac \
    99→pnpm dev --port 8232 --hostname 0.0.0.0
   100→```
   101→
   102→### 健康检查
   103→
   104→```bash
   105→# API 健康检查
   106→curl http://106.37.170.238:8000/health
   107→# 期望输出: {"status":"ok","service":"vibelife-api","version":"1.0.0","database":"ok"}
   108→
   109→# API 文档
   110→open http://106.37.170.238:8000/docs
   111→
   112→# 前端站点
   113→curl http://106.37.170.238:8230
   114→curl http://106.37.170.238:8231
   115→curl http://106.37.170.238:8232
   116→```
   117→
   118→---
   119→
   120→## 环境要求
   121→
   122→### 系统要求
   123→- Node.js 18+
   124→- Python 3.11+
   125→- PostgreSQL 16+ (with pgvector extension)
   126→- CUDA (可选，用于 GPU 加速 embedding)
   127→
   128→### 云服务
   129→- Cloudflare (域名 + CDN)
   130→- Stripe 账户 (支付)
   131→- 智谱 API (LLM)
   132→- Pinecone (向量存储，可选)
   133→
   134→---
   135→
   136→## 环境变量配置
   137→
   138→### 后端环境变量 (.env)
   139→
   140→```bash
   141→# ─────────────────────────────────────────────────────────────────
   142→# 数据库
   143→# ─────────────────────────────────────────────────────────────────
   144→VIBELIFE_DB_URL=postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife
   145→VIBELIFE_DB_HOST=106.37.170.238
   146→VIBELIFE_DB_PORT=8224
   147→VIBELIFE_DB_NAME=vibelife
   148→VIBELIFE_DB_USER=postgres
   149→VIBELIFE_DB_PASSWORD=<PASSWORD>
   150→
   151→# ─────────────────────────────────────────────────────────────────
   152→# JWT 认证
   153→# ─────────────────────────────────────────────────────────────────
   154→VIBELIFE_JWT_SECRET=your-jwt-secret-key
   155→VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
   156→VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30
   157→
   158→# ─────────────────────────────────────────────────────────────────
   159→# API 配置
   160→# ─────────────────────────────────────────────────────────────────
   161→VIBELIFE_API_HOST=0.0.0.0
   162→VIBELIFE_API_PORT=8000
   163→VIBELIFE_DEV=1
   164→
   165→# ─────────────────────────────────────────────────────────────────
   166→# CORS (根据部署环境调整)
   167→# ─────────────────────────────────────────────────────────────────
   168→# 测试环境
   169→VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8230,http://106.37.170.238:8231,http://106.37.170.238:8232,http://localhost:3000
   170→
   171→# 正式环境
   172→# VIBELIFE_CORS_ORIGINS=https://vibelife.app,https://bazi.vibelife.app,https://zodiac.vibelife.app
   173→
   174→# ─────────────────────────────────────────────────────────────────
   175→# LLM 服务 - 智谱 GLM (支持 GLM_* 或 ZHIPU_* 前缀)
   176→# ─────────────────────────────────────────────────────────────────
   177→GLM_API_KEY=your-glm-api-key
   178→GLM_CHAT_MODEL=glm-4.7
   179→GLM_VISION_MODEL=glm-4.6v
   180→GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
   181→
   182→# ─────────────────────────────────────────────────────────────────
   183→# Claude (备选)
   184→# ─────────────────────────────────────────────────────────────────
   185→CLAUDE_API_KEY=your-claude-api-key
   186→
   187→# ─────────────────────────────────────────────────────────────────
   188→# Embedding - BAAI/bge-m3 (本地)
   189→# ─────────────────────────────────────────────────────────────────
   190→EMBEDDING_MODEL_NAME=BAAI/bge-m3
   191→EMBEDDING_DIMENSION=1024
   192→EMBEDDING_DEVICE=cuda
   193→
   194→# ─────────────────────────────────────────────────────────────────
   195→# Pinecone (向量存储 - 可选)
   196→# ─────────────────────────────────────────────────────────────────
   197→PINECONE_API_KEY=your-pinecone-api-key
   198→PINECONE_HOST=your-index.pinecone.io
   199→
   200→# ─────────────────────────────────────────────────────────────────
   201→# Stripe 支付
   202→# ─────────────────────────────────────────────────────────────────
   203→STRIPE_SECRET_KEY=sk_live_...
   204→STRIPE_PUBLISHABLE_KEY=pk_live_...
   205→STRIPE_WEBHOOK_SECRET=whsec_...
   206→
   207→# ─────────────────────────────────────────────────────────────────
   208→# 默认 LLM 提供商 (支持 'glm' 或 'zhipu')
   209→# ─────────────────────────────────────────────────────────────────
   210→DEFAULT_LLM_PROVIDER=glm
   211→```
   212→
   213→### 前端环境变量
   214→
   215→```bash
   216→# 测试环境
   217→NEXT_PUBLIC_API_URL=http://106.37.170.238:8000
   218→NEXT_PUBLIC_API_BASE=http://106.37.170.238:8000/api/v1
   219→
   220→# 正式环境
   221→# NEXT_PUBLIC_API_URL=https://api.vibelife.app
   222→# NEXT_PUBLIC_API_BASE=https://api.vibelife.app/api/v1
   223→
   224→# 站点标识 (用于多站点路由)
   225→NEXT_PUBLIC_SITE_ID=vibelife  # 或 bazi, zodiac, mbti
   226→
   227→# Stripe 公钥
   228→NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_xxx
   229→```
   230→
   231→---
   232→
   233→## 数据库初始化
   234→
   235→### 运行 v3.0 Schema 迁移
   236→
   237→```bash
   238→# 连接数据库
   239→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife
   240→
   241→# 运行迁移
   242→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
   243→  -f /home/aiscend/work/vibelife/migrations/001_v3_schema.sql
   244→```
   245→
   246→### 验证表创建
   247→
   248→```bash
   249→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
   250→  -c "SELECT tablename FROM pg_tables WHERE schemaname = 'public' ORDER BY tablename;"
   251→```
   252→
   253→期望输出 (核心表):
   254→- `users`, `user_auth`, `user_profiles`
   255→- `conversations`, `messages`
   256→- `reports`, `relationships`, `insights`
   257→- `knowledge_chunks`
   258→- `subscription_plans`, `subscriptions`, `payments`
   259→- `daily_greetings`, `user_events`
   260→
   261→---
   262→
   263→## 后端部署 (aiscend 服务器)
   264→
   265→### 方式一: 直接运行
   266→
   267→```bash
   268→cd /home/aiscend/work/vibelife/apps/api
   269→
   270→# 安装依赖
   271→pip install -r requirements.txt
   272→
   273→# 设置环境变量
   274→export GLM_API_KEY="your-key"
   275→export GLM_CHAT_MODEL="glm-4.7"
   276→export GLM_BASE_URL="https://open.bigmodel.cn/api/paas/v4"
   277→export DEFAULT_LLM_PROVIDER="glm"
   278→export VIBELIFE_DB_URL="postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife"
   279→
   280→# 启动服务
   281→uvicorn main:app --port 8000 --host 0.0.0.0
   282→```
   283→
   284→### 方式二: Docker 部署
   285→
   286→```bash
   287→cd /home/aiscend/work/vibelife/deploy/aiscend
   288→
   289→# 配置环境变量
   290→cp .env.example .env
   291→vim .env
   292→
   293→# 启动
   294→docker-compose up -d
   295→
   296→# 查看日志
   297→docker-compose logs -f api
   298→```
   299→
   300→### 方式三: Systemd 服务
   301→
   302→创建 `/etc/systemd/system/vibelife-api.service`:
   303→
   304→```ini
   305→[Unit]
   306→Description=VibeLife API
   307→After=network.target
   308→
   309→[Service]
   310→Type=simple
   311→User=aiscend
   312→WorkingDirectory=/home/aiscend/work/vibelife/apps/api
   313→EnvironmentFile=/home/aiscend/work/vibelife/.env
   314→ExecStart=/usr/bin/python3 -m uvicorn main:app --port 8000 --host 0.0.0.0
   315→Restart=always
   316→RestartSec=10
   317→
   318→[Install]
   319→WantedBy=multi-user.target
   320→```
   321→
   322→```bash
   323→sudo systemctl daemon-reload
   324→sudo systemctl enable vibelife-api
   325→sudo systemctl start vibelife-api
   326→sudo systemctl status vibelife-api
   327→```
   328→
   329→---
   330→
   331→## 前端部署
   332→
   333→### 前端构建
   334→
   335→```bash
   336→cd /home/aiscend/work/vibelife/apps/web
   337→
   338→# 安装依赖
   339→pnpm install
   340→
   341→# 构建
   342→pnpm build
   343→
   344→# 期望输出:
   345→# ✓ Generating static pages (14/14)
   346→# ✓ 编译成功
   347→```
   348→
   349→### 方式一: Vercel (推荐)
   350→
   351→1. 连接 GitHub 仓库到 Vercel
   352→2. 配置项目:
   353→   - Root Directory: `apps/web`
   354→   - Framework: Next.js
   355→   - Build Command: `pnpm build`
   356→
   357→3. 配置环境变量:
   358→   ```
   359→   NEXT_PUBLIC_API_URL=https://api.vibelife.app
   360→   NEXT_PUBLIC_API_BASE=https://api.vibelife.app/api/v1
   361→   ```
   362→
   363→4. 配置域名:
   364→   - `vibelife.app` → 主站
   365→   - `bazi.vibelife.app` → 八字站
   366→   - `zodiac.vibelife.app` → 星座站
   367→
   368→### 方式二: 阿里云香港 ECS
   369→
   370→```bash
   371→# 安装 Node.js
   372→curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
   373→sudo apt install -y nodejs
   374→
   375→# 安装 pnpm
   376→npm install -g pnpm
   377→
   378→# 部署
   379→cd /home/aiscend/work/vibelife/apps/web
   380→pnpm install
   381→pnpm build
   382→pnpm start --port 3000
   383→```
   384→
   385→---
   386→
   387→## DNS 配置 (Cloudflare)
   388→
   389→| 记录类型 | 名称 | 内容 | 代理状态 |
   390→|----------|------|------|----------|
   391→| A | api | 106.37.170.238 | DNS only |
   392→| CNAME | @ | cname.vercel-dns.com | Proxied |
   393→| CNAME | bazi | cname.vercel-dns.com | Proxied |
   394→| CNAME | zodiac | cname.vercel-dns.com | Proxied |
   395→| CNAME | mbti | cname.vercel-dns.com | Proxied |
   396→
   397→---
   398→
   399→## API 端点验证
   400→
   401→部署完成后，验证以下核心端点:
   402→
   403→```bash
   404→# 1. 健康检查
   405→curl http://localhost:8000/health
   406→
   407→# 2. Guest Chat
   408→curl -X POST http://localhost:8000/api/v1/chat/guest \
   409→  -H "Content-Type: application/json" \
   410→  -d '{"message": "你好", "skill": "bazi"}'
   411→
   412→# 3. Interview
   413→curl -X POST http://localhost:8000/api/v1/chat/interview/start \
   414→  -H "Content-Type: application/json" \
   415→  -d '{"skill": "bazi"}'
   416→
   417→# 4. Fortune Cycles
   418→curl "http://localhost:8000/api/v1/fortune/cycles?birth_year=1990&day_master_element=wood&gender=male"
   419→
   420→# 5. Daily Greeting
   421→curl -X POST http://localhost:8000/api/v1/fortune/greeting \
   422→  -H "Content-Type: application/json" \
   423→  -d '{"profile": {"basic": {}}, "voice_mode": "warm"}'
   424→```
   425→
   426→---
   427→
   428→## 监控与日志
   429→
   430→### 健康检查
   431→
   432→```bash
   433→# API
   434→curl http://106.37.170.238:8000/health
   435→# 或正式环境
   436→curl https://api.vibelife.app/health
   437→```
   438→
   439→### 日志查看
   440→
   441→```bash
   442→# Docker 日志
   443→docker logs -f vibelife-api
   444→
   445→# Systemd 日志
   446→journalctl -u vibelife-api -f
   447→
   448→# 直接运行时
   449→# 日志输出在终端
   450→```
   451→
   452→---
   453→
   454→## 故障排查
   455→
   456→### 1. API 无法访问
   457→
   458→```bash
   459→# 检查进程
   460→ps aux | grep uvicorn
   461→
   462→# 检查端口
   463→netstat -tlnp | grep 8000
   464→
   465→# 检查防火墙
   466→sudo ufw status
   467→```
   468→
   469→### 2. 数据库连接失败
   470→
   471→```bash
   472→# 测试连接
   473→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife -c "SELECT 1"
   474→
   475→# 检查 PostgreSQL 状态
   476→systemctl status postgresql
   477→```
   478→
   479→### 3. LLM 调用失败
   480→
   481→```bash
   482→# 检查环境变量
   483→echo $GLM_API_KEY
   484→echo $GLM_CHAT_MODEL
   485→
   486→# 测试 API Key
   487→curl -X POST https://open.bigmodel.cn/api/paas/v4/chat/completions \
   488→  -H "Authorization: Bearer $GLM_API_KEY" \
   489→  -H "Content-Type: application/json" \
   490→  -d '{"model": "glm-4.7", "messages": [{"role": "user", "content": "hello"}]}'
   491→```
   492→
   493→### 4. 前端无法调用 API
   494→
   495→- 检查 CORS 配置是否包含前端域名
   496→- 检查 `NEXT_PUBLIC_API_URL` 是否正确
   497→- 查看浏览器 Network 面板的错误信息
   498→- 确保 API 服务器在运行
   499→
   500→### 5. TypeScript 构建错误
   501→
   502→```bash
   503→# 清理缓存
   504→cd /home/aiscend/work/vibelife/apps/web
   505→rm -rf .next
   506→pnpm build
   507→```
   508→
   509→---
   510→
   511→## 安全建议
   512→
   513→1. **API 密钥**: 使用环境变量，不要提交到代码库
   514→2. **HTTPS**: 正式环境必须使用 HTTPS (Cloudflare 提供)
   515→3. **CORS**: 限制允许的来源域名
   516→4. **防火墙**: 只开放必要端口 (8000, 8224)
   517→5. **日志脱敏**: 不要记录敏感信息
   518→6. **定期更新**: 保持依赖包更新
   519→7. **数据库**: 使用强密码，限制访问 IP
   520→
   521→---
   522→
   523→## 版本历史
   524→
   525→| 版本 | 日期 | 说明 |
   526→|------|------|------|
   527→| v3.0 | 2026-01-07 | Schema v3.0, LLM 配置优化, 前端 Suspense 修复 |
   528→| v2.0 | 2026-01-05 | 初始部署配置 |
   529→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
