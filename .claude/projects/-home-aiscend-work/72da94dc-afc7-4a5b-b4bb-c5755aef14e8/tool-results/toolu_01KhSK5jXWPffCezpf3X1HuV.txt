     1→"use client";
     2→
     3→import { useState, useRef, useEffect } from "react";
     4→import { ChatMessage } from "./ChatMessage";
     5→import { ChatInput } from "./ChatInput";
     6→import { getTokens, sendGuestMessage, sendMessage, ChatResponse } from "@/lib/api";
     7→
     8→interface Message {
     9→  id: string;
    10→  role: "user" | "assistant";
    11→  content: string;
    12→  timestamp?: string;
    13→}
    14→
    15→export interface ChatContainerProps {
    16→  skillId: string;
    17→  conversationId?: string;
    18→  onConversationStart?: (id: string) => void;
    19→}
    20→
    21→export function ChatContainer({ skillId, conversationId, onConversationStart }: ChatContainerProps) {
    22→  const [messages, setMessages] = useState<Message[]>([]);
    23→  const [isLoading, setIsLoading] = useState(false);
    24→  const [currentConvoId, setCurrentConvoId] = useState(conversationId);
    25→  const messagesEndRef = useRef<HTMLDivElement>(null);
    26→
    27→  const scrollToBottom = () => {
    28→    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    29→  };
    30→
    31→  useEffect(() => {
    32→    scrollToBottom();
    33→  }, [messages]);
    34→
    35→  const handleSend = async (content: string) => {
    36→    // Add user message
    37→    const userMessage: Message = {
    38→      id: Date.now().toString(),
    39→      role: "user",
    40→      content,
    41→      timestamp: new Date().toLocaleTimeString(),
    42→    };
    43→    setMessages((prev) => [...prev, userMessage]);
    44→    setIsLoading(true);
    45→
    46→    try {
    47→      const { accessToken } = getTokens();
    48→
    49→      if (accessToken) {
    50→        const response: ChatResponse = await sendMessage({
    51→          message: content,
    52→          skill_id: skillId,
    53→          conversation_id: currentConvoId,
    54→        });
    55→
    56→        // Update conversation ID
    57→        if (!currentConvoId && response.conversation_id) {
    58→          setCurrentConvoId(response.conversation_id);
    59→          onConversationStart?.(response.conversation_id);
    60→        }
    61→
    62→        // Add assistant message
    63→        const assistantMessage: Message = {
    64→          id: (Date.now() + 1).toString(),
    65→          role: "assistant",
    66→          content: response.content,
    67→          timestamp: new Date().toLocaleTimeString(),
    68→        };
    69→        setMessages((prev) => [...prev, assistantMessage]);
    70→      } else {
    71→        // Guest mode: use the public endpoint for progressive disclosure
    72→        const response = await sendGuestMessage(content, skillId);
    73→        const assistantMessage: Message = {
    74→          id: (Date.now() + 1).toString(),
    75→          role: "assistant",
    76→          content: response.content,
    77→          timestamp: new Date().toLocaleTimeString(),
    78→        };
    79→        setMessages((prev) => [...prev, assistantMessage]);
    80→
    81→        if (response.suggestion) {
    82→          setMessages((prev) => [
    83→            ...prev,
    84→            {
    85→              id: (Date.now() + 2).toString(),
    86→              role: "assistant",
    87→              content: response.suggestion,
    88→              timestamp: new Date().toLocaleTimeString(),
    89→            },
    90→          ]);
    91→        }
    92→      }
    93→    } catch (error) {
    94→      console.error("Chat error:", error);
    95→      // Add error message
    96→      setMessages((prev) => [...prev, {
    97→        id: (Date.now() + 1).toString(),
    98→        role: "assistant",
    99→        content: "抱歉，出了点问题。请稍后再试。",
   100→      }]);
   101→    } finally {
   102→      setIsLoading(false);
   103→    }
   104→  };
   105→
   106→  return (
   107→    <div className="flex flex-col h-full">
   108→      {/* Messages */}
   109→      <div className="flex-1 overflow-y-auto p-4">
   110→        {messages.length === 0 && (
   111→          <div className="text-center text-gray-500 py-12">
   112→            <p className="text-lg mb-2">开始对话吧</p>
   113→            <p className="text-sm">有什么我可以帮到你的？</p>
   114→          </div>
   115→        )}
   116→        {messages.map((message) => (
   117→          <ChatMessage
   118→            key={message.id}
   119→            role={message.role}
   120→            content={message.content}
   121→            timestamp={message.timestamp}
   122→          />
   123→        ))}
   124→        {isLoading && (
   125→          <ChatMessage
   126→            role="assistant"
   127→            content=""
   128→            isStreaming
   129→          />
   130→        )}
   131→        <div ref={messagesEndRef} />
   132→      </div>
   133→
   134→      {/* Input */}
   135→      <ChatInput onSend={handleSend} disabled={isLoading} />
   136→    </div>
   137→  );
   138→}
   139→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
