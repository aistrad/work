     1→-- ═══════════════════════════════════════════════════════════════
     2→-- VIBELIFE DATABASE SCHEMA - INITIAL MIGRATION
     3→-- Version: 001
     4→-- Description: Core tables for Vibe ID and Skill system
     5→-- ═══════════════════════════════════════════════════════════════
     6→
     7→-- Enable extensions
     8→CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
     9→CREATE EXTENSION IF NOT EXISTS "vector";
    10→
    11→-- ─────────────────────────────────────────────────────────────────
    12→-- VIBE ID TABLES
    13→-- ─────────────────────────────────────────────────────────────────
    14→
    15→-- Users core table
    16→CREATE TABLE IF NOT EXISTS vibe_users (
    17→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    18→    vibe_id VARCHAR(20) UNIQUE NOT NULL,
    19→    display_name VARCHAR(100),
    20→    avatar_url VARCHAR(500),
    21→    birth_datetime TIMESTAMPTZ,
    22→    birth_location VARCHAR(255),
    23→    birth_location_coords POINT,
    24→    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    25→    language VARCHAR(10) DEFAULT 'zh-CN',
    26→    status VARCHAR(20) DEFAULT 'active',
    27→    email_verified BOOLEAN DEFAULT false,
    28→    phone_verified BOOLEAN DEFAULT false,
    29→    created_at TIMESTAMPTZ DEFAULT NOW(),
    30→    updated_at TIMESTAMPTZ DEFAULT NOW()
    31→);
    32→
    33→-- User authentication methods
    34→CREATE TABLE IF NOT EXISTS vibe_user_auth (
    35→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    36→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    37→    auth_type VARCHAR(20) NOT NULL,  -- 'email', 'phone', 'wechat', 'apple', 'google'
    38→    auth_identifier VARCHAR(255) NOT NULL,
    39→    auth_credential TEXT,
    40→    created_at TIMESTAMPTZ DEFAULT NOW(),
    41→    UNIQUE(auth_type, auth_identifier)
    42→);
    43→
    44→-- Data sharing consent
    45→CREATE TABLE IF NOT EXISTS vibe_data_consents (
    46→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    47→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    48→    source_skill VARCHAR(50) NOT NULL,
    49→    target_skill VARCHAR(50) NOT NULL,
    50→    data_type VARCHAR(50) NOT NULL,
    51→    consent_granted BOOLEAN DEFAULT false,
    52→    granted_at TIMESTAMPTZ,
    53→    revoked_at TIMESTAMPTZ,
    54→    UNIQUE(user_id, source_skill, target_skill, data_type)
    55→);
    56→
    57→-- ─────────────────────────────────────────────────────────────────
    58→-- SKILL DATA TABLES
    59→-- ─────────────────────────────────────────────────────────────────
    60→
    61→-- Skill profiles (per user per skill)
    62→CREATE TABLE IF NOT EXISTS skill_profiles (
    63→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    64→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    65→    skill_id VARCHAR(50) NOT NULL,
    66→    profile_data JSONB NOT NULL DEFAULT '{}',
    67→    first_use_at TIMESTAMPTZ DEFAULT NOW(),
    68→    last_use_at TIMESTAMPTZ DEFAULT NOW(),
    69→    total_sessions INTEGER DEFAULT 0,
    70→    UNIQUE(user_id, skill_id)
    71→);
    72→
    73→-- Conversations
    74→CREATE TABLE IF NOT EXISTS skill_conversations (
    75→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    76→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    77→    skill_id VARCHAR(50) NOT NULL,
    78→    started_at TIMESTAMPTZ DEFAULT NOW(),
    79→    ended_at TIMESTAMPTZ,
    80→    message_count INTEGER DEFAULT 0,
    81→    entry_point VARCHAR(50),
    82→    referrer VARCHAR(255),
    83→    status VARCHAR(20) DEFAULT 'active'
    84→);
    85→
    86→-- Messages
    87→CREATE TABLE IF NOT EXISTS skill_messages (
    88→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    89→    conversation_id UUID REFERENCES skill_conversations(id) ON DELETE CASCADE,
    90→    role VARCHAR(20) NOT NULL,
    91→    content TEXT NOT NULL,
    92→    intent VARCHAR(100),
    93→    tools_used VARCHAR(100)[],
    94→    knowledge_used VARCHAR(100)[],
    95→    insight_generated BOOLEAN DEFAULT false,
    96→    insight_id UUID,
    97→    created_at TIMESTAMPTZ DEFAULT NOW()
    98→);
    99→
   100→-- Insights
   101→CREATE TABLE IF NOT EXISTS skill_insights (
   102→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   103→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
   104→    skill_id VARCHAR(50) NOT NULL,
   105→    conversation_id UUID REFERENCES skill_conversations(id),
   106→    insight_type VARCHAR(50) NOT NULL,  -- 'discovery', 'pattern', 'timing', 'growth'
   107→    title VARCHAR(255),
   108→    content TEXT NOT NULL,
   109→    evidence JSONB,
   110→    confidence FLOAT,
   111→    user_reaction VARCHAR(20),  -- 'helpful', 'not_helpful', 'saved'
   112→    created_at TIMESTAMPTZ DEFAULT NOW()
   113→);
   114→
   115→-- ─────────────────────────────────────────────────────────────────
   116→-- SUBSCRIPTION TABLES
   117→-- ─────────────────────────────────────────────────────────────────
   118→
   119→-- Subscription plans
   120→CREATE TABLE IF NOT EXISTS subscription_plans (
   121→    id VARCHAR(50) PRIMARY KEY,
   122→    name VARCHAR(100) NOT NULL,
   123→    plan_type VARCHAR(20) NOT NULL,  -- 'skill_single', 'skill_bundle', 'vibelife_all'
   124→    skill_ids VARCHAR(50)[],
   125→    price_monthly INTEGER,
   126→    price_yearly INTEGER,
   127→    currency VARCHAR(10) DEFAULT 'CNY',
   128→    features JSONB,
   129→    is_active BOOLEAN DEFAULT true
   130→);
   131→
   132→-- User subscriptions
   133→CREATE TABLE IF NOT EXISTS user_subscriptions (
   134→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   135→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
   136→    plan_id VARCHAR(50) REFERENCES subscription_plans(id),
   137→    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'cancelled', 'expired'
   138→    started_at TIMESTAMPTZ DEFAULT NOW(),
   139→    current_period_end TIMESTAMPTZ,
   140→    cancelled_at TIMESTAMPTZ,
   141→    payment_provider VARCHAR(50),
   142→    payment_subscription_id VARCHAR(255),
   143→    source_skill VARCHAR(50),
   144→    source_campaign VARCHAR(100)
   145→);
   146→
   147→-- ─────────────────────────────────────────────────────────────────
   148→-- KNOWLEDGE TABLES
   149→-- ─────────────────────────────────────────────────────────────────
   150→
   151→-- Knowledge chunks (with vector embedding)
   152→CREATE TABLE IF NOT EXISTS knowledge_chunks (
   153→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   154→    skill_id VARCHAR(50) NOT NULL,
   155→    source_file VARCHAR(255),
   156→    source_section VARCHAR(255),
   157→    content TEXT NOT NULL,
   158→    content_type VARCHAR(50),  -- 'theory', 'pattern', 'case', 'qa'
   159→    metadata JSONB,
   160→    embedding vector(3072),  -- Gemini embedding dimension
   161→    search_vector TSVECTOR,
   162→    created_at TIMESTAMPTZ DEFAULT NOW()
   163→);
   164→
   165→-- QA pairs
   166→CREATE TABLE IF NOT EXISTS knowledge_qa_pairs (
   167→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   168→    skill_id VARCHAR(50) NOT NULL,
   169→    chunk_id UUID REFERENCES knowledge_chunks(id),
   170→    question TEXT NOT NULL,
   171→    answer TEXT NOT NULL,
   172→    question_embedding vector(3072),
   173→    verified BOOLEAN DEFAULT false,
   174→    usage_count INTEGER DEFAULT 0,
   175→    helpfulness_score FLOAT
   176→);
   177→
   178→-- ─────────────────────────────────────────────────────────────────
   179→-- REMINDER TABLES
   180→-- ─────────────────────────────────────────────────────────────────
   181→
   182→-- Fortune events calendar
   183→CREATE TABLE IF NOT EXISTS fortune_events (
   184→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   185→    event_type VARCHAR(50) NOT NULL,
   186→    name VARCHAR(100) NOT NULL,
   187→    start_date DATE NOT NULL,
   188→    end_date DATE,
   189→    event_data JSONB,
   190→    created_at TIMESTAMPTZ DEFAULT NOW()
   191→);
   192→
   193→-- Reminder settings per user
   194→CREATE TABLE IF NOT EXISTS reminder_settings (
   195→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   196→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
   197→    bazi_month_enabled BOOLEAN DEFAULT true,
   198→    bazi_month_advance_days INTEGER DEFAULT 2,
   199→    bazi_year_enabled BOOLEAN DEFAULT true,
   200→    bazi_year_advance_days INTEGER DEFAULT 5,
   201→    mercury_retrograde_enabled BOOLEAN DEFAULT true,
   202→    mercury_retrograde_advance_days INTEGER DEFAULT 3,
   203→    weekly_fortune_enabled BOOLEAN DEFAULT false,
   204→    weekly_fortune_time VARCHAR(10) DEFAULT '20:00',
   205→    quiet_start_time VARCHAR(10) DEFAULT '22:00',
   206→    quiet_end_time VARCHAR(10) DEFAULT '08:00',
   207→    in_app_enabled BOOLEAN DEFAULT true,
   208→    push_enabled BOOLEAN DEFAULT true,
   209→    wechat_enabled BOOLEAN DEFAULT false,
   210→    UNIQUE(user_id)
   211→);
   212→
   213→-- User notifications
   214→CREATE TABLE IF NOT EXISTS user_notifications (
   215→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   216→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
   217→    notification_type VARCHAR(50) NOT NULL,
   218→    title VARCHAR(255),
   219→    content TEXT,
   220→    read BOOLEAN DEFAULT false,
   221→    created_at TIMESTAMPTZ DEFAULT NOW()
   222→);
   223→
   224→-- ─────────────────────────────────────────────────────────────────
   225→-- INDEXES
   226→-- ─────────────────────────────────────────────────────────────────
   227→
   228→CREATE INDEX IF NOT EXISTS idx_vibe_users_vibe_id ON vibe_users(vibe_id);
   229→CREATE INDEX IF NOT EXISTS idx_vibe_users_status ON vibe_users(status);
   230→CREATE INDEX IF NOT EXISTS idx_vibe_user_auth_user ON vibe_user_auth(user_id);
   231→CREATE INDEX IF NOT EXISTS idx_vibe_user_auth_type ON vibe_user_auth(auth_type, auth_identifier);
   232→
   233→CREATE INDEX IF NOT EXISTS idx_skill_profiles_user ON skill_profiles(user_id);
   234→CREATE INDEX IF NOT EXISTS idx_skill_profiles_skill ON skill_profiles(skill_id);
   235→CREATE INDEX IF NOT EXISTS idx_skill_conversations_user ON skill_conversations(user_id, skill_id);
   236→CREATE INDEX IF NOT EXISTS idx_skill_conversations_status ON skill_conversations(status);
   237→CREATE INDEX IF NOT EXISTS idx_skill_messages_convo ON skill_messages(conversation_id);
   238→CREATE INDEX IF NOT EXISTS idx_skill_messages_created ON skill_messages(created_at DESC);
   239→CREATE INDEX IF NOT EXISTS idx_skill_insights_user ON skill_insights(user_id, skill_id);
   240→CREATE INDEX IF NOT EXISTS idx_skill_insights_type ON skill_insights(insight_type);
   241→
   242→CREATE INDEX IF NOT EXISTS idx_user_subscriptions_user ON user_subscriptions(user_id);
   243→CREATE INDEX IF NOT EXISTS idx_user_subscriptions_status ON user_subscriptions(status);
   244→
   245→CREATE INDEX IF NOT EXISTS idx_knowledge_chunks_skill ON knowledge_chunks(skill_id);
   246→CREATE INDEX IF NOT EXISTS idx_knowledge_chunks_type ON knowledge_chunks(content_type);
   247→CREATE INDEX IF NOT EXISTS idx_knowledge_chunks_search ON knowledge_chunks USING GIN(search_vector);
   248→
   249→CREATE INDEX IF NOT EXISTS idx_fortune_events_date ON fortune_events(start_date);
   250→CREATE INDEX IF NOT EXISTS idx_fortune_events_type ON fortune_events(event_type);
   251→CREATE INDEX IF NOT EXISTS idx_user_notifications_user ON user_notifications(user_id, created_at DESC);
   252→CREATE INDEX IF NOT EXISTS idx_user_notifications_read ON user_notifications(user_id, read);
   253→
   254→-- ─────────────────────────────────────────────────────────────────
   255→-- TRIGGER: Auto-update updated_at
   256→-- ─────────────────────────────────────────────────────────────────
   257→
   258→CREATE OR REPLACE FUNCTION update_updated_at_column()
   259→RETURNS TRIGGER AS $$
   260→BEGIN
   261→    NEW.updated_at = NOW();
   262→    RETURN NEW;
   263→END;
   264→$$ language 'plpgsql';
   265→
   266→CREATE TRIGGER update_vibe_users_updated_at
   267→    BEFORE UPDATE ON vibe_users
   268→    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
   269→
   270→-- ─────────────────────────────────────────────────────────────────
   271→-- SEED DATA: Subscription Plans
   272→-- ─────────────────────────────────────────────────────────────────
   273→
   274→INSERT INTO subscription_plans (id, name, plan_type, skill_ids, price_monthly, price_yearly, features, is_active)
   275→VALUES
   276→    ('free', '免费版', 'free', NULL, 0, 0, '{"daily_questions": 3, "basic_analysis": true}', true),
   277→    ('bazi_pro', '八字会员', 'skill_single', ARRAY['bazi'], 29, 199, '{"unlimited_questions": true, "deep_analysis": true, "monthly_report": true}', true),
   278→    ('zodiac_pro', '星座会员', 'skill_single', ARRAY['zodiac'], 29, 199, '{"unlimited_questions": true, "weekly_report": true, "transit_alerts": true}', true),
   279→    ('mbti_pro', 'MBTI会员', 'skill_single', ARRAY['mbti'], 29, 199, '{"unlimited_questions": true, "deep_analysis": true, "compatibility": true}', true),
   280→    ('vibelife_all', 'VibeLife 全能', 'vibelife_all', ARRAY['bazi', 'zodiac', 'mbti'], 59, 399, '{"all_skills": true, "cross_skill_insights": true, "priority_support": true}', true)
   281→ON CONFLICT (id) DO NOTHING;
   282→
   283→-- Done
   284→SELECT 'VibeLife schema initialized successfully' as result;
   285→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
