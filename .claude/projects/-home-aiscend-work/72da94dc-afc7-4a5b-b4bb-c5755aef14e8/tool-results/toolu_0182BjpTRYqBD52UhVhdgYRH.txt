     1→/**
     2→ * VibeLife API Client
     3→ */
     4→
     5→const API_BASE = process.env.NEXT_PUBLIC_API_BASE || "http://localhost:8000/api/v1";
     6→
     7→// ─────────────────────────────────────────────────────────────────
     8→// Types
     9→// ─────────────────────────────────────────────────────────────────
    10→
    11→export interface TokenResponse {
    12→  access_token: string;
    13→  refresh_token: string;
    14→  token_type: string;
    15→  expires_in: number;
    16→  user: {
    17→    user_id: string;
    18→    vibe_id: string;
    19→    display_name?: string;
    20→  };
    21→}
    22→
    23→export interface ChatRequest {
    24→  message: string;
    25→  skill_id: string;
    26→  conversation_id?: string;
    27→}
    28→
    29→export interface ChatResponse {
    30→  content: string;
    31→  conversation_id: string;
    32→  intent?: string;
    33→  tools_used?: string[];
    34→  knowledge_used: boolean;
    35→  insight?: {
    36→    id: string;
    37→    insight_type: string;
    38→    title: string;
    39→    content: string;
    40→  };
    41→  suggestions?: string[];
    42→}
    43→
    44→// ─────────────────────────────────────────────────────────────────
    45→// Token Management
    46→// ─────────────────────────────────────────────────────────────────
    47→
    48→let accessToken: string | null = null;
    49→let refreshToken: string | null = null;
    50→
    51→export function setTokens(access: string, refresh: string) {
    52→  accessToken = access;
    53→  refreshToken = refresh;
    54→  if (typeof window !== "undefined") {
    55→    localStorage.setItem("access_token", access);
    56→    localStorage.setItem("refresh_token", refresh);
    57→  }
    58→}
    59→
    60→export function getTokens() {
    61→  if (typeof window !== "undefined") {
    62→    accessToken = localStorage.getItem("access_token");
    63→    refreshToken = localStorage.getItem("refresh_token");
    64→  }
    65→  return { accessToken, refreshToken };
    66→}
    67→
    68→export function clearTokens() {
    69→  accessToken = null;
    70→  refreshToken = null;
    71→  if (typeof window !== "undefined") {
    72→    localStorage.removeItem("access_token");
    73→    localStorage.removeItem("refresh_token");
    74→    localStorage.removeItem("user");
    75→  }
    76→}
    77→
    78→// ─────────────────────────────────────────────────────────────────
    79→// API Helpers
    80→// ─────────────────────────────────────────────────────────────────
    81→
    82→async function fetchAPI(
    83→  endpoint: string,
    84→  options: RequestInit = {}
    85→): Promise<Response> {
    86→  const { accessToken } = getTokens();
    87→
    88→  const headers: Record<string, string> = {
    89→    "Content-Type": "application/json",
    90→    ...options.headers as Record<string, string>,
    91→  };
    92→
    93→  if (accessToken) {
    94→    headers["Authorization"] = `Bearer ${accessToken}`;
    95→  }
    96→
    97→  const response = await fetch(`${API_BASE}${endpoint}`, {
    98→    ...options,
    99→    headers,
   100→  });
   101→
   102→  // Handle 401 - try to refresh token
   103→  if (response.status === 401 && refreshToken) {
   104→    const refreshed = await refreshAccessToken();
   105→    if (refreshed) {
   106→      headers["Authorization"] = `Bearer ${accessToken}`;
   107→      return fetch(`${API_BASE}${endpoint}`, { ...options, headers });
   108→    }
   109→  }
   110→
   111→  return response;
   112→}
   113→
   114→async function refreshAccessToken(): Promise<boolean> {
   115→  try {
   116→    const response = await fetch(`${API_BASE}/auth/refresh`, {
   117→      method: "POST",
   118→      headers: { "Content-Type": "application/json" },
   119→      body: JSON.stringify({ refresh_token: refreshToken }),
   120→    });
   121→
   122→    if (response.ok) {
   123→      const data: TokenResponse = await response.json();
   124→      setTokens(data.access_token, data.refresh_token);
   125→      return true;
   126→    }
   127→  } catch (error) {
   128→    console.error("Token refresh failed:", error);
   129→  }
   130→
   131→  clearTokens();
   132→  return false;
   133→}
   134→
   135→// ─────────────────────────────────────────────────────────────────
   136→// Auth API
   137→// ─────────────────────────────────────────────────────────────────
   138→
   139→export async function register(
   140→  email: string,
   141→  password: string,
   142→  displayName?: string
   143→): Promise<TokenResponse> {
   144→  const response = await fetch(`${API_BASE}/auth/register`, {
   145→    method: "POST",
   146→    headers: { "Content-Type": "application/json" },
   147→    body: JSON.stringify({ email, password, display_name: displayName }),
   148→  });
   149→
   150→  if (!response.ok) {
   151→    const error = await response.json();
   152→    throw new Error(error.detail || "Registration failed");
   153→  }
   154→
   155→  const data: TokenResponse = await response.json();
   156→  setTokens(data.access_token, data.refresh_token);
   157→
   158→  if (typeof window !== "undefined") {
   159→    localStorage.setItem("user", JSON.stringify(data.user));
   160→  }
   161→
   162→  return data;
   163→}
   164→
   165→export async function login(
   166→  email: string,
   167→  password: string
   168→): Promise<TokenResponse> {
   169→  const response = await fetch(`${API_BASE}/auth/login`, {
   170→    method: "POST",
   171→    headers: { "Content-Type": "application/json" },
   172→    body: JSON.stringify({ email, password }),
   173→  });
   174→
   175→  if (!response.ok) {
   176→    const error = await response.json();
   177→    throw new Error(error.detail || "Login failed");
   178→  }
   179→
   180→  const data: TokenResponse = await response.json();
   181→  setTokens(data.access_token, data.refresh_token);
   182→
   183→  if (typeof window !== "undefined") {
   184→    localStorage.setItem("user", JSON.stringify(data.user));
   185→  }
   186→
   187→  return data;
   188→}
   189→
   190→export async function logout(): Promise<void> {
   191→  try {
   192→    await fetchAPI("/auth/logout", { method: "POST" });
   193→  } finally {
   194→    clearTokens();
   195→  }
   196→}
   197→
   198→export async function getMe() {
   199→  const response = await fetchAPI("/auth/me");
   200→  if (!response.ok) throw new Error("Failed to get user");
   201→  return response.json();
   202→}
   203→
   204→// ─────────────────────────────────────────────────────────────────
   205→// Chat API
   206→// ─────────────────────────────────────────────────────────────────
   207→
   208→export async function sendMessage(request: ChatRequest): Promise<ChatResponse> {
   209→  const response = await fetchAPI("/chat/", {
   210→    method: "POST",
   211→    body: JSON.stringify(request),
   212→  });
   213→
   214→  if (!response.ok) {
   215→    const error = await response.json();
   216→    throw new Error(error.detail || "Chat failed");
   217→  }
   218→
   219→  return response.json();
   220→}
   221→
   222→export async function sendGuestMessage(
   223→  message: string,
   224→  skillId: string
   225→): Promise<{ content: string; is_guest: boolean; suggestion: string }> {
   226→  const response = await fetch(`${API_BASE}/chat/guest`, {
   227→    method: "POST",
   228→    headers: { "Content-Type": "application/json" },
   229→    body: JSON.stringify({ message, skill_id: skillId }),
   230→  });
   231→
   232→  if (!response.ok) {
   233→    throw new Error("Chat failed");
   234→  }
   235→
   236→  return response.json();
   237→}
   238→
   239→export function streamChat(
   240→  request: ChatRequest,
   241→  onChunk: (chunk: string) => void,
   242→  onDone: () => void,
   243→  onError: (error: Error) => void
   244→) {
   245→  const { accessToken } = getTokens();
   246→
   247→  const eventSource = new EventSource(
   248→    `${API_BASE}/chat/stream?${new URLSearchParams({
   249→      message: request.message,
   250→      skill_id: request.skill_id,
   251→      ...(request.conversation_id && { conversation_id: request.conversation_id }),
   252→    })}`,
   253→  );
   254→
   255→  // Note: For POST with EventSource, we'd need a different approach
   256→  // This is a simplified version
   257→
   258→  fetch(`${API_BASE}/chat/stream`, {
   259→    method: "POST",
   260→    headers: {
   261→      "Content-Type": "application/json",
   262→      ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
   263→    },
   264→    body: JSON.stringify(request),
   265→  }).then(async (response) => {
   266→    const reader = response.body?.getReader();
   267→    const decoder = new TextDecoder();
   268→
   269→    if (!reader) {
   270→      onError(new Error("No response body"));
   271→      return;
   272→    }
   273→
   274→    while (true) {
   275→      const { done, value } = await reader.read();
   276→      if (done) {
   277→        onDone();
   278→        break;
   279→      }
   280→
   281→      const text = decoder.decode(value);
   282→      const lines = text.split("\n");
   283→
   284→      for (const line of lines) {
   285→        if (line.startsWith("data: ")) {
   286→          const data = line.slice(6);
   287→          if (data === "[DONE]") {
   288→            onDone();
   289→            return;
   290→          }
   291→          onChunk(data);
   292→        }
   293→      }
   294→    }
   295→  }).catch(onError);
   296→}
   297→
   298→// ─────────────────────────────────────────────────────────────────
   299→// User API
   300→// ─────────────────────────────────────────────────────────────────
   301→
   302→export async function getProfile() {
   303→  const response = await fetchAPI("/users/me/profile");
   304→  if (!response.ok) throw new Error("Failed to get profile");
   305→  return response.json();
   306→}
   307→
   308→export async function updateProfile(data: Record<string, unknown>) {
   309→  const response = await fetchAPI("/users/me/profile", {
   310→    method: "PUT",
   311→    body: JSON.stringify(data),
   312→  });
   313→  if (!response.ok) throw new Error("Failed to update profile");
   314→  return response.json();
   315→}
   316→
   317→export async function getSubscriptionStatus() {
   318→  const response = await fetchAPI("/users/me/subscription");
   319→  if (!response.ok) throw new Error("Failed to get subscription");
   320→  return response.json();
   321→}
   322→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
