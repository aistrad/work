     1â†’"""
     2â†’VibeLife Database Connection
     3â†’PostgreSQL with asyncpg
     4â†’"""
     5â†’import os
     6â†’from typing import Optional
     7â†’from contextlib import asynccontextmanager
     8â†’
     9â†’import asyncpg
    10â†’
    11â†’
    12â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    13â†’# Global Connection Pool
    14â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    15â†’
    16â†’_pool: Optional[asyncpg.Pool] = None
    17â†’
    18â†’
    19â†’def get_db_url() -> str:
    20â†’    """Get database URL from environment"""
    21â†’    return os.getenv(
    22â†’        "VIBELIFE_DB_URL",
    23â†’        "postgresql://postgres:password@localhost:5432/vibelife"
    24â†’    )
    25â†’
    26â†’
    27â†’async def init_db():
    28â†’    """Initialize database connection pool"""
    29â†’    global _pool
    30â†’
    31â†’    if _pool is not None:
    32â†’        return
    33â†’
    34â†’    db_url = get_db_url()
    35â†’
    36â†’    _pool = await asyncpg.create_pool(
    37â†’        db_url,
    38â†’        min_size=2,
    39â†’        max_size=20,
    40â†’        command_timeout=60,
    41â†’    )
    42â†’
    43â†’    # Test connection
    44â†’    async with _pool.acquire() as conn:
    45â†’        version = await conn.fetchval("SELECT version()")
    46â†’        print(f"ðŸ“¦ PostgreSQL: {version[:50]}...")
    47â†’
    48â†’
    49â†’async def close_db():
    50â†’    """Close database connection pool"""
    51â†’    global _pool
    52â†’
    53â†’    if _pool is not None:
    54â†’        await _pool.close()
    55â†’        _pool = None
    56â†’
    57â†’
    58â†’async def get_db() -> asyncpg.Pool:
    59â†’    """Get database pool (for dependency injection)"""
    60â†’    if _pool is None:
    61â†’        await init_db()
    62â†’    return _pool
    63â†’
    64â†’
    65â†’async def get_db_pool() -> asyncpg.Pool:
    66â†’    """Backward-compatible alias for getting the DB pool"""
    67â†’    return await get_db()
    68â†’
    69â†’
    70â†’@asynccontextmanager
    71â†’async def get_connection():
    72â†’    """Get a database connection from pool"""
    73â†’    pool = await get_db()
    74â†’    async with pool.acquire() as conn:
    75â†’        yield conn
    76â†’
    77â†’
    78â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    79â†’# Utility Functions
    80â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    81â†’
    82â†’async def execute(query: str, *args):
    83â†’    """Execute a query"""
    84â†’    async with get_connection() as conn:
    85â†’        return await conn.execute(query, *args)
    86â†’
    87â†’
    88â†’async def fetch(query: str, *args):
    89â†’    """Fetch all rows"""
    90â†’    async with get_connection() as conn:
    91â†’        return await conn.fetch(query, *args)
    92â†’
    93â†’
    94â†’async def fetchrow(query: str, *args):
    95â†’    """Fetch one row"""
    96â†’    async with get_connection() as conn:
    97â†’        return await conn.fetchrow(query, *args)
    98â†’
    99â†’
   100â†’async def fetchval(query: str, *args):
   101â†’    """Fetch one value"""
   102â†’    async with get_connection() as conn:
   103â†’        return await conn.fetchval(query, *args)
   104â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
