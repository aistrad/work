     1→"""
     2→Bazi Analysis - Ten Gods, Five Elements strength
     3→"""
     4→from typing import Dict, Any, List
     5→from dataclasses import dataclass
     6→from datetime import datetime
     7→
     8→from .calculator import BaziChart, Pillar
     9→from tools.shared import LunarCalendar
    10→
    11→
    12→@dataclass
    13→class TenGodRelation:
    14→    """Ten God (十神) relationship"""
    15→    name: str
    16→    chinese: str
    17→    description: str
    18→    position: str
    19→
    20→
    21→class BaziAnalysis:
    22→    """
    23→    Analyze Bazi chart: Ten Gods, Five Elements, Patterns
    24→    """
    25→
    26→    # Ten Gods definitions
    27→    TEN_GODS = {
    28→        "比肩": {"en": "Rob Wealth", "desc": "同类相助，竞争"},
    29→        "劫财": {"en": "Friend", "desc": "朋友助力，但需防劫财"},
    30→        "食神": {"en": "Eating God", "desc": "才华、口福、子女"},
    31→        "伤官": {"en": "Hurting Officer", "desc": "叛逆、创新、表达"},
    32→        "偏财": {"en": "Indirect Wealth", "desc": "意外之财、副业"},
    33→        "正财": {"en": "Direct Wealth", "desc": "正当收入、稳定财源"},
    34→        "七杀": {"en": "Seven Killings", "desc": "压力、挑战、权威"},
    35→        "正官": {"en": "Direct Officer", "desc": "事业、地位、规则"},
    36→        "偏印": {"en": "Indirect Seal", "desc": "偏才、灵感、冷门"},
    37→        "正印": {"en": "Direct Seal", "desc": "学业、贵人、母亲"},
    38→    }
    39→
    40→    # Five Elements relationships
    41→    ELEMENT_RELATIONS = {
    42→        "木": {"生": "火", "克": "土", "被生": "水", "被克": "金"},
    43→        "火": {"生": "土", "克": "金", "被生": "木", "被克": "水"},
    44→        "土": {"生": "金", "克": "水", "被生": "火", "被克": "木"},
    45→        "金": {"生": "水", "克": "木", "被生": "土", "被克": "火"},
    46→        "水": {"生": "木", "克": "火", "被生": "金", "被克": "土"},
    47→    }
    48→
    49→    @classmethod
    50→    def analyze_five_elements(cls, chart: BaziChart) -> Dict[str, Any]:
    51→        """Analyze Five Elements distribution"""
    52→        elements = {"木": 0, "火": 0, "土": 0, "金": 0, "水": 0}
    53→
    54→        # Count from stems
    55→        for pillar in [chart.year, chart.month, chart.day, chart.hour]:
    56→            stem_element = LunarCalendar.get_element(pillar.stem)
    57→            if stem_element:
    58→                elements[stem_element] += 1
    59→
    60→            # Count from branches (main qi)
    61→            branch_element = LunarCalendar.get_branch_element(pillar.branch)
    62→            if branch_element:
    63→                elements[branch_element] += 1
    64→
    65→        total = sum(elements.values())
    66→
    67→        return {
    68→            "distribution": elements,
    69→            "percentages": {
    70→                k: round(v / total * 100, 1) if total > 0 else 0
    71→                for k, v in elements.items()
    72→            },
    73→            "strongest": max(elements, key=elements.get),
    74→            "weakest": min(elements, key=elements.get),
    75→            "day_master": chart.day_element
    76→        }
    77→
    78→    @classmethod
    79→    def calculate_ten_gods(cls, chart: BaziChart) -> Dict[str, str]:
    80→        """Calculate Ten Gods for each position"""
    81→        day_master = chart.day_element
    82→        day_stem = chart.day_master
    83→
    84→        # Yang/Yin determination
    85→        yang_stems = ["甲", "丙", "戊", "庚", "壬"]
    86→        is_day_yang = day_stem in yang_stems
    87→
    88→        results = {}
    89→
    90→        for position, pillar in [
    91→            ("年干", chart.year.stem),
    92→            ("月干", chart.month.stem),
    93→            ("时干", chart.hour.stem),
    94→            ("年支", chart.year.branch),
    95→            ("月支", chart.month.branch),
    96→            ("日支", chart.day.branch),
    97→            ("时支", chart.hour.branch),
    98→        ]:
    99→            if position.endswith("干"):
   100→                element = LunarCalendar.get_element(pillar)
   101→                is_yang = pillar in yang_stems
   102→            else:
   103→                element = LunarCalendar.get_branch_element(pillar)
   104→                # Branch yang/yin based on position
   105→                yang_branches = ["子", "寅", "辰", "午", "申", "戌"]
   106→                is_yang = pillar in yang_branches
   107→
   108→            god = cls._get_ten_god(day_master, element, is_day_yang, is_yang)
   109→            results[position] = god
   110→
   111→        return results
   112→
   113→    @classmethod
   114→    def _get_ten_god(
   115→        cls,
   116→        day_element: str,
   117→        target_element: str,
   118→        day_yang: bool,
   119→        target_yang: bool
   120→    ) -> str:
   121→        """Determine Ten God based on element relationship"""
   122→        if not target_element:
   123→            return ""
   124→
   125→        relations = cls.ELEMENT_RELATIONS.get(day_element, {})
   126→        same_polarity = day_yang == target_yang
   127→
   128→        # Same element
   129→        if target_element == day_element:
   130→            return "比肩" if same_polarity else "劫财"
   131→
   132→        # I produce (生)
   133→        if relations.get("生") == target_element:
   134→            return "食神" if same_polarity else "伤官"
   135→
   136→        # I conquer (克)
   137→        if relations.get("克") == target_element:
   138→            return "偏财" if same_polarity else "正财"
   139→
   140→        # Conquers me (被克)
   141→        if relations.get("被克") == target_element:
   142→            return "七杀" if same_polarity else "正官"
   143→
   144→        # Produces me (被生)
   145→        if relations.get("被生") == target_element:
   146→            return "偏印" if same_polarity else "正印"
   147→
   148→        return ""
   149→
   150→    @classmethod
   151→    def analyze_personality(cls, chart: BaziChart) -> Dict[str, Any]:
   152→        """Generate personality analysis based on day master"""
   153→        day_master_traits = {
   154→            "甲": {
   155→                "element": "阳木",
   156→                "symbol": "参天大树",
   157→                "traits": ["正直", "有担当", "领导力强", "有时固执"],
   158→                "strengths": "有远大志向，能屈能伸",
   159→                "challenges": "过于刚强，需学会柔韧"
   160→            },
   161→            "乙": {
   162→                "element": "阴木",
   163→                "symbol": "花草藤蔓",
   164→                "traits": ["柔韧", "适应力强", "善于借力", "温和"],
   165→                "strengths": "灵活变通，善于合作",
   166→                "challenges": "有时优柔寡断"
   167→            },
   168→            "丙": {
   169→                "element": "阳火",
   170→                "symbol": "太阳",
   171→                "traits": ["热情", "开朗", "有感染力", "直率"],
   172→                "strengths": "照耀他人，充满正能量",
   173→                "challenges": "有时过于冲动"
   174→            },
   175→            "丁": {
   176→                "element": "阴火",
   177→                "symbol": "烛光灯火",
   178→                "traits": ["细腻", "聪慧", "有洞察力", "温暖"],
   179→                "strengths": "照亮细节，善于思考",
   180→                "challenges": "有时容易多虑"
   181→            },
   182→            "戊": {
   183→                "element": "阳土",
   184→                "symbol": "高山大地",
   185→                "traits": ["稳重", "包容", "值得信赖", "厚实"],
   186→                "strengths": "承载能力强，可靠",
   187→                "challenges": "有时过于保守"
   188→            },
   189→            "己": {
   190→                "element": "阴土",
   191→                "symbol": "田园沃土",
   192→                "traits": ["务实", "细心", "善于培养", "谨慎"],
   193→                "strengths": "滋养他人，注重细节",
   194→                "challenges": "有时过于计较"
   195→            },
   196→            "庚": {
   197→                "element": "阳金",
   198→                "symbol": "刀剑斧钺",
   199→                "traits": ["果断", "有魄力", "重义气", "刚强"],
   200→                "strengths": "决断力强，行动派",
   201→                "challenges": "有时过于犀利"
   202→            },
   203→            "辛": {
   204→                "element": "阴金",
   205→                "symbol": "珠宝首饰",
   206→                "traits": ["精致", "敏锐", "有品味", "注重细节"],
   207→                "strengths": "追求完美，审美力强",
   208→                "challenges": "有时过于挑剔"
   209→            },
   210→            "壬": {
   211→                "element": "阳水",
   212→                "symbol": "江河大海",
   213→                "traits": ["智慧", "包容", "有谋略", "善变通"],
   214→                "strengths": "思维活跃，善于规划",
   215→                "challenges": "有时过于漂泊"
   216→            },
   217→            "癸": {
   218→                "element": "阴水",
   219→                "symbol": "雨露泉水",
   220→                "traits": ["聪颖", "直觉强", "善于感应", "敏感"],
   221→                "strengths": "滋润万物，善解人意",
   222→                "challenges": "有时情绪波动"
   223→            }
   224→        }
   225→
   226→        return day_master_traits.get(chart.day_master, {})
   227→
   228→    @classmethod
   229→    def to_analysis_dict(cls, chart: BaziChart) -> Dict[str, Any]:
   230→        """Generate complete analysis dictionary"""
   231→        elements = cls.analyze_five_elements(chart)
   232→        ten_gods = cls.calculate_ten_gods(chart)
   233→        personality = cls.analyze_personality(chart)
   234→
   235→        return {
   236→            "five_elements": elements,
   237→            "ten_gods": ten_gods,
   238→            "personality": personality
   239→        }
   240→
   241→
   242→class BaziAnalyzer:
   243→    """Compatibility wrapper for spec/tests (dict-in, dict-out)."""
   244→
   245→    @staticmethod
   246→    def _dict_to_chart(chart: Dict[str, Any]) -> BaziChart:
   247→        """Convert a lightweight chart dict into a BaziChart dataclass."""
   248→
   249→        def pillar_from(data: Dict[str, Any]) -> Pillar:
   250→            stem = data.get("stem", "")
   251→            branch = data.get("branch", "")
   252→            return Pillar(
   253→                stem=stem,
   254→                branch=branch,
   255→                element=LunarCalendar.get_element(stem),
   256→                hidden_stems=[],
   257→            )
   258→
   259→        day_master = chart.get("day_master") or chart.get("day", {}).get("stem", "")
   260→        day_element = chart.get("day_master_element") or LunarCalendar.get_element(day_master)
   261→
   262→        return BaziChart(
   263→            year=pillar_from(chart.get("year", {})),
   264→            month=pillar_from(chart.get("month", {})),
   265→            day=pillar_from(chart.get("day", {})),
   266→            hour=pillar_from(chart.get("hour", {})),
   267→            day_master=day_master,
   268→            day_element=day_element,
   269→            birth_datetime=datetime.now(),
   270→        )
   271→
   272→    def analyze_ten_gods(self, chart: Dict[str, Any]) -> Dict[str, Any]:
   273→        """Analyze Ten Gods (十神) for a chart dict."""
   274→        bazi_chart = self._dict_to_chart(chart)
   275→        return {"ten_gods": BaziAnalysis.calculate_ten_gods(bazi_chart)}
   276→
   277→    def calculate_element_strength(self, chart: Dict[str, Any]) -> Dict[str, float]:
   278→        """Calculate five-element strength (percentages), keyed by EN names."""
   279→        element_key = {"木": "wood", "火": "fire", "土": "earth", "金": "metal", "水": "water"}
   280→        counts = {k: 0.0 for k in element_key.values()}
   281→
   282→        for pos in ("year", "month", "day", "hour"):
   283→            pillar = chart.get(pos, {}) or {}
   284→            stem = pillar.get("stem", "")
   285→            branch = pillar.get("branch", "")
   286→
   287→            stem_el = LunarCalendar.get_element(stem)
   288→            branch_el = LunarCalendar.get_branch_element(branch)
   289→
   290→            if stem_el in element_key:
   291→                counts[element_key[stem_el]] += 1.0
   292→            if branch_el in element_key:
   293→                counts[element_key[branch_el]] += 1.0
   294→
   295→        total = sum(counts.values()) or 1.0
   296→        return {k: (v / total) * 100.0 for k, v in counts.items()}
   297→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
