     1→# VibeLife 完整重构计划
     2→
     3→> 严格基于 vibelife spec v2.0.md 和 v2.1.md 实现全部功能
     4→
     5→## 项目概述
     6→
     7→将 mentis 项目完全重构为 vibelife 全新项目，实现完整的 **Living Companion** 生态系统。
     8→
     9→### 关键决策
    10→- **项目方式**: 全新项目 at `/home/aiscend/work/vibelife`
    11→- **Phase 1 Skill 站点**: bazi + zodiac + mbti (三个站点)
    12→- **Vibe ID**: 完整实现 (SSO、跨站授权、数据主权)
    13→- **技术栈**: FastAPI + PostgreSQL + pgvector + Next.js 14+
    14→
    15→---
    16→
    17→## 可用资源配置 (来自 config.md)
    18→
    19→### 数据库 - PostgreSQL (aiscend 服务器)
    20→
    21→| 配置项 | 值 |
    22→|--------|-----|
    23→| 主机 | `106.37.170.238` |
    24→| 端口 | `8224` |
    25→| 用户 | `postgres` |
    26→| 密码 | `Ak4_9lScd-69WX` |
    27→| 数据库 | `vibelife` (新建) / `mentis_v3` (参考) |
    28→| 连接字符串 | `postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife` |
    29→
    30→### LLM 服务 - 智谱 GLM
    31→
    32→| 配置项 | 值 |
    33→|--------|-----|
    34→| API Key | `42b82ed9a13e4e8890ef3854bb840ef8.TcWZ4DIq0NF2xElF` |
    35→| 对话模型 | `glm-4.7` ✅ (最新旗舰) |
    36→| 图片理解 | `glm-4.6v` ✅ (最新视觉) |
    37→| API 文档 | https://bigmodel.cn/dev/api |
    38→
    39→### LLM 服务 - Claude (备选)
    40→
    41→| 配置项 | 值 |
    42→|--------|-----|
    43→| API Key | 需配置 `CLAUDE_API_KEY` |
    44→| 模型 | `claude-3-5-sonnet-20241022` |
    45→
    46→### 向量嵌入 - Google Gemini
    47→
    48→| 配置项 | 值 |
    49→|--------|-----|
    50→| API Key | `AIzaSyCRxKvvtDeb1_-yBUVGafNkTuO2QLME9HE` |
    51→| 模型 | `gemini-embedding-001` |
    52→| **维度** | **3072** |
    53→
    54→### 向量存储 - Pinecone
    55→
    56→| 配置项 | 值 |
    57→|--------|-----|
    58→| API Key | `pcsk_tVETE_HsAhSvJG9yN2nSdGfkMz2aTefYa72inmvnp97musqf3twzRgDiLEtHDdYAsBmiQ` |
    59→| 索引名称 | `mentis-streams` (可复用或新建 `vibelife-knowledge`) |
    60→| Host | `mentis-streams-nkchadl.svc.aped-4627-b74a.pinecone.io` |
    61→| **维度** | **3072** (与 Gemini 匹配) |
    62→| Metric | `cosine` |
    63→
    64→### 服务分工总览
    65→
    66→| 服务 | 提供商 | 模型 | 状态 |
    67→|------|--------|------|------|
    68→| 对话生成 | GLM | glm-4.7 | ✅ 已验证 |
    69→| 图片理解 | GLM | glm-4.6v | ✅ 已配置 |
    70→| 向量嵌入 | Gemini | gemini-embedding-001 (3072维) | ✅ 已升级 |
    71→| 语义搜索 | Pinecone | mentis-streams (3072维) | ✅ 已升级 |
    72→| 星盘计算 | swisseph | Swiss Ephemeris | 待安装 |
    73→
    74→### 环境变量模板
    75→
    76→```bash
    77→# ─────────────────────────────────────────────────────────────────
    78→# VIBELIFE 环境变量
    79→# ─────────────────────────────────────────────────────────────────
    80→
    81→# 数据库
    82→VIBELIFE_DB_URL=postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
    83→
    84→# JWT
    85→VIBELIFE_JWT_SECRET=vibelife-jwt-secret-key-2026-aiscend
    86→
    87→# 智谱 GLM (对话/图片)
    88→GLM_API_KEY=42b82ed9a13e4e8890ef3854bb840ef8.TcWZ4DIq0NF2xElF
    89→GLM_CHAT_MODEL=glm-4.7
    90→GLM_VISION_MODEL=glm-4.6v
    91→
    92→# Claude (备选)
    93→CLAUDE_API_KEY=your-claude-api-key
    94→
    95→# Google Gemini (Embedding)
    96→GEMINI_API_KEY=AIzaSyCRxKvvtDeb1_-yBUVGafNkTuO2QLME9HE
    97→GEMINI_EMBEDDING_MODEL=gemini-embedding-001
    98→
    99→# Pinecone
   100→PINECONE_API_KEY=pcsk_tVETE_HsAhSvJG9yN2nSdGfkMz2aTefYa72inmvnp97musqf3twzRgDiLEtHDdYAsBmiQ
   101→PINECONE_HOST=mentis-streams-nkchadl.svc.aped-4627-b74a.pinecone.io
   102→
   103→# 默认 LLM 提供商: glm | claude
   104→DEFAULT_LLM_PROVIDER=glm
   105→```
   106→
   107→---
   108→
   109→### 核心定位
   110→> "The Living Companion" — 每个人都值得被深度理解
   111→
   112→**三大差异化**:
   113→1. **Deep Understanding** — 理解你这个人，而非只是问题
   114→2. **Proactive Agency** — 主动关心，而非等你开口
   115→3. **Infinite Extensibility** — 通过 Skills 无限扩展
   116→
   117→**四大体验支柱**: INSIGHT (看见) → INTERACT (陪伴) → EVOLVE (演化) → EDUCATE (觉知)
   118→
   119→---
   120→
   121→## 六层架构总览
   122→
   123→```
   124→┌─────────────────────────────────────────────────────────────────────┐
   125→│  L1: SKILL CONSTELLATION LAYER                                       │
   126→│  独立站点层 - bazi.vibelife.app / zodiac.vibelife.app / mbti...    │
   127→├─────────────────────────────────────────────────────────────────────┤
   128→│  L2: EXPERIENCE LAYER                                                │
   129→│  体验标准层 - Landing / Stream / Insight Cards / Skill Mirror       │
   130→├─────────────────────────────────────────────────────────────────────┤
   131→│  L3: SKILL AGENT LAYER                                               │
   132→│  智能代理层 - Persona / Skill Router / Tool Executor / Workflow     │
   133→├─────────────────────────────────────────────────────────────────────┤
   134→│  L4: KNOWLEDGE LAYER                                                 │
   135→│  知识引擎层 - Chunking / Vector + FTS + Graph / RRF / LLM Grading   │
   136→├─────────────────────────────────────────────────────────────────────┤
   137→│  L5: VIBE ENGINE                                                     │
   138→│  核心引擎层 - LLM / Memory / Emotion / User Model / Insight / Score │
   139→├─────────────────────────────────────────────────────────────────────┤
   140→│  L6: IDENTITY & DATA LAYER                                           │
   141→│  身份数据层 - Vibe ID / SSO / Data Vault / Consent / Profiles       │
   142→└─────────────────────────────────────────────────────────────────────┘
   143→```
   144→
   145→---
   146→
   147→## 重构 TODO Plan
   148→
   149→### Phase 0: 项目初始化 ✅ 已完成 (2026-01-05)
   150→
   151→- [x] **0.1 创建项目目录结构**
   152→  - 创建 `/home/aiscend/work/vibelife` 根目录
   153→  - 设置 monorepo 结构 (pnpm workspace + Turbo)
   154→  - 初始化 Git 仓库
   155→  - 创建 .gitignore, .env.example
   156→
   157→- [x] **0.2 后端基础设施初始化 (FastAPI)**
   158→  - FastAPI 项目骨架 (`apps/api/`)
   159→  - PostgreSQL 连接配置 (含 pgvector 扩展)
   160→  - 环境变量配置 (.env)
   161→  - requirements.txt
   162→  - 数据库迁移 (14个表已创建)
   163→
   164→- [x] **0.3 前端基础设施初始化 (Next.js 14)**
   165→  - Next.js 14 项目初始化 (App Router)
   166→  - TypeScript 配置
   167→  - Tailwind CSS 配置
   168→  - 共享组件库结构 (`packages/ui/`)
   169→
   170→- [x] **0.4 开发工具配置**
   171→  - Turbo pipeline 配置
   172→  - Docker Compose (本地开发)
   173→
   174→**已创建项目结构**:
   175→```
   176→/home/aiscend/work/vibelife/
   177→├── apps/
   178→│   ├── api/                     # FastAPI 后端
   179→│   │   ├── main.py              # 应用入口
   180→│   │   ├── requirements.txt
   181→│   │   ├── Dockerfile
   182→│   │   ├── routes/
   183→│   │   │   ├── auth.py          # 认证路由
   184→│   │   │   └── health.py        # 健康检查
   185→│   │   └── stores/
   186→│   │       └── db.py            # 数据库连接
   187→│   └── web/                     # Next.js 14 前端
   188→│       ├── package.json
   189→│       ├── tailwind.config.ts
   190→│       └── src/app/
   191→├── migrations/
   192→│   └── 001_init.sql             # 数据库初始化 (已执行)
   193→├── packages/                    # 共享包
   194→├── package.json                 # Monorepo 配置
   195→├── pnpm-workspace.yaml
   196→├── turbo.json
   197→├── docker-compose.yml
   198→├── .env.example
   199→├── .env                         # 已配置
   200→└── .gitignore
   201→```
   202→
   203→**已创建数据库表 (14个)**:
   204→- `vibe_users`, `vibe_user_auth`, `vibe_data_consents`
   205→- `skill_profiles`, `skill_conversations`, `skill_messages`, `skill_insights`
   206→- `subscription_plans`, `user_subscriptions`
   207→- `knowledge_chunks` (pgvector 3072维), `knowledge_qa_pairs`
   208→- `fortune_events`, `reminder_settings`, `user_notifications`
   209→
   210→---
   211→
   212→### Phase 1: 数据层完善 (L6 - Identity & Data Layer)
   213→
   214→> 注: 基础表已在 Phase 0 创建，此阶段完善数据访问层
   215→
   216→- [x] **1.1 数据库 Schema 设计 - Vibe ID 核心表** ✅ 已完成
   217→  ```sql
   218→  vibe_users              -- 用户核心表 (vibe_id, display_name, birth_datetime, etc.)
   219→  vibe_user_auth          -- 认证方式表 (email/phone/wechat/apple/google)
   220→  vibe_data_consents      -- 数据共享授权表
   221→  ```
   222→
   223→- [x] **1.2 数据库 Schema 设计 - Skill 数据表** ✅ 已完成
   224→  ```sql
   225→  skill_profiles          -- Skill Profile (JSONB profile_data)
   226→  skill_conversations     -- 对话记录
   227→  skill_messages          -- 消息记录 (intent, tools_used, knowledge_used)
   228→  skill_insights          -- 洞察记录 (insight_type, confidence, user_reaction)
   229→  ```
   230→
   231→- [x] **1.3 数据库 Schema 设计 - 订阅与商业化** ✅ 已完成
   232→  ```sql
   233→  subscription_plans      -- 订阅计划 (skill_single/skill_bundle/vibelife_all)
   234→  user_subscriptions      -- 用户订阅状态
   235→  ```
   236→
   237→- [x] **1.4 数据库 Schema 设计 - 知识库表** ✅ 已完成
   238→  ```sql
   239→  knowledge_chunks        -- 知识块 (含 pgvector 3072维向量 + tsvector 全文)
   240→  knowledge_qa_pairs      -- QA 对
   241→  ```
   242→
   243→- [x] **1.5 数据库 Schema 设计 - 提醒与通知** ✅ 已完成
   244→  ```sql
   245→  fortune_events          -- 运势事件日历
   246→  user_notifications      -- 用户通知记录
   247→  reminder_settings       -- 提醒设置
   248→  ```
   249→
   250→- [x] **1.6 pgvector 向量索引** ✅ 已完成
   251→  - pgvector 扩展已安装
   252→  - 向量列已创建 (3072维，匹配 Gemini embedding)
   253→  - 索引已创建
   254→
   255→- [x] **1.7 数据库迁移脚本** ✅ 已完成
   256→  - `migrations/001_init.sql` 已执行
   257→  - 14个表已创建并验证
   258→
   259→- [ ] **1.8 数据访问层 (Repository Pattern)**
   260→  - `stores/user_repo.py` - 用户数据操作
   261→  - `stores/skill_repo.py` - Skill 数据操作
   262→  - `stores/knowledge_repo.py` - 知识库操作
   263→  - `stores/subscription_repo.py` - 订阅操作
   264→
   265→- [ ] **1.9 Pydantic Models**
   266→  - `models/user.py` - 用户模型
   267→  - `models/skill.py` - Skill 相关模型
   268→  - `models/knowledge.py` - 知识模型
   269→  - `models/subscription.py` - 订阅模型
   270→
   271→---
   272→
   273→### Phase 2: Vibe ID 统一身份系统 ✅ 已完成 (2026-01-05)
   274→
   275→- [x] **2.1 认证层实现**
   276→  - Email/Password 认证 (bcrypt hash)
   277→  - Magic Link 认证 (邮件发送)
   278→  - JWT Token 管理 (access token + refresh token)
   279→  - Token 刷新机制
   280→
   281→- [ ] **2.2 Social OAuth 集成**
   282→  - 微信登录 (预留实现)
   283→  - Apple 登录 (预留实现)
   284→  - Google 登录 (预留实现)
   285→  - OAuth 统一适配器
   286→
   287→- [ ] **2.3 SSO 跨站登录**
   288→  - id.vibelife.app 认证中心
   289→  - Cross-site token 生成 (短期有效)
   290→  - SSO 跳转流程实现
   291→  - Session 同步机制
   292→  - 站点间 Token 验证
   293→
   294→- [ ] **2.4 数据主权层**
   295→  - Data Vault (敏感数据加密存储)
   296→  - Consent Manager (授权管理 API)
   297→  - Export Engine (数据导出 - JSON/PDF)
   298→  - Skill 间数据共享授权机制
   299→
   300→- [ ] **2.5 用户画像系统**
   301→  - Core Profile API (跨站共享: birth_datetime, location, timezone)
   302→  - Skill Profile API (各站独立: bazi chart, zodiac sign, mbti type)
   303→  - Cross-Skill Insights 聚合 API
   304→
   305→- [ ] **2.6 MFA 支持预留**
   306→  - TOTP 接口设计
   307→  - 短信验证码接口设计
   308→
   309→---
   310→
   311→### Phase 3: 核心引擎层 (L5 - Vibe Engine) ✅ 已完成 (2026-01-05)
   312→
   313→- [x] **3.1 LLM 编排器 (Chat Engine)**
   314→  - 多模型支持适配器 (Claude, GLM, GPT-4)
   315→  - Prompt 模板管理系统
   316→  - System Prompt 构建器 (Persona + Skill + User Context)
   317→  - 上下文窗口管理 (Token 计数, 截断策略)
   318→  - **流式响应支持 (SSE/WebSocket)**
   319→  - 重试和降级策略
   320→
   321→- [ ] **3.2 Memory System (记忆系统)**
   322→  - 短期记忆 (对话上下文)
   323→  - 长期记忆 (向量化存储)
   324→  - 记忆检索 (相关性匹配)
   325→  - 记忆更新和衰减
   326→
   327→- [ ] **3.3 情绪感知引擎 (Emotion Analysis)**
   328→  - 规则引擎 (8主情绪 + 12次级情绪)
   329→  - LLM 深度分析
   330→  - 混合分析策略 (Rule + LLM)
   331→  - 情绪强度评估
   332→
   333→- [ ] **3.4 用户模型系统 (User Model)**
   334→  - 行为模式检测
   335→  - 性格画像构建
   336→  - 偏好学习
   337→  - 对话风格适应
   338→
   339→- [ ] **3.5 Insight 生成器**
   340→  - **4种卡片类型生成器**:
   341→    - DISCOVERY Card (发现卡) - "我看见你..."
   342→    - PATTERN Card (模式卡) - "我注意到一个模式..."
   343→    - TIMING Card (时机卡) - "现在是...的好时机"
   344→    - GROWTH Card (成长卡) - "你的成长..."
   345→  - **触发规则引擎**:
   346→    - Discovery: 首次提及 + 强情绪 + 重要主题
   347→    - Pattern: 3次以上 + 相似上下文 + 稳定出现
   348→    - Timing: 运势节点 + 能量高峰 + 用户准备好
   349→    - Growth: 对比改变 + 突破行为 + 里程碑
   350→  - 置信度评估 (>0.7 触发)
   351→  - 冷却期管理 (避免过度推送)
   352→
   353→- [ ] **3.6 Vibe Score 系统**
   354→  - 能量分数计算 (0-100)
   355→  - 趋势追踪
   356→  - 历史记录
   357→  - 分数影响因子
   358→
   359→---
   360→
   361→### Phase 4: 知识引擎层 (L4 - Knowledge Layer) ✅ 已完成 (2026-01-05)
   362→
   363→- [x] **4.1 知识处理管道**
   364→  - 知识提取 (Extract from MD/PDF/JSON)
   365→  - 语义分块 (Semantic Chunking)
   366→  - 实体关系抽取 (NER + Relation)
   367→  - QA 对自动生成
   368→
   369→- [ ] **4.2 混合检索系统**
   370→  - **Vector Search** (pgvector cosine similarity)
   371→  - **Keyword Search** (PostgreSQL FTS + BM25)
   372→  - **Graph Search** (实体关系路径查找)
   373→  - **Reciprocal Rank Fusion (RRF)** 结果融合
   374→  - **LLM Relevance Grading** 相关性评分
   375→
   376→- [ ] **4.3 Embedding 服务**
   377→  - OpenAI Embedding API 集成
   378→  - 本地 Embedding 备选 (sentence-transformers)
   379→  - 批量向量化处理
   380→
   381→- [ ] **4.4 知识库内容 - 八字 (bazi)**
   382→  - `/knowledge/bazi/theory/` - 理论基础 (天干地支、十神、五行)
   383→  - `/knowledge/bazi/patterns/` - 格局模式
   384→  - `/knowledge/bazi/transit/` - 大运流年
   385→  - `/knowledge/bazi/cases/` - 案例库
   386→  - `/knowledge/bazi/qa/` - 问答对
   387→
   388→- [ ] **4.5 知识库内容 - 星座 (zodiac)**
   389→  - `/knowledge/zodiac/theory/` - 12星座、12宫位、行星
   390→  - `/knowledge/zodiac/aspects/` - 相位
   391→  - `/knowledge/zodiac/transit/` - 行运
   392→  - `/knowledge/zodiac/cases/`
   393→
   394→- [ ] **4.6 知识库内容 - MBTI**
   395→  - `/knowledge/mbti/theory/` - 认知功能、16类型
   396→  - `/knowledge/mbti/patterns/` - 类型行为模式
   397→  - `/knowledge/mbti/assessment/` - 测评问题
   398→
   399→- [ ] **4.7 共享知识库**
   400→  - `/knowledge/shared/psychology/` - 心理学通用
   401→  - `/knowledge/shared/communication/` - 沟通技巧
   402→  - `/knowledge/shared/wellbeing/` - 身心健康
   403→
   404→---
   405→
   406→### Phase 5: Skill Agent 层 (L3 - Skill Agent Layer) ✅ 已完成 (2026-01-05)
   407→
   408→- [x] **5.1 Agent Runtime 框架**
   409→  - **Persona Injector** (角色注入) - 加载 Persona Guidelines
   410→  - **Skill Router** (意图路由) - 匹配 Skill 和意图
   411→  - **Context Builder** (上下文构建) - 组装用户上下文
   412→  - **Tool Executor** (工具执行) - 调用专业工具
   413→
   414→- [ ] **5.2 Agent 处理流程 (6步)**
   415→  ```
   416→  1. Context Assembly    - 加载用户画像、对话历史、相关记忆
   417→  2. Intent Classification - 意图识别和 Skill 路由
   418→  3. Knowledge Retrieval  - 混合检索相关知识
   419→  4. Tool Invocation     - 调用专业计算工具
   420→  5. Insight Generation  - 检查是否触发洞察
   421→  6. Response Composition - 按 Language Guidelines 组装回复
   422→  ```
   423→
   424→- [ ] **5.3 SKILL.md 定义规范**
   425→  - SKILL.md 解析器
   426→  - 目录结构验证:
   427→    ```
   428→    skills/{skill_name}/
   429→    ├── SKILL.md            # 技能定义
   430→    ├── scripts/            # 专业计算脚本
   431→    ├── references/         # 参考知识文档
   432→    └── assets/             # 资源文件
   433→    ```
   434→
   435→- [ ] **5.4 Workflow Engine**
   436→  - 工作流配置加载
   437→  - 步骤执行器
   438→  - 条件分支处理
   439→
   440→- [ ] **5.5 Insight Rules Engine**
   441→  - 规则定义 DSL
   442→  - 规则评估器
   443→  - 触发条件检查
   444→
   445→- [ ] **5.6 Persona & Language Guidelines**
   446→  - **Core Identity**: 陪伴者、知己
   447→  - **Personality Traits**: 细腻、温暖、深度、有分寸
   448→  - **Language Principles**:
   449→    - "看见" 替代 "分析"
   450→    - "发现" 替代 "诊断"
   451→    - "也许" 替代 "一定"
   452→    - "这让我想到" 替代 "根据数据"
   453→  - **场景示例库**
   454→
   455→---
   456→
   457→### Phase 6: Skill 工具函数系统 ✅ 已完成 (2026-01-05)
   458→
   459→- [x] **6.1 八字工具 (bazi tools)**
   460→  - `bazi.calculator.generate_chart` - 排盘计算
   461→  - `bazi.transit.calculate_dayun` - 大运计算
   462→  - `bazi.transit.calculate_liunian` - 流年计算
   463→  - `bazi.pattern.analyze_ten_gods` - 十神分析
   464→  - `bazi.elements.calculate_strength` - 五行力量分布
   465→  - `bazi.compatibility.analyze` - 八字合婚 (预留)
   466→
   467→- [ ] **6.2 星座工具 (zodiac tools)**
   468→  - `zodiac.chart.calculate_natal` - 本命星盘计算
   469→  - `zodiac.transit.current` - 当前行星位置
   470→  - `zodiac.aspects.analyze` - 相位分析
   471→  - `zodiac.synastry.compare` - 双人星盘比较 (预留)
   472→  - `zodiac.events.mercury_retrograde` - 水逆日期计算
   473→  - `zodiac.events.moon_phases` - 新月满月计算
   474→
   475→- [ ] **6.3 MBTI 工具 (mbti tools)**
   476→  - `mbti.assessment.calculate_type` - 类型计算
   477→  - `mbti.functions.analyze` - 认知功能栈分析
   478→  - `mbti.compatibility.check` - 类型兼容性检查
   479→
   480→- [ ] **6.4 共享工具 (shared tools)**
   481→  - `datetime.convert` - 公历/农历/时区转换
   482→  - `location.geocode` - 地址地理编码
   483→  - `visualization.generate_chart` - 图表生成
   484→
   485→---
   486→
   487→### Phase 7: 体验层 (L2 - Experience Layer) ✅ 已完成 (2026-01-05)
   488→
   489→- [x] **7.1 The Landing - 零摩擦入口**
   490→  - Hero 区域组件 (title, subtitle, CTA)
   491→  - Value Props 组件 (价值主张卡片)
   492→  - 出生信息输入组件 (日期选择、时辰选择)
   493→  - 即时洞察卡片 (快速结果展示)
   494→  - Sample Conversation 展示
   495→  - Cross-Sell Banner (跨站推荐)
   496→  - 渐进式注册流程 (先体验后注册)
   497→
   498→- [ ] **7.2 Stream - 对话流界面**
   499→  - Stream Feed 组件 (消息列表)
   500→  - Message Bubble 组件 (用户/AI消息气泡)
   501→  - Typing Indicator (输入中指示)
   502→  - Quick Replies 组件 (快捷回复按钮)
   503→  - Quick Actions 组件 (快速操作)
   504→  - Omnibar 输入框 (支持文本/语音/图片)
   505→  - **流式响应显示** (SSE 实时渲染)
   506→
   507→- [ ] **7.3 Insight Card System**
   508→  - **InsightCard 基础组件** (卡片容器)
   509→  - **DiscoveryCard 组件** - 发现卡
   510→    - 标题: "我看见你..."
   511→    - 蓝色主题
   512→  - **PatternCard 组件** - 模式卡
   513→    - 标题: "我注意到一个模式..."
   514→    - 紫色主题
   515→  - **TimingCard 组件** - 时机卡
   516→    - 标题: "现在是...的好时机"
   517→    - 金色主题
   518→  - **GrowthCard 组件** - 成长卡
   519→    - 标题: "你的成长..."
   520→    - 绿色主题
   521→  - 卡片动画 (Framer Motion)
   522→  - 卡片交互 (展开详情、保存、分享)
   523→
   524→- [ ] **7.4 Profile & Settings**
   525→  - 用户资料页面
   526→  - Vibe ID 设置
   527→  - 通知偏好设置
   528→  - 提醒设置 UI:
   529→    - 八字提醒 (月运交接、流年交接、大运交接)
   530→    - 星座提醒 (水逆、新月满月、周运)
   531→    - 提前天数设置
   532→    - 静默时段设置
   533→  - 数据隐私设置
   534→  - 数据导出按钮
   535→
   536→- [ ] **7.5 Charts & Visualizations**
   537→  - BaziChart 组件 (八字命盘可视化)
   538→  - AstroChart 组件 (星盘可视化)
   539→  - RadarChart 组件 (五行/特质雷达图)
   540→  - TimelineChart 组件 (大运流年时间线)
   541→  - ElementsBar 组件 (五行分布条形图)
   542→
   543→---
   544→
   545→### Phase 8: 独立站点层 (L1 - Skill Constellation Layer)
   546→
   547→- [ ] **8.1 站点配置系统 (site_config.yaml)**
   548→  - 站点模板引擎 (Config → Template Engine → Generated Site)
   549→  - 配置项:
   550→    - site: id, name, domain, tagline, description
   551→    - theme: primary_color, secondary_color, background, icon, font_style
   552→    - branding: logo, og_image, favicon
   553→    - landing: hero, value_props, input_form, sample_conversation, cross_sell
   554→    - main_interface: tabs, insight_card
   555→    - result_display: chart_visual, sections
   556→    - monetization: free_tier, premium_tier, paywall_triggers
   557→    - seo: title, description, keywords, structured_data
   558→    - content_marketing: platforms, content_types, posting_frequency
   559→
   560→- [ ] **8.2 bazi.vibelife.app**
   561→  - 站点路由配置 (Next.js 多租户路由)
   562→  - 八字专属 Landing (传统棕金色主题)
   563→  - 命盘展示组件 (四柱可视化)
   564→  - 运势日历组件
   565→  - 月运报告页面
   566→  - 流年报告页面
   567→  - 大运详情页面
   568→
   569→- [ ] **8.3 zodiac.vibelife.app**
   570→  - 站点路由配置
   571→  - 星座专属 Landing
   572→  - 星盘展示组件
   573→  - 行星位置实时展示
   574→  - 水逆提醒组件
   575→  - 周运/月运报告页面
   576→
   577→- [ ] **8.4 mbti.vibelife.app**
   578→  - 站点路由配置
   579→  - MBTI 专属 Landing
   580→  - 类型测评流程 (多步问卷)
   581→  - 认知功能栈展示
   582→  - 16类型详情页面
   583→  - 类型兼容性页面
   584→
   585→- [ ] **8.5 共享组件库 (@vibelife/ui)**
   586→  ```
   587→  @vibelife/ui/
   588→  ├── /layout/           # AppShell, Header, BottomNav, PageContainer
   589→  ├── /landing/          # Hero, ValueProps, InputForm, SampleConversation, CrossSellBanner
   590→  ├── /chat/             # ChatContainer, MessageBubble, InputBar, QuickReplies, TypingIndicator
   591→  ├── /insight/          # InsightCard, DiscoveryCard, PatternCard, TimingCard, GrowthCard
   592→  ├── /charts/           # BaziChart, AstroChart, RadarChart, TimelineChart, ElementsBar
   593→  ├── /profile/          # ProfileHeader, SkillDataCard, SubscriptionStatus, DataSharingSettings
   594→  ├── /common/           # Button, Card, Input, Modal, Toast, Loading
   595→  └── /auth/             # VibeIdLogin, SocialLogin, ConsentDialog
   596→  ```
   597→
   598→- [ ] **8.6 多站点导航**
   599→  - 统一导航栏 (带 Skill 切换)
   600→  - 统一页脚
   601→  - Skill 切换组件
   602→  - 跨站引导组件 ("也试试星座分析?")
   603→
   604→---
   605→
   606→### Phase 9: 主动智能系统 (Proactive Agency)
   607→
   608→- [ ] **9.1 Event Calendar (运势日历)**
   609→  - 八字事件:
   610→    - 节气日期表 (2026年预计算)
   611→    - 月运交接日期
   612→    - 流年交接日期
   613→  - 星座事件:
   614→    - 水逆日期表
   615→    - 新月满月日期
   616→    - 行星逆行日期
   617→  - 用户事件:
   618→    - 生日
   619→    - 纪念日
   620→    - 自定义事件
   621→
   622→- [ ] **9.2 Reminder Scheduler (提醒调度)**
   623→  - Vercel Cron Job 配置
   624→  - 每日扫描任务 (upcoming events)
   625→  - 用户匹配逻辑
   626→  - 提醒设置检查
   627→  - 调度队列管理
   628→
   629→- [ ] **9.3 Content Generator (内容生成)**
   630→  - 个性化提醒内容生成
   631→  - 基于 Persona Guidelines 生成
   632→  - 模板渲染 (Jinja2 / 字符串模板)
   633→  - 用户历史上下文注入
   634→
   635→- [ ] **9.4 Notification Delivery (通知投递)**
   636→  - In-App 通知 (消息中心)
   637→  - Push 通知 (FCM/APNs 预留)
   638→  - 微信服务通知 (预留)
   639→  - 通知状态追踪
   640→
   641→- [ ] **9.5 提醒类型实现**
   642→  - 八字月运交接提醒
   643→  - 八字流年交接提醒
   644→  - 水逆提醒
   645→  - 周运推送
   646→
   647→---
   648→
   649→### Phase 10: Skill Mirror 系统 (周期回顾)
   650→
   651→- [ ] **10.1 月运回顾卡 (Bazi)**
   652→  - 触发时机: 每月最后一天
   653→  - 内容结构:
   654→    - 本月运势回顾 (基于流月)
   655→    - 下月运势展望
   656→    - 关键建议
   657→  - 回顾内容生成 (LLM)
   658→  - 卡片 UI 组件
   659→  - 分享功能
   660→
   661→- [ ] **10.2 周运回顾卡 (Zodiac)**
   662→  - 触发时机: 每周日
   663→  - 内容结构:
   664→    - 本周运势回顾
   665→    - 下周运势展望
   666→    - 关键日期提醒
   667→  - 回顾内容生成 (LLM)
   668→  - 卡片 UI 组件
   669→  - 分享功能
   670→
   671→- [ ] **10.3 可分享卡片系统**
   672→  - 卡片图片生成 (Canvas/SVG → PNG)
   673→  - 多尺寸支持:
   674→    - 1080x1920 (Instagram Story, 微信朋友圈)
   675→    - 1080x1080 (Square, 微博)
   676→    - 1200x630 (Link Preview)
   677→  - 设计元素:
   678→    - 渐变背景 (品牌色)
   679→    - 用户星座/命盘标识
   680→    - 关键数据可视化
   681→    - 一句话主题
   682→    - 品牌 Logo + URL
   683→  - 分享链接生成
   684→  - 分享到社交平台
   685→
   686→---
   687→
   688→### Phase 11: 商业化系统
   689→
   690→- [ ] **11.1 订阅计划设计**
   691→  - 免费层 (Free Tier):
   692→    - 1次完整命盘解读
   693→    - 每天3次提问
   694→    - 基础运势分析
   695→  - 会员层 (Premium Tier):
   696→    - 无限对话
   697→    - 深度十神分析
   698→    - 每月运势推送
   699→    - 详细大运解读
   700→    - 跨技能洞察
   701→  - 定价: 月付 ¥29 / 年付 ¥199
   702→
   703→- [ ] **11.2 Paywall 触发点**
   704→  - deep_pattern_analysis (深度格局分析)
   705→  - detailed_transit (详细运势)
   706→  - compatibility_analysis (合婚分析)
   707→
   708→- [ ] **11.3 Stripe 支付集成**
   709→  - Stripe 账户配置
   710→  - 支付 API 集成
   711→  - Webhook 处理 (订阅状态更新)
   712→  - 发票和收据
   713→
   714→- [ ] **11.4 订阅管理**
   715→  - 订阅状态展示
   716→  - 升级/降级/取消
   717→  - 续费提醒
   718→
   719→---
   720→
   721→### Phase 12: 测试与质量保证
   722→
   723→- [ ] **12.1 单元测试**
   724→  - 后端 API 测试 (pytest)
   725→  - 工具函数测试 (八字计算、星盘计算)
   726→  - 前端组件测试 (Jest + React Testing Library)
   727→
   728→- [ ] **12.2 集成测试**
   729→  - 跨站 SSO 流程测试
   730→  - Agent 处理流程测试
   731→  - 知识检索测试
   732→  - 支付流程测试
   733→
   734→- [ ] **12.3 E2E 测试**
   735→  - Playwright 配置
   736→  - 关键用户流程测试
   737→
   738→- [ ] **12.4 性能测试**
   739→  - API 响应时间
   740→  - 知识检索延迟
   741→  - 流式响应性能
   742→
   743→---
   744→
   745→### Phase 13: 文档与运维
   746→
   747→- [ ] **13.1 API 文档**
   748→  - OpenAPI/Swagger 配置
   749→  - API 端点说明
   750→  - 认证说明
   751→
   752→- [ ] **13.2 Skill 开发指南**
   753→  - SKILL.md 编写规范
   754→  - 工具函数开发指南
   755→  - 知识库构建指南
   756→
   757→- [ ] **13.3 运维文档**
   758→  - 部署流程
   759→  - 环境变量说明
   760→  - 故障排查指南
   761→
   762→- [ ] **13.4 监控与分析**
   763→  - KPI 仪表板:
   764→    - Landing → Chat 转化率 (目标 >35%)
   765→    - 注册转化率 (目标 >15%)
   766→    - 平均对话轮数 (目标 >8)
   767→    - 洞察卡片点击率 (目标 >40%)
   768→    - 7日留存 (目标 >30%)
   769→    - 免费→付费转化率 (目标 >5%)
   770→  - 错误追踪 (Sentry)
   771→  - 日志聚合
   772→
   773→---
   774→
   775→### Phase 14: 部署与上线
   776→
   777→- [ ] **14.1 部署配置**
   778→  - Docker 容器化
   779→  - docker-compose.yml (本地)
   780→  - Kubernetes 配置 (生产 - 预留)
   781→
   782→- [ ] **14.2 域名与 SSL**
   783→  - 域名配置 (*.vibelife.app)
   784→  - Cloudflare DNS 配置
   785→  - SSL 证书 (自动)
   786→
   787→- [ ] **14.3 CI/CD 流水线**
   788→  - GitHub Actions 配置
   789→  - 自动化测试
   790→  - 自动部署 (Vercel)
   791→
   792→- [ ] **14.4 环境分离**
   793→  - Development 环境
   794→  - Staging 环境
   795→  - Production 环境
   796→
   797→---
   798→
   799→## 技术架构
   800→
   801→```
   802→/vibelife/
   803→├── apps/
   804→│   ├── api/                        # FastAPI 后端
   805→│   │   ├── main.py                 # 应用入口
   806→│   │   ├── routes/
   807→│   │   │   ├── auth/               # Vibe ID 认证 API
   808→│   │   │   ├── users/              # 用户 API
   809→│   │   │   ├── skill/              # Skill Agent API
   810→│   │   │   ├── stream/             # Stream 对话 API
   811→│   │   │   ├── insight/            # Insight API
   812→│   │   │   ├── reminder/           # 提醒 API
   813→│   │   │   ├── subscription/       # 订阅 API
   814→│   │   │   └── webhook/            # Webhook (Stripe)
   815→│   │   ├── services/
   816→│   │   │   ├── vibe_engine/        # L5 核心引擎
   817→│   │   │   │   ├── llm_orchestrator.py
   818→│   │   │   │   ├── memory_system.py
   819→│   │   │   │   ├── emotion_engine.py
   820→│   │   │   │   ├── user_model.py
   821→│   │   │   │   ├── insight_generator.py
   822→│   │   │   │   └── vibe_score.py
   823→│   │   │   ├── knowledge/          # L4 知识引擎
   824→│   │   │   │   ├── pipeline.py
   825→│   │   │   │   ├── retrieval.py
   826→│   │   │   │   ├── embedding.py
   827→│   │   │   │   └── rrf.py
   828→│   │   │   ├── agent/              # L3 Agent 系统
   829→│   │   │   │   ├── runtime.py
   830→│   │   │   │   ├── persona.py
   831→│   │   │   │   ├── router.py
   832→│   │   │   │   ├── workflow.py
   833→│   │   │   │   └── insight_rules.py
   834→│   │   │   ├── identity/           # Vibe ID 服务
   835→│   │   │   │   ├── auth.py
   836→│   │   │   │   ├── sso.py
   837→│   │   │   │   ├── consent.py
   838→│   │   │   │   └── profile.py
   839→│   │   │   ├── reminder/           # 提醒服务
   840→│   │   │   │   ├── scheduler.py
   841→│   │   │   │   ├── calendar.py
   842→│   │   │   │   └── generator.py
   843→│   │   │   └── billing/            # 订阅服务
   844→│   │   │       ├── stripe.py
   845→│   │   │       └── subscription.py
   846→│   │   ├── tools/                  # 专业工具
   847→│   │   │   ├── bazi/
   848→│   │   │   │   ├── calculator.py
   849→│   │   │   │   ├── transit.py
   850→│   │   │   │   └── pattern.py
   851→│   │   │   ├── zodiac/
   852→│   │   │   │   ├── chart.py
   853→│   │   │   │   ├── transit.py
   854→│   │   │   │   └── events.py
   855→│   │   │   ├── mbti/
   856→│   │   │   │   ├── assessment.py
   857→│   │   │   │   └── functions.py
   858→│   │   │   └── shared/
   859→│   │   │       ├── datetime_utils.py
   860→│   │   │       └── location.py
   861→│   │   └── stores/
   862→│   │       ├── db.py               # PostgreSQL + pgvector
   863→│   │       └── redis.py            # Redis 缓存
   864→│   │
   865→│   ├── web/                        # Next.js 14 主站
   866→│   │   ├── src/
   867→│   │   │   ├── app/
   868→│   │   │   │   ├── (auth)/         # 认证页面组
   869→│   │   │   │   │   ├── login/
   870→│   │   │   │   │   ├── register/
   871→│   │   │   │   │   └── sso-callback/
   872→│   │   │   │   ├── (bazi)/         # 八字站点组
   873→│   │   │   │   │   ├── page.tsx    # Landing
   874→│   │   │   │   │   ├── chat/
   875→│   │   │   │   │   ├── chart/
   876→│   │   │   │   │   └── transit/
   877→│   │   │   │   ├── (zodiac)/       # 星座站点组
   878→│   │   │   │   └── (mbti)/         # MBTI 站点组
   879→│   │   │   ├── components/         # 站点专属组件
   880→│   │   │   └── lib/
   881→│   │   │       ├── api.ts
   882→│   │   │       └── hooks/
   883→│   │   └── tailwind.config.ts
   884→│   │
   885→│   └── id/                         # Vibe ID 认证中心
   886→│       └── ...
   887→│
   888→├── packages/
   889→│   ├── ui/                         # @vibelife/ui 共享组件库
   890→│   │   ├── src/
   891→│   │   │   ├── layout/
   892→│   │   │   ├── landing/
   893→│   │   │   ├── chat/
   894→│   │   │   ├── insight/
   895→│   │   │   ├── charts/
   896→│   │   │   ├── profile/
   897→│   │   │   ├── common/
   898→│   │   │   └── auth/
   899→│   │   └── package.json
   900→│   │
   901→│   ├── skills/                     # Skill 定义
   902→│   │   ├── bazi/
   903→│   │   │   ├── SKILL.md
   904→│   │   │   ├── site_config.yaml
   905→│   │   │   ├── scripts/
   906→│   │   │   ├── references/
   907→│   │   │   └── assets/
   908→│   │   ├── zodiac/
   909→│   │   └── mbti/
   910→│   │
   911→│   ├── knowledge/                  # 知识库
   912→│   │   ├── bazi/
   913→│   │   │   ├── theory/
   914→│   │   │   ├── patterns/
   915→│   │   │   ├── transit/
   916→│   │   │   ├── cases/
   917→│   │   │   └── qa/
   918→│   │   ├── zodiac/
   919→│   │   ├── mbti/
   920→│   │   └── shared/
   921→│   │
   922→│   └── shared/                     # 共享代码
   923→│       ├── types/
   924→│       └── utils/
   925→│
   926→├── migrations/                     # 数据库迁移
   927→│   ├── 001_vibe_id.sql
   928→│   ├── 002_skill_data.sql
   929→│   ├── 003_knowledge.sql
   930→│   └── 004_subscriptions.sql
   931→│
   932→├── docs/                           # 文档
   933→├── tests/                          # 测试
   934→├── scripts/                        # 脚本工具
   935→├── package.json                    # Monorepo 配置
   936→├── pnpm-workspace.yaml
   937→├── turbo.json
   938→├── docker-compose.yml
   939→└── .env.example
   940→```
   941→
   942→---
   943→
   944→## 执行策略
   945→
   946→每个 Phase 完成后:
   947→1. 自我测试验证功能
   948→2. `/compact` 压缩上下文
   949→3. 继续下一个 Phase
   950→
   951→**预计总共 14 个 Phase**，严格覆盖 spec v2.0 和 v2.1 的全部功能。
   952→
   953→---
   954→
   955→## 附录: 数据库完整 Schema
   956→
   957→```sql
   958→-- ═══════════════════════════════════════════════════════════════
   959→-- VIBELIFE COMPLETE DATABASE SCHEMA
   960→-- ═══════════════════════════════════════════════════════════════
   961→
   962→-- 启用扩展
   963→CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
   964→CREATE EXTENSION IF NOT EXISTS "vector";
   965→
   966→-- ─────────────────────────────────────────────────────────────────
   967→-- VIBE ID 相关表
   968→-- ─────────────────────────────────────────────────────────────────
   969→
   970→CREATE TABLE vibe_users (
   971→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   972→    vibe_id VARCHAR(20) UNIQUE NOT NULL,
   973→    display_name VARCHAR(100),
   974→    avatar_url VARCHAR(500),
   975→    birth_datetime TIMESTAMPTZ,
   976→    birth_location VARCHAR(255),
   977→    birth_location_coords POINT,
   978→    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
   979→    language VARCHAR(10) DEFAULT 'zh-CN',
   980→    status VARCHAR(20) DEFAULT 'active',
   981→    email_verified BOOLEAN DEFAULT false,
   982→    phone_verified BOOLEAN DEFAULT false,
   983→    created_at TIMESTAMPTZ DEFAULT NOW(),
   984→    updated_at TIMESTAMPTZ DEFAULT NOW()
   985→);
   986→
   987→CREATE TABLE vibe_user_auth (
   988→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   989→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
   990→    auth_type VARCHAR(20) NOT NULL,
   991→    auth_identifier VARCHAR(255) NOT NULL,
   992→    auth_credential TEXT,
   993→    created_at TIMESTAMPTZ DEFAULT NOW(),
   994→    UNIQUE(auth_type, auth_identifier)
   995→);
   996→
   997→CREATE TABLE vibe_data_consents (
   998→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   999→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
  1000→    source_skill VARCHAR(50) NOT NULL,
  1001→    target_skill VARCHAR(50) NOT NULL,
  1002→    data_type VARCHAR(50) NOT NULL,
  1003→    consent_granted BOOLEAN DEFAULT false,
  1004→    granted_at TIMESTAMPTZ,
  1005→    revoked_at TIMESTAMPTZ,
  1006→    UNIQUE(user_id, source_skill, target_skill, data_type)
  1007→);
  1008→
  1009→-- ─────────────────────────────────────────────────────────────────
  1010→-- SKILL 数据表
  1011→-- ─────────────────────────────────────────────────────────────────
  1012→
  1013→CREATE TABLE skill_profiles (
  1014→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1015→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
  1016→    skill_id VARCHAR(50) NOT NULL,
  1017→    profile_data JSONB NOT NULL DEFAULT '{}',
  1018→    first_use_at TIMESTAMPTZ DEFAULT NOW(),
  1019→    last_use_at TIMESTAMPTZ DEFAULT NOW(),
  1020→    total_sessions INTEGER DEFAULT 0,
  1021→    UNIQUE(user_id, skill_id)
  1022→);
  1023→
  1024→CREATE TABLE skill_conversations (
  1025→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1026→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
  1027→    skill_id VARCHAR(50) NOT NULL,
  1028→    started_at TIMESTAMPTZ DEFAULT NOW(),
  1029→    ended_at TIMESTAMPTZ,
  1030→    message_count INTEGER DEFAULT 0,
  1031→    entry_point VARCHAR(50),
  1032→    referrer VARCHAR(255),
  1033→    status VARCHAR(20) DEFAULT 'active'
  1034→);
  1035→
  1036→CREATE TABLE skill_messages (
  1037→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1038→    conversation_id UUID REFERENCES skill_conversations(id) ON DELETE CASCADE,
  1039→    role VARCHAR(20) NOT NULL,
  1040→    content TEXT NOT NULL,
  1041→    intent VARCHAR(100),
  1042→    tools_used VARCHAR(100)[],
  1043→    knowledge_used VARCHAR(100)[],
  1044→    insight_generated BOOLEAN DEFAULT false,
  1045→    insight_id UUID,
  1046→    created_at TIMESTAMPTZ DEFAULT NOW()
  1047→);
  1048→
  1049→CREATE TABLE skill_insights (
  1050→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1051→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
  1052→    skill_id VARCHAR(50) NOT NULL,
  1053→    conversation_id UUID REFERENCES skill_conversations(id),
  1054→    insight_type VARCHAR(50) NOT NULL,
  1055→    title VARCHAR(255),
  1056→    content TEXT NOT NULL,
  1057→    evidence JSONB,
  1058→    confidence FLOAT,
  1059→    user_reaction VARCHAR(20),
  1060→    created_at TIMESTAMPTZ DEFAULT NOW()
  1061→);
  1062→
  1063→-- ─────────────────────────────────────────────────────────────────
  1064→-- 订阅与商业化
  1065→-- ─────────────────────────────────────────────────────────────────
  1066→
  1067→CREATE TABLE subscription_plans (
  1068→    id VARCHAR(50) PRIMARY KEY,
  1069→    name VARCHAR(100) NOT NULL,
  1070→    plan_type VARCHAR(20) NOT NULL,
  1071→    skill_ids VARCHAR(50)[],
  1072→    price_monthly INTEGER,
  1073→    price_yearly INTEGER,
  1074→    currency VARCHAR(10) DEFAULT 'CNY',
  1075→    features JSONB,
  1076→    is_active BOOLEAN DEFAULT true
  1077→);
  1078→
  1079→CREATE TABLE user_subscriptions (
  1080→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1081→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
  1082→    plan_id VARCHAR(50) REFERENCES subscription_plans(id),
  1083→    status VARCHAR(20) DEFAULT 'active',
  1084→    started_at TIMESTAMPTZ DEFAULT NOW(),
  1085→    current_period_end TIMESTAMPTZ,
  1086→    cancelled_at TIMESTAMPTZ,
  1087→    payment_provider VARCHAR(50),
  1088→    payment_subscription_id VARCHAR(255),
  1089→    source_skill VARCHAR(50),
  1090→    source_campaign VARCHAR(100)
  1091→);
  1092→
  1093→-- ─────────────────────────────────────────────────────────────────
  1094→-- 知识库
  1095→-- ─────────────────────────────────────────────────────────────────
  1096→
  1097→CREATE TABLE knowledge_chunks (
  1098→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1099→    skill_id VARCHAR(50) NOT NULL,
  1100→    source_file VARCHAR(255),
  1101→    source_section VARCHAR(255),
  1102→    content TEXT NOT NULL,
  1103→    content_type VARCHAR(50),
  1104→    metadata JSONB,
  1105→    embedding vector(1536),
  1106→    search_vector TSVECTOR,
  1107→    created_at TIMESTAMPTZ DEFAULT NOW()
  1108→);
  1109→
  1110→CREATE TABLE knowledge_qa_pairs (
  1111→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1112→    skill_id VARCHAR(50) NOT NULL,
  1113→    chunk_id UUID REFERENCES knowledge_chunks(id),
  1114→    question TEXT NOT NULL,
  1115→    answer TEXT NOT NULL,
  1116→    question_embedding vector(1536),
  1117→    verified BOOLEAN DEFAULT false,
  1118→    usage_count INTEGER DEFAULT 0,
  1119→    helpfulness_score FLOAT
  1120→);
  1121→
  1122→-- ─────────────────────────────────────────────────────────────────
  1123→-- 提醒与通知
  1124→-- ─────────────────────────────────────────────────────────────────
  1125→
  1126→CREATE TABLE fortune_events (
  1127→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1128→    event_type VARCHAR(50) NOT NULL,
  1129→    name VARCHAR(100) NOT NULL,
  1130→    start_date DATE NOT NULL,
  1131→    end_date DATE,
  1132→    event_data JSONB,
  1133→    created_at TIMESTAMPTZ DEFAULT NOW()
  1134→);
  1135→
  1136→CREATE TABLE reminder_settings (
  1137→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1138→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
  1139→    bazi_month_enabled BOOLEAN DEFAULT true,
  1140→    bazi_month_advance_days INTEGER DEFAULT 2,
  1141→    bazi_year_enabled BOOLEAN DEFAULT true,
  1142→    bazi_year_advance_days INTEGER DEFAULT 5,
  1143→    mercury_retrograde_enabled BOOLEAN DEFAULT true,
  1144→    mercury_retrograde_advance_days INTEGER DEFAULT 3,
  1145→    weekly_fortune_enabled BOOLEAN DEFAULT false,
  1146→    weekly_fortune_time VARCHAR(10) DEFAULT '20:00',
  1147→    quiet_start_time VARCHAR(10) DEFAULT '22:00',
  1148→    quiet_end_time VARCHAR(10) DEFAULT '08:00',
  1149→    in_app_enabled BOOLEAN DEFAULT true,
  1150→    push_enabled BOOLEAN DEFAULT true,
  1151→    wechat_enabled BOOLEAN DEFAULT false,
  1152→    UNIQUE(user_id)
  1153→);
  1154→
  1155→CREATE TABLE user_notifications (
  1156→    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  1157→    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
  1158→    notification_type VARCHAR(50) NOT NULL,
  1159→    title VARCHAR(255),
  1160→    content TEXT,
  1161→    read BOOLEAN DEFAULT false,
  1162→    created_at TIMESTAMPTZ DEFAULT NOW()
  1163→);
  1164→
  1165→-- ─────────────────────────────────────────────────────────────────
  1166→-- 索引
  1167→-- ─────────────────────────────────────────────────────────────────
  1168→
  1169→CREATE INDEX idx_vibe_users_vibe_id ON vibe_users(vibe_id);
  1170→CREATE INDEX idx_skill_profiles_user ON skill_profiles(user_id);
  1171→CREATE INDEX idx_skill_profiles_skill ON skill_profiles(skill_id);
  1172→CREATE INDEX idx_skill_conversations_user ON skill_conversations(user_id, skill_id);
  1173→CREATE INDEX idx_skill_messages_convo ON skill_messages(conversation_id);
  1174→CREATE INDEX idx_skill_insights_user ON skill_insights(user_id, skill_id);
  1175→CREATE INDEX idx_user_subscriptions_user ON user_subscriptions(user_id);
  1176→CREATE INDEX idx_knowledge_chunks_search ON knowledge_chunks USING GIN(search_vector);
  1177→CREATE INDEX idx_knowledge_chunks_embedding ON knowledge_chunks USING ivfflat(embedding vector_cosine_ops);
  1178→CREATE INDEX idx_knowledge_qa_embedding ON knowledge_qa_pairs USING ivfflat(question_embedding vector_cosine_ops);
  1179→CREATE INDEX idx_fortune_events_date ON fortune_events(start_date);
  1180→CREATE INDEX idx_user_notifications_user ON user_notifications(user_id, created_at DESC);
  1181→```
  1182→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
