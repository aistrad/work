     1→"""
     2→Bazi Calculator - Generate Bazi chart from birth datetime
     3→"""
     4→from datetime import datetime
     5→from typing import Dict, Any, Tuple, Optional
     6→from dataclasses import dataclass
     7→
     8→from tools.shared import LunarCalendar, DateTimeUtils
     9→
    10→
    11→@dataclass
    12→class Pillar:
    13→    """A pillar (柱) in Bazi"""
    14→    stem: str       # 天干
    15→    branch: str     # 地支
    16→    element: str    # 五行
    17→    hidden_stems: list  # 藏干
    18→
    19→
    20→@dataclass
    21→class BaziChart:
    22→    """Complete Bazi Chart"""
    23→    year: Pillar
    24→    month: Pillar
    25→    day: Pillar
    26→    hour: Pillar
    27→    day_master: str     # 日主 (Day Stem)
    28→    day_element: str    # 日主五行
    29→    birth_datetime: datetime
    30→
    31→
    32→class BaziCalculator:
    33→    """
    34→    Calculate Bazi (Four Pillars) from birth datetime.
    35→    """
    36→
    37→    # Month stem calculation table (based on year stem)
    38→    # Year stem -> First month stem index offset
    39→    MONTH_STEM_OFFSET = {
    40→        "甲": 2, "己": 2,  # 丙寅月
    41→        "乙": 4, "庚": 4,  # 戊寅月
    42→        "丙": 6, "辛": 6,  # 庚寅月
    43→        "丁": 8, "壬": 8,  # 壬寅月
    44→        "戊": 0, "癸": 0,  # 甲寅月
    45→    }
    46→
    47→    # Hour stem calculation (based on day stem)
    48→    HOUR_STEM_OFFSET = {
    49→        "甲": 0, "己": 0,
    50→        "乙": 2, "庚": 2,
    51→        "丙": 4, "辛": 4,
    52→        "丁": 6, "壬": 6,
    53→        "戊": 8, "癸": 8,
    54→    }
    55→
    56→    # Hidden stems in each branch (藏干)
    57→    HIDDEN_STEMS = {
    58→        "子": ["癸"],
    59→        "丑": ["己", "癸", "辛"],
    60→        "寅": ["甲", "丙", "戊"],
    61→        "卯": ["乙"],
    62→        "辰": ["戊", "乙", "癸"],
    63→        "巳": ["丙", "庚", "戊"],
    64→        "午": ["丁", "己"],
    65→        "未": ["己", "丁", "乙"],
    66→        "申": ["庚", "壬", "戊"],
    67→        "酉": ["辛"],
    68→        "戌": ["戊", "辛", "丁"],
    69→        "亥": ["壬", "甲"],
    70→    }
    71→
    72→    @classmethod
    73→    def calculate(cls, birth_datetime: datetime) -> BaziChart:
    74→        """Calculate complete Bazi chart from birth datetime"""
    75→
    76→        # Year pillar
    77→        year_stem, year_branch = cls._calculate_year_pillar(birth_datetime)
    78→
    79→        # Month pillar (based on solar term, simplified here)
    80→        month_stem, month_branch = cls._calculate_month_pillar(
    81→            birth_datetime, year_stem
    82→        )
    83→
    84→        # Day pillar
    85→        day_stem, day_branch = cls._calculate_day_pillar(birth_datetime)
    86→
    87→        # Hour pillar
    88→        hour_stem, hour_branch = cls._calculate_hour_pillar(
    89→            birth_datetime.hour, day_stem
    90→        )
    91→
    92→        return BaziChart(
    93→            year=Pillar(
    94→                stem=year_stem,
    95→                branch=year_branch,
    96→                element=LunarCalendar.get_element(year_stem),
    97→                hidden_stems=cls.HIDDEN_STEMS.get(year_branch, [])
    98→            ),
    99→            month=Pillar(
   100→                stem=month_stem,
   101→                branch=month_branch,
   102→                element=LunarCalendar.get_element(month_stem),
   103→                hidden_stems=cls.HIDDEN_STEMS.get(month_branch, [])
   104→            ),
   105→            day=Pillar(
   106→                stem=day_stem,
   107→                branch=day_branch,
   108→                element=LunarCalendar.get_element(day_stem),
   109→                hidden_stems=cls.HIDDEN_STEMS.get(day_branch, [])
   110→            ),
   111→            hour=Pillar(
   112→                stem=hour_stem,
   113→                branch=hour_branch,
   114→                element=LunarCalendar.get_element(hour_stem),
   115→                hidden_stems=cls.HIDDEN_STEMS.get(hour_branch, [])
   116→            ),
   117→            day_master=day_stem,
   118→            day_element=LunarCalendar.get_element(day_stem),
   119→            birth_datetime=birth_datetime
   120→        )
   121→
   122→    @classmethod
   123→    def _calculate_year_pillar(cls, dt: datetime) -> Tuple[str, str]:
   124→        """Calculate year stem and branch"""
   125→        # Year changes at 立春, simplified here to use Jan 1
   126→        year = dt.year
   127→
   128→        # Adjust for early year (before 立春)
   129→        if dt.month == 1 or (dt.month == 2 and dt.day < 4):
   130→            year -= 1
   131→
   132→        return LunarCalendar.get_year_ganzhi(year)
   133→
   134→    @classmethod
   135→    def _calculate_month_pillar(
   136→        cls,
   137→        dt: datetime,
   138→        year_stem: str
   139→    ) -> Tuple[str, str]:
   140→        """Calculate month stem and branch"""
   141→        # Month branches are fixed:
   142→        # 寅月(Feb), 卯月(Mar), 辰月(Apr), 巳月(May), 午月(Jun), 未月(Jul)
   143→        # 申月(Aug), 酉月(Sep), 戌月(Oct), 亥月(Nov), 子月(Dec), 丑月(Jan)
   144→
   145→        month_branches = [
   146→            "丑", "寅", "卯", "辰", "巳", "午",
   147→            "未", "申", "酉", "戌", "亥", "子"
   148→        ]
   149→
   150→        month_idx = dt.month - 1
   151→        branch = month_branches[month_idx]
   152→
   153→        # Calculate stem
   154→        stems = LunarCalendar.HEAVENLY_STEMS
   155→        offset = cls.MONTH_STEM_OFFSET.get(year_stem, 0)
   156→        stem_idx = (offset + month_idx) % 10
   157→        stem = stems[stem_idx]
   158→
   159→        return stem, branch
   160→
   161→    @classmethod
   162→    def _calculate_day_pillar(cls, dt: datetime) -> Tuple[str, str]:
   163→        """
   164→        Calculate day stem and branch.
   165→        Uses a reference date method.
   166→        Reference: Jan 1, 1900 = 甲子日
   167→        """
   168→        reference = datetime(1900, 1, 1)
   169→        delta = (dt - reference).days
   170→
   171→        stems = LunarCalendar.HEAVENLY_STEMS
   172→        branches = LunarCalendar.EARTHLY_BRANCHES
   173→
   174→        stem_idx = delta % 10
   175→        branch_idx = delta % 12
   176→
   177→        return stems[stem_idx], branches[branch_idx]
   178→
   179→    @classmethod
   180→    def _calculate_hour_pillar(
   181→        cls,
   182→        hour: int,
   183→        day_stem: str
   184→    ) -> Tuple[str, str]:
   185→        """Calculate hour stem and branch"""
   186→        branch, _ = DateTimeUtils.get_chinese_hour(hour)
   187→
   188→        # Calculate stem based on day stem
   189→        stems = LunarCalendar.HEAVENLY_STEMS
   190→        branches = LunarCalendar.EARTHLY_BRANCHES
   191→
   192→        branch_idx = branches.index(branch)
   193→        offset = cls.HOUR_STEM_OFFSET.get(day_stem, 0)
   194→        stem_idx = (offset + branch_idx) % 10
   195→        stem = stems[stem_idx]
   196→
   197→        return stem, branch
   198→
   199→    @classmethod
   200→    def to_dict(cls, chart: BaziChart) -> Dict[str, Any]:
   201→        """Convert chart to dictionary"""
   202→        return {
   203→            "year": {
   204→                "ganzhi": f"{chart.year.stem}{chart.year.branch}",
   205→                "stem": chart.year.stem,
   206→                "branch": chart.year.branch,
   207→                "element": chart.year.element,
   208→                "hidden_stems": chart.year.hidden_stems
   209→            },
   210→            "month": {
   211→                "ganzhi": f"{chart.month.stem}{chart.month.branch}",
   212→                "stem": chart.month.stem,
   213→                "branch": chart.month.branch,
   214→                "element": chart.month.element,
   215→                "hidden_stems": chart.month.hidden_stems
   216→            },
   217→            "day": {
   218→                "ganzhi": f"{chart.day.stem}{chart.day.branch}",
   219→                "stem": chart.day.stem,
   220→                "branch": chart.day.branch,
   221→                "element": chart.day.element,
   222→                "hidden_stems": chart.day.hidden_stems
   223→            },
   224→            "hour": {
   225→                "ganzhi": f"{chart.hour.stem}{chart.hour.branch}",
   226→                "stem": chart.hour.stem,
   227→                "branch": chart.hour.branch,
   228→                "element": chart.hour.element,
   229→                "hidden_stems": chart.hour.hidden_stems
   230→            },
   231→            "day_master": chart.day_master,
   232→            "day_element": chart.day_element,
   233→            "day_master_element": chart.day_element,
   234→            "four_pillars": (
   235→                f"{chart.year.stem}{chart.year.branch} "
   236→                f"{chart.month.stem}{chart.month.branch} "
   237→                f"{chart.day.stem}{chart.day.branch} "
   238→                f"{chart.hour.stem}{chart.hour.branch}"
   239→            ),
   240→            "birth_datetime": str(chart.birth_datetime)
   241→        }
   242→
   243→    def generate_chart(
   244→        self,
   245→        birth_datetime: datetime,
   246→        birth_location: Optional[str] = None,
   247→        gender: str = "male",
   248→    ) -> Dict[str, Any]:
   249→        """
   250→        Public chart generator (compat for spec/tests).
   251→
   252→        Parameters like `birth_location` and `gender` are accepted for future
   253→        extensions but are not required for basic chart generation.
   254→        """
   255→        chart = self.calculate(birth_datetime)
   256→        data = self.to_dict(chart)
   257→
   258→        if birth_location:
   259→            data["birth_location"] = birth_location
   260→        if gender:
   261→            data["gender"] = gender
   262→
   263→        return data
   264→
   265→    @classmethod
   266→    def format_chart(cls, chart: BaziChart) -> str:
   267→        """Format chart as readable string"""
   268→        return f"""八字命盘
   269→═══════════════════════════════════
   270→      年柱    月柱    日柱    时柱
   271→天干   {chart.year.stem}      {chart.month.stem}      {chart.day.stem}      {chart.hour.stem}
   272→地支   {chart.year.branch}      {chart.month.branch}      {chart.day.branch}      {chart.hour.branch}
   273→五行   {chart.year.element}      {chart.month.element}      {chart.day.element}      {chart.hour.element}
   274→═══════════════════════════════════
   275→日主: {chart.day_master} ({chart.day_element})
   276→四柱: {chart.year.stem}{chart.year.branch} {chart.month.stem}{chart.month.branch} {chart.day.stem}{chart.day.branch} {chart.hour.stem}{chart.hour.branch}
   277→"""
   278→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
