{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","type":"user","message":{"role":"user","content":"深入阅读 /home/aiscend/work/vibelife/docs/archive/v3 目录下的所有文档，重点关注：\n1. 当前实现状态\n2. 前端页面设计相关的内容\n3. 已知问题和待优化点\n\n列出所有文件并总结关键内容。"},"uuid":"1d2a8119-b973-4621-b950-044a1dac6af5","timestamp":"2026-01-07T10:04:36.526Z"}
{"parentUuid":"1d2a8119-b973-4621-b950-044a1dac6af5","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01VRA1pZkosqprRX1SMGnAoM","type":"message","role":"assistant","content":[{"type":"text","text":"我来帮你深入阅读该目录下的所有文档。首先，让我列出目录结构并找到所有文件。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":19649,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":19649,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWsq1qm5ErSpzkAnAPdSq","type":"assistant","uuid":"566349c4-00f3-4407-b7ff-8545d7206b24","timestamp":"2026-01-07T10:04:39.305Z"}
{"parentUuid":"566349c4-00f3-4407-b7ff-8545d7206b24","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01VRA1pZkosqprRX1SMGnAoM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_019TyeX4hqSY1xhrev3r1qyk","name":"Bash","input":{"command":"find /home/aiscend/work/vibelife/docs/archive/v3 -type f","description":"列出v3目录下所有文件"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":19649,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":19649,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"}},"requestId":"req_011CWsq1qm5ErSpzkAnAPdSq","type":"assistant","uuid":"302e8042-39a4-4e8b-a596-484e16c36a18","timestamp":"2026-01-07T10:04:39.649Z"}
{"parentUuid":"302e8042-39a4-4e8b-a596-484e16c36a18","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01VRA1pZkosqprRX1SMGnAoM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UqdvTQGmPTJ9jjHnE68UGp","name":"Bash","input":{"command":"ls -la /home/aiscend/work/vibelife/docs/archive/v3","description":"查看v3目录结构"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":19649,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":19649,"ephemeral_1h_input_tokens":0},"output_tokens":223,"service_tier":"standard"}},"requestId":"req_011CWsq1qm5ErSpzkAnAPdSq","type":"assistant","uuid":"5f558e97-00bc-4c41-a27c-c5539aa9262b","timestamp":"2026-01-07T10:04:40.047Z"}
{"parentUuid":"5f558e97-00bc-4c41-a27c-c5539aa9262b","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_019TyeX4hqSY1xhrev3r1qyk","type":"tool_result","content":"/home/aiscend/work/vibelife/docs/archive/v3/chat-flow.md\n/home/aiscend/work/vibelife/docs/archive/v3/implementation-status-analysis.md\n/home/aiscend/work/vibelife/docs/archive/v3/matrix-strategy-architecture.md\n/home/aiscend/work/vibelife/docs/archive/v3/architecture-decisions.md","is_error":false}]},"uuid":"7feb5bc9-6eb0-404b-a149-34a905869318","timestamp":"2026-01-07T10:04:40.234Z","toolUseResult":{"stdout":"/home/aiscend/work/vibelife/docs/archive/v3/chat-flow.md\n/home/aiscend/work/vibelife/docs/archive/v3/implementation-status-analysis.md\n/home/aiscend/work/vibelife/docs/archive/v3/matrix-strategy-architecture.md\n/home/aiscend/work/vibelife/docs/archive/v3/architecture-decisions.md","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"7feb5bc9-6eb0-404b-a149-34a905869318","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UqdvTQGmPTJ9jjHnE68UGp","type":"tool_result","content":"总计 112\ndrwxrwxr-x 2 aiscend aiscend  4096 Jan  7 17:57 .\ndrwxrwxr-x 5 aiscend aiscend  4096 Jan  7 17:10 ..\n-rw------- 1 aiscend aiscend 16358 Jan  7 17:57 architecture-decisions.md\n-rw------- 1 aiscend aiscend 28548 Jan  7 17:18 chat-flow.md\n-rw------- 1 aiscend aiscend 14785 Jan  7 17:35 implementation-status-analysis.md\n-rw------- 1 aiscend aiscend 43305 Jan  7 17:50 matrix-strategy-architecture.md","is_error":false}]},"uuid":"19899c6f-d954-451d-b60f-a7d33fcfacda","timestamp":"2026-01-07T10:04:40.243Z","toolUseResult":{"stdout":"总计 112\ndrwxrwxr-x 2 aiscend aiscend  4096 Jan  7 17:57 .\ndrwxrwxr-x 5 aiscend aiscend  4096 Jan  7 17:10 ..\n-rw------- 1 aiscend aiscend 16358 Jan  7 17:57 architecture-decisions.md\n-rw------- 1 aiscend aiscend 28548 Jan  7 17:18 chat-flow.md\n-rw------- 1 aiscend aiscend 14785 Jan  7 17:35 implementation-status-analysis.md\n-rw------- 1 aiscend aiscend 43305 Jan  7 17:50 matrix-strategy-architecture.md","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"19899c6f-d954-451d-b60f-a7d33fcfacda","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012sWzruhNKLcFQVwnxgJbQD","type":"message","role":"assistant","content":[{"type":"text","text":"好的，现在我逐个读取这些文件，重点关注你提出的三个方面。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":866,"cache_read_input_tokens":19649,"cache_creation":{"ephemeral_5m_input_tokens":866,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWsq275Zr6dhzghcWPbeG","type":"assistant","uuid":"8b8e0216-2d6e-4a9c-a0d6-97fb39349903","timestamp":"2026-01-07T10:04:43.424Z"}
{"parentUuid":"8b8e0216-2d6e-4a9c-a0d6-97fb39349903","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012sWzruhNKLcFQVwnxgJbQD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CYBwV64qFNej33C3iy8BXu","name":"Read","input":{"file_path":"/home/aiscend/work/vibelife/docs/archive/v3/implementation-status-analysis.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":866,"cache_read_input_tokens":19649,"cache_creation":{"ephemeral_5m_input_tokens":866,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWsq275Zr6dhzghcWPbeG","type":"assistant","uuid":"f78825fe-c40a-4aaa-887e-e1c19030b0ad","timestamp":"2026-01-07T10:04:43.684Z"}
{"parentUuid":"f78825fe-c40a-4aaa-887e-e1c19030b0ad","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012sWzruhNKLcFQVwnxgJbQD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CFGsUaBART6GBoNngmKcvQ","name":"Read","input":{"file_path":"/home/aiscend/work/vibelife/docs/archive/v3/chat-flow.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":866,"cache_read_input_tokens":19649,"cache_creation":{"ephemeral_5m_input_tokens":866,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWsq275Zr6dhzghcWPbeG","type":"assistant","uuid":"a7804f15-1234-41e1-b10f-d63539697666","timestamp":"2026-01-07T10:04:43.845Z"}
{"parentUuid":"a7804f15-1234-41e1-b10f-d63539697666","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012sWzruhNKLcFQVwnxgJbQD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016rq3oF2amrbWV1XBWGGCKN","name":"Read","input":{"file_path":"/home/aiscend/work/vibelife/docs/archive/v3/architecture-decisions.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":866,"cache_read_input_tokens":19649,"cache_creation":{"ephemeral_5m_input_tokens":866,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWsq275Zr6dhzghcWPbeG","type":"assistant","uuid":"ec96ec68-0e0f-4ba0-92fd-dd225d75d47e","timestamp":"2026-01-07T10:04:44.058Z"}
{"parentUuid":"ec96ec68-0e0f-4ba0-92fd-dd225d75d47e","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_012sWzruhNKLcFQVwnxgJbQD","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01J1B22kKVcy58BgqApp1Aqj","name":"Read","input":{"file_path":"/home/aiscend/work/vibelife/docs/archive/v3/matrix-strategy-architecture.md"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":866,"cache_read_input_tokens":19649,"cache_creation":{"ephemeral_5m_input_tokens":866,"ephemeral_1h_input_tokens":0},"output_tokens":291,"service_tier":"standard"}},"requestId":"req_011CWsq275Zr6dhzghcWPbeG","type":"assistant","uuid":"479e1c89-36bf-433c-8e4c-d63160a60ba1","timestamp":"2026-01-07T10:04:44.286Z"}
{"parentUuid":"1f9ad842-dedd-4e83-9d17-e1be70656347","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CYBwV64qFNej33C3iy8BXu","type":"tool_result","content":"     1→# VibeLife 实现状态分析 & 最佳架构建议\n     2→\n     3→> **分析日期**: 2026-01-07\n     4→> **分析目标**: 对比 Spec v3.0 与当前实现，确定最佳架构模式\n     5→> **用户核心诉求**: 功能完整度优先 + 独立子域名深度定制 UI\n     6→\n     7→---\n     8→\n     9→## 1. 当前实现 vs Spec v3.0 对比总结\n    10→\n    11→### 1.1 整体完成度\n    12→\n    13→| 模块 | Spec v3.0 要求 | 当前状态 | 完成度 |\n    14→|------|---------------|----------|--------|\n    15→| **Vibe Engine** | LLM + Portrait + Context | ✅ 完整实现 | 100% |\n    16→| **访谈系统** | 强制访谈 + 信息抽取 | ✅ 完整实现 | 100% |\n    17→| **报告生成** | lite/full + AI 生图 + 卷首语 | ✅ 核心完成 | 85% |\n    18→| **Identity Prism** | Inner/Core/Outer 三元 | ✅ 完整实现 | 100% |\n    19→| **人生 K-Line** | 大运/流年可视化 | ✅ 完整实现 | 95% |\n    20→| **Daily Greeting** | 节气 + 24 季节 | ✅ 完整实现 | 100% |\n    21→| **关系模拟器** | 单人/Vibe Link/话术模板 | ✅ 完整实现 | 100% |\n    22→| **知识库** | 八字 + 星座专业内容 | ✅ 已建立 | 100% |\n    23→| **数据库 Schema** | v3.0 完整表结构 | ✅ 已设计 | 90% |\n    24→| **支付系统** | Stripe 集成 | ⚠️ 骨架阶段 | 30% |\n    25→| **前端页面** | 三栏布局 + 移动端优先 | ✅ 基本完成 | 85% |\n    26→\n    27→### 1.2 核心差距\n    28→\n    29→**需要补完的部分**：\n    30→1. 数据库持久化（部分 API 使用模拟数据）\n    31→2. 支付系统完整集成（Stripe webhook 等）\n    32→3. 前端部分页面细节（报告展示、付费流程 UI）\n    33→\n    34→---\n    35→\n    36→## 2. 前端页面结构现状\n    37→\n    38→### 2.1 当前活跃页面 (src/app)\n    39→\n    40→| 路由 | 文件 | 说明 |\n    41→|------|------|------|\n    42→| `/` | page.tsx | 首页/登陆页 |\n    43→| `/chat` | chat/page.tsx | 主聊天页面（三栏布局） |\n    44→| `/auth/login` | auth/login/page.tsx | 登录页 |\n    45→| `/auth/register` | auth/register/page.tsx | 注册页 |\n    46→| `/auth/sso-callback` | auth/sso-callback/page.tsx | SSO 回调页 |\n    47→\n    48→### 2.2 存档页面 (archive/app)\n    49→\n    50→| 路由 | 说明 |\n    51→|------|------|\n    52→| `/bazi` | 八字首页 |\n    53→| `/bazi/chat` | 八字聊天页 |\n    54→| `/zodiac` | 星座首页 |\n    55→| `/zodiac/chat` | 星座聊天页 |\n    56→| `/mbti` | MBTI 首页 |\n    57→| `/mbti/chat` | MBTI 聊天页 |\n    58→\n    59→### 2.3 当前路由机制\n    60→\n    61→- `middleware.ts` - 子域名检测自动设置 skill\n    62→- 支持的 skills: `[\"bazi\", \"zodiac\", \"mbti\", \"attach\", \"career\"]`\n    63→- 默认 skill: `bazi`\n    64→\n    65→---\n    66→\n    67→## 3. 子域名 + 深度定制 UI 架构分析\n    68→\n    69→### 3.1 可行性：完全可行 ✅\n    70→\n    71→Next.js 14 完全支持此模式，当前代码已有基础：\n    72→\n    73→**现有实现**：\n    74→- `middleware.ts` 已实现子域名检测\n    75→- `SkillProvider.tsx` 已支持 skill 上下文切换\n    76→\n    77→**实现方式**：\n    78→```\n    79→bazi.vibelife.app → skill=bazi → (bazi)/ 路由组\n    80→zodiac.vibelife.app → skill=zodiac → (zodiac)/ 路由组\n    81→```\n    82→\n    83→### 3.2 推荐架构模式\n    84→\n    85→```\n    86→┌─────────────────────────────────────────────────────────────────┐\n    87→│                        子域名入口                                │\n    88→├─────────────────────────────────────────────────────────────────┤\n    89→│                                                                 │\n    90→│   bazi.vibelife.app        zodiac.vibelife.app                 │\n    91→│        │                         │                              │\n    92→│        ▼                         ▼                              │\n    93→│   ┌─────────────────┐      ┌─────────────────┐                 │\n    94→│   │  Bazi 专属 UI   │      │ Zodiac 专属 UI  │                 │\n    95→│   │                 │      │                 │                  │\n    96→│   │ • 命盘可视化    │      │ • 星盘图表      │                  │\n    97→│   │ • 玄金配色      │      │ • 星蓝配色      │                  │\n    98→│   │ • 八字术语展示  │      │ • 行星运行动画  │                  │\n    99→│   │ • 大运流年 UI   │      │ • 水逆/月相 UI  │                  │\n   100→│   └────────┬────────┘      └────────┬────────┘                 │\n   101→│            │                        │                           │\n   102→│            └──────────┬─────────────┘                           │\n   103→│                       ▼                                         │\n   104→│           ┌─────────────────────────┐                          │\n   105→│           │    共享组件层            │                          │\n   106→│           │                         │                          │\n   107→│           │ • ChatContainer         │                          │\n   108→│           │ • InsightCard           │                          │\n   109→│           │ • LuminousPaper         │                          │\n   110→│           │ • BreathAura            │                          │\n   111→│           └────────────┬────────────┘                          │\n   112→│                        │                                        │\n   113→│                        ▼                                        │\n   114→│           ┌─────────────────────────┐                          │\n   115→│           │    共享后端服务          │                          │\n   116→│           │                         │                          │\n   117→│           │ • Vibe Engine           │                          │\n   118→│           │ • Report Service        │                          │\n   119→│           │ • Relationship Service  │                          │\n   120→│           │ • Knowledge Retrieval   │                          │\n   121→│           └─────────────────────────┘                          │\n   122→│                                                                 │\n   123→└─────────────────────────────────────────────────────────────────┘\n   124→```\n   125→\n   126→### 3.3 代码组织建议\n   127→\n   128→> **架构决策**：采用「路由组隔离」模式，(bazi)/chat 和 (zodiac)/chat 各自有独立页面文件，但共享 components/core 和 components/chat 组件。\n   129→\n   130→```\n   131→apps/web/src/\n   132→├── app/\n   133→│   ├── (www)/               # 主站路由组（品牌索引页）\n   134→│   │   ├── layout.tsx       # 主站布局\n   135→│   │   └── page.tsx         # 品牌索引页（Phase 1 实现）\n   136→│   │\n   137→│   ├── (bazi)/              # Bazi 路由组\n   138→│   │   ├── layout.tsx       # Bazi 专属布局（玄金配色）\n   139→│   │   ├── page.tsx         # Bazi 首页（命盘快览）\n   140→│   │   ├── chat/\n   141→│   │   │   └── page.tsx     # Bazi 聊天页\n   142→│   │   ├── chart/\n   143→│   │   │   └── page.tsx     # Bazi 命盘详情\n   144→│   │   └── report/\n   145→│   │       └── page.tsx     # Bazi 报告页\n   146→│   │\n   147→│   ├── (zodiac)/            # Zodiac 路由组\n   148→│   │   ├── layout.tsx       # Zodiac 专属布局（星蓝配色）\n   149→│   │   ├── page.tsx         # Zodiac 首页（星盘快览）\n   150→│   │   ├── chat/\n   151→│   │   │   └── page.tsx     # Zodiac 聊天页\n   152→│   │   ├── chart/\n   153→│   │   │   └── page.tsx     # Zodiac 星盘详情\n   154→│   │   └── report/\n   155→│   │       └── page.tsx     # Zodiac 报告页\n   156→│   │\n   157→│   ├── (shared)/            # 共享路由（跨子域名共用）\n   158→│   │   ├── auth/\n   159→│   │   │   ├── login/page.tsx\n   160→│   │   │   ├── register/page.tsx\n   161→│   │   │   └── sso-callback/page.tsx\n   162→│   │   └── me/\n   163→│   │       ├── page.tsx          # 个人中心\n   164→│   │       └── subscriptions/page.tsx  # 订阅管理\n   165→│   │\n   166→│   └── middleware.ts        # 子域名路由\n   167→│\n   168→├── components/\n   169→│   ├── core/                # 共享核心组件\n   170→│   ├── chat/                # 共享聊天组件\n   171→│   ├── bazi/                # Bazi 专属组件\n   172→│   │   ├── BaziChart.tsx    # 八字命盘\n   173→│   │   ├── WuxingDisplay.tsx # 五行展示\n   174→│   │   └── DayunTimeline.tsx # 大运时间线\n   175→│   └── zodiac/              # Zodiac 专属组件\n   176→│       ├── NatalChart.tsx   # 本命星盘\n   177→│       ├── PlanetPositions.tsx\n   178→│       └── TransitOverlay.tsx\n   179→│\n   180→└── styles/\n   181→    ├── globals.css          # 共享样式\n   182→    ├── bazi-theme.css       # Bazi 主题（玄金/朱砂）\n   183→    └── zodiac-theme.css     # Zodiac 主题（星蓝/金线）\n   184→```\n   185→\n   186→### 3.4 部署配置\n   187→\n   188→**Vercel 配置**（vercel.json）:\n   189→```json\n   190→{\n   191→  \"rewrites\": [\n   192→    {\n   193→      \"source\": \"/:path*\",\n   194→      \"has\": [{ \"type\": \"host\", \"value\": \"bazi.vibelife.app\" }],\n   195→      \"destination\": \"/bazi/:path*\"\n   196→    },\n   197→    {\n   198→      \"source\": \"/:path*\",\n   199→      \"has\": [{ \"type\": \"host\", \"value\": \"zodiac.vibelife.app\" }],\n   200→      \"destination\": \"/zodiac/:path*\"\n   201→    },\n   202→    {\n   203→      \"source\": \"/:path*\",\n   204→      \"has\": [{ \"type\": \"host\", \"value\": \"www.vibelife.app\" }],\n   205→      \"destination\": \"/www/:path*\"\n   206→    }\n   207→  ]\n   208→}\n   209→```\n   210→\n   211→> **路由策略说明**：采用路由组物理隔离模式，每个子域名映射到对应的路由组目录，实现深度定制 UI。\n   212→\n   213→---\n   214→\n   215→## 4. 后端实现状态详情\n   216→\n   217→### 4.1 核心服务模块（完整实现）\n   218→\n   219→```\n   220→services/ (11,062 行代码)\n   221→├── vibe_engine/           ✅ 核心引擎\n   222→│   ├── llm.py             ✅ 多 LLM 支持 (Zhipu/Claude/Gemini)\n   223→│   ├── context.py         ✅ LLM 上下文构建\n   224→│   ├── portrait.py        ✅ 用户画像管理 (4层结构)\n   225→│   ├── portrait_service.py ✅ 画像服务\n   226→│   ├── llm_orchestrator.py ✅ LLM 编排器\n   227→│   ├── emotion_engine.py  ✅ 情感分析引擎\n   228→│   ├── insight_generator.py ✅ 洞察生成器\n   229→│   └── memory_system.py   ✅ 记忆系统\n   230→│\n   231→├── agent/                 ✅ Agent 运行时\n   232→├── interview/             ✅ 访谈系统\n   233→├── report/                ✅ 报告生成\n   234→├── relationship/          ✅ 关系分析\n   235→├── fortune/               ✅ 运势计算\n   236→├── greeting/              ✅ 日常问候\n   237→├── knowledge/             ✅ 知识检索\n   238→├── extraction/            ✅ 文件提取\n   239→├── identity/              ✅ 身份验证\n   240→└── billing/               ✅ 计费（骨架）\n   241→```\n   242→\n   243→### 4.2 API 端点实现状态\n   244→\n   245→| 路由 | 状态 | 说明 |\n   246→|------|------|------|\n   247→| `/api/v1/auth/*` | ✅ | 完整认证流程 |\n   248→| `/api/v1/chat/*` | ✅ | 流式聊天 + 访谈 |\n   249→| `/api/v1/report/*` | ✅ | 报告生成（部分持久化待完善）|\n   250→| `/api/v1/relationship/*` | ✅ | 关系分析 + Vibe Link |\n   251→| `/api/v1/fortune/*` | ✅ | K 线 + 运势 |\n   252→| `/api/v1/payment/*` | ⚠️ | 骨架阶段 |\n   253→\n   254→---\n   255→\n   256→## 5. Phase 1 功能完整度清单\n   257→\n   258→根据 Spec v3.0 P0/P0+ 定义，Phase 1 需要完成：\n   259→\n   260→### 5.1 P0 功能（必须上线）\n   261→\n   262→| 功能 | 当前状态 | 差距 |\n   263→|------|---------|------|\n   264→| 深度报告生成 | ✅ 已实现 | 前端展示细节 |\n   265→| 对话式咨询（流式+语气切换）| ✅ 已实现 | - |\n   266→| Identity Prism | ✅ 已实现 | 前端 TriToggle 组件细节 |\n   267→| Relationship Simulator | ✅ 已实现 | Vibe Link UI 细节 |\n   268→| 人生 K 线 | ✅ 已实现 | ECharts 交互细节 |\n   269→| 智能信息采集 | ✅ 已实现 | - |\n   270→| Now/Next 趋势视图 | ✅ 已实现 | - |\n   271→| 洞察卡片系统 | ✅ 已实现 | - |\n   272→\n   273→### 5.2 P0+ 功能（强制上线）\n   274→\n   275→| 功能 | 当前状态 | 差距 |\n   276→|------|---------|------|\n   277→| Daily Greeting | ✅ 已实现 | 强制展示逻辑需前端配合 |\n   278→\n   279→### 5.3 P2 功能（Phase 2 延后）\n   280→\n   281→- ❌ 主动推送系统\n   282→- ❌ 每日微行动 + 打卡\n   283→- ❌ SOS 情绪急救模式\n   284→- ❌ MBTI Skill\n   285→- ❌ 长程计划追踪\n   286→\n   287→---\n   288→\n   289→## 6. 实施建议\n   290→\n   291→### 6.1 立即执行（补完 Phase 1）\n   292→\n   293→**优先级 1: 前端子域名架构重构**\n   294→- 将 archive 中的 bazi/zodiac 页面迁移到路由组模式\n   295→- 实现 skill 专属主题切换\n   296→- 确保组件复用最大化\n   297→\n   298→**优先级 2: 数据库持久化补完**\n   299→- conversations 真实存储\n   300→- reports 持久化\n   301→- relationship 记录保存\n   302→\n   303→**优先级 3: 支付系统集成**\n   304→- Stripe Checkout 完整流程\n   305→- Webhook 处理\n   306→- 订阅状态管理\n   307→\n   308→**优先级 4: 前端细节打磨**\n   309→- 报告展示页面\n   310→- 付费墙 UI\n   311→- 访谈流程优化\n   312→\n   313→### 6.2 后续迭代（Phase 2）\n   314→\n   315→- 主动推送系统\n   316→- SOS 情绪急救\n   317→- 更多 Skill 扩展\n   318→\n   319→---\n   320→\n   321→## 7. 结论\n   322→\n   323→### 当前状态总结\n   324→\n   325→✅ **核心引擎完备**: Vibe Engine、Portrait、Knowledge 全部就绪\n   326→✅ **功能覆盖率高**: Spec v3.0 P0 功能 ~85% 完成\n   327→✅ **架构设计合理**: 支持子域名 + 深度定制 UI 的扩展\n   328→\n   329→### 最佳模式建议\n   330→\n   331→1. **采用子域名 + 路由组隔离架构**\n   332→   - `(www)/`、`(bazi)/`、`(zodiac)/` 路由组物理隔离\n   333→   - 每个 skill 专属 layout + 主题 + 独立页面文件\n   334→   - 共享 components/core、components/chat 和后端服务\n   335→   - Vercel rewrites 映射子域名到对应路由组\n   336→\n   337→2. **Phase 1 实现品牌索引页**\n   338→   - www.vibelife.app 作为品牌入口\n   339→   - 引导用户选择 bazi/zodiac 子站\n   340→\n   341→3. **共享账户 + 独立收费**\n   342→   - Cookie 设在 .vibelife.app 根域名，实现 SSO\n   343→   - 各 Skill 独立订阅，系统支持差异化定价能力\n   344→   - 定价策略待定，Phase 1 暂用统一定价\n   345→\n   346→4. **清理 archive 代码**\n   347→   - 将有价值的页面迁移到新架构\n   348→   - 删除冗余代码\n   349→\n   350→5. **补完持久化层**\n   351→   - 将模拟数据替换为真实数据库操作\n   352→   - 完善支付流程\n   353→\n   354→6. **严格遵循 Spec v3.0**\n   355→   - Phase 1 聚焦核心付费转化\n   356→   - P2 功能明确延后\n   357→\n   358→---\n   359→\n   360→## 关键文件路径\n   361→\n   362→### 前端\n   363→- `apps/web/src/middleware.ts` - 子域名路由\n   364→- `apps/web/src/providers/SkillProvider.tsx` - Skill 上下文\n   365→- `apps/web/src/app/` - 页面路由\n   366→- `apps/web/archive/app/` - 存档页面（待迁移）\n   367→\n   368→### 后端\n   369→- `apps/api/services/vibe_engine/` - 核心引擎\n   370→- `apps/api/routes/` - API 端点\n   371→- `apps/api/stores/` - 数据存储\n   372→\n   373→### 文档\n   374→- `docs/vibelife spec v3.0.md` - 产品规格\n   375→- `docs/config.md` - 配置文档\n   376→- `docs/deployment.md` - 部署指南\n   377→- `docs/archive/v2/user-case-analysis-report.md` - 用户案例分析\n   378→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7bfec54b-a21a-4e18-bfb1-dc58d0d92ef2","timestamp":"2026-01-07T10:04:44.471Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/vibelife/docs/archive/v3/implementation-status-analysis.md","content":"# VibeLife 实现状态分析 & 最佳架构建议\n\n> **分析日期**: 2026-01-07\n> **分析目标**: 对比 Spec v3.0 与当前实现，确定最佳架构模式\n> **用户核心诉求**: 功能完整度优先 + 独立子域名深度定制 UI\n\n---\n\n## 1. 当前实现 vs Spec v3.0 对比总结\n\n### 1.1 整体完成度\n\n| 模块 | Spec v3.0 要求 | 当前状态 | 完成度 |\n|------|---------------|----------|--------|\n| **Vibe Engine** | LLM + Portrait + Context | ✅ 完整实现 | 100% |\n| **访谈系统** | 强制访谈 + 信息抽取 | ✅ 完整实现 | 100% |\n| **报告生成** | lite/full + AI 生图 + 卷首语 | ✅ 核心完成 | 85% |\n| **Identity Prism** | Inner/Core/Outer 三元 | ✅ 完整实现 | 100% |\n| **人生 K-Line** | 大运/流年可视化 | ✅ 完整实现 | 95% |\n| **Daily Greeting** | 节气 + 24 季节 | ✅ 完整实现 | 100% |\n| **关系模拟器** | 单人/Vibe Link/话术模板 | ✅ 完整实现 | 100% |\n| **知识库** | 八字 + 星座专业内容 | ✅ 已建立 | 100% |\n| **数据库 Schema** | v3.0 完整表结构 | ✅ 已设计 | 90% |\n| **支付系统** | Stripe 集成 | ⚠️ 骨架阶段 | 30% |\n| **前端页面** | 三栏布局 + 移动端优先 | ✅ 基本完成 | 85% |\n\n### 1.2 核心差距\n\n**需要补完的部分**：\n1. 数据库持久化（部分 API 使用模拟数据）\n2. 支付系统完整集成（Stripe webhook 等）\n3. 前端部分页面细节（报告展示、付费流程 UI）\n\n---\n\n## 2. 前端页面结构现状\n\n### 2.1 当前活跃页面 (src/app)\n\n| 路由 | 文件 | 说明 |\n|------|------|------|\n| `/` | page.tsx | 首页/登陆页 |\n| `/chat` | chat/page.tsx | 主聊天页面（三栏布局） |\n| `/auth/login` | auth/login/page.tsx | 登录页 |\n| `/auth/register` | auth/register/page.tsx | 注册页 |\n| `/auth/sso-callback` | auth/sso-callback/page.tsx | SSO 回调页 |\n\n### 2.2 存档页面 (archive/app)\n\n| 路由 | 说明 |\n|------|------|\n| `/bazi` | 八字首页 |\n| `/bazi/chat` | 八字聊天页 |\n| `/zodiac` | 星座首页 |\n| `/zodiac/chat` | 星座聊天页 |\n| `/mbti` | MBTI 首页 |\n| `/mbti/chat` | MBTI 聊天页 |\n\n### 2.3 当前路由机制\n\n- `middleware.ts` - 子域名检测自动设置 skill\n- 支持的 skills: `[\"bazi\", \"zodiac\", \"mbti\", \"attach\", \"career\"]`\n- 默认 skill: `bazi`\n\n---\n\n## 3. 子域名 + 深度定制 UI 架构分析\n\n### 3.1 可行性：完全可行 ✅\n\nNext.js 14 完全支持此模式，当前代码已有基础：\n\n**现有实现**：\n- `middleware.ts` 已实现子域名检测\n- `SkillProvider.tsx` 已支持 skill 上下文切换\n\n**实现方式**：\n```\nbazi.vibelife.app → skill=bazi → (bazi)/ 路由组\nzodiac.vibelife.app → skill=zodiac → (zodiac)/ 路由组\n```\n\n### 3.2 推荐架构模式\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        子域名入口                                │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│   bazi.vibelife.app        zodiac.vibelife.app                 │\n│        │                         │                              │\n│        ▼                         ▼                              │\n│   ┌─────────────────┐      ┌─────────────────┐                 │\n│   │  Bazi 专属 UI   │      │ Zodiac 专属 UI  │                 │\n│   │                 │      │                 │                  │\n│   │ • 命盘可视化    │      │ • 星盘图表      │                  │\n│   │ • 玄金配色      │      │ • 星蓝配色      │                  │\n│   │ • 八字术语展示  │      │ • 行星运行动画  │                  │\n│   │ • 大运流年 UI   │      │ • 水逆/月相 UI  │                  │\n│   └────────┬────────┘      └────────┬────────┘                 │\n│            │                        │                           │\n│            └──────────┬─────────────┘                           │\n│                       ▼                                         │\n│           ┌─────────────────────────┐                          │\n│           │    共享组件层            │                          │\n│           │                         │                          │\n│           │ • ChatContainer         │                          │\n│           │ • InsightCard           │                          │\n│           │ • LuminousPaper         │                          │\n│           │ • BreathAura            │                          │\n│           └────────────┬────────────┘                          │\n│                        │                                        │\n│                        ▼                                        │\n│           ┌─────────────────────────┐                          │\n│           │    共享后端服务          │                          │\n│           │                         │                          │\n│           │ • Vibe Engine           │                          │\n│           │ • Report Service        │                          │\n│           │ • Relationship Service  │                          │\n│           │ • Knowledge Retrieval   │                          │\n│           └─────────────────────────┘                          │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### 3.3 代码组织建议\n\n> **架构决策**：采用「路由组隔离」模式，(bazi)/chat 和 (zodiac)/chat 各自有独立页面文件，但共享 components/core 和 components/chat 组件。\n\n```\napps/web/src/\n├── app/\n│   ├── (www)/               # 主站路由组（品牌索引页）\n│   │   ├── layout.tsx       # 主站布局\n│   │   └── page.tsx         # 品牌索引页（Phase 1 实现）\n│   │\n│   ├── (bazi)/              # Bazi 路由组\n│   │   ├── layout.tsx       # Bazi 专属布局（玄金配色）\n│   │   ├── page.tsx         # Bazi 首页（命盘快览）\n│   │   ├── chat/\n│   │   │   └── page.tsx     # Bazi 聊天页\n│   │   ├── chart/\n│   │   │   └── page.tsx     # Bazi 命盘详情\n│   │   └── report/\n│   │       └── page.tsx     # Bazi 报告页\n│   │\n│   ├── (zodiac)/            # Zodiac 路由组\n│   │   ├── layout.tsx       # Zodiac 专属布局（星蓝配色）\n│   │   ├── page.tsx         # Zodiac 首页（星盘快览）\n│   │   ├── chat/\n│   │   │   └── page.tsx     # Zodiac 聊天页\n│   │   ├── chart/\n│   │   │   └── page.tsx     # Zodiac 星盘详情\n│   │   └── report/\n│   │       └── page.tsx     # Zodiac 报告页\n│   │\n│   ├── (shared)/            # 共享路由（跨子域名共用）\n│   │   ├── auth/\n│   │   │   ├── login/page.tsx\n│   │   │   ├── register/page.tsx\n│   │   │   └── sso-callback/page.tsx\n│   │   └── me/\n│   │       ├── page.tsx          # 个人中心\n│   │       └── subscriptions/page.tsx  # 订阅管理\n│   │\n│   └── middleware.ts        # 子域名路由\n│\n├── components/\n│   ├── core/                # 共享核心组件\n│   ├── chat/                # 共享聊天组件\n│   ├── bazi/                # Bazi 专属组件\n│   │   ├── BaziChart.tsx    # 八字命盘\n│   │   ├── WuxingDisplay.tsx # 五行展示\n│   │   └── DayunTimeline.tsx # 大运时间线\n│   └── zodiac/              # Zodiac 专属组件\n│       ├── NatalChart.tsx   # 本命星盘\n│       ├── PlanetPositions.tsx\n│       └── TransitOverlay.tsx\n│\n└── styles/\n    ├── globals.css          # 共享样式\n    ├── bazi-theme.css       # Bazi 主题（玄金/朱砂）\n    └── zodiac-theme.css     # Zodiac 主题（星蓝/金线）\n```\n\n### 3.4 部署配置\n\n**Vercel 配置**（vercel.json）:\n```json\n{\n  \"rewrites\": [\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"bazi.vibelife.app\" }],\n      \"destination\": \"/bazi/:path*\"\n    },\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"zodiac.vibelife.app\" }],\n      \"destination\": \"/zodiac/:path*\"\n    },\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"www.vibelife.app\" }],\n      \"destination\": \"/www/:path*\"\n    }\n  ]\n}\n```\n\n> **路由策略说明**：采用路由组物理隔离模式，每个子域名映射到对应的路由组目录，实现深度定制 UI。\n\n---\n\n## 4. 后端实现状态详情\n\n### 4.1 核心服务模块（完整实现）\n\n```\nservices/ (11,062 行代码)\n├── vibe_engine/           ✅ 核心引擎\n│   ├── llm.py             ✅ 多 LLM 支持 (Zhipu/Claude/Gemini)\n│   ├── context.py         ✅ LLM 上下文构建\n│   ├── portrait.py        ✅ 用户画像管理 (4层结构)\n│   ├── portrait_service.py ✅ 画像服务\n│   ├── llm_orchestrator.py ✅ LLM 编排器\n│   ├── emotion_engine.py  ✅ 情感分析引擎\n│   ├── insight_generator.py ✅ 洞察生成器\n│   └── memory_system.py   ✅ 记忆系统\n│\n├── agent/                 ✅ Agent 运行时\n├── interview/             ✅ 访谈系统\n├── report/                ✅ 报告生成\n├── relationship/          ✅ 关系分析\n├── fortune/               ✅ 运势计算\n├── greeting/              ✅ 日常问候\n├── knowledge/             ✅ 知识检索\n├── extraction/            ✅ 文件提取\n├── identity/              ✅ 身份验证\n└── billing/               ✅ 计费（骨架）\n```\n\n### 4.2 API 端点实现状态\n\n| 路由 | 状态 | 说明 |\n|------|------|------|\n| `/api/v1/auth/*` | ✅ | 完整认证流程 |\n| `/api/v1/chat/*` | ✅ | 流式聊天 + 访谈 |\n| `/api/v1/report/*` | ✅ | 报告生成（部分持久化待完善）|\n| `/api/v1/relationship/*` | ✅ | 关系分析 + Vibe Link |\n| `/api/v1/fortune/*` | ✅ | K 线 + 运势 |\n| `/api/v1/payment/*` | ⚠️ | 骨架阶段 |\n\n---\n\n## 5. Phase 1 功能完整度清单\n\n根据 Spec v3.0 P0/P0+ 定义，Phase 1 需要完成：\n\n### 5.1 P0 功能（必须上线）\n\n| 功能 | 当前状态 | 差距 |\n|------|---------|------|\n| 深度报告生成 | ✅ 已实现 | 前端展示细节 |\n| 对话式咨询（流式+语气切换）| ✅ 已实现 | - |\n| Identity Prism | ✅ 已实现 | 前端 TriToggle 组件细节 |\n| Relationship Simulator | ✅ 已实现 | Vibe Link UI 细节 |\n| 人生 K 线 | ✅ 已实现 | ECharts 交互细节 |\n| 智能信息采集 | ✅ 已实现 | - |\n| Now/Next 趋势视图 | ✅ 已实现 | - |\n| 洞察卡片系统 | ✅ 已实现 | - |\n\n### 5.2 P0+ 功能（强制上线）\n\n| 功能 | 当前状态 | 差距 |\n|------|---------|------|\n| Daily Greeting | ✅ 已实现 | 强制展示逻辑需前端配合 |\n\n### 5.3 P2 功能（Phase 2 延后）\n\n- ❌ 主动推送系统\n- ❌ 每日微行动 + 打卡\n- ❌ SOS 情绪急救模式\n- ❌ MBTI Skill\n- ❌ 长程计划追踪\n\n---\n\n## 6. 实施建议\n\n### 6.1 立即执行（补完 Phase 1）\n\n**优先级 1: 前端子域名架构重构**\n- 将 archive 中的 bazi/zodiac 页面迁移到路由组模式\n- 实现 skill 专属主题切换\n- 确保组件复用最大化\n\n**优先级 2: 数据库持久化补完**\n- conversations 真实存储\n- reports 持久化\n- relationship 记录保存\n\n**优先级 3: 支付系统集成**\n- Stripe Checkout 完整流程\n- Webhook 处理\n- 订阅状态管理\n\n**优先级 4: 前端细节打磨**\n- 报告展示页面\n- 付费墙 UI\n- 访谈流程优化\n\n### 6.2 后续迭代（Phase 2）\n\n- 主动推送系统\n- SOS 情绪急救\n- 更多 Skill 扩展\n\n---\n\n## 7. 结论\n\n### 当前状态总结\n\n✅ **核心引擎完备**: Vibe Engine、Portrait、Knowledge 全部就绪\n✅ **功能覆盖率高**: Spec v3.0 P0 功能 ~85% 完成\n✅ **架构设计合理**: 支持子域名 + 深度定制 UI 的扩展\n\n### 最佳模式建议\n\n1. **采用子域名 + 路由组隔离架构**\n   - `(www)/`、`(bazi)/`、`(zodiac)/` 路由组物理隔离\n   - 每个 skill 专属 layout + 主题 + 独立页面文件\n   - 共享 components/core、components/chat 和后端服务\n   - Vercel rewrites 映射子域名到对应路由组\n\n2. **Phase 1 实现品牌索引页**\n   - www.vibelife.app 作为品牌入口\n   - 引导用户选择 bazi/zodiac 子站\n\n3. **共享账户 + 独立收费**\n   - Cookie 设在 .vibelife.app 根域名，实现 SSO\n   - 各 Skill 独立订阅，系统支持差异化定价能力\n   - 定价策略待定，Phase 1 暂用统一定价\n\n4. **清理 archive 代码**\n   - 将有价值的页面迁移到新架构\n   - 删除冗余代码\n\n5. **补完持久化层**\n   - 将模拟数据替换为真实数据库操作\n   - 完善支付流程\n\n6. **严格遵循 Spec v3.0**\n   - Phase 1 聚焦核心付费转化\n   - P2 功能明确延后\n\n---\n\n## 关键文件路径\n\n### 前端\n- `apps/web/src/middleware.ts` - 子域名路由\n- `apps/web/src/providers/SkillProvider.tsx` - Skill 上下文\n- `apps/web/src/app/` - 页面路由\n- `apps/web/archive/app/` - 存档页面（待迁移）\n\n### 后端\n- `apps/api/services/vibe_engine/` - 核心引擎\n- `apps/api/routes/` - API 端点\n- `apps/api/stores/` - 数据存储\n\n### 文档\n- `docs/vibelife spec v3.0.md` - 产品规格\n- `docs/config.md` - 配置文档\n- `docs/deployment.md` - 部署指南\n- `docs/archive/v2/user-case-analysis-report.md` - 用户案例分析\n","numLines":378,"startLine":1,"totalLines":378}}}
{"parentUuid":"7bfec54b-a21a-4e18-bfb1-dc58d0d92ef2","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01CFGsUaBART6GBoNngmKcvQ","type":"tool_result","content":"     1→# VibeLife Chat 流程文档\n     2→\n     3→> 基于 v3 架构代码分析，2026-01-07\n     4→\n     5→## 整体架构图\n     6→\n     7→```\n     8→┌─────────────────────────────────────────────────────────────────────────────┐\n     9→│                              FRONTEND (Next.js)                              │\n    10→├─────────────────────────────────────────────────────────────────────────────┤\n    11→│                                                                              │\n    12→│  ┌──────────────┐    onSend()    ┌──────────────────┐                       │\n    13→│  │  ChatInput   │ ─────────────► │  ChatContainer   │                       │\n    14→│  │  (textarea)  │                │   handleSend()   │                       │\n    15→│  └──────────────┘                └────────┬─────────┘                       │\n    16→│                                           │                                  │\n    17→│                                           ▼                                  │\n    18→│                                  ┌──────────────────┐                       │\n    19→│                                  │    api.ts        │                       │\n    20→│                                  │  sendMessage()   │                       │\n    21→│                                  └────────┬─────────┘                       │\n    22→│                                           │                                  │\n    23→└───────────────────────────────────────────┼─────────────────────────────────┘\n    24→                                            │ POST /api/v1/chat/\n    25→                                            │ Authorization: Bearer {token}\n    26→                                            ▼\n    27→┌─────────────────────────────────────────────────────────────────────────────┐\n    28→│                              BACKEND (FastAPI)                               │\n    29→├─────────────────────────────────────────────────────────────────────────────┤\n    30→│                                                                              │\n    31→│  ┌──────────────────┐                                                       │\n    32→│  │  routes/chat.py  │  POST /chat/                                          │\n    33→│  │  ───────────────                                                         │\n    34→│  │  1. parse_skill()                                                        │\n    35→│  │  2. get_user_profile()                                                   │\n    36→│  │  3. get_conversation_history()                                           │\n    37→│  │  4. save_message(user)                                                   │\n    38→│  └────────┬─────────┘                                                       │\n    39→│           │                                                                  │\n    40→│           ▼                                                                  │\n    41→│  ┌────────────────────────────────────────────────────────────┐             │\n    42→│  │              VIBE ENGINE (services/vibe_engine/)           │             │\n    43→│  │  ┌─────────────────┐      ┌─────────────────────────────┐  │             │\n    44→│  │  │  context.py     │      │  llm.py                     │  │             │\n    45→│  │  │  ContextBuilder │ ───► │  LLMService                 │  │             │\n    46→│  │  │  ─────────────  │      │  ────────────               │  │             │\n    47→│  │  │  • system_prompt│      │  • Zhipu (primary)         │  │             │\n    48→│  │  │  • topic分类    │      │  • Claude (fallback)       │  │             │\n    49→│  │  │  • profile选择  │      │  • Gemini (backup)         │  │             │\n    50→│  │  │  • history格式化│      └─────────────────────────────┘  │             │\n    51→│  │  └─────────────────┘                                       │             │\n    52→│  └────────────────────────────────────────────────────────────┘             │\n    53→│           │                                                                  │\n    54→│           ▼                                                                  │\n    55→│  ┌──────────────────┐                                                       │\n    56→│  │  5. save_message │  (assistant response)                                 │\n    57→│  │  6. return JSON  │                                                       │\n    58→│  └──────────────────┘                                                       │\n    59→│                                                                              │\n    60→└─────────────────────────────────────────────────────────────────────────────┘\n    61→                                            │\n    62→                                            │ ChatResponse JSON\n    63→                                            ▼\n    64→┌─────────────────────────────────────────────────────────────────────────────┐\n    65→│  FRONTEND: ChatContainer receives response                                   │\n    66→│  → setMessages([...prev, assistantMessage])                                 │\n    67→│  → ChatMessage renders assistant bubble                                      │\n    68→└─────────────────────────────────────────────────────────────────────────────┘\n    69→```\n    70→\n    71→---\n    72→\n    73→## 详细流程分解\n    74→\n    75→### 1. 前端输入层\n    76→\n    77→```\n    78→ChatInput.tsx                         ChatContainer.tsx\n    79→┌────────────────────┐               ┌─────────────────────────────────┐\n    80→│ <textarea>         │   Enter键     │ handleSend(content)             │\n    81→│ ┌────────────────┐ │ ───────────►  │ ┌─────────────────────────────┐ │\n    82→│ │ 用户输入消息    │ │               │ │ 1. 创建 userMessage         │ │\n    83→│ └────────────────┘ │               │ │ 2. setMessages(prev+user)   │ │\n    84→│ [🎤] [📷] [发送]  │               │ │ 3. setIsLoading(true)       │ │\n    85→└────────────────────┘               │ │ 4. await sendMessage(...)   │ │\n    86→                                     │ └─────────────────────────────┘ │\n    87→                                     └─────────────────────────────────┘\n    88→```\n    89→\n    90→**关键代码**: `apps/web/src/components/chat/ChatContainer.tsx:224-299`\n    91→\n    92→```typescript\n    93→const handleSend = async (content: string) => {\n    94→  // 1. 添加用户消息到状态\n    95→  const userMessage: Message = {\n    96→    id: Date.now().toString(),\n    97→    role: \"user\",\n    98→    content,\n    99→    timestamp: new Date().toLocaleTimeString(),\n   100→  };\n   101→  setMessages((prev) => [...prev, userMessage]);\n   102→  setIsLoading(true);\n   103→\n   104→  // 2. 发送到后端\n   105→  const response: ChatResponse = await sendMessage({\n   106→    message: content,\n   107→    skill_id: skillId,\n   108→    conversation_id: currentConvoId,\n   109→  });\n   110→\n   111→  // 3. 处理新会话创建\n   112→  if (!currentConvoId && response.conversation_id) {\n   113→    setCurrentConvoId(response.conversation_id);\n   114→  }\n   115→\n   116→  // 4. 显示助手响应\n   117→  const assistantMessage: Message = {\n   118→    id: (Date.now() + 1).toString(),\n   119→    role: \"assistant\",\n   120→    content: response.content,\n   121→    insight: response.insight,\n   122→  };\n   123→  setMessages((prev) => [...prev, assistantMessage]);\n   124→};\n   125→```\n   126→\n   127→---\n   128→\n   129→### 2. API 调用层\n   130→\n   131→**关键代码**: `apps/web/src/lib/api.ts:208-220`\n   132→\n   133→```typescript\n   134→export async function sendMessage(request: ChatRequest): Promise<ChatResponse> {\n   135→  const response = await fetchAPI(\"/chat/\", {\n   136→    method: \"POST\",\n   137→    body: JSON.stringify(request),\n   138→  });\n   139→  return response.json();\n   140→}\n   141→```\n   142→\n   143→**请求结构**:\n   144→```typescript\n   145→interface ChatRequest {\n   146→  message: string;              // 用户输入\n   147→  skill_id: string;            // \"bazi\" | \"zodiac\"\n   148→  conversation_id?: string;    // UUID，续聊时提供\n   149→}\n   150→```\n   151→\n   152→**响应结构**:\n   153→```typescript\n   154→interface ChatResponse {\n   155→  content: string;             // 助手响应\n   156→  conversation_id: string;     // UUID\n   157→  intent?: string;\n   158→  tools_used?: string[];\n   159→  knowledge_used: boolean;\n   160→  insight?: {                  // 可选洞察卡片\n   161→    id: string;\n   162→    insight_type: string;\n   163→    title: string;\n   164→    content: string;\n   165→  };\n   166→}\n   167→```\n   168→\n   169→---\n   170→\n   171→### 3. 后端路由处理\n   172→\n   173→**关键代码**: `apps/api/routes/chat.py:220-273`\n   174→\n   175→```\n   176→@router.post(\"/chat/\") 处理流程\n   177→┌─────────────────────────────────────────────────────────────┐\n   178→│                                                              │\n   179→│  ChatRequest                    处理流程                     │\n   180→│  ┌────────────────┐            ┌────────────────────────┐   │\n   181→│  │ message        │            │ 1. parse_skill()       │   │\n   182→│  │ skill          │ ─────────► │    \"bazi\" → Skill.BAZI │   │\n   183→│  │ conversation_id│            │                        │   │\n   184→│  │ voice_mode     │            │ 2. get_user_profile()  │   │\n   185→│  └────────────────┘            │    从 profile_repo 获取 │   │\n   186→│                                │                        │   │\n   187→│                                │ 3. get_conversation_   │   │\n   188→│                                │    history() 最近20条   │   │\n   189→│                                │                        │   │\n   190→│                                │ 4. save_message()      │   │\n   191→│                                │    保存用户消息到 DB    │   │\n   192→│                                └────────────────────────┘   │\n   193→│                                                              │\n   194→└─────────────────────────────────────────────────────────────┘\n   195→```\n   196→\n   197→**请求模型** (Python):\n   198→```python\n   199→class ChatRequest(BaseModel):\n   200→    message: str\n   201→    skill: str  # \"bazi\" or \"zodiac\"\n   202→    conversation_id: Optional[UUID] = None\n   203→    voice_mode: Optional[str] = \"warm\"  # warm | sarcastic\n   204→```\n   205→\n   206→**响应模型**:\n   207→```python\n   208→class ChatResponse(BaseModel):\n   209→    content: str\n   210→    conversation_id: UUID\n   211→    skill: str\n   212→    voice_mode: str\n   213→    metadata: Optional[dict] = None  # model, usage\n   214→```\n   215→\n   216→---\n   217→\n   218→### 4. Vibe Engine - 上下文构建\n   219→\n   220→**关键代码**: `apps/api/services/vibe_engine/context.py:342-394`\n   221→\n   222→```\n   223→ContextBuilder.build() 处理流程\n   224→┌───────────────────────────────────────────────────────────────────────┐\n   225→│                                                                        │\n   226→│  输入                           输出                                   │\n   227→│  ─────                          ────                                   │\n   228→│  • skill (BAZI/ZODIAC)          system_prompt:                        │\n   229→│  • voice_mode (WARM/SARCASTIC)  ┌────────────────────────────────┐    │\n   230→│  • current_message               │ # Vibe 人设                     │    │\n   231→│  • profile (用户画像)            │ 你是 Vibe，用户的知己...        │    │\n   232→│  • history (对话历史)            │                                 │    │\n   233→│                                  │ # 八字技能上下文                │    │\n   234→│  处理步骤:                       │ 你是资深命理师...              │    │\n   235→│  1. build_system_prompt()        │                                 │    │\n   236→│  2. classify_topic() → Topic     │ # 语气模式                     │    │\n   237→│     • CAREER (工作相关)          │ 共情、支持、鼓励...            │    │\n   238→│     • RELATIONSHIP (感情)        │                                 │    │\n   239→│     • FORTUNE (运势)             │ # 用户画像 (XML)               │    │\n   240→│     • SELF (性格)                │ <profile>...</profile>         │    │\n   241→│     • GENERAL (通用)             └────────────────────────────────┘    │\n   242→│  3. select_profile_sections()                                          │\n   243→│     按 topic 选择相关画像片段    messages[]:                          │\n   244→│  4. format_profile_context()     [system, history..., user_msg]       │\n   245→│                                                                        │\n   246→└───────────────────────────────────────────────────────────────────────┘\n   247→```\n   248→\n   249→**话题分类规则**:\n   250→- CAREER: 工作, 职业, 事业, 创业, 面试\n   251→- RELATIONSHIP: 感情, 恋爱, 婚姻, 家人\n   252→- FORTUNE: 运势, 大运, 流年, 什么时候\n   253→- SELF: 性格, 优点, 缺点, 了解自己\n   254→- GENERAL: 默认\n   255→\n   256→**按话题选择画像片段**:\n   257→- CAREER → career + growth_areas\n   258→- RELATIONSHIP → relationship + relationship_patterns + communication_style\n   259→- FORTUNE → current_focus + recent_events\n   260→- SELF → all ai_insights\n   261→- GENERAL → current_focus + personality_traits\n   262→\n   263→---\n   264→\n   265→### 5. Vibe Engine - LLM 调用\n   266→\n   267→**关键代码**: `apps/api/services/vibe_engine/llm.py:304-370`\n   268→\n   269→```\n   270→LLMService.chat() 调用流程\n   271→┌───────────────────────────────────────────────────────────────────────┐\n   272→│                                                                        │\n   273→│                          ┌─────────────────┐                          │\n   274→│                          │  Primary: Zhipu │                          │\n   275→│  messages[] ──────────►  │  glm-4-plus     │                          │\n   276→│                          └────────┬────────┘                          │\n   277→│                                   │                                    │\n   278→│                          成功?    │    失败?                          │\n   279→│                            │      │      │                            │\n   280→│                            ▼      │      ▼                            │\n   281→│                     ┌──────────┐  │  ┌─────────────────┐              │\n   282→│                     │ 返回响应  │  │  │ Fallback: Claude│              │\n   283→│                     └──────────┘  │  │ claude-sonnet   │              │\n   284→│                                   │  └────────┬────────┘              │\n   285→│                                   │           │                        │\n   286→│                                   │    失败?  │  成功?                │\n   287→│                                   │      │    │    │                  │\n   288→│                                   │      ▼    │    ▼                  │\n   289→│                                   │  ┌──────────────────┐             │\n   290→│                                   │  │ Raise Exception  │             │\n   291→│                                   │  └──────────────────┘             │\n   292→│                                                                        │\n   293→└───────────────────────────────────────────────────────────────────────┘\n   294→```\n   295→\n   296→**LLM 配置**:\n   297→```python\n   298→@dataclass\n   299→class LLMConfig:\n   300→    zhipu_api_key: str          # Primary: Zhipu GLM-4-Plus\n   301→    zhipu_base_url: str         # https://open.bigmodel.cn/api/paas/v4\n   302→    zhipu_chat_model: str       # glm-4-plus\n   303→    claude_api_key: str         # Backup: Claude\n   304→    claude_model: str           # claude-3-5-sonnet-20241022\n   305→    default_provider: LLMProvider = LLMProvider.ZHIPU\n   306→```\n   307→\n   308→**LLM 响应结构**:\n   309→```python\n   310→@dataclass\n   311→class LLMResponse:\n   312→    content: str                    # 生成文本\n   313→    model: str                      # 使用的模型\n   314→    provider: LLMProvider           # ZHIPU | CLAUDE | GEMINI\n   315→    usage: Optional[Dict[str, int]] # {input_tokens, output_tokens}\n   316→    finish_reason: Optional[str]    # \"stop\" | \"length\"\n   317→```\n   318→\n   319→---\n   320→\n   321→### 6. 响应返回\n   322→\n   323→```\n   324→                    Backend                              Frontend\n   325→┌──────────────────────────────────┐    ┌──────────────────────────────────┐\n   326→│  save_message(assistant, resp)   │    │  ChatContainer                   │\n   327→│              │                   │    │                                  │\n   328→│              ▼                   │    │  response = await sendMessage()  │\n   329→│  return ChatResponse {           │───►│              │                   │\n   330→│    content: \"根据你的八字...\",   │    │              ▼                   │\n   331→│    conversation_id: uuid,        │    │  if (!currentConvoId) {          │\n   332→│    skill: \"bazi\",                │    │    setCurrentConvoId(resp.id)    │\n   333→│    voice_mode: \"warm\",           │    │  }                               │\n   334→│    metadata: {model, usage}      │    │              │                   │\n   335→│  }                               │    │              ▼                   │\n   336→└──────────────────────────────────┘    │  setMessages([...prev, {         │\n   337→                                        │    role: \"assistant\",            │\n   338→                                        │    content: resp.content,        │\n   339→                                        │    insight: resp.insight         │\n   340→                                        │  }])                             │\n   341→                                        │              │                   │\n   342→                                        │              ▼                   │\n   343→                                        │  ChatMessage renders             │\n   344→                                        └──────────────────────────────────┘\n   345→```\n   346→\n   347→---\n   348→\n   349→## 数据流转示意\n   350→\n   351→```\n   352→┌─────────────────────────────────────────────────────────────────────────────┐\n   353→│                            完整数据流转                                      │\n   354→├─────────────────────────────────────────────────────────────────────────────┤\n   355→│                                                                              │\n   356→│  用户输入          前端 Request            后端 Request                     │\n   357→│  ─────────         ────────────            ────────────                     │\n   358→│  \"我是90年         {                       ChatRequest(                     │\n   359→│   5月15日           message: \"...\",         message=\"...\",                  │\n   360→│   出生的\"           skill_id: \"bazi\",       skill=\"bazi\",                   │\n   361→│                     conversation_id:null    conversation_id=None,          │\n   362→│                   }                         voice_mode=\"warm\"              │\n   363→│                                           )                                 │\n   364→│                                                                              │\n   365→│  ════════════════════════════════════════════════════════════════════════   │\n   366→│                                                                              │\n   367→│  LLM Messages                                                               │\n   368→│  ────────────                                                               │\n   369→│  [                                                                          │\n   370→│    {role: \"system\", content: \"# Vibe 人设\\n你是Vibe...\"},                  │\n   371→│    {role: \"user\", content: \"[历史] 你好\"},                                  │\n   372→│    {role: \"assistant\", content: \"[历史] 你好呀！...\"},                      │\n   373→│    {role: \"user\", content: \"我是90年5月15日出生的\"}   ← current            │\n   374→│  ]                                                                          │\n   375→│                                                                              │\n   376→│  ════════════════════════════════════════════════════════════════════════   │\n   377→│                                                                              │\n   378→│  后端 Response             前端 Response           UI 渲染                  │\n   379→│  ────────────              ────────────            ────────                  │\n   380→│  ChatResponse(             {                       ┌──────────────────┐     │\n   381→│    content=\"根据...\",       content: \"根据...\",    │ 👤 我是90年...   │     │\n   382→│    conversation_id=uuid,    conversation_id:uuid,  ├──────────────────┤     │\n   383→│    skill=\"bazi\",            skill: \"bazi\",         │ 🔮 根据你的      │     │\n   384→│    voice_mode=\"warm\",       metadata: {...}        │    八字...       │     │\n   385→│    metadata={...}         }                        └──────────────────┘     │\n   386→│  )                                                                          │\n   387→│                                                                              │\n   388→└─────────────────────────────────────────────────────────────────────────────┘\n   389→```\n   390→\n   391→---\n   392→\n   393→## 关键代码文件清单\n   394→\n   395→| 层级 | 文件路径 | 核心功能 |\n   396→|------|----------|----------|\n   397→| 前端输入 | `apps/web/src/components/chat/ChatInput.tsx` | 文本输入框组件 |\n   398→| 前端容器 | `apps/web/src/components/chat/ChatContainer.tsx` | 消息状态管理、API调用 |\n   399→| 前端消息 | `apps/web/src/components/chat/ChatMessage.tsx` | 消息气泡渲染 |\n   400→| API客户端 | `apps/web/src/lib/api.ts` | HTTP请求封装、token管理 |\n   401→| 后端路由 | `apps/api/routes/chat.py` | `/chat/` 端点处理 |\n   402→| 上下文构建 | `apps/api/services/vibe_engine/context.py` | system prompt、话题分类 |\n   403→| LLM调用 | `apps/api/services/vibe_engine/llm.py` | Zhipu/Claude 调用 |\n   404→| 用户画像 | `apps/api/services/vibe_engine/portrait.py` | profile 数据结构 |\n   405→| 会话存储 | `apps/api/stores/conversation_repo.py` | 会话持久化 |\n   406→| 消息存储 | `apps/api/stores/message_repo.py` | 消息持久化 |\n   407→\n   408→---\n   409→\n   410→## 语气模式系统\n   411→\n   412→### WARM 模式 (默认)\n   413→- 风格: 共情、支持、鼓励\n   414→- 用词: \"我感觉到\", \"你可能\", \"值得尝试\"\n   415→- 像温暖的朋友聊天\n   416→\n   417→### SARCASTIC 模式\n   418→- 风格: 直接、犀利、有趣\n   419→- 用词: \"得了吧\", \"说白了\", \"典型的...\"\n   420→- 像毒舌但关心你的朋友\n   421→\n   422→---\n   423→\n   424→## 用户画像结构\n   425→\n   426→```python\n   427→DEFAULT_PROFILE = {\n   428→    \"version\": \"1.0\",\n   429→    \"basic\": {\n   430→        \"birth_datetime\": None,    # 出生时间\n   431→        \"birth_location\": None,    # 出生地点\n   432→        \"gender\": None,\n   433→        \"name\": None,\n   434→        \"occupation\": None\n   435→    },\n   436→    \"life_context\": {\n   437→        \"career\": {...},           # 职业信息\n   438→        \"relationship\": {...},     # 感情状态\n   439→        \"current_focus\": [],       # 当前关注点\n   440→        \"life_stage\": None,\n   441→        \"recent_events\": []\n   442→    },\n   443→    \"ai_insights\": {\n   444→        \"personality_traits\": [],  # 性格特点\n   445→        \"communication_style\": None,\n   446→        \"emotional_patterns\": {...},\n   447→        \"relationship_patterns\": {...},\n   448→        \"growth_areas\": []\n   449→    },\n   450→    \"identity_prism\": {\n   451→        \"core\": {...},             # 核心驱动\n   452→        \"inner\": {...},            # 内在关注\n   453→        \"outer\": {...}             # 外在表现\n   454→    }\n   455→}\n   456→```\n   457→\n   458→---\n   459→\n   460→## 配置参数\n   461→\n   462→| 参数 | 值 | 说明 |\n   463→|------|-----|------|\n   464→| 历史消息限制 | 20条 | get_conversation_history limit |\n   465→| Profile上下文 | ~1000 tokens | 画像片段大小限制 |\n   466→| 总Token预算 | 8000 | 完整上下文窗口 |\n   467→| 响应Token | 4096 | max_tokens 默认值 |\n   468→| Primary LLM | glm-4-plus | Zhipu 智谱 |\n   469→| Fallback LLM | claude-sonnet | Anthropic Claude |\n   470→\n   471→---\n   472→\n   473→## 待确认问题\n   474→\n   475→1. **字段名映射**: 前端发送 `skill_id`，后端模型接收 `skill`，是否在某处做了映射？\n   476→2. **流式端点**: `/chat/stream` SSE 端点是否启用？当前 ChatContainer 使用非流式调用\n   477→3. **认证模式**: Guest `/chat/guest` vs Authenticated `/chat/`，当前主要使用哪种？\n   478→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"bcc035fa-b816-4416-8a7c-e49cb5dea7c0","timestamp":"2026-01-07T10:04:44.472Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/vibelife/docs/archive/v3/chat-flow.md","content":"# VibeLife Chat 流程文档\n\n> 基于 v3 架构代码分析，2026-01-07\n\n## 整体架构图\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                              FRONTEND (Next.js)                              │\n├─────────────────────────────────────────────────────────────────────────────┤\n│                                                                              │\n│  ┌──────────────┐    onSend()    ┌──────────────────┐                       │\n│  │  ChatInput   │ ─────────────► │  ChatContainer   │                       │\n│  │  (textarea)  │                │   handleSend()   │                       │\n│  └──────────────┘                └────────┬─────────┘                       │\n│                                           │                                  │\n│                                           ▼                                  │\n│                                  ┌──────────────────┐                       │\n│                                  │    api.ts        │                       │\n│                                  │  sendMessage()   │                       │\n│                                  └────────┬─────────┘                       │\n│                                           │                                  │\n└───────────────────────────────────────────┼─────────────────────────────────┘\n                                            │ POST /api/v1/chat/\n                                            │ Authorization: Bearer {token}\n                                            ▼\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                              BACKEND (FastAPI)                               │\n├─────────────────────────────────────────────────────────────────────────────┤\n│                                                                              │\n│  ┌──────────────────┐                                                       │\n│  │  routes/chat.py  │  POST /chat/                                          │\n│  │  ───────────────                                                         │\n│  │  1. parse_skill()                                                        │\n│  │  2. get_user_profile()                                                   │\n│  │  3. get_conversation_history()                                           │\n│  │  4. save_message(user)                                                   │\n│  └────────┬─────────┘                                                       │\n│           │                                                                  │\n│           ▼                                                                  │\n│  ┌────────────────────────────────────────────────────────────┐             │\n│  │              VIBE ENGINE (services/vibe_engine/)           │             │\n│  │  ┌─────────────────┐      ┌─────────────────────────────┐  │             │\n│  │  │  context.py     │      │  llm.py                     │  │             │\n│  │  │  ContextBuilder │ ───► │  LLMService                 │  │             │\n│  │  │  ─────────────  │      │  ────────────               │  │             │\n│  │  │  • system_prompt│      │  • Zhipu (primary)         │  │             │\n│  │  │  • topic分类    │      │  • Claude (fallback)       │  │             │\n│  │  │  • profile选择  │      │  • Gemini (backup)         │  │             │\n│  │  │  • history格式化│      └─────────────────────────────┘  │             │\n│  │  └─────────────────┘                                       │             │\n│  └────────────────────────────────────────────────────────────┘             │\n│           │                                                                  │\n│           ▼                                                                  │\n│  ┌──────────────────┐                                                       │\n│  │  5. save_message │  (assistant response)                                 │\n│  │  6. return JSON  │                                                       │\n│  └──────────────────┘                                                       │\n│                                                                              │\n└─────────────────────────────────────────────────────────────────────────────┘\n                                            │\n                                            │ ChatResponse JSON\n                                            ▼\n┌─────────────────────────────────────────────────────────────────────────────┐\n│  FRONTEND: ChatContainer receives response                                   │\n│  → setMessages([...prev, assistantMessage])                                 │\n│  → ChatMessage renders assistant bubble                                      │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## 详细流程分解\n\n### 1. 前端输入层\n\n```\nChatInput.tsx                         ChatContainer.tsx\n┌────────────────────┐               ┌─────────────────────────────────┐\n│ <textarea>         │   Enter键     │ handleSend(content)             │\n│ ┌────────────────┐ │ ───────────►  │ ┌─────────────────────────────┐ │\n│ │ 用户输入消息    │ │               │ │ 1. 创建 userMessage         │ │\n│ └────────────────┘ │               │ │ 2. setMessages(prev+user)   │ │\n│ [🎤] [📷] [发送]  │               │ │ 3. setIsLoading(true)       │ │\n└────────────────────┘               │ │ 4. await sendMessage(...)   │ │\n                                     │ └─────────────────────────────┘ │\n                                     └─────────────────────────────────┘\n```\n\n**关键代码**: `apps/web/src/components/chat/ChatContainer.tsx:224-299`\n\n```typescript\nconst handleSend = async (content: string) => {\n  // 1. 添加用户消息到状态\n  const userMessage: Message = {\n    id: Date.now().toString(),\n    role: \"user\",\n    content,\n    timestamp: new Date().toLocaleTimeString(),\n  };\n  setMessages((prev) => [...prev, userMessage]);\n  setIsLoading(true);\n\n  // 2. 发送到后端\n  const response: ChatResponse = await sendMessage({\n    message: content,\n    skill_id: skillId,\n    conversation_id: currentConvoId,\n  });\n\n  // 3. 处理新会话创建\n  if (!currentConvoId && response.conversation_id) {\n    setCurrentConvoId(response.conversation_id);\n  }\n\n  // 4. 显示助手响应\n  const assistantMessage: Message = {\n    id: (Date.now() + 1).toString(),\n    role: \"assistant\",\n    content: response.content,\n    insight: response.insight,\n  };\n  setMessages((prev) => [...prev, assistantMessage]);\n};\n```\n\n---\n\n### 2. API 调用层\n\n**关键代码**: `apps/web/src/lib/api.ts:208-220`\n\n```typescript\nexport async function sendMessage(request: ChatRequest): Promise<ChatResponse> {\n  const response = await fetchAPI(\"/chat/\", {\n    method: \"POST\",\n    body: JSON.stringify(request),\n  });\n  return response.json();\n}\n```\n\n**请求结构**:\n```typescript\ninterface ChatRequest {\n  message: string;              // 用户输入\n  skill_id: string;            // \"bazi\" | \"zodiac\"\n  conversation_id?: string;    // UUID，续聊时提供\n}\n```\n\n**响应结构**:\n```typescript\ninterface ChatResponse {\n  content: string;             // 助手响应\n  conversation_id: string;     // UUID\n  intent?: string;\n  tools_used?: string[];\n  knowledge_used: boolean;\n  insight?: {                  // 可选洞察卡片\n    id: string;\n    insight_type: string;\n    title: string;\n    content: string;\n  };\n}\n```\n\n---\n\n### 3. 后端路由处理\n\n**关键代码**: `apps/api/routes/chat.py:220-273`\n\n```\n@router.post(\"/chat/\") 处理流程\n┌─────────────────────────────────────────────────────────────┐\n│                                                              │\n│  ChatRequest                    处理流程                     │\n│  ┌────────────────┐            ┌────────────────────────┐   │\n│  │ message        │            │ 1. parse_skill()       │   │\n│  │ skill          │ ─────────► │    \"bazi\" → Skill.BAZI │   │\n│  │ conversation_id│            │                        │   │\n│  │ voice_mode     │            │ 2. get_user_profile()  │   │\n│  └────────────────┘            │    从 profile_repo 获取 │   │\n│                                │                        │   │\n│                                │ 3. get_conversation_   │   │\n│                                │    history() 最近20条   │   │\n│                                │                        │   │\n│                                │ 4. save_message()      │   │\n│                                │    保存用户消息到 DB    │   │\n│                                └────────────────────────┘   │\n│                                                              │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**请求模型** (Python):\n```python\nclass ChatRequest(BaseModel):\n    message: str\n    skill: str  # \"bazi\" or \"zodiac\"\n    conversation_id: Optional[UUID] = None\n    voice_mode: Optional[str] = \"warm\"  # warm | sarcastic\n```\n\n**响应模型**:\n```python\nclass ChatResponse(BaseModel):\n    content: str\n    conversation_id: UUID\n    skill: str\n    voice_mode: str\n    metadata: Optional[dict] = None  # model, usage\n```\n\n---\n\n### 4. Vibe Engine - 上下文构建\n\n**关键代码**: `apps/api/services/vibe_engine/context.py:342-394`\n\n```\nContextBuilder.build() 处理流程\n┌───────────────────────────────────────────────────────────────────────┐\n│                                                                        │\n│  输入                           输出                                   │\n│  ─────                          ────                                   │\n│  • skill (BAZI/ZODIAC)          system_prompt:                        │\n│  • voice_mode (WARM/SARCASTIC)  ┌────────────────────────────────┐    │\n│  • current_message               │ # Vibe 人设                     │    │\n│  • profile (用户画像)            │ 你是 Vibe，用户的知己...        │    │\n│  • history (对话历史)            │                                 │    │\n│                                  │ # 八字技能上下文                │    │\n│  处理步骤:                       │ 你是资深命理师...              │    │\n│  1. build_system_prompt()        │                                 │    │\n│  2. classify_topic() → Topic     │ # 语气模式                     │    │\n│     • CAREER (工作相关)          │ 共情、支持、鼓励...            │    │\n│     • RELATIONSHIP (感情)        │                                 │    │\n│     • FORTUNE (运势)             │ # 用户画像 (XML)               │    │\n│     • SELF (性格)                │ <profile>...</profile>         │    │\n│     • GENERAL (通用)             └────────────────────────────────┘    │\n│  3. select_profile_sections()                                          │\n│     按 topic 选择相关画像片段    messages[]:                          │\n│  4. format_profile_context()     [system, history..., user_msg]       │\n│                                                                        │\n└───────────────────────────────────────────────────────────────────────┘\n```\n\n**话题分类规则**:\n- CAREER: 工作, 职业, 事业, 创业, 面试\n- RELATIONSHIP: 感情, 恋爱, 婚姻, 家人\n- FORTUNE: 运势, 大运, 流年, 什么时候\n- SELF: 性格, 优点, 缺点, 了解自己\n- GENERAL: 默认\n\n**按话题选择画像片段**:\n- CAREER → career + growth_areas\n- RELATIONSHIP → relationship + relationship_patterns + communication_style\n- FORTUNE → current_focus + recent_events\n- SELF → all ai_insights\n- GENERAL → current_focus + personality_traits\n\n---\n\n### 5. Vibe Engine - LLM 调用\n\n**关键代码**: `apps/api/services/vibe_engine/llm.py:304-370`\n\n```\nLLMService.chat() 调用流程\n┌───────────────────────────────────────────────────────────────────────┐\n│                                                                        │\n│                          ┌─────────────────┐                          │\n│                          │  Primary: Zhipu │                          │\n│  messages[] ──────────►  │  glm-4-plus     │                          │\n│                          └────────┬────────┘                          │\n│                                   │                                    │\n│                          成功?    │    失败?                          │\n│                            │      │      │                            │\n│                            ▼      │      ▼                            │\n│                     ┌──────────┐  │  ┌─────────────────┐              │\n│                     │ 返回响应  │  │  │ Fallback: Claude│              │\n│                     └──────────┘  │  │ claude-sonnet   │              │\n│                                   │  └────────┬────────┘              │\n│                                   │           │                        │\n│                                   │    失败?  │  成功?                │\n│                                   │      │    │    │                  │\n│                                   │      ▼    │    ▼                  │\n│                                   │  ┌──────────────────┐             │\n│                                   │  │ Raise Exception  │             │\n│                                   │  └──────────────────┘             │\n│                                                                        │\n└───────────────────────────────────────────────────────────────────────┘\n```\n\n**LLM 配置**:\n```python\n@dataclass\nclass LLMConfig:\n    zhipu_api_key: str          # Primary: Zhipu GLM-4-Plus\n    zhipu_base_url: str         # https://open.bigmodel.cn/api/paas/v4\n    zhipu_chat_model: str       # glm-4-plus\n    claude_api_key: str         # Backup: Claude\n    claude_model: str           # claude-3-5-sonnet-20241022\n    default_provider: LLMProvider = LLMProvider.ZHIPU\n```\n\n**LLM 响应结构**:\n```python\n@dataclass\nclass LLMResponse:\n    content: str                    # 生成文本\n    model: str                      # 使用的模型\n    provider: LLMProvider           # ZHIPU | CLAUDE | GEMINI\n    usage: Optional[Dict[str, int]] # {input_tokens, output_tokens}\n    finish_reason: Optional[str]    # \"stop\" | \"length\"\n```\n\n---\n\n### 6. 响应返回\n\n```\n                    Backend                              Frontend\n┌──────────────────────────────────┐    ┌──────────────────────────────────┐\n│  save_message(assistant, resp)   │    │  ChatContainer                   │\n│              │                   │    │                                  │\n│              ▼                   │    │  response = await sendMessage()  │\n│  return ChatResponse {           │───►│              │                   │\n│    content: \"根据你的八字...\",   │    │              ▼                   │\n│    conversation_id: uuid,        │    │  if (!currentConvoId) {          │\n│    skill: \"bazi\",                │    │    setCurrentConvoId(resp.id)    │\n│    voice_mode: \"warm\",           │    │  }                               │\n│    metadata: {model, usage}      │    │              │                   │\n│  }                               │    │              ▼                   │\n└──────────────────────────────────┘    │  setMessages([...prev, {         │\n                                        │    role: \"assistant\",            │\n                                        │    content: resp.content,        │\n                                        │    insight: resp.insight         │\n                                        │  }])                             │\n                                        │              │                   │\n                                        │              ▼                   │\n                                        │  ChatMessage renders             │\n                                        └──────────────────────────────────┘\n```\n\n---\n\n## 数据流转示意\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                            完整数据流转                                      │\n├─────────────────────────────────────────────────────────────────────────────┤\n│                                                                              │\n│  用户输入          前端 Request            后端 Request                     │\n│  ─────────         ────────────            ────────────                     │\n│  \"我是90年         {                       ChatRequest(                     │\n│   5月15日           message: \"...\",         message=\"...\",                  │\n│   出生的\"           skill_id: \"bazi\",       skill=\"bazi\",                   │\n│                     conversation_id:null    conversation_id=None,          │\n│                   }                         voice_mode=\"warm\"              │\n│                                           )                                 │\n│                                                                              │\n│  ════════════════════════════════════════════════════════════════════════   │\n│                                                                              │\n│  LLM Messages                                                               │\n│  ────────────                                                               │\n│  [                                                                          │\n│    {role: \"system\", content: \"# Vibe 人设\\n你是Vibe...\"},                  │\n│    {role: \"user\", content: \"[历史] 你好\"},                                  │\n│    {role: \"assistant\", content: \"[历史] 你好呀！...\"},                      │\n│    {role: \"user\", content: \"我是90年5月15日出生的\"}   ← current            │\n│  ]                                                                          │\n│                                                                              │\n│  ════════════════════════════════════════════════════════════════════════   │\n│                                                                              │\n│  后端 Response             前端 Response           UI 渲染                  │\n│  ────────────              ────────────            ────────                  │\n│  ChatResponse(             {                       ┌──────────────────┐     │\n│    content=\"根据...\",       content: \"根据...\",    │ 👤 我是90年...   │     │\n│    conversation_id=uuid,    conversation_id:uuid,  ├──────────────────┤     │\n│    skill=\"bazi\",            skill: \"bazi\",         │ 🔮 根据你的      │     │\n│    voice_mode=\"warm\",       metadata: {...}        │    八字...       │     │\n│    metadata={...}         }                        └──────────────────┘     │\n│  )                                                                          │\n│                                                                              │\n└─────────────────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## 关键代码文件清单\n\n| 层级 | 文件路径 | 核心功能 |\n|------|----------|----------|\n| 前端输入 | `apps/web/src/components/chat/ChatInput.tsx` | 文本输入框组件 |\n| 前端容器 | `apps/web/src/components/chat/ChatContainer.tsx` | 消息状态管理、API调用 |\n| 前端消息 | `apps/web/src/components/chat/ChatMessage.tsx` | 消息气泡渲染 |\n| API客户端 | `apps/web/src/lib/api.ts` | HTTP请求封装、token管理 |\n| 后端路由 | `apps/api/routes/chat.py` | `/chat/` 端点处理 |\n| 上下文构建 | `apps/api/services/vibe_engine/context.py` | system prompt、话题分类 |\n| LLM调用 | `apps/api/services/vibe_engine/llm.py` | Zhipu/Claude 调用 |\n| 用户画像 | `apps/api/services/vibe_engine/portrait.py` | profile 数据结构 |\n| 会话存储 | `apps/api/stores/conversation_repo.py` | 会话持久化 |\n| 消息存储 | `apps/api/stores/message_repo.py` | 消息持久化 |\n\n---\n\n## 语气模式系统\n\n### WARM 模式 (默认)\n- 风格: 共情、支持、鼓励\n- 用词: \"我感觉到\", \"你可能\", \"值得尝试\"\n- 像温暖的朋友聊天\n\n### SARCASTIC 模式\n- 风格: 直接、犀利、有趣\n- 用词: \"得了吧\", \"说白了\", \"典型的...\"\n- 像毒舌但关心你的朋友\n\n---\n\n## 用户画像结构\n\n```python\nDEFAULT_PROFILE = {\n    \"version\": \"1.0\",\n    \"basic\": {\n        \"birth_datetime\": None,    # 出生时间\n        \"birth_location\": None,    # 出生地点\n        \"gender\": None,\n        \"name\": None,\n        \"occupation\": None\n    },\n    \"life_context\": {\n        \"career\": {...},           # 职业信息\n        \"relationship\": {...},     # 感情状态\n        \"current_focus\": [],       # 当前关注点\n        \"life_stage\": None,\n        \"recent_events\": []\n    },\n    \"ai_insights\": {\n        \"personality_traits\": [],  # 性格特点\n        \"communication_style\": None,\n        \"emotional_patterns\": {...},\n        \"relationship_patterns\": {...},\n        \"growth_areas\": []\n    },\n    \"identity_prism\": {\n        \"core\": {...},             # 核心驱动\n        \"inner\": {...},            # 内在关注\n        \"outer\": {...}             # 外在表现\n    }\n}\n```\n\n---\n\n## 配置参数\n\n| 参数 | 值 | 说明 |\n|------|-----|------|\n| 历史消息限制 | 20条 | get_conversation_history limit |\n| Profile上下文 | ~1000 tokens | 画像片段大小限制 |\n| 总Token预算 | 8000 | 完整上下文窗口 |\n| 响应Token | 4096 | max_tokens 默认值 |\n| Primary LLM | glm-4-plus | Zhipu 智谱 |\n| Fallback LLM | claude-sonnet | Anthropic Claude |\n\n---\n\n## 待确认问题\n\n1. **字段名映射**: 前端发送 `skill_id`，后端模型接收 `skill`，是否在某处做了映射？\n2. **流式端点**: `/chat/stream` SSE 端点是否启用？当前 ChatContainer 使用非流式调用\n3. **认证模式**: Guest `/chat/guest` vs Authenticated `/chat/`，当前主要使用哪种？\n","numLines":478,"startLine":1,"totalLines":478}}}
{"parentUuid":"bcc035fa-b816-4416-8a7c-e49cb5dea7c0","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016rq3oF2amrbWV1XBWGGCKN","type":"tool_result","content":"     1→# VibeLife 架构决策文档\n     2→\n     3→> **访谈日期**: 2026-01-07\n     4→> **基于文档**: matrix-strategy-architecture.md, implementation-status-analysis.md\n     5→> **决策状态**: 已确认\n     6→\n     7→---\n     8→\n     9→## 1. 访谈结论汇总\n    10→\n    11→### 1.1 核心架构决策\n    12→\n    13→| 决策点 | 选择 | 说明 |\n    14→|--------|------|------|\n    15→| **前端框架** | Vercel AI SDK 6 | 全面采用 useChat + SSE + Generative UI |\n    16→| **后端框架** | Python FastAPI | 保留 Vibe Engine、Portrait Service、Knowledge Retrieval |\n    17→| **认证方案** | Clerk | Vercel 生态首选，webhook 写入 PostgreSQL |\n    18→| **数据库** | 统一 PostgreSQL | Clerk + 支付 + 业务数据全部在同一 DB |\n    19→| **子域名架构** | Phase 1 必须 | bazi.vibelife.app / zodiac.vibelife.app |\n    20→| **支付系统** | Phase 1 必须 | 参照 matrix 文档实现 |\n    21→| **时间线** | 无硬性 deadline | 质量优先 |\n    22→\n    23→### 1.2 功能决策\n    24→\n    25→| 功能 | 决策 | 说明 |\n    26→|------|------|------|\n    27→| **Voice Mode** | Bug，需修复 | 前端需传递 voice_mode 给后端 |\n    28→| **RAG 知识库** | Phase 1 必须启用 | 八字/星座知识库是核心竞争力 |\n    29→| **访谈流程** | 深度服务默认 + 可跳过 | 给用户选择权 |\n    30→| **报告生成** | lite + full 两种 | lite 免费 + full 付费解锁 |\n    31→| **多语言** | 中英双语 | Phase 1 支持切换 |\n    32→\n    33→### 1.3 UI 策略\n    34→\n    35→| 组件类型 | 来源 | 说明 |\n    36→|----------|------|------|\n    37→| 品牌特色组件 | 保留现有 | LuminousPaper、BreathAura、InsightCard |\n    38→| 聊天状态管理 | AI SDK useChat | 自动流式、重试、中断 |\n    39→| 动态卡片生成 | AI SDK Generative UI | LLM 返回结构化数据，前端渲染组件 |\n    40→| 命盘/星盘图表 | 保留现有 | 专业可视化已实现 |\n    41→\n    42→---\n    43→\n    44→## 2. 代码 Review 发现的问题\n    45→\n    46→### 2.1 Critical（必须修复）\n    47→\n    48→| # | 问题 | 位置 | 影响 |\n    49→|---|------|------|------|\n    50→| 1 | **API 字段不匹配** | 前端 `skill_id` vs 后端 `skill` | API 调用 400 错误 |\n    51→| 2 | **用户上下文缺失** | chat.py:164 `get_user_profile(None)` | 所有用户共享默认 profile |\n    52→| 3 | **Mock 支付暴露** | payment.py:245 `/mock-pay` | 任何人可标记支付完成 |\n    53→| 4 | **支付数据内存存储** | payment.py:136 `_payment_sessions = {}` | 重启丢失支付状态 |\n    54→\n    55→### 2.2 High（Phase 1 需修复）\n    56→\n    57→| # | 问题 | 位置 | 影响 |\n    58→|---|------|------|------|\n    59→| 5 | **voice_mode 未传递** | ChatContainer.tsx | 用户切换无效 |\n    60→| 6 | **流式未使用** | ChatContainer.tsx | 长响应体验差 |\n    61→| 7 | **报告持久化 stub** | report.py:123+ | 报告无法保存/检索 |\n    62→| 8 | **会话列表 stub** | chat.py:396-424 | 用户无法查看历史会话 |\n    63→| 9 | **RAG 未启用** | context.py | knowledge_chunks 参数未使用 |\n    64→\n    65→### 2.3 Medium（Phase 2 可修复）\n    66→\n    67→| # | 问题 | 位置 | 影响 |\n    68→|---|------|------|------|\n    69→| 10 | **Token 刷新竞态** | api.ts | 多个 401 同时触发刷新 |\n    70→| 11 | **错误处理不一致** | 所有 routes | HTTPException vs Response model 混用 |\n    71→| 12 | **Profile 大小无限制** | portrait.py | 可能超出 token 预算 |\n    72→| 13 | **deep_merge 重复** | portrait.py + profile_repo.py | 维护性问题 |\n    73→\n    74→---\n    75→\n    76→## 3. Vercel AI SDK 6 集成方案\n    77→\n    78→### 3.1 架构概览\n    79→\n    80→```\n    81→┌─────────────────────────────────────────────────────────────────────────┐\n    82→│                        Vercel AI SDK 6 集成架构                          │\n    83→├─────────────────────────────────────────────────────────────────────────┤\n    84→│                                                                          │\n    85→│   Frontend (Next.js + AI SDK 6)                                         │\n    86→│   ┌─────────────────────────────────────────────────────────┐           │\n    87→│   │                                                         │           │\n    88→│   │  useChat({                                              │           │\n    89→│   │    api: '/api/chat',        // Next.js Route Handler   │           │\n    90→│   │    streamProtocol: 'text',  // 或 'data' for tools     │           │\n    91→│   │  })                                                     │           │\n    92→│   │       │                                                 │           │\n    93→│   │       ▼                                                 │           │\n    94→│   │  /api/chat/route.ts (Next.js Route Handler)            │           │\n    95→│   │       │                                                 │           │\n    96→│   │       ▼ 转发请求到 Python 后端                          │           │\n    97→│   │  fetch('https://api.vibelife.app/chat/stream')         │           │\n    98→│   │       │                                                 │           │\n    99→│   │       ▼ 转换 SSE 格式为 AI SDK 协议                     │           │\n   100→│   │  return new StreamingTextResponse(transformedStream)   │           │\n   101→│   │                                                         │           │\n   102→│   └─────────────────────────────────────────────────────────┘           │\n   103→│                         │                                               │\n   104→│                         ▼                                               │\n   105→│   Python Backend (FastAPI)                                              │\n   106→│   ┌─────────────────────────────────────────────────────────┐           │\n   107→│   │                                                         │           │\n   108→│   │  POST /chat/stream                                      │           │\n   109→│   │       │                                                 │           │\n   110→│   │       ▼                                                 │           │\n   111→│   │  返回 AI SDK 兼容的 SSE 格式：                          │           │\n   112→│   │  data: {\"type\":\"text-delta\",\"textDelta\":\"你好\"}        │           │\n   113→│   │  data: {\"type\":\"text-delta\",\"textDelta\":\"！\"}          │           │\n   114→│   │  data: {\"type\":\"finish\",\"finishReason\":\"stop\"}         │           │\n   115→│   │                                                         │           │\n   116→│   └─────────────────────────────────────────────────────────┘           │\n   117→│                                                                          │\n   118→└─────────────────────────────────────────────────────────────────────────┘\n   119→```\n   120→\n   121→### 3.2 后端 SSE 格式适配\n   122→\n   123→**当前格式** (自定义):\n   124→```\n   125→data: {\"type\": \"chunk\", \"content\": \"你好\"}\n   126→data: {\"type\": \"done\", \"conversation_id\": \"...\"}\n   127→```\n   128→\n   129→**AI SDK 要求格式**:\n   130→```\n   131→data: {\"type\": \"text-delta\", \"textDelta\": \"你好\"}\n   132→data: {\"type\": \"finish\", \"finishReason\": \"stop\", \"usage\": {...}}\n   133→```\n   134→\n   135→**适配方案** - 修改 `apps/api/routes/chat.py`:\n   136→\n   137→```python\n   138→# 新的 SSE 事件格式\n   139→async def stream_chat_sse(response_generator, conversation_id: str):\n   140→    async for chunk in response_generator:\n   141→        yield {\n   142→            \"event\": \"message\",\n   143→            \"data\": json.dumps({\n   144→                \"type\": \"text-delta\",\n   145→                \"textDelta\": chunk\n   146→            })\n   147→        }\n   148→\n   149→    # 结束事件\n   150→    yield {\n   151→        \"event\": \"message\",\n   152→        \"data\": json.dumps({\n   153→            \"type\": \"finish\",\n   154→            \"finishReason\": \"stop\",\n   155→            \"metadata\": {\"conversationId\": str(conversation_id)}\n   156→        })\n   157→    }\n   158→```\n   159→\n   160→### 3.3 前端 useChat 配置\n   161→\n   162→```typescript\n   163→// apps/web/src/hooks/useVibeChat.ts\n   164→import { useChat } from '@ai-sdk/react';\n   165→\n   166→export function useVibeChat(skillId: string, voiceMode: string) {\n   167→  return useChat({\n   168→    api: '/api/chat',\n   169→    body: {\n   170→      skill: skillId,           // 统一用 skill\n   171→      voice_mode: voiceMode,    // 传递 voice_mode\n   172→    },\n   173→    streamProtocol: 'data',     // AI SDK data stream protocol\n   174→    onFinish: (message) => {\n   175→      // 处理完成事件，提取 metadata\n   176→      const metadata = message.annotations?.[0];\n   177→      if (metadata?.conversationId) {\n   178→        // 更新会话 ID\n   179→      }\n   180→    },\n   181→    onError: (error) => {\n   182→      // 统一错误处理\n   183→      console.error('Chat error:', error);\n   184→    },\n   185→  });\n   186→}\n   187→```\n   188→\n   189→### 3.4 Generative UI 实现（动态卡片）\n   190→\n   191→```typescript\n   192→// apps/web/src/app/api/chat/route.ts\n   193→import { streamUI } from 'ai/rsc';\n   194→import { z } from 'zod';\n   195→import { InsightCard } from '@/components/core/InsightCard';\n   196→import { KLineChart } from '@/components/fortune/KLineChart';\n   197→\n   198→export async function POST(req: Request) {\n   199→  const { messages, skill, voice_mode } = await req.json();\n   200→\n   201→  const result = await streamUI({\n   202→    model: customModel, // 包装 Python 后端调用\n   203→    messages,\n   204→    tools: {\n   205→      showInsightCard: {\n   206→        description: '展示洞察卡片，用于呈现性格特点、运势分析等',\n   207→        parameters: z.object({\n   208→          title: z.string(),\n   209→          content: z.string(),\n   210→          type: z.enum(['personality', 'career', 'relationship', 'fortune']),\n   211→        }),\n   212→        generate: async ({ title, content, type }) => {\n   213→          return <InsightCard title={title} content={content} type={type} />;\n   214→        },\n   215→      },\n   216→      showKLine: {\n   217→        description: '展示人生K线图',\n   218→        parameters: z.object({\n   219→          userId: z.string(),\n   220→          startYear: z.number(),\n   221→          endYear: z.number(),\n   222→        }),\n   223→        generate: async ({ userId, startYear, endYear }) => {\n   224→          const data = await fetchKLineData(userId, startYear, endYear);\n   225→          return <KLineChart data={data} />;\n   226→        },\n   227→      },\n   228→      showRelationshipCard: {\n   229→        description: '展示关系分析卡片',\n   230→        parameters: z.object({\n   231→          score: z.number(),\n   232→          aspects: z.array(z.object({\n   233→            name: z.string(),\n   234→            score: z.number(),\n   235→            description: z.string(),\n   236→          })),\n   237→        }),\n   238→        generate: async ({ score, aspects }) => {\n   239→          return <RelationshipCard score={score} aspects={aspects} />;\n   240→        },\n   241→      },\n   242→    },\n   243→  });\n   244→\n   245→  return result.toDataStreamResponse();\n   246→}\n   247→```\n   248→\n   249→---\n   250→\n   251→## 4. 实施路线图\n   252→\n   253→### Phase 1 核心任务\n   254→\n   255→```\n   256→┌─────────────────────────────────────────────────────────────────────────┐\n   257→│                        Phase 1 实施顺序                                  │\n   258→├─────────────────────────────────────────────────────────────────────────┤\n   259→│                                                                          │\n   260→│   Week 1: 基础架构                                                       │\n   261→│   ─────────────────                                                      │\n   262→│   [ ] 1.1 修复 skill_id → skill 字段名                                  │\n   263→│   [ ] 1.2 集成 Clerk 认证                                               │\n   264→│   [ ] 1.3 后端 SSE 格式适配 AI SDK                                      │\n   265→│   [ ] 1.4 前端 useChat hook 集成                                        │\n   266→│                                                                          │\n   267→│   Week 2: 核心功能                                                       │\n   268→│   ─────────────────                                                      │\n   269→│   [ ] 2.1 voice_mode 完整链路                                           │\n   270→│   [ ] 2.2 RAG 知识库启用                                                │\n   271→│   [ ] 2.3 访谈流程前端集成                                              │\n   272→│   [ ] 2.4 用户 profile 持久化                                           │\n   273→│                                                                          │\n   274→│   Week 3: 子域名 + 支付                                                  │\n   275→│   ─────────────────                                                      │\n   276→│   [ ] 3.1 路由组重构 (bazi)/ (zodiac)/                                  │\n   277→│   [ ] 3.2 middleware.ts 子域名路由                                       │\n   278→│   [ ] 3.3 Stripe 支付集成                                               │\n   279→│   [ ] 3.4 订阅状态管理                                                  │\n   280→│                                                                          │\n   281→│   Week 4: 报告 + 打磨                                                    │\n   282→│   ─────────────────                                                      │\n   283→│   [ ] 4.1 报告持久化完成                                                │\n   284→│   [ ] 4.2 lite/full 报告流程                                            │\n   285→│   [ ] 4.3 Generative UI 动态卡片                                        │\n   286→│   [ ] 4.4 中英双语切换                                                  │\n   287→│                                                                          │\n   288→└─────────────────────────────────────────────────────────────────────────┘\n   289→```\n   290→\n   291→### 关键文件修改清单\n   292→\n   293→| 文件 | 修改内容 | 优先级 |\n   294→|------|----------|--------|\n   295→| `apps/web/src/lib/api.ts` | `skill_id` → `skill` | P0 |\n   296→| `apps/web/src/components/chat/ChatContainer.tsx` | 改用 useChat + 传递 voice_mode | P0 |\n   297→| `apps/api/routes/chat.py` | SSE 格式适配 + 认证集成 | P0 |\n   298→| `apps/api/routes/chat.py:164` | 获取真实用户 profile | P0 |\n   299→| `apps/api/routes/payment.py` | 删除 mock-pay，完善 Stripe | P0 |\n   300→| `apps/api/services/vibe_engine/context.py` | 启用 knowledge_chunks | P1 |\n   301→| `apps/web/src/middleware.ts` | 完善子域名路由 | P1 |\n   302→| `apps/api/stores/report_repo.py` | 报告持久化 | P1 |\n   303→\n   304→---\n   305→\n   306→## 5. 技术栈确认\n   307→\n   308→```\n   309→Frontend\n   310→────────\n   311→• Next.js 14+ (App Router)\n   312→• Vercel AI SDK 6\n   313→• TypeScript\n   314→• Tailwind CSS\n   315→• 现有品牌组件 (LuminousPaper, BreathAura, InsightCard)\n   316→\n   317→Backend\n   318→───────\n   319→• Python 3.11+\n   320→• FastAPI\n   321→• asyncpg (PostgreSQL)\n   322→• httpx (LLM 调用)\n   323→• Vibe Engine (Context, Portrait, LLM)\n   324→\n   325→Infrastructure\n   326→──────────────\n   327→• Vercel (Frontend)\n   328→• Railway/Render/自有服务器 (Python Backend)\n   329→• PostgreSQL (Supabase/Railway/自有)\n   330→• Clerk (认证)\n   331→• Stripe (支付)\n   332→\n   333→LLM Providers\n   334→─────────────\n   335→• Primary: Zhipu GLM-4-Plus\n   336→• Fallback: Claude Sonnet\n   337→• Vision: GLM-4V-Plus (可选)\n   338→```\n   339→\n   340→---\n   341→\n   342→## 6. 待确认事项\n   343→\n   344→以下问题在后续实施中需要确认：\n   345→\n   346→1. **Clerk webhook 端点**: 放在 Python 后端还是 Next.js API Routes？\n   347→2. **Stripe webhook 端点**: 同上\n   348→3. **子域名 Cookie 域名**: `.vibelife.app` 还是各子域名独立？\n   349→4. **报告 PDF 生成**: 服务端生成还是客户端生成？\n   350→5. **命盘/星盘计算**: 继续用 Python 还是迁移到前端 JS 库？\n   351→\n   352→---\n   353→\n   354→## 参考资源\n   355→\n   356→- [AI SDK 6 Documentation](https://ai-sdk.dev/docs/introduction)\n   357→- [AI SDK 6 Blog Post](https://vercel.com/blog/ai-sdk-6)\n   358→- [AI Elements Components](https://vercel.com/changelog/introducing-ai-elements)\n   359→- [Clerk Documentation](https://clerk.com/docs)\n   360→- [Stripe Checkout](https://stripe.com/docs/payments/checkout)\n   361→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"7a0bba50-1f1f-475b-900d-c0087626f4fe","timestamp":"2026-01-07T10:04:44.474Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/vibelife/docs/archive/v3/architecture-decisions.md","content":"# VibeLife 架构决策文档\n\n> **访谈日期**: 2026-01-07\n> **基于文档**: matrix-strategy-architecture.md, implementation-status-analysis.md\n> **决策状态**: 已确认\n\n---\n\n## 1. 访谈结论汇总\n\n### 1.1 核心架构决策\n\n| 决策点 | 选择 | 说明 |\n|--------|------|------|\n| **前端框架** | Vercel AI SDK 6 | 全面采用 useChat + SSE + Generative UI |\n| **后端框架** | Python FastAPI | 保留 Vibe Engine、Portrait Service、Knowledge Retrieval |\n| **认证方案** | Clerk | Vercel 生态首选，webhook 写入 PostgreSQL |\n| **数据库** | 统一 PostgreSQL | Clerk + 支付 + 业务数据全部在同一 DB |\n| **子域名架构** | Phase 1 必须 | bazi.vibelife.app / zodiac.vibelife.app |\n| **支付系统** | Phase 1 必须 | 参照 matrix 文档实现 |\n| **时间线** | 无硬性 deadline | 质量优先 |\n\n### 1.2 功能决策\n\n| 功能 | 决策 | 说明 |\n|------|------|------|\n| **Voice Mode** | Bug，需修复 | 前端需传递 voice_mode 给后端 |\n| **RAG 知识库** | Phase 1 必须启用 | 八字/星座知识库是核心竞争力 |\n| **访谈流程** | 深度服务默认 + 可跳过 | 给用户选择权 |\n| **报告生成** | lite + full 两种 | lite 免费 + full 付费解锁 |\n| **多语言** | 中英双语 | Phase 1 支持切换 |\n\n### 1.3 UI 策略\n\n| 组件类型 | 来源 | 说明 |\n|----------|------|------|\n| 品牌特色组件 | 保留现有 | LuminousPaper、BreathAura、InsightCard |\n| 聊天状态管理 | AI SDK useChat | 自动流式、重试、中断 |\n| 动态卡片生成 | AI SDK Generative UI | LLM 返回结构化数据，前端渲染组件 |\n| 命盘/星盘图表 | 保留现有 | 专业可视化已实现 |\n\n---\n\n## 2. 代码 Review 发现的问题\n\n### 2.1 Critical（必须修复）\n\n| # | 问题 | 位置 | 影响 |\n|---|------|------|------|\n| 1 | **API 字段不匹配** | 前端 `skill_id` vs 后端 `skill` | API 调用 400 错误 |\n| 2 | **用户上下文缺失** | chat.py:164 `get_user_profile(None)` | 所有用户共享默认 profile |\n| 3 | **Mock 支付暴露** | payment.py:245 `/mock-pay` | 任何人可标记支付完成 |\n| 4 | **支付数据内存存储** | payment.py:136 `_payment_sessions = {}` | 重启丢失支付状态 |\n\n### 2.2 High（Phase 1 需修复）\n\n| # | 问题 | 位置 | 影响 |\n|---|------|------|------|\n| 5 | **voice_mode 未传递** | ChatContainer.tsx | 用户切换无效 |\n| 6 | **流式未使用** | ChatContainer.tsx | 长响应体验差 |\n| 7 | **报告持久化 stub** | report.py:123+ | 报告无法保存/检索 |\n| 8 | **会话列表 stub** | chat.py:396-424 | 用户无法查看历史会话 |\n| 9 | **RAG 未启用** | context.py | knowledge_chunks 参数未使用 |\n\n### 2.3 Medium（Phase 2 可修复）\n\n| # | 问题 | 位置 | 影响 |\n|---|------|------|------|\n| 10 | **Token 刷新竞态** | api.ts | 多个 401 同时触发刷新 |\n| 11 | **错误处理不一致** | 所有 routes | HTTPException vs Response model 混用 |\n| 12 | **Profile 大小无限制** | portrait.py | 可能超出 token 预算 |\n| 13 | **deep_merge 重复** | portrait.py + profile_repo.py | 维护性问题 |\n\n---\n\n## 3. Vercel AI SDK 6 集成方案\n\n### 3.1 架构概览\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        Vercel AI SDK 6 集成架构                          │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│   Frontend (Next.js + AI SDK 6)                                         │\n│   ┌─────────────────────────────────────────────────────────┐           │\n│   │                                                         │           │\n│   │  useChat({                                              │           │\n│   │    api: '/api/chat',        // Next.js Route Handler   │           │\n│   │    streamProtocol: 'text',  // 或 'data' for tools     │           │\n│   │  })                                                     │           │\n│   │       │                                                 │           │\n│   │       ▼                                                 │           │\n│   │  /api/chat/route.ts (Next.js Route Handler)            │           │\n│   │       │                                                 │           │\n│   │       ▼ 转发请求到 Python 后端                          │           │\n│   │  fetch('https://api.vibelife.app/chat/stream')         │           │\n│   │       │                                                 │           │\n│   │       ▼ 转换 SSE 格式为 AI SDK 协议                     │           │\n│   │  return new StreamingTextResponse(transformedStream)   │           │\n│   │                                                         │           │\n│   └─────────────────────────────────────────────────────────┘           │\n│                         │                                               │\n│                         ▼                                               │\n│   Python Backend (FastAPI)                                              │\n│   ┌─────────────────────────────────────────────────────────┐           │\n│   │                                                         │           │\n│   │  POST /chat/stream                                      │           │\n│   │       │                                                 │           │\n│   │       ▼                                                 │           │\n│   │  返回 AI SDK 兼容的 SSE 格式：                          │           │\n│   │  data: {\"type\":\"text-delta\",\"textDelta\":\"你好\"}        │           │\n│   │  data: {\"type\":\"text-delta\",\"textDelta\":\"！\"}          │           │\n│   │  data: {\"type\":\"finish\",\"finishReason\":\"stop\"}         │           │\n│   │                                                         │           │\n│   └─────────────────────────────────────────────────────────┘           │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n### 3.2 后端 SSE 格式适配\n\n**当前格式** (自定义):\n```\ndata: {\"type\": \"chunk\", \"content\": \"你好\"}\ndata: {\"type\": \"done\", \"conversation_id\": \"...\"}\n```\n\n**AI SDK 要求格式**:\n```\ndata: {\"type\": \"text-delta\", \"textDelta\": \"你好\"}\ndata: {\"type\": \"finish\", \"finishReason\": \"stop\", \"usage\": {...}}\n```\n\n**适配方案** - 修改 `apps/api/routes/chat.py`:\n\n```python\n# 新的 SSE 事件格式\nasync def stream_chat_sse(response_generator, conversation_id: str):\n    async for chunk in response_generator:\n        yield {\n            \"event\": \"message\",\n            \"data\": json.dumps({\n                \"type\": \"text-delta\",\n                \"textDelta\": chunk\n            })\n        }\n\n    # 结束事件\n    yield {\n        \"event\": \"message\",\n        \"data\": json.dumps({\n            \"type\": \"finish\",\n            \"finishReason\": \"stop\",\n            \"metadata\": {\"conversationId\": str(conversation_id)}\n        })\n    }\n```\n\n### 3.3 前端 useChat 配置\n\n```typescript\n// apps/web/src/hooks/useVibeChat.ts\nimport { useChat } from '@ai-sdk/react';\n\nexport function useVibeChat(skillId: string, voiceMode: string) {\n  return useChat({\n    api: '/api/chat',\n    body: {\n      skill: skillId,           // 统一用 skill\n      voice_mode: voiceMode,    // 传递 voice_mode\n    },\n    streamProtocol: 'data',     // AI SDK data stream protocol\n    onFinish: (message) => {\n      // 处理完成事件，提取 metadata\n      const metadata = message.annotations?.[0];\n      if (metadata?.conversationId) {\n        // 更新会话 ID\n      }\n    },\n    onError: (error) => {\n      // 统一错误处理\n      console.error('Chat error:', error);\n    },\n  });\n}\n```\n\n### 3.4 Generative UI 实现（动态卡片）\n\n```typescript\n// apps/web/src/app/api/chat/route.ts\nimport { streamUI } from 'ai/rsc';\nimport { z } from 'zod';\nimport { InsightCard } from '@/components/core/InsightCard';\nimport { KLineChart } from '@/components/fortune/KLineChart';\n\nexport async function POST(req: Request) {\n  const { messages, skill, voice_mode } = await req.json();\n\n  const result = await streamUI({\n    model: customModel, // 包装 Python 后端调用\n    messages,\n    tools: {\n      showInsightCard: {\n        description: '展示洞察卡片，用于呈现性格特点、运势分析等',\n        parameters: z.object({\n          title: z.string(),\n          content: z.string(),\n          type: z.enum(['personality', 'career', 'relationship', 'fortune']),\n        }),\n        generate: async ({ title, content, type }) => {\n          return <InsightCard title={title} content={content} type={type} />;\n        },\n      },\n      showKLine: {\n        description: '展示人生K线图',\n        parameters: z.object({\n          userId: z.string(),\n          startYear: z.number(),\n          endYear: z.number(),\n        }),\n        generate: async ({ userId, startYear, endYear }) => {\n          const data = await fetchKLineData(userId, startYear, endYear);\n          return <KLineChart data={data} />;\n        },\n      },\n      showRelationshipCard: {\n        description: '展示关系分析卡片',\n        parameters: z.object({\n          score: z.number(),\n          aspects: z.array(z.object({\n            name: z.string(),\n            score: z.number(),\n            description: z.string(),\n          })),\n        }),\n        generate: async ({ score, aspects }) => {\n          return <RelationshipCard score={score} aspects={aspects} />;\n        },\n      },\n    },\n  });\n\n  return result.toDataStreamResponse();\n}\n```\n\n---\n\n## 4. 实施路线图\n\n### Phase 1 核心任务\n\n```\n┌─────────────────────────────────────────────────────────────────────────┐\n│                        Phase 1 实施顺序                                  │\n├─────────────────────────────────────────────────────────────────────────┤\n│                                                                          │\n│   Week 1: 基础架构                                                       │\n│   ─────────────────                                                      │\n│   [ ] 1.1 修复 skill_id → skill 字段名                                  │\n│   [ ] 1.2 集成 Clerk 认证                                               │\n│   [ ] 1.3 后端 SSE 格式适配 AI SDK                                      │\n│   [ ] 1.4 前端 useChat hook 集成                                        │\n│                                                                          │\n│   Week 2: 核心功能                                                       │\n│   ─────────────────                                                      │\n│   [ ] 2.1 voice_mode 完整链路                                           │\n│   [ ] 2.2 RAG 知识库启用                                                │\n│   [ ] 2.3 访谈流程前端集成                                              │\n│   [ ] 2.4 用户 profile 持久化                                           │\n│                                                                          │\n│   Week 3: 子域名 + 支付                                                  │\n│   ─────────────────                                                      │\n│   [ ] 3.1 路由组重构 (bazi)/ (zodiac)/                                  │\n│   [ ] 3.2 middleware.ts 子域名路由                                       │\n│   [ ] 3.3 Stripe 支付集成                                               │\n│   [ ] 3.4 订阅状态管理                                                  │\n│                                                                          │\n│   Week 4: 报告 + 打磨                                                    │\n│   ─────────────────                                                      │\n│   [ ] 4.1 报告持久化完成                                                │\n│   [ ] 4.2 lite/full 报告流程                                            │\n│   [ ] 4.3 Generative UI 动态卡片                                        │\n│   [ ] 4.4 中英双语切换                                                  │\n│                                                                          │\n└─────────────────────────────────────────────────────────────────────────┘\n```\n\n### 关键文件修改清单\n\n| 文件 | 修改内容 | 优先级 |\n|------|----------|--------|\n| `apps/web/src/lib/api.ts` | `skill_id` → `skill` | P0 |\n| `apps/web/src/components/chat/ChatContainer.tsx` | 改用 useChat + 传递 voice_mode | P0 |\n| `apps/api/routes/chat.py` | SSE 格式适配 + 认证集成 | P0 |\n| `apps/api/routes/chat.py:164` | 获取真实用户 profile | P0 |\n| `apps/api/routes/payment.py` | 删除 mock-pay，完善 Stripe | P0 |\n| `apps/api/services/vibe_engine/context.py` | 启用 knowledge_chunks | P1 |\n| `apps/web/src/middleware.ts` | 完善子域名路由 | P1 |\n| `apps/api/stores/report_repo.py` | 报告持久化 | P1 |\n\n---\n\n## 5. 技术栈确认\n\n```\nFrontend\n────────\n• Next.js 14+ (App Router)\n• Vercel AI SDK 6\n• TypeScript\n• Tailwind CSS\n• 现有品牌组件 (LuminousPaper, BreathAura, InsightCard)\n\nBackend\n───────\n• Python 3.11+\n• FastAPI\n• asyncpg (PostgreSQL)\n• httpx (LLM 调用)\n• Vibe Engine (Context, Portrait, LLM)\n\nInfrastructure\n──────────────\n• Vercel (Frontend)\n• Railway/Render/自有服务器 (Python Backend)\n• PostgreSQL (Supabase/Railway/自有)\n• Clerk (认证)\n• Stripe (支付)\n\nLLM Providers\n─────────────\n• Primary: Zhipu GLM-4-Plus\n• Fallback: Claude Sonnet\n• Vision: GLM-4V-Plus (可选)\n```\n\n---\n\n## 6. 待确认事项\n\n以下问题在后续实施中需要确认：\n\n1. **Clerk webhook 端点**: 放在 Python 后端还是 Next.js API Routes？\n2. **Stripe webhook 端点**: 同上\n3. **子域名 Cookie 域名**: `.vibelife.app` 还是各子域名独立？\n4. **报告 PDF 生成**: 服务端生成还是客户端生成？\n5. **命盘/星盘计算**: 继续用 Python 还是迁移到前端 JS 库？\n\n---\n\n## 参考资源\n\n- [AI SDK 6 Documentation](https://ai-sdk.dev/docs/introduction)\n- [AI SDK 6 Blog Post](https://vercel.com/blog/ai-sdk-6)\n- [AI Elements Components](https://vercel.com/changelog/introducing-ai-elements)\n- [Clerk Documentation](https://clerk.com/docs)\n- [Stripe Checkout](https://stripe.com/docs/payments/checkout)\n","numLines":361,"startLine":1,"totalLines":361}}}
{"parentUuid":"7a0bba50-1f1f-475b-900d-c0087626f4fe","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01J1B22kKVcy58BgqApp1Aqj","type":"tool_result","content":"     1→# VibeLife 矩阵战略架构方案\n     2→\n     3→> **文档版本**: v1.0\n     4→> **更新日期**: 2026-01-07\n     5→> **战略阶段**: Phase 1 & 2 去中心化流量验证 → Phase 3 中心化生态聚合\n     6→\n     7→---\n     8→\n     9→## 1. 战略概述\n    10→\n    11→### 1.1 矩阵战略核心\n    12→\n    13→| 阶段 | 目标 | 架构特征 |\n    14→|------|------|----------|\n    15→| **Phase 1** | 去中心化获客 + 验证 | 独立子域名，快速试错 |\n    16→| **Phase 2** | 矩阵扩展 + 交叉销售 | 统一账户，独立收费 |\n    17→| **Phase 3** | 中心化生态 | 主 App 聚合，子域名变落地页 |\n    18→\n    19→### 1.2 核心决策\n    20→\n    21→| 决策点 | 选择 | 理由 |\n    22→|--------|------|------|\n    23→| **域名策略** | 子域名 (Subdomain) | 工程速度 + 风险隔离 + 独立品牌感 |\n    24→| **命名风格** | 直接命名 (bazi/zodiac) | SEO 友好 + 中文用户易记 |\n    25→| **路由策略** | 路由组物理隔离 | (bazi)/ (zodiac)/ 独立页面文件，深度定制 UI |\n    26→| **账户体系** | 共享注册登录 | Cookie 设在 .vibelife.app，跨子域名 SSO |\n    27→| **收费模式** | 各 Skill 独立收费 | 系统支持差异化定价，具体价格待定 |\n    28→| **数据策略** | 深度共享 | 「了解你越多越深」核心价值 |\n    29→| **视觉关联** | 强关联 - 统一顶栏 | 品牌矩阵感 |\n    30→| **主站定位** | 品牌索引页 (Phase 1) | www.vibelife.app 作为品牌入口 |\n    31→| **支付架构** | Stripe + Airwallex 双轨 | 海外主体，国内外用户各半 |\n    32→| **定价币种** | 双币种 (CNY/USD) | 根据用户地区自动切换 |\n    33→| **计费模型** | 订阅 + 单次 + 增值服务 | 灵活的商业模式 |\n    34→\n    35→---\n    36→\n    37→## 2. 域名架构\n    38→\n    39→### 2.1 子域名规划\n    40→\n    41→```\n    42→┌─────────────────────────────────────────────────────────────────┐\n    43→│                     vibelife.app 域名矩阵                        │\n    44→├─────────────────────────────────────────────────────────────────┤\n    45→│                                                                 │\n    46→│   www.vibelife.app          ← 品牌索引页（Phase 1）             │\n    47→│        │                                                        │\n    48→│        ├── bazi.vibelife.app    ← 八字命理（P1 上线）           │\n    49→│        │                                                        │\n    50→│        ├── zodiac.vibelife.app  ← 星座占星（P1 上线）           │\n    51→│        │                                                        │\n    52→│        ├── mbti.vibelife.app    ← MBTI 人格（P2 规划）          │\n    53→│        │                                                        │\n    54→│        ├── career.vibelife.app  ← 职业发展（P2 规划）           │\n    55→│        │                                                        │\n    56→│        └── app.vibelife.app     ← 主 App（Phase 3）             │\n    57→│                                                                 │\n    58→└─────────────────────────────────────────────────────────────────┘\n    59→```\n    60→\n    61→### 2.2 DNS 配置\n    62→\n    63→```\n    64→# Vercel/Cloudflare DNS 配置\n    65→*.vibelife.app    CNAME    cname.vercel-dns.com\n    66→www.vibelife.app  CNAME    cname.vercel-dns.com\n    67→```\n    68→\n    69→### 2.3 Vercel 配置 (vercel.json)\n    70→\n    71→> **路由策略**：采用路由组物理隔离模式，每个子域名映射到对应的路由组目录，实现深度定制 UI。\n    72→\n    73→```json\n    74→{\n    75→  \"rewrites\": [\n    76→    {\n    77→      \"source\": \"/:path*\",\n    78→      \"has\": [{ \"type\": \"host\", \"value\": \"www.vibelife.app\" }],\n    79→      \"destination\": \"/www/:path*\"\n    80→    },\n    81→    {\n    82→      \"source\": \"/:path*\",\n    83→      \"has\": [{ \"type\": \"host\", \"value\": \"bazi.vibelife.app\" }],\n    84→      \"destination\": \"/bazi/:path*\"\n    85→    },\n    86→    {\n    87→      \"source\": \"/:path*\",\n    88→      \"has\": [{ \"type\": \"host\", \"value\": \"zodiac.vibelife.app\" }],\n    89→      \"destination\": \"/zodiac/:path*\"\n    90→    }\n    91→  ]\n    92→}\n    93→```\n    94→\n    95→---\n    96→\n    97→## 3. 账户与认证架构\n    98→\n    99→### 3.1 共享账户 + 独立订阅模型\n   100→\n   101→```\n   102→┌─────────────────────────────────────────────────────────────────┐\n   103→│                        用户账户层（全局共享）                     │\n   104→│                                                                 │\n   105→│   ┌─────────────────────────────────────────────────────────┐   │\n   106→│   │  User                                                   │   │\n   107→│   │  ├── id: UUID (全局唯一)                                │   │\n   108→│   │  ├── email / phone / oauth_provider                     │   │\n   109→│   │  ├── created_at                                         │   │\n   110→│   │  └── Cookie Domain: .vibelife.app (根域名)              │   │\n   111→│   └─────────────────────────────────────────────────────────┘   │\n   112→│                              │                                   │\n   113→│              ┌───────────────┼───────────────┐                   │\n   114→│              ▼               ▼               ▼                   │\n   115→│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │\n   116→│   │  Bazi Profile   │ │ Zodiac Profile  │ │  MBTI Profile   │   │\n   117→│   │                 │ │                 │ │                 │   │\n   118→│   │ • 命盘数据      │ │ • 星盘数据      │ │ • 类型数据      │   │\n   119→│   │ • 对话历史      │ │ • 对话历史      │ │ • 对话历史      │   │\n   120→│   │ • 报告记录      │ │ • 报告记录      │ │ • 报告记录      │   │\n   121→│   └────────┬────────┘ └────────┬────────┘ └────────┬────────┘   │\n   122→│            │                   │                   │             │\n   123→│   ┌────────▼────────┐ ┌────────▼────────┐ ┌────────▼────────┐   │\n   124→│   │ Bazi Subscribe  │ │Zodiac Subscribe │ │ MBTI Subscribe  │   │\n   125→│   │                 │ │                 │ │                 │   │\n   126→│   │ tier: pro       │ │ tier: free      │ │ tier: free      │   │\n   127→│   │ price: ¥19.9/mo │ │ price: ¥19.9/mo │ │ price: ¥19.9/mo │   │\n   128→│   └─────────────────┘ └─────────────────┘ └─────────────────┘   │\n   129→│                                                                 │\n   130→├─────────────────────────────────────────────────────────────────┤\n   131→│                        共享数据层                                │\n   132→│                                                                 │\n   133→│   ┌─────────────────────────────────────────────────────────┐   │\n   134→│   │  Shared Profile (深度共享)                              │   │\n   135→│   │  ├── basic: { birth_datetime, birth_location, gender }  │   │\n   136→│   │  ├── life_context: { career, relationship, events }     │   │\n   137→│   │  ├── ai_insights: { traits, patterns, growth_areas }    │   │\n   138→│   │  └── identity_prism: { core, inner, outer }             │   │\n   139→│   └─────────────────────────────────────────────────────────┘   │\n   140→│                                                                 │\n   141→└─────────────────────────────────────────────────────────────────┘\n   142→```\n   143→\n   144→### 3.2 SSO 技术实现\n   145→\n   146→**Cookie 设置（根域名共享）**：\n   147→```typescript\n   148→// apps/api/services/identity/auth.py\n   149→def set_auth_cookie(response: Response, token: str):\n   150→    response.set_cookie(\n   151→        key=\"vibelife_token\",\n   152→        value=token,\n   153→        domain=\".vibelife.app\",  # 关键：根域名\n   154→        httponly=True,\n   155→        secure=True,\n   156→        samesite=\"lax\",\n   157→        max_age=60 * 60 * 24 * 30  # 30 天\n   158→    )\n   159→```\n   160→\n   161→**前端 Cookie 读取**：\n   162→```typescript\n   163→// apps/web/src/lib/auth.ts\n   164→export function getAuthToken(): string | null {\n   165→  // Cookie 自动在所有 *.vibelife.app 子域名共享\n   166→  return Cookies.get('vibelife_token');\n   167→}\n   168→```\n   169→\n   170→### 3.3 数据库 Schema 扩展\n   171→\n   172→```sql\n   173→-- 用户表（已有）\n   174→CREATE TABLE users (\n   175→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   176→    email TEXT UNIQUE,\n   177→    phone TEXT UNIQUE,\n   178→    created_at TIMESTAMPTZ DEFAULT NOW()\n   179→);\n   180→\n   181→-- 订阅表（按 Skill 独立）\n   182→CREATE TABLE subscriptions (\n   183→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   184→    user_id UUID REFERENCES users(id),\n   185→    skill TEXT NOT NULL,  -- 'bazi', 'zodiac', 'mbti', 'career'\n   186→    tier TEXT NOT NULL DEFAULT 'free',  -- 'free', 'pro', 'premium'\n   187→    price_cents INT,  -- 支持差异化定价\n   188→    status TEXT NOT NULL DEFAULT 'active',\n   189→    starts_at TIMESTAMPTZ DEFAULT NOW(),\n   190→    expires_at TIMESTAMPTZ,\n   191→    stripe_subscription_id TEXT,\n   192→    UNIQUE(user_id, skill)\n   193→);\n   194→\n   195→-- Phase 2: 全家桶套餐\n   196→CREATE TABLE bundle_subscriptions (\n   197→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   198→    user_id UUID REFERENCES users(id),\n   199→    bundle_type TEXT NOT NULL,  -- 'all_access'\n   200→    price_cents INT,\n   201→    status TEXT,\n   202→    starts_at TIMESTAMPTZ,\n   203→    expires_at TIMESTAMPTZ\n   204→);\n   205→\n   206→-- 共享 Profile（已有 user_profiles 表）\n   207→-- ai_insights, identity_prism 等数据全局共享\n   208→\n   209→-- Skill 专属数据\n   210→CREATE TABLE skill_data (\n   211→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   212→    user_id UUID REFERENCES users(id),\n   213→    skill TEXT NOT NULL,\n   214→    data_type TEXT NOT NULL,  -- 'conversation', 'report', 'chart'\n   215→    data JSONB,\n   216→    created_at TIMESTAMPTZ DEFAULT NOW()\n   217→);\n   218→```\n   219→\n   220→---\n   221→\n   222→## 4. 前端架构\n   223→\n   224→### 4.1 代码组织（Monorepo + 路由组）\n   225→\n   226→```\n   227→apps/web/src/\n   228→├── app/\n   229→│   │\n   230→│   ├── (www)/                    # 主站（品牌索引页）\n   231→│   │   ├── layout.tsx            # 主站布局\n   232→│   │   └── page.tsx              # 品牌索引页\n   233→│   │\n   234→│   ├── (bazi)/                   # Bazi 路由组\n   235→│   │   ├── layout.tsx            # Bazi 专属布局\n   236→│   │   ├── page.tsx              # Bazi 首页\n   237→│   │   ├── chat/page.tsx         # 聊天\n   238→│   │   ├── chart/page.tsx        # 命盘\n   239→│   │   ├── report/page.tsx       # 报告\n   240→│   │   └── relationship/page.tsx # 关系\n   241→│   │\n   242→│   ├── (zodiac)/                 # Zodiac 路由组\n   243→│   │   ├── layout.tsx            # Zodiac 专属布局\n   244→│   │   ├── page.tsx              # Zodiac 首页\n   245→│   │   ├── chat/page.tsx\n   246→│   │   ├── chart/page.tsx\n   247→│   │   ├── report/page.tsx\n   248→│   │   └── relationship/page.tsx\n   249→│   │\n   250→│   ├── (shared)/                 # 共享路由\n   251→│   │   ├── auth/\n   252→│   │   │   ├── login/page.tsx\n   253→│   │   │   ├── register/page.tsx\n   254→│   │   │   └── sso-callback/page.tsx\n   255→│   │   └── me/\n   256→│   │       ├── page.tsx          # 个人中心\n   257→│   │       └── subscriptions/page.tsx  # 订阅管理\n   258→│   │\n   259→│   └── middleware.ts             # 子域名路由中间件\n   260→│\n   261→├── components/\n   262→│   ├── core/                     # 共享核心组件\n   263→│   │   ├── LuminousPaper.tsx\n   264→│   │   ├── BreathAura.tsx\n   265→│   │   ├── InsightCard.tsx\n   266→│   │   └── GlobalNav.tsx         # 统一顶栏\n   267→│   │\n   268→│   ├── chat/                     # 共享聊天组件\n   269→│   │   ├── ChatContainer.tsx\n   270→│   │   ├── ChatMessage.tsx\n   271→│   │   └── ChatInput.tsx\n   272→│   │\n   273→│   ├── bazi/                     # Bazi 专属组件\n   274→│   │   ├── BaziChart.tsx\n   275→│   │   ├── WuxingDisplay.tsx\n   276→│   │   ├── DayunTimeline.tsx\n   277→│   │   └── BaziThemeProvider.tsx\n   278→│   │\n   279→│   └── zodiac/                   # Zodiac 专属组件\n   280→│       ├── NatalChart.tsx\n   281→│       ├── PlanetPositions.tsx\n   282→│       ├── TransitOverlay.tsx\n   283→│       └── ZodiacThemeProvider.tsx\n   284→│\n   285→└── styles/\n   286→    ├── globals.css               # 共享基础样式\n   287→    ├── themes/\n   288→    │   ├── bazi.css              # 玄金 #8B7355 + 朱砂 #C45C48\n   289→    │   └── zodiac.css            # 星蓝 #4A5568 + 金线 #D4AF37\n   290→    └── components/               # 组件样式\n   291→```\n   292→\n   293→### 4.2 Middleware 子域名路由\n   294→\n   295→```typescript\n   296→// apps/web/src/middleware.ts\n   297→import { NextRequest, NextResponse } from 'next/server';\n   298→\n   299→const SKILL_DOMAINS: Record<string, string> = {\n   300→  'bazi': 'bazi',\n   301→  'zodiac': 'zodiac',\n   302→  'mbti': 'mbti',\n   303→  'career': 'career',\n   304→  'www': 'www',\n   305→};\n   306→\n   307→export function middleware(request: NextRequest) {\n   308→  const hostname = request.headers.get('host') || '';\n   309→  const subdomain = hostname.split('.')[0];\n   310→\n   311→  // 识别 skill\n   312→  const skill = SKILL_DOMAINS[subdomain] || 'bazi';\n   313→\n   314→  // 设置 skill 到 Cookie 和 Header\n   315→  const response = NextResponse.next();\n   316→  response.cookies.set('vibelife_skill', skill, {\n   317→    domain: '.vibelife.app',\n   318→    path: '/',\n   319→  });\n   320→  response.headers.set('x-vibelife-skill', skill);\n   321→\n   322→  return response;\n   323→}\n   324→\n   325→export const config = {\n   326→  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],\n   327→};\n   328→```\n   329→\n   330→### 4.3 统一顶栏组件\n   331→\n   332→```typescript\n   333→// apps/web/src/components/core/GlobalNav.tsx\n   334→'use client';\n   335→\n   336→import { useSkill } from '@/providers/SkillProvider';\n   337→import Link from 'next/link';\n   338→\n   339→const SKILL_LINKS = [\n   340→  { skill: 'bazi', label: '八字', href: 'https://bazi.vibelife.app' },\n   341→  { skill: 'zodiac', label: '星座', href: 'https://zodiac.vibelife.app' },\n   342→  { skill: 'mbti', label: 'MBTI', href: 'https://mbti.vibelife.app', disabled: true },\n   343→];\n   344→\n   345→export function GlobalNav() {\n   346→  const { skill: currentSkill } = useSkill();\n   347→\n   348→  return (\n   349→    <nav className=\"h-12 border-b border-vellum-200 bg-vellum/80 backdrop-blur\">\n   350→      <div className=\"flex items-center justify-between px-4 h-full\">\n   351→        {/* Logo */}\n   352→        <Link href=\"https://www.vibelife.app\" className=\"flex items-center gap-2\">\n   353→          <span className=\"text-lg font-serif text-ink\">VibeLife</span>\n   354→        </Link>\n   355→\n   356→        {/* Skill 导航 */}\n   357→        <div className=\"flex items-center gap-4\">\n   358→          {SKILL_LINKS.map(({ skill, label, href, disabled }) => (\n   359→            <a\n   360→              key={skill}\n   361→              href={disabled ? undefined : href}\n   362→              className={`\n   363→                text-sm transition-colors\n   364→                ${currentSkill === skill\n   365→                  ? 'text-ink font-medium'\n   366→                  : 'text-ink/60 hover:text-ink'}\n   367→                ${disabled ? 'opacity-40 cursor-not-allowed' : ''}\n   368→              `}\n   369→            >\n   370→              {label}\n   371→            </a>\n   372→          ))}\n   373→        </div>\n   374→\n   375→        {/* 用户菜单 */}\n   376→        <UserMenu />\n   377→      </div>\n   378→    </nav>\n   379→  );\n   380→}\n   381→```\n   382→\n   383→---\n   384→\n   385→## 5. 后端服务架构\n   386→\n   387→### 5.1 服务共享模型\n   388→\n   389→```\n   390→┌─────────────────────────────────────────────────────────────────┐\n   391→│                        API Gateway                               │\n   392→│                   api.vibelife.app                              │\n   393→├─────────────────────────────────────────────────────────────────┤\n   394→│                                                                 │\n   395→│   所有子域名共享同一个后端 API                                    │\n   396→│                                                                 │\n   397→│   bazi.vibelife.app  ─┐                                        │\n   398→│                       │                                         │\n   399→│   zodiac.vibelife.app ├──▶  api.vibelife.app                   │\n   400→│                       │                                         │\n   401→│   mbti.vibelife.app  ─┘                                        │\n   402→│                                                                 │\n   403→├─────────────────────────────────────────────────────────────────┤\n   404→│                                                                 │\n   405→│   API 路由                                                      │\n   406→│   ─────────────────────────────────────────────────────────     │\n   407→│                                                                 │\n   408→│   POST /api/v1/chat/stream                                      │\n   409→│        Body: { skill: \"bazi\", message: \"...\" }                  │\n   410→│                                                                 │\n   411→│   POST /api/v1/report/generate                                  │\n   412→│        Body: { skill: \"zodiac\", level: \"full\" }                 │\n   413→│                                                                 │\n   414→│   GET /api/v1/user/subscriptions                                │\n   415→│        Response: [                                              │\n   416→│          { skill: \"bazi\", tier: \"pro\", expires_at: \"...\" },     │\n   417→│          { skill: \"zodiac\", tier: \"free\" }                      │\n   418→│        ]                                                        │\n   419→│                                                                 │\n   420→└─────────────────────────────────────────────────────────────────┘\n   421→```\n   422→\n   423→### 5.2 订阅验证中间件\n   424→\n   425→```python\n   426→# apps/api/middleware/subscription.py\n   427→from functools import wraps\n   428→from fastapi import HTTPException, Request\n   429→\n   430→def require_subscription(skill: str, min_tier: str = \"pro\"):\n   431→    \"\"\"检查用户是否有指定 Skill 的订阅\"\"\"\n   432→    def decorator(func):\n   433→        @wraps(func)\n   434→        async def wrapper(request: Request, *args, **kwargs):\n   435→            user_id = request.state.user_id\n   436→\n   437→            # 检查订阅\n   438→            subscription = await get_user_subscription(user_id, skill)\n   439→\n   440→            if not subscription or subscription.tier < min_tier:\n   441→                raise HTTPException(\n   442→                    status_code=402,\n   443→                    detail={\n   444→                        \"error\": \"subscription_required\",\n   445→                        \"skill\": skill,\n   446→                        \"required_tier\": min_tier,\n   447→                        \"current_tier\": subscription.tier if subscription else \"free\"\n   448→                    }\n   449→                )\n   450→\n   451→            return await func(request, *args, **kwargs)\n   452→        return wrapper\n   453→    return decorator\n   454→\n   455→# 使用示例\n   456→@router.post(\"/report/generate\")\n   457→@require_subscription(skill_from_body=True, min_tier=\"pro\")\n   458→async def generate_report(request: ReportRequest):\n   459→    ...\n   460→```\n   461→\n   462→### 5.3 定价配置\n   463→\n   464→> **定价策略**：Phase 1 定价待定，系统先支持差异化定价能力。以下为示例配置。\n   465→\n   466→```python\n   467→# apps/api/config/pricing.py\n   468→from typing import Dict\n   469→from dataclasses import dataclass\n   470→\n   471→@dataclass\n   472→class SkillPricing:\n   473→    skill: str\n   474→    tiers: Dict[str, int]  # tier -> price_cents\n   475→\n   476→# Phase 1: 定价待定，系统支持差异化定价\n   477→# 以下为示例配置，上线前确认具体价格\n   478→SKILL_PRICING = {\n   479→    \"bazi\": SkillPricing(\n   480→        skill=\"bazi\",\n   481→        tiers={\n   482→            \"free\": 0,\n   483→            \"pro\": 1990,      # ¥19.9/月（待定）\n   484→            \"premium\": 2990,  # ¥29.9/月（预留）\n   485→        }\n   486→    ),\n   487→    \"zodiac\": SkillPricing(\n   488→        skill=\"zodiac\",\n   489→        tiers={\n   490→            \"free\": 0,\n   491→            \"pro\": 1990,      # ¥19.9/月（待定）\n   492→            \"premium\": 2990,\n   493→        }\n   494→    ),\n   495→}\n   496→\n   497→# Phase 2: 全家桶套餐\n   498→BUNDLE_PRICING = {\n   499→    \"all_access\": {\n   500→        \"monthly\": 4990,   # ¥49.9/月\n   501→        \"yearly\": 39900,   # ¥399/年\n   502→    }\n   503→}\n   504→```\n   505→\n   506→---\n   507→\n   508→## 6. 支付与收费架构\n   509→\n   510→### 6.1 支付服务商策略\n   511→\n   512→> **核心决策**：网站部署海外，仅海外主体，采用 **Stripe 为主 + Airwallex 补充** 的双轨支付架构。\n   513→\n   514→```\n   515→┌─────────────────────────────────────────────────────────────────┐\n   516→│                        支付架构总览                              │\n   517→├─────────────────────────────────────────────────────────────────┤\n   518→│                                                                 │\n   519→│   用户地区识别                                                   │\n   520→│        │                                                        │\n   521→│        ├─── 海外用户 ──────────────────────┐                    │\n   522→│        │                                   │                    │\n   523→│        │    ┌─────────────────────────┐    │                    │\n   524→│        │    │       Stripe            │    │                    │\n   525→│        │    │                         │    │                    │\n   526→│        │    │  • Credit Card          │    │                    │\n   527→│        │    │  • Apple Pay            │    │                    │\n   528→│        │    │  • Google Pay           │    │                    │\n   529→│        │    │  • PayPal (via Stripe)  │    │                    │\n   530→│        │    └─────────────────────────┘    │                    │\n   531→│        │                                   │                    │\n   532→│        └─── 国内用户 ──────────────────────┤                    │\n   533→│                                            │                    │\n   534→│             ┌─────────────────────────┐    │                    │\n   535→│             │      Airwallex          │    │                    │\n   536→│             │    (跨境收单)            │    │                    │\n   537→│             │                         │    │                    │\n   538→│             │  • 微信支付 (WeChat Pay) │    │                    │\n   539→│             │  • 支付宝 (Alipay)       │    │                    │\n   540→│             └─────────────────────────┘    │                    │\n   541→│                                            │                    │\n   542→│                                            ▼                    │\n   543→│                              ┌─────────────────────────┐        │\n   544→│                              │     海外银行账户         │        │\n   545→│                              │   (统一结算)            │        │\n   546→│                              └─────────────────────────┘        │\n   547→│                                                                 │\n   548→└─────────────────────────────────────────────────────────────────┘\n   549→```\n   550→\n   551→### 6.2 Stripe vs Airwallex 对比\n   552→\n   553→| 维度 | Stripe | Airwallex |\n   554→|------|--------|-----------|\n   555→| **海外信用卡** | ✅ 最佳体验 | ✅ 支持 |\n   556→| **Apple Pay / Google Pay** | ✅ 原生支持 | ⚠️ 有限支持 |\n   557→| **微信支付 (跨境)** | ⚠️ 需中国实体 | ✅ 海外主体可用 |\n   558→| **支付宝 (跨境)** | ⚠️ 需中国实体 | ✅ 海外主体可用 |\n   559→| **订阅管理** | ✅ Stripe Billing 强大 | ⚠️ 需自建 |\n   560→| **费率 (海外)** | 2.9% + $0.30 | 2.5% + $0.30 |\n   561→| **费率 (国内)** | N/A | 3.5% + ¥0.50 |\n   562→| **适用场景** | 海外用户为主 | 国内用户跨境收款 |\n   563→\n   564→### 6.3 双轨支付技术实现\n   565→\n   566→```python\n   567→# apps/api/services/billing/payment_router.py\n   568→from enum import Enum\n   569→from typing import Optional\n   570→\n   571→class PaymentProvider(Enum):\n   572→    STRIPE = \"stripe\"\n   573→    AIRWALLEX = \"airwallex\"\n   574→\n   575→class PaymentRouter:\n   576→    \"\"\"根据用户地区和支付方式路由到对应支付服务商\"\"\"\n   577→\n   578→    def get_provider(\n   579→        self,\n   580→        user_region: str,\n   581→        payment_method: str\n   582→    ) -> PaymentProvider:\n   583→        # 国内用户 + 微信/支付宝 → Airwallex\n   584→        if user_region == \"CN\" and payment_method in [\"wechat_pay\", \"alipay\"]:\n   585→            return PaymentProvider.AIRWALLEX\n   586→\n   587→        # 其他情况 → Stripe\n   588→        return PaymentProvider.STRIPE\n   589→\n   590→    async def create_checkout_session(\n   591→        self,\n   592→        user_id: str,\n   593→        product_type: str,  # 'subscription' | 'one_time' | 'addon'\n   594→        product_id: str,\n   595→        currency: str,\n   596→        user_region: str,\n   597→        payment_method: Optional[str] = None\n   598→    ):\n   599→        provider = self.get_provider(user_region, payment_method)\n   600→\n   601→        if provider == PaymentProvider.STRIPE:\n   602→            return await self.stripe_service.create_session(...)\n   603→        else:\n   604→            return await self.airwallex_service.create_session(...)\n   605→```\n   606→\n   607→### 6.4 双币种定价策略\n   608→\n   609→```python\n   610→# apps/api/config/pricing.py\n   611→from dataclasses import dataclass\n   612→from typing import Dict\n   613→\n   614→@dataclass\n   615→class MultiCurrencyPrice:\n   616→    cny: int  # 人民币（分）\n   617→    usd: int  # 美元（美分）\n   618→\n   619→# 订阅定价（双币种）\n   620→SUBSCRIPTION_PRICING = {\n   621→    \"bazi\": {\n   622→        \"pro\": {\n   623→            \"monthly\": MultiCurrencyPrice(cny=1990, usd=299),   # ¥19.9 / $2.99\n   624→            \"yearly\": MultiCurrencyPrice(cny=15900, usd=2399),  # ¥159 / $23.99\n   625→        }\n   626→    },\n   627→    \"zodiac\": {\n   628→        \"pro\": {\n   629→            \"monthly\": MultiCurrencyPrice(cny=1990, usd=299),\n   630→            \"yearly\": MultiCurrencyPrice(cny=15900, usd=2399),\n   631→        }\n   632→    },\n   633→}\n   634→\n   635→# 单次购买定价\n   636→ONE_TIME_PRICING = {\n   637→    \"full_report\": MultiCurrencyPrice(cny=1990, usd=299),      # ¥19.9 / $2.99\n   638→    \"ai_portrait\": MultiCurrencyPrice(cny=990, usd=149),       # ¥9.9 / $1.49\n   639→    \"relationship_report\": MultiCurrencyPrice(cny=1990, usd=299),\n   640→}\n   641→\n   642→# 增值服务定价\n   643→ADDON_PRICING = {\n   644→    \"ai_art_report\": MultiCurrencyPrice(cny=990, usd=149),     # AI 生图报告\n   645→    \"deep_analysis\": MultiCurrencyPrice(cny=1990, usd=299),    # 深度分析\n   646→    \"extra_chat_quota\": MultiCurrencyPrice(cny=590, usd=99),   # 额外对话额度\n   647→}\n   648→\n   649→# Phase 2: 全家桶套餐\n   650→BUNDLE_PRICING = {\n   651→    \"all_access\": {\n   652→        \"monthly\": MultiCurrencyPrice(cny=4990, usd=699),      # ¥49.9 / $6.99\n   653→        \"yearly\": MultiCurrencyPrice(cny=39900, usd=5999),     # ¥399 / $59.99\n   654→    }\n   655→}\n   656→\n   657→def get_price(price: MultiCurrencyPrice, region: str) -> tuple[int, str]:\n   658→    \"\"\"根据用户地区返回对应币种价格\"\"\"\n   659→    if region == \"CN\":\n   660→        return price.cny, \"CNY\"\n   661→    return price.usd, \"USD\"\n   662→```\n   663→\n   664→### 6.5 产品类型与计费模型\n   665→\n   666→```\n   667→┌─────────────────────────────────────────────────────────────────┐\n   668→│                        计费模型总览                              │\n   669→├─────────────────────────────────────────────────────────────────┤\n   670→│                                                                 │\n   671→│   1. 订阅 (Subscription)                                        │\n   672→│   ─────────────────────────────────────────────────────────     │\n   673→│   • 按 Skill 独立订阅（bazi_pro, zodiac_pro）                   │\n   674→│   • 支持月付 / 年付（年付享折扣）                                │\n   675→│   • Stripe Billing 管理订阅生命周期                             │\n   676→│   • 自动续费 + 到期提醒                                         │\n   677→│                                                                 │\n   678→│   2. 单次购买 (One-time)                                        │\n   679→│   ─────────────────────────────────────────────────────────     │\n   680→│   • 完整报告套餐                                                │\n   681→│   • AI 生图报告                                                 │\n   682→│   • 关系分析报告                                                │\n   683→│   • 购买后永久有效                                              │\n   684→│                                                                 │\n   685→│   3. 增值服务 (Add-on)                                          │\n   686→│   ─────────────────────────────────────────────────────────     │\n   687→│   • 订阅用户可额外购买                                          │\n   688→│   • AI 艺术报告（高清海报）                                     │\n   689→│   • 深度咨询时长                                                │\n   690→│   • 额外对话额度                                                │\n   691→│                                                                 │\n   692→│   4. 全家桶套餐 (Bundle) - Phase 2                              │\n   693→│   ─────────────────────────────────────────────────────────     │\n   694→│   • All Access：解锁所有 Skill                                  │\n   695→│   • 月付 / 年付                                                 │\n   696→│                                                                 │\n   697→└─────────────────────────────────────────────────────────────────┘\n   698→```\n   699→\n   700→### 6.6 数据库 Schema（支付相关）\n   701→\n   702→```sql\n   703→-- 订阅表（按 Skill 独立）\n   704→CREATE TABLE subscriptions (\n   705→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   706→    user_id UUID REFERENCES users(id),\n   707→    skill TEXT NOT NULL,  -- 'bazi', 'zodiac', 'mbti', 'career'\n   708→    tier TEXT NOT NULL DEFAULT 'free',\n   709→    billing_cycle TEXT,  -- 'monthly', 'yearly'\n   710→    currency TEXT NOT NULL,  -- 'CNY', 'USD'\n   711→    price_cents INT,\n   712→    status TEXT NOT NULL DEFAULT 'active',\n   713→    payment_provider TEXT,  -- 'stripe', 'airwallex'\n   714→    provider_subscription_id TEXT,  -- Stripe/Airwallex 订阅 ID\n   715→    starts_at TIMESTAMPTZ DEFAULT NOW(),\n   716→    current_period_start TIMESTAMPTZ,\n   717→    current_period_end TIMESTAMPTZ,\n   718→    cancel_at_period_end BOOLEAN DEFAULT FALSE,\n   719→    canceled_at TIMESTAMPTZ,\n   720→    created_at TIMESTAMPTZ DEFAULT NOW(),\n   721→    updated_at TIMESTAMPTZ DEFAULT NOW(),\n   722→    UNIQUE(user_id, skill)\n   723→);\n   724→\n   725→-- 单次购买记录\n   726→CREATE TABLE purchases (\n   727→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   728→    user_id UUID REFERENCES users(id),\n   729→    product_type TEXT NOT NULL,  -- 'report', 'ai_portrait', 'relationship'\n   730→    product_id TEXT,  -- 关联的报告/产品 ID\n   731→    skill TEXT,\n   732→    currency TEXT NOT NULL,\n   733→    amount_cents INT NOT NULL,\n   734→    payment_provider TEXT,\n   735→    provider_payment_id TEXT,\n   736→    status TEXT NOT NULL DEFAULT 'pending',\n   737→    created_at TIMESTAMPTZ DEFAULT NOW(),\n   738→    completed_at TIMESTAMPTZ\n   739→);\n   740→\n   741→-- 增值服务购买记录\n   742→CREATE TABLE addon_purchases (\n   743→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   744→    user_id UUID REFERENCES users(id),\n   745→    addon_type TEXT NOT NULL,  -- 'ai_art_report', 'deep_analysis', 'extra_chat_quota'\n   746→    skill TEXT,\n   747→    currency TEXT NOT NULL,\n   748→    amount_cents INT NOT NULL,\n   749→    quantity INT DEFAULT 1,\n   750→    payment_provider TEXT,\n   751→    provider_payment_id TEXT,\n   752→    status TEXT NOT NULL,\n   753→    created_at TIMESTAMPTZ DEFAULT NOW(),\n   754→    expires_at TIMESTAMPTZ  -- 部分增值服务有有效期\n   755→);\n   756→\n   757→-- 支付事件日志（对账用）\n   758→CREATE TABLE payment_events (\n   759→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n   760→    user_id UUID REFERENCES users(id),\n   761→    event_type TEXT NOT NULL,  -- 'checkout.completed', 'subscription.renewed', etc.\n   762→    payment_provider TEXT NOT NULL,\n   763→    provider_event_id TEXT,\n   764→    payload JSONB,\n   765→    created_at TIMESTAMPTZ DEFAULT NOW()\n   766→);\n   767→\n   768→-- 索引\n   769→CREATE INDEX idx_subscriptions_user ON subscriptions(user_id);\n   770→CREATE INDEX idx_subscriptions_provider ON subscriptions(payment_provider, provider_subscription_id);\n   771→CREATE INDEX idx_purchases_user ON purchases(user_id);\n   772→CREATE INDEX idx_payment_events_provider ON payment_events(payment_provider, provider_event_id);\n   773→```\n   774→\n   775→### 6.7 Webhook 处理\n   776→\n   777→```python\n   778→# apps/api/routes/webhooks.py\n   779→from fastapi import APIRouter, Request, HTTPException\n   780→import stripe\n   781→from services.billing import SubscriptionService, PurchaseService\n   782→\n   783→router = APIRouter()\n   784→\n   785→# Stripe Webhook\n   786→@router.post(\"/webhooks/stripe\")\n   787→async def stripe_webhook(request: Request):\n   788→    payload = await request.body()\n   789→    sig_header = request.headers.get(\"stripe-signature\")\n   790→\n   791→    try:\n   792→        event = stripe.Webhook.construct_event(\n   793→            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET\n   794→        )\n   795→    except ValueError:\n   796→        raise HTTPException(status_code=400, detail=\"Invalid payload\")\n   797→    except stripe.error.SignatureVerificationError:\n   798→        raise HTTPException(status_code=400, detail=\"Invalid signature\")\n   799→\n   800→    # 处理事件\n   801→    if event[\"type\"] == \"checkout.session.completed\":\n   802→        await handle_checkout_completed(event[\"data\"][\"object\"])\n   803→    elif event[\"type\"] == \"customer.subscription.updated\":\n   804→        await handle_subscription_updated(event[\"data\"][\"object\"])\n   805→    elif event[\"type\"] == \"customer.subscription.deleted\":\n   806→        await handle_subscription_canceled(event[\"data\"][\"object\"])\n   807→    elif event[\"type\"] == \"invoice.payment_failed\":\n   808→        await handle_payment_failed(event[\"data\"][\"object\"])\n   809→\n   810→    return {\"status\": \"ok\"}\n   811→\n   812→# Airwallex Webhook\n   813→@router.post(\"/webhooks/airwallex\")\n   814→async def airwallex_webhook(request: Request):\n   815→    payload = await request.json()\n   816→    signature = request.headers.get(\"x-signature\")\n   817→\n   818→    # 验证签名\n   819→    if not verify_airwallex_signature(payload, signature):\n   820→        raise HTTPException(status_code=400, detail=\"Invalid signature\")\n   821→\n   822→    event_type = payload.get(\"name\")\n   823→\n   824→    if event_type == \"payment_intent.succeeded\":\n   825→        await handle_airwallex_payment_success(payload[\"data\"][\"object\"])\n   826→    elif event_type == \"payment_intent.payment_failed\":\n   827→        await handle_airwallex_payment_failed(payload[\"data\"][\"object\"])\n   828→\n   829→    return {\"status\": \"ok\"}\n   830→```\n   831→\n   832→### 6.8 前端支付流程\n   833→\n   834→```typescript\n   835→// apps/web/src/lib/checkout.ts\n   836→import { loadStripe } from '@stripe/stripe-js';\n   837→\n   838→const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_KEY!);\n   839→\n   840→interface CheckoutParams {\n   841→  productType: 'subscription' | 'one_time' | 'addon';\n   842→  productId: string;\n   843→  skill?: string;\n   844→}\n   845→\n   846→export async function initiateCheckout(params: CheckoutParams) {\n   847→  // 1. 获取用户地区\n   848→  const region = await detectUserRegion();\n   849→\n   850→  // 2. 调用后端创建 checkout session\n   851→  const response = await fetch('/api/v1/billing/checkout', {\n   852→    method: 'POST',\n   853→    headers: { 'Content-Type': 'application/json' },\n   854→    body: JSON.stringify({\n   855→      ...params,\n   856→      region,\n   857→    }),\n   858→  });\n   859→\n   860→  const { provider, sessionId, redirectUrl } = await response.json();\n   861→\n   862→  // 3. 根据支付服务商跳转\n   863→  if (provider === 'stripe') {\n   864→    const stripe = await stripePromise;\n   865→    await stripe?.redirectToCheckout({ sessionId });\n   866→  } else if (provider === 'airwallex') {\n   867→    // Airwallex 跳转到支付页面\n   868→    window.location.href = redirectUrl;\n   869→  }\n   870→}\n   871→\n   872→// 用户地区检测\n   873→async function detectUserRegion(): Promise<string> {\n   874→  // 优先使用用户设置\n   875→  const savedRegion = localStorage.getItem('user_region');\n   876→  if (savedRegion) return savedRegion;\n   877→\n   878→  // 其次使用 IP 地理位置\n   879→  try {\n   880→    const response = await fetch('https://ipapi.co/json/');\n   881→    const data = await response.json();\n   882→    return data.country_code;\n   883→  } catch {\n   884→    return 'US'; // 默认海外\n   885→  }\n   886→}\n   887→```\n   888→\n   889→---\n   890→\n   891→## 7. 数据共享策略\n   892→\n   893→### 7.1 共享数据范围\n   894→\n   895→| 数据类型 | 共享级别 | 说明 |\n   896→|----------|----------|------|\n   897→| **基础信息** | ✅ 全局共享 | birth_datetime, birth_location, gender, name |\n   898→| **生活上下文** | ✅ 全局共享 | career, relationship, life_stage, recent_events |\n   899→| **AI 洞察** | ✅ 全局共享 | personality_traits, communication_style, emotional_patterns |\n   900→| **Identity Prism** | ✅ 全局共享 | core, inner, outer 三元身份 |\n   901→| **对话历史** | ❌ Skill 独立 | 各 Skill 对话分开存储 |\n   902→| **报告记录** | ❌ Skill 独立 | 各 Skill 报告分开存储 |\n   903→| **订阅状态** | ❌ Skill 独立 | 各 Skill 独立收费 |\n   904→\n   905→### 7.2 跨 Skill 数据利用\n   906→\n   907→```python\n   908→# 用户在 bazi 积累的画像可在 zodiac 使用\n   909→async def build_context(user_id: str, skill: str):\n   910→    # 1. 加载共享 Profile（所有 Skill 贡献的数据）\n   911→    shared_profile = await get_shared_profile(user_id)\n   912→\n   913→    # 2. 加载 Skill 专属数据\n   914→    skill_data = await get_skill_data(user_id, skill)\n   915→\n   916→    # 3. 构建上下文\n   917→    context = {\n   918→        \"shared\": {\n   919→            \"basic\": shared_profile.basic,\n   920→            \"life_context\": shared_profile.life_context,\n   921→            \"ai_insights\": shared_profile.ai_insights,\n   922→            \"identity_prism\": shared_profile.identity_prism,\n   923→        },\n   924→        \"skill_specific\": skill_data,\n   925→    }\n   926→\n   927→    return context\n   928→```\n   929→\n   930→---\n   931→\n   932→## 8. 部署架构\n   933→\n   934→### 8.1 Vercel 多域名部署\n   935→\n   936→```\n   937→┌─────────────────────────────────────────────────────────────────┐\n   938→│                        Vercel Project                            │\n   939→│                      vibelife-web                                │\n   940→├─────────────────────────────────────────────────────────────────┤\n   941→│                                                                 │\n   942→│   Domains:                                                      │\n   943→│   ├── www.vibelife.app      (Primary)                          │\n   944→│   ├── bazi.vibelife.app     (Alias)                            │\n   945→│   ├── zodiac.vibelife.app   (Alias)                            │\n   946→│   └── *.vibelife.app        (Wildcard)                         │\n   947→│                                                                 │\n   948→│   Environment Variables:                                        │\n   949→│   ├── NEXT_PUBLIC_API_URL=https://api.vibelife.app             │\n   950→│   ├── NEXT_PUBLIC_COOKIE_DOMAIN=.vibelife.app                  │\n   951→│   └── NEXT_PUBLIC_DEFAULT_SKILL=bazi                           │\n   952→│                                                                 │\n   953→└─────────────────────────────────────────────────────────────────┘\n   954→```\n   955→\n   956→### 8.2 本地开发配置\n   957→\n   958→```bash\n   959→# /etc/hosts (本地开发)\n   960→127.0.0.1 www.vibelife.local\n   961→127.0.0.1 bazi.vibelife.local\n   962→127.0.0.1 zodiac.vibelife.local\n   963→```\n   964→\n   965→```env\n   966→# .env.local\n   967→NEXT_PUBLIC_API_URL=http://localhost:8000\n   968→NEXT_PUBLIC_COOKIE_DOMAIN=.vibelife.local\n   969→```\n   970→\n   971→---\n   972→\n   973→## 9. 实施路线图\n   974→\n   975→### Phase 1 (当前)\n   976→\n   977→- [x] 子域名架构设计\n   978→- [x] 支付架构设计（Stripe + Airwallex 双轨）\n   979→- [ ] middleware.ts 子域名路由完善\n   980→- [ ] (www)/ (bazi)/ (zodiac)/ 路由组创建\n   981→- [ ] 统一顶栏 GlobalNav 实现\n   982→- [ ] SSO Cookie 跨域配置\n   983→- [ ] 订阅表 Schema 扩展（支持多币种、多支付商）\n   984→- [ ] Stripe 集成（海外信用卡、订阅管理）\n   985→- [ ] Airwallex 集成（国内微信/支付宝跨境收单）\n   986→- [ ] 双币种定价系统\n   987→- [ ] Webhook 处理（Stripe + Airwallex）\n   988→\n   989→### Phase 2\n   990→\n   991→- [ ] 全家桶套餐（All Access）\n   992→- [ ] MBTI Skill 上线\n   993→- [ ] 增值服务商店\n   994→- [ ] 跨 Skill 数据分析\n   995→- [ ] 订阅用户留存优化\n   996→\n   997→### Phase 3\n   998→\n   999→- [ ] 主 App (app.vibelife.app) 开发\n  1000→- [ ] 子域名转为落地页\n  1001→- [ ] 原生 App 开发\n  1002→\n  1003→---\n  1004→\n  1005→## 10. 关键文件清单\n  1006→\n  1007→### 前端\n  1008→\n  1009→| 文件 | 作用 |\n  1010→|------|------|\n  1011→| `apps/web/src/middleware.ts` | 子域名路由 |\n  1012→| `apps/web/src/providers/SkillProvider.tsx` | Skill 上下文 |\n  1013→| `apps/web/src/components/core/GlobalNav.tsx` | 统一顶栏 |\n  1014→| `apps/web/src/app/(www)/layout.tsx` | 主站布局 |\n  1015→| `apps/web/src/app/(bazi)/layout.tsx` | Bazi 专属布局 |\n  1016→| `apps/web/src/app/(zodiac)/layout.tsx` | Zodiac 专属布局 |\n  1017→| `apps/web/src/lib/checkout.ts` | 支付流程 |\n  1018→| `vercel.json` | 部署配置 |\n  1019→\n  1020→### 后端\n  1021→\n  1022→| 文件 | 作用 |\n  1023→|------|------|\n  1024→| `apps/api/services/billing/payment_router.py` | 支付路由（Stripe/Airwallex） |\n  1025→| `apps/api/services/billing/stripe_service.py` | Stripe 服务 |\n  1026→| `apps/api/services/billing/airwallex_service.py` | Airwallex 服务 |\n  1027→| `apps/api/config/pricing.py` | 定价配置（双币种） |\n  1028→| `apps/api/middleware/subscription.py` | 订阅验证 |\n  1029→| `apps/api/routes/webhooks.py` | Webhook 处理 |\n  1030→| `apps/api/routes/billing.py` | 计费 API |\n  1031→\n  1032→### 数据库\n  1033→\n  1034→| 文件 | 作用 |\n  1035→|------|------|\n  1036→| `migrations/002_subscriptions.sql` | 订阅表 Schema |\n  1037→| `migrations/003_purchases.sql` | 单次购买表 |\n  1038→| `migrations/004_addon_purchases.sql` | 增值服务表 |\n  1039→| `migrations/005_payment_events.sql` | 支付事件日志 |\n  1040→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"dde14e84-6a14-47a1-97c8-aa6d788d8306","timestamp":"2026-01-07T10:04:45.638Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/vibelife/docs/archive/v3/matrix-strategy-architecture.md","content":"# VibeLife 矩阵战略架构方案\n\n> **文档版本**: v1.0\n> **更新日期**: 2026-01-07\n> **战略阶段**: Phase 1 & 2 去中心化流量验证 → Phase 3 中心化生态聚合\n\n---\n\n## 1. 战略概述\n\n### 1.1 矩阵战略核心\n\n| 阶段 | 目标 | 架构特征 |\n|------|------|----------|\n| **Phase 1** | 去中心化获客 + 验证 | 独立子域名，快速试错 |\n| **Phase 2** | 矩阵扩展 + 交叉销售 | 统一账户，独立收费 |\n| **Phase 3** | 中心化生态 | 主 App 聚合，子域名变落地页 |\n\n### 1.2 核心决策\n\n| 决策点 | 选择 | 理由 |\n|--------|------|------|\n| **域名策略** | 子域名 (Subdomain) | 工程速度 + 风险隔离 + 独立品牌感 |\n| **命名风格** | 直接命名 (bazi/zodiac) | SEO 友好 + 中文用户易记 |\n| **路由策略** | 路由组物理隔离 | (bazi)/ (zodiac)/ 独立页面文件，深度定制 UI |\n| **账户体系** | 共享注册登录 | Cookie 设在 .vibelife.app，跨子域名 SSO |\n| **收费模式** | 各 Skill 独立收费 | 系统支持差异化定价，具体价格待定 |\n| **数据策略** | 深度共享 | 「了解你越多越深」核心价值 |\n| **视觉关联** | 强关联 - 统一顶栏 | 品牌矩阵感 |\n| **主站定位** | 品牌索引页 (Phase 1) | www.vibelife.app 作为品牌入口 |\n| **支付架构** | Stripe + Airwallex 双轨 | 海外主体，国内外用户各半 |\n| **定价币种** | 双币种 (CNY/USD) | 根据用户地区自动切换 |\n| **计费模型** | 订阅 + 单次 + 增值服务 | 灵活的商业模式 |\n\n---\n\n## 2. 域名架构\n\n### 2.1 子域名规划\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                     vibelife.app 域名矩阵                        │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│   www.vibelife.app          ← 品牌索引页（Phase 1）             │\n│        │                                                        │\n│        ├── bazi.vibelife.app    ← 八字命理（P1 上线）           │\n│        │                                                        │\n│        ├── zodiac.vibelife.app  ← 星座占星（P1 上线）           │\n│        │                                                        │\n│        ├── mbti.vibelife.app    ← MBTI 人格（P2 规划）          │\n│        │                                                        │\n│        ├── career.vibelife.app  ← 职业发展（P2 规划）           │\n│        │                                                        │\n│        └── app.vibelife.app     ← 主 App（Phase 3）             │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### 2.2 DNS 配置\n\n```\n# Vercel/Cloudflare DNS 配置\n*.vibelife.app    CNAME    cname.vercel-dns.com\nwww.vibelife.app  CNAME    cname.vercel-dns.com\n```\n\n### 2.3 Vercel 配置 (vercel.json)\n\n> **路由策略**：采用路由组物理隔离模式，每个子域名映射到对应的路由组目录，实现深度定制 UI。\n\n```json\n{\n  \"rewrites\": [\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"www.vibelife.app\" }],\n      \"destination\": \"/www/:path*\"\n    },\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"bazi.vibelife.app\" }],\n      \"destination\": \"/bazi/:path*\"\n    },\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"zodiac.vibelife.app\" }],\n      \"destination\": \"/zodiac/:path*\"\n    }\n  ]\n}\n```\n\n---\n\n## 3. 账户与认证架构\n\n### 3.1 共享账户 + 独立订阅模型\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        用户账户层（全局共享）                     │\n│                                                                 │\n│   ┌─────────────────────────────────────────────────────────┐   │\n│   │  User                                                   │   │\n│   │  ├── id: UUID (全局唯一)                                │   │\n│   │  ├── email / phone / oauth_provider                     │   │\n│   │  ├── created_at                                         │   │\n│   │  └── Cookie Domain: .vibelife.app (根域名)              │   │\n│   └─────────────────────────────────────────────────────────┘   │\n│                              │                                   │\n│              ┌───────────────┼───────────────┐                   │\n│              ▼               ▼               ▼                   │\n│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │\n│   │  Bazi Profile   │ │ Zodiac Profile  │ │  MBTI Profile   │   │\n│   │                 │ │                 │ │                 │   │\n│   │ • 命盘数据      │ │ • 星盘数据      │ │ • 类型数据      │   │\n│   │ • 对话历史      │ │ • 对话历史      │ │ • 对话历史      │   │\n│   │ • 报告记录      │ │ • 报告记录      │ │ • 报告记录      │   │\n│   └────────┬────────┘ └────────┬────────┘ └────────┬────────┘   │\n│            │                   │                   │             │\n│   ┌────────▼────────┐ ┌────────▼────────┐ ┌────────▼────────┐   │\n│   │ Bazi Subscribe  │ │Zodiac Subscribe │ │ MBTI Subscribe  │   │\n│   │                 │ │                 │ │                 │   │\n│   │ tier: pro       │ │ tier: free      │ │ tier: free      │   │\n│   │ price: ¥19.9/mo │ │ price: ¥19.9/mo │ │ price: ¥19.9/mo │   │\n│   └─────────────────┘ └─────────────────┘ └─────────────────┘   │\n│                                                                 │\n├─────────────────────────────────────────────────────────────────┤\n│                        共享数据层                                │\n│                                                                 │\n│   ┌─────────────────────────────────────────────────────────┐   │\n│   │  Shared Profile (深度共享)                              │   │\n│   │  ├── basic: { birth_datetime, birth_location, gender }  │   │\n│   │  ├── life_context: { career, relationship, events }     │   │\n│   │  ├── ai_insights: { traits, patterns, growth_areas }    │   │\n│   │  └── identity_prism: { core, inner, outer }             │   │\n│   └─────────────────────────────────────────────────────────┘   │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### 3.2 SSO 技术实现\n\n**Cookie 设置（根域名共享）**：\n```typescript\n// apps/api/services/identity/auth.py\ndef set_auth_cookie(response: Response, token: str):\n    response.set_cookie(\n        key=\"vibelife_token\",\n        value=token,\n        domain=\".vibelife.app\",  # 关键：根域名\n        httponly=True,\n        secure=True,\n        samesite=\"lax\",\n        max_age=60 * 60 * 24 * 30  # 30 天\n    )\n```\n\n**前端 Cookie 读取**：\n```typescript\n// apps/web/src/lib/auth.ts\nexport function getAuthToken(): string | null {\n  // Cookie 自动在所有 *.vibelife.app 子域名共享\n  return Cookies.get('vibelife_token');\n}\n```\n\n### 3.3 数据库 Schema 扩展\n\n```sql\n-- 用户表（已有）\nCREATE TABLE users (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    email TEXT UNIQUE,\n    phone TEXT UNIQUE,\n    created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- 订阅表（按 Skill 独立）\nCREATE TABLE subscriptions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    skill TEXT NOT NULL,  -- 'bazi', 'zodiac', 'mbti', 'career'\n    tier TEXT NOT NULL DEFAULT 'free',  -- 'free', 'pro', 'premium'\n    price_cents INT,  -- 支持差异化定价\n    status TEXT NOT NULL DEFAULT 'active',\n    starts_at TIMESTAMPTZ DEFAULT NOW(),\n    expires_at TIMESTAMPTZ,\n    stripe_subscription_id TEXT,\n    UNIQUE(user_id, skill)\n);\n\n-- Phase 2: 全家桶套餐\nCREATE TABLE bundle_subscriptions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    bundle_type TEXT NOT NULL,  -- 'all_access'\n    price_cents INT,\n    status TEXT,\n    starts_at TIMESTAMPTZ,\n    expires_at TIMESTAMPTZ\n);\n\n-- 共享 Profile（已有 user_profiles 表）\n-- ai_insights, identity_prism 等数据全局共享\n\n-- Skill 专属数据\nCREATE TABLE skill_data (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    skill TEXT NOT NULL,\n    data_type TEXT NOT NULL,  -- 'conversation', 'report', 'chart'\n    data JSONB,\n    created_at TIMESTAMPTZ DEFAULT NOW()\n);\n```\n\n---\n\n## 4. 前端架构\n\n### 4.1 代码组织（Monorepo + 路由组）\n\n```\napps/web/src/\n├── app/\n│   │\n│   ├── (www)/                    # 主站（品牌索引页）\n│   │   ├── layout.tsx            # 主站布局\n│   │   └── page.tsx              # 品牌索引页\n│   │\n│   ├── (bazi)/                   # Bazi 路由组\n│   │   ├── layout.tsx            # Bazi 专属布局\n│   │   ├── page.tsx              # Bazi 首页\n│   │   ├── chat/page.tsx         # 聊天\n│   │   ├── chart/page.tsx        # 命盘\n│   │   ├── report/page.tsx       # 报告\n│   │   └── relationship/page.tsx # 关系\n│   │\n│   ├── (zodiac)/                 # Zodiac 路由组\n│   │   ├── layout.tsx            # Zodiac 专属布局\n│   │   ├── page.tsx              # Zodiac 首页\n│   │   ├── chat/page.tsx\n│   │   ├── chart/page.tsx\n│   │   ├── report/page.tsx\n│   │   └── relationship/page.tsx\n│   │\n│   ├── (shared)/                 # 共享路由\n│   │   ├── auth/\n│   │   │   ├── login/page.tsx\n│   │   │   ├── register/page.tsx\n│   │   │   └── sso-callback/page.tsx\n│   │   └── me/\n│   │       ├── page.tsx          # 个人中心\n│   │       └── subscriptions/page.tsx  # 订阅管理\n│   │\n│   └── middleware.ts             # 子域名路由中间件\n│\n├── components/\n│   ├── core/                     # 共享核心组件\n│   │   ├── LuminousPaper.tsx\n│   │   ├── BreathAura.tsx\n│   │   ├── InsightCard.tsx\n│   │   └── GlobalNav.tsx         # 统一顶栏\n│   │\n│   ├── chat/                     # 共享聊天组件\n│   │   ├── ChatContainer.tsx\n│   │   ├── ChatMessage.tsx\n│   │   └── ChatInput.tsx\n│   │\n│   ├── bazi/                     # Bazi 专属组件\n│   │   ├── BaziChart.tsx\n│   │   ├── WuxingDisplay.tsx\n│   │   ├── DayunTimeline.tsx\n│   │   └── BaziThemeProvider.tsx\n│   │\n│   └── zodiac/                   # Zodiac 专属组件\n│       ├── NatalChart.tsx\n│       ├── PlanetPositions.tsx\n│       ├── TransitOverlay.tsx\n│       └── ZodiacThemeProvider.tsx\n│\n└── styles/\n    ├── globals.css               # 共享基础样式\n    ├── themes/\n    │   ├── bazi.css              # 玄金 #8B7355 + 朱砂 #C45C48\n    │   └── zodiac.css            # 星蓝 #4A5568 + 金线 #D4AF37\n    └── components/               # 组件样式\n```\n\n### 4.2 Middleware 子域名路由\n\n```typescript\n// apps/web/src/middleware.ts\nimport { NextRequest, NextResponse } from 'next/server';\n\nconst SKILL_DOMAINS: Record<string, string> = {\n  'bazi': 'bazi',\n  'zodiac': 'zodiac',\n  'mbti': 'mbti',\n  'career': 'career',\n  'www': 'www',\n};\n\nexport function middleware(request: NextRequest) {\n  const hostname = request.headers.get('host') || '';\n  const subdomain = hostname.split('.')[0];\n\n  // 识别 skill\n  const skill = SKILL_DOMAINS[subdomain] || 'bazi';\n\n  // 设置 skill 到 Cookie 和 Header\n  const response = NextResponse.next();\n  response.cookies.set('vibelife_skill', skill, {\n    domain: '.vibelife.app',\n    path: '/',\n  });\n  response.headers.set('x-vibelife-skill', skill);\n\n  return response;\n}\n\nexport const config = {\n  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],\n};\n```\n\n### 4.3 统一顶栏组件\n\n```typescript\n// apps/web/src/components/core/GlobalNav.tsx\n'use client';\n\nimport { useSkill } from '@/providers/SkillProvider';\nimport Link from 'next/link';\n\nconst SKILL_LINKS = [\n  { skill: 'bazi', label: '八字', href: 'https://bazi.vibelife.app' },\n  { skill: 'zodiac', label: '星座', href: 'https://zodiac.vibelife.app' },\n  { skill: 'mbti', label: 'MBTI', href: 'https://mbti.vibelife.app', disabled: true },\n];\n\nexport function GlobalNav() {\n  const { skill: currentSkill } = useSkill();\n\n  return (\n    <nav className=\"h-12 border-b border-vellum-200 bg-vellum/80 backdrop-blur\">\n      <div className=\"flex items-center justify-between px-4 h-full\">\n        {/* Logo */}\n        <Link href=\"https://www.vibelife.app\" className=\"flex items-center gap-2\">\n          <span className=\"text-lg font-serif text-ink\">VibeLife</span>\n        </Link>\n\n        {/* Skill 导航 */}\n        <div className=\"flex items-center gap-4\">\n          {SKILL_LINKS.map(({ skill, label, href, disabled }) => (\n            <a\n              key={skill}\n              href={disabled ? undefined : href}\n              className={`\n                text-sm transition-colors\n                ${currentSkill === skill\n                  ? 'text-ink font-medium'\n                  : 'text-ink/60 hover:text-ink'}\n                ${disabled ? 'opacity-40 cursor-not-allowed' : ''}\n              `}\n            >\n              {label}\n            </a>\n          ))}\n        </div>\n\n        {/* 用户菜单 */}\n        <UserMenu />\n      </div>\n    </nav>\n  );\n}\n```\n\n---\n\n## 5. 后端服务架构\n\n### 5.1 服务共享模型\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        API Gateway                               │\n│                   api.vibelife.app                              │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│   所有子域名共享同一个后端 API                                    │\n│                                                                 │\n│   bazi.vibelife.app  ─┐                                        │\n│                       │                                         │\n│   zodiac.vibelife.app ├──▶  api.vibelife.app                   │\n│                       │                                         │\n│   mbti.vibelife.app  ─┘                                        │\n│                                                                 │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│   API 路由                                                      │\n│   ─────────────────────────────────────────────────────────     │\n│                                                                 │\n│   POST /api/v1/chat/stream                                      │\n│        Body: { skill: \"bazi\", message: \"...\" }                  │\n│                                                                 │\n│   POST /api/v1/report/generate                                  │\n│        Body: { skill: \"zodiac\", level: \"full\" }                 │\n│                                                                 │\n│   GET /api/v1/user/subscriptions                                │\n│        Response: [                                              │\n│          { skill: \"bazi\", tier: \"pro\", expires_at: \"...\" },     │\n│          { skill: \"zodiac\", tier: \"free\" }                      │\n│        ]                                                        │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### 5.2 订阅验证中间件\n\n```python\n# apps/api/middleware/subscription.py\nfrom functools import wraps\nfrom fastapi import HTTPException, Request\n\ndef require_subscription(skill: str, min_tier: str = \"pro\"):\n    \"\"\"检查用户是否有指定 Skill 的订阅\"\"\"\n    def decorator(func):\n        @wraps(func)\n        async def wrapper(request: Request, *args, **kwargs):\n            user_id = request.state.user_id\n\n            # 检查订阅\n            subscription = await get_user_subscription(user_id, skill)\n\n            if not subscription or subscription.tier < min_tier:\n                raise HTTPException(\n                    status_code=402,\n                    detail={\n                        \"error\": \"subscription_required\",\n                        \"skill\": skill,\n                        \"required_tier\": min_tier,\n                        \"current_tier\": subscription.tier if subscription else \"free\"\n                    }\n                )\n\n            return await func(request, *args, **kwargs)\n        return wrapper\n    return decorator\n\n# 使用示例\n@router.post(\"/report/generate\")\n@require_subscription(skill_from_body=True, min_tier=\"pro\")\nasync def generate_report(request: ReportRequest):\n    ...\n```\n\n### 5.3 定价配置\n\n> **定价策略**：Phase 1 定价待定，系统先支持差异化定价能力。以下为示例配置。\n\n```python\n# apps/api/config/pricing.py\nfrom typing import Dict\nfrom dataclasses import dataclass\n\n@dataclass\nclass SkillPricing:\n    skill: str\n    tiers: Dict[str, int]  # tier -> price_cents\n\n# Phase 1: 定价待定，系统支持差异化定价\n# 以下为示例配置，上线前确认具体价格\nSKILL_PRICING = {\n    \"bazi\": SkillPricing(\n        skill=\"bazi\",\n        tiers={\n            \"free\": 0,\n            \"pro\": 1990,      # ¥19.9/月（待定）\n            \"premium\": 2990,  # ¥29.9/月（预留）\n        }\n    ),\n    \"zodiac\": SkillPricing(\n        skill=\"zodiac\",\n        tiers={\n            \"free\": 0,\n            \"pro\": 1990,      # ¥19.9/月（待定）\n            \"premium\": 2990,\n        }\n    ),\n}\n\n# Phase 2: 全家桶套餐\nBUNDLE_PRICING = {\n    \"all_access\": {\n        \"monthly\": 4990,   # ¥49.9/月\n        \"yearly\": 39900,   # ¥399/年\n    }\n}\n```\n\n---\n\n## 6. 支付与收费架构\n\n### 6.1 支付服务商策略\n\n> **核心决策**：网站部署海外，仅海外主体，采用 **Stripe 为主 + Airwallex 补充** 的双轨支付架构。\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        支付架构总览                              │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│   用户地区识别                                                   │\n│        │                                                        │\n│        ├─── 海外用户 ──────────────────────┐                    │\n│        │                                   │                    │\n│        │    ┌─────────────────────────┐    │                    │\n│        │    │       Stripe            │    │                    │\n│        │    │                         │    │                    │\n│        │    │  • Credit Card          │    │                    │\n│        │    │  • Apple Pay            │    │                    │\n│        │    │  • Google Pay           │    │                    │\n│        │    │  • PayPal (via Stripe)  │    │                    │\n│        │    └─────────────────────────┘    │                    │\n│        │                                   │                    │\n│        └─── 国内用户 ──────────────────────┤                    │\n│                                            │                    │\n│             ┌─────────────────────────┐    │                    │\n│             │      Airwallex          │    │                    │\n│             │    (跨境收单)            │    │                    │\n│             │                         │    │                    │\n│             │  • 微信支付 (WeChat Pay) │    │                    │\n│             │  • 支付宝 (Alipay)       │    │                    │\n│             └─────────────────────────┘    │                    │\n│                                            │                    │\n│                                            ▼                    │\n│                              ┌─────────────────────────┐        │\n│                              │     海外银行账户         │        │\n│                              │   (统一结算)            │        │\n│                              └─────────────────────────┘        │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### 6.2 Stripe vs Airwallex 对比\n\n| 维度 | Stripe | Airwallex |\n|------|--------|-----------|\n| **海外信用卡** | ✅ 最佳体验 | ✅ 支持 |\n| **Apple Pay / Google Pay** | ✅ 原生支持 | ⚠️ 有限支持 |\n| **微信支付 (跨境)** | ⚠️ 需中国实体 | ✅ 海外主体可用 |\n| **支付宝 (跨境)** | ⚠️ 需中国实体 | ✅ 海外主体可用 |\n| **订阅管理** | ✅ Stripe Billing 强大 | ⚠️ 需自建 |\n| **费率 (海外)** | 2.9% + $0.30 | 2.5% + $0.30 |\n| **费率 (国内)** | N/A | 3.5% + ¥0.50 |\n| **适用场景** | 海外用户为主 | 国内用户跨境收款 |\n\n### 6.3 双轨支付技术实现\n\n```python\n# apps/api/services/billing/payment_router.py\nfrom enum import Enum\nfrom typing import Optional\n\nclass PaymentProvider(Enum):\n    STRIPE = \"stripe\"\n    AIRWALLEX = \"airwallex\"\n\nclass PaymentRouter:\n    \"\"\"根据用户地区和支付方式路由到对应支付服务商\"\"\"\n\n    def get_provider(\n        self,\n        user_region: str,\n        payment_method: str\n    ) -> PaymentProvider:\n        # 国内用户 + 微信/支付宝 → Airwallex\n        if user_region == \"CN\" and payment_method in [\"wechat_pay\", \"alipay\"]:\n            return PaymentProvider.AIRWALLEX\n\n        # 其他情况 → Stripe\n        return PaymentProvider.STRIPE\n\n    async def create_checkout_session(\n        self,\n        user_id: str,\n        product_type: str,  # 'subscription' | 'one_time' | 'addon'\n        product_id: str,\n        currency: str,\n        user_region: str,\n        payment_method: Optional[str] = None\n    ):\n        provider = self.get_provider(user_region, payment_method)\n\n        if provider == PaymentProvider.STRIPE:\n            return await self.stripe_service.create_session(...)\n        else:\n            return await self.airwallex_service.create_session(...)\n```\n\n### 6.4 双币种定价策略\n\n```python\n# apps/api/config/pricing.py\nfrom dataclasses import dataclass\nfrom typing import Dict\n\n@dataclass\nclass MultiCurrencyPrice:\n    cny: int  # 人民币（分）\n    usd: int  # 美元（美分）\n\n# 订阅定价（双币种）\nSUBSCRIPTION_PRICING = {\n    \"bazi\": {\n        \"pro\": {\n            \"monthly\": MultiCurrencyPrice(cny=1990, usd=299),   # ¥19.9 / $2.99\n            \"yearly\": MultiCurrencyPrice(cny=15900, usd=2399),  # ¥159 / $23.99\n        }\n    },\n    \"zodiac\": {\n        \"pro\": {\n            \"monthly\": MultiCurrencyPrice(cny=1990, usd=299),\n            \"yearly\": MultiCurrencyPrice(cny=15900, usd=2399),\n        }\n    },\n}\n\n# 单次购买定价\nONE_TIME_PRICING = {\n    \"full_report\": MultiCurrencyPrice(cny=1990, usd=299),      # ¥19.9 / $2.99\n    \"ai_portrait\": MultiCurrencyPrice(cny=990, usd=149),       # ¥9.9 / $1.49\n    \"relationship_report\": MultiCurrencyPrice(cny=1990, usd=299),\n}\n\n# 增值服务定价\nADDON_PRICING = {\n    \"ai_art_report\": MultiCurrencyPrice(cny=990, usd=149),     # AI 生图报告\n    \"deep_analysis\": MultiCurrencyPrice(cny=1990, usd=299),    # 深度分析\n    \"extra_chat_quota\": MultiCurrencyPrice(cny=590, usd=99),   # 额外对话额度\n}\n\n# Phase 2: 全家桶套餐\nBUNDLE_PRICING = {\n    \"all_access\": {\n        \"monthly\": MultiCurrencyPrice(cny=4990, usd=699),      # ¥49.9 / $6.99\n        \"yearly\": MultiCurrencyPrice(cny=39900, usd=5999),     # ¥399 / $59.99\n    }\n}\n\ndef get_price(price: MultiCurrencyPrice, region: str) -> tuple[int, str]:\n    \"\"\"根据用户地区返回对应币种价格\"\"\"\n    if region == \"CN\":\n        return price.cny, \"CNY\"\n    return price.usd, \"USD\"\n```\n\n### 6.5 产品类型与计费模型\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        计费模型总览                              │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│   1. 订阅 (Subscription)                                        │\n│   ─────────────────────────────────────────────────────────     │\n│   • 按 Skill 独立订阅（bazi_pro, zodiac_pro）                   │\n│   • 支持月付 / 年付（年付享折扣）                                │\n│   • Stripe Billing 管理订阅生命周期                             │\n│   • 自动续费 + 到期提醒                                         │\n│                                                                 │\n│   2. 单次购买 (One-time)                                        │\n│   ─────────────────────────────────────────────────────────     │\n│   • 完整报告套餐                                                │\n│   • AI 生图报告                                                 │\n│   • 关系分析报告                                                │\n│   • 购买后永久有效                                              │\n│                                                                 │\n│   3. 增值服务 (Add-on)                                          │\n│   ─────────────────────────────────────────────────────────     │\n│   • 订阅用户可额外购买                                          │\n│   • AI 艺术报告（高清海报）                                     │\n│   • 深度咨询时长                                                │\n│   • 额外对话额度                                                │\n│                                                                 │\n│   4. 全家桶套餐 (Bundle) - Phase 2                              │\n│   ─────────────────────────────────────────────────────────     │\n│   • All Access：解锁所有 Skill                                  │\n│   • 月付 / 年付                                                 │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### 6.6 数据库 Schema（支付相关）\n\n```sql\n-- 订阅表（按 Skill 独立）\nCREATE TABLE subscriptions (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    skill TEXT NOT NULL,  -- 'bazi', 'zodiac', 'mbti', 'career'\n    tier TEXT NOT NULL DEFAULT 'free',\n    billing_cycle TEXT,  -- 'monthly', 'yearly'\n    currency TEXT NOT NULL,  -- 'CNY', 'USD'\n    price_cents INT,\n    status TEXT NOT NULL DEFAULT 'active',\n    payment_provider TEXT,  -- 'stripe', 'airwallex'\n    provider_subscription_id TEXT,  -- Stripe/Airwallex 订阅 ID\n    starts_at TIMESTAMPTZ DEFAULT NOW(),\n    current_period_start TIMESTAMPTZ,\n    current_period_end TIMESTAMPTZ,\n    cancel_at_period_end BOOLEAN DEFAULT FALSE,\n    canceled_at TIMESTAMPTZ,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW(),\n    UNIQUE(user_id, skill)\n);\n\n-- 单次购买记录\nCREATE TABLE purchases (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    product_type TEXT NOT NULL,  -- 'report', 'ai_portrait', 'relationship'\n    product_id TEXT,  -- 关联的报告/产品 ID\n    skill TEXT,\n    currency TEXT NOT NULL,\n    amount_cents INT NOT NULL,\n    payment_provider TEXT,\n    provider_payment_id TEXT,\n    status TEXT NOT NULL DEFAULT 'pending',\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    completed_at TIMESTAMPTZ\n);\n\n-- 增值服务购买记录\nCREATE TABLE addon_purchases (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    addon_type TEXT NOT NULL,  -- 'ai_art_report', 'deep_analysis', 'extra_chat_quota'\n    skill TEXT,\n    currency TEXT NOT NULL,\n    amount_cents INT NOT NULL,\n    quantity INT DEFAULT 1,\n    payment_provider TEXT,\n    provider_payment_id TEXT,\n    status TEXT NOT NULL,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    expires_at TIMESTAMPTZ  -- 部分增值服务有有效期\n);\n\n-- 支付事件日志（对账用）\nCREATE TABLE payment_events (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    user_id UUID REFERENCES users(id),\n    event_type TEXT NOT NULL,  -- 'checkout.completed', 'subscription.renewed', etc.\n    payment_provider TEXT NOT NULL,\n    provider_event_id TEXT,\n    payload JSONB,\n    created_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- 索引\nCREATE INDEX idx_subscriptions_user ON subscriptions(user_id);\nCREATE INDEX idx_subscriptions_provider ON subscriptions(payment_provider, provider_subscription_id);\nCREATE INDEX idx_purchases_user ON purchases(user_id);\nCREATE INDEX idx_payment_events_provider ON payment_events(payment_provider, provider_event_id);\n```\n\n### 6.7 Webhook 处理\n\n```python\n# apps/api/routes/webhooks.py\nfrom fastapi import APIRouter, Request, HTTPException\nimport stripe\nfrom services.billing import SubscriptionService, PurchaseService\n\nrouter = APIRouter()\n\n# Stripe Webhook\n@router.post(\"/webhooks/stripe\")\nasync def stripe_webhook(request: Request):\n    payload = await request.body()\n    sig_header = request.headers.get(\"stripe-signature\")\n\n    try:\n        event = stripe.Webhook.construct_event(\n            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET\n        )\n    except ValueError:\n        raise HTTPException(status_code=400, detail=\"Invalid payload\")\n    except stripe.error.SignatureVerificationError:\n        raise HTTPException(status_code=400, detail=\"Invalid signature\")\n\n    # 处理事件\n    if event[\"type\"] == \"checkout.session.completed\":\n        await handle_checkout_completed(event[\"data\"][\"object\"])\n    elif event[\"type\"] == \"customer.subscription.updated\":\n        await handle_subscription_updated(event[\"data\"][\"object\"])\n    elif event[\"type\"] == \"customer.subscription.deleted\":\n        await handle_subscription_canceled(event[\"data\"][\"object\"])\n    elif event[\"type\"] == \"invoice.payment_failed\":\n        await handle_payment_failed(event[\"data\"][\"object\"])\n\n    return {\"status\": \"ok\"}\n\n# Airwallex Webhook\n@router.post(\"/webhooks/airwallex\")\nasync def airwallex_webhook(request: Request):\n    payload = await request.json()\n    signature = request.headers.get(\"x-signature\")\n\n    # 验证签名\n    if not verify_airwallex_signature(payload, signature):\n        raise HTTPException(status_code=400, detail=\"Invalid signature\")\n\n    event_type = payload.get(\"name\")\n\n    if event_type == \"payment_intent.succeeded\":\n        await handle_airwallex_payment_success(payload[\"data\"][\"object\"])\n    elif event_type == \"payment_intent.payment_failed\":\n        await handle_airwallex_payment_failed(payload[\"data\"][\"object\"])\n\n    return {\"status\": \"ok\"}\n```\n\n### 6.8 前端支付流程\n\n```typescript\n// apps/web/src/lib/checkout.ts\nimport { loadStripe } from '@stripe/stripe-js';\n\nconst stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_KEY!);\n\ninterface CheckoutParams {\n  productType: 'subscription' | 'one_time' | 'addon';\n  productId: string;\n  skill?: string;\n}\n\nexport async function initiateCheckout(params: CheckoutParams) {\n  // 1. 获取用户地区\n  const region = await detectUserRegion();\n\n  // 2. 调用后端创建 checkout session\n  const response = await fetch('/api/v1/billing/checkout', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({\n      ...params,\n      region,\n    }),\n  });\n\n  const { provider, sessionId, redirectUrl } = await response.json();\n\n  // 3. 根据支付服务商跳转\n  if (provider === 'stripe') {\n    const stripe = await stripePromise;\n    await stripe?.redirectToCheckout({ sessionId });\n  } else if (provider === 'airwallex') {\n    // Airwallex 跳转到支付页面\n    window.location.href = redirectUrl;\n  }\n}\n\n// 用户地区检测\nasync function detectUserRegion(): Promise<string> {\n  // 优先使用用户设置\n  const savedRegion = localStorage.getItem('user_region');\n  if (savedRegion) return savedRegion;\n\n  // 其次使用 IP 地理位置\n  try {\n    const response = await fetch('https://ipapi.co/json/');\n    const data = await response.json();\n    return data.country_code;\n  } catch {\n    return 'US'; // 默认海外\n  }\n}\n```\n\n---\n\n## 7. 数据共享策略\n\n### 7.1 共享数据范围\n\n| 数据类型 | 共享级别 | 说明 |\n|----------|----------|------|\n| **基础信息** | ✅ 全局共享 | birth_datetime, birth_location, gender, name |\n| **生活上下文** | ✅ 全局共享 | career, relationship, life_stage, recent_events |\n| **AI 洞察** | ✅ 全局共享 | personality_traits, communication_style, emotional_patterns |\n| **Identity Prism** | ✅ 全局共享 | core, inner, outer 三元身份 |\n| **对话历史** | ❌ Skill 独立 | 各 Skill 对话分开存储 |\n| **报告记录** | ❌ Skill 独立 | 各 Skill 报告分开存储 |\n| **订阅状态** | ❌ Skill 独立 | 各 Skill 独立收费 |\n\n### 7.2 跨 Skill 数据利用\n\n```python\n# 用户在 bazi 积累的画像可在 zodiac 使用\nasync def build_context(user_id: str, skill: str):\n    # 1. 加载共享 Profile（所有 Skill 贡献的数据）\n    shared_profile = await get_shared_profile(user_id)\n\n    # 2. 加载 Skill 专属数据\n    skill_data = await get_skill_data(user_id, skill)\n\n    # 3. 构建上下文\n    context = {\n        \"shared\": {\n            \"basic\": shared_profile.basic,\n            \"life_context\": shared_profile.life_context,\n            \"ai_insights\": shared_profile.ai_insights,\n            \"identity_prism\": shared_profile.identity_prism,\n        },\n        \"skill_specific\": skill_data,\n    }\n\n    return context\n```\n\n---\n\n## 8. 部署架构\n\n### 8.1 Vercel 多域名部署\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                        Vercel Project                            │\n│                      vibelife-web                                │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│   Domains:                                                      │\n│   ├── www.vibelife.app      (Primary)                          │\n│   ├── bazi.vibelife.app     (Alias)                            │\n│   ├── zodiac.vibelife.app   (Alias)                            │\n│   └── *.vibelife.app        (Wildcard)                         │\n│                                                                 │\n│   Environment Variables:                                        │\n│   ├── NEXT_PUBLIC_API_URL=https://api.vibelife.app             │\n│   ├── NEXT_PUBLIC_COOKIE_DOMAIN=.vibelife.app                  │\n│   └── NEXT_PUBLIC_DEFAULT_SKILL=bazi                           │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n### 8.2 本地开发配置\n\n```bash\n# /etc/hosts (本地开发)\n127.0.0.1 www.vibelife.local\n127.0.0.1 bazi.vibelife.local\n127.0.0.1 zodiac.vibelife.local\n```\n\n```env\n# .env.local\nNEXT_PUBLIC_API_URL=http://localhost:8000\nNEXT_PUBLIC_COOKIE_DOMAIN=.vibelife.local\n```\n\n---\n\n## 9. 实施路线图\n\n### Phase 1 (当前)\n\n- [x] 子域名架构设计\n- [x] 支付架构设计（Stripe + Airwallex 双轨）\n- [ ] middleware.ts 子域名路由完善\n- [ ] (www)/ (bazi)/ (zodiac)/ 路由组创建\n- [ ] 统一顶栏 GlobalNav 实现\n- [ ] SSO Cookie 跨域配置\n- [ ] 订阅表 Schema 扩展（支持多币种、多支付商）\n- [ ] Stripe 集成（海外信用卡、订阅管理）\n- [ ] Airwallex 集成（国内微信/支付宝跨境收单）\n- [ ] 双币种定价系统\n- [ ] Webhook 处理（Stripe + Airwallex）\n\n### Phase 2\n\n- [ ] 全家桶套餐（All Access）\n- [ ] MBTI Skill 上线\n- [ ] 增值服务商店\n- [ ] 跨 Skill 数据分析\n- [ ] 订阅用户留存优化\n\n### Phase 3\n\n- [ ] 主 App (app.vibelife.app) 开发\n- [ ] 子域名转为落地页\n- [ ] 原生 App 开发\n\n---\n\n## 10. 关键文件清单\n\n### 前端\n\n| 文件 | 作用 |\n|------|------|\n| `apps/web/src/middleware.ts` | 子域名路由 |\n| `apps/web/src/providers/SkillProvider.tsx` | Skill 上下文 |\n| `apps/web/src/components/core/GlobalNav.tsx` | 统一顶栏 |\n| `apps/web/src/app/(www)/layout.tsx` | 主站布局 |\n| `apps/web/src/app/(bazi)/layout.tsx` | Bazi 专属布局 |\n| `apps/web/src/app/(zodiac)/layout.tsx` | Zodiac 专属布局 |\n| `apps/web/src/lib/checkout.ts` | 支付流程 |\n| `vercel.json` | 部署配置 |\n\n### 后端\n\n| 文件 | 作用 |\n|------|------|\n| `apps/api/services/billing/payment_router.py` | 支付路由（Stripe/Airwallex） |\n| `apps/api/services/billing/stripe_service.py` | Stripe 服务 |\n| `apps/api/services/billing/airwallex_service.py` | Airwallex 服务 |\n| `apps/api/config/pricing.py` | 定价配置（双币种） |\n| `apps/api/middleware/subscription.py` | 订阅验证 |\n| `apps/api/routes/webhooks.py` | Webhook 处理 |\n| `apps/api/routes/billing.py` | 计费 API |\n\n### 数据库\n\n| 文件 | 作用 |\n|------|------|\n| `migrations/002_subscriptions.sql` | 订阅表 Schema |\n| `migrations/003_purchases.sql` | 单次购买表 |\n| `migrations/004_addon_purchases.sql` | 增值服务表 |\n| `migrations/005_payment_events.sql` | 支付事件日志 |\n","numLines":1040,"startLine":1,"totalLines":1040}}}
{"parentUuid":"dde14e84-6a14-47a1-97c8-aa6d788d8306","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work","sessionId":"8175f293-0999-4f0d-9e9a-649dd3125b58","version":"2.0.74","gitBranch":"","agentId":"ae0ddd3","slug":"hazy-gathering-owl","message":{"model":"claude-haiku-4-5-20251001","id":"msg_0151NPWa48ja6AahX9vCacSA","type":"message","role":"assistant","content":[{"type":"text","text":"完成了！我已经深入阅读了所有4个文档。以下是全面的总结：\n\n---\n\n## 📋 文件清单\n\n目录下共有4个文档：\n1. `/home/aiscend/work/vibelife/docs/archive/v3/implementation-status-analysis.md` (14.8 KB)\n2. `/home/aiscend/work/vibelife/docs/archive/v3/chat-flow.md` (28.5 KB)\n3. `/home/aiscend/work/vibelife/docs/archive/v3/architecture-decisions.md` (16.4 KB)\n4. `/home/aiscend/work/vibelife/docs/archive/v3/matrix-strategy-architecture.md` (43.3 KB)\n\n---\n\n## 1. 当前实现状态\n\n### 整体完成度\n\n| 模块 | 状态 | 完成度 |\n|------|------|--------|\n| Vibe Engine | ✅ 完整实现 | 100% |\n| 访谈系统 | ✅ 完整实现 | 100% |\n| 报告生成 | ✅ 核心完成 | 85% |\n| Identity Prism | ✅ 完整实现 | 100% |\n| 人生 K-Line | ✅ 完整实现 | 95% |\n| Daily Greeting | ✅ 完整实现 | 100% |\n| 关系模拟器 | ✅ 完整实现 | 100% |\n| 知识库 | ✅ 已建立 | 100% |\n| 前端页面 | ✅ 基本完成 | 85% |\n| **支付系统** | ⚠️ 骨架阶段 | **30%** |\n\n### 核心差距\n\n1. **数据库持久化** - 部分 API 使用模拟数据\n2. **支付系统集成** - Stripe webhook 等待完成\n3. **前端细节** - 报告展示、付费流程 UI 需打磨\n\n---\n\n## 2. 前端页面设计相关\n\n### 当前活跃页面\n\n```\n/                          → 首页/登陆页\n/chat                      → 主聊天页面（三栏布局）\n/auth/login                → 登录页\n/auth/register             → 注册页\n/auth/sso-callback         → SSO 回调页\n```\n\n### 存档页面（待迁移）\n\n```\n/bazi, /bazi/chat\n/zodiac, /zodiac/chat\n/mbti, /mbti/chat\n```\n\n### 推荐架构：子域名 + 路由组隔离\n\n**核心决策**：采用 `(www)/`、`(bazi)/`、`(zodiac)/` 路由组物理隔离，每个 skill 有独立的：\n- Layout 文件（玄金/星蓝主题）\n- 首页、聊天、命盘、报告页面\n- 专属组件（BaziChart、NatalChart 等）\n- 专属主题样式\n\n**代码组织**：\n```\napps/web/src/\n├── app/\n│   ├── (www)/              # 品牌索引页\n│   ├── (bazi)/             # Bazi 专属路由\n│   │   ├── layout.tsx      # 玄金配色\n│   │   ├── page.tsx        # 首页\n│   │   ├── chat/page.tsx\n│   │   ├── chart/page.tsx\n│   │   └── report/page.tsx\n│   ├── (zodiac)/           # Zodiac 专属路由\n│   │   ├── layout.tsx      # 星蓝配色\n│   │   └── ...\n│   └── (shared)/           # 认证、个人中心\n├── components/\n│   ├── core/               # 共享：LuminousPaper、BreathAura、InsightCard\n│   ├── chat/               # 共享：ChatContainer、ChatMessage、ChatInput\n│   ├── bazi/               # Bazi 专属：BaziChart、WuxingDisplay、DayunTimeline\n│   └── zodiac/             # Zodiac 专属：NatalChart、PlanetPositions\n└── styles/\n    ├── bazi-theme.css      # 玄金 #8B7355 + 朱砂 #C45C48\n    └── zodiac-theme.css    # 星蓝 #4A5568 + 金线 #D4AF37\n```\n\n### 部署配置 (vercel.json)\n\n```json\n{\n  \"rewrites\": [\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"bazi.vibelife.app\" }],\n      \"destination\": \"/bazi/:path*\"\n    },\n    {\n      \"source\": \"/:path*\",\n      \"has\": [{ \"type\": \"host\", \"value\": \"zodiac.vibelife.app\" }],\n      \"destination\": \"/zodiac/:path*\"\n    }\n  ]\n}\n```\n\n---\n\n## 3. 已知问题和待优化点\n\n### Critical（必须修复）\n\n| # | 问题 | 位置 | 影响 |\n|---|------|------|------|\n| 1 | **API 字段不匹配** | 前端 `skill_id` vs 后端 `skill` | API 调用 400 错误 |\n| 2 | **用户上下文缺失** | chat.py:164 | 所有用户共享默认 profile |\n| 3 | **Mock 支付暴露** | payment.py `/mock-pay` | 任何人可标记支付完成 |\n| 4 | **支付数据内存存储** | payment.py 内存字典 | 重启丢失支付状态 |\n\n### High（Phase 1 需修复）\n\n| # | 问题 | 位置 | 影响 |\n|---|------|------|------|\n| 5 | **voice_mode 未传递** | ChatContainer.tsx | 用户切换无效 |\n| 6 | **流式未使用** | ChatContainer.tsx | 长响应体验差 |\n| 7 | **报告持久化 stub** | report.py | 报告无法保存/检索 |\n| 8 | **会话列表 stub** | chat.py | 用户无法查看历史会话 |\n| 9 | **RAG 未启用** | context.py | knowledge_chunks 参数未使用 |\n\n### Medium（Phase 2 可修复）\n\n| # | 问题 | 位置 |\n|---|------|------|\n| 10 | Token 刷新竞态 | api.ts |\n| 11 | 错误处理不一致 | 所有 routes |\n| 12 | Profile 大小无限制 | portrait.py |\n| 13 | deep_merge 重复代码 | portrait.py + profile_repo.py |\n\n---\n\n## 4. 聊天流程关键点\n\n### 完整数据流转\n\n```\n用户输入 → ChatContainer.handleSend() \n  ↓\nPOST /api/v1/chat/ (skill_id, message, conversation_id)\n  ↓\n后端路由 (parse_skill, get_user_profile, get_conversation_history)\n  ↓\nVibe Engine (ContextBuilder.build_system_prompt + LLMService.chat)\n  ↓\nLLM 调用 (Zhipu GLM-4-Plus → Claude Sonnet fallback)\n  ↓\n保存消息 + 返回 ChatResponse\n  ↓\n前端更新 messages 状态 + 渲染气泡\n```\n\n### 关键代码位置\n\n| 层级 | 文件 | 功能 |\n|------|------|------|\n| 前端容器 | `ChatContainer.tsx:224-299` | 消息状态管理、API 调用 |\n| API 客户端 | `api.ts:208-220` | sendMessage 函数 |\n| 后端路由 | `routes/chat.py:220-273` | `/chat/` 端点处理 |\n| 上下文构建 | `vibe_engine/context.py:342-394` | system prompt 和话题分类 |\n| LLM 调用 | `vibe_engine/llm.py:304-370` | 多 LLM 支持和降级 |\n\n### 话题分类规则\n\n- **CAREER**: 工作、职业、事业、创业、面试\n- **RELATIONSHIP**: 感情、恋爱、婚姻、家人\n- **FORTUNE**: 运势、大运、流年、什么时候\n- **SELF**: 性格、优点、缺点、了解自己\n- **GENERAL**: 默认分类\n\n---\n\n## 5. 矩阵战略架构（Phase 1-3）\n\n### 域名规划\n\n```\nwww.vibelife.app          ← 品牌索引页（Phase 1）\nbazi.vibelife.app         ← 八字命理（P1 上线）\nzodiac.vibelife.app       ← 星座占星（P1 上线）\nmbti.vibelife.app         ← MBTI 人格（P2 规划）\ncareer.vibelife.app       ← 职业发展（P2 规划）\napp.vibelife.app          ← 主 App（Phase 3）\n```\n\n### 账户架构：共享注册 + 独立收费\n\n```\n全局共享数据：\n  ├── 基础信息（出生时间、地点、性别、名字）\n  ├── 生活上下文（职业、感情、生活阶段）\n  ├── AI 洞察（性格特点、沟通风格、成长方向）\n  └── Identity Prism（核心/内在/外在）\n\nSkill 独立数据：\n  ├── 对话历史（各 Skill 分开存储）\n  ├── 报告记录（各 Skill 分开存储）\n  └── 订阅状态（各 Skill 独立收费）\n```\n\n### 支付架构：Stripe + Airwallex 双轨\n\n**海外用户** → Stripe（信用卡、Apple Pay、Google Pay）\n**国内用户** → Airwallex 跨境收单（微信支付、支付宝）\n\n**定价模型**：\n- **订阅**：按 Skill 独立（月付/年付）\n- **单次购买**：完整报告、AI 生图\n- **增值服务**：AI 艺术报告、深度分析、额外额度\n- **全家桶**（Phase 2）：All Access 套餐\n\n**双币种**：\n- CNY: ¥19.9/月（订阅）\n- USD: $2.99/月（订阅）\n\n---\n\n## 6. Phase 1 实施优先级\n\n### Week 1：基础架构\n- [ ] 修复 skill_id → skill 字段映射\n- [ ] 集成 Clerk 认证\n- [ ] 后端 SSE 格式适配 AI SDK 6\n- [ ] 前端 useChat hook 集成\n\n### Week 2：核心功能\n- [ ] voice_mode 完整链路修复\n- [ ] RAG 知识库启用\n- [ ] 访谈流程前端集成\n- [ ] 用户 profile 持久化\n\n### Week 3：子域名 + 支付\n- [ ] 路由组重构（(bazi)/(zodiac)/）\n- [ ] middleware.ts 子域名路由\n- [ ] Stripe 集成（海外信用卡、订阅）\n- [ ] Airwallex 集成（国内微信/支付宝）\n\n### Week 4：报告 + 打磨\n- [ ] 报告持久化完成\n- [ ] lite/full 报告流程\n- [ ] Generative UI 动态卡片\n- [ ] 中英双语切换\n\n---\n\n## 7. 技术栈确认\n\n**前端**：Next.js 14 + Vercel AI SDK 6 + TypeScript + Tailwind CSS\n**后端**：Python 3.11 + FastAPI + asyncpg\n**数据库**：PostgreSQL（Supabase/Railway）\n**认证**：Clerk\n**支付**：Stripe + Airwallex\n**LLM**：Zhipu GLM-4-Plus（主）+ Claude Sonnet（备用）\n\n---\n\n## 总结\n\n✅ **核心引擎完备**：Vibe Engine、Portrait、Knowledge 全部就绪\n✅ **功能覆盖率高**：Spec v3.0 P0 功能约85%完成\n⚠️ **待补完**：数据持久化、支付系统、前端细节\n\n**最佳实践**：采用子域名 + 路由组隔离架构，支持 Clerk 认证、共享 SSO 和独立订阅，实现矩阵级产品拓展能力。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":6,"cache_creation_input_tokens":36679,"cache_read_input_tokens":20515,"cache_creation":{"ephemeral_5m_input_tokens":36679,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWsq2tK9DMBU9rBm7ocP8","type":"assistant","uuid":"7b91271f-f729-4a80-a2b1-c335b5264c5f","timestamp":"2026-01-07T10:05:25.528Z"}
