     1→"use client"
     2→
     3→import { cn } from "@/lib/utils"
     4→import type { Block, TaskBlock, ToggleBlock, DiffBlock, ActionButtonsBlock, MarkdownTextBlock, ActionButton } from "@/types"
     5→import { ChevronDown, ChevronRight, Check, Clock, AlertCircle, Play, Calendar, ExternalLink, X, Heart, Lightbulb } from "lucide-react"
     6→import { useState } from "react"
     7→
     8→interface BlockRendererProps {
     9→  block: Block
    10→  onAction?: (action: ActionButton["action"]) => void
    11→}
    12→
    13→function getCookie(name: string): string {
    14→  if (typeof document === "undefined") return ""
    15→  const match = document.cookie.match(
    16→    new RegExp(`(?:^|; )${name.replace(/[-.]/g, "\\$&")}=([^;]*)`)
    17→  )
    18→  return match ? decodeURIComponent(match[1]) : ""
    19→}
    20→
    21→function csrfHeaders(): Record<string, string> {
    22→  const csrf = getCookie("fortune_csrf")
    23→  return csrf ? { "X-CSRF-Token": csrf } : {}
    24→}
    25→
    26→export function BlockRenderer({ block, onAction }: BlockRendererProps) {
    27→  switch (block.type) {
    28→    case "callout":
    29→      return <CalloutBlock block={block} />
    30→    case "toggle":
    31→      return <ToggleBlockComponent block={block as ToggleBlock} />
    32→    case "task":
    33→      return <TaskBlockComponent block={block as TaskBlock} />
    34→    case "diff":
    35→      return <DiffBlockComponent block={block as DiffBlock} />
    36→    case "action_buttons":
    37→      return <ActionButtonsBlockComponent block={block as ActionButtonsBlock} onAction={onAction} />
    38→    case "markdown_text":
    39→      return <MarkdownTextBlockComponent block={block as MarkdownTextBlock} />
    40→    default:
    41→      return <TextBlock block={block} />
    42→  }
    43→}
    44→
    45→// Callout Block - 一句话结论
    46→function CalloutBlock({ block }: { block: Block }) {
    47→  return (
    48→    <div
    49→      className={cn(
    50→        "flex items-start gap-3 p-4 rounded-lg",
    51→        "bg-advice border-l-4 border-advice-foreground"
    52→      )}
    53→    >
    54→      <div className="flex-shrink-0 w-6 h-6 rounded-full bg-advice-foreground/10 flex items-center justify-center">
    55→        <Lightbulb className="w-4 h-4 text-advice-foreground" />
    56→      </div>
    57→      <p className="text-foreground font-medium">{block.content}</p>
    58→    </div>
    59→  )
    60→}
    61→
    62→// Toggle Block - 原因与证据 (默认折叠)
    63→function ToggleBlockComponent({ block }: { block: ToggleBlock }) {
    64→  const [isOpen, setIsOpen] = useState(block.isOpen ?? false)
    65→
    66→  return (
    67→    <div className="border border-border rounded-lg overflow-hidden">
    68→      <button
    69→        onClick={() => setIsOpen(!isOpen)}
    70→        className={cn(
    71→          "w-full flex items-center gap-2 px-4 py-3",
    72→          "text-left hover:bg-hover transition-colors"
    73→        )}
    74→      >
    75→        {isOpen ? (
    76→          <ChevronDown className="w-4 h-4 text-muted-foreground" />
    77→        ) : (
    78→          <ChevronRight className="w-4 h-4 text-muted-foreground" />
    79→        )}
    80→        <span className="font-medium text-foreground">{block.content}</span>
    81→      </button>
    82→
    83→      {isOpen && block.children && (
    84→        <div className="px-4 pb-4 pl-10 space-y-2">
    85→          {block.children.map((child) => (
    86→            <BlockRenderer key={child.id} block={child} />
    87→          ))}
    88→        </div>
    89→      )}
    90→    </div>
    91→  )
    92→}
    93→
    94→// Task Block - 下一步行动
    95→function TaskBlockComponent({ block }: { block: TaskBlock }) {
    96→  const [status, setStatus] = useState(block.status ?? "pending")
    97→
    98→  const handleComplete = () => {
    99→    setStatus("completed")
   100→    // TODO: 触发状态更新和 Pulse 动效
   101→  }
   102→
   103→  return (
   104→    <div
   105→      className={cn(
   106→        "flex items-center gap-3 p-3 rounded-lg",
   107→        "bg-sidebar border border-border",
   108→        "transition-all duration-300",
   109→        status === "completed" && "opacity-60"
   110→      )}
   111→    >
   112→      {/* 完成按钮 */}
   113→      <button
   114→        onClick={handleComplete}
   115→        disabled={status === "completed"}
   116→        className={cn(
   117→          "flex-shrink-0 w-5 h-5 rounded border-2",
   118→          "transition-colors",
   119→          status === "completed"
   120→            ? "bg-status border-status-foreground"
   121→            : "border-muted-foreground hover:border-foreground"
   122→        )}
   123→      >
   124→        {status === "completed" && (
   125→          <Check className="w-full h-full text-status-foreground p-0.5" />
   126→        )}
   127→      </button>
   128→
   129→      {/* 任务内容 */}
   130→      <span
   131→        className={cn(
   132→          "flex-1 text-foreground",
   133→          status === "completed" && "line-through"
   134→        )}
   135→      >
   136→        {block.content}
   137→      </span>
   138→
   139→      {/* 时长标签 */}
   140→      <span
   141→        className={cn(
   142→          "flex items-center gap-1 px-2 py-1 rounded-full text-xs",
   143→          "bg-hover text-muted-foreground"
   144→        )}
   145→      >
   146→        <Clock className="w-3 h-3" />
   147→        {block.duration}分钟
   148→      </span>
   149→    </div>
   150→  )
   151→}
   152→
   153→// Diff Block - 回写更新
   154→function DiffBlockComponent({ block }: { block: DiffBlock }) {
   155→  const [status, setStatus] = useState(block.status)
   156→
   157→  if (status === "applied" || status === "rejected") {
   158→    return null // 已处理的不显示
   159→  }
   160→
   161→  return (
   162→    <div
   163→      className={cn(
   164→        "p-4 rounded-lg",
   165→        "bg-alert/50 border border-alert-foreground/20"
   166→      )}
   167→    >
   168→      <div className="flex items-center gap-2 mb-3">
   169→        <AlertCircle className="w-4 h-4 text-alert-foreground" />
   170→        <span className="font-medium text-foreground">将更新</span>
   171→      </div>
   172→
   173→      {/* 变更列表 */}
   174→      <div className="space-y-2 mb-4">
   175→        {block.changes.map((change, i) => (
   176→          <div key={i} className="flex items-center gap-2 text-sm">
   177→            <span className="text-muted-foreground">{change.field}:</span>
   178→            <span className="text-foreground">
   179→              {typeof change.oldValue === "number" && typeof change.newValue === "number"
   180→                ? `${change.newValue > change.oldValue ? "+" : ""}${change.newValue - change.oldValue}`
   181→                : `${change.oldValue} → ${change.newValue}`}
   182→            </span>
   183→            <span className="text-muted-foreground">({change.reason})</span>
   184→          </div>
   185→        ))}
   186→      </div>
   187→
   188→      {/* 操作按钮 */}
   189→      <div className="flex items-center gap-2">
   190→        <button
   191→          onClick={() => setStatus("applied")}
   192→          className={cn(
   193→            "flex items-center gap-1 px-3 py-1.5 rounded-lg text-sm font-medium",
   194→            "bg-status text-status-foreground hover:opacity-90 transition-opacity"
   195→          )}
   196→        >
   197→          <Check className="w-4 h-4" />
   198→          应用更新
   199→        </button>
   200→        <button
   201→          onClick={() => setStatus("rejected")}
   202→          className={cn(
   203→            "px-3 py-1.5 rounded-lg text-sm",
   204→            "text-muted-foreground hover:text-foreground hover:bg-hover transition-colors"
   205→          )}
   206→        >
   207→          ✎ 纠正
   208→        </button>
   209→        <button
   210→          onClick={() => setStatus("paused")}
   211→          className={cn(
   212→            "px-3 py-1.5 rounded-lg text-sm",
   213→            "text-muted-foreground hover:text-foreground hover:bg-hover transition-colors"
   214→          )}
   215→        >
   216→          ⏸ 暂不更新
   217→        </button>
   218→      </div>
   219→    </div>
   220→  )
   221→}
   222→
   223→// Action Buttons Block - A2UI 操作按钮组
   224→function ActionButtonsBlockComponent({
   225→  block,
   226→  onAction,
   227→}: {
   228→  block: ActionButtonsBlock
   229→  onAction?: (action: ActionButton["action"]) => void
   230→}) {
   231→  const handleClick = async (action: ActionButton["action"]) => {
   232→    if (onAction) {
   233→      onAction(action)
   234→    } else {
   235→      // 默认处理逻辑
   236→      switch (action.type) {
   237→        case "start_task":
   238→          if (action.task_id) {
   239→            try {
   240→              const res = await fetch("/api/dashboard/task/accept", {
   241→                method: "POST",
   242→                headers: { "Content-Type": "application/json", ...csrfHeaders() },
   243→                credentials: "include",
   244→                body: JSON.stringify({
   245→                  task_id: action.task_id,
   246→                  commitment_type: "start_task",
   247→                }),
   248→              })
   249→              if (res.ok) {
   250→                window.location.reload()
   251→              }
   252→            } catch (e) {
   253→              console.error("Failed to start task:", e)
   254→            }
   255→          }
   256→          break
   257→        case "schedule_task":
   258→          if (action.task_id) {
   259→            try {
   260→              const res = await fetch("/api/dashboard/task/accept", {
   261→                method: "POST",
   262→                headers: { "Content-Type": "application/json", ...csrfHeaders() },
   263→                credentials: "include",
   264→                body: JSON.stringify({
   265→                  task_id: action.task_id,
   266→                  commitment_type: "schedule_task",
   267→                }),
   268→              })
   269→              if (res.ok) {
   270→                window.location.reload()
   271→              }
   272→            } catch (e) {
   273→              console.error("Failed to schedule task:", e)
   274→            }
   275→          }
   276→          break
   277→        case "open_panel":
   278→          // 映射 panel 名称到 Tab ID
   279→          const panelMap: Record<string, string> = {
   280→            bento: "overview",
   281→            quests: "quests",
   282→            tasks: "quests",
   283→            status: "status",
   284→            trends: "trends",
   285→            overview: "overview",
   286→            relations: "relations",
   287→            explore: "explore",
   288→          }
   289→          const tabId = panelMap[action.panel || ""] || action.panel
   290→          // 触发 Tab 切换（通过 URL 或 state）
   291→          if (typeof window !== "undefined") {
   292→            window.dispatchEvent(
   293→              new CustomEvent("switchTab", { detail: { tab: tabId } })
   294→            )
   295→          }
   296→          break
   297→        case "opt_out":
   298→          // 记录用户选择暂不执行
   299→          console.log("User opted out")
   300→          break
   301→        case "checkin":
   302→          // 打开 checkin modal
   303→          if (typeof window !== "undefined") {
   304→            window.dispatchEvent(new CustomEvent("openCheckin"))
   305→          }
   306→          break
   307→      }
   308→    }
   309→  }
   310→
   311→  const getButtonIcon = (actionType: ActionButton["action"]["type"]) => {
   312→    switch (actionType) {
   313→      case "start_task":
   314→        return <Play className="w-4 h-4" />
   315→      case "schedule_task":
   316→        return <Calendar className="w-4 h-4" />
   317→      case "open_panel":
   318→        return <ExternalLink className="w-4 h-4" />
   319→      case "opt_out":
   320→        return <X className="w-4 h-4" />
   321→      case "checkin":
   322→        return <Heart className="w-4 h-4" />
   323→      default:
   324→        return null
   325→    }
   326→  }
   327→
   328→  const getButtonStyle = (actionType: ActionButton["action"]["type"], index: number) => {
   329→    // 第一个按钮是主要按钮
   330→    if (index === 0) {
   331→      return "bg-primary text-primary-foreground hover:bg-primary/90"
   332→    }
   333→    // 其他按钮是次要按钮
   334→    return "bg-secondary text-secondary-foreground hover:bg-secondary/80"
   335→  }
   336→
   337→  return (
   338→    <div className="flex flex-wrap gap-2 mt-3">
   339→      {block.buttons.map((button, index) => (
   340→        <button
   341→          key={index}
   342→          onClick={() => handleClick(button.action)}
   343→          className={cn(
   344→            "flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium",
   345→            "transition-colors duration-200",
   346→            getButtonStyle(button.action.type, index)
   347→          )}
   348→        >
   349→          {getButtonIcon(button.action.type)}
   350→          {button.label}
   351→        </button>
   352→      ))}
   353→    </div>
   354→  )
   355→}
   356→
   357→// Markdown Text Block - A2UI 文本内容
   358→function MarkdownTextBlockComponent({ block }: { block: MarkdownTextBlock }) {
   359→  // 简单的 Markdown 解析
   360→  const renderMarkdown = (content: string) => {
   361→    // 处理标题
   362→    const lines = content.split("\n")
   363→    return lines.map((line, i) => {
   364→      if (line.startsWith("### ")) {
   365→        return (
   366→          <h3 key={i} className="text-lg font-semibold mt-4 mb-2 text-foreground">
   367→            {line.replace("### ", "")}
   368→          </h3>
   369→        )
   370→      }
   371→      if (line.startsWith("## ")) {
   372→        return (
   373→          <h2 key={i} className="text-xl font-bold mt-4 mb-2 text-foreground">
   374→            {line.replace("## ", "")}
   375→          </h2>
   376→        )
   377→      }
   378→      if (line.startsWith("# ")) {
   379→        return (
   380→          <h1 key={i} className="text-2xl font-bold mt-4 mb-2 text-foreground">
   381→            {line.replace("# ", "")}
   382→          </h1>
   383→        )
   384→      }
   385→      if (line.startsWith("- ")) {
   386→        return (
   387→          <li key={i} className="ml-4 text-foreground">
   388→            {renderInlineMarkdown(line.replace("- ", ""))}
   389→          </li>
   390→        )
   391→      }
   392→      if (line.startsWith("> ")) {
   393→        return (
   394→          <blockquote key={i} className="border-l-4 border-primary pl-4 my-2 text-muted-foreground italic">
   395→            {renderInlineMarkdown(line.replace("> ", ""))}
   396→          </blockquote>
   397→        )
   398→      }
   399→      if (line.trim() === "") {
   400→        return <br key={i} />
   401→      }
   402→      return (
   403→        <p key={i} className="text-foreground leading-relaxed">
   404→          {renderInlineMarkdown(line)}
   405→        </p>
   406→      )
   407→    })
   408→  }
   409→
   410→  // 处理行内 Markdown（粗体、斜体）
   411→  const renderInlineMarkdown = (text: string) => {
   412→    // 处理 **bold**
   413→    const parts = text.split(/(\*\*[^*]+\*\*)/g)
   414→    return parts.map((part, i) => {
   415→      if (part.startsWith("**") && part.endsWith("**")) {
   416→        return (
   417→          <strong key={i} className="font-semibold">
   418→            {part.slice(2, -2)}
   419→          </strong>
   420→        )
   421→      }
   422→      return part
   423→    })
   424→  }
   425→
   426→  return (
   427→    <div className="prose prose-neutral dark:prose-invert max-w-none">
   428→      {block.title && (
   429→        <h4 className="text-sm font-medium text-muted-foreground mb-2">{block.title}</h4>
   430→      )}
   431→      {renderMarkdown(block.content)}
   432→    </div>
   433→  )
   434→}
   435→
   436→// 普通文本 Block
   437→function TextBlock({ block }: { block: Block }) {
   438→  return <p className="text-foreground leading-relaxed">{block.content}</p>
   439→}
   440→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
