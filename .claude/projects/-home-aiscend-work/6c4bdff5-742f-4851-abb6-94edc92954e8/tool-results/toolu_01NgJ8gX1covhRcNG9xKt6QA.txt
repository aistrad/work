     1→#!/usr/bin/env bash
     2→set -euo pipefail
     3→
     4→ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
     5→cd "$ROOT_DIR"
     6→mkdir -p logs
     7→
     8→# 可选读取本地 .env 文件
     9→if [[ -f .env ]]; then
    10→  set -a; source ./.env; set +a
    11→fi
    12→
    13→# 可选：从本地信息派生运行时环境变量（不回显密钥）
    14→# - 从 CLI_WORKER_DB_URL 推导 Fortune/Gemini DB 密码与 fortune_ai 连接串
    15→# - 从 docs/apikey.md 推导 GLM（Z.AI）Anthropic 兼容变量
    16→if [[ -f scripts/load_runtime_env.sh ]]; then
    17→  # shellcheck disable=SC1090
    18→  source scripts/load_runtime_env.sh
    19→fi
    20→
    21→: "${GEMINI_DB_HOST:?GEMINI_DB_HOST missing}"
    22→: "${GEMINI_DB_PORT:?GEMINI_DB_PORT missing}"
    23→: "${GEMINI_DB_NAME:?GEMINI_DB_NAME missing}"
    24→: "${GEMINI_DB_USER:?GEMINI_DB_USER missing}"
    25→: "${GEMINI_DB_PASSWORD:?GEMINI_DB_PASSWORD missing}"
    26→
    27→: "${GLM_API_KEY:?GLM_API_KEY missing}"
    28→: "${GLM_BASE_URL:=https://api.z.ai/api/paas/v4}"
    29→: "${FORTUNE_AI_GLM_MODEL:?FORTUNE_AI_GLM_MODEL missing}"
    30→
    31→if [[ -z "${FORTUNE_AI_DB_URL:-}" && -z "${FORTUNE_DB_URL:-}" ]]; then
    32→  : "${FORTUNE_DB_HOST:?FORTUNE_DB_HOST missing}"
    33→  : "${FORTUNE_DB_PORT:?FORTUNE_DB_PORT missing}"
    34→  : "${FORTUNE_DB_NAME:?FORTUNE_DB_NAME missing}"
    35→  : "${FORTUNE_DB_USER:?FORTUNE_DB_USER missing}"
    36→  : "${FORTUNE_DB_PASSWORD:?FORTUNE_DB_PASSWORD missing}"
    37→fi
    38→
    39→API_HOST="${API_HOST:-0.0.0.0}"
    40→API_PORT="${API_PORT:-8230}"
    41→WORKER_INTERVAL="${WORKER_INTERVAL:-5}"
    42→WORKER_FILTER_KEYWORD="${WORKER_FILTER_KEYWORD:-八字}"
    43→GEMINI_DB_READONLY="${GEMINI_DB_READONLY:-1}"
    44→
    45→stop_if_running() {
    46→  local pattern="$1"
    47→  pkill -f "$pattern" 2>/dev/null || true
    48→}
    49→
    50→echo "[deploy] stopping previous processes..."
    51→stop_if_running "python -m worker.a2ui_worker"
    52→stop_if_running "python -m worker.push_worker"
    53→stop_if_running "uvicorn api.main:app"
    54→stop_if_running "python -u worker/tg_bot.py"
    55→
    56→echo "[deploy] starting API on :$API_PORT ..."
    57→nohup env PYTHONPATH=. \
    58→  python -u -m uvicorn api.main:app --host "$API_HOST" --port "$API_PORT" \
    59→  >> logs/api.log 2>&1 & echo $! > logs/api.pid
    60→
    61→BACKEND="${GEMINI_BACKEND:-gemini}"
    62→echo "[deploy] backend=$BACKEND"
    63→if [[ "$BACKEND" == "cli" ]]; then
    64→  echo "[deploy] starting CLI Worker ..."
    65→  : "${CLI_WORKER_DB_URL:=}"
    66→  if [[ -z "$CLI_WORKER_DB_URL" ]]; then
    67→    # fallback to local sqlite under /home/aiscend/work/cli_worker
    68→    export CLI_WORKER_ROOT="${CLI_WORKER_ROOT:-/home/aiscend/work/cli_worker}"
    69→    export CLI_WORKER_DB_URL="sqlite:///${CLI_WORKER_ROOT}/cli_worker.db"
    70→  fi
    71→  nohup env PYTHONPATH=. \
    72→    DB_URL="$CLI_WORKER_DB_URL" \
    73→    CLI_WORKER_ROOT="${CLI_WORKER_ROOT:-/home/aiscend/work/cli_worker}" \
    74→    python -u -m worker.cli_worker >> logs/worker.log 2>&1 & echo $! > logs/worker.pid
    75→else
    76→  echo "[deploy] starting DB observer Worker ..."
    77→  nohup env PYTHONPATH=. \
    78→    GEMINI_DB_HOST="$GEMINI_DB_HOST" GEMINI_DB_PORT="$GEMINI_DB_PORT" GEMINI_DB_NAME="$GEMINI_DB_NAME" GEMINI_DB_USER="$GEMINI_DB_USER" GEMINI_DB_PASSWORD="$GEMINI_DB_PASSWORD" \
    79→    WORKER_INTERVAL="$WORKER_INTERVAL" WORKER_FILTER_KEYWORD="$WORKER_FILTER_KEYWORD" GEMINI_DB_READONLY="$GEMINI_DB_READONLY" \
    80→    python -u -m worker.a2ui_worker >> logs/worker.log 2>&1 & echo $! > logs/worker.pid
    81→fi
    82→
    83→echo "[deploy] starting Push Worker (in-app) ..."
    84→nohup env PYTHONPATH=. \
    85→  python -u -m worker.push_worker --loop --interval-seconds 60 >> logs/push_worker.log 2>&1 & echo $! > logs/push_worker.pid
    86→
    87→if [[ "${TG_BOT_ENABLED:-0}" == "1" && -n "${TG_BOT_TOKEN:-}" ]]; then
    88→  echo "[deploy] starting Telegram bot ..."
    89→  nohup env PYTHONPATH=. TG_BOT_TOKEN="$TG_BOT_TOKEN" H5_BASE="${H5_BASE:-http://127.0.0.1:${API_PORT}/fortune}" \
    90→    python -u worker/tg_bot.py >> logs/tg_bot.log 2>&1 & echo $! > logs/tg_bot.pid
    91→fi
    92→
    93→echo "[deploy] done. pids:"
    94→for f in api worker push_worker tg_bot; do
    95→  [[ -f logs/$f.pid ]] && echo " - $f: $(cat logs/$f.pid)" || :
    96→done
    97→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
