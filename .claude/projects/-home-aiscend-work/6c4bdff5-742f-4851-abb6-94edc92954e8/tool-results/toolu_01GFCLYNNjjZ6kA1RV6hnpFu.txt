     1→"use client"
     2→
     3→import { useState, useCallback, useEffect } from "react"
     4→import { cn } from "@/lib/utils"
     5→import { useAppStore } from "@/stores/app-store"
     6→import { Resizer } from "./resizer"
     7→
     8→interface DualCoreLayoutProps {
     9→  zoneA: React.ReactNode  // Chat 区
    10→  zoneB: React.ReactNode  // Dashboard 区
    11→}
    12→
    13→// 黄金分割比例常量
    14→const DEFAULT_RATIO = 0.618  // 黄金分割比例
    15→
    16→// 聊天区宽度限制（扩大范围，支持任意调整）
    17→const MIN_ZONE_A_WIDTH = 320      // 最小宽度
    18→const MAX_ZONE_A_WIDTH = 1200     // 最大宽度，支持更大的调整范围
    19→const MIN_ZONE_B_WIDTH = 280      // Dashboard 最小宽度
    20→const RESIZER_MAX_WIDTH = 12      // 与 Resizer 最大宽度对齐（w-3 ≈ 12px）
    21→
    22→const STORAGE_KEY = "dual-core-layout:zone-a-width"
    23→
    24→const clampZoneAWidth = (width: number, containerWidth: number) => {
    25→  const maxByContainer = Math.max(
    26→    MIN_ZONE_A_WIDTH,
    27→    containerWidth - MIN_ZONE_B_WIDTH - RESIZER_MAX_WIDTH
    28→  )
    29→  const maxWidth = Math.min(MAX_ZONE_A_WIDTH, maxByContainer)
    30→  return Math.max(MIN_ZONE_A_WIDTH, Math.min(maxWidth, Math.round(width)))
    31→}
    32→
    33→// 计算默认宽度（在 useEffect 中动态计算）
    34→const getDefaultWidth = (containerWidth: number) => {
    35→  // 聊天区占黄金分割比例
    36→  return clampZoneAWidth(containerWidth * DEFAULT_RATIO, containerWidth)
    37→}
    38→
    39→export function DualCoreLayout({ zoneA, zoneB }: DualCoreLayoutProps) {
    40→  const { isSidebarOpen, setSidebarOpen, isMobile, setIsMobile } = useAppStore()
    41→  // 注意：不要在初始 render 里读 window/localStorage（会导致 SSR hydration mismatch）
    42→  const [zoneAWidth, setZoneAWidth] = useState<number | null>(null)
    43→
    44→  // 初始化：检测移动端（仅在 mount 时运行）
    45→  useEffect(() => {
    46→    const containerWidth = window.innerWidth
    47→    const mobile = containerWidth < 1024
    48→    setIsMobile(mobile)
    49→    // 移动端默认显示 Chat（isSidebarOpen = false）
    50→    if (mobile) {
    51→      setSidebarOpen(false)
    52→    }
    53→
    54→    // Desktop: initialize zoneA width from storage (or golden ratio) after mount
    55→    if (!mobile) {
    56→      const storedWidth = window.localStorage.getItem(STORAGE_KEY)
    57→      const parsedWidth = storedWidth ? Number(storedWidth) : NaN
    58→      const next = Number.isFinite(parsedWidth)
    59→        ? clampZoneAWidth(parsedWidth, containerWidth)
    60→        : getDefaultWidth(containerWidth)
    61→      const raf = window.requestAnimationFrame(() => setZoneAWidth(next))
    62→      return () => window.cancelAnimationFrame(raf)
    63→    }
    64→  }, [setIsMobile, setSidebarOpen])
    65→
    66→  // 监听窗口变化：更新移动端状态并确保宽度在合理范围
    67→  useEffect(() => {
    68→    const handleResize = () => {
    69→      const containerWidth = window.innerWidth
    70→      const mobile = containerWidth < 1024
    71→      setIsMobile(mobile)
    72→      if (mobile) {
    73→        setSidebarOpen(false)
    74→      }
    75→      setZoneAWidth((prev) => (prev == null ? prev : clampZoneAWidth(prev, containerWidth)))
    76→    }
    77→
    78→    window.addEventListener("resize", handleResize)
    79→    return () => window.removeEventListener("resize", handleResize)
    80→  }, [setIsMobile, setSidebarOpen])
    81→
    82→  // 持久化宽度（桌面端用户调整后保留）
    83→  useEffect(() => {
    84→    if (zoneAWidth == null) return
    85→    window.localStorage.setItem(STORAGE_KEY, String(zoneAWidth))
    86→  }, [zoneAWidth])
    87→
    88→  // 处理 Resizer 拖拽
    89→  const handleResize = useCallback((delta: number) => {
    90→    setZoneAWidth((prev) => {
    91→      const containerWidth = window.innerWidth
    92→      const current = prev ?? getDefaultWidth(containerWidth)
    93→      const newWidth = current + delta
    94→      return clampZoneAWidth(newWidth, containerWidth)
    95→    })
    96→  }, [])
    97→
    98→  // 双击 Resizer：恢复默认比例
    99→  const handleReset = useCallback(() => {
   100→    const containerWidth = window.innerWidth
   101→    setZoneAWidth(getDefaultWidth(containerWidth))
   102→  }, [])
   103→
   104→  // 移动端布局
   105→  if (isMobile) {
   106→    return (
   107→      <div className="h-screen w-full flex flex-col bg-background">
   108→        {/* 主内容区 - 根据当前 tab 显示 */}
   109→        <main className="flex-1 overflow-hidden">
   110→          {isSidebarOpen ? zoneB : zoneA}
   111→        </main>
   112→
   113→        {/* 底部双 Tab 导航 */}
   114→        <MobileTabBar />
   115→      </div>
   116→    )
   117→  }
   118→
   119→  // 桌面端布局
   120→  // 沉浸模式：Dashboard 关闭时，Chat 区填满整个屏幕
   121→  const isImmersive = !isSidebarOpen
   122→
   123→  return (
   124→    <div className="h-screen w-full flex bg-sidebar overflow-hidden">
   125→      {/* Zone A: Chat 区 */}
   126→      <main
   127→        className={cn(
   128→          "flex flex-col min-w-0 bg-background relative z-10 transition-all duration-300 ease-out",
   129→          isImmersive ? "flex-1" : "flex-shrink-0 shadow-float"
   130→        )}
   131→        style={{ width: isImmersive ? "100%" : (zoneAWidth ?? "clamp(320px, 61.8vw, 1200px)") }}
   132→      >
   133→        {zoneA}
   134→      </main>
   135→
   136→      {/* Resizer - 仅在非沉浸模式显示 */}
   137→      {!isImmersive && <Resizer onResize={handleResize} onReset={handleReset} />}
   138→
   139→      {/* Zone B: Dashboard 区 - 自适应填充剩余宽度 */}
   140→      <aside
   141→        className={cn(
   142→          "flex flex-col min-w-0 transition-all duration-300 ease-out",
   143→          "bg-sidebar",
   144→          isSidebarOpen
   145→            ? "flex-1 opacity-100"
   146→            : "w-0 opacity-0 overflow-hidden pointer-events-none"
   147→        )}
   148→      >
   149→        {zoneB}
   150→      </aside>
   151→    </div>
   152→  )
   153→}
   154→
   155→// 移动端底部导航 tabs 配置 - 包含所有入口
   156→const MOBILE_TABS = [
   157→  { id: "chat", label: "对话", icon: ChatIcon },
   158→  { id: "overview", label: "概览", icon: OverviewIcon },
   159→  { id: "status", label: "状态", icon: StatusIcon },
   160→  { id: "trends", label: "趋势", icon: TrendsIcon },
   161→  { id: "quests", label: "任务", icon: QuestsIcon },
   162→  { id: "relations", label: "关系", icon: RelationsIcon },
   163→  { id: "explore", label: "探索", icon: ExploreIcon },
   164→  { id: "settings", label: "设置", icon: SettingsIcon },
   165→] as const
   166→
   167→type MobileTabId = typeof MOBILE_TABS[number]["id"]
   168→
   169→// 移动端底部 Tab 导航 - 支持横向滚动
   170→function MobileTabBar() {
   171→  const { isSidebarOpen, setSidebarOpen, activeTab, setActiveTab } = useAppStore()
   172→
   173→  // 计算当前激活的 tab
   174→  const currentTab: MobileTabId = !isSidebarOpen ? "chat" : activeTab as MobileTabId
   175→
   176→  const handleTabClick = (tabId: MobileTabId) => {
   177→    if (tabId === "chat") {
   178→      setSidebarOpen(false)
   179→    } else {
   180→      setSidebarOpen(true)
   181→      setActiveTab(tabId as "overview" | "status" | "trends" | "quests" | "relations" | "explore" | "settings")
   182→    }
   183→  }
   184→
   185→  return (
   186→    <nav
   187→      className={cn(
   188→        "flex items-center",
   189→        "h-16 border-t border-border",
   190→        "bg-background",
   191→        "overflow-x-auto scrollbar-none",
   192→        "safe-area-pb" // iOS safe area
   193→      )}
   194→    >
   195→      {MOBILE_TABS.map((tab) => {
   196→        const isActive = currentTab === tab.id
   197→        const Icon = tab.icon
   198→        return (
   199→          <button
   200→            key={tab.id}
   201→            onClick={() => handleTabClick(tab.id)}
   202→            className={cn(
   203→              "relative flex flex-col items-center justify-center gap-0.5",
   204→              "min-w-[60px] px-2 h-full flex-shrink-0",
   205→              "text-muted-foreground transition-all duration-200",
   206→              isActive && "text-foreground"
   207→            )}
   208→          >
   209→            {/* 选中指示器 */}
   210→            {isActive && (
   211→              <div className="absolute top-1 w-8 h-1 rounded-full bg-foreground" />
   212→            )}
   213→            <Icon className={cn("w-5 h-5", isActive && "scale-110")} />
   214→            <span className="text-[10px] font-medium whitespace-nowrap">{tab.label}</span>
   215→          </button>
   216→        )
   217→      })}
   218→    </nav>
   219→  )
   220→}
   221→
   222→// Icons
   223→function ChatIcon({ className }: { className?: string }) {
   224→  return (
   225→    <svg
   226→      xmlns="http://www.w3.org/2000/svg"
   227→      viewBox="0 0 24 24"
   228→      fill="none"
   229→      stroke="currentColor"
   230→      strokeWidth="2"
   231→      strokeLinecap="round"
   232→      strokeLinejoin="round"
   233→      className={className}
   234→    >
   235→      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
   236→    </svg>
   237→  )
   238→}
   239→
   240→// 概览图标
   241→function OverviewIcon({ className }: { className?: string }) {
   242→  return (
   243→    <svg
   244→      xmlns="http://www.w3.org/2000/svg"
   245→      viewBox="0 0 24 24"
   246→      fill="none"
   247→      stroke="currentColor"
   248→      strokeWidth="2"
   249→      strokeLinecap="round"
   250→      strokeLinejoin="round"
   251→      className={className}
   252→    >
   253→      <rect x="3" y="3" width="7" height="9" rx="1" />
   254→      <rect x="14" y="3" width="7" height="5" rx="1" />
   255→      <rect x="14" y="12" width="7" height="9" rx="1" />
   256→      <rect x="3" y="16" width="7" height="5" rx="1" />
   257→    </svg>
   258→  )
   259→}
   260→
   261→// 状态图标 (心形/健康)
   262→function StatusIcon({ className }: { className?: string }) {
   263→  return (
   264→    <svg
   265→      xmlns="http://www.w3.org/2000/svg"
   266→      viewBox="0 0 24 24"
   267→      fill="none"
   268→      stroke="currentColor"
   269→      strokeWidth="2"
   270→      strokeLinecap="round"
   271→      strokeLinejoin="round"
   272→      className={className}
   273→    >
   274→      <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />
   275→    </svg>
   276→  )
   277→}
   278→
   279→// 趋势图标
   280→function TrendsIcon({ className }: { className?: string }) {
   281→  return (
   282→    <svg
   283→      xmlns="http://www.w3.org/2000/svg"
   284→      viewBox="0 0 24 24"
   285→      fill="none"
   286→      stroke="currentColor"
   287→      strokeWidth="2"
   288→      strokeLinecap="round"
   289→      strokeLinejoin="round"
   290→      className={className}
   291→    >
   292→      <path d="m22 7-8.5 8.5-5-5L2 17" />
   293→      <path d="M16 7h6v6" />
   294→    </svg>
   295→  )
   296→}
   297→
   298→// 任务图标
   299→function QuestsIcon({ className }: { className?: string }) {
   300→  return (
   301→    <svg
   302→      xmlns="http://www.w3.org/2000/svg"
   303→      viewBox="0 0 24 24"
   304→      fill="none"
   305→      stroke="currentColor"
   306→      strokeWidth="2"
   307→      strokeLinecap="round"
   308→      strokeLinejoin="round"
   309→      className={className}
   310→    >
   311→      <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z" />
   312→      <path d="m9 12 2 2 4-4" />
   313→    </svg>
   314→  )
   315→}
   316→
   317→// 关系图标
   318→function RelationsIcon({ className }: { className?: string }) {
   319→  return (
   320→    <svg
   321→      xmlns="http://www.w3.org/2000/svg"
   322→      viewBox="0 0 24 24"
   323→      fill="none"
   324→      stroke="currentColor"
   325→      strokeWidth="2"
   326→      strokeLinecap="round"
   327→      strokeLinejoin="round"
   328→      className={className}
   329→    >
   330→      <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
   331→      <circle cx="9" cy="7" r="4" />
   332→      <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
   333→      <path d="M16 3.13a4 4 0 0 1 0 7.75" />
   334→    </svg>
   335→  )
   336→}
   337→
   338→// 探索图标
   339→function ExploreIcon({ className }: { className?: string }) {
   340→  return (
   341→    <svg
   342→      xmlns="http://www.w3.org/2000/svg"
   343→      viewBox="0 0 24 24"
   344→      fill="none"
   345→      stroke="currentColor"
   346→      strokeWidth="2"
   347→      strokeLinecap="round"
   348→      strokeLinejoin="round"
   349→      className={className}
   350→    >
   351→      <circle cx="12" cy="12" r="10" />
   352→      <polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76" />
   353→    </svg>
   354→  )
   355→}
   356→
   357→// 设置图标
   358→function SettingsIcon({ className }: { className?: string }) {
   359→  return (
   360→    <svg
   361→      xmlns="http://www.w3.org/2000/svg"
   362→      viewBox="0 0 24 24"
   363→      fill="none"
   364→      stroke="currentColor"
   365→      strokeWidth="2"
   366→      strokeLinecap="round"
   367→      strokeLinejoin="round"
   368→      className={className}
   369→    >
   370→      <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
   371→      <circle cx="12" cy="12" r="3" />
   372→    </svg>
   373→  )
   374→}
   375→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
