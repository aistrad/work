     1→<!doctype html>
     2→<html>
     3→  <head>
     4→    <meta charset="utf-8" />
     5→    <meta name="viewport" content="width=device-width, initial-scale=1" />
     6→    <title>八字深度分析</title>
     7→    <link rel="stylesheet" href="/static/style.css" />
     8→  </head>
     9→  <body>
    10→    <main class="a2ui-main">
    11→      <h1>八字深度分析（内测版）</h1>
    12→      <div class="a2ui-layout">
    13→        <div class="a2ui-stack">
    14→          <section class="card">
    15→            <form id="form">
    16→              <input name="name" placeholder="姓名" required />
    17→              <select name="gender">
    18→                <option value="M">男</option>
    19→                <option value="F">女</option>
    20→              </select>
    21→              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px;">
    22→                <label>生日
    23→                  <input name="date" type="date" required />
    24→                </label>
    25→                <label>时间（时:分:秒）
    26→                  <input name="time" type="time" step="1" required />
    27→                </label>
    28→              </div>
    29→              <div style="margin-top:8px">
    30→                <label>模型
    31→                  <select name="model">
    32→                    <option value="standard" selected>standard</option>
    33→                    <option value="deep_research">deep_research</option>
    34→                  </select>
    35→                </label>
    36→              </div>
    37→              <div style="margin-top:8px">
    38→                <label>System Prompt
    39→                  <div style="display:flex; gap:8px; align-items:center">
    40→                    <input id="system_prompt_input" name="system_prompt" list="system_prompt_list" placeholder="可直接输入，或从候选中选择" style="flex:1" />
    41→                    <button id="system_prompt_toggle" type="button" title="展开候选">▾</button>
    42→                  </div>
    43→                  <datalist id="system_prompt_list">
    44→                    {% for p in prompt_presets or [] %}
    45→                      <option value="{{ p.text }}" label="{{ p.label }}" data-model="{{ p.model or '' }}"></option>
    46→                    {% endfor %}
    47→                    {% for h in prompt_history or [] %}
    48→                      <option value="{{ h.text }}" data-model="{{ h.model or '' }}"></option>
    49→                    {% endfor %}
    50→                  </datalist>
    51→                  <div id="system_prompt_fallback" class="card" style="display:none; max-height:180px; overflow:auto; margin-top:6px"></div>
    52→                </label>
    53→              </div>
    54→              <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
    55→                <button type="submit" id="submit-bazi">八字</button>
    56→                <button type="button" id="btn-rectify">校准出生时间</button>
    57→              </div>
    58→            </form>
    59→          </section>
    60→          <section class="card" id="bazi-box" style="display:none">
    61→            <h2>即时八字命盘</h2>
    62→            <pre id="bazi-pre"></pre>
    63→          </section>
    64→          <pre id="log" class="card log-card"></pre>
    65→          <div id="render"></div>
    66→        </div>
    67→        <section class="card" id="rectify-card">
    68→          <h2>事件列表（用于校准）</h2>
    69→          <p>模板格式：一行一条，逗号分隔（事件,日期,强弱）。可点击下方按钮插入示例。</p>
    70→          <textarea id="rectify-events" rows="6" style="width:100%" placeholder="例如：\n结婚,2018-05-12,强\n子女出生,2020-11-03,强\n近亲亡故,2016-02-01,中\n搬家,2014-07,弱\n职业剧变,2018-05,强\n重大意外,2019-09-21,中"></textarea>
    71→          <div style="margin-top:8px; display:flex; gap:8px;">
    72→            <button type="button" id="rectify-template">插入模板</button>
    73→          </div>
    74→          <div id="rectify-result" class="card" style="margin-top:12px; display:none;"></div>
    75→        </section>
    76→      </div>
    77→    </main>
    78→    <script>
    79→      const q = new URLSearchParams(location.search);
    80→      const userid = q.get('userid') || 'wecom_test';
    81→      const promptHistory = (window.__PROMPT_HISTORY__ || []);
    82→      const spIpt = document.getElementById('system_prompt_input');
    83→      const spList = document.getElementById('system_prompt_list');
    84→      function renderPromptOptions(){
    85→        // 注入模板渲染传下来的历史（若有）
    86→        try {
    87→          const injected = JSON.parse(document.getElementById('prompt-history-json').textContent);
    88→          if (Array.isArray(injected)) {
    89→            injected.forEach(it=>promptHistory.push(it));
    90→          }
    91→        } catch(e){}
    92→        // 注入预置模板
    93→        try {
    94→          const presets = JSON.parse(document.getElementById('prompt-presets-json').textContent);
    95→          if (Array.isArray(presets)) {
    96→            presets.forEach(p=>promptHistory.push({text:p.text, model:p.model||'', label:p.label||''}));
    97→          }
    98→        } catch(e){}
    99→        // 去重并渲染 datalist 选项（在已有服务端预置的基础上增量添加）
   100→        const seen = new Set(Array.from(spList.options).map(o=>o.value));
   101→        promptHistory.forEach(it=>{
   102→          const t = (it.text||'').trim(); if(!t || seen.has(t)) return; seen.add(t);
   103→          const opt = document.createElement('option');
   104→          opt.value = t;
   105→          opt.label = (it.label||'') ? `${it.label} — ${t.slice(0,40)}` : t.slice(0,60);
   106→          if (it.model) opt.dataset.model = it.model;
   107→          spList.appendChild(opt);
   108→        });
   109→      }
   110→      renderPromptOptions();
   111→      function applySuggestedModel(val){
   112→        const match = Array.from(spList.options).find(o=>o.value===val);
   113→        const m = match?.dataset?.model || '';
   114→        if (m) document.querySelector('select[name="model"]').value = m;
   115→      }
   116→
   117→      spIpt.addEventListener('input', ()=>{
   118→        // 若匹配到建议模型，自动切换模型
   119→        applySuggestedModel(spIpt.value);
   120→      });
   121→
   122→      // 回退自绘下拉：当浏览器不弹出 datalist 时，用户可点按钮展开
   123→      const fallback = document.getElementById('system_prompt_fallback');
   124→      document.getElementById('system_prompt_toggle').addEventListener('click', ()=>{
   125→        if (fallback.style.display === 'none') {
   126→          // 渲染候选
   127→          fallback.innerHTML = '';
   128→          Array.from(spList.options).forEach(o=>{
   129→            const a = document.createElement('a'); a.href='#'; a.textContent = o.label || o.value; a.style.display='block'; a.style.padding='6px 8px';
   130→            a.addEventListener('click', (e)=>{ e.preventDefault(); spIpt.value = o.value; applySuggestedModel(o.value); fallback.style.display='none'; });
   131→            fallback.appendChild(a);
   132→          });
   133→          fallback.style.display = 'block';
   134→        } else {
   135→          fallback.style.display = 'none';
   136→        }
   137→      });
   138→      const log = (m)=>{ const el=document.getElementById('log'); el.textContent += m+"\n"; };
   139→      function showBazi(b){
   140→        if (!b) return;
   141→        const el = document.getElementById('bazi-pre');
   142→        el.textContent = `年柱 ${b.year_pillar}｜月柱 ${b.month_pillar}｜日柱 ${b.day_pillar}｜时柱 ${b.hour_pillar}\n五行 ${b.wuxing||''}｜地点 ${b.location?.name||''} (${b.location?.longitude||''}, ${b.location?.latitude||''})`;
   143→        document.getElementById('bazi-box').style.display='block';
   144→      }
   145→      document.getElementById('form').addEventListener('submit', async (e)=>{
   146→        e.preventDefault();
   147→        const data = Object.fromEntries(new FormData(e.target));
   148→        const [year, month, day] = String(data.date||'').split('-').map(v=>parseInt(v,10));
   149→        const [hour, minute, secondRaw] = String(data.time||'').split(':');
   150→        const minuteNum = parseInt(minute||'0',10);
   151→        const hourNum = parseInt(hour||'0',10);
   152→        const birth_data = {
   153→          name: data.name,
   154→          gender: data.gender,
   155→          year: Number(year), month: Number(month), day: Number(day),
   156→          hour: Number(hourNum), minute: Number(minuteNum)
   157→        };
   158→        // 使用 /api/calculate 以确保第一时间返回八字命盘
   159→        // 先走 v2 提交可携带模型和 system_prompt，同时后端也会即时返回八字
   160→        const payload = {openid: userid, src:'wecom', model: data.model || 'standard', system_prompt: spIpt.value || '', birth_data};
   161→        try{
   162→          const resp = await fetch('/api/v2/submit', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
   163→          let j;
   164→          try{
   165→            j = await resp.json();
   166→          }catch(parseErr){
   167→            log('提交失败：服务端返回无效 JSON');
   168→            return;
   169→          }
   170→          if (!resp.ok) {
   171→            const detail = Array.isArray(j?.detail) ? j.detail.map(d=>d.msg || JSON.stringify(d)).join('; ') : (j?.detail || j?.message || '提交失败');
   172→            log('提交失败：' + detail);
   173→            return;
   174→          }
   175→          if (!j.job_id) {
   176→            log('提交失败：未获取到任务 ID');
   177→            return;
   178→          }
   179→          if (j.bazi) showBazi(j.bazi);
   180→          log('提交成功: job_id=' + j.job_id);
   181→          const job_id = j.job_id;
   182→          const poll = setInterval(async ()=>{
   183→            const r = await fetch('/api/v2/report/' + job_id);
   184→            let v;
   185→            try{
   186→              v = await r.json();
   187→            }catch(err){
   188→              clearInterval(poll);
   189→              log('轮询失败：服务端返回无效 JSON');
   190→              return;
   191→            }
   192→            if (!r.ok) {
   193→              clearInterval(poll);
   194→              const detail = Array.isArray(v?.detail) ? v.detail.map(d=>d.msg || JSON.stringify(d)).join('; ') : (v?.detail || v?.message || '未知错误');
   195→              log('轮询失败：' + detail);
   196→              return;
   197→            }
   198→            if (v.status === 'completed') {
   199→              clearInterval(poll);
   200→              renderA2UI(v.a2ui_data);
   201→            } else {
   202→              log('进度: ' + JSON.stringify(v));
   203→            }
   204→          }, 2000);
   205→        }catch(err){
   206→          log('提交失败：' + err);
   207→        }
   208→      });
   209→
   210→      function renderA2UI(a2ui){
   211→        const root = document.getElementById('render');
   212→        root.innerHTML = '';
   213→        (a2ui.ui_components||[]).forEach(c=>{
   214→          const sec = document.createElement('section');
   215→          const h = document.createElement('h2'); h.textContent = c.title || c.type; sec.appendChild(h);
   216→          if (c.type === 'markdown_text') {
   217→            const pre = document.createElement('pre'); pre.textContent = c.data; sec.appendChild(pre);
   218→          } else {
   219→            const pre = document.createElement('pre'); pre.textContent = JSON.stringify(c.data, null, 2); sec.appendChild(pre);
   220→          }
   221→          root.appendChild(sec);
   222→        });
   223→      }
   224→
   225→      // --------- 校准：基于主表单日期时间 ±2小时 ---------
   226→      function computeWindow(timeStr){
   227→        const [h,m,sRaw] = String(timeStr||'').split(':');
   228→        const hN = parseInt(h||'0',10), mN = parseInt(m||'0',10), sN = parseInt(sRaw||'0',10);
   229→        const to2 = (n)=> String(n).padStart(2,'0');
   230→        function norm(hh,mm,ss){
   231→          let dt = new Date(2000,0,1,hh,mm,ss);
   232→          const h2 = to2(dt.getHours()); const m2=to2(dt.getMinutes()); const s2=to2(dt.getSeconds());
   233→          return `${h2}:${m2}:${s2}`;
   234→        }
   235→        // 简易环绕，忽略跨日（服务端按生日当天构造窗口）
   236→        let startH = hN - 2; if (startH < 0) startH = 0;
   237→        let endH = hN + 2; if (endH > 23) endH = 23;
   238→        return {start: norm(startH, mN, sN), end: norm(endH, mN, sN)};
   239→      }
   240→
   241→      function mapEventType(t){
   242→        const x = (t||'').toLowerCase();
   243→        if (x.includes('结婚')||x.includes('婚')) return 'marriage';
   244→        if (x.includes('子女')||x.includes('出生')) return 'child_birth';
   245→        if (x.includes('亡')||x.includes('去世')||x.includes('丧')) return 'relative_death';
   246→        if (x.includes('搬家')||x.includes('移民')||x.includes('迁')) return 'move';
   247→        if (x.includes('职业')||x.includes('升职')||x.includes('失业')||x.includes('创业')) return 'career_change';
   248→        if (x.includes('意外')||x.includes('手术')||x.includes('受伤')) return 'accident';
   249→        return x;
   250→      }
   251→
   252→      document.getElementById('rectify-template').addEventListener('click', ()=>{
   253→        const el = document.getElementById('rectify-events');
   254→        el.value = [
   255→          '结婚,2018-05-12,强',
   256→          '子女出生,2020-11-03,强',
   257→          '近亲亡故,2016-02-01,中',
   258→          '搬家,2014-07,弱',
   259→          '职业剧变,2018-05,强',
   260→          '重大意外,2019-09-21,中',
   261→        ].join('\n');
   262→      });
   263→
   264→      document.getElementById('btn-rectify').addEventListener('click', async ()=>{
   265→        const formEl = document.getElementById('form');
   266→        const data = Object.fromEntries(new FormData(formEl));
   267→        if (!data.name || !data.date || !data.time) { log('请先填写姓名、生日与时间'); return; }
   268→        const win = computeWindow(data.time);
   269→        const lines = (document.getElementById('rectify-events').value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
   270→        const events = lines.map(line=>{ const [t,d,imp] = line.split(/[,，]/).map(s=>(s||'').trim()); return { type: mapEventType(t), date: d, impact: imp||undefined }; });
   271→        try{
   272→          log('正在校准...');
   273→          const res = await fetch('/api/rectify', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name: data.name, birthday: data.date, window_start: win.start, window_end: win.end, events }) });
   274→          const j = await res.json();
   275→          if (!res.ok || j.status !== 'ok') throw new Error(j.detail||'rectify failed');
   276→          const used = j.used_swisseph ? '（使用 Swiss Ephemeris 计算）' : '（使用简化算法）';
   277→          const items = (j.candidates||[]).map(c=>`• ${c.time} → 分数 ${c.score}`).join('\n');
   278→          const el = document.getElementById('rectify-result'); el.style.display='block';
   279→          el.innerHTML = `<pre>最佳时间：${j.best_time}\n候选：\n${items}\n窗口：${j.window.start} ~ ${j.window.end}\n${used}</pre>`;
   280→          log('校准完成');
   281→        }catch(err){
   282→          log('校准失败：'+err);
   283→        }
   284→      });
   285→    </script>
   286→    <script>
   287→      // ---------- Rectify (birth time calibration) ----------
   288→      (function(){
   289→        const rectifyForm = document.getElementById('rectify-form');
   290→        const rectifyEvents = document.getElementById('rectify-events');
   291→        const rectifyTemplateBtn = document.getElementById('rectify-template');
   292→        const rectifyResult = document.getElementById('rectify-result');
   293→        const logS = (m)=>{ const el=document.getElementById('log'); el.textContent += m+"\n"; };
   294→        if (rectifyTemplateBtn) {
   295→          rectifyTemplateBtn.addEventListener('click', ()=>{
   296→            const tmpl = [
   297→              '结婚,2018-05-12,强',
   298→              '子女出生,2020-11-03,强',
   299→              '近亲亡故,2016-02-01,中',
   300→              '搬家,2014-07,弱',
   301→              '职业剧变,2018-05,强',
   302→              '重大意外,2019-09-21,中',
   303→            ].join('\n');
   304→            rectifyEvents.value = tmpl;
   305→          });
   306→        }
   307→        function mapType(t){
   308→          const x = (t||'').toLowerCase();
   309→          if (x.includes('结婚')||x.includes('婚')) return 'marriage';
   310→          if (x.includes('子女')||x.includes('出生')) return 'child_birth';
   311→          if (x.includes('亡')||x.includes('去世')||x.includes('丧')) return 'relative_death';
   312→          if (x.includes('搬家')||x.includes('移民')||x.includes('迁')) return 'move';
   313→          if (x.includes('职业')||x.includes('升职')||x.includes('失业')||x.includes('创业')) return 'career_change';
   314→          if (x.includes('意外')||x.includes('手术')||x.includes('受伤')) return 'accident';
   315→          return x;
   316→        }
   317→        if (rectifyForm) {
   318→          rectifyForm.addEventListener('submit', async (e)=>{
   319→            e.preventDefault();
   320→            const fd = new FormData(rectifyForm);
   321→            const name = fd.get('name')||'';
   322→            const birthday = fd.get('birthday');
   323→            const latitude = Number(fd.get('latitude'));
   324→            const longitude = Number(fd.get('longitude'));
   325→            const window_start = fd.get('window_start');
   326→            const window_end = fd.get('window_end');
   327→            if (!name || !birthday || isNaN(latitude)|| isNaN(longitude)|| !window_start|| !window_end){
   328→              logS('请完整填写校准所需信息');
   329→              return;
   330→            }
   331→            const lines = (rectifyEvents.value||'').split(/\n+/).map(s=>s.trim()).filter(Boolean);
   332→            const events = lines.map(line=>{
   333→              const [t,d,imp] = line.split(/[,，]/).map(s=> (s||'').trim());
   334→              return { type: mapType(t), date: d, impact: imp||undefined };
   335→            });
   336→            const payload = { name, birthday, latitude, longitude, window_start, window_end, events };
   337→            try{
   338→              logS('开始校准...');
   339→              const res = await fetch('/api/rectify', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
   340→              const data = await res.json();
   341→              if (!res.ok || data.status !== 'ok') throw new Error(data.detail||'rectify failed');
   342→              const used = data.used_swisseph ? '（使用 Swiss Ephemeris 计算）' : '（使用简化算法）';
   343→              const items = (data.candidates||[]).map(c=>`• ${c.time} → 分数 ${c.score}`).join('\n');
   344→              rectifyResult.style.display='block';
   345→              rectifyResult.innerHTML = `<pre>最佳时间：${data.best_time}\n候选：\n${items}\n窗口：${data.window.start} ~ ${data.window.end}\n${used}</pre>`;
   346→              logS('校准完成');
   347→            }catch(err){
   348→              logS('校准失败：'+err);
   349→            }
   350→          });
   351→        }
   352→      })();
   353→    </script>
   354→    <script id="prompt-history-json" type="application/json">{{ prompt_history | tojson }}</script>
   355→    <script id="prompt-presets-json" type="application/json">{{ prompt_presets | tojson }}</script>
   356→  </body>
   357→  </html>
   358→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
