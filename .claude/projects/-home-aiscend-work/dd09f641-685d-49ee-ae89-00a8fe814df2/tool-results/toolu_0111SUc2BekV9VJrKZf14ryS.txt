     1→-- P1/P2 Updates: Chat Backend + Push Schema Fixes
     2→-- Date: 2025-12-30
     3→
     4→-- 1. Add chat_backend column to fortune_user_preferences
     5→ALTER TABLE fortune_user_preferences
     6→ADD COLUMN IF NOT EXISTS chat_backend TEXT NOT NULL DEFAULT 'fastapi'
     7→CHECK (chat_backend IN ('fastapi', 'agent_service'));
     8→
     9→COMMENT ON COLUMN fortune_user_preferences.chat_backend IS 'Chat backend: fastapi (direct LLM) or agent_service (Vercel AI SDK)';
    10→
    11→-- 2. Ensure fortune_push_event supports JITAI push lifecycle (idempotent)
    12→DO $$
    13→DECLARE
    14→  c RECORD;
    15→BEGIN
    16→  IF to_regclass('public.fortune_push_event') IS NOT NULL THEN
    17→    ALTER TABLE public.fortune_push_event
    18→      ADD COLUMN IF NOT EXISTS sent_at TIMESTAMPTZ,
    19→      ADD COLUMN IF NOT EXISTS delivered_at TIMESTAMPTZ,
    20→      ADD COLUMN IF NOT EXISTS clicked_at TIMESTAMPTZ,
    21→      ADD COLUMN IF NOT EXISTS dismissed_at TIMESTAMPTZ,
    22→      ADD COLUMN IF NOT EXISTS status TEXT,
    23→      ADD COLUMN IF NOT EXISTS error TEXT;
    24→
    25→    ALTER TABLE public.fortune_push_event ALTER COLUMN status SET DEFAULT 'scheduled';
    26→    UPDATE public.fortune_push_event SET status = 'scheduled' WHERE status IS NULL;
    27→    ALTER TABLE public.fortune_push_event ALTER COLUMN status SET NOT NULL;
    28→
    29→    ALTER TABLE public.fortune_push_event ALTER COLUMN error SET DEFAULT '';
    30→    UPDATE public.fortune_push_event SET error = '' WHERE error IS NULL;
    31→    ALTER TABLE public.fortune_push_event ALTER COLUMN error SET NOT NULL;
    32→
    33→    FOR c IN (
    34→      SELECT conname
    35→      FROM pg_constraint
    36→      WHERE conrelid = 'public.fortune_push_event'::regclass
    37→        AND contype = 'c'
    38→        AND pg_get_constraintdef(oid) LIKE '%push_type%'
    39→    ) LOOP
    40→      EXECUTE format('ALTER TABLE public.fortune_push_event DROP CONSTRAINT IF EXISTS %I', c.conname);
    41→    END LOOP;
    42→
    43→    FOR c IN (
    44→      SELECT conname
    45→      FROM pg_constraint
    46→      WHERE conrelid = 'public.fortune_push_event'::regclass
    47→        AND contype = 'c'
    48→        AND pg_get_constraintdef(oid) LIKE '%status%'
    49→    ) LOOP
    50→      EXECUTE format('ALTER TABLE public.fortune_push_event DROP CONSTRAINT IF EXISTS %I', c.conname);
    51→    END LOOP;
    52→
    53→    ALTER TABLE public.fortune_push_event
    54→      ADD CONSTRAINT fortune_push_event_push_type_check CHECK (push_type IN (
    55→        'plan_daily', 'weekly_reflection', 'milestone',
    56→        'jitai_energy_low', 'jitai_mood_check', 'jitai_activity_prompt',
    57→        'jitai_custom', 'social_buff', 'social_chain', 'system'
    58→      ));
    59→
    60→    ALTER TABLE public.fortune_push_event
    61→      ADD CONSTRAINT fortune_push_event_status_check CHECK (status IN (
    62→        'scheduled', 'sent', 'delivered', 'clicked', 'dismissed', 'skipped', 'failed'
    63→      ));
    64→  END IF;
    65→END $$;
    66→
    67→CREATE INDEX IF NOT EXISTS idx_push_user_scheduled ON fortune_push_event (user_id, scheduled_at DESC);
    68→CREATE INDEX IF NOT EXISTS idx_push_status ON fortune_push_event (status, scheduled_at);
    69→
    70→-- 3. Note on KB tables:
    71→-- Current production uses bazi_kb_chunk/bazi_kb_document (FTS + trigram)
    72→-- fortune_kb_chunk in 20251230_claude_mvp.sql is for future pgvector migration
    73→-- DO NOT use fortune_kb_chunk until vector embeddings are implemented
    74→
    75→-- 4. fortune_agent_run table is defined in 20251230_claude_mvp.sql
    76→-- This migration ensures it exists and adds any missing indexes
    77→CREATE INDEX IF NOT EXISTS idx_agent_run_facts_hash ON fortune_agent_run(facts_hash);
    78→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
