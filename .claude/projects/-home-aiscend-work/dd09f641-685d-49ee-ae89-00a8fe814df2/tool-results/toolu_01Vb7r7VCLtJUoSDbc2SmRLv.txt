     1→# Fortune AI 最终 MVP 系统设计（Web 可落地 / PostgreSQL / GLM）
     2→
     3→**文档类型**：Final MVP System Design  
     4→**产品代号**：`Fortune AI`  
     5→**版本**：Final MVP v1.0  
     6→**日期**：2025-12-29  
     7→**核心定位**：AI 驱动的“人生导航 / 陪伴 / 提升系统”（有效而极简）  
     8→**硬约束**：纯 AI（不引入真人服务）/ 不做社区 / Web 端可落地 / **Fortune AI 业务数据仅使用 PostgreSQL（DB=fortune_ai）**；深度报告支持 `backend=cli|gemini`：`gemini` 仅在调用 gemini 报告链路时连接 `DB=gemini`（`gemini_job/gemini_task`），`cli` 仅调用 `cli_worker` 的执行与状态查询（业务 SSOT 仍写入 `fortune_ai`）  
     9→**LLM**：**GLM（Z.AI / /api/paas/v4/chat/completions）**  
    10→**入口**：`/main`（**两栏**：左=对话（含会话切换/历史抽屉）右=Workbench（顶部结果 Viewer + 下方 Tabs 输入/配置）；未登录跳转 `/login`）  
    11→
    12→---
    13→
    14→## 0. 一页结论（给产品 & 开发）
    15→
    16→### 0.1 MVP 交付目标
    17→
    18→在 Web 端跑通一个可重复、可度量、可追溯的“陪跑闭环”：
    19→
    20→`Clarify → Insight → Prescription → Commitment → Action → Reflection → Memory Update`
    21→
    22→并用最小交互承载三大价值：
    23→- **导航**：把问题结构化成 `Options / Constraints / Risk Boundary / Next Experiment`
    24→- **陪伴**：以积极心理学 / Performance Coach 话术承接情绪（不恐吓、不宿命）
    25→- **提升**：把输出收敛为可执行行动与能力训练轨道（30 天计划 + 复盘）
    26→
    27→### 0.2 北极星指标（统一口径）
    28→
    29→`WCG`（Weekly Closed-loop Guidance）  
    30→定义：用户在一周内完成 ≥1 次“触发 → 指引 → 行动 → 反馈”闭环。
    31→
    32→### 0.3 最终合并决策（Codex MVP × Claude MVP）
    33→
    34→| 决策点 | 最终方案（Final MVP） | 取舍理由 |
    35→|---|---|---|
    36→| 闭环核心 | 引入 `Commitment`（4 类承诺） | 没有承诺就没有闭环；与“提升”一致 |
    37→| 交互效率 | “三点击原则”作为验收标准 | 可验收、可迭代、可控复杂度 |
    38→| 布局 | **两栏**（对话 + 功能区；会话历史为抽屉/弹层） | 保持极简与高效；多会话仍可用但不占常驻空间 |
    39→| Bento | 卡片为内容 + Tab 为容器 | 卡片可复用、Tab 可组织复杂度 |
    40→| 计划 | 4 个预设计划开箱即用 + 30 天轨道统一口径 | 降低选择成本，同时保证“提升”可度量 |
    41→| 知识库 | **PostgreSQL FTS + pg_trgm**（不引入其他 DB） | 可真实落地、可运维、可追溯 |
    42→| LLM | GLM（Z.AI / ChatGLM-4） | 统一对话与文本生成后端，便于治理 |
    43→
    44→---
    45→
    46→## 1. 产品原则（硬规则，可验收）
    47→
    48→### 1.1 三点击原则
    49→
    50→任何核心价值都必须在 ≤3 次点击内完成：
    51→- 打开 `/main` → 看今日指引 → 选择一个行动（Commitment）
    52→- 点“情绪打卡” → 选情绪/强度 → 获得一个调节动作并开始
    53→- 点“决策模板” → 选问题类型 → 生成下一步实验并加入待办
    54→
    55→### 1.2 每次交互必落到 Commitment
    56→
    57→`commitment_type`（仅 4 类）：
    58→- `start_task`：立刻开始（≤5 分钟优先）
    59→- `schedule_task`：加入今日/本周并设提醒
    60→- `ask_followup`：选择一个澄清问题继续（减少开放式追问）
    61→- `opt_out`：暂停/关闭（推送与反依赖的必要出口）
    62→
    63→### 1.3 反依赖机制（防玄学依赖）
    64→
    65→| 触发条件 | 系统响应（默认温和） |
    66→|---|---|
    67→| 连续 3 次问同一问题 | 强制给“现实行动实验”（5–15 分钟）后再继续；提供“我愿意执行/稍后/不再提示” |
    68→| 当日咨询 > 5 次 | 提示“信息足够，先行动”；给 1 个最小任务并结束回合 |
    69→| 轨道达标毕业 | 主动降频推送；强调自我掌控；引导进入维护期或换轨道 |
    70→
    71→### 1.4 Agent 角色优先级（不可逆）
    72→
    73→`Coach > Teaching Assistant > Customer Support > Sales`
    74→
    75→销售规则：**先交付价值，再给升级路径**；禁止恐吓式转化。
    76→
    77→---
    78→
    79→## 2. 前端交互（Web /main：两栏 + Bento）
    80→
    81→### 2.1 登录与用户管理（无游客模式）
    82→
    83→- 未登录访问 `/main` 时，服务端返回 `302` 跳转到 `/login`。
    84→- `/login`：邮箱 + 密码登录（成功后写入会话 Cookie）。
    85→- `/register`：邮箱 + 密码注册（注册即登录），并在同一流程内完成最小 Profile（姓名/性别/出生信息/地点）。
    86→- `设置` Tab 必须包含：
    87→  - 修改密码
    88→  - 退出登录
    89→  - 注销账户（软删除，清空会话）
    90→
    91→### 2.2 页面结构
    92→
    93→`/main` 两栏布局（极简且可落地）：
    94→- 左：对话线程（Chat Thread，SSOT）+ 顶部会话切换；会话历史以**抽屉/弹层**呈现（不常驻）
    95→- 右：功能区（Bento/Workbench，承载所有非语言交互）
    96→
    97→**ASCII（桌面端 /main 结构）**
    98→
    99→```text
   100→┌──────────────────────────────────────────────────────────────────────────┐
   101→│ Fortune AI | 会话 ▼ | 风格: warm | 设置 | 退出                              │
   102→├───────────────────────────────┬──────────────────────────────────────────┤
   103→│ Chat Thread (SSOT)             │ Bento / Workbench                         │
   104→│ ─────────────────────────────  │ Tabs: [Bento] [工具] [设置]               │
   105→│ · 会话历史（抽屉/弹层，按需开） │                                           │
   106→│ · 消息流（用户/教练）          │ 6 张核心卡片（1 tap 启动）                 │
   107→│ · 输入框 + 快捷动作            │ + 工具：八字报告/校准/铁板                 │
   108→│                                │ + 设置：push/静默/隐私/语言风格           │
   109→└───────────────────────────────┴──────────────────────────────────────────┘
   110→```
   111→
   112→### 2.3 右侧 Bento（Tab 作为容器，卡片为内容）
   113→
   114→右侧固定 3 个 Tab：
   115→- `Bento`（默认）：6 张核心卡片
   116→- `工具`：八字报告 / 出生校准 / 铁板神算
   117→- `设置`：语言风格 / 推送与静默时段 / 隐私与数据管理
   118→
   119→**Bento 6 张核心卡片（全部 1 tap 启动）**
   120→1) `今日指引`：结论 + 1 个动作（按钮）  
   121→2) `行动处方`：最多 3 个进行中任务（完成/跳过/复盘）  
   122→3) `情绪打卡`：情绪 + 强度（0–10）→ 归因 + 1 个调节动作  
   123→4) `成长计划`：预设计划（4 个）+ 30 天游程轨道（统一进度口径）  
   124→5) `决策模板`：Decision Brief（Options/Constraints/Risks/Next Experiment）  
   125→6) `话术生成`：场景 → 可复制模板（沟通/边界/拒绝/谈判）  
   126→
   127→### 2.4 语言风格（表达层）
   128→
   129→`persona_style`：
   130→- `standard`：清晰、中性、专业
   131→- `warm`：共情、支持性（默认）
   132→- `roast`：轻毒舌但不羞辱、不做人身定性
   133→
   134→---
   135→
   136→## 3. Chat Agent（GLM）设计
   137→
   138→### 3.1 “后端专业分析”到“教练表达”的翻译规则
   139→
   140→后端产出两类输入给 LLM：
   141→- `facts`：确定性事实（八字计算、用户偏好、计划进度、历史反馈）
   142→- `evidence`：证据（规则 ID + 知识库引用 + `facts_hash`）
   143→
   144→LLM 只做三件事：
   145→1) 共情承接（积极心理学）
   146→2) 结构化解释（把问题拆成可控/不可控/需澄清）
   147→3) 生成行动处方 + 承诺邀请（≤3 条处方）
   148→
   149→LLM 禁止做：
   150→- 自行推断八字事实、编造经典出处、输出确定性宿命论断言
   151→
   152→### 3.2 统一对话结构（6 步）
   153→
   154→1) 情绪确认  
   155→2) 结构解释（导航）  
   156→3) 行动处方（≤3）  
   157→4) 时间窗口（默认干预窗口）  
   158→5) 风险边界（医疗/法律/投资等）  
   159→6) 承诺邀请（Commitment）  
   160→
   161→### 3.3 GLM 接入方式（Z.AI OpenAI-compat）
   162→
   163→配置来源：`/home/aiscend/work/docs/apikey.md`
   164→
   165→**必须环境变量（不在文档中写明密钥值）**
   166→- `GLM_BASE_URL=https://api.z.ai/api/paas/v4`
   167→- `GLM_API_KEY=$ZAI_GLM_KEY`
   168→- `FORTUNE_AI_GLM_MODEL=glm-4.7`
   169→- `FORTUNE_AI_GLM_THINKING=disabled`（`enabled|disabled`）
   170→
   171→**请求协议（Chat Completions）**
   172→- `POST ${GLM_BASE_URL}/chat/completions`
   173→- Header：
   174→  - `Content-Type: application/json`
   175→  - `Authorization: Bearer ${GLM_API_KEY}`
   176→- Body：`model`, `messages`, `max_tokens`, `temperature`, `thinking.type`, `stream`
   177→
   178→**请求示例（非流式）**
   179→
   180→```bash
   181→curl -sS "$GLM_BASE_URL/chat/completions" \
   182→  -H "Content-Type: application/json" \
   183→  -H "Authorization: Bearer $GLM_API_KEY" \
   184→  -d '{
   185→    "model": "'"$FORTUNE_AI_GLM_MODEL"'",
   186→    "max_tokens": 1200,
   187→    "temperature": 0.6,
   188→    "stream": false,
   189→    "thinking": {"type":"disabled"},
   190→    "messages": [
   191→      {"role":"system","content":"你是 Fortune AI 的 Performance Coach。请严格仅输出 A2UI JSON（不要代码块/不要多余文本）。"},
   192→      {"role":"user","content":"我最近很焦虑，工作要不要换？"}
   193→    ]
   194→  }'
   195→```
   196→
   197→**注意**
   198→- 若设置 `thinking.type=enabled`，Z.AI 可能仅返回 `reasoning_content` 且 `content` 为空。
   199→- 后端会在检测到 `content` 为空时自动降级重试（`thinking=disabled`）以保证有可展示输出。
   200→
   201→**输出格式要求（强制）**
   202→- 返回 **A2UI JSON**，首组件必须为 `markdown_text`，确保前端可渲染。
   203→
   204→### 3.4 GLM System Prompt（最终模板，直接用于实现）
   205→
   206→> 目标：把“命理/知识库/规则”的专业分析，翻译成“积极心理学/绩效教练”的行动闭环输出；并强制结构化与可追溯。
   207→
   208→```text
   209→你是 Fortune AI 的对话 Agent，角色是积极心理学教练（Performance Coach）。
   210→
   211→【产品定位】
   212→人生导航 / 陪伴 / 提升。系统和交互保持“有效而极简”。
   213→
   214→【你的优先级（不可逆）】
   215→Coach > Teaching Assistant > Customer Support > Sales
   216→
   217→【硬性规则（必须遵守）】
   218→1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接“你可以做什么”的行动处方。
   219→2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。
   220→3) 每次输出必须包含：结论(conclusion) + 依据(why) + ≤3条处方(prescriptions) + 承诺邀请(commitment_ask)。
   221→4) 时间窗口默认只给干预窗口（intervention）；forecast 只能条件句+低置信度。
   222→5) 输出必须是 A2UI JSON，且第一组件必须是 markdown_text。
   223→6) 必须给出可点击 actions（start_task / schedule_task / open_panel / opt_out）。
   224→
   225→【语言风格 persona_style】
   226→standard：清晰、中性、专业
   227→warm：共情、支持性（默认）
   228→roast：轻毒舌但不羞辱、不对人格做负面定性
   229→
   230→【输入】
   231→- persona_style 取值：standard / warm / roast
   232→- user_context：用户基础信息与偏好（来自 PostgreSQL）
   233→- facts：八字确定性事实 + 计划进度 + 历史反馈（来自 PostgreSQL）
   234→- evidence：rule_ids + kb_refs + facts_hash（来自 PostgreSQL）
   235→- user_message：用户本轮输入（来自对话）
   236→
   237→【输出（A2UI JSON）】
   238→- meta.summary：一句话摘要
   239→- ui_components[0]：markdown_text（必须，包含：结论要点/依据/处方/时间窗口/边界/承诺邀请）
   240→- ui_components[1]：action_buttons（必须，包含：开始行动/加入计划/查看Bento等按钮）
   241→```
   242→
   243→---
   244→
   245→## 4. 交付契约（Guidance Card + A2UI）
   246→
   247→### 4.1 Guidance Card（服务端 SSOT）
   248→
   249→```json
   250→{
   251→  "card_id": "b3a28c14-7a04-4b6c-8a37-8f4b0bb4c0f3",
   252→  "type": "daily_guidance",
   253→  "conclusion": "≤50字结论",
   254→  "why": "依据（用心理学/教练语言重构）",
   255→  "prescriptions": [
   256→    {"task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1", "content": "行动1", "estimated_minutes": 5},
   257→    {"task_id": "d1d6b1f3-1c1a-4d0f-9a64-2e4a91bfe5d2", "content": "行动2", "estimated_minutes": 10}
   258→  ],
   259→  "time_window": {
   260→    "type": "intervention",
   261→    "value": "7天试行",
   262→    "confidence": "high",
   263→    "checkpoint_date": "2026-01-05"
   264→  },
   265→  "risk_boundary": "不替代医疗/法律/投资建议",
   266→  "commitment_ask": "你愿意先做哪一个？",
   267→  "actions": [
   268→    {"type": "start_task", "task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1", "label": "开始行动1"},
   269→    {"type": "schedule_task", "task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1", "label": "加入今日计划"}
   270→  ],
   271→  "evidence": {
   272→    "plugin": "bazi",
   273→    "rule_ids": ["RULE-TS-001", "RULE-PATTERN-004"],
   274→    "kb_refs": ["kb:doc:2:page:45:chunk:3"],
   275→    "facts_hash": "sha256:3b9e8b9a1ad0b2f92b2d4e8c5a2d9b4c1f3e2d1c0b9a8f7e6d5c4b3a2f1e0d9c"
   276→  },
   277→  "created_at": "2025-12-29T10:00:00Z"
   278→}
   279→```
   280→
   281→### 4.2 A2UI（前端渲染）
   282→
   283→```json
   284→{
   285→  "meta": {"summary": "一句话摘要"},
   286→  "ui_components": [
   287→    {"type": "markdown_text", "title": "输出", "data": "### 结论要点\n- 你现在的焦虑主要来自不确定性与信息过载。\n\n### 行动处方（≤3条）\n1) 用决策模板写清选项/约束（10分钟）\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\n3) 情绪峰值先做3分钟降噪再决策\n\n### 承诺\n你愿意先做哪一个？"},
   288→    {"type": "action_buttons", "title": "下一步", "data": [{"label": "开始行动1", "action": {"type": "start_task", "task_id": "4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1"}}]}
   289→  ]
   290→}
   291→```
   292→
   293→---
   294→
   295→## 5. 后端架构（数学脑 / 知识脑 / 语言脑）
   296→
   297→```
   298→Client (/main)
   299→  → API (FastAPI)
   300→      → [数学脑] 八字确定性计算（facts + facts_hash）
   301→      → [知识脑] PostgreSQL FTS 检索知识库（kb_refs）
   302→      → [语言脑] GLM 生成 A2UI + Guidance Card
   303→      → PostgreSQL SSOT（用户/会话/计划/承诺/反馈/推送/知识库）
   304→```
   305→
   306→### 5.1 数学脑：八字确定性计算（真太阳时，直接实现）
   307→
   308→**输入（来自用户 Profile）**
   309→- `birthday_local`: `YYYY-MM-DD HH:MM:SS`（用户当地标准时间）
   310→- `tz_offset_hours`: 例如 `8.0`
   311→- `location`: `{ "name": "北京", "longitude": 116.4074, "latitude": 39.9042 }`
   312→
   313→**真太阳时校正（用于时柱/跨日边界）**
   314→
   315→1) 时区中央经线：`tz_meridian_deg = tz_offset_hours * 15`
   316→2) 经度校正（分钟）：`lon_corr_min = (longitude - tz_meridian_deg) * 4`
   317→3) 均时差（Equation of Time，分钟）：
   318→   - `birthday_utc = birthday_local - tz_offset_hours`
   319→   - `jd_ut = swisseph.julday(birthday_utc.year, birthday_utc.month, birthday_utc.day, hour_decimal_utc)`
   320→   - `e_days = swisseph.time_equ(jd_ut)`（返回“真太阳时 - 平太阳时”，单位天）
   321→   - `eot_min = e_days * 1440`
   322→4) 真太阳时（本地）：`true_solar_time_local = birthday_local + lon_corr_min + eot_min`
   323→
   324→**排盘（lunar_python）**
   325→
   326→以 `true_solar_time_local` 为排盘时间：
   327→- `Solar.fromYmdHms(Y,M,D,hh,mm,ss) -> Lunar -> EightChar`
   328→- 四柱：
   329→  - `EightChar.getYear()/getMonth()/getDay()/getTime()`
   330→- 十神（天干 + 地支）：
   331→  - `getYearShiShenGan/getMonthShiShenGan/getDayShiShenGan/getTimeShiShenGan`
   332→  - `getYearShiShenZhi/getMonthShiShenZhi/getDayShiShenZhi/getTimeShiShenZhi`
   333→- 纳音：`getYearNaYin/getMonthNaYin/getDayNaYin/getTimeNaYin`
   334→- 地势：`getYearDiShi/getMonthDiShi/getDayDiShi/getTimeDiShi`
   335→- 大运/流年：
   336→  - `yun = EightChar.getYun(gender_code)`（`男=1`，`女=0`）
   337→  - `da_yun_list = yun.getDaYun(10)`（取 10 步大运；过滤 `getGanZhi()==''` 的条目）
   338→  - 每步大运：`getStartAge/getEndAge/getStartYear/getEndYear/getGanZhi/getXun/getXunKong`
   339→  - 流年：`DaYun.getLiuNian()`（取当年与未来 5 年用于 MVP）
   340→
   341→### 5.2 `facts`（LLM 唯一事实输入，固定字段）
   342→
   343→`facts` 写入 `fortune_bazi_snapshot.facts`，并作为 GLM 生成的唯一事实来源。
   344→
   345→示例（北京，1990-05-12 14:00，男）：
   346→
   347→```json
   348→{
   349→  "profile": {
   350→    "name": "张三",
   351→    "gender": "男",
   352→    "birthday_local": "1990-05-12 14:00:00",
   353→    "tz_offset_hours": 8.0,
   354→    "location": {"name": "北京", "longitude": 116.4074, "latitude": 39.9042}
   355→  },
   356→  "solar_time": {
   357→    "tz_meridian_deg": 120.0,
   358→    "lon_corr_min": -14.3704,
   359→    "eot_min": 3.6845,
   360→    "true_solar_time_local": "1990-05-12 13:49:19"
   361→  },
   362→  "bazi": {
   363→    "pillars": {"year": "庚午", "month": "辛巳", "day": "丁丑", "hour": "丁未"},
   364→    "day_master": {"gan": "丁", "element": "火"},
   365→    "wuxing_count": {"金": 2, "木": 0, "水": 0, "火": 4, "土": 2},
   366→    "shi_shen_gan": {"year": "正财", "month": "偏财", "day": "日主", "hour": "比肩"},
   367→    "shi_shen_zhi": {
   368→      "year": ["比肩", "食神"],
   369→      "month": ["劫财", "正财", "伤官"],
   370→      "day": ["食神", "七杀", "偏财"],
   371→      "hour": ["食神", "比肩", "偏印"]
   372→    },
   373→    "na_yin": {"year": "路旁土", "month": "白蜡金", "day": "涧下水", "hour": "天河水"},
   374→    "di_shi": {"year": "临官", "month": "帝旺", "day": "墓", "hour": "冠带"},
   375→    "luck": {
   376→      "forward": true,
   377→      "start_age_year": 8,
   378→      "da_yun": [
   379→        {"index": 1, "start_age": 9, "end_age": 18, "start_year": 1998, "end_year": 2007, "gan_zhi": "壬午", "xun": "甲申", "xun_kong": "戌亥"},
   380→        {"index": 2, "start_age": 19, "end_age": 28, "start_year": 2008, "end_year": 2017, "gan_zhi": "癸未", "xun": "乙酉", "xun_kong": "戌亥"}
   381→      ],
   382→      "liu_nian_next5": [
   383→        {"year": 2026, "gan_zhi": "丙午"},
   384→        {"year": 2027, "gan_zhi": "丁未"},
   385→        {"year": 2028, "gan_zhi": "戊申"},
   386→        {"year": 2029, "gan_zhi": "己酉"},
   387→        {"year": 2030, "gan_zhi": "庚戌"}
   388→      ]
   389→    },
   390→    "shensha": [
   391→      {"name": "桃花", "hit": true, "note": "以日支/年支推咸池"},
   392→      {"name": "驿马", "hit": false, "note": "以日支/年支推驿马"},
   393→      {"name": "天乙贵人", "hit": true, "note": "以日干推贵人"}
   394→    ]
   395→  },
   396→  "version": {
   397→    "compute_version": "bazi-tts-v1",
   398→    "facts_hash": "sha256:9a59e0f36b8f4c8b0b0e0e7b1c3c0d9610e14aa0f0e2d1d6b1f31c1a4d0f9a64"
   399→  }
   400→}
   401→```
   402→
   403→### 5.3 旺衰与喜用（MVP 确定性算法，输出可解释）
   404→
   405→**日主五行映射（按日干）**
   406→- 甲乙=木；丙丁=火；戊己=土；庚辛=金；壬癸=水
   407→
   408→**月令季节五行（按月支）**
   409→- 寅卯辰=木（春）；巳午未=火（夏）；申酉戌=金（秋）；亥子丑=水（冬）
   410→
   411→**强弱评分（score）**
   412→- `support = count(day_master) + count(generator_of_day_master)`
   413→- `drain = count(produced_by_day_master) + count(controller_of_day_master)`
   414→- `score = support - drain + season_bonus`
   415→- `season_bonus`：
   416→  - 月令同五行：`+2`
   417→  - 月令生日主：`+1`
   418→  - 月令克日主：`-1`
   419→  - 月令被日主克：`-1`
   420→
   421→**判定**
   422→- `score >= 2` → `strong`
   423→- `score <= -2` → `weak`
   424→- 其余 → `neutral`
   425→
   426→**喜用输出**
   427→- `weak`：喜 `日主五行 + 生扶五行`
   428→- `strong`：喜 `泄耗五行 + 财五行 + 官杀五行`
   429→- `neutral`：优先补“最少的五行”
   430→
   431→### 5.4 神煞（MVP 固定计算范围与规则）
   432→
   433→固定计算：`桃花(咸池)`、`驿马`、`华盖`、`天乙贵人`、`文昌`
   434→
   435→**三合局分组（以年支/日支所属局为准）**
   436→- 申子辰局 → 桃花=酉，驿马=寅，华盖=辰
   437→- 亥卯未局 → 桃花=子，驿马=巳，华盖=未
   438→- 寅午戌局 → 桃花=卯，驿马=申，华盖=戌
   439→- 巳酉丑局 → 桃花=午，驿马=亥，华盖=丑
   440→
   441→**天乙贵人（按日干）**
   442→- 甲/戊/庚：丑、未
   443→- 乙/己：子、申
   444→- 丙/丁：亥、酉
   445→- 辛：寅、午
   446→- 壬/癸：卯、巳
   447→
   448→**文昌（按日干）**
   449→- 甲乙：巳、午
   450→- 丙丁：申、酉
   451→- 戊己：申、酉
   452→- 庚辛：亥、子
   453→- 壬癸：寅、卯
   454→
   455→命中判定：若四柱地支出现对应地支，则 `hit=true`。
   456→
   457→---
   458→
   459→## 6. 数据库设计（PostgreSQL / DB=fortune_ai，全部可执行）
   460→
   461→> 说明：本节为最终 schema（不使用任何其他数据库）。连接凭据参考 `docs/apikey.md`，将 DB 名替换为 `fortune_ai`。
   462→
   463→**决策（回答 DB 名称冲突）**
   464→- 在同一 PostgreSQL 实例中新建数据库 `fortune_ai`，Fortune AI 所有业务表只创建在该库内。
   465→- 深度报告支持 `backend=cli|gemini`：`gemini` 数据库保持原样，仅在 `backend=gemini` 时作为报告引擎的 job/task 存储（读写 `gemini_job/gemini_task`）；`backend=cli` 通过 `cli_worker` 的执行链路提交与轮询（不访问 `gemini` DB）。
   466→
   467→**运行时连接（必须）**
   468→- Fortune AI 业务库（DB=fortune_ai）：使用 `FORTUNE_DB_HOST/FORTUNE_DB_PORT/FORTUNE_DB_NAME/FORTUNE_DB_USER/FORTUNE_DB_PASSWORD`（与现有代码一致，`FORTUNE_DB_NAME=fortune_ai`）；也可用单一连接串 `FORTUNE_AI_DB_URL`（libpq URL 形式）。
   469→- `backend=gemini`：Gemini 报告服务库使用 `.env.example` 同名变量 `GEMINI_DB_HOST/GEMINI_DB_PORT/GEMINI_DB_NAME/GEMINI_DB_USER/GEMINI_DB_PASSWORD` 连接 `gemini`；**仅** `integrations/gemini_repo.py`（以及其依赖的 gemini_tool）允许访问该库，用于创建与轮询 `gemini_job/gemini_task`。
   470→- `backend=cli`：CLI Worker 使用 `CLI_WORKER_DB_URL`（或本地 sqlite fallback）查询任务状态；任务提交通过 `cli_worker` 项目接口执行（由 `integrations/cli_worker_repo.py` 封装）。
   471→
   472→### 6.1 初始化（数据库与扩展）
   473→
   474→```sql
   475→CREATE DATABASE fortune_ai;
   476→
   477→\\c fortune_ai;
   478→
   479→CREATE EXTENSION IF NOT EXISTS pgcrypto;
   480→CREATE EXTENSION IF NOT EXISTS pg_trgm;
   481→```
   482→
   483→### 6.2 用户与偏好
   484→
   485→```sql
   486→CREATE TABLE IF NOT EXISTS fortune_user (
   487→  user_id BIGSERIAL PRIMARY KEY,
   488→  email TEXT NOT NULL,
   489→  password_hash TEXT NOT NULL,          -- bcrypt
   490→  name TEXT NOT NULL,                   -- 昵称/显示名
   491→  gender TEXT NOT NULL CHECK (gender IN ('男','女')),
   492→  birthday_local TIMESTAMP NOT NULL,    -- 用户当地标准时间（不含时区）
   493→  birthday_utc TIMESTAMPTZ NOT NULL,    -- 统一存 UTC 时间（由 birthday_local + tz_offset_hours 推导）
   494→  tz_offset_hours NUMERIC(4,1) NOT NULL DEFAULT 8.0,
   495→  location JSONB NOT NULL,              -- {name, longitude, latitude}
   496→  bazi_digest TEXT,
   497→  last_login_at TIMESTAMPTZ,
   498→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   499→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   500→  deleted_at TIMESTAMPTZ
   501→);
   502→CREATE UNIQUE INDEX IF NOT EXISTS idx_fortune_user_email_lower ON fortune_user ((lower(email))) WHERE deleted_at IS NULL;
   503→CREATE INDEX IF NOT EXISTS idx_fortune_user_name ON fortune_user (name) WHERE deleted_at IS NULL;
   504→
   505→CREATE TABLE IF NOT EXISTS fortune_user_preferences (
   506→  user_id BIGINT PRIMARY KEY REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   507→  persona_style TEXT NOT NULL DEFAULT 'warm' CHECK (persona_style IN ('standard','warm','roast')),
   508→  push_enabled BOOLEAN NOT NULL DEFAULT TRUE,
   509→  push_time TIME NOT NULL DEFAULT '08:00:00',
   510→  push_timezone TEXT NOT NULL DEFAULT 'Asia/Shanghai',
   511→  quiet_hours_start TIME NOT NULL DEFAULT '22:00:00',
   512→  quiet_hours_end TIME NOT NULL DEFAULT '07:00:00',
   513→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   514→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   515→);
   516→
   517→CREATE TABLE IF NOT EXISTS fortune_user_session (
   518→  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   519→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   520→  token_hash TEXT NOT NULL,             -- sha256(base64url_token)
   521→  csrf_token_hash TEXT NOT NULL,        -- sha256(csrf_token)
   522→  ip TEXT NOT NULL DEFAULT '',
   523→  user_agent TEXT NOT NULL DEFAULT '',
   524→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   525→  expires_at TIMESTAMPTZ NOT NULL,      -- now() + interval '30 days'
   526→  revoked_at TIMESTAMPTZ
   527→);
   528→CREATE UNIQUE INDEX IF NOT EXISTS idx_user_session_token_hash ON fortune_user_session (token_hash);
   529→CREATE INDEX IF NOT EXISTS idx_user_session_user_active ON fortune_user_session (user_id, expires_at DESC) WHERE revoked_at IS NULL;
   530→```
   531→
   532→### 6.3 会话与消息（SSOT，不落本地文件）
   533→
   534→```sql
   535→CREATE TABLE IF NOT EXISTS fortune_conversation_session (
   536→  session_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   537→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   538→  title TEXT NOT NULL DEFAULT '',
   539→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   540→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   541→);
   542→CREATE INDEX IF NOT EXISTS idx_conv_session_user_updated ON fortune_conversation_session (user_id, updated_at DESC);
   543→
   544→CREATE TABLE IF NOT EXISTS fortune_conversation_message (
   545→  message_id BIGSERIAL PRIMARY KEY,
   546→  session_id UUID NOT NULL REFERENCES fortune_conversation_session(session_id) ON DELETE CASCADE,
   547→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   548→  role TEXT NOT NULL CHECK (role IN ('user','assistant','system')),
   549→  content TEXT NOT NULL,
   550→  a2ui JSONB,                            -- assistant 输出（可空）
   551→  model TEXT NOT NULL,
   552→  prompt_tokens INTEGER NOT NULL DEFAULT 0,
   553→  completion_tokens INTEGER NOT NULL DEFAULT 0,
   554→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
   555→);
   556→CREATE INDEX IF NOT EXISTS idx_conv_msg_session_time ON fortune_conversation_message (session_id, created_at);
   557→```
   558→
   559→### 6.4 八字事实快照（可追溯一致性）
   560→
   561→```sql
   562→CREATE TABLE IF NOT EXISTS fortune_bazi_snapshot (
   563→  snapshot_id BIGSERIAL PRIMARY KEY,
   564→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   565→  compute_version TEXT NOT NULL,
   566→  facts JSONB NOT NULL,
   567→  facts_hash TEXT NOT NULL,
   568→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   569→  UNIQUE (user_id, compute_version, facts_hash)
   570→);
   571→CREATE INDEX IF NOT EXISTS idx_bazi_snapshot_user_time ON fortune_bazi_snapshot (user_id, created_at DESC);
   572→```
   573→
   574→### 6.5 承诺与行动（闭环核心）
   575→
   576→```sql
   577→CREATE TABLE IF NOT EXISTS fortune_commitment (
   578→  task_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   579→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   580→  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,
   581→  card_id UUID,                         -- 生成该建议的交付卡 ID（可空）
   582→  source TEXT NOT NULL CHECK (source IN ('chat','bento','push')),
   583→  commitment_type TEXT NOT NULL CHECK (commitment_type IN ('start_task','schedule_task','ask_followup','opt_out')),
   584→  title TEXT NOT NULL,
   585→  details JSONB NOT NULL DEFAULT '{}'::jsonb,
   586→  status TEXT NOT NULL DEFAULT 'suggested' CHECK (status IN ('suggested','active','done','skipped','canceled')),
   587→  accepted_at TIMESTAMPTZ,              -- 用户确认承诺的时间（commitment_made 以此判定）
   588→  due_at TIMESTAMPTZ,
   589→  done_at TIMESTAMPTZ,
   590→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
   591→);
   592→CREATE INDEX IF NOT EXISTS idx_commitment_user_status ON fortune_commitment (user_id, status, created_at DESC);
   593→```
   594→
   595→### 6.6 情绪打卡与复盘（反馈闭环）
   596→
   597→```sql
   598→CREATE TABLE IF NOT EXISTS fortune_checkin (
   599→  checkin_id BIGSERIAL PRIMARY KEY,
   600→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   601→  mood TEXT NOT NULL,                    -- 例：焦虑/低落/平静/兴奋
   602→  intensity INTEGER NOT NULL CHECK (intensity BETWEEN 0 AND 10),
   603→  note TEXT NOT NULL DEFAULT '',
   604→  recommended_action TEXT NOT NULL,      -- 系统给出的 1 个动作（可执行）
   605→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
   606→);
   607→CREATE INDEX IF NOT EXISTS idx_checkin_user_time ON fortune_checkin (user_id, created_at DESC);
   608→
   609→CREATE TABLE IF NOT EXISTS fortune_reflection (
   610→  reflection_id BIGSERIAL PRIMARY KEY,
   611→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   612→  period TEXT NOT NULL CHECK (period IN ('daily','weekly')),
   613→  reflection_date DATE NOT NULL,
   614→  input JSONB NOT NULL,                 -- 用户回答（结构化）
   615→  output_card JSONB NOT NULL,           -- Guidance Card
   616→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   617→  UNIQUE (user_id, period, reflection_date)
   618→);
   619→```
   620→
   621→### 6.7 成长计划（4 个预设 + 用户进度）
   622→
   623→```sql
   624→CREATE TABLE IF NOT EXISTS fortune_plan (
   625→  plan_id TEXT PRIMARY KEY,
   626→  name TEXT NOT NULL,
   627→  duration_days INTEGER NOT NULL CHECK (duration_days > 0),
   628→  theory TEXT NOT NULL,
   629→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
   630→);
   631→
   632→CREATE TABLE IF NOT EXISTS fortune_plan_day (
   633→  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE CASCADE,
   634→  day_no INTEGER NOT NULL CHECK (day_no > 0),
   635→  title TEXT NOT NULL,
   636→  instruction TEXT NOT NULL,
   637→  PRIMARY KEY (plan_id, day_no)
   638→);
   639→
   640→CREATE TABLE IF NOT EXISTS fortune_plan_enrollment (
   641→  enrollment_id BIGSERIAL PRIMARY KEY,
   642→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   643→  plan_id TEXT NOT NULL REFERENCES fortune_plan(plan_id) ON DELETE RESTRICT,
   644→  start_date DATE NOT NULL,
   645→  current_day INTEGER NOT NULL DEFAULT 1,
   646→  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active','paused','completed','abandoned')),
   647→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   648→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   649→  UNIQUE (user_id, plan_id, start_date)
   650→);
   651→CREATE INDEX IF NOT EXISTS idx_plan_enroll_user_status ON fortune_plan_enrollment (user_id, status, updated_at DESC);
   652→
   653→CREATE TABLE IF NOT EXISTS fortune_plan_record (
   654→  record_id BIGSERIAL PRIMARY KEY,
   655→  enrollment_id BIGINT NOT NULL REFERENCES fortune_plan_enrollment(enrollment_id) ON DELETE CASCADE,
   656→  day_no INTEGER NOT NULL,
   657→  completed BOOLEAN NOT NULL DEFAULT FALSE,
   658→  note TEXT NOT NULL DEFAULT '',
   659→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   660→  UNIQUE (enrollment_id, day_no)
   661→);
   662→```
   663→
   664→**预设计划固定为 4 个（开箱即用，写入 DB）**
   665→
   666→```sql
   667→INSERT INTO fortune_plan (plan_id, name, duration_days, theory) VALUES
   668→  ('gratitude_21', '21天感恩练习', 21, '积极心理学'),
   669→  ('mindfulness_7', '7天正念入门', 7, '正念冥想'),
   670→  ('habit_30', '30天习惯养成挑战', 30, '行为科学/原子习惯'),
   671→  ('strength_14', '14天优势发现之旅', 14, 'VIA优势理论')
   672→ON CONFLICT (plan_id) DO NOTHING;
   673→```
   674→
   675→**预设计划任务（`fortune_plan_day`，固定内容，直接写入 DB）**
   676→
   677→```sql
   678→-- 21天感恩练习
   679→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
   680→('gratitude_21', 1, '启动：三件好事', '写下今天发生的3件值得感恩/欣赏的小事；每件用1句话写清“发生了什么”和“我为什么感激”。'),
   681→('gratitude_21', 2, '细化：把好事写具体', '从昨天的3件好事里任选1件，补充3个细节（人/地点/动作/感受），让它更可回忆。'),
   682→('gratitude_21', 3, '人际：感谢一个人', '给一个人发一条感谢信息（不需长），明确说出：对方做了什么→对你产生了什么影响。'),
   683→('gratitude_21', 4, '逆境：找出一个转折', '回想最近一个不顺，写下：最难的点是什么？我从中学到的一件事是什么？'),
   684→('gratitude_21', 5, '身体：感谢身体', '写下今天身体为你做好的3件事（例如呼吸、走路、恢复），并做一次1分钟伸展。'),
   685→('gratitude_21', 6, '环境：感谢一处空间', '选一个你常待的空间（工位/卧室），写下它带给你的1个好处，并整理1个小角落。'),
   686→('gratitude_21', 7, '一周复盘：我更容易看见什么', '写下这一周你更容易注意到的“好”是什么（人/事/能力/资源），以及下周你想继续强化的1点。'),
   687→('gratitude_21', 8, '行为：把感谢变成行动', '选择一个你感激的人或资源，做一个5分钟的小行动来回馈（例如主动帮一次忙）。'),
   688→('gratitude_21', 9, '优势：感谢自己的一个优点', '写下你最近做对的一件事，并标注它体现了你哪种能力/品质（例如专注、勇气、耐心）。'),
   689→('gratitude_21', 10, '情绪：感谢一次情绪提醒', '回想今天一次负面情绪，写下：它提醒了我什么需求？我能用一个健康方式满足它是什么？'),
   690→('gratitude_21', 11, '关系：修复一个小摩擦', '选择一个小摩擦场景，写下你能做的一个小修复动作（例如道歉、解释、感谢）。'),
   691→('gratitude_21', 12, '时间：感谢一次坚持', '写下你最近坚持了3天以上的一件事，并说明它让你得到的一个好处。'),
   692→('gratitude_21', 13, '工作：感谢一个机会', '写下你当前工作/学习里一个可利用的机会或资源，并写下你明天会做的一个最小利用动作。'),
   693→('gratitude_21', 14, '两周复盘：我的变化', '用0-10分给“情绪稳定/行动一致/关系满意”各打分，并写下各自提升/下降的原因。'),
   694→('gratitude_21', 15, '表达：把感谢说出口', '当面或语音对一个人表达感谢（30秒即可）：具体行为→影响→你的感受。'),
   695→('gratitude_21', 16, '愿景：感谢未来的自己', '写一段给30天后的自己的话：你希望他/她保持什么？你感谢他/她会做到什么？'),
   696→('gratitude_21', 17, '学习：感谢一次输入', '选一段你今天学到的内容（文章/视频/对话），写下1句可执行的收获（明天怎么用）。'),
   697→('gratitude_21', 18, '金钱：感谢一笔支出', '挑一笔你最近的支出，写下它解决了什么问题/带来了什么价值；避免自责式语言。'),
   698→('gratitude_21', 19, '勇气：感谢一次不完美行动', '写下你做过的一次“虽然不完美但仍然去做”的行动；标注它体现的勇气。'),
   699→('gratitude_21', 20, '整合：我的感谢清单', '把前19天里你最想保留的5条感谢整理成清单，并写下你将如何持续（每周一次）。'),
   700→('gratitude_21', 21, '毕业：把感谢变成习惯', '写下：这21天最有效的一个做法；以及你未来4周的最小维持频率（例如每周3天）。')
   701→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;
   702→
   703→-- 7天正念入门
   704→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
   705→('mindfulness_7', 1, '呼吸锚点（3分钟）', '计时3分钟：只关注呼吸的进出；走神时温和拉回；结束后给自己一句鼓励。'),
   706→('mindfulness_7', 2, '身体扫描（5分钟）', '从头到脚扫描身体感受；只描述“紧/松/热/冷”，不评判好坏。'),
   707→('mindfulness_7', 3, '情绪命名（2分钟）', '当下情绪用一个词命名（例如焦虑/烦躁）；再用一句话描述它在身体的感觉。'),
   708→('mindfulness_7', 4, '正念进食（5分钟）', '选一小口食物：观察颜色/气味/口感；放慢咀嚼；注意冲动与满足的变化。'),
   709→('mindfulness_7', 5, '正念行走（5分钟）', '走5分钟：注意脚掌触地、身体重心移动；不听信息流。'),
   710→('mindfulness_7', 6, '3分钟降噪协议', '遇到强情绪时执行：1分钟呼吸→1分钟身体感受→1分钟选择下一步（一个小动作）。'),
   711→('mindfulness_7', 7, '毕业复盘', '写下：本周最有效的练习是哪一个？你准备在未来两周以什么频率继续？')
   712→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;
   713→
   714→-- 30天习惯养成挑战
   715→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
   716→('habit_30', 1, '定义一个最小习惯', '选择一个你想养成的习惯，把它缩小到“2分钟版本”（例如做5个俯卧撑/写50字）。'),
   717→('habit_30', 2, '设置触发器', '为习惯选择一个固定触发器（起床后/刷牙后/下班到家后），写成一句话，例如：“当我刷牙后，我就做2分钟版本”。'),
   718→('habit_30', 3, '准备环境', '把执行习惯需要的物品/环境准备好（例如把瑜伽垫放出来）；让开始成本≤30秒。'),
   719→('habit_30', 4, '记录一次完成', '今天完成一次2分钟版本，并记录：我在什么时刻做的？完成后感觉如何（0-10）？'),
   720→('habit_30', 5, '加入一个奖励', '为完成后加一个小奖励（1分钟伸展/一杯热水/听一首歌），强化闭环。'),
   721→('habit_30', 6, '识别阻碍', '写下你今天最可能失败的原因（时间/情绪/环境），并给一个应对预案。'),
   722→('habit_30', 7, '一周复盘', '统计本周完成天数；写下最有效的触发器与最大阻碍；调整一次触发器或时间。'),
   723→('habit_30', 8, '提高可见性', '把习惯放到更可见的位置（便签/桌面/日历），让你更容易想起它。'),
   724→('habit_30', 9, '缩短启动时间', '把“开始动作”进一步缩短（例如只做1个俯卧撑也算开始），确保今天不会零。'),
   725→('habit_30', 10, '提高一致性', '把习惯固定到同一时间段；如果做不到，就固定“同一触发器”。'),
   726→('habit_30', 11, '建立替代方案', '准备一个“低能量版本”（例如累时做30秒），保证情绪低谷也能完成。'),
   727→('habit_30', 12, '消除一个摩擦', '找到一个让你不想做的摩擦点（准备麻烦/太远），今天把它消掉。'),
   728→('habit_30', 13, '把习惯和身份绑定', '写一句身份宣言：我是谁→我会做什么（例如“我是重视健康的人，所以我每天动2分钟”）。'),
   729→('habit_30', 14, '两周复盘', '统计14天完成率；写下你最常见的失败场景，并更新一个更现实的预案。'),
   730→('habit_30', 15, '提升一点难度', '把2分钟版本提升10%-20%（仍然很小），例如从写50字到写60字。'),
   731→('habit_30', 16, '让它更有趣', '给习惯加一点乐趣（音乐/计时挑战/打卡视觉化），让你更愿意开始。'),
   732→('habit_30', 17, '建立“如果-那么”计划', '写下两条：如果我加班→那么我做低能量版本；如果我忘了→那么我睡前补一次。'),
   733→('habit_30', 18, '加入社交承诺', '找一个朋友或对话里做一个承诺：我将坚持到第30天；并写下你希望被如何提醒。'),
   734→('habit_30', 19, '连续3天挑战', '目标：连续3天不间断完成（允许低能量版本）。'),
   735→('habit_30', 20, '复盘奖励机制', '写下奖励是否有效；如果无效，换一个更适合你的奖励（不靠刷短视频）。'),
   736→('habit_30', 21, '三周复盘', '统计21天完成率；写下你完成最多的时间段；把习惯固定到那个时间段。'),
   737→('habit_30', 22, '减少自责', '写下：我失败时常说的自责句；把它改写成教练句（例如“下一次我做更小”）。'),
   738→('habit_30', 23, '优化提醒', '设置一个具体提醒（闹钟/日历），并写上行动文案（不是“别忘了”，而是“现在做2分钟版本”）。'),
   739→('habit_30', 24, '把习惯连到目标', '写下：这个习惯最终服务什么目标？它让你更接近目标的证据是什么？'),
   740→('habit_30', 25, '应对突发', '假设明天有突发事件，写下你仍能完成的最小动作是什么，并承诺执行。'),
   741→('habit_30', 26, '连续7天维护', '目标：连续7天都完成（允许低能量版本）；只追求“不断”。'),
   742→('habit_30', 27, '整理成果', '写下本月你累计完成了多少次；你感觉最大的变化是什么（哪怕很小）。'),
   743→('habit_30', 28, '建立复盘仪式', '选择一个每周固定的复盘时刻（例如周日20:00），写下你将检查的3个问题。'),
   744→('habit_30', 29, '准备长期版本', '为下个月定义一个可持续版本（不比现在更难），并确定触发器与提醒方式。'),
   745→('habit_30', 30, '毕业：写一封给自己的信', '写下：我靠什么坚持了30天？我下个月继续的最小频率是多少？')
   746→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;
   747→
   748→-- 14天优势发现之旅
   749→INSERT INTO fortune_plan_day (plan_id, day_no, title, instruction) VALUES
   750→('strength_14', 1, '列出5次高光时刻', '写下你过去1-2年里5次“做得很顺/很投入”的时刻；每次写清场景与结果。'),
   751→('strength_14', 2, '提炼3个优势', '从高光时刻里提炼3个反复出现的优势（例如组织、表达、洞察、执行），并各写一句证据。'),
   752→('strength_14', 3, '优势命名', '给每个优势起一个你喜欢的名字（更个人化），并写下它在你身上的表现。'),
   753→('strength_14', 4, '优势应用：工作', '选择一个工作/学习任务，刻意用一个优势完成它；记录结果与感受。'),
   754→('strength_14', 5, '优势应用：关系', '选择一个关系场景，用一个优势改善沟通（例如倾听/表达/边界），并记录反馈。'),
   755→('strength_14', 6, '识别优势的阴影面', '为每个优势写下它的“过度使用”会带来的问题（例如过度负责、过度挑剔）。'),
   756→('strength_14', 7, '一周复盘：优势最有用的时刻', '写下本周优势最有帮助的一次经历；以及下一周你想在哪个场景继续用它。'),
   757→('strength_14', 8, '优势组合', '挑两个优势做组合：它们如何互补？写下一个你想尝试的组合行动。'),
   758→('strength_14', 9, '优势补短', '选一个你经常卡住的弱项，写下用哪个优势可以“绕过去”（例如用结构化代替拖延）。'),
   759→('strength_14', 10, '优势与目标对齐', '写下你当前一个目标；把它拆成3步，并标注每步使用哪个优势最省力。'),
   760→('strength_14', 11, '请求支持', '找一个人描述你的一个优势，并请对方给一个你可以更好发挥的建议。'),
   761→('strength_14', 12, '优势表达为价值', '写一段30秒自我介绍：我擅长什么→能为别人带来什么价值（避免空话）。'),
   762→('strength_14', 13, '优势在压力下的使用', '回想一次压力情境，写下你可以如何用优势稳定自己，并设计一个下次的应对句。'),
   763→('strength_14', 14, '毕业：优势使用计划', '写下未来4周你要刻意使用的1个优势；设定每周至少2次的应用场景。')
   764→ON CONFLICT (plan_id, day_no) DO UPDATE SET title = EXCLUDED.title, instruction = EXCLUDED.instruction;
   765→```
   766→
   767→### 6.8 每日指引（今日卡 SSOT）
   768→
   769→```sql
   770→CREATE TABLE IF NOT EXISTS fortune_daily_guidance (
   771→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   772→  guidance_date DATE NOT NULL,
   773→  card JSONB NOT NULL,                    -- Guidance Card
   774→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   775→  PRIMARY KEY (user_id, guidance_date)
   776→);
   777→```
   778→
   779→### 6.9 推送调度与发送记录（可审计）
   780→
   781→```sql
   782→CREATE TABLE IF NOT EXISTS fortune_push_event (
   783→  push_id BIGSERIAL PRIMARY KEY,
   784→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   785→  push_type TEXT NOT NULL CHECK (push_type IN ('plan_daily','weekly_reflection','milestone')),
   786→  scheduled_at TIMESTAMPTZ NOT NULL,
   787→  sent_at TIMESTAMPTZ,
   788→  status TEXT NOT NULL DEFAULT 'scheduled' CHECK (status IN ('scheduled','sent','skipped','failed')),
   789→  payload JSONB NOT NULL,
   790→  error TEXT NOT NULL DEFAULT '',
   791→  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
   792→);
   793→CREATE INDEX IF NOT EXISTS idx_push_user_scheduled ON fortune_push_event (user_id, scheduled_at DESC);
   794→```
   795→
   796→### 6.10 八字知识库（PDF 入库 → PostgreSQL 检索）
   797→
   798→```sql
   799→CREATE TABLE IF NOT EXISTS bazi_kb_document (
   800→  doc_id BIGSERIAL PRIMARY KEY,
   801→  file_name TEXT NOT NULL,
   802→  sha256 TEXT NOT NULL,
   803→  title TEXT NOT NULL DEFAULT '',
   804→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   805→  UNIQUE (sha256)
   806→);
   807→
   808→CREATE TABLE IF NOT EXISTS bazi_kb_chunk (
   809→  chunk_id BIGSERIAL PRIMARY KEY,
   810→  doc_id BIGINT NOT NULL REFERENCES bazi_kb_document(doc_id) ON DELETE CASCADE,
   811→  page_no INTEGER NOT NULL CHECK (page_no > 0),
   812→  chunk_no INTEGER NOT NULL CHECK (chunk_no > 0),
   813→  content TEXT NOT NULL,
   814→  content_tsv tsvector GENERATED ALWAYS AS (to_tsvector('simple', content)) STORED,
   815→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   816→  UNIQUE (doc_id, page_no, chunk_no)
   817→);
   818→CREATE INDEX IF NOT EXISTS idx_kb_chunk_tsv ON bazi_kb_chunk USING GIN (content_tsv);
   819→CREATE INDEX IF NOT EXISTS idx_kb_chunk_trgm ON bazi_kb_chunk USING GIN (content gin_trgm_ops);
   820→```
   821→
   822→检索（用于 Structured RAG）：
   823→```sql
   824→-- 关键词检索（FTS）
   825→SELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,
   826→       ts_rank(c.content_tsv, plainto_tsquery('simple', :q)) AS rank,
   827→       c.content
   828→FROM bazi_kb_chunk c
   829→WHERE c.content_tsv @@ plainto_tsquery('simple', :q)
   830→ORDER BY rank DESC
   831→LIMIT 12;
   832→
   833→-- 中文场景补充：trgm 相似度
   834→SELECT c.chunk_id, c.doc_id, c.page_no, c.chunk_no,
   835→       similarity(c.content, :q) AS sim,
   836→       c.content
   837→FROM bazi_kb_chunk c
   838→WHERE c.content % :q
   839→ORDER BY sim DESC
   840→LIMIT 12;
   841→```
   842→
   843→### 6.10.1 知识库入库流程（PDF → 文本 → chunk → PostgreSQL）
   844→
   845→**输入目录**
   846→- `fortune_ai/knowledge/bazi/*.pdf`
   847→
   848→**依赖（Python）**
   849→- `pypdf`（用于 PDF 文本抽取）
   850→
   851→**入库规则（固定）**
   852→- `bazi_kb_document.sha256` 唯一，保证幂等：同一 PDF 重复导入不会产生重复文档。
   853→- chunk 参数固定：
   854→  - `chunk_size_chars = 800`
   855→  - `chunk_overlap_chars = 120`
   856→- `kb_ref` 统一格式：`kb:doc:{doc_id}:page:{page_no}:chunk:{chunk_no}`
   857→
   858→**入库步骤（脚本执行顺序）**
   859→1) 遍历 PDF：计算文件 `sha256`，写入/复用 `bazi_kb_document`。
   860→2) 逐页抽取文本：保留 `page_no`；清理多余空白与重复换行。
   861→3) 分段切分：
   862→   - 先按段落（空行）拆分
   863→   - 再按字符数合并成 chunk（800 字），相邻 chunk 120 字重叠
   864→4) 写入 `bazi_kb_chunk`（`doc_id + page_no + chunk_no` 唯一）
   865→
   866→### 6.11 规则库（`rule_ids` SSOT，可追溯）
   867→
   868→```sql
   869→CREATE TABLE IF NOT EXISTS fortune_rule (
   870→  rule_id TEXT PRIMARY KEY,
   871→  category TEXT NOT NULL,
   872→  name TEXT NOT NULL,
   873→  body JSONB NOT NULL,
   874→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   875→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
   876→);
   877→CREATE INDEX IF NOT EXISTS idx_rule_category ON fortune_rule (category);
   878→```
   879→
   880→写入 MVP 必备规则（与 §5.3/§5.4 保持一致）：
   881→
   882→```sql
   883→INSERT INTO fortune_rule (rule_id, category, name, body) VALUES
   884→('RULE-STRENGTH-SCORE-V1', 'bazi_strength', '旺衰评分算法', '{
   885→  "season_map": {"寅":"木","卯":"木","辰":"木","巳":"火","午":"火","未":"火","申":"金","酉":"金","戌":"金","亥":"水","子":"水","丑":"水"},
   886→  "day_master_map": {"甲":"木","乙":"木","丙":"火","丁":"火","戊":"土","己":"土","庚":"金","辛":"金","壬":"水","癸":"水"},
   887→  "threshold": {"strong": 2, "weak": -2}
   888→}'::jsonb),
   889→('RULE-SHENSHA-TAOHUA-V1', 'bazi_shensha', '桃花（咸池）', '{
   890→  "group_map": {"申子辰":"酉","亥卯未":"子","寅午戌":"卯","巳酉丑":"午"},
   891→  "basis": "year_or_day_branch"
   892→}'::jsonb),
   893→('RULE-SHENSHA-YIMA-V1', 'bazi_shensha', '驿马', '{
   894→  "group_map": {"申子辰":"寅","亥卯未":"巳","寅午戌":"申","巳酉丑":"亥"},
   895→  "basis": "year_or_day_branch"
   896→}'::jsonb),
   897→('RULE-SHENSHA-HUAGAI-V1', 'bazi_shensha', '华盖', '{
   898→  "group_map": {"申子辰":"辰","亥卯未":"未","寅午戌":"戌","巳酉丑":"丑"},
   899→  "basis": "year_or_day_branch"
   900→}'::jsonb),
   901→('RULE-SHENSHA-TIANYI-V1', 'bazi_shensha', '天乙贵人', '{
   902→  "day_gan_map": {"甲":["丑","未"],"戊":["丑","未"],"庚":["丑","未"],"乙":["子","申"],"己":["子","申"],"丙":["亥","酉"],"丁":["亥","酉"],"辛":["寅","午"],"壬":["卯","巳"],"癸":["卯","巳"]}
   903→}'::jsonb),
   904→('RULE-SHENSHA-WENCHANG-V1', 'bazi_shensha', '文昌', '{
   905→  "day_gan_map": {"甲":["巳","午"],"乙":["巳","午"],"丙":["申","酉"],"丁":["申","酉"],"戊":["申","酉"],"己":["申","酉"],"庚":["亥","子"],"辛":["亥","子"],"壬":["寅","卯"],"癸":["寅","卯"]}
   906→}'::jsonb)
   907→ON CONFLICT (rule_id) DO UPDATE SET
   908→  category = EXCLUDED.category,
   909→  name = EXCLUDED.name,
   910→  body = EXCLUDED.body,
   911→  updated_at = now();
   912→```
   913→
   914→### 6.12 外部任务映射（报告 Job：backend=cli|gemini）
   915→
   916→目标：Fortune AI 的业务闭环与权限在 `fortune_ai` 库内完成；报告生成的执行与状态可来自 `backend=cli|gemini`，本表负责在两者之间建立“用户 ↔ provider_job_id”的可审计映射。
   917→
   918→```sql
   919→CREATE TABLE IF NOT EXISTS fortune_external_job (
   920→  id BIGSERIAL PRIMARY KEY,
   921→  user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
   922→  session_id UUID REFERENCES fortune_conversation_session(session_id) ON DELETE SET NULL,
   923→  provider TEXT NOT NULL CHECK (provider IN ('cli','gemini')),
   924→  job_type TEXT NOT NULL CHECK (job_type IN ('bazi_report')),
   925→  provider_job_id BIGINT NOT NULL,
   926→  status TEXT NOT NULL CHECK (status IN ('processing','completed','error')),
   927→  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   928→  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
   929→  last_polled_at TIMESTAMPTZ,
   930→  output_url TEXT NOT NULL DEFAULT '',
   931→  output_a2ui JSONB,
   932→  error TEXT NOT NULL DEFAULT '',
   933→  UNIQUE (provider, provider_job_id)
   934→);
   935→CREATE INDEX IF NOT EXISTS idx_external_job_user_time ON fortune_external_job (user_id, created_at DESC);
   936→CREATE INDEX IF NOT EXISTS idx_external_job_status ON fortune_external_job (status, updated_at DESC);
   937→```
   938→
   939→---
   940→
   941→## 7. API 设计（统一命名，直接实现）
   942→
   943→### 7.0 认证与通用约定（必须）
   944→
   945→**无游客模式**
   946→- 只有以下接口不需要登录：
   947→  - `POST /api/auth/register`
   948→  - `POST /api/auth/login`
   949→- 其余所有接口都要求有效登录态，否则返回 `401`。
   950→
   951→**登录态（Cookie 会话）**
   952→- Cookie：
   953→  - `fortune_session`：`base64url` 随机 token（HttpOnly，`SameSite=Lax`，`Path=/`）
   954→  - `fortune_csrf`：随机 CSRF token（非 HttpOnly，`SameSite=Lax`，`Path=/`）
   955→- 服务端校验：
   956→  - `fortune_session` → `sha256(token)` 匹配 `fortune_user_session.token_hash`，且 `revoked_at IS NULL AND expires_at > now()`
   957→  - 对所有 `POST/PUT/DELETE`：要求请求头 `X-CSRF-Token`，其 `sha256` 必须匹配 `fortune_user_session.csrf_token_hash`
   958→
   959→**统一响应结构**
   960→
   961→成功：
   962→```json
   963→{"ok": true, "data": {}}
   964→```
   965→
   966→失败：
   967→```json
   968→{"ok": false, "error": {"code": "invalid_request", "message": "missing_field: birthday_local", "detail": {"field": "birthday_local"}}}
   969→```
   970→
   971→### 7.1 认证与用户管理
   972→
   973→`POST /api/auth/register`（注册即登录）
   974→
   975→请求：
   976→```json
   977→{
   978→  "email": "zhangsan@example.com",
   979→  "password": "S3curePassw0rd!",
   980→  "name": "张三",
   981→  "gender": "男",
   982→  "birthday_local": "1990-05-12 14:00:00",
   983→  "tz_offset_hours": 8.0,
   984→  "location": {"name": "北京", "longitude": 116.4074, "latitude": 39.9042}
   985→}
   986→```
   987→
   988→行为：
   989→- 创建 `fortune_user`（`email` 统一转小写存储；`password_hash` 使用 bcrypt）
   990→- upsert `fortune_user_preferences`（默认 `persona_style=warm`）
   991→- 创建会话：插入 `fortune_user_session`，下发 `fortune_session` 与 `fortune_csrf` Cookie
   992→- 计算并写入 `fortune_bazi_snapshot`（`compute_version=bazi-tts-v1`）
   993→
   994→响应：
   995→```json
   996→{
   997→  "ok": true,
   998→  "data": {
   999→    "user_id": 123,
  1000→    "email": "zhangsan@example.com",
  1001→    "profile_summary": {"name": "张三", "gender": "男", "location_name": "北京"}
  1002→  }
  1003→}
  1004→```
  1005→
  1006→`POST /api/auth/login`
  1007→
  1008→请求：
  1009→```json
  1010→{"email":"zhangsan@example.com","password":"S3curePassw0rd!"}
  1011→```
  1012→
  1013→行为：
  1014→- 校验密码（bcrypt）
  1015→- 更新 `fortune_user.last_login_at`
  1016→- 创建 `fortune_user_session` 并下发 Cookie
  1017→
  1018→响应：
  1019→```json
  1020→{"ok": true, "data": {"user_id": 123, "email": "zhangsan@example.com", "name": "张三"}}
  1021→```
  1022→
  1023→`GET /api/auth/me`
  1024→
  1025→响应：
  1026→```json
  1027→{"ok": true, "data": {"user_id": 123, "email": "zhangsan@example.com", "name": "张三", "persona_style": "warm"}}
  1028→```
  1029→
  1030→`POST /api/auth/logout`
  1031→- 行为：将当前 `fortune_user_session.revoked_at = now()`，并清空 Cookie
  1032→
  1033→`GET /api/auth/sessions`
  1034→响应：
  1035→```json
  1036→{
  1037→  "ok": true,
  1038→  "data": {
  1039→    "sessions": [
  1040→      {"session_id":"a9c55f2f-2d2b-4f02-9c35-7f5a0d6d9a1c","created_at":"2025-12-29T10:00:00Z","expires_at":"2026-01-28T10:00:00Z","ip":"106.37.170.238","user_agent":"Mozilla/5.0"}
  1041→    ]
  1042→  }
  1043→}
  1044→```
  1045→
  1046→`POST /api/auth/logout-all`
  1047→- 行为：将该用户所有未过期 session 标记 `revoked_at = now()`，并清空当前 Cookie
  1048→
  1049→`PUT /api/auth/password`
  1050→
  1051→请求：
  1052→```json
  1053→{"old_password":"S3curePassw0rd!","new_password":"N3wS3curePassw0rd!"}
  1054→```
  1055→
  1056→行为：
  1057→- 校验旧密码 → 更新 `fortune_user.password_hash`
  1058→- 退出所有登录态：`logout-all`
  1059→
  1060→`DELETE /api/auth/account`
  1061→
  1062→请求：
  1063→```json
  1064→{"password":"N3wS3curePassw0rd!"}
  1065→```
  1066→
  1067→行为：
  1068→- 校验密码 → `fortune_user.deleted_at = now()`
  1069→- 退出所有登录态：`logout-all`
  1070→
  1071→### 7.2 用户资料（Profile）
  1072→
  1073→`GET /api/user/profile`
  1074→
  1075→响应：
  1076→```json
  1077→{
  1078→  "ok": true,
  1079→  "data": {
  1080→    "profile": {
  1081→      "name": "张三",
  1082→      "gender": "男",
  1083→      "birthday_local": "1990-05-12 14:00:00",
  1084→      "tz_offset_hours": 8.0,
  1085→      "location": {"name": "北京", "longitude": 116.4074, "latitude": 39.9042}
  1086→    },
  1087→    "preferences": {"persona_style":"warm","push_enabled":true,"push_time":"08:00:00","quiet_hours_start":"22:00:00","quiet_hours_end":"07:00:00"}
  1088→  }
  1089→}
  1090→```
  1091→
  1092→`PUT /api/user/profile`（更新出生信息会触发重算）
  1093→
  1094→请求：
  1095→```json
  1096→{
  1097→  "name": "张三",
  1098→  "gender": "男",
  1099→  "birthday_local": "1990-05-12 13:50:00",
  1100→  "tz_offset_hours": 8.0,
  1101→  "location": {"name": "北京", "longitude": 116.4074, "latitude": 39.9042}
  1102→}
  1103→```
  1104→
  1105→行为：
  1106→- 更新 `fortune_user` 的 Profile 字段
  1107→- 写入新的 `fortune_bazi_snapshot`（重算并生成新 `facts_hash`）
  1108→
  1109→### 7.3 会话
  1110→
  1111→`POST /api/session/new`
  1112→```json
  1113→{"title": "新对话"}
  1114→```
  1115→
  1116→响应：
  1117→```json
  1118→{"ok": true, "data": {"session_id": "5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d", "title": "新对话"}}
  1119→```
  1120→
  1121→`GET /api/session/list`
  1122→```json
  1123→{"ok": true, "data": {"sessions": [{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","title":"新对话","updated_at":"2025-12-29T10:00:00Z","preview":"我最近很焦虑，工作要不要换？"}]}}
  1124→```
  1125→
  1126→`GET /api/session/{session_id}`
  1127→```json
  1128→{"ok": true, "data": {"messages": [{"role":"user","content":"我最近很焦虑，工作要不要换？"},{"role":"assistant","content":"（已用A2UI返回）","a2ui":{"meta":{"summary":"把问题写清并做最小验证"},"ui_components":[{"type":"markdown_text","title":"输出","data":"### 结论要点\\n- 你现在的焦虑主要来自不确定性与信息过载。\\n\\n### 行动处方（≤3条）\\n1) 用决策模板写清选项/约束（10分钟）\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\n3) 情绪峰值先做3分钟降噪再决策\\n\\n### 承诺\\n你愿意先做哪一个？"}]}}}]}}
  1129→```
  1130→
  1131→### 7.4 Chat（GLM，写入会话 + 生成“建议承诺”）
  1132→
  1133→`POST /api/chat/send`
  1134→
  1135→请求：
  1136→```json
  1137→{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","text":"我最近很焦虑，工作要不要换？"}
  1138→```
  1139→
  1140→行为：
  1141→- 写入 `fortune_conversation_message(role=user)`
  1142→- 读取最新 `fortune_bazi_snapshot` + `fortune_user_preferences` + 计划/承诺/打卡摘要
  1143→- 检索知识库 `bazi_kb_chunk`（FTS + trgm，top-k=12）得到 `kb_refs`
  1144→- 调用 GLM 输出 A2UI（必须含 actions）
  1145→- 写入 `fortune_conversation_message(role=assistant, a2ui=GLM输出的A2UI JSON)`
  1146→- 将 A2UI 中的处方写入 `fortune_commitment(status=suggested, source=chat, card_id=card.card_id)`
  1147→
  1148→响应：
  1149→```json
  1150→{"ok": true, "data": {"assistant_message": {"role":"assistant","a2ui":{"meta":{"summary":"先把问题写清，再做最小验证"},"ui_components":[{"type":"markdown_text","title":"输出","data":"### 结论要点\\n- 你现在的焦虑主要来自不确定性与信息过载。\\n\\n### 行动处方（≤3条）\\n1) 用决策模板写清选项/约束（10分钟）\\n2) 48小时内做一次最小验证（找1位同行聊15分钟）\\n3) 情绪峰值先做3分钟降噪再决策\\n\\n### 承诺\\n你愿意先做哪一个？"},{"type":"action_buttons","title":"下一步","data":[{"label":"生成决策模板","action":{"type":"open_panel","panel":"decision_brief"}},{"label":"开始行动1","action":{"type":"accept_task","task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1"}}]}]}},"suggested_tasks":[{"task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1","title":"用决策模板写清选项/约束（10分钟）"}]}}
  1151→```
  1152→
  1153→### 7.5 Bento（非语言交互）
  1154→
  1155→`GET /api/bento/today`
  1156→- 返回今日指引卡；并 upsert `fortune_daily_guidance(user_id, today)`
  1157→
  1158→`POST /api/bento/checkin`
  1159→```json
  1160→{"mood":"焦虑","intensity":7,"note":"总担心选错"}
  1161→```
  1162→- 写入 `fortune_checkin`
  1163→- 返回一个“调节动作” + card（并带 actions 以便生成承诺）
  1164→
  1165→`POST /api/bento/commitment/accept`
  1166→```json
  1167→{"task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1","due_at":"2025-12-29T13:00:00Z"}
  1168→```
  1169→- 将该 task 从 `suggested` 变为 `active`，写入 `accepted_at`
  1170→
  1171→`POST /api/bento/commitment/done`
  1172→```json
  1173→{"task_id":"4aa0f0e2-acde-4e2f-acde-0c3c0d9610e1","note":"已完成，感觉更清晰了"}
  1174→```
  1175→- `status=done`，写 `done_at`
  1176→
  1177→`POST /api/bento/decision-brief`
  1178→```json
  1179→{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","topic":"是否换工作","options":["留下","跳槽"],"constraints":["经济压力","学习成本"],"time_horizon_days":30}
  1180→```
  1181→
  1182→`POST /api/bento/script`
  1183→```json
  1184→{"session_id":"5bfa6d4f-2b4b-4f6f-8a5c-4f6d9a1e5a0d","scenario":"和领导谈涨薪","tone":"professional","constraints":["不引战","清晰边界"],"length":"short"}
  1185→```
  1186→
  1187→`POST /api/bento/reflect`
  1188→```json
  1189→{"period":"weekly","reflection_date":"2025-12-29","input":{"wins":["按计划完成了2分钟习惯"],"pain_points":["中途差点放弃"],"next_week_focus":["把触发器固定到刷牙后"]}}
  1190→```
  1191→
  1192→### 7.6 计划（固定 4 个）
  1193→
  1194→`GET /api/plan/list`：返回 `fortune_plan`
  1195→
  1196→`POST /api/plan/join`
  1197→```json
  1198→{"plan_id":"habit_30","start_date":"2025-12-29"}
  1199→```
  1200→
  1201→`POST /api/plan/record`
  1202→```json
  1203→{"plan_id":"habit_30","day_no":1,"completed":true,"note":"完成2分钟版本"}
  1204→```
  1205→
  1206→### 7.7 偏好与推送
  1207→
  1208→`GET /api/user/preferences`：读取 `fortune_user_preferences`
  1209→
  1210→`PUT /api/user/preferences`
  1211→```json
  1212→{"persona_style":"warm","push_enabled":true,"push_time":"08:00:00","quiet_hours_start":"22:00:00","quiet_hours_end":"07:00:00"}
  1213→```
  1214→
  1215→`POST /api/push/pause`
  1216→```json
  1217→{"push_enabled": false}
  1218→```
  1219→
  1220→### 7.8 八字深度报告（backend=cli|gemini）
  1221→
  1222→定位：作为 `工具` Tab 的可选能力（长文报告、阅读模式），不影响主闭环（主闭环用 GLM）。
  1223→
  1224→**边界（DB 使用）**
  1225→- Fortune AI 业务数据与权限控制：`fortune_ai`（本项目所有表）
  1226→- `backend=cli`：调用 `cli_worker` 执行与状态查询（不访问 `gemini` DB）
  1227→- `backend=gemini`：复用现有 gemini job/task 流程（仅此处会访问 `gemini` DB，见 `.env.example` 的 `GEMINI_DB_*`）
  1228→
  1229→**对外 API（绑定登录用户，权限可控）**
  1230→
  1231→`POST /api/report/bazi/submit`
  1232→
  1233→请求：
  1234→```json
  1235→{"backend":"cli","model":"deep_research","system_prompt":"你是一个八字大师，请以建设性、可执行的方式输出。"}
  1236→```
  1237→
  1238→行为：
  1239→- 从 `fortune_user` 读取该用户的出生信息（不允许前端随意覆盖）
  1240→- 默认 `backend=cli`：调用 `cli_worker` 执行链路提交与轮询任务
  1241→- 当 `backend=gemini`：调用现有报告引擎（内部仍走 `/api/v2/submit` 与 `task_service.submit_bazi_task_v2` 的逻辑）
  1242→- 在 `fortune_ai` 写入 `fortune_external_job` 记录（user_id ↔ provider_job_id ↔ backend ↔ session_id 可选）
  1243→
  1244→响应：
  1245→```json
  1246→{"ok": true, "data": {"job_id": 101, "backend": "cli", "status": "processing"}}
  1247→```
  1248→
  1249→`GET /api/report/bazi/{job_id}?backend=cli|gemini`
  1250→
  1251→响应（processing）：
  1252→```json
  1253→{"ok": true, "data": {"job_id": 101, "backend": "cli", "status": "processing"}}
  1254→```
  1255→
  1256→响应（completed）：
  1257→```json
  1258→{"ok": true, "data": {"job_id": 101, "backend": "cli", "status": "completed", "a2ui": {"meta": {"summary": "八字深度报告"}, "ui_components": [{"type": "markdown_text", "title": "模型输出", "data": "### 结论要点\\n- 你属于偏火土的结构，做事更适合先定节奏再推进。\\n\\n### 行动处方（≤3条）\\n1) 本周只做一个最小目标（写清楚并公开承诺）\\n2) 每天固定一个30分钟深度专注块\\n3) 情绪上头时先做3分钟降噪再沟通"}]}}}
  1259→```
  1260→
  1261→**内部保留接口（不建议前端直接调用）**
  1262→- `POST /api/v2/submit`
  1263→- `GET /api/v2/report/{job_id}`
  1264→
  1265→---
  1266→
  1267→## 8. 主动服务（Push）实现（订阅制、可审计）
  1268→
  1269→### 8.1 触发与频控（固定）
  1270→
  1271→| push_type | 触发 | 频率上限 |
  1272→|---|---|---:|
  1273→| `plan_daily` | 用户加入任一计划后，每日到点 | 每日 1 次 |
  1274→| `weekly_reflection` | 每周固定一天到点 | 每周 1 次 |
  1275→| `milestone` | streak/毕业/关键里程碑 | 达成即推 |
  1276→
  1277→### 8.2 发送规则（执行时检查）
  1278→
  1279→发送前必须同时满足：
  1280→- `fortune_user_preferences.push_enabled = true`
  1281→- 不在静默时段
  1282→- 同类 push 当日未发送过（以 `fortune_push_event` 去重）
  1283→
  1284→---
  1285→
  1286→## 9. 验收（可运行、可统计、可回放）
  1287→
  1288→### 9.1 事件口径（WCG）
  1289→
  1290→| 事件 | 写入表 | 判定 |
  1291→|---|---|---|
  1292→| trigger | `fortune_push_event` / `fortune_conversation_message` | 用户打开/点击/发起 |
  1293→| guidance_shown | `fortune_daily_guidance` / message.a2ui | 已展示 card |
  1294→| commitment_made | `fortune_commitment` | `accepted_at IS NOT NULL` |
  1295→| action_done | `fortune_commitment.status='done'` | 完成 ≥1 |
  1296→| feedback | `fortune_checkin` / `fortune_reflection` | 有打卡/复盘 |
  1297→
  1298→### 9.2 关键验收标准
  1299→
  1300→- 三点击路径全部可走通（今日指引/情绪打卡/决策模板/话术生成）
  1301→- 每次 Chat 输出都有 `commitment_ask` 与可点击 `actions`
  1302→- 任何负面提示都包含“你可以做什么”的行动处方
  1303→- 所有输出可追溯：`facts_hash + kb_refs + rule_ids`
  1304→
  1305→---
  1306→
  1307→## 10. 4 周交付计划（Final MVP）
  1308→
  1309→1) Week 1：PostgreSQL schema（fortune_ai）+ 登录/会话（注册/登录/用户管理）+ 会话/消息 SSOT + `/login`/`/register`/`/main` 路由落地  
  1310→2) Week 2：八字事实完整版（facts + facts_hash）+ 知识库入库脚本（PDF→chunk→PG）+ 检索接口  
  1311→3) Week 3：GLM 对话 `/api/chat/send` + Guidance Card/A2UI 输出 + Bento 6 卡片 API  
  1312→4) Week 4：计划（4 个预设）+ Push 调度器（写 `fortune_push_event`）+ WCG 指标统计与回放  
  1313→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
