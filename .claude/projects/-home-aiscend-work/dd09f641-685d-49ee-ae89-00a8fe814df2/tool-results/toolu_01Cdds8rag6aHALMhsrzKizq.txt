     1→-- Fortune AI Goal & Enhanced Reflection Schema
     2→-- Date: 2026-01-01
     3→-- Purpose: Add Goal setting module and enhance Reflection for complete OS loop
     4→
     5→-- =============================================================================
     6→-- 1. Goal Setting Module (目标设定)
     7→-- REQ: os_design_claude_mvp v1.md §3
     8→-- =============================================================================
     9→
    10→CREATE TABLE IF NOT EXISTS fortune_goal (
    11→    goal_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    12→    user_id BIGINT NOT NULL REFERENCES fortune_user(user_id) ON DELETE CASCADE,
    13→    parent_goal_id UUID REFERENCES fortune_goal(goal_id) ON DELETE SET NULL,
    14→    type TEXT NOT NULL CHECK (type IN ('annual','quarterly','monthly','weekly')),
    15→    title TEXT NOT NULL,
    16→    outcome_measure TEXT,
    17→    lead_measures JSONB DEFAULT '[]',
    18→    assumptions JSONB DEFAULT '[]',
    19→    dimension TEXT DEFAULT 'mixed' CHECK (dimension IN ('cognition','time','capital','mixed')),
    20→    checkpoints JSONB DEFAULT '[]',
    21→    status TEXT DEFAULT 'active' CHECK (status IN ('active','achieved','abandoned','revised')),
    22→    created_at TIMESTAMPTZ DEFAULT NOW(),
    23→    updated_at TIMESTAMPTZ DEFAULT NOW()
    24→);
    25→
    26→CREATE INDEX IF NOT EXISTS idx_goal_user_status ON fortune_goal(user_id, status);
    27→CREATE INDEX IF NOT EXISTS idx_goal_parent ON fortune_goal(parent_goal_id) WHERE parent_goal_id IS NOT NULL;
    28→CREATE INDEX IF NOT EXISTS idx_goal_type ON fortune_goal(user_id, type, created_at DESC);
    29→
    30→-- =============================================================================
    31→-- 2. Goal-Commitment Link (目标-任务关联)
    32→-- =============================================================================
    33→
    34→-- Add goal_id to fortune_commitment if not exists
    35→DO $$
    36→BEGIN
    37→    IF NOT EXISTS (
    38→        SELECT 1 FROM information_schema.columns
    39→        WHERE table_name = 'fortune_commitment' AND column_name = 'goal_id'
    40→    ) THEN
    41→        ALTER TABLE fortune_commitment ADD COLUMN goal_id UUID REFERENCES fortune_goal(goal_id) ON DELETE SET NULL;
    42→        CREATE INDEX IF NOT EXISTS idx_commitment_goal ON fortune_commitment(goal_id) WHERE goal_id IS NOT NULL;
    43→    END IF;
    44→END $$;
    45→
    46→-- =============================================================================
    47→-- 3. Enhanced Reflection Table (增强版复盘)
    48→-- REQ: os_design_claude_mvp v1.md §4
    49→-- =============================================================================
    50→
    51→-- Check if fortune_reflection exists and migrate to new schema
    52→DO $$
    53→BEGIN
    54→    -- If the table exists but lacks new columns, add them
    55→    IF EXISTS (
    56→        SELECT 1 FROM information_schema.tables
    57→        WHERE table_name = 'fortune_reflection'
    58→    ) THEN
    59→        -- Add new columns if they don't exist
    60→        IF NOT EXISTS (
    61→            SELECT 1 FROM information_schema.columns
    62→            WHERE table_name = 'fortune_reflection' AND column_name = 'four_questions'
    63→        ) THEN
    64→            ALTER TABLE fortune_reflection
    65→                ADD COLUMN IF NOT EXISTS period_start DATE,
    66→                ADD COLUMN IF NOT EXISTS period_end DATE,
    67→                ADD COLUMN IF NOT EXISTS related_goal_id UUID REFERENCES fortune_goal(goal_id) ON DELETE SET NULL,
    68→                ADD COLUMN IF NOT EXISTS facts JSONB DEFAULT '{}',
    69→                ADD COLUMN IF NOT EXISTS decision_review JSONB DEFAULT '{}',
    70→                ADD COLUMN IF NOT EXISTS four_questions JSONB DEFAULT '{}',
    71→                ADD COLUMN IF NOT EXISTS upgrades JSONB DEFAULT '{}',
    72→                ADD COLUMN IF NOT EXISTS next_focus TEXT;
    73→
    74→            -- Migrate existing data: set period_start/end from reflection_date
    75→            UPDATE fortune_reflection
    76→            SET period_start = reflection_date,
    77→                period_end = reflection_date
    78→            WHERE period_start IS NULL AND reflection_date IS NOT NULL;
    79→
    80→            -- Set defaults for remaining nulls
    81→            UPDATE fortune_reflection
    82→            SET period_start = COALESCE(period_start, created_at::date),
    83→                period_end = COALESCE(period_end, created_at::date);
    84→
    85→            -- Now make period_start/end NOT NULL
    86→            ALTER TABLE fortune_reflection ALTER COLUMN period_start SET NOT NULL;
    87→            ALTER TABLE fortune_reflection ALTER COLUMN period_end SET NOT NULL;
    88→        END IF;
    89→
    90→        -- Update type check constraint if needed (period -> type)
    91→        IF EXISTS (
    92→            SELECT 1 FROM information_schema.columns
    93→            WHERE table_name = 'fortune_reflection' AND column_name = 'period'
    94→        ) AND NOT EXISTS (
    95→            SELECT 1 FROM information_schema.columns
    96→            WHERE table_name = 'fortune_reflection' AND column_name = 'type'
    97→        ) THEN
    98→            ALTER TABLE fortune_reflection RENAME COLUMN period TO type;
    99→        END IF;
   100→
   101→        -- Add 'monthly' and 'checkpoint' to type check if needed
   102→        -- Drop and recreate constraint
   103→        ALTER TABLE fortune_reflection DROP CONSTRAINT IF EXISTS fortune_reflection_period_check;
   104→        ALTER TABLE fortune_reflection DROP CONSTRAINT IF EXISTS fortune_reflection_type_check;
   105→        ALTER TABLE fortune_reflection ADD CONSTRAINT fortune_reflection_type_check
   106→            CHECK (type IN ('daily','weekly','monthly','checkpoint'));
   107→    END IF;
   108→END $$;
   109→
   110→-- Create index on reflection type and user
   111→CREATE INDEX IF NOT EXISTS idx_reflection_user_type ON fortune_reflection(user_id, type, period_start DESC);
   112→CREATE INDEX IF NOT EXISTS idx_reflection_goal ON fortune_reflection(related_goal_id) WHERE related_goal_id IS NOT NULL;
   113→
   114→-- =============================================================================
   115→-- 4. User Onboarding Status (新用户豁免)
   116→-- =============================================================================
   117→
   118→-- Add onboarding_completed to fortune_user if not exists
   119→DO $$
   120→BEGIN
   121→    IF NOT EXISTS (
   122→        SELECT 1 FROM information_schema.columns
   123→        WHERE table_name = 'fortune_user' AND column_name = 'onboarding_completed'
   124→    ) THEN
   125→        ALTER TABLE fortune_user ADD COLUMN onboarding_completed BOOLEAN DEFAULT FALSE;
   126→    END IF;
   127→END $$;
   128→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
