     1→"""
     2→Insight Generator - Generate personalized insights
     3→"""
     4→from typing import Optional, List, Dict, Any
     5→from datetime import datetime, timedelta
     6→from uuid import UUID
     7→from dataclasses import dataclass
     8→from enum import Enum
     9→
    10→from stores import SkillRepository
    11→
    12→
    13→class InsightType(Enum):
    14→    """4 types of insights"""
    15→    DISCOVERY = "discovery"   # "I see in you..."
    16→    PATTERN = "pattern"       # "I notice a pattern..."
    17→    TIMING = "timing"         # "Now is a good time for..."
    18→    GROWTH = "growth"         # "Your growth..."
    19→
    20→
    21→@dataclass
    22→class InsightTrigger:
    23→    """Trigger condition for insight"""
    24→    should_trigger: bool
    25→    insight_type: InsightType
    26→    confidence: float
    27→    evidence: Dict[str, Any]
    28→    title: Optional[str] = None
    29→    content: Optional[str] = None
    30→
    31→
    32→class InsightGenerator:
    33→    """
    34→    Generates personalized insights based on patterns, timing, and user data.
    35→    """
    36→
    37→    # ─────────────────────────────────────────────────────────────────
    38→    # Trigger Rules Configuration
    39→    # ─────────────────────────────────────────────────────────────────
    40→
    41→    DISCOVERY_TRIGGERS = {
    42→        "first_mention": 0.3,       # First time mentioning topic
    43→        "strong_emotion": 0.4,      # High intensity emotion
    44→        "important_topic": 0.3      # Topic matches important category
    45→    }
    46→
    47→    PATTERN_TRIGGERS = {
    48→        "min_occurrences": 3,       # Minimum times to see pattern
    49→        "similar_context": 0.7,     # Context similarity threshold
    50→        "time_span_days": 30        # Within this many days
    51→    }
    52→
    53→    TIMING_TRIGGERS = {
    54→        "fortune_event": True,      # Triggered by calendar event
    55→        "energy_peak": 0.8,         # User energy above threshold
    56→        "user_readiness": 0.7       # Assessed readiness
    57→    }
    58→
    59→    GROWTH_TRIGGERS = {
    60→        "behavior_change": 0.3,     # Detected change in behavior
    61→        "milestone": True,          # Reached a milestone
    62→        "comparison_period_days": 90
    63→    }
    64→
    65→    # Cooldown periods (hours)
    66→    COOLDOWN = {
    67→        InsightType.DISCOVERY: 24,
    68→        InsightType.PATTERN: 72,
    69→        InsightType.TIMING: 48,
    70→        InsightType.GROWTH: 168  # 1 week
    71→    }
    72→
    73→    # Minimum confidence to trigger
    74→    MIN_CONFIDENCE = 0.7
    75→
    76→    # ─────────────────────────────────────────────────────────────────
    77→    # Insight Title Templates
    78→    # ─────────────────────────────────────────────────────────────────
    79→
    80→    TITLES = {
    81→        InsightType.DISCOVERY: [
    82→            "我看见你...",
    83→            "我注意到一些特别的...",
    84→            "关于你，我发现...",
    85→        ],
    86→        InsightType.PATTERN: [
    87→            "我注意到一个模式...",
    88→            "我发现了一个规律...",
    89→            "有个有趣的模式...",
    90→        ],
    91→        InsightType.TIMING: [
    92→            "现在是...的好时机",
    93→            "时机来了...",
    94→            "这个时刻很特别...",
    95→        ],
    96→        InsightType.GROWTH: [
    97→            "你的成长...",
    98→            "我看到了变化...",
    99→            "回顾你的旅程...",
   100→        ]
   101→    }
   102→
   103→    # ─────────────────────────────────────────────────────────────────
   104→    # Check Methods
   105→    # ─────────────────────────────────────────────────────────────────
   106→
   107→    @classmethod
   108→    async def check_discovery_trigger(
   109→        cls,
   110→        user_id: UUID,
   111→        skill_id: str,
   112→        message: str,
   113→        emotion_result=None,
   114→        topics: Optional[List[str]] = None
   115→    ) -> InsightTrigger:
   116→        """Check if DISCOVERY insight should be triggered"""
   117→        confidence = 0.0
   118→        evidence = {}
   119→
   120→        # Check for strong emotion
   121→        if emotion_result and emotion_result.intensity > 0.7:
   122→            confidence += cls.DISCOVERY_TRIGGERS["strong_emotion"]
   123→            evidence["strong_emotion"] = {
   124→                "emotion": emotion_result.primary.value,
   125→                "intensity": emotion_result.intensity
   126→            }
   127→
   128→        # Check for important topics (simplified)
   129→        important_keywords = ["人生", "未来", "感情", "事业", "健康", "家庭"]
   130→        for kw in important_keywords:
   131→            if kw in message:
   132→                confidence += cls.DISCOVERY_TRIGGERS["important_topic"]
   133→                evidence["important_topic"] = kw
   134→                break
   135→
   136→        # Check if topic is first mentioned (would need topic tracking)
   137→        # For now, add small base confidence
   138→        confidence += 0.1
   139→
   140→        should_trigger = confidence >= cls.MIN_CONFIDENCE
   141→
   142→        return InsightTrigger(
   143→            should_trigger=should_trigger,
   144→            insight_type=InsightType.DISCOVERY,
   145→            confidence=min(1.0, confidence),
   146→            evidence=evidence
   147→        )
   148→
   149→    @classmethod
   150→    async def check_pattern_trigger(
   151→        cls,
   152→        user_id: UUID,
   153→        skill_id: str,
   154→        recent_messages: List[Dict[str, Any]],
   155→        recent_insights: List[Dict[str, Any]]
   156→    ) -> InsightTrigger:
   157→        """Check if PATTERN insight should be triggered"""
   158→        confidence = 0.0
   159→        evidence = {}
   160→
   161→        # Count repeated themes/emotions in recent messages
   162→        emotion_counts = {}
   163→        topic_counts = {}
   164→
   165→        for msg in recent_messages:
   166→            if "emotion" in msg:
   167→                emotion = msg["emotion"]
   168→                emotion_counts[emotion] = emotion_counts.get(emotion, 0) + 1
   169→
   170→        # Check for patterns
   171→        for emotion, count in emotion_counts.items():
   172→            if count >= cls.PATTERN_TRIGGERS["min_occurrences"]:
   173→                confidence += 0.4
   174→                evidence["repeated_emotion"] = {
   175→                    "emotion": emotion,
   176→                    "count": count
   177→                }
   178→
   179→        should_trigger = confidence >= cls.MIN_CONFIDENCE
   180→
   181→        return InsightTrigger(
   182→            should_trigger=should_trigger,
   183→            insight_type=InsightType.PATTERN,
   184→            confidence=min(1.0, confidence),
   185→            evidence=evidence
   186→        )
   187→
   188→    @classmethod
   189→    async def check_timing_trigger(
   190→        cls,
   191→        user_id: UUID,
   192→        skill_id: str,
   193→        current_events: Optional[List[Dict[str, Any]]] = None,
   194→        user_energy: Optional[float] = None
   195→    ) -> InsightTrigger:
   196→        """Check if TIMING insight should be triggered"""
   197→        confidence = 0.0
   198→        evidence = {}
   199→
   200→        # Check for fortune events
   201→        if current_events:
   202→            for event in current_events:
   203→                confidence += 0.4
   204→                evidence["fortune_event"] = event
   205→                break
   206→
   207→        # Check user energy
   208→        if user_energy and user_energy >= cls.TIMING_TRIGGERS["energy_peak"]:
   209→            confidence += 0.3
   210→            evidence["high_energy"] = user_energy
   211→
   212→        should_trigger = confidence >= cls.MIN_CONFIDENCE
   213→
   214→        return InsightTrigger(
   215→            should_trigger=should_trigger,
   216→            insight_type=InsightType.TIMING,
   217→            confidence=min(1.0, confidence),
   218→            evidence=evidence
   219→        )
   220→
   221→    @classmethod
   222→    async def check_growth_trigger(
   223→        cls,
   224→        user_id: UUID,
   225→        skill_id: str,
   226→        historical_insights: List[Dict[str, Any]],
   227→        current_state: Optional[Dict[str, Any]] = None
   228→    ) -> InsightTrigger:
   229→        """Check if GROWTH insight should be triggered"""
   230→        confidence = 0.0
   231→        evidence = {}
   232→
   233→        # Check for milestones
   234→        if len(historical_insights) in [10, 25, 50, 100]:
   235→            confidence += 0.5
   236→            evidence["milestone"] = f"{len(historical_insights)} insights reached"
   237→
   238→        # Check for behavioral changes (simplified)
   239→        if current_state:
   240→            confidence += 0.2
   241→
   242→        should_trigger = confidence >= cls.MIN_CONFIDENCE
   243→
   244→        return InsightTrigger(
   245→            should_trigger=should_trigger,
   246→            insight_type=InsightType.GROWTH,
   247→            confidence=min(1.0, confidence),
   248→            evidence=evidence
   249→        )
   250→
   251→    # ─────────────────────────────────────────────────────────────────
   252→    # Cooldown Check
   253→    # ─────────────────────────────────────────────────────────────────
   254→
   255→    @classmethod
   256→    async def check_cooldown(
   257→        cls,
   258→        user_id: UUID,
   259→        skill_id: str,
   260→        insight_type: InsightType
   261→    ) -> bool:
   262→        """Check if insight type is in cooldown period"""
   263→        recent_insights = await SkillRepository.get_user_insights(
   264→            user_id, skill_id,
   265→            insight_type=insight_type.value,
   266→            limit=1
   267→        )
   268→
   269→        if not recent_insights:
   270→            return False  # No cooldown
   271→
   272→        last_insight_time = recent_insights[0]["created_at"]
   273→        cooldown_hours = cls.COOLDOWN[insight_type]
   274→        cooldown_end = last_insight_time + timedelta(hours=cooldown_hours)
   275→
   276→        return datetime.utcnow() < cooldown_end
   277→
   278→    # ─────────────────────────────────────────────────────────────────
   279→    # Content Generation
   280→    # ─────────────────────────────────────────────────────────────────
   281→
   282→    @classmethod
   283→    async def generate_insight_content(
   284→        cls,
   285→        trigger: InsightTrigger,
   286→        user_context: Dict[str, Any],
   287→        llm_orchestrator=None
   288→    ) -> tuple[str, str]:
   289→        """Generate insight title and content using LLM"""
   290→        import random
   291→
   292→        # Select title template
   293→        title_templates = cls.TITLES[trigger.insight_type]
   294→        title = random.choice(title_templates)
   295→
   296→        if not llm_orchestrator:
   297→            # Return placeholder content
   298→            return title, f"[需要 LLM 生成内容: {trigger.evidence}]"
   299→
   300→        from .llm_orchestrator import LLMMessage
   301→
   302→        # Build prompt based on insight type
   303→        prompt = cls._build_insight_prompt(
   304→            trigger.insight_type,
   305→            trigger.evidence,
   306→            user_context
   307→        )
   308→
   309→        messages = [LLMMessage(role="user", content=prompt)]
   310→
   311→        response = await llm_orchestrator.chat(
   312→            messages,
   313→            temperature=0.7,
   314→            max_tokens=300
   315→        )
   316→
   317→        return title, response.content
   318→
   319→    @classmethod
   320→    def _build_insight_prompt(
   321→        cls,
   322→        insight_type: InsightType,
   323→        evidence: Dict[str, Any],
   324→        user_context: Dict[str, Any]
   325→    ) -> str:
   326→        """Build prompt for insight content generation"""
   327→        prompts = {
   328→            InsightType.DISCOVERY: f"""你是一个温暖、有洞察力的朋友。
   329→
   330→基于以下发现，生成一段简短的洞察内容（2-3句话）：
   331→证据: {evidence}
   332→用户背景: {user_context}
   333→
   334→以"我看见"或"我注意到"开头，语气温暖、不说教。只输出内容，不要解释。""",
   335→
   336→            InsightType.PATTERN: f"""你是一个善于发现规律的朋友。
   337→
   338→基于以下模式，生成一段简短的洞察内容（2-3句话）：
   339→证据: {evidence}
   340→用户背景: {user_context}
   341→
   342→以"我注意到一个模式"开头，帮助用户觉察，不评判。只输出内容，不要解释。""",
   343→
   344→            InsightType.TIMING: f"""你是一个懂得时机的朋友。
   345→
   346→基于以下时机信息，生成一段简短的建议（2-3句话）：
   347→证据: {evidence}
   348→用户背景: {user_context}
   349→
   350→以"现在"或"这个时候"开头，给出具体可行的建议。只输出内容，不要解释。""",
   351→
   352→            InsightType.GROWTH: f"""你是一个见证成长的朋友。
   353→
   354→基于以下变化，生成一段简短的成长回顾（2-3句话）：
   355→证据: {evidence}
   356→用户背景: {user_context}
   357→
   358→以"回顾"或"我看到"开头，肯定进步，鼓励继续。只输出内容，不要解释。"""
   359→        }
   360→
   361→        return prompts.get(insight_type, prompts[InsightType.DISCOVERY])
   362→
   363→    # ─────────────────────────────────────────────────────────────────
   364→    # Main Entry Point
   365→    # ─────────────────────────────────────────────────────────────────
   366→
   367→    @classmethod
   368→    async def maybe_generate_insight(
   369→        cls,
   370→        user_id: UUID,
   371→        skill_id: str,
   372→        message: str,
   373→        conversation_id: UUID,
   374→        emotion_result=None,
   375→        user_context: Optional[Dict[str, Any]] = None,
   376→        llm_orchestrator=None
   377→    ) -> Optional[Dict[str, Any]]:
   378→        """
   379→        Main entry point - check if insight should be generated and create it.
   380→        Returns insight data or None.
   381→        """
   382→        # Check discovery trigger (most common)
   383→        trigger = await cls.check_discovery_trigger(
   384→            user_id, skill_id, message, emotion_result
   385→        )
   386→
   387→        if trigger.should_trigger:
   388→            # Check cooldown
   389→            if await cls.check_cooldown(user_id, skill_id, trigger.insight_type):
   390→                return None  # In cooldown
   391→
   392→            # Generate content
   393→            title, content = await cls.generate_insight_content(
   394→                trigger,
   395→                user_context or {},
   396→                llm_orchestrator
   397→            )
   398→
   399→            # Save insight
   400→            insight = await SkillRepository.create_insight(
   401→                user_id=user_id,
   402→                skill_id=skill_id,
   403→                insight_type=trigger.insight_type.value,
   404→                title=title,
   405→                content=content,
   406→                evidence=trigger.evidence,
   407→                confidence=trigger.confidence,
   408→                conversation_id=conversation_id
   409→            )
   410→
   411→            return insight
   412→
   413→        return None
   414→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
