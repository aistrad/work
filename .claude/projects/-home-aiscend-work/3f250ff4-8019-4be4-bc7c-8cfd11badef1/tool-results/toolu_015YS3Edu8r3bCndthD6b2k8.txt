The file /home/aiscend/.claude/plans/recursive-crunching-scroll.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   422→1. **不需要在本计划中添加 Insight 沉淀优化** - 这是研究任务，非实现任务
   423→2. 如果需要实现，建议作为 **Phase 15** 独立迭代
   424→3. 优先确保 Phase 14 的部署稳定
   425→
   426→---
   427→
   428→## 7. User Insight 沉淀机制实现计划
   429→
   430→### 7.1 实现概览
   431→
   432→```
   433→┌─────────────────────────────────────────────────────────────────────────────┐
   434→│                         增强后的 Insight 架构                                │
   435→├─────────────────────────────────────────────────────────────────────────────┤
   436→│                                                                              │
   437→│  用户消息                                                                    │
   438→│      │                                                                       │
   439→│      ▼                                                                       │
   440→│  ┌──────────────────┐     ┌──────────────────┐                              │
   441→│  │ TopicExtractor   │────►│user_topic_mentions│ (新表)                      │
   442→│  │  (话题提取)       │     │  (话题追踪)       │                              │
   443→│  └──────────────────┘     └──────────────────┘                              │
   444→│      │                                                                       │
   445→│      ▼                                                                       │
   446→│  ┌──────────────────┐     ┌──────────────────┐                              │
   447→│  │ EmotionTracker   │────►│user_emotion_history│ (新表)                     │
   448→│  │  (情绪追踪)       │     │  (情绪历史)        │                             │
   449→│  └──────────────────┘     └──────────────────┘                              │
   450→│      │                                                                       │
   451→│      ▼                                                                       │
   452→│  ┌──────────────────┐                                                       │
   453→│  │ PatternDetector  │ (新模块)                                              │
   454→│  │  - 首次提及检测                                                          │
   455→│  │  - 话题重复模式                                                          │
   456→│  │  - 情绪变化趋势                                                          │
   457→│  │  - 时间段模式                                                            │
   458→│  └──────────────────┘                                                       │
   459→│      │                                                                       │
   460→│      ▼                                                                       │
   461→│  ┌──────────────────┐     ┌──────────────────┐                              │
   462→│  │InsightGenerator  │────►│  skill_insights   │ (现有表)                    │
   463→│  │   (增强版)        │     │   (洞察存储)      │                              │
   464→│  └──────────────────┘     └──────────────────┘                              │
   465→│                                                                              │
   466→└─────────────────────────────────────────────────────────────────────────────┘
   467→```
   468→
   469→### 7.2 新数据库表
   470→
   471→#### user_topic_mentions (话题提及表)
   472→
   473→```sql
   474→CREATE TABLE user_topic_mentions (
   475→    id UUID PRIMARY KEY,
   476→    user_id UUID REFERENCES vibe_users(id),
   477→    skill_id VARCHAR(50),
   478→    conversation_id UUID,
   479→    message_id UUID,
   480→    topic VARCHAR(100),              -- 归一化话题名
   481→    topic_category VARCHAR(50),      -- 话题分类
   482→    raw_mention TEXT,                -- 原始提及文本
   483→    sentiment VARCHAR(20),           -- positive/negative/neutral
   484→    emotion VARCHAR(50),             -- 关联情绪
   485→    intensity FLOAT,                 -- 提及强度
   486→    mentioned_at TIMESTAMPTZ,
   487→    day_of_week INTEGER,
   488→    hour_of_day INTEGER,
   489→    is_first_mention BOOLEAN,        -- 是否首次提及
   490→    mention_count INTEGER            -- 累计提及次数
   491→);
   492→```
   493→
   494→#### user_emotion_history (情绪历史表)
   495→
   496→```sql
   497→CREATE TABLE user_emotion_history (
   498→    id UUID PRIMARY KEY,
   499→    user_id UUID REFERENCES vibe_users(id),
   500→    skill_id VARCHAR(50),
   501→    conversation_id UUID,
   502→    message_id UUID,
   503→    primary_emotion VARCHAR(50),
   504→    secondary_emotion VARCHAR(50),
   505→    intensity FLOAT,
   506→    confidence FLOAT,
   507→    energy_delta INTEGER,
   508→    triggers TEXT[],
   509→    related_topic VARCHAR(100),
   510→    context_snippet TEXT,
   511→    recorded_at TIMESTAMPTZ,
   512→    day_of_week INTEGER,
   513→    hour_of_day INTEGER
   514→);
   515→```
   516→
   517→### 7.3 新模块文件
   518→
   519→| 文件路径 | 功能 |
   520→|---------|------|
   521→| `migrations/002_insight_tracking.sql` | 新表迁移脚本 |
   522→| `apps/api/services/vibe_engine/topic_extractor.py` | 话题提取器 |
   523→| `apps/api/services/vibe_engine/emotion_tracker.py` | 情绪追踪持久化 |
   524→| `apps/api/services/vibe_engine/pattern_detector.py` | 模式检测器 |
   525→| `apps/api/stores/insight_repo.py` | 数据访问层 |
   526→
   527→### 7.4 InsightGenerator 增强
   528→
   529→**增强方法:**
   530→
   531→| 方法 | 当前实现 | 增强后 |
   532→|------|---------|-------|
   533→| `check_discovery_trigger` | 关键词匹配 | + 首次话题提及检测 |
   534→| `check_pattern_trigger` | 情绪重复计数 | + 话题重复 + 时间模式 + 话题-情绪关联 |
   535→| `check_growth_trigger` | 里程碑检测 | + 情绪趋势对比 + 能量变化分析 |
   536→
   537→### 7.5 AgentRuntime 集成
   538→
   539→```python
   540→# runtime.py 处理流程增强
   541→
   542→async def process_message(...):
   543→    # 1-4. 保留现有流程
   544→
   545→    # 5. 情绪分析
   546→    emotion_result = await EmotionEngine.analyze(message)
   547→
   548→    # 5.1 新增: 话题提取
   549→    extracted_topics = TopicExtractor.extract_topics(message, emotion_result)
   550→
   551→    # 6-7. 响应生成和消息保存
   552→
   553→    # 7.1 新增: 异步持久化追踪数据 (不阻塞响应)
   554→    asyncio.create_task(
   555→        _persist_tracking_data(user_id, skill_id, emotion_result, extracted_topics)
   556→    )
   557→
   558→    # 8. 增强版洞察生成
   559→    insight = await InsightGenerator.maybe_generate_insight_enhanced(
   560→        ..., extracted_topics=extracted_topics
   561→    )
   562→```
   563→
   564→### 7.6 实现优先级
   565→
   566→#### Phase 1: 数据基础 (1-2 天)
   567→- [ ] 创建 `002_insight_tracking.sql` 迁移脚本
   568→- [ ] 创建 `insight_repo.py` 数据访问层
   569→
   570→#### Phase 2: 核心模块 (2-3 天)
   571→- [ ] 实现 `topic_extractor.py`
   572→- [ ] 实现 `emotion_tracker.py`
   573→- [ ] 实现 `pattern_detector.py`
   574→
   575→#### Phase 3: InsightGenerator 增强 (1 天)
   576→- [ ] 增强 `check_discovery_trigger` - 首次提及
   577→- [ ] 增强 `check_pattern_trigger` - 多维模式
   578→- [ ] 增强 `check_growth_trigger` - 趋势对比
   579→
   580→#### Phase 4: 集成与测试 (1 天)
   581→- [ ] 更新 `runtime.py` 集成
   582→- [ ] 添加异步后台处理
   583→- [ ] 单元测试
   584→
   585→**总工作量: 5-7 天**
   586→
   587→### 7.7 关键修改文件
   588→
   589→| 文件 | 修改类型 | 说明 |
   590→|------|---------|------|
   591→| `migrations/002_insight_tracking.sql` | 新增 | 新表定义 |
   592→| `apps/api/stores/insight_repo.py` | 新增 | 数据访问层 |
   593→| `apps/api/services/vibe_engine/topic_extractor.py` | 新增 | 话题提取 |
   594→| `apps/api/services/vibe_engine/emotion_tracker.py` | 新增 | 情绪持久化 |
   595→| `apps/api/services/vibe_engine/pattern_detector.py` | 新增 | 模式检测 |
   596→| `apps/api/services/vibe_engine/insight_generator.py` | 修改 | 增强触发逻辑 |
   597→| `apps/api/services/agent/runtime.py` | 修改 | 集成新模块 |
   598→| `apps/api/services/vibe_engine/__init__.py` | 修改 | 导出新模块 |
   599→| `apps/api/stores/__init__.py` | 修改 | 导出新 repo |
   600→
   601→---
   602→
   603→## 8. 总结
   604→
   605→### 当前状态对照
   606→
   607→| 层 | 组件 | 状态 | 说明 |
   608→|----|------|------|------|
   609→| **Knowledge Layer** | `knowledge_chunks` | ✅ 已实现 | RAG 检索 |
   610→| **User Layer** | `vibe_users` + `skill_profiles` | ✅ 已实现 | 用户基础数据 |
   611→| **Insight Layer** | `skill_insights` 表 | ✅ 基础 | 存储结构已有 |
   612→| **Insight Layer** | `InsightGenerator` | ⚠️ 基础 | 触发规则简单 |
   613→| **Insight Layer** | 话题追踪 | ❌ 缺失 | 需新增 `user_topic_mentions` |
   614→| **Insight Layer** | 情绪历史 | ❌ 缺失 | 需新增 `user_emotion_history` |
   615→| **Insight Layer** | 模式检测 | ❌ 缺失 | 需新增 `PatternDetector` |
   616→
   617→### 本次实现目标
   618→
   619→1. **完善数据基础** - 新增话题追踪和情绪历史表
   620→2. **增强洞察生成** - 多维度触发检测
   621→3. **性能优化** - 异步持久化不阻塞响应
   622→4. **可扩展设计** - 模块化便于后续迭代
   623→
   624→---
   625→
   626→*本文档为 VibeLife User Insight 沉淀机制的完整分析和实现计划。*
   627→