     1→# VibeProfile 架构
     2→
     3→## 1. UserDataSpace 全景
     4→
     5→```
     6→┌─────────────────────────────────────────────────────────────────────────────┐
     7→│                            UserDataSpace                                     │
     8→│                     (用户数据统一管理入口)                                   │
     9→├─────────────────────────────────────────────────────────────────────────────┤
    10→│                                                                              │
    11→│  ┌───────────────────────────────────────────────────────────────────────┐  │
    12→│  │                         VibeProfile (WHO)                              │  │
    13→│  │                         用户画像数据                                   │  │
    14→│  ├───────────────────────────────────────────────────────────────────────┤  │
    15→│  │  unified_profiles.profile (JSONB)                                      │  │
    16→│  │  ├── account      账户信息                                             │  │
    17→│  │  ├── identity     身份信息 (出生信息)                                  │  │
    18→│  │  ├── state        当前状态 (情绪、关注点)                              │  │
    19→│  │  ├── preferences  偏好设置 (含 data_retention)                         │  │
    20→│  │  ├── skill_data   Skill 专属数据                                       │  │
    21→│  │  ├── extracted    对话抽取                                             │  │
    22→│  │  └── life_context 生活上下文 (目标、任务、提醒)                        │  │
    23→│  └───────────────────────────────────────────────────────────────────────┘  │
    24→│                                                                              │
    25→│  ┌──────────────────────┐  ┌──────────────────────┐  ┌─────────────────┐   │
    26→│  │   Operational (WHAT) │  │    Content (WHAT)    │  │ Billing (WHAT)  │   │
    27→│  │   操作数据           │  │    内容快照          │  │ 财务数据        │   │
    28→│  ├──────────────────────┤  ├──────────────────────┤  ├─────────────────┤   │
    29→│  │ conversations        │  │ reports              │  │ subscriptions   │   │
    30→│  │ messages             │  │ relationships        │  │ payments        │   │
    31→│  │ notifications        │  │                      │  │                 │   │
    32→│  │ skill_usage_log      │  │                      │  │                 │   │
    33→│  └──────────────────────┘  └──────────────────────┘  └─────────────────┘   │
    34→│                                                                              │
    35→└─────────────────────────────────────────────────────────────────────────────┘
    36→```
    37→
    38→## 2. VibeProfile 系统架构
    39→
    40→```
    41→┌─────────────────────────────────────────────────────────────────────────────┐
    42→│                              VibeLife System                                 │
    43→├─────────────────────────────────────────────────────────────────────────────┤
    44→│                                                                              │
    45→│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
    46→│   │  Chat API   │  │ Settings API│  │ Proactive   │                         │
    47→│   └──────┬──────┘  └──────┬──────┘  │ Worker      │                         │
    48→│          │                │         └──────┬──────┘                         │
    49→│          ▼                ▼                ▼                                │
    50→│   ┌─────────────────────────────────────────────────────────────────┐       │
    51→│   │                         CoreAgent                                │       │
    52→│   │  ┌──────────────────────────────────────────────────────────┐   │       │
    53→│   │  │                    Skill Services                         │   │       │
    54→│   │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐  │   │       │
    55→│   │  │  │  core  │ │lifecoach││  bazi  │ │ zodiac │ │ tarot  │  │   │       │
    56→│   │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘  │   │       │
    57→│   │  └──────────────────────────────────────────────────────────┘   │       │
    58→│   └─────────────────────────────────┬───────────────────────────────┘       │
    59→│                                     │                                        │
    60→│                                     ▼                                        │
    61→│   ┌─────────────────────────────────────────────────────────────────┐       │
    62→│   │                     VibeProfileRepository                        │       │
    63→│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │       │
    64→│   │  │   get_*     │  │  update_*   │  │   Cache     │              │       │
    65→│   │  └─────────────┘  └─────────────┘  │  (5min TTL) │              │       │
    66→│   │                                     └─────────────┘              │       │
    67→│   └─────────────────────────────────┬───────────────────────────────┘       │
    68→│                                     │                                        │
    69→│                                     ▼                                        │
    70→│   ┌─────────────────────────────────────────────────────────────────┐       │
    71→│   │                       PostgreSQL                                 │       │
    72→│   │  ┌───────────────────────┐  ┌───────────────┐  ┌────────────┐   │       │
    73→│   │  │   unified_profiles    │  │   insights    │  │  timeline  │   │       │
    74→│   │  │   (profile JSONB)     │  │   (Cold)      │  │  (Cold)    │   │       │
    75→│   │  └───────────────────────┘  └───────────────┘  └────────────┘   │       │
    76→│   └─────────────────────────────────────────────────────────────────┘       │
    77→│                                                                              │
    78→└─────────────────────────────────────────────────────────────────────────────┘
    79→```
    80→
    81→## 3. 数据流
    82→
    83→### 3.1 读取流程
    84→
    85→```
    86→请求 ──▶ VibeProfileRepository.get_*() ──▶ Cache命中? ──▶ 返回
    87→                                              │
    88→                                              ▼ miss
    89→                                         SELECT from DB
    90→                                              │
    91→                                              ▼
    92→                                         存入 Cache
    93→                                              │
    94→                                              ▼
    95→                                            返回
    96→```
    97→
    98→### 3.2 写入流程
    99→
   100→```
   101→请求 ──▶ VibeProfileRepository.update_*() ──▶ jsonb_set() ──▶ 失效 Cache
   102→```
   103→
   104→## 4. Skill 访问矩阵
   105→
   106→```
   107→                        VibeProfile
   108→                            │
   109→        ┌───────────────────┼───────────────────┐
   110→        │                   │                   │
   111→        ▼                   ▼                   ▼
   112→   Core Layer         Professional         System
   113→   (全量读/写)        (受限读/写)         (全量读/写)
   114→        │                   │                   │
   115→   ┌────┴────┐         ┌────┴────┐         ┌────┴────┐
   116→   │  core   │         │  bazi   │         │Proactive│
   117→   │lifecoach│         │ zodiac  │         │ Worker  │
   118→   │mindful  │         │  tarot  │         │         │
   119→   └─────────┘         │ career  │         └─────────┘
   120→                       └─────────┘
   121→
   122→Core Layer:    读 全部 / 写 state, extracted
   123→Professional:  读 identity, state / 写 skill_data.{self}
   124→System:        读/写 全部
   125→```
   126→
   127→## 5. Proactive 流程
   128→
   129→```
   130→每天 04:00
   131→    │
   132→    ▼
   133→┌───────────────────────────────────────────────────────────────┐
   134→│                    ProactiveWorker                             │
   135→│                                                                │
   136→│  1. SELECT * FROM unified_profiles                             │
   137→│     WHERE profile->'preferences'->>'push_enabled' = 'true'     │
   138→│                                                                │
   139→│  2. for each user:                                             │
   140→│       - 检查 subscribed_skills                                 │
   141→│       - 为每个 skill 生成今日内容                              │
   142→│       - 存入 notifications 表                                  │
   143→│                                                                │
   144→│  3. 按 push_hour 时间投递                                      │
   145→│                                                                │
   146→└───────────────────────────────────────────────────────────────┘
   147→```
   148→
   149→## 6. 时序图：对话场景
   150→
   151→```
   152→User        ChatAPI      CoreAgent     VibeProfile     BaziSkill     DB
   153→  │            │             │              │              │          │
   154→  │  发消息    │             │              │              │          │
   155→  │ ──────────▶│             │              │              │          │
   156→  │            │  处理       │              │              │          │
   157→  │            │ ───────────▶│              │              │          │
   158→  │            │             │ get_profile  │              │          │
   159→  │            │             │ ────────────▶│              │          │
   160→  │            │             │              │──▶ Cache/DB ─────────▶│
   161→  │            │             │◀─────────────│              │          │
   162→  │            │             │              │              │          │
   163→  │            │             │ 路由到 Bazi  │              │          │
   164→  │            │             │ ────────────────────────────▶│          │
   165→  │            │             │              │              │ 生成回复 │
   166→  │            │             │◀────────────────────────────│          │
   167→  │            │             │              │              │          │
   168→  │            │             │ update_state │              │          │
   169→  │            │             │ ────────────▶│              │          │
   170→  │            │             │              │──▶ UPDATE ───────────▶│
   171→  │            │             │              │              │          │
   172→  │            │◀────────────│              │              │          │
   173→  │◀───────────│             │              │              │          │
   174→```
   175→
   176→## 7. 数据生命周期
   177→
   178→```
   179→┌─────────────────────────────────────────────────────────────────────────────┐
   180→│                          数据生命周期管理                                    │
   181→├─────────────────────────────────────────────────────────────────────────────┤
   182→│                                                                              │
   183→│  领域              默认保留    用户可选           清理规则                   │
   184→│  ─────────────────────────────────────────────────────────────────────────  │
   185→│  VibeProfile       永久        -                  checkins 保留 30 天        │
   186→│  Conversations     1 年        1年 / 3年 / 永久   按 data_retention 设置     │
   187→│  Content           永久        可手动删除         -                          │
   188→│  Billing           7 年        不可更改           法规要求                   │
   189→│  Logs              90 天       -                  滚动清理                   │
   190→│  Notifications     30 天       -                  已读 30 天后清理           │
   191→│                                                                              │
   192→└─────────────────────────────────────────────────────────────────────────────┘
   193→
   194→用户设置路径: preferences.data_retention.conversations = "1y" | "3y" | "forever"
   195→```
   196→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
