     1→# VibeProfile - 用户画像数据层
     2→
     3→> Version: 2.3 | 极简设计 | UserDataSpace 统一管理
     4→> Updated: 2026-01-19
     5→
     6→---
     7→
     8→## 1. 概述
     9→
    10→VibeProfile 是 VibeLife 用户数据的**画像层**，描述用户是谁（WHO）。与操作性数据（WHAT）分离，通过 UserDataSpace 统一管理。
    11→
    12→### 核心概念
    13→
    14→```
    15→┌─────────────────────────────────────────────────────────────────┐
    16→│                        UserDataSpace                             │
    17→├─────────────────────────────────────────────────────────────────┤
    18→│                                                                  │
    19→│   VibeProfile (WHO)              Operational (WHAT)              │
    20→│   ─────────────────              ──────────────────              │
    21→│   用户是谁                       用户做了什么                    │
    22→│   • account                      • conversations                 │
    23→│   • birth_info                   • messages                      │
    24→│   • state                        • reports                       │
    25→│   • preferences                  • notifications                 │
    26→│   • life_context                 • payments                      │
    27→│                                                                  │
    28→└─────────────────────────────────────────────────────────────────┘
    29→```
    30→
    31→### 设计原则
    32→
    33→- **WHO vs WHAT** - VibeProfile 存画像，操作数据独立表
    34→- **Single JSONB** - 画像数据一张表 (`unified_profiles.profile`)
    35→- **Daily Proactive** - 每天凌晨扫描一次，按小时投递
    36→- **User Control** - 用户可选数据保留策略
    37→
    38→---
    39→
    40→## 2. 数据结构
    41→
    42→### 2.1 Profile Schema
    43→
    44→```yaml
    45→profile:
    46→  # ═══════════════════════════════════════════════════════════════
    47→  # 账户 (只读，从 vibe_users 通过触发器自动同步)
    48→  # ═══════════════════════════════════════════════════════════════
    49→  account:
    50→    vibe_id: "VB-A1B2C3D4"
    51→    display_name: "用户昵称"
    52→    tier: "free"                    # free | basic | pro | enterprise
    53→    status: "active"
    54→
    55→  # ═══════════════════════════════════════════════════════════════
    56→  # 出生信息 (顶层字段)
    57→  # ═══════════════════════════════════════════════════════════════
    58→  birth_info:
    59→    date: "1990-05-15"
    60→    time: "14:30"
    61→    place: "北京"
    62→    timezone: "Asia/Shanghai"
    63→    gender: "male"
    64→
    65→  # ═══════════════════════════════════════════════════════════════
    66→  # 状态 (简化版，只保留 focus)
    67→  # ═══════════════════════════════════════════════════════════════
    68→  state:
    69→    focus: ["career", "health"]     # 当前关注的话题
    70→    updated_at: "2026-01-19T10:00:00Z"
    71→
    72→  # ═══════════════════════════════════════════════════════════════
    73→  # 偏好
    74→  # ═══════════════════════════════════════════════════════════════
    75→  preferences:
    76→    voice_mode: "warm"
    77→    language: "zh-CN"
    78→    timezone: "Asia/Shanghai"
    79→
    80→    # Skill 订阅 (对象结构，支持元数据)
    81→    subscribed_skills:
    82→      bazi:
    83→        status: "subscribed"        # subscribed | unsubscribed | not_subscribed
    84→        push_enabled: true
    85→        subscribed_at: "2026-01-01T00:00:00Z"
    86→        trial_messages_used: 0
    87→      zodiac:
    88→        status: "subscribed"
    89→        push_enabled: true
    90→        subscribed_at: "2026-01-01T00:00:00Z"
    91→        trial_messages_used: 0
    92→
    93→    # 推送设置
    94→    push_settings:
    95→      default_push_hour: 8          # 默认推送时间 (0-23)
    96→      max_daily_pushes: 5
    97→      quiet_start_hour: 22          # 静默开始
    98→      quiet_end_hour: 7             # 静默结束
    99→
   100→    # 屏蔽的 Skill
   101→    blocked_skills: []
   102→
   103→    # 数据保留策略 (用户可配置)
   104→    data_retention:
   105→      conversations: "1y"           # "1y" | "3y" | "forever"
   106→
   107→  # ═════════════════��═════════════════════════════════════════════
   108→  # Skill 数据
   109→  # ═══════════════════════════════════════════════════════════════
   110→  skill_data:
   111→    bazi:
   112→      chart: { ... }
   113→      features: { daymaster, strength, pattern }
   114→      current_dayun: { ... }
   115→      current_liunian: { ... }
   116→    zodiac:
   117→      chart: { ... }
   118→      current_transits: { ... }
   119→    tarot:
   120→      last_reading: { ... }
   121→    career:
   122→      assessment: { ... }
   123→
   124→  # ═════════════════════════════════════════���═════════════════════
   125→  # 从对话抽取
   126→  # ═══════════════════════════════════════════════════════════════
   127→  extracted:
   128→    facts: ["在互联网公司工作", "有升职压力"]
   129→    goals: ["年底升职"]             # 当前活跃目标摘要
   130→    concerns: ["工作压力"]
   131→
   132→  # ═══════════════════════════════════════════════════════════════
   133→  # 生活上下文
   134→  # ═══════════════════════════════════════════════════════════════
   135→  life_context:
   136→    # 基础信息
   137→    occupation:
   138→      title: "产品经理"
   139→      industry: "互联网"
   140→    focus_areas: ["career", "health"]
   141→
   142→    # 目标管理
   143→    goals:
   144→      - id: "uuid-1"
   145→        title: "年底升职到高级产品经理"
   146→        category: "career"
   147→        status: "active"            # active | completed | abandoned
   148→        progress: 0.3
   149→        deadline: "2026-12-31"
   150→        created_at: "2026-01-01"
   151→
   152→    # 任务管理
   153→    tasks:
   154→      - id: "uuid-a"
   155→        title: "准备季度汇报"
   156→        status: "pending"           # pending | done | cancelled
   157→        due_date: "2026-01-25"
   158→        goal_id: "uuid-1"           # 关联目标
   159→
   160→    # 打卡记录 (只保留 30 天)
   161→    checkins:
   162→      "2026-01-19": { mood: 7, energy: 6, notes: "状态不错" }
   163→
   164→    # 提醒
   165→    reminders:
   166→      - id: "uuid-r1"
   167→        type: "goal_checkin"        # goal_checkin | daily_plan | custom
   168→        title: "目标打卡提醒"
   169→        schedule_type: "daily"      # once | daily | weekly
   170→        trigger_hour: 20
   171→        status: "active"            # active | paused
   172→
   173→    # 虚拟路径存储 (灵活扩展)
   174→    _paths:
   175→      "goals/2026/year": { content: {...}, version: 1, updated_at: "..." }
   176→
   177→    # 追踪统计
   178→    tracking:
   179→      last_checkin: "2026-01-19"
   180→      streak_days: 5
   181→```
   182→
   183→### 2.2 Cold Layer (独立表，低频写入)
   184→
   185→```sql
   186→-- 洞察 (AI 生成的长期观察)
   187→CREATE TABLE vibe_profile_insights (
   188→    id UUID PRIMARY KEY,
   189→    user_id UUID NOT NULL,
   190→    insight_type VARCHAR(50),       -- discovery | pattern | timing | growth
   191→    skill_id VARCHAR(50),
   192→    content TEXT,
   193→    created_at TIMESTAMPTZ DEFAULT now()
   194→);
   195→
   196→-- 时间线 (重要事件记录)
   197→CREATE TABLE vibe_profile_timeline (
   198→    id UUID PRIMARY KEY,
   199→    user_id UUID NOT NULL,
   200→    event_type VARCHAR(50),         -- dayun_change | goal_completed | milestone
   201→    event_date DATE,
   202→    title VARCHAR(200),
   203→    data JSONB,
   204→    created_at TIMESTAMPTZ DEFAULT now()
   205→);
   206→```
   207→
   208→---
   209→
   210→## 3. 数据访问
   211→
   212→### 3.1 Repository
   213→
   214→```python
   215→class UnifiedProfileRepository:
   216→    """唯一数据访问层 (stores/unified_profile_repo.py)"""
   217→
   218→    # ─────────────────────────────────────────────────────────────
   219→    # 读取
   220→    # ─────────────────────────────────────────────────────────────
   221→    async def get_profile(user_id: UUID) -> Dict
   222→    async def get_account(user_id: UUID) -> Dict      # v7.7 新增
   223→    async def get_birth_info(user_id: UUID) -> Dict
   224→    async def get_state(user_id: UUID) -> Dict        # v7.7 新增
   225→    async def get_focus(user_id: UUID) -> List[str]   # v7.7 新增
   226→    async def get_tier(user_id: UUID) -> str          # v7.7 新增
   227→    async def get_skill_data(user_id: UUID, skill: str) -> Dict
   228→    async def get_preferences(user_id: UUID) -> Dict
   229→    async def get_life_context(user_id: UUID) -> Dict
   230→
   231→    # ─────────────────────────────────────────────────────────────
   232→    # 写入
   233→    # ─────────────────────────────────────────────────────────────
   234→    async def update_birth_info(user_id: UUID, birth_info: Dict)
   235→    async def update_state(user_id: UUID, state: Dict)
   236→    async def update_focus(user_id: UUID, focus: List[str])  # v7.7 新增
   237→    async def add_focus(user_id: UUID, topic: str) -> List[str]  # v7.7 新增
   238→    async def remove_focus(user_id: UUID, topic: str) -> List[str]  # v7.7 新增
   239→    async def update_skill_data(user_id: UUID, skill: str, data: Dict)
   240→    async def update_preferences(user_id: UUID, preferences: Dict)
   241→    async def update_life_context(user_id: UUID, life_context: Dict)
   242→    async def update_extracted(user_id: UUID, extracted: Dict)
   243→
   244→    # ─────────────────────────────────────────────────────────────
   245→    # Skill 订阅管理
   246→    # ─────────────────────────────────────────────────────────────
   247→    async def get_skill_subscription(user_id: UUID, skill_id: str) -> SkillSubscription
   248→    async def get_user_subscriptions(user_id: UUID) -> List[SkillSubscription]
   249→    async def subscribe(user_id: UUID, skill_id: str, push_enabled: bool) -> SkillSubscription
   250→    async def unsubscribe(user_id: UUID, skill_id: str) -> SkillSubscription
   251→    async def is_subscribed(user_id: UUID, skill_id: str) -> bool
   252→
   253→    # ─────────────────────────────────────────────────────────────
   254→    # 推送设置
   255→    # ─────────────────────────────────────────────────────────────
   256→    async def get_push_settings(user_id: UUID) -> UserPushPreferences
   257→    async def upsert_push_settings(user_id: UUID, ...) -> UserPushPreferences
   258→    async def get_push_hour(user_id: UUID) -> int
   259→    async def is_in_quiet_hours(user_id: UUID, current_hour: int) -> bool
   260→
   261→    # ─────────────────────────────────────────────────────────────
   262→    # 生活上下文路径操作
   263→    # ─────────────────────────────────────────────────────────────
   264→    async def read_life_context_path(user_id: UUID, path: str) -> LifeContextData
   265→    async def write_life_context_path(user_id: UUID, path: str, content: Dict) -> LifeContextData
   266→    async def delete_life_context_path(user_id: UUID, path: str) -> bool
   267→    async def list_life_context_paths(user_id: UUID, prefix: str) -> List[str]
   268→
   269→    # ─────────────────────────────────────────────────────────────
   270→    # Proactive 支持
   271→    # ─────────────────────────────────────────────────────────────
   272→    async def get_users_with_push_enabled(skill_id: str) -> List[UUID]
   273→
   274→    # ─────────────────────────────────────────────────────────────
   275→    # 数据维护
   276→    # ─────────────────────────────────────────────────────────────
   277→    async def cleanup_old_checkins(user_id: UUID, keep_days: int = 30)
   278→```
   279→
   280→### 3.2 account 字段同步机制
   281→
   282→`account` 字段通过数据库触发器自动从 `vibe_users` 同步：
   283→
   284→```sql
   285→-- 触发器：当 vibe_users 更新时自动同步到 unified_profiles.profile.account
   286→CREATE TRIGGER trigger_sync_account_to_profile
   287→    AFTER INSERT OR UPDATE OF vibe_id, display_name, tier
   288→    ON vibe_users
   289→    FOR EACH ROW
   290→    EXECUTE FUNCTION sync_account_to_profile();
   291→```
   292→
   293→**注意**: `account` 字段是只读的，不应直接修改。修改用户信息应通过 `UserRepository` 操作 `vibe_users` 表。
   294→
   295→### 3.3 缓存
   296→
   297→```python
   298→# 简单内存缓存，5分钟 TTL
   299→_cache: Dict[UUID, CacheEntry] = {}
   300→TTL = 300
   301→```
   302→
   303→---
   304→
   305→## 4. Proactive 流程
   306→
   307→### 每日扫描 (04:00)
   308→
   309→```
   310→04:00 凌晨
   311→    │
   312→    ▼
   313→┌─────────────────────────────────────────────────────────────┐
   314→│  ProactiveWorker.daily_scan()                                │
   315→│                                                              │
   316→│  1. 获取所有 push_enabled 用户                               │
   317→│                                                              │
   318→│  2. 为每个用户生成今日内容:                                  │
   319→│     - 检查 subscribed_skills，生成运势推送                   │
   320→│     - 检查 reminders，生成提醒推送                           │
   321→│     - 检查 goals，生成目标进度推送                           │
   322→│                                                              │
   323→│  3. 存入 notifications 表，标记 deliver_hour                 │
   324→│                                                              │
   325→└─────────────────────────────────────────────────────────────┘
   326→
   327→每小时 (00, 01, 02, ...)
   328→    │
   329→    ▼
   330→┌─────────────────────────────────────────────────────────────┐
   331→│  NotificationWorker.deliver()                                │
   332→│                                                              │
   333→│  SELECT * FROM notifications                                 │
   334→│  WHERE deliver_hour = current_hour AND delivered = false     │
   335→│                                                              │
   336→│  投递到用户设备                                              │
   337→└─────────────────────────────────────────────────────────────┘
   338→```
   339→
   340→### reminders 触发逻辑
   341→
   342→```python
   343→# 每日扫描时检查 reminders
   344→for user in users:
   345→    reminders = user["profile"]["life_context"]["reminders"]
   346→    for reminder in reminders:
   347→        if reminder["status"] != "active":
   348→            continue
   349→
   350→        # 检查今天是否应该触发
   351→        if should_trigger_today(reminder):
   352→            # 生成通知，在 trigger_hour 投递
   353→            create_notification(
   354→                user_id=user["id"],
   355→                type="reminder",
   356→                content=reminder["title"],
   357→                deliver_hour=reminder["trigger_hour"]
   358→            )
   359→
   360→def should_trigger_today(reminder):
   361→    if reminder["schedule_type"] == "daily":
   362→        return True
   363→    if reminder["schedule_type"] == "weekly":
   364→        return today.weekday() == reminder.get("trigger_weekday", 0)
   365→    if reminder["schedule_type"] == "once":
   366→        return reminder.get("trigger_date") == today
   367→    return False
   368→```
   369→
   370→---
   371→
   372→## 5. Skill 访问规则
   373→
   374→| Skill | 可读 | 可写 |
   375→|-------|------|------|
   376→| **Core Layer** | | |
   377→| core | 全部 | state, extracted |
   378→| lifecoach | 全部 | state, extracted, life_context |
   379→| mindfulness | 全部 | state |
   380→| **Professional Layer** | | |
   381→| bazi | identity, state | skill_data.bazi |
   382→| zodiac | identity, state | skill_data.zodiac |
   383→| tarot | identity, state | skill_data.tarot |
   384→| career | identity, state, life_context | skill_data.career |
   385→
   386→---
   387→
   388→## 6. 迁移
   389→
   390→### 废弃的表
   391→
   392→迁移后删除：
   393→- `user_data_store`
   394→- `user_reminders`
   395→- `user_skill_subscriptions`
   396→- `user_push_preferences`
   397→- `skill_recommendation_blocks`
   398→
   399→### 迁移脚本
   400→
   401→```sql
   402→-- 1. 合并 subscribed_skills
   403→UPDATE unified_profiles up
   404→SET profile = jsonb_set(
   405→    profile,
   406→    '{preferences,subscribed_skills}',
   407→    COALESCE((
   408→        SELECT jsonb_agg(skill_id)
   409→        FROM user_skill_subscriptions
   410→        WHERE user_id = up.user_id AND status = 'subscribed'
   411→    ), '["core"]'::jsonb)
   412→);
   413→
   414→-- 2. 合并 push_hour
   415→UPDATE unified_profiles up
   416→SET profile = jsonb_set(
   417→    profile,
   418→    '{preferences,push_hour}',
   419→    to_jsonb(COALESCE(
   420→        (SELECT default_push_hour FROM user_push_preferences WHERE user_id = up.user_id),
   421→        8
   422→    ))
   423→);
   424→
   425→-- 3. 合并 goals
   426→UPDATE unified_profiles up
   427→SET profile = jsonb_set(
   428→    profile,
   429→    '{life_context,goals}',
   430→    COALESCE((
   431→        SELECT jsonb_agg(content)
   432→        FROM user_data_store
   433→        WHERE user_id = up.user_id AND data_type = 'goals'
   434→    ), '[]'::jsonb)
   435→);
   436→
   437→-- 4. 合并 tasks (只保留 pending 状态)
   438→UPDATE unified_profiles up
   439→SET profile = jsonb_set(
   440→    profile,
   441→    '{life_context,tasks}',
   442→    COALESCE((
   443→        SELECT jsonb_agg(content)
   444→        FROM user_data_store
   445→        WHERE user_id = up.user_id AND data_type = 'tasks'
   446→          AND content->>'status' = 'pending'
   447→    ), '[]'::jsonb)
   448→);
   449→
   450→-- 5. 合并 checkins (只保留 30 天)
   451→UPDATE unified_profiles up
   452→SET profile = jsonb_set(
   453→    profile,
   454→    '{life_context,checkins}',
   455→    COALESCE((
   456→        SELECT jsonb_object_agg(
   457→            to_char((content->>'date')::date, 'YYYY-MM-DD'),
   458→            content
   459→        )
   460→        FROM user_data_store
   461→        WHERE user_id = up.user_id AND data_type = 'checkins'
   462→          AND (content->>'date')::date >= CURRENT_DATE - 30
   463→    ), '{}'::jsonb)
   464→);
   465→
   466→-- 6. 合并 reminders
   467→UPDATE unified_profiles up
   468→SET profile = jsonb_set(
   469→    profile,
   470→    '{life_context,reminders}',
   471→    COALESCE((
   472→        SELECT jsonb_agg(jsonb_build_object(
   473→            'id', id,
   474→            'type', reminder_type,
   475→            'title', title,
   476→            'schedule_type', schedule_type,
   477→            'trigger_hour', EXTRACT(HOUR FROM next_trigger_at)::int,
   478→            'status', status,
   479→            'goal_id', metadata->>'goal_id'
   480→        ))
   481→        FROM user_reminders
   482→        WHERE user_id = up.user_id AND status = 'active'
   483→    ), '[]'::jsonb)
   484→);
   485→```
   486→
   487→---
   488→
   489→## 7. 数据大小控制
   490→
   491→### 预估大小
   492→
   493→| 字段 | 预估大小 |
   494→|------|---------|
   495→| account | 200 bytes |
   496→| identity | 500 bytes |
   497→| state | 200 bytes |
   498→| preferences | 300 bytes |
   499→| skill_data | 5 KB |
   500→| extracted | 500 bytes |
   501→| life_context.goals (10个) | 2 KB |
   502→| life_context.tasks (20个) | 2 KB |
   503→| life_context.checkins (30天) | 3 KB |
   504→| life_context.reminders (10个) | 1 KB |
   505→| **总计** | **~15 KB** |
   506→
   507→### 限制规则
   508→
   509→```python
   510→MAX_GOALS = 20
   511→MAX_TASKS = 50
   512→MAX_CHECKIN_DAYS = 30
   513→MAX_REMINDERS = 20
   514→MAX_FACTS = 50
   515→
   516→# 写入时检查
   517→async def add_goal(user_id, goal):
   518→    profile = await get_profile(user_id)
   519→    goals = profile["life_context"].get("goals", [])
   520→    if len(goals) >= MAX_GOALS:
   521→        raise LimitExceeded("最多支持 20 个目标")
   522→    # ...
   523→```
   524→
   525→---
   526→
   527→## 8. API
   528→
   529→### 内部 Python API
   530→
   531→```python
   532→# 读取
   533→profile = await VibeProfileRepository.get_profile(user_id)
   534→goals = profile["life_context"]["goals"]
   535→
   536→# 写入
   537→await VibeProfileRepository.add_goal(user_id, {
   538→    "title": "学习英语",
   539→    "category": "learning",
   540→    "status": "active"
   541→})
   542→
   543→await VibeProfileRepository.add_checkin(user_id, "2026-01-19", {
   544→    "mood": 8,
   545→    "energy": 7,
   546→    "notes": "今天很棒"
   547→})
   548→```
   549→
   550→### HTTP API
   551→
   552→```
   553→GET  /api/v1/profile/summary       # 用户认知摘要
   554→GET  /api/v1/profile/goals         # 目标列表
   555→POST /api/v1/profile/goals         # 添加目标
   556→PUT  /api/v1/profile/goals/:id     # 更新目标
   557→POST /api/v1/profile/checkins      # 打卡
   558→GET  /api/v1/profile/reminders     # 提醒列表
   559→POST /api/v1/profile/reminders     # 添加提醒
   560→```
   561→
   562→---
   563→
   564→## 9. UserDataSpace - 统一数据管理
   565→
   566→### 9.1 领域划分
   567→
   568→```
   569→┌─────────────────────────────────────────────────────────────────────┐
   570→│                         UserDataSpace                                │
   571→├─────────────────────────────────────────────────────────────────────┤
   572→│                                                                      │
   573→│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
   574→│  │   VibeProfile   │  │   Operational   │  │    Billing      │      │
   575→│  │   (画像数据)     │  │   (操作数据)     │  │   (财务数据)    │      │
   576→│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤      │
   577→│  │ unified_profiles│  │ conversations   │  │ subscriptions   │      │
   578→│  │                 │  │ messages        │  │ payments        │      │
   579→│  │                 │  │ notifications   │  │                 │      │
   580→│  │                 │  │ skill_usage_log │  │                 │      │
   581→│  └─────────────────┘  └─────────────────┘  └─────────────────┘      │
   582→│                                                                      │
   583→│  ┌─────────────────┐                                                 │
   584→│  │    Content      │                                                 │
   585→│  │   (内容快照)     │                                                 │
   586→│  ├─────────────────┤                                                 │
   587→│  │ reports         │                                                 │
   588→│  │ relationships   │                                                 │
   589→│  └─────────────────┘                                                 │
   590→│                                                                      │
   591→└─────────────────────────────────────────────────────────────────────┘
   592→```
   593→
   594→### 9.2 统一管理入口
   595→
   596→```python
   597→class UserDataSpace:
   598→    """用户数据空间 - 统一管理入口"""
   599→
   600→    profile: VibeProfileRepository      # 画像数据
   601→    conversations: ConversationRepository  # 对话
   602→    content: ContentRepository          # 快照内容
   603→    billing: BillingRepository          # 财务
   604→
   605→    async def delete_user_data(user_id: UUID) -> Dict:
   606→        """账户删除时，清理所有数据"""
   607→        return {
   608→            "profile": await self.profile.delete(user_id),
   609→            "conversations": await self.conversations.delete_all(user_id),
   610→            "content": await self.content.delete_all(user_id),
   611→            "billing": "retained",  # 财务数据保留 (法规)
   612→        }
   613→
   614→    async def export_user_data(user_id: UUID) -> Dict:
   615→        """GDPR 数据导出"""
   616→        return {
   617→            "profile": await self.profile.get_profile(user_id),
   618→            "conversations": await self.conversations.export(user_id),
   619→            "content": await self.content.export(user_id),
   620→            "billing": await self.billing.export(user_id),
   621→        }
   622→
   623→    async def get_storage_usage(user_id: UUID) -> Dict:
   624→        """存储用量统计"""
   625→        return {
   626→            "profile_kb": ...,
   627→            "messages_count": ...,
   628→            "reports_count": ...,
   629→        }
   630→```
   631→
   632→### 9.3 数据生命周期
   633→
   634→| 领域 | 默认保留 | 用户可选 | 清理规则 |
   635→|------|---------|---------|---------|
   636→| **VibeProfile** | 永久 | - | checkins 保留 30 天 |
   637→| **Conversations** | 1 年 | 1年 / 3年 / 永久 | 按用户设置清理 |
   638→| **Content** | 永久 | 可手动删除 | - |
   639→| **Billing** | 7 年 | 不可更改 | 法规要求 |
   640→| **Logs** | 90 天 | - | 滚动清理 |
   641→| **Notifications** | 30 天 | - | 已读 30 天后清理 |
   642→
   643→### 9.4 对话清理逻辑
   644→
   645→```python
   646→async def cleanup_conversations(user_id: UUID):
   647→    """按用户设置清理对话"""
   648→    profile = await VibeProfileRepository.get_profile(user_id)
   649→    retention = profile.get("preferences", {}).get("data_retention", {})
   650→    conversations_retention = retention.get("conversations", "1y")
   651→
   652→    if conversations_retention == "forever":
   653→        return  # 不清理
   654→
   655→    days = {"1y": 365, "3y": 1095}[conversations_retention]
   656→    cutoff = datetime.now() - timedelta(days=days)
   657→
   658→    await ConversationRepository.archive_before(user_id, cutoff)
   659→```
   660→
   661→---
   662→
   663→## 附录：设计原则
   664→
   665→1. **WHO vs WHAT** - VibeProfile 存画像 (WHO)，操作数据 (WHAT) 独立表
   666→2. **Single JSONB** - 画像数据一张表 (`unified_profiles.profile`)
   667→3. **Daily Scan** - 每天凌晨扫描，按小时投递
   668→4. **30 Days Limit** - checkins 等时间序列数据只保留 30 天
   669→5. **User Control** - 对话保留策略用户可选 (1年/3年/永久)
   670→6. **Convention > Code** - 访问规则靠 Review 保证
   671→7. **Simple Cache** - 内存缓存，5分钟 TTL
   672→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
