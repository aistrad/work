     1→# Dashboard 数据流设计
     2→
     3→> **Version**: 1.0 | 2026-01-19
     4→> **关联文档**: DESIGN.md, COMPONENTS.md
     5→
     6→---
     7→
     8→## 数据源映射
     9→
    10→```
    11→┌─────────────────────────────────────────────────────────────────────────────────┐
    12→│                         Dashboard 数据源全景                                     │
    13→├─────────────────────────────────────────────────────────────────────────────────┤
    14→│                                                                                  │
    15→│   Dashboard                    数据源                       存储位置             │
    16→│   ═════════                    ═════                        ═════               │
    17→│                                                                                  │
    18→│   ┌─────────────┐                                                               │
    19→│   │ Ambient     │────────────▶ 系统时间 + 节气 API ────────▶ 实时计算           │
    20→│   │ Header      │                                                               │
    21→│   └─────────────┘              用户设置 ────────────────────▶ preferences       │
    22→│                                                                                  │
    23→│   ┌─────────────┐                                                               │
    24→│   │ Identity    │────────────▶ VibeProfile ─────────────────▶ unified_profiles  │
    25→│   │ Card        │              (archetypes)                   .profile.skill_data│
    26→│   └─────────────┘                                             .bazi/zodiac      │
    27→│                                                                                  │
    28→│                                Lifecoach State ──────────────▶ unified_profiles │
    29→│                                (identity.statement)           .profile          │
    30→│                                                               .life_context     │
    31→│                                                               ._paths.lifecoach │
    32→│                                                                                  │
    33→│   ┌─────────────┐                                                               │
    34→│   │ Today       │────────────▶ Lifecoach State ──────────────▶ life_context     │
    35→│   │ Card        │              (current.daily)                ._paths.lifecoach │
    36→│   └─────────────┘                                             .current.daily    │
    37→│                                                                                  │
    38→│                                Progress Data ────────────────▶ life_context     │
    39→│                                (streak, checkins)             ._paths.lifecoach │
    40→│                                                               .progress         │
    41→│                                                                                  │
    42→│   ┌─────────────┐                                                               │
    43→│   │ NorthStar   │────────────▶ Lifecoach State ──────────────▶ life_context     │
    44→│   │ Card        │              (north_star, roadmap)          ._paths.lifecoach │
    45→│   └─────────────┘                                             .north_star       │
    46→│                                                               .roadmap          │
    47→│                                                               .current.month    │
    48→│                                                                                  │
    49→│   ┌─────────────┐                                                               │
    50→│   │ Week        │────────────▶ Lifecoach State ──────────────▶ life_context     │
    51→│   │ Card        │              (current.week)                 ._paths.lifecoach │
    52→│   └─────────────┘                                             .current.week     │
    53→│                                                               .goals            │
    54→│                                                                                  │
    55→│   ┌─────────────┐                                                               │
    56→│   │ Growth      │────────────▶ Lifecoach Journal ────────────▶ life_context     │
    57→│   │ Timeline    │              (journal entries)              ._paths.lifecoach │
    58→│   └─────────────┘                                             .journal          │
    59→│                                                                                  │
    60→│                                Roadmap Milestones ───────────▶ .roadmap         │
    61→│                                                                                  │
    62→│   ┌─────────────┐                                                               │
    63→│   │ Proactive   │────────────▶ Notifications ────────────────▶ notifications    │
    64→│   │ Messages    │                                             table             │
    65→│   └─────────────┘                                                               │
    66→│                                                                                  │
    67→└─────────────────────────────────────────────────────────────────────────────────┘
    68→```
    69→
    70→---
    71→
    72→## 数据聚合策略
    73→
    74→### 策略 A: 聚合 API (推荐)
    75→
    76→```
    77→┌─────────────────────────────────────────────────────────────────────────────────┐
    78→│                         聚合 API 模式                                            │
    79→├─────────────────────────────────────────────────────────────────────────────────┤
    80→│                                                                                  │
    81→│   Frontend                    API                         Backend                │
    82→│   ═════════                   ═══                         ═══════                │
    83→│                                                                                  │
    84→│   ┌─────────────┐                                                               │
    85→│   │  Dashboard  │                                                               │
    86→│   │    Page     │                                                               │
    87→│   └──────┬──────┘                                                               │
    88→│          │                                                                       │
    89→│          │  GET /api/dashboard?user_id=xxx                                      │
    90→│          │                                                                       │
    91→│          ▼                                                                       │
    92→│   ┌──────────────────────────────────────────────────────────────────────────┐  │
    93→│   │                                                                          │  │
    94→│   │                    Dashboard Aggregation API                              │  │
    95→│   │                                                                          │  │
    96→│   │   async def get_dashboard(user_id: str) -> DashboardDTO:                 │  │
    97→│   │       # 并行获取所有数据                                                  │  │
    98→│   │       profile, lifecoach, notifications, stats = await asyncio.gather(   │  │
    99→│   │           vibe_profile_repo.get_profile(user_id),                        │  │
   100→│   │           lifecoach_service.get_state(user_id),                          │  │
   101→│   │           notification_repo.get_today(user_id),                          │  │
   102→│   │           stats_service.get_overview(user_id)                            │  │
   103→│   │       )                                                                  │  │
   104→│   │                                                                          │  │
   105→│   │       # 组装 DTO                                                          │  │
   106→│   │       return DashboardDTO(                                               │  │
   107→│   │           ambient=build_ambient(profile),                                │  │
   108→│   │           identity=build_identity(profile, lifecoach),                   │  │
   109→│   │           today=build_today(lifecoach),                                  │  │
   110→│   │           north_star=build_north_star(lifecoach),                        │  │
   111→│   │           week=build_week(lifecoach),                                    │  │
   112→│   │           growth=build_growth(lifecoach, stats),                         │  │
   113→│   │           proactive=notifications                                        │  │
   114→│   │       )                                                                  │  │
   115→│   │                                                                          │  │
   116→│   └──────────────────────────────────────────────────────────────────────────┘  │
   117→│          │                                                                       │
   118→│          │  单一响应，包含所有 Dashboard 数据                                    │
   119→│          ▼                                                                       │
   120→│   ┌─────────────┐                                                               │
   121→│   │  Dashboard  │                                                               │
   122→│   │  Rendered   │                                                               │
   123→│   └─────────────┘                                                               │
   124→│                                                                                  │
   125→│   优点:                                                                          │
   126→│   ✓ 单一请求，减少网络往返                                                      │
   127→│   ✓ 后端可以优化查询 (合并数据库查询)                                           │
   128→│   ✓ 缓存策略简单                                                                │
   129→│   ✓ 减少前端复杂度                                                              │
   130→│                                                                                  │
   131→│   缺点:                                                                          │
   132→│   ✗ 任一数据源失败会影响整个响应                                                │
   133→│   ✗ 部分更新需要重新获取全部数据                                                │
   134→│                                                                                  │
   135→└─────────────────────────────────────────────────────────────────────────────────┘
   136→```
   137→
   138→### 策略 B: 分离 API + 并行获取
   139→
   140→```
   141→┌─────────────────────────────────────────────────────────────────────────────────┐
   142→│                         分离 API 模式                                            │
   143→├─────────────────────────────────────────────────────────────────────────────────┤
   144→│                                                                                  │
   145→│   Frontend                                                                       │
   146→│   ═════════                                                                      │
   147→│                                                                                  │
   148→│   ┌─────────────────────────────────────────────────────────────────────────┐   │
   149→│   │                           useDashboard Hook                              │   │
   150→│   │                                                                          │   │
   151→│   │   // 并行获取，独立缓存                                                   │   │
   152→│   │   const { data: profile } = useSWR('/api/vibe-profile/xxx');            │   │
   153→│   │   const { data: lifecoach } = useSWR('/api/lifecoach/state/xxx');       │   │
   154→│   │   const { data: proactive } = useSWR('/api/proactive/today/xxx');       │   │
   155→│   │   const { data: stats } = useSWR('/api/stats/overview/xxx');            │   │
   156→│   │                                                                          │   │
   157→│   │   // 客户端聚合                                                           │   │
   158→│   │   const dashboard = useMemo(() => {                                      │   │
   159→│   │     if (!profile || !lifecoach || !proactive || !stats) return null;    │   │
   160→│   │     return aggregateDashboard(profile, lifecoach, proactive, stats);    │   │
   161→│   │   }, [profile, lifecoach, proactive, stats]);                           │   │
   162→│   │                                                                          │   │
   163→│   └─────────────────────────────────────────────────────────────────────────┘   │
   164→│                                                                                  │
   165→│          │          │          │          │                                     │
   166→│          ▼          ▼          ▼          ▼                                     │
   167→│   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                          │
   168→│   │  /vibe-  │ │/lifecoach│ │/proactive│ │ /stats   │                          │
   169→│   │  profile │ │  /state  │ │  /today  │ │ /overview│                          │
   170→│   └──────────┘ └──────────┘ └──────────┘ └──────────┘                          │
   171→│                                                                                  │
   172→│   优点:                                                                          │
   173→│   ✓ 部分失败不影响其他数据展示                                                  │
   174→│   ✓ 独立缓存，部分更新只刷新相关数据                                            │
   175→│   ✓ API 可复用于其他页面                                                        │
   176→│                                                                                  │
   177→│   缺点:                                                                          │
   178→│   ✗ 多个请求，增加网络开销                                                      │
   179→│   ✗ 前端聚合逻辑复杂                                                            │
   180→│   ✗ 需要处理竞态条件                                                            │
   181→│                                                                                  │
   182→└─────────────────────────────────────────────────────────────────────────────────┘
   183→```
   184→
   185→### 推荐: 混合策略
   186→
   187→```
   188→┌─────────────────────────────────────────────────────────────────────────────────┐
   189→│                         混合策略 (推荐)                                          │
   190→├─────────────────────────────────────────────────────────────────────────────────┤
   191→│                                                                                  │
   192→│   初始加载: 使用聚合 API                                                         │
   193→│   ═══════════════════════                                                        │
   194→│                                                                                  │
   195→│   GET /api/dashboard ──────▶ 返回完整 DashboardDTO                              │
   196→│                                                                                  │
   197→│   增量更新: 使用分离 API                                                         │
   198→│   ═══════════════════════                                                        │
   199→│                                                                                  │
   200→│   用户签到后:                                                                    │
   201→│   POST /api/dashboard/checkin ──────▶ 只刷新 Today 数据                         │
   202→│                                                                                  │
   203→│   用户勾选 lever 后:                                                             │
   204→│   PATCH /api/dashboard/lever/:id ──────▶ 只刷新相关 lever 状态                  │
   205→│                                                                                  │
   206→│   用户完成 rock 后:                                                              │
   207→│   PATCH /api/dashboard/rock/:id ──────▶ 只刷新 Week 数据                        │
   208→│                                                                                  │
   209→│   实现:                                                                          │
   210→│   ┌─────────────────────────────────────────────────────────────────────────┐   │
   211→│   │                                                                         │   │
   212→│   │   const { data, mutate } = useSWR('/api/dashboard');                    │   │
   213→│   │                                                                         │   │
   214→│   │   // 乐观更新 + 后台验证                                                 │   │
   215→│   │   async function handleCheckIn() {                                      │   │
   216→│   │     // 1. 乐观更新 UI                                                    │   │
   217→│   │     mutate({                                                            │   │
   218→│   │       ...data,                                                          │   │
   219→│   │       today: { ...data.today, checkedIn: true, streak: data.today.streak + 1 }│
   220→│   │     }, false);                                                          │   │
   221→│   │                                                                         │   │
   222→│   │     // 2. 后台请求                                                       │   │
   223→│   │     const result = await api.post('/api/dashboard/checkin');            │   │
   224→│   │                                                                         │   │
   225→│   │     // 3. 用服务端数据验证                                               │   │
   226→│   │     mutate({                                                            │   │
   227→│   │       ...data,                                                          │   │
   228→│   │       today: { ...data.today, ...result.today }                         │   │
   229→│   │     });                                                                 │   │
   230→│   │   }                                                                     │   │
   231→│   │                                                                         │   │
   232→│   └─────────────────────────────────────────────────────────────────────────┘   │
   233→│                                                                                  │
   234→└─────────────────────────────────────────────────────────────────────────────────┘
   235→```
   236→
   237→---
   238→
   239→## API 规格详细
   240→
   241→### GET /api/dashboard
   242→
   243→```typescript
   244→// 请求
   245→GET /api/dashboard
   246→Headers:
   247→  Authorization: Bearer {token}
   248→Query:
   249→  user_id: string (可选，默认当前用户)
   250→
   251→// 响应
   252→{
   253→  "success": true,
   254→  "data": {
   255→    "userId": "user_123",
   256→    "generatedAt": "2026-01-19T08:00:00Z",
   257→
   258→    "ambient": {
   259→      "greeting": "早安，小薇",
   260→      "message": "新的一周开始了，你的愿景正在等待你的行动。",
   261→      "date": "2026年1月19日 周日",
   262→      "solarTerm": "小寒第三候",
   263→      "suggestion": "宜静心规划"
   264→    },
   265→
   266→    "identity": {
   267→      "archetypes": {
   268→        "core": "creator",
   269→        "inner": "lover",
   270→        "outer": "explorer",
   271→        "shadow": "hero"
   272→      },
   273→      "statement": "我是一个每天都在创造的人",
   274→      "currentState": "专注创作",
   275→      "tags": ["创作中", "高能量"]
   276→    },
   277→
   278→    "northStar": {
   279→      "vision": "我想成为一个用文字帮助他人找到方向的创作者",
   280→      "monthlyProject": {
   281→        "name": "完成书籍第3章",
   282→        "progress": 40,
   283→        "daysRemaining": 12
   284→      },
   285→      "yearGoal": "出版第一本书"
   286→    },
   287→
   288→    "today": {
   289→      "levers": [
   290→        { "id": "lever_1", "text": "完成3.2节初稿", "completed": false },
   291→        { "id": "lever_2", "text": "回复小明的邮件", "completed": false },
   292→        { "id": "lever_3", "text": "30分钟阅读", "completed": false }
   293→      ],
   294→      "streak": 7,
   295→      "checkedIn": false,
   296→      "proactiveMessage": "今天是本周的最后一天，有什么想完成的吗？"
   297→    },
   298→
   299→    "week": {
   300→      "rocks": [
   301→        { "id": "rock_1", "text": "完成3.2节初稿", "role": "创作者", "completed": true },
   302→        { "id": "rock_2", "text": "周三带孩子去公园", "role": "父亲", "completed": false },
   303→        { "id": "rock_3", "text": "周六约会", "role": "丈夫", "completed": false },
   304→        { "id": "rock_4", "text": "跑步3次", "role": "个人", "completed": false }
   305→      ],
   306→      "roleBalance": {
   307→        "创作者": 80,
   308→        "父亲": 60,
   309→        "丈夫": 40,
   310→        "个人": 20
   311→      }
   312→    },
   313→
   314→    "growth": {
   315→      "milestones": [
   316→        { "date": "2026-01-01", "title": "设定年度愿景", "type": "past" },
   317→        { "date": "2026-01-07", "title": "完成第一周签到", "type": "past" },
   318→        { "date": "2026-01-15", "title": "第2章定稿", "type": "past" },
   319→        { "date": "2026-01-19", "title": "今天", "type": "today" },
   320→        { "date": "2026-01-31", "title": "月度目标: 第3章完成", "type": "future" }
   321→      ],
   322→      "stats": {
   323→        "totalDays": 19,
   324→        "goalsCompleted": 5,
   325→        "insightsGained": 12
   326→      }
   327→    }
   328→  },
   329→  "meta": {
   330→    "cached": false,
   331→    "cacheKey": "dashboard:user_123:20260119"
   332→  }
   333→}
   334→```
   335→
   336→### POST /api/dashboard/checkin
   337→
   338→```typescript
   339→// 请求
   340→POST /api/dashboard/checkin
   341→Headers:
   342→  Authorization: Bearer {token}
   343→Body:
   344→  {
   345→    "timestamp": "2026-01-19T08:30:00Z"
   346→  }
   347→
   348→// 响应
   349→{
   350→  "success": true,
   351→  "data": {
   352→    "streak": 8,
   353→    "message": "太棒了！连续第8天签到！",
   354→    "animation": "fire",
   355→    "today": {
   356→      "checkedIn": true,
   357→      "checkinTime": "2026-01-19T08:30:00Z",
   358→      "streak": 8
   359→    }
   360→  }
   361→}
   362→```
   363→
   364→### PATCH /api/dashboard/lever/{lever_id}
   365→
   366→```typescript
   367→// 请求
   368→PATCH /api/dashboard/lever/lever_1
   369→Headers:
   370→  Authorization: Bearer {token}
   371→Body:
   372→  {
   373→    "completed": true
   374→  }
   375→
   376→// 响应
   377→{
   378→  "success": true,
   379→  "data": {
   380→    "lever": {
   381→      "id": "lever_1",
   382→      "text": "完成3.2节初稿",
   383→      "completed": true,
   384→      "completedAt": "2026-01-19T10:30:00Z"
   385→    },
   386→    "todayProgress": {
   387→      "completed": 1,
   388→      "total": 3,
   389→      "percentage": 33
   390→    },
   391→    "allCompleted": false
   392→  }
   393→}
   394→
   395→// 全部完成时
   396→{
   397→  "success": true,
   398→  "data": {
   399→    "lever": { ... },
   400→    "todayProgress": {
   401→      "completed": 3,
   402→      "total": 3,
   403→      "percentage": 100
   404→    },
   405→    "allCompleted": true,
   406→    "celebration": {
   407→      "message": "今日目标全部完成！太棒了！",
   408→      "animation": "confetti"
   409→    }
   410→  }
   411→}
   412→```
   413→
   414→### PATCH /api/dashboard/rock/{rock_id}
   415→
   416→```typescript
   417→// 请求
   418→PATCH /api/dashboard/rock/rock_2
   419→Headers:
   420→  Authorization: Bearer {token}
   421→Body:
   422→  {
   423→    "completed": true
   424→  }
   425→
   426→// 响应
   427→{
   428→  "success": true,
   429→  "data": {
   430→    "rock": {
   431→      "id": "rock_2",
   432→      "text": "周三带孩子去公园",
   433→      "role": "父亲",
   434→      "completed": true,
   435→      "completedAt": "2026-01-19T15:00:00Z"
   436→    },
   437→    "weekProgress": {
   438→      "completed": 2,
   439→      "total": 4,
   440→      "percentage": 50
   441→    },
   442→    "roleBalance": {
   443→      "创作者": 80,
   444→      "父亲": 80,  // 更新
   445→      "丈夫": 40,
   446→      "个人": 20
   447→    }
   448→  }
   449→}
   450→```
   451→
   452→---
   453→
   454→## 缓存策略
   455→
   456→```
   457→┌─────────────────────────────────────────────────────────────────────────────────┐
   458→│                              缓存层级                                            │
   459→├─────────────────────────────────────────────────────────────────────────────────┤
   460→│                                                                                  │
   461→│   Layer 1: 浏览器缓存 (SWR)                                                      │
   462→│   ═══════════════════════════                                                    │
   463→│                                                                                  │
   464→│   ┌─────────────────────────────────────────────────────────────────────────┐   │
   465→│   │                                                                         │   │
   466→│   │   useSWR('/api/dashboard', fetcher, {                                   │   │
   467→│   │     revalidateOnFocus: false,      // 聚焦时不重新验证                   │   │
   468→│   │     revalidateOnReconnect: true,   // 重连时重新验证                     │   │
   469→│   │     dedupingInterval: 60000,       // 1分钟内去重                        │   │
   470→│   │     focusThrottleInterval: 5000,   // 聚焦节流                           │   │
   471→│   │     errorRetryCount: 3,            // 错误重试次数                       │   │
   472→│   │     fallbackData: cachedDashboard, // 离线降级数据                       │   │
   473→│   │   });                                                                   │   │
   474→│   │                                                                         │   │
   475→│   └─────────────────────────────────────────────────────────────────────────┘   │
   476→│                                                                                  │
   477→│   TTL: 内存中保持，刷新页面后使用 fallbackData                                   │
   478→│                                                                                  │
   479→│   ─────────────────────────────────────────────────────────────────────────────  │
   480→│                                                                                  │
   481→│   Layer 2: API 缓存 (Redis / Memory)                                            │
   482→│   ════════════════════════════════════                                           │
   483→│                                                                                  │
   484→│   ┌─────────────────────────────────────────────────────────────────────────┐   │
   485→│   │                                                                         │   │
   486→│   │   # API 缓存策略                                                         │   │
   487→│   │   cache_key = f"dashboard:{user_id}:{date}"                             │   │
   488→│   │   ttl = 300  # 5 分钟                                                   │   │
   489→│   │                                                                         │   │
   490→│   │   # 缓存失效条件                                                         │   │
   491→│   │   - 用户签到 → 失效 today 部分                                           │   │
   492→│   │   - 用户更新 lever/rock → 失效对应部分                                   │   │
   493→│   │   - Proactive 推送 → 失效 proactive 部分                                 │   │
   494→│   │   - 每日 00:00 → 全部失效 (新的一天)                                     │   │
   495→│   │                                                                         │   │
   496→│   └─────────────────────────────────────────────────────────────────────────┘   │
   497→│                                                                                  │
   498→│   ─────────────────────────────────────────────────────────────────────────────  │
   499→│                                                                                  │
   500→│   Layer 3: 数据库缓存 (VibeProfile)                                             │
   501→│   ════════════════════════════════════                                           │
   502→│                                                                                  │
   503→│   ┌─────────────────────────────────────────────────────────────────────────┐   │
   504→│   │                                                                         │   │
   505→│   │   # VibeProfileRepository 内置缓存                                       │   │
   506→│   │   cache_ttl = 300  # 5 分钟                                             │   │
   507→│   │                                                                         │   │
   508→│   │   # 写入时自动失效                                                       │   │
   509→│   │   def update_profile(user_id, data):                                    │   │
   510→│   │       result = db.update(...)                                           │   │
   511→│   │       cache.delete(f"profile:{user_id}")  # 失效缓存                    │   │
   512→│   │       return result                                                     │   │
   513→│   │                                                                         │   │
   514→│   └─────────────────────────────────────────────────────────────────────────┘   │
   515→│                                                                                  │
   516→└─────────────────────────────────────────────────────────────────────────────────┘
   517→```
   518→
   519→---
   520→
   521→## 实时更新机制
   522→
   523→```
   524→┌─────────────────────────────────────────────────────────────────────────────────┐
   525→│                              实时更新方案                                        │
   526→├─────────────────────────────────────────────────────────────────────────────────┤
   527→│                                                                                  │
   528→│   方案 A: 轮询 (简单)                                                            │
   529→│   ════════════════════                                                           │
   530→│                                                                                  │
   531→│   ┌─────────────────────────────────────────────────────────────────────────┐   │
   532→│   │                                                                         │   │
   533→│   │   useSWR('/api/dashboard', fetcher, {                                   │   │
   534→│   │     refreshInterval: 60000,  // 每分钟刷新                              │   │
   535→│   │   });                                                                   │   │
   536→│   │                                                                         │   │
   537→│   └─────────────────────────────────────────────────────────────────────────┘   │
   538→│                                                                                  │
   539→│   适用: MVP 阶段，用户量小                                                       │
   540→│                                                                                  │
   541→│   ─────────────────────────────────────────────────────────────────────────────  │
   542→│                                                                                  │
   543→│   方案 B: SSE (Server-Sent Events)                                              │
   544→│   ════════════════════════════════                                               │
   545→│                                                                                  │
   546→│   ┌─────────────────────────────────────────────────────────────────────────┐   │
   547→│   │                                                                         │   │
   548→│   │   // 前端                                                                │   │
   549→│   │   useEffect(() => {                                                     │   │
   550→│   │     const source = new EventSource('/api/dashboard/updates');           │   │
   551→│   │                                                                         │   │
   552→│   │     source.onmessage = (event) => {                                     │   │
   553→│   │       const update = JSON.parse(event.data);                            │   │
   554→│   │       mutate(current => ({ ...current, ...update }), false);            │   │
   555→│   │     };                                                                  │   │
   556→│   │                                                                         │   │
   557→│   │     return () => source.close();                                        │   │
   558→│   │   }, []);                                                               │   │
   559→│   │                                                                         │   │
   560→│   │   // 后端推送事件                                                        │   │
   561→│   │   - proactive_message: 主动推送消息                                      │   │
   562→│   │   - streak_update: 签到更新                                             │   │
   563→│   │   - milestone_achieved: 里程碑达成                                       │   │
   564→│   │                                                                         │   │
   565→│   └─────────────────────────────────────────────────────────────────────────┘   │
   566→│                                                                                  │
   567→│   适用: 需要实时推送主动消息                                                     │
   568→│                                                                                  │
   569→│   ─────────────────────────────────────────────────────────────────────────────  │
   570→│                                                                                  │
   571→│   方案 C: WebSocket (高实时)                                                     │
   572→│   ════════════════════════                                                       │
   573→│                                                                                  │
   574→│   适用: 多端同步、协作场景                                                       │
   575→│   当前不需要，留作扩展                                                           │
   576→│                                                                                  │
   577→└─────────────────────────────────────────────────────────────────────────────────┘
   578→```
   579→
   580→---
   581→
   582→## 前端状态管理
   583→
   584→```typescript
   585→// src/stores/dashboardStore.ts
   586→
   587→import { create } from 'zustand';
   588→import { persist } from 'zustand/middleware';
   589→import type { DashboardDTO } from '@/types/dashboard';
   590→
   591→interface DashboardState {
   592→  // 数据
   593→  dashboard: DashboardDTO | null;
   594→  isLoading: boolean;
   595→  error: Error | null;
   596→  lastUpdated: string | null;
   597→
   598→  // 操作
   599→  setDashboard: (data: DashboardDTO) => void;
   600→  updateToday: (updates: Partial<DashboardDTO['today']>) => void;
   601→  updateWeek: (updates: Partial<DashboardDTO['week']>) => void;
   602→  toggleLever: (leverId: string) => void;
   603→  toggleRock: (rockId: string) => void;
   604→  setCheckedIn: (streak: number) => void;
   605→
   606→  // 状态
   607→  isInitialized: boolean;
   608→  initialize: () => void;
   609→}
   610→
   611→export const useDashboardStore = create<DashboardState>()(
   612→  persist(
   613→    (set, get) => ({
   614→      dashboard: null,
   615→      isLoading: false,
   616→      error: null,
   617→      lastUpdated: null,
   618→      isInitialized: false,
   619→
   620→      setDashboard: (data) => set({
   621→        dashboard: data,
   622→        lastUpdated: new Date().toISOString(),
   623→        isLoading: false,
   624→        error: null
   625→      }),
   626→
   627→      updateToday: (updates) => set((state) => ({
   628→        dashboard: state.dashboard ? {
   629→          ...state.dashboard,
   630→          today: { ...state.dashboard.today, ...updates }
   631→        } : null
   632→      })),
   633→
   634→      updateWeek: (updates) => set((state) => ({
   635→        dashboard: state.dashboard ? {
   636→          ...state.dashboard,
   637→          week: { ...state.dashboard.week, ...updates }
   638→        } : null
   639→      })),
   640→
   641→      toggleLever: (leverId) => set((state) => {
   642→        if (!state.dashboard) return state;
   643→
   644→        const levers = state.dashboard.today.levers.map(lever =>
   645→          lever.id === leverId
   646→            ? { ...lever, completed: !lever.completed }
   647→            : lever
   648→        );
   649→
   650→        return {
   651→          dashboard: {
   652→            ...state.dashboard,
   653→            today: { ...state.dashboard.today, levers }
   654→          }
   655→        };
   656→      }),
   657→
   658→      toggleRock: (rockId) => set((state) => {
   659→        if (!state.dashboard) return state;
   660→
   661→        const rocks = state.dashboard.week.rocks.map(rock =>
   662→          rock.id === rockId
   663→            ? { ...rock, completed: !rock.completed }
   664→            : rock
   665→        );
   666→
   667→        // 重新计算角色平衡
   668→        const roleBalance = calculateRoleBalance(rocks);
   669→
   670→        return {
   671→          dashboard: {
   672→            ...state.dashboard,
   673→            week: { ...state.dashboard.week, rocks, roleBalance }
   674→          }
   675→        };
   676→      }),
   677→
   678→      setCheckedIn: (streak) => set((state) => ({
   679→        dashboard: state.dashboard ? {
   680→          ...state.dashboard,
   681→          today: { ...state.dashboard.today, checkedIn: true, streak }
   682→        } : null
   683→      })),
   684→
   685→      initialize: () => set({ isInitialized: true })
   686→    }),
   687→    {
   688→      name: 'vibelife-dashboard',
   689→      partialize: (state) => ({
   690→        dashboard: state.dashboard,
   691→        lastUpdated: state.lastUpdated
   692→      })
   693→    }
   694→  )
   695→);
   696→
   697→// 辅助函数
   698→function calculateRoleBalance(rocks: DashboardDTO['week']['rocks']) {
   699→  const roleCount: Record<string, { completed: number; total: number }> = {};
   700→
   701→  rocks.forEach(rock => {
   702→    if (!roleCount[rock.role]) {
   703→      roleCount[rock.role] = { completed: 0, total: 0 };
   704→    }
   705→    roleCount[rock.role].total++;
   706→    if (rock.completed) {
   707→      roleCount[rock.role].completed++;
   708→    }
   709→  });
   710→
   711→  const balance: Record<string, number> = {};
   712→  Object.entries(roleCount).forEach(([role, { completed, total }]) => {
   713→    balance[role] = Math.round((completed / total) * 100);
   714→  });
   715→
   716→  return balance;
   717→}
   718→```
   719→
   720→---
   721→
   722→## 数据同步时序图
   723→
   724→```
   725→┌─────────────────────────────────────────────────────────────────────────────────┐
   726→│                           签到流程时序图                                         │
   727→├─────────────────────────────────────────────────────────────────────────────────┤
   728→│                                                                                  │
   729→│   User        Dashboard       Store        API          Backend       DB         │
   730→│     │            │             │            │              │           │         │
   731→│     │  点击签到  │             │            │              │           │         │
   732→│     │──────────▶│             │            │              │           │         │
   733→│     │            │             │            │              │           │         │
   734→│     │            │ 乐观更新    │            │              │           │         │
   735→│     │            │────────────▶│            │              │           │         │
   736→│     │            │             │ streak+1   │              │           │         │
   737→│     │            │             │ UI 更新    │              │           │         │
   738→│     │            │◀────────────│            │              │           │         │
   739→│     │  看到动画  │             │            │              │           │         │
   740→│     │◀───────────│             │            │              │           │         │
   741→│     │            │             │            │              │           │         │
   742→│     │            │             │  POST      │              │           │         │
   743→│     │            │             │───────────▶│              │           │         │
   744→│     │            │             │            │  check_in()  │           │         │
   745→│     │            │             │            │─────────────▶│           │         │
   746→│     │            │             │            │              │ UPDATE    │         │
   747→│     │            │             │            │              │──────────▶│         │
   748→│     │            │             │            │              │◀──────────│         │
   749→│     │            │             │            │◀─────────────│           │         │
   750→│     │            │             │            │  {streak: 8} │           │         │
   751→│     │            │             │◀───────────│              │           │         │
   752→│     │            │             │ 验证更新   │              │           │         │
   753→│     │            │◀────────────│ streak=8   │              │           │         │
   754→│     │  数据一致  │             │            │              │           │         │
   755→│     │◀───────────│             │            │              │           │         │
   756→│     │            │             │            │              │           │         │
   757→│                                                                                  │
   758→│   ─────────────────────────────────────────────────────────────────────────────  │
   759→│                                                                                  │
   760→│   如果 API 失败:                                                                 │
   761→│     │            │             │            │              │           │         │
   762→│     │            │             │  POST      │              │           │         │
   763→│     │            │             │───────────▶│              │           │         │
   764→│     │            │             │            │  ✗ 错误      │           │         │
   765→│     │            │             │◀───────────│              │           │         │
   766→│     │            │             │ 回滚       │              │           │         │
   767→│     │            │◀────────────│ streak=7   │              │           │         │
   768→│     │  显示错误  │             │            │              │           │         │
   769→│     │◀───────────│             │            │              │           │         │
   770→│     │            │             │            │              │           │         │
   771→│                                                                                  │
   772→└─────────────────────────────────────────────────────────────────────────────────┘
   773→```
   774→
   775→---
   776→
   777→> **Version**: 1.0 | 2026-01-19
   778→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
