     1→# VibeLife V6.8 系统架构文档
     2→
     3→> Version: 6.8 | 2026-01-15
     4→> 基于深度分析生成的系统架构文档
     5→
     6→---
     7→
     8→## 1. 顶层系统架构图
     9→
    10→```
    11→┌─────────────────────────────────────────────────────────────────────────────────┐
    12→│                           VibeLife V6.8 系统架构                                  │
    13→├─────────────────────────────────────────────────────────────────────────────────┤
    14→│                                                                                 │
    15→│  ┌─────────────────────────────────────────────────────────────────────────┐   │
    16→│  │                         Frontend Layer (Next.js 14)                      │   │
    17→│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────────┐  │   │
    18→│  │  │ useVibeChat  │  │ CardRegistry │  │useToolSchema │  │AuthProvider │  │   │
    19→│  │  │ (AI SDK 4.x) │  │ (动态卡片)    │  │ (工具Schema) │  │ (认证状态)   │  │   │
    20→│  │  └──────┬───────┘  └──────────────┘  └──────────────┘  └─────────────┘  │   │
    21→│  │         │                                                                │   │
    22→│  │         │ SSE Stream (AI SDK Data Protocol)                              │   │
    23→│  │         ▼                                                                │   │
    24→│  │  ┌──────────────────────────────────────────────────────────────────┐   │   │
    25→│  │  │              Next.js Rewrites Proxy                               │   │   │
    26→│  │  │              /api/v1/* → Python API                               │   │   │
    27→│  │  └──────────────────────────────────────────────────────────────────┘   │   │
    28→│  └─────────────────────────────────────────────────────────────────────────┘   │
    29→│                                        │                                        │
    30→│                                        ▼                                        │
    31→│  ┌─────────────────────────────────────────────────────────────────────────┐   │
    32→│  │                         Backend Layer (FastAPI)                          │   │
    33→│  │                                                                          │   │
    34→│  │  ┌────────────────────────────────────────────────────────────────┐     │   │
    35→│  │  │                    API Routes Layer (精简)                      │     │   │
    36→│  │  │                                                                 │     │   │
    37→│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │     │   │
    38→│  │  │  │ chat_v5.py   │  │ skills.py    │  │ 平台服务 (3个文件)    │  │     │   │
    39→│  │  │  │              │  │              │  │                      │  │     │   │
    40→│  │  │  │ CoreAgent    │  │ Skill        │  │ • account.py         │  │     │   │
    41→│  │  │  │ 对话入口     │  │ Gateway      │  │   (auth+users+id)    │  │     │   │
    42→│  │  │  │              │  │ (配置驱动)   │  │ • commerce.py        │  │     │   │
    43→│  │  │  │ 独立路由     │  │ 统一路由     │  │   (pay+bill+entitle) │  │     │   │
    44→│  │  │  │              │  │              │  │ • notifications.py   │  │     │   │
    45→│  │  │  └──────┬───────┘  └──────┬───────┘  └──────────┬───────────┘  │     │   │
    46→│  │  └─────────┼─────────────────┼────────────────────┼───────────────┘     │   │
    47→│  │            │                 │                    │                      │   │
    48→│  │            ▼                 ▼                    ▼                      │   │
    49→│  │  ┌────────────────────────────────────────────────────────────────┐     │   │
    50→│  │  │                    Service Layer                                │     │   │
    51→│  │  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │     │   │
    52→│  │  │  │  CoreAgent   │  │ SkillService │  │  Platform Services   │  │     │   │
    53→│  │  │  │  (core.py)   │  │ Registry     │  │                      │  │     │   │
    54→│  │  │  │              │  │ (自动发现)   │  │ • Identity           │  │     │   │
    55→│  │  │  │ - Agentic    │  │              │  │ • Billing            │  │     │   │
    56→│  │  │  │   Loop       │  │ - Bazi       │  │ • Entitlement        │  │     │   │
    57→│  │  │  │ - Tool Use   │  │ - Zodiac     │  │ • Notification       │  │     │   │
    58→│  │  │  │ - SOP引擎    │  │ - Tarot      │  │                      │  │     │   │
    59→│  │  │  │              │  │ - Career     │  │                      │  │     │   │
    60→│  │  │  └──────────────┘  └──────────────┘  └──────────────────────┘  │     │   │
    61→│  │  └────────────────────────────────────────────────────────────────┘     │   │
    62→│  │                                                                          │   │
    63→│  └─────────────────────────────────────────────────────────────────────────┘   │
    64→│                                        │                                        │
    65→│                                        ▼                                        │
    66→│  ┌─────────────────────────────────────────────────────────────────────────┐   │
    67→│  │                         Skill Layer (DDD架构)                            │   │
    68→│  │                                                                          │   │
    69→│  │  ┌─────────────┐  ┌─────────────┐  ┌───��─────────┐  ┌─────────────┐     │   │
    70→│  │  │  skills/    │  │  skills/    │  │  skills/    │  │  skills/    │     │   │
    71→│  │  │  bazi/      │  │  zodiac/    │  │  tarot/     │  │  career/    │     │   │
    72→│  │  │             │  │             │  │             │  │             │     │   │
    73→│  │  │ ├─SKILL.md  │  │ ├─SKILL.md  │  │ ├─SKILL.md  │  │ ├─SKILL.md  │     │   │
    74→│  │  │ ├─services/ │  │ ├─services/ │  │ ├─tools/    │  │ ├─tools/    │     │   │
    75→│  │  │ │ ├─api.py  │  │ │ ├─api.py  │  │ │ ├─yaml    │  │ │ ├─yaml    │     │   │
    76→│  │  │ │ ├─calc.py │  │ │ ├─calc.py │  │ │ └─handler │  │ │ └─handler │     │   │
    77→│  │  │ │ └─comp.py │  │ │ └─comp.py │  │ └─scenarios │  │ └─scenarios │     │   │
    78→│  │  │ ├─tools/    │  │ ├─tools/    │  │             │  │             │     │   │
    79→│  │  │ └─scenarios │  │ └─scenarios │  │             │  │             │     │   │
    80→│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │   │
    81→│  │                                                                          │   │
    82→│  └─────────────────────────────────────────────────────────────────────────┘   │
    83→│                                        │                                        │
    84→│                                        ▼                                        │
    85→│  ┌─────────────────────────────────────────────────────────────────────────┐   │
    86→│  │                         Data Layer                                       │   │
    87→│  │                                                                          │   │
    88→│  │  ┌──────────────────────────┐  ┌──────────────────────────────────┐     │   │
    89→│  │  │   PostgreSQL 16          │  │   Local Embedding                 │     │   │
    90→│  │  │   (pgvector 扩展)        │  │   BAAI/bge-m3 (CUDA)              │     │   │
    91→│  │  │                          │  │   1024维向量                       │     │   │
    92→│  │  │   - unified_profiles     │  │                                   │     │   │
    93→│  │  │   - conversations        │  │   用途:                           │     │   │
    94→│  │  │   - messages             │  │   - 知识检索                       │     │   │
    95→│  │  │   - knowledge_chunks     │  │   - 案例匹配                       │     │   │
    96→│  │  │   - cases                │  │   - 场景路由                       │     │   │
    97→│  │  │   - subscriptions        │  │                                   │     │   │
    98→│  │  │   - payments             │  └──────────────────────────────────┘     │   │
    99→│  │  └──────────────────────────┘                                           │   │
   100→│  │                                                                          │   │
   101→│  └─────────────────────────────────────────────────────────────────────────┘   │
   102→│                                                                                 │
   103→│  ┌─────────────────────────────────────────────────────────────────────────┐   │
   104→│  │                         External Services                                │   │
   105→│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │   │
   106→│  │  │ Zhipu    │  │ DeepSeek │  │ Claude   │  │ Gemini   │  │ Stripe   │  │   │
   107→│  │  │ GLM-4.7  │  │ V3       │  │ Opus     │  │ 2.5      │  │ Payment  │  │   │
   108→│  │  │ (主对话) │  │ (推理)   │  │ (备选)   │  │ (生图)   │  │          │  │   │
   109→│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │   │
   110→│  └─────────────────────────────────────────────────────────────────────────┘   │
   111→│                                                                                 │
   112→│  ┌─────────────────────────────────────────────────────────────────────────┐   │
   113→│  │                    Background Workers (不暴露 API)                       │   │
   114→│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                   │   │
   115→│  │  │ Proactive    │  │ Profile      │  │ Ingestion    │                   │   │
   116→│  │  │ Worker       │  │ Extractor    │  │ Worker       │                   │   │
   117→│  │  │ (主动推送)   │  │ (画像抽取)   │  │ (知识入库)   │                   │   │
   118→│  │  └──────────────┘  └──────────────┘  └──────────────┘                   │   │
   119→│  └─────────────────────────────────────────────────────────────────────────┘   │
   120→│                                                                                 │
   121→└─────────────────────────────────────────────────────────────────────────────────┘
   122→```
   123→
   124→---
   125→
   126→## 2. API 路由架构
   127→
   128→### 2.1 路由文件结构 (精简后)
   129→
   130→```
   131→routes/
   132→├── chat_v5.py          # 对话入口 - CoreAgent (独立)
   133→├── skills.py           # Skill Gateway - 配置驱动 (统一)
   134→├── account.py          # 用户域 - auth + users + identity (合并)
   135→├── commerce.py         # 支付域 - payment + billing + entitlement (合并)
   136→├── notifications.py    # 通知域 (独立)
   137→├── health.py           # 健康检查
   138→└── tools.py            # 工具 Schema API
   139→
   140→删除 (迁移到 skills.py):
   141→├── bazi.py
   142→├── zodiac.py
   143→└── fortune.py
   144→```
   145→
   146→### 2.2 API 端点设计
   147→
   148→| 类型 | 端点 | 处理方式 | 说明 |
   149→|------|------|----------|------|
   150→| **对话** | `/chat/v5/stream` | CoreAgent | 独立路由，流式 SSE |
   151→| **Skill** | `/skills/{skill_id}/{action}` | SkillServiceRegistry | 配置驱动，自动发现 |
   152→| **用户** | `/account/*` | 代码驱动 | auth/users/identity 合并 |
   153→| **支付** | `/commerce/*` | 代码驱动 | payment/billing/entitlement 合并 |
   154→| **通知** | `/notifications/*` | 代码驱动 | 推送结果查询 |
   155→
   156→### 2.3 Skill Gateway 详细设计
   157→
   158→```
   159→/api/v1/skills/{skill_id}/{action}
   160→
   161→示例:
   162→├── /skills/bazi/chart        # 八字命盘
   163→├── /skills/bazi/fortune      # 八字运势
   164→├── /skills/bazi/kline        # 运势K线
   165→├── /skills/zodiac/chart      # 星盘
   166→├── /skills/zodiac/transit    # 行运
   167→├── /skills/tarot/draw        # 抽牌
   168→└── /skills/career/assess     # 职业评估
   169→
   170→新增 Skill 只需:
   171→1. 创建 skills/{new_skill}/services/api.py
   172→2. 添加 @skill_service 装饰的方法
   173→无需修改 routes/ 或 main.py
   174→```
   175→
   176→### 2.4 SkillServiceRegistry 实现
   177→
   178→```python
   179→class SkillServiceRegistry:
   180→    """统一 Skill 服务注册表 - 配置驱动"""
   181→    
   182→    _services: Dict[tuple, Callable] = {}  # {(skill_id, action): handler}
   183→    
   184→    @classmethod
   185→    def initialize()                       # 自动发现所有 Skill
   186→    @classmethod
   187→    async def execute(skill_id, action, args, context) -> Dict
   188→    @classmethod
   189→    def list_services(skill_id) -> list
   190→
   191→def skill_service(skill_id: str, action: str):
   192→    """装饰器 - 自动注册服务"""
   193→    
   194→# 使用示例
   195→@skill_service("bazi", "chart")
   196→async def get_bazi_chart(args, context) -> Dict:
   197→    return calculate_bazi(...)
   198→```
   199→
   200→---
   201→
   202→## 3. 核心时序图
   203→
   204→### 3.1 对话流程
   205→
   206→```
   207→┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────┐
   208→│ Browser │     │  Next.js    │     │ Python API  │     │  CoreAgent  │     │ LLM API │
   209→└────┬────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └────┬────┘
   210→     │                 │                   │                   │                 │
   211→     │ 1. sendMessage  │                   │                   │                 │
   212→     │ POST /chat/v5/  │                   │                   │                 │
   213→     │ stream          │                   │                   │                 │
   214→     │────────────────>│                   │                   │                 │
   215→     │                 │ 2. rewrites       │                   │                 │
   216→     │                 │──────────────────>│                   │                 │
   217→     │                 │                   │ 3. 配额检查       │                 │
   218→     │                 │                   │──────┐            │                 │
   219→     │                 │                   │<─────┘            │                 │
   220→     │                 │                   │ 4. 获取用户上下文 │                 │
   221→     │                 │                   │──────┐            │                 │
   222→     │                 │                   │<─────┘            │                 │
   223→     │                 │                   │ 5. CoreAgent.run()│                 │
   224→     │                 │                   │────��─────────────>│                 │
   225→     │                 │                   │                   │ 6. LLM调用     │
   226→     │                 │                   │                   │────────────────>│
   227→     │                 │                   │                   │<────────────────│
   228→     │                 │                   │                   │ 7. Tool执行?   │
   229→     │                 │                   │                   │──────┐         │
   230→     │                 │                   │                   │<─────┘         │
   231→     │                 │                   │ 8. SSE事件流     │                 │
   232→     │                 │                   │<──────────────────│                 │
   233→     │                 │ 9. 转发SSE       │                   │                 │
   234→     │                 │<──────────────────│                   │                 │
   235→     │ 10. 渲染消息    │                   │                   │                 │
   236→     │<────────────────│                   │                   │                 │
   237→```
   238→
   239→### 3.2 Skill 数据服务流程
   240→
   241→```
   242→┌─────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
   243→│ Browser │     │  Next.js    │     │ skills.py   │     │ SkillService│
   244→└────┬────┘     └──────┬──────┘     └──────┬──────┘     └──────┬──────┘
   245→     │                 │                   │                   │
   246→     │ 1. POST         │                   │                   │
   247→     │ /skills/bazi/   │                   │                   │
   248→     │ chart           │                   │                   │
   249→     │────────────────>│                   │                   │
   250→     │                 │ 2. rewrites       │                   │
   251→     │                 │──────────────────>│                   │
   252→     │                 │                   │ 3. Registry       │
   253→     │                 │                   │    .execute()     │
   254→     │                 │                   │──────────────────>│
   255→     │                 │                   │                   │
   256→     │                 │                   │                   │ 4. 计算命盘
   257→     │                 │                   │                   │──────┐
   258→     │                 │                   │                   │<─────┘
   259→     │                 │                   │ 5. 返回结果       │
   260→     │                 │                   │<──────────────────│
   261→     │                 │ 6. JSON响应      │                   │
   262→     │                 │<──────────────────│                   │
   263→     │ 7. 渲染数据     │                   │                   │
   264→     │<────────────────│                   │                   │
   265→```
   266→
   267→---
   268→
   269→## 4. 关键程序和数据结构
   270→
   271→### 4.1 CoreAgent (`services/agent/core.py`)
   272→
   273→```python
   274→class CoreAgent:
   275→    """CoreAgent v6 - Agentic Loop 实现"""
   276→    
   277→    llm: LLMClient                    # LLM 客户端
   278→    knowledge_repo: KnowledgeRepository  # 知识库
   279→    max_iterations: int = 10          # 最大迭代次数
   280→    
   281→    async def run(message, context) -> AsyncGenerator[AgentEvent]
   282→    async def _build_system_prompt(message, context) -> str
   283→    async def _execute_tool(tool_name, tool_args, context) -> Dict
   284→
   285→@dataclass
   286→class AgentContext:
   287→    user_id: str
   288→    user_tier: str = "free"
   289→    profile: Dict[str, Any]
   290→    skill_data: Dict[str, Any]
   291→    history: List[Dict[str, str]]
   292→    skill: Optional[str]
   293→    scenario: Optional[str]
   294→    voice_mode: str = "warm"
   295→```
   296→
   297→### 4.2 ToolRegistry (`services/agent/tool_registry.py`)
   298→
   299→```python
   300→class UnifiedToolRegistry:
   301→    """统一工具注册表 - 用于 CoreAgent Tool Use"""
   302→    
   303→    _tool_defs: Dict[str, ToolDef] = {}   # 工具定义
   304→    _handlers: Dict[str, ToolHandler] = {} # 工具执行器
   305→    
   306→    @classmethod
   307→    def get_tools_for_skill(skill_id) -> List[Dict]
   308→    @classmethod
   309→    async def execute(tool_name, args, context) -> Dict
   310→
   311→def tool_handler(tool_name: str):
   312→    """装饰器 - 自动注册工具"""
   313→```
   314→
   315→### 4.3 统一 Profile (`stores/unified_profile_repo.py`)
   316→
   317→```python
   318→class UnifiedProfileRepository:
   319→    """统一 Profile 数据访问层"""
   320→    
   321→    # 读取
   322→    async def get_profile(user_id) -> Dict
   323→    async def get_birth_info(user_id) -> Dict
   324→    async def get_skill_data(user_id, skill) -> Dict
   325→    async def get_extracted(user_id) -> Dict
   326→    
   327→    # 写入 (使用 jsonb_set 局部更新)
   328→    async def update_birth_info(user_id, birth_info)
   329→    async def update_skill_data(user_id, skill, data)
   330→    async def update_extracted(user_id, extracted)
   331→```
   332→
   333→---
   334→
   335→## 5. 数据流
   336→
   337→### 5.1 对话数据流
   338→
   339→```
   340→用户输入 → useVibeChat → /chat/v5/stream
   341→                              │
   342→                              ├─ [A] 配额检查 (QuotaTracker)
   343→                              │
   344→                              ├─ [B] CoreAgent 处理
   345→                              │      ├─ 构建 context (profile + skill_data)
   346→                              │      ├─ LLM 调用 (GLM/DeepSeek)
   347→                              │      ├─ Tool calling + 执行
   348→                              │      └─ 流式输出 SSE
   349→                              │
   350→                              └─ [C] 保存消息 + 记录配额
   351→                              │
   352→                              ▼
   353→                    SSE 响应 (AI SDK Protocol)
   354→                              │
   355→                              ▼
   356→                    Browser 渲染
   357→```
   358→
   359→### 5.2 Profile 数据流
   360→
   361→```
   362→用户对话 → messages 表
   363→    ↓
   364→profile_extractor (每日凌晨3点)
   365→    ↓
   366→unified_profiles.profile.extracted
   367→    ↓
   368→CoreAgent._build_system_prompt() → 传递完整 profile
   369→    ↓
   370→skill_loader.build_system_prompt() → 自动格式化注入
   371→    ↓
   372→LLM System Prompt (包含 facts/concerns/goals/pain_points/life_events)
   373→```
   374→
   375→---
   376→
   377→## 6. 新增 Skill 流程
   378→
   379→```
   380→新增 Tarot Skill:
   381→
   382→1. 创建目录结构
   383→   skills/tarot/
   384→   ├── SKILL.md              # Skill 定义
   385→   ├── services/
   386→   │   ├── __init__.py
   387→   │   ├── api.py            # @skill_service 装饰的 API
   388→   │   └── calculator.py     # 业务逻辑
   389→   ├── tools/
   390→   │   ├── tools.yaml        # 工具定义
   391→   │   └── handlers.py       # @tool_handler 装饰的执行器
   392→   └── scenarios/            # 场景定义
   393→
   394→2. 无需修改:
   395→   - routes/*.py
   396→   - main.py
   397→   
   398→   SkillServiceRegistry 和 ToolRegistry 自动发现
   399→```
   400→
   401→---
   402→
   403→## 7. 设计原则
   404→
   405→| 原则 | 说明 |
   406→|------|------|
   407→| **对话独立** | chat-v5 保持独立，不与其他 API 混淆 |
   408→| **Skill 配置驱动** | 新增 Skill 无需改路由，自动发现 |
   409→| **平台代码驱动** | 认证/支付等安全敏感功能保持代码控制 |
   410→| **后台不暴露** | Worker 进程不暴露 API，内部调度 |
   411→| **Single Source of Truth** | 工具定义 YAML、模型配置 YAML |
   412→
   413→---
   414→
   415→## 8. 与旧架构对比
   416→
   417→| 方面 | 旧架构 | 新架构 |
   418→|------|--------|--------|
   419→| 路由文件数 | 17+ 个 | 6 个 |
   420→| 新增 Skill | 改 3 处 | 改 1 处 |
   421→| Skill API | 分散 (bazi.py, zodiac.py...) | 统一 (skills.py) |
   422→| 平台 API | 分散 (7个文件) | 合并 (3个文件) |
   423→| 注册方式 | 手动 import | 自动发现 |
   424→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
