The file /home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
    42→        if self._llm_service is None:
    43→            self._llm_service = LLMService()
    44→        return self._llm_service
    45→
    46→    async def generate(
    47→        self,
    48→        task: ReminderTask,
    49→        profile: Dict[str, Any],
    50→        config: Dict[str, Any],
    51→    ) -> ReminderContent:
    52→        """
    53→        生成个性化提醒内容
    54→
    55→        Args:
    56→            task: 提醒任务
    57→            profile: 用户画像 (from unified_profiles)
    58→            config: 提醒配置 (from reminders.yaml)
    59→
    60→        Returns:
    61→            ReminderContent
    62→        """
    63→        reminder_type = task.reminder_type
    64→        skill_id = task.skill_id
    65→
    66→        # 检查是否使用 rules/ 架构
    67→        content_config = config.get("content", {})
    68→        generator_path = content_config.get("generator", "")
    69→
    70→        if generator_path.startswith("rules/"):
    71→            # 使用 rules/ 架构生成内容
    72→            content = await self._generate_from_rule(
    73→                task=task,
    74→                profile=profile,
    75→                config=config,
    76→                generator_path=generator_path,
    77→            )
    78→        else:
    79→            # 根据提醒类型分发到不同生成器（旧架构）
    80→            generator_map = {
    81→                # Bazi
    82→                "daily_fortune": self._generate_daily_fortune,
    83→                "dayun_transition": self._generate_dayun_transition,
    84→                "fortune_alert": self._generate_fortune_alert,
    85→                # Zodiac
    86→                "daily_horoscope": self._generate_daily_horoscope,
    87→                "transit_alert": self._generate_transit_alert,
    88→                "lunar_phase": self._generate_lunar_phase,
    89→                "solar_term": self._generate_solar_term,
    90→                # Core
    91→                "weekly_summary": self._generate_weekly_summary,
    92→                "monthly_report": self._generate_monthly_report,
    93→                # Common
    94→                "birthday": self._generate_birthday,
    95→                "liunian": self._generate_liunian,
    96→            }
    97→
    98→            generator = generator_map.get(reminder_type)
    99→            if generator:
   100→                content = await generator(task, profile, config)
   101→            else:
   102→                # 默认生成器
   103→                content = await self._generate_default(task, profile, config)
   104→
   105→        # 附加对话引导配置
   106→        content.suggested_prompt = content_config.get("suggested_prompt")
   107→        content.quick_actions = content_config.get("quick_actions", [])
   108→        content.card_type = content_config.get("card_type")
   109→
   110→        return content
   111→
   112→    async def _generate_from_rule(
   113→        self,
   114→        task: ReminderTask,
   115→        profile: Dict[str, Any],
   116→        config: Dict[str, Any],
   117→        generator_path: str,
   118→    ) -> ReminderContent:
   119→        """
   120→        基于 Rule 文件生成内容
   121→
   122→        流程:
   123→        1. 加载 rule 文件
   124→        2. 提取分析要点和检索 Query
   125→        3. 执行知识检索
   126→        4. 调用 LLM 生成个性化内容
   127→        """
   128→        skill_id = task.skill_id
   129→
   130→        # 解析 rule 路径: rules/daily-fortune.md -> daily-fortune
   131→        rule_id = generator_path.replace("rules/", "").replace(".md", "")
   132→
   133→        # 加载 rule
   134→        rule = load_rule(skill_id, rule_id)
   135→        if not rule:
   136→            logger.warning(f"Rule not found: {skill_id}/{rule_id}, falling back to default")
   137→            return await self._generate_default(task, profile, config)
   138→
   139→        # 执行知识检索
   140→        knowledge_context = []
   141→        for step in rule.analysis_steps:
   142→            query = step.get("query", "").strip('"')
   143→            if query and step.get("priority") in ["必须", "推荐"]:
   144→                try:
   145→                    results = await search_db(
   146→                        table="knowledge_chunks",
   147→                        query=query,
   148→                        skill_id=skill_id,
   149→                        top_k=3,
   150→                    )
   151→                    knowledge_context.extend(results)
   152→                except Exception as e:
   153→                    logger.warning(f"Knowledge search failed for query '{query}': {e}")
   154→
   155→        # 获取用户特征
   156→        life_context = profile.get("life_context", {})
   157→        preferences = profile.get("preferences", {})
   158→        voice_mode = preferences.get("voice_mode", "warm")
   159→
   160→        # 构建 prompt
   161→        context_str = "\n".join([
   162→            f"- {chunk.get('content', '')[:200]}"
   163→            for chunk in knowledge_context[:5]
   164→        ]) if knowledge_context else "无相关知识"
   165→
   166→        concerns = life_context.get("concerns", [])
   167→        goals = life_context.get("goals", [])
   168→
   169→        # 使用 LLM 生成内容
   170→        llm_result = await self._generate_with_llm(
   171→            template_type="rule_based",
   172→            context={
   173→                "rule_name": rule.name,
   174→                "rule_content": rule.content[:1000],  # 截断避免过长
   175→                "knowledge_context": context_str,
   176→                "concerns": concerns[:3] if concerns else [],
   177→                "goals": goals[:2] if goals else [],
   178→                "date": date.today().strftime("%Y年%m月%d日"),
   179→            },
   180→            voice_mode=voice_mode,
   181→        )
   182→
   183→        return ReminderContent(
   184→            title=config.get("name", rule.name),
   185→            body=llm_result.get("greeting", f"关于{rule.name}的洞察"),
   186→            data={
   187→                "rule_id": rule_id,
   188→                "fortune_hint": llm_result.get("fortune_hint", ""),
   189→                "action_tip": llm_result.get("action_tip", ""),
   190→            },
   191→        )
   192→
   193→    # ═══════════════════════════════════════════════════════════════════════════
   194→    # Bazi 内容生成器
   195→    # ═══════════════════════════════════════════════════════════════════════════