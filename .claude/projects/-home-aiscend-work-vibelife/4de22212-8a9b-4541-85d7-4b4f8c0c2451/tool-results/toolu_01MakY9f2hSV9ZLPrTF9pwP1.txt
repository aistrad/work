     1→/**
     2→ * useVibeChat - AI SDK 4.x useChat wrapper for VibeLife
     3→ *
     4→ * v5.2 优化:
     5→ * - 使用缓存的 localStorage 工具 (Vercel rule: js-cache-storage)
     6→ * - 优化 useMemo 依赖 (Vercel rule: rerender-usememo-expensive)
     7→ *
     8→ * Provides streaming chat with OpenAI-compatible backend
     9→ * Uses standard OpenAI SSE format from Python CoreAgent
    10→ */
    11→
    12→'use client';
    13→
    14→import { useChat, Message } from 'ai/react';
    15→import { useCallback, useMemo } from 'react';
    16→import { getAccessToken } from '@/utils/storage';
    17→
    18→export type SkillId = 'bazi' | 'zodiac' | 'mbti' | 'tarot' | 'attach' | 'career';
    19→export type VoiceMode = 'warm' | 'sarcastic';
    20→
    21→export interface UseVibeChatOptions {
    22→  /**
    23→   * Skill ID - 可选
    24→   * - 传入时：后端直接使用该 skill，不走 LLM 路由
    25→   * - 不传时：后端 CoreAgent 通过 LLM 自动识别用户意图并路由到合适的 skill
    26→   */
    27→  skillId?: SkillId;
    28→  voiceMode?: VoiceMode;
    29→  conversationId?: string;
    30→  onConversationStart?: (id: string) => void;
    31→  onError?: (error: Error) => void;
    32→  onFinish?: (message: Message) => void;
    33→}
    34→
    35→export function useVibeChat({
    36→  skillId,
    37→  voiceMode = 'warm',
    38→  conversationId,
    39→  onConversationStart,
    40→  onError,
    41→  onFinish,
    42→}: UseVibeChatOptions) {
    43→  // Get auth token - getAccessToken() uses cached Map lookup (O(1)), safe to call on each render
    44→  // This ensures token changes (login/logout) are reflected immediately
    45→  const accessToken = getAccessToken();
    46→
    47→  // Memoize headers to prevent unnecessary re-renders (Vercel rule: rerender-usememo-expensive)
    48→  const headers = useMemo(
    49→    () => (accessToken ? { Authorization: `Bearer ${accessToken}` } : undefined),
    50→    [accessToken]
    51→  );
    52→
    53→  // Memoize body to prevent unnecessary re-renders
    54→  // 当 skillId 为 undefined 时，不传 skill 字段，让后端 LLM 自动路由
    55→  const body = useMemo(
    56→    () => ({
    57→      ...(skillId && { skill: skillId }),
    58→      voice_mode: voiceMode,
    59→      conversation_id: conversationId,
    60→    }),
    61→    [skillId, voiceMode, conversationId]
    62→  );
    63→
    64→  // AI SDK 4.x useChat hook
    65→  const chat = useChat({
    66→    api: '/api/v1/chat/v5/stream',
    67→    // 使用默认 data 协议，支持 toolInvocations (0:, 9:, a: 格式)
    68→    headers,
    69→    body,
    70→    onFinish: (message) => {
    71→      onFinish?.(message);
    72→    },
    73→    onError: (error) => {
    74→      console.error('Chat error:', error);
    75→      onError?.(error);
    76→    },
    77→  });
    78→
    79→  // Wrapper for sending messages
    80→  const sendVibeMessage = useCallback(

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
