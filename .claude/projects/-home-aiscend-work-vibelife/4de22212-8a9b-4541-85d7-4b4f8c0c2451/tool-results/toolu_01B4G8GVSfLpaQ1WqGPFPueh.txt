     1→---
     2→name: vibelife-skill
     3→description: |
     4→  VibeLife Skill - 知识库与专家系统构建工具 v7.0。
     5→  基于 VibeLife Expert System 架构，整合知识构建流水线全流程。
     6→  v7.0 简化版: 删除预筛选、质量评分、相似度检测，改为人工审核。
     7→  触发词：vibelife-skill, 建库, 建skill, 知识库构建, skill构建
     8→---
     9→
    10→# VibeLife Skill v7.0 - 知识库构建工具
    11→
    12→## 概述
    13→
    14→提供从原始资料到可用专家系统的完整流水线。
    15→
    16→**核心原则**：所有涉及大模型的步骤都在 Claude Code 中完成，自动化流程不调用外部 LLM API。
    17→
    18→**v7.0 简化改进**:
    19→- 删除预筛选机制 (ChunkFilter, ScenarioChunkFilter)
    20→- 删除质量评分系统
    21→- 删除相似度检测
    22→- 所有抽取结果直接保存，由人工审核
    23→
    24→**流水线架构**:
    25→```
    26→Stage 0: 格式转换 (自动化) → PDF/EPUB/DOCX → Markdown
    27→Stage 1-3: 切块 → 向量化 → 入库 (自动化)
    28→Stage 4C: Case 抽取 (Claude Code 手动)
    29→Stage 4S: Scenario 抽取 (Claude Code 手动)
    30→Stage 6: 质量检查 (自动化)
    31→```
    32→
    33→---
    34→
    35→## 目录结构
    36→
    37→### 知识源目录
    38→```
    39→/data/vibelife/knowledge/{skill_id}/
    40→├── source/                           # 原始源文件
    41→├── converted/                        # 转换后的 Markdown
    42→└── extracted/                        # 抽取结果
    43→```
    44→
    45→### Skill 目录
    46→```
    47→/home/aiscend/work/vibelife/apps/api/skills/{skill_id}/
    48→├── SKILL.md                   # Skill 核心定义
    49→├── scenarios/{scenario_id}.md # MiniSkill 场景库
    50→└── tools/
    51→    ├── tools.yaml             # 工具定义
    52→    └── handlers.py            # 工具执行器
    53→```
    54→
    55→### 工具系统
    56→```
    57→全局工具 (skills/core/tools/):
    58→├── search_db          # 统一数据库查询
    59→├── ask_user_question  # 主动追问用户
    60→├── request_info       # 请求用户提供信息
    61→├── show_service_menu  # 展示服务目录
    62→├── show_insight       # 通用洞察卡片
    63→└── show_report        # 通用报告
    64→
    65→Skill级工具: 定义在各 skills/{skill}/tools/ 中
    66→```
    67→
    68→---
    69→
    70→## Stage 0-3: 格式转换与入库
    71→
    72→### Stage 0: 格式转换
    73→
    74→| 输入格式 | 转换方法 | 输出 |
    75→|---------|---------|------|
    76→| PDF | pymupdf4llm | MD |
    77→| EPUB | ebooklib + html2text | MD |
    78→| DOCX | python-docx | MD |
    79→
    80→### Stage 1-3: 切块 → 向量化 → 入库
    81→
    82→- **切块**: max_tokens=2000, min_tokens=200, overlap=50
    83→- **向量化**: BAAI/bge-m3, 1024维
    84→- **入库**: PostgreSQL + pgvector
    85→
    86→---
    87→
    88→## Stage 4C: Case 抽取
    89→
    90→从 knowledge_chunks 表中抽取案例，写入 cases 表。
    91→
    92→### 命令
    93→
    94→```bash
    95→cd /home/aiscend/work/vibelife/apps/api
    96→python workers/case_extractor.py {skill}
    97→```
    98→
    99→### Case 数据结构
   100→
   101→```json
   102→{
   103→  "name": "案例名称",
   104→  "core_data": {"year": "甲子", "month": "乙丑", ...},
   105→  "features": {"daymaster": "丙火", "strength": "身强", ...},
   106→  "reasoning_chain": [
   107→    {"step": 1, "framework": "...", "observation": "...", "analysis": "...", "conclusion": "..."}
   108→  ],
   109→  "guidance_patterns": [
   110→    {"pattern_name": "...", "condition": "...", "advice": "...", "source": "..."}
   111→  ],
   112→  "tags": ["事业", "财运"],
   113→  "scenario_ids": ["basic_reading", "career"]
   114→}
   115→```
   116→
   117→### 数据库表
   118→
   119→```sql
   120→CREATE TABLE cases (
   121→    id              VARCHAR(50) PRIMARY KEY,
   122→    skill_id        VARCHAR(50) NOT NULL,
   123→    scenario_ids    VARCHAR[] NOT NULL,
   124→    name            VARCHAR(255) NOT NULL,
   125→    core_data       JSONB NOT NULL,
   126→    features        JSONB NOT NULL,
   127→    tags            VARCHAR[] NOT NULL,
   128→    analysis        JSONB NOT NULL,
   129→    conclusion      JSONB NOT NULL,
   130→    authority       VARCHAR(20) DEFAULT 'medium',
   131→    created_at      TIMESTAMP DEFAULT NOW()
   132→);
   133→```
   134→
   135→---
   136→
   137→## Stage 4S: Scenario 抽取
   138→
   139→从 knowledge_chunks 表中抽取场景，发布到 scenarios/*.md 文件。
   140→
   141→### 命令
   142→
   143→```bash
   144→cd /home/aiscend/work/vibelife/apps/api
   145→python workers/scenario_extractor.py {skill}
   146→```
   147→
   148→### Scenario 文件格式
   149→
   150→```markdown
   151→---
   152→id: career
   153→name: 事业分析
   154→level: standard
   155→billing: basic
   156→description: 从八字角度分析事业发展潜力...
   157→---
   158→
   159→# 事业分析
   160→
   161→## 触发条件
   162→
   163→**主要触发词**: 事业, 工作, 职业
   164→
   165→**次要触发词**: 跳槽, 升职
   166→
   167→## 服务流程 (SOP)
   168→
   169→### Phase 1: 信息收集
   170→**类型**: required
   171→确认用户出生信息
   172→**工具**: request_info
   173→
   174→### Phase 2: 计算排盘
   175→**类型**: required
   176→计算命盘数据
   177→**工具**: show_bazi_chart
   178→```
   179→
   180→---
   181→
   182→## Stage 6: 质量检查
   183→
   184→| 指标 | 目标 |
   185→|------|------|
   186→| 知识覆盖率 | ≥300 chunks |
   187→| 案例分布 | ≥50 cases |
   188→| 检索质量 | ≥70% |
   189→
   190→---
   191→
   192→## 使用方式
   193→
   194→### CLI 命令
   195→
   196→```bash
   197→# 自动化流水线 (Stage 0-3, 6)
   198→python scripts/build_knowledge.py --skill bazi --stages all
   199→
   200→# 特定阶段
   201→python scripts/build_knowledge.py --skill bazi --stages 0        # 格式转换
   202→python scripts/build_knowledge.py --skill bazi --stages 1-3      # 入库
   203→python scripts/build_knowledge.py --skill bazi --stages 6        # 质量报告
   204→```
   205→
   206→### Claude Code 手动命令 (Stage 4)
   207→
   208→```bash
   209→# Case 抽取
   210→cd /home/aiscend/work/vibelife/apps/api
   211→python workers/case_extractor.py bazi
   212→
   213→# Scenario 抽取
   214→python workers/scenario_extractor.py bazi
   215→```
   216→
   217→---
   218→
   219→## 核心原则
   220→
   221→1. **质量优先**：只入库高质量内容
   222→2. **深度优先**：提取大模型不知道的专业知识
   223→3. **可追溯**：所有规则标注来源
   224→4. **可迭代**：支持增量更新
   225→5. **模块化**：各阶段可独立执行
   226→
   227→## 禁止行为
   228→
   229→1. 禁止创建骨架/占位文件
   230→2. 禁止入库空内容 (< 50KB)
   231→3. 禁止猜测/编写内容
   232→4. 禁止跳过质量评估
   233→5. 禁止提取常识性规则
   234→6. 禁止无来源的规则
   235→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
