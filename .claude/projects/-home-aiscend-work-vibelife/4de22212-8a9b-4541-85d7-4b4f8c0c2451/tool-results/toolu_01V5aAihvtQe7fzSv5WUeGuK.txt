     1→'use client';
     2→
     3→/**
     4→ * useSkillSubscription - Skill 订阅管理 Hook
     5→ *
     6→ * 提供 Skill 订阅状态查询和操作功能
     7→ */
     8→
     9→import { useCallback, useMemo } from 'react';
    10→import useSWR, { useSWRConfig } from 'swr';
    11→import { useAuth } from '@/providers/AuthProvider';
    12→import { apiClient } from '@/lib/api';
    13→import type {
    14→  SkillSubscription,
    15→  SkillSubscriptionsResponse,
    16→  SkillListResponse,
    17→  SkillRecommendationsResponse,
    18→  SkillUserStatus,
    19→  SkillWithUserStatus,
    20→} from '@/types/skill';
    21→
    22→// ═══════════════════════════════════════════════════════════════════════════
    23→// Fetchers
    24→// ═══════════════════════════════════════════════════════════════════════════
    25→
    26→const fetchSubscriptions = async (): Promise<SkillSubscriptionsResponse> => {
    27→  const response = await apiClient.get('/api/v1/skills/subscriptions');
    28→  return response.data;
    29→};
    30→
    31→const fetchSkills = async (category?: string): Promise<SkillListResponse> => {
    32→  const params = category ? { category } : {};
    33→  const response = await apiClient.get('/api/v1/skills', { params });
    34→  return response.data;
    35→};
    36→
    37→const fetchRecommendations = async (
    38→  limit: number = 3,
    39→  context?: string
    40→): Promise<SkillRecommendationsResponse> => {
    41→  const params: Record<string, any> = { limit };
    42→  if (context) params.context = context;
    43→  const response = await apiClient.get('/api/v1/skills/recommendations', { params });
    44→  return response.data;
    45→};
    46→
    47→// ═══════════════════════════════════════════════════════════════════════════
    48→// useSkillSubscription Hook
    49→// ═══════════════════════════════════════════════════════════════════════════
    50→
    51→export function useSkillSubscription() {
    52→  const { user } = useAuth();
    53→  const { mutate } = useSWRConfig();
    54→
    55→  // 获取订阅列表
    56→  const {
    57→    data: subscriptionsData,
    58→    error: subscriptionsError,
    59→    isLoading: subscriptionsLoading,
    60→  } = useSWR(
    61→    user ? 'skill-subscriptions' : null,
    62→    fetchSubscriptions,
    63→    { revalidateOnFocus: false }
    64→  );
    65→
    66→  const subscriptions = subscriptionsData?.subscriptions ?? [];
    67→  const summary = subscriptionsData?.summary;
    68→
    69→  // 订阅 Skill
    70→  const subscribe = useCallback(
    71→    async (skillId: string, pushEnabled: boolean = true) => {
    72→      await apiClient.post(`/api/v1/skills/${skillId}/subscribe`, {
    73→        push_enabled: pushEnabled,
    74→      });
    75→      mutate('skill-subscriptions');
    76→      mutate('skill-list');
    77→    },
    78→    [mutate]
    79→  );
    80→
    81→  // 取消订阅 Skill
    82→  const unsubscribe = useCallback(
    83→    async (skillId: string) => {
    84→      await apiClient.post(`/api/v1/skills/${skillId}/unsubscribe`);
    85→      mutate('skill-subscriptions');
    86→      mutate('skill-list');
    87→    },
    88→    [mutate]
    89→  );
    90→
    91→  // 切换推送开关
    92→  const togglePush = useCallback(
    93→    async (skillId: string, enabled: boolean) => {
    94→      await apiClient.post(`/api/v1/skills/${skillId}/push`, { enabled });
    95→      mutate('skill-subscriptions');
    96→    },
    97→    [mutate]
    98→  );
    99→
   100→  // 检查是否已订阅
   101→  const isSubscribed = useCallback(
   102→    (skillId: string): boolean => {
   103→      return subscriptions.some(
   104→        (s) => s.skill_id === skillId && s.status === 'subscribed'
   105→      );
   106→    },
   107→    [subscriptions]
   108→  );
   109→
   110→  // 检查推送是否开启
   111→  const isPushEnabled = useCallback(
   112→    (skillId: string): boolean => {
   113→      const sub = subscriptions.find((s) => s.skill_id === skillId);
   114→      return sub?.push_enabled ?? false;
   115→    },
   116→    [subscriptions]
   117→  );
   118→
   119→  // 获取订阅状态
   120→  const getSubscription = useCallback(
   121→    (skillId: string): SkillSubscription | undefined => {
   122→      return subscriptions.find((s) => s.skill_id === skillId);
   123→    },
   124→    [subscriptions]
   125→  );
   126→
   127→  // 构建 userStatuses map
   128→  const userStatuses = useMemo((): Record<string, SkillUserStatus> => {
   129→    const map: Record<string, SkillUserStatus> = {};
   130→    for (const sub of subscriptions) {
   131→      map[sub.skill_id] = {
   132→        subscribed: sub.status === 'subscribed',
   133→        push_enabled: sub.push_enabled,
   134→        trial_messages_used: sub.trial_messages_used,
   135→        trial_messages_remaining: null, // 需要从 skill metadata 计算
   136→        subscribed_at: sub.subscribed_at ?? undefined,
   137→      };
   138→    }
   139→    return map;
   140→  }, [subscriptions]);
   141→
   142→  return {
   143→    subscriptions,
   144→    summary,
   145→    isLoading: subscriptionsLoading,
   146→    error: subscriptionsError,
   147→    subscribe,
   148→    unsubscribe,
   149→    togglePush,
   150→    isSubscribed,
   151→    isPushEnabled,
   152→    getSubscription,
   153→    userStatuses,
   154→    refresh: () => mutate('skill-subscriptions'),
   155→  };
   156→}
   157→
   158→// ═══════════════════════════════════════════════════════════════════════════
   159→// useSkills Hook
   160→// ═══════════════════════════════════════════════════════════════════════════
   161→
   162→export function useSkills(category?: string) {
   163→  const { user } = useAuth();
   164→
   165→  const {
   166→    data,
   167→    error,
   168→    isLoading,
   169→    mutate: refresh,
   170→  } = useSWR(
   171→    ['skill-list', category],
   172→    () => fetchSkills(category),
   173→    { revalidateOnFocus: false }
   174→  );
   175→
   176→  return {
   177→    skills: data?.skills ?? [],
   178→    categories: data?.categories,
   179→    total: data?.total ?? 0,
   180→    isLoading,
   181→    error,
   182→    refresh,
   183→  };
   184→}
   185→
   186→// ═══════════════════════════════════════════════════════════════════════════
   187→// useSkillRecommendations Hook
   188→// ═══════════════════════════════════════════════════════════════════════════
   189→
   190→export function useSkillRecommendations(options?: {
   191→  limit?: number;
   192→  context?: string;
   193→  enabled?: boolean;
   194→}) {
   195→  const { user } = useAuth();
   196→  const { limit = 3, context, enabled = true } = options ?? {};
   197→
   198→  const {
   199→    data,
   200→    error,
   201→    isLoading,
   202→    mutate: refresh,
   203→  } = useSWR(
   204→    user && enabled ? ['skill-recommendations', limit, context] : null,
   205→    () => fetchRecommendations(limit, context),
   206→    {
   207→      revalidateOnFocus: false,
   208→      dedupingInterval: 5 * 60 * 1000, // 5 分钟内不重复请求
   209→    }
   210→  );
   211→
   212→  return {
   213→    recommendations: data?.recommendations ?? [],
   214→    generatedAt: data?.generated_at,
   215→    isLoading,
   216→    error,
   217→    refresh,
   218→  };
   219→}
   220→
   221→// ═══════════════════════════════════════════════════════════════════════════
   222→// useSkillMetadata Hook
   223→// ═══════════════════════════════════════════════════════════════════════════
   224→
   225→export function useSkillMetadata(skillId: string) {
   226→  const { skills } = useSkills();
   227→  return useMemo(
   228→    () => skills.find((s) => s.id === skillId),
   229→    [skills, skillId]
   230→  );
   231→}
   232→
   233→export default useSkillSubscription;
   234→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
