     1â†’"""
     2â†’SkillLoader v7 - æ”¯æŒ Agentic + Rule æ¶æ„çš„ Skill åŠ è½½å™¨
     3â†’
     4â†’v7 æ¶æ„ï¼š
     5â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
     6â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
     7â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
     8â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
     9â†’
    10â†’v7.4 æ–°å¢ï¼š
    11â†’- Skill Management æ”¯æŒï¼šcategory, pricing, showcase, subscription å­—æ®µ
    12â†’"""
    13â†’import re
    14â†’import json
    15â†’import logging
    16â†’import yaml
    17â†’from pathlib import Path
    18â†’from dataclasses import dataclass, field
    19â†’from typing import Dict, List, Optional, Any
    20â†’from functools import lru_cache
    21â†’
    22â†’logger = logging.getLogger(__name__)
    23â†’
    24â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    25â†’
    26â†’
    27â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    28â†’# æ•°æ®ç»“æ„
    29â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    30â†’
    31â†’@dataclass
    32â†’class SkillPricing:
    33â†’    """Skill å®šä»·é…ç½®"""
    34â†’    type: str = "free"  # free | premium | credits
    35â†’    trial_messages: int = 3
    36â†’    credits_per_use: Optional[int] = None
    37â†’
    38â†’
    39â†’@dataclass
    40â†’class SkillShowcase:
    41â†’    """Skill å±•ç¤ºé…ç½®ï¼ˆç”¨äº Skill å¸‚åœºï¼‰"""
    42â†’    tagline: str = ""
    43â†’    highlights: List[str] = field(default_factory=list)
    44â†’    preview_image: Optional[str] = None
    45â†’    demo_prompts: List[str] = field(default_factory=list)
    46â†’
    47â†’
    48â†’@dataclass
    49â†’class SkillSubscription:
    50â†’    """Skill è®¢é˜…é…ç½®"""
    51â†’    auto_subscribe: bool = False
    52â†’    can_unsubscribe: bool = True
    53â†’    push_default: bool = True
    54â†’    min_subscription_days: int = 0
    55â†’
    56â†’
    57â†’@dataclass
    58â†’class SkillFeature:
    59â†’    """Skill åŠŸèƒ½ç‰¹æ€§"""
    60â†’    name: str
    61â†’    description: str = ""
    62â†’    icon: str = "ğŸ“Œ"
    63â†’    tier: str = "free"  # free | basic | premium
    64â†’
    65â†’
    66â†’@dataclass
    67â†’class SkillMetadata:
    68â†’    """Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰"""
    69â†’    id: str
    70â†’    name: str
    71â†’    description: str
    72â†’    version: str = "1.0.0"
    73â†’    category: str = "professional"  # core | default | professional
    74â†’    icon: str = "ğŸ’¡"
    75â†’    color: str = "#6B7280"
    76â†’    triggers: List[str] = field(default_factory=list)
    77â†’    pricing: SkillPricing = field(default_factory=SkillPricing)
    78â†’    features: List[SkillFeature] = field(default_factory=list)
    79â†’    showcase: SkillShowcase = field(default_factory=SkillShowcase)
    80â†’    subscription: SkillSubscription = field(default_factory=SkillSubscription)
    81â†’
    82â†’    def to_dict(self) -> Dict[str, Any]:
    83â†’        """è½¬æ¢ä¸º API å“åº”æ ¼å¼"""
    84â†’        return {
    85â†’            "id": self.id,
    86â†’            "name": self.name,
    87â†’            "description": self.description,
    88â†’            "version": self.version,
    89â†’            "category": self.category,
    90â†’            "icon": self.icon,
    91â†’            "color": self.color,
    92â†’            "triggers": self.triggers,
    93â†’            "pricing": {
    94â†’                "type": self.pricing.type,
    95â†’                "trial_messages": self.pricing.trial_messages,
    96â†’                "credits_per_use": self.pricing.credits_per_use,
    97â†’            },
    98â†’            "features": [
    99â†’                {"name": f.name, "description": f.description, "icon": f.icon, "tier": f.tier}
   100â†’                for f in self.features
   101â†’            ],
   102â†’            "showcase": {
   103â†’                "tagline": self.showcase.tagline,
   104â†’                "highlights": self.showcase.highlights,
   105â†’                "preview_image": self.showcase.preview_image,
   106â†’                "demo_prompts": self.showcase.demo_prompts,
   107â†’            },
   108â†’            "subscription": {
   109â†’                "auto_subscribe": self.subscription.auto_subscribe,
   110â†’                "can_unsubscribe": self.subscription.can_unsubscribe,
   111â†’                "push_default": self.subscription.push_default,
   112â†’            },
   113â†’        }
   114â†’
   115â†’
   116â†’@dataclass
   117â†’class SkillConfig:
   118â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
   119â†’    id: str
   120â†’    name: str
   121â†’    description: str
   122â†’    expert_persona: str
   123â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
   124â†’    ethics: Dict[str, Any]
   125â†’    tools: List[str]
   126â†’    default_scenario: str = "basic_reading"
   127â†’    triggers: List[str] = field(default_factory=list)
   128â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
   129â†’    # v7.1: SOP é…ç½®é©±åŠ¨
   130â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
   131â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
   132â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
   133â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   134â†’    collect_tool: Optional[str] = None # æ”¶é›†å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   135â†’    external_tools: List[str] = field(default_factory=list)  # v7.3: ä»å…¶ä»– skill å¯¼å…¥çš„å·¥å…·
   136â†’
   137â†’
   138â†’@dataclass
   139â†’class ServiceItem:
   140â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
   141â†’    scenario_id: str
   142â†’    name: str
   143â†’    icon: str
   144â†’    description: str
   145â†’    tier: str  # entry/standard/professional
   146â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
   147â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
   148â†’
   149â†’
   150â†’@dataclass
   151â†’class ScenarioConfig:
   152â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
   153â†’    id: str
   154â†’    name: str
   155â†’    level: str  # entry/standard/professional
   156â†’    billing: str  # free/basic/premium
   157â†’    description: str
   158â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
   159â†’    prerequisites: List[str]
   160â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
   161â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
   162â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
   163â†’    tools: List[str]
   164â†’
   165â†’
   166â†’@dataclass
   167â†’class ToolMetadata:
   168â†’    """å·¥å…·å…ƒæ•°æ®"""
   169â†’    name: str
   170â†’    description: str
   171â†’    tool_type: str  # collect/calculate/display/search
   172â†’    card_type: Optional[str] = None
   173â†’    card_props_schema: Optional[Dict] = None
   174â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   175â†’    when_to_call: Optional[str] = None
   176â†’
   177â†’
   178â†’@dataclass
   179â†’class RuleConfig:
   180â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
   181â†’    id: str
   182â†’    name: str
   183â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
   184â†’    impact_description: str
   185â†’    tags: List[str]
   186â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
   187â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
   188â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
   189â†’    common_questions: str  # å¸¸è§é—®é¢˜
   190â†’
   191â†’
   192â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   193â†’# è§£æå‡½æ•°
   194â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   195â†’
   196â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   197â†’    """è§£æ YAML frontmatterï¼ˆæ”¯æŒåµŒå¥—å¯¹è±¡ï¼‰"""
   198â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   199â†’    match = re.match(pattern, text, re.DOTALL)
   200â†’    if not match:
   201â†’        return {}, text
   202â†’
   203â†’    frontmatter_str, content = match.groups()
   204â†’
   205â†’    # ä½¿ç”¨ YAML è§£æä»¥æ”¯æŒåµŒå¥—å¯¹è±¡
   206â†’    try:
   207â†’        metadata = yaml.safe_load(frontmatter_str) or {}
   208â†’    except yaml.YAMLError as e:
   209â†’        logger.warning(f"YAML parse error in frontmatter: {e}, falling back to simple parse")
   210â†’        # å›é€€åˆ°ç®€å•è§£æ
   211â†’        metadata = {}
   212â†’        current_key = None
   213â†’        current_list = None
   214â†’
   215â†’        for line in frontmatter_str.strip().split('\n'):
   216â†’            stripped = line.strip()
   217â†’            if not stripped:
   218â†’                continue
   219â†’            if stripped.startswith('- ') and current_key:
   220â†’                if current_list is None:
   221â†’                    current_list = []
   222â†’                current_list.append(stripped[2:].strip())
   223â†’                metadata[current_key] = current_list
   224â†’            elif ':' in line and not line.startswith(' '):
   225â†’                current_list = None
   226â†’                key, value = line.split(':', 1)
   227â†’                current_key = key.strip()
   228â†’                value = value.strip()
   229â†’                if value in ('|', ''):
   230â†’                    continue
   231â†’                elif value.lower() == 'true':
   232â†’                    metadata[current_key] = True
   233â†’                elif value.lower() == 'false':
   234â†’                    metadata[current_key] = False
   235â†’                else:
   236â†’                    metadata[current_key] = value
   237â†’
   238â†’    return metadata, content.strip()
   239â†’
   240â†’
   241â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   242â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   243â†’
   244â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   245â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   246â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   247â†’    """
   248â†’    metadata, content = parse_frontmatter(text)
   249â†’
   250â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   251â†’    triggers = metadata.get("triggers", [])
   252â†’
   253â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   254â†’    if not triggers:
   255â†’        description = metadata.get("description", "")
   256â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   257â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   258â†’        if trigger_match:
   259â†’            trigger_str = trigger_match.group(1)
   260â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   261â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   262â†’
   263â†’    result = {
   264â†’        "id": metadata.get("id", ""),
   265â†’        "name": metadata.get("name", ""),
   266â†’        "description": metadata.get("description", ""),
   267â†’        "triggers": triggers,
   268â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   269â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   270â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   271â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   272â†’        "requires_compute": metadata.get("requires_compute", False),
   273â†’        "compute_type": metadata.get("compute_type", None),
   274â†’        "compute_tool": metadata.get("compute_tool", None),
   275â†’        "collect_tool": metadata.get("collect_tool", None),
   276â†’        "external_tools": metadata.get("external_tools", []),  # v7.3
   277â†’    }
   278â†’
   279â†’    # æå–ä¸“å®¶èº«ä»½
   280â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   281â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   282â†’
   283â†’    # æå–åœºæ™¯ç›®å½•
   284â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   285â†’    for level in scenarios.keys():
   286â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   287â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   288â†’        if match:
   289â†’            for row in match.group(1).strip().split('\n'):
   290â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   291â†’                if len(cols) >= 2:
   292â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   293â†’    result["scenarios"] = scenarios
   294â†’
   295â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   296â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   297â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   298â†’    if forbidden_match:
   299â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   300â†’    result["ethics"] = ethics
   301â†’
   302â†’    # æå–å·¥å…·åˆ—è¡¨
   303â†’    tools = []
   304â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   305â†’    if tools_match:
   306â†’        for row in tools_match.group(1).strip().split('\n'):
   307â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   308â†’            if len(cols) >= 1:
   309â†’                tools.append(cols[0])
   310â†’    result["tools"] = tools
   311â†’
   312â†’    return result
   313â†’
   314â†’
   315â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   316â†’    """è§£æ scenario.md å†…å®¹"""
   317â†’    metadata, content = parse_frontmatter(text)
   318â†’
   319â†’    result = {
   320â†’        "id": metadata.get("id", ""),
   321â†’        "name": metadata.get("name", ""),
   322â†’        "level": metadata.get("level", "entry"),
   323â†’        "billing": metadata.get("billing", "free"),
   324â†’        "description": metadata.get("description", ""),
   325â†’    }
   326â†’
   327â†’    # æå–è§¦å‘æ¡ä»¶
   328â†’    triggers = {"primary": [], "secondary": []}
   329â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   330â†’    if primary_match:
   331â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   332â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   333â†’    if secondary_match:
   334â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   335â†’    result["triggers"] = triggers
   336â†’
   337â†’    # æå–å‰ç½®è¦æ±‚
   338â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   339â†’    result["prerequisites"] = []
   340â†’    if prereq_match:
   341â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   342â†’
   343â†’    # æå– SOP é˜¶æ®µ
   344â†’    sop = []
   345â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   346â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   347â†’        phase_num, phase_name, phase_content = match.groups()
   348â†’        phase = {
   349â†’            "phase": int(phase_num),
   350â†’            "name": phase_name.strip(),
   351â†’            "content": phase_content.strip()
   352â†’        }
   353â†’        # æå–ç±»å‹
   354â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   355â†’        if type_match:
   356â†’            phase["type"] = type_match.group(1)
   357â†’        sop.append(phase)
   358â†’    result["sop"] = sop
   359â†’
   360â†’    # æå–å·¥å…·åˆ—è¡¨
   361â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   362â†’    result["tools"] = []
   363â†’    if tools_match:
   364â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   365â†’
   366â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   367â†’    result["knowledge_config"] = {}
   368â†’    result["output_config"] = {}
   369â†’
   370â†’    return result
   371â†’
   372â†’
   373â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   374â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   375â†’    metadata, content = parse_frontmatter(text)
   376â†’
   377â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   378â†’    tags_raw = metadata.get("tags", [])
   379â†’    if isinstance(tags_raw, str):
   380â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   381â†’    else:
   382â†’        tags = tags_raw
   383â†’
   384â†’    result = {
   385â†’        "id": metadata.get("id", ""),
   386â†’        "name": metadata.get("name", ""),
   387â†’        "impact": metadata.get("impact", "MEDIUM"),
   388â†’        "impact_description": metadata.get("impactDescription", ""),
   389â†’        "tags": tags,
   390â†’        "content": content,
   391â†’    }
   392â†’
   393â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   394â†’    analysis_steps = []
   395â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   396â†’    if table_match:
   397â†’        for row in table_match.group(1).strip().split('\n'):
   398â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   399â†’            if len(cols) >= 4:
   400â†’                analysis_steps.append({
   401â†’                    "step": cols[0],
   402â†’                    "point": cols[1],
   403â†’                    "query": cols[2],
   404â†’                    "priority": cols[3],
   405â†’                })
   406â†’    result["analysis_steps"] = analysis_steps
   407â†’
   408â†’    # æå–è¾“å‡ºè¦æ±‚
   409â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   410â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   411â†’
   412â†’    # æå–å¸¸è§é—®é¢˜
   413â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   414â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   415â†’
   416â†’    return result
   417â†’
   418â†’
   419â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   420â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   421â†’    services = {"entry": [], "standard": [], "professional": []}
   422â†’
   423â†’    tier_map = {
   424â†’        "entry": "entry",
   425â†’        "standard": "standard",
   426â†’        "professional": "professional"
   427â†’    }
   428â†’
   429â†’    for tier_name, tier_key in tier_map.items():
   430â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   431â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   432â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   433â†’        if not match:
   434â†’            continue
   435â†’
   436â†’        table_content = match.group(1).strip()
   437â†’        if not table_content:
   438â†’            continue
   439â†’
   440â†’        for row in table_content.split('\n'):
   441â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   442â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   443â†’                continue
   444â†’
   445â†’            service = {
   446â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   447â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   448â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   449â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   450â†’                "tier": tier_key,
   451â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   452â†’                "highlights": []
   453â†’            }
   454â†’
   455â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   456â†’            if len(cols) > 7 and cols[7]:
   457â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   458â†’
   459â†’            services[tier_key].append(service)
   460â†’
   461â†’    return services
   462â†’
   463â†’
   464â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   465â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   466â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   467â†’    if not skill_path.exists():
   468â†’        return None
   469â†’
   470â†’    text = skill_path.read_text(encoding='utf-8')
   471â†’    metadata, _ = parse_frontmatter(text)
   472â†’    services = parse_skill_services(text)
   473â†’
   474â†’    return {
   475â†’        "skill_id": skill_id,
   476â†’        "skill_name": metadata.get("name", skill_id),
   477â†’        "description": metadata.get("description", ""),
   478â†’        "services": services
   479â†’    }
   480â†’
   481â†’
   482â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   483â†’# åŠ è½½å‡½æ•°
   484â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   485â†’
   486â†’@lru_cache(maxsize=32)
   487â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   488â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   489â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   490â†’    if not skill_path.exists():
   491â†’        return None
   492â†’
   493â†’    text = skill_path.read_text(encoding='utf-8')
   494â†’    data = parse_skill_md(text)
   495â†’
   496â†’    return SkillConfig(
   497â†’        id=data.get("id", skill_id),
   498â†’        name=data.get("name", skill_id),
   499â†’        description=data.get("description", ""),
   500â†’        expert_persona=data.get("expert_persona", ""),
   501â†’        scenarios=data.get("scenarios", {}),
   502â†’        ethics=data.get("ethics", {}),
   503â†’        tools=data.get("tools", []),
   504â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   505â†’        triggers=data.get("triggers", []),
   506â†’        global_tools=data.get("global_tools", []),
   507â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   508â†’        requires_birth_info=data.get("requires_birth_info", False),
   509â†’        requires_compute=data.get("requires_compute", False),
   510â†’        compute_type=data.get("compute_type", None),
   511â†’        compute_tool=data.get("compute_tool", None),
   512â†’        collect_tool=data.get("collect_tool", None),
   513â†’        external_tools=data.get("external_tools", []),  # v7.3
   514â†’    )
   515â†’
   516â†’
   517â†’@lru_cache(maxsize=32)
   518â†’def load_skill_metadata(skill_id: str) -> Optional[SkillMetadata]:
   519â†’    """åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰- v7.4 æ–°å¢
   520â†’
   521â†’    ä» SKILL.md çš„ frontmatter ä¸­è¯»å–å®Œæ•´çš„å…ƒæ•°æ®é…ç½®ï¼Œ
   522â†’    åŒ…æ‹¬ category, pricing, showcase, subscription ç­‰å­—æ®µã€‚
   523â†’    """
   524â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   525â†’    if not skill_path.exists():
   526â†’        return None
   527â†’
   528â†’    text = skill_path.read_text(encoding='utf-8')
   529â†’    metadata, _ = parse_frontmatter(text)
   530â†’
   531â†’    # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   532â†’    triggers = metadata.get("triggers", [])
   533â†’    if not triggers:
   534â†’        description = metadata.get("description", "")
   535â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   536â†’        if trigger_match:
   537â†’            trigger_str = trigger_match.group(1)
   538â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   539â†’
   540â†’    # è§£æ pricing
   541â†’    pricing_data = metadata.get("pricing", {})
   542â†’    pricing = SkillPricing(
   543â†’        type=pricing_data.get("type", "free") if isinstance(pricing_data, dict) else "free",
   544â†’        trial_messages=pricing_data.get("trial_messages", 3) if isinstance(pricing_data, dict) else 3,
   545â†’        credits_per_use=pricing_data.get("credits_per_use") if isinstance(pricing_data, dict) else None,
   546â†’    )
   547â†’
   548â†’    # è§£æ features
   549â†’    features_data = metadata.get("features", [])
   550â†’    features = []
   551â†’    if isinstance(features_data, list):
   552â†’        for f in features_data:
   553â†’            if isinstance(f, dict):
   554â†’                features.append(SkillFeature(
   555â†’                    name=f.get("name", ""),
   556â†’                    description=f.get("description", ""),
   557â†’                    icon=f.get("icon", "ğŸ“Œ"),
   558â†’                    tier=f.get("tier", "free"),
   559â†’                ))
   560â†’
   561â†’    # è§£æ showcase
   562â†’    showcase_data = metadata.get("showcase", {})
   563â†’    showcase = SkillShowcase(
   564â†’        tagline=showcase_data.get("tagline", "") if isinstance(showcase_data, dict) else "",
   565â†’        highlights=showcase_data.get("highlights", []) if isinstance(showcase_data, dict) else [],
   566â†’        preview_image=showcase_data.get("preview_image") if isinstance(showcase_data, dict) else None,
   567â†’        demo_prompts=showcase_data.get("demo_prompts", []) if isinstance(showcase_data, dict) else [],
   568â†’    )
   569â†’
   570â†’    # è§£æ subscription
   571â†’    subscription_data = metadata.get("subscription", {})
   572â†’    category = metadata.get("category", "professional")
   573â†’    subscription = SkillSubscription(
   574â†’        auto_subscribe=subscription_data.get("auto_subscribe", category == "default") if isinstance(subscription_data, dict) else (category == "default"),
   575â†’        can_unsubscribe=subscription_data.get("can_unsubscribe", category != "core") if isinstance(subscription_data, dict) else (category != "core"),
   576â†’        push_default=subscription_data.get("push_default", True) if isinstance(subscription_data, dict) else True,
   577â†’        min_subscription_days=subscription_data.get("min_subscription_days", 0) if isinstance(subscription_data, dict) else 0,
   578â†’    )
   579â†’
   580â†’    return SkillMetadata(
   581â†’        id=metadata.get("id", skill_id),
   582â†’        name=metadata.get("name", skill_id),
   583â†’        description=metadata.get("description", ""),
   584â†’        version=metadata.get("version", "1.0.0"),
   585â†’        category=category,
   586â†’        icon=metadata.get("icon", "ğŸ’¡"),
   587â†’        color=metadata.get("color", "#6B7280"),
   588â†’        triggers=triggers,
   589â†’        pricing=pricing,
   590â†’        features=features,
   591â†’        showcase=showcase,
   592â†’        subscription=subscription,
   593â†’    )
   594â†’
   595â†’
   596â†’def get_all_skill_metadata() -> List[SkillMetadata]:
   597â†’    """è·å–æ‰€æœ‰å¯ç”¨ Skill çš„å…ƒæ•°æ®ï¼ˆç”¨äº Skill åˆ—è¡¨ APIï¼‰- v7.4 æ–°å¢"""
   598â†’    skills = []
   599â†’    for skill_id in get_available_skills():
   600â†’        metadata = load_skill_metadata(skill_id)
   601â†’        if metadata:
   602â†’            skills.append(metadata)
   603â†’    return skills
   604â†’
   605â†’
   606â†’def get_skills_by_category(category: str) -> List[SkillMetadata]:
   607â†’    """æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ - v7.4 æ–°å¢
   608â†’
   609â†’    Args:
   610â†’        category: core | default | professional
   611â†’
   612â†’    Returns:
   613â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„å…ƒæ•°æ®åˆ—è¡¨
   614â†’    """
   615â†’    return [s for s in get_all_skill_metadata() if s.category == category]
   616â†’
   617â†’
   618â†’@lru_cache(maxsize=64)
   619â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   620â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   621â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   622â†’    if not scenario_path.exists():
   623â†’        return None
   624â†’
   625â†’    text = scenario_path.read_text(encoding='utf-8')
   626â†’    data = parse_scenario_md(text)
   627â†’
   628â†’    return ScenarioConfig(
   629â†’        id=data.get("id", scenario_id),
   630â†’        name=data.get("name", scenario_id),
   631â†’        level=data.get("level", "entry"),
   632â†’        billing=data.get("billing", "free"),
   633â†’        description=data.get("description", ""),
   634â†’        triggers=data.get("triggers", {}),
   635â†’        prerequisites=data.get("prerequisites", []),
   636â†’        sop=data.get("sop", []),
   637â†’        knowledge_config=data.get("knowledge_config", {}),
   638â†’        output_config=data.get("output_config", {}),
   639â†’        tools=data.get("tools", [])
   640â†’    )
   641â†’
   642â†’
   643â†’@lru_cache(maxsize=128)
   644â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   645â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢"""
   646â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   647â†’    if not rule_path.exists():
   648â†’        return None
   649â†’
   650â†’    text = rule_path.read_text(encoding='utf-8')
   651â†’    data = parse_rule_md(text)
   652â†’
   653â†’    return RuleConfig(
   654â†’        id=data.get("id", rule_id),
   655â†’        name=data.get("name", rule_id),
   656â†’        impact=data.get("impact", "MEDIUM"),
   657â†’        impact_description=data.get("impact_description", ""),
   658â†’        tags=data.get("tags", []),
   659â†’        content=data.get("content", ""),
   660â†’        analysis_steps=data.get("analysis_steps", []),
   661â†’        output_requirements=data.get("output_requirements", ""),
   662â†’        common_questions=data.get("common_questions", ""),
   663â†’    )
   664â†’
   665â†’
   666â†’def get_skill_rules(skill_id: str) -> List[str]:
   667â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢"""
   668â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   669â†’    if not rules_dir.exists():
   670â†’        return []
   671â†’    return [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   672â†’
   673â†’
   674â†’def has_rules(skill_id: str) -> bool:
   675â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   676â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   677â†’    if not rules_dir.exists():
   678â†’        return False
   679â†’    rules = list(rules_dir.glob("*.md"))
   680â†’    return len(rules) > 0
   681â†’
   682â†’
   683â†’def get_available_skills() -> List[str]:
   684â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   685â†’    if not SKILLS_DIR.exists():
   686â†’        return []
   687â†’    return [p.name for p in SKILLS_DIR.iterdir()
   688â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   689â†’
   690â†’
   691â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   692â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   693â†’
   694â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   695â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   696â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼‰
   697â†’    """
   698â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   699â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   700â†’    if rules_dir.exists():
   701â†’        rules = [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   702â†’        if rules:
   703â†’            return rules
   704â†’
   705â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   706â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   707â†’    if not scenarios_dir.exists():
   708â†’        return []
   709â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   710â†’
   711â†’
   712â†’def get_skill_triggers() -> Dict[str, List[str]]:
   713â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   714â†’    triggers = {}
   715â†’    for skill_id in get_available_skills():
   716â†’        if skill_id == "core":
   717â†’            continue
   718â†’        skill = load_skill(skill_id)
   719â†’        if skill and skill.triggers:
   720â†’            triggers[skill_id] = skill.triggers
   721â†’    return triggers
   722â†’
   723â†’
   724â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   725â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   726â†’    skill = load_skill(skill_id)
   727â†’    if skill and skill.global_tools:
   728â†’        return skill.global_tools
   729â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   730â†’    return []
   731â†’
   732â†’
   733â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   734â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   735â†’    skill = load_skill(skill_id)
   736â†’    if skill and skill.external_tools:
   737â†’        return skill.external_tools
   738â†’    return []
   739â†’
   740â†’
   741â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   742â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
   743â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   744â†’
   745â†’def skill_requires_birth_info(skill_id: str) -> bool:
   746â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   747â†’    skill = load_skill(skill_id)
   748â†’    return skill.requires_birth_info if skill else False
   749â†’
   750â†’
   751â†’def skill_requires_compute(skill_id: str) -> bool:
   752â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   753â†’    skill = load_skill(skill_id)
   754â†’    return skill.requires_compute if skill else False
   755â†’
   756â†’
   757â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
   758â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
   759â†’
   760â†’    è¿”å›å€¼ï¼š
   761â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
   762â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
   763â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
   764â†’    """
   765â†’    skill = load_skill(skill_id)
   766â†’    return skill.compute_type if skill else None
   767â†’
   768â†’
   769â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
   770â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   771â†’
   772â†’    è¿”å›å€¼ï¼š
   773â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
   774â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   775â†’    """
   776â†’    skill = load_skill(skill_id)
   777â†’    return skill.compute_tool if skill else None
   778â†’
   779â†’
   780â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
   781â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   782â†’
   783â†’    è¿”å›å€¼ï¼š
   784â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
   785â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   786â†’    """
   787â†’    skill = load_skill(skill_id)
   788â†’    return skill.collect_tool if skill else None
   789â†’
   790â†’
   791â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   792â†’# System Prompt æ„å»º
   793â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   794â†’
   795â†’def build_system_prompt(
   796â†’    skill_id: str,
   797â†’    scenario_id: Optional[str] = None,
   798â†’    user_context: Optional[Dict] = None
   799â†’) -> str:
   800â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
   801â†’
   802â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
   803â†’    """
   804â†’    parts = []
   805â†’
   806â†’    # åŠ è½½ Skill
   807â†’    skill = load_skill(skill_id)
   808â†’    if not skill:
   809â†’        return ""
   810â†’
   811â†’    # ä¸“å®¶èº«ä»½
   812â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   813â†’
   814â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
   815â†’    if scenario_id:
   816â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
   817â†’        if has_rules(skill_id):
   818â†’            rule = load_rule(skill_id, scenario_id)
   819â†’            if rule:
   820â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
   821â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
   822â†’                parts.append(rule.content)
   823â†’            else:
   824â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
   825â†’                scenario = load_scenario(skill_id, scenario_id)
   826â†’                if scenario:
   827â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   828â†’                    if scenario.sop:
   829â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   830â†’                        for phase in scenario.sop:
   831â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   832â†’                        parts.append(sop_text)
   833â†’        else:
   834â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
   835â†’            scenario = load_scenario(skill_id, scenario_id)
   836â†’            if scenario:
   837â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   838â†’                # SOP
   839â†’                if scenario.sop:
   840â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   841â†’                    for phase in scenario.sop:
   842â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   843â†’                    parts.append(sop_text)
   844â†’
   845â†’    # ä¼¦ç†è¾¹ç•Œ
   846â†’    if skill.ethics.get("forbidden"):
   847â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   848â†’        for item in skill.ethics["forbidden"]:
   849â†’            ethics_text += f"- {item}\n"
   850â†’        parts.append(ethics_text)
   851â†’
   852â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ
   853â†’    if user_context:
   854â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   855â†’
   856â†’        # ç‰¹æ®Šå¤„ç† birth_info
   857â†’        if user_context.get("birth_info"):
   858â†’            birth_info = user_context['birth_info']
   859â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
   860â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
   861â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
   862â†’
   863â†’        # ç‰¹æ®Šå¤„ç† portrait
   864â†’        if user_context.get("portrait"):
   865â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
   866â†’
   867â†’        # ç‰¹æ®Šå¤„ç† extracted (æŠ½å–çš„ç”¨æˆ·ä¿¡æ¯)
   868â†’        if user_context.get("extracted"):
   869â†’            extracted = user_context['extracted']
   870â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
   871â†’            if extracted.get("facts"):
   872â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
   873â†’            if extracted.get("concerns"):
   874â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
   875â†’            if extracted.get("goals"):
   876â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
   877â†’            if extracted.get("pain_points"):
   878â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
   879â†’            if extracted.get("life_events"):
   880â†’                events = [f"{e.get('date', '?')}: {e.get('event', '')}" for e in extracted['life_events'][:5]]
   881â†’                ctx_text += f"**è¿‘æœŸäº‹ä»¶**: {'; '.join(events)}\n"
   882â†’
   883â†’        # ç‰¹æ®Šå¤„ç† identity_prism
   884â†’        if user_context.get("identity_prism"):
   885â†’            prism = user_context['identity_prism']
   886â†’            ctx_text += f"\n### èº«ä»½ç‰¹å¾\n"
   887â†’            if prism.get("core"):
   888â†’                ctx_text += f"**æ ¸å¿ƒç‰¹è´¨**: {prism['core']}\n"
   889â†’            if prism.get("inner"):
   890â†’                ctx_text += f"**å†…åœ¨éœ€æ±‚**: {prism['inner']}\n"
   891â†’            if prism.get("outer"):
   892â†’                ctx_text += f"**å¤–åœ¨è¡¨ç°**: {prism['outer']}\n"
   893â†’
   894â†’        # ç‰¹æ®Šå¤„ç† life_context
   895â†’        if user_context.get("life_context"):
   896â†’            life_ctx = user_context['life_context']
   897â†’            if life_ctx.get("concerns") or life_ctx.get("goals") or life_ctx.get("pain_points"):
   898â†’                ctx_text += f"\n### ç”Ÿæ´»èƒŒæ™¯\n"
   899â†’                if life_ctx.get("concerns"):
   900â†’                    ctx_text += f"**å…³æ³¨**: {', '.join(life_ctx['concerns'])}\n"
   901â†’                if life_ctx.get("goals"):
   902â†’                    ctx_text += f"**ç›®æ ‡**: {', '.join(life_ctx['goals'])}\n"
   903â†’                if life_ctx.get("pain_points"):
   904â†’                    ctx_text += f"**å›°éš¾**: {', '.join(life_ctx['pain_points'])}\n"
   905â†’
   906â†’        parts.append(ctx_text)
   907â†’
   908â†’    return "\n".join(parts)
   909â†’
   910â†’
   911â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   912â†’# ç¼“å­˜ç®¡ç†
   913â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   914â†’
   915â†’def clear_cache():
   916â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
   917â†’    load_skill.cache_clear()
   918â†’    load_skill_metadata.cache_clear()  # v7.4
   919â†’    load_scenario.cache_clear()
   920â†’    load_rule.cache_clear()
   921â†’    get_scenario_triggers.cache_clear()
   922â†’    get_rule_triggers.cache_clear()
   923â†’    logger.info("Skill cache cleared")
   924â†’
   925â†’
   926â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
   927â†’    """é‡è½½å•ä¸ª Skill"""
   928â†’    load_skill.cache_clear()
   929â†’    load_scenario.cache_clear()
   930â†’    load_rule.cache_clear()
   931â†’    return load_skill(skill_id)
   932â†’
   933â†’
   934â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   935â†’# åœºæ™¯è·¯ç”± (å†…å­˜åŒ¹é…)
   936â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   937â†’
   938â†’def parse_scenario_triggers(text: str) -> Dict[str, Dict[str, List[str]]]:
   939â†’    """ä» SKILL.md è§£æåœºæ™¯ç›®å½•è¡¨æ ¼ï¼Œæå–è§¦å‘è¯"""
   940â†’    triggers = {}  # {scenario_id: {primary: [...], secondary: [...]}}
   941â†’
   942â†’    # åŒ¹é…ä¸‰ä¸ªçº§åˆ«çš„è¡¨æ ¼
   943â†’    for level in ["entry", "standard", "professional"]:
   944â†’        pattern = rf'### {level.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   945â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   946â†’        if not match:
   947â†’            continue
   948â†’
   949â†’        for row in match.group(1).strip().split('\n'):
   950â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   951â†’            if len(cols) >= 3:
   952â†’                # cols[1] = æ–‡ä»¶å, cols[2] = è§¦å‘è¯
   953â†’                scenario_id = cols[1].replace('.md', '')
   954â†’                trigger_str = cols[2]
   955â†’                # è§£æè§¦å‘è¯ï¼ˆç”¨é¡¿å·æˆ–é€—å·åˆ†éš”ï¼‰
   956â†’                trigger_words = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   957â†’                triggers[scenario_id] = {
   958â†’                    "primary": trigger_words,
   959â†’                    "secondary": []
   960â†’                }
   961â†’
   962â†’    return triggers
   963â†’
   964â†’
   965â†’@lru_cache(maxsize=32)
   966â†’def get_scenario_triggers(skill_id: str) -> Dict[str, Dict[str, List[str]]]:
   967â†’    """è·å– Skill çš„åœºæ™¯è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
   968â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   969â†’    if not skill_path.exists():
   970â†’        return {}
   971â†’
   972â†’    text = skill_path.read_text(encoding='utf-8')
   973â†’    return parse_scenario_triggers(text)
   974â†’
   975â†’
   976â†’def route_scenario(skill_id: str, message: str) -> Optional[str]:
   977â†’    """
   978â†’    å†…å­˜åœºæ™¯è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³åœºæ™¯
   979â†’
   980â†’    Args:
   981â†’        skill_id: Skill ID
   982â†’        message: ç”¨æˆ·æ¶ˆæ¯
   983â†’
   984â†’    Returns:
   985â†’        åŒ¹é…çš„ scenario_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
   986â†’    """
   987â†’    triggers = get_scenario_triggers(skill_id)
   988â†’    if not triggers:
   989â†’        return None
   990â†’
   991â†’    best_match = None
   992â†’    best_score = 0
   993â†’
   994â†’    for scenario_id, trigger_config in triggers.items():
   995â†’        score = 0
   996â†’        # ä¸»è¦è§¦å‘è¯æƒé‡ 1.0
   997â†’        for word in trigger_config.get("primary", []):
   998â†’            if word in message:
   999â†’                score += 1.0
  1000â†’        # æ¬¡è¦è§¦å‘è¯æƒé‡ 0.5
  1001â†’        for word in trigger_config.get("secondary", []):
  1002â†’            if word in message:
  1003â†’                score += 0.5
  1004â†’
  1005â†’        if score > best_score:
  1006â†’            best_score = score
  1007â†’            best_match = scenario_id
  1008â†’
  1009â†’    return best_match
  1010â†’
  1011â†’
  1012â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1013â†’# è§„åˆ™è·¯ç”± (v7 æ–°å¢)
  1014â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1015â†’
  1016â†’@lru_cache(maxsize=32)
  1017â†’def get_rule_triggers(skill_id: str) -> Dict[str, List[str]]:
  1018â†’    """è·å– Skill çš„è§„åˆ™è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰- v7 æ–°å¢
  1019â†’
  1020â†’    ä» rules/*.md çš„ frontmatter ä¸­è¯»å– tags ä½œä¸ºè§¦å‘è¯
  1021â†’    """
  1022â†’    triggers = {}  # {rule_id: [tag1, tag2, ...]}
  1023â†’
  1024â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
  1025â†’    if not rules_dir.exists():
  1026â†’        return triggers
  1027â†’
  1028â†’    for rule_path in rules_dir.glob("*.md"):
  1029â†’        if rule_path.stem.startswith("_"):
  1030â†’            continue
  1031â†’
  1032â†’        rule = load_rule(skill_id, rule_path.stem)
  1033â†’        if rule and rule.tags:
  1034â†’            triggers[rule.id] = rule.tags
  1035â†’
  1036â†’    return triggers
  1037â†’
  1038â†’
  1039â†’def route_to_rule(skill_id: str, message: str) -> Optional[str]:
  1040â†’    """
  1041â†’    è§„åˆ™è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³è§„åˆ™ - v7 æ–°å¢
  1042â†’
  1043â†’    ä½¿ç”¨ tags è¿›è¡Œè¯­ä¹‰åŒ¹é…ï¼Œæ”¯æŒæ›´çµæ´»çš„è·¯ç”±
  1044â†’
  1045â†’    Args:
  1046â†’        skill_id: Skill ID
  1047â†’        message: ç”¨æˆ·æ¶ˆæ¯
  1048â†’
  1049â†’    Returns:
  1050â†’        åŒ¹é…çš„ rule_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
  1051â†’    """
  1052â†’    # ä¼˜å…ˆä½¿ç”¨è§„åˆ™è·¯ç”±
  1053â†’    if has_rules(skill_id):
  1054â†’        triggers = get_rule_triggers(skill_id)
  1055â†’        if not triggers:
  1056â†’            return None
  1057â†’
  1058â†’        best_match = None
  1059â†’        best_score = 0
  1060â†’
  1061â†’        for rule_id, tags in triggers.items():
  1062â†’            score = 0
  1063â†’            for tag in tags:
  1064â†’                if tag in message:
  1065â†’                    score += 1.0
  1066â†’
  1067â†’            if score > best_score:
  1068â†’                best_score = score
  1069â†’                best_match = rule_id
  1070â†’
  1071â†’        return best_match
  1072â†’
  1073â†’    # å›é€€åˆ°åœºæ™¯è·¯ç”±ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
  1074â†’    return route_scenario(skill_id, message)
  1075â†’
  1076â†’
  1077â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
  1078â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
  1079â†’
  1080â†’    Args:
  1081â†’        skill_id: Skill ID
  1082â†’        rule_id: Rule ID
  1083â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1084â†’
  1085â†’    Returns:
  1086â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
  1087â†’    """
  1088â†’    parts = []
  1089â†’
  1090â†’    # åŠ è½½ Skill
  1091â†’    skill = load_skill(skill_id)
  1092â†’    if not skill:
  1093â†’        return ""
  1094â†’
  1095â†’    # ä¸“å®¶èº«ä»½
  1096â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1097â†’
  1098â†’    # åŠ è½½è§„åˆ™
  1099â†’    rule = load_rule(skill_id, rule_id)
  1100â†’    if rule:
  1101â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1102â†’
  1103â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1104â†’        parts.append(rule.content)
  1105â†’
  1106â†’    # ä¼¦ç†è¾¹ç•Œ
  1107â†’    if skill.ethics.get("forbidden"):
  1108â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1109â†’        for item in skill.ethics["forbidden"]:
  1110â†’            ethics_text += f"- {item}\n"
  1111â†’        parts.append(ethics_text)
  1112â†’
  1113â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
  1114â†’    if user_context:
  1115â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1116â†’
  1117â†’        if user_context.get("birth_info"):
  1118â†’            birth_info = user_context['birth_info']
  1119â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1120â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1121â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1122â†’
  1123â†’        if user_context.get("portrait"):
  1124â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1125â†’
  1126â†’        if user_context.get("extracted"):
  1127â†’            extracted = user_context['extracted']
  1128â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1129â†’            if extracted.get("facts"):
  1130â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1131â†’            if extracted.get("concerns"):
  1132â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1133â†’            if extracted.get("goals"):
  1134â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1135â†’            if extracted.get("pain_points"):
  1136â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1137â†’
  1138â†’        parts.append(ctx_text)
  1139â†’
  1140â†’    return "\n".join(parts)
  1141â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
