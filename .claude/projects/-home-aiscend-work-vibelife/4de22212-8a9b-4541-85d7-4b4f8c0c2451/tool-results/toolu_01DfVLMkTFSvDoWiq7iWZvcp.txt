     1→"""
     2→ContentGenerator - 个性化内容生成器
     3→
     4→特点:
     5→1. 基于 life_context 个性化
     6→2. 支持多种语气风格 (voice_mode)
     7→3. 使用 LLM 生成自然语言内容
     8→4. 从 reminders.yaml 读取模板配置
     9→
    10→设计原则:
    11→- 从 unified_profiles 读取用户画像
    12→- 支持 Skill 级内容模板
    13→- 智能化: 基于用户关注点和目标个性化
    14→"""
    15→
    16→import logging
    17→from datetime import date, datetime
    18→from typing import Dict, Any, Optional
    19→from uuid import UUID
    20→
    21→from services.llm import LLMService
    22→from .engine import ReminderTask, ReminderContent
    23→
    24→logger = logging.getLogger(__name__)
    25→
    26→
    27→class ContentGenerator:
    28→    """个性化内容生成器"""
    29→
    30→    def __init__(self):
    31→        self._llm_service = None
    32→
    33→    @property
    34→    def llm_service(self):
    35→        """延迟加载 LLM 服务"""
    36→        if self._llm_service is None:
    37→            self._llm_service = LLMService()
    38→        return self._llm_service
    39→
    40→    async def generate(
    41→        self,
    42→        task: ReminderTask,
    43→        profile: Dict[str, Any],
    44→        config: Dict[str, Any],
    45→    ) -> ReminderContent:
    46→        """
    47→        生成个性化提醒内容
    48→
    49→        Args:
    50→            task: 提醒任务
    51→            profile: 用户画像 (from unified_profiles)
    52→            config: 提醒配置 (from reminders.yaml)
    53→
    54→        Returns:
    55→            ReminderContent
    56→        """
    57→        reminder_type = task.reminder_type
    58→        skill_id = task.skill_id
    59→
    60→        # 根据提醒类型分发到不同生成器
    61→        generator_map = {
    62→            # Bazi
    63→            "daily_fortune": self._generate_daily_fortune,
    64→            "dayun_transition": self._generate_dayun_transition,
    65→            "fortune_alert": self._generate_fortune_alert,
    66→            # Zodiac
    67→            "daily_horoscope": self._generate_daily_horoscope,
    68→            "transit_alert": self._generate_transit_alert,
    69→            "lunar_phase": self._generate_lunar_phase,
    70→            "solar_term": self._generate_solar_term,
    71→            # Core
    72→            "weekly_summary": self._generate_weekly_summary,
    73→            "monthly_report": self._generate_monthly_report,
    74→            # Common
    75→            "birthday": self._generate_birthday,
    76→            "liunian": self._generate_liunian,
    77→        }
    78→
    79→        generator = generator_map.get(reminder_type)
    80→        if generator:
    81→            return await generator(task, profile, config)
    82→
    83→        # 默认生成器
    84→        return await self._generate_default(task, profile, config)
    85→
    86→    # ═══════════════════════════════════════════════════════════════════════════
    87→    # Bazi 内容生成器
    88→    # ═══════════════════════════════════════════════════════════════════════════
    89→
    90→    async def _generate_daily_fortune(
    91→        self,
    92→        task: ReminderTask,
    93→        profile: Dict[str, Any],
    94→        config: Dict[str, Any],
    95→    ) -> ReminderContent:
    96→        """生成每日运势"""
    97→        # 提取用户特征
    98→        birth_info = profile.get("birth_info", {})
    99→        life_context = profile.get("life_context", {})
   100→        preferences = profile.get("preferences", {})
   101→        skill_data = profile.get("skill_data", {}).get("bazi", {})
   102→
   103→        # 获取日主元素
   104→        chart = skill_data.get("chart", {})
   105→        day_master = chart.get("day_master", {})
   106→        day_master_element = day_master.get("element", "wood")
   107→
   108→        # 获取用户关注点
   109→        concerns = life_context.get("concerns", [])
   110→        goals = life_context.get("goals", [])
   111→        voice_mode = preferences.get("voice_mode", "warm")
   112→
   113→        # 计算今日运势
   114→        from skills.bazi.services import BaziComputer
   115→        computer = BaziComputer()
   116→        daily_fortune = await computer.calculate_daily_fortune(profile)
   117→
   118→        # 使用 LLM 生成个性化内容
   119→        content = await self._generate_with_llm(
   120→            template_type="daily_fortune",
   121→            context={
   122→                "day_master_element": day_master_element,
   123→                "daily_fortune": daily_fortune,
   124→                "concerns": concerns[:3] if concerns else [],
   125→                "goals": goals[:2] if goals else [],
   126→                "voice_mode": voice_mode,
   127→                "date": date.today().strftime("%Y年%m月%d日"),
   128→            },
   129→            voice_mode=voice_mode,
   130→        )
   131→
   132→        return ReminderContent(
   133→            title="今日运势",
   134→            body=content.get("greeting", "新的一天，新的开始！"),
   135→            data={
   136→                "fortune_hint": content.get("fortune_hint", ""),
   137→                "action_tip": content.get("action_tip", ""),
   138→                "fortune_score": daily_fortune.get("score", 60),
   139→                "element": day_master_element,
   140→            },
   141→        )
   142→
   143→    async def _generate_dayun_transition(
   144→        self,
   145→        task: ReminderTask,
   146→        profile: Dict[str, Any],
   147→        config: Dict[str, Any],
   148→    ) -> ReminderContent:
   149→        """生成大运交接提醒"""
   150→        event_info = task.metadata.get("event_info", {})
   151→        event_name = event_info.get("event_name", "大运交接")
   152→        days_until = event_info.get("days_until", 0)
   153→
   154→        life_context = profile.get("life_context", {})
   155→        concerns = life_context.get("concerns", [])
   156→
   157→        if days_until == 0:
   158→            title = "大运交接日"
   159→            body = f"今天是您的{event_name}，这是人生重要的转折点。新的十年周期开始，把握机遇，迎接变化。"
   160→        elif days_until == 7:
   161→            title = "大运交接倒计时"
   162→            body = f"还有7天，您将迎来{event_name}。这是人生的重要节点，建议提前做好心理准备。"
   163→        else:
   164→            title = "大运交接预告"
   165→            body = f"还有{days_until}天，您将迎来{event_name}。新的周期即将开始，是时候规划未来了。"
   166→
   167→        return ReminderContent(
   168→            title=title,
   169→            body=body,
   170→            data={
   171→                "event_name": event_name,
   172→                "days_until": days_until,
   173→                "concerns": concerns[:3] if concerns else [],
   174→            },
   175→        )
   176→
   177→    async def _generate_fortune_alert(
   178→        self,
   179→        task: ReminderTask,
   180→        profile: Dict[str, Any],
   181→        config: Dict[str, Any],
   182→    ) -> ReminderContent:
   183→        """生成运势预警"""
   184→        event_info = task.metadata.get("event_info", {})
   185→        score = event_info.get("value", 40)
   186→        threshold = event_info.get("threshold", 40)
   187→
   188→        life_context = profile.get("life_context", {})
   189→        concerns = life_context.get("concerns", [])
   190→
   191→        return ReminderContent(
   192→            title="运势提醒",
   193→            body=f"近期运势能量较低（{score}分），建议放慢脚步，避免重大决策。这是调整和积蓄能量的好时机。",
   194→            data={
   195→                "fortune_score": score,
   196→                "threshold": threshold,
   197→                "concerns": concerns[:3] if concerns else [],
   198→                "suggestions": ["避免冲动决策", "注意休息", "多与亲友交流"],
   199→            },
   200→        )
   201→
   202→    # ═══════════════════════════════════════════════════════════════════════════
   203→    # Zodiac 内容生成器
   204→    # ═══════════════════════════════════════════════════════════════════════════
   205→
   206→    async def _generate_daily_horoscope(
   207→        self,
   208→        task: ReminderTask,
   209→        profile: Dict[str, Any],
   210→        config: Dict[str, Any],
   211→    ) -> ReminderContent:
   212→        """生成每日星座运势"""
   213→        skill_data = profile.get("skill_data", {}).get("zodiac", {})
   214→        chart = skill_data.get("chart", {})
   215→
   216→        sun_sign = chart.get("sun_sign", "")
   217→        moon_sign = chart.get("moon_sign", "")
   218→
   219→        life_context = profile.get("life_context", {})
   220→        concerns = life_context.get("concerns", [])
   221→
   222→        return ReminderContent(
   223→            title="今日星座运势",
   224→            body=f"作为{sun_sign}座，今天的能量适合专注内心，倾听直觉。",
   225→            data={
   226→                "sun_sign": sun_sign,
   227→                "moon_sign": moon_sign,
   228→                "concerns": concerns[:3] if concerns else [],
   229→            },
   230→        )
   231→
   232→    async def _generate_transit_alert(
   233→        self,
   234→        task: ReminderTask,
   235→        profile: Dict[str, Any],
   236→        config: Dict[str, Any],
   237→    ) -> ReminderContent:
   238→        """生成行运提醒"""
   239→        event_info = task.metadata.get("event_info", {})
   240→        event_name = event_info.get("event_name", "行星过境")
   241→        transit_type = event_info.get("transit_type", "")
   242→
   243→        return ReminderContent(
   244→            title=f"星象提醒：{event_name}",
   245→            body=f"今日{event_name}开始，这是一个重要的宇宙能量转换期。",
   246→            data={
   247→                "event_name": event_name,
   248→                "transit_type": transit_type,
   249→            },
   250→        )
   251→
   252→    async def _generate_lunar_phase(
   253→        self,
   254→        task: ReminderTask,
   255→        profile: Dict[str, Any],
   256→        config: Dict[str, Any],
   257→    ) -> ReminderContent:
   258→        """生成月相提醒"""
   259→        event_info = task.metadata.get("event_info", {})
   260→        event_name = event_info.get("event_name", "月相")
   261→        phase = event_info.get("phase", "")
   262→
   263→        if phase == "new_moon":
   264→            body = "新月是播种意图的好时机。写下你的愿望，设定新的目标。"
   265→        elif phase == "full_moon":
   266→            body = "满月是收获和释放的时刻。庆祝你的成就，放下不再需要的。"
   267→        else:
   268→            body = f"今日{event_name}，是调整能量的好时机。"
   269→
   270→        return ReminderContent(
   271→            title=f"月相提醒：{event_name}",
   272→            body=body,
   273→            data={
   274→                "event_name": event_name,
   275→                "phase": phase,
   276→            },
   277→        )
   278→
   279→    async def _generate_solar_term(
   280→        self,
   281→        task: ReminderTask,
   282→        profile: Dict[str, Any],
   283→        config: Dict[str, Any],
   284→    ) -> ReminderContent:
   285→        """生成节气提醒"""
   286→        event_info = task.metadata.get("event_info", {})
   287→        event_name = event_info.get("event_name", "节气")
   288→        description = event_info.get("description", "")
   289→
   290→        return ReminderContent(
   291→            title=f"节气：{event_name}",
   292→            body=description or f"今日{event_name}，顺应自然节律，调整生活作息。",
   293→            data={
   294→                "event_name": event_name,
   295→                "description": description,
   296→            },
   297→        )
   298→
   299→    # ═══════════════════════════════════════════════════════════════════════════
   300→    # Core 内容生成器
   301→    # ═══════════════════════════════════════════════════════════════════════════
   302→
   303→    async def _generate_weekly_summary(
   304→        self,
   305→        task: ReminderTask,
   306→        profile: Dict[str, Any],
   307→        config: Dict[str, Any],
   308→    ) -> ReminderContent:
   309→        """生成每周总结"""
   310→        life_context = profile.get("life_context", {})
   311→        concerns = life_context.get("concerns", [])
   312→        goals = life_context.get("goals", [])
   313→
   314→        return ReminderContent(
   315→            title="本周运势回顾",
   316→            body="新的一周开始了！回顾过去，展望未来，保持积极心态。",
   317→            data={
   318→                "concerns": concerns[:3] if concerns else [],
   319→                "goals": goals[:2] if goals else [],
   320→            },
   321→        )
   322→
   323→    async def _generate_monthly_report(
   324→        self,
   325→        task: ReminderTask,
   326→        profile: Dict[str, Any],
   327→        config: Dict[str, Any],
   328→    ) -> ReminderContent:
   329→        """生成每月报告"""
   330→        today = date.today()
   331→        month_name = today.strftime("%Y年%m月")
   332→
   333→        return ReminderContent(
   334→            title=f"{month_name}运势报告",
   335→            body=f"新的月份开始了！{month_name}的能量主题是成长与突破。",
   336→            data={
   337→                "month": today.month,
   338→                "year": today.year,
   339→            },
   340→        )
   341→
   342→    # ═══════════════════════════════════════════════════════════════════════════
   343→    # 通用内容生成器
   344→    # ═══════════════════════════════════════════════════════════════════════════
   345→
   346→    async def _generate_birthday(
   347→        self,
   348→        task: ReminderTask,
   349→        profile: Dict[str, Any],
   350→        config: Dict[str, Any],
   351→    ) -> ReminderContent:
   352→        """生成生日提醒"""
   353→        event_info = task.metadata.get("event_info", {})
   354→        days_until = event_info.get("days_until", 0)
   355→
   356→        if days_until == 0:
   357→            return ReminderContent(
   358→                title="生日快乐！",
   359→                body="祝您生日快乐！新的一岁，新的开始，愿您心想事成！",
   360→                data={"days_until": 0},
   361→            )
   362→        else:
   363→            return ReminderContent(
   364→                title="生日倒计时",
   365→                body=f"您的生日还有{days_until}天！新的一岁即将开始。",
   366→                data={"days_until": days_until},
   367→            )
   368→
   369→    async def _generate_liunian(
   370→        self,
   371→        task: ReminderTask,
   372→        profile: Dict[str, Any],
   373→        config: Dict[str, Any],
   374→    ) -> ReminderContent:
   375→        """生成流年运势"""
   376→        from skills.bazi.services import BaziComputer
   377→
   378→        computer = BaziComputer()
   379→        year = date.today().year
   380→        annual_fortune = await computer.calculate_annual_fortune(profile, year)
   381→
   382→        return ReminderContent(
   383→            title=f"{year}年运势",
   384→            body=f"新的一年主题：{annual_fortune.get('theme', '稳步前进')}",
   385→            data={
   386→                "year": year,
   387→                "theme": annual_fortune.get("theme", ""),
   388→                "highlights": annual_fortune.get("highlights", []),
   389→                "cautions": annual_fortune.get("cautions", []),
   390→            },
   391→        )
   392→
   393→    async def _generate_default(
   394→        self,
   395→        task: ReminderTask,
   396→        profile: Dict[str, Any],
   397→        config: Dict[str, Any],
   398→    ) -> ReminderContent:
   399→        """默认内容生成器"""
   400→        return ReminderContent(
   401→            title=config.get("name", "通知"),
   402→            body=config.get("description", "您有一条新消息"),
   403→            data={},
   404→        )
   405→
   406→    # ═══════════════════════════════════════════════════════════════════════════
   407→    # LLM 内容生成
   408→    # ═══════════════════════════════════════════════════════════════════════════
   409→
   410→    async def _generate_with_llm(
   411→        self,
   412→        template_type: str,
   413→        context: Dict[str, Any],
   414→        voice_mode: str = "warm",
   415→    ) -> Dict[str, Any]:
   416→        """使用 LLM 生成个性化内容"""
   417→        import json
   418→        from services.llm import create_system_message, create_user_message
   419→
   420→        # 构建 prompt
   421→        system_prompt = self._get_system_prompt(template_type, voice_mode)
   422→        user_prompt = self._get_user_prompt(template_type, context)
   423→
   424→        try:
   425→            messages = [
   426→                create_system_message(system_prompt),
   427→                create_user_message(user_prompt),
   428→            ]
   429→            response = await self.llm_service.chat(messages=messages)
   430→
   431→            # 解析 JSON 响应
   432→            content = response.content.strip()
   433→            # 处理可能的 markdown 代码块
   434→            if content.startswith("```json"):
   435→                content = content[7:]
   436→            if content.startswith("```"):
   437→                content = content[3:]
   438→            if content.endswith("```"):
   439→                content = content[:-3]
   440→
   441→            return json.loads(content.strip())
   442→        except Exception as e:
   443→            logger.error(f"LLM generation failed: {e}")
   444→            # 返回默认内容
   445→            return self._get_fallback_content(template_type, context)
   446→
   447→    def _get_system_prompt(self, template_type: str, voice_mode: str) -> str:
   448→        """获取系统提示词"""
   449→        voice_styles = {
   450→            "warm": "你是 Vibe，一个温暖、共情、支持的 AI 知己。用温暖的语气与用户交流。",
   451→            "sarcastic": "你是 Vibe，一个直接、犀利但有趣的 AI 损友。用幽默的方式给出建议。",
   452→            "wise": "你是 Vibe，一个理性、深度、像长辈一样的 AI 导师。用睿智的方式指点迷津。",
   453→        }
   454→
   455→        base_prompt = voice_styles.get(voice_mode, voice_styles["warm"])
   456→
   457→        if template_type == "daily_fortune":
   458→            return f"""{base_prompt}
   459→
   460→现在要为用户生成一条个性化的每日运势提醒。
   461→
   462→输出 JSON 格式：
   463→{{
   464→    "greeting": "问候语（不超过50字）",
   465→    "fortune_hint": "今日运势提示（不超过30字）",
   466→    "action_tip": "具体可执行的建议（不超过30字）"
   467→}}"""
   468→
   469→        return base_prompt
   470→
   471→    def _get_user_prompt(self, template_type: str, context: Dict[str, Any]) -> str:
   472→        """获取用户提示词"""
   473→        if template_type == "daily_fortune":
   474→            concerns = context.get("concerns", [])
   475→            goals = context.get("goals", [])
   476→            concerns_str = "、".join(concerns) if concerns else "无特别关注"
   477→            goals_str = "、".join(goals) if goals else "无特别目标"
   478→
   479→            return f"""为用户生成今日问候：
   480→- 日期：{context.get('date', '')}
   481→- 日主元素：{context.get('day_master_element', 'wood')}
   482→- 今日运势分数：{context.get('daily_fortune', {}).get('score', 60)}
   483→- 用户关注：{concerns_str}
   484→- 用户目标：{goals_str}"""
   485→
   486→        return str(context)
   487→
   488→    def _get_fallback_content(self, template_type: str, context: Dict[str, Any]) -> Dict[str, Any]:
   489→        """获取降级内容"""
   490→        if template_type == "daily_fortune":
   491→            return {
   492→                "greeting": "新的一天，新的开始！愿今天一切顺利。",
   493→                "fortune_hint": "保持积极心态",
   494→                "action_tip": "专注当下，一步一步来",
   495→            }
   496→        return {"message": "您有一条新消息"}
   497→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
