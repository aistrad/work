The file /home/aiscend/work/vibelife/docs/components/VibeProfile.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→# VibeProfile v13 设计文档
     2→
     3→> 简化的用户画像架构：从交互中提取，注入 Context，个性化服务
     4→
     5→## 一、设计原则
     6→
     7→```
     8→Vibe = 关于用户的结构化记忆
     9→
    10→输入：用户在系统中的所有交互（对话、工具调用、Skill 数据）
    11→输出：结构化画像 → 注入 Context → 个性化服务
    12→```
    13→
    14→**核心简化**：
    15→1. **单一数据流**：所有 Vibe 数据都从"交互"中提取，不再从多个源同步
    16→2. **三层存储**：Hot（实时）+ Warm（定时）+ Cold（事件）
    17→3. **扁平结构**：减少嵌套层级，每个字段有明确语义
    18→
    19→## 二、整体架构
    20→
    21→```
    22→┌─────────────────────────────────────────────────────────────────────────────┐
    23→│                       VibeProfile 架构 v13                                   │
    24→├─────────────────────────────────────────────────────────────────────────────┤
    25→│                                                                             │
    26→│   数据源（所有交互）              提取器                    存储            │
    27→│   ─────────────────              ─────                    ────            │
    28→│                                                                             │
    29→│   ┌─────────────────┐                                                       │
    30→│   │    对话消息      │────┐                                                  │
    31→│   │  role + content │    │                                                  │
    32→│   └─────────────────┘    │                                                  │
    33→│                          │    ┌──────────────┐    ┌──────────────────────┐ │
    34→│   ┌─────────────────┐    ├──▶│   实时提取    │──▶│   vibe.current       │ │
    35→│   │    工具调用      │────┤    │  (每轮对话后) │    │   (Hot, 实时覆盖)    │ │
    36→│   │  tool + result  │    │    └──────────────┘    └──────────────────────┘ │
    37→│   └─────────────────┘    │                                                  │
    38→│                          │    ┌──────────────┐    ┌──────────────────────┐ │
    39→│   ┌─────────────────┐    ├──▶│   定时提取    │──▶│   vibe.profile       │ │
    40→│   │   Skill 数据     │────┤    │  (每日凌晨)   │    │   (Warm, 增量合并)   │ │
    41→│   │  chart + 计算   │    │    └──────────────┘    └──────────────────────┘ │
    42→│   └─────────────────┘    │                                                  │
    43→│                          │    ┌──────────────┐    ┌──────────────────────┐ │
    44→│   ┌─────────────────┐    └──▶│   事件检测    │──▶│   vibe.timeline      │ │
    45→│   │    用户行为      │────────▶│  (触发式)     │    │   (Cold, 追加存储)   │ │
    46→│   │  click + action │         └──────────────┘    └──────────────────────┘ │
    47→│   └─────────────────┘                                                       │
    48→│                                                                             │
    49→│   ════════════════════════════════════════════════════════════════════════ │
    50→│                                                                             │
    51→│   消费者（读取 vibe.* 注入 Context）                                        │
    52→│   ──────────────────────────────────                                        │
    53→│   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐          │
    54→│   │ CoreAgent  │  │   Skills   │  │ Proactive  │  │   推荐     │          │
    55→│   └────────────┘  └────────────┘  └────────────┘  └────────────┘          │
    56→│                                                                             │
    57→└─────────────────────────────────────────────────────────────────────────────┘
    58→```
    59→
    60→## 三、Vibe 层完整结构
    61→
    62→```yaml
    63→vibe:
    64→  # ═══════════════════════════════════════════════════════════════
    65→  # 1. current - 当前状态（Hot Layer）
    66→  #    更新时机：每轮对话后实时更新
    67→  #    写入策略：覆盖写入
    68→  #    用途：捕捉即时状态，下一轮对话立即可用
    69→  # ═══════════════════════════════════════════════════════════════
    70→  current:
    71→    emotion: "focused"           # 当前情绪 (anxious|sad|neutral|content|excited|focused)
    72→    energy: "high"               # 能量水平 (low|medium|high)
    73→    focus: ["career"]            # 当前关注领域
    74→    topics:                      # 进行中的话题（最多 5 个）
    75→      - "职业转型考虑中"
    76→      - "和伴侣沟通问题"
    77→    context: "用户在考虑是否接受新工作offer"  # 当前对话上下文摘要
    78→    updated_at: "2026-01-23T10:00:00Z"
    79→
    80→  # ═══════════════════════════════════════════════════════════════
    81→  # 2. profile - 稳定画像（Warm Layer）
    82→  #    更新时机：每日凌晨定时提取
    83→  #    写入策略：增量合并，去重
    84→  #    用途：长期画像，供所有 Skill 读取
    85→  # ═══════════════════════════════════════════════════════════════
    86→  profile:
    87→    # 身份特征
    88→    identity:
    89→      archetypes: ["成长者", "开拓者"]   # 人格原型（融合多来源）
    90→      traits: ["创新", "进取", "直觉"]    # 核心特质（max 5）
    91→      style: "理性分析型"                 # 沟通风格
    92→      sources:                            # 来源追溯（供 Skill 参考）
    93→        bazi: { day_master: "甲木", element: "wood" }
    94→        zodiac: { sun_sign: "aries", moon_sign: "cancer" }
    95→
    96→    # 目标与愿景
    97→    goals:
    98→      - id: "g_001"
    99→        title: "完成副业项目第一版"
   100→        category: "career"               # career|health|relationship|wealth|growth
   101→        status: "active"                 # active|paused|completed
   102→        progress: 60                     # 0-100
   103→        deadline: "2026-03-01"
   104→        mentioned_at: "2026-01-20"
   105→      - id: "g_002"
   106→        title: "建立个人品牌"
   107→        category: "career"
   108→        status: "active"
   109→        progress: 30
   110→        mentioned_at: "2026-01-15"
   111→
   112→    # 关键人物
   113→    people:
   114→      - id: "p_001"
   115→        name: "小明"
   116→        relation: "romantic"             # romantic|family|friend|colleague|other
   117→        birth_info:                      # 可选，用于合盘
   118→          date: "1992-05-15"
   119→          time: "14:30"
   120→          place: "上海"
   121→        notes: "伴侣，沟通风格偏感性"
   122→        mentioned_at: "2026-01-22"
   123→
   124→    # 生活背景
   125→    context:
   126→      occupation: "产品经理"
   127→      industry: "互联网"
   128→      life_stage: "career_growth"        # student|early_career|career_growth|career_peak|transition|retirement
   129→      concerns: ["工作压力", "职业发展"]  # 当前困扰（max 5）
   130→      interests: ["命理", "心理学", "创业"]  # 兴趣领域（max 10）
   131→
   132→    # 偏好（从行为中学习）
   133→    preferences:
   134→      response_style: "简洁直接"         # 期望的回复风格
   135→      language: "zh-CN"
   136→      topics_to_avoid: []                # 不想谈的话题
   137→
   138→    updated_at: "2026-01-23T04:00:00Z"
   139→
   140→  # ═══════════════════════════════════════════════════════════════
   141→  # 3. timeline - 重要事件（Cold Layer）
   142→  #    更新时机：检测到关键事件时追加
   143→  #    写入策略：追加存储，保留最近 100 条
   144→  #    用途：回溯重要节点，支持时间线展示
   145→  # ═══════════════════════════════════════════════════════════════
   146→  timeline:
   147→    - id: "e_001"
   148→      date: "2026-01-22"
   149→      type: "relationship"               # goal|relationship|decision|milestone|life_event
   150→      event: "添加伴侣信息进行合盘"
   151→      data:
   152→        person_id: "p_001"
   153→        action: "synastry"
   154→    - id: "e_002"
   155→      date: "2026-01-20"
   156→      type: "goal"
   157→      event: "设定新目标：完成副业项目"
   158→      data:
   159→        goal_id: "g_001"
   160→    - id: "e_003"
   161→      date: "2026-01-18"
   162→      type: "decision"
   163→      event: "开始分析 A 公司 offer"
   164→      data:
   165→        title: "要不要接 A 公司 offer"
   166→        status: "analyzing"
   167→    - id: "e_004"
   168→      date: "2026-01-15"
   169→      type: "milestone"
   170→      event: "首次命盘计算"
   171→      data:
   172→        skill: "bazi"
   173→```
   174→
   175→## 四、提取器设计
   176→
   177→### 4.1 实时提取器（Hot Extractor）
   178→
   179→```
   180→触发时机：每轮对话结束后
   181→输入：当前对话最近 10 条消息
   182→输出：vibe.current（覆盖写入）
   183→延迟要求：< 2s
   184→```
   185→
   186→```python
   187→# 实时提取 Prompt
   188→REALTIME_EXTRACTION_PROMPT = """
   189→分析对话，提取用户当前状态。只返回 JSON。
   190→
   191→{
   192→  "emotion": "focused",      // anxious|sad|neutral|content|excited|focused
   193→  "energy": "high",          // low|medium|high
   194→  "focus": ["career"],       // 当前关注领域
   195→  "topics": ["..."],         // 进行中的话题（max 5）
   196→  "context": "..."           // 一句话总结当前对话上下文
   197→}
   198→"""
   199→```
   200→
   201→### 4.2 定时提取器（Warm Extractor）
   202→
   203→```
   204→触发时机：每日 04:00
   205→输入：过去 7 天所有交互 + 现有 vibe.profile
   206→输出：vibe.profile（增量合并）
   207→处理量：每用户 ~100 条消息
   208→```
   209→
   210→```python
   211→# 定时提取 Prompt
   212→DAILY_EXTRACTION_PROMPT = """
   213→分析用户过去一周的交互记录，更新用户画像。
   214→
   215→## 当前画像
   216→{current_profile}
   217→
   218→## 新交互记录
   219→{interactions}
   220→
   221→## 输出格式
   222→只返回需要新增或更新的字段：
   223→{
   224→  "identity": { ... },    // 如有新发现的特质
   225→  "goals": [ ... ],       // 如有新目标
   226→  "people": [ ... ],      // 如有新提及的人物
   227→  "context": { ... },     // 如有新的背景信息
   228→  "preferences": { ... }  // 如有新的偏好
   229→}
   230→"""
   231→```
   232→
   233→### 4.3 事件检测器（Cold Detector）
   234→
   235→```
   236→触发时机：实时检测 + 定时扫描
   237→检测条件：
   238→  - 新目标设定（关键词：想要、计划、目标）
   239→  - 新人物提及（关键词：伴侣、父母、朋友 + 姓名）
   240→  - 重要决策（关键词：纠结、选择、决定）
   241→  - 人生事件（关键词：结婚、买房、跳槽、生病）
   242→输出：vibe.timeline（追加）
   243→```
   244→
   245→## 五、数据流设计
   246→
   247→```
   248→┌─────────────────────────────────────────────────────────────────────────────┐
   249→│                            数据流                                            │
   250→├─────────────────────────────────────────────────────────────────────────────┤
   251→│                                                                             │
   252→│   用户交互                                                                   │
   253→│   ────────                                                                  │
   254→│                                                                             │
   255→│   1. 对话消息 ──► messages 表                                               │
   256→│   2. 工具调用 ──► messages.metadata.tool_calls                              │
   257→│   3. Skill 计算 ──► skills.{skill_id}                                       │
   258→│   4. 用户行为 ──► usage_events 表                                           │
   259→│                                                                             │
   260→│   ════════════════════════════════════════════════════════════════════════ │
   261→│                                                                             │
   262→│   提取流程                                                                   │
   263→│   ────────                                                                  │
   264→│                                                                             │
   265→│   ┌─────────────────────────────────────────────────────────────────────┐   │
   266→│   │  对话结束                                                            │   │
   267→│   │      │                                                              │   │
   268→│   │      ▼                                                              │   │
   269→│   │  ┌──────────────────┐                                               │   │
   270→│   │  │  实时提取器       │──► vibe.current（覆盖）                       │   │
   271→│   │  │  extract_current │                                               │   │
   272→│   │  └──────────────────┘                                               │   │
   273→│   │      │                                                              │   │
   274→│   │      ▼                                                              │   │
   275→│   │  ┌──────────────────┐                                               │   │
   276→│   │  │  事件检测器       │──► vibe.timeline（追加）                      │   │
   277→│   │  │  detect_events   │                                               │   │
   278→│   │  └──────────────────┘                                               │   │
   279→│   └─────────────────────────────────────────────────────────────────────┘   │
   280→│                                                                             │
   281→│   ┌─────────────────────────────────────────────────────────────────────┐   │
   282→│   │  每日 04:00                                                          │   │
   283→│   │      │                                                              │   │
   284→│   │      ▼                                                              │   │
   285→│   │  ┌──────────────────┐                                               │   │
   286→│   │  │  定时提取器       │──► vibe.profile（合并）                       │   │
   287→│   │  │  extract_profile │                                               │   │
   288→│   │  └──────────────────┘                                               │   │
   289→│   └─────────────────────────────────────────────────────────────────────┘   │
   290→│                                                                             │
   291→│   ════════════════════════════════════════════════════════════════════════ │
   292→│                                                                             │
   293→│   消费流程                                                                   │
   294→│   ────────                                                                  │
   295→│                                                                             │
   296→│   CoreAgent / Skill / Proactive                                             │
   297→│       │                                                                     │
   298→│       ▼                                                                     │
   299→│   get_vibe_context(user_id)                                                 │
   300→│       │                                                                     │
   301→│       ▼                                                                     │
   302→│   构建个性化 System Prompt                                                  │
   303→│                                                                             │
   304→└─────────────────────────────────────────────────────────────────────────────┘
   305→```
   306→
   307→## 六、API 设计
   308→
   309→```python
   310→class UnifiedProfileRepository:
   311→    # ═══════════════════════════════════════════════════════════════
   312→    # Vibe 读取
   313→    # ═══════════════════════════════════════════════════════════════
   314→
   315→    async def get_vibe(user_id: UUID) -> Dict:
   316→        """获取完整 Vibe 数据"""
   317→
   318→    async def get_vibe_current(user_id: UUID) -> Dict:
   319→        """获取当前状态（Hot Layer）"""
   320→
   321→    async def get_vibe_profile(user_id: UUID) -> Dict:
   322→        """获取稳定画像（Warm Layer）"""
   323→
   324→    async def get_vibe_timeline(user_id: UUID, limit: int = 20) -> List[Dict]:
   325→        """获取事件时间线（Cold Layer）"""
   326→
   327→    async def get_vibe_context(user_id: UUID) -> str:
   328→        """获取用于注入 System Prompt 的上下文字符串"""
   329→
   330→    # ═══════════════════════════════════════════════════════════════
   331→    # Vibe 写入
   332→    # ═══════════════════════════════════════════════════════════════
   333→
   334→    async def update_vibe_current(user_id: UUID, current: Dict) -> None:
   335→        """更新当前状态（覆盖写入）"""
   336→
   337→    async def update_vibe_profile(user_id: UUID, updates: Dict) -> None:
   338→        """更新稳定画像（增量合并）"""
   339→
   340→    async def append_vibe_timeline(user_id: UUID, event: Dict) -> str:
   341→        """追加事件到时间线，返回 event_id"""
   342→
   343→    # ═══════════════════════════════════════════════════════════════
   344→    # 便捷方法
   345→    # ═══════════════════════════════════════════════════════════════
   346→
   347→    async def add_goal(user_id: UUID, goal: Dict) -> str:
   348→        """添加目标到 vibe.profile.goals"""
   349→
   350→    async def update_goal(user_id: UUID, goal_id: str, updates: Dict) -> bool:
   351→        """更新目标"""
   352→
   353→    async def add_person(user_id: UUID, person: Dict) -> str:
   354→        """添加人物到 vibe.profile.people"""
   355→
   356→    async def get_person(user_id: UUID, person_id: str) -> Optional[Dict]:
   357→        """获取人物信息"""
   358→```
   359→
   360→## 七、Context 注入示例
   361→
   362→```python
   363→async def build_vibe_context(user_id: UUID) -> str:
   364→    """构建用于 System Prompt 的 Vibe 上下文"""
   365→
   366→    vibe = await UnifiedProfileRepository.get_vibe(user_id)
   367→    current = vibe.get("current", {})
   368→    profile = vibe.get("profile", {})
   369→
   370→    parts = []
   371→
   372→    # 当前状态
   373→    if current:
   374→        parts.append(f"【当前状态】情绪: {current.get('emotion', '未知')}, "
   375→                    f"关注: {', '.join(current.get('focus', []))}")
   376→        if current.get('context'):
   377→            parts.append(f"上下文: {current['context']}")
   378→
   379→    # 身份特征
   380→    identity = profile.get("identity", {})
   381→    if identity.get("archetypes"):
   382→        parts.append(f"【人格原型】{', '.join(identity['archetypes'])}")
   383→    if identity.get("traits"):
   384→        parts.append(f"【核心特质】{', '.join(identity['traits'])}")
   385→
   386→    # 目标
   387→    goals = profile.get("goals", [])
   388→    active_goals = [g for g in goals if g.get("status") == "active"]
   389→    if active_goals:
   390→        goal_texts = [f"{g['title']}({g.get('progress', 0)}%)" for g in active_goals[:3]]
   391→        parts.append(f"【当前目标】{', '.join(goal_texts)}")
   392→
   393→    # 背景
   394→    context = profile.get("context", {})
   395→    if context.get("occupation"):
   396→        parts.append(f"【职业】{context['occupation']}")
   397→    if context.get("concerns"):
   398→        parts.append(f"【关注问题】{', '.join(context['concerns'][:3])}")
   399→
   400→    return "\n".join(parts)
   401→```
   402→
   403→## 八、与 v12 的迁移映射
   404→
   405→| v12 结构 | v13 结构 | 迁移说明 |
   406→|----------|----------|----------|
   407→| insight.essence.archetype | profile.identity.archetypes | 扁平化，数组存储 |
   408→| insight.essence.traits | profile.identity.traits | 保持 |
   409→| insight.essence.shadow | 移除 | 低使用率 |
   410→| insight.psyche | profile.identity.style | 简化为单字段 |
   411→| insight.dynamic.emotion | current.emotion | 提升到 current 层 |
   412→| insight.dynamic.energy | current.energy | 提升到 current 层 |
   413→| target.north_star | profile.goals[0] | 合并到目标列表 |
   414→| target.goals | profile.goals | 保持 |
   415→| target.focus | current.focus | 分离到实时层 |
   416→| timing.current_window | 移除 | 按需从 Skill 实时计算 |
   417→| timing.windows | 移除 | 按需从 Skill 实时计算 |
   418→| timing.decisions | timeline[] type=decision | 作为事件存储 |
   419→| timing.milestones | timeline[] type=milestone | 作为事件存储 |
   420→| relationship.partners | profile.people | 简化结构 |
   421→| relationship.daily_weather | 移除 | 按需实时计算 |
   422→| relationship.interaction_patterns | 移除 | 低使用率 |
   423→
   424→## 九、移除的组件
   425→
   426→### 9.1 移除 vibe_sync.yaml
   427→
   428→**原因**：配置驱动的同步过于复杂，且与"从交互提取"的理念冲突。
   429→
   430→**迁移方案**：
   431→- Skill 数据（bazi/zodiac chart）保存在 `skills.{skill_id}`
   432→- 定时提取器会读取 Skill 数据，提取关键特征到 `vibe.profile.identity.sources`
   433→
   434→### 9.2 简化 ProfileExtractor
   435→
   436→**原因**：原 V8 版本同时更新 insight 和 target，结构复杂。
   437→
   438→**新设计**：
   439→- `extract_current()` - 实时提取当前状态
   440→- `extract_profile()` - 定时提取稳定画像
   441→- `detect_events()` - 事件检测
   442→
   443→## 十、版本历史
   444→
   445→| 版本 | 日期 | 变更 |
   446→|------|------|------|
   447→| v13 | 2026-01-23 | 简化架构：三层存储（current/profile/timeline），移除 vibe_sync.yaml |
   448→| v12 | 2026-01-23 | 完整设计：insight/target/timing/relationship/timeline |
   449→| v11 | 2026-01-15 | 新增 vibe_sync.yaml 配置驱动同步 |
   450→| v10 | 2026-01-10 | 新增 relationship 支持合盘 |
   451→| v9 | 2026-01-05 | 三层架构：identity + skills + vibe |
   452→