     1→"""
     2→Prompt Builder v10 - System Prompt 构建
     3→
     4→从 core.py 拆分出来的 Prompt 构建逻辑，支持：
     5→- Phase 1/Phase 2 分阶段 Prompt
     6→- 会话恢复 Prompt（断点续传）
     7→- SOP 规则注入
     8→- 案例匹配
     9→
    10→与 ContextManager 协作：
    11→- 读取会话上下文
    12→- 注入断点信息
    13→"""
    14→import json
    15→import logging
    16→from typing import Optional, Dict, Any, List
    17→
    18→from .skill_loader import (
    19→    load_skill, build_system_prompt,
    20→    skill_requires_birth_info, skill_requires_compute,
    21→    get_skill_compute_type, get_skill_compute_tool, get_skill_collect_tool,
    22→    get_skill_required_data
    23→)
    24→from .routing_config import get_phase1_prompt, get_sop_template
    25→from .context_manager import SessionContext
    26→
    27→logger = logging.getLogger(__name__)
    28→
    29→
    30→class PromptBuilder:
    31→    """
    32→    System Prompt 构建器
    33→
    34→    职责：
    35→    1. 根据 Phase 构建不同的 Prompt
    36→    2. 注入会话恢复上下文
    37→    3. 注入 SOP 规则
    38→    4. 动态加载案例
    39→    5. v10.1: 用户画像注入（让 Coach 了解用户）
    40→    """
    41→
    42→    # 需要详细用户画像的 Skill（注入 goals, patterns, findings）
    43→    PORTRAIT_FULL_SKILLS = {"lifecoach", "career"}
    44→
    45→    # 需要出生信息的 Skill
    46→    BIRTH_INFO_SKILLS = {"bazi", "zodiac", "jungastro"}
    47→
    48→    def __init__(self):
    49→        self.case_index = None  # Lazy init
    50→
    51→    async def build(
    52→        self,
    53→        skill_id: Optional[str],
    54→        rule_id: Optional[str],
    55→        message: str,
    56→        profile: Optional[Dict[str, Any]] = None,
    57→        skill_data: Optional[Dict[str, Any]] = None,
    58→        session_context: Optional[SessionContext] = None,
    59→        protocol_prompt: Optional[str] = None
    60→    ) -> str:
    61→        """
    62→        构建 System Prompt
    63→
    64→        Args:
    65→            skill_id: 当前技能 ID
    66→            rule_id: 当前规则 ID
    67→            message: 用户消息
    68→            profile: 用户 Profile
    69→            skill_data: Skill 数据
    70→            session_context: 会话上下文（断点续传）
    71→            protocol_prompt: 协议专用 Prompt（可选）
    72→
    73→        Returns:
    74→            完整的 System Prompt
    75→        """
    76→        parts = []
    77→
    78→        # ═══════════════════════════════════════════════════════════════
    79→        # 协议模式：使用协议专用 Prompt
    80→        # ═══════════════════════════════════════════════════════════════
    81→        if protocol_prompt:
    82→            skill = load_skill("lifecoach")
    83→            if skill:
    84→                parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
    85→            parts.append("\n---\n")
    86→            parts.append(protocol_prompt)
    87→            return "\n".join(parts)
    88→
    89→        if skill_id:
    90→            # ═══════════════════════════════════════════════════════════════
    91→            # Phase 2: Skill 执行阶段 - 完整上下文
    92→            # ═══════════════════════════════════════════════════════════════
    93→
    94→            # 基础 Skill Prompt
    95→            user_ctx = dict(profile) if profile else {}
    96→            base_prompt = build_system_prompt(skill_id, rule_id, user_ctx)
    97→            parts.append(base_prompt)
    98→
    99→            # ═══════════════════════════════════════════════════════════════
   100→            # Profile 注入（简化版 v2.2）- 两层架构
   101→            # ═══════════════════════════════════════════════════════════════
   102→            profile_context = self._build_profile_context(profile, skill_data, skill_id)
   103→            if profile_context:
   104→                parts.append(profile_context)
   105→
   106→            # 会话恢复上下文（断点续传核心）
   107→            if session_context and session_context.has_checkpoint:
   108→                resume_context = session_context.to_prompt_context()
   109→                if resume_context:
   110→                    parts.append(resume_context)
   111→
   112→            # SOP 规则
   113→            sop_rules = self._build_sop_rules(skill_id, profile, skill_data)
   114→            if sop_rules:
   115→                parts.append(sop_rules)
   116→
   117→            # 案例匹配
   118→            cases_text = await self._match_cases(skill_id, skill_data)
   119→            if cases_text:
   120→                parts.append(cases_text)
   121→
   122→        else:
   123→            # ═══════════════════════════════════════════════════════════════
   124→            # Phase 1: Skill 选择阶段 - v11 个性化路由
   125→            # ═══════════════════════════════════════════════════════════════
   126→
   127→            core_prompt = get_phase1_prompt()
   128→            if not core_prompt:
   129→                # Fallback
   130→                core_prompt = self._get_fallback_phase1_prompt()
   131→
   132→            # v11: 注入用户画像和订阅信息（用于个性化路由）
   133→            if profile:
   134→                core_prompt = self._inject_phase1_context(core_prompt, profile)
   135→
   136→            parts.append(core_prompt)
   137→
   138→        return "\n".join(parts)
   139→
   140→    def _build_profile_context(
   141→        self,
   142→        profile: Optional[Dict[str, Any]],
   143→        skill_data: Optional[Dict[str, Any]],
   144→        skill_id: str
   145→    ) -> str:
   146→        """
   147→        构建 Profile 上下文（v3.0 三层架构）
   148→
   149→        三层架构：
   150→        - Layer 1: Identity（共享）- 基本信息

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
