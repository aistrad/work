     1→"""
     2→Context Manager v10 - Context Engineering 核心
     3→
     4→管理 Agent 的"磁盘工作记忆"，实现：
     5→- 会话上下文持久化
     6→- 断点续传（checkpoint 机制）
     7→- 分析发现积累（findings）
     8→- 跨 Skill 共享上下文
     9→
    10→数据存储位置（v9.0 三层架构）：
    11→- profile.identity: 用户基本信息
    12→- profile.skills.{skill_id}: Skill 数据
    13→- profile.skills.{skill_id}._session: Skill 会话状态
    14→- profile.skills.{skill_id}._findings: 分析发现
    15→- profile.vibe.insight: 用户画像（我是谁）
    16→- profile.vibe.target: 用户目标（我要成为谁）
    17→"""
    18→import json
    19→import logging
    20→from dataclasses import dataclass, field, asdict
    21→from datetime import datetime, timezone
    22→from typing import Optional, Dict, Any, List
    23→from uuid import UUID
    24→
    25→logger = logging.getLogger(__name__)
    26→
    27→
    28→# ═══════════════════════════════════════════════════════════════════════════
    29→# Data Classes
    30→# ═══════════════════════════════════════════════════════════════════════════
    31→
    32→@dataclass
    33→class Checkpoint:
    34→    """执行检查点 - 支持断点续传"""
    35→    phase: Optional[int] = None
    36→    step: int = 0
    37→    total_steps: int = 0
    38→    collected_data: Dict[str, Any] = field(default_factory=dict)
    39→
    40→    def to_dict(self) -> Dict[str, Any]:
    41→        return asdict(self)
    42→
    43→    @classmethod
    44→    def from_dict(cls, data: Dict[str, Any]) -> "Checkpoint":
    45→        return cls(
    46→            phase=data.get("phase"),
    47→            step=data.get("step", 0),
    48→            total_steps=data.get("total_steps", 0),
    49→            collected_data=data.get("collected_data", {})
    50→        )
    51→
    52→
    53→@dataclass
    54→class SkillSession:
    55→    """Skill 会话状态"""
    56→    active: bool = False
    57→    rule_id: Optional[str] = None
    58→    started_at: Optional[str] = None
    59→    last_activity: Optional[str] = None
    60→    checkpoint: Optional[Checkpoint] = None
    61→    context: Dict[str, Any] = field(default_factory=dict)
    62→
    63→    def to_dict(self) -> Dict[str, Any]:
    64→        return {
    65→            "active": self.active,
    66→            "rule_id": self.rule_id,
    67→            "started_at": self.started_at,
    68→            "last_activity": self.last_activity,
    69→            "checkpoint": self.checkpoint.to_dict() if self.checkpoint else None,
    70→            "context": self.context
    71→        }
    72→
    73→    @classmethod
    74→    def from_dict(cls, data: Dict[str, Any]) -> "SkillSession":
    75→        checkpoint_data = data.get("checkpoint")
    76→        return cls(
    77→            active=data.get("active", False),
    78→            rule_id=data.get("rule_id"),
    79→            started_at=data.get("started_at"),
    80→            last_activity=data.get("last_activity"),
    81→            checkpoint=Checkpoint.from_dict(checkpoint_data) if checkpoint_data else None,
    82→            context=data.get("context", {})
    83→        )
    84→
    85→
    86→@dataclass
    87→class Finding:
    88→    """分析发现"""
    89→    type: str  # insight | pattern | concern | goal | milestone
    90→    content: str
    91→    rule_id: Optional[str] = None
    92→    created_at: Optional[str] = None
    93→    metadata: Dict[str, Any] = field(default_factory=dict)
    94→
    95→    def to_dict(self) -> Dict[str, Any]:
    96→        return asdict(self)
    97→
    98→    @classmethod
    99→    def from_dict(cls, data: Dict[str, Any]) -> "Finding":
   100→        return cls(
   101→            type=data.get("type", "insight"),
   102→            content=data.get("content", ""),
   103→            rule_id=data.get("rule_id"),
   104→            created_at=data.get("created_at"),
   105→            metadata=data.get("metadata", {})
   106→        )
   107→
   108→
   109→@dataclass
   110→class SessionContext:
   111→    """会话上下文（用于传递给 LLM）"""
   112→    skill_id: str
   113→    rule_id: Optional[str] = None
   114→    session: Optional[SkillSession] = None
   115→    findings: List[Finding] = field(default_factory=list)
   116→    shared_context: Dict[str, Any] = field(default_factory=dict)
   117→
   118→    @property
   119→    def has_checkpoint(self) -> bool:
   120→        """是否有可恢复的检查点"""
   121→        return (
   122→            self.session is not None and
   123→            self.session.checkpoint is not None and
   124→            self.session.checkpoint.step > 0
   125→        )
   126→
   127→    @property
   128→    def checkpoint(self) -> Optional[Checkpoint]:
   129→        """获取检查点"""
   130→        return self.session.checkpoint if self.session else None
   131→
   132→    def to_prompt_context(self) -> str:
   133→        """转换为 Prompt 上下文文本"""
   134→        if not self.has_checkpoint:
   135→            return ""
   136→
   137→        cp = self.checkpoint
   138→        lines = ["## 会话恢复上下文（断点续传）\n"]
   139→
   140→        # 会话信息
   141→        if self.session:
   142→            lines.append(f"**上次会话信息**：")
   143→            if self.rule_id:
   144→                lines.append(f"- 规则: {self.rule_id}")
   145→            lines.append(f"- 开始时间: {self.session.started_at}")
   146→            lines.append(f"- 上次活动: {self.session.last_activity}")
   147→            lines.append("")
   148→
   149→        # 进度信息
   150→        if cp:

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
