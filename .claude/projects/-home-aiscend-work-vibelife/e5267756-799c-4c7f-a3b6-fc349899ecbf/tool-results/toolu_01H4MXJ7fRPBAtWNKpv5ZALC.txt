     1→# VibeProfile v12 设计文档
     2→
     3→> 跨 Skill 共享数据层的统一架构设计
     4→
     5→## 一、设计原则
     6→
     7→```
     8→vibe 层 = 跨 Skill 共享的"高阶理解"
     9→
    10→- 不是原始数据（那些存在 skills.{skill_id}）
    11→- 而是从多个 Skill 汇聚/融合后的洞察
    12→- 供所有 Skill 读取，按配置规则写入
    13→```
    14→
    15→## 二、整体架构
    16→
    17→```
    18→┌─────────────────────────────────────────────────────────────────────────────┐
    19→│                        VibeProfile 数据架构 (v12)                            │
    20→├─────────────────────────────────────────────────────────────────────────────┤
    21→│                                                                             │
    22→│   Layer 1: identity        身份层（基础信息，所有 Skill 共享读取）            │
    23→│   Layer 2: skills          技能层（各 Skill 原始数据，隔离存储）              │
    24→│   Layer 3: vibe            共享层（跨 Skill 融合洞察，本文档重点）            │
    25→│   Layer 4: preferences     偏好层（用户设置）                                │
    26→│                                                                             │
    27→└─────────────────────────────────────────────────────────────────────────────┘
    28→```
    29→
    30→## 三、vibe 层完整结构
    31→
    32→```yaml
    33→vibe:
    34→  # ═══════════════════════════════════════════════════════════════
    35→  # 1. insight - 我是谁（静态本质 + 动态状态）
    36→  # ═══════════════════════════════════════════════════════════════
    37→  insight:
    38→    essence:           # 本质（多来源融合）
    39→      archetype:       # 人格原型
    40→        primary: "成长者"
    41→        sources:
    42→          - { skill: "bazi", value: "甲木" }
    43→          - { skill: "zodiac", value: "Aries" }
    44→      traits:          # 核心特质（去重合并）
    45→        - { trait: "创新", intensity: 0.9, sources: ["bazi", "zodiac"] }
    46→        - { trait: "进取", intensity: 0.8, sources: ["bazi"] }
    47→      shadow:          # 阴影面（Psych Skill 贡献）
    48→        patterns: ["控制倾向", "回避冲突"]
    49→        source: "psych"
    50→        updated_at: "2026-01-23T10:00:00Z"
    51→
    52→    psyche:            # 心理画像（Psych Skill 专属贡献）
    53→      dominant_functions: ["Ni", "Te"]  # 荣格心理功能
    54→      attachment_style: "secure"         # 依恋类型
    55→      coping_patterns:                   # 应对模式
    56→        - { pattern: "理性分析", context: "压力下", effectiveness: "high" }
    57→      growth_areas:                      # 成长领域
    58→        - { area: "情感表达", priority: "high" }
    59→      updated_at: "2026-01-23T10:00:00Z"
    60→
    61→    dynamic:           # 动态状态（定期更新）
    62→      emotion:
    63→        current: "focused"
    64→        trend: "stable"
    65→        updated_at: "2026-01-23T10:00:00Z"
    66→      energy:
    67→        level: 72
    68→        trend: "rising"
    69→        updated_at: "2026-01-23T10:00:00Z"
    70→
    71→  # ═══════════════════════════════════════════════════════════════
    72→  # 2. target - 我要成为谁（目标 + 聚焦）
    73→  # ═══════════════════════════════════════════════════════════════
    74→  target:
    75→    north_star:        # 北极星愿景（lifecoach 贡献）
    76→      vision_scene: "站在自己创办的公司里，团队成员都在做有意义的事..."
    77→      anti_vision: "困在无意义的工作中，每天只是为了生存..."
    78→      statement: "成为一个能够帮助他人实现潜能的创业者"
    79→      updated_at: "2026-01-20T10:00:00Z"
    80→
    81→    goals:             # 当前目标（lifecoach 贡献）
    82→      - id: "goal_001"
    83→        title: "完成副业项目第一版"
    84→        status: "active"
    85→        progress: 60
    86→        deadline: "2026-03-01"
    87→      - id: "goal_002"
    88→        title: "建立个人品牌"
    89→        status: "active"
    90→        progress: 30
    91→        deadline: "2026-06-01"
    92→
    93→    focus:             # 当前聚焦
    94→      primary: "career"
    95→      active_goal: "goal_001"
    96→      updated_at: "2026-01-23T10:00:00Z"
    97→
    98→  # ═══════════════════════════════════════════════════════════════
    99→  # 3. timing - 我的时机（职场时机/人生节点的核心支撑）
   100→  # ═══════════════════════════════════════════════════════════════
   101→  timing:
   102→    current_window:    # 当前时机窗口（每日更新）
   103→      quality: 78      # 0-100 综合评分
   104→      factors:
   105→        - { source: "bazi", factor: "日主得令", effect: "positive", weight: 0.3 }
   106→        - { source: "zodiac", factor: "木星三分太阳", effect: "positive", weight: 0.25 }
   107→        - { source: "zodiac", factor: "水星逆行", effect: "caution", weight: 0.15 }
   108→      best_for: ["谈判", "社交", "表达"]
   109→      avoid: ["签约", "重大决策"]
   110→      advice: "今天适合沟通和表达，但重要文件建议延后签署"
   111→      updated_at: "2026-01-23T08:00:00Z"
   112→
   113→    windows:           # 未来时机窗口（月度更新）
   114→      - period: "2026-01-25 ~ 2026-01-28"
   115→        quality: "best"
   116→        score: 92
   117→        theme: "谈判黄金期"
   118→        best_for: ["薪资谈判", "商务洽谈"]
   119→        sources: ["bazi", "zodiac"]
   120→      - period: "2026-02-03"
   121→        quality: "good"
   122→        score: 85
   123→        theme: "贵人日"
   124→        best_for: ["networking", "求助"]
   125→        sources: ["bazi"]
   126→      - period: "2026-02-05 ~ 2026-02-20"
   127→        quality: "caution"
   128→        score: 45
   129→        theme: "水星逆行期"
   130→        avoid: ["签署合同", "启动新项目"]
   131→        sources: ["zodiac"]
   132→
   133→    decisions:         # 进行中的决策追踪
   134→      - id: "dec_001"
   135→        type: "career"           # career | life | relationship
   136→        title: "要不要接 A 公司 offer"
   137→        status: "analyzing"      # analyzing | pending | decided | completed
   138→        deadline: "2026-02-01"
   139→        options:
   140→          - label: "接受"
   141→            timing_fit: 72
   142→            pros: ["薪资涨幅大", "技术栈匹配"]
   143→            cons: ["加班文化"]
   144→          - label: "拒绝"
   145→            timing_fit: null
   146→            pros: ["保持稳定"]
   147→            cons: ["错过机会"]
   148→          - label: "谈判"
   149→            timing_fit: 85
   150→            pros: ["可能获得更好条件"]
   151→            cons: ["需要技巧"]
   152→        collected_factors:
   153→          - { category: "薪资", value: "涨幅 30%", weight: 0.3, sentiment: "positive" }
   154→          - { category: "团队", value: "技术氛围好", weight: 0.2, sentiment: "positive" }
   155→          - { category: "通勤", value: "需要 1.5 小时", weight: 0.15, sentiment: "negative" }
   156→        pending_factors: ["时机分析", "长期发展评估"]
   157→        recommended_action: "谈判"
   158→        recommended_window: "2026-01-25 ~ 2026-01-28"
   159→        created_at: "2026-01-20T10:00:00Z"
   160→        updated_at: "2026-01-23T10:00:00Z"
   161→
   162→    milestones:        # 人生节点里程碑
   163→      - id: "ms_001"
   164→        type: "buy_house"        # buy_house | marriage | startup | baby | career_change
   165→        title: "2026 年买房"
   166→        status: "preparing"      # planning | preparing | executing | achieved
   167→        target_period: "2026-Q2"
   168→        timing_analysis:
   169→          overall_fit: 78
   170→          best_windows: ["2026-03 ~ 2026-05"]
   171→          caution_periods: ["2026-07 ~ 2026-08"]
   172→          advice: "上半年运势利于置业，建议抓住春季窗口"
   173→          sources: ["bazi", "zodiac"]
   174→        tasks:
   175→          - { id: "t1", title: "确定预算范围", status: "done", completed_at: "2026-01-15" }
   176→          - { id: "t2", title: "准备首付", status: "in_progress", progress: 60 }
   177→          - { id: "t3", title: "开始看房", status: "pending" }
   178→          - { id: "t4", title: "签约过户", status: "pending" }
   179→        checkins:
   180→          - { date: "2026-01-19", note: "确定了预算范围 200-250 万", mood: "confident" }
   181→          - { date: "2026-01-12", note: "和家人讨论了区域偏好", mood: "neutral" }
   182→        created_at: "2026-01-10T10:00:00Z"
   183→        updated_at: "2026-01-19T10:00:00Z"
   184→
   185→  # ═══════════════════════════════════════════════════════════════
   186→  # 4. relationship - 我与他人（关系经营的核心支撑）
   187→  # ═══════════════════════════════════════════════════════════════
   188→  relationship:
   189→    partners:          # 关系对象
   190→      - id: "rel_001"
   191→        name: "小明"
   192→        type: "romantic"         # romantic | spouse | family | friend | business
   193→        is_primary: true         # 是否主要伴侣
   194→        birth_info:              # 用于合盘计算
   195→          birth_date: "1992-05-15"
   196→          birth_time: "14:30"
   197→          birth_place: "上海"
   198→          gender: "male"
   199→
   200→        harmony:                 # 融合后的关系洞察（多 Skill 贡献）
   201→          overall: 78
   202→          dimensions:
   203→            - { name: "情感共鸣", score: 85, source: "zodiac", detail: "月亮合相带来深度情感连接" }
   204→            - { name: "价值观契合", score: 72, source: "bazi", detail: "日主相生，目标一致" }
   205→            - { name: "沟通模式", score: 68, source: "psych", detail: "一个理性一个感性，需要调适" }
   206→            - { name: "生活节奏", score: 75, source: "zodiac", detail: "火象与风象配合良好" }
   207→          strengths:
   208→            - "深度情感连接"
   209→            - "共同成长愿望"
   210→            - "互补的能力"
   211→          challenges:
   212→            - "沟通节奏差异"
   213→            - "表达方式不同"
   214→            - "处理冲突方式不一致"
   215→          growth_advice: "学习对方的沟通语言，建立定期深度对话的习惯"
   216→          updated_at: "2026-01-22T10:00:00Z"
   217→
   218→        daily_weather:           # 每日关系天气（Proactive 更新）
   219→          mood: "晴"             # 晴 | 多云 | 阴 | 雨
   220→          score: 82
   221→          factors:
   222→            - { factor: "金星三分月亮", effect: "positive", desc: "情感交流顺畅" }
   223→            - { factor: "火星刑土星", effect: "caution", desc: "避免争执" }
   224→          today_advice: "适合深度交流，分享内心想法"
   225→          communication_tip: "TA 今天情感需求增强，主动表达关心会让 TA 感到被重视"
   226→          avoid: "讨论敏感财务话题"
   227→          activity_suggestion: "一起看一部温馨的电影"
   228→          updated_at: "2026-01-23T08:00:00Z"
   229→
   230→        suggestions:             # 互动建议缓存
   231→          - type: "daily"
   232→            content: "发一条关心的消息"
   233→            reason: "今天 TA 工作压力大"
   234→            expires_at: "2026-01-23T23:59:59Z"
   235→          - type: "event"
   236→            content: "情人节快到了，准备惊喜"
   237→            event_date: "2026-02-14"
   238→            lead_days: 7
   239→
   240→        created_at: "2026-01-15T10:00:00Z"
   241→        last_synastry_at: "2026-01-22T10:00:00Z"
   242→
   243→    interaction_patterns:        # 互动模式（Psych Skill 贡献）
   244→      communication_style: "理性分析型"
   245→      attachment_style: "secure"
   246→      conflict_pattern: "回避-追逐"
   247→      attachment_dynamic: "secure-anxious"
   248→      strengths: ["善于倾听", "尊重边界"]
   249→      growth_areas: ["表达脆弱", "主动关心"]
   250→      updated_at: "2026-01-20T10:00:00Z"
   251→
   252→  # ═══════════════════════════════════════════════════════════════
   253→  # 5. timeline - 时间线视图（跨场景的时间轴汇聚）
   254→  # ═══════════════════════════════════════════════════════════════
   255→  timeline:
   256→    - period: "2026-Q1"
   257→      events:
   258→        - type: "timing_window"
   259→          title: "谈判黄金期"
   260→          date_range: "2026-01-25 ~ 2026-01-28"
   261→          quality: "best"
   262→          source: "bazi+zodiac"
   263→          related_decision: "dec_001"
   264→        - type: "milestone_task"
   265→          title: "准备首付"
   266→          milestone_id: "ms_001"
   267→          deadline: "2026-02-28"
   268→        - type: "relationship"
   269→          title: "情人节"
   270→          partner_id: "rel_001"
   271→          date: "2026-02-14"
   272→        - type: "caution"
   273→          title: "水星逆行"
   274→          date_range: "2026-02-05 ~ 2026-02-20"
   275→          source: "zodiac"
   276→
   277→    - period: "2026-Q2"
   278→      events:
   279→        - type: "timing_window"
   280→          title: "买房最佳执行期"
   281→          date_range: "2026-03 ~ 2026-05"
   282→          quality: "best"
   283→          source: "bazi"
   284→          related_milestone: "ms_001"
   285→        - type: "milestone"
   286→          title: "完成买房"
   287→          milestone_id: "ms_001"
   288→          target_date: "2026-05"
   289→        - type: "goal"
   290→          title: "副业项目上线"
   291→          goal_id: "goal_001"
   292→          deadline: "2026-03-01"
   293→```
   294→
   295→## 四、数据流设计
   296→
   297→```
   298→┌─────────────────────────────────────────────────────────────────────────────┐
   299→│                        vibe 层数据流                                         │
   300→├─────────────────────────────────────────────────────────────────────────────┤
   301→│                                                                             │
   302→│   ┌─────────────────────────────────────────────────────────────────────┐   │
   303→│   │                        写入来源 (Skills)                             │   │
   304→│   ├─────────────────────────────────────────────────────────────────────┤   │
   305→│   │                                                                     │   │
   306→│   │   skills.bazi.chart ──────┐                                         │   │
   307→│   │   skills.zodiac.chart ─────┼──▶ vibe.insight.essence               │   │
   308→│   │   skills.jungastro ────────┘    (archetype, traits)                │   │
   309→│   │                                                                     │   │
   310→│   │   skills.psych.assessment ────▶ vibe.insight.psyche                │   │
   311→│   │   skills.psych.shadow ────────▶ vibe.insight.essence.shadow        │   │
   312→│   │                                                                     │   │
   313→│   │   skills.lifecoach.north_star ──▶ vibe.target.north_star           │   │
   314→│   │   skills.lifecoach.goals ───────▶ vibe.target.goals                │   │
   315→│   │                                                                     │   │
   316→│   │   skills.bazi.dayun ──────┐                                         │   │
   317→│   │   skills.zodiac.transit ───┼──▶ vibe.timing.current_window         │   │
   318→│   │   skills.bazi.liunian ─────┼──▶ vibe.timing.windows                │   │
   319→│   │                            │                                        │   │
   320→│   │   [工具调用] ──────────────┼──▶ vibe.timing.decisions              │   │
   321→│   │   [工具调用] ──────────────┘──▶ vibe.timing.milestones             │   │
   322→│   │                                                                     │   │
   323→│   │   skills.synastry ────────┐                                         │   │
   324→│   │   skills.psych.rel ────────┼──▶ vibe.relationship.partners[].harmony│  │
   325→│   │   [Proactive] ─────────────┼──▶ vibe.relationship.daily_weather    │   │
   326→│   │   skills.psych ────────────┘──▶ vibe.relationship.interaction_patterns│ │
   327→│   │                                                                     │   │
   328→│   │   [自动汇聚] ──────────────────▶ vibe.timeline                      │   │
   329→│   │                                                                     │   │
   330→│   └─────────────────────────────────────────────────────────────────────┘   │
   331→│                                                                             │
   332→│   ┌─────────────────────────────────────────────────────────────────────┐   │
   333→│   │                        读取消费者 (Skills)                           │   │
   334→│   ├─────────────────────────────────────────────────────────────────────┤   │
   335→│   │                                                                     │   │
   336→│   │   vibe.insight ──────▶ 所有 Skill（了解用户本质）                    │   │
   337→│   │   vibe.target ───────▶ lifecoach, career（目标对齐）                │   │
   338→│   │   vibe.timing ───────▶ career, lifecoach（时机决策）                │   │
   339→│   │   vibe.relationship ─▶ synastry, psych, lifecoach（关系洞察）        │   │
   340→│   │   vibe.timeline ─────▶ 所有 Skill（时间规划）                        │   │
   341→│   │                                                                     │   │
   342→│   └─────────────────────────────────────────────────────────────────────┘   │
   343→│                                                                             │
   344→└─────────────────────────────────────────────────────────────────────────────┘
   345→```
   346→
   347→## 五、API 设计
   348→
   349→### 5.1 insight 操作
   350→
   351→```python
   352→class UnifiedProfileRepository:
   353→    # 原型更新（多来源融合）
   354→    async def update_vibe_archetype(
   355→        user_id: UUID,
   356→        archetype_data: Dict,
   357→        source_skill: str
   358→    ) -> None:
   359→        """
   360→        更新人格原型（支持多来源）
   361→
   362→        Args:
   363→            user_id: 用户 ID
   364→            archetype_data: { "primary": "成长者", "value": "甲木" }
   365→            source_skill: "bazi" | "zodiac" | "jungastro"
   366→        """
   367→
   368→    # 心理画像更新
   369→    async def update_vibe_psyche(
   370→        user_id: UUID,
   371→        psyche_data: Dict
   372→    ) -> None:
   373→        """
   374→        更新心理画像（Psych Skill 专用）
   375→
   376→        Args:
   377→            psyche_data: {
   378→                "dominant_functions": ["Ni", "Te"],
   379→                "attachment_style": "secure",
   380→                ...
   381→            }
   382→        """
   383→
   384→    # 阴影更新
   385→    async def update_vibe_shadow(
   386→        user_id: UUID,
   387→        shadow_data: Dict
   388→    ) -> None
   389→
   390→    # 获取融合后的本质
   391→    async def get_vibe_essence(user_id: UUID) -> Dict:
   392→        """返回融合后的 insight.essence"""
   393→```
   394→
   395→### 5.2 timing 操作
   396→
   397→```python
   398→class UnifiedProfileRepository:
   399→    # ═══════════════════════════════════════════════════════════════
   400→    # 时机窗口
   401→    # ═══════════════════════════════════════════════════════════════
   402→    async def update_timing_window(
   403→        user_id: UUID,
   404→        window_data: Dict
   405→    ) -> None:
   406→        """每日更新当前时机窗口（由 Proactive 调用）"""
   407→
   408→    async def get_current_timing(user_id: UUID) -> Dict:
   409→        """获取当前时机窗口"""
   410→
   411→    async def update_timing_windows(
   412→        user_id: UUID,
   413→        windows: List[Dict]
   414→    ) -> None:
   415→        """更新未来时机窗口列表（月度更新）"""
   416→
   417→    # ═══════════════════════════════════════════════════════════════
   418→    # 决策追踪
   419→    # ═══════════════════════════════════════════════════════════════
   420→    async def add_decision(
   421→        user_id: UUID,
   422→        decision: Dict
   423→    ) -> str:
   424→        """
   425→        创建决策追踪
   426→
   427→        Args:
   428→            decision: {
   429→                "type": "career",
   430→                "title": "要不要接 A 公司 offer",
   431→                "deadline": "2026-02-01",
   432→                "options": [...]
   433→            }
   434→
   435→        Returns:
   436→            decision_id
   437→        """
   438→
   439→    async def update_decision(
   440→        user_id: UUID,
   441→        decision_id: str,
   442→        updates: Dict
   443→    ) -> bool:
   444→        """
   445→        更新决策（添加因素、更新状态等）
   446→
   447→        Args:
   448→            updates: {
   449→                "collected_factors": [...],  # 追加
   450→                "status": "pending",
   451→                "recommended_action": "谈判"
   452→            }
   453→        """
   454→
   455→    async def get_active_decisions(user_id: UUID) -> List[Dict]:
   456→        """获取进行中的决策"""
   457→
   458→    async def complete_decision(
   459→        user_id: UUID,
   460→        decision_id: str,
   461→        outcome: Dict
   462→    ) -> bool:
   463→        """
   464→        完成决策
   465→
   466→        Args:
   467→            outcome: {
   468→                "chosen_option": "谈判",
   469→                "result": "成功加薪 10%",
   470→                "reflection": "..."
   471→            }
   472→        """
   473→
   474→    # ═══════════════════════════════════════════════════════════════
   475→    # 里程碑追踪
   476→    # ═══════════════════════════════════════════════════════════════
   477→    async def add_milestone(
   478→        user_id: UUID,
   479→        milestone: Dict
   480→    ) -> str:
   481→        """
   482→        创建里程碑
   483→
   484→        Args:
   485→            milestone: {
   486→                "type": "buy_house",
   487→                "title": "2026 年买房",
   488→                "target_period": "2026-Q2"
   489→            }
   490→
   491→        Returns:
   492→            milestone_id
   493→        """
   494→
   495→    async def update_milestone(
   496→        user_id: UUID,
   497→        milestone_id: str,
   498→        updates: Dict
   499→    ) -> bool
   500→
   501→    async def add_milestone_task(
   502→        user_id: UUID,
   503→        milestone_id: str,
   504→        task: Dict
   505→    ) -> str:
   506→        """添加里程碑任务"""
   507→
   508→    async def update_milestone_task(
   509→        user_id: UUID,
   510→        milestone_id: str,
   511→        task_id: str,
   512→        updates: Dict
   513→    ) -> bool
   514→
   515→    async def add_milestone_checkin(
   516→        user_id: UUID,
   517→        milestone_id: str,
   518→        checkin: Dict
   519→    ) -> bool:
   520→        """
   521→        添加里程碑 check-in
   522→
   523→        Args:
   524→            checkin: {
   525→                "note": "确定了预算范围",
   526→                "mood": "confident"
   527→            }
   528→        """
   529→
   530→    async def get_active_milestones(user_id: UUID) -> List[Dict]:
   531→        """获取进行中的里程碑"""
   532→```
   533→
   534→### 5.3 relationship 操作
   535→
   536→```python
   537→class UnifiedProfileRepository:
   538→    # ═══════════════════════════════════════════════════════════════
   539→    # 关系对象管理
   540→    # ═══════════════════════════════════════════════════════════════
   541→    async def add_partner(
   542→        user_id: UUID,
   543→        partner_data: Dict
   544→    ) -> str:
   545→        """
   546→        添加关系对象
   547→
   548→        Args:
   549→            partner_data: {
   550→                "name": "小明",
   551→                "type": "romantic",
   552→                "birth_info": {...},
   553→                "is_primary": true
   554→            }
   555→
   556→        Returns:
   557→            partner_id
   558→        """
   559→
   560→    async def update_partner(
   561→        user_id: UUID,
   562→        partner_id: str,
   563→        updates: Dict
   564→    ) -> bool
   565→
   566→    async def delete_partner(
   567→        user_id: UUID,
   568→        partner_id: str
   569→    ) -> bool
   570→
   571→    async def get_partners(user_id: UUID) -> List[Dict]
   572→
   573→    async def get_primary_partner(user_id: UUID) -> Optional[Dict]
   574→
   575→    # ═══════════════════════════════════════════════════════════════
   576→    # 关系洞察更新
   577→    # ═══════════════════════════════════════════════════════════════
   578→    async def update_partner_harmony(
   579→        user_id: UUID,
   580→        partner_id: str,
   581→        harmony_data: Dict,
   582→        source_skill: str
   583→    ) -> None:
   584→        """
   585→        更新关系和谐度（多来源融合）
   586→
   587→        Args:
   588→            harmony_data: {
   589→                "dimension": "情感共鸣",
   590→                "score": 85,
   591→                "detail": "月亮合相带来深度情感连接"
   592→            }
   593→            source_skill: "zodiac" | "bazi" | "psych"
   594→        """
   595→
   596→    async def update_daily_weather(
   597→        user_id: UUID,
   598→        partner_id: str,
   599→        weather_data: Dict
   600→    ) -> None:
   601→        """
   602→        更新每日关系天气（Proactive 调用）
   603→
   604→        Args:
   605→            weather_data: {
   606→                "mood": "晴",
   607→                "score": 82,
   608→                "today_advice": "...",
   609→                "communication_tip": "...",
   610→                ...
   611→            }
   612→        """
   613→
   614→    async def get_partner_weather(
   615→        user_id: UUID,
   616→        partner_id: str
   617→    ) -> Optional[Dict]:
   618→        """获取今日关系天气"""
   619→
   620→    async def add_partner_suggestion(
   621→        user_id: UUID,
   622→        partner_id: str,
   623→        suggestion: Dict
   624→    ) -> None:
   625→        """
   626→        添加互动建议
   627→
   628→        Args:
   629→            suggestion: {
   630→                "type": "daily" | "event",
   631→                "content": "...",
   632→                "reason": "...",
   633→                "expires_at": "..." | "event_date": "..."
   634→            }
   635→        """
   636→
   637→    # ═══════════════════════════════════════════════════════════════
   638→    # 互动模式更新
   639→    # ═══════════════════════════════════════════════════════════════
   640→    async def update_interaction_patterns(
   641→        user_id: UUID,
   642→        patterns: Dict
   643→    ) -> None:
   644→        """
   645→        更新互动模式（Psych Skill 调用）
   646→
   647→        Args:
   648→            patterns: {
   649→                "communication_style": "理性分析型",
   650→                "conflict_pattern": "回避-追逐",
   651→                ...
   652→            }
   653→        """
   654→```
   655→
   656→### 5.4 timeline 操作
   657→
   658→```python
   659→class UnifiedProfileRepository:
   660→    async def rebuild_timeline(
   661→        user_id: UUID,
   662→        year: int = None
   663→    ) -> None:
   664→        """
   665→        重建时间线（汇聚所有时间相关数据）
   666→
   667→        自动汇聚来源：
   668→        - vibe.timing.windows
   669→        - vibe.timing.milestones
   670→        - vibe.timing.decisions
   671→        - vibe.relationship.partners[].suggestions[type=event]
   672→        - vibe.target.goals[deadline]
   673→        """
   674→
   675→    async def get_timeline(
   676→        user_id: UUID,
   677→        start_period: str,
   678→        end_period: str
   679→    ) -> List[Dict]:
   680→        """
   681→        获取时间线事件
   682→
   683→        Args:
   684→            start_period: "2026-Q1" | "2026-01"
   685→            end_period: "2026-Q4" | "2026-12"
   686→        """
   687→```
   688→
   689→## 六、同步配置 (vibe_sync.yaml)
   690→
   691→```yaml
   692→version: "2.0"
   693→
   694→# ═══════════════════════════════════════════════════════════════
   695→# insight 同步规则
   696→# ═══════════════════════════════════════════════════════════════
   697→insight:
   698→  essence:
   699→    archetype:
   700→      merge_strategy: priority_first  # 按优先级取第一个有值的
   701→      sources:
   702→        - skill: bazi
   703→          path: chart.day_master
   704→          priority: 1
   705→          transform: element_to_archetype
   706→        - skill: zodiac
   707→          path: chart.sun_sign
   708→          priority: 2
   709→          transform: sign_to_archetype
   710→        - skill: jungastro
   711→          path: analysis.archetype
   712→          priority: 3
   713→          transform: direct
   714→
   715→    traits:
   716→      merge_strategy: append_unique_weighted  # 按权重去重合并
   717→      max_items: 5
   718→      sources:
   719→        - skill: bazi
   720→          path: chart.day_master
   721→          weight: 0.4
   722→          transform: extract_bazi_traits
   723→        - skill: zodiac
   724→          path: chart.sun_sign
   725→          weight: 0.3
   726→          transform: extract_zodiac_traits
   727→        - skill: psych
   728→          path: assessment.traits
   729→          weight: 0.3
   730→          transform: direct
   731→
   732→    shadow:
   733→      sources:
   734→        - skill: psych
   735→          path: shadow.patterns
   736→          transform: direct
   737→
   738→  psyche:
   739→    sources:
   740→      - skill: psych
   741→        path: assessment
   742→        fields:
   743→          - dominant_functions
   744→          - attachment_style
   745→          - coping_patterns
   746→          - growth_areas
   747→      - skill: jungastro
   748→        path: psychological_functions
   749→        merge_into: dominant_functions
   750→
   751→# ═══════════════════════════════════════════════════════════════
   752→# timing 同步规则
   753→# ═══════════════════════════════════════════════════════════════
   754→timing:
   755→  current_window:
   756→    refresh: daily
   757→    sources:
   758→      - skill: bazi
   759→        path: liunian.daily
   760→        transform: extract_bazi_timing
   761→      - skill: zodiac
   762→        path: transits.today
   763→        transform: extract_zodiac_timing
   764→    merge_strategy: combine_factors
   765→
   766→  windows:
   767→    refresh: monthly
   768→    sources:
   769→      - skill: bazi
   770→        path: liunian.months
   771→        transform: extract_bazi_windows
   772→      - skill: zodiac
   773→        path: transits.upcoming
   774→        transform: extract_zodiac_windows
   775→    merge_strategy: merge_overlapping
   776→
   777→# ═══════════════════════════════════════════════════════════════
   778→# relationship 同步规则
   779→# ═══════════════════════════════════════════════════════════════
   780→relationship:
   781→  harmony:
   782→    sources:
   783→      - skill: synastry
   784→        path: zodiac
   785→        transform: extract_zodiac_harmony
   786→      - skill: synastry
   787→        path: bazi
   788→        transform: extract_bazi_harmony
   789→      - skill: psych
   790→        path: relationship_analysis
   791→        transform: extract_psych_harmony
   792→    merge_strategy: weighted_average
   793→    weights:
   794→      zodiac: 0.4
   795→      bazi: 0.4
   796→      psych: 0.2
   797→
   798→  daily_weather:
   799→    refresh: daily
   800→    requires:
   801→      - synastry.zodiac  # 需要有星座合盘数据
   802→    sources:
   803→      - skill: zodiac
   804→        path: transits.today
   805→        transform: generate_relationship_weather
   806→
   807→# ═══════════════════════════════════════════════════════════════
   808→# timeline 同步规则
   809→# ═══════════════════════════════════════════════════════════════
   810→timeline:
   811→  auto_rebuild: true  # 相关数据变化时自动重建
   812→  sources:
   813→    - vibe.timing.windows
   814→    - vibe.timing.milestones
   815→    - vibe.timing.decisions
   816→    - vibe.relationship.partners[].suggestions[type=event]
   817→    - vibe.target.goals[deadline]
   818→```
   819→
   820→## 七、场景支撑映射
   821→
   822→| 场景 | vibe 字段 | 数据来源 | 消费者 |
   823→|------|-----------|----------|--------|
   824→| **职场时机** | `timing.current_window` | bazi, zodiac | career, lifecoach |
   825→| **职场时机** | `timing.windows` | bazi, zodiac | career, lifecoach |
   826→| **职场时机** | `timing.decisions` | 工具调用 | career, lifecoach |
   827→| **关系经营** | `relationship.partners[].harmony` | synastry, psych | synastry, lifecoach |
   828→| **关系经营** | `relationship.daily_weather` | Proactive | synastry, core |
   829→| **关系经营** | `relationship.interaction_patterns` | psych | synastry, lifecoach |
   830→| **人生节点** | `timing.milestones` | 工具调用 | lifecoach |
   831→| **人生节点** | `timeline` | 自动汇聚 | 所有 Skill |
   832→| **心理探索** | `insight.psyche` | psych | 所有 Skill |
   833→| **心理探索** | `insight.essence.shadow` | psych | lifecoach, psych |
   834→| **全局共享** | `insight.essence` | bazi, zodiac, psych | 所有 Skill |
   835→| **全局共享** | `target` | lifecoach | 所有 Skill |
   836→
   837→## 八、迁移计划
   838→
   839→### 8.1 数据迁移
   840→
   841→```sql
   842→-- 从旧结构迁移到新结构
   843→UPDATE unified_profiles
   844→SET profile = jsonb_set(
   845→    profile,
   846→    '{vibe}',
   847→    jsonb_build_object(
   848→        'insight', COALESCE(profile->'vibe'->'insight', '{}'::jsonb),
   849→        'target', COALESCE(profile->'vibe'->'target', '{}'::jsonb),
   850→        'timing', '{}'::jsonb,
   851→        'relationship', jsonb_build_object(
   852→            'partners', COALESCE(profile->'relationships', '[]'::jsonb),
   853→            'interaction_patterns', '{}'::jsonb
   854→        ),
   855→        'timeline', '[]'::jsonb
   856→    )
   857→)
   858→WHERE profile->'vibe' IS NOT NULL;
   859→
   860→-- 删除旧的 relationships 字段
   861→UPDATE unified_profiles
   862→SET profile = profile - 'relationships'
   863→WHERE profile->'relationships' IS NOT NULL;
   864→```
   865→
   866→### 8.2 API 兼容
   867→
   868→```python
   869→# 保留旧 API 作为别名
   870→async def get_relationships(user_id: UUID) -> List[Dict]:
   871→    """[DEPRECATED] 使用 get_partners() 替代"""
   872→    return await get_partners(user_id)
   873→
   874→async def add_relationship(user_id: UUID, data: Dict) -> str:
   875→    """[DEPRECATED] 使用 add_partner() 替代"""
   876→    return await add_partner(user_id, data)
   877→```
   878→
   879→## 九、版本历史
   880→
   881→| 版本 | 日期 | 变更 |
   882→|------|------|------|
   883→| v12 | 2026-01-23 | 重新设计 vibe 层，新增 timing、relationship、timeline |
   884→| v11 | 2026-01-15 | 新增 vibe_sync.yaml 配置驱动同步 |
   885→| v10 | 2026-01-10 | 新增 relationship 支持合盘 |
   886→| v9 | 2026-01-05 | 三层架构：identity + skills + vibe |
   887→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
