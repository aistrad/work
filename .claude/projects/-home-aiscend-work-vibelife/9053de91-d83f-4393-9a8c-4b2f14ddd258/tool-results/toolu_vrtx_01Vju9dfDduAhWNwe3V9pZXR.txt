     1→"""
     2→Unified Profile Repository - 统一 Profile 数据访问层
     3→
     4→基于 unified_profiles 表，提供统一的 Profile 访问接口。
     5→使用 jsonb_set() 进行局部更新，避免重写整个 profile。
     6→
     7→v7.7 重构：添加 account 和 state 字段
     8→- account: 从 vibe_users 同步 (vibe_id, display_name, tier, status)
     9→- state: 用户当前状态 (focus)
    10→
    11→v7.6 重构：整合以下功能到统一 Profile:
    12→- Skill 订阅管理 (原 user_skill_subscriptions)
    13→- 推送偏好 (原 user_push_preferences)
    14→- 生活上下文 (原 user_data_store)
    15→- Skill 推荐屏蔽 (原 skill_recommendation_blocks)
    16→
    17→Profile 结构:
    18→{
    19→    "account": {
    20→        "vibe_id": "VB-A1B2C3D4",
    21→        "display_name": "用户昵称",
    22→        "tier": "free",
    23→        "status": "active"
    24→    },
    25→    "birth_info": {...},
    26→    "state": {
    27→        "focus": ["career", "health"],
    28→        "updated_at": "2026-01-19T10:00:00Z"
    29→    },
    30→    "life_context": {...},
    31→    "preferences": {
    32→        "voice_mode": "warm",
    33→        "language": "zh-CN",
    34→        "timezone": "Asia/Shanghai",
    35→        "subscribed_skills": {
    36→            "bazi": {"status": "subscribed", "push_enabled": true, ...},
    37→            ...
    38→        },
    39→        "push_settings": {
    40→            "default_push_hour": 8,
    41→            "max_daily_pushes": 5,
    42→            "quiet_start_hour": 22,
    43→            "quiet_end_hour": 7
    44→        },
    45→        "blocked_skills": ["skill_id_1", ...]
    46→    },
    47→    "skill_data": {...},
    48→    "extracted": {...}
    49→}
    50→"""
    51→import json
    52→import logging
    53→from dataclasses import dataclass
    54→from datetime import datetime, date
    55→from typing import Optional, Dict, Any, List
    56→from uuid import UUID
    57→
    58→from .db import get_connection, fetch, fetchrow, fetchval, execute
    59→
    60→logger = logging.getLogger(__name__)
    61→
    62→
    63→# ═══════════════════════════════════════════════════════════════════════════
    64→# Data Classes
    65→# ═══════════════════════════════════════════════════════════════════════════
    66→
    67→@dataclass
    68→class SkillSubscription:
    69→    """Skill 订阅数据类 (兼容旧接口)"""
    70→    skill_id: str
    71→    status: str  # subscribed | unsubscribed | not_subscribed
    72→    push_enabled: bool
    73→    subscribed_at: Optional[datetime]
    74→    unsubscribed_at: Optional[datetime]
    75→    trial_messages_used: int
    76→
    77→    def to_dict(self) -> Dict[str, Any]:
    78→        return {
    79→            "skill_id": self.skill_id,
    80→            "status": self.status,
    81→            "push_enabled": self.push_enabled,
    82→            "subscribed_at": self.subscribed_at.isoformat() if self.subscribed_at else None,
    83→            "unsubscribed_at": self.unsubscribed_at.isoformat() if self.unsubscribed_at else None,
    84→            "trial_messages_used": self.trial_messages_used,
    85→        }
    86→
    87→
    88→@dataclass
    89→class UserPushPreferences:
    90→    """用户推送偏好 (兼容旧接口)"""
    91→    user_id: UUID
    92→    default_push_hour: int = 8
    93→    max_daily_pushes: int = 5
    94→    quiet_start_hour: int = 22
    95→    quiet_end_hour: int = 7
    96→
    97→    def to_dict(self) -> Dict[str, Any]:
    98→        return {
    99→            "user_id": str(self.user_id),
   100→            "default_push_hour": self.default_push_hour,

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
