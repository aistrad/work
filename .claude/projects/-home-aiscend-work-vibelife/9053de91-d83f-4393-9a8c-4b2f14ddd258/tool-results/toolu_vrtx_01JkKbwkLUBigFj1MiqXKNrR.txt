The file /home/aiscend/work/vibelife/apps/api/services/agent/global_handlers.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   245→        "relationshipType": relationship_type,
   246→    }
   247→
   248→
   249→@tool_handler("recommend_skill")
   250→async def execute_recommend_skill(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   251→    """
   252→    推荐 Skill 给用户
   253→
   254→    当 LLM 判断用户可能对某个未订阅的 Skill 感兴趣时调用此工具。
   255→    前端收到此卡片后会显示推荐卡片，用户可以选择试用或了解更多。
   256→
   257→    Args:
   258→        skill_id: 推荐的 Skill ID
   259→        reason: 推荐原因（基于对话内容生成）
   260→        confidence: 推荐置信度 (high/medium/low)
   261→
   262→    Returns:
   263→        skill_recommendation 卡片数据
   264→    """
   265→    from .skill_loader import load_skill_metadata
   266→
   267→    skill_id = args.get("skill_id")
   268→    reason = args.get("reason", "")
   269→    confidence = args.get("confidence", "medium")
   270→
   271→    if not skill_id:
   272→        return {"status": "error", "error": "skill_id is required"}
   273→
   274→    # 加载 Skill 元数据
   275→    metadata = load_skill_metadata(skill_id)
   276→    if not metadata:
   277→        return {"status": "error", "error": f"Skill not found: {skill_id}"}
   278→
   279→    # 检查用户是否已订阅（如果已订阅则不推荐）
   280→    user_id = context.user_id
   281→    if user_id and user_id != "guest":
   282→        try:
   283→            from uuid import UUID
   284→            # v7.6: 使用 UnifiedProfileRepository
   285→            from stores.unified_profile_repo import UnifiedProfileRepository
   286→
   287→            user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
   288→            subscription = await UnifiedProfileRepository.get_skill_subscription(user_uuid, skill_id)
   289→
   290→            if subscription and subscription.status == "subscribed":
   291→                # 用户已订阅，不需要推荐
   292→                return {
   293→                    "status": "skip",
   294→                    "reason": "already_subscribed",
   295→                    "skill_id": skill_id,
   296→                }
   297→        except Exception as e:
   298→            logger.warning(f"Failed to check subscription for {skill_id}: {e}")
   299→
   300→    # 返回推荐卡片数据
   301→    return {
   302→        "status": "success",
   303→        "cardType": "skill_recommendation",
   304→        "skill_id": skill_id,
   305→        "skill": {
   306→            "id": metadata.id,
   307→            "name": metadata.name,
   308→            "description": metadata.description,
   309→            "icon": metadata.icon,
   310→            "color": metadata.color,
   311→            "tagline": metadata.showcase.tagline,
   312→            "trial_messages": metadata.pricing.trial_messages,
   313→        },
   314→        "reason": reason,
   315→        "confidence": confidence,
   316→    }
   317→
   318→
   319→# ============================================================================
   320→# 通用数据工具 - REFACTOR_PLAN.md Phase 1
   321→# ============================================================================
   322→
   323→@tool_handler("read_state")
   324→async def execute_read_state(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   325→    """
   326→    通用状态读取 - 自动使用当前 skill_id
   327→
   328→    按照 REFACTOR_PLAN.md 设计，所有 Skill 共享此工具。
   329→    LLM 不需要传 skill_id，从 context 自动获取。
   330→
   331→    Args:
   332→        sections: 可选，指定要读取的部分
   333→
   334→    示例：
   335→        read_state({})  # 读取全部
   336→        read_state({"sections": ["north_star", "goals"]})  # 只读取指定部分
   337→    """
   338→    from stores.unified_profile_repo import UnifiedProfileRepository
   339→    from uuid import UUID
   340→
   341→    skill_id = context.skill_id
   342→    if not skill_id:
   343→        return {
   344→            "status": "error",
   345→            "message": "No active skill"
   346→        }
   347→
   348→    sections = args.get("sections")
   349→
   350→    # 读取 skill 状态
   351→    user_uuid = UUID(context.user_id) if isinstance(context.user_id, str) else context.user_id
   352→    data = await UnifiedProfileRepository.get_skill_state(
   353→        user_uuid,
   354→        skill_id
   355→    )
   356→
   357→    if not data:
   358→        return {
   359→            "status": "empty",
   360→            "message": f"尚未建立 {skill_id} 数据",
   361→            "data": {}
   362→        }
   363→
   364→    # 过滤指定部分
   365→    if sections:
   366→        result = {k: v for k, v in data.items() if k in sections}
   367→    else:
   368→        result = data
   369→
   370→    return {
   371→        "status": "success",
   372→        "data": result,
   373→        "skill_id": skill_id
   374→    }
   375→
   376→
   377→@tool_handler("write_state")
   378→async def execute_write_state(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   379→    """
   380→    通用状态写入 - 自动使用当前 skill_id
   381→
   382→    支持深度合并，不会覆盖未指定的字段
   383→
   384→    Args:
   385→        section: 要写入的部分，如 "north_star" 或 "protocol"
   386→        data: 要写入的数据
   387→
   388→    示例:
   389→        write_state({
   390→            "section": "north_star",
   391→            "data": {"vision": "通过创作实现财务自由"}
   392→        })
   393→    """
   394→    from stores.unified_profile_repo import UnifiedProfileRepository
   395→    from uuid import UUID
   396→
   397→    skill_id = context.skill_id
   398→    if not skill_id:
   399→        return {
   400→            "status": "error",
   401→            "message": "No active skill"
   402→        }
   403→
   404→    section = args.get("section")
   405→    data = args.get("data")
   406→
   407→    if not section or not data:
   408→        return {
   409→            "status": "error",
   410→            "message": "Missing section or data"
   411→        }
   412→
   413→    # 写入状态
   414→    user_uuid = UUID(context.user_id) if isinstance(context.user_id, str) else context.user_id
   415→    await UnifiedProfileRepository.update_skill_state(
   416→        user_uuid,
   417→        skill_id,
   418→        section,
   419→        data
   420→    )
   421→
   422→    return {
   423→        "status": "success",
   424→        "message": f"已保存 {section}",
   425→        "skill_id": skill_id,
   426→        "section": section
   427→    }
   428→
   429→
   430→@tool_handler("append_to_list")
   431→async def execute_append_to_list(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   432→    """
   433→    向列表追加条目
   434→
   435→    用于日志、记录等场景。
   436→    自动添加 _created_at 时间戳。
   437→
   438→    Args:
   439→        path: 列表路径，如 "journal" 或 "progress.milestones"
   440→        entry: 要追加的条目
   441→        max_items: 列表最大长度（超出则删除最旧的），默认 100
   442→
   443→    示例:
   444→        append_to_list({
   445→            "path": "journal",
   446→            "entry": {"content": "今天完成了第一个目标"},
   447→            "max_items": 100
   448→        })
   449→    """
   450→    from stores.unified_profile_repo import UnifiedProfileRepository
   451→    from uuid import UUID
   452→
   453→    skill_id = context.skill_id
   454→    if not skill_id:
   455→        return {
   456→            "status": "error",
   457→            "message": "No active skill"
   458→        }
   459→
   460→    path = args.get("path")
   461→    entry = args.get("entry")
   462→    max_items = args.get("max_items", 100)
   463→
   464→    if not path or not entry:
   465→        return {
   466→            "status": "error",
   467→            "message": "Missing path or entry"
   468→        }
   469→
   470→    # 添加时间戳
   471→    if isinstance(entry, dict):
   472→        entry["_created_at"] = datetime.utcnow().isoformat()
   473→
   474→    # 追加到列表
   475→    user_uuid = UUID(context.user_id) if isinstance(context.user_id, str) else context.user_id
   476→    await UnifiedProfileRepository.append_to_skill_list(
   477→        user_uuid,
   478→        skill_id,
   479→        path,
   480→        entry,
   481→        max_items
   482→    )
   483→
   484→    return {
   485→        "status": "success",
   486→        "message": f"已添加到 {path}",
   487→        "skill_id": skill_id
   488→    }
   489→