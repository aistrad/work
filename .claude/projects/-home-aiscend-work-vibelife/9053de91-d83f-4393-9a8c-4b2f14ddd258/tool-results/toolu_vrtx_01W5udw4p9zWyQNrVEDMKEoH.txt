     1→"""
     2→Global Tool Handlers - 全局工具执行器
     3→
     4→使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
     5→"""
     6→import json
     7→import logging
     8→from datetime import datetime
     9→from typing import Dict, Any
    10→
    11→from .tool_registry import tool_handler, ToolContext
    12→from .skill_loader import get_skill_services
    13→
    14→logger = logging.getLogger(__name__)
    15→
    16→
    17→@tool_handler("search_db")
    18→async def execute_search_db(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    19→    """从数据库检索知识或案例"""
    20→    from services.knowledge.repository import get_knowledge_repository
    21→
    22→    table = args.get("table", "knowledge_chunks")
    23→    query = args.get("query", "")
    24→    filters = args.get("filters", {})
    25→    top_k = args.get("top_k", 5)
    26→
    27→    # 自动添加当前 skill_id 到 filters
    28→    if context.skill_id and "skill_id" not in filters:
    29→        filters["skill_id"] = context.skill_id
    30→
    31→    try:
    32→        repo = get_knowledge_repository()
    33→        results = await repo.search_db(
    34→            table=table,
    35→            query=query,
    36→            filters=filters,
    37→            top_k=top_k
    38→        )
    39→        return {
    40→            "status": "success",
    41→            "table": table,
    42→            "query": query,
    43→            "count": len(results),
    44→            "results": results
    45→        }
    46→    except Exception as e:
    47→        logger.error(f"search_db failed: {e}")
    48→        return {"status": "error", "error": str(e)}
    49→
    50→
    51→@tool_handler("ask_user_question")
    52→async def execute_ask_user_question(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    53→    """向用户提问"""
    54→    return {
    55→        "status": "question",
    56→        "question": args.get("question"),
    57→        "options": args.get("options", [])
    58→    }
    59→
    60→
    61→@tool_handler("show_service_menu")
    62→async def execute_show_service_menu(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    63→    """展示服务目录"""
    64→    services = args.get("services", [
    65→        {"id": "bazi", "name": "八字命理", "description": "八字排盘、运势分析", "icon": "compass"},
    66→        {"id": "zodiac", "name": "星座占星", "description": "星盘解读、行运分析", "icon": "star"},
    67→        {"id": "tarot", "name": "塔罗占卜", "description": "塔罗牌阵、问题指引", "icon": "cards"},
    68→        {"id": "career", "name": "职业规划", "description": "职业方向、发展建议", "icon": "briefcase"},
    69→    ])
    70→    return {
    71→        "status": "success",
    72→        "cardType": "service_menu",
    73→        "services": services,
    74→    }
    75→
    76→
    77→@tool_handler("show_skill_services")
    78→async def execute_show_skill_services(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    79→    """展示 Skill 服务目录"""
    80→    skill_id = args.get("skill_id") or context.skill_id or "bazi"
    81→
    82→    # 从 SKILL.md 动态获取服务列表
    83→    skill_services = get_skill_services(skill_id)
    84→    if skill_services:
    85→        return {
    86→            "status": "success",
    87→            "cardType": "skill_services",
    88→            "skillId": skill_id,
    89→            "skillName": skill_services.get("skill_name", skill_id),
    90→            "services": skill_services.get("services", {}),
    91→        }
    92→
    93→    # 回退到静态列表
    94→    static_services = {
    95→        "bazi": [
    96→            {"id": "bazi_chart", "name": "八字排盘", "description": "生成完整八字命盘", "tier": "entry"},
    97→            {"id": "bazi_fortune", "name": "运势分析", "description": "大运流年详解", "tier": "entry"},
    98→            {"id": "bazi_career", "name": "事业分析", "description": "职业方向与发展", "tier": "pro"},
    99→        ],
   100→        "zodiac": [
   101→            {"id": "zodiac_chart", "name": "星盘解读", "description": "本命星盘分析", "tier": "entry"},
   102→            {"id": "zodiac_transit", "name": "行运分析", "description": "当前行星影响", "tier": "entry"},
   103→        ],
   104→    }
   105→
   106→    return {
   107→        "status": "success",
   108→        "cardType": "skill_services",
   109→        "skillId": skill_id,
   110→        "services": static_services.get(skill_id, []),
   111→    }
   112→
   113→
   114→@tool_handler("recommend_service")
   115→async def execute_recommend_service(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   116→    """推荐升级服务"""
   117→    return {
   118→        "status": "success",
   119→        "cardType": "service_recommendation",
   120→        "scenarioId": args.get("scenario_id", ""),
   121→        "reason": args.get("reason", ""),
   122→        "highlights": args.get("highlights", []),
   123→    }
   124→
   125→
   126→@tool_handler("request_info")
   127→async def execute_request_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   128→    """向用户请求信息"""
   129→    info_type = args.get("info_type", "birth")
   130→
   131→    fields_map = {
   132→        "birth": [
   133→            {"id": "birthDate", "label": "出生日期", "type": "date", "placeholder": ""},
   134→            {"id": "birthTime", "label": "出生时间", "type": "time", "placeholder": ""},
   135→            {"id": "birthPlace", "label": "出生地点", "type": "text", "placeholder": "城市名"},
   136→            {"id": "gender", "label": "性别", "type": "select", "options": [
   137→                {"value": "male", "label": "男"},
   138→                {"value": "female", "label": "女"},
   139→            ]},
   140→        ],
   141→        "context": [
   142→            {"id": "situation", "label": "当前情况", "type": "text", "placeholder": "描述你目前面临的情况"},
   143→        ],
   144→        "goals": [
   145→            {"id": "goals", "label": "你的目标", "type": "text", "placeholder": "你想达成什么"},
   146→        ],
   147→        "concerns": [
   148→            {"id": "concerns", "label": "你的困惑", "type": "text", "placeholder": "最困扰你的是什么"},
   149→        ],
   150→    }
   151→
   152→    return {
   153→        "status": "collecting",
   154→        "cardType": "collect_form",
   155→        "infoType": info_type,
   156→        "question": args.get("question"),
   157→        "fields": fields_map.get(info_type, fields_map["birth"]),
   158→    }
   159→
   160→
   161→@tool_handler("show_insight")
   162→async def execute_show_insight(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   163→    """展示洞察卡片"""
   164→    return {
   165→        "status": "success",
   166→        "cardType": "insight_card",
   167→        "insightType": args.get("insight_type", "general"),
   168→        "title": args.get("title", "关键洞察"),
   169→        "content": args.get("content", ""),
   170→    }
   171→
   172→
   173→@tool_handler("show_report")
   174→async def execute_show_report(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   175→    """展示报告"""
   176→    from uuid import UUID
   177→
   178→    report_id = args.get("report_id")
   179→    report_type = args.get("report_type", "lite")
   180→    user_id = context.user_id
   181→    skill = context.skill_id or "bazi"
   182→
   183→    # 尝试获取已有报告
   184→    if report_id:
   185→        try:
   186→            from stores import report_repo
   187→            report = await report_repo.get_report(report_id)
   188→            if report:
   189→                return _normalize_report(report.to_dict())
   190→        except Exception as e:
   191→            logger.error(f"Failed to get report {report_id}: {e}")
   192→
   193→    if user_id and user_id != "guest":
   194→        try:
   195→            from stores import report_repo
   196→            user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
   197→            reports = await report_repo.list_reports(user_uuid, skill=skill, limit=1)
   198→            if reports:
   199→                report = await report_repo.get_report(reports[0].id)
   200→                if report:
   201→                    return _normalize_report(report.to_dict())
   202→        except Exception as e:
   203→            logger.error(f"Failed to get user reports: {e}")
   204→
   205→    # 返回演示报告
   206→    return {
   207→        "status": "success",
   208→        "cardType": "report_card",
   209→        "id": "demo",
   210→        "title": f"{'星盘' if skill == 'zodiac' else '八字'}报告（演示）",
   211→        "createdAt": datetime.now().strftime("%Y-%m-%d"),
   212→        "prologue": "这是一个演示版报告卡片。完善个人信息后可生成真实报告。",
   213→        "isPaid": False,
   214→        "reportType": report_type,
   215→    }
   216→
   217→
   218→def _normalize_report(report: Dict[str, Any]) -> Dict[str, Any]:
   219→    """标准化报告字段名"""
   220→    return {
   221→        **report,
   222→        "status": "success",
   223→        "cardType": "report_card",
   224→        "createdAt": report.get("created_at") or report.get("createdAt"),
   225→        "isPaid": report.get("is_paid") if report.get("isPaid") is None else report.get("isPaid"),
   226→        "reportType": report.get("report_type") or report.get("reportType"),
   227→    }
   228→
   229→
   230→@tool_handler("show_relationship")
   231→async def execute_show_relationship(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   232→    """展示关系分析"""
   233→    partner_info = args.get("partner_info") or args.get("partnerInfo")
   234→    relationship_type = args.get("relationship_type") or args.get("relationshipType", "general")
   235→
   236→    # TODO: 接入真正的关系分析服务
   237→    return {
   238→        "status": "success",
   239→        "cardType": "relationship_card",
   240→        "score": 85,
   241→        "summary": "你们的关系有很好的互补性",
   242→        "strengths": ["沟通顺畅", "价值观相近"],
   243→        "challenges": ["需要更多耐心", "注意情绪表达"],
   244→        "advice": "多倾��对方的想法，用行动表达关心。",
   245→        "relationshipType": relationship_type,
   246→    }
   247→
   248→
   249→@tool_handler("recommend_skill")
   250→async def execute_recommend_skill(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   251→    """
   252→    推荐 Skill 给用户
   253→
   254→    当 LLM 判断用户可能对某个未订阅的 Skill 感兴趣时调用此工具。
   255→    前端收到此卡片后会显示推荐卡片，用户可以选择试用或了解更多。
   256→
   257→    Args:
   258→        skill_id: 推荐的 Skill ID
   259→        reason: 推荐原因（基于对话内容生成）
   260→        confidence: 推荐置信度 (high/medium/low)
   261→
   262→    Returns:
   263→        skill_recommendation 卡片数据
   264→    """
   265→    from .skill_loader import load_skill_metadata
   266→
   267→    skill_id = args.get("skill_id")
   268→    reason = args.get("reason", "")
   269→    confidence = args.get("confidence", "medium")
   270→
   271→    if not skill_id:
   272→        return {"status": "error", "error": "skill_id is required"}
   273→
   274→    # 加载 Skill 元数据
   275→    metadata = load_skill_metadata(skill_id)
   276→    if not metadata:
   277→        return {"status": "error", "error": f"Skill not found: {skill_id}"}
   278→
   279→    # 检查用户是否已订阅（如果已订阅则不推荐）
   280→    user_id = context.user_id
   281→    if user_id and user_id != "guest":
   282→        try:
   283→            from uuid import UUID
   284→            # v7.6: 使用 UnifiedProfileRepository
   285→            from stores.unified_profile_repo import UnifiedProfileRepository
   286→
   287→            user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
   288→            subscription = await UnifiedProfileRepository.get_skill_subscription(user_uuid, skill_id)
   289→
   290→            if subscription and subscription.status == "subscribed":
   291→                # 用户已订阅，不需要推荐
   292→                return {
   293→                    "status": "skip",
   294→                    "reason": "already_subscribed",
   295→                    "skill_id": skill_id,
   296→                }
   297→        except Exception as e:
   298→            logger.warning(f"Failed to check subscription for {skill_id}: {e}")
   299→
   300→    # 返回推荐卡片数据
   301→    return {
   302→        "status": "success",
   303→        "cardType": "skill_recommendation",
   304→        "skill_id": skill_id,
   305→        "skill": {
   306→            "id": metadata.id,
   307→            "name": metadata.name,
   308→            "description": metadata.description,
   309→            "icon": metadata.icon,
   310→            "color": metadata.color,
   311→            "tagline": metadata.showcase.tagline,
   312→            "trial_messages": metadata.pricing.trial_messages,
   313→        },
   314→        "reason": reason,
   315→        "confidence": confidence,
   316→    }
   317→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
