     1→# VibeLife V8 系统架构文档
     2→
     3→> Version: 8.0 | 2026-01-19
     4→> 核心理念：AI 原生的个人成长陪伴平台
     5→
     6→---
     7→
     8→## 1. 产品定位
     9→
    10→VibeLife 是一个 AI 原生的个人成长陪伴平台，通过多个专业 Skill 提供深度理解和主动关怀。
    11→
    12→### 1.1 三大差异化
    13→
    14→| 差异化 | 说明 |
    15→|--------|------|
    16→| **Deep Understanding** | 理解你这个人，而非只是问题 |
    17→| **Proactive Agency** | 主动关心，而非等你开口 |
    18→| **Infinite Extensibility** | 通过 Skills 无限扩展能力 |
    19→
    20→### 1.2 设计原则
    21→
    22→| 原则 | 说明 |
    23→|------|------|
    24→| **Simplicity** | 保持简单，避免过度工程 |
    25→| **Config-Driven** | Skill 层配置驱动，平台层代码驱动 |
    26→| **Single Source of Truth** | 工具定义、模型配置等只有一个数据源 |
    27→| **DDD** | 领域驱动设计，每个 Skill 独立管理自己的服务 |
    28→
    29→---
    30→
    31→## 2. 整体架构
    32→
    33→```
    34→┌─────────────────────────────────────────────────────────────────────────┐
    35→│                         VibeLife V8 Architecture                         │
    36→├─────────────────────────────────────────────────────────────────────────┤
    37→│                                                                          │
    38→│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐          │
    39→│   │   Browser    │─────▶│   Next.js    │─────▶│  Python API  │          │
    40→│   │  (AI SDK 4)  │      │   (Proxy)    │      │  (FastAPI)   │          │
    41→│   └──────────────┘      └──────────────┘      └──────────────┘          │
    42→│                                                      │                   │
    43→│                         ┌────────────────────────────┼────────────────┐  │
    44→│                         │                            ▼                │  │
    45→│                         │   ┌────────────────────────────────────┐    │  │
    46→│                         │   │            CoreAgent               │    │  │
    47→│                         │   │     (Agentic Loop + Tool Calling)  │    │  │
    48→│                         │   └────────────────────────────────────┘    │  │
    49→│                         │              │              │               │  │
    50→│                         │    ┌─────────┴──────┐      │               │  │
    51→│                         │    ▼                ▼      ▼               │  │
    52→│                         │ ┌────────┐  ┌────────────┐ ┌────────────┐  │  │
    53→│                         │ │  Tool  │  │   Skill    │ │  Knowledge │  │  │
    54→│                         │ │Registry│  │  Loader    │ │  (Cases)   │  │  │
    55→│                         │ └────────┘  └────────────┘ └────────────┘  │  │
    56→│                         │                    │                       │  │
    57→│                         │    ┌───────────────┼───────────────┐       │  │
    58→│                         │    ▼               ▼               ▼       │  │
    59→│                         │ ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐    │  │
    60→│                         │ │ Bazi │  │Zodiac│  │Tarot │  │Career│    │  │
    61→│                         │ │Skill │  │Skill │  │Skill │  │Skill │    │  │
    62→│                         │ └──────┘  └──────┘  └──────┘  └──────┘    │  │
    63→│                         └────────────────────────────────────────────┘  │
    64→│                                                                          │
    65→│   ┌──────────────────────────────────────────────────────────────────┐  │
    66→│   │                      Supporting Services                          │  │
    67→│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │  │
    68→│   │  │  Proactive │  │   Skill    │  │  Identity  │  │  Commerce  │  │  │
    69→│   │  │   Engine   │  │ Management │  │  Service   │  │  Service   │  │  │
    70→│   │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │  │
    71→│   └──────────────────────────────────────────────────────────────────┘  │
    72→│                                                                          │
    73→│   ┌──────────────────────────────────────────────────────────────────┐  │
    74→│   │                         Data Layer                                │  │
    75→│   │   PostgreSQL (users, profiles, messages, cases, subscriptions)   │  │
    76→│   └──────────────────────────────────────────────────────────────────┘  │
    77→│                                                                          │
    78→└─────────────────────────────────────────────────────────────────────────┘
    79→```
    80→
    81→---
    82→
    83→## 3. 核心引擎
    84→
    85→### 3.1 CoreAgent
    86→
    87→基于 Anthropic Agent 设计原则的对话引擎，是系统的核心。
    88→
    89→**核心流程**：
    90→```
    91→用户消息 → CoreAgent.run()
    92→    │
    93→    ├─ 1. Skill 路由（LLM 自动选择或前端指定）
    94→    │
    95→    ├─ 2. 构建 System Prompt
    96→    │      ├─ Skill 专家身份
    97→    │      ├─ SOP 规则（配置驱动）
    98→    │      ├─ 相关 Cases（倒排索引匹配）
    99→    │      └─ 用户上下文（Profile + Skill Data）
   100→    │
   101→    ├─ 3. LLM 调用（支持 Tool Calling）
   102→    │
   103→    ├─ 4. 工具执行（ToolRegistry）
   104→    │
   105→    └─ 5. 流式输出（AI SDK Data Stream Protocol）
   106→```
   107→
   108→**关键特性**：
   109→- **LLM 自动路由**：通过 `use_skill` 工具让 LLM 决定使用哪个 Skill
   110→- **SOP 配置驱动**：从 SKILL.md 读取 `requires_birth_info`、`requires_compute` 等配置
   111→- **Case 匹配**：使用倒排索引匹配相似案例，注入 System Prompt
   112→
   113→### 3.2 Skill System
   114→
   115→配置驱动的技能系统，支持自动发现。
   116→
   117→**Skill 分类**：
   118→```
   119→┌─────────────────────────────────────────────────────────────┐
   120→│  Core Layer (始终激活，不可取消)                              │
   121→│  └─ core: 生命对话者 - AI 的灵魂                             │
   122→├─────────────────────────────────────────────────────────────┤
   123→│  Default Layer (默认激活，免费，可取消)                       │
   124→│  ├─ mindfulness: 正念导师                                    │
   125→│  └─ lifecoach: 人生教练                                      │
   126→├─────────────────────────────────────────────────────────────┤
   127→│  Professional Layer (需订阅，付费)                           │
   128→│  ├─ bazi: 八字命理                                          │
   129→│  ├─ zodiac: 西方占星                                        │
   130→│  ├─ tarot: 塔罗占卜                                         │
   131→│  ├─ jungastro: 荣格占星                                     │
   132→│  └─ career: 职业规划                                        │
   133→└─────────────────────────────────────────────────────────────┘
   134→```
   135→
   136→**Skill 目录结构**：
   137→```
   138→skills/{skill_id}/
   139→├── SKILL.md              # Skill 定义（专家身份、触发词、配置）
   140→├── rules/                # 规则文件（分析要点、输出要求）
   141→│   ├── basic-reading.md
   142→│   └── career.md
   143→├── tools/                # 工具定义
   144→│   ├── tools.yaml        # 工具 Schema
   145→│   └── handlers.py       # 工具执行器
   146→├── services/             # 领域服务
   147→│   └── api.py            # API 服务（@skill_service 装饰器）
   148→├── scenarios/            # 场景文件（旧架构兼容）
   149→└── reminders.yaml        # 主动推送配置
   150→```
   151→
   152→### 3.3 Tool Registry
   153→
   154→统一的工具注册表，支持自动发现。
   155→
   156→**工具类型**：
   157→| 类型 | 说明 | 示例 |
   158→|------|------|------|
   159→| collect | 收集用户信息 | request_info |
   160→| calculate | 计算/排盘 | calculate_bazi |
   161→| display | 展示结果 | show_bazi_chart |
   162→| search | 知识检索 | search_db |
   163→| action | 执行操作 | write_user_data |
   164→
   165→**工具定义**（tools.yaml）：
   166→```yaml
   167→- name: show_bazi_chart
   168→  description: 展示八字命盘
   169→  tool_type: display
   170→  card_type: BaziChart
   171→  parameters:
   172→    - name: chart
   173→      type: object
   174→      required: true
   175→```
   176→
   177→**工具执行器**（handlers.py）：
   178→```python
   179→@tool_handler("show_bazi_chart")
   180→async def execute_show_bazi_chart(args: Dict, context: ToolContext) -> Dict:
   181→    return {"cardType": "bazi_chart", **args}
   182→```
   183→
   184→---
   185→
   186→## 4. 知识系统
   187→
   188→### 4.1 Knowledge Base v2
   189→
   190→基于 Case 倒排索引的知识检索系统，替代传统向量检索。
   191→
   192→**核心概念**：
   193→- **Cases**：从原文 LLM 抽取的结构化案例，存储在数据库中
   194→- **倒排索引**：基于 tags 的内存索引，快速匹配相似案例
   195→- **Rule 关联**：Cases 通过 `rule_ids` 关联到规则文件
   196→
   197→**数据流**：
   198→```
   199→原文 (PDF/MD)
   200→    │
   201→    ▼ LLM 抽取
   202→数据库: skill_cases 表
   203→    │
   204→    ▼ tags
   205→Case 倒排索引（内存缓存）
   206→    │
   207→    ▼ 用户命盘特征匹配
   208→System Prompt 注入
   209→```
   210→
   211→**Case 数据模型**：
   212→| 字段 | 类型 | 说明 |
   213→|------|------|------|
   214→| id | string | 案例 ID |
   215→| skill_id | string | 所属 Skill |
   216→| name | string | 案例名称 |
   217→| tags | string[] | 特征标签（用于匹配） |
   218→| rule_ids | string[] | 关联的规则 ID |
   219→| content | text | 案例正文（Markdown） |
   220→
   221→---
   222→
   223→## 5. 主动模块
   224→
   225→### 5.1 Proactive Engine
   226→
   227→主动触达用户，增强粘性和业务转化。
   228→
   229→**架构**：
   230→```
   231→┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   232→│  Scheduler  │───▶│   Engine    │───▶│  Delivery   │
   233→│  (Cron)     │    │             │    │  (Push)     │
   234→└─────────────┘    └──────┬──────┘    └─────────────┘
   235→                          │
   236→          ┌───────────────┼───────────────┐
   237→          ▼               ▼               ▼
   238→   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
   239→   │  Trigger    │ │  Content    │ │ Subscription│
   240→   │  Detector   │ │  Generator  │ │   Checker   │
   241→   └─────────────┘ └─────────────┘ └─────────────┘
   242→```
   243→
   244→**触发器类型**：
   245→| 类型 | 说明 | 示例 |
   246→|------|------|------|
   247→| time_based | 定时触发 | 每日运势 |
   248→| event_based | 事件触发 | 生日、节气 |
   249→| threshold_based | 阈值触发 | 运势低于 40 分 |
   250→| emotion_based | 情绪触发 | 检测到焦虑 |
   251→| skill_completion | 完成触发 | 深度对话后推荐 |
   252→
   253→**配置示例**（reminders.yaml）：
   254→```yaml
   255→skill_id: bazi
   256→enabled: true
   257→
   258→reminders:
   259→  - id: daily_fortune
   260→    name: 每日运势
   261→    trigger:
   262→      type: time_based
   263→      schedule: "0 4 * * *"
   264→    content:
   265→      generator: rules/daily-fortune.md
   266→      suggested_prompt: "想了解今天的运势详情？"
   267→      quick_actions:
   268→        - label: "今日宜忌"
   269→          prompt: "今天适合做什么？"
   270→```
   271→
   272→### 5.2 Skill Management
   273→
   274→让用户发现、订阅、管理 Skill 的完整系统。
   275→
   276→**发现入口**：
   277→| 入口 | 位置 | 触发时机 |
   278→|------|------|----------|
   279→| Skill 市场 | /skills 页面 | 用户主动访问 |
   280→| 对话推荐 | 对话流中 | AI 检测到相关意图 |
   281→| 设置管理 | 设置页面 | 用户管理订阅 |
   282→| 首页卡片 | 主页侧边栏 | 每次进入首页 |
   283→
   284→**订阅状态与推送关系**：
   285→| Skill 类别 | 订阅状态 | push_enabled | 是否推送 |
   286→|-----------|---------|--------------|---------|
   287→| core | - | - | 始终推送 |
   288→| default | subscribed | true | 推送 |
   289→| default | unsubscribed | - | 不推送 |
   290→| professional | subscribed | true | 推送 |
   291→| professional | 无/unsubscribed | - | 不推送 |
   292→
   293→---
   294→
   295→## 6. 用户体验
   296→
   297→### 6.1 对话体验
   298→
   299→**Core Skill 人格**：
   300→- 温暖但不粘腻
   301→- 智慧但不说教
   302→- 好奇但不窥探
   303→- 诚实但不伤害
   304→
   305→**能力层次**：
   306→1. **倾听与共情**：深度倾听、情绪感知、不评判
   307→2. **记忆与累积**：跨对话记忆、模式识别、变化觉察
   308→3. **引导探索**：苏格拉底式提问、重框架、联结
   309→4. **适度引导**：知道边界、轻推、播种、庆祝
   310→
   311→### 6.2 新用户流程
   312→
   313→```
   314→Landing → Loading → Aha Moment → Conversion
   315→   │          │          │           │
   316→   │          │          │           └─ 付费转化
   317→   │          │          └─ 日主洞察 + 今日运势
   318→   │          └─ 命盘渐进绘制 + 计算步骤展示
   319→   └─ 零摩擦入口（键盘直接输入生辰）
   320→```
   321→
   322→### 6.3 ShowCard Fallback 机制
   323→
   324→"专用优先，通用兜底"的卡片渲染策略：
   325→1. 优先使用注册的专用组件
   326→2. 不存在时根据 `fallbackType` 降级到通用视图
   327→3. 智能推断：根据 data/items/nodes 等属性自动选择
   328→
   329→**通用视图类型**：list, tree, table, timeline, form, select, chart, progress, counter, modal, toast, custom
   330→
   331→---
   332→
   333→## 7. 技术栈
   334→
   335→### 7.1 后端
   336→
   337→| 组件 | 技术 |
   338→|------|------|
   339→| 框架 | FastAPI (Python 3.11+) |
   340→| 数据库 | PostgreSQL 16 + pgvector |
   341→| LLM | DeepSeek / GLM / Claude (Anthropic 兼容 API) |
   342→| 向量嵌入 | BAAI/bge-m3 (1024维，本地 CUDA) |
   343→
   344→### 7.2 前端
   345→
   346→| 组件 | 技术 |
   347→|------|------|
   348→| 框架 | Next.js 14 (App Router) |
   349→| 语言 | TypeScript 5.3+ |
   350→| 样式 | Tailwind CSS 3.4 |
   351→| 动画 | Framer Motion |
   352→| AI SDK | Vercel AI SDK 4.x |
   353→
   354→### 7.3 LLM 模型配置
   355→
   356→**唯一配置源**：`config/models.yaml`
   357→
   358→```yaml
   359→providers:
   360→  deepseek:
   361→    base_url: https://api.deepseek.com/anthropic
   362→    is_anthropic_compatible: true
   363→  glm:
   364→    base_url: https://open.bigmodel.cn/api/anthropic/v1
   365→    is_anthropic_compatible: true
   366→
   367→routing:
   368→  chat:
   369→    free: deepseek-chat
   370→    paid: deepseek-chat
   371→    fallback: [glm-4.7]
   372→```
   373→
   374→---
   375→
   376→## 8. API 架构
   377→
   378→### 8.1 路由结构
   379→
   380→```
   381→routes/ (7 个核心路由文件)
   382→├── health.py           # 健康检查
   383→├── chat_v5.py          # CoreAgent 对话入口
   384→├── tools.py            # 工具 Schema API
   385→├── skills.py           # Skill Gateway（配置驱动）
   386→├── account.py          # 用户域（认证、用户、访客、身份）
   387→├── commerce.py         # 支付域（支付、订阅、权益）
   388→└── notifications.py    # 通知域
   389→```
   390→
   391→### 8.2 核心端点
   392→
   393→| 域 | 端点前缀 | 说明 |
   394→|----|----------|------|
   395→| Chat | `/api/v1/chat/v5/*` | CoreAgent 对话 |
   396→| Skills | `/api/v1/skills/{skill}/{action}` | 统一 Skill Gateway |
   397→| Account | `/api/v1/account/*` | 认证、用户、访客、身份 |
   398→| Commerce | `/api/v1/commerce/*` | 支付、订阅、权益 |
   399→| Tools | `/api/v1/tools/*` | 工具 Schema |
   400→| Notifications | `/api/v1/notifications/*` | 通知管理 |
   401→
   402→---
   403→
   404→## 9. 数据模型
   405→
   406→### 9.1 核心表
   407→
   408→| 表 | 说明 |
   409→|----|------|
   410→| vibe_users | 用户基本信息 |
   411→| unified_profiles | 用户档案（profile + skill_data） |
   412→| conversations | 对话会话 |
   413→| messages | 对话消息 |
   414→| skill_cases | 知识案例（Case 系统） |
   415→| user_skill_subscriptions | 用户 Skill 订阅 |
   416→| subscriptions | 付费订阅记录 |
   417→| payments | 支付记录 |
   418→
   419→### 9.2 用户画像
   420→
   421→**Hot Memory**（unified_profiles.profile）：
   422→- Facts：客观事实（生日、命盘等）
   423→- State：当前状态（情绪、关注点）
   424→- Preferences：偏好习惯
   425→- Focus：近期焦点
   426→
   427→**Cold Memory**（insights）：
   428→- Discovery：首次发现的特征
   429→- Pattern：重复出现的规律
   430→- Timing：时机相关建议
   431→- Growth：成长变化观察
   432→
   433→---
   434→
   435→## 10. 部署架构
   436→
   437→### 10.1 环境配置
   438→
   439→| 环境 | API 端口 | Web 端口 | 说明 |
   440→|------|----------|----------|------|
   441→| 开发 | 8000 | 3000 | 本地开发 |
   442→| 测试 | 8100 | 8232 | aiscend 服务器 |
   443→| 生产 | 8231 | 8230 | 分布式部署 |
   444→
   445→### 10.2 生产部署
   446→
   447→```
   448→用户 (全球)
   449→    │
   450→    ▼
   451→Cloudflare (边缘节点 + DDoS 防护)
   452→    │
   453→    ▼ HTTPS 加密隧道
   454→火山引擎香港 (Nginx + Next.js)
   455→    │
   456→    ▼
   457→北京服务器 (FastAPI + PostgreSQL)
   458→```
   459→
   460→---
   461→
   462→## 附录
   463→
   464→### A. AI SDK Data Stream Protocol
   465→
   466→```
   467→0:"text chunk"           # 文本块
   468→9:{"toolCallId":"..."}   # 工具调用开始
   469→a:{"toolCallId":"..."}   # 工具调用结果
   470→e:{"finishReason":"..."}  # 完成
   471→d:{"finishReason":"..."}  # 结束
   472→```
   473→
   474→### B. 添加新 Skill 流程
   475→
   476→1. 创建目录：`skills/newskill/{SKILL.md, rules/, tools/, services/}`
   477→2. 定义 SKILL.md：专家身份、触发词、配置
   478→3. 创建工具：tools.yaml + handlers.py
   479→4. 创建 API 服务：services/api.py（@skill_service 装饰器）
   480→5. 配置推送：reminders.yaml
   481→6. 重启服务 - 自动发现新 Skill
   482→
   483→### C. 版本历史
   484→
   485→- **V8.0** (2026-01-19): 整合 Knowledge v2、Skill Management、Proactive 模块
   486→- **V7.1** (2026-01-18): LLM 自动路由、ShowCard Fallback 机制
   487→- **V7.0** (2026-01-15): SkillServiceRegistry、统一 Skill Gateway、路由精简
   488→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
