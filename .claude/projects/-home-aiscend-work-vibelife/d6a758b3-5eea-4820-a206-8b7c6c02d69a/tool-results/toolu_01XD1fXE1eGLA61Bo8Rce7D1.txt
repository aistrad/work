The file /home/aiscend/work/vibelife/docs/archive/v8/ARCHITECTURE.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   400→| Notifications | `/api/v1/notifications/*` | 通知管理 |
   401→
   402→---
   403→
   404→## 9. 数据模型
   405→
   406→### 9.1 UserDataSpace - 数据空间划分
   407→
   408→VibeLife 采用 UserDataSpace 统一管理用户数据，区分 **WHO**（画像）和 **WHAT**（操作）：
   409→
   410→```
   411→┌─────────────────────────────────────────────────────────────────┐
   412→│                        UserDataSpace                             │
   413→├─────────────────────────────────────────────────────────────────┤
   414→│                                                                  │
   415→│   VibeProfile (WHO)              Operational (WHAT)              │
   416→│   ─────────────────              ──────────────────              │
   417→│   用户是谁                       用户做了什么                    │
   418→│   • unified_profiles             • conversations                 │
   419→│                                  • messages                      │
   420→│                                  • reports                       │
   421→│                                  • notifications                 │
   422→│                                  • subscriptions                 │
   423→│                                  • payments                      │
   424→│                                                                  │
   425→└─────────────────────────────────────────────────────────────────┘
   426→```
   427→
   428→### 9.2 核心表
   429→
   430→| 表 | 说明 | 数据类型 |
   431→|----|------|----------|
   432→| **VibeProfile (WHO)** | | |
   433→| unified_profiles | 用户画像（JSONB） | WHO |
   434→| vibe_profile_insights | AI 洞察（Cold Layer） | WHO |
   435→| vibe_profile_timeline | 重要事件时间线 | WHO |
   436→| **Operational (WHAT)** | | |
   437→| vibe_users | 用户基本信息 | WHAT |
   438→| conversations | 对话会话 | WHAT |
   439→| messages | 对话消息 | WHAT |
   440→| notifications | 通知记录 | WHAT |
   441→| skill_cases | 知识案例（Case 系统） | WHAT |
   442→| **Billing (WHAT)** | | |
   443→| subscriptions | 付费订阅记录 | WHAT |
   444→| payments | 支付记录 | WHAT |
   445→
   446→### 9.3 VibeProfile 数据结构
   447→
   448→**统一画像存储**（unified_profiles.profile JSONB）：
   449→
   450→```yaml
   451→profile:
   452→  # 账户信息（从 vibe_users 同步）
   453→  account:
   454→    vibe_id: "VB-A1B2C3D4"
   455→    display_name: "用户昵称"
   456→    email: "user@example.com"
   457→    tier: "free"                    # free | premium
   458→    status: "active"
   459→
   460→  # 身份信息
   461→  identity:
   462→    birth_info:
   463→      date: "1990-05-15"
   464→      time: "14:30"
   465→      place: "北京"
   466→      timezone: "Asia/Shanghai"
   467→      gender: "male"
   468→
   469→  # 当前状态
   470→  state:
   471→    emotion: "neutral"              # anxious | sad | neutral | content | excited
   472→    focus: ["career"]               # 当前关注的话题
   473→    life_stage: "career_growth"
   474→
   475→  # 偏好设置
   476→  preferences:
   477→    voice_mode: "warm"
   478→    language: "zh-CN"
   479→
   480→    # Skill 订阅（整合 user_skill_subscriptions）
   481→    subscribed_skills:
   482→      bazi:
   483→        status: "subscribed"        # subscribed | unsubscribed | not_subscribed
   484→        push_enabled: true
   485→        subscribed_at: "2026-01-01T00:00:00Z"
   486→        trial_messages_used: 0
   487→      zodiac:
   488→        status: "subscribed"
   489→        push_enabled: true
   490→        subscribed_at: "2026-01-15T00:00:00Z"
   491→        trial_messages_used: 0
   492→
   493→    # 推送设置（整合 user_push_preferences）
   494→    push_settings:
   495→      default_push_hour: 8
   496→      max_daily_pushes: 5
   497→      quiet_start_hour: 22
   498→      quiet_end_hour: 7
   499→
   500→    # 数据保留策略
   501→    data_retention:
   502→      conversations: "1y"           # "1y" | "3y" | "forever"
   503→
   504→    # Skill 推荐屏蔽
   505→    blocked_skills: ["skill_id_1"]
   506→
   507→  # Skill 数据
   508→  skill_data:
   509→    bazi:
   510→      chart: { ... }
   511→      features: { daymaster, strength, pattern }
   512→      current_dayun: { ... }
   513→      current_liunian: { ... }
   514→    zodiac:
   515→      chart: { ... }
   516→      current_transits: { ... }
   517→    tarot:
   518→      last_reading: { ... }
   519→    career:
   520→      assessment: { ... }
   521→
   522→  # 从对话抽取
   523→  extracted:
   524→    facts: ["在互联网公司工作", "有升职压力"]
   525→    goals: ["年底升职"]             # 当前活跃目标摘要
   526→    concerns: ["工作压力"]
   527→    pain_points: ["工作生活平衡"]
   528→    life_events: [...]
   529→    patterns: [...]
   530→
   531→  # 生活上下文（整合 user_data_store）
   532→  life_context:
   533→    # 基础信息
   534→    occupation:
   535→      title: "产品经理"
   536→      industry: "互联网"
   537→    focus_areas: ["career", "health"]
   538→
   539→    # 目标管理
   540→    goals:
   541→      - id: "uuid-1"
   542→        title: "年底升职到高级产品经理"
   543→        category: "career"
   544→        status: "active"            # active | completed | abandoned
   545→        progress: 0.3
   546→        deadline: "2026-12-31"
   547→        created_at: "2026-01-01"
   548→
   549→    # 任务管理
   550→    tasks:
   551→      - id: "uuid-a"
   552→        title: "准备季度汇报"
   553→        status: "pending"           # pending | done | cancelled
   554→        due_date: "2026-01-25"
   555→        goal_id: "uuid-1"
   556→
   557→    # 打卡记录（只保留 30 天）
   558→    checkins:
   559→      "2026-01-19": { mood: 7, energy: 6, notes: "状态不错" }
   560→      "2026-01-18": { mood: 5, energy: 4, notes: "有点累" }
   561→
   562→    # 提醒
   563→    reminders:
   564→      - id: "uuid-r1"
   565→        type: "goal_checkin"        # goal_checkin | daily_plan | custom
   566→        title: "目标打卡提醒"
   567→        schedule_type: "daily"      # once | daily | weekly
   568→        trigger_hour: 20
   569→        status: "active"            # active | paused
   570→        goal_id: "uuid-1"
   571→
   572→    # 追踪统计
   573→    tracking:
   574→      last_checkin: "2026-01-19"
   575→      streak_days: 5
   576→```
   577→
   578→### 9.4 数据访问层
   579→
   580→**UnifiedProfileRepository** 提供统一的 Profile 访问接口：
   581→
   582→```python
   583→class UnifiedProfileRepository:
   584→    # 读取操作
   585→    async def get_profile(user_id: UUID) -> Optional[Dict[str, Any]]
   586→    async def get_birth_info(user_id: UUID) -> Dict[str, Any]
   587→    async def get_skill_data(user_id: UUID, skill: str) -> Dict[str, Any]
   588→    async def get_preferences(user_id: UUID) -> Dict[str, Any]
   589→    async def get_identity_prism(user_id: UUID) -> Dict[str, Any]
   590→    async def get_life_context(user_id: UUID) -> Dict[str, Any]
   591→    async def get_extracted(user_id: UUID) -> Dict[str, Any]
   592→
   593→    # 写入操作（使用 jsonb_set 局部更新）
   594→    async def update_birth_info(user_id: UUID, birth_info: Dict[str, Any])
   595→    async def update_skill_data(user_id: UUID, skill: str, data: Dict[str, Any])
   596→    async def update_preferences(user_id: UUID, preferences: Dict[str, Any])
   597→    async def update_identity_prism(user_id: UUID, identity_prism: Dict[str, Any])
   598→    async def update_life_context(user_id: UUID, life_context: Dict[str, Any])
   599→    async def update_extracted(user_id: UUID, extracted: Dict[str, Any])
   600→
   601→    # 生活管理
   602→    async def add_goal(user_id: UUID, goal: Dict)
   603→    async def update_goal(user_id: UUID, goal_id: str, updates: Dict)
   604→    async def add_task(user_id: UUID, task: Dict)
   605→    async def update_task(user_id: UUID, task_id: str, updates: Dict)
   606→    async def add_checkin(user_id: UUID, date: str, checkin: Dict)
   607→    async def add_reminder(user_id: UUID, reminder: Dict)
   608→    async def update_reminder(user_id: UUID, reminder_id: str, updates: Dict)
   609→
   610→    # Skill 订阅管理
   611→    async def get_skill_subscription(user_id: UUID, skill_id: str) -> Optional[SkillSubscription]
   612→    async def subscribe(user_id: UUID, skill_id: str, push_enabled: bool) -> SkillSubscription
   613→    async def unsubscribe(user_id: UUID, skill_id: str) -> SkillSubscription
   614→    async def is_subscribed(user_id: UUID, skill_id: str) -> bool
   615→    async def can_use_skill(user_id: UUID, skill_id: str, skill_category: str) -> tuple
   616→
   617→    # 推送管理
   618→    async def get_push_settings(user_id: UUID) -> Optional[UserPushPreferences]
   619→    async def is_push_enabled(user_id: UUID, skill_id: str) -> bool
   620→    async def get_users_with_push_enabled(skill_id: str) -> List[UUID]
   621→
   622→    # 缓存管理
   623→    async def _invalidate_cache(user_id: UUID, skill: str = None)
   624→```
   625→
   626→### 9.5 Skill 访问规则
   627→
   628→| Skill | 可读 | 可写 |
   629→|-------|------|------|
   630→| **Core Layer** | | |
   631→| core | 全部 | state, extracted |
   632→| lifecoach | 全部 | state, extracted, life_context |
   633→| mindfulness | 全部 | state |
   634→| **Professional Layer** | | |
   635→| bazi | identity, state | skill_data.bazi |
   636→| zodiac | identity, state | skill_data.zodiac |
   637→| tarot | identity, state | skill_data.tarot |
   638→| career | identity, state, life_context | skill_data.career |
   639→
   640→### 9.6 数据生命周期
   641→
   642→| 领域 | 默认保留 | 用户可选 | 清理规则 |
   643→|------|---------|---------|---------|
   644→| **VibeProfile** | 永久 | - | checkins 保留 30 天 |
   645→| **Conversations** | 1 年 | 1年 / 3年 / 永久 | 按 data_retention 设置清理 |
   646→| **Content** | 永久 | 可手动删除 | - |
   647→| **Billing** | 7 年 | 不可更改 | 法规要求 |
   648→| **Logs** | 90 天 | - | 滚动清理 |
   649→| **Notifications** | 30 天 | - | 已读 30 天后清理 |
   650→
   651→---
   652→
   653→## 10. 部署架构