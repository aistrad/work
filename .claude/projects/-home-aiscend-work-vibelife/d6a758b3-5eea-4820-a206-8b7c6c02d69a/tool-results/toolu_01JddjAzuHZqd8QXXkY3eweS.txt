     1→# VibeProfile - 用户画像数据层
     2→
     3→> Version: 2.2 | 极简设计 | UserDataSpace 统一管理
     4→
     5→---
     6→
     7→## 1. 概述
     8→
     9→VibeProfile 是 VibeLife 用户数据的**画像层**，描述用户是谁（WHO）。与操作性数据（WHAT）分离，通过 UserDataSpace 统一管理。
    10→
    11→### 核心概念
    12→
    13→```
    14→┌─────────────────────────────────────────────────────────────────┐
    15→│                        UserDataSpace                             │
    16→├─────────────────────────────────────────────────────────────────┤
    17→│                                                                  │
    18→│   VibeProfile (WHO)              Operational (WHAT)              │
    19→│   ─────────────────              ──────────────────              │
    20→│   用户是谁                       用户做了什么                    │
    21→│   • identity                     • conversations                 │
    22→│   • preferences                  • messages                      │
    23→│   • state                        • reports                       │
    24→│   • life_context                 • notifications                 │
    25→│                                  • payments                      │
    26→│                                                                  │
    27→└─────────────────────────────────────────────────────────────────┘
    28→```
    29→
    30→### 设计原则
    31→
    32→- **WHO vs WHAT** - VibeProfile 存画像，操作数据独立表
    33→- **Single JSONB** - 画像数据一张表 (`unified_profiles.profile`)
    34→- **Daily Proactive** - 每天凌晨扫描一次，按小时投递
    35→- **User Control** - 用户可选数据保留策略
    36→
    37→---
    38→
    39→## 2. 数据结构
    40→
    41→### 2.1 Profile Schema
    42→
    43→```yaml
    44→profile:
    45→  # ═══════════════════════════════════════════════════════════════
    46→  # 账户 (只读，从 vibe_users 同步)
    47→  # ═══════════════════════════════════════════════════════════════
    48→  account:
    49→    vibe_id: "VB-A1B2C3D4"
    50→    display_name: "用户昵称"
    51→    email: "user@example.com"
    52→    tier: "free"                    # free | premium
    53→    status: "active"
    54→
    55→  # ═══════════════════════════════════════════════════════════════
    56→  # 身份
    57→  # ═══════════════════════════════════════════════════════════════
    58→  identity:
    59→    birth_info:
    60→      date: "1990-05-15"
    61→      time: "14:30"
    62→      place: "北京"
    63→      timezone: "Asia/Shanghai"
    64→      gender: "male"
    65→
    66→  # ═══════════════════════════════════════════════════════════════
    67→  # 状态
    68→  # ═══════════════════════════════════════════════════════════════
    69→  state:
    70→    emotion: "neutral"              # anxious | sad | neutral | content | excited
    71→    focus: ["career"]               # 当前关注的话题
    72→    life_stage: "career_growth"
    73→
    74→  # ═══════════════════════════════════════════════════════════════
    75→  # 偏好 (合并 user_push_preferences, user_skill_subscriptions)
    76→  # ═══════════════════════════════════════════════════════════════
    77→  preferences:
    78→    voice_mode: "warm"
    79→    language: "zh-CN"
    80→    push_enabled: true
    81→    push_hour: 8                    # 推送时间 (0-23)
    82→    subscribed_skills: ["core", "bazi", "zodiac"]
    83→
    84→    # 数据保留策略 (用户可配置)
    85→    data_retention:
    86→      conversations: "1y"           # "1y" | "3y" | "forever"
    87→
    88→  # ═══════════════════════════════════════════════════════════════
    89→  # Skill 数据
    90→  # ═══════════════════════════════════════════════════════════════
    91→  skill_data:
    92→    bazi:
    93→      chart: { ... }
    94→      features: { daymaster, strength, pattern }
    95→      current_dayun: { ... }
    96→      current_liunian: { ... }
    97→    zodiac:
    98→      chart: { ... }
    99→      current_transits: { ... }
   100→    tarot:
   101→      last_reading: { ... }
   102→    career:
   103→      assessment: { ... }
   104→
   105→  # ═══════════════════════════════════════════════════════════════
   106→  # 从对话抽取
   107→  # ═══════════════════════════════════════════════════════════════
   108→  extracted:
   109→    facts: ["在互联网公司工作", "有升职压力"]
   110→    goals: ["年底升职"]             # 当前活跃目标摘要
   111→    concerns: ["工作压力"]
   112→
   113→  # ═══════════════════════════════════════════════════════════════
   114→  # 生活上下文 (合并 user_data_store)
   115→  # ═══════════════════════════════════════════════════════════════
   116→  life_context:
   117→    # 基础信息
   118→    occupation:
   119→      title: "产品经理"
   120→      industry: "互联网"
   121→    focus_areas: ["career", "health"]
   122→
   123→    # 目标管理 (原 user_data_store.goals)
   124→    goals:
   125→      - id: "uuid-1"
   126→        title: "年底升职到高级产品经理"
   127→        category: "career"
   128→        status: "active"            # active | completed | abandoned
   129→        progress: 0.3
   130→        deadline: "2026-12-31"
   131→        created_at: "2026-01-01"
   132→      - id: "uuid-2"
   133→        title: "每周运动3次"
   134→        category: "health"
   135→        status: "active"
   136→        progress: 0.5
   137→
   138→    # 任务管理 (原 user_data_store.tasks)
   139→    tasks:
   140→      - id: "uuid-a"
   141→        title: "准备季度汇报"
   142→        status: "pending"           # pending | done | cancelled
   143→        due_date: "2026-01-25"
   144→        goal_id: "uuid-1"           # 关联目标
   145→      - id: "uuid-b"
   146→        title: "跑步5公里"
   147→        status: "done"
   148→        due_date: "2026-01-19"
   149→        goal_id: "uuid-2"
   150→
   151→    # 打卡记录 (原 user_data_store.checkins，只保留 30 天)
   152→    checkins:
   153→      "2026-01-19": { mood: 7, energy: 6, notes: "状态不错" }
   154→      "2026-01-18": { mood: 5, energy: 4, notes: "有点累" }
   155→      # ... 最多 30 天
   156→
   157→    # 提醒 (原 user_reminders)
   158→    reminders:
   159→      - id: "uuid-r1"
   160→        type: "goal_checkin"        # goal_checkin | daily_plan | custom
   161→        title: "目标打卡提醒"
   162→        schedule_type: "daily"      # once | daily | weekly
   163→        trigger_hour: 20            # 每天 20:00 触发
   164→        status: "active"            # active | paused
   165→        goal_id: "uuid-1"           # 关联目标
   166→      - id: "uuid-r2"
   167→        type: "custom"
   168→        title: "喝水提醒"
   169→        schedule_type: "daily"
   170→        trigger_hour: 10
   171→        status: "active"
   172→
   173→    # 追踪统计
   174→    tracking:
   175→      last_checkin: "2026-01-19"
   176→      streak_days: 5
   177→```
   178→
   179→### 2.2 Cold Layer (独立表，低频写入)
   180→
   181→```sql
   182→-- 洞察 (AI 生成的长期观察)
   183→CREATE TABLE vibe_profile_insights (
   184→    id UUID PRIMARY KEY,
   185→    user_id UUID NOT NULL,
   186→    insight_type VARCHAR(50),       -- discovery | pattern | timing | growth
   187→    skill_id VARCHAR(50),
   188→    content TEXT,
   189→    created_at TIMESTAMPTZ DEFAULT now()
   190→);
   191→
   192→-- 时间线 (重要事件记录)
   193→CREATE TABLE vibe_profile_timeline (
   194→    id UUID PRIMARY KEY,
   195→    user_id UUID NOT NULL,
   196→    event_type VARCHAR(50),         -- dayun_change | goal_completed | milestone
   197→    event_date DATE,
   198→    title VARCHAR(200),
   199→    data JSONB,
   200→    created_at TIMESTAMPTZ DEFAULT now()
   201→);
   202→```
   203→
   204→---
   205→
   206→## 3. 数据访问
   207→
   208→### 3.1 Repository
   209→
   210→```python
   211→class VibeProfileRepository:
   212→    """唯一数据访问层"""
   213→
   214→    # ─────────────────────────────────────────────────────────────
   215→    # 读取
   216→    # ─────────────────────────────────────────────────────────────
   217→    async def get_profile(user_id: UUID) -> Dict
   218→    async def get_identity(user_id: UUID) -> Dict
   219→    async def get_skill_data(user_id: UUID, skill: str) -> Dict
   220→    async def get_life_context(user_id: UUID) -> Dict
   221→
   222→    # ─────────────────────────────────────────────────────────────
   223→    # 写入
   224→    # ─────────────────────────────────────────────────────────────
   225→    async def update_birth_info(user_id: UUID, birth_info: Dict)
   226→    async def update_state(user_id: UUID, state: Dict)
   227→    async def update_skill_data(user_id: UUID, skill: str, data: Dict)
   228→    async def update_preferences(user_id: UUID, preferences: Dict)
   229→
   230→    # ─────────────────────────────────────────────────────────────
   231→    # 生活管理 (goals, tasks, checkins, reminders)
   232→    # ─────────────────────────────────────────────────────────────
   233→    async def add_goal(user_id: UUID, goal: Dict)
   234→    async def update_goal(user_id: UUID, goal_id: str, updates: Dict)
   235→    async def add_task(user_id: UUID, task: Dict)
   236→    async def update_task(user_id: UUID, task_id: str, updates: Dict)
   237→    async def add_checkin(user_id: UUID, date: str, checkin: Dict)
   238→    async def add_reminder(user_id: UUID, reminder: Dict)
   239→    async def update_reminder(user_id: UUID, reminder_id: str, updates: Dict)
   240→
   241→    # ─────────────────────────────────────────────────────────────
   242→    # Proactive 支持
   243→    # ─────────────────────────────────────────────────────────────
   244→    async def get_users_for_push(push_hour: int) -> List[Dict]
   245→    async def get_users_with_reminders(trigger_hour: int) -> List[Dict]
   246→
   247→    # ─────────────────────────────────────────────────────────────
   248→    # 数据维护
   249→    # ─────────────────────────────────────────────────────────────
   250→    async def cleanup_old_checkins(user_id: UUID, keep_days: int = 30)
   251→```
   252→
   253→### 3.2 缓存
   254→
   255→```python
   256→# 简单内存缓存，5分钟 TTL
   257→_cache: Dict[UUID, CacheEntry] = {}
   258→TTL = 300
   259→```
   260→
   261→---
   262→
   263→## 4. Proactive 流程
   264→
   265→### 每日扫描 (04:00)
   266→
   267→```
   268→04:00 凌晨
   269→    │
   270→    ▼
   271→┌─────────────────────────────────────────────────────────────┐
   272→│  ProactiveWorker.daily_scan()                                │
   273→│                                                              │
   274→│  1. 获取所有 push_enabled 用户                               │
   275→│                                                              │
   276→│  2. 为每个用户生成今日内容:                                  │
   277→│     - 检查 subscribed_skills，生成运势推送                   │
   278→│     - 检查 reminders，生成提醒推送                           │
   279→│     - 检查 goals，生成目标进度推送                           │
   280→│                                                              │
   281→│  3. 存入 notifications 表，标记 deliver_hour                 │
   282→│                                                              │
   283→└─────────────────────────────────────────────────────────────┘
   284→
   285→每小时 (00, 01, 02, ...)
   286→    │
   287→    ▼
   288→┌─────────────────────────────────────────────────────────────┐
   289→│  NotificationWorker.deliver()                                │
   290→│                                                              │
   291→│  SELECT * FROM notifications                                 │
   292→│  WHERE deliver_hour = current_hour AND delivered = false     │
   293→│                                                              │
   294→│  投递到用户设备                                              │
   295→└─────────────────────────────────────────────────────────────┘
   296→```
   297→
   298→### reminders 触发逻辑
   299→
   300→```python
   301→# 每日扫描时检查 reminders
   302→for user in users:
   303→    reminders = user["profile"]["life_context"]["reminders"]
   304→    for reminder in reminders:
   305→        if reminder["status"] != "active":
   306→            continue
   307→
   308→        # 检查今天是否应该触发
   309→        if should_trigger_today(reminder):
   310→            # 生成通知，在 trigger_hour 投递
   311→            create_notification(
   312→                user_id=user["id"],
   313→                type="reminder",
   314→                content=reminder["title"],
   315→                deliver_hour=reminder["trigger_hour"]
   316→            )
   317→
   318→def should_trigger_today(reminder):
   319→    if reminder["schedule_type"] == "daily":
   320→        return True
   321→    if reminder["schedule_type"] == "weekly":
   322→        return today.weekday() == reminder.get("trigger_weekday", 0)
   323→    if reminder["schedule_type"] == "once":
   324→        return reminder.get("trigger_date") == today
   325→    return False
   326→```
   327→
   328→---
   329→
   330→## 5. Skill 访问规则
   331→
   332→| Skill | 可读 | 可写 |
   333→|-------|------|------|
   334→| **Core Layer** | | |
   335→| core | 全部 | state, extracted |
   336→| lifecoach | 全部 | state, extracted, life_context |
   337→| mindfulness | 全部 | state |
   338→| **Professional Layer** | | |
   339→| bazi | identity, state | skill_data.bazi |
   340→| zodiac | identity, state | skill_data.zodiac |
   341→| tarot | identity, state | skill_data.tarot |
   342→| career | identity, state, life_context | skill_data.career |
   343→
   344→---
   345→
   346→## 6. 迁移
   347→
   348→### 废弃的表
   349→
   350→迁移后删除：
   351→- `user_data_store`
   352→- `user_reminders`
   353→- `user_skill_subscriptions`
   354→- `user_push_preferences`
   355→- `skill_recommendation_blocks`
   356→
   357→### 迁移脚本
   358→
   359→```sql
   360→-- 1. 合并 subscribed_skills
   361→UPDATE unified_profiles up
   362→SET profile = jsonb_set(
   363→    profile,
   364→    '{preferences,subscribed_skills}',
   365→    COALESCE((
   366→        SELECT jsonb_agg(skill_id)
   367→        FROM user_skill_subscriptions
   368→        WHERE user_id = up.user_id AND status = 'subscribed'
   369→    ), '["core"]'::jsonb)
   370→);
   371→
   372→-- 2. 合并 push_hour
   373→UPDATE unified_profiles up
   374→SET profile = jsonb_set(
   375→    profile,
   376→    '{preferences,push_hour}',
   377→    to_jsonb(COALESCE(
   378→        (SELECT default_push_hour FROM user_push_preferences WHERE user_id = up.user_id),
   379→        8
   380→    ))
   381→);
   382→
   383→-- 3. 合并 goals
   384→UPDATE unified_profiles up
   385→SET profile = jsonb_set(
   386→    profile,
   387→    '{life_context,goals}',
   388→    COALESCE((
   389→        SELECT jsonb_agg(content)
   390→        FROM user_data_store
   391→        WHERE user_id = up.user_id AND data_type = 'goals'
   392→    ), '[]'::jsonb)
   393→);
   394→
   395→-- 4. 合并 tasks (只保留 pending 状态)
   396→UPDATE unified_profiles up
   397→SET profile = jsonb_set(
   398→    profile,
   399→    '{life_context,tasks}',
   400→    COALESCE((
   401→        SELECT jsonb_agg(content)
   402→        FROM user_data_store
   403→        WHERE user_id = up.user_id AND data_type = 'tasks'
   404→          AND content->>'status' = 'pending'
   405→    ), '[]'::jsonb)
   406→);
   407→
   408→-- 5. 合并 checkins (只保留 30 天)
   409→UPDATE unified_profiles up
   410→SET profile = jsonb_set(
   411→    profile,
   412→    '{life_context,checkins}',
   413→    COALESCE((
   414→        SELECT jsonb_object_agg(
   415→            to_char((content->>'date')::date, 'YYYY-MM-DD'),
   416→            content
   417→        )
   418→        FROM user_data_store
   419→        WHERE user_id = up.user_id AND data_type = 'checkins'
   420→          AND (content->>'date')::date >= CURRENT_DATE - 30
   421→    ), '{}'::jsonb)
   422→);
   423→
   424→-- 6. 合并 reminders
   425→UPDATE unified_profiles up
   426→SET profile = jsonb_set(
   427→    profile,
   428→    '{life_context,reminders}',
   429→    COALESCE((
   430→        SELECT jsonb_agg(jsonb_build_object(
   431→            'id', id,
   432→            'type', reminder_type,
   433→            'title', title,
   434→            'schedule_type', schedule_type,
   435→            'trigger_hour', EXTRACT(HOUR FROM next_trigger_at)::int,
   436→            'status', status,
   437→            'goal_id', metadata->>'goal_id'
   438→        ))
   439→        FROM user_reminders
   440→        WHERE user_id = up.user_id AND status = 'active'
   441→    ), '[]'::jsonb)
   442→);
   443→```
   444→
   445→---
   446→
   447→## 7. 数据大小控制
   448→
   449→### 预估大小
   450→
   451→| 字段 | 预估大小 |
   452→|------|---------|
   453→| account | 200 bytes |
   454→| identity | 500 bytes |
   455→| state | 200 bytes |
   456→| preferences | 300 bytes |
   457→| skill_data | 5 KB |
   458→| extracted | 500 bytes |
   459→| life_context.goals (10个) | 2 KB |
   460→| life_context.tasks (20个) | 2 KB |
   461→| life_context.checkins (30天) | 3 KB |
   462→| life_context.reminders (10个) | 1 KB |
   463→| **总计** | **~15 KB** |
   464→
   465→### 限制规则
   466→
   467→```python
   468→MAX_GOALS = 20
   469→MAX_TASKS = 50
   470→MAX_CHECKIN_DAYS = 30
   471→MAX_REMINDERS = 20
   472→MAX_FACTS = 50
   473→
   474→# 写入时检查
   475→async def add_goal(user_id, goal):
   476→    profile = await get_profile(user_id)
   477→    goals = profile["life_context"].get("goals", [])
   478→    if len(goals) >= MAX_GOALS:
   479→        raise LimitExceeded("最多支持 20 个目标")
   480→    # ...
   481→```
   482→
   483→---
   484→
   485→## 8. API
   486→
   487→### 内部 Python API
   488→
   489→```python
   490→# 读取
   491→profile = await VibeProfileRepository.get_profile(user_id)
   492→goals = profile["life_context"]["goals"]
   493→
   494→# 写入
   495→await VibeProfileRepository.add_goal(user_id, {
   496→    "title": "学习英语",
   497→    "category": "learning",
   498→    "status": "active"
   499→})
   500→
   501→await VibeProfileRepository.add_checkin(user_id, "2026-01-19", {
   502→    "mood": 8,
   503→    "energy": 7,
   504→    "notes": "今天很棒"
   505→})
   506→```
   507→
   508→### HTTP API
   509→
   510→```
   511→GET  /api/v1/profile/summary       # 用户认知摘要
   512→GET  /api/v1/profile/goals         # 目标列表
   513→POST /api/v1/profile/goals         # 添加目标
   514→PUT  /api/v1/profile/goals/:id     # 更新目标
   515→POST /api/v1/profile/checkins      # 打卡
   516→GET  /api/v1/profile/reminders     # 提醒列表
   517→POST /api/v1/profile/reminders     # 添加提醒
   518→```
   519→
   520→---
   521→
   522→## 9. UserDataSpace - 统一数据管理
   523→
   524→### 9.1 领域划分
   525→
   526→```
   527→┌─────────────────────────────────────────────────────────────────────┐
   528→│                         UserDataSpace                                │
   529→├─────────────────────────────────────────────────────────────────────┤
   530→│                                                                      │
   531→│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐      │
   532→│  │   VibeProfile   │  │   Operational   │  │    Billing      │      │
   533→│  │   (画像数据)     │  │   (操作数据)     │  │   (财务数据)    │      │
   534→│  ├─────────────────┤  ├─────────────────┤  ├─────────────────┤      │
   535→│  │ unified_profiles│  │ conversations   │  │ subscriptions   │      │
   536→│  │                 │  │ messages        │  │ payments        │      │
   537→│  │                 │  │ notifications   │  │                 │      │
   538→│  │                 │  │ skill_usage_log │  │                 │      │
   539→│  └─────────────────┘  └─────────────────┘  └─────────────────┘      │
   540→│                                                                      │
   541→│  ┌─────────────────┐                                                 │
   542→│  │    Content      │                                                 │
   543→│  │   (内容快照)     │                                                 │
   544→│  ├─────────────────┤                                                 │
   545→│  │ reports         │                                                 │
   546→│  │ relationships   │                                                 │
   547→│  └─────────────────┘                                                 │
   548→│                                                                      │
   549→└─────────────────────────────────────────────────────────────────────┘
   550→```
   551→
   552→### 9.2 统一管理入口
   553→
   554→```python
   555→class UserDataSpace:
   556→    """用户数据空间 - 统一管理入口"""
   557→
   558→    profile: VibeProfileRepository      # 画像数据
   559→    conversations: ConversationRepository  # 对话
   560→    content: ContentRepository          # 快照内容
   561→    billing: BillingRepository          # 财务
   562→
   563→    async def delete_user_data(user_id: UUID) -> Dict:
   564→        """账户删除时，清理所有数据"""
   565→        return {
   566→            "profile": await self.profile.delete(user_id),
   567→            "conversations": await self.conversations.delete_all(user_id),
   568→            "content": await self.content.delete_all(user_id),
   569→            "billing": "retained",  # 财务数据保留 (法规)
   570→        }
   571→
   572→    async def export_user_data(user_id: UUID) -> Dict:
   573→        """GDPR 数据导出"""
   574→        return {
   575→            "profile": await self.profile.get_profile(user_id),
   576→            "conversations": await self.conversations.export(user_id),
   577→            "content": await self.content.export(user_id),
   578→            "billing": await self.billing.export(user_id),
   579→        }
   580→
   581→    async def get_storage_usage(user_id: UUID) -> Dict:
   582→        """存储用量统计"""
   583→        return {
   584→            "profile_kb": ...,
   585→            "messages_count": ...,
   586→            "reports_count": ...,
   587→        }
   588→```
   589→
   590→### 9.3 数据生命周期
   591→
   592→| 领域 | 默认保留 | 用户可选 | 清理规则 |
   593→|------|---------|---------|---------|
   594→| **VibeProfile** | 永久 | - | checkins 保留 30 天 |
   595→| **Conversations** | 1 年 | 1年 / 3年 / 永久 | 按用户设置清理 |
   596→| **Content** | 永久 | 可手动删除 | - |
   597→| **Billing** | 7 年 | 不可更改 | 法规要求 |
   598→| **Logs** | 90 天 | - | 滚动清理 |
   599→| **Notifications** | 30 天 | - | 已读 30 天后清理 |
   600→
   601→### 9.4 对话清理逻辑
   602→
   603→```python
   604→async def cleanup_conversations(user_id: UUID):
   605→    """按用户设置清理对话"""
   606→    profile = await VibeProfileRepository.get_profile(user_id)
   607→    retention = profile.get("preferences", {}).get("data_retention", {})
   608→    conversations_retention = retention.get("conversations", "1y")
   609→
   610→    if conversations_retention == "forever":
   611→        return  # 不清理
   612→
   613→    days = {"1y": 365, "3y": 1095}[conversations_retention]
   614→    cutoff = datetime.now() - timedelta(days=days)
   615→
   616→    await ConversationRepository.archive_before(user_id, cutoff)
   617→```
   618→
   619→---
   620→
   621→## 附录：设计原则
   622→
   623→1. **WHO vs WHAT** - VibeProfile 存画像 (WHO)，操作数据 (WHAT) 独立表
   624→2. **Single JSONB** - 画像数据一张表 (`unified_profiles.profile`)
   625→3. **Daily Scan** - 每天凌晨扫描，按小时投递
   626→4. **30 Days Limit** - checkins 等时间序列数据只保留 30 天
   627→5. **User Control** - 对话保留策略用户可选 (1年/3年/永久)
   628→6. **Convention > Code** - 访问规则靠 Review 保证
   629→7. **Simple Cache** - 内存缓存，5分钟 TTL
   630→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
