     1â†’"use client";
     2â†’
     3â†’/**
     4â†’ * ChatContainer - v5.2 æ€§èƒ½ä¼˜åŒ–ç‰ˆ
     5â†’ *
     6â†’ * ä¼˜åŒ–ç‚¹:
     7â†’ * 1. ä½¿ç”¨ content-visibility ä¼˜åŒ–é•¿æ¶ˆæ¯åˆ—è¡¨ (Vercel rule: rendering-content-visibility)
     8â†’ * 2. Memoize ChatEmptyState ç»„ä»¶ (Vercel rule: rerender-extract-component)
     9â†’ * 3. ä½¿ç”¨ç¼“å­˜çš„ localStorage å·¥å…· (Vercel rule: js-cache-storage)
    10â†’ */
    11â†’
    12â†’import { useRef, useEffect, useMemo, useCallback, useState, memo } from "react";
    13â†’import type { Message } from "ai/react";
    14â†’import { toast } from "sonner";
    15â†’import { ChatMessage } from "./ChatMessage";
    16â†’import { ChatInput } from "./ChatInput";
    17â†’import { SmartSuggestions } from "./SmartSuggestions";
    18â†’import { InsightCard, InsightType } from "@/components/insight/InsightCard";
    19â†’import { VibeGlyph, BreathAura, type SkillType } from "@/components/core";
    20â†’import { DailyGreeting } from "@/components/greeting/DailyGreeting";
    21â†’import { BentoDashboard } from "./BentoDashboard";
    22â†’import { useVibeChat, type SkillId } from "@/hooks/useVibeChat";
    23â†’import { getLocalStorageJSON, getLocalStorage, setLocalStorage } from "@/utils/storage";
    24â†’import { useBentoDashboardData } from "@/hooks/useBentoDashboardData";
    25â†’import SkillIntroCard from "@/skills/shared/SkillIntroCard";
    26â†’import { useSkillIntro, useMarkFirstUse } from "@/skills/shared/SkillIntroCard/hooks/useSkillIntro";
    27â†’import type { IntroCardAction } from "@/skills/shared/SkillIntroCard/types";
    28â†’import type { DashboardDTO } from "@/types/dashboard";
    29â†’
    30â†’interface InsightData {
    31â†’  id: string;
    32â†’  insight_type: InsightType;
    33â†’  title: string;
    34â†’  content: string;
    35â†’}
    36â†’
    37â†’/**
    38â†’ * Extract text content from AI SDK Message
    39â†’ */
    40â†’function getMessageContent(message: Message): string {
    41â†’  return message.content || '';
    42â†’}
    43â†’
    44â†’/**
    45â†’ * UUID ç”Ÿæˆå‡½æ•°ï¼ˆå…¼å®¹ SSR å’Œä¸æ”¯æŒ crypto.randomUUID çš„ç¯å¢ƒï¼‰
    46â†’ */
    47â†’function generateUUID(): string {
    48â†’  if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
    49â†’    return crypto.randomUUID();
    50â†’  }
    51â†’  // Fallback: ä½¿ç”¨ crypto.getRandomValues
    52â†’  if (typeof crypto !== "undefined" && typeof crypto.getRandomValues === "function") {
    53â†’    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    54â†’      const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15) >> (c === "x" ? 0 : 3);
    55â†’      return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
    56â†’    });
    57â†’  }
    58â†’  // Fallback: Math.random
    59â†’  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    60â†’    const r = (Math.random() * 16) | 0;
    61â†’    return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
    62â†’  });
    63â†’}
    64â†’
    65â†’export type VoiceMode = "warm" | "sarcastic" | "wise";
    66â†’
    67â†’export interface ChatContainerProps {
    68â†’  /**
    69â†’   * Skill ID - å¯é€‰
    70â†’   * - ä¼ å…¥æ—¶ï¼šåç«¯ç›´æ¥ä½¿ç”¨è¯¥ skill
    71â†’   * - ä¸ä¼ æ—¶ï¼šåç«¯ CoreAgent é€šè¿‡ LLM è‡ªåŠ¨è·¯ç”±
    72â†’   */
    73â†’  skillId?: string;
    74â†’  /**
    75â†’   * Scenario/Rule ID - å¯é€‰
    76â†’   * - ä¼ å…¥æ—¶ï¼šåç«¯ç›´æ¥åŠ è½½å¯¹åº”çš„ Rule æ–‡ä»¶
    77â†’   * - ä¸ä¼ æ—¶ï¼šåç«¯æ ¹æ® tags åŒ¹é…æˆ–ä½¿ç”¨é»˜è®¤ scenario
    78â†’   */
    79â†’  scenario?: string;
    80â†’  /**
    81â†’   * ç”¨äº UI å±•ç¤ºçš„ skillï¼ˆä¸»é¢˜ã€ç©ºçŠ¶æ€ç­‰ï¼‰
    82â†’   * å½“ skillId ä¸ä¼ æ—¶ï¼Œæ­¤å­—æ®µä»å¯ç”¨äº UI å±•ç¤º
    83â†’   */
    84â†’  skill?: SkillType;
    85â†’  conversationId?: string;
    86â†’  voiceMode?: VoiceMode;
    87â†’  onConversationStart?: (id: string) => void;
    88â†’  /**
    89â†’   * ä» URL ä¼ å…¥çš„åˆå§‹æ¶ˆæ¯ï¼ˆå¦‚ä»é€šçŸ¥è·³è½¬ï¼‰
    90â†’   */
    91â†’  initialPrompt?: string | null;
    92â†’  /**
    93â†’   * åˆå§‹æ¶ˆæ¯å‘é€åçš„å›è°ƒ
    94â†’   */
    95â†’  onInitialPromptSent?: () => void;
    96â†’  /**
    97â†’   * Dashboard æ•°æ®ï¼ˆç”¨äºç©ºçŠ¶æ€ï¼‰
    98â†’   */
    99â†’  dashboardData?: DashboardDTO | null;
   100â†’  /**
   101â†’   * Dashboard æ•°æ®åŠ è½½çŠ¶æ€
   102â†’   */
   103â†’  isDashboardLoading?: boolean;
   104â†’  /**
   105â†’   * å¼ºåˆ¶æ˜¾ç¤º Intro Cardï¼ˆä» Discover é¡µé¢è¿›å…¥æ—¶ä½¿ç”¨ï¼‰
   106â†’   * å½“ä¸º true æ—¶ï¼Œå…³é—­ Intro Card ä¸ä¼šæ ‡è®° first_use
   107â†’   */
   108â†’  forceIntro?: boolean;
   109â†’  /**
   110â†’   * ç­¾åˆ°å›è°ƒ
   111â†’   */
   112â†’  onCheckIn?: () => Promise<void>;
   113â†’  /**
   114â†’   * æ æ†æ‰“å‹¾å›è°ƒ
   115â†’   */
   116â†’  onToggleLever?: (leverId: string) => Promise<void>;
   117â†’  /**
   118â†’   * å¤§çŸ³å¤´æ‰“å‹¾å›è°ƒ
   119â†’   */
   120â†’  onToggleRock?: (rockId: string) => Promise<void>;
   121â†’}
   122â†’
   123â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   124â†’// ChatEmptyState - LUMINOUS PAPER Design System
   125â†’// ç©ºçŠ¶æ€ï¼šå±…ä¸­ VibeGlyph + æŠ€èƒ½æ„ŸçŸ¥æ–‡æ¡ˆ + å‘¼å¸å…‰æ™•
   126â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   127â†’
   128â†’const SKILL_EMPTY_STATE: Record<SkillType, { title: string; subtitle: string }> = {
   129â†’  bazi: {
   130â†’    title: "æ¢ç´¢ä½ çš„å‘½ç†",
   131â†’    subtitle: "åˆ†äº«ä½ çš„ç”Ÿè¾°ï¼Œå¼€å¯å…«å­—è§£è¯»ä¹‹æ—…",
   132â†’  },
   133â†’  zodiac: {
   134â†’    title: "å€¾å¬æ˜Ÿè¾°çš„å£°éŸ³",
   135â†’    subtitle: "è®©æ˜Ÿç›˜ä¸ºä½ æ­ç¤ºå®‡å®™çš„å¯†è¯­",
   136â†’  },
   137â†’  mbti: {
   138â†’    title: "å‘ç°çœŸå®çš„è‡ªå·±",
   139â†’    subtitle: "é€šè¿‡å¯¹è¯ï¼Œæ¢ç´¢ä½ çš„äººæ ¼ç‰¹è´¨",
   140â†’  },
   141â†’  attach: {
   142â†’    title: "ç†è§£ä½ çš„ä¾æ‹æ¨¡å¼",
   143â†’    subtitle: "æ¢ç´¢äº²å¯†å…³ç³»ä¸­çš„è‡ªæˆ‘",
   144â†’  },
   145â†’  career: {
   146â†’    title: "è§„åˆ’ä½ çš„èŒä¸šè“å›¾",
   147â†’    subtitle: "è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä½ çš„èŒä¸šå‘å±•æ–¹å‘",
   148â†’  },
   149â†’  lifecoach: {
   150â†’    title: "å¼€å¯äººç”Ÿæ•™ç»ƒä¹‹æ—…",
   151â†’    subtitle: "ç§‘å­¦æ–¹æ³•ï¼ŒåŠ©ä½ çªç ´ç“¶é¢ˆï¼Œé‡å¡‘äººç”Ÿ",
   152â†’  },
   153â†’};
   154â†’
   155â†’// Quick prompts for each skill with icons and categories
   156â†’interface QuickPromptItem {
   157â†’  icon: string;
   158â†’  category: string;
   159â†’  question: string;
   160â†’  gradient: string;
   161â†’}
   162â†’
   163â†’const SKILL_QUICK_PROMPTS: Record<SkillType, QuickPromptItem[]> = {
   164â†’  bazi: [
   165â†’    { icon: "ğŸ‚", category: "ç”Ÿè¾°ä¿¡æ¯", question: "æˆ‘æ˜¯1990å¹´5æœˆ15æ—¥æ—©ä¸Š8ç‚¹å‡ºç”Ÿçš„", gradient: "from-blue-500/10 to-cyan-500/10" },
   166â†’    { icon: "ğŸ“ˆ", category: "è¿åŠ¿åˆ†æ", question: "å¸®æˆ‘åˆ†æä»Šå¹´çš„è¿åŠ¿", gradient: "from-purple-500/10 to-pink-500/10" },
   167â†’    { icon: "ğŸ’¼", category: "äº‹ä¸šå‘å±•", question: "æˆ‘çš„äº‹ä¸šè¿å¦‚ä½•ï¼Ÿ", gradient: "from-orange-500/10 to-red-500/10" },
   168â†’    { icon: "â°", category: "æ—¶æœºé€‰æ‹©", question: "ä»€ä¹ˆæ—¶å€™é€‚åˆåšé‡å¤§å†³å®šï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   169â†’  ],
   170â†’  zodiac: [
   171â†’    { icon: "â­", category: "è¿åŠ¿æŸ¥è¯¢", question: "æˆ‘æ˜¯åŒå­åº§ï¼Œå¸®æˆ‘çœ‹çœ‹æœ¬å‘¨è¿åŠ¿", gradient: "from-purple-500/10 to-pink-500/10" },
   172â†’    { icon: "ğŸŒ™", category: "æ˜Ÿç›˜è§£è¯»", question: "æˆ‘çš„å¤ªé˜³æ˜Ÿåº§å’Œä¸Šå‡æ˜Ÿåº§æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ", gradient: "from-indigo-500/10 to-purple-500/10" },
   173â†’    { icon: "ğŸ’•", category: "å…³ç³»åŒ¹é…", question: "åŒå­åº§å’Œä»€ä¹ˆæ˜Ÿåº§æœ€é…ï¼Ÿ", gradient: "from-rose-500/10 to-pink-500/10" },
   174â†’    { icon: "ğŸŒ€", category: "æ˜Ÿè±¡å½±å“", question: "æ°´é€†å¯¹æˆ‘æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ", gradient: "from-blue-500/10 to-cyan-500/10" },
   175â†’  ],
   176â†’  mbti: [
   177â†’    { icon: "ğŸ”", category: "ç±»å‹æµ‹è¯•", question: "å¸®æˆ‘æµ‹æµ‹æˆ‘çš„MBTIç±»å‹", gradient: "from-blue-500/10 to-cyan-500/10" },
   178â†’    { icon: "ğŸ’¼", category: "èŒä¸šå»ºè®®", question: "INFPé€‚åˆä»€ä¹ˆèŒä¸šï¼Ÿ", gradient: "from-orange-500/10 to-amber-500/10" },
   179â†’    { icon: "ğŸ‘¥", category: "äººé™…å…³ç³»", question: "æˆ‘æ˜¯INTJï¼Œå¦‚ä½•æ”¹å–„äººé™…å…³ç³»ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   180â†’    { icon: "âš¡", category: "ç±»å‹å¯¹æ¯”", question: "Eäººå’ŒIäººæœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ", gradient: "from-purple-500/10 to-pink-500/10" },
   181â†’  ],
   182â†’  attach: [
   183â†’    { icon: "ğŸ”", category: "ç±»å‹åˆ†æ", question: "å¸®æˆ‘åˆ†ææˆ‘çš„ä¾æ‹ç±»å‹", gradient: "from-blue-500/10 to-cyan-500/10" },
   184â†’    { icon: "ğŸ’‘", category: "å…³ç³»å»ºè®¾", question: "å›é¿å‹ä¾æ‹å¦‚ä½•å»ºç«‹äº²å¯†å…³ç³»ï¼Ÿ", gradient: "from-rose-500/10 to-pink-500/10" },
   185â†’    { icon: "ğŸ›¡ï¸", category: "å†…å¿ƒæ¢ç´¢", question: "ä¸ºä»€ä¹ˆæˆ‘æ€»æ˜¯å®³æ€•è¢«æŠ›å¼ƒï¼Ÿ", gradient: "from-amber-500/10 to-orange-500/10" },
   186â†’    { icon: "ğŸ’š", category: "è‡ªæˆ‘ç–—æ„ˆ", question: "å¦‚ä½•æ²»æ„ˆç«¥å¹´çš„æƒ…æ„Ÿåˆ›ä¼¤ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   187â†’  ],
   188â†’  career: [
   189â†’    { icon: "ğŸ¯", category: "èŒä¸šè§„åˆ’", question: "æˆ‘è¯¥å¦‚ä½•è§„åˆ’èŒä¸šå‘å±•ï¼Ÿ", gradient: "from-blue-500/10 to-cyan-500/10" },
   190â†’    { icon: "ğŸš€", category: "æ–¹å‘é€‰æ‹©", question: "æˆ‘é€‚åˆåˆ›ä¸šè¿˜æ˜¯æ‰“å·¥ï¼Ÿ", gradient: "from-orange-500/10 to-red-500/10" },
   191â†’    { icon: "ğŸ’ª", category: "é¢è¯•æŠ€å·§", question: "å¦‚ä½•åœ¨é¢è¯•ä¸­å±•ç°è‡ªå·±ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   192â†’    { icon: "ğŸ”„", category: "èŒä¸šè½¬å‹", question: "è½¬è¡Œéœ€è¦è€ƒè™‘ä»€ä¹ˆï¼Ÿ", gradient: "from-purple-500/10 to-pink-500/10" },
   193â†’  ],
   194â†’  lifecoach: [
   195â†’    { icon: "ğŸ¯", category: "ç›®æ ‡è®¾å®š", question: "æˆ‘æƒ³æ‰¾åˆ°äººç”Ÿæ–¹å‘ï¼Œä½†ä¸çŸ¥é“ä»å“ªå¼€å§‹", gradient: "from-red-500/10 to-pink-500/10" },
   196â†’    { icon: "ğŸ”„", category: "çªç ´ç“¶é¢ˆ", question: "æˆ‘æ„Ÿè§‰å¡ä½äº†ï¼Œæƒ³è¦çªç ´ç°çŠ¶", gradient: "from-purple-500/10 to-indigo-500/10" },
   197â†’    { icon: "âš¡", category: "ä¹ æƒ¯å…»æˆ", question: "å¦‚ä½•å»ºç«‹é«˜æ•ˆçš„æ—¥å¸¸ä¹ æƒ¯ï¼Ÿ", gradient: "from-orange-500/10 to-amber-500/10" },
   198â†’    { icon: "ğŸ’¡", category: "ä»·å€¼åˆ›é€ ", question: "å¦‚ä½•æŠŠå…´è¶£å˜æˆäº‹ä¸šï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   199â†’  ],
   200â†’};
   201â†’
   202â†’// API calls now go through Next.js API routes
   203â†’
   204â†’// æœ¬åœ° fallback æ•°æ®ç”Ÿæˆ
   205â†’function getLocalGreetingData(skill: SkillType) {
   206â†’  const now = new Date();
   207â†’  const hour = now.getHours();
   208â†’  const month = now.getMonth();
   209â†’  const day = now.getDate();
   210â†’  const isoDate = now.toISOString().slice(0, 10);
   211â†’
   212â†’  // ç¡®å®šæ—¶æ®µ
   213â†’  type TimeOfDay = "dawn" | "morning" | "afternoon" | "evening" | "night";
   214â†’  let timeOfDay: TimeOfDay = "morning";
   215â†’  let greeting = "æ–°çš„ä¸€å¤©å¼€å§‹äº†";
   216â†’
   217â†’  if (hour >= 5 && hour < 7) {
   218â†’    timeOfDay = "dawn";
   219â†’    greeting = "æ™¨å…‰ç†¹å¾®";
   220â†’  } else if (hour >= 7 && hour < 12) {
   221â†’    timeOfDay = "morning";
   222â†’    greeting = "æ„¿ä½ èƒ½é‡æ»¡æ»¡";
   223â†’  } else if (hour >= 12 && hour < 18) {
   224â†’    timeOfDay = "afternoon";
   225â†’    greeting = "ä¿æŒä¸“æ³¨";
   226â†’  } else if (hour >= 18 && hour < 21) {
   227â†’    timeOfDay = "evening";
   228â†’    greeting = "è¾›è‹¦ä¸€å¤©äº†";
   229â†’  } else {
   230â†’    timeOfDay = "night";
   231â†’    greeting = "å¤œæ·±äº†ï¼Œæ—©ç‚¹ä¼‘æ¯";
   232â†’  }
   233â†’
   234â†’  const solarTerms = [
   235â†’    "å°å¯’", "å¤§å¯’", "ç«‹æ˜¥", "é›¨æ°´", "æƒŠè›°", "æ˜¥åˆ†",
   236â†’    "æ¸…æ˜", "è°·é›¨", "ç«‹å¤", "å°æ»¡", "èŠ’ç§", "å¤è‡³",
   237â†’    "å°æš‘", "å¤§æš‘", "ç«‹ç§‹", "å¤„æš‘", "ç™½éœ²", "ç§‹åˆ†",
   238â†’    "å¯’éœ²", "éœœé™", "ç«‹å†¬", "å°é›ª", "å¤§é›ª", "å†¬è‡³",
   239â†’  ];
   240â†’  const termIdx = month * 2 + (day >= 15 ? 1 : 0);
   241â†’  const solarTerm = solarTerms[termIdx % 24];
   242â†’
   243â†’  const seasonTips: Record<string, string> = {
   244â†’    å°å¯’: "å†¬è—æ—¶èŠ‚ï¼Œåˆ©äºå›é¡¾ä¸è§„åˆ’", å¤§å¯’: "ä¸¥å¯’ä¹‹é™…ï¼Œè“„åŠ›å¾…å‘",
   245â†’    ç«‹æ˜¥: "ä¸‡ç‰©å¤è‹ï¼Œé€‚åˆå¯åŠ¨æ–°è®¡åˆ’", é›¨æ°´: "æ¶¦ç‰©æ— å£°ï¼Œé™å¿ƒæ»‹å…»",
   246â†’    æƒŠè›°: "æ˜¥é›·æƒŠé†’ï¼Œè¡ŒåŠ¨èµ·æ¥", æ˜¥åˆ†: "æ˜¼å¤œå¹³åˆ†ï¼Œè°ƒå’Œèº«å¿ƒ",
   247â†’    æ¸…æ˜: "å¤©æ¸…åœ°æ˜ï¼Œæ•´ç†æ€ç»ª", è°·é›¨: "é›¨ç”Ÿç™¾è°·ï¼Œæ’­ç§å¸Œæœ›",
   248â†’    ç«‹å¤: "å¤æ°”æ¸ç››ï¼Œä¿æŒæ´»åŠ›", å°æ»¡: "å°æœ‰æ‰€æˆï¼Œç»§ç»­åŠªåŠ›",
   249â†’    èŠ’ç§: "æ’­ç§æ”¶è·ï¼Œå‹¤å‹‰ä¸æ‡ˆ", å¤è‡³: "é˜³æ°”é¼ç››ï¼Œé€‚åº¦ä¼‘æ¯",
   250â†’    å°æš‘: "æš‘æ°”åˆå‡ï¼Œæ¸…å¿ƒå®ç¥", å¤§æš‘: "é…·æš‘éš¾è€ï¼Œé™ä»¥å…»å¿ƒ",
   251â†’    ç«‹ç§‹: "ç§‹æ„æ¸èµ·ï¼Œæ”¶è·æ—¶èŠ‚", å¤„æš‘: "æš‘æ°”æ¸æ¶ˆï¼Œè°ƒæ•´èŠ‚å¥",
   252â†’    ç™½éœ²: "ç§‹å‡‰æ¸æµ“ï¼Œæ”¶æ•›å¿ƒç¥", ç§‹åˆ†: "ç§‹é«˜æ°”çˆ½ï¼Œå¹³è¡¡å·¥ä½œä¸ç”Ÿæ´»",
   253â†’    å¯’éœ²: "éœ²æ°´æ¸å¯’ï¼Œæ³¨æ„ä¿å…»", éœœé™: "éœœé™æ°´æ³½ï¼Œæ²‰æ·€ç§¯ç´¯",
   254â†’    ç«‹å†¬: "å†¬å­£æ¥ä¸´ï¼Œå‚¨å¤‡èƒ½é‡", å°é›ª: "é›ªèŠ±åˆé™ï¼Œå†…çœæ—¶åˆ»",
   255â†’    å¤§é›ª: "ç‘é›ªå…†ä¸°ï¼Œé™å¾…æ¥å¹´", å†¬è‡³: "ä¸€é˜³åˆç”Ÿï¼Œå¦ææ³°æ¥",
   256â†’  };
   257â†’
   258â†’  const baziHints: Record<string, string> = {
   259â†’    å°å¯’: "æ°´æ—ºä¹‹å­£ï¼Œåˆ©äºæ€è€ƒä¸è§„åˆ’", å¤§å¯’: "æ°´æ°”æœ€ç››ï¼Œé€‚åˆå†…çœæ²‰æ·€",
   260â†’    ç«‹æ˜¥: "æœ¨æ°”åˆç”Ÿï¼Œå®œå¼€å¯æ–°äº‹ä¸š", æ˜¥åˆ†: "æœ¨æ°”æ—ºç››ï¼Œé€‚åˆæ‹“å±•äººè„‰",
   261â†’    ç«‹å¤: "ç«æ°”æ¸å‡ï¼Œåˆ©äºè¡¨è¾¾å±•ç°", å¤è‡³: "ç«æ°”æ­£ç››ï¼Œæ³¨æ„å¹³è¡¡",
   262â†’    ç«‹ç§‹: "é‡‘æ°”åˆç”Ÿï¼Œé€‚åˆå†³æ–­å–èˆ", ç§‹åˆ†: "é‡‘æ°”æ—ºç››ï¼Œåˆ©äºæ”¶è·æˆæœ",
   263â†’    ç«‹å†¬: "æ°´æ°”åˆç”Ÿï¼Œå®œä¼‘å…»ç”Ÿæ¯", å†¬è‡³: "ä¸€é˜³å¤å§‹ï¼Œåšç§¯è–„å‘",
   264â†’  };
   265â†’
   266â†’  const dateStr = `${month + 1}æœˆ${day}æ—¥`;
   267â†’  const seedStr = `${isoDate}:${skill}:${solarTerm}:${timeOfDay}`;
   268â†’  let hash = 0;
   269â†’  for (let i = 0; i < seedStr.length; i += 1) {
   270â†’    hash = (hash * 31 + seedStr.charCodeAt(i)) % 100000;
   271â†’  }
   272â†’  const fortuneScore = Math.max(32, Math.min(92, 42 + (hash % 51)));
   273â†’  const fortuneHint = skill === "bazi"
   274â†’    ? (baziHints[solarTerm] || "ä»Šå¤©é€‚åˆç¨³ä½èŠ‚å¥ï¼ŒæŠŠåŠ›æ°”ç”¨åœ¨å…³é”®å¤„ã€‚")
   275â†’    : (seasonTips[solarTerm] || "ä»Šå¤©é€‚åˆæŠŠæ³¨æ„åŠ›æ”¶å›åˆ°è‡ªå·±èº«ä¸Šã€‚");
   276â†’
   277â†’  const actionText =
   278â†’    timeOfDay === "dawn" || timeOfDay === "morning"
   279â†’      ? "å†™ä¸‹ä»Šå¤©æœ€é‡è¦çš„ä¸€ä»¶äº‹ï¼Œå¹¶ç”¨ 25 åˆ†é’Ÿå¯åŠ¨å®ƒ"
   280â†’      : timeOfDay === "afternoon"
   281â†’        ? "æŠŠä¸€ä»¶æ‚¬è€Œæœªå†³çš„å°äº‹æ”¶å°¾ï¼Œç»™è‡ªå·±ä¸€ä¸ªç¡®å®šæ„Ÿ"
   282â†’        : timeOfDay === "evening"
   283â†’          ? "ç”¨ 10 åˆ†é’Ÿå¤ç›˜ä»Šå¤©ï¼šåšå¯¹äº†ä»€ä¹ˆã€ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆ"
   284â†’          : "å…³æœºå‰å†™ä¸€å¥æ„Ÿè°¢ï¼Œç»™å¤§è„‘ä¸€ä¸ªæŸ”è½¯çš„ç»“å°¾";
   285â†’
   286â†’  return {
   287â†’    greeting, solarTerm, timeOfDay, date: dateStr, isoDate,
   288â†’    todayTip: seasonTips[solarTerm] || "ä¸“æ³¨å½“ä¸‹ï¼Œç¨³æ­¥å‰è¡Œ",
   289â†’    baziHint: skill === "bazi" ? (baziHints[solarTerm] || null) : null,
   290â†’    fortuneScore, fortuneHint, actionText, isFromApi: false,
   291â†’  };
   292â†’}
   293â†’
   294â†’// ç”Ÿæˆå½“æ—¥é—®å€™æ•°æ® - ä½¿ç”¨æœ¬åœ°ç®—æ³•ç”Ÿæˆ
   295â†’// NOTE: åŸ API è°ƒç”¨å·²ç§»é™¤ï¼Œå› åç«¯ /api/v1/fortune/greeting æœªå®ç°
   296â†’// æœ¬åœ°ç®—æ³•å·²æä¾›å®Œæ•´åŠŸèƒ½ï¼šèŠ‚æ°”ã€æ—¶è¾°ã€è¿åŠ¿è¯„åˆ†ç­‰
   297â†’function useDailyGreeting(skill: SkillType) {
   298â†’  // åˆå§‹çŠ¶æ€ä½¿ç”¨é»˜è®¤å€¼ï¼Œé¿å… hydration mismatch
   299â†’  const [data, setData] = useState(() => ({
   300â†’    greeting: "æ–°çš„ä¸€å¤©å¼€å§‹äº†",
   301â†’    timeOfDay: "morning" as "dawn" | "morning" | "afternoon" | "evening" | "night",
   302â†’    solarTerm: "ç«‹æ˜¥",
   303â†’    isoDate: new Date().toISOString().slice(0, 10),
   304â†’    todayTip: "ä¸“æ³¨å½“ä¸‹ï¼Œç¨³æ­¥å‰è¡Œ",
   305â†’    baziHint: null as string | null,
   306â†’    fortuneScore: 75,
   307â†’    fortuneHint: "è¿åŠ¿å¹³ç¨³",
   308â†’    actionText: "ä»Šæ—¥å®œ",
   309â†’    isFromApi: false,
   310â†’  }));
   311â†’  const [loading] = useState(false);
   312â†’
   313â†’  // åœ¨å®¢æˆ·ç«¯è®¡ç®—å®é™…çš„é—®å€™æ•°æ®
   314â†’  useEffect(() => {
   315â†’    setData(getLocalGreetingData(skill));
   316â†’  }, [skill]);
   317â†’
   318â†’  return { ...data, loading };
   319â†’}
   320â†’
   321â†’// Memoized ChatEmptyState (Vercel rule: rerender-extract-component)
   322â†’const ChatEmptyState = memo(function ChatEmptyState({ skill, onQuickPrompt }: { skill: SkillType; onQuickPrompt?: (prompt: string) => void }) {
   323â†’  const config = SKILL_EMPTY_STATE[skill] || SKILL_EMPTY_STATE.bazi;
   324â†’  const quickPrompts = SKILL_QUICK_PROMPTS[skill] || SKILL_QUICK_PROMPTS.bazi;
   325â†’  const dailyData = useDailyGreeting(skill);
   326â†’  const actionKey = useMemo(
   327â†’    () => `vibelife-daily-action:${skill}:${dailyData.isoDate}`,
   328â†’    [skill, dailyData.isoDate]
   329â†’  );
   330â†’  const [actionCompleted, setActionCompleted] = useState(false);
   331â†’
   332â†’  useEffect(() => {
   333â†’    if (typeof window === "undefined") return;
   334â†’    // Use cached localStorage (Vercel rule: js-cache-storage)
   335â†’    setActionCompleted(getLocalStorage(actionKey) === "1");
   336â†’  }, [actionKey]);
   337â†’
   338â†’  const toggleAction = useCallback(() => {
   339â†’    setActionCompleted((prev) => {
   340â†’      const next = !prev;
   341â†’      // Use cached localStorage (Vercel rule: js-cache-storage)
   342â†’      setLocalStorage(actionKey, next ? "1" : "0");
   343â†’      return next;
   344â†’    });
   345â†’  }, [actionKey]);
   346â†’
   347â†’  const shareText = useMemo(() => {
   348â†’    const term = dailyData.solarTerm ? ` Â· ${dailyData.solarTerm}` : "";
   349â†’    return [
   350â†’      `VibeLife${term} Â· ${dailyData.isoDate}`,
   351â†’      dailyData.greeting,
   352â†’      `è¿åŠ¿æŒ‡æ•°ï¼š${dailyData.fortuneScore}/100`,
   353â†’      `ä»Šæ—¥ä¸€æ­¥ï¼š${dailyData.actionText}`,
   354â†’      "#VibeLife",
   355â†’    ].join("\n");
   356â†’  }, [dailyData]);
   357â†’
   358â†’  return (
   359â†’    <div className="flex flex-col items-center justify-center w-full md:max-w-xl mx-auto px-4 py-6">
   360â†’      {/* Daily Greeting æ¯æ—¥é—®å€™ */}
   361â†’      <DailyGreeting
   362â†’        greeting={dailyData.greeting}
   363â†’        solarTerm={dailyData.solarTerm}
   364â†’        timeOfDay={dailyData.timeOfDay}
   365â†’        date={dailyData.isoDate}
   366â†’        todayTip={dailyData.todayTip}
   367â†’        baziHint={dailyData.baziHint || undefined}
   368â†’        fortuneScore={dailyData.fortuneScore}
   369â†’        fortuneHint={dailyData.fortuneHint}
   370â†’        actionItem={{ text: dailyData.actionText, completed: actionCompleted }}
   371â†’        onActionToggle={toggleAction}
   372â†’        shareText={shareText}
   373â†’        className="mb-6 w-full"
   374â†’      />
   375â†’
   376â†’      {/* Animated glyph with enhanced aura */}
   377â†’      <div className="relative flex items-center justify-center mb-4">
   378â†’        {/* Outer pulsing ring */}
   379â†’        <div className="absolute w-16 h-16 rounded-full border border-skill-primary/20 animate-pulse-slow" />
   380â†’        <div className="absolute w-24 h-24 rounded-full border border-skill-primary/10 animate-pulse-slower" />
   381â†’
   382â†’        {/* Breath aura */}
   383â†’        <BreathAura
   384â†’          skill={skill}
   385â†’          size="sm"
   386â†’          position="center"
   387â†’          intensity="medium"
   388â†’          className="opacity-40"
   389â†’        />
   390â†’
   391â†’        {/* Central glyph */}
   392â†’        <VibeGlyph
   393â†’          size="sm"
   394â†’          skill={skill}
   395â†’          showAura={true}
   396â†’          animate={true}
   397â†’          className="relative z-10"
   398â†’        />
   399â†’      </div>
   400â†’
   401â†’      {/* Title */}
   402â†’      <h3 className="text-base md:text-lg font-serif font-semibold text-foreground mb-1 text-center">
   403â†’        {config.title}
   404â†’      </h3>
   405â†’
   406â†’      {/* Subtitle */}
   407â†’      <p className="text-sm text-muted-foreground max-w-sm text-center mb-4">
   408â†’        {config.subtitle}
   409â†’      </p>
   410â†’
   411â†’      {/* Quick prompt suggestions */}
   412â†’      <div className="w-full space-y-3">
   413â†’        <p className="text-xs text-muted-foreground/60 text-center">
   414â†’          è¯•è¯•è¿™æ ·é—®
   415â†’        </p>
   416â†’        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
   417â†’          {quickPrompts.slice(0, 4).map((prompt, index) => (
   418â†’            <button
   419â†’              key={index}
   420â†’              onClick={() => onQuickPrompt?.(prompt.question)}
   421â†’              className={`
   422â†’                group relative px-3 py-3 text-left
   423â†’                bg-gradient-to-br ${prompt.gradient}
   424â†’                border border-border/50 hover:border-skill-primary/30
   425â†’                rounded-xl transition-all duration-200
   426â†’                hover:shadow-md hover:-translate-y-0.5
   427â†’              `}
   428â†’            >
   429â†’              <div className="flex items-start gap-2.5">
   430â†’                <span className="text-lg flex-shrink-0">{prompt.icon}</span>
   431â†’                <div className="flex-1 min-w-0">
   432â†’                  <span className="text-[10px] font-medium text-muted-foreground/70 uppercase tracking-wide">
   433â†’                    {prompt.category}
   434â†’                  </span>
   435â†’                  <p className="text-sm text-foreground line-clamp-2 mt-0.5">
   436â†’                    {prompt.question}
   437â†’                  </p>
   438â†’                </div>
   439â†’              </div>
   440â†’            </button>
   441â†’          ))}
   442â†’        </div>
   443â†’      </div>
   444â†’    </div>
   445â†’  );
   446â†’});
   447â†’
   448â†’export function ChatContainer({
   449â†’  skillId,
   450â†’  scenario,
   451â†’  skill = "bazi",
   452â†’  conversationId: externalConversationId,
   453â†’  voiceMode = "warm",
   454â†’  onConversationStart,
   455â†’  initialPrompt,
   456â†’  onInitialPromptSent,
   457â†’  dashboardData,
   458â†’  isDashboardLoading,
   459â†’  onCheckIn,
   460â†’  onToggleLever,
   461â†’  onToggleRock,
   462â†’  forceIntro = false,
   463â†’}: ChatContainerProps) {
   464â†’  const messagesEndRef = useRef<HTMLDivElement>(null);
   465â†’  const initialPromptSentRef = useRef(false);
   466â†’
   467â†’  // ç”Ÿæˆç¨³å®šçš„ conversationIdï¼ˆå¦‚æœå¤–éƒ¨æ²¡ä¼ å…¥ï¼‰
   468â†’  // ä½¿ç”¨ useRef ç¡®ä¿åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜
   469â†’  const generatedIdRef = useRef<string | null>(null);
   470â†’  if (!generatedIdRef.current) {
   471â†’    generatedIdRef.current = generateUUID();
   472â†’  }
   473â†’  const conversationId = externalConversationId || generatedIdRef.current;
   474â†’
   475â†’  // UI å±•ç¤ºç”¨çš„ skillï¼ˆä¸»é¢˜ã€ç©ºçŠ¶æ€ç­‰ï¼‰
   476â†’  const displaySkill: SkillType = skill || (skillId as SkillType) || "bazi";
   477â†’
   478â†’  // Skill Intro Card - é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤º
   479â†’  const [showIntroCard, setShowIntroCard] = useState(false);
   480â†’  const { data: introData } = useSkillIntro(displaySkill);
   481â†’  const { mark: doMarkFirstUse } = useMarkFirstUse(displaySkill);
   482â†’
   483â†’  // Use AI SDK powered chat hook
   484â†’  // skillId å¯é€‰ï¼šä¸ä¼ æ—¶åç«¯ LLM è‡ªåŠ¨è·¯ç”±
   485â†’  const {
   486â†’    messages,
   487â†’    isLoading,
   488â†’    sendMessage,
   489â†’    sendQuickPrompt,
   490â†’    error,
   491â†’    getThinkingSteps,  // v11: Get thinking steps for each message
   492â†’  } = useVibeChat({
   493â†’    skillId: skillId as SkillId | undefined,
   494â†’    scenario,
   495â†’    voiceMode,
   496â†’    conversationId,
   497â†’    onConversationStart,
   498â†’    onError: (err) => {
   499â†’      console.error("Chat error:", err);
   500â†’      // Show user-friendly toast notification with retry option
   501â†’      const errorMessage = err instanceof Error ? err.message : "æœªçŸ¥é”™è¯¯";
   502â†’      const isNetworkError = errorMessage.includes("network") || errorMessage.includes("fetch");
   503â†’      const isTimeoutError = errorMessage.includes("timeout") || errorMessage.includes("è¶…æ—¶");
   504â†’
   505â†’      toast.error(
   506â†’        isNetworkError ? "ç½‘ç»œè¿æ¥å¤±è´¥" : isTimeoutError ? "è¯·æ±‚è¶…æ—¶" : "å‘é€å¤±è´¥",
   507â†’        {
   508â†’          description: isNetworkError
   509â†’            ? "è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•"
   510â†’            : isTimeoutError
   511â†’              ? "æœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•"
   512â†’              : "è¯·ç¨åé‡è¯•ï¼Œæˆ–åˆ·æ–°é¡µé¢",
   513â†’          duration: 5000,
   514â†’        }
   515â†’      );
   516â†’    },
   517â†’  });
   518â†’
   519â†’  // æ£€æµ‹æ˜¯å¦é¦–æ¬¡ä½¿ç”¨æˆ–å¼ºåˆ¶æ˜¾ç¤ºä»‹ç»å¡
   520â†’  useEffect(() => {
   521â†’    if (introData?.is_first_use || forceIntro) {
   522â†’      setShowIntroCard(true);
   523â†’    }
   524â†’  }, [introData?.is_first_use, forceIntro]);
   525â†’
   526â†’  // å¤„ç†ä»‹ç»å¡ç‰‡åŠ¨ä½œ
   527â†’  // ä» Discover è¿›å…¥æ—¶ï¼ˆforceIntro=trueï¼‰ï¼Œå…³é—­æ—¶ä¸æ ‡è®° first_use
   528â†’  const handleIntroAction = useCallback((action: IntroCardAction) => {
   529â†’    if (action.type === 'dismiss') {
   530â†’      setShowIntroCard(false);
   531â†’      if (!forceIntro) {
   532â†’        doMarkFirstUse();
   533â†’      }
   534â†’    } else if (action.type === 'send_prompt') {
   535â†’      setShowIntroCard(false);
   536â†’      if (!forceIntro) {
   537â†’        doMarkFirstUse();
   538â†’      }
   539â†’      sendQuickPrompt(action.prompt);
   540â†’    }
   541â†’  }, [forceIntro, doMarkFirstUse, sendQuickPrompt]);
   542â†’
   543â†’  // Vercel rule: rerender-defer-reads - åªåœ¨ messages é•¿åº¦å˜åŒ–æ—¶æ»šåŠ¨
   544â†’  const messagesLength = messages.length;
   545â†’  const scrollToBottom = useCallback(() => {
   546â†’    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
   547â†’  }, []);
   548â†’
   549â†’  useEffect(() => {
   550â†’    scrollToBottom();
   551â†’  }, [messagesLength, scrollToBottom]);
   552â†’
   553â†’  // å¤„ç†ä» URL ä¼ å…¥çš„åˆå§‹æ¶ˆæ¯ï¼ˆå¦‚ä»é€šçŸ¥è·³è½¬ï¼‰
   554â†’  // Vercel rule: rerender-dependencies - ä½¿ç”¨ ref é¿å… sendMessage ä¾èµ–
   555â†’  const sendMessageRef = useRef(sendMessage);
   556â†’  sendMessageRef.current = sendMessage;
   557â†’
   558â†’  useEffect(() => {
   559â†’    if (initialPrompt && !initialPromptSentRef.current && !isLoading) {
   560â†’      initialPromptSentRef.current = true;
   561â†’      sendMessageRef.current(initialPrompt).then(() => {
   562â†’        onInitialPromptSent?.();
   563â†’      });
   564â†’    }
   565â†’  }, [initialPrompt, isLoading, onInitialPromptSent]);
   566â†’
   567â†’  // é‡ç½®æ ‡è®°å½“ initialPrompt å˜åŒ–æ—¶
   568â†’  useEffect(() => {
   569â†’    if (!initialPrompt) {
   570â†’      initialPromptSentRef.current = false;
   571â†’    }
   572â†’  }, [initialPrompt]);
   573â†’
   574â†’  // Handle send from ChatInput
   575â†’  const handleSend = useCallback(
   576â†’    async (content: string) => {
   577â†’      await sendMessage(content);
   578â†’    },
   579â†’    [sendMessage]
   580â†’  );
   581â†’
   582â†’  // Handle quick prompt from empty state
   583â†’  const handleQuickPrompt = useCallback(
   584â†’    async (content: string) => {
   585â†’      await sendQuickPrompt(content);
   586â†’    },
   587â†’    [sendQuickPrompt]
   588â†’  );
   589â†’
   590â†’  const hasMessages = messages.length > 0;
   591â†’
   592â†’  // DailyGreeting æ•°æ®
   593â†’  const dailyData = useDailyGreeting(displaySkill);
   594â†’  const actionKey = useMemo(
   595â†’    () => `vibelife-daily-action:${displaySkill}:${dailyData.isoDate}`,
   596â†’    [displaySkill, dailyData.isoDate]
   597â†’  );
   598â†’  const [actionCompleted, setActionCompleted] = useState(false);
   599â†’
   600â†’  useEffect(() => {
   601â†’    if (typeof window === "undefined") return;
   602â†’    setActionCompleted(getLocalStorage(actionKey) === "1");
   603â†’  }, [actionKey]);
   604â†’
   605â†’  const toggleAction = useCallback(() => {
   606â†’    setActionCompleted((prev) => {
   607â†’      const next = !prev;
   608â†’      setLocalStorage(actionKey, next ? "1" : "0");
   609â†’      return next;
   610â†’    });
   611â†’  }, [actionKey]);
   612â†’
   613â†’  const shareText = useMemo(() => {
   614â†’    const term = dailyData.solarTerm ? ` Â· ${dailyData.solarTerm}` : "";
   615â†’    return [
   616â†’      `VibeLife${term} Â· ${dailyData.isoDate}`,
   617â†’      dailyData.greeting,
   618â†’      `è¿åŠ¿æŒ‡æ•°ï¼š${dailyData.fortuneScore}/100`,
   619â†’      `ä»Šæ—¥ä¸€æ­¥ï¼š${dailyData.actionText}`,
   620â†’      "#VibeLife",
   621â†’    ].join("\n");
   622â†’  }, [dailyData]);
   623â†’
   624â†’  // é»˜è®¤å›è°ƒï¼ˆå¦‚æœæ²¡æœ‰ä¼ å…¥ï¼‰
   625â†’  const handleCheckIn = useCallback(async () => {
   626â†’    if (onCheckIn) {
   627â†’      await onCheckIn();
   628â†’    } else {
   629â†’      toast.success("ç­¾åˆ°æˆåŠŸï¼");
   630â†’    }
   631â†’  }, [onCheckIn]);
   632â†’
   633â†’  const handleToggleLever = useCallback(async (leverId: string) => {
   634â†’    if (onToggleLever) {
   635â†’      await onToggleLever(leverId);
   636â†’    }
   637â†’  }, [onToggleLever]);
   638â†’
   639â†’  const handleToggleRock = useCallback(async (rockId: string) => {
   640â†’    if (onToggleRock) {
   641â†’      await onToggleRock(rockId);
   642â†’    }
   643â†’  }, [onToggleRock]);
   644â†’
   645â†’  // è½¬æ¢ Dashboard æ•°æ®ä¸º Bento Dashboard æ ¼å¼
   646â†’  const bentoDashboardData = useBentoDashboardData(dashboardData);
   647â†’
   648â†’  return (
   649â†’    <div className="flex flex-col h-full" data-skill={displaySkill}>
   650â†’      {/* Messages area - always flex-1 to push input to bottom */}
   651â†’      <main
   652â†’        id="main-content"
   653â†’        className="flex-1 overflow-y-auto relative min-h-0"
   654â†’        role="log"
   655â†’        aria-label="å¯¹è¯æ¶ˆæ¯"
   656â†’        aria-live="polite"
   657â†’      >
   658â†’        {!hasMessages ? (
   659â†’          /* Empty state with Welcome Message or Skill Intro */
   660â†’          <div className="flex flex-col items-center justify-center h-full py-4 md:py-8">
   661â†’            {/* é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤º Skill ä»‹ç»å¡ */}
   662â†’            {showIntroCard && (
   663â†’              <div className="w-full max-w-3xl px-4 mb-4">
   664â†’                <SkillIntroCard
   665â†’                  skillId={displaySkill}
   666â†’                  variant="compact"
   667â†’                  dismissible
   668â†’                  onAction={handleIntroAction}
   669â†’                />
   670â†’              </div>
   671â†’            )}
   672â†’
   673â†’            {isDashboardLoading ? (
   674â†’              <div className="flex items-center justify-center">
   675â†’                <div className="text-sm text-muted-foreground">åŠ è½½ä¸­â€¦</div>
   676â†’              </div>
   677â†’            ) : bentoDashboardData ? (
   678â†’              <BentoDashboard
   679â†’                data={bentoDashboardData}
   680â†’                className="w-full"
   681â†’              />
   682â†’            ) : (
   683â†’              <div className="flex items-center justify-center">
   684â†’                <div className="text-sm text-muted-foreground">æ¬¢è¿å›æ¥</div>
   685â†’              </div>
   686â†’            )}
   687â†’          </div>
   688â†’        ) : (
   689â†’          /* Messages list - æ‰€æœ‰è®¾å¤‡å±…ä¸­ï¼ŒPCç«¯å“åº”å¼å¢å®½ */
   690â†’          <div className="px-4 pt-4 pb-2 max-w-3xl xl:max-w-4xl 2xl:max-w-5xl mx-auto">
   691â†’            {messages.map((message) => (
   692â†’              // Use chat-message-item class for content-visibility optimization (Vercel rule: rendering-content-visibility)
   693â†’              <div key={message.id} className="chat-message-item">
   694â†’                <ChatMessage
   695â†’                  role={message.role as "user" | "assistant"}
   696â†’                  content={getMessageContent(message)}
   697â†’                  skill={displaySkill}
   698â†’                  isStreaming={isLoading && message.role === "assistant" && message === messages[messages.length - 1]}
   699â†’                  thinkingSteps={message.role === "assistant" ? getThinkingSteps(message.id) : undefined}
   700â†’                  onSendMessage={sendMessage}
   701â†’                />
   702â†’              </div>
   703â†’            ))}
   704â†’            {/* Show loading indicator when waiting for first response chunk */}
   705â†’            {isLoading && messages.length > 0 && messages[messages.length - 1].role === "user" && (
   706â†’              <ChatMessage
   707â†’                role="assistant"
   708â†’                content=""
   709â†’                skill={displaySkill}
   710â†’                isStreaming
   711â†’              />
   712â†’            )}
   713â†’            {/* Error is now handled via toast notification in onError callback */}
   714â†’            <div ref={messagesEndRef} />
   715â†’          </div>
   716â†’        )}
   717â†’      </main>
   718â†’
   719â†’      {/* Smart Suggestions + Input - fixed at bottom */}
   720â†’      <div className="flex-shrink-0">
   721â†’        {/* æ™ºèƒ½æ¨è - ä»…åœ¨ç©ºçŠ¶æ€æ—¶æ˜¾ç¤º */}
   722â†’        {!hasMessages && (
   723â†’          <SmartSuggestions
   724â†’            dashboardData={dashboardData}
   725â†’            onSelect={handleQuickPrompt}
   726â†’          />
   727â†’        )}
   728â†’        <ChatInput onSend={handleSend} disabled={isLoading} />
   729â†’      </div>
   730â†’    </div>
   731â†’  );
   732â†’}
   733â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
