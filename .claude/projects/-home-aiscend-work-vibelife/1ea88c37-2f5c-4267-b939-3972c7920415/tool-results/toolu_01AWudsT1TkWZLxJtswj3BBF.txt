     1â†’"""
     2â†’SkillLoader v9 - æ¸è¿›å¼ Skill åŠ è½½å™¨
     3â†’
     4â†’v9 æ¶æ„ï¼ˆéµå¾ª Claude Agent SDK åŸåˆ™ï¼‰ï¼š
     5â†’- Core Skill å…¨ç¨‹æ¿€æ´»ï¼Œå…¨æ–‡åŠ è½½
     6â†’- å…¶ä»– Skill æ¸è¿›å¼åŠ è½½ï¼š
     7â†’  - Phase 1: åªåŠ è½½ frontmatterï¼ˆSkillMetaï¼‰
     8â†’  - Phase 2: æŒ‰éœ€åŠ è½½å®Œæ•´å†…å®¹ï¼ˆSkillFullï¼‰
     9â†’- æ”¯æŒå¤š Skill å¹¶è¡Œæ¿€æ´»
    10â†’- LLM è‡ªä¸»ç¼–æ’ï¼Œåˆ é™¤ç¡¬ç¼–ç è·¯ç”±
    11â†’
    12â†’v7 æ¶æ„ï¼ˆä¿ç•™å…¼å®¹ï¼‰ï¼š
    13â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
    14â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
    15â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
    16â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
    17â†’
    18â†’v7.4 æ–°å¢ï¼š
    19â†’- Skill Management æ”¯æŒï¼šcategory, pricing, showcase, subscription å­—æ®µ
    20â†’
    21â†’v7.5 æ–°å¢ï¼š
    22â†’- æ•°æ®åº“ä¼˜å…ˆå…ƒæ•°æ®åŠ è½½ï¼ˆskill_catalog è¡¨ï¼‰
    23â†’- async å‡½æ•°æ”¯æŒï¼šload_skill_metadata_async, get_all_skill_metadata_async
    24â†’- SKILL.md ä½œä¸º fallback
    25â†’"""
    26â†’import re
    27â†’import json
    28â†’import logging
    29â†’import yaml
    30â†’from pathlib import Path
    31â†’from dataclasses import dataclass, field
    32â†’from typing import Dict, List, Optional, Any
    33â†’from functools import lru_cache
    34â†’
    35â†’logger = logging.getLogger(__name__)
    36â†’
    37â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    38â†’
    39â†’
    40â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    41â†’# æ•°æ®ç»“æ„
    42â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    43â†’
    44â†’@dataclass
    45â†’class SkillPricing:
    46â†’    """Skill å®šä»·é…ç½®"""
    47â†’    type: str = "free"  # free | premium | credits
    48â†’    trial_messages: int = 3
    49â†’    credits_per_use: Optional[int] = None
    50â†’
    51â†’
    52â†’@dataclass
    53â†’class SkillShowcase:
    54â†’    """Skill å±•ç¤ºé…ç½®ï¼ˆç”¨äº Skill å¸‚åœºï¼‰"""
    55â†’    tagline: str = ""
    56â†’    highlights: List[str] = field(default_factory=list)
    57â†’    preview_image: Optional[str] = None
    58â†’    demo_prompts: List[str] = field(default_factory=list)
    59â†’
    60â†’
    61â†’@dataclass
    62â†’class SkillSubscription:
    63â†’    """Skill è®¢é˜…é…ç½®"""
    64â†’    auto_subscribe: bool = False
    65â†’    can_unsubscribe: bool = True
    66â†’    push_default: bool = True
    67â†’    min_subscription_days: int = 0
    68â†’
    69â†’
    70â†’@dataclass
    71â†’class SkillFeature:
    72â†’    """Skill åŠŸèƒ½ç‰¹æ€§"""
    73â†’    name: str
    74â†’    description: str = ""
    75â†’    icon: str = "ğŸ“Œ"
    76â†’    tier: str = "free"  # free | basic | premium
    77â†’
    78â†’
    79â†’@dataclass
    80â†’class SkillMetadata:
    81â†’    """Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰"""
    82â†’    id: str
    83â†’    name: str
    84â†’    description: str
    85â†’    version: str = "1.0.0"
    86â†’    category: str = "professional"  # core | default | professional
    87â†’    icon: str = "ğŸ’¡"
    88â†’    color: str = "#6B7280"
    89â†’    triggers: List[str] = field(default_factory=list)
    90â†’    pricing: SkillPricing = field(default_factory=SkillPricing)
    91â†’    features: List[SkillFeature] = field(default_factory=list)
    92â†’    showcase: SkillShowcase = field(default_factory=SkillShowcase)
    93â†’    subscription: SkillSubscription = field(default_factory=SkillSubscription)
    94â†’
    95â†’    def to_dict(self) -> Dict[str, Any]:
    96â†’        """è½¬æ¢ä¸º API å“åº”æ ¼å¼"""
    97â†’        return {
    98â†’            "id": self.id,
    99â†’            "name": self.name,
   100â†’            "description": self.description,
   101â†’            "version": self.version,
   102â†’            "category": self.category,
   103â†’            "icon": self.icon,
   104â†’            "color": self.color,
   105â†’            "triggers": self.triggers,
   106â†’            "pricing": {
   107â†’                "type": self.pricing.type,
   108â†’                "trial_messages": self.pricing.trial_messages,
   109â†’                "credits_per_use": self.pricing.credits_per_use,
   110â†’            },
   111â†’            "features": [
   112â†’                {"name": f.name, "description": f.description, "icon": f.icon, "tier": f.tier}
   113â†’                for f in self.features
   114â†’            ],
   115â†’            "showcase": {
   116â†’                "tagline": self.showcase.tagline,
   117â†’                "highlights": self.showcase.highlights,
   118â†’                "preview_image": self.showcase.preview_image,
   119â†’                "demo_prompts": self.showcase.demo_prompts,
   120â†’            },
   121â†’            "subscription": {
   122â†’                "auto_subscribe": self.subscription.auto_subscribe,
   123â†’                "can_unsubscribe": self.subscription.can_unsubscribe,
   124â†’                "push_default": self.subscription.push_default,
   125â†’            },
   126â†’        }
   127â†’
   128â†’
   129â†’@dataclass
   130â†’class SkillConfig:
   131â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
   132â†’    id: str
   133â†’    name: str
   134â†’    description: str
   135â†’    expert_persona: str
   136â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
   137â†’    ethics: Dict[str, Any]
   138â†’    tools: List[str]
   139â†’    default_scenario: str = "basic_reading"
   140â†’    triggers: List[str] = field(default_factory=list)
   141â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
   142â†’    # v7.1: SOP é…ç½®é©±åŠ¨
   143â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
   144â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
   145â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
   146â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   147â†’    collect_tool: Optional[str] = None # æ”¶é›†å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   148â†’    external_tools: List[str] = field(default_factory=list)  # v7.3: ä»å…¶ä»– skill å¯¼å…¥çš„å·¥å…·
   149â†’    # v2.2: Profile æ³¨å…¥é…ç½®
   150â†’    requires_skill_data: List[str] = field(default_factory=list)  # éœ€è¦çš„ skill_dataï¼Œç©ºåˆ—è¡¨è¡¨ç¤ºåªéœ€è‡ªèº«
   151â†’
   152â†’
   153â†’@dataclass
   154â†’class ServiceItem:
   155â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
   156â†’    scenario_id: str
   157â†’    name: str
   158â†’    icon: str
   159â†’    description: str
   160â†’    tier: str  # entry/standard/professional
   161â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
   162â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
   163â†’
   164â†’
   165â†’@dataclass
   166â†’class ScenarioConfig:
   167â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
   168â†’    id: str
   169â†’    name: str
   170â†’    level: str  # entry/standard/professional
   171â†’    billing: str  # free/basic/premium
   172â†’    description: str
   173â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
   174â†’    prerequisites: List[str]
   175â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
   176â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
   177â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
   178â†’    tools: List[str]
   179â†’
   180â†’
   181â†’@dataclass
   182â†’class ToolMetadata:
   183â†’    """å·¥å…·å…ƒæ•°æ®"""
   184â†’    name: str
   185â†’    description: str
   186â†’    tool_type: str  # collect/calculate/display/search
   187â†’    card_type: Optional[str] = None
   188â†’    card_props_schema: Optional[Dict] = None
   189â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   190â†’    when_to_call: Optional[str] = None
   191â†’
   192â†’
   193â†’@dataclass
   194â†’class RuleConfig:
   195â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
   196â†’    id: str
   197â†’    name: str
   198â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
   199â†’    impact_description: str
   200â†’    tags: List[str]
   201â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
   202â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
   203â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
   204â†’    common_questions: str  # å¸¸è§é—®é¢˜
   205â†’
   206â†’
   207â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   208â†’# V9: æ¸è¿›å¼åŠ è½½æ•°æ®ç»“æ„
   209â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   210â†’
   211â†’@dataclass
   212â†’class SkillMeta:
   213â†’    """Skill å…ƒæ•°æ®æ‘˜è¦ï¼ˆPhase 1 å±•ç¤ºï¼‰- V9 æ–°å¢
   214â†’
   215â†’    åªåŒ…å« frontmatter ä¿¡æ¯ï¼Œç”¨äº Phase 1 è·¯ç”±ã€‚
   216â†’    description å†…åµŒå·¥å…·åˆ—è¡¨ï¼Œtools_list ä¸ºä» tools.yaml æŠ½å–çš„æœºå™¨å¯è¯»æ¸…å•ã€‚
   217â†’    """
   218â†’    id: str
   219â†’    name: str
   220â†’    description: str  # å†…å«å·¥å…·åˆ—è¡¨ï¼Œå¦‚ "æ˜Ÿç›˜è®¡ç®—ä¸è§£è¯»ã€‚å·¥å…·ï¼šcalculate_zodiac, show_zodiac_chart"
   221â†’    triggers: List[str] = field(default_factory=list)
   222â†’    category: str = "professional"
   223â†’    tools_list: List[str] = field(default_factory=list)
   224â†’
   225â†’
   226â†’@dataclass
   227â†’class ToolDef:
   228â†’    """å·¥å…·å®šä¹‰ï¼ˆç”¨äº SkillFullï¼‰- V9 æ–°å¢"""
   229â†’    name: str
   230â†’    description: str
   231â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   232â†’    tool_type: str = "action"  # routing/collect/action/search/display/trigger
   233â†’
   234â†’
   235â†’@dataclass
   236â†’class SkillFull:
   237â†’    """Skill å®Œæ•´å†…å®¹ï¼ˆPhase 2 åŠ è½½ï¼‰- V9 æ–°å¢
   238â†’
   239â†’    åŒ…å« SKILL.md å…¨æ–‡ã€å·¥å…·å®šä¹‰ã€è§„åˆ™æ–‡ä»¶ã€‚
   240â†’    """
   241â†’    meta: SkillMeta
   242â†’    content: str  # SKILL.md å…¨æ–‡ï¼ˆä¸å« frontmatterï¼‰
   243â†’    tools: List[ToolDef] = field(default_factory=list)
   244â†’    rules: Dict[str, str] = field(default_factory=dict)  # rule_id -> content
   245â†’
   246â†’
   247â†’# V9: Core Skill å…¨å±€ç¼“å­˜
   248â†’_core_skill_cache: Optional[SkillFull] = None
   249â†’
   250â†’# V9: æ‰€æœ‰ Skill Meta ç¼“å­˜
   251â†’_skill_metas_cache: Optional[Dict[str, SkillMeta]] = None
   252â†’
   253â†’
   254â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   255â†’# è§£æå‡½æ•°
   256â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   257â†’
   258â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   259â†’    """è§£æ YAML frontmatterï¼ˆæ”¯æŒåµŒå¥—å¯¹è±¡ï¼‰"""
   260â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   261â†’    match = re.match(pattern, text, re.DOTALL)
   262â†’    if not match:
   263â†’        return {}, text
   264â†’
   265â†’    frontmatter_str, content = match.groups()
   266â†’
   267â†’    # ä½¿ç”¨ YAML è§£æä»¥æ”¯æŒåµŒå¥—å¯¹è±¡
   268â†’    try:
   269â†’        metadata = yaml.safe_load(frontmatter_str) or {}
   270â†’    except yaml.YAMLError as e:
   271â†’        logger.warning(f"YAML parse error in frontmatter: {e}, falling back to simple parse")
   272â†’        # å›é€€åˆ°ç®€å•è§£æ
   273â†’        metadata = {}
   274â†’        current_key = None
   275â†’        current_list = None
   276â†’
   277â†’        for line in frontmatter_str.strip().split('\n'):
   278â†’            stripped = line.strip()
   279â†’            if not stripped:
   280â†’                continue
   281â†’            if stripped.startswith('- ') and current_key:
   282â†’                if current_list is None:
   283â†’                    current_list = []
   284â†’                current_list.append(stripped[2:].strip())
   285â†’                metadata[current_key] = current_list
   286â†’            elif ':' in line and not line.startswith(' '):
   287â†’                current_list = None
   288â†’                key, value = line.split(':', 1)
   289â†’                current_key = key.strip()
   290â†’                value = value.strip()
   291â†’                if value in ('|', ''):
   292â†’                    continue
   293â†’                elif value.lower() == 'true':
   294â†’                    metadata[current_key] = True
   295â†’                elif value.lower() == 'false':
   296â†’                    metadata[current_key] = False
   297â†’                else:
   298â†’                    metadata[current_key] = value
   299â†’
   300â†’    return metadata, content.strip()
   301â†’
   302â†’
   303â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   304â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   305â†’
   306â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   307â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   308â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   309â†’    """
   310â†’    metadata, content = parse_frontmatter(text)
   311â†’
   312â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   313â†’    triggers = metadata.get("triggers", [])
   314â†’
   315â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   316â†’    if not triggers:
   317â†’        description = metadata.get("description", "")
   318â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   319â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   320â†’        if trigger_match:
   321â†’            trigger_str = trigger_match.group(1)
   322â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   323â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   324â†’
   325â†’    result = {
   326â†’        "id": metadata.get("id", ""),
   327â†’        "name": metadata.get("name", ""),
   328â†’        "description": metadata.get("description", ""),
   329â†’        "triggers": triggers,
   330â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   331â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   332â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   333â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   334â†’        "requires_compute": metadata.get("requires_compute", False),
   335â†’        "compute_type": metadata.get("compute_type", None),
   336â†’        "compute_tool": metadata.get("compute_tool", None),
   337â†’        "collect_tool": metadata.get("collect_tool", None),
   338â†’        "external_tools": metadata.get("external_tools", []),  # v7.3
   339â†’        # v2.2: Profile æ³¨å…¥é…ç½®
   340â†’        "requires_skill_data": metadata.get("requires_skill_data", []),
   341â†’    }
   342â†’
   343â†’    # æå–ä¸“å®¶èº«ä»½
   344â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   345â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   346â†’
   347â†’    # æå–åœºæ™¯ç›®å½•
   348â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   349â†’    for level in scenarios.keys():
   350â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   351â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   352â†’        if match:
   353â†’            for row in match.group(1).strip().split('\n'):
   354â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   355â†’                if len(cols) >= 2:
   356â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   357â†’    result["scenarios"] = scenarios
   358â†’
   359â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   360â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   361â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   362â†’    if forbidden_match:
   363â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   364â†’    result["ethics"] = ethics
   365â†’
   366â†’    # æå–å·¥å…·åˆ—è¡¨
   367â†’    tools = []
   368â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   369â†’    if tools_match:
   370â†’        for row in tools_match.group(1).strip().split('\n'):
   371â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   372â†’            if len(cols) >= 1:
   373â†’                tools.append(cols[0])
   374â†’    result["tools"] = tools
   375â†’
   376â†’    return result
   377â†’
   378â†’
   379â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   380â†’    """è§£æ scenario.md å†…å®¹"""
   381â†’    metadata, content = parse_frontmatter(text)
   382â†’
   383â†’    result = {
   384â†’        "id": metadata.get("id", ""),
   385â†’        "name": metadata.get("name", ""),
   386â†’        "level": metadata.get("level", "entry"),
   387â†’        "billing": metadata.get("billing", "free"),
   388â†’        "description": metadata.get("description", ""),
   389â†’    }
   390â†’
   391â†’    # æå–è§¦å‘æ¡ä»¶
   392â†’    triggers = {"primary": [], "secondary": []}
   393â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   394â†’    if primary_match:
   395â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   396â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   397â†’    if secondary_match:
   398â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   399â†’    result["triggers"] = triggers
   400â†’
   401â†’    # æå–å‰ç½®è¦æ±‚
   402â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   403â†’    result["prerequisites"] = []
   404â†’    if prereq_match:
   405â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   406â†’
   407â†’    # æå– SOP é˜¶æ®µ
   408â†’    sop = []
   409â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   410â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   411â†’        phase_num, phase_name, phase_content = match.groups()
   412â†’        phase = {
   413â†’            "phase": int(phase_num),
   414â†’            "name": phase_name.strip(),
   415â†’            "content": phase_content.strip()
   416â†’        }
   417â†’        # æå–ç±»å‹
   418â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   419â†’        if type_match:
   420â†’            phase["type"] = type_match.group(1)
   421â†’        sop.append(phase)
   422â†’    result["sop"] = sop
   423â†’
   424â†’    # æå–å·¥å…·åˆ—è¡¨
   425â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   426â†’    result["tools"] = []
   427â†’    if tools_match:
   428â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   429â†’
   430â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   431â†’    result["knowledge_config"] = {}
   432â†’    result["output_config"] = {}
   433â†’
   434â†’    return result
   435â†’
   436â†’
   437â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   438â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   439â†’    metadata, content = parse_frontmatter(text)
   440â†’
   441â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   442â†’    tags_raw = metadata.get("tags", [])
   443â†’    if isinstance(tags_raw, str):
   444â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   445â†’    else:
   446â†’        tags = tags_raw
   447â†’
   448â†’    result = {
   449â†’        "id": metadata.get("id", ""),
   450â†’        "name": metadata.get("name", ""),
   451â†’        "impact": metadata.get("impact", "MEDIUM"),
   452â†’        "impact_description": metadata.get("impactDescription", ""),
   453â†’        "tags": tags,
   454â†’        "content": content,
   455â†’    }
   456â†’
   457â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   458â†’    analysis_steps = []
   459â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   460â†’    if table_match:
   461â†’        for row in table_match.group(1).strip().split('\n'):
   462â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   463â†’            if len(cols) >= 4:
   464â†’                analysis_steps.append({
   465â†’                    "step": cols[0],
   466â†’                    "point": cols[1],
   467â†’                    "query": cols[2],
   468â†’                    "priority": cols[3],
   469â†’                })
   470â†’    result["analysis_steps"] = analysis_steps
   471â†’
   472â†’    # æå–è¾“å‡ºè¦æ±‚
   473â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   474â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   475â†’
   476â†’    # æå–å¸¸è§é—®é¢˜
   477â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   478â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   479â†’
   480â†’    return result
   481â†’
   482â†’
   483â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   484â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   485â†’    services = {"entry": [], "standard": [], "professional": []}
   486â†’
   487â†’    tier_map = {
   488â†’        "entry": "entry",
   489â†’        "standard": "standard",
   490â†’        "professional": "professional"
   491â†’    }
   492â†’
   493â†’    for tier_name, tier_key in tier_map.items():
   494â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   495â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   496â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   497â†’        if not match:
   498â†’            continue
   499â†’
   500â†’        table_content = match.group(1).strip()
   501â†’        if not table_content:
   502â†’            continue
   503â†’
   504â†’        for row in table_content.split('\n'):
   505â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   506â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   507â†’                continue
   508â†’
   509â†’            service = {
   510â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   511â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   512â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   513â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   514â†’                "tier": tier_key,
   515â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   516â†’                "highlights": []
   517â†’            }
   518â†’
   519â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   520â†’            if len(cols) > 7 and cols[7]:
   521â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   522â†’
   523â†’            services[tier_key].append(service)
   524â†’
   525â†’    return services
   526â†’
   527â†’
   528â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   529â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   530â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   531â†’    if not skill_path.exists():
   532â†’        return None
   533â†’
   534â†’    text = skill_path.read_text(encoding='utf-8')
   535â†’    metadata, _ = parse_frontmatter(text)
   536â†’    services = parse_skill_services(text)
   537â†’
   538â†’    return {
   539â†’        "skill_id": skill_id,
   540â†’        "skill_name": metadata.get("name", skill_id),
   541â†’        "description": metadata.get("description", ""),
   542â†’        "services": services
   543â†’    }
   544â†’
   545â†’
   546â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   547â†’# åŠ è½½å‡½æ•°
   548â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   549â†’
   550â†’@lru_cache(maxsize=32)
   551â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   552â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   553â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   554â†’    if not skill_path.exists():
   555â†’        return None
   556â†’
   557â†’    text = skill_path.read_text(encoding='utf-8')
   558â†’    data = parse_skill_md(text)
   559â†’
   560â†’    return SkillConfig(
   561â†’        id=data.get("id", skill_id),
   562â†’        name=data.get("name", skill_id),
   563â†’        description=data.get("description", ""),
   564â†’        expert_persona=data.get("expert_persona", ""),
   565â†’        scenarios=data.get("scenarios", {}),
   566â†’        ethics=data.get("ethics", {}),
   567â†’        tools=data.get("tools", []),
   568â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   569â†’        triggers=data.get("triggers", []),
   570â†’        global_tools=data.get("global_tools", []),
   571â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   572â†’        requires_birth_info=data.get("requires_birth_info", False),
   573â†’        requires_compute=data.get("requires_compute", False),
   574â†’        compute_type=data.get("compute_type", None),
   575â†’        compute_tool=data.get("compute_tool", None),
   576â†’        collect_tool=data.get("collect_tool", None),
   577â†’        external_tools=data.get("external_tools", []),  # v7.3
   578â†’        # v2.2: Profile æ³¨å…¥é…ç½®
   579â†’        requires_skill_data=data.get("requires_skill_data", []),
   580â†’    )
   581â†’
   582â†’
   583â†’@lru_cache(maxsize=32)
   584â†’def load_skill_metadata(skill_id: str) -> Optional[SkillMetadata]:
   585â†’    """åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰- v7.4 æ–°å¢
   586â†’
   587â†’    ä» SKILL.md çš„ frontmatter ä¸­è¯»å–å®Œæ•´çš„å…ƒæ•°æ®é…ç½®ï¼Œ
   588â†’    åŒ…æ‹¬ category, pricing, showcase, subscription ç­‰å­—æ®µã€‚
   589â†’    """
   590â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   591â†’    if not skill_path.exists():
   592â†’        return None
   593â†’
   594â†’    text = skill_path.read_text(encoding='utf-8')
   595â†’    metadata, _ = parse_frontmatter(text)
   596â†’
   597â†’    # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   598â†’    triggers = metadata.get("triggers", [])
   599â†’    if not triggers:
   600â†’        description = metadata.get("description", "")
   601â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   602â†’        if trigger_match:
   603â†’            trigger_str = trigger_match.group(1)
   604â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   605â†’
   606â†’    # è§£æ pricing
   607â†’    pricing_data = metadata.get("pricing", {})
   608â†’    pricing = SkillPricing(
   609â†’        type=pricing_data.get("type", "free") if isinstance(pricing_data, dict) else "free",
   610â†’        trial_messages=pricing_data.get("trial_messages", 3) if isinstance(pricing_data, dict) else 3,
   611â†’        credits_per_use=pricing_data.get("credits_per_use") if isinstance(pricing_data, dict) else None,
   612â†’    )
   613â†’
   614â†’    # è§£æ features
   615â†’    features_data = metadata.get("features", [])
   616â†’    features = []
   617â†’    if isinstance(features_data, list):
   618â†’        for f in features_data:
   619â†’            if isinstance(f, dict):
   620â†’                features.append(SkillFeature(
   621â†’                    name=f.get("name", ""),
   622â†’                    description=f.get("description", ""),
   623â†’                    icon=f.get("icon", "ğŸ“Œ"),
   624â†’                    tier=f.get("tier", "free"),
   625â†’                ))
   626â†’
   627â†’    # è§£æ showcase
   628â†’    showcase_data = metadata.get("showcase", {})
   629â†’    showcase = SkillShowcase(
   630â†’        tagline=showcase_data.get("tagline", "") if isinstance(showcase_data, dict) else "",
   631â†’        highlights=showcase_data.get("highlights", []) if isinstance(showcase_data, dict) else [],
   632â†’        preview_image=showcase_data.get("preview_image") if isinstance(showcase_data, dict) else None,
   633â†’        demo_prompts=showcase_data.get("demo_prompts", []) if isinstance(showcase_data, dict) else [],
   634â†’    )
   635â†’
   636â†’    # è§£æ subscription
   637â†’    subscription_data = metadata.get("subscription", {})
   638â†’    category = metadata.get("category", "professional")
   639â†’    subscription = SkillSubscription(
   640â†’        auto_subscribe=subscription_data.get("auto_subscribe", category == "default") if isinstance(subscription_data, dict) else (category == "default"),
   641â†’        can_unsubscribe=subscription_data.get("can_unsubscribe", category != "core") if isinstance(subscription_data, dict) else (category != "core"),
   642â†’        push_default=subscription_data.get("push_default", True) if isinstance(subscription_data, dict) else True,
   643â†’        min_subscription_days=subscription_data.get("min_subscription_days", 0) if isinstance(subscription_data, dict) else 0,
   644â†’    )
   645â†’
   646â†’    return SkillMetadata(
   647â†’        id=metadata.get("id", skill_id),
   648â†’        name=metadata.get("name", skill_id),
   649â†’        description=metadata.get("description", ""),
   650â†’        version=metadata.get("version", "1.0.0"),
   651â†’        category=category,
   652â†’        icon=metadata.get("icon", "ğŸ’¡"),
   653â†’        color=metadata.get("color", "#6B7280"),
   654â†’        triggers=triggers,
   655â†’        pricing=pricing,
   656â†’        features=features,
   657â†’        showcase=showcase,
   658â†’        subscription=subscription,
   659â†’    )
   660â†’
   661â†’
   662â†’def get_all_skill_metadata() -> List[SkillMetadata]:
   663â†’    """è·å–æ‰€æœ‰å¯ç”¨ Skill çš„å…ƒæ•°æ®ï¼ˆç”¨äº Skill åˆ—è¡¨ APIï¼‰- v7.4 æ–°å¢"""
   664â†’    skills = []
   665â†’    for skill_id in get_available_skills():
   666â†’        metadata = load_skill_metadata(skill_id)
   667â†’        if metadata:
   668â†’            skills.append(metadata)
   669â†’    return skills
   670â†’
   671â†’
   672â†’def get_skills_by_category(category: str) -> List[SkillMetadata]:
   673â†’    """æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ - v7.4 æ–°å¢
   674â†’
   675â†’    Args:
   676â†’        category: core | default | professional
   677â†’
   678â†’    Returns:
   679â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„å…ƒæ•°æ®åˆ—è¡¨
   680â†’    """
   681â†’    return [s for s in get_all_skill_metadata() if s.category == category]
   682â†’
   683â†’
   684â†’@lru_cache(maxsize=64)
   685â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   686â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   687â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   688â†’    if not scenario_path.exists():
   689â†’        return None
   690â†’
   691â†’    text = scenario_path.read_text(encoding='utf-8')
   692â†’    data = parse_scenario_md(text)
   693â†’
   694â†’    return ScenarioConfig(
   695â†’        id=data.get("id", scenario_id),
   696â†’        name=data.get("name", scenario_id),
   697â†’        level=data.get("level", "entry"),
   698â†’        billing=data.get("billing", "free"),
   699â†’        description=data.get("description", ""),
   700â†’        triggers=data.get("triggers", {}),
   701â†’        prerequisites=data.get("prerequisites", []),
   702â†’        sop=data.get("sop", []),
   703â†’        knowledge_config=data.get("knowledge_config", {}),
   704â†’        output_config=data.get("output_config", {}),
   705â†’        tools=data.get("tools", [])
   706â†’    )
   707â†’
   708â†’
   709â†’@lru_cache(maxsize=128)
   710â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   711â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢
   712â†’
   713â†’    æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
   714â†’    1. æ ¹ç›®å½•è§„åˆ™: rule_id="dankoe" -> rules/dankoe.md
   715â†’    2. å­ç›®å½•è§„åˆ™: rule_id="companion/weekly-review" -> rules/companion/weekly-review.md
   716â†’
   717â†’    å®¹é”™å¤„ç†ï¼š
   718â†’    - è‡ªåŠ¨å¤„ç†å·²å¸¦ .md åç¼€çš„ rule_id
   719â†’    - æ‹’ç»ç›®å½•è·¯å¾„
   720â†’    """
   721â†’    # å…ˆå°è¯•æ ‡å‡†æ ¼å¼ï¼ˆè‡ªåŠ¨æ·»åŠ  .md åç¼€ï¼‰
   722â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   723â†’
   724â†’    if not rule_path.exists():
   725â†’        # Fallback: å°è¯•ç›´æ¥ä½œä¸ºè·¯å¾„ï¼ˆå¤„ç†å·²å¸¦ .md åç¼€çš„æƒ…å†µï¼‰
   726â†’        rule_path = SKILLS_DIR / skill_id / "rules" / rule_id
   727â†’
   728â†’        # æ‹’ç»ç›®å½•
   729â†’        if rule_path.is_dir():
   730â†’            logger.warning(f"load_rule: {rule_id} is a directory, not a rule file")
   731â†’            return None
   732â†’
   733â†’        # å¦‚æœæ²¡æœ‰åç¼€ï¼Œæ·»åŠ  .md
   734â†’        if not rule_path.suffix:
   735â†’            rule_path = rule_path.with_suffix(".md")
   736â†’
   737â†’        # ä»ç„¶ä¸å­˜åœ¨ï¼Œè¿”å› None
   738â†’        if not rule_path.exists():
   739â†’            return None
   740â†’
   741â†’    try:
   742â†’        text = rule_path.read_text(encoding='utf-8')
   743â†’        data = parse_rule_md(text)
   744â†’
   745â†’        return RuleConfig(
   746â†’            id=data.get("id", rule_id),
   747â†’            name=data.get("name", rule_id),
   748â†’            impact=data.get("impact", "MEDIUM"),
   749â†’            impact_description=data.get("impact_description", ""),
   750â†’            tags=data.get("tags", []),
   751â†’            content=data.get("content", ""),
   752â†’            analysis_steps=data.get("analysis_steps", []),
   753â†’            output_requirements=data.get("output_requirements", ""),
   754â†’            common_questions=data.get("common_questions", ""),
   755â†’        )
   756â†’    except Exception as e:
   757â†’        logger.error(f"load_rule: Failed to load {skill_id}/{rule_id}: {e}")
   758â†’        return None
   759â†’
   760â†’
   761â†’def get_skill_rules(skill_id: str) -> List[str]:
   762â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢
   763â†’
   764â†’    è¿”å›æ ¼å¼ï¼š
   765â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   766â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   767â†’    """
   768â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   769â†’    if not rules_dir.exists():
   770â†’        return []
   771â†’
   772â†’    rule_ids = []
   773â†’
   774â†’    # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   775â†’    for md_file in rules_dir.rglob("*.md"):
   776â†’        # è·³è¿‡ _index.md ç­‰
   777â†’        if md_file.stem.startswith("_"):
   778â†’            continue
   779â†’
   780â†’        # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   781â†’        relative_path = md_file.relative_to(rules_dir)
   782â†’        rule_id = str(relative_path.with_suffix(""))
   783â†’
   784â†’        # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   785â†’        rule_id = rule_id.replace("\\", "/")
   786â†’
   787â†’        rule_ids.append(rule_id)
   788â†’
   789â†’    return sorted(rule_ids)
   790â†’
   791â†’
   792â†’def has_rules(skill_id: str) -> bool:
   793â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   794â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   795â†’    if not rules_dir.exists():
   796â†’        return False
   797â†’    rules = list(rules_dir.glob("*.md"))
   798â†’    return len(rules) > 0
   799â†’
   800â†’
   801â†’def get_available_skills() -> List[str]:
   802â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   803â†’    if not SKILLS_DIR.exists():
   804â†’        return []
   805â†’    return [p.name for p in SKILLS_DIR.iterdir()
   806â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   807â†’
   808â†’
   809â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   810â†’# Protocol/Rule å…ƒä¿¡æ¯ï¼ˆç”¨äºæ¶ˆé™¤ç¡¬ç¼–ç ï¼‰
   811â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   812â†’
   813â†’@lru_cache(maxsize=32)
   814â†’def get_protocols_meta(skill_id: str) -> Dict[str, Dict[str, Any]]:
   815â†’    """æ‰«æ rules é¡¶å±‚ .md ä½œä¸ºâ€œåè®®â€ï¼Œè§£æ frontmatter è¿”å› meta æ˜ å°„ã€‚
   816â†’
   817â†’    è¿”å›: {protocol_id: {id, name, estimated_time?, total_steps?, order?, enabled?}}
   818â†’    ä»…æ‰«æè§„åˆ™æ ¹ç›®å½•ï¼Œå¿½ç•¥å­ç›®å½•ï¼ˆå¦‚ companion/ï¼‰ã€‚
   819â†’    """
   820â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   821â†’    metas: Dict[str, Dict[str, Any]] = {}
   822â†’    if not rules_dir.exists():
   823â†’        return metas
   824â†’
   825â†’    for md in rules_dir.glob("*.md"):
   826â†’        if md.stem.startswith("_"):
   827â†’            continue
   828â†’        try:
   829â†’            text = md.read_text(encoding="utf-8")
   830â†’            fm, _ = parse_frontmatter(text)
   831â†’            pid = fm.get("id", md.stem)
   832â†’            metas[pid] = {
   833â†’                "id": pid,
   834â†’                "name": fm.get("name", pid),
   835â†’                "estimated_time": fm.get("estimated_time"),
   836â†’                "total_steps": fm.get("total_steps"),
   837â†’                "order": fm.get("order", 0),
   838â†’                "enabled": fm.get("enabled", True),
   839â†’            }
   840â†’        except Exception:
   841â†’            # å¿½ç•¥å•ä¸ªæ–‡ä»¶é”™è¯¯
   842â†’            continue
   843â†’    return metas
   844â†’
   845â†’
   846â†’@lru_cache(maxsize=32)
   847â†’def get_protocol_ids(skill_id: str) -> List[str]:
   848â†’    """è¿”å›å¯ç”¨çš„åè®® ID åˆ—è¡¨ï¼ˆæŒ‰ order/name æ’åºï¼‰ã€‚"""
   849â†’    metas = get_protocols_meta(skill_id)
   850â†’    enabled = [m for m in metas.values() if m.get("enabled", True)]
   851â†’    enabled.sort(key=lambda m: (m.get("order", 0), m.get("name", m.get("id"))))
   852â†’    return [m["id"] for m in enabled]
   853â†’
   854â†’
   855â†’def get_rule_name(skill_id: str, rule_id: str) -> str:
   856â†’    """è¿”å›è§„åˆ™æ˜¾ç¤ºåï¼ˆfrontmatter.nameï¼‰ï¼Œå¤±è´¥åˆ™å›é€€ rule_idã€‚"""
   857â†’    rc = load_rule(skill_id, rule_id)
   858â†’    return rc.name if rc else rule_id
   859â†’
   860â†’
   861â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   862â†’# Case Index é…ç½®ï¼ˆç”¨äºæå–ç‰¹å¾å­—æ®µï¼Œæ¶ˆé™¤ç¡¬ç¼–ç ï¼‰
   863â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   864â†’
   865â†’@lru_cache(maxsize=64)
   866â†’def get_case_index_config(skill_id: str) -> Dict[str, Any]:
   867â†’    """ä» SKILL.md frontmatter è¯»å– case_index é…ç½®ã€‚
   868â†’
   869â†’    çº¦å®šï¼š
   870â†’    case_index:
   871â†’      nested_key: "chart"   # å¯é€‰
   872â†’      fields: ["daymaster", "strength", "pattern"]  # å¿…é€‰
   873â†’    æˆ–ç®€å†™ï¼šcase_fields: ["..."]
   874â†’    """
   875â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   876â†’    if not skill_path.exists():
   877â†’        return {}
   878â†’    try:
   879â†’        text = skill_path.read_text(encoding="utf-8")
   880â†’        fm, _ = parse_frontmatter(text)
   881â†’        cfg = fm.get("case_index") or {}
   882â†’        if not cfg and fm.get("case_fields"):
   883â†’            cfg = {"fields": fm.get("case_fields")}
   884â†’        # è§„èŒƒåŒ–
   885â†’        nested_key = cfg.get("nested_key")
   886â†’        fields = cfg.get("fields") if isinstance(cfg.get("fields"), list) else []
   887â†’        return {"nested_key": nested_key, "fields": fields}
   888â†’    except Exception:
   889â†’        return {}
   890â†’
   891â†’
   892â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   893â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   894â†’
   895â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   896â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   897â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼Œæ”¯æŒå­ç›®å½•ï¼‰
   898â†’
   899â†’    è¿”å›æ ¼å¼ï¼š
   900â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   901â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   902â†’    """
   903â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   904â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   905â†’    if rules_dir.exists():
   906â†’        rule_ids = []
   907â†’        # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   908â†’        for md_file in rules_dir.rglob("*.md"):
   909â†’            # è·³è¿‡ _index.md ç­‰
   910â†’            if md_file.stem.startswith("_"):
   911â†’                continue
   912â†’
   913â†’            # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   914â†’            relative_path = md_file.relative_to(rules_dir)
   915â†’            rule_id = str(relative_path.with_suffix(""))
   916â†’
   917â†’            # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   918â†’            rule_id = rule_id.replace("\\", "/")
   919â†’
   920â†’            rule_ids.append(rule_id)
   921â†’
   922â†’        if rule_ids:
   923â†’            return sorted(rule_ids)
   924â†’
   925â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   926â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   927â†’    if not scenarios_dir.exists():
   928â†’        return []
   929â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   930â†’
   931â†’
   932â†’def get_skill_triggers() -> Dict[str, List[str]]:
   933â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   934â†’    triggers = {}
   935â†’    for skill_id in get_available_skills():
   936â†’        if skill_id == "core":
   937â†’            continue
   938â†’        skill = load_skill(skill_id)
   939â†’        if skill and skill.triggers:
   940â†’            triggers[skill_id] = skill.triggers
   941â†’    return triggers
   942â†’
   943â†’
   944â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   945â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   946â†’    skill = load_skill(skill_id)
   947â†’    if skill and skill.global_tools:
   948â†’        return skill.global_tools
   949â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   950â†’    return []
   951â†’
   952â†’
   953â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   954â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   955â†’    skill = load_skill(skill_id)
   956â†’    if skill and skill.external_tools:
   957â†’        return skill.external_tools
   958â†’    return []
   959â†’
   960â†’
   961â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   962â†’# v10: è·¨æŠ€èƒ½å¥‘çº¦åŠ è½½
   963â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   964â†’
   965â†’# å¥‘çº¦ç¼“å­˜
   966â†’_skill_contracts_cache: Optional[Dict[str, Any]] = None
   967â†’
   968â†’
   969â†’def load_skill_contract(skill_id: str) -> Optional[Any]:
   970â†’    """åŠ è½½å•ä¸ª Skill çš„å¥‘çº¦ï¼ˆexports + importsï¼‰
   971â†’
   972â†’    Args:
   973â†’        skill_id: Skill ID
   974â†’
   975â†’    Returns:
   976â†’        SkillContract å¯¹è±¡ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å› None
   977â†’    """
   978â†’    from .schemas.skill_contract import parse_skill_contract
   979â†’
   980â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   981â†’    if not skill_path.exists():
   982â†’        return None
   983â†’
   984â†’    try:
   985â†’        text = skill_path.read_text(encoding='utf-8')
   986â†’        metadata, _ = parse_frontmatter(text)
   987â†’        return parse_skill_contract(skill_id, metadata)
   988â†’    except Exception as e:
   989â†’        logger.warning(f"Failed to load contract for {skill_id}: {e}")
   990â†’        return None
   991â†’
   992â†’
   993â†’def load_all_skill_contracts() -> Dict[str, Any]:
   994â†’    """åŠ è½½æ‰€æœ‰ Skill çš„å¥‘çº¦
   995â†’
   996â†’    Returns:
   997â†’        {skill_id: SkillContract}
   998â†’    """
   999â†’    global _skill_contracts_cache
  1000â†’
  1001â†’    if _skill_contracts_cache is not None:
  1002â†’        return _skill_contracts_cache
  1003â†’
  1004â†’    _skill_contracts_cache = {}
  1005â†’
  1006â†’    for skill_id in get_available_skills():
  1007â†’        contract = load_skill_contract(skill_id)
  1008â†’        if contract:
  1009â†’            _skill_contracts_cache[skill_id] = contract
  1010â†’
  1011â†’    logger.info(f"[v10] Loaded {len(_skill_contracts_cache)} skill contracts")
  1012â†’    return _skill_contracts_cache
  1013â†’
  1014â†’
  1015â†’def get_skill_exports(skill_id: str) -> Optional[Any]:
  1016â†’    """è·å– Skill çš„ exports å£°æ˜
  1017â†’
  1018â†’    Args:
  1019â†’        skill_id: Skill ID
  1020â†’
  1021â†’    Returns:
  1022â†’        SkillExports å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰å£°æ˜åˆ™è¿”å› None
  1023â†’    """
  1024â†’    contract = load_skill_contract(skill_id)
  1025â†’    return contract.exports if contract else None
  1026â†’
  1027â†’
  1028â†’def get_skill_imports(skill_id: str) -> List[Any]:
  1029â†’    """è·å– Skill çš„ imports å£°æ˜
  1030â†’
  1031â†’    Args:
  1032â†’        skill_id: Skill ID
  1033â†’
  1034â†’    Returns:
  1035â†’        SkillImport åˆ—è¡¨
  1036â†’    """
  1037â†’    contract = load_skill_contract(skill_id)
  1038â†’    return contract.imports if contract else []
  1039â†’
  1040â†’
  1041â†’def get_imported_tool_names(skill_id: str) -> List[str]:
  1042â†’    """è·å– Skill é€šè¿‡ imports å£°æ˜çš„æ‰€æœ‰å·¥å…·åï¼ˆæ‰å¹³åŒ–ï¼‰
  1043â†’
  1044â†’    Args:
  1045â†’        skill_id: Skill ID
  1046â†’
  1047â†’    Returns:
  1048â†’        å·¥å…·ååˆ—è¡¨
  1049â†’    """
  1050â†’    contract = load_skill_contract(skill_id)
  1051â†’    if not contract:
  1052â†’        return []
  1053â†’    return contract.get_all_imported_tool_names()
  1054â†’
  1055â†’
  1056â†’def get_imported_tools_by_provider(skill_id: str) -> Dict[str, List[str]]:
  1057â†’    """è·å– Skill ä»å„ Provider å¯¼å…¥çš„å·¥å…·
  1058â†’
  1059â†’    Args:
  1060â†’        skill_id: Skill ID
  1061â†’
  1062â†’    Returns:
  1063â†’        {provider_skill_id: [tool_name, ...]}
  1064â†’    """
  1065â†’    contract = load_skill_contract(skill_id)
  1066â†’    if not contract:
  1067â†’        return {}
  1068â†’    return contract.get_imported_tools()
  1069â†’
  1070â†’
  1071â†’def validate_all_contracts() -> Any:
  1072â†’    """æ ¡éªŒæ‰€æœ‰ Skill å¥‘çº¦
  1073â†’
  1074â†’    Returns:
  1075â†’        ContractValidationResult
  1076â†’    """
  1077â†’    from .validators import validate_skill_contracts
  1078â†’
  1079â†’    contracts = load_all_skill_contracts()
  1080â†’    return validate_skill_contracts(contracts)
  1081â†’
  1082â†’
  1083â†’def clear_contracts_cache():
  1084â†’    """æ¸…é™¤å¥‘çº¦ç¼“å­˜"""
  1085â†’    global _skill_contracts_cache
  1086â†’    _skill_contracts_cache = None
  1087â†’    logger.info("[v10] Contracts cache cleared")
  1088â†’
  1089â†’
  1090â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1091â†’# V9: æ¸è¿›å¼åŠ è½½å‡½æ•°
  1092â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1093â†’
  1094â†’def get_core_skill() -> SkillFull:
  1095â†’    """è·å– Core Skillï¼ˆå…¨ç¨‹å¯ç”¨ï¼Œå…¨æ–‡åŠ è½½ï¼‰- V9 æ–°å¢
  1096â†’
  1097â†’    Core Skill å§‹ç»ˆå…¨æ–‡åŠ è½½ï¼Œä¸å‚ä¸æ¸è¿›å¼åŠ è½½ã€‚
  1098â†’    è¿”å›åŒ…å« SKILL.md å…¨æ–‡å’Œå·¥å…·å®šä¹‰çš„ SkillFull å¯¹è±¡ã€‚
  1099â†’    """
  1100â†’    global _core_skill_cache
  1101â†’
  1102â†’    if _core_skill_cache is not None:
  1103â†’        return _core_skill_cache
  1104â†’
  1105â†’    skill_id = "core"
  1106â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
  1107â†’
  1108â†’    if not skill_path.exists():
  1109â†’        # è¿”å›ç©ºçš„ Core Skill
  1110â†’        _core_skill_cache = SkillFull(
  1111â†’            meta=SkillMeta(id="core", name="Vibe", description="ç”Ÿå‘½å¯¹è¯è€…"),
  1112â†’            content="",
  1113â†’            tools=[],
  1114â†’            rules={}
  1115â†’        )
  1116â†’        return _core_skill_cache
  1117â†’
  1118â†’    text = skill_path.read_text(encoding='utf-8')
  1119â†’    metadata, content = parse_frontmatter(text)
  1120â†’
  1121â†’    # æ„å»º SkillMeta
  1122â†’    meta = SkillMeta(
  1123â†’        id=metadata.get("id", skill_id),
  1124â†’        name=metadata.get("name", "Vibe"),
  1125â†’        description=metadata.get("description", ""),
  1126â†’        triggers=metadata.get("triggers", []),
  1127â†’        category=metadata.get("category", "core"),
  1128â†’    )
  1129â†’
  1130â†’    # åŠ è½½å·¥å…·å®šä¹‰
  1131â†’    tools = _load_skill_tools(skill_id)
  1132â†’
  1133â†’    # åŠ è½½è§„åˆ™æ–‡ä»¶
  1134â†’    rules = _load_skill_rules_content(skill_id)
  1135â†’
  1136â†’    _core_skill_cache = SkillFull(
  1137â†’        meta=meta,
  1138â†’        content=content,
  1139â†’        tools=tools,
  1140â†’        rules=rules,
  1141â†’    )
  1142â†’
  1143â†’    logger.info(f"[V9] Core skill loaded: {len(content)} chars, {len(tools)} tools, {len(rules)} rules")
  1144â†’    return _core_skill_cache
  1145â†’
  1146â†’
  1147â†’def load_all_skill_metas() -> Dict[str, SkillMeta]:
  1148â†’    """å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰é Core Skill çš„ frontmatter - V9 æ–°å¢
  1149â†’
  1150â†’    åªåŠ è½½ frontmatterï¼ˆSkillMetaï¼‰ï¼Œç”¨äº Phase 1 è·¯ç”±ã€‚
  1151â†’    description å†…åµŒå·¥å…·åˆ—è¡¨ï¼Œæ— éœ€é¢å¤–åŠ è½½ã€‚
  1152â†’    """
  1153â†’    global _skill_metas_cache
  1154â†’
  1155â†’    if _skill_metas_cache is not None:
  1156â†’        return _skill_metas_cache
  1157â†’
  1158â†’    _skill_metas_cache = {}
  1159â†’
  1160â†’    for skill_id in get_available_skills():
  1161â†’        if skill_id == "core":
  1162â†’            continue
  1163â†’
  1164â†’        skill_path = SKILLS_DIR / skill_id / "SKILL.md"
  1165â†’        if not skill_path.exists():
  1166â†’            continue
  1167â†’
  1168â†’        try:
  1169â†’            text = skill_path.read_text(encoding='utf-8')
  1170â†’            metadata, _ = parse_frontmatter(text)
  1171â†’
  1172â†’            # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
  1173â†’            triggers = metadata.get("triggers", [])
  1174â†’            if not triggers:
  1175â†’                description = metadata.get("description", "")
  1176â†’                trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
  1177â†’                if trigger_match:
  1178â†’                    trigger_str = trigger_match.group(1)
  1179â†’                    triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
  1180â†’
  1181â†’            tools_list = _extract_tools_list(skill_id, metadata.get("description", ""))
  1182â†’
  1183â†’            _skill_metas_cache[skill_id] = SkillMeta(
  1184â†’                id=metadata.get("id", skill_id),
  1185â†’                name=metadata.get("name", skill_id),
  1186â†’                description=metadata.get("description", ""),
  1187â†’                triggers=triggers,
  1188â†’                category=metadata.get("category", "professional"),
  1189â†’                tools_list=tools_list,
  1190â†’            )
  1191â†’        except Exception as e:
  1192â†’            logger.warning(f"[V9] Failed to load skill meta for {skill_id}: {e}")
  1193â†’
  1194â†’    logger.info(f"[V9] Loaded {len(_skill_metas_cache)} skill metas")
  1195â†’    return _skill_metas_cache
  1196â†’
  1197â†’
  1198â†’def load_skill_full(skill_id: str) -> Optional[SkillFull]:
  1199â†’    """æŒ‰éœ€åŠ è½½ Skill å®Œæ•´å†…å®¹ - V9 æ–°å¢
  1200â†’
  1201â†’    Phase 2 æ—¶è°ƒç”¨ï¼ŒåŠ è½½ SKILL.md å…¨æ–‡ã€å·¥å…·å®šä¹‰ã€è§„åˆ™æ–‡ä»¶ã€‚
  1202â†’    """
  1203â†’    if skill_id == "core":
  1204â†’        return get_core_skill()
  1205â†’
  1206â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
  1207â†’    if not skill_path.exists():
  1208â†’        return None
  1209â†’
  1210â†’    try:
  1211â†’        text = skill_path.read_text(encoding='utf-8')
  1212â†’        metadata, content = parse_frontmatter(text)
  1213â†’
  1214â†’        # ä» description ä¸­æå–è§¦å‘è¯
  1215â†’        triggers = metadata.get("triggers", [])
  1216â†’        if not triggers:
  1217â†’            description = metadata.get("description", "")
  1218â†’            trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
  1219â†’            if trigger_match:
  1220â†’                trigger_str = trigger_match.group(1)
  1221â†’                triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
  1222â†’
  1223â†’        meta = SkillMeta(
  1224â†’            id=metadata.get("id", skill_id),
  1225â†’            name=metadata.get("name", skill_id),
  1226â†’            description=metadata.get("description", ""),
  1227â†’            triggers=triggers,
  1228â†’            category=metadata.get("category", "professional"),
  1229â†’        )
  1230â†’
  1231â†’        # åŠ è½½å·¥å…·å®šä¹‰
  1232â†’        tools = _load_skill_tools(skill_id)
  1233â†’
  1234â†’        # åŠ è½½è§„åˆ™æ–‡ä»¶
  1235â†’        rules = _load_skill_rules_content(skill_id)
  1236â†’
  1237â†’        skill_full = SkillFull(
  1238â†’            meta=meta,
  1239â†’            content=content,
  1240â†’            tools=tools,
  1241â†’            rules=rules,
  1242â†’        )
  1243â†’
  1244â†’        logger.info(f"[V9] Skill {skill_id} full loaded: {len(content)} chars, {len(tools)} tools, {len(rules)} rules")
  1245â†’        return skill_full
  1246â†’
  1247â†’    except Exception as e:
  1248â†’        logger.error(f"[V9] Failed to load skill full for {skill_id}: {e}")
  1249â†’        return None
  1250â†’
  1251â†’
  1252â†’def _load_skill_tools(skill_id: str) -> List[ToolDef]:
  1253â†’    """åŠ è½½ Skill çš„å·¥å…·å®šä¹‰ - V9 å†…éƒ¨å‡½æ•°"""
  1254â†’    tools_path = SKILLS_DIR / skill_id / "tools" / "tools.yaml"
  1255â†’    if not tools_path.exists():
  1256â†’        return []
  1257â†’
  1258â†’    try:
  1259â†’        text = tools_path.read_text(encoding='utf-8')
  1260â†’        data = yaml.safe_load(text) or {}
  1261â†’
  1262â†’        tools = []
  1263â†’        # V9 æ ¼å¼ï¼štools åˆ—è¡¨
  1264â†’        if "tools" in data:
  1265â†’            for tool in data["tools"]:
  1266â†’                tools.append(ToolDef(
  1267â†’                    name=tool.get("name", ""),
  1268â†’                    description=tool.get("description", ""),
  1269â†’                    parameters={p.get("name", ""): p for p in tool.get("parameters", [])},
  1270â†’                    tool_type=tool.get("type", "action"),
  1271â†’                ))
  1272â†’        else:
  1273â†’            # V2 æ ¼å¼ï¼šæŒ‰ç±»åˆ«åˆ†ç»„
  1274â†’            for category in ["routing", "collect", "action", "search", "display", "trigger"]:
  1275â†’                for tool in data.get(category, []):
  1276â†’                    tools.append(ToolDef(
  1277â†’                        name=tool.get("name", ""),
  1278â†’                        description=tool.get("description", ""),
  1279â†’                        parameters={p.get("name", ""): p for p in tool.get("parameters", [])},
  1280â†’                        tool_type=category,
  1281â†’                    ))
  1282â†’
  1283â†’        return tools
  1284â†’    except Exception as e:
  1285â†’        logger.warning(f"[V9] Failed to load tools for {skill_id}: {e}")
  1286â†’        return []
  1287â†’
  1288â†’
  1289â†’def _load_skill_rules_content(skill_id: str) -> Dict[str, str]:
  1290â†’    """åŠ è½½ Skill çš„æ‰€æœ‰è§„åˆ™æ–‡ä»¶å†…å®¹ - V9 å†…éƒ¨å‡½æ•°"""
  1291â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
  1292â†’    if not rules_dir.exists():
  1293â†’        return {}
  1294â†’
  1295â†’    rules = {}
  1296â†’    for md_file in rules_dir.rglob("*.md"):
  1297â†’        if md_file.stem.startswith("_"):
  1298â†’            continue
  1299â†’
  1300â†’        try:
  1301â†’            relative_path = md_file.relative_to(rules_dir)
  1302â†’            rule_id = str(relative_path.with_suffix("")).replace("\\", "/")
  1303â†’            rules[rule_id] = md_file.read_text(encoding='utf-8')
  1304â†’        except Exception as e:
  1305â†’            logger.warning(f"[V9] Failed to load rule {md_file}: {e}")
  1306â†’
  1307â†’    return rules
  1308â†’
  1309â†’
  1310â†’def build_phase1_prompt() -> str:
  1311â†’    """æ„å»º Phase 1 System Prompt - V9 æ–°å¢
  1312â†’
  1313â†’    Phase 1 æä¾›ï¼š
  1314â†’    - Core Skill å…¨æ–‡ï¼ˆç²¾ç®€ç‰ˆï¼‰
  1315â†’    - å…¶ä»– Skill çš„ frontmatter åˆ—è¡¨ï¼ˆid, name, descriptionï¼‰
  1316â†’
  1317â†’    LLM åŸºäºæ­¤é€‰æ‹© Skill(s)ã€‚
  1318â†’    """
  1319â†’    parts = []
  1320â†’
  1321â†’    # 1. Core Skill å…¨æ–‡ï¼ˆç²¾ç®€æ–‡æœ¬ä¼˜å…ˆï¼šè‹¥è¶…è¿‡ 5000 å­—ç¬¦åˆ™æˆªæ–­ï¼‰
  1322â†’    core = get_core_skill()
  1323â†’    core_text = core.content
  1324â†’    if len(core_text) > 5000:
  1325â†’        core_text = core_text[:5000] + "\n\nâ€¦"
  1326â†’    parts.append(f"# {core.meta.name}\n\n{core_text}")
  1327â†’
  1328â†’    # 2. å¯ç”¨ Skill åˆ—è¡¨
  1329â†’    skill_metas = load_all_skill_metas()
  1330â†’    if skill_metas:
  1331â†’        parts.append("\n---\n\n## å¯ç”¨åŠŸèƒ½\n")
  1332â†’        parts.append("æ ¹æ®ç”¨æˆ·æ„å›¾ï¼Œå¯è°ƒç”¨ activate_skills æ¿€æ´»ä¸€ä¸ªæˆ–å¤šä¸ªæŠ€èƒ½ï¼š\n")
  1333â†’
  1334â†’        for skill_id, meta in sorted(skill_metas.items()):
  1335â†’            desc = meta.description.strip().replace('\n', ' ')
  1336â†’            if len(desc) > 120:
  1337â†’                desc = desc[:120] + 'â€¦'
  1338â†’            line = f"- **{meta.name}** (`{skill_id}`): {desc}"
  1339â†’            if meta.tools_list:
  1340â†’                tools_text = ", ".join(meta.tools_list[:6])
  1341â†’                line += f"ï¼ˆå·¥å…·ï¼š{tools_text}ï¼‰"
  1342â†’            parts.append(line)
  1343â†’
  1344â†’    # 3. è¾¹ç•Œè§„åˆ™ï¼ˆæ¥è‡ª core/rules/boundary.mdï¼‰
  1345â†’    boundary = load_boundary_rules_text()
  1346â†’    if boundary:
  1347â†’        parts.append("\n---\n")
  1348â†’        parts.append(boundary)
  1349â†’
  1350â†’    return "\n".join(parts)
  1351â†’
  1352â†’
  1353â†’def _extract_tools_list(skill_id: str, description: str) -> List[str]:
  1354â†’    """æå–å·¥å…·åæ¸…å•ï¼ˆä¼˜å…ˆ tools.yamlï¼Œå…¶æ¬¡ä» description æ­£åˆ™è§£æï¼‰ã€‚"""
  1355â†’    try:
  1356â†’        import yaml  # æœ¬åœ°ä¾èµ–
  1357â†’        tools_yaml = SKILLS_DIR / skill_id / "tools" / "tools.yaml"
  1358â†’        if tools_yaml.exists():
  1359â†’            data = yaml.safe_load(tools_yaml.read_text(encoding='utf-8')) or {}
  1360â†’            tools = []
  1361â†’            # å…¼å®¹ä¸¤ç§ç»“æ„ï¼šé¡¶å±‚ tools: [] æˆ– æŒ‰åˆ†ç»„é”® []
  1362â†’            if isinstance(data.get("tools"), list):
  1363â†’                for item in data["tools"]:
  1364â†’                    if isinstance(item, dict) and item.get("name"):
  1365â†’                        tools.append(item["name"])
  1366â†’            # éå†æ‰€æœ‰ä¸€çº§åˆ†ç»„é”®
  1367â†’            for k, v in data.items():
  1368â†’                if k in {"version", "skill_id", "description", "phase1_tools"}:
  1369â†’                    continue
  1370â†’                if isinstance(v, list):
  1371â†’                    for item in v:
  1372â†’                        if isinstance(item, dict) and item.get("name"):
  1373â†’                            tools.append(item["name"])
  1374â†’            # å»é‡ä¿æŒé¡ºåº
  1375â†’            seen = set()
  1376â†’            dedup = []
  1377â†’            for t in tools:
  1378â†’                if t not in seen:
  1379â†’                    seen.add(t)
  1380â†’                    dedup.append(t)
  1381â†’            return dedup
  1382â†’    except Exception as e:
  1383â†’        logger.debug(f"[V9] extract tools_list failed for {skill_id}: {e}")
  1384â†’
  1385â†’    # å›é€€ï¼šä» description æå–
  1386â†’    match = re.search(r'å·¥å…·[ï¼š:]\s*([^\nã€‚]+)', description or "")
  1387â†’    if match:
  1388â†’        return [t.strip() for t in re.split(r'[ã€,ï¼Œ]', match.group(1)) if t.strip()]
  1389â†’    return []
  1390â†’
  1391â†’
  1392â†’def load_boundary_rules_text() -> str:
  1393â†’    """è¯»å– Core è¾¹ç•Œè§„åˆ™ï¼ˆcore/rules/boundary.mdï¼‰ã€‚æ‰¾ä¸åˆ°åˆ™è¿”å›ç©ºã€‚"""
  1394â†’    path = SKILLS_DIR / "core" / "rules" / "boundary.md"
  1395â†’    try:
  1396â†’        if path.exists():
  1397â†’            return path.read_text(encoding='utf-8')
  1398â†’    except Exception as e:
  1399â†’        logger.debug(f"[V9] load boundary rules failed: {e}")
  1400â†’    return ""
  1401â†’
  1402â†’
  1403â†’def build_phase2_prompt(
  1404â†’    active_skills: List[str],
  1405â†’    user_context: Optional[Dict] = None,
  1406â†’    active_rule: Optional[str] = None
  1407â†’) -> str:
  1408â†’    """æ„å»º Phase 2 System Prompt - V9 æ–°å¢
  1409â†’
  1410â†’    Phase 2 æä¾›ï¼š
  1411â†’    - Core Skill å…¨æ–‡ï¼ˆå§‹ç»ˆå­˜åœ¨ï¼‰
  1412â†’    - å·²æ¿€æ´» Skill çš„å®Œæ•´ SKILL.md
  1413â†’    - ç›¸å…³ rules/*.md
  1414â†’    - Profile + Skill Data
  1415â†’
  1416â†’    Args:
  1417â†’        active_skills: å·²æ¿€æ´»çš„ Skill ID åˆ—è¡¨
  1418â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1419â†’        active_rule: å½“å‰æ¿€æ´»çš„è§„åˆ™ ID
  1420â†’
  1421â†’    Returns:
  1422â†’        å®Œæ•´çš„ System Prompt
  1423â†’    """
  1424â†’    parts = []
  1425â†’
  1426â†’    # 1. Core Skill å…¨æ–‡
  1427â†’    core = get_core_skill()
  1428â†’    parts.append(f"# {core.meta.name}\n\n{core.content}")
  1429â†’
  1430â†’    # 2. å·²æ¿€æ´» Skill çš„å®Œæ•´å†…å®¹
  1431â†’    for skill_id in active_skills:
  1432â†’        if skill_id == "core":
  1433â†’            continue
  1434â†’
  1435â†’        skill_full = load_skill_full(skill_id)
  1436â†’        if skill_full:
  1437â†’            parts.append(f"\n---\n\n# {skill_full.meta.name}\n\n{skill_full.content}")
  1438â†’
  1439â†’            # å¦‚æœæœ‰æ¿€æ´»çš„è§„åˆ™ï¼ŒåŠ è½½è§„åˆ™å†…å®¹
  1440â†’            if active_rule and active_rule in skill_full.rules:
  1441â†’                rule_content = skill_full.rules[active_rule]
  1442â†’                _, rule_body = parse_frontmatter(rule_content)
  1443â†’                parts.append(f"\n## å½“å‰è§„åˆ™\n{rule_body}")
  1444â†’
  1445â†’    # 3. è¾¹ç•Œè§„åˆ™ï¼ˆæ¥è‡ª core/rules/boundary.mdï¼‰
  1446â†’    boundary = load_boundary_rules_text()
  1447â†’    if boundary:
  1448â†’        parts.append(boundary)
  1449â†’
  1450â†’    # 4. ç”¨æˆ·ä¸Šä¸‹æ–‡
  1451â†’    if user_context:
  1452â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1453â†’
  1454â†’        # å‡ºç”Ÿä¿¡æ¯
  1455â†’        if user_context.get("birth_info"):
  1456â†’            birth_info = user_context['birth_info']
  1457â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼‰\n"
  1458â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1459â†’
  1460â†’        # VibeInsight
  1461â†’        vibe = user_context.get("vibe", {})
  1462â†’        if vibe.get("insight"):
  1463â†’            insight = vibe["insight"]
  1464â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n"
  1465â†’            if insight.get("essence", {}).get("archetype", {}).get("primary"):
  1466â†’                ctx_text += f"- ä¸»è¦åŸå‹: {insight['essence']['archetype']['primary']}\n"
  1467â†’
  1468â†’        # VibeTarget
  1469â†’        if vibe.get("target"):
  1470â†’            target = vibe["target"]
  1471â†’            if target.get("north_star", {}).get("vision_scene"):
  1472â†’                ctx_text += f"\n### æ„¿æ™¯\n{target['north_star']['vision_scene'][:200]}\n"
  1473â†’
  1474â†’        parts.append(ctx_text)
  1475â†’
  1476â†’    return "\n".join(parts)
  1477â†’
  1478â†’
  1479â†’def clear_v9_cache():
  1480â†’    """æ¸…é™¤ V9 ç¼“å­˜ - V9 æ–°å¢"""
  1481â†’    global _core_skill_cache, _skill_metas_cache
  1482â†’    _core_skill_cache = None
  1483â†’    _skill_metas_cache = None
  1484â†’    logger.info("[V9] Cache cleared")
  1485â†’
  1486â†’
  1487â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1488â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
  1489â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1490â†’
  1491â†’def skill_requires_birth_info(skill_id: str) -> bool:
  1492â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
  1493â†’    skill = load_skill(skill_id)
  1494â†’    return skill.requires_birth_info if skill else False
  1495â†’
  1496â†’
  1497â†’def skill_requires_compute(skill_id: str) -> bool:
  1498â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
  1499â†’    skill = load_skill(skill_id)
  1500â†’    return skill.requires_compute if skill else False
  1501â†’
  1502â†’
  1503â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
  1504â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
  1505â†’
  1506â†’    è¿”å›å€¼ï¼š
  1507â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
  1508â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
  1509â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
  1510â†’    """
  1511â†’    skill = load_skill(skill_id)
  1512â†’    return skill.compute_type if skill else None
  1513â†’
  1514â†’
  1515â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
  1516â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
  1517â†’
  1518â†’    è¿”å›å€¼ï¼š
  1519â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
  1520â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
  1521â†’    """
  1522â†’    skill = load_skill(skill_id)
  1523â†’    return skill.compute_tool if skill else None
  1524â†’
  1525â†’
  1526â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
  1527â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
  1528â†’
  1529â†’    è¿”å›å€¼ï¼š
  1530â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
  1531â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
  1532â†’    """
  1533â†’    skill = load_skill(skill_id)
  1534â†’    return skill.collect_tool if skill else None
  1535â†’
  1536â†’
  1537â†’def get_skill_required_data(skill_id: str) -> List[str]:
  1538â†’    """è·å– Skill éœ€è¦çš„ skill_data åˆ—è¡¨ï¼ˆé…ç½®é©±åŠ¨ï¼‰- v2.2
  1539â†’
  1540â†’    è¿”å›å€¼ï¼š
  1541â†’    - é…ç½®çš„ skill_data åˆ—è¡¨ï¼ˆå¦‚ ["bazi", "zodiac"]ï¼‰
  1542â†’    - ç©ºåˆ—è¡¨æ—¶è¿”å› [skill_id]ï¼ˆé»˜è®¤åªéœ€è‡ªèº«æ•°æ®ï¼‰
  1543â†’
  1544â†’    ç¤ºä¾‹ï¼š
  1545â†’    - bazi â†’ ["bazi"]ï¼ˆé»˜è®¤ï¼Œåªéœ€è‡ªèº«ï¼‰
  1546â†’    - jungastro â†’ ["bazi", "zodiac"]ï¼ˆé…ç½®äº† requires_skill_dataï¼‰
  1547â†’    - vibe_id â†’ ["bazi", "zodiac"]ï¼ˆé…ç½®äº† requires_skill_dataï¼‰
  1548â†’    """
  1549â†’    skill = load_skill(skill_id)
  1550â†’    if skill and skill.requires_skill_data:
  1551â†’        return skill.requires_skill_data
  1552â†’    return [skill_id]  # é»˜è®¤åªéœ€è‡ªèº«
  1553â†’
  1554â†’
  1555â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1556â†’# System Prompt æ„å»º
  1557â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1558â†’
  1559â†’# V2: è¯­æ°”æ¨¡å¼ Prompt æ¨¡æ¿
  1560â†’# ä¸æ•°æ®åº“çº¦æŸä¸€è‡´ï¼šwarm, sarcastic, wise
  1561â†’VOICE_MODE_PROMPTS = {
  1562â†’    "warm": """## è¯­æ°”é£æ ¼ï¼šæ¸©æš–æ”¯æŒå‹
  1563â†’åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿã€‚
  1564â†’- ç”¨"æˆ‘ä»¬"è€Œé"ä½ åº”è¯¥"
  1565â†’- å…ˆè‚¯å®šæ„Ÿå—ï¼Œå†å¼•å¯¼æ€è€ƒ
  1566â†’- ç”¨é—®é¢˜ä»£æ›¿å»ºè®®
  1567â†’""",
  1568â†’    "sarcastic": """## è¯­æ°”é£æ ¼ï¼šç›´æ¥æŒ‘æˆ˜å‹ï¼ˆæ¯’èˆŒä½†æœ‰çˆ±ï¼‰
  1569â†’ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸ã€‚
  1570â†’- ç›´æ¥æŒ‡å‡ºé—®é¢˜ï¼Œä¸ç»•å¼¯å­
  1571â†’- ç”¨å¹½é»˜ç¼“è§£çŠ€åˆ©ï¼Œé¿å…ä¼¤å®³
  1572â†’- åœ¨åæ§½ä¸­å¸¦ç€æœŸå¾…å’Œå…³å¿ƒ
  1573â†’- æ•¢è¯´çœŸè¯ï¼Œä½†ä»ä¸æ¶æ„æ”»å‡»
  1574â†’""",
  1575â†’    "wise": """## è¯­æ°”é£æ ¼ï¼šç¿æ™ºå¯¼å¸ˆå‹
  1576â†’åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒã€‚
  1577â†’- ä»æ›´é«˜è§†è§’çœ‹å¾…é—®é¢˜
  1578â†’- å¼•ç”¨ç»å…¸æ™ºæ…§å’ŒåŸç†
  1579â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡ç‚¹è¿·æ´¥
  1580â†’- å¸®åŠ©çœ‹åˆ°æ›´é•¿è¿œçš„æ„ä¹‰
  1581â†’"""
  1582â†’}
  1583â†’
  1584â†’
  1585â†’def _build_persona_prompt(skill_id: str, user_context: Optional[Dict] = None) -> Optional[str]:
  1586â†’    """
  1587â†’    LLM-First v10.3: Persona Prompt - ç®€åŒ–ç‰ˆ
  1588â†’
  1589â†’    ä» SKILL.md æˆ– rules/persona.md è¯»å– persona æ¨¡æ¿ï¼Œ
  1590â†’    åªåšç®€å•çš„å˜é‡æ›¿æ¢ï¼Œä¸åš if/elif æ¡ä»¶åˆ¤æ–­ã€‚
  1591â†’
  1592â†’    Args:
  1593â†’        skill_id: Skill ID
  1594â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1595â†’
  1596â†’    Returns:
  1597â†’        Persona prompt å­—ç¬¦ä¸²ï¼Œæˆ– None
  1598â†’    """
  1599â†’    # å°è¯•ä» rules/persona.md åŠ è½½ persona æ¨¡æ¿
  1600â†’    persona_path = SKILLS_DIR / skill_id / "rules" / "persona.md"
  1601â†’    if not persona_path.exists():
  1602â†’        return None
  1603â†’
  1604â†’    try:
  1605â†’        persona_template = persona_path.read_text(encoding='utf-8')
  1606â†’        _, content = parse_frontmatter(persona_template)
  1607â†’
  1608â†’        # ç®€å•å˜é‡æ›¿æ¢ï¼ˆå¦‚æœæœ‰ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼‰
  1609â†’        if user_context:
  1610â†’            skills = user_context.get("skills", {})
  1611â†’            skill_data = skills.get(skill_id, {})
  1612â†’
  1613â†’            # æ›¿æ¢å¸¸ç”¨å˜é‡
  1614â†’            north_star = skill_data.get("north_star", {})
  1615â†’            content = content.replace("{vision_scene}", north_star.get("vision_scene", ""))
  1616â†’            content = content.replace("{vision_timeframe}", north_star.get("vision_timeframe", ""))
  1617â†’
  1618â†’            identity_data = skill_data.get("identity", {})
  1619â†’            content = content.replace("{identity_target}", identity_data.get("target", ""))
  1620â†’
  1621â†’        return content
  1622â†’    except Exception as e:
  1623â†’        logger.warning(f"[LLM-First] Failed to load persona for {skill_id}: {e}")
  1624â†’        return None
  1625â†’
  1626â†’
  1627â†’@lru_cache(maxsize=32)
  1628â†’def _load_skill_md_content(skill_id: str) -> str:
  1629â†’    """åŠ è½½ SKILL.md å…¨æ–‡å†…å®¹ï¼ˆå»æ‰ frontmatterï¼‰"""
  1630â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
  1631â†’    if not skill_path.exists():
  1632â†’        return ""
  1633â†’    text = skill_path.read_text(encoding='utf-8')
  1634â†’    _, content = parse_frontmatter(text)
  1635â†’    return content
  1636â†’
  1637â†’
  1638â†’def build_system_prompt(
  1639â†’    skill_id: str,
  1640â†’    scenario_id: Optional[str] = None,
  1641â†’    user_context: Optional[Dict] = None
  1642â†’) -> str:
  1643â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
  1644â†’
  1645â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
  1646â†’    v8 æ›´æ–°ï¼šæ”¯æŒ persona å’Œ voice_mode æ³¨å…¥
  1647â†’    v10 æ›´æ–°ï¼šç›´æ¥åŠ è½½ SKILL.md å…¨æ–‡ï¼ˆå»æ‰ frontmatterï¼‰ï¼Œç¡®ä¿æ‰€æœ‰è§„åˆ™éƒ½è¢«åŠ è½½
  1648â†’    """
  1649â†’    parts = []
  1650â†’
  1651â†’    # åŠ è½½ Skill
  1652â†’    skill = load_skill(skill_id)
  1653â†’    if not skill:
  1654â†’        return ""
  1655â†’
  1656â†’    # V2: Persona æ³¨å…¥ï¼ˆåœ¨ä¸“å®¶èº«ä»½ä¹‹å‰ï¼‰- ä»… lifecoach æ”¯æŒ
  1657â†’    persona_prompt = _build_persona_prompt(skill_id, user_context)
  1658â†’    if persona_prompt:
  1659â†’        parts.append(persona_prompt)
  1660â†’    else:
  1661â†’        # v10: ç›´æ¥åŠ è½½ SKILL.md å…¨æ–‡ï¼ˆå»æ‰ frontmatterï¼‰
  1662â†’        skill_md_content = _load_skill_md_content(skill_id)
  1663â†’        if skill_md_content:
  1664â†’            parts.append(skill_md_content)
  1665â†’        else:
  1666â†’            # Fallback: åªåŠ è½½ä¸“å®¶èº«ä»½
  1667â†’            parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1668â†’
  1669â†’    # V2: Voice Mode æ³¨å…¥
  1670â†’    if user_context:
  1671â†’        preferences = user_context.get("preferences", {})
  1672â†’        voice_mode = preferences.get("voice_mode", "warm")
  1673â†’        if voice_mode in VOICE_MODE_PROMPTS:
  1674â†’            parts.append(VOICE_MODE_PROMPTS[voice_mode])
  1675â†’
  1676â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
  1677â†’    if scenario_id:
  1678â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
  1679â†’        if has_rules(skill_id):
  1680â†’            rule = load_rule(skill_id, scenario_id)
  1681â†’            if rule:
  1682â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1683â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1684â†’                parts.append(rule.content)
  1685â†’            else:
  1686â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
  1687â†’                scenario = load_scenario(skill_id, scenario_id)
  1688â†’                if scenario:
  1689â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1690â†’                    if scenario.sop:
  1691â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1692â†’                        for phase in scenario.sop:
  1693â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1694â†’                        parts.append(sop_text)
  1695â†’        else:
  1696â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
  1697â†’            scenario = load_scenario(skill_id, scenario_id)
  1698â†’            if scenario:
  1699â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1700â†’                # SOP
  1701â†’                if scenario.sop:
  1702â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1703â†’                    for phase in scenario.sop:
  1704â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1705â†’                    parts.append(sop_text)
  1706â†’
  1707â†’    # v10: ä¼¦ç†è¾¹ç•Œå·²åœ¨ SKILL.md å…¨æ–‡ä¸­ï¼Œæ— éœ€é‡å¤æ³¨å…¥
  1708â†’
  1709â†’    # è¾¹ç•Œè§„åˆ™ï¼šä» core/rules/boundary.md æ³¨å…¥
  1710â†’    boundary = load_boundary_rules_text()
  1711â†’    if boundary:
  1712â†’        parts.append(boundary)
  1713â†’
  1714â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ (v8.0 ä¸‰å±‚æ¶æ„å…¼å®¹)
  1715â†’    if user_context:
  1716â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1717â†’
  1718â†’        # ç‰¹æ®Šå¤„ç† birth_info
  1719â†’        if user_context.get("birth_info"):
  1720â†’            birth_info = user_context['birth_info']
  1721â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1722â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1723â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1724â†’
  1725â†’        # ç‰¹æ®Šå¤„ç† portrait
  1726â†’        if user_context.get("portrait"):
  1727â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1728â†’
  1729â†’        # v8.0: ä¼˜å…ˆä½¿ç”¨ vibe ç»“æ„
  1730â†’        vibe = user_context.get("vibe", {})
  1731â†’        vibe_insight = vibe.get("insight", {})
  1732â†’        vibe_target = vibe.get("target", {})
  1733â†’
  1734â†’        # VibeInsight - ç”¨æˆ·ç”»åƒï¼ˆæˆ‘æ˜¯è°ï¼‰
  1735â†’        if vibe_insight:
  1736â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ (VibeInsight)\n"
  1737â†’            # æœ¬è´¨
  1738â†’            essence = vibe_insight.get("essence", {})
  1739â†’            if essence.get("archetype", {}).get("primary"):
  1740â†’                ctx_text += f"**ä¸»è¦åŸå‹**: {essence['archetype']['primary']}\n"
  1741â†’            if essence.get("traits"):
  1742â†’                traits = [t.get("trait", str(t)) if isinstance(t, dict) else str(t) for t in essence["traits"][:3]]
  1743â†’                ctx_text += f"**æ ¸å¿ƒç‰¹è´¨**: {', '.join(traits)}\n"
  1744â†’            # åŠ¨æ€
  1745â†’            dynamic = vibe_insight.get("dynamic", {})
  1746â†’            if dynamic.get("emotion", {}).get("current"):
  1747â†’                ctx_text += f"**å½“å‰æƒ…ç»ª**: {dynamic['emotion']['current']}\n"
  1748â†’            # è§„å¾‹
  1749â†’            pattern = vibe_insight.get("pattern", {})
  1750â†’            if pattern.get("insights"):
  1751â†’                ctx_text += f"**æ´å¯Ÿ**: {pattern['insights'][0]}\n"
  1752â†’
  1753â†’        # VibeTarget - ç”¨æˆ·ç›®æ ‡ï¼ˆæˆ‘è¦æˆä¸ºè°ï¼‰
  1754â†’        if vibe_target:
  1755â†’            ctx_text += f"\n### ç”¨æˆ·ç›®æ ‡ (VibeTarget)\n"
  1756â†’            # åŒ—ææ˜Ÿ
  1757â†’            north_star = vibe_target.get("north_star", {})
  1758â†’            if north_star.get("vision_scene"):
  1759â†’                vision = north_star["vision_scene"]
  1760â†’                if len(vision) > 100:
  1761â†’                    vision = vision[:100] + "..."
  1762â†’                ctx_text += f"**æ„¿æ™¯**: {vision}\n"
  1763â†’            # ç›®æ ‡
  1764â†’            goals = vibe_target.get("goals", [])
  1765â†’            if goals:
  1766â†’                active_goals = [g for g in goals if g.get("status") == "in_progress"][:2]
  1767â†’                if active_goals:
  1768â†’                    goals_text = ', '.join([g.get('title', '') for g in active_goals])
  1769â†’                    ctx_text += f"**å½“å‰ç›®æ ‡**: {goals_text}\n"
  1770â†’            # èšç„¦
  1771â†’            focus = vibe_target.get("focus", {})
  1772â†’            if focus.get("primary"):
  1773â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {focus['primary']}\n"
  1774â†’
  1775â†’        # v9.0: å·²ç§»é™¤ extracted å’Œ life_context å…¼å®¹ä»£ç 
  1776â†’
  1777â†’        parts.append(ctx_text)
  1778â†’
  1779â†’    return "\n".join(parts)
  1780â†’
  1781â†’
  1782â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1783â†’# ç¼“å­˜ç®¡ç†
  1784â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1785â†’
  1786â†’def clear_cache():
  1787â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
  1788â†’    load_skill.cache_clear()
  1789â†’    load_skill_metadata.cache_clear()  # v7.4
  1790â†’    load_scenario.cache_clear()
  1791â†’    load_rule.cache_clear()
  1792â†’    _load_skill_md_content.cache_clear()  # v10
  1793â†’    clear_v9_cache()  # V9
  1794â†’    clear_contracts_cache()  # v10: å¥‘çº¦ç¼“å­˜
  1795â†’    logger.info("Skill cache cleared")
  1796â†’
  1797â†’
  1798â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
  1799â†’    """é‡è½½å•ä¸ª Skill"""
  1800â†’    load_skill.cache_clear()
  1801â†’    load_scenario.cache_clear()
  1802â†’    load_rule.cache_clear()
  1803â†’    _load_skill_md_content.cache_clear()  # v10
  1804â†’    return load_skill(skill_id)
  1805â†’
  1806â†’
  1807â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
  1808â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
  1809â†’
  1810â†’    Args:
  1811â†’        skill_id: Skill ID
  1812â†’        rule_id: Rule ID
  1813â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1814â†’
  1815â†’    Returns:
  1816â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
  1817â†’    """
  1818â†’    parts = []
  1819â†’
  1820â†’    # åŠ è½½ Skill
  1821â†’    skill = load_skill(skill_id)
  1822â†’    if not skill:
  1823â†’        return ""
  1824â†’
  1825â†’    # ä¸“å®¶èº«ä»½
  1826â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1827â†’
  1828â†’    # åŠ è½½è§„åˆ™
  1829â†’    rule = load_rule(skill_id, rule_id)
  1830â†’    if rule:
  1831â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1832â†’
  1833â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1834â†’        parts.append(rule.content)
  1835â†’
  1836â†’    # ä¼¦ç†è¾¹ç•Œ
  1837â†’    if skill.ethics.get("forbidden"):
  1838â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1839â†’        for item in skill.ethics["forbidden"]:
  1840â†’            ethics_text += f"- {item}\n"
  1841â†’        parts.append(ethics_text)
  1842â†’
  1843â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
  1844â†’    if user_context:
  1845â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1846â†’
  1847â†’        if user_context.get("birth_info"):
  1848â†’            birth_info = user_context['birth_info']
  1849â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1850â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1851â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1852â†’
  1853â†’        if user_context.get("portrait"):
  1854â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1855â†’
  1856â†’        if user_context.get("extracted"):
  1857â†’            extracted = user_context['extracted']
  1858â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1859â†’            if extracted.get("facts"):
  1860â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1861â†’            if extracted.get("concerns"):
  1862â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1863â†’            if extracted.get("goals"):
  1864â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1865â†’            if extracted.get("pain_points"):
  1866â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1867â†’
  1868â†’        parts.append(ctx_text)
  1869â†’
  1870â†’    return "\n".join(parts)
  1871â†’
  1872â†’
  1873â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1874â†’# v7.5: æ•°æ®åº“ä¼˜å…ˆçš„å…ƒæ•°æ®åŠ è½½ï¼ˆAsyncï¼‰
  1875â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1876â†’
  1877â†’async def load_skill_metadata_async(skill_id: str) -> Optional[SkillMetadata]:
  1878â†’    """
  1879â†’    å¼‚æ­¥åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼ŒSKILL.md ä½œä¸º fallbackï¼‰- v7.5 æ–°å¢
  1880â†’
  1881â†’    ä¼˜å…ˆçº§ï¼š
  1882â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1883â†’    2. SKILL.md frontmatterï¼ˆé™æ€é…ç½®ï¼‰
  1884â†’
  1885â†’    Args:
  1886â†’        skill_id: Skill ID
  1887â†’
  1888â†’    Returns:
  1889â†’        SkillMetadata å¯¹è±¡ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  1890â†’    """
  1891â†’    try:
  1892â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1893â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1894â†’
  1895â†’        db_entry = await SkillCatalogRepository.get(skill_id)
  1896â†’        if db_entry:
  1897â†’            # è½¬æ¢ SkillCatalogEntry -> SkillMetadata
  1898â†’            return SkillMetadata(
  1899â†’                id=db_entry.skill_id,
  1900â†’                name=db_entry.name,
  1901â†’                description=db_entry.description,
  1902â†’                version=db_entry.version,
  1903â†’                category=db_entry.category,
  1904â†’                icon=db_entry.icon,
  1905â†’                color=db_entry.color,
  1906â†’                triggers=db_entry.triggers,
  1907â†’                pricing=SkillPricing(
  1908â†’                    type=db_entry.pricing.type,
  1909â†’                    trial_messages=db_entry.pricing.trial_messages,
  1910â†’                    credits_per_use=db_entry.pricing.credits_per_use,
  1911â†’                ),
  1912â†’                features=[
  1913â†’                    SkillFeature(
  1914â†’                        name=f.name,
  1915â†’                        description=f.description,
  1916â†’                        icon=f.icon,
  1917â†’                        tier=f.tier,
  1918â†’                    )
  1919â†’                    for f in db_entry.features
  1920â†’                ],
  1921â†’                showcase=SkillShowcase(
  1922â†’                    tagline=db_entry.showcase.tagline,
  1923â†’                    highlights=db_entry.showcase.highlights,
  1924â†’                    preview_image=db_entry.showcase.preview_image,
  1925â†’                    demo_prompts=db_entry.showcase.demo_prompts,
  1926â†’                ),
  1927â†’                subscription=SkillSubscription(
  1928â†’                    auto_subscribe=db_entry.subscription.auto_subscribe,
  1929â†’                    can_unsubscribe=db_entry.subscription.can_unsubscribe,
  1930â†’                    push_default=db_entry.subscription.push_default,
  1931â†’                    min_subscription_days=db_entry.subscription.min_subscription_days,
  1932â†’                ),
  1933â†’            )
  1934â†’    except Exception as e:
  1935â†’        logger.warning(f"Failed to load skill {skill_id} from database: {e}")
  1936â†’
  1937â†’    # 2. Fallback åˆ° SKILL.md
  1938â†’    return load_skill_metadata(skill_id)
  1939â†’
  1940â†’
  1941â†’async def get_all_skill_metadata_async() -> List[SkillMetadata]:
  1942â†’    """
  1943â†’    å¼‚æ­¥è·å–æ‰€æœ‰ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1944â†’
  1945â†’    ä¼˜å…ˆçº§ï¼š
  1946â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1947â†’    2. SKILL.md fallbackï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºæˆ–å‡ºé”™ï¼‰
  1948â†’
  1949â†’    Returns:
  1950â†’        æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1951â†’    """
  1952â†’    try:
  1953â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1954â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1955â†’
  1956â†’        catalog = await SkillCatalogRepository.get_all()
  1957â†’        if catalog:
  1958â†’            return [
  1959â†’                SkillMetadata(
  1960â†’                    id=entry.skill_id,
  1961â†’                    name=entry.name,
  1962â†’                    description=entry.description,
  1963â†’                    version=entry.version,
  1964â†’                    category=entry.category,
  1965â†’                    icon=entry.icon,
  1966â†’                    color=entry.color,
  1967â†’                    triggers=entry.triggers,
  1968â†’                    pricing=SkillPricing(
  1969â†’                        type=entry.pricing.type,
  1970â†’                        trial_messages=entry.pricing.trial_messages,
  1971â†’                        credits_per_use=entry.pricing.credits_per_use,
  1972â†’                    ),
  1973â†’                    features=[
  1974â†’                        SkillFeature(
  1975â†’                            name=f.name,
  1976â†’                            description=f.description,
  1977â†’                            icon=f.icon,
  1978â†’                            tier=f.tier,
  1979â†’                        )
  1980â†’                        for f in entry.features
  1981â†’                    ],
  1982â†’                    showcase=SkillShowcase(
  1983â†’                        tagline=entry.showcase.tagline,
  1984â†’                        highlights=entry.showcase.highlights,
  1985â†’                        preview_image=entry.showcase.preview_image,
  1986â†’                        demo_prompts=entry.showcase.demo_prompts,
  1987â†’                    ),
  1988â†’                    subscription=SkillSubscription(
  1989â†’                        auto_subscribe=entry.subscription.auto_subscribe,
  1990â†’                        can_unsubscribe=entry.subscription.can_unsubscribe,
  1991â†’                        push_default=entry.subscription.push_default,
  1992â†’                        min_subscription_days=entry.subscription.min_subscription_days,
  1993â†’                    ),
  1994â†’                )
  1995â†’                for entry in catalog.values()
  1996â†’            ]
  1997â†’    except Exception as e:
  1998â†’        logger.warning(f"Failed to load skill catalog from database: {e}")
  1999â†’
  2000â†’    # 2. Fallback åˆ° SKILL.md
  2001â†’    return get_all_skill_metadata()
  2002â†’
  2003â†’
  2004â†’async def get_skills_by_category_async(category: str) -> List[SkillMetadata]:
  2005â†’    """
  2006â†’    å¼‚æ­¥æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  2007â†’
  2008â†’    Args:
  2009â†’        category: core | default | professional
  2010â†’
  2011â†’    Returns:
  2012â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  2013â†’    """
  2014â†’    all_skills = await get_all_skill_metadata_async()
  2015â†’    return [s for s in all_skills if s.category == category]
  2016â†’
  2017â†’
  2018â†’async def get_featured_skills_async() -> List[SkillMetadata]:
  2019â†’    """
  2020â†’    å¼‚æ­¥è·å–ç²¾é€‰ Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  2021â†’
  2022â†’    Returns:
  2023â†’        ç²¾é€‰ Skill åˆ—è¡¨ï¼ŒæŒ‰ featured_position æ’åº
  2024â†’    """
  2025â†’    try:
  2026â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  2027â†’
  2028â†’        featured_entries = await SkillCatalogRepository.get_featured()
  2029â†’        return [
  2030â†’            SkillMetadata(
  2031â†’                id=entry.skill_id,
  2032â†’                name=entry.name,
  2033â†’                description=entry.description,
  2034â†’                version=entry.version,
  2035â†’                category=entry.category,
  2036â†’                icon=entry.icon,
  2037â†’                color=entry.color,
  2038â†’                triggers=entry.triggers,
  2039â†’                pricing=SkillPricing(
  2040â†’                    type=entry.pricing.type,
  2041â†’                    trial_messages=entry.pricing.trial_messages,
  2042â†’                    credits_per_use=entry.pricing.credits_per_use,
  2043â†’                ),
  2044â†’                features=[
  2045â†’                    SkillFeature(
  2046â†’                        name=f.name,
  2047â†’                        description=f.description,
  2048â†’                        icon=f.icon,
  2049â†’                        tier=f.tier,
  2050â†’                    )
  2051â†’                    for f in entry.features
  2052â†’                ],
  2053â†’                showcase=SkillShowcase(
  2054â†’                    tagline=entry.showcase.tagline,
  2055â†’                    highlights=entry.showcase.highlights,
  2056â†’                    preview_image=entry.showcase.preview_image,
  2057â†’                    demo_prompts=entry.showcase.demo_prompts,
  2058â†’                ),
  2059â†’                subscription=SkillSubscription(
  2060â†’                    auto_subscribe=entry.subscription.auto_subscribe,
  2061â†’                    can_unsubscribe=entry.subscription.can_unsubscribe,
  2062â†’                    push_default=entry.subscription.push_default,
  2063â†’                    min_subscription_days=entry.subscription.min_subscription_days,
  2064â†’                ),
  2065â†’            )
  2066â†’            for entry in featured_entries
  2067â†’        ]
  2068â†’    except Exception as e:
  2069â†’        logger.warning(f"Failed to load featured skills from database: {e}")
  2070â†’        # Fallback: è¿”å› professional åˆ†ç±»çš„å‰ 3 ä¸ª
  2071â†’        all_skills = get_all_skill_metadata()
  2072â†’        professional = [s for s in all_skills if s.category == "professional"]
  2073â†’        return professional[:3]
  2074â†’
  2075â†’
  2076â†’async def get_skill_categories_summary_async() -> Dict[str, Dict]:
  2077â†’    """
  2078â†’    å¼‚æ­¥è·å–åˆ†ç±»ç»Ÿè®¡ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  2079â†’
  2080â†’    Returns:
  2081â†’        åˆ†ç±»ç»Ÿè®¡å­—å…¸
  2082â†’    """
  2083â†’    try:
  2084â†’        from stores.skill_catalog_repo import get_skill_categories_summary
  2085â†’        return await get_skill_categories_summary()
  2086â†’    except Exception as e:
  2087â†’        logger.warning(f"Failed to get category summary from database: {e}")
  2088â†’        # Fallback
  2089â†’        all_skills = get_all_skill_metadata()
  2090â†’        return {
  2091â†’            "core": {
  2092â†’                "name": "æ ¸å¿ƒèƒ½åŠ›",
  2093â†’                "description": "å§‹ç»ˆæ¿€æ´»çš„åŸºç¡€èƒ½åŠ›",
  2094â†’                "count": len([s for s in all_skills if s.category == "core"])
  2095â†’            },
  2096â†’            "default": {
  2097â†’                "name": "åŸºç¡€åŠŸèƒ½",
  2098â†’                "description": "é»˜è®¤æ¿€æ´»ï¼Œå…è´¹ä½¿ç”¨",
  2099â†’                "count": len([s for s in all_skills if s.category == "default"])
  2100â†’            },
  2101â†’            "professional": {
  2102â†’                "name": "ä¸“ä¸šæŠ€èƒ½",
  2103â†’                "description": "éœ€è¦è®¢é˜…çš„é«˜çº§åŠŸèƒ½",
  2104â†’                "count": len([s for s in all_skills if s.category == "professional"])
  2105â†’            },
  2106â†’        }
  2107â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
