     1â†’"""
     2â†’VibeLife Database Connection
     3â†’PostgreSQL with asyncpg
     4â†’
     5â†’Test-mode fallback:
     6â†’- When VIBELIFE_ENV=test or asyncpg is unavailable, provide a lightweight
     7â†’  in-memory stub so that importing repositories does not require the
     8â†’  asyncpg binary package. This lets API tests run with service/repo mocks.
     9â†’"""
    10â†’import os
    11â†’from typing import Optional
    12â†’from contextlib import asynccontextmanager
    13â†’
    14â†’# TEST_MODE: ä½¿ç”¨ dummy è¿žæŽ¥ï¼ˆé™¤éžè®¾ç½®äº† VIBELIFE_TEST_DB_URL å¼ºåˆ¶ä½¿ç”¨çœŸå®žæ•°æ®åº“ï¼‰
    15â†’_env_test = os.getenv("VIBELIFE_ENV") == "test"
    16â†’_has_test_db = bool(os.getenv("VIBELIFE_TEST_DB_URL"))
    17â†’TEST_MODE = _env_test and not _has_test_db
    18â†’
    19â†’try:  # Avoid hard-failing when asyncpg wheels are unavailable in CI
    20â†’    import asyncpg  # type: ignore
    21â†’except Exception:  # pragma: no cover - only in lean test envs
    22â†’    asyncpg = None  # type: ignore
    23â†’
    24â†’
    25â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    26â†’# Global Connection Pool
    27â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    28â†’
    29â†’_pool: Optional[object] = None
    30â†’
    31â†’
    32â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    33â†’# Test-mode stubs
    34â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    35â†’
    36â†’class _DummyConn:
    37â†’    async def fetch(self, *args, **kwargs):
    38â†’        return []
    39â†’
    40â†’    async def fetchrow(self, *args, **kwargs):
    41â†’        return None
    42â†’
    43â†’    async def fetchval(self, *args, **kwargs):
    44â†’        return None
    45â†’
    46â†’    async def execute(self, *args, **kwargs):
    47â†’        return "OK"
    48â†’
    49â†’    class _Tx:
    50â†’        async def __aenter__(self):
    51â†’            return self
    52â†’
    53â†’        async def __aexit__(self, exc_type, exc, tb):
    54â†’            return False
    55â†’
    56â†’    def transaction(self):
    57â†’        return self._Tx()
    58â†’
    59â†’
    60â†’class _AcquireCM:
    61â†’    def __init__(self):
    62â†’        self._conn = _DummyConn()
    63â†’
    64â†’    async def __aenter__(self):
    65â†’        return self._conn
    66â†’
    67â†’    async def __aexit__(self, exc_type, exc, tb):
    68â†’        return False
    69â†’
    70â†’
    71â†’class _DummyPool:
    72â†’    def acquire(self):
    73â†’        return _AcquireCM()
    74â†’
    75â†’
    76â†’def get_db_url() -> str:
    77â†’    """Get database URL from environment - MUST be set"""
    78â†’    # æµ‹è¯•çŽ¯å¢ƒä¼˜å…ˆä½¿ç”¨ VIBELIFE_TEST_DB_URL
    79â†’    db_url = os.getenv("VIBELIFE_TEST_DB_URL") or os.getenv("VIBELIFE_DB_URL")
    80â†’    if not db_url:
    81â†’        raise RuntimeError(
    82â†’            "CRITICAL: VIBELIFE_DB_URL environment variable is not set. "
    83â†’            "Database connection requires explicit configuration."
    84â†’        )
    85â†’    return db_url
    86â†’
    87â†’
    88â†’async def init_db():
    89â†’    """Initialize database connection pool"""
    90â†’    global _pool
    91â†’
    92â†’    if _pool is not None:
    93â†’        return
    94â†’
    95â†’    if TEST_MODE:
    96â†’        _pool = _DummyPool()
    97â†’        return
    98â†’
    99â†’    if asyncpg is None:
   100â†’        raise RuntimeError(
   101â†’            "asyncpg is not installed and TEST mode is not enabled; cannot init DB"
   102â†’        )
   103â†’
   104â†’    db_url = get_db_url()
   105â†’
   106â†’    _pool = await asyncpg.create_pool(  # type: ignore[attr-defined]
   107â†’        db_url,
   108â†’        min_size=2,
   109â†’        max_size=20,
   110â†’        command_timeout=60,
   111â†’    )
   112â†’
   113â†’    # Test connection
   114â†’    async with _pool.acquire() as conn:  # type: ignore[union-attr]
   115â†’        version = await conn.fetchval("SELECT version()")
   116â†’        print(f"ðŸ“¦ PostgreSQL: {str(version)[:50]}...")
   117â†’
   118â†’
   119â†’async def close_db():
   120â†’    """Close database connection pool"""
   121â†’    global _pool
   122â†’
   123â†’    if _pool is not None:
   124â†’        await _pool.close()
   125â†’        _pool = None
   126â†’
   127â†’
   128â†’async def get_db() -> object:
   129â†’    """Get database pool (for dependency injection)"""
   130â†’    if _pool is None:
   131â†’        await init_db()
   132â†’    return _pool
   133â†’
   134â†’
   135â†’async def get_db_pool() -> object:
   136â†’    """Backward-compatible alias for getting the DB pool"""
   137â†’    return await get_db()
   138â†’
   139â†’
   140â†’@asynccontextmanager
   141â†’async def get_connection():
   142â†’    """Get a database connection from pool"""
   143â†’    if TEST_MODE:
   144â†’        yield _DummyConn()
   145â†’    else:
   146â†’        pool = await get_db()
   147â†’        async with pool.acquire() as conn:  # type: ignore[union-attr]
   148â†’            yield conn
   149â†’
   150â†’
   151â†’@asynccontextmanager
   152â†’async def get_transaction():
   153â†’    """Get a database connection with transaction support.
   154â†’
   155â†’    Usage:
   156â†’        async with get_transaction() as conn:
   157â†’            await conn.execute("INSERT ...")
   158â†’            await conn.execute("UPDATE ...")
   159â†’            # Auto-commits on success, auto-rollbacks on exception
   160â†’    """
   161â†’    if TEST_MODE:
   162â†’        conn = _DummyConn()
   163â†’        async with conn.transaction():
   164â†’            yield conn
   165â†’    else:
   166â†’        pool = await get_db()
   167â†’        async with pool.acquire() as conn:  # type: ignore[union-attr]
   168â†’            async with conn.transaction():
   169â†’                yield conn
   170â†’
   171â†’
   172â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   173â†’# Utility Functions
   174â†’# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   175â†’
   176â†’async def execute(query: str, *args):
   177â†’    """Execute a query"""
   178â†’    async with get_connection() as conn:
   179â†’        return await conn.execute(query, *args)
   180â†’
   181â†’
   182â†’async def fetch(query: str, *args):
   183â†’    """Fetch all rows"""
   184â†’    async with get_connection() as conn:
   185â†’        return await conn.fetch(query, *args)
   186â†’
   187â†’
   188â†’async def fetchrow(query: str, *args):
   189â†’    """Fetch one row"""
   190â†’    async with get_connection() as conn:
   191â†’        return await conn.fetchrow(query, *args)
   192â†’
   193â†’
   194â†’async def fetchval(query: str, *args):
   195â†’    """Fetch one value"""
   196â†’    async with get_connection() as conn:
   197â†’        return await conn.fetchval(query, *args)
   198â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
