The file /home/aiscend/work/vibelife/apps/api/routes/skills.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   211→            "count": len([s for s in all_skills if s.category == "professional"])
   212→        },
   213→    }
   214→
   215→    return {"skills": skills, "categories": categories, "total": len(skills)}
   216→
   217→
   218→# ═══════════════════════════════════════════════════════════════════════════
   219→# 订阅管理端点 (v7.4)
   220→# ═══════════════════════════════════════════════════════════════════════════
   221→
   222→@router.get("/subscriptions")
   223→async def get_subscriptions(current_user: CurrentUser = Depends(get_current_user)):
   224→    """
   225→    获取用户订阅列表
   226→
   227→    Returns:
   228→        subscriptions: 所有 Skill 的订阅状态列表
   229→        summary: 统计摘要
   230→    """
   231→    subscriptions = await SkillSubscriptionRepository.get_user_subscriptions(current_user.user_id)
   232→    all_skills = get_all_skill_metadata()
   233→    skill_map = {s.id: s for s in all_skills}
   234→
   235→    result = []
   236→    for skill in all_skills:
   237→        sub = next((s for s in subscriptions if s.skill_id == skill.id), None)
   238→        result.append({
   239→            "skill_id": skill.id,
   240→            "skill_name": skill.name,
   241→            "status": sub.status if sub else "not_subscribed",
   242→            "push_enabled": sub.push_enabled if sub else False,
   243→            "subscribed_at": sub.subscribed_at.isoformat() if sub and sub.subscribed_at else None,
   244→            "can_unsubscribe": skill.subscription.can_unsubscribe,
   245→            "trial_messages_used": sub.trial_messages_used if sub else 0,
   246→        })
   247→
   248→    return {
   249→        "subscriptions": result,
   250→        "summary": {
   251→            "total_subscribed": len([s for s in result if s["status"] == "subscribed"]),
   252→            "total_available": len(all_skills),
   253→            "push_enabled_count": len([s for s in result if s["push_enabled"]]),
   254→        }
   255→    }
   256→
   257→
   258→@router.get("/recommendations")
   259→async def get_recommendations(
   260→    limit: int = Query(default=3, le=10, description="返回数量"),
   261→    context: Optional[str] = Query(None, description="当前对话上下文"),
   262→    current_user: CurrentUser = Depends(get_current_user),
   263→):
   264→    """
   265→    获取推荐 Skill
   266→
   267→    基于用户档案、使用历史和对话上下文推荐 Skill。
   268→
   269→    Args:
   270→        limit: 返回数量，默认 3，最大 10
   271→        context: 当前对话上下文（关键词）
   272→
   273→    Returns:
   274→        recommendations: 推荐 Skill 列表
   275→    """
   276→    # 获取用户已订阅和已屏蔽的 Skill
   277→    subscribed_ids = await SkillSubscriptionRepository.get_subscribed_skill_ids(current_user.user_id)
   278→    blocked_ids = await SkillRecommendationBlockRepository.get_blocked_skills(current_user.user_id)
   279→
   280→    # 获取所有 Skill
   281→    all_skills = get_all_skill_metadata()
   282→
   283→    # 过滤：未订阅 + 未屏蔽 + 非 core
   284→    candidates = [
   285→        s for s in all_skills
   286→        if s.id not in subscribed_ids
   287→        and s.id not in blocked_ids
   288→        and s.category != "core"
   289→    ]
   290→
   291→    recommendations = []
   292→    for skill in candidates[:limit]:
   293→        # 简单推荐逻辑：基于触发词匹配
   294→        reason = "featured"
   295→        context_text = f"试试「{skill.name}」，{skill.showcase.tagline or skill.description}"
   296→
   297→        if context:
   298→            # 检查上下文是否匹配触发词
   299→            for trigger in skill.triggers:
   300→                if trigger in context:
   301→                    reason = "based_on_conversation"
   302→                    context_text = f"你提到了「{trigger}」，{skill.name} 可以帮助你。"
   303→                    break
   304→
   305→        # 获取试用次数
   306→        trial_used = await SkillSubscriptionRepository.get_trial_usage(current_user.user_id, skill.id)
   307→        trial_remaining = skill.pricing.trial_messages - trial_used if skill.pricing.type != "free" else None
   308→
   309→        recommendations.append({
   310→            "skill_id": skill.id,
   311→            "skill": {
   312→                "id": skill.id,
   313→                "name": skill.name,
   314→                "icon": skill.icon,
   315→                "color": skill.color,
   316→                "tagline": skill.showcase.tagline,
   317→            },
   318→            "reason": reason,
   319→            "context": context_text,
   320→            "score": 0.8,
   321→            "trial_messages_remaining": trial_remaining,
   322→        })
   323→
   324→    return {
   325→        "recommendations": recommendations,
   326→        "generated_at": datetime.utcnow().isoformat(),
   327→    }
   328→
   329→
   330→@router.get("/featured")
   331→async def get_featured():
   332→    """
   333→    获取精选 Skill（用于首页轮播等）
   334→
   335→    Returns:
   336→        featured: 精选 Skill 列表
   337→    """
   338→    # 硬编码精选列表，后续可从数据库读取
   339→    featured_config = [
   340→        {"skill_id": "bazi", "position": 1, "campaign": None},
   341→        {"skill_id": "zodiac", "position": 2, "campaign": None},
   342→        {"skill_id": "tarot", "position": 3, "campaign": None},
   343→    ]
   344→
   345→    featured = []
   346→    for item in featured_config:
   347→        metadata = load_skill_metadata(item["skill_id"])
   348→        if metadata:
   349→            featured.append({
   350→                "skill_id": item["skill_id"],
   351→                "skill": {
   352→                    "id": metadata.id,
   353→                    "name": metadata.name,
   354→                    "icon": metadata.icon,
   355→                    "color": metadata.color,
   356→                    "tagline": metadata.showcase.tagline,
   357→                    "preview_image": metadata.showcase.preview_image,
   358→                },
   359→                "position": item["position"],
   360→                "campaign": item.get("campaign"),
   361→            })
   362→
   363→    return {"featured": featured}
   364→
   365→
   366→@router.get("/{skill_id}")
   367→async def get_skill_detail(
   368→    skill_id: str,
   369→    current_user: Optional[CurrentUser] = Depends(get_optional_user),
   370→):
   371→    """
   372→    获取单个 Skill 详情
   373→
   374→    Args:
   375→        skill_id: Skill ID
   376→
   377→    Returns:
   378→        skill: Skill 完整详情
   379→        user_status: 用户订阅状态（如已登录）
   380→    """
   381→    metadata = load_skill_metadata(skill_id)
   382→    if not metadata:
   383→        raise HTTPException(status_code=404, detail="Skill not found")
   384→
   385→    skill_dict = metadata.to_dict()
   386→
   387→    # 获取服务列表
   388→    services = SkillServiceRegistry.list_services(skill_id)
   389→    skill_dict["services"] = services or []
   390→
   391→    # 获取用户状态
   392→    user_status = None
   393→    if current_user:
   394→        sub = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   395→        if sub:
   396→            trial_limit = metadata.pricing.trial_messages if metadata.pricing.type != "free" else None
   397→            user_status = {
   398→                "subscribed": sub.status == "subscribed",
   399→                "push_enabled": sub.push_enabled,
   400→                "subscribed_at": sub.subscribed_at.isoformat() if sub.subscribed_at else None,
   401→                "trial_messages_used": sub.trial_messages_used,
   402→                "trial_messages_remaining": (trial_limit - sub.trial_messages_used) if trial_limit else None,
   403→            }
   404→
   405→    return {"skill": skill_dict, "user_status": user_status}
   406→
   407→
   408→@router.post("/{skill_id}/subscribe")
   409→async def subscribe_skill(
   410→    skill_id: str,
   411→    request: SubscribeRequest,
   412→    current_user: CurrentUser = Depends(get_current_user),
   413→):
   414→    """
   415→    订阅 Skill
   416→
   417→    Args:
   418→        skill_id: Skill ID
   419→        request: 订阅请求（push_enabled）
   420→
   421→    Returns:
   422→        success: 是否成功
   423→        subscription: 订阅状态
   424→        message: 提示消息
   425→    """
   426→    metadata = load_skill_metadata(skill_id)
   427→    if not metadata:
   428→        raise HTTPException(status_code=404, detail="Skill not found")
   429→
   430→    # 检查是否已订阅
   431→    existing = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   432→    if existing and existing.status == "subscribed":
   433→        raise HTTPException(status_code=400, detail="Already subscribed")
   434→
   435→    # 检查是否需要 Premium（目前简化处理，不检查 Premium 状态）
   436→    # TODO: 集成 EntitlementService 检查用户是否有 Premium
   437→
   438→    # 创建/更新订阅
   439→    subscription = await SkillSubscriptionRepository.subscribe(
   440→        user_id=current_user.user_id,
   441→        skill_id=skill_id,
   442→        push_enabled=request.push_enabled,
   443→    )
   444→
   445→    # 记录使用日志
   446→    await SkillUsageRepository.log_usage(
   447→        user_id=current_user.user_id,
   448→        skill_id=skill_id,
   449→        action="subscribe",
   450→    )
   451→
   452→    return {
   453→        "success": True,
   454→        "subscription": subscription.to_dict(),
   455→        "message": f"已成功订阅「{metadata.name}」",
   456→    }
   457→
   458→
   459→@router.post("/{skill_id}/unsubscribe")
   460→async def unsubscribe_skill(
   461→    skill_id: str,
   462→    current_user: CurrentUser = Depends(get_current_user),
   463→):
   464→    """
   465→    取消订阅 Skill
   466→
   467→    Args:
   468→        skill_id: Skill ID
   469→
   470→    Returns:
   471→        success: 是否成功
   472→        subscription: 订阅状态
   473→        message: 提示消息
   474→    """
   475→    metadata = load_skill_metadata(skill_id)
   476→    if not metadata:
   477→        raise HTTPException(status_code=404, detail="Skill not found")
   478→
   479→    # Core Skill 不可取消
   480→    if not metadata.subscription.can_unsubscribe:
   481→        raise HTTPException(status_code=400, detail="This skill cannot be unsubscribed")
   482→
   483→    # 检查是否已订阅
   484→    existing = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   485→    if not existing or existing.status != "subscribed":
   486→        raise HTTPException(status_code=400, detail="Not subscribed")
   487→
   488→    # 取消订阅
   489→    subscription = await SkillSubscriptionRepository.unsubscribe(current_user.user_id, skill_id)
   490→
   491→    # 记录使用日志
   492→    await SkillUsageRepository.log_usage(
   493→        user_id=current_user.user_id,
   494→        skill_id=skill_id,
   495→        action="unsubscribe",
   496→    )
   497→
   498→    return {
   499→        "success": True,
   500→        "subscription": subscription.to_dict(),
   501→        "message": f"已取消订阅「{metadata.name}」",
   502→    }
   503→
   504→
   505→@router.post("/{skill_id}/push")
   506→async def toggle_push(
   507→    skill_id: str,
   508→    request: PushToggleRequest,
   509→    current_user: CurrentUser = Depends(get_current_user),
   510→):
   511→    """
   512→    切换推送开关
   513→
   514→    Args:
   515→        skill_id: Skill ID
   516→        request: 推送开关请求
   517→
   518→    Returns:
   519→        success: 是否成功
   520→        subscription: 订阅状态
   521→        message: 提示消息
   522→    """
   523→    metadata = load_skill_metadata(skill_id)
   524→    if not metadata:
   525→        raise HTTPException(status_code=404, detail="Skill not found")
   526→
   527→    # 检查是否已订阅
   528→    existing = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   529→    if not existing or existing.status != "subscribed":
   530→        raise HTTPException(status_code=400, detail="Not subscribed")
   531→
   532→    # 更新推送状态
   533→    subscription = await SkillSubscriptionRepository.update_push(
   534→        user_id=current_user.user_id,
   535→        skill_id=skill_id,
   536→        enabled=request.enabled,
   537→    )
   538→
   539→    action = "开启" if request.enabled else "关闭"
   540→    return {
   541→        "success": True,
   542→        "subscription": subscription.to_dict() if subscription else None,
   543→        "message": f"已{action}「{metadata.name}」的推送通知",
   544→    }
   545→
   546→
   547→# ═══════════════════════════════════════════════════════════════════════════
   548→# 原有服务端点
   549→# ═══════════════════════════════════════════════════════════════════════════
   550→
   551→@router.get("/{skill_id}/services")
   552→async def list_skill_services(skill_id: str):
   553→    """
   554→    列出 Skill 的所有服务
   555→
   556→    Args: