     1â†’"""
     2â†’SkillLoader v7 - æ”¯æŒ Agentic + Rule æ¶æ„çš„ Skill åŠ è½½å™¨
     3â†’
     4â†’v7 æ¶æ„ï¼š
     5â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
     6â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
     7â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
     8â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
     9â†’"""
    10â†’import re
    11â†’import json
    12â†’import logging
    13â†’from pathlib import Path
    14â†’from dataclasses import dataclass, field
    15â†’from typing import Dict, List, Optional, Any
    16â†’from functools import lru_cache
    17â†’
    18â†’logger = logging.getLogger(__name__)
    19â†’
    20â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    21â†’
    22â†’
    23â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    24â†’# æ•°æ®ç»“æ„
    25â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    26â†’
    27â†’@dataclass
    28â†’class SkillConfig:
    29â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
    30â†’    id: str
    31â†’    name: str
    32â†’    description: str
    33â†’    expert_persona: str
    34â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
    35â†’    ethics: Dict[str, Any]
    36â†’    tools: List[str]
    37â†’    default_scenario: str = "basic_reading"
    38â†’    triggers: List[str] = field(default_factory=list)
    39â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
    40â†’    # v7.1: SOP é…ç½®é©±åŠ¨
    41â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
    42â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
    43â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
    44â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
    45â†’    collect_tool: Optional[str] = None # æ”¶é›†å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š request_info
    46â†’    external_tools: List[str] = field(default_factory=list)  # v7.3: ä»å…¶ä»– skill å¯¼å…¥çš„å·¥å…·
    47â†’
    48â†’
    49â†’@dataclass
    50â†’class ServiceItem:
    51â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
    52â†’    scenario_id: str
    53â†’    name: str
    54â†’    icon: str
    55â†’    description: str
    56â†’    tier: str  # entry/standard/professional
    57â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
    58â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
    59â†’
    60â†’
    61â†’@dataclass
    62â†’class ScenarioConfig:
    63â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
    64â†’    id: str
    65â†’    name: str
    66â†’    level: str  # entry/standard/professional
    67â†’    billing: str  # free/basic/premium
    68â†’    description: str
    69â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
    70â†’    prerequisites: List[str]
    71â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
    72â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
    73â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
    74â†’    tools: List[str]
    75â†’
    76â†’
    77â†’@dataclass
    78â†’class ToolMetadata:
    79â†’    """å·¥å…·å…ƒæ•°æ®"""
    80â†’    name: str
    81â†’    description: str
    82â†’    tool_type: str  # collect/calculate/display/search
    83â†’    card_type: Optional[str] = None
    84â†’    card_props_schema: Optional[Dict] = None
    85â†’    parameters: Dict[str, Any] = field(default_factory=dict)
    86â†’    when_to_call: Optional[str] = None
    87â†’
    88â†’
    89â†’@dataclass
    90â†’class RuleConfig:
    91â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
    92â†’    id: str
    93â†’    name: str
    94â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
    95â†’    impact_description: str
    96â†’    tags: List[str]
    97â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
    98â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
    99â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
   100â†’    common_questions: str  # å¸¸è§é—®é¢˜
   101â†’
   102â†’
   103â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   104â†’# è§£æå‡½æ•°
   105â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   106â†’
   107â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   108â†’    """è§£æ YAML frontmatter"""
   109â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   110â†’    match = re.match(pattern, text, re.DOTALL)
   111â†’    if not match:
   112â†’        return {}, text
   113â†’
   114â†’    frontmatter_str, content = match.groups()
   115â†’    metadata = {}
   116â†’    current_key = None
   117â†’    current_list = None
   118â†’
   119â†’    for line in frontmatter_str.strip().split('\n'):
   120â†’        stripped = line.strip()
   121â†’        if not stripped:
   122â†’            continue
   123â†’        if stripped.startswith('- ') and current_key:
   124â†’            if current_list is None:
   125â†’                current_list = []
   126â†’            current_list.append(stripped[2:].strip())
   127â†’            metadata[current_key] = current_list
   128â†’        elif ':' in line and not line.startswith(' '):
   129â†’            current_list = None
   130â†’            key, value = line.split(':', 1)
   131â†’            current_key = key.strip()
   132â†’            value = value.strip()
   133â†’            if value in ('|', ''):
   134â†’                continue
   135â†’            elif value.lower() == 'true':
   136â†’                metadata[current_key] = True
   137â†’            elif value.lower() == 'false':
   138â†’                metadata[current_key] = False
   139â†’            else:
   140â†’                metadata[current_key] = value
   141â†’
   142â†’    return metadata, content.strip()
   143â†’
   144â†’
   145â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   146â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   147â†’
   148â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   149â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   150â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   151â†’    """
   152â†’    metadata, content = parse_frontmatter(text)
   153â†’
   154â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   155â†’    triggers = metadata.get("triggers", [])
   156â†’
   157â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   158â†’    if not triggers:
   159â†’        description = metadata.get("description", "")
   160â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   161â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   162â†’        if trigger_match:
   163â†’            trigger_str = trigger_match.group(1)
   164â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   165â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   166â†’
   167â†’    result = {
   168â†’        "id": metadata.get("id", ""),
   169â†’        "name": metadata.get("name", ""),
   170â†’        "description": metadata.get("description", ""),
   171â†’        "triggers": triggers,
   172â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   173â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   174â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   175â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   176â†’        "requires_compute": metadata.get("requires_compute", False),
   177â†’        "compute_type": metadata.get("compute_type", None),
   178â†’        "compute_tool": metadata.get("compute_tool", None),
   179â†’        "collect_tool": metadata.get("collect_tool", None),
   180â†’        "external_tools": metadata.get("external_tools", []),  # v7.3
   181â†’    }
   182â†’
   183â†’    # æå–ä¸“å®¶èº«ä»½
   184â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   185â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   186â†’
   187â†’    # æå–åœºæ™¯ç›®å½•
   188â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   189â†’    for level in scenarios.keys():
   190â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   191â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   192â†’        if match:
   193â†’            for row in match.group(1).strip().split('\n'):
   194â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   195â†’                if len(cols) >= 2:
   196â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   197â†’    result["scenarios"] = scenarios
   198â†’
   199â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   200â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   201â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   202â†’    if forbidden_match:
   203â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   204â†’    result["ethics"] = ethics
   205â†’
   206â†’    # æå–å·¥å…·åˆ—è¡¨
   207â†’    tools = []
   208â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   209â†’    if tools_match:
   210â†’        for row in tools_match.group(1).strip().split('\n'):
   211â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   212â†’            if len(cols) >= 1:
   213â†’                tools.append(cols[0])
   214â†’    result["tools"] = tools
   215â†’
   216â†’    return result
   217â†’
   218â†’
   219â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   220â†’    """è§£æ scenario.md å†…å®¹"""
   221â†’    metadata, content = parse_frontmatter(text)
   222â†’
   223â†’    result = {
   224â†’        "id": metadata.get("id", ""),
   225â†’        "name": metadata.get("name", ""),
   226â†’        "level": metadata.get("level", "entry"),
   227â†’        "billing": metadata.get("billing", "free"),
   228â†’        "description": metadata.get("description", ""),
   229â†’    }
   230â†’
   231â†’    # æå–è§¦å‘æ¡ä»¶
   232â†’    triggers = {"primary": [], "secondary": []}
   233â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   234â†’    if primary_match:
   235â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   236â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   237â†’    if secondary_match:
   238â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   239â†’    result["triggers"] = triggers
   240â†’
   241â†’    # æå–å‰ç½®è¦æ±‚
   242â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   243â†’    result["prerequisites"] = []
   244â†’    if prereq_match:
   245â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   246â†’
   247â†’    # æå– SOP é˜¶æ®µ
   248â†’    sop = []
   249â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   250â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   251â†’        phase_num, phase_name, phase_content = match.groups()
   252â†’        phase = {
   253â†’            "phase": int(phase_num),
   254â†’            "name": phase_name.strip(),
   255â†’            "content": phase_content.strip()
   256â†’        }
   257â†’        # æå–ç±»å‹
   258â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   259â†’        if type_match:
   260â†’            phase["type"] = type_match.group(1)
   261â†’        sop.append(phase)
   262â†’    result["sop"] = sop
   263â†’
   264â†’    # æå–å·¥å…·åˆ—è¡¨
   265â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   266â†’    result["tools"] = []
   267â†’    if tools_match:
   268â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   269â†’
   270â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   271â†’    result["knowledge_config"] = {}
   272â†’    result["output_config"] = {}
   273â†’
   274â†’    return result
   275â†’
   276â†’
   277â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   278â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   279â†’    metadata, content = parse_frontmatter(text)
   280â†’
   281â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   282â†’    tags_raw = metadata.get("tags", [])
   283â†’    if isinstance(tags_raw, str):
   284â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   285â†’    else:
   286â†’        tags = tags_raw
   287â†’
   288â†’    result = {
   289â†’        "id": metadata.get("id", ""),
   290â†’        "name": metadata.get("name", ""),
   291â†’        "impact": metadata.get("impact", "MEDIUM"),
   292â†’        "impact_description": metadata.get("impactDescription", ""),
   293â†’        "tags": tags,
   294â†’        "content": content,
   295â†’    }
   296â†’
   297â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   298â†’    analysis_steps = []
   299â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   300â†’    if table_match:
   301â†’        for row in table_match.group(1).strip().split('\n'):
   302â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   303â†’            if len(cols) >= 4:
   304â†’                analysis_steps.append({
   305â†’                    "step": cols[0],
   306â†’                    "point": cols[1],
   307â†’                    "query": cols[2],
   308â†’                    "priority": cols[3],
   309â†’                })
   310â†’    result["analysis_steps"] = analysis_steps
   311â†’
   312â†’    # æå–è¾“å‡ºè¦æ±‚
   313â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   314â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   315â†’
   316â†’    # æå–å¸¸è§é—®é¢˜
   317â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   318â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   319â†’
   320â†’    return result
   321â†’
   322â†’
   323â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   324â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   325â†’    services = {"entry": [], "standard": [], "professional": []}
   326â†’
   327â†’    tier_map = {
   328â†’        "entry": "entry",
   329â†’        "standard": "standard",
   330â†’        "professional": "professional"
   331â†’    }
   332â†’
   333â†’    for tier_name, tier_key in tier_map.items():
   334â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   335â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   336â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   337â†’        if not match:
   338â†’            continue
   339â†’
   340â†’        table_content = match.group(1).strip()
   341â†’        if not table_content:
   342â†’            continue
   343â†’
   344â†’        for row in table_content.split('\n'):
   345â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   346â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   347â†’                continue
   348â†’
   349â†’            service = {
   350â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   351â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   352â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   353â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   354â†’                "tier": tier_key,
   355â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   356â†’                "highlights": []
   357â†’            }
   358â†’
   359â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   360â†’            if len(cols) > 7 and cols[7]:
   361â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   362â†’
   363â†’            services[tier_key].append(service)
   364â†’
   365â†’    return services
   366â†’
   367â†’
   368â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   369â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   370â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   371â†’    if not skill_path.exists():
   372â†’        return None
   373â†’
   374â†’    text = skill_path.read_text(encoding='utf-8')
   375â†’    metadata, _ = parse_frontmatter(text)
   376â†’    services = parse_skill_services(text)
   377â†’
   378â†’    return {
   379â†’        "skill_id": skill_id,
   380â†’        "skill_name": metadata.get("name", skill_id),
   381â†’        "description": metadata.get("description", ""),
   382â†’        "services": services
   383â†’    }
   384â†’
   385â†’
   386â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   387â†’# åŠ è½½å‡½æ•°
   388â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   389â†’
   390â†’@lru_cache(maxsize=32)
   391â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   392â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   393â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   394â†’    if not skill_path.exists():
   395â†’        return None
   396â†’
   397â†’    text = skill_path.read_text(encoding='utf-8')
   398â†’    data = parse_skill_md(text)
   399â†’
   400â†’    return SkillConfig(
   401â†’        id=data.get("id", skill_id),
   402â†’        name=data.get("name", skill_id),
   403â†’        description=data.get("description", ""),
   404â†’        expert_persona=data.get("expert_persona", ""),
   405â†’        scenarios=data.get("scenarios", {}),
   406â†’        ethics=data.get("ethics", {}),
   407â†’        tools=data.get("tools", []),
   408â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   409â†’        triggers=data.get("triggers", []),
   410â†’        global_tools=data.get("global_tools", []),
   411â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   412â†’        requires_birth_info=data.get("requires_birth_info", False),
   413â†’        requires_compute=data.get("requires_compute", False),
   414â†’        compute_type=data.get("compute_type", None),
   415â†’        compute_tool=data.get("compute_tool", None),
   416â†’        collect_tool=data.get("collect_tool", None),
   417â†’        external_tools=data.get("external_tools", []),  # v7.3
   418â†’    )
   419â†’
   420â†’
   421â†’@lru_cache(maxsize=64)
   422â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   423â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   424â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   425â†’    if not scenario_path.exists():
   426â†’        return None
   427â†’
   428â†’    text = scenario_path.read_text(encoding='utf-8')
   429â†’    data = parse_scenario_md(text)
   430â†’
   431â†’    return ScenarioConfig(
   432â†’        id=data.get("id", scenario_id),
   433â†’        name=data.get("name", scenario_id),
   434â†’        level=data.get("level", "entry"),
   435â†’        billing=data.get("billing", "free"),
   436â†’        description=data.get("description", ""),
   437â†’        triggers=data.get("triggers", {}),
   438â†’        prerequisites=data.get("prerequisites", []),
   439â†’        sop=data.get("sop", []),
   440â†’        knowledge_config=data.get("knowledge_config", {}),
   441â†’        output_config=data.get("output_config", {}),
   442â†’        tools=data.get("tools", [])
   443â†’    )
   444â†’
   445â†’
   446â†’@lru_cache(maxsize=128)
   447â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   448â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢"""
   449â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   450â†’    if not rule_path.exists():
   451â†’        return None
   452â†’
   453â†’    text = rule_path.read_text(encoding='utf-8')
   454â†’    data = parse_rule_md(text)
   455â†’
   456â†’    return RuleConfig(
   457â†’        id=data.get("id", rule_id),
   458â†’        name=data.get("name", rule_id),
   459â†’        impact=data.get("impact", "MEDIUM"),
   460â†’        impact_description=data.get("impact_description", ""),
   461â†’        tags=data.get("tags", []),
   462â†’        content=data.get("content", ""),
   463â†’        analysis_steps=data.get("analysis_steps", []),
   464â†’        output_requirements=data.get("output_requirements", ""),
   465â†’        common_questions=data.get("common_questions", ""),
   466â†’    )
   467â†’
   468â†’
   469â†’def get_skill_rules(skill_id: str) -> List[str]:
   470â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢"""
   471â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   472â†’    if not rules_dir.exists():
   473â†’        return []
   474â†’    return [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   475â†’
   476â†’
   477â†’def has_rules(skill_id: str) -> bool:
   478â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   479â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   480â†’    if not rules_dir.exists():
   481â†’        return False
   482â†’    rules = list(rules_dir.glob("*.md"))
   483â†’    return len(rules) > 0
   484â†’
   485â†’
   486â†’def get_available_skills() -> List[str]:
   487â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   488â†’    if not SKILLS_DIR.exists():
   489â†’        return []
   490â†’    return [p.name for p in SKILLS_DIR.iterdir()
   491â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   492â†’
   493â†’
   494â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   495â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   496â†’
   497â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   498â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   499â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼‰
   500â†’    """
   501â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   502â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   503â†’    if rules_dir.exists():
   504â†’        rules = [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   505â†’        if rules:
   506â†’            return rules
   507â†’
   508â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   509â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   510â†’    if not scenarios_dir.exists():
   511â†’        return []
   512â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   513â†’
   514â†’
   515â†’def get_skill_triggers() -> Dict[str, List[str]]:
   516â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   517â†’    triggers = {}
   518â†’    for skill_id in get_available_skills():
   519â†’        if skill_id == "core":
   520â†’            continue
   521â†’        skill = load_skill(skill_id)
   522â†’        if skill and skill.triggers:
   523â†’            triggers[skill_id] = skill.triggers
   524â†’    return triggers
   525â†’
   526â†’
   527â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   528â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   529â†’    skill = load_skill(skill_id)
   530â†’    if skill and skill.global_tools:
   531â†’        return skill.global_tools
   532â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   533â†’    return []
   534â†’
   535â†’
   536â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   537â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   538â†’    skill = load_skill(skill_id)
   539â†’    if skill and skill.external_tools:
   540â†’        return skill.external_tools
   541â†’    return []
   542â†’
   543â†’
   544â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   545â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
   546â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   547â†’
   548â†’def skill_requires_birth_info(skill_id: str) -> bool:
   549â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   550â†’    skill = load_skill(skill_id)
   551â†’    return skill.requires_birth_info if skill else False
   552â†’
   553â†’
   554â†’def skill_requires_compute(skill_id: str) -> bool:
   555â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   556â†’    skill = load_skill(skill_id)
   557â†’    return skill.requires_compute if skill else False
   558â†’
   559â†’
   560â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
   561â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
   562â†’
   563â†’    è¿”å›å€¼ï¼š
   564â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
   565â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
   566â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
   567â†’    """
   568â†’    skill = load_skill(skill_id)
   569â†’    return skill.compute_type if skill else None
   570â†’
   571â†’
   572â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
   573â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   574â†’
   575â†’    è¿”å›å€¼ï¼š
   576â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
   577â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   578â†’    """
   579â†’    skill = load_skill(skill_id)
   580â†’    return skill.compute_tool if skill else None
   581â†’
   582â†’
   583â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
   584â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   585â†’
   586â†’    è¿”å›å€¼ï¼š
   587â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
   588â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   589â†’    """
   590â†’    skill = load_skill(skill_id)
   591â†’    return skill.collect_tool if skill else None
   592â†’
   593â†’
   594â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   595â†’# System Prompt æ„å»º
   596â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   597â†’
   598â†’def build_system_prompt(
   599â†’    skill_id: str,
   600â†’    scenario_id: Optional[str] = None,
   601â†’    user_context: Optional[Dict] = None
   602â†’) -> str:
   603â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
   604â†’
   605â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
   606â†’    """
   607â†’    parts = []
   608â†’
   609â†’    # åŠ è½½ Skill
   610â†’    skill = load_skill(skill_id)
   611â†’    if not skill:
   612â†’        return ""
   613â†’
   614â†’    # ä¸“å®¶èº«ä»½
   615â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   616â†’
   617â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
   618â†’    if scenario_id:
   619â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
   620â†’        if has_rules(skill_id):
   621â†’            rule = load_rule(skill_id, scenario_id)
   622â†’            if rule:
   623â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
   624â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
   625â†’                parts.append(rule.content)
   626â†’            else:
   627â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
   628â†’                scenario = load_scenario(skill_id, scenario_id)
   629â†’                if scenario:
   630â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   631â†’                    if scenario.sop:
   632â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   633â†’                        for phase in scenario.sop:
   634â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   635â†’                        parts.append(sop_text)
   636â†’        else:
   637â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
   638â†’            scenario = load_scenario(skill_id, scenario_id)
   639â†’            if scenario:
   640â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   641â†’                # SOP
   642â†’                if scenario.sop:
   643â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   644â†’                    for phase in scenario.sop:
   645â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   646â†’                    parts.append(sop_text)
   647â†’
   648â†’    # ä¼¦ç†è¾¹ç•Œ
   649â†’    if skill.ethics.get("forbidden"):
   650â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   651â†’        for item in skill.ethics["forbidden"]:
   652â†’            ethics_text += f"- {item}\n"
   653â†’        parts.append(ethics_text)
   654â†’
   655â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ
   656â†’    if user_context:
   657â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   658â†’
   659â†’        # ç‰¹æ®Šå¤„ç† birth_info
   660â†’        if user_context.get("birth_info"):
   661â†’            birth_info = user_context['birth_info']
   662â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
   663â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
   664â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
   665â†’
   666â†’        # ç‰¹æ®Šå¤„ç† portrait
   667â†’        if user_context.get("portrait"):
   668â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
   669â†’
   670â†’        # ç‰¹æ®Šå¤„ç† extracted (æŠ½å–çš„ç”¨æˆ·ä¿¡æ¯)
   671â†’        if user_context.get("extracted"):
   672â†’            extracted = user_context['extracted']
   673â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
   674â†’            if extracted.get("facts"):
   675â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
   676â†’            if extracted.get("concerns"):
   677â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
   678â†’            if extracted.get("goals"):
   679â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
   680â†’            if extracted.get("pain_points"):
   681â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
   682â†’            if extracted.get("life_events"):
   683â†’                events = [f"{e.get('date', '?')}: {e.get('event', '')}" for e in extracted['life_events'][:5]]
   684â†’                ctx_text += f"**è¿‘æœŸäº‹ä»¶**: {'; '.join(events)}\n"
   685â†’
   686â†’        # ç‰¹æ®Šå¤„ç† identity_prism
   687â†’        if user_context.get("identity_prism"):
   688â†’            prism = user_context['identity_prism']
   689â†’            ctx_text += f"\n### èº«ä»½ç‰¹å¾\n"
   690â†’            if prism.get("core"):
   691â†’                ctx_text += f"**æ ¸å¿ƒç‰¹è´¨**: {prism['core']}\n"
   692â†’            if prism.get("inner"):
   693â†’                ctx_text += f"**å†…åœ¨éœ€æ±‚**: {prism['inner']}\n"
   694â†’            if prism.get("outer"):
   695â†’                ctx_text += f"**å¤–åœ¨è¡¨ç°**: {prism['outer']}\n"
   696â†’
   697â†’        # ç‰¹æ®Šå¤„ç† life_context
   698â†’        if user_context.get("life_context"):
   699â†’            life_ctx = user_context['life_context']
   700â†’            if life_ctx.get("concerns") or life_ctx.get("goals") or life_ctx.get("pain_points"):
   701â†’                ctx_text += f"\n### ç”Ÿæ´»èƒŒæ™¯\n"
   702â†’                if life_ctx.get("concerns"):
   703â†’                    ctx_text += f"**å…³æ³¨**: {', '.join(life_ctx['concerns'])}\n"
   704â†’                if life_ctx.get("goals"):
   705â†’                    ctx_text += f"**ç›®æ ‡**: {', '.join(life_ctx['goals'])}\n"
   706â†’                if life_ctx.get("pain_points"):
   707â†’                    ctx_text += f"**å›°éš¾**: {', '.join(life_ctx['pain_points'])}\n"
   708â†’
   709â†’        parts.append(ctx_text)
   710â†’
   711â†’    return "\n".join(parts)
   712â†’
   713â†’
   714â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   715â†’# ç¼“å­˜ç®¡ç†
   716â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   717â†’
   718â†’def clear_cache():
   719â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
   720â†’    load_skill.cache_clear()
   721â†’    load_scenario.cache_clear()
   722â†’    load_rule.cache_clear()
   723â†’    get_scenario_triggers.cache_clear()
   724â†’    get_rule_triggers.cache_clear()
   725â†’    logger.info("Skill cache cleared")
   726â†’
   727â†’
   728â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
   729â†’    """é‡è½½å•ä¸ª Skill"""
   730â†’    load_skill.cache_clear()
   731â†’    load_scenario.cache_clear()
   732â†’    load_rule.cache_clear()
   733â†’    return load_skill(skill_id)
   734â†’
   735â†’
   736â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   737â†’# åœºæ™¯è·¯ç”± (å†…å­˜åŒ¹é…)
   738â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   739â†’
   740â†’def parse_scenario_triggers(text: str) -> Dict[str, Dict[str, List[str]]]:
   741â†’    """ä» SKILL.md è§£æåœºæ™¯ç›®å½•è¡¨æ ¼ï¼Œæå–è§¦å‘è¯"""
   742â†’    triggers = {}  # {scenario_id: {primary: [...], secondary: [...]}}
   743â†’
   744â†’    # åŒ¹é…ä¸‰ä¸ªçº§åˆ«çš„è¡¨æ ¼
   745â†’    for level in ["entry", "standard", "professional"]:
   746â†’        pattern = rf'### {level.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   747â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   748â†’        if not match:
   749â†’            continue
   750â†’
   751â†’        for row in match.group(1).strip().split('\n'):
   752â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   753â†’            if len(cols) >= 3:
   754â†’                # cols[1] = æ–‡ä»¶å, cols[2] = è§¦å‘è¯
   755â†’                scenario_id = cols[1].replace('.md', '')
   756â†’                trigger_str = cols[2]
   757â†’                # è§£æè§¦å‘è¯ï¼ˆç”¨é¡¿å·æˆ–é€—å·åˆ†éš”ï¼‰
   758â†’                trigger_words = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   759â†’                triggers[scenario_id] = {
   760â†’                    "primary": trigger_words,
   761â†’                    "secondary": []
   762â†’                }
   763â†’
   764â†’    return triggers
   765â†’
   766â†’
   767â†’@lru_cache(maxsize=32)
   768â†’def get_scenario_triggers(skill_id: str) -> Dict[str, Dict[str, List[str]]]:
   769â†’    """è·å– Skill çš„åœºæ™¯è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
   770â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   771â†’    if not skill_path.exists():
   772â†’        return {}
   773â†’
   774â†’    text = skill_path.read_text(encoding='utf-8')
   775â†’    return parse_scenario_triggers(text)
   776â†’
   777â†’
   778â†’def route_scenario(skill_id: str, message: str) -> Optional[str]:
   779â†’    """
   780â†’    å†…å­˜åœºæ™¯è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³åœºæ™¯
   781â†’
   782â†’    Args:
   783â†’        skill_id: Skill ID
   784â†’        message: ç”¨æˆ·æ¶ˆæ¯
   785â†’
   786â†’    Returns:
   787â†’        åŒ¹é…çš„ scenario_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
   788â†’    """
   789â†’    triggers = get_scenario_triggers(skill_id)
   790â†’    if not triggers:
   791â†’        return None
   792â†’
   793â†’    best_match = None
   794â†’    best_score = 0
   795â†’
   796â†’    for scenario_id, trigger_config in triggers.items():
   797â†’        score = 0
   798â†’        # ä¸»è¦è§¦å‘è¯æƒé‡ 1.0
   799â†’        for word in trigger_config.get("primary", []):
   800â†’            if word in message:
   801â†’                score += 1.0
   802â†’        # æ¬¡è¦è§¦å‘è¯æƒé‡ 0.5
   803â†’        for word in trigger_config.get("secondary", []):
   804â†’            if word in message:
   805â†’                score += 0.5
   806â†’
   807â†’        if score > best_score:
   808â†’            best_score = score
   809â†’            best_match = scenario_id
   810â†’
   811â†’    return best_match
   812â†’
   813â†’
   814â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   815â†’# è§„åˆ™è·¯ç”± (v7 æ–°å¢)
   816â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   817â†’
   818â†’@lru_cache(maxsize=32)
   819â†’def get_rule_triggers(skill_id: str) -> Dict[str, List[str]]:
   820â†’    """è·å– Skill çš„è§„åˆ™è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰- v7 æ–°å¢
   821â†’
   822â†’    ä» rules/*.md çš„ frontmatter ä¸­è¯»å– tags ä½œä¸ºè§¦å‘è¯
   823â†’    """
   824â†’    triggers = {}  # {rule_id: [tag1, tag2, ...]}
   825â†’
   826â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   827â†’    if not rules_dir.exists():
   828â†’        return triggers
   829â†’
   830â†’    for rule_path in rules_dir.glob("*.md"):
   831â†’        if rule_path.stem.startswith("_"):
   832â†’            continue
   833â†’
   834â†’        rule = load_rule(skill_id, rule_path.stem)
   835â†’        if rule and rule.tags:
   836â†’            triggers[rule.id] = rule.tags
   837â†’
   838â†’    return triggers
   839â†’
   840â†’
   841â†’def route_to_rule(skill_id: str, message: str) -> Optional[str]:
   842â†’    """
   843â†’    è§„åˆ™è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³è§„åˆ™ - v7 æ–°å¢
   844â†’
   845â†’    ä½¿ç”¨ tags è¿›è¡Œè¯­ä¹‰åŒ¹é…ï¼Œæ”¯æŒæ›´çµæ´»çš„è·¯ç”±
   846â†’
   847â†’    Args:
   848â†’        skill_id: Skill ID
   849â†’        message: ç”¨æˆ·æ¶ˆæ¯
   850â†’
   851â†’    Returns:
   852â†’        åŒ¹é…çš„ rule_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
   853â†’    """
   854â†’    # ä¼˜å…ˆä½¿ç”¨è§„åˆ™è·¯ç”±
   855â†’    if has_rules(skill_id):
   856â†’        triggers = get_rule_triggers(skill_id)
   857â†’        if not triggers:
   858â†’            return None
   859â†’
   860â†’        best_match = None
   861â†’        best_score = 0
   862â†’
   863â†’        for rule_id, tags in triggers.items():
   864â†’            score = 0
   865â†’            for tag in tags:
   866â†’                if tag in message:
   867â†’                    score += 1.0
   868â†’
   869â†’            if score > best_score:
   870â†’                best_score = score
   871â†’                best_match = rule_id
   872â†’
   873â†’        return best_match
   874â†’
   875â†’    # å›é€€åˆ°åœºæ™¯è·¯ç”±ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
   876â†’    return route_scenario(skill_id, message)
   877â†’
   878â†’
   879â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
   880â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
   881â†’
   882â†’    Args:
   883â†’        skill_id: Skill ID
   884â†’        rule_id: Rule ID
   885â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
   886â†’
   887â†’    Returns:
   888â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
   889â†’    """
   890â†’    parts = []
   891â†’
   892â†’    # åŠ è½½ Skill
   893â†’    skill = load_skill(skill_id)
   894â†’    if not skill:
   895â†’        return ""
   896â†’
   897â†’    # ä¸“å®¶èº«ä»½
   898â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   899â†’
   900â†’    # åŠ è½½è§„åˆ™
   901â†’    rule = load_rule(skill_id, rule_id)
   902â†’    if rule:
   903â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
   904â†’
   905â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
   906â†’        parts.append(rule.content)
   907â†’
   908â†’    # ä¼¦ç†è¾¹ç•Œ
   909â†’    if skill.ethics.get("forbidden"):
   910â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   911â†’        for item in skill.ethics["forbidden"]:
   912â†’            ethics_text += f"- {item}\n"
   913â†’        parts.append(ethics_text)
   914â†’
   915â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
   916â†’    if user_context:
   917â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   918â†’
   919â†’        if user_context.get("birth_info"):
   920â†’            birth_info = user_context['birth_info']
   921â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
   922â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
   923â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
   924â†’
   925â†’        if user_context.get("portrait"):
   926â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
   927â†’
   928â†’        if user_context.get("extracted"):
   929â†’            extracted = user_context['extracted']
   930â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
   931â†’            if extracted.get("facts"):
   932â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
   933â†’            if extracted.get("concerns"):
   934â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
   935â†’            if extracted.get("goals"):
   936â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
   937â†’            if extracted.get("pain_points"):
   938â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
   939â†’
   940â†’        parts.append(ctx_text)
   941â†’
   942â†’    return "\n".join(parts)
   943â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
