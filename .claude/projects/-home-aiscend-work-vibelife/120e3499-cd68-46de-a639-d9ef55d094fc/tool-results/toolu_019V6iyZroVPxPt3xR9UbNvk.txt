     1â†’"""
     2â†’Unified Skill Gateway - ç»Ÿä¸€ Skill API å…¥å£
     3â†’
     4â†’æ‰€æœ‰ Skill æ•°æ®æœåŠ¡é€šè¿‡æ­¤è·¯ç”±è®¿é—®:
     5â†’- POST /api/v1/skills/{skill_id}/{action}
     6â†’- GET /api/v1/skills/{skill_id}/services
     7â†’- GET /api/v1/skills
     8â†’
     9â†’v7.4 æ–°å¢è®¢é˜…ç®¡ç†ç«¯ç‚¹:
    10â†’- GET /api/v1/skills/subscriptions
    11â†’- POST /api/v1/skills/{skill_id}/subscribe
    12â†’- POST /api/v1/skills/{skill_id}/unsubscribe
    13â†’- POST /api/v1/skills/{skill_id}/push
    14â†’- GET /api/v1/skills/recommendations
    15â†’- GET /api/v1/skills/featured
    16â†’
    17â†’ç¤ºä¾‹:
    18â†’- POST /api/v1/skills/bazi/chart
    19â†’- POST /api/v1/skills/zodiac/fortune
    20â†’- POST /api/v1/skills/tarot/draw
    21â†’"""
    22â†’import logging
    23â†’from datetime import datetime
    24â†’from typing import Optional, Dict, Any, List
    25â†’from uuid import UUID
    26â†’
    27â†’from fastapi import APIRouter, Depends, HTTPException, Header, Query
    28â†’from pydantic import BaseModel, Field
    29â†’
    30â†’from services.identity import get_optional_user, get_current_user, CurrentUser
    31â†’from services.agent.skill_service_registry import (
    32â†’    SkillServiceRegistry, ServiceContext
    33â†’)
    34â†’from services.agent.skill_loader import (
    35â†’    load_skill_metadata, get_all_skill_metadata, get_skills_by_category
    36â†’)
    37â†’from stores.profile_cache import get_cached_profile_with_skill
    38â†’from stores.skill_subscription_repo import (
    39â†’    SkillSubscriptionRepository, SkillUsageRepository, SkillRecommendationBlockRepository
    40â†’)
    41â†’
    42â†’router = APIRouter(prefix="/skills", tags=["Skills"])
    43â†’logger = logging.getLogger(__name__)
    44â†’
    45â†’
    46â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    47â†’# Request/Response Models
    48â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    49â†’
    50â†’class SkillRequest(BaseModel):
    51â†’    """é€šç”¨ Skill è¯·æ±‚"""
    52â†’    args: Dict[str, Any] = Field(default_factory=dict, description="æœåŠ¡å‚æ•°")
    53â†’
    54â†’
    55â†’class SkillResponse(BaseModel):
    56â†’    """é€šç”¨ Skill å“åº”"""
    57â†’    status: str = "success"
    58â†’    data: Optional[Dict[str, Any]] = None
    59â†’    error: Optional[str] = None
    60â†’
    61â†’
    62â†’class ServiceInfo(BaseModel):
    63â†’    """æœåŠ¡ä¿¡æ¯"""
    64â†’    skill_id: str
    65â†’    action: str
    66â†’    description: str = ""
    67â†’    auth_required: bool = True
    68â†’    entitlement: Optional[str] = None
    69â†’
    70â†’
    71â†’# v7.4: è®¢é˜…ç®¡ç†ç›¸å…³æ¨¡å‹
    72â†’class SubscribeRequest(BaseModel):
    73â†’    """è®¢é˜…è¯·æ±‚"""
    74â†’    push_enabled: bool = True
    75â†’
    76â†’
    77â†’class PushToggleRequest(BaseModel):
    78â†’    """æ¨é€å¼€å…³è¯·æ±‚"""
    79â†’    enabled: bool
    80â†’
    81â†’
    82â†’class SkillUserStatus(BaseModel):
    83â†’    """ç”¨æˆ·å¯¹ Skill çš„çŠ¶æ€"""
    84â†’    subscribed: bool = False
    85â†’    push_enabled: bool = False
    86â†’    trial_messages_used: int = 0
    87â†’    trial_messages_remaining: Optional[int] = None
    88â†’
    89â†’
    90â†’class SkillWithStatus(BaseModel):
    91â†’    """å¸¦ç”¨æˆ·çŠ¶æ€çš„ Skill ä¿¡æ¯"""
    92â†’    id: str
    93â†’    name: str
    94â†’    description: str
    95â†’    icon: str = "ğŸ’¡"
    96â†’    color: str = "#6B7280"
    97â†’    category: str
    98â†’    pricing: Dict[str, Any]
    99â†’    features: List[Dict[str, Any]] = []
   100â†’    showcase: Dict[str, Any] = {}
   101â†’    triggers: List[str] = []
   102â†’    user_status: Optional[SkillUserStatus] = None
   103â†’
   104â†’
   105â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   106â†’# Helper Functions
   107â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   108â†’
   109â†’async def build_service_context(
   110â†’    user_id: Optional[UUID],
   111â†’    skill_id: str,
   112â†’    user_tier: str = "free"
   113â†’) -> ServiceContext:
   114â†’    """æ„å»ºæœåŠ¡ä¸Šä¸‹æ–‡"""
   115â†’    profile = {}
   116â†’    skill_data = {}
   117â†’
   118â†’    if user_id:
   119â†’        try:
   120â†’            result = await get_cached_profile_with_skill(user_id, skill_id)
   121â†’            profile = result.get("profile", {})
   122â†’            skill_data = result.get("skill_data", {})
   123â†’        except Exception as e:
   124â†’            logger.warning(f"Failed to get user context: {e}")
   125â†’
   126â†’    return ServiceContext(
   127â†’        user_id=str(user_id) if user_id else None,
   128â†’        user_tier=user_tier,
   129â†’        profile=profile,
   130â†’        skill_data=skill_data
   131â†’    )
   132â†’
   133â†’
   134â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   135â†’# Endpoints
   136â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   137â†’
   138â†’@router.get("")
   139â†’async def list_skills(
   140â†’    category: Optional[str] = Query(None, description="æŒ‰åˆ†ç±»ç­›é€‰: core, default, professional"),
   141â†’    subscribed: Optional[bool] = Query(None, description="åªè¿”å›å·²è®¢é˜…çš„ Skill"),
   142â†’    current_user: Optional[CurrentUser] = Depends(get_optional_user),
   143â†’):
   144â†’    """
   145â†’    è·å–æ‰€æœ‰ Skill åˆ—è¡¨ï¼ˆå¸¦å…ƒæ•°æ®å’Œè®¢é˜…çŠ¶æ€ï¼‰
   146â†’
   147â†’    Args:
   148â†’        category: æŒ‰åˆ†ç±»ç­›é€‰ (core/default/professional)
   149â†’        subscribed: åªè¿”å›å·²è®¢é˜…çš„ Skill
   150â†’
   151â†’    Returns:
   152â†’        skills: Skill åˆ—è¡¨ï¼ŒåŒ…å«å…ƒæ•°æ®å’Œç”¨æˆ·è®¢é˜…çŠ¶æ€
   153â†’        categories: åˆ†ç±»ç»Ÿè®¡
   154â†’        total: æ€»æ•°
   155â†’    """
   156â†’    # è·å–æ‰€æœ‰ Skill å…ƒæ•°æ®
   157â†’    if category:
   158â†’        all_metadata = get_skills_by_category(category)
   159â†’    else:
   160â†’        all_metadata = get_all_skill_metadata()
   161â†’
   162â†’    # è·å–ç”¨æˆ·è®¢é˜…çŠ¶æ€
   163â†’    user_statuses = {}
   164â†’    if current_user:
   165â†’        subscriptions = await SkillSubscriptionRepository.get_user_subscriptions(current_user.user_id)
   166â†’        user_statuses = {s.skill_id: s for s in subscriptions}
   167â†’
   168â†’    # æ„å»ºå“åº”
   169â†’    skills = []
   170â†’    for metadata in all_metadata:
   171â†’        skill_dict = metadata.to_dict()
   172â†’        sub = user_statuses.get(metadata.id)
   173â†’
   174â†’        # è®¡ç®—è¯•ç”¨å‰©ä½™æ¬¡æ•°
   175â†’        trial_limit = metadata.pricing.trial_messages if metadata.pricing.type != "free" else None
   176â†’        trial_used = sub.trial_messages_used if sub else 0
   177â†’
   178â†’        skill_dict["user_status"] = {
   179â†’            "subscribed": sub.status == "subscribed" if sub else False,
   180â†’            "push_enabled": sub.push_enabled if sub else False,
   181â†’            "trial_messages_used": trial_used,
   182â†’            "trial_messages_remaining": (trial_limit - trial_used) if trial_limit else None,
   183â†’        }
   184â†’
   185â†’        # ç­›é€‰å·²è®¢é˜…
   186â†’        if subscribed is not None:
   187â†’            is_subscribed = skill_dict["user_status"]["subscribed"]
   188â†’            if subscribed and not is_subscribed:
   189â†’                continue
   190â†’            if not subscribed and is_subscribed:
   191â†’                continue
   192â†’
   193â†’        skills.append(skill_dict)
   194â†’
   195â†’    # åˆ†ç±»ç»Ÿè®¡
   196â†’    all_skills = get_all_skill_metadata()
   197â†’    categories = {
   198â†’        "core": {
   199â†’            "name": "æ ¸å¿ƒèƒ½åŠ›",
   200â†’            "description": "å§‹ç»ˆæ¿€æ´»çš„åŸºç¡€èƒ½åŠ›",
   201â†’            "count": len([s for s in all_skills if s.category == "core"])
   202â†’        },
   203â†’        "default": {
   204â†’            "name": "åŸºç¡€åŠŸèƒ½",
   205â†’            "description": "é»˜è®¤æ¿€æ´»ï¼Œå…è´¹ä½¿ç”¨",
   206â†’            "count": len([s for s in all_skills if s.category == "default"])
   207â†’        },
   208â†’        "professional": {
   209â†’            "name": "ä¸“ä¸šæŠ€èƒ½",
   210â†’            "description": "éœ€è¦è®¢é˜…çš„é«˜çº§åŠŸèƒ½",
   211â†’            "count": len([s for s in all_skills if s.category == "professional"])
   212â†’        },
   213â†’    }
   214â†’
   215â†’    return {"skills": skills, "categories": categories, "total": len(skills)}
   216â†’
   217â†’
   218â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   219â†’# è®¢é˜…ç®¡ç†ç«¯ç‚¹ (v7.4)
   220â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   221â†’
   222â†’@router.get("/subscriptions")
   223â†’async def get_subscriptions(current_user: CurrentUser = Depends(get_current_user)):
   224â†’    """
   225â†’    è·å–ç”¨æˆ·è®¢é˜…åˆ—è¡¨
   226â†’
   227â†’    Returns:
   228â†’        subscriptions: æ‰€æœ‰ Skill çš„è®¢é˜…çŠ¶æ€åˆ—è¡¨
   229â†’        summary: ç»Ÿè®¡æ‘˜è¦
   230â†’    """
   231â†’    subscriptions = await SkillSubscriptionRepository.get_user_subscriptions(current_user.user_id)
   232â†’    all_skills = get_all_skill_metadata()
   233â†’    skill_map = {s.id: s for s in all_skills}
   234â†’
   235â†’    result = []
   236â†’    for skill in all_skills:
   237â†’        sub = next((s for s in subscriptions if s.skill_id == skill.id), None)
   238â†’        result.append({
   239â†’            "skill_id": skill.id,
   240â†’            "skill_name": skill.name,
   241â†’            "status": sub.status if sub else "not_subscribed",
   242â†’            "push_enabled": sub.push_enabled if sub else False,
   243â†’            "subscribed_at": sub.subscribed_at.isoformat() if sub and sub.subscribed_at else None,
   244â†’            "can_unsubscribe": skill.subscription.can_unsubscribe,
   245â†’            "trial_messages_used": sub.trial_messages_used if sub else 0,
   246â†’        })
   247â†’
   248â†’    return {
   249â†’        "subscriptions": result,
   250â†’        "summary": {
   251â†’            "total_subscribed": len([s for s in result if s["status"] == "subscribed"]),
   252â†’            "total_available": len(all_skills),
   253â†’            "push_enabled_count": len([s for s in result if s["push_enabled"]]),
   254â†’        }
   255â†’    }
   256â†’
   257â†’
   258â†’@router.get("/recommendations")
   259â†’async def get_recommendations(
   260â†’    limit: int = Query(default=3, le=10, description="è¿”å›æ•°é‡"),
   261â†’    context: Optional[str] = Query(None, description="å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡"),
   262â†’    current_user: CurrentUser = Depends(get_current_user),
   263â†’):
   264â†’    """
   265â†’    è·å–æ¨è Skill
   266â†’
   267â†’    åŸºäºç”¨æˆ·æ¡£æ¡ˆã€ä½¿ç”¨å†å²å’Œå¯¹è¯ä¸Šä¸‹æ–‡æ¨è Skillã€‚
   268â†’
   269â†’    Args:
   270â†’        limit: è¿”å›æ•°é‡ï¼Œé»˜è®¤ 3ï¼Œæœ€å¤§ 10
   271â†’        context: å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆå…³é”®è¯ï¼‰
   272â†’
   273â†’    Returns:
   274â†’        recommendations: æ¨è Skill åˆ—è¡¨
   275â†’    """
   276â†’    # è·å–ç”¨æˆ·å·²è®¢é˜…å’Œå·²å±è”½çš„ Skill
   277â†’    subscribed_ids = await SkillSubscriptionRepository.get_subscribed_skill_ids(current_user.user_id)
   278â†’    blocked_ids = await SkillRecommendationBlockRepository.get_blocked_skills(current_user.user_id)
   279â†’
   280â†’    # è·å–æ‰€æœ‰ Skill
   281â†’    all_skills = get_all_skill_metadata()
   282â†’
   283â†’    # è¿‡æ»¤ï¼šæœªè®¢é˜… + æœªå±è”½ + é core
   284â†’    candidates = [
   285â†’        s for s in all_skills
   286â†’        if s.id not in subscribed_ids
   287â†’        and s.id not in blocked_ids
   288â†’        and s.category != "core"
   289â†’    ]
   290â†’
   291â†’    recommendations = []
   292â†’    for skill in candidates[:limit]:
   293â†’        # ç®€å•æ¨èé€»è¾‘ï¼šåŸºäºè§¦å‘è¯åŒ¹é…
   294â†’        reason = "featured"
   295â†’        context_text = f"è¯•è¯•ã€Œ{skill.name}ã€ï¼Œ{skill.showcase.tagline or skill.description}"
   296â†’
   297â†’        if context:
   298â†’            # æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦åŒ¹é…è§¦å‘è¯
   299â†’            for trigger in skill.triggers:
   300â†’                if trigger in context:
   301â†’                    reason = "based_on_conversation"
   302â†’                    context_text = f"ä½ æåˆ°äº†ã€Œ{trigger}ã€ï¼Œ{skill.name} å¯ä»¥å¸®åŠ©ä½ ã€‚"
   303â†’                    break
   304â†’
   305â†’        # è·å–è¯•ç”¨æ¬¡æ•°
   306â†’        trial_used = await SkillSubscriptionRepository.get_trial_usage(current_user.user_id, skill.id)
   307â†’        trial_remaining = skill.pricing.trial_messages - trial_used if skill.pricing.type != "free" else None
   308â†’
   309â†’        recommendations.append({
   310â†’            "skill_id": skill.id,
   311â†’            "skill": {
   312â†’                "id": skill.id,
   313â†’                "name": skill.name,
   314â†’                "icon": skill.icon,
   315â†’                "color": skill.color,
   316â†’                "tagline": skill.showcase.tagline,
   317â†’            },
   318â†’            "reason": reason,
   319â†’            "context": context_text,
   320â†’            "score": 0.8,
   321â†’            "trial_messages_remaining": trial_remaining,
   322â†’        })
   323â†’
   324â†’    return {
   325â†’        "recommendations": recommendations,
   326â†’        "generated_at": datetime.utcnow().isoformat(),
   327â†’    }
   328â†’
   329â†’
   330â†’@router.get("/featured")
   331â†’async def get_featured():
   332â†’    """
   333â†’    è·å–ç²¾é€‰ Skillï¼ˆç”¨äºé¦–é¡µè½®æ’­ç­‰ï¼‰
   334â†’
   335â†’    Returns:
   336â†’        featured: ç²¾é€‰ Skill åˆ—è¡¨
   337â†’    """
   338â†’    # ç¡¬ç¼–ç ç²¾é€‰åˆ—è¡¨ï¼Œåç»­å¯ä»æ•°æ®åº“è¯»å–
   339â†’    featured_config = [
   340â†’        {"skill_id": "bazi", "position": 1, "campaign": None},
   341â†’        {"skill_id": "zodiac", "position": 2, "campaign": None},
   342â†’        {"skill_id": "tarot", "position": 3, "campaign": None},
   343â†’    ]
   344â†’
   345â†’    featured = []
   346â†’    for item in featured_config:
   347â†’        metadata = load_skill_metadata(item["skill_id"])
   348â†’        if metadata:
   349â†’            featured.append({
   350â†’                "skill_id": item["skill_id"],
   351â†’                "skill": {
   352â†’                    "id": metadata.id,
   353â†’                    "name": metadata.name,
   354â†’                    "icon": metadata.icon,
   355â†’                    "color": metadata.color,
   356â†’                    "tagline": metadata.showcase.tagline,
   357â†’                    "preview_image": metadata.showcase.preview_image,
   358â†’                },
   359â†’                "position": item["position"],
   360â†’                "campaign": item.get("campaign"),
   361â†’            })
   362â†’
   363â†’    return {"featured": featured}
   364â†’
   365â†’
   366â†’@router.get("/{skill_id}")
   367â†’async def get_skill_detail(
   368â†’    skill_id: str,
   369â†’    current_user: Optional[CurrentUser] = Depends(get_optional_user),
   370â†’):
   371â†’    """
   372â†’    è·å–å•ä¸ª Skill è¯¦æƒ…
   373â†’
   374â†’    Args:
   375â†’        skill_id: Skill ID
   376â†’
   377â†’    Returns:
   378â†’        skill: Skill å®Œæ•´è¯¦æƒ…
   379â†’        user_status: ç”¨æˆ·è®¢é˜…çŠ¶æ€ï¼ˆå¦‚å·²ç™»å½•ï¼‰
   380â†’    """
   381â†’    metadata = load_skill_metadata(skill_id)
   382â†’    if not metadata:
   383â†’        raise HTTPException(status_code=404, detail="Skill not found")
   384â†’
   385â†’    skill_dict = metadata.to_dict()
   386â†’
   387â†’    # è·å–æœåŠ¡åˆ—è¡¨
   388â†’    services = SkillServiceRegistry.list_services(skill_id)
   389â†’    skill_dict["services"] = services or []
   390â†’
   391â†’    # è·å–ç”¨æˆ·çŠ¶æ€
   392â†’    user_status = None
   393â†’    if current_user:
   394â†’        sub = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   395â†’        if sub:
   396â†’            trial_limit = metadata.pricing.trial_messages if metadata.pricing.type != "free" else None
   397â†’            user_status = {
   398â†’                "subscribed": sub.status == "subscribed",
   399â†’                "push_enabled": sub.push_enabled,
   400â†’                "subscribed_at": sub.subscribed_at.isoformat() if sub.subscribed_at else None,
   401â†’                "trial_messages_used": sub.trial_messages_used,
   402â†’                "trial_messages_remaining": (trial_limit - sub.trial_messages_used) if trial_limit else None,
   403â†’            }
   404â†’
   405â†’    return {"skill": skill_dict, "user_status": user_status}
   406â†’
   407â†’
   408â†’@router.post("/{skill_id}/subscribe")
   409â†’async def subscribe_skill(
   410â†’    skill_id: str,
   411â†’    request: SubscribeRequest,
   412â†’    current_user: CurrentUser = Depends(get_current_user),
   413â†’):
   414â†’    """
   415â†’    è®¢é˜… Skill
   416â†’
   417â†’    Args:
   418â†’        skill_id: Skill ID
   419â†’        request: è®¢é˜…è¯·æ±‚ï¼ˆpush_enabledï¼‰
   420â†’
   421â†’    Returns:
   422â†’        success: æ˜¯å¦æˆåŠŸ
   423â†’        subscription: è®¢é˜…çŠ¶æ€
   424â†’        message: æç¤ºæ¶ˆæ¯
   425â†’    """
   426â†’    metadata = load_skill_metadata(skill_id)
   427â†’    if not metadata:
   428â†’        raise HTTPException(status_code=404, detail="Skill not found")
   429â†’
   430â†’    # æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
   431â†’    existing = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   432â†’    if existing and existing.status == "subscribed":
   433â†’        raise HTTPException(status_code=400, detail="Already subscribed")
   434â†’
   435â†’    # æ£€æŸ¥æ˜¯å¦éœ€è¦ Premiumï¼ˆç›®å‰ç®€åŒ–å¤„ç†ï¼Œä¸æ£€æŸ¥ Premium çŠ¶æ€ï¼‰
   436â†’    # TODO: é›†æˆ EntitlementService æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ Premium
   437â†’
   438â†’    # åˆ›å»º/æ›´æ–°è®¢é˜…
   439â†’    subscription = await SkillSubscriptionRepository.subscribe(
   440â†’        user_id=current_user.user_id,
   441â†’        skill_id=skill_id,
   442â†’        push_enabled=request.push_enabled,
   443â†’    )
   444â†’
   445â†’    # è®°å½•ä½¿ç”¨æ—¥å¿—
   446â†’    await SkillUsageRepository.log_usage(
   447â†’        user_id=current_user.user_id,
   448â†’        skill_id=skill_id,
   449â†’        action="subscribe",
   450â†’    )
   451â†’
   452â†’    return {
   453â†’        "success": True,
   454â†’        "subscription": subscription.to_dict(),
   455â†’        "message": f"å·²æˆåŠŸè®¢é˜…ã€Œ{metadata.name}ã€",
   456â†’    }
   457â†’
   458â†’
   459â†’@router.post("/{skill_id}/unsubscribe")
   460â†’async def unsubscribe_skill(
   461â†’    skill_id: str,
   462â†’    current_user: CurrentUser = Depends(get_current_user),
   463â†’):
   464â†’    """
   465â†’    å–æ¶ˆè®¢é˜… Skill
   466â†’
   467â†’    Args:
   468â†’        skill_id: Skill ID
   469â†’
   470â†’    Returns:
   471â†’        success: æ˜¯å¦æˆåŠŸ
   472â†’        subscription: è®¢é˜…çŠ¶æ€
   473â†’        message: æç¤ºæ¶ˆæ¯
   474â†’    """
   475â†’    metadata = load_skill_metadata(skill_id)
   476â†’    if not metadata:
   477â†’        raise HTTPException(status_code=404, detail="Skill not found")
   478â†’
   479â†’    # Core Skill ä¸å¯å–æ¶ˆ
   480â†’    if not metadata.subscription.can_unsubscribe:
   481â†’        raise HTTPException(status_code=400, detail="This skill cannot be unsubscribed")
   482â†’
   483â†’    # æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
   484â†’    existing = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   485â†’    if not existing or existing.status != "subscribed":
   486â†’        raise HTTPException(status_code=400, detail="Not subscribed")
   487â†’
   488â†’    # å–æ¶ˆè®¢é˜…
   489â†’    subscription = await SkillSubscriptionRepository.unsubscribe(current_user.user_id, skill_id)
   490â†’
   491â†’    # è®°å½•ä½¿ç”¨æ—¥å¿—
   492â†’    await SkillUsageRepository.log_usage(
   493â†’        user_id=current_user.user_id,
   494â†’        skill_id=skill_id,
   495â†’        action="unsubscribe",
   496â†’    )
   497â†’
   498â†’    return {
   499â†’        "success": True,
   500â†’        "subscription": subscription.to_dict(),
   501â†’        "message": f"å·²å–æ¶ˆè®¢é˜…ã€Œ{metadata.name}ã€",
   502â†’    }
   503â†’
   504â†’
   505â†’@router.post("/{skill_id}/push")
   506â†’async def toggle_push(
   507â†’    skill_id: str,
   508â†’    request: PushToggleRequest,
   509â†’    current_user: CurrentUser = Depends(get_current_user),
   510â†’):
   511â†’    """
   512â†’    åˆ‡æ¢æ¨é€å¼€å…³
   513â†’
   514â†’    Args:
   515â†’        skill_id: Skill ID
   516â†’        request: æ¨é€å¼€å…³è¯·æ±‚
   517â†’
   518â†’    Returns:
   519â†’        success: æ˜¯å¦æˆåŠŸ
   520â†’        subscription: è®¢é˜…çŠ¶æ€
   521â†’        message: æç¤ºæ¶ˆæ¯
   522â†’    """
   523â†’    metadata = load_skill_metadata(skill_id)
   524â†’    if not metadata:
   525â†’        raise HTTPException(status_code=404, detail="Skill not found")
   526â†’
   527â†’    # æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
   528â†’    existing = await SkillSubscriptionRepository.get(current_user.user_id, skill_id)
   529â†’    if not existing or existing.status != "subscribed":
   530â†’        raise HTTPException(status_code=400, detail="Not subscribed")
   531â†’
   532â†’    # æ›´æ–°æ¨é€çŠ¶æ€
   533â†’    subscription = await SkillSubscriptionRepository.update_push(
   534â†’        user_id=current_user.user_id,
   535â†’        skill_id=skill_id,
   536â†’        enabled=request.enabled,
   537â†’    )
   538â†’
   539â†’    action = "å¼€å¯" if request.enabled else "å…³é—­"
   540â†’    return {
   541â†’        "success": True,
   542â†’        "subscription": subscription.to_dict() if subscription else None,
   543â†’        "message": f"å·²{action}ã€Œ{metadata.name}ã€çš„æ¨é€é€šçŸ¥",
   544â†’    }
   545â†’
   546â†’
   547â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   548â†’# åŸæœ‰æœåŠ¡ç«¯ç‚¹
   549â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   550â†’
   551â†’@router.get("/{skill_id}/services")
   552â†’async def list_skill_services(skill_id: str):
   553â†’    """
   554â†’    åˆ—å‡º Skill çš„æ‰€æœ‰æœåŠ¡
   555â†’
   556â†’    Args:
   557â†’        skill_id: Skill æ ‡è¯† (bazi, zodiac, tarot, career)
   558â†’
   559â†’    Returns:
   560â†’        services: æœåŠ¡åˆ—è¡¨
   561â†’    """
   562â†’    services = SkillServiceRegistry.list_services(skill_id)
   563â†’    if not services:
   564â†’        raise HTTPException(
   565â†’            status_code=404,
   566â†’            detail=f"No services found for skill: {skill_id}"
   567â†’        )
   568â†’    return {"skill_id": skill_id, "services": services}
   569â†’
   570â†’
   571â†’@router.post("/{skill_id}/{action}")
   572â†’async def execute_skill_service(
   573â†’    skill_id: str,
   574â†’    action: str,
   575â†’    request: SkillRequest,
   576â†’    current_user: Optional[CurrentUser] = Depends(get_optional_user),
   577â†’    x_test_tier: Optional[str] = Header(None, alias="x-test-tier")
   578â†’):
   579â†’    """
   580â†’    æ‰§è¡Œ Skill æœåŠ¡
   581â†’
   582â†’    Args:
   583â†’        skill_id: Skill æ ‡è¯† (bazi, zodiac, tarot, career)
   584â†’        action: æœåŠ¡åŠ¨ä½œ (chart, fortune, draw, etc.)
   585â†’        request: è¯·æ±‚å‚æ•°
   586â†’
   587â†’    Returns:
   588â†’        æœåŠ¡æ‰§è¡Œç»“æœ
   589â†’
   590â†’    Examples:
   591â†’        POST /api/v1/skills/bazi/chart
   592â†’        {"args": {"birth_date": "1990-01-01", "birth_time": "12:00"}}
   593â†’
   594â†’        POST /api/v1/skills/zodiac/fortune
   595â†’        {"args": {"date": "2026-01-15"}}
   596â†’    """
   597â†’    # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
   598â†’    if not SkillServiceRegistry.has_service(skill_id, action):
   599â†’        raise HTTPException(
   600â†’            status_code=404,
   601â†’            detail=f"Service not found: {skill_id}/{action}"
   602â†’        )
   603â†’
   604â†’    # è·å–æœåŠ¡å®šä¹‰
   605â†’    service_def = SkillServiceRegistry.get_service(skill_id, action)
   606â†’
   607â†’    # æ£€æŸ¥è®¤è¯è¦æ±‚
   608â†’    if service_def.auth_required and not current_user:
   609â†’        raise HTTPException(
   610â†’            status_code=401,
   611â†’            detail="Authentication required"
   612â†’        )
   613â†’
   614â†’    # ç¡®å®šç”¨æˆ·ç­‰çº§
   615â†’    user_id = current_user.user_id if current_user else None
   616â†’    user_tier = "free"
   617â†’
   618â†’    # æµ‹è¯•æ¨¡å¼: å…è®¸é€šè¿‡ header è¦†ç›– tier
   619â†’    if x_test_tier and x_test_tier in ("free", "paid", "vip", "guest"):
   620â†’        user_tier = x_test_tier
   621â†’        logger.info(f"Test mode: using tier={x_test_tier}")
   622â†’    elif user_id:
   623â†’        try:
   624â†’            from services.entitlement import EntitlementService
   625â†’            entitlements = await EntitlementService.get_entitlements(user_id)
   626â†’            user_tier = entitlements.get("tier", "free")
   627â†’        except Exception as e:
   628â†’            logger.warning(f"Failed to get entitlements: {e}")
   629â†’
   630â†’    # æ£€æŸ¥æƒç›Šè¦æ±‚
   631â†’    if service_def.entitlement:
   632â†’        # TODO: å®ç°æƒç›Šæ£€æŸ¥
   633â†’        pass
   634â†’
   635â†’    # æ„å»ºä¸Šä¸‹æ–‡
   636â†’    context = await build_service_context(user_id, skill_id, user_tier)
   637â†’
   638â†’    # æ‰§è¡ŒæœåŠ¡
   639â†’    result = await SkillServiceRegistry.execute(skill_id, action, request.args, context)
   640â†’
   641â†’    # æ£€æŸ¥é”™è¯¯
   642â†’    if "error" in result and result.get("status") in ("error", "not_found"):
   643â†’        status_code = 404 if result.get("status") == "not_found" else 400
   644â†’        raise HTTPException(status_code=status_code, detail=result["error"])
   645â†’
   646â†’    return result
   647â†’
   648â†’
   649â†’@router.get("/{skill_id}/{action}")
   650â†’async def get_skill_service_info(skill_id: str, action: str):
   651â†’    """
   652â†’    è·å–æœåŠ¡ä¿¡æ¯
   653â†’
   654â†’    Args:
   655â†’        skill_id: Skill æ ‡è¯†
   656â†’        action: æœåŠ¡åŠ¨ä½œ
   657â†’
   658â†’    Returns:
   659â†’        æœåŠ¡å®šä¹‰ä¿¡æ¯
   660â†’    """
   661â†’    service_def = SkillServiceRegistry.get_service(skill_id, action)
   662â†’    if not service_def:
   663â†’        raise HTTPException(
   664â†’            status_code=404,
   665â†’            detail=f"Service not found: {skill_id}/{action}"
   666â†’        )
   667â†’
   668â†’    return {
   669â†’        "skill_id": service_def.skill_id,
   670â†’        "action": service_def.action,
   671â†’        "description": service_def.description,
   672â†’        "auth_required": service_def.auth_required,
   673â†’        "entitlement": service_def.entitlement
   674â†’    }
   675â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
