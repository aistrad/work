     1â†’'use client'
     2â†’
     3â†’/**
     4â†’ * Settings Page - v5.1 æ€§èƒ½ä¼˜åŒ–ç‰ˆ
     5â†’ * è®¾è®¡æ–‡æ¡£: payment-design-pc.md ç¬¬åç« 
     6â†’ *
     7â†’ * v5.1 ä¼˜åŒ–:
     8â†’ * - ç§»é™¤ framer-motionï¼Œä½¿ç”¨ CSS åŠ¨ç”» (Vercel rule: bundle-dynamic-imports)
     9â†’ * - ä½¿ç”¨ç¼“å­˜çš„ localStorage è¯»å– (Vercel rule: js-cache-storage)
    10â†’ * - ä½¿ç”¨å‡½æ•°å¼ setState (Vercel rule: rerender-functional-setstate)
    11â†’ *
    12â†’ * PCç«¯å¸ƒå±€: å·¦ä¾§è®¾ç½®èœå• + å³ä¾§è®¾ç½®å†…å®¹
    13â†’ * ç§»åŠ¨ç«¯å¸ƒå±€: å•æ è®¾ç½®åˆ—è¡¨
    14â†’ */
    15â†’
    16â†’import { useState, useEffect, useCallback, memo } from 'react'
    17â†’import { useRouter } from 'next/navigation'
    18â†’import { PCLayout } from '@/components/layout/PCLayout'
    19â†’import { getLocalStorageJSON, getAccessToken, setLocalStorageJSON } from '@/utils/storage'
    20â†’import { AccountDeletionSection } from '@/components/settings/AccountDeletionSection'
    21â†’
    22â†’const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1'
    23â†’
    24â†’const SETTINGS_MENU = [
    25â†’  { id: 'profile', icon: 'ğŸ‘¤', label: 'ä¸ªäººèµ„æ–™' },
    26â†’  { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥è®¾ç½®' },
    27â†’  { id: 'privacy', icon: 'ğŸ”', label: 'éšç§ä¸å®‰å…¨' },
    28â†’  { id: 'membership', icon: 'ğŸ’', label: 'ä¼šå‘˜ç®¡ç†' },
    29â†’  { id: 'memory', icon: 'ğŸ§ ', label: 'è®°å¿†ç®¡ç†' },
    30â†’  { id: 'preferences', icon: 'âš™ï¸', label: 'åå¥½è®¾ç½®' },
    31â†’  { id: 'account', icon: 'âš ï¸', label: 'è´¦æˆ·ç®¡ç†' },
    32â†’  { id: 'help', icon: 'â“', label: 'å¸®åŠ©ä¸åé¦ˆ' },
    33â†’  { id: 'about', icon: 'ğŸ“„', label: 'å…³äº' },
    34â†’]
    35â†’
    36â†’interface UserProfile {
    37â†’  nickname: string
    38â†’  email: string
    39â†’  avatar: string
    40â†’  birthDate: string
    41â†’  birthTime: string
    42â†’  timezone: string
    43â†’}
    44â†’
    45â†’export default function SettingsPage() {
    46â†’  const router = useRouter()
    47â†’  const [activeSection, setActiveSection] = useState('profile')
    48â†’  const [loading, setLoading] = useState(false)
    49â†’  const [profile, setProfile] = useState<UserProfile>(() => ({
    50â†’    nickname: 'ç”¨æˆ·',
    51â†’    email: 'user@example.com',
    52â†’    avatar: 'ğŸ‘¤',
    53â†’    birthDate: '1990-05-15',
    54â†’    birthTime: '10:30',
    55â†’    timezone: 'Asia/Shanghai',
    56â†’  }))
    57â†’
    58â†’  useEffect(() => {
    59â†’    // Use cached localStorage read (Vercel rule: js-cache-storage)
    60â†’    const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
    61â†’    if (user) {
    62â†’      setProfile(prev => ({
    63â†’        ...prev,
    64â†’        nickname: user.nickname || user.display_name || 'ç”¨æˆ·',
    65â†’        email: user.email || '',
    66â†’        avatar: user.avatar || 'ğŸ‘¤',
    67â†’        birthDate: user.birth_date || '',
    68â†’        birthTime: user.birth_time || '',
    69â†’        timezone: user.timezone || 'Asia/Shanghai',
    70â†’      }))
    71â†’    }
    72â†’  }, [])
    73â†’
    74â†’  // Use useCallback for stable reference (Vercel rule: rerender-functional-setstate)
    75â†’  const handleProfileChange = useCallback((field: keyof UserProfile, value: string) => {
    76â†’    setProfile(prev => ({ ...prev, [field]: value }))
    77â†’  }, [])
    78â†’
    79â†’  const handleSaveProfile = useCallback(async () => {
    80â†’    setLoading(true)
    81â†’    try {
    82â†’      const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
    83â†’      const token = getAccessToken()
    84â†’
    85â†’      if (user?.user_id && token) {
    86â†’        const res = await fetch(`${API_BASE}/users/me/profile`, {
    87â†’          method: 'PUT',
    88â†’          headers: {
    89â†’            'Content-Type': 'application/json',
    90â†’            'Authorization': `Bearer ${token}`
    91â†’          },
    92â†’          body: JSON.stringify({
    93â†’            display_name: profile.nickname,
    94â†’            birth_datetime: profile.birthDate && profile.birthTime
    95â†’              ? `${profile.birthDate}T${profile.birthTime}:00`
    96â†’              : undefined,
    97â†’            timezone: profile.timezone,
    98â†’          }),
    99â†’        })
   100â†’
   101â†’        if (res.ok) {
   102â†’          setLocalStorageJSON('user', { ...user, ...profile })
   103â†’        }
   104â†’      }
   105â†’    } catch (err) {
   106â†’      console.error('Failed to save profile:', err)
   107â†’    } finally {
   108â†’      setLoading(false)
   109â†’    }
   110â†’  }, [profile])
   111â†’
   112â†’  // è®¾ç½®å†…å®¹åŒºåŸŸ
   113â†’  const SettingsContent = () => {
   114â†’    switch (activeSection) {
   115â†’      case 'profile':
   116â†’        return (
   117â†’          <div className="space-y-6">
   118â†’            <h2 className="font-serif text-xl text-text-primary">ä¸ªäººèµ„æ–™</h2>
   119â†’            <div className="space-y-4">
   120â†’              <div>
   121â†’                <label className="block text-sm text-text-secondary mb-2">å¤´åƒ</label>
   122â†’                <div className="flex items-center gap-4">
   123â†’                  <div className="w-16 h-16 rounded-full bg-[var(--bg-secondary)] flex items-center justify-center text-3xl">
   124â†’                    {profile.avatar}
   125â†’                  </div>
   126â†’                  <button className="btn btn-secondary">æ›´æ¢å¤´åƒ</button>
   127â†’                </div>
   128â†’              </div>
   129â†’              <div>
   130â†’                <label className="block text-sm text-text-secondary mb-2">æ˜µç§°</label>
   131â†’                <input
   132â†’                  type="text"
   133â†’                  value={profile.nickname}
   134â†’                  onChange={(e) => handleProfileChange('nickname', e.target.value)}
   135â†’                  className="input"
   136â†’                />
   137â†’              </div>
   138â†’              <div>
   139â†’                <label className="block text-sm text-text-secondary mb-2">é‚®ç®±</label>
   140â†’                <input
   141â†’                  type="email"
   142â†’                  value={profile.email}
   143â†’                  disabled
   144â†’                  className="input bg-[var(--bg-secondary)]"
   145â†’                />
   146â†’              </div>
   147â†’              <div>
   148â†’                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¥æœŸ</label>
   149â†’                <input
   150â†’                  type="date"
   151â†’                  value={profile.birthDate}
   152â†’                  onChange={(e) => handleProfileChange('birthDate', e.target.value)}
   153â†’                  className="input"
   154â†’                />
   155â†’              </div>
   156â†’              <div>
   157â†’                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¶é—´</label>
   158â†’                <input
   159â†’                  type="time"
   160â†’                  value={profile.birthTime}
   161â†’                  onChange={(e) => handleProfileChange('birthTime', e.target.value)}
   162â†’                  className="input"
   163â†’                />
   164â†’              </div>
   165â†’              <div>
   166â†’                <label className="block text-sm text-text-secondary mb-2">æ—¶åŒº</label>
   167â†’                <select
   168â†’                  value={profile.timezone}
   169â†’                  onChange={(e) => handleProfileChange('timezone', e.target.value)}
   170â†’                  className="input"
   171â†’                >
   172â†’                  <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
   173â†’                  <option value="Asia/Hong_Kong">Asia/Hong_Kong (UTC+8)</option>
   174â†’                  <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
   175â†’                  <option value="America/New_York">America/New_York (UTC-5)</option>
   176â†’                  <option value="America/Los_Angeles">America/Los_Angeles (UTC-8)</option>
   177â†’                  <option value="Europe/London">Europe/London (UTC+0)</option>
   178â†’                </select>
   179â†’              </div>
   180â†’              <button onClick={handleSaveProfile} disabled={loading} className="btn btn-primary">
   181â†’                {loading ? 'ä¿å­˜ä¸­...' : 'ä¿å­˜æ›´æ”¹'}
   182â†’              </button>
   183â†’            </div>
   184â†’          </div>
   185â†’        )
   186â†’      case 'notifications':
   187â†’        return (
   188â†’          <div className="space-y-6">
   189â†’            <h2 className="font-serif text-xl text-text-primary">é€šçŸ¥è®¾ç½®</h2>
   190â†’            <div className="space-y-4">
   191â†’              {[
   192â†’                { id: 'daily', label: 'æ¯æ—¥è¿åŠ¿æé†’', desc: 'æ¯å¤©æ—©ä¸Šæ¨é€ä»Šæ—¥è¿åŠ¿' },
   193â†’                { id: 'astro', label: 'æ˜Ÿè±¡äº‹ä»¶æé†’', desc: 'é‡è¦æ˜Ÿè±¡äº‹ä»¶ï¼ˆæ°´é€†ã€æ»¡æœˆç­‰ï¼‰' },
   194â†’                { id: 'memory', label: 'è®°å¿†æ›´æ–°æé†’', desc: 'å½“ VibeLife æœ‰æ–°çš„æ´å¯Ÿæ—¶' },
   195â†’                { id: 'promo', label: 'ä¼˜æƒ æ´»åŠ¨é€šçŸ¥', desc: 'ä¼šå‘˜ä¼˜æƒ å’Œæ´»åŠ¨ä¿¡æ¯' },
   196â†’              ].map((item) => (
   197â†’                <div key={item.id} className="flex items-center justify-between p-4 bg-[var(--bg-card-alt)] rounded-lg">
   198â†’                  <div>
   199â†’                    <p className="text-text-primary font-medium">{item.label}</p>
   200â†’                    <p className="text-sm text-text-secondary">{item.desc}</p>
   201â†’                  </div>
   202â†’                  <label className="relative inline-flex items-center cursor-pointer">
   203â†’                    <input type="checkbox" defaultChecked className="sr-only peer" />
   204â†’                    <div className="w-11 h-6 bg-[var(--bg-secondary)] peer-focus:ring-2 peer-focus:ring-amber rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-accent"></div>
   205â†’                  </label>
   206â†’                </div>
   207â†’              ))}
   208â†’            </div>
   209â†’          </div>
   210â†’        )
   211â†’      case 'membership':
   212â†’        return (
   213â†’          <div className="space-y-6">
   214â†’            <h2 className="font-serif text-xl text-text-primary">ä¼šå‘˜ç®¡ç†</h2>
   215â†’            <div className="card p-6">
   216â†’              <div className="flex items-center justify-between mb-4">
   217â†’                <div>
   218â†’                  <p className="text-text-primary font-medium">å½“å‰çŠ¶æ€</p>
   219â†’                  <p className="text-sm text-text-secondary">å…è´¹ç”¨æˆ·</p>
   220â†’                </div>
   221â†’                <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded-full text-sm text-text-secondary">Free</span>
   222â†’              </div>
   223â†’              <button onClick={() => router.push('/membership')} className="btn btn-premium w-full">
   224â†’                âœ¨ å‡çº§ Premium
   225â†’              </button>
   226â†’            </div>
   227â†’            <div className="space-y-3">
   228â†’              <p className="text-sm text-text-secondary">Premium ä¼šå‘˜æƒç›Šï¼š</p>
   229â†’              <ul className="space-y-2 text-sm text-text-secondary">
   230â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´æ¯æ—¥è¿åŠ¿</li>
   231â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> 30æ¬¡/å¤© AIå¯¹è¯</li>
   232â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´å¤§è¿/æµå¹´åˆ†æ</li>
   233â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> Identity Prism æ·±åº¦è§£è¯»</li>
   234â†’              </ul>
   235â†’            </div>
   236â†’          </div>
   237â†’        )
   238â†’      case 'memory':
   239â†’        return (
   240â†’          <div className="space-y-6">
   241â†’            <h2 className="font-serif text-xl text-text-primary">è®°å¿†ç®¡ç†</h2>
   242â†’            <p className="text-sm text-text-secondary">VibeLife ä¼šè®°ä½ä½ åˆ†äº«çš„ä¿¡æ¯ï¼Œä»¥æä¾›æ›´ä¸ªæ€§åŒ–çš„ä½“éªŒã€‚</p>
   243â†’            <div className="space-y-3">
   244â†’              {[
   245â†’                { content: 'ä½ æœ€è¿‘å·¥ä½œå‹åŠ›è¾ƒå¤§', date: '2å¤©å‰' },
   246â†’                { content: 'å…³æ³¨èŒä¸šå‘å±•æ–¹å‘', date: '1å‘¨å‰' },
   247â†’                { content: 'å¯¹æ„Ÿæƒ…é—®é¢˜æœ‰å›°æ‰°', date: '2å‘¨å‰' },
   248â†’              ].map((memory, i) => (
   249â†’                <div key={i} className="flex items-center justify-between p-4 bg-[var(--bg-callout)] rounded-lg">
   250â†’                  <div>
   251â†’                    <p className="text-text-primary">{memory.content}</p>
   252â†’                    <p className="text-xs text-text-secondary mt-1">{memory.date}</p>
   253â†’                  </div>
   254â†’                  <button className="text-sm text-error">åˆ é™¤</button>
   255â†’                </div>
   256â†’              ))}
   257â†’            </div>
   258â†’            <button className="text-sm text-error">æ¸…é™¤æ‰€æœ‰è®°å¿†</button>
   259â†’          </div>
   260â†’        )
   261â†’      case 'account':
   262â†’        return (
   263â†’          <div className="space-y-6">
   264â†’            <h2 className="font-serif text-xl text-text-primary">è´¦æˆ·ç®¡ç†</h2>
   265â†’            <AccountDeletionSection />
   266â†’          </div>
   267â†’        )
   268â†’      case 'about':
   269â†’        return (
   270â†’          <div className="space-y-6">
   271â†’            <h2 className="font-serif text-xl text-text-primary">å…³äº VibeLife</h2>
   272â†’            <div className="text-center py-8">
   273â†’              <span className="text-5xl mb-4 block">ğŸŒŸ</span>
   274â†’              <h3 className="font-serif text-2xl text-text-primary mb-2">VibeLife</h3>
   275â†’              <p className="text-text-secondary mb-4">æ¢ç´¢å†…å¿ƒä¸–ç•Œ</p>
   276â†’              <p className="text-sm text-text-secondary">ç‰ˆæœ¬ 5.0.0</p>
   277â†’            </div>
   278â†’            <div className="space-y-2 text-sm text-text-secondary">
   279â†’              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">ç”¨æˆ·åè®®</button>
   280â†’              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">éšç§æ”¿ç­–</button>
   281â†’              <button className="w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">è”ç³»æˆ‘ä»¬</button>
   282â†’            </div>
   283â†’          </div>
   284â†’        )
   285â†’      default:
   286â†’        return (
   287â†’          <div className="text-center py-8 text-text-secondary">
   288â†’            <p>è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
   289â†’          </div>
   290â†’        )
   291â†’    }
   292â†’  }
   293â†’
   294â†’  // PCç«¯å³ä¾§è¾¹æ  - è®¾ç½®èœå•
   295â†’  const AsideContent = () => (
   296â†’    <div className="space-y-2">
   297â†’      {SETTINGS_MENU.map((item) => (
   298â†’        <button
   299â†’          key={item.id}
   300â†’          onClick={() => setActiveSection(item.id)}
   301â†’          className={`w-full flex items-center gap-3 p-3 rounded-lg text-left transition-colors ${
   302â†’            activeSection === item.id
   303â†’              ? 'bg-accent/10 text-accent'
   304â†’              : 'text-text-secondary hover:bg-[var(--bg-secondary)]'
   305â†’          }`}
   306â†’        >
   307â†’          <span className="text-lg">{item.icon}</span>
   308â†’          <span className="text-sm">{item.label}</span>
   309â†’        </button>
   310â†’      ))}
   311â†’      <div className="pt-4 mt-4 border-t border-[var(--border-light)]">
   312â†’        <button className="w-full flex items-center gap-3 p-3 rounded-lg text-left text-error hover:bg-error/5 transition-colors">
   313â†’          <span className="text-lg">ğŸšª</span>
   314â†’          <span className="text-sm">é€€å‡ºç™»å½•</span>
   315â†’        </button>
   316â†’      </div>
   317â†’    </div>
   318â†’  )
   319â†’
   320â†’  // PCç«¯ä¸»å†…å®¹
   321â†’  const PCContent = () => (
   322â†’    <div className="card p-6">
   323â†’      <SettingsContent />
   324â†’    </div>
   325â†’  )
   326â†’
   327â†’  // ç§»åŠ¨ç«¯å†…å®¹
   328â†’  const MobileContent = () => (
   329â†’    <div className="min-h-screen bg-bg-primary lg:hidden">
   330â†’      <nav className="nav">
   331â†’        <div className="nav-container">
   332â†’          <button onClick={() => router.back()} className="text-text-secondary">â† è¿”å›</button>
   333â†’          <h1 className="font-serif text-card-title text-text-primary">è®¾ç½®</h1>
   334â†’          <div className="w-8" />
   335â†’        </div>
   336â†’      </nav>
   337â†’
   338â†’      <main className="max-w-lg mx-auto px-4 py-6">
   339â†’        <div className="space-y-2">
   340â†’          {SETTINGS_MENU.map((item, index) => (
   341â†’            <button
   342â†’              key={item.id}
   343â†’              onClick={() => {
   344â†’                if (item.id === 'membership') {
   345â†’                  router.push('/membership')
   346â†’                } else {
   347â†’                  setActiveSection(item.id)
   348â†’                }
   349â†’              }}
   350â†’              className="w-full card p-4 flex items-center gap-3 animate-slide-in-up stagger-item"
   351â†’              style={{ animationDelay: `${index * 50}ms` }}
   352â†’            >
   353â†’              <span className="text-xl">{item.icon}</span>
   354â†’              <span className="text-text-primary">{item.label}</span>
   355â†’              <span className="ml-auto text-text-secondary">â€º</span>
   356â†’            </button>
   357â†’          ))}
   358â†’        </div>
   359â†’
   360â†’        <div className="mt-8">
   361â†’          <button className="w-full p-4 text-center text-error">é€€å‡ºç™»å½•</button>
   362â†’        </div>
   363â†’
   364â†’        <div className="mt-8 text-center text-sm text-text-secondary">
   365â†’          <p>VibeLife v5.0.0</p>
   366â†’        </div>
   367â†’      </main>
   368â†’    </div>
   369â†’  )
   370â†’
   371â†’  return (
   372â†’    <>
   373â†’      {/* PCç«¯: ä½¿ç”¨ PCLayout ä¸‰æ å¸ƒå±€ */}
   374â†’      <div className="hidden lg:block">
   375â†’        <PCLayout
   376â†’          breadcrumb={[
   377â†’            { label: 'é¦–é¡µ', href: '/' },
   378â†’            { label: 'è®¾ç½®' }
   379â†’          ]}
   380â†’          aside={<AsideContent />}
   381â†’          showCommandBar={false}
   382â†’        >
   383â†’          <PCContent />
   384â†’        </PCLayout>
   385â†’      </div>
   386â†’
   387â†’      {/* ç§»åŠ¨ç«¯: ç®€å•å•æ å¸ƒå±€ */}
   388â†’      <MobileContent />
   389â†’    </>
   390â†’  )
   391â†’}
   392â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
