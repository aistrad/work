     1→/**
     2→ * CardRegistry v7.0 - 工具-卡片映射注册表 (V7 重构版)
     3→ *
     4→ * v7.0 变更:
     5→ * - 新增 11 种通用视图类型 (list, tree, table, timeline, form, select, chart, progress, counter, modal, toast)
     6→ * - 新增 custom 类型支持自定义组件
     7→ * - 删除旧的业务卡片类型 (insight_card, skill_services, service_recommendation)
     8→ * - 保留 Skill 专属卡片 (bazi_chart, zodiac_chart 等)
     9→ *
    10→ * 每个后端工具通过 card_type 映射到前端组件。
    11→ * 新增 Skill 时，同时注册对应的卡片组件。
    12→ */
    13→
    14→import React, { Suspense, lazy } from 'react';
    15→
    16→// 卡片组件类型
    17→type CardComponent = React.FC<any>;
    18→type LazyCardLoader = () => Promise<{ default: CardComponent }>;
    19→
    20→// 卡片注册表 - 支持直接组件或懒加载器
    21→const cardRegistry = new Map<string, CardComponent>();
    22→const lazyCardRegistry = new Map<string, React.LazyExoticComponent<CardComponent>>();
    23→
    24→/**
    25→ * 注册卡片组件 (直接注册)
    26→ */
    27→export function registerCard(cardType: string, component: CardComponent): void {
    28→  cardRegistry.set(cardType, component);
    29→}
    30→
    31→/**
    32→ * 注册懒加载卡片组件 (Vercel rule: bundle-dynamic-imports)
    33→ */
    34→export function registerLazyCard(cardType: string, loader: LazyCardLoader): void {
    35→  const LazyComponent = lazy(loader);
    36→  lazyCardRegistry.set(cardType, LazyComponent);
    37→}
    38→
    39→/**
    40→ * 获取卡片组件
    41→ */
    42→export function getCard(cardType: string): CardComponent | React.LazyExoticComponent<CardComponent> | undefined {
    43→  // 优先返回直接注册的组件
    44→  const directComponent = cardRegistry.get(cardType);
    45→  if (directComponent) return directComponent;
    46→
    47→  // 其次返回懒加载组件
    48→  return lazyCardRegistry.get(cardType);
    49→}
    50→
    51→/**
    52→ * 渲染卡片 (支持懒加载)
    53→ */
    54→export function renderCard(cardType: string, props: any): React.ReactNode {
    55→  const Component = getCard(cardType);
    56→  if (!Component) {
    57→    console.warn(`Unknown card type: ${cardType}`);
    58→    return null;
    59→  }
    60→
    61→  // 检查是否是懒加载组件
    62→  const isLazy = lazyCardRegistry.has(cardType);
    63→
    64→  if (isLazy) {
    65→    // 懒加载组件需要 Suspense 包装
    66→    return React.createElement(
    67→      Suspense,
    68→      { fallback: React.createElement('div', { className: 'animate-pulse bg-gray-100 rounded-lg h-32' }) },
    69→      React.createElement(Component, props)
    70→    );
    71→  }
    72→
    73→  return React.createElement(Component, props);
    74→}
    75→
    76→/**
    77→ * 检查卡片是否已注册
    78→ */
    79→export function hasCard(cardType: string): boolean {
    80→  return cardRegistry.has(cardType) || lazyCardRegistry.has(cardType);
    81→}
    82→
    83→/**
    84→ * 获取所有已注册的卡片类型
    85→ */
    86→export function getRegisteredCardTypes(): string[] {
    87→  const directTypes = Array.from(cardRegistry.keys());
    88→  const lazyTypes = Array.from(lazyCardRegistry.keys());
    89→  return Array.from(new Set([...directTypes, ...lazyTypes]));
    90→}
    91→
    92→// ═══════════════════════════════════════════════════════════════════════════
    93→// 卡片类型常量 (V7)
    94→// ═══════════════════════════════════════════════════════════════════════════
    95→
    96→export const CARD_TYPES = {
    97→  // ═══════════════════════════════════════════════════════════════════════════
    98→  // 通用视图类型 (V7 新增)
    99→  // ═══════════════════════════════════════════════════════════════════════════
   100→  LIST: 'list',
   101→  TREE: 'tree',
   102→  TABLE: 'table',
   103→  TIMELINE: 'timeline',
   104→  FORM: 'form',
   105→  SELECT: 'select',
   106→  CHART: 'chart',
   107→  PROGRESS: 'progress',
   108→  COUNTER: 'counter',
   109→  MODAL: 'modal',
   110→  TOAST: 'toast',
   111→  CUSTOM: 'custom',
   112→
   113→  // ═══════════════════════════════════════════════════════════════════════════
   114→  // 向后兼容 (将逐步废弃)
   115→  // ═══════════════════════════════════════════════════════════════════════════
   116→  COLLECT_FORM: 'collect_form',
   117→  INSIGHT_CARD: 'insight_card',
   118→  REPORT_CARD: 'report_card',
   119→  SKILL_SERVICES: 'skill_services',
   120→  SERVICE_RECOMMENDATION: 'service_recommendation',
   121→
   122→  // ═══════════════════════════════════════════════════════════════════════════
   123→  // Skill 自定义卡片 (通过 custom + component_id 访问)
   124→  // ═══════════════════════════════════════════════════════════════════════════
   125→  // Bazi
   126→  BAZI_CHART: 'bazi_chart',
   127→  BAZI_FORTUNE: 'bazi_fortune',
   128→  BAZI_KLINE: 'bazi_kline',
   129→  BAZI_DAILY_FORTUNE: 'bazi_daily_fortune',
   130→
   131→  // Zodiac
   132→  ZODIAC_CHART: 'zodiac_chart',
   133→  ZODIAC_TRANSIT: 'zodiac_transit',
   134→  ZODIAC_SYNASTRY: 'zodiac_synastry',
   135→  ZODIAC_LUNAR_PHASE: 'zodiac_lunar_phase',
   136→
   137→  // Tarot
   138→  TAROT_SPREAD: 'tarot_spread',
   139→
   140→  // Career
   141→  CAREER_ANALYSIS: 'career_analysis',
   142→
   143→  // Jungastro (荣格心理占星)
   144→  JUNGASTRO_PORTRAIT: 'jungastro_portrait',
   145→  JUNGASTRO_SHADOW: 'jungastro_shadow',
   146→  JUNGASTRO_INDIVIDUATION: 'jungastro_individuation',
   147→  JUNGASTRO_FUNCTIONS: 'jungastro_functions',
   148→  JUNGASTRO_RELATIONSHIP: 'jungastro_relationship',
   149→
   150→  // VibeID
   151→  VIBE_ID: 'vibe_id',
   152→  VIBE_ID_RADAR: 'vibe_id_radar',
   153→} as const;
   154→
   155→export type CardType = typeof CARD_TYPES[keyof typeof CARD_TYPES];
   156→
   157→// ═══════════════════════════════════════════════════════════════════════════
   158→// 默认导出
   159→// ═══════════════════════════════════════════════════════════════════════════
   160→
   161→export const CardRegistry = {
   162→  register: registerCard,
   163→  registerLazy: registerLazyCard,
   164→  get: getCard,
   165→  render: renderCard,
   166→  has: hasCard,
   167→  getTypes: getRegisteredCardTypes,
   168→  TYPES: CARD_TYPES,
   169→};
   170→
   171→export default CardRegistry;
   172→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
