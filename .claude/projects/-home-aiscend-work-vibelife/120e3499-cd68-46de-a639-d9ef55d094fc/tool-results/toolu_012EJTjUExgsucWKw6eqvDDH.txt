   350â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   351â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   352â†’        phase_num, phase_name, phase_content = match.groups()
   353â†’        phase = {
   354â†’            "phase": int(phase_num),
   355â†’            "name": phase_name.strip(),
   356â†’            "content": phase_content.strip()
   357â†’        }
   358â†’        # æå–ç±»å‹
   359â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   360â†’        if type_match:
   361â†’            phase["type"] = type_match.group(1)
   362â†’        sop.append(phase)
   363â†’    result["sop"] = sop
   364â†’
   365â†’    # æå–å·¥å…·åˆ—è¡¨
   366â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   367â†’    result["tools"] = []
   368â†’    if tools_match:
   369â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   370â†’
   371â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   372â†’    result["knowledge_config"] = {}
   373â†’    result["output_config"] = {}
   374â†’
   375â†’    return result
   376â†’
   377â†’
   378â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   379â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   380â†’    metadata, content = parse_frontmatter(text)
   381â†’
   382â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   383â†’    tags_raw = metadata.get("tags", [])
   384â†’    if isinstance(tags_raw, str):
   385â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   386â†’    else:
   387â†’        tags = tags_raw
   388â†’
   389â†’    result = {
   390â†’        "id": metadata.get("id", ""),
   391â†’        "name": metadata.get("name", ""),
   392â†’        "impact": metadata.get("impact", "MEDIUM"),
   393â†’        "impact_description": metadata.get("impactDescription", ""),
   394â†’        "tags": tags,
   395â†’        "content": content,
   396â†’    }
   397â†’
   398â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   399â†’    analysis_steps = []
   400â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   401â†’    if table_match:
   402â†’        for row in table_match.group(1).strip().split('\n'):
   403â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   404â†’            if len(cols) >= 4:
   405â†’                analysis_steps.append({
   406â†’                    "step": cols[0],
   407â†’                    "point": cols[1],
   408â†’                    "query": cols[2],
   409â†’                    "priority": cols[3],
   410â†’                })
   411â†’    result["analysis_steps"] = analysis_steps
   412â†’
   413â†’    # æå–è¾“å‡ºè¦æ±‚
   414â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   415â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   416â†’
   417â†’    # æå–å¸¸è§é—®é¢˜
   418â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   419â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   420â†’
   421â†’    return result
   422â†’
   423â†’
   424â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   425â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   426â†’    services = {"entry": [], "standard": [], "professional": []}
   427â†’
   428â†’    tier_map = {
   429â†’        "entry": "entry",
   430â†’        "standard": "standard",
   431â†’        "professional": "professional"
   432â†’    }
   433â†’
   434â†’    for tier_name, tier_key in tier_map.items():
   435â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   436â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   437â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   438â†’        if not match:
   439â†’            continue
   440â†’
   441â†’        table_content = match.group(1).strip()
   442â†’        if not table_content:
   443â†’            continue
   444â†’
   445â†’        for row in table_content.split('\n'):
   446â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   447â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   448â†’                continue
   449â†’
   450â†’            service = {
   451â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   452â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   453â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   454â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   455â†’                "tier": tier_key,
   456â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   457â†’                "highlights": []
   458â†’            }
   459â†’
   460â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   461â†’            if len(cols) > 7 and cols[7]:
   462â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   463â†’
   464â†’            services[tier_key].append(service)
   465â†’
   466â†’    return services
   467â†’
   468â†’
   469â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   470â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   471â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   472â†’    if not skill_path.exists():
   473â†’        return None
   474â†’
   475â†’    text = skill_path.read_text(encoding='utf-8')
   476â†’    metadata, _ = parse_frontmatter(text)
   477â†’    services = parse_skill_services(text)
   478â†’
   479â†’    return {
   480â†’        "skill_id": skill_id,
   481â†’        "skill_name": metadata.get("name", skill_id),
   482â†’        "description": metadata.get("description", ""),
   483â†’        "services": services
   484â†’    }
   485â†’
   486â†’
   487â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   488â†’# åŠ è½½å‡½æ•°
   489â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   490â†’
   491â†’@lru_cache(maxsize=32)
   492â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   493â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   494â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   495â†’    if not skill_path.exists():
   496â†’        return None
   497â†’
   498â†’    text = skill_path.read_text(encoding='utf-8')
   499â†’    data = parse_skill_md(text)
   500â†’
   501â†’    return SkillConfig(
   502â†’        id=data.get("id", skill_id),
   503â†’        name=data.get("name", skill_id),
   504â†’        description=data.get("description", ""),
   505â†’        expert_persona=data.get("expert_persona", ""),
   506â†’        scenarios=data.get("scenarios", {}),
   507â†’        ethics=data.get("ethics", {}),
   508â†’        tools=data.get("tools", []),
   509â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   510â†’        triggers=data.get("triggers", []),
   511â†’        global_tools=data.get("global_tools", []),
   512â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   513â†’        requires_birth_info=data.get("requires_birth_info", False),
   514â†’        requires_compute=data.get("requires_compute", False),
   515â†’        compute_type=data.get("compute_type", None),
   516â†’        compute_tool=data.get("compute_tool", None),
   517â†’        collect_tool=data.get("collect_tool", None),
   518â†’        external_tools=data.get("external_tools", []),  # v7.3
   519â†’    )
   520â†’
   521â†’
   522â†’@lru_cache(maxsize=32)
   523â†’def load_skill_metadata(skill_id: str) -> Optional[SkillMetadata]:
   524â†’    """åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰- v7.4 æ–°å¢
   525â†’
   526â†’    ä» SKILL.md çš„ frontmatter ä¸­è¯»å–å®Œæ•´çš„å…ƒæ•°æ®é…ç½®ï¼Œ
   527â†’    åŒ…æ‹¬ category, pricing, showcase, subscription ç­‰å­—æ®µã€‚
   528â†’    """
   529â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   530â†’    if not skill_path.exists():
   531â†’        return None
   532â†’
   533â†’    text = skill_path.read_text(encoding='utf-8')
   534â†’    metadata, _ = parse_frontmatter(text)
   535â†’
   536â†’    # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   537â†’    triggers = metadata.get("triggers", [])
   538â†’    if not triggers:
   539â†’        description = metadata.get("description", "")
   540â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   541â†’        if trigger_match:
   542â†’            trigger_str = trigger_match.group(1)
   543â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   544â†’
   545â†’    # è§£æ pricing
   546â†’    pricing_data = metadata.get("pricing", {})
   547â†’    pricing = SkillPricing(
   548â†’        type=pricing_data.get("type", "free") if isinstance(pricing_data, dict) else "free",
   549â†’        trial_messages=pricing_data.get("trial_messages", 3) if isinstance(pricing_data, dict) else 3,
   550â†’        credits_per_use=pricing_data.get("credits_per_use") if isinstance(pricing_data, dict) else None,
   551â†’    )
   552â†’
   553â†’    # è§£æ features
   554â†’    features_data = metadata.get("features", [])
   555â†’    features = []
   556â†’    if isinstance(features_data, list):
   557â†’        for f in features_data:
   558â†’            if isinstance(f, dict):
   559â†’                features.append(SkillFeature(
   560â†’                    name=f.get("name", ""),
   561â†’                    description=f.get("description", ""),
   562â†’                    icon=f.get("icon", "ğŸ“Œ"),
   563â†’                    tier=f.get("tier", "free"),
   564â†’                ))
   565â†’
   566â†’    # è§£æ showcase
   567â†’    showcase_data = metadata.get("showcase", {})
   568â†’    showcase = SkillShowcase(
   569â†’        tagline=showcase_data.get("tagline", "") if isinstance(showcase_data, dict) else "",
   570â†’        highlights=showcase_data.get("highlights", []) if isinstance(showcase_data, dict) else [],
   571â†’        preview_image=showcase_data.get("preview_image") if isinstance(showcase_data, dict) else None,
   572â†’        demo_prompts=showcase_data.get("demo_prompts", []) if isinstance(showcase_data, dict) else [],
   573â†’    )
   574â†’
   575â†’    # è§£æ subscription
   576â†’    subscription_data = metadata.get("subscription", {})
   577â†’    category = metadata.get("category", "professional")
   578â†’    subscription = SkillSubscription(
   579â†’        auto_subscribe=subscription_data.get("auto_subscribe", category == "default") if isinstance(subscription_data, dict) else (category == "default"),
   580â†’        can_unsubscribe=subscription_data.get("can_unsubscribe", category != "core") if isinstance(subscription_data, dict) else (category != "core"),
   581â†’        push_default=subscription_data.get("push_default", True) if isinstance(subscription_data, dict) else True,
   582â†’        min_subscription_days=subscription_data.get("min_subscription_days", 0) if isinstance(subscription_data, dict) else 0,
   583â†’    )
   584â†’
   585â†’    return SkillMetadata(
   586â†’        id=metadata.get("id", skill_id),
   587â†’        name=metadata.get("name", skill_id),
   588â†’        description=metadata.get("description", ""),
   589â†’        version=metadata.get("version", "1.0.0"),
   590â†’        category=category,
   591â†’        icon=metadata.get("icon", "ğŸ’¡"),
   592â†’        color=metadata.get("color", "#6B7280"),
   593â†’        triggers=triggers,
   594â†’        pricing=pricing,
   595â†’        features=features,
   596â†’        showcase=showcase,
   597â†’        subscription=subscription,
   598â†’    )
   599â†’
   600â†’
   601â†’def get_all_skill_metadata() -> List[SkillMetadata]:
   602â†’    """è·å–æ‰€æœ‰å¯ç”¨ Skill çš„å…ƒæ•°æ®ï¼ˆç”¨äº Skill åˆ—è¡¨ APIï¼‰- v7.4 æ–°å¢"""
   603â†’    skills = []
   604â†’    for skill_id in get_available_skills():
   605â†’        metadata = load_skill_metadata(skill_id)
   606â†’        if metadata:
   607â†’            skills.append(metadata)
   608â†’    return skills
   609â†’
   610â†’
   611â†’def get_skills_by_category(category: str) -> List[SkillMetadata]:
   612â†’    """æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ - v7.4 æ–°å¢
   613â†’
   614â†’    Args:
   615â†’        category: core | default | professional
   616â†’
   617â†’    Returns:
   618â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„å…ƒæ•°æ®åˆ—è¡¨
   619â†’    """
   620â†’    return [s for s in get_all_skill_metadata() if s.category == category]
   621â†’
   622â†’
   623â†’@lru_cache(maxsize=64)
   624â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   625â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   626â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   627â†’    if not scenario_path.exists():
   628â†’        return None
   629â†’
   630â†’    text = scenario_path.read_text(encoding='utf-8')
   631â†’    data = parse_scenario_md(text)
   632â†’
   633â†’    return ScenarioConfig(
   634â†’        id=data.get("id", scenario_id),
   635â†’        name=data.get("name", scenario_id),
   636â†’        level=data.get("level", "entry"),
   637â†’        billing=data.get("billing", "free"),
   638â†’        description=data.get("description", ""),
   639â†’        triggers=data.get("triggers", {}),
   640â†’        prerequisites=data.get("prerequisites", []),
   641â†’        sop=data.get("sop", []),
   642â†’        knowledge_config=data.get("knowledge_config", {}),
   643â†’        output_config=data.get("output_config", {}),
   644â†’        tools=data.get("tools", [])
   645â†’    )
   646â†’
   647â†’
   648â†’@lru_cache(maxsize=128)
   649â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   650â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢"""
   651â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   652â†’    if not rule_path.exists():
   653â†’        return None
   654â†’
   655â†’    text = rule_path.read_text(encoding='utf-8')
   656â†’    data = parse_rule_md(text)
   657â†’
   658â†’    return RuleConfig(
   659â†’        id=data.get("id", rule_id),
   660â†’        name=data.get("name", rule_id),
   661â†’        impact=data.get("impact", "MEDIUM"),
   662â†’        impact_description=data.get("impact_description", ""),
   663â†’        tags=data.get("tags", []),
   664â†’        content=data.get("content", ""),
   665â†’        analysis_steps=data.get("analysis_steps", []),
   666â†’        output_requirements=data.get("output_requirements", ""),
   667â†’        common_questions=data.get("common_questions", ""),
   668â†’    )
   669â†’
   670â†’
   671â†’def get_skill_rules(skill_id: str) -> List[str]:
   672â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢"""
   673â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   674â†’    if not rules_dir.exists():
   675â†’        return []
   676â†’    return [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   677â†’
   678â†’
   679â†’def has_rules(skill_id: str) -> bool:
   680â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   681â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   682â†’    if not rules_dir.exists():
   683â†’        return False
   684â†’    rules = list(rules_dir.glob("*.md"))
   685â†’    return len(rules) > 0
   686â†’
   687â†’
   688â†’def get_available_skills() -> List[str]:
   689â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   690â†’    if not SKILLS_DIR.exists():
   691â†’        return []
   692â†’    return [p.name for p in SKILLS_DIR.iterdir()
   693â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   694â†’
   695â†’
   696â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   697â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   698â†’
   699â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   700â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   701â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼‰
   702â†’    """
   703â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   704â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   705â†’    if rules_dir.exists():
   706â†’        rules = [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   707â†’        if rules:
   708â†’            return rules
   709â†’
   710â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   711â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   712â†’    if not scenarios_dir.exists():
   713â†’        return []
   714â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   715â†’
   716â†’
   717â†’def get_skill_triggers() -> Dict[str, List[str]]:
   718â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   719â†’    triggers = {}
   720â†’    for skill_id in get_available_skills():
   721â†’        if skill_id == "core":
   722â†’            continue
   723â†’        skill = load_skill(skill_id)
   724â†’        if skill and skill.triggers:
   725â†’            triggers[skill_id] = skill.triggers
   726â†’    return triggers
   727â†’
   728â†’
   729â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   730â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   731â†’    skill = load_skill(skill_id)
   732â†’    if skill and skill.global_tools:
   733â†’        return skill.global_tools
   734â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   735â†’    return []
   736â†’
   737â†’
   738â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   739â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   740â†’    skill = load_skill(skill_id)
   741â†’    if skill and skill.external_tools:
   742â†’        return skill.external_tools
   743â†’    return []
   744â†’
   745â†’
   746â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   747â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
   748â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   749â†’
   750â†’def skill_requires_birth_info(skill_id: str) -> bool:
   751â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   752â†’    skill = load_skill(skill_id)
   753â†’    return skill.requires_birth_info if skill else False
   754â†’
   755â†’
   756â†’def skill_requires_compute(skill_id: str) -> bool:
   757â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   758â†’    skill = load_skill(skill_id)
   759â†’    return skill.requires_compute if skill else False
   760â†’
   761â†’
   762â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
   763â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
   764â†’
   765â†’    è¿”å›å€¼ï¼š
   766â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
   767â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
   768â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
   769â†’    """
   770â†’    skill = load_skill(skill_id)
   771â†’    return skill.compute_type if skill else None
   772â†’
   773â†’
   774â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
   775â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   776â†’
   777â†’    è¿”å›å€¼ï¼š
   778â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
   779â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   780â†’    """
   781â†’    skill = load_skill(skill_id)
   782â†’    return skill.compute_tool if skill else None
   783â†’
   784â†’
   785â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
   786â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   787â†’
   788â†’    è¿”å›å€¼ï¼š
   789â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
   790â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   791â†’    """
   792â†’    skill = load_skill(skill_id)
   793â†’    return skill.collect_tool if skill else None
   794â†’
   795â†’
   796â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   797â†’# System Prompt æ„å»º
   798â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   799â†’
   800â†’def build_system_prompt(
   801â†’    skill_id: str,
   802â†’    scenario_id: Optional[str] = None,
   803â†’    user_context: Optional[Dict] = None
   804â†’) -> str:
   805â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
   806â†’
   807â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
   808â†’    """
   809â†’    parts = []
   810â†’
   811â†’    # åŠ è½½ Skill
   812â†’    skill = load_skill(skill_id)
   813â†’    if not skill:
   814â†’        return ""
   815â†’
   816â†’    # ä¸“å®¶èº«ä»½
   817â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   818â†’
   819â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
   820â†’    if scenario_id:
   821â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
   822â†’        if has_rules(skill_id):
   823â†’            rule = load_rule(skill_id, scenario_id)
   824â†’            if rule:
   825â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
   826â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
   827â†’                parts.append(rule.content)
   828â†’            else:
   829â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
   830â†’                scenario = load_scenario(skill_id, scenario_id)
   831â†’                if scenario:
   832â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   833â†’                    if scenario.sop:
   834â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   835â†’                        for phase in scenario.sop:
   836â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   837â†’                        parts.append(sop_text)
   838â†’        else:
   839â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
   840â†’            scenario = load_scenario(skill_id, scenario_id)
   841â†’            if scenario:
   842â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   843â†’                # SOP
   844â†’                if scenario.sop:
   845â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   846â†’                    for phase in scenario.sop:
   847â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   848â†’                    parts.append(sop_text)
   849â†’
   850â†’    # ä¼¦ç†è¾¹ç•Œ
   851â†’    if skill.ethics.get("forbidden"):
   852â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   853â†’        for item in skill.ethics["forbidden"]:
   854â†’            ethics_text += f"- {item}\n"
   855â†’        parts.append(ethics_text)
   856â†’
   857â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ
   858â†’    if user_context:
   859â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   860â†’
   861â†’        # ç‰¹æ®Šå¤„ç† birth_info
   862â†’        if user_context.get("birth_info"):
   863â†’            birth_info = user_context['birth_info']
   864â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
   865â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
   866â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
   867â†’
   868â†’        # ç‰¹æ®Šå¤„ç† portrait
   869â†’        if user_context.get("portrait"):
   870â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
   871â†’
   872â†’        # ç‰¹æ®Šå¤„ç† extracted (æŠ½å–çš„ç”¨æˆ·ä¿¡æ¯)
   873â†’        if user_context.get("extracted"):
   874â†’            extracted = user_context['extracted']
   875â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
   876â†’            if extracted.get("facts"):
   877â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
   878â†’            if extracted.get("concerns"):
   879â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
   880â†’            if extracted.get("goals"):
   881â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
   882â†’            if extracted.get("pain_points"):
   883â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
   884â†’            if extracted.get("life_events"):
   885â†’                events = [f"{e.get('date', '?')}: {e.get('event', '')}" for e in extracted['life_events'][:5]]
   886â†’                ctx_text += f"**è¿‘æœŸäº‹ä»¶**: {'; '.join(events)}\n"
   887â†’
   888â†’        # ç‰¹æ®Šå¤„ç† identity_prism
   889â†’        if user_context.get("identity_prism"):
   890â†’            prism = user_context['identity_prism']
   891â†’            ctx_text += f"\n### èº«ä»½ç‰¹å¾\n"
   892â†’            if prism.get("core"):
   893â†’                ctx_text += f"**æ ¸å¿ƒç‰¹è´¨**: {prism['core']}\n"
   894â†’            if prism.get("inner"):
   895â†’                ctx_text += f"**å†…åœ¨éœ€æ±‚**: {prism['inner']}\n"
   896â†’            if prism.get("outer"):
   897â†’                ctx_text += f"**å¤–åœ¨è¡¨ç°**: {prism['outer']}\n"
   898â†’
   899â†’        # ç‰¹æ®Šå¤„ç† life_context
   900â†’        if user_context.get("life_context"):
   901â†’            life_ctx = user_context['life_context']
   902â†’            if life_ctx.get("concerns") or life_ctx.get("goals") or life_ctx.get("pain_points"):
   903â†’                ctx_text += f"\n### ç”Ÿæ´»èƒŒæ™¯\n"
   904â†’                if life_ctx.get("concerns"):
   905â†’                    ctx_text += f"**å…³æ³¨**: {', '.join(life_ctx['concerns'])}\n"
   906â†’                if life_ctx.get("goals"):
   907â†’                    ctx_text += f"**ç›®æ ‡**: {', '.join(life_ctx['goals'])}\n"
   908â†’                if life_ctx.get("pain_points"):
   909â†’                    ctx_text += f"**å›°éš¾**: {', '.join(life_ctx['pain_points'])}\n"
   910â†’
   911â†’        parts.append(ctx_text)
   912â†’
   913â†’    return "\n".join(parts)
   914â†’
   915â†’
   916â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   917â†’# ç¼“å­˜ç®¡ç†
   918â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   919â†’
   920â†’def clear_cache():
   921â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
   922â†’    load_skill.cache_clear()
   923â†’    load_skill_metadata.cache_clear()  # v7.4
   924â†’    load_scenario.cache_clear()
   925â†’    load_rule.cache_clear()
   926â†’    get_scenario_triggers.cache_clear()
   927â†’    get_rule_triggers.cache_clear()
   928â†’    logger.info("Skill cache cleared")
   929â†’
   930â†’
   931â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
   932â†’    """é‡è½½å•ä¸ª Skill"""
   933â†’    load_skill.cache_clear()
   934â†’    load_scenario.cache_clear()
   935â†’    load_rule.cache_clear()
   936â†’    return load_skill(skill_id)
   937â†’
   938â†’
   939â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   940â†’# åœºæ™¯è·¯ç”± (å†…å­˜åŒ¹é…)
   941â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   942â†’
   943â†’def parse_scenario_triggers(text: str) -> Dict[str, Dict[str, List[str]]]:
   944â†’    """ä» SKILL.md è§£æåœºæ™¯ç›®å½•è¡¨æ ¼ï¼Œæå–è§¦å‘è¯"""
   945â†’    triggers = {}  # {scenario_id: {primary: [...], secondary: [...]}}
   946â†’
   947â†’    # åŒ¹é…ä¸‰ä¸ªçº§åˆ«çš„è¡¨æ ¼
   948â†’    for level in ["entry", "standard", "professional"]:
   949â†’        pattern = rf'### {level.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   950â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   951â†’        if not match:
   952â†’            continue
   953â†’
   954â†’        for row in match.group(1).strip().split('\n'):
   955â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   956â†’            if len(cols) >= 3:
   957â†’                # cols[1] = æ–‡ä»¶å, cols[2] = è§¦å‘è¯
   958â†’                scenario_id = cols[1].replace('.md', '')
   959â†’                trigger_str = cols[2]
   960â†’                # è§£æè§¦å‘è¯ï¼ˆç”¨é¡¿å·æˆ–é€—å·åˆ†éš”ï¼‰
   961â†’                trigger_words = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   962â†’                triggers[scenario_id] = {
   963â†’                    "primary": trigger_words,
   964â†’                    "secondary": []
   965â†’                }
   966â†’
   967â†’    return triggers
   968â†’
   969â†’
   970â†’@lru_cache(maxsize=32)
   971â†’def get_scenario_triggers(skill_id: str) -> Dict[str, Dict[str, List[str]]]:
   972â†’    """è·å– Skill çš„åœºæ™¯è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
   973â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   974â†’    if not skill_path.exists():
   975â†’        return {}
   976â†’
   977â†’    text = skill_path.read_text(encoding='utf-8')
   978â†’    return parse_scenario_triggers(text)
   979â†’
   980â†’
   981â†’def route_scenario(skill_id: str, message: str) -> Optional[str]:
   982â†’    """
   983â†’    å†…å­˜åœºæ™¯è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³åœºæ™¯
   984â†’
   985â†’    Args:
   986â†’        skill_id: Skill ID
   987â†’        message: ç”¨æˆ·æ¶ˆæ¯
   988â†’
   989â†’    Returns:
   990â†’        åŒ¹é…çš„ scenario_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
   991â†’    """
   992â†’    triggers = get_scenario_triggers(skill_id)
   993â†’    if not triggers:
   994â†’        return None
   995â†’
   996â†’    best_match = None
   997â†’    best_score = 0
   998â†’
   999â†’    for scenario_id, trigger_config in triggers.items():
  1000â†’        score = 0
  1001â†’        # ä¸»è¦è§¦å‘è¯æƒé‡ 1.0
  1002â†’        for word in trigger_config.get("primary", []):
  1003â†’            if word in message:
  1004â†’                score += 1.0
  1005â†’        # æ¬¡è¦è§¦å‘è¯æƒé‡ 0.5
  1006â†’        for word in trigger_config.get("secondary", []):
  1007â†’            if word in message:
  1008â†’                score += 0.5
  1009â†’
  1010â†’        if score > best_score:
  1011â†’            best_score = score
  1012â†’            best_match = scenario_id
  1013â†’
  1014â†’    return best_match
  1015â†’
  1016â†’
  1017â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1018â†’# è§„åˆ™è·¯ç”± (v7 æ–°å¢)
  1019â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1020â†’
  1021â†’@lru_cache(maxsize=32)
  1022â†’def get_rule_triggers(skill_id: str) -> Dict[str, List[str]]:
  1023â†’    """è·å– Skill çš„è§„åˆ™è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰- v7 æ–°å¢
  1024â†’
  1025â†’    ä» rules/*.md çš„ frontmatter ä¸­è¯»å– tags ä½œä¸ºè§¦å‘è¯
  1026â†’    """
  1027â†’    triggers = {}  # {rule_id: [tag1, tag2, ...]}
  1028â†’
  1029â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
  1030â†’    if not rules_dir.exists():
  1031â†’        return triggers
  1032â†’
  1033â†’    for rule_path in rules_dir.glob("*.md"):
  1034â†’        if rule_path.stem.startswith("_"):
  1035â†’            continue
  1036â†’
  1037â†’        rule = load_rule(skill_id, rule_path.stem)
  1038â†’        if rule and rule.tags:
  1039â†’            triggers[rule.id] = rule.tags
  1040â†’
  1041â†’    return triggers
  1042â†’
  1043â†’
  1044â†’def route_to_rule(skill_id: str, message: str) -> Optional[str]:
  1045â†’    """
  1046â†’    è§„åˆ™è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³è§„åˆ™ - v7 æ–°å¢
  1047â†’
  1048â†’    ä½¿ç”¨ tags è¿›è¡Œè¯­ä¹‰åŒ¹é…ï¼Œæ”¯æŒæ›´çµæ´»çš„è·¯ç”±
  1049â†’
  1050â†’    Args:
  1051â†’        skill_id: Skill ID
  1052â†’        message: ç”¨æˆ·æ¶ˆæ¯
  1053â†’
  1054â†’    Returns:
  1055â†’        åŒ¹é…çš„ rule_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
  1056â†’    """
  1057â†’    # ä¼˜å…ˆä½¿ç”¨è§„åˆ™è·¯ç”±
  1058â†’    if has_rules(skill_id):
  1059â†’        triggers = get_rule_triggers(skill_id)
  1060â†’        if not triggers:
  1061â†’            return None
  1062â†’
  1063â†’        best_match = None
  1064â†’        best_score = 0
  1065â†’
  1066â†’        for rule_id, tags in triggers.items():
  1067â†’            score = 0
  1068â†’            for tag in tags:
  1069â†’                if tag in message:
  1070â†’                    score += 1.0
  1071â†’
  1072â†’            if score > best_score:
  1073â†’                best_score = score
  1074â†’                best_match = rule_id
  1075â†’
  1076â†’        return best_match
  1077â†’
  1078â†’    # å›é€€åˆ°åœºæ™¯è·¯ç”±ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
  1079â†’    return route_scenario(skill_id, message)
  1080â†’
  1081â†’
  1082â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
  1083â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
  1084â†’
  1085â†’    Args:
  1086â†’        skill_id: Skill ID
  1087â†’        rule_id: Rule ID
  1088â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1089â†’
  1090â†’    Returns:
  1091â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
  1092â†’    """
  1093â†’    parts = []
  1094â†’
  1095â†’    # åŠ è½½ Skill
  1096â†’    skill = load_skill(skill_id)
  1097â†’    if not skill:
  1098â†’        return ""
  1099â†’
  1100â†’    # ä¸“å®¶èº«ä»½
  1101â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1102â†’
  1103â†’    # åŠ è½½è§„åˆ™
  1104â†’    rule = load_rule(skill_id, rule_id)
  1105â†’    if rule:
  1106â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1107â†’
  1108â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1109â†’        parts.append(rule.content)
  1110â†’
  1111â†’    # ä¼¦ç†è¾¹ç•Œ
  1112â†’    if skill.ethics.get("forbidden"):
  1113â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1114â†’        for item in skill.ethics["forbidden"]:
  1115â†’            ethics_text += f"- {item}\n"
  1116â†’        parts.append(ethics_text)
  1117â†’
  1118â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
  1119â†’    if user_context:
  1120â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1121â†’
  1122â†’        if user_context.get("birth_info"):
  1123â†’            birth_info = user_context['birth_info']
  1124â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1125â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1126â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1127â†’
  1128â†’        if user_context.get("portrait"):
  1129â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1130â†’
  1131â†’        if user_context.get("extracted"):
  1132â†’            extracted = user_context['extracted']
  1133â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1134â†’            if extracted.get("facts"):
  1135â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1136â†’            if extracted.get("concerns"):
  1137â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1138â†’            if extracted.get("goals"):
  1139â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1140â†’            if extracted.get("pain_points"):
  1141â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1142â†’
  1143â†’        parts.append(ctx_text)
  1144â†’
  1145â†’    return "\n".join(parts)
  1146â†’
  1147â†’
  1148â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1149â†’# v7.5: æ•°æ®åº“ä¼˜å…ˆçš„å…ƒæ•°æ®åŠ è½½ï¼ˆAsyncï¼‰
  1150â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1151â†’
  1152â†’async def load_skill_metadata_async(skill_id: str) -> Optional[SkillMetadata]:
  1153â†’    """
  1154â†’    å¼‚æ­¥åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼ŒSKILL.md ä½œä¸º fallbackï¼‰- v7.5 æ–°å¢
  1155â†’
  1156â†’    ä¼˜å…ˆçº§ï¼š
  1157â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1158â†’    2. SKILL.md frontmatterï¼ˆé™æ€é…ç½®ï¼‰
  1159â†’
  1160â†’    Args:
  1161â†’        skill_id: Skill ID
  1162â†’
  1163â†’    Returns:
  1164â†’        SkillMetadata å¯¹è±¡ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  1165â†’    """
  1166â†’    try:
  1167â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1168â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1169â†’
  1170â†’        db_entry = await SkillCatalogRepository.get(skill_id)
  1171â†’        if db_entry:
  1172â†’            # è½¬æ¢ SkillCatalogEntry -> SkillMetadata
  1173â†’            return SkillMetadata(
  1174â†’                id=db_entry.skill_id,
  1175â†’                name=db_entry.name,
  1176â†’                description=db_entry.description,
  1177â†’                version=db_entry.version,
  1178â†’                category=db_entry.category,
  1179â†’                icon=db_entry.icon,
  1180â†’                color=db_entry.color,
  1181â†’                triggers=db_entry.triggers,
  1182â†’                pricing=SkillPricing(
  1183â†’                    type=db_entry.pricing.type,
  1184â†’                    trial_messages=db_entry.pricing.trial_messages,
  1185â†’                    credits_per_use=db_entry.pricing.credits_per_use,
  1186â†’                ),
  1187â†’                features=[
  1188â†’                    SkillFeature(
  1189â†’                        name=f.name,
  1190â†’                        description=f.description,
  1191â†’                        icon=f.icon,
  1192â†’                        tier=f.tier,
  1193â†’                    )
  1194â†’                    for f in db_entry.features
  1195â†’                ],
  1196â†’                showcase=SkillShowcase(
  1197â†’                    tagline=db_entry.showcase.tagline,
  1198â†’                    highlights=db_entry.showcase.highlights,
  1199â†’                    preview_image=db_entry.showcase.preview_image,
  1200â†’                    demo_prompts=db_entry.showcase.demo_prompts,
  1201â†’                ),
  1202â†’                subscription=SkillSubscription(
  1203â†’                    auto_subscribe=db_entry.subscription.auto_subscribe,
  1204â†’                    can_unsubscribe=db_entry.subscription.can_unsubscribe,
  1205â†’                    push_default=db_entry.subscription.push_default,
  1206â†’                    min_subscription_days=db_entry.subscription.min_subscription_days,
  1207â†’                ),
  1208â†’            )
  1209â†’    except Exception as e:
  1210â†’        logger.warning(f"Failed to load skill {skill_id} from database: {e}")
  1211â†’
  1212â†’    # 2. Fallback åˆ° SKILL.md
  1213â†’    return load_skill_metadata(skill_id)
  1214â†’
  1215â†’
  1216â†’async def get_all_skill_metadata_async() -> List[SkillMetadata]:
  1217â†’    """
  1218â†’    å¼‚æ­¥è·å–æ‰€æœ‰ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1219â†’
  1220â†’    ä¼˜å…ˆçº§ï¼š
  1221â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1222â†’    2. SKILL.md fallbackï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºæˆ–å‡ºé”™ï¼‰
  1223â†’
  1224â†’    Returns:
  1225â†’        æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1226â†’    """
  1227â†’    try:
  1228â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1229â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1230â†’
  1231â†’        catalog = await SkillCatalogRepository.get_all()
  1232â†’        if catalog:
  1233â†’            return [
  1234â†’                SkillMetadata(
  1235â†’                    id=entry.skill_id,
  1236â†’                    name=entry.name,
  1237â†’                    description=entry.description,
  1238â†’                    version=entry.version,
  1239â†’                    category=entry.category,
  1240â†’                    icon=entry.icon,
  1241â†’                    color=entry.color,
  1242â†’                    triggers=entry.triggers,
  1243â†’                    pricing=SkillPricing(
  1244â†’                        type=entry.pricing.type,
  1245â†’                        trial_messages=entry.pricing.trial_messages,
  1246â†’                        credits_per_use=entry.pricing.credits_per_use,
  1247â†’                    ),
  1248â†’                    features=[
  1249â†’                        SkillFeature(
  1250â†’                            name=f.name,
  1251â†’                            description=f.description,
  1252â†’                            icon=f.icon,
  1253â†’                            tier=f.tier,
  1254â†’                        )
  1255â†’                        for f in entry.features
  1256â†’                    ],
  1257â†’                    showcase=SkillShowcase(
  1258â†’                        tagline=entry.showcase.tagline,
  1259â†’                        highlights=entry.showcase.highlights,
  1260â†’                        preview_image=entry.showcase.preview_image,
  1261â†’                        demo_prompts=entry.showcase.demo_prompts,
  1262â†’                    ),
  1263â†’                    subscription=SkillSubscription(
  1264â†’                        auto_subscribe=entry.subscription.auto_subscribe,
  1265â†’                        can_unsubscribe=entry.subscription.can_unsubscribe,
  1266â†’                        push_default=entry.subscription.push_default,
  1267â†’                        min_subscription_days=entry.subscription.min_subscription_days,
  1268â†’                    ),
  1269â†’                )
  1270â†’                for entry in catalog.values()
  1271â†’            ]
  1272â†’    except Exception as e:
  1273â†’        logger.warning(f"Failed to load skill catalog from database: {e}")
  1274â†’
  1275â†’    # 2. Fallback åˆ° SKILL.md
  1276â†’    return get_all_skill_metadata()
  1277â†’
  1278â†’
  1279â†’async def get_skills_by_category_async(category: str) -> List[SkillMetadata]:
  1280â†’    """
  1281â†’    å¼‚æ­¥æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1282â†’
  1283â†’    Args:
  1284â†’        category: core | default | professional
  1285â†’
  1286â†’    Returns:
  1287â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1288â†’    """
  1289â†’    all_skills = await get_all_skill_metadata_async()
  1290â†’    return [s for s in all_skills if s.category == category]
  1291â†’
  1292â†’
  1293â†’async def get_featured_skills_async() -> List[SkillMetadata]:
  1294â†’    """
  1295â†’    å¼‚æ­¥è·å–ç²¾é€‰ Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1296â†’
  1297â†’    Returns:
  1298â†’        ç²¾é€‰ Skill åˆ—è¡¨ï¼ŒæŒ‰ featured_position æ’åº
  1299â†’    """
  1300â†’    try:
  1301â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1302â†’
  1303â†’        featured_entries = await SkillCatalogRepository.get_featured()
  1304â†’        return [
  1305â†’            SkillMetadata(
  1306â†’                id=entry.skill_id,
  1307â†’                name=entry.name,
  1308â†’                description=entry.description,
  1309â†’                version=entry.version,
  1310â†’                category=entry.category,
  1311â†’                icon=entry.icon,
  1312â†’                color=entry.color,
  1313â†’                triggers=entry.triggers,
  1314â†’                pricing=SkillPricing(
  1315â†’                    type=entry.pricing.type,
  1316â†’                    trial_messages=entry.pricing.trial_messages,
  1317â†’                    credits_per_use=entry.pricing.credits_per_use,
  1318â†’                ),
  1319â†’                features=[
  1320â†’                    SkillFeature(
  1321â†’                        name=f.name,
  1322â†’                        description=f.description,
  1323â†’                        icon=f.icon,
  1324â†’                        tier=f.tier,
  1325â†’                    )
  1326â†’                    for f in entry.features
  1327â†’                ],
  1328â†’                showcase=SkillShowcase(
  1329â†’                    tagline=entry.showcase.tagline,
  1330â†’                    highlights=entry.showcase.highlights,
  1331â†’                    preview_image=entry.showcase.preview_image,
  1332â†’                    demo_prompts=entry.showcase.demo_prompts,
  1333â†’                ),
  1334â†’                subscription=SkillSubscription(
  1335â†’                    auto_subscribe=entry.subscription.auto_subscribe,
  1336â†’                    can_unsubscribe=entry.subscription.can_unsubscribe,
  1337â†’                    push_default=entry.subscription.push_default,
  1338â†’                    min_subscription_days=entry.subscription.min_subscription_days,
  1339â†’                ),
  1340â†’            )
  1341â†’            for entry in featured_entries
  1342â†’        ]
  1343â†’    except Exception as e:
  1344â†’        logger.warning(f"Failed to load featured skills from database: {e}")
  1345â†’        # Fallback: è¿”å› professional åˆ†ç±»çš„å‰ 3 ä¸ª
  1346â†’        all_skills = get_all_skill_metadata()
  1347â†’        professional = [s for s in all_skills if s.category == "professional"]
  1348â†’        return professional[:3]
  1349â†’
  1350â†’
  1351â†’async def get_skill_categories_summary_async() -> Dict[str, Dict]:
  1352â†’    """
  1353â†’    å¼‚æ­¥è·å–åˆ†ç±»ç»Ÿè®¡ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1354â†’
  1355â†’    Returns:
  1356â†’        åˆ†ç±»ç»Ÿè®¡å­—å…¸
  1357â†’    """
  1358â†’    try:
  1359â†’        from stores.skill_catalog_repo import get_skill_categories_summary
  1360â†’        return await get_skill_categories_summary()
  1361â†’    except Exception as e:
  1362â†’        logger.warning(f"Failed to get category summary from database: {e}")
  1363â†’        # Fallback
  1364â†’        all_skills = get_all_skill_metadata()
  1365â†’        return {
  1366â†’            "core": {
  1367â†’                "name": "æ ¸å¿ƒèƒ½åŠ›",
  1368â†’                "description": "å§‹ç»ˆæ¿€æ´»çš„åŸºç¡€èƒ½åŠ›",
  1369â†’                "count": len([s for s in all_skills if s.category == "core"])
  1370â†’            },
  1371â†’            "default": {
  1372â†’                "name": "åŸºç¡€åŠŸèƒ½",
  1373â†’                "description": "é»˜è®¤æ¿€æ´»ï¼Œå…è´¹ä½¿ç”¨",
  1374â†’                "count": len([s for s in all_skills if s.category == "default"])
  1375â†’            },
  1376â†’            "professional": {
  1377â†’                "name": "ä¸“ä¸šæŠ€èƒ½",
  1378â†’                "description": "éœ€è¦è®¢é˜…çš„é«˜çº§åŠŸèƒ½",
  1379â†’                "count": len([s for s in all_skills if s.category == "professional"])
  1380â†’            },
  1381â†’        }
  1382â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
