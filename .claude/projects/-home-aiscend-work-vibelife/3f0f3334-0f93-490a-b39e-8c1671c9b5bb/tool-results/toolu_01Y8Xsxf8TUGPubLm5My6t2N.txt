The file /home/aiscend/work/vibelife/apps/api/services/agent/core.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   335→        system_prompt = await self._build_system_prompt(message, context)
   336→
   337→        messages = [LLMMessage(role="system", content=system_prompt)]
   338→
   339→        if context.history:
   340→            # 过滤并验证历史消息，确保 tool 消息配对完整
   341→            filtered_history = self._filter_valid_history(context.history[-10:])
   342→            for msg in filtered_history:
   343→                messages.append(LLMMessage(
   344→                    role=msg.get("role", "user"),
   345→                    content=msg.get("content", ""),
   346→                    tool_call_id=msg.get("tool_call_id"),
   347→                    tool_calls=msg.get("tool_calls")
   348→                ))
   349→
   350→        messages.append(LLMMessage(role="user", content=message))
   351→        return messages
   352→