   310→                yield AgentEvent(type="error", data={"error": str(e)})
   311→                return
   312→
   313→        self.state = AgentState.COMPLETED
   314→        yield AgentEvent(type="done", data={"max_iterations_reached": True})
   315→
   316→    async def _route_scenario(self, skill_id: str, message: str) -> Optional[str]:
   317→        """场景路由 - 根据消息匹配最佳场景"""
   318→        try:
   319→            matches = await self.knowledge_repo.route_scenario(skill_id, message)
   320→            if matches:
   321→                return matches[0].scenario_id
   322→        except Exception as e:
   323→            logger.warning(f"Scenario routing failed: {e}")
   324→
   325→        # 回退到默认场景
   326→        skill = load_skill(skill_id)
   327→        return skill.default_scenario if skill else "basic_reading"
   328→
   329→    async def _build_initial_messages(
   330→        self,
   331→        message: str,
   332→        context: AgentContext
   333→    ) -> List[LLMMessage]:
   334→        """构建初始消息列表"""
   335→        system_prompt = await self._build_system_prompt(message, context)
   336→
   337→        messages = [LLMMessage(role="system", content=system_prompt)]
   338→
   339→        if context.history:
   340→            # 过滤并验证历史消息，确保 tool 消息配对完整
   341→            filtered_history = self._filter_valid_history(context.history[-10:])
   342→            for msg in filtered_history:
   343→                messages.append(LLMMessage(
   344→                    role=msg.get("role", "user"),
   345→                    content=msg.get("content", ""),
   346→                    tool_call_id=msg.get("tool_call_id"),
   347→                    tool_calls=msg.get("tool_calls")
   348→                ))
   349→
   350→        messages.append(LLMMessage(role="user", content=message))
   351→        return messages
   352→
   353→    async def _build_system_prompt(self, message: str, context: AgentContext) -> str:
   354→        """构建 System Prompt"""
   355→        parts = []
   356→
   357→        # 基础 prompt
   358→        if self._active_skill:
   359→            # 传递完整 profile，让 skill_loader 自动处理所有字段

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
