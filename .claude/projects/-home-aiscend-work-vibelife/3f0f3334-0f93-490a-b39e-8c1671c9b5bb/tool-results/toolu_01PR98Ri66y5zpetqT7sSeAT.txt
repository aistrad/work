     1→# VibeLife 数据架构图
     2→
     3→## 1. 数据库 ER 图
     4→
     5→```
     6→┌─────────────────────────────────────────────────────────────────────────────────┐
     7→│                              DATABASE SCHEMA                                      │
     8→└─────────────────────────────────────────────────────────────────────────────────┘
     9→
    10→┌──────────────────────┐       ┌───────────────────────────┐
    11→│     vibe_users       │       │    unified_profiles       │
    12→├──────────────────────┤       ├───────────────────────────┤
    13→│ id            UUID PK│◄──────│ user_id      UUID FK,UK   │
    14→│ email         VARCHAR│       │ profile      JSONB        │
    15→│ phone         VARCHAR│       │ ├─ birth_info             │
    16→│ nickname      VARCHAR│       │ │  ├─ date                │
    17→│ avatar_url    VARCHAR│       │ │  ├─ time                │
    18→│ subscription  VARCHAR│       │ │  └─ place               │
    19→│ created_at    TIMESTAMP      │ ├─ bazi_data              │
    20→│ updated_at    TIMESTAMP      │ ├─ zodiac_data            │
    21→└──────────────────────┘       │ ├─ life_context           │
    22→         │                     │ ├─ preferences            │
    23→         │                     │ │  ├─ timezone            │
    24→         │                     │ │  ├─ voice_mode          │
    25→         │                     │ │  └─ enable_fortune_*    │
    26→         │                     │ └─ goal_tracking          │
    27→         │                     │    ├─ last_checkin        │
    28→         │                     │    ├─ streak_days         │
    29→         │                     │    └─ reminder_time       │
    30→         │                     │ created_at    TIMESTAMP   │
    31→         │                     │ updated_at    TIMESTAMP   │
    32→         │                     └───────────────────────────┘
    33→         │
    34→         │  1:N
    35→         ▼
    36→┌──────────────────────────────┐       ┌───────────────────────────┐
    37→│      user_data_store         │       │      user_reminders       │
    38→├──────────────────────────────┤       ├───────────────────────────┤
    39→│ id            UUID PK        │       │ id              UUID PK   │
    40→│ user_id       UUID FK        │◄──────│ user_id         UUID FK   │
    41→│ data_type     VARCHAR        │       │ reminder_type   VARCHAR   │
    42→│ ├─ goals                     │       │ ├─ goal_checkin           │
    43→│ ├─ tasks                     │       │ ├─ daily_plan             │
    44→│ ├─ checkins                  │       │ ├─ milestone              │
    45→│ ├─ plans                     │       │ └─ custom                 │
    46→│ └─ reflections               │       │ title           VARCHAR   │
    47→│ data_path     VARCHAR UK     │       │ description     TEXT      │
    48→│ content       JSONB          │       │ schedule        VARCHAR   │
    49→│ version       INTEGER        │       │ schedule_type   VARCHAR   │
    50→│ created_at    TIMESTAMP      │       │ ├─ once                   │
    51→│ updated_at    TIMESTAMP      │       │ ├─ daily                  │
    52→└──────────────────────────────┘       │ ├─ weekly                 │
    53→                                       │ └─ cron                   │
    54→                                       │ next_trigger_at TIMESTAMP │
    55→                                       │ last_triggered  TIMESTAMP │
    56→                                       │ status          VARCHAR   │
    57→                                       │ metadata        JSONB     │
    58→                                       │ created_at      TIMESTAMP │
    59→                                       └───────────────────────────┘
    60→
    61→┌─────────────────────────────────────────────────────────────────────────────────┐
    62→│ 关系说明:                                                                        │
    63→│ • vibe_users 1:1 unified_profiles (用户基础信息 vs 扩展 Profile)                 │
    64→│ • vibe_users 1:N user_data_store (一个用户可有多条数据记录)                       │
    65→│ • vibe_users 1:N user_reminders (一个用户可有多个提醒)                            │
    66→│ • user_data_store.data_path 作为虚拟文件路径，支持层级结构                        │
    67→└─────────────────────────────────────────────────────────────────────────────────┘
    68→```
    69→
    70→---
    71→
    72→## 2. 数据分层架构
    73→
    74→```
    75→┌─────────────────────────────────────────────────────────────────────────────────┐
    76→│                            DATA LAYER ARCHITECTURE                               │
    77→└─────────────────────────────────────────────────────────────────────────────────┘
    78→
    79→┌─────────────────────────────────────────────────────────────────────────────────┐
    80→│                              用户数据分层                                         │
    81→├─────────────────────────────────────────────────────────────────────────────────┤
    82→│                                                                                  │
    83→│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐                │
    84→│  │   身份层        │   │   画像层         │   │   行为层         │                │
    85→│  │  (Identity)     │   │  (Profile)      │   │  (Activity)     │                │
    86→│  ├─────────────────┤   ├─────────────────┤   ├─────────────────┤                │
    87→│  │ • 账号信息      │   │ • 出生信息      │   │ • 目标数据      │                │
    88→│  │ • 认证信息      │   │ • 命理数据      │   │ • 计划数据      │                │
    89→│  │ • 订阅状态      │   │ • 偏好设置      │   │ • 打卡记录      │                │
    90→│  │                 │   │ • 生活上下文    │   │ • 对话历史      │                │
    91→│  └────────┬────────┘   └────────┬────────┘   └────────┬────────┘                │
    92→│           │                     │                     │                          │
    93→│           ▼                     ▼                     ▼                          │
    94→│  ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐                │
    95→│  │   vibe_users    │   │unified_profiles │   │ user_data_store │                │
    96→│  └─────────────────┘   └─────────────────┘   └─────────────────┘                │
    97→│                                                                                  │
    98→└─────────────────────────────────────────────────────────────────────────────────┘
    99→
   100→┌─────────────────────────────────────────────────────────────────────────────────┐
   101→│                           user_data_store 虚拟文件系统                           │
   102→├─────────────────────────────────────────────────────────────────────────────────┤
   103→│                                                                                  │
   104→│   /users/{user_id}/                                                              │
   105→│   │                                                                              │
   106→│   ├── goals/                          # 目标数据                                 │
   107→│   │   ├── 2026/                                                                  │
   108→│   │   │   ├── year                    # data_path: "goals/2026/year"             │
   109→│   │   │   ├── q1                      # data_path: "goals/2026/q1"               │
   110→│   │   │   ├── q2                                                                 │
   111→│   │   │   └── months/                                                            │
   112→│   │   │       ├── 01                  # data_path: "goals/2026/months/01"        │
   113→│   │   │       └── 02                                                             │
   114→│   │   └── 2025/                                                                  │
   115→│   │                                                                              │
   116→│   ├── plans/                          # 计划数据                                 │
   117→│   │   └── daily/                                                                 │
   118→│   │       ├── 2026-01-18              # data_path: "plans/daily/2026-01-18"      │
   119→│   │       └── 2026-01-19                                                         │
   120→│   │                                                                              │
   121→│   ├── checkins/                       # 打卡数据                                 │
   122→│   │   ├── 2026-01-18                  # data_path: "checkins/2026-01-18"         │
   123→│   │   └── 2026-01-19                                                             │
   124→│   │                                                                              │
   125→│   └── reflections/                    # 复盘数据                                 │
   126→│       ├── week_01                     # data_path: "reflections/week_01"         │
   127→│       └── week_02                                                                │
   128→│                                                                                  │
   129→└─────────────────────────────────────────────────────────────────────────────────┘
   130→```
   131→
   132→---
   133→
   134→## 3. Profile 数据结构
   135→
   136→```
   137→┌─────────────────────────────────────────────────────────────────────────────────┐
   138→│                         unified_profiles.profile JSONB 结构                       │
   139→└─────────────────────────────────────────────────────────────────────────────────┘
   140→
   141→{
   142→  "birth_info": {                      // 出生信息（命理计算基础）
   143→    "date": "1990-05-15",
   144→    "time": "10:30",
   145→    "place": "北京",
   146→    "timezone": "Asia/Shanghai",
   147→    "solar_date": "1990-05-15",
   148→    "lunar_date": "庚午年四月廿一"
   149→  },
   150→
   151→  "bazi_data": {                       // 八字命理数据（计算缓存）
   152→    "pillars": {
   153→      "year": {"stem": "庚", "branch": "午"},
   154→      "month": {"stem": "辛", "branch": "巳"},
   155→      "day": {"stem": "甲", "branch": "子"},
   156→      "hour": {"stem": "己", "branch": "巳"}
   157→    },
   158→    "day_master": "甲木",
   159→    "day_master_strength": "身弱",
   160→    "useful_god": "水",
   161→    "dayun": [...],                    // 大运列表
   162→    "calculated_at": "2026-01-18T..."
   163→  },
   164→
   165→  "zodiac_data": {                     // 星座数据（计算缓存）
   166→    "sun_sign": "金牛座",
   167→    "moon_sign": "双子座",
   168→    "rising_sign": "狮子座",
   169→    "chart": {...},                    // 完整星盘
   170→    "calculated_at": "2026-01-18T..."
   171→  },
   172→
   173→  "life_context": {                    // 生活上下文（对话提取）
   174→    "current_focus": "职业发展",
   175→    "relationships": {
   176→      "status": "已婚",
   177→      "partner_birth": "1992-03-20"
   178→    },
   179→    "career": {
   180→      "industry": "互联网",
   181→      "role": "产品经理",
   182→      "concerns": ["晋升", "转型"]
   183→    },
   184→    "health": {...},
   185→    "updated_at": "2026-01-18T..."
   186→  },
   187→
   188→  "preferences": {                     // 用户偏好
   189→    "timezone": "Asia/Shanghai",
   190→    "voice_mode": "温暖",              // 语气模式
   191→    "enable_fortune_insights": true,   // 命理整合开关
   192→    "notification_time": "08:00",
   193→    "language": "zh-CN"
   194→  },
   195→
   196→  "goal_tracking": {                   // 目标追踪状态
   197→    "enabled": true,
   198→    "last_checkin": "2026-01-17",
   199→    "streak_days": 5,
   200→    "reminder_time": "08:00",
   201→    "total_goals": 3,
   202→    "completed_goals": 1
   203→  }
   204→}
   205→```
   206→
   207→---
   208→
   209→## 4. 数据处理流程图
   210→
   211→### 4.1 目标设定流程
   212→
   213→```
   214→┌─────────────────────────────────────────────────────────────────────────────────┐
   215→│                            目标设定流程 (Goal Setting Flow)                       │
   216→└─────────────────────────────────────────────────────────────────────────────────┘
   217→
   218→  用户                    前端                      后端 API                   数据库
   219→   │                       │                          │                         │
   220→   │  "设定2026年目标"     │                          │                         │
   221→   │──────────────────────►│                          │                         │
   222→   │                       │                          │                         │
   223→   │                       │   POST /chat             │                         │
   224→   │                       │──────────────────────────►│                         │
   225→   │                       │                          │                         │
   226→   │                       │                          │  触发 goal_tracking     │
   227→   │                       │                          │  scenario               │
   228→   │                       │                          │─────────┐               │
   229→   │                       │                          │         │               │
   230→   │                       │                          │◄────────┘               │
   231→   │                       │                          │                         │
   232→   │                       │   SSE: 收集目标信息      │                         │
   233→   │◄──────────────────────│◄─────────────────────────│                         │
   234→   │                       │                          │                         │
   235→   │  输入目标详情         │                          │                         │
   236→   │──────────────────────►│──────────────────────────►│                         │
   237→   │                       │                          │                         │
   238→   │                       │                          │  LLM 分解目标           │
   239→   │                       │                          │  调用 write_user_data   │
   240→   │                       │                          │─────────────────────────►│
   241→   │                       │                          │                         │
   242→   │                       │                          │  INSERT INTO            │
   243→   │                       │                          │  user_data_store        │
   244→   │                       │                          │  (goals/2026/year)      │
   245→   │                       │                          │◄─────────────────────────│
   246→   │                       │                          │                         │
   247→   │                       │                          │  调用 schedule_reminder │
   248→   │                       │                          │─────────────────────────►│
   249→   │                       │                          │                         │
   250→   │                       │                          │  INSERT INTO            │
   251→   │                       │                          │  user_reminders         │
   252→   │                       │                          │◄─────────────────────────│
   253→   │                       │                          │                         │
   254→   │                       │   SSE: show_goal_tree    │                         │
   255→   │◄──────────────────────│◄─────────────────────────│                         │
   256→   │                       │                          │                         │
   257→   │  查看目标树卡片       │                          │                         │
   258→   │◄──────────────────────│                          │                         │
   259→   │                       │                          │                         │
   260→```
   261→
   262→### 4.2 每日打卡流程
   263→
   264→```
   265→┌─────────────────────────────────────────────────────────────────────────────────┐
   266→│                            每日打卡流程 (Daily Checkin Flow)                      │
   267→└─────────────────────────────────────────────────────────────────────────────────┘
   268→
   269→  推送系统              用户                前端                后端 API          数据库
   270→     │                   │                   │                    │                 │
   271→     │  21:00 触发       │                   │                    │                 │
   272→     │──────────────────►│                   │                    │                 │
   273→     │  "该打卡了"       │                   │                    │                 │
   274→     │                   │                   │                    │                 │
   275→     │                   │  点击通知         │                    │                 │
   276→     │                   │─────────────────►│                    │                 │
   277→     │                   │                   │                    │                 │
   278→     │                   │                   │  POST /chat        │                 │
   279→     │                   │                   │  "打卡"            │                 │
   280→     │                   │                   │───────────────────►│                 │
   281→     │                   │                   │                    │                 │
   282→     │                   │                   │                    │ read_user_data  │
   283→     │                   │                   │                    │ (plans/daily/*) │
   284→     │                   │                   │                    │────────────────►│
   285→     │                   │                   │                    │◄────────────────│
   286→     │                   │                   │                    │                 │
   287→     │                   │                   │  SSE: checkin_form │                 │
   288→     │                   │◄──────────────────│◄───────────────────│                 │
   289→     │                   │                   │                    │                 │
   290→     │                   │  勾选完成项       │                    │                 │
   291→     │                   │  填写反思         │                    │                 │
   292→     │                   │─────────────────►│                    │                 │
   293→     │                   │                   │                    │                 │
   294→     │                   │                   │  提交打卡          │                 │
   295→     │                   │                   │───────────────────►│                 │
   296→     │                   │                   │                    │                 │
   297→     │                   │                   │                    │ write_user_data │
   298→     │                   │                   │                    │ (checkins/*)    │
   299→     │                   │                   │                    │────────────────►│
   300→     │                   │                   │                    │◄────────────────│
   301→     │                   │                   │                    │                 │
   302→     │                   │                   │                    │ 更新 profile    │
   303→     │                   │                   │                    │ streak_days++   │
   304→     │                   │                   │                    │────────────────►│
   305→     │                   │                   │                    │◄────────────────│
   306→     │                   │                   │                    │                 │
   307→     │                   │                   │  SSE: 打卡成功     │                 │
   308→     │                   │◄──────────────────│◄───────────────────│                 │
   309→     │                   │  "连续5天打卡!"   │                    │                 │
   310→     │                   │                   │                    │                 │
   311→```
   312→
   313→### 4.3 数据读写流程
   314→
   315→```
   316→┌─────────────────────────────────────────────────────────────────────────────────┐
   317→│                        数据读写流程 (Data CRUD Flow)                              │
   318→└─────────────────────────────────────────────────────────────────────────────────┘
   319→
   320→                              ┌─────────────────────┐
   321→                              │      Tool Call      │
   322→                              │  (from LLM Agent)   │
   323→                              └──────────┬──────────┘
   324→                                         │
   325→                    ┌────────────────────┼────────────────────┐
   326→                    │                    │                    │
   327→                    ▼                    ▼                    ▼
   328→        ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐
   329→        │  read_user_data   │ │  write_user_data  │ │  query_user_data  │
   330→        │    (handlers.py)  │ │    (handlers.py)  │ │    (handlers.py)  │
   331→        └─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘
   332→                  │                     │                     │
   333→                  ▼                     ▼                     ▼
   334→        ┌─────────────────────────────────────────────────────────────┐
   335→        │                    UserDataService                           │
   336→        │                    (user_data.py)                            │
   337→        ├─────────────────────────────────────────────────────────────┤
   338→        │  • read(user_id, path) → UserData                           │
   339→        │  • write(user_id, path, content) → UserData                 │
   340→        │  • query(user_id, filters) → List[UserData]                 │
   341→        │  • delete(user_id, path) → bool                             │
   342→        │  • list_paths(user_id, prefix) → List[str]                  │
   343→        └─────────────────────────────────────────────────────────────┘
   344→                                         │
   345→                                         ▼
   346→        ┌─────────────────────────────────────────────────────────────┐
   347→        │                    PostgreSQL                                │
   348→        ├─────────────────────────────────────────────────────────────┤
   349→        │                                                              │
   350→        │   ┌─────────────────────────────────────────────────────┐   │
   351→        │   │              user_data_store                         │   │
   352→        │   ├─────────────────────────────────────────────────────┤   │
   353→        │   │ id | user_id | data_type | data_path | content | v  │   │
   354→        │   │────┼─────────┼───────────┼───────────┼─────────┼────│   │
   355→        │   │ .. │ abc-123 │ goals     │ goals/... │ {...}   │ 1  │   │
   356→        │   │ .. │ abc-123 │ plans     │ plans/... │ {...}   │ 2  │   │
   357→        │   │ .. │ abc-123 │ checkins  │ check/... │ {...}   │ 1  │   │
   358→        │   └─────────────────────────────────────────────────────┘   │
   359→        │                                                              │
   360→        │   索引: (user_id, data_path) UNIQUE                          │
   361→        │   索引: (user_id, data_type)                                 │
   362→        │   索引: content GIN (JSONB 查询)                             │
   363→        │                                                              │
   364→        └─────────────────────────────────────────────────────────────┘
   365→```
   366→
   367→---
   368→
   369→## 5. 提醒系统架构
   370→
   371→```
   372→┌─────────────────────────────────────────────────────────────────────────────────┐
   373→│                         提醒系统架构 (Reminder System)                           │
   374→└─────────────────────────────────────────────────────────────────────────────────┘
   375→
   376→┌─────────────────────────────────────────────────────────────────────────────────┐
   377→│                                                                                  │
   378→│   ┌─────────────┐     ┌─────────────────┐     ┌─────────────────────────────┐   │
   379→│   │   Cron Job  │────►│ ProactiveEngine │────►│     TriggerDetector         │   │
   380→│   │ (每小时跑)  │     │   (engine.py)   │     │   (trigger_detector.py)     │   │
   381→│   └─────────────┘     └────────┬────────┘     └──────────────┬──────────────┘   │
   382→│                                │                              │                  │
   383→│                                │                              │ 检查触发条件     │
   384→│                                │                              ▼                  │
   385→│                                │              ┌─────────────────────────────┐   │
   386→│                                │              │ 系统提醒 (reminders.yaml)   │   │
   387→│                                │              │ • daily_plan (08:00)        │   │
   388→│                                │              │ • daily_checkin (21:00)     │   │
   389→│                                │              │ • weekly_review (周日)      │   │
   390→│                                │              │ • milestone_reminder        │   │
   391→│                                │              │ • streak_celebration        │   │
   392→│                                │              └─────────────────────────────┘   │
   393→│                                │                              │                  │
   394→│                                │                              │                  │
   395→│                                ▼                              ▼                  │
   396→│                    ┌─────────────────────┐    ┌─────────────────────────────┐   │
   397→│                    │  ContentGenerator   │    │ 用户提醒 (user_reminders)   │   │
   398→│                    │(content_generator.py│    │ • 用户自定义提醒            │   │
   399→│                    └──────────┬──────────┘    │ • 通过 schedule_reminder    │   │
   400→│                               │               │   工具创建                   │   │
   401→│                               │               └──────────────┬──────────────┘   │
   402→│                               │                              │                  │
   403→│                               ▼                              ▼                  │
   404→│                    ┌─────────────────────────────────────────────────────────┐  │
   405→│                    │              NotificationService                         │  │
   406→│                    │            (notification.py)                             │  │
   407→│                    ├─────────────────────────────────────────────────────────┤  │
   408→│                    │  • 保存到 notifications 表                               │  │
   409→│                    │  • 推送到 APNs / FCM (移动端)                            │  │
   410→│                    │  • WebSocket 实时推送 (Web端)                            │  │
   411→│                    └─────────────────────────────────────────────────────────┘  │
   412→│                                                                                  │
   413→└─────────────────────────────────────────────────────────────────────────────────┘
   414→
   415→┌─────────────────────────────────────────────────────────────────────────────────┐
   416→│  用户提醒调度流程                                                                │
   417→├─────────────────────────────────────────────────────────────────────────────────┤
   418→│                                                                                  │
   419→│   用户说: "每天早上8点提醒我看目标"                                              │
   420→│                    │                                                             │
   421→│                    ▼                                                             │
   422→│   ┌────────────────────────────────────────┐                                    │
   423→│   │  LLM 调用 schedule_reminder            │                                    │
   424→│   │  title: "查看今日目标"                  │                                    │
   425→│   │  schedule: "08:00"                      │                                    │
   426→│   │  schedule_type: "daily"                 │                                    │
   427→│   └────────────────────────────────────────┘                                    │
   428→│                    │                                                             │
   429→│                    ▼                                                             │
   430→│   ┌────────────────────────────────────────┐                                    │
   431→│   │  ReminderService.create()              │                                    │
   432→│   │  • 计算 next_trigger_at (UTC)          │                                    │
   433→│   │  • 写入 user_reminders 表              │                                    │
   434→│   └────────────────────────────────────────┘                                    │
   435→│                    │                                                             │
   436→│                    ▼                                                             │
   437→│   ┌────────────────────────────────────────┐                                    │
   438→│   │  ProactiveWorker 扫描                   │                                    │
   439→│   │  • WHERE next_trigger_at <= NOW()      │                                    │
   440→│   │  • 触发提醒                             │                                    │
   441→│   │  • 更新 next_trigger_at                │                                    │
   442→│   └────────────────────────────────────────┘                                    │
   443→│                                                                                  │
   444→└─────────────────────────────────────────────────────────────────────────────────┘
   445→```
   446→
   447→---
   448→
   449→## 6. 整体数据流向
   450→
   451→```
   452→┌─────────────────────────────────────────────────────────────────────────────────┐
   453→│                          整体数据流向 (Overall Data Flow)                        │
   454→└─────────────────────────────────────────────────────────────────────────────────┘
   455→
   456→                                    ┌───────────────┐
   457→                                    │     用户      │
   458→                                    └───────┬───────┘
   459→                                            │
   460→                    ┌───────────────────────┼───────────────────────┐
   461→                    │                       │                       │
   462→                    ▼                       ▼                       ▼
   463→            ┌───────────────┐       ┌───────────────┐       ┌───────────────┐
   464→            │    对话输入    │       │   表单提交    │       │   推送响应    │
   465→            └───────┬───────┘       └───────┬───────┘       └───────┬───────┘
   466→                    │                       │                       │
   467→                    └───────────────────────┼───────────────────────┘
   468→                                            │
   469→                                            ▼
   470→                              ┌─────────────────────────┐
   471→                              │        API Gateway      │
   472→                              │   /api/v1/chat          │
   473→                              │   /api/v1/tools/*       │
   474→                              └───────────┬─────────────┘
   475→                                          │
   476→                                          ▼
   477→                              ┌─────────────────────────┐
   478→                              │     Agent Core          │
   479→                              │  (Skill Router + LLM)   │
   480→                              └───────────┬─────────────┘
   481→                                          │
   482→                    ┌─────────────────────┼─────────────────────┐
   483→                    │                     │                     │
   484→                    ▼                     ▼                     ▼
   485→          ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────┐
   486→          │   Core Skill    │   │   Bazi Skill    │   │  Zodiac Skill   │
   487→          │   Tools         │   │   Tools         │   │   Tools         │
   488→          └────────┬────────┘   └────────┬────────┘   └────────┬────────┘
   489→                   │                     │                     │
   490→                   ▼                     ▼                     ▼
   491→          ┌─────────────────────────────────────────────────────────────┐
   492→          │                      Tool Handlers                           │
   493→          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
   494→          │  │ user_data   │ │  reminder   │ │  display    │            │
   495→          │  │ handlers    │ │  handlers   │ │  handlers   │            │
   496→          │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘            │
   497→          └─────────┼───────────────┼───────────────┼───────────────────┘
   498→                    │               │               │
   499→                    ▼               ▼               ▼
   500→          ┌─────────────────────────────────────────────────────────────┐
   501→          │                      Services Layer                          │
   502→          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
   503→          │  │UserDataSvc  │ │ReminderSvc  │ │ ProfileSvc  │            │
   504→          │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘            │
   505→          └─────────┼───────────────┼───────────────┼───────────────────┘
   506→                    │               │               │
   507→                    └───────────────┼───────────────┘
   508→                                    │
   509→                                    ▼
   510→          ┌─────────────────────────────────────────────────────────────┐
   511→          │                      PostgreSQL                              │
   512→          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
   513→          │  │ vibe_users  │ │ unified_    │ │ user_data_  │            │
   514→          │  │             │ │ profiles    │ │ store       │            │
   515→          │  └─────────────┘ └─────────────┘ └─────────────┘            │
   516→          │                                                              │
   517→          │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            │
   518→          │  │ user_       │ │ knowledge_  │ │ cases       │            │
   519→          │  │ reminders   │ │ chunks      │ │             │            │
   520→          │  └─────────────┘ └─────────────┘ └─────────────┘            │
   521→          └─────────────────────────────────────────────────────────────┘
   522→```
   523→
   524→---
   525→
   526→## 7. 关键设计决策
   527→
   528→| 决策 | 选择 | 原因 |
   529→|------|------|------|
   530→| Profile 存储 | JSONB 单字段 | 灵活扩展，无需频繁 DDL |
   531→| 用户数据存储 | 虚拟文件路径 | 支持层级结构，易于理解和查询 |
   532→| 提醒调度 | cron + 事件驱动 | 兼顾定时和即时触发 |
   533→| 版本控制 | 乐观锁 (version 字段) | 防止并发写入冲突 |
   534→| 数据隔离 | user_id 外键 + 索引 | 确保用户只能访问自己的数据 |
   535→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
