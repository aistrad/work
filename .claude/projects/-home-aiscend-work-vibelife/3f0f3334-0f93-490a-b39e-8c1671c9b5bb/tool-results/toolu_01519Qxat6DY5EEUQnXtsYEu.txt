     1→"""
     2→Unified Profile Repository - 统一 Profile 数据访问层
     3→
     4→基于 unified_profiles 表，提供统一的 Profile 访问接口。
     5→使用 jsonb_set() 进行局部更新，避免重写整个 profile。
     6→"""
     7→import json
     8→import logging
     9→from typing import Optional, Dict, Any, List
    10→from uuid import UUID
    11→
    12→from .db import get_connection, fetch, fetchrow, fetchval, execute
    13→
    14→logger = logging.getLogger(__name__)
    15→
    16→
    17→def deep_merge(base: Dict, update: Dict) -> Dict:
    18→    """深度合并两个字典"""
    19→    result = base.copy()
    20→    for key, value in update.items():
    21→        if key in result and isinstance(result[key], dict) and isinstance(value, dict):
    22→            result[key] = deep_merge(result[key], value)
    23→        elif value is not None:
    24→            result[key] = value
    25→    return result
    26→
    27→
    28→class UnifiedProfileRepository:
    29→    """统一 Profile 数据访问层"""
    30→
    31→    # ═══════════════════════════════════════════════════════════════════════════
    32→    # 读取操作
    33→    # ═══════════════════════════════════════════════════════════════════════════
    34→
    35→    @staticmethod
    36→    async def get_profile(user_id: UUID) -> Optional[Dict[str, Any]]:
    37→        """获取完整 Profile"""
    38→        row = await fetchrow(
    39→            "SELECT profile FROM unified_profiles WHERE user_id = $1",
    40→            user_id
    41→        )
    42→        if not row:
    43→            return None
    44→
    45→        profile = row["profile"]
    46→        if isinstance(profile, str):
    47→            profile = json.loads(profile)
    48→        return profile
    49→
    50→    @staticmethod
    51→    async def get_birth_info(user_id: UUID) -> Dict[str, Any]:
    52→        """获取出生信息"""
    53→        profile = await UnifiedProfileRepository.get_profile(user_id)
    54→        return profile.get("birth_info", {}) if profile else {}
    55→
    56→    @staticmethod
    57→    async def get_skill_data(user_id: UUID, skill: str) -> Dict[str, Any]:
    58→        """获取 Skill 数据"""
    59→        profile = await UnifiedProfileRepository.get_profile(user_id)
    60→        if profile:
    61→            return profile.get("skill_data", {}).get(skill, {})
    62→        return {}
    63→
    64→    @staticmethod
    65→    async def get_all_skill_data(user_id: UUID) -> Dict[str, Any]:
    66→        """获取所有 Skill 数据"""
    67→        profile = await UnifiedProfileRepository.get_profile(user_id)
    68→        if profile:
    69→            return profile.get("skill_data", {})
    70→        return {}
    71→
    72→    @staticmethod
    73→    async def get_preferences(user_id: UUID) -> Dict[str, Any]:
    74→        """获取用户偏好"""
    75→        profile = await UnifiedProfileRepository.get_profile(user_id)
    76→        if profile:
    77→            return profile.get("preferences", {"voice_mode": "warm", "language": "zh-CN"})
    78→        return {"voice_mode": "warm", "language": "zh-CN"}
    79→
    80→    @staticmethod
    81→    async def get_identity_prism(user_id: UUID) -> Dict[str, Any]:
    82→        """获取 Identity Prism"""
    83→        profile = await UnifiedProfileRepository.get_profile(user_id)
    84→        if profile:
    85→            return profile.get("identity_prism", {})
    86→        return {}
    87→
    88→    @staticmethod
    89→    async def get_life_context(user_id: UUID) -> Dict[str, Any]:
    90→        """获取生活上下文"""
    91→        profile = await UnifiedProfileRepository.get_profile(user_id)
    92→        if profile:
    93→            return profile.get("life_context", {})
    94→        return {}
    95→
    96→    # ═══════════════════════════════════════════════════════════════════════════
    97→    # 写入操作
    98→    # ═══════════════════════════════════════════════════════════════════════════
    99→
   100→    @staticmethod
   101→    async def create_profile(user_id: UUID, initial_profile: Dict[str, Any] = None) -> Dict[str, Any]:
   102→        """创建新的 Profile"""
   103→        profile = initial_profile or {
   104→            "birth_info": {},
   105→            "life_context": {},
   106→            "identity_prism": {},
   107→            "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   108→            "skill_data": {}
   109→        }
   110→
   111→        await execute(
   112→            """INSERT INTO unified_profiles (user_id, profile)
   113→               VALUES ($1, $2::jsonb)
   114→               ON CONFLICT (user_id) DO NOTHING""",
   115→            user_id, json.dumps(profile, ensure_ascii=False, default=str)
   116→        )
   117→
   118→        return profile
   119→
   120→    @staticmethod
   121→    async def update_profile(user_id: UUID, updates: Dict[str, Any]) -> None:
   122→        """
   123→        更新 Profile (全量合并更新)
   124→
   125→        Args:
   126→            user_id: 用户 ID
   127→            updates: 要更新的字段，会与现有数据深度合并
   128→        """
   129→        current = await UnifiedProfileRepository.get_profile(user_id)
   130→
   131→        if current:
   132→            merged = deep_merge(current, updates)
   133→            await execute(
   134→                """UPDATE unified_profiles
   135→                   SET profile = $2::jsonb, updated_at = NOW()
   136→                   WHERE user_id = $1""",
   137→                user_id, json.dumps(merged, ensure_ascii=False, default=str)
   138→            )
   139→        else:
   140→            # 不存在则创建
   141→            default_profile = {
   142→                "birth_info": {},
   143→                "life_context": {},
   144→                "identity_prism": {},
   145→                "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   146→                "skill_data": {}
   147→            }
   148→            merged = deep_merge(default_profile, updates)
   149→            await execute(
   150→                """INSERT INTO unified_profiles (user_id, profile)
   151→                   VALUES ($1, $2::jsonb)""",
   152→                user_id, json.dumps(merged, ensure_ascii=False, default=str)
   153→            )
   154→
   155→        # 失效缓存
   156→        await UnifiedProfileRepository._invalidate_cache(user_id)
   157→
   158→    @staticmethod
   159→    async def update_birth_info(user_id: UUID, birth_info: Dict[str, Any]) -> None:
   160→        """
   161→        更新出生信息 (使用 jsonb_set 局部更新)
   162→
   163→        Args:
   164→            user_id: 用户 ID
   165→            birth_info: 出生信息 {date, time, place, gender, timezone}
   166→        """
   167→        # 确保记录存在
   168→        exists = await fetchval(
   169→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   170→            user_id
   171→        )
   172→
   173→        if exists:
   174→            await execute(
   175→                """UPDATE unified_profiles
   176→                   SET profile = jsonb_set(
   177→                       COALESCE(profile, '{}'::jsonb),
   178→                       '{birth_info}',
   179→                       $2::jsonb
   180→                   ),
   181→                   updated_at = NOW()
   182→                   WHERE user_id = $1""",
   183→                user_id, json.dumps(birth_info, ensure_ascii=False, default=str)
   184→            )
   185→        else:
   186→            await UnifiedProfileRepository.create_profile(user_id, {"birth_info": birth_info})
   187→
   188→        # 失效所有缓存 (birth_info 影响所有 skill)
   189→        await UnifiedProfileRepository._invalidate_cache(user_id)
   190→
   191→    @staticmethod
   192→    async def update_skill_data(user_id: UUID, skill: str, data: Dict[str, Any]) -> None:
   193→        """
   194→        更新 Skill 数据 (使用 jsonb_set 局部更新，避免重写整个 profile)
   195→
   196→        Args:
   197→            user_id: 用户 ID
   198→            skill: Skill 标识 (bazi, zodiac, tarot, career)
   199→            data: Skill 数据 (如命盘数据)
   200→        """
   201→        # 确保记录存在
   202→        exists = await fetchval(
   203→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   204→            user_id
   205→        )
   206→
   207→        if exists:
   208→            # 使用 jsonb_set 进行嵌套路径更新
   209→            # 先确保 skill_data 存在，再设置具体 skill
   210→            await execute(
   211→                """UPDATE unified_profiles
   212→                   SET profile = jsonb_set(
   213→                       jsonb_set(
   214→                           COALESCE(profile, '{}'::jsonb),
   215→                           '{skill_data}',
   216→                           COALESCE(profile -> 'skill_data', '{}'::jsonb)
   217→                       ),
   218→                       ARRAY['skill_data', $2],
   219→                       $3::jsonb
   220→                   ),
   221→                   updated_at = NOW()
   222→                   WHERE user_id = $1""",
   223→                user_id, skill, json.dumps(data, ensure_ascii=False, default=str)
   224→            )
   225→        else:
   226→            await UnifiedProfileRepository.create_profile(user_id, {"skill_data": {skill: data}})
   227→
   228→        # 只失效该 skill 的缓存
   229→        await UnifiedProfileRepository._invalidate_cache(user_id, skill)
   230→
   231→    @staticmethod
   232→    async def update_preferences(user_id: UUID, preferences: Dict[str, Any]) -> None:
   233→        """更新用户偏好 (使用 jsonb_set 局部更新)"""
   234→        exists = await fetchval(
   235→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   236→            user_id
   237→        )
   238→
   239→        if exists:
   240→            # 合并现有偏好
   241→            current_prefs = await UnifiedProfileRepository.get_preferences(user_id)
   242→            merged_prefs = {**current_prefs, **preferences}
   243→
   244→            await execute(
   245→                """UPDATE unified_profiles
   246→                   SET profile = jsonb_set(
   247→                       COALESCE(profile, '{}'::jsonb),
   248→                       '{preferences}',
   249→                       $2::jsonb
   250→                   ),
   251→                   updated_at = NOW()
   252→                   WHERE user_id = $1""",
   253→                user_id, json.dumps(merged_prefs, ensure_ascii=False)
   254→            )
   255→        else:
   256→            await UnifiedProfileRepository.create_profile(user_id, {"preferences": preferences})
   257→
   258→        await UnifiedProfileRepository._invalidate_cache(user_id)
   259→
   260→    @staticmethod
   261→    async def update_identity_prism(user_id: UUID, identity_prism: Dict[str, Any]) -> None:
   262→        """更新 Identity Prism (使用 jsonb_set 局部更新)"""
   263→        exists = await fetchval(
   264→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   265→            user_id
   266→        )
   267→
   268→        if exists:
   269→            await execute(
   270→                """UPDATE unified_profiles
   271→                   SET profile = jsonb_set(
   272→                       COALESCE(profile, '{}'::jsonb),
   273→                       '{identity_prism}',
   274→                       $2::jsonb
   275→                   ),
   276→                   updated_at = NOW()
   277→                   WHERE user_id = $1""",
   278→                user_id, json.dumps(identity_prism, ensure_ascii=False, default=str)
   279→            )
   280→        else:
   281→            await UnifiedProfileRepository.create_profile(user_id, {"identity_prism": identity_prism})
   282→
   283→        await UnifiedProfileRepository._invalidate_cache(user_id)
   284→
   285→    @staticmethod
   286→    async def update_life_context(user_id: UUID, life_context: Dict[str, Any]) -> None:
   287→        """更新生活上下文 (使用 jsonb_set 局部更新)"""
   288→        exists = await fetchval(
   289→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   290→            user_id
   291→        )
   292→
   293→        if exists:
   294→            # 合并现有上下文
   295→            current_ctx = await UnifiedProfileRepository.get_life_context(user_id)
   296→            merged_ctx = deep_merge(current_ctx, life_context)
   297→
   298→            await execute(
   299→                """UPDATE unified_profiles
   300→                   SET profile = jsonb_set(
   301→                       COALESCE(profile, '{}'::jsonb),
   302→                       '{life_context}',
   303→                       $2::jsonb
   304→                   ),
   305→                   updated_at = NOW()
   306→                   WHERE user_id = $1""",
   307→                user_id, json.dumps(merged_ctx, ensure_ascii=False, default=str)
   308→            )
   309→        else:
   310→            await UnifiedProfileRepository.create_profile(user_id, {"life_context": life_context})
   311→
   312→        await UnifiedProfileRepository._invalidate_cache(user_id)
   313→
   314→    @staticmethod
   315→    async def update_extracted(user_id: UUID, extracted: Dict[str, Any]) -> None:
   316→        """
   317→        更新抽取的用户信息 (使用 jsonb_set 局部更新)
   318→
   319→        Args:
   320→            user_id: 用户 ID
   321→            extracted: 抽取的信息 {facts, concerns, goals, pain_points, life_events, patterns, ...}
   322→        """
   323→        exists = await fetchval(
   324→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   325→            user_id
   326→        )
   327→
   328→        if exists:
   329→            await execute(
   330→                """UPDATE unified_profiles
   331→                   SET profile = jsonb_set(
   332→                       COALESCE(profile, '{}'::jsonb),
   333→                       '{extracted}',
   334→                       $2::jsonb
   335→                   ),
   336→                   updated_at = NOW()
   337→                   WHERE user_id = $1""",
   338→                user_id, json.dumps(extracted, ensure_ascii=False, default=str)
   339→            )
   340→        else:
   341→            await UnifiedProfileRepository.create_profile(user_id, {"extracted": extracted})
   342→
   343→        await UnifiedProfileRepository._invalidate_cache(user_id)
   344→
   345→    @staticmethod
   346→    async def get_extracted(user_id: UUID) -> Dict[str, Any]:
   347→        """获取抽取的用户信息"""
   348→        profile = await UnifiedProfileRepository.get_profile(user_id)
   349→        if profile:
   350→            return profile.get("extracted", {})
   351→        return {}
   352→
   353→    # ═══════════════════════════════════════════════════════════════════════════
   354→    # 删除操作
   355→    # ═══════════════════════════════════════════════════════════════════════════
   356→
   357→    @staticmethod
   358→    async def delete_profile(user_id: UUID) -> bool:
   359→        """删除用户 Profile"""
   360→        result = await execute(
   361→            "DELETE FROM unified_profiles WHERE user_id = $1",
   362→            user_id
   363→        )
   364→        await UnifiedProfileRepository._invalidate_cache(user_id)
   365→        return "DELETE 1" in str(result)
   366→
   367→    # ═══════════════════════════════════════════════════════════════════════════
   368→    # 历史归档
   369→    # ═══════════════════════════════════════════════════════════════════════════
   370→
   371→    @staticmethod
   372→    async def archive_profile(user_id: UUID) -> bool:
   373→        """归档当前 Profile 到历史表"""
   374→        profile = await UnifiedProfileRepository.get_profile(user_id)
   375→        if not profile:
   376→            return False
   377→
   378→        await execute(
   379→            """INSERT INTO unified_profiles_history (user_id, profile)
   380→               VALUES ($1, $2::jsonb)""",
   381→            user_id, json.dumps(profile, ensure_ascii=False, default=str)
   382→        )
   383→        return True
   384→
   385→    @staticmethod
   386→    async def get_profile_history(user_id: UUID, limit: int = 10) -> List[Dict[str, Any]]:
   387→        """获取 Profile 历史记录"""
   388→        rows = await fetch(
   389→            """SELECT profile, archived_at FROM unified_profiles_history
   390→               WHERE user_id = $1
   391→               ORDER BY archived_at DESC
   392→               LIMIT $2""",
   393→            user_id, limit
   394→        )
   395→        return [
   396→            {
   397→                "profile": row["profile"] if isinstance(row["profile"], dict) else json.loads(row["profile"]),
   398→                "archived_at": row["archived_at"]
   399→            }
   400→            for row in rows
   401→        ]
   402→
   403→    # ═══════════════════════════════════════════════════════════════════════════
   404→    # 缓存管理
   405→    # ═══════════════════════════════════════════════════════════════════════════
   406→
   407→    @staticmethod
   408→    async def _invalidate_cache(user_id: UUID, skill: str = None) -> None:
   409→        """
   410→        失效缓存
   411→
   412→        Args:
   413→            user_id: 用户 ID
   414→            skill: 如果指定，只失效该 skill 的缓存；否则失效所有缓存
   415→        """
   416→        try:
   417→            from stores.profile_cache import get_profile_cache
   418→            cache = get_profile_cache()
   419→
   420→            if skill:
   421→                # 只失效特定 skill 的缓存
   422→                await cache.invalidate_by_key(f"{user_id}:{skill}")
   423→                # 也失效 all 缓存
   424→                await cache.invalidate_by_key(f"{user_id}:all")
   425→            else:
   426→                # 失效该用户所有缓存
   427→                await cache.invalidate_by_prefix(str(user_id))
   428→
   429→            logger.debug(f"缓存已失效: user_id={user_id}, skill={skill}")
   430→        except Exception as e:
   431→            logger.warning(f"缓存失效失败: {e}")
   432→
   433→
   434→# ═══════════════════════════════════════════════════════════════════════════
   435→# 便捷函数 (兼容旧代码)
   436→# ═══════════════════════════════════════════════════════════════════════════
   437→
   438→async def get_unified_profile(user_id: UUID) -> Optional[Dict[str, Any]]:
   439→    """获取统一 Profile (便捷函数)"""
   440→    return await UnifiedProfileRepository.get_profile(user_id)
   441→
   442→
   443→async def get_unified_profile_with_skill(user_id: UUID, skill: str = None) -> Dict[str, Any]:
   444→    """
   445→    获取 Profile 和 Skill 数据 (兼容 profile_cache 接口)
   446→
   447→    Returns:
   448→        {
   449→            "profile": {...},
   450→            "skill_data": {...}
   451→        }
   452→    """
   453→    profile = await UnifiedProfileRepository.get_profile(user_id)
   454→
   455→    if profile:
   456→        skill_data = profile.get("skill_data", {})
   457→        return {
   458→            "profile": profile,
   459→            "skill_data": skill_data
   460→        }
   461→
   462→    return {"profile": {}, "skill_data": {}}
   463→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
