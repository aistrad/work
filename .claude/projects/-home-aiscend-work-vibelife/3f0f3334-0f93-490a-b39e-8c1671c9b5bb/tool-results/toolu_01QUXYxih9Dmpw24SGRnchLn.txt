     1→"""
     2→Core Skill Tool Handlers - 全局工具执行器
     3→
     4→所有 Skill 共享的工具执行器。
     5→使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
     6→"""
     7→import logging
     8→from datetime import datetime
     9→from typing import Dict, Any, List
    10→
    11→from services.agent.tool_registry import tool_handler, ToolContext
    12→
    13→logger = logging.getLogger(__name__)
    14→
    15→
    16→# ═══════════════════════════════════════════════════════════════════════════
    17→# 搜索型工具
    18→# ═══════════════════════════════════════════════════════════════════════════
    19→
    20→@tool_handler("search_db")
    21→async def execute_search_db(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    22→    """从数据库检索知识或案例"""
    23→    from services.knowledge.repository import get_knowledge_repository
    24→
    25→    table = args.get("table", "knowledge_chunks")
    26→    query = args.get("query", "")
    27→    filters = args.get("filters", {})
    28→    top_k = args.get("top_k", 5)
    29→
    30→    # 自动添加当前 skill_id 到 filters
    31→    if context.skill_id and "skill_id" not in filters:
    32→        filters["skill_id"] = context.skill_id
    33→    if context.scenario_id and "scenario_id" not in filters:
    34→        filters["scenario_id"] = context.scenario_id
    35→
    36→    try:
    37→        repo = get_knowledge_repository()
    38→        results = await repo.search_db(
    39→            table=table,
    40→            query=query,
    41→            filters=filters,
    42→            top_k=top_k
    43→        )
    44→
    45→        return {
    46→            "status": "success",
    47→            "table": table,
    48→            "query": query,
    49→            "count": len(results),
    50→            "results": results
    51→        }
    52→    except Exception as e:
    53→        logger.error(f"search_db failed: {e}")
    54→        return {
    55→            "status": "error",
    56→            "error": str(e),
    57→            "results": []
    58→        }
    59→
    60→
    61→# ═══════════════════════════════════════════════════════════════════════════
    62→# 收集型工具
    63→# ═══════════════════════════════════════════════════════════════════════════
    64→
    65→@tool_handler("ask_user_question")
    66→async def execute_ask_user_question(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    67→    """主动向用户提问"""
    68→    question = args.get("question", "")
    69→    options = args.get("options", [])
    70→
    71→    return {
    72→        "status": "asking",
    73→        "cardType": "question_card",
    74→        "question": question,
    75→        "options": options[:4] if options else [],  # 最多4个选项
    76→    }
    77→
    78→
    79→@tool_handler("request_info")
    80→async def execute_request_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    81→    """向用户请求信息"""
    82→    info_type = args.get("info_type", "birth")
    83→    question = args.get("question")
    84→
    85→    fields_map = {
    86→        "birth": [
    87→            {"id": "birthDate", "label": "出生日期", "type": "date", "required": True, "placeholder": ""},
    88→            {"id": "birthTime", "label": "出生时间", "type": "time", "required": True, "placeholder": ""},
    89→            {"id": "birthPlace", "label": "出生地点", "type": "text", "required": False, "placeholder": "城市名"},
    90→            {"id": "gender", "label": "性别", "type": "select", "required": True, "options": [
    91→                {"value": "male", "label": "男"},
    92→                {"value": "female", "label": "女"},
    93→            ]},
    94→        ],
    95→        "context": [
    96→            {"id": "situation", "label": "当前情况", "type": "textarea", "required": True, "placeholder": "描述你目前面临的情况"},
    97→        ],
    98→        "goals": [
    99→            {"id": "goals", "label": "你的目标", "type": "textarea", "required": True, "placeholder": "你想达成什么"},
   100→        ],
   101→        "concerns": [
   102→            {"id": "concerns", "label": "你的困惑", "type": "textarea", "required": True, "placeholder": "最困扰你的是什么"},
   103→        ],
   104→    }
   105→
   106→    return {
   107→        "status": "collecting",
   108→        "cardType": "collect_form",
   109→        "infoType": info_type,
   110→        "question": question,
   111→        "fields": fields_map.get(info_type, fields_map["birth"]),
   112→    }
   113→
   114→
   115→# ═══════════════════════════════════════════════════════════════════════════
   116→# 展示型工具
   117→# ═══════════════════════════════════════════════════════════════════════════
   118→
   119→@tool_handler("show_service_menu")
   120→async def execute_show_service_menu(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   121→    """展示服务目录卡片"""
   122→    services = args.get("services") or [
   123→        {"id": "bazi", "name": "八字命理", "description": "八字排盘、运势分析", "icon": "compass"},
   124→        {"id": "zodiac", "name": "星座占星", "description": "星盘解读、行运分析", "icon": "star"},
   125→        {"id": "tarot", "name": "塔罗占卜", "description": "塔罗牌阵、问题指引", "icon": "cards"},
   126→        {"id": "career", "name": "职业规划", "description": "职业方向、发展建议", "icon": "briefcase"},
   127→    ]
   128→
   129→    return {
   130→        "status": "success",
   131→        "cardType": "service_menu",
   132→        "services": services,
   133→    }
   134→
   135→
   136→@tool_handler("show_skill_services")
   137→async def execute_show_skill_services(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   138→    """展示 Skill 服务目录"""
   139→    from services.agent.skill_loader import get_skill_services
   140→
   141→    skill_id = args.get("skill_id") or context.skill_id or "bazi"
   142→
   143→    # 从 SKILL.md 动态加载服务目录
   144→    skill_services = get_skill_services(skill_id)
   145→
   146→    if skill_services:
   147→        return {
   148→            "status": "success",
   149→            "cardType": "skill_services",
   150→            "skillId": skill_id,
   151→            "skillName": skill_services.get("skill_name", skill_id),
   152→            "description": skill_services.get("description", ""),
   153→            "services": skill_services.get("services", {}),
   154→        }
   155→
   156→    # 回退到默认服务列表
   157→    default_services = {
   158→        "bazi": {
   159→            "entry": [
   160→                {"scenario_id": "basic_reading", "name": "基础命盘", "description": "快速了解你的八字命盘", "tier": "entry"},
   161→                {"scenario_id": "personality", "name": "性格分析", "description": "从命盘看你的性格特点", "tier": "entry"},
   162→            ],
   163→            "standard": [
   164→                {"scenario_id": "yearly_fortune", "name": "流年运势", "description": "详细分析今年运势走向", "tier": "standard"},
   165→                {"scenario_id": "career", "name": "事业运势", "description": "深度分析事业发展方向", "tier": "standard"},
   166→            ],
   167→            "professional": [
   168→                {"scenario_id": "life_blueprint", "name": "人生蓝图", "description": "全面深度的命盘分析", "tier": "professional"},
   169→            ],
   170→        },
   171→        "zodiac": {
   172→            "entry": [
   173→                {"scenario_id": "basic_chart", "name": "星盘解读", "description": "本命星盘分析", "tier": "entry"},
   174→            ],
   175→            "standard": [
   176→                {"scenario_id": "transit", "name": "行运分析", "description": "当前行星影响", "tier": "standard"},
   177→            ],
   178→        },
   179→        "tarot": {
   180→            "entry": [
   181→                {"scenario_id": "single_card", "name": "单牌占卜", "description": "快速问答", "tier": "entry"},
   182→            ],
   183→        },
   184→        "career": {
   185→            "entry": [
   186→                {"scenario_id": "direction", "name": "职业方向", "description": "适合的职业领域", "tier": "entry"},
   187→            ],
   188→        },
   189→    }
   190→
   191→    return {
   192→        "status": "success",
   193→        "cardType": "skill_services",
   194→        "skillId": skill_id,
   195→        "services": default_services.get(skill_id, {}),
   196→    }
   197→
   198→
   199→@tool_handler("recommend_service")
   200→async def execute_recommend_service(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   201→    """推荐升级服务"""
   202→    scenario_id = args.get("scenario_id", "")
   203→    reason = args.get("reason", "")
   204→    highlights = args.get("highlights", [])
   205→
   206→    return {
   207→        "status": "success",
   208→        "cardType": "service_recommendation",
   209→        "scenarioId": scenario_id,
   210→        "reason": reason,
   211→        "highlights": highlights,
   212→    }
   213→
   214→
   215→@tool_handler("show_insight")
   216→async def execute_show_insight(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   217→    """展示洞察卡片"""
   218→    insight_type = args.get("insight_type", "general")
   219→    title = args.get("title", "关键洞察")
   220→    content = args.get("content", "")
   221→
   222→    return {
   223→        "status": "success",
   224→        "cardType": "insight_card",
   225→        "insightType": insight_type,
   226→        "insights": [
   227→            {
   228→                "id": f"ins-{datetime.now().timestamp()}",
   229→                "title": title,
   230→                "content": content,
   231→            }
   232→        ],
   233→    }
   234→
   235→
   236→@tool_handler("show_report")
   237→async def execute_show_report(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   238→    """展示完整报告"""
   239→    report_type = args.get("report_type", "lite")
   240→    report_id = args.get("report_id")
   241→
   242→    # 如果指定了 report_id，尝试获取
   243→    if report_id:
   244→        try:
   245→            from stores import report_repo
   246→            report = await report_repo.get_report(report_id)
   247→            if report:
   248→                return {
   249→                    "status": "success",
   250→                    "cardType": "report_card",
   251→                    **_normalize_report(report.to_dict())
   252→                }
   253→        except Exception as e:
   254→            logger.error(f"Failed to get report {report_id}: {e}")
   255→
   256→    # 尝试获取用户最新报告
   257→    if context.user_id and context.user_id != "guest":
   258→        try:
   259→            from stores import report_repo
   260→            from uuid import UUID
   261→            user_uuid = UUID(context.user_id)
   262→            reports = await report_repo.list_reports(user_uuid, skill=context.skill_id, limit=1)
   263→            if reports:
   264→                report = await report_repo.get_report(reports[0].id)
   265→                if report:
   266→                    return {
   267→                        "status": "success",
   268→                        "cardType": "report_card",
   269→                        **_normalize_report(report.to_dict())
   270→                    }
   271→        except Exception as e:
   272→            logger.error(f"Failed to get user reports: {e}")
   273→
   274→    # 返回演示报告
   275→    return {
   276→        "status": "success",
   277→        "cardType": "report_card",
   278→        "id": "demo",
   279→        "title": f"{'星盘' if context.skill_id == 'zodiac' else '八字'}报告（演示）",
   280→        "createdAt": datetime.now().strftime("%Y-%m-%d"),
   281→        "prologue": "这是一个演示版报告卡片。完善个人信息后可生成真实报告。",
   282→        "isPaid": False,
   283→        "reportType": report_type,
   284→    }
   285→
   286→
   287→def _normalize_report(report: Dict[str, Any]) -> Dict[str, Any]:
   288→    """标准化报告字段名"""
   289→    return {
   290→        **report,
   291→        "createdAt": report.get("created_at") or report.get("createdAt"),
   292→        "isPaid": report.get("is_paid") if report.get("isPaid") is None else report.get("isPaid"),
   293→        "reportType": report.get("report_type") or report.get("reportType"),
   294→    }
   295→
   296→
   297→@tool_handler("show_relationship")
   298→async def execute_show_relationship(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   299→    """展示关系分析结果"""
   300→    partner_info = args.get("partner_info", {})
   301→    relationship_type = args.get("relationship_type", "general")
   302→
   303→    # 关系类型描述 - 使用标准 ASCII 注释
   304→    type_descriptions = {
   305→        "romantic": "恋爱关系",
   306→        "friendship": "友谊关系",
   307→        "family": "家庭关系",
   308→        "work": "工作关系",
   309→        "general": "综合关系",
   310→    }
   311→
   312→    # 基础关系分析数据
   313→    analysis_data = {
   314→        "romantic": {
   315→            "dimensions": [
   316→                {"name": "情感连接", "score": 78, "description": "情感共鸣较好，能感受彼此"},
   317→                {"name": "沟通质量", "score": 72, "description": "沟通顺畅，偶有误解"},
   318→                {"name": "价值观契合", "score": 80, "description": "核心价值观一致"},
   319→                {"name": "生活习惯", "score": 68, "description": "需要相互适应"},
   320→                {"name": "长期潜力", "score": 75, "description": "有发展空间"},
   321→            ],
   322→            "strengths": ["情感基础稳固", "相互尊重", "共同成长意愿"],
   323→            "challenges": ["沟通方式差异", "生活节奏不同"],
   324→            "advice": "多创造共同经历，用行动表达关心。",
   325→        },
   326→        "friendship": {
   327→            "dimensions": [
   328→                {"name": "信任度", "score": 82, "description": "相互信任，可以倾诉"},
   329→                {"name": "共同兴趣", "score": 75, "description": "有共同话题"},
   330→                {"name": "支持度", "score": 78, "description": "愿意相互支持"},
   331→                {"name": "边界感", "score": 80, "description": "尊重彼此空间"},
   332→            ],
   333→            "strengths": ["真诚相待", "互相支持", "保持独立"],
   334→            "challenges": ["时间协调", "期望管理"],
   335→            "advice": "保持联系的同时尊重各自的生活节奏。",
   336→        },
   337→        "family": {
   338→            "dimensions": [
   339→                {"name": "亲密度", "score": 75, "description": "家庭纽带稳固"},
   340→                {"name": "沟通模式", "score": 68, "description": "沟通有改善空间"},
   341→                {"name": "期望管理", "score": 65, "description": "需要调整期望"},
   342→                {"name": "边界设定", "score": 70, "description": "边界逐渐清晰"},
   343→            ],
   344→            "strengths": ["血缘纽带", "无条件支持", "共同记忆"],
   345→            "challenges": ["代际差异", "期望落差"],
   346→            "advice": "接纳差异，专注于建立新的相处模式。",
   347→        },
   348→        "work": {
   349→            "dimensions": [
   350→                {"name": "协作效率", "score": 78, "description": "配合默契"},
   351→                {"name": "沟通效果", "score": 75, "description": "工作沟通顺畅"},
   352→                {"name": "信任基础", "score": 72, "description": "专业信任建立中"},
   353→                {"name": "目标一致", "score": 80, "description": "工作目标一致"},
   354→            ],
   355→            "strengths": ["专业互补", "目标一致", "高效协作"],
   356→            "challenges": ["风格差异", "压力传导"],
   357→            "advice": "明确分工，保持专业边界。",
   358→        },
   359→        "general": {
   360→            "dimensions": [
   361→                {"name": "整体和谐", "score": 75, "description": "关系整体和谐"},
   362→                {"name": "沟通质量", "score": 72, "description": "沟通基本顺畅"},
   363→                {"name": "相互理解", "score": 70, "description": "理解程度中等"},
   364→                {"name": "发展潜力", "score": 78, "description": "有提升空间"},
   365→            ],
   366→            "strengths": ["相互尊重", "愿意沟通"],
   367→            "challenges": ["需要更多了解"],
   368→            "advice": "增加互动，加深了解。",
   369→        },
   370→    }
   371→
   372→    data = analysis_data.get(relationship_type, analysis_data["general"])
   373→
   374→    # 计算总分
   375→    overall_score = int(sum(d["score"] for d in data["dimensions"]) / len(data["dimensions"]))
   376→
   377→    return {
   378→        "status": "success",
   379→        "cardType": "relationship_card",
   380→        "relationshipType": relationship_type,
   381→        "relationshipTypeName": type_descriptions.get(relationship_type, "综合关系"),
   382→        "partnerInfo": partner_info,
   383→        "overallScore": overall_score,
   384→        "dimensions": data["dimensions"],
   385→        "strengths": data["strengths"],
   386→        "challenges": data["challenges"],
   387→        "advice": data["advice"],
   388→    }
   389→
   390→
   391→# ═══════════════════════════════════════════════════════════════════════════
   392→# 用户数据工具
   393→# ═══════════════════════════════════════════════════════════════════════════
   394→
   395→@tool_handler("read_user_data")
   396→async def execute_read_user_data(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   397→    """读取用户数据"""
   398→    from uuid import UUID
   399→    from skills.core.services.user_data import get_user_data_service
   400→
   401→    path = args.get("path", "")
   402→
   403→    if not context.user_id or context.user_id == "guest":
   404→        return {
   405→            "status": "error",
   406→            "error": "需要登录才能读取数据",
   407→        }
   408→
   409→    try:
   410→        service = get_user_data_service()
   411→        user_uuid = UUID(context.user_id)
   412→        data = await service.read(user_uuid, path)
   413→
   414→        if data:
   415→            return {
   416→                "status": "success",
   417→                "path": path,
   418→                "data": data.to_dict(),
   419→            }
   420→        else:
   421→            return {
   422→                "status": "not_found",
   423→                "path": path,
   424→                "message": f"未找到数据: {path}",
   425→            }
   426→    except Exception as e:
   427→        logger.error(f"read_user_data failed: {e}")
   428→        return {
   429→            "status": "error",
   430→            "error": str(e),
   431→        }
   432→
   433→
   434→@tool_handler("write_user_data")
   435→async def execute_write_user_data(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   436→    """写入用户数据"""
   437→    from uuid import UUID
   438→    from skills.core.services.user_data import get_user_data_service
   439→
   440→    path = args.get("path", "")
   441→    content = args.get("content", {})
   442→    data_type = args.get("data_type")
   443→
   444→    if not context.user_id or context.user_id == "guest":
   445→        return {
   446→            "status": "error",
   447→            "error": "需要登录才能保存数据",
   448→        }
   449→
   450→    if not path:
   451→        return {
   452→            "status": "error",
   453→            "error": "path 参数不能为空",
   454→        }
   455→
   456→    if not content:
   457→        return {
   458→            "status": "error",
   459→            "error": "content 参数不能为空",
   460→        }
   461→
   462→    try:
   463→        service = get_user_data_service()
   464→        user_uuid = UUID(context.user_id)
   465→        data = await service.write(user_uuid, path, content, data_type)
   466→
   467→        return {
   468→            "status": "success",
   469→            "path": path,
   470→            "version": data.version,
   471→            "message": f"数据已保存到 {path}",
   472→        }
   473→    except Exception as e:
   474→        logger.error(f"write_user_data failed: {e}")
   475→        return {
   476→            "status": "error",
   477→            "error": str(e),
   478→        }
   479→
   480→
   481→@tool_handler("query_user_data")
   482→async def execute_query_user_data(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   483→    """查询用户数据"""
   484→    from uuid import UUID
   485→    from skills.core.services.user_data import get_user_data_service
   486→
   487→    data_type = args.get("data_type")
   488→    path_prefix = args.get("path_prefix")
   489→    filters = args.get("filters")
   490→    limit = args.get("limit", 20)
   491→
   492→    if not context.user_id or context.user_id == "guest":
   493→        return {
   494→            "status": "error",
   495→            "error": "需要登录才能查询数据",
   496→        }
   497→
   498→    try:
   499→        service = get_user_data_service()
   500→        user_uuid = UUID(context.user_id)
   501→        results = await service.query(
   502→            user_uuid,
   503→            data_type=data_type,
   504→            path_prefix=path_prefix,
   505→            filters=filters,
   506→            limit=limit,
   507→        )
   508→
   509→        return {
   510→            "status": "success",
   511→            "count": len(results),
   512→            "results": [r.to_dict() for r in results],
   513→        }
   514→    except Exception as e:
   515→        logger.error(f"query_user_data failed: {e}")
   516→        return {
   517→            "status": "error",
   518→            "error": str(e),
   519→        }
   520→
   521→
   522→@tool_handler("delete_user_data")
   523→async def execute_delete_user_data(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   524→    """删除用户数据"""
   525→    from uuid import UUID
   526→    from skills.core.services.user_data import get_user_data_service
   527→
   528→    path = args.get("path", "")
   529→
   530→    if not context.user_id or context.user_id == "guest":
   531→        return {
   532→            "status": "error",
   533→            "error": "需要登录才能删除数据",
   534→        }
   535→
   536→    if not path:
   537→        return {
   538→            "status": "error",
   539→            "error": "path 参数不能为空",
   540→        }
   541→
   542→    try:
   543→        service = get_user_data_service()
   544→        user_uuid = UUID(context.user_id)
   545→        deleted = await service.delete(user_uuid, path)
   546→
   547→        if deleted:
   548→            return {
   549→                "status": "success",
   550→                "path": path,
   551→                "message": f"已删除: {path}",
   552→            }
   553→        else:
   554→            return {
   555→                "status": "not_found",
   556→                "path": path,
   557→                "message": f"未找到数据: {path}",
   558→            }
   559→    except Exception as e:
   560→        logger.error(f"delete_user_data failed: {e}")
   561→        return {
   562→            "status": "error",
   563→            "error": str(e),
   564→        }
   565→
   566→
   567→# ═══════════════════════════════════════════════════════════════════════════
   568→# 提醒工具
   569→# ═══════════════════════════════════════════════════════════════════════════
   570→
   571→@tool_handler("schedule_reminder")
   572→async def execute_schedule_reminder(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   573→    """设置定时提醒"""
   574→    from uuid import UUID
   575→    from skills.core.services.reminder import get_reminder_service
   576→
   577→    title = args.get("title", "")
   578→    schedule = args.get("schedule", "")
   579→    schedule_type = args.get("schedule_type", "daily")
   580→    reminder_type = args.get("reminder_type", "custom")
   581→    description = args.get("description")
   582→    metadata = args.get("metadata", {})
   583→
   584→    if not context.user_id or context.user_id == "guest":
   585→        return {
   586→            "status": "error",
   587→            "error": "需要登录才能设置提醒",
   588→        }
   589→
   590→    if not title:
   591→        return {
   592→            "status": "error",
   593→            "error": "title 参数不能为空",
   594→        }
   595→
   596→    if not schedule:
   597→        return {
   598→            "status": "error",
   599→            "error": "schedule 参数不能为空",
   600→        }
   601→
   602→    try:
   603→        service = get_reminder_service()
   604→        user_uuid = UUID(context.user_id)
   605→        reminder = await service.create(
   606→            user_id=user_uuid,
   607→            reminder_type=reminder_type,
   608→            title=title,
   609→            schedule=schedule,
   610→            schedule_type=schedule_type,
   611→            description=description,
   612→            metadata=metadata,
   613→        )
   614→
   615→        return {
   616→            "status": "success",
   617→            "reminder": reminder.to_dict(),
   618→            "message": f"已设置提醒: {title}",
   619→        }
   620→    except Exception as e:
   621→        logger.error(f"schedule_reminder failed: {e}")
   622→        return {
   623→            "status": "error",
   624→            "error": str(e),
   625→        }
   626→
   627→
   628→@tool_handler("list_reminders")
   629→async def execute_list_reminders(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   630→    """列出用户提醒"""
   631→    from uuid import UUID
   632→    from skills.core.services.reminder import get_reminder_service
   633→
   634→    reminder_type = args.get("reminder_type")
   635→    status = args.get("status", "active")
   636→
   637→    if not context.user_id or context.user_id == "guest":
   638→        return {
   639→            "status": "error",
   640→            "error": "需要登录才能查看提醒",
   641→        }
   642→
   643→    try:
   644→        service = get_reminder_service()
   645→        user_uuid = UUID(context.user_id)
   646→        reminders = await service.list(
   647→            user_uuid,
   648→            reminder_type=reminder_type,
   649→            status=status,
   650→        )
   651→
   652→        return {
   653→            "status": "success",
   654→            "count": len(reminders),
   655→            "reminders": [r.to_dict() for r in reminders],
   656→        }
   657→    except Exception as e:
   658→        logger.error(f"list_reminders failed: {e}")
   659→        return {
   660→            "status": "error",
   661→            "error": str(e),
   662→        }
   663→
   664→
   665→@tool_handler("cancel_reminder")
   666→async def execute_cancel_reminder(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   667→    """取消提醒"""
   668→    from uuid import UUID
   669→    from skills.core.services.reminder import get_reminder_service
   670→
   671→    reminder_id = args.get("reminder_id", "")
   672→
   673→    if not context.user_id or context.user_id == "guest":
   674→        return {
   675→            "status": "error",
   676→            "error": "需要登录才能取消提醒",
   677→        }
   678→
   679→    if not reminder_id:
   680→        return {
   681→            "status": "error",
   682→            "error": "reminder_id 参数不能为空",
   683→        }
   684→
   685→    try:
   686→        service = get_reminder_service()
   687→        user_uuid = UUID(context.user_id)
   688→        reminder_uuid = UUID(reminder_id)
   689→        cancelled = await service.cancel(user_uuid, reminder_uuid)
   690→
   691→        if cancelled:
   692→            return {
   693→                "status": "success",
   694→                "message": "提醒已取消",
   695→            }
   696→        else:
   697→            return {
   698→                "status": "not_found",
   699→                "message": "未找到该提醒或已取消",
   700→            }
   701→    except Exception as e:
   702→        logger.error(f"cancel_reminder failed: {e}")
   703→        return {
   704→            "status": "error",
   705→            "error": str(e),
   706→        }
   707→
   708→
   709→# ═══════════════════════════════════════════════════════════════════════════
   710→# 目标追踪展示工具
   711→# ═══════════════════════════════════════════════════════════════════════════
   712→
   713→@tool_handler("show_goal_tree")
   714→async def execute_show_goal_tree(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   715→    """展示目标树卡片"""
   716→    from uuid import UUID
   717→    from skills.core.services.user_data import get_user_data_service
   718→
   719→    root_goal_path = args.get("root_goal_path")
   720→
   721→    if not context.user_id or context.user_id == "guest":
   722→        # 返回演示数据
   723→        return {
   724→            "status": "success",
   725→            "cardType": "goal_tree",
   726→            "goals": [
   727→                {
   728→                    "id": "demo-goal-1",
   729→                    "title": "2026年目标示例",
   730→                    "level": "year",
   731→                    "progress": 25,
   732→                    "status": "active",
   733→                    "children": [
   734→                        {"id": "demo-q1", "title": "Q1: 完成认证", "level": "quarter", "progress": 50, "status": "active"},
   735→                        {"id": "demo-q2", "title": "Q2: 主导项目", "level": "quarter", "progress": 0, "status": "pending"},
   736→                    ],
   737→                }
   738→            ],
   739→            "isDemo": True,
   740→        }
   741→
   742→    try:
   743→        service = get_user_data_service()
   744→        user_uuid = UUID(context.user_id)
   745→
   746→        # 查询用户目标
   747→        if root_goal_path:
   748→            results = await service.query(user_uuid, path_prefix=root_goal_path)
   749→        else:
   750→            results = await service.query(user_uuid, data_type="goals")
   751→
   752→        goals = []
   753→        for r in results:
   754→            goal = r.content.copy()
   755→            goal["id"] = r.data_path
   756→            goal["path"] = r.data_path
   757→            goals.append(goal)
   758→
   759→        return {
   760→            "status": "success",
   761→            "cardType": "goal_tree",
   762→            "goals": goals,
   763→            "count": len(goals),
   764→        }
   765→    except Exception as e:
   766→        logger.error(f"show_goal_tree failed: {e}")
   767→        return {
   768→            "status": "error",
   769→            "error": str(e),
   770→        }
   771→
   772→
   773→@tool_handler("show_daily_plan")
   774→async def execute_show_daily_plan(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   775→    """展示今日计划卡片"""
   776→    from uuid import UUID
   777→    from skills.core.services.user_data import get_user_data_service
   778→
   779→    date_str = args.get("date") or datetime.now().strftime("%Y-%m-%d")
   780→
   781→    if not context.user_id or context.user_id == "guest":
   782→        # 返回演示数据
   783→        return {
   784→            "status": "success",
   785→            "cardType": "daily_plan",
   786→            "date": date_str,
   787→            "tasks": [
   788→                {"id": "demo-1", "title": "完成报告", "time": "09:00", "completed": False, "priority": "high"},
   789→                {"id": "demo-2", "title": "团队会议", "time": "14:00", "completed": False, "priority": "medium"},
   790→                {"id": "demo-3", "title": "阅读30分钟", "time": "21:00", "completed": False, "priority": "low"},
   791→            ],
   792→            "isDemo": True,
   793→        }
   794→
   795→    try:
   796→        service = get_user_data_service()
   797→        user_uuid = UUID(context.user_id)
   798→
   799→        # 查询当日计划
   800→        plan_path = f"plans/daily/{date_str}"
   801→        data = await service.read(user_uuid, plan_path)
   802→
   803→        if data:
   804→            return {
   805→                "status": "success",
   806→                "cardType": "daily_plan",
   807→                "date": date_str,
   808→                "tasks": data.content.get("tasks", []),
   809→                "notes": data.content.get("notes", ""),
   810→            }
   811→        else:
   812→            return {
   813→                "status": "success",
   814→                "cardType": "daily_plan",
   815→                "date": date_str,
   816→                "tasks": [],
   817→                "message": "今天还没有计划，要现在创建吗？",
   818→            }
   819→    except Exception as e:
   820→        logger.error(f"show_daily_plan failed: {e}")
   821→        return {
   822→            "status": "error",
   823→            "error": str(e),
   824→        }
   825→
   826→
   827→@tool_handler("show_checkin_form")
   828→async def execute_show_checkin_form(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   829→    """展示打卡表单卡片"""
   830→    from uuid import UUID
   831→    from skills.core.services.user_data import get_user_data_service
   832→
   833→    date_str = args.get("date") or datetime.now().strftime("%Y-%m-%d")
   834→
   835→    if not context.user_id or context.user_id == "guest":
   836→        # 返回演示数据
   837→        return {
   838→            "status": "success",
   839→            "cardType": "checkin_form",
   840→            "date": date_str,
   841→            "tasks": [
   842→                {"id": "demo-1", "title": "完成报告", "completed": True},
   843→                {"id": "demo-2", "title": "团队会议", "completed": True},
   844→                {"id": "demo-3", "title": "阅读30分钟", "completed": False},
   845→            ],
   846→            "fields": [
   847→                {"id": "energy", "label": "今日精力", "type": "rating", "max": 5},
   848→                {"id": "reflection", "label": "今日反思", "type": "textarea"},
   849→            ],
   850→            "isDemo": True,
   851→        }
   852→
   853→    try:
   854→        service = get_user_data_service()
   855→        user_uuid = UUID(context.user_id)
   856→
   857→        # 获取当日计划
   858→        plan_path = f"plans/daily/{date_str}"
   859→        plan_data = await service.read(user_uuid, plan_path)
   860→
   861→        # 获取已有打卡记录
   862→        checkin_path = f"checkins/{date_str}"
   863→        checkin_data = await service.read(user_uuid, checkin_path)
   864→
   865→        tasks = plan_data.content.get("tasks", []) if plan_data else []
   866→
   867→        # 合并打卡状态
   868→        if checkin_data:
   869→            completed_ids = set(checkin_data.content.get("completed_tasks", []))
   870→            for task in tasks:
   871→                task["completed"] = task.get("id") in completed_ids
   872→
   873→        return {
   874→            "status": "success",
   875→            "cardType": "checkin_form",
   876→            "date": date_str,
   877→            "tasks": tasks,
   878→            "checkin": checkin_data.content if checkin_data else None,
   879→            "fields": [
   880→                {"id": "energy", "label": "今日精力", "type": "rating", "max": 5},
   881→                {"id": "mood", "label": "今日心情", "type": "rating", "max": 5},
   882→                {"id": "reflection", "label": "今日反思", "type": "textarea", "placeholder": "今天有什么收获或感悟？"},
   883→            ],
   884→        }
   885→    except Exception as e:
   886→        logger.error(f"show_checkin_form failed: {e}")
   887→        return {
   888→            "status": "error",
   889→            "error": str(e),
   890→        }
   891→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
