The file /home/aiscend/work/vibelife/apps/api/services/agent/core.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   312→
   313→        self.state = AgentState.COMPLETED
   314→        yield AgentEvent(type="done", data={"max_iterations_reached": True})
   315→
   316→    def _filter_valid_history(self, history: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
   317→        """
   318→        过滤历史消息，确保 tool 消息配对完整。
   319→
   320→        Anthropic API 要求每个 tool_result 必须有对应的 tool_use。
   321→        如果历史消息不完整（如只有 tool 消息没有对应的 assistant tool_calls），
   322→        需要过滤掉这些孤立的消息。
   323→        """
   324→        if not history:
   325→            return []
   326→
   327→        # 收集所有有效的 tool_call_ids（来自 assistant 的 tool_calls）
   328→        valid_tool_ids = set()
   329→        for msg in history:
   330→            if msg.get("role") == "assistant" and msg.get("tool_calls"):
   331→                for tc in msg["tool_calls"]:
   332→                    tc_id = tc.get("id")
   333→                    if tc_id:
   334→                        valid_tool_ids.add(tc_id)
   335→
   336→        # 过滤消息
   337→        filtered = []
   338→        for msg in history:
   339→            role = msg.get("role", "user")
   340→
   341→            # tool 消息需要检查是否有对应的 tool_use
   342→            if role == "tool":
   343→                tool_call_id = msg.get("tool_call_id")
   344→                if tool_call_id and tool_call_id in valid_tool_ids:
   345→                    filtered.append(msg)
   346→                else:
   347→                    # 孤立的 tool 消息，跳过
   348→                    logger.warning(f"Skipping orphan tool message: {tool_call_id}")
   349→            else:
   350→                # user/assistant 消息直接保留
   351→                filtered.append(msg)
   352→
   353→        return filtered
   354→
   355→    async def _route_scenario(self, skill_id: str, message: str) -> Optional[str]:
   356→        """场景路由 - 根据消息匹配最佳场景"""
   357→        try:
   358→            matches = await self.knowledge_repo.route_scenario(skill_id, message)
   359→            if matches:
   360→                return matches[0].scenario_id