     1→"""
     2→Agent Framework - V10 Architecture (Context Engineering)
     3→
     4→V10 Changes:
     5→- Context Engineering: 文件/JSONB 持久化状态，断点续传
     6→- 模块化: ContextManager, SessionManager, PromptBuilder, ToolExecutor
     7→- 会话恢复: 自动检测未完成会话，支持断点续传
     8→- 跨 Skill 共享: profile.extracted + identity
     9→
    10→V9 Features (retained):
    11→- Phase 1 提供所有路由工具，LLM 一次性决策
    12→- 移除 Python 硬编码决策逻辑
    13→- 工具即行为：activate_skill, show_protocol_invitation, show_skill_intro
    14→
    15→V6 Features (retained):
    16→- CoreAgent replaces Orchestrator + SkillAgents
    17→- LLM-based skill selection (no keyword matching)
    18→- SkillLoader loads SKILL.md files
    19→- Unified tool schema from YAML
    20→- Skill validation for CI
    21→"""
    22→
    23→# Core Agent
    24→from .core import CoreAgent, AgentContext, AgentEvent, AgentState, create_agent
    25→from .skill_loader import load_skill, build_system_prompt, get_available_skills, SkillConfig
    26→from .subagent import SkillSubAgent
    27→
    28→# Tier limits (简化版，完整配额管理使用 model_router.quota)
    29→TIER_LIMITS = {
    30→    "free": {"calls": 50, "tokens": 100000},
    31→    "paid": {"calls": 500, "tokens": 1000000},
    32→    "vip": {"calls": -1, "tokens": -1},
    33→}
    34→
    35→
    36→class QuotaTracker:
    37→    """简化配额追踪 - 委托到 UsageService"""
    38→
    39→    @classmethod
    40→    async def check(cls, user_id: str, tier: str):
    41→        """检查配额"""
    42→        if tier == "vip":
    43→            return True, ""
    44→
    45→        from services.usage import UsageService
    46→        from uuid import UUID
    47→
    48→        try:
    49→            usage = await UsageService.get_monthly_usage(UUID(user_id))
    50→            limits = TIER_LIMITS.get(tier, TIER_LIMITS["free"])
    51→
    52→            if limits["calls"] > 0 and usage["llm_calls"] >= limits["calls"]:
    53→                return False, "本月对话次数已用完"
    54→            return True, ""
    55→        except Exception:
    56→            return True, ""
    57→
    58→    @classmethod
    59→    async def record(cls, user_id: str, usage: dict):
    60→        """记录用量 - 已由 UsageService 处理"""
    61→        pass
    62→
    63→# Stream Adapters
    64→from .stream_adapter import (
    65→    BaseStreamAdapter,
    66→    AISDKv6Adapter,
    67→    LegacySSEAdapter,
    68→    StreamConfig,
    69→    get_adapter,
    70→)
    71→
    72→# V6 新增: 统一工具定义
    73→from .tool_schema import (
    74→    ToolDef,
    75→    ToolParam,
    76→    load_skill_tools,
    77→    get_skill_tools_openai,
    78→    get_global_tools_openai,
    79→    get_all_tools_for_skill,
    80→    get_tool_card_type,
    81→)
    82→
    83→# V6 新增: 统一工具注册表
    84→from .tool_registry import (
    85→    ToolRegistry,
    86→    ToolContext,
    87→    tool_handler,
    88→)
    89→
    90→# V10 新增: Context Engineering
    91→from .context_manager import (
    92→    ContextManager,
    93→    SessionContext,
    94→    Checkpoint,
    95→    Finding,
    96→    get_context_manager,
    97→)
    98→from .session_manager import (
    99→    SessionManager,
   100→    ActiveSession,
   101→    SessionStatus,
   102→    get_session_manager,
   103→)
   104→from .prompt_builder import PromptBuilder, get_prompt_builder
   105→from .tool_executor import ToolExecutor, get_tool_executor
   106→
   107→# V6 新增: Skill 校验
   108→from .skill_validator import (
   109→    validate_skill,
   110→    validate_all_skills,
   111→    ValidationResult,
   112→    ValidationError,
   113→)
   114→
   115→__all__ = [
   116→    # Core Agent
   117→    "CoreAgent",
   118→    "AgentContext",
   119→    "AgentEvent",
   120→    "AgentState",
   121→    "SkillConfig",
   122→    "SkillSubAgent",
   123→    "QuotaTracker",
   124→    "TIER_LIMITS",
   125→    "create_agent",
   126→    "load_skill",
   127→    "build_system_prompt",
   128→    "get_available_skills",
   129→    # Stream Adapters
   130→    "BaseStreamAdapter",
   131→    "AISDKv6Adapter",
   132→    "LegacySSEAdapter",
   133→    "StreamConfig",
   134→    "get_adapter",
   135→    # Tool Schema
   136→    "ToolDef",
   137→    "ToolParam",
   138→    "load_skill_tools",
   139→    "get_skill_tools_openai",
   140→    "get_global_tools_openai",
   141→    "get_all_tools_for_skill",
   142→    "get_tool_card_type",
   143→    # Tool Registry
   144→    "ToolRegistry",
   145→    "ToolContext",
   146→    "tool_handler",
   147→    # Context Engineering (v10)
   148→    "ContextManager",
   149→    "SessionContext",
   150→    "Checkpoint",
   151→    "Finding",
   152→    "get_context_manager",
   153→    "SessionManager",
   154→    "ActiveSession",
   155→    "SessionStatus",
   156→    "get_session_manager",
   157→    "PromptBuilder",
   158→    "get_prompt_builder",
   159→    "ToolExecutor",
   160→    "get_tool_executor",
   161→    # Skill Validator
   162→    "validate_skill",
   163→    "validate_all_skills",
   164→    "ValidationResult",
   165→    "ValidationError",
   166→]
   167→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
