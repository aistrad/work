     1→"""
     2→Prompt Builder v10 - System Prompt 构建
     3→
     4→从 core.py 拆分出来的 Prompt 构建逻辑，支持：
     5→- Phase 1/Phase 2 分阶段 Prompt
     6→- 会话恢复 Prompt（断点续传）
     7→- SOP 规则注入
     8→- 案例匹配
     9→
    10→与 ContextManager 协作：
    11→- 读取会话上下文
    12→- 注入断点信息
    13→"""
    14→import json
    15→import logging
    16→from typing import Optional, Dict, Any, List
    17→
    18→from .skill_loader import (
    19→    load_skill, build_system_prompt,
    20→    skill_requires_birth_info, skill_requires_compute,
    21→    get_skill_compute_type, get_skill_compute_tool, get_skill_collect_tool
    22→)
    23→from .routing_config import get_phase1_prompt, get_sop_template
    24→from .context_manager import SessionContext
    25→
    26→logger = logging.getLogger(__name__)
    27→
    28→
    29→class PromptBuilder:
    30→    """
    31→    System Prompt 构建器
    32→
    33→    职责：
    34→    1. 根据 Phase 构建不同的 Prompt
    35→    2. 注入会话恢复上下文
    36→    3. 注入 SOP 规则
    37→    4. 动态加载案例
    38→    """
    39→
    40→    def __init__(self):
    41→        self.case_index = None  # Lazy init
    42→
    43→    async def build(
    44→        self,
    45→        skill_id: Optional[str],
    46→        rule_id: Optional[str],
    47→        message: str,
    48→        profile: Optional[Dict[str, Any]] = None,
    49→        skill_data: Optional[Dict[str, Any]] = None,
    50→        session_context: Optional[SessionContext] = None,
    51→        protocol_prompt: Optional[str] = None
    52→    ) -> str:
    53→        """
    54→        构建 System Prompt
    55→
    56→        Args:
    57→            skill_id: 当前技能 ID
    58→            rule_id: 当前规则 ID
    59→            message: 用户消息
    60→            profile: 用户 Profile
    61→            skill_data: Skill 数据
    62→            session_context: 会话上下文（断点续传）
    63→            protocol_prompt: 协议专用 Prompt（可选）
    64→
    65→        Returns:
    66→            完整的 System Prompt
    67→        """
    68→        parts = []
    69→
    70→        # ═══════════════════════════════════════════════════════════════
    71→        # 协议模式：使用协议专用 Prompt
    72→        # ═══════════════════════════════════════════════════════════════
    73→        if protocol_prompt:
    74→            skill = load_skill("lifecoach")
    75→            if skill:
    76→                parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
    77→            parts.append("\n---\n")
    78→            parts.append(protocol_prompt)
    79→            return "\n".join(parts)
    80→
    81→        if skill_id:
    82→            # ═══════════════════════════════════════════════════════════════
    83→            # Phase 2: Skill 执行阶段 - 完整上下文
    84→            # ═══════════════════════════════════════════════════════════════
    85→
    86→            # 基础 Skill Prompt
    87→            user_ctx = dict(profile) if profile else {}
    88→            base_prompt = build_system_prompt(skill_id, rule_id, user_ctx)
    89→            parts.append(base_prompt)
    90→
    91→            # 会话恢复上下文（断点续传核心）
    92→            if session_context and session_context.has_checkpoint:
    93→                resume_context = session_context.to_prompt_context()
    94→                if resume_context:
    95→                    parts.append(resume_context)
    96→
    97→            # SOP 规则
    98→            sop_rules = self._build_sop_rules(skill_id, profile, skill_data)
    99→            if sop_rules:
   100→                parts.append(sop_rules)
   101→
   102→            # 案例匹配
   103→            cases_text = await self._match_cases(skill_id, skill_data)
   104→            if cases_text:
   105→                parts.append(cases_text)
   106→
   107→            # 用户数据
   108→            if skill_data:
   109→                compute_type = get_skill_compute_type(skill_id) or skill_id
   110→                data = skill_data.get(compute_type, {})
   111→                if data:
   112→                    parts.append(f"\n## 用户数据\n{json.dumps(data, ensure_ascii=False, indent=2)}")
   113→
   114→        else:
   115→            # ═══════════════════════════════════════════════════════════════
   116→            # Phase 1: Skill 选择阶段 - 轻量级
   117→            # ═══════════════════════════════════════════════════════════════
   118→
   119→            core_prompt = get_phase1_prompt()
   120→            if not core_prompt:
   121→                # Fallback
   122→                core_prompt = self._get_fallback_phase1_prompt()
   123→
   124→            parts.append(core_prompt)
   125→
   126→        return "\n".join(parts)
   127→
   128→    def _build_sop_rules(
   129→        self,
   130→        skill_id: str,
   131→        profile: Optional[Dict[str, Any]],
   132→        skill_data: Optional[Dict[str, Any]]
   133→    ) -> str:
   134→        """
   135→        构建 SOP 规则（自然语言版）
   136→
   137→        根据当前状态生成教练式指导。
   138→        """
   139→        needs_birth = skill_requires_birth_info(skill_id)
   140→        needs_compute = skill_requires_compute(skill_id)
   141→
   142→        # 计算当前状态
   143→        status = self._compute_status(skill_id, profile, skill_data)
   144→
   145→        # 如果已经可以分析，使用简洁的状态提示
   146→        if status["ready_for_analysis"]:
   147→            template = get_sop_template("ready_for_analysis")
   148→            if template:
   149→                chart_summary = self._extract_chart_summary(skill_id, skill_data)
   150→                return template.format(
   151→                    chart_summary=chart_summary,
   152→                    skill_id=skill_id
   153→                )
   154→            return self._get_ready_prompt()
   155→
   156→        rules_parts = []
   157→
   158→        # P1: 需要收集信息
   159→        if needs_birth and not status["has_birth_info"]:
   160→            collect_tool = get_skill_collect_tool(skill_id) or "request_info"
   161→            template = get_sop_template("need_birth_info")
   162→            if template:
   163→                rules_parts.append(template.format(collect_tool=collect_tool))
   164→            else:
   165→                rules_parts.append(self._get_need_birth_prompt(collect_tool))
   166→
   167→        # P2: 需要计算
   168→        elif needs_compute and not status["has_chart_data"]:
   169→            compute_type = get_skill_compute_type(skill_id) or skill_id
   170→            compute_tool = get_skill_compute_tool(skill_id) or f"calculate_{compute_type}"
   171→
   172→            template = get_sop_template("need_compute")
   173→            if template:
   174→                rules_parts.append(template.format(compute_tool=compute_tool, has_chart="否"))
   175→            else:
   176→                rules_parts.append(self._get_need_compute_prompt(compute_tool))
   177→
   178→        return "\n".join(rules_parts)
   179→
   180→    def _compute_status(
   181→        self,
   182→        skill_id: str,
   183→        profile: Optional[Dict[str, Any]],
   184→        skill_data: Optional[Dict[str, Any]]
   185→    ) -> Dict[str, Any]:
   186→        """计算当前 SOP 状态"""
   187→        needs_birth = skill_requires_birth_info(skill_id)
   188→        needs_compute = skill_requires_compute(skill_id)
   189→
   190→        # 检查出生信息
   191→        has_birth = False
   192→        if profile:
   193→            identity = profile.get("identity", {})
   194→            birth_info = identity.get("birth_info", {})
   195→            has_birth = bool(birth_info.get("birth_date") or birth_info.get("date"))
   196→
   197→        # 检查命盘数据
   198→        has_chart = False
   199→        if skill_data:
   200→            compute_type = get_skill_compute_type(skill_id) or skill_id
   201→            data = skill_data.get(compute_type, {})
   202→            has_chart = bool(data.get("chart") or data.get("cards"))
   203→
   204→        return {
   205→            "skill_id": skill_id,
   206→            "needs_birth_info": needs_birth,
   207→            "has_birth_info": has_birth,
   208→            "needs_compute": needs_compute,
   209→            "has_chart_data": has_chart,
   210→            "ready_for_analysis": (not needs_birth or has_birth) and (not needs_compute or has_chart)
   211→        }
   212→
   213→    def _extract_chart_summary(
   214→        self,
   215→        skill_id: str,
   216→        skill_data: Optional[Dict[str, Any]]
   217→    ) -> str:
   218→        """从命盘数据中提取关键摘要"""
   219→        if not skill_data:
   220→            return "无命盘数据"
   221→
   222→        compute_type = get_skill_compute_type(skill_id) or skill_id
   223→        data = skill_data.get(compute_type, {})
   224→
   225→        if not data:
   226→            return "无命盘数据"
   227→
   228→        summary_parts = []
   229→
   230→        # 八字
   231→        if compute_type == "bazi" and "chart" in data:
   232→            chart = data["chart"]
   233→            if "pillars" in chart and len(chart["pillars"]) > 2:
   234→                day_pillar = chart["pillars"][2]
   235→                summary_parts.append(f"日主{day_pillar.get('day_stem', '')}{day_pillar.get('day_branch', '')}")
   236→            if "month_order" in chart:
   237→                summary_parts.append(f"月令{chart['month_order']}")
   238→
   239→        # 星盘
   240→        elif compute_type == "zodiac" and "chart" in data:
   241→            chart = data["chart"]
   242→            planets = chart.get("planets", {})
   243→            if "sun" in planets:
   244→                summary_parts.append(f"太阳{planets['sun'].get('sign', '')}")
   245→            if "moon" in planets:
   246→                summary_parts.append(f"月亮{planets['moon'].get('sign', '')}")
   247→
   248→        # 塔罗
   249→        elif compute_type == "tarot" and "cards" in data:
   250→            cards = data["cards"]
   251→            if isinstance(cards, list) and len(cards) > 0:
   252→                summary_parts.append(f"{len(cards)}张牌")
   253→
   254→        if summary_parts:
   255→            return "、".join(summary_parts)
   256→        else:
   257→            return "已生成命盘"
   258→
   259→    async def _match_cases(
   260→        self,
   261→        skill_id: str,
   262→        skill_data: Optional[Dict[str, Any]]
   263→    ) -> str:
   264→        """匹配相关案例"""
   265→        if not skill_data:
   266→            return ""
   267→
   268→        try:
   269→            from .case_index import get_case_index, extract_features
   270→
   271→            if self.case_index is None:
   272→                self.case_index = get_case_index()
   273→
   274→            features = extract_features(skill_data)
   275→            if not features:
   276→                return ""
   277→
   278→            cases = await self.case_index.get_matched_cases(skill_id, features, top_k=2)
   279→            if not cases:
   280→                return ""
   281→
   282→            cases_text = "\n## 相关案例\n\n"
   283→            for case in cases:
   284→                cases_text += f"### {case.name}\n{case.content}\n\n"
   285→
   286→            return cases_text
   287→
   288→        except Exception as e:
   289→            logger.warning(f"[PromptBuilder] Case matching failed: {e}")
   290→            return ""
   291→
   292→    def _get_fallback_phase1_prompt(self) -> str:
   293→        """Fallback Phase 1 Prompt"""
   294→        return """# Vibe
   295→
   296→你是 Vibe，生命对话者。你的任务是理解用户意图，引导 Ta 到合适的服务。
   297→
   298→## 行为准则
   299→
   300→1. **识别意图 → 调用工具**：不要只用文字回复，要调用工具
   301→2. **简短回应 + 工具**：调用工具时配合一句暖心的话
   302→3. **不确定 → 推荐**：调用 recommend_skills 让用户选择
   303→
   304→## 语气
   305→
   306→温暖、简洁、不啰嗦。像一个懂你的老朋友。
   307→
   308→示例：
   309→- "嗨～ 今天想聊点什么？"
   310→- "好的，让我来帮你看看～"
   311→- "迷茫的时候来找我就对了。"
   312→"""
   313→
   314→    def _get_ready_prompt(self) -> str:
   315→        """已准备好分析的 Prompt"""
   316→        return """## 当前状态
   317→
   318→用户信息已完整，命盘已生成。你可以开始分析了。
   319→
   320→**分析流程**：
   321→1. 快速扫描命盘中的关键特征
   322→2. 根据用户问题聚焦分析
   323→3. 用 `show_xxx` 工具展示分析结果
   324→4. 回答用户的追问
   325→"""
   326→
   327→    def _get_need_birth_prompt(self, collect_tool: str) -> str:
   328→        """需要收集出生信息的 Prompt"""
   329→        return f"""## 当前状态
   330→
   331→用户还没有告诉你出生信息。在深入分析之前，你需要先了解 Ta 的出生时间。
   332→
   333→**下一步**：调用 `{collect_tool}` 工具，让用户填写出生信息表单。
   334→不要用文字问"请问你的生日是？"——表单体验更好。
   335→"""
   336→
   337→    def _get_need_compute_prompt(self, compute_tool: str) -> str:
   338→        """需要计算的 Prompt"""
   339→        return f"""## 当前状态
   340→
   341→用户已提供出生信息，但还没有生成命盘。
   342→
   343→**下一步**：调用 `{compute_tool}` 工具生成命盘数据。
   344→计算完成后你就可以开始分析了。
   345→"""
   346→
   347→    def build_session_resume_prompt(
   348→        self,
   349→        session_context: SessionContext,
   350→        rule_name: Optional[str] = None
   351→    ) -> str:
   352→        """
   353→        构建会话恢复 Prompt（用于 SOP 模板）
   354→
   355→        专门用于断点续传场景
   356→        """
   357→        if not session_context or not session_context.has_checkpoint:
   358→            return ""
   359→
   360→        cp = session_context.checkpoint
   361→        session = session_context.session
   362→
   363→        lines = ["## 会话恢复模式\n"]
   364→
   365→        if cp:
   366→            lines.append(f"用户上次完成了 {cp.step} 个步骤。\n")
   367→
   368→            if cp.collected_data:
   369→                lines.append("**已收集信息**：")
   370→                for key, value in cp.collected_data.items():
   371→                    lines.append(f"- {key}: {value}")
   372→                lines.append("")
   373→
   374→            next_step = cp.step + 1
   375→            lines.append(f"**下一步**：")
   376→            lines.append(f"继续第 {next_step} 个问题\n")
   377→
   378→        lines.append("**处理方式**：")
   379→        lines.append("1. 简短问候：「欢迎回来！上次我们聊到了...」")
   380→        lines.append("2. 快速回顾（1-2 句）")
   381→        lines.append("3. 直接问下一个问题")
   382→
   383→        return "\n".join(lines)
   384→
   385→
   386→# ═══════════════════════════════════════════════════════════════════════════
   387→# Singleton
   388→# ═══════════════════════════════════════════════════════════════════════════
   389→
   390→_prompt_builder: Optional[PromptBuilder] = None
   391→
   392→
   393→def get_prompt_builder() -> PromptBuilder:
   394→    """获取 PromptBuilder 单例"""
   395→    global _prompt_builder
   396→    if _prompt_builder is None:
   397→        _prompt_builder = PromptBuilder()
   398→    return _prompt_builder
   399→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
