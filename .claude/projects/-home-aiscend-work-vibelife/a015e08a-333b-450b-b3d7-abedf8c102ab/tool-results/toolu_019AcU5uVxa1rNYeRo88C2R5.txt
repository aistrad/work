     1→"""
     2→Unified Profile Repository - 统一 Profile 数据访问层
     3→
     4→基于 unified_profiles 表，提供统一的 Profile 访问接口。
     5→使用 jsonb_set() 进行局部更新，避免重写整个 profile。
     6→
     7→v7.7 重构：添加 account 和 state 字段
     8→- account: 从 vibe_users 同步 (vibe_id, display_name, tier, status)
     9→- state: 用户当前状态 (focus)
    10→
    11→v7.6 重构：整合以下功能到统一 Profile:
    12→- Skill 订阅管理 (原 user_skill_subscriptions)
    13→- 推送偏好 (原 user_push_preferences)
    14→- 生活上下文 (原 user_data_store)
    15→- Skill 推荐屏蔽 (原 skill_recommendation_blocks)
    16→
    17→Profile 结构:
    18→{
    19→    "account": {
    20→        "vibe_id": "VB-A1B2C3D4",
    21→        "display_name": "用户昵称",
    22→        "tier": "free",
    23→        "status": "active"
    24→    },
    25→    "birth_info": {...},
    26→    "state": {
    27→        "focus": ["career", "health"],
    28→        "updated_at": "2026-01-19T10:00:00Z"
    29→    },
    30→    "life_context": {...},
    31→    "preferences": {
    32→        "voice_mode": "warm",
    33→        "language": "zh-CN",
    34→        "timezone": "Asia/Shanghai",
    35→        "subscribed_skills": {
    36→            "bazi": {"status": "subscribed", "push_enabled": true, ...},
    37→            ...
    38→        },
    39→        "push_settings": {
    40→            "default_push_hour": 8,
    41→            "max_daily_pushes": 5,
    42→            "quiet_start_hour": 22,
    43→            "quiet_end_hour": 7
    44→        },
    45→        "blocked_skills": ["skill_id_1", ...]
    46→    },
    47→    "skill_data": {...},
    48→    "extracted": {...}
    49→}
    50→"""
    51→import json
    52→import logging
    53→from dataclasses import dataclass
    54→from datetime import datetime, date, timezone
    55→from typing import Optional, Dict, Any, List
    56→from uuid import UUID
    57→
    58→from .db import get_connection, fetch, fetchrow, fetchval, execute
    59→
    60→logger = logging.getLogger(__name__)
    61→
    62→
    63→# ═══════════════════════════════════════════════════════════════════════════
    64→# Data Classes
    65→# ═══════════════════════════════════════════════════════════════════════════
    66→
    67→@dataclass
    68→class SkillSubscription:
    69→    """Skill 订阅数据类 (兼容旧接口)"""
    70→    skill_id: str
    71→    status: str  # subscribed | unsubscribed | not_subscribed
    72→    push_enabled: bool
    73→    subscribed_at: Optional[datetime]
    74→    unsubscribed_at: Optional[datetime]
    75→    trial_messages_used: int
    76→
    77→    def to_dict(self) -> Dict[str, Any]:
    78→        return {
    79→            "skill_id": self.skill_id,
    80→            "status": self.status,
    81→            "push_enabled": self.push_enabled,
    82→            "subscribed_at": self.subscribed_at.isoformat() if self.subscribed_at else None,
    83→            "unsubscribed_at": self.unsubscribed_at.isoformat() if self.unsubscribed_at else None,
    84→            "trial_messages_used": self.trial_messages_used,
    85→        }
    86→
    87→
    88→@dataclass
    89→class UserPushPreferences:
    90→    """用户推送偏好 (兼容旧接口)"""
    91→    user_id: UUID
    92→    default_push_hour: int = 8
    93→    max_daily_pushes: int = 5
    94→    quiet_start_hour: int = 22
    95→    quiet_end_hour: int = 7
    96→
    97→    def to_dict(self) -> Dict[str, Any]:
    98→        return {
    99→            "user_id": str(self.user_id),
   100→            "default_push_hour": self.default_push_hour,
   101→            "max_daily_pushes": self.max_daily_pushes,
   102→            "quiet_start_hour": self.quiet_start_hour,
   103→            "quiet_end_hour": self.quiet_end_hour,
   104→        }
   105→
   106→
   107→@dataclass
   108→class LifeContextData:
   109→    """生活上下文数据 (替代 UserData)"""
   110→    path: str
   111→    content: Dict[str, Any]
   112→    version: int = 1
   113→    updated_at: Optional[datetime] = None
   114→
   115→    def to_dict(self) -> Dict[str, Any]:
   116→        return {
   117→            "path": self.path,
   118→            "content": self.content,
   119→            "version": self.version,
   120→            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
   121→        }
   122→
   123→
   124→def deep_merge(base: Dict, update: Dict) -> Dict:
   125→    """
   126→    深度合并两个字典
   127→
   128→    规则：
   129→    - 如果 update 中的值是 dict，递归合并
   130→    - 如果 update 中的值是 None，删除该键
   131→    - 否则，update 的值覆盖 base
   132→    """
   133→    result = base.copy()
   134→    for key, value in update.items():
   135→        if value is None:
   136→            # None 表示删除该键
   137→            result.pop(key, None)
   138→        elif key in result and isinstance(result[key], dict) and isinstance(value, dict):
   139→            # 递归合并嵌套字典
   140→            result[key] = deep_merge(result[key], value)
   141→        else:
   142→            # 覆盖值
   143→            result[key] = value
   144→    return result
   145→
   146→
   147→class UnifiedProfileRepository:
   148→    """统一 Profile 数据访问层"""
   149→
   150→    # ═══════════════════════════════════════════════════════════════════════════
   151→    # 读取操作
   152→    # ═══════════════════════════════════════════════════════════════════════════
   153→
   154→    @staticmethod
   155→    async def get_profile(user_id: UUID) -> Optional[Dict[str, Any]]:
   156→        """获取完整 Profile"""
   157→        row = await fetchrow(
   158→            "SELECT profile FROM unified_profiles WHERE user_id = $1",
   159→            user_id
   160→        )
   161→        if not row:
   162→            return None
   163→
   164→        profile = row["profile"]
   165→        if isinstance(profile, str):
   166→            profile = json.loads(profile)
   167→        return profile
   168→
   169→    @staticmethod
   170→    async def get_birth_info(user_id: UUID) -> Dict[str, Any]:
   171→        """获取出生信息"""
   172→        profile = await UnifiedProfileRepository.get_profile(user_id)
   173→        if profile:
   174→            identity = profile.get("identity", {})
   175→            return identity.get("birth_info", {})
   176→        return {}
   177→
   178→    @staticmethod
   179→    async def get_skill_data(user_id: UUID, skill: str) -> Dict[str, Any]:
   180→        """获取 Skill 数据"""
   181→        profile = await UnifiedProfileRepository.get_profile(user_id)
   182→        if profile:
   183→            return profile.get("skill_data", {}).get(skill, {})
   184→        return {}
   185→
   186→    @staticmethod
   187→    async def get_all_skill_data(user_id: UUID) -> Dict[str, Any]:
   188→        """获取所有 Skill 数据"""
   189→        profile = await UnifiedProfileRepository.get_profile(user_id)
   190→        if profile:
   191→            return profile.get("skill_data", {})
   192→        return {}
   193→
   194→    @staticmethod
   195→    async def get_preferences(user_id: UUID) -> Dict[str, Any]:
   196→        """获取用户偏好"""
   197→        profile = await UnifiedProfileRepository.get_profile(user_id)
   198→        if profile:
   199→            return profile.get("preferences", {"voice_mode": "warm", "language": "zh-CN"})
   200→        return {"voice_mode": "warm", "language": "zh-CN"}
   201→
   202→    @staticmethod
   203→    async def get_life_context(user_id: UUID) -> Dict[str, Any]:
   204→        """获取生活上下文"""
   205→        profile = await UnifiedProfileRepository.get_profile(user_id)
   206→        if profile:
   207→            return profile.get("life_context", {})
   208→        return {}
   209→
   210→    @staticmethod
   211→    async def get_account(user_id: UUID) -> Dict[str, Any]:
   212→        """
   213→        获取账户信息 (从 vibe_users 同步)
   214→
   215→        Returns:
   216→            {
   217→                "vibe_id": "VB-A1B2C3D4",
   218→                "display_name": "用户昵称",
   219→                "tier": "free",
   220→                "status": "active"
   221→            }
   222→        """
   223→        profile = await UnifiedProfileRepository.get_profile(user_id)
   224→        if profile:
   225→            return profile.get("account", {})
   226→        return {}
   227→
   228→    @staticmethod
   229→    async def get_state(user_id: UUID) -> Dict[str, Any]:
   230→        """
   231→        获取用户状态
   232→
   233→        Returns:
   234→            {
   235→                "focus": ["career", "health"],
   236→                "updated_at": "2026-01-19T10:00:00Z"
   237→            }
   238→        """
   239→        profile = await UnifiedProfileRepository.get_profile(user_id)
   240→        if profile:
   241→            return profile.get("state", {"focus": [], "updated_at": None})
   242→        return {"focus": [], "updated_at": None}
   243→
   244→    @staticmethod
   245→    async def get_focus(user_id: UUID) -> List[str]:
   246→        """获取用户当前关注的话题"""
   247→        state = await UnifiedProfileRepository.get_state(user_id)
   248→        return state.get("focus", [])
   249→
   250→    @staticmethod
   251→    async def get_tier(user_id: UUID) -> str:
   252→        """获取用户等级 (free, basic, pro, enterprise)"""
   253→        account = await UnifiedProfileRepository.get_account(user_id)
   254→        return account.get("tier", "free")
   255→
   256→    @staticmethod
   257→    async def get_account_full(user_id: UUID) -> Dict[str, Any]:
   258→        """
   259→        获取完整账户信息（替代 UserRepository.get_by_id）
   260→
   261→        Returns:
   262→            完整的账户+偏好信息，包括：
   263→            {
   264→                "vibe_id": "VB-xxx",
   265→                "display_name": "用户昵称",
   266→                "avatar_url": "https://...",
   267→                "tier": "free",
   268→                "status": "active",
   269→                "timezone": "Asia/Shanghai",
   270→                "language": "zh-CN",
   271→                "deletion_requested_at": null,
   272→                "deletion_scheduled_at": null
   273→            }
   274→        """
   275→        profile = await UnifiedProfileRepository.get_profile(user_id)
   276→        if not profile:
   277→            return {}
   278→
   279→        account = profile.get("account", {})
   280→        prefs = profile.get("preferences", {})
   281→
   282→        return {
   283→            "vibe_id": account.get("vibe_id"),
   284→            "display_name": account.get("display_name"),
   285→            "avatar_url": account.get("avatar_url"),
   286→            "tier": account.get("tier", "free"),
   287→            "status": account.get("status", "active"),
   288→            "timezone": prefs.get("timezone", "Asia/Shanghai"),
   289→            "language": prefs.get("language", "zh-CN"),
   290→            "deletion_requested_at": account.get("deletion_requested_at"),
   291→            "deletion_scheduled_at": account.get("deletion_scheduled_at"),
   292→        }
   293→
   294→    # ═══════════════════════════════════════════════════════════════════════════
   295→    # 写入操作
   296→    # ═══════════════════════════════════════════════════════════════════════════
   297→
   298→    @staticmethod
   299→    async def create_profile(user_id: UUID, initial_profile: Dict[str, Any] = None) -> Dict[str, Any]:
   300→        """创建新的 Profile"""
   301→        profile = initial_profile or {
   302→            "account": {},  # Will be synced from vibe_users via trigger
   303→            "birth_info": {},
   304→            "state": {"focus": [], "updated_at": None},
   305→            "life_context": {},
   306→            "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   307→            "skill_data": {}
   308→        }
   309→
   310→        await execute(
   311→            """INSERT INTO unified_profiles (user_id, profile)
   312→               VALUES ($1, $2::jsonb)
   313→               ON CONFLICT (user_id) DO NOTHING""",
   314→            user_id, json.dumps(profile, ensure_ascii=False, default=str)
   315→        )
   316→
   317→        return profile
   318→
   319→    @staticmethod
   320→    async def update_profile(user_id: UUID, updates: Dict[str, Any]) -> None:
   321→        """
   322→        更新 Profile (全量合并更新)
   323→
   324→        Args:
   325→            user_id: 用户 ID
   326→            updates: 要更新的字段，会与现有数据深度合并
   327→        """
   328→        current = await UnifiedProfileRepository.get_profile(user_id)
   329→
   330→        if current:
   331→            merged = deep_merge(current, updates)
   332→            await execute(
   333→                """UPDATE unified_profiles
   334→                   SET profile = $2::jsonb, updated_at = NOW()
   335→                   WHERE user_id = $1""",
   336→                user_id, json.dumps(merged, ensure_ascii=False, default=str)
   337→            )
   338→        else:
   339→            # 不存在则创建
   340→            default_profile = {
   341→                "birth_info": {},
   342→                "life_context": {},
   343→                "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   344→                "skill_data": {}
   345→            }
   346→            merged = deep_merge(default_profile, updates)
   347→            await execute(
   348→                """INSERT INTO unified_profiles (user_id, profile)
   349→                   VALUES ($1, $2::jsonb)""",
   350→                user_id, json.dumps(merged, ensure_ascii=False, default=str)
   351→            )
   352→
   353→        # 失效缓存
   354→        await UnifiedProfileRepository._invalidate_cache(user_id)
   355→
   356→    @staticmethod
   357→    async def update_birth_info(user_id: UUID, birth_info: Dict[str, Any]) -> None:
   358→        """
   359→        更新出生信息 (使用 jsonb_set 局部更新)
   360→
   361→        Args:
   362→            user_id: 用户 ID
   363→            birth_info: 出生信息 {date, time, place, gender, timezone}
   364→        """
   365→        # 确保记录存在
   366→        exists = await fetchval(
   367→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   368→            user_id
   369→        )
   370→
   371→        if exists:
   372→            await execute(
   373→                """UPDATE unified_profiles
   374→                   SET profile = jsonb_set(
   375→                       COALESCE(profile, '{}'::jsonb),
   376→                       '{birth_info}',
   377→                       $2::jsonb
   378→                   ),
   379→                   updated_at = NOW()
   380→                   WHERE user_id = $1""",
   381→                user_id, json.dumps(birth_info, ensure_ascii=False, default=str)
   382→            )
   383→        else:
   384→            await UnifiedProfileRepository.create_profile(user_id, {"birth_info": birth_info})
   385→
   386→        # 失效所有缓存 (birth_info 影响所有 skill)
   387→        await UnifiedProfileRepository._invalidate_cache(user_id)
   388→
   389→    @staticmethod
   390→    async def update_skill_data(user_id: UUID, skill: str, data: Dict[str, Any]) -> None:
   391→        """
   392→        更新 Skill 数据 (使用 jsonb_set 局部更新，避免重写整个 profile)
   393→
   394→        Args:
   395→            user_id: 用户 ID
   396→            skill: Skill 标识 (bazi, zodiac, tarot, career)
   397→            data: Skill 数据 (如命盘数据)
   398→        """
   399→        # 确保记录存在
   400→        exists = await fetchval(
   401→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   402→            user_id
   403→        )
   404→
   405→        if exists:
   406→            # 使用 jsonb_set 进行嵌套路径更新
   407→            # 先确保 skill_data 存在，再设置具体 skill
   408→            await execute(
   409→                """UPDATE unified_profiles
   410→                   SET profile = jsonb_set(
   411→                       jsonb_set(
   412→                           COALESCE(profile, '{}'::jsonb),
   413→                           '{skill_data}',
   414→                           COALESCE(profile -> 'skill_data', '{}'::jsonb)
   415→                       ),
   416→                       ARRAY['skill_data', $2],
   417→                       $3::jsonb
   418→                   ),
   419→                   updated_at = NOW()
   420→                   WHERE user_id = $1""",
   421→                user_id, skill, json.dumps(data, ensure_ascii=False, default=str)
   422→            )
   423→        else:
   424→            await UnifiedProfileRepository.create_profile(user_id, {"skill_data": {skill: data}})
   425→
   426→        # 只失效该 skill 的缓存
   427→        await UnifiedProfileRepository._invalidate_cache(user_id, skill)
   428→
   429→    @staticmethod
   430→    async def update_preferences(user_id: UUID, preferences: Dict[str, Any]) -> None:
   431→        """更新用户偏好 (使用 jsonb_set 局部更新)"""
   432→        exists = await fetchval(
   433→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   434→            user_id
   435→        )
   436→
   437→        if exists:
   438→            # 合并现有偏好
   439→            current_prefs = await UnifiedProfileRepository.get_preferences(user_id)
   440→            merged_prefs = {**current_prefs, **preferences}
   441→
   442→            await execute(
   443→                """UPDATE unified_profiles
   444→                   SET profile = jsonb_set(
   445→                       COALESCE(profile, '{}'::jsonb),
   446→                       '{preferences}',
   447→                       $2::jsonb
   448→                   ),
   449→                   updated_at = NOW()
   450→                   WHERE user_id = $1""",
   451→                user_id, json.dumps(merged_prefs, ensure_ascii=False)
   452→            )
   453→        else:
   454→            await UnifiedProfileRepository.create_profile(user_id, {"preferences": preferences})
   455→
   456→        await UnifiedProfileRepository._invalidate_cache(user_id)
   457→
   458→    @staticmethod
   459→    async def update_account_info(
   460→        user_id: UUID,
   461→        display_name: str = None,
   462→        avatar_url: str = None
   463→    ) -> None:
   464→        """
   465→        更新账户信息 (Migration 022 compatible)
   466→
   467→        Post-Migration 022: display_name 和 avatar_url 只存在于 unified_profiles.profile.account
   468→        不再写入 vibe_users (字段已删除)
   469→
   470→        Args:
   471→            user_id: 用户 ID
   472→            display_name: 显示名称
   473→            avatar_url: 头像 URL
   474→        """
   475→        update_fields = {}
   476→        if display_name is not None:
   477→            update_fields["display_name"] = display_name
   478→        if avatar_url is not None:
   479→            update_fields["avatar_url"] = avatar_url
   480→
   481→        if update_fields:
   482→            # 直接更新 unified_profiles.profile.account
   483→            async with get_connection() as conn:
   484→                # Build JSONB update path
   485→                for key, value in update_fields.items():
   486→                    await conn.execute(
   487→                        """
   488→                        UPDATE unified_profiles
   489→                        SET profile = jsonb_set(
   490→                            COALESCE(profile, '{}'::jsonb),
   491→                            $2,
   492→                            to_jsonb($3::text),
   493→                            true
   494→                        ),
   495→                        updated_at = NOW()
   496→                        WHERE user_id = $1
   497→                        """,
   498→                        user_id,
   499→                        ['account', key],
   500→                        value
   501→                    )
   502→
   503→            # 失效缓存
   504→            await UnifiedProfileRepository._invalidate_cache(user_id)
   505→
   506→    @staticmethod
   507→    async def update_deletion_status(
   508→        user_id: UUID,
   509→        status: str,
   510→        deletion_requested_at: datetime = None,
   511→        deletion_scheduled_at: datetime = None
   512→    ) -> None:
   513→        """
   514→        更新账户删除状态 (Migration 022 compatible)
   515→
   516→        Post-Migration 022:
   517→        - status: 更新 vibe_users.status (触发器自动同步到 unified_profiles)
   518→        - deletion_*: 只存在于 unified_profiles.profile.account
   519→
   520→        Args:
   521→            user_id: 用户 ID
   522→            status: 账户状态 ('active' | 'pending_deletion' | 'deleted')
   523→            deletion_requested_at: 删除请求时间
   524→            deletion_scheduled_at: 计划删除时间
   525→        """
   526→        from .user_repo import UserRepository
   527→
   528→        # Update status in vibe_users (trigger will sync to unified_profiles)
   529→        await UserRepository.update(user_id, status=status)
   530→
   531→        # Update deletion timestamps in unified_profiles (vibe_users doesn't have these fields)
   532→        if deletion_requested_at is not None or deletion_scheduled_at is not None:
   533→            async with get_connection() as conn:
   534→                account_updates = {}
   535→                if deletion_requested_at is not None:
   536→                    account_updates['deletion_requested_at'] = deletion_requested_at.isoformat() if deletion_requested_at else None
   537→                if deletion_scheduled_at is not None:
   538→                    account_updates['deletion_scheduled_at'] = deletion_scheduled_at.isoformat() if deletion_scheduled_at else None
   539→
   540→                # Update unified_profiles.profile.account with deletion timestamps
   541→                for key, value in account_updates.items():
   542→                    await conn.execute(
   543→                        """
   544→                        UPDATE unified_profiles
   545→                        SET profile = jsonb_set(
   546→                            COALESCE(profile, '{}'::jsonb),
   547→                            $2,
   548→                            to_jsonb($3::text),
   549→                            true
   550→                        ),
   551→                        updated_at = NOW()
   552→                        WHERE user_id = $1
   553→                        """,
   554→                        user_id,
   555→                        ['account', key],
   556→                        value
   557→                    )
   558→
   559→        # 失效缓存
   560→        await UnifiedProfileRepository._invalidate_cache(user_id)
   561→
   562→    @staticmethod
   563→    async def update_life_context(user_id: UUID, life_context: Dict[str, Any]) -> None:
   564→        """更新生活上下文 (使用 jsonb_set 局部更新)"""
   565→        exists = await fetchval(
   566→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   567→            user_id
   568→        )
   569→
   570→        if exists:
   571→            # 合并现有上下文
   572→            current_ctx = await UnifiedProfileRepository.get_life_context(user_id)
   573→            merged_ctx = deep_merge(current_ctx, life_context)
   574→
   575→            await execute(
   576→                """UPDATE unified_profiles
   577→                   SET profile = jsonb_set(
   578→                       COALESCE(profile, '{}'::jsonb),
   579→                       '{life_context}',
   580→                       $2::jsonb
   581→                   ),
   582→                   updated_at = NOW()
   583→                   WHERE user_id = $1""",
   584→                user_id, json.dumps(merged_ctx, ensure_ascii=False, default=str)
   585→            )
   586→        else:
   587→            await UnifiedProfileRepository.create_profile(user_id, {"life_context": life_context})
   588→
   589→        await UnifiedProfileRepository._invalidate_cache(user_id)
   590→
   591→    # ═══════════════════════════════════════════════════════════════════════════
   592→    # State 管理 (v7.7 新增)
   593→    # ═══════════════════════════════════════════════════════════════════════════
   594→
   595→    @staticmethod
   596→    async def update_state(user_id: UUID, state: Dict[str, Any]) -> None:
   597→        """
   598→        更新用户状态 (使用 jsonb_set 局部更新)
   599→
   600→        Args:
   601→            user_id: 用户 ID
   602→            state: 状态数据 {focus: [...], updated_at: ...}
   603→        """
   604→        # 自动添加更新时间
   605→        state["updated_at"] = datetime.now(timezone.utc).isoformat()
   606→
   607→        exists = await fetchval(
   608→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   609→            user_id
   610→        )
   611→
   612→        if exists:
   613→            await execute(
   614→                """UPDATE unified_profiles
   615→                   SET profile = jsonb_set(
   616→                       COALESCE(profile, '{}'::jsonb),
   617→                       '{state}',
   618→                       $2::jsonb
   619→                   ),
   620→                   updated_at = NOW()
   621→                   WHERE user_id = $1""",
   622→                user_id, json.dumps(state, ensure_ascii=False, default=str)
   623→            )
   624→        else:
   625→            await UnifiedProfileRepository.create_profile(user_id, {"state": state})
   626→
   627→        await UnifiedProfileRepository._invalidate_cache(user_id)
   628→
   629→    @staticmethod
   630→    async def update_focus(user_id: UUID, focus: List[str]) -> None:
   631→        """
   632→        更新用户关注的话题
   633→
   634→        Args:
   635→            user_id: 用户 ID
   636→            focus: 关注话题列表，如 ["career", "health", "relationship"]
   637→        """
   638→        await UnifiedProfileRepository.update_state(user_id, {"focus": focus})
   639→
   640→    @staticmethod
   641→    async def add_focus(user_id: UUID, topic: str) -> List[str]:
   642→        """
   643→        添加一个关注话题
   644→
   645→        Args:
   646→            user_id: 用户 ID
   647→            topic: 话题名称
   648→
   649→        Returns:
   650→            更新后的 focus 列表
   651→        """
   652→        current_focus = await UnifiedProfileRepository.get_focus(user_id)
   653→        if topic not in current_focus:
   654→            current_focus.append(topic)
   655→            await UnifiedProfileRepository.update_focus(user_id, current_focus)
   656→        return current_focus
   657→
   658→    @staticmethod
   659→    async def remove_focus(user_id: UUID, topic: str) -> List[str]:
   660→        """
   661→        移除一个关注话题
   662→
   663→        Args:
   664→            user_id: 用户 ID
   665→            topic: 话题名称
   666→
   667→        Returns:
   668→            更新后的 focus 列表
   669→        """
   670→        current_focus = await UnifiedProfileRepository.get_focus(user_id)
   671→        if topic in current_focus:
   672→            current_focus.remove(topic)
   673→            await UnifiedProfileRepository.update_focus(user_id, current_focus)
   674→        return current_focus
   675→
   676→    @staticmethod
   677→    async def update_extracted(user_id: UUID, extracted: Dict[str, Any]) -> None:
   678→        """
   679→        更新抽取的用户信息 (使用 jsonb_set 局部更新)
   680→
   681→        Args:
   682→            user_id: 用户 ID
   683→            extracted: 抽取的信息 {facts, concerns, goals, pain_points, life_events, patterns, ...}
   684→        """
   685→        exists = await fetchval(
   686→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   687→            user_id
   688→        )
   689→
   690→        if exists:
   691→            await execute(
   692→                """UPDATE unified_profiles
   693→                   SET profile = jsonb_set(
   694→                       COALESCE(profile, '{}'::jsonb),
   695→                       '{extracted}',
   696→                       $2::jsonb
   697→                   ),
   698→                   updated_at = NOW()
   699→                   WHERE user_id = $1""",
   700→                user_id, json.dumps(extracted, ensure_ascii=False, default=str)
   701→            )
   702→        else:
   703→            await UnifiedProfileRepository.create_profile(user_id, {"extracted": extracted})
   704→
   705→        await UnifiedProfileRepository._invalidate_cache(user_id)
   706→
   707→    @staticmethod
   708→    async def get_extracted(user_id: UUID) -> Dict[str, Any]:
   709→        """获取抽取的用户信息"""
   710→        profile = await UnifiedProfileRepository.get_profile(user_id)
   711→        if profile:
   712→            return profile.get("extracted", {})
   713→        return {}
   714→
   715→    # ═══════════════════════════════════════════════════════════════════════════
   716→    # 删除操作
   717→    # ═══════════════════════════════════════════════════════════════════════════
   718→
   719→    @staticmethod
   720→    async def delete_profile(user_id: UUID) -> bool:
   721→        """删除用户 Profile"""
   722→        result = await execute(
   723→            "DELETE FROM unified_profiles WHERE user_id = $1",
   724→            user_id
   725→        )
   726→        await UnifiedProfileRepository._invalidate_cache(user_id)
   727→        return "DELETE 1" in str(result)
   728→
   729→    # ═══════════════════════════════════════════════════════════════════════════
   730→    # 历史归档
   731→    # ═══════════════════════════════════════════════════════════════════════════
   732→
   733→    @staticmethod
   734→    async def archive_profile(user_id: UUID) -> bool:
   735→        """归档当前 Profile 到历史表"""
   736→        profile = await UnifiedProfileRepository.get_profile(user_id)
   737→        if not profile:
   738→            return False
   739→
   740→        await execute(
   741→            """INSERT INTO unified_profiles_history (user_id, profile)
   742→               VALUES ($1, $2::jsonb)""",
   743→            user_id, json.dumps(profile, ensure_ascii=False, default=str)
   744→        )
   745→        return True
   746→
   747→    @staticmethod
   748→    async def get_profile_history(user_id: UUID, limit: int = 10) -> List[Dict[str, Any]]:
   749→        """获取 Profile 历史记录"""
   750→        rows = await fetch(
   751→            """SELECT profile, archived_at FROM unified_profiles_history
   752→               WHERE user_id = $1
   753→               ORDER BY archived_at DESC
   754→               LIMIT $2""",
   755→            user_id, limit
   756→        )
   757→        return [
   758→            {
   759→                "profile": row["profile"] if isinstance(row["profile"], dict) else json.loads(row["profile"]),
   760→                "archived_at": row["archived_at"]
   761→            }
   762→            for row in rows
   763→        ]
   764→
   765→    # ═══════════════════════════════════════════════════════════════════════════
   766→    # Skill 订阅管理 (v7.6 - 从 SkillSubscriptionRepository 迁移)
   767→    # ═══════════════════════════════════════════════════════════════════════════
   768→
   769→    @staticmethod
   770→    async def get_skill_subscription(user_id: UUID, skill_id: str) -> Optional[SkillSubscription]:
   771→        """获取单个 Skill 订阅状态"""
   772→        profile = await UnifiedProfileRepository.get_profile(user_id)
   773→        if not profile:
   774→            return None
   775→
   776→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   777→        sub_data = subscribed_skills.get(skill_id)
   778→
   779→        if not sub_data:
   780→            return None
   781→
   782→        return SkillSubscription(
   783→            skill_id=skill_id,
   784→            status=sub_data.get("status", "not_subscribed"),
   785→            push_enabled=sub_data.get("push_enabled", False),
   786→            subscribed_at=datetime.fromisoformat(sub_data["subscribed_at"]) if sub_data.get("subscribed_at") else None,
   787→            unsubscribed_at=datetime.fromisoformat(sub_data["unsubscribed_at"]) if sub_data.get("unsubscribed_at") else None,
   788→            trial_messages_used=sub_data.get("trial_messages_used", 0),
   789→        )
   790→
   791→    @staticmethod
   792→    async def get_user_subscriptions(user_id: UUID) -> List[SkillSubscription]:
   793→        """获取用户所有订阅"""
   794→        profile = await UnifiedProfileRepository.get_profile(user_id)
   795→        if not profile:
   796→            return []
   797→
   798→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   799→        subscriptions = []
   800→
   801→        for skill_id, sub_data in subscribed_skills.items():
   802→            subscriptions.append(SkillSubscription(
   803→                skill_id=skill_id,
   804→                status=sub_data.get("status", "not_subscribed"),
   805→                push_enabled=sub_data.get("push_enabled", False),
   806→                subscribed_at=datetime.fromisoformat(sub_data["subscribed_at"]) if sub_data.get("subscribed_at") else None,
   807→                unsubscribed_at=datetime.fromisoformat(sub_data["unsubscribed_at"]) if sub_data.get("unsubscribed_at") else None,
   808→                trial_messages_used=sub_data.get("trial_messages_used", 0),
   809→            ))
   810→
   811→        # 按订阅时间排序 (最新优先)
   812→        subscriptions.sort(key=lambda s: s.subscribed_at or datetime.min, reverse=True)
   813→        return subscriptions
   814→
   815→    @staticmethod
   816→    async def get_subscribed_skill_ids(user_id: UUID) -> List[str]:
   817→        """获取用户已订阅的 Skill ID 列表"""
   818→        profile = await UnifiedProfileRepository.get_profile(user_id)
   819→        if not profile:
   820→            return []
   821→
   822→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   823→        return [
   824→            skill_id for skill_id, sub_data in subscribed_skills.items()
   825→            if sub_data.get("status") == "subscribed"
   826→        ]
   827→
   828→    @staticmethod
   829→    async def subscribe(
   830→        user_id: UUID,
   831→        skill_id: str,
   832→        push_enabled: bool = True
   833→    ) -> SkillSubscription:
   834→        """订阅 Skill"""
   835→        profile = await UnifiedProfileRepository.get_profile(user_id)
   836→        if not profile:
   837→            profile = await UnifiedProfileRepository.create_profile(user_id)
   838→
   839→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   840→        existing = subscribed_skills.get(skill_id, {})
   841→
   842→        now = datetime.now(timezone.utc)
   843→        sub_data = {
   844→            "status": "subscribed",
   845→            "push_enabled": push_enabled,
   846→            "subscribed_at": now.isoformat(),
   847→            "unsubscribed_at": None,
   848→            "trial_messages_used": existing.get("trial_messages_used", 0),
   849→        }
   850→
   851→        subscribed_skills[skill_id] = sub_data
   852→
   853→        # 使用 jsonb_set 更新
   854→        await execute(
   855→            """UPDATE unified_profiles
   856→               SET profile = jsonb_set(
   857→                   jsonb_set(
   858→                       COALESCE(profile, '{}'::jsonb),
   859→                       '{preferences}',
   860→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   861→                   ),
   862→                   '{preferences, subscribed_skills}',
   863→                   $2::jsonb
   864→               ),
   865→               updated_at = NOW()
   866→               WHERE user_id = $1""",
   867→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
   868→        )
   869→
   870→        await UnifiedProfileRepository._invalidate_cache(user_id)
   871→
   872→        return SkillSubscription(
   873→            skill_id=skill_id,
   874→            status="subscribed",
   875→            push_enabled=push_enabled,
   876→            subscribed_at=now,
   877→            unsubscribed_at=None,
   878→            trial_messages_used=existing.get("trial_messages_used", 0),
   879→        )
   880→
   881→    @staticmethod
   882→    async def unsubscribe(user_id: UUID, skill_id: str) -> SkillSubscription:
   883→        """取消订阅 Skill"""
   884→        profile = await UnifiedProfileRepository.get_profile(user_id)
   885→        if not profile:
   886→            return SkillSubscription(
   887→                skill_id=skill_id,
   888→                status="unsubscribed",
   889→                push_enabled=False,
   890→                subscribed_at=None,
   891→                unsubscribed_at=datetime.now(timezone.utc),
   892→                trial_messages_used=0,
   893→            )
   894→
   895→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   896→        existing = subscribed_skills.get(skill_id, {})
   897→
   898→        now = datetime.now(timezone.utc)
   899→        sub_data = {
   900→            "status": "unsubscribed",
   901→            "push_enabled": False,
   902→            "subscribed_at": existing.get("subscribed_at"),
   903→            "unsubscribed_at": now.isoformat(),
   904→            "trial_messages_used": existing.get("trial_messages_used", 0),
   905→        }
   906→
   907→        subscribed_skills[skill_id] = sub_data
   908→
   909→        await execute(
   910→            """UPDATE unified_profiles
   911→               SET profile = jsonb_set(
   912→                   jsonb_set(
   913→                       COALESCE(profile, '{}'::jsonb),
   914→                       '{preferences}',
   915→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   916→                   ),
   917→                   '{preferences, subscribed_skills}',
   918→                   $2::jsonb
   919→               ),
   920→               updated_at = NOW()
   921→               WHERE user_id = $1""",
   922→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
   923→        )
   924→
   925→        await UnifiedProfileRepository._invalidate_cache(user_id)
   926→
   927→        return SkillSubscription(
   928→            skill_id=skill_id,
   929→            status="unsubscribed",
   930→            push_enabled=False,
   931→            subscribed_at=datetime.fromisoformat(existing["subscribed_at"]) if existing.get("subscribed_at") else None,
   932→            unsubscribed_at=now,
   933→            trial_messages_used=existing.get("trial_messages_used", 0),
   934→        )
   935→
   936→    @staticmethod
   937→    async def update_push(
   938→        user_id: UUID,
   939→        skill_id: str,
   940→        enabled: bool
   941→    ) -> Optional[SkillSubscription]:
   942→        """更新推送状态"""
   943→        profile = await UnifiedProfileRepository.get_profile(user_id)
   944→        if not profile:
   945→            return None
   946→
   947→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   948→        existing = subscribed_skills.get(skill_id)
   949→
   950→        if not existing:
   951→            return None
   952→
   953→        existing["push_enabled"] = enabled
   954→        subscribed_skills[skill_id] = existing
   955→
   956→        await execute(
   957→            """UPDATE unified_profiles
   958→               SET profile = jsonb_set(
   959→                   jsonb_set(
   960→                       COALESCE(profile, '{}'::jsonb),
   961→                       '{preferences}',
   962→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   963→                   ),
   964→                   '{preferences, subscribed_skills}',
   965→                   $2::jsonb
   966→               ),
   967→               updated_at = NOW()
   968→               WHERE user_id = $1""",
   969→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
   970→        )
   971→
   972→        await UnifiedProfileRepository._invalidate_cache(user_id)
   973→
   974→        return SkillSubscription(
   975→            skill_id=skill_id,
   976→            status=existing.get("status", "not_subscribed"),
   977→            push_enabled=enabled,
   978→            subscribed_at=datetime.fromisoformat(existing["subscribed_at"]) if existing.get("subscribed_at") else None,
   979→            unsubscribed_at=datetime.fromisoformat(existing["unsubscribed_at"]) if existing.get("unsubscribed_at") else None,
   980→            trial_messages_used=existing.get("trial_messages_used", 0),
   981→        )
   982→
   983→    @staticmethod
   984→    async def is_push_enabled(user_id: UUID, skill_id: str) -> bool:
   985→        """检查推送是否开启"""
   986→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
   987→        if not subscription:
   988→            return False
   989→        return subscription.status == "subscribed" and subscription.push_enabled
   990→
   991→    @staticmethod
   992→    async def get_users_with_push_enabled(skill_id: str) -> List[UUID]:
   993→        """获取某 Skill 开启推送的所有用户 ID"""
   994→        query = """
   995→            SELECT user_id
   996→            FROM unified_profiles
   997→            WHERE profile -> 'preferences' -> 'subscribed_skills' -> $1 ->> 'status' = 'subscribed'
   998→            AND (profile -> 'preferences' -> 'subscribed_skills' -> $1 ->> 'push_enabled')::boolean = true
   999→        """
  1000→        rows = await fetch(query, skill_id)
  1001→        return [row["user_id"] for row in rows]
  1002→
  1003→    @staticmethod
  1004→    async def increment_trial_usage(user_id: UUID, skill_id: str) -> int:
  1005→        """增加试用次数，返回新的使用次数"""
  1006→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1007→        if not profile:
  1008→            profile = await UnifiedProfileRepository.create_profile(user_id)
  1009→
  1010→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
  1011→        existing = subscribed_skills.get(skill_id, {
  1012→            "status": "not_subscribed",
  1013→            "push_enabled": False,
  1014→            "subscribed_at": None,
  1015→            "unsubscribed_at": None,
  1016→            "trial_messages_used": 0,
  1017→        })
  1018→
  1019→        existing["trial_messages_used"] = existing.get("trial_messages_used", 0) + 1
  1020→        subscribed_skills[skill_id] = existing
  1021→
  1022→        await execute(
  1023→            """UPDATE unified_profiles
  1024→               SET profile = jsonb_set(
  1025→                   jsonb_set(
  1026→                       COALESCE(profile, '{}'::jsonb),
  1027→                       '{preferences}',
  1028→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
  1029→                   ),
  1030→                   '{preferences, subscribed_skills}',
  1031→                   $2::jsonb
  1032→               ),
  1033→               updated_at = NOW()
  1034→               WHERE user_id = $1""",
  1035→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
  1036→        )
  1037→
  1038→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1039→        return existing["trial_messages_used"]
  1040→
  1041→    @staticmethod
  1042→    async def get_trial_usage(user_id: UUID, skill_id: str) -> int:
  1043→        """获取试用次数"""
  1044→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
  1045→        return subscription.trial_messages_used if subscription else 0
  1046→
  1047→    @staticmethod
  1048→    async def is_subscribed(user_id: UUID, skill_id: str) -> bool:
  1049→        """检查是否已订阅"""
  1050→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
  1051→        return subscription is not None and subscription.status == "subscribed"
  1052→
  1053→    @staticmethod
  1054→    async def can_use_skill(
  1055→        user_id: UUID,
  1056→        skill_id: str,
  1057→        skill_category: str,
  1058→        trial_limit: int = 3
  1059→    ) -> tuple:
  1060→        """
  1061→        检查用户是否可以使用 Skill
  1062→
  1063→        Returns:
  1064→            (can_use, reason)
  1065→            - (True, "subscribed") - 已订阅
  1066→            - (True, "default") - 默认 Skill
  1067→            - (True, "core") - Core Skill
  1068→            - (True, "trial") - 试用中
  1069→            - (False, "trial_exhausted") - 试用次数用完
  1070→            - (False, "not_subscribed") - 未订阅
  1071→        """
  1072→        # Core Skill 始终可用
  1073→        if skill_category == "core":
  1074→            return True, "core"
  1075→
  1076→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
  1077→
  1078→        # Default Skill: 如果没有订阅记录或已订阅，则可用
  1079→        if skill_category == "default":
  1080→            if not subscription or subscription.status == "subscribed":
  1081→                return True, "default"
  1082→            return False, "unsubscribed"
  1083→
  1084→        # Professional Skill: 需要订阅或在试用期内
  1085→        if subscription and subscription.status == "subscribed":
  1086→            return True, "subscribed"
  1087→
  1088→        # 检查试用
  1089→        trial_used = subscription.trial_messages_used if subscription else 0
  1090→        if trial_used < trial_limit:
  1091→            return True, "trial"
  1092→
  1093→        return False, "trial_exhausted"
  1094→
  1095→    # ═══════════════════════════════════════════════════════════════════════════
  1096→    # 推送偏好管理 (v7.6 - 从 UserPushPreferencesRepository 迁移)
  1097→    # ═══════════════════════════════════════════════════════════════════════════
  1098→
  1099→    @staticmethod
  1100→    async def get_push_settings(user_id: UUID) -> Optional[UserPushPreferences]:
  1101→        """获取用户推送偏好"""
  1102→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1103→        if not profile:
  1104→            return None
  1105→
  1106→        push_settings = profile.get("preferences", {}).get("push_settings", {})
  1107→        if not push_settings:
  1108→            return None
  1109→
  1110→        return UserPushPreferences(
  1111→            user_id=user_id,
  1112→            default_push_hour=push_settings.get("default_push_hour", 8),
  1113→            max_daily_pushes=push_settings.get("max_daily_pushes", 5),
  1114→            quiet_start_hour=push_settings.get("quiet_start_hour", 22),
  1115→            quiet_end_hour=push_settings.get("quiet_end_hour", 7),
  1116→        )
  1117→
  1118→    @staticmethod
  1119→    async def upsert_push_settings(
  1120→        user_id: UUID,
  1121→        default_push_hour: Optional[int] = None,
  1122→        max_daily_pushes: Optional[int] = None,
  1123→        quiet_start_hour: Optional[int] = None,
  1124→        quiet_end_hour: Optional[int] = None,
  1125→    ) -> UserPushPreferences:
  1126→        """创建或更新用户推送偏好"""
  1127→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1128→        if not profile:
  1129→            profile = await UnifiedProfileRepository.create_profile(user_id)
  1130→
  1131→        current_settings = profile.get("preferences", {}).get("push_settings", {})
  1132→        push_settings = {
  1133→            "default_push_hour": default_push_hour if default_push_hour is not None else current_settings.get("default_push_hour", 8),
  1134→            "max_daily_pushes": max_daily_pushes if max_daily_pushes is not None else current_settings.get("max_daily_pushes", 5),
  1135→            "quiet_start_hour": quiet_start_hour if quiet_start_hour is not None else current_settings.get("quiet_start_hour", 22),
  1136→            "quiet_end_hour": quiet_end_hour if quiet_end_hour is not None else current_settings.get("quiet_end_hour", 7),
  1137→        }
  1138→
  1139→        await execute(
  1140→            """UPDATE unified_profiles
  1141→               SET profile = jsonb_set(
  1142→                   jsonb_set(
  1143→                       COALESCE(profile, '{}'::jsonb),
  1144→                       '{preferences}',
  1145→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
  1146→                   ),
  1147→                   '{preferences, push_settings}',
  1148→                   $2::jsonb
  1149→               ),
  1150→               updated_at = NOW()
  1151→               WHERE user_id = $1""",
  1152→            user_id, json.dumps(push_settings, ensure_ascii=False)
  1153→        )
  1154→
  1155→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1156→
  1157→        return UserPushPreferences(
  1158→            user_id=user_id,
  1159→            default_push_hour=push_settings["default_push_hour"],
  1160→            max_daily_pushes=push_settings["max_daily_pushes"],
  1161→            quiet_start_hour=push_settings["quiet_start_hour"],
  1162→            quiet_end_hour=push_settings["quiet_end_hour"],
  1163→        )
  1164→
  1165→    @staticmethod
  1166→    async def get_push_hour(user_id: UUID, skill_id: Optional[str] = None) -> int:
  1167→        """
  1168→        获取用户的推送时间
  1169→
  1170→        优先级:
  1171→        1. 用户全局偏好 (preferences.push_settings.default_push_hour)
  1172→        2. 系统默认值 (8)
  1173→        """
  1174→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1175→        if profile:
  1176→            push_settings = profile.get("preferences", {}).get("push_settings", {})
  1177→            if "default_push_hour" in push_settings:
  1178→                return push_settings["default_push_hour"]
  1179→        return 8
  1180→
  1181→    @staticmethod
  1182→    async def is_in_quiet_hours(user_id: UUID, current_hour: int) -> bool:
  1183→        """检查当前是否在用户的静默时段"""
  1184→        prefs = await UnifiedProfileRepository.get_push_settings(user_id)
  1185→        if not prefs:
  1186→            # 默认静默时段 22:00 - 07:00
  1187→            return current_hour >= 22 or current_hour < 7
  1188→
  1189→        start = prefs.quiet_start_hour
  1190→        end = prefs.quiet_end_hour
  1191→
  1192→        # 处理跨午夜的情况
  1193→        if start > end:
  1194→            return current_hour >= start or current_hour < end
  1195→        else:
  1196→            return start <= current_hour < end
  1197→
  1198→    # ═══════════════════════════════════════════════════════════════════════════
  1199→    # Skill 推荐屏蔽 (v7.6 - 从 SkillRecommendationBlockRepository 迁移)
  1200→    # ═══════════════════════════════════════════════════════════════════════════
  1201→
  1202→    @staticmethod
  1203→    async def get_blocked_skills(user_id: UUID) -> List[str]:
  1204→        """获取用户屏蔽的 Skill 列表"""
  1205→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1206→        if not profile:
  1207→            return []
  1208→        return profile.get("preferences", {}).get("blocked_skills", [])
  1209→
  1210→    @staticmethod
  1211→    async def block_skill(user_id: UUID, skill_id: str) -> None:
  1212→        """屏蔽 Skill 推荐"""
  1213→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1214→        if not profile:
  1215→            profile = await UnifiedProfileRepository.create_profile(user_id)
  1216→
  1217→        blocked_skills = profile.get("preferences", {}).get("blocked_skills", [])
  1218→        if skill_id not in blocked_skills:
  1219→            blocked_skills.append(skill_id)
  1220→
  1221→        await execute(
  1222→            """UPDATE unified_profiles
  1223→               SET profile = jsonb_set(
  1224→                   jsonb_set(
  1225→                       COALESCE(profile, '{}'::jsonb),
  1226→                       '{preferences}',
  1227→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
  1228→                   ),
  1229→                   '{preferences, blocked_skills}',
  1230→                   $2::jsonb
  1231→               ),
  1232→               updated_at = NOW()
  1233→               WHERE user_id = $1""",
  1234→            user_id, json.dumps(blocked_skills, ensure_ascii=False)
  1235→        )
  1236→
  1237→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1238→
  1239→    @staticmethod
  1240→    async def unblock_skill(user_id: UUID, skill_id: str) -> None:
  1241→        """取消屏蔽 Skill 推荐"""
  1242→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1243→        if not profile:
  1244→            return
  1245→
  1246→        blocked_skills = profile.get("preferences", {}).get("blocked_skills", [])
  1247→        if skill_id in blocked_skills:
  1248→            blocked_skills.remove(skill_id)
  1249→
  1250→        await execute(
  1251→            """UPDATE unified_profiles
  1252→               SET profile = jsonb_set(
  1253→                   jsonb_set(
  1254→                       COALESCE(profile, '{}'::jsonb),
  1255→                       '{preferences}',
  1256→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
  1257→                   ),
  1258→                   '{preferences, blocked_skills}',
  1259→                   $2::jsonb
  1260→               ),
  1261→               updated_at = NOW()
  1262→               WHERE user_id = $1""",
  1263→            user_id, json.dumps(blocked_skills, ensure_ascii=False)
  1264→        )
  1265→
  1266→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1267→
  1268→    @staticmethod
  1269→    async def is_skill_blocked(user_id: UUID, skill_id: str) -> bool:
  1270→        """检查 Skill 是否被屏蔽"""
  1271→        blocked_skills = await UnifiedProfileRepository.get_blocked_skills(user_id)
  1272→        return skill_id in blocked_skills
  1273→
  1274→    # ═══════════════════════════════════════════════════════════════════════════
  1275→    # 生活上下文路径操作 (v7.6 - 替代 UserDataService)
  1276→    # ═══════════════════════════════════════════════════════════════════════════
  1277→
  1278→    @staticmethod
  1279→    async def read_life_context_path(user_id: UUID, path: str) -> Optional[LifeContextData]:
  1280→        """
  1281→        读取生活上下文的指定路径
  1282→
  1283→        Args:
  1284→            user_id: 用户 ID
  1285→            path: 虚拟路径，如 "goals/2026/year"
  1286→
  1287→        Returns:
  1288→            LifeContextData 对象，不存在返回 None
  1289→        """
  1290→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1291→        if not profile:
  1292→            return None
  1293→
  1294→        life_context = profile.get("life_context", {})
  1295→        paths = life_context.get("_paths", {})
  1296→        path_data = paths.get(path)
  1297→
  1298→        if not path_data:
  1299→            return None
  1300→
  1301→        return LifeContextData(
  1302→            path=path,
  1303→            content=path_data.get("content", {}),
  1304→            version=path_data.get("version", 1),
  1305→            updated_at=datetime.fromisoformat(path_data["updated_at"]) if path_data.get("updated_at") else None,
  1306→        )
  1307→
  1308→    @staticmethod
  1309→    async def write_life_context_path(
  1310→        user_id: UUID,
  1311→        path: str,
  1312→        content: Dict[str, Any],
  1313→        expected_version: Optional[int] = None,
  1314→    ) -> LifeContextData:
  1315→        """
  1316→        写入生活上下文的指定路径
  1317→
  1318→        Args:
  1319→            user_id: 用户 ID
  1320→            path: 虚拟路径
  1321→            content: JSON 内容
  1322→            expected_version: 期望版本号（乐观锁）
  1323→
  1324→        Returns:
  1325→            更新后的 LifeContextData 对象
  1326→        """
  1327→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1328→        if not profile:
  1329→            profile = await UnifiedProfileRepository.create_profile(user_id)
  1330→
  1331→        life_context = profile.get("life_context", {})
  1332→        paths = life_context.get("_paths", {})
  1333→        existing = paths.get(path, {})
  1334→
  1335→        # 检查版本冲突
  1336→        if expected_version is not None:
  1337→            current_version = existing.get("version", 0)
  1338→            if current_version != expected_version:
  1339→                raise ValueError(f"Version conflict: expected {expected_version}, got {current_version}")
  1340→
  1341→        now = datetime.now(timezone.utc)
  1342→        new_version = existing.get("version", 0) + 1
  1343→
  1344→        paths[path] = {
  1345→            "content": content,
  1346→            "version": new_version,
  1347→            "updated_at": now.isoformat(),
  1348→        }
  1349→
  1350→        life_context["_paths"] = paths
  1351→
  1352→        await execute(
  1353→            """UPDATE unified_profiles
  1354→               SET profile = jsonb_set(
  1355→                   COALESCE(profile, '{}'::jsonb),
  1356→                   '{life_context}',
  1357→                   $2::jsonb
  1358→               ),
  1359→               updated_at = NOW()
  1360→               WHERE user_id = $1""",
  1361→            user_id, json.dumps(life_context, ensure_ascii=False, default=str)
  1362→        )
  1363→
  1364→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1365→
  1366→        return LifeContextData(
  1367→            path=path,
  1368→            content=content,
  1369→            version=new_version,
  1370→            updated_at=now,
  1371→        )
  1372→
  1373→    @staticmethod
  1374→    async def delete_life_context_path(user_id: UUID, path: str) -> bool:
  1375→        """删除生活上下文的指定路径"""
  1376→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1377→        if not profile:
  1378→            return False
  1379→
  1380→        life_context = profile.get("life_context", {})
  1381→        paths = life_context.get("_paths", {})
  1382→
  1383→        if path not in paths:
  1384→            return False
  1385→
  1386→        del paths[path]
  1387→        life_context["_paths"] = paths
  1388→
  1389→        await execute(
  1390→            """UPDATE unified_profiles
  1391→               SET profile = jsonb_set(
  1392→                   COALESCE(profile, '{}'::jsonb),
  1393→                   '{life_context}',
  1394→                   $2::jsonb
  1395→               ),
  1396→               updated_at = NOW()
  1397→               WHERE user_id = $1""",
  1398→            user_id, json.dumps(life_context, ensure_ascii=False, default=str)
  1399→        )
  1400→
  1401→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1402→        return True
  1403→
  1404→    @staticmethod
  1405→    async def query_life_context(
  1406→        user_id: UUID,
  1407→        path_prefix: Optional[str] = None,
  1408→        limit: int = 100,
  1409→    ) -> List[LifeContextData]:
  1410→        """查询生活上下文"""
  1411→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1412→        if not profile:
  1413→            return []
  1414→
  1415→        life_context = profile.get("life_context", {})
  1416→        paths = life_context.get("_paths", {})
  1417→
  1418→        results = []
  1419→        for path, path_data in paths.items():
  1420→            if path_prefix and not path.startswith(path_prefix):
  1421→                continue
  1422→
  1423→            results.append(LifeContextData(
  1424→                path=path,
  1425→                content=path_data.get("content", {}),
  1426→                version=path_data.get("version", 1),
  1427→                updated_at=datetime.fromisoformat(path_data["updated_at"]) if path_data.get("updated_at") else None,
  1428→            ))
  1429→
  1430→            if len(results) >= limit:
  1431→                break
  1432→
  1433→        # 按更新时间排序
  1434→        results.sort(key=lambda x: x.updated_at or datetime.min, reverse=True)
  1435→        return results
  1436→
  1437→    @staticmethod
  1438→    async def list_life_context_paths(
  1439→        user_id: UUID,
  1440→        path_prefix: Optional[str] = None,
  1441→    ) -> List[str]:
  1442→        """列出生活上下文的所有路径"""
  1443→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1444→        if not profile:
  1445→            return []
  1446→
  1447→        life_context = profile.get("life_context", {})
  1448→        paths = life_context.get("_paths", {})
  1449→
  1450→        result = []
  1451→        for path in paths.keys():
  1452→            if path_prefix and not path.startswith(path_prefix):
  1453→                continue
  1454→            result.append(path)
  1455→
  1456→        result.sort()
  1457→        return result
  1458→
  1459→    # ═══════════════════════════════════════════════════════════════════════════
  1460→    # Skill 状态管理 - REFACTOR_PLAN.md Phase 1
  1461→    # ═══════════════════════════════════════════════════════════════════════════
  1462→
  1463→    @staticmethod
  1464→    async def get_skill_state(user_id: UUID, skill_id: str) -> Dict[str, Any]:
  1465→        """
  1466→        获取 Skill 状态
  1467→
  1468→        按照 REFACTOR_PLAN.md，所有 Skill 数据统一存储在 profile.skills.{skill_id}
  1469→
  1470→        Returns:
  1471→            skill 状态数据，如果不存在则返回空字典
  1472→        """
  1473→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1474→        if not profile:
  1475→            return {}
  1476→        return profile.get("skills", {}).get(skill_id, {})
  1477→
  1478→    @staticmethod
  1479→    async def update_skill_state(
  1480→        user_id: UUID,
  1481→        skill_id: str,
  1482→        section: str,
  1483→        data: Dict[str, Any]
  1484→    ) -> None:
  1485→        """
  1486→        更新 Skill 状态（深度合并）
  1487→
  1488→        使用 PostgreSQL || 操作符进行深度合并，不会覆盖未指定的字段
  1489→
  1490→        Args:
  1491→            user_id: 用户 ID
  1492→            skill_id: Skill ID
  1493→            section: 要更新的部分，如 "north_star"、"protocol"
  1494→            data: 要写入的数据
  1495→        """
  1496→        exists = await fetchval(
  1497→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
  1498→            user_id
  1499→        )
  1500→
  1501→        if exists:
  1502→            # 使用 jsonb_set + || 进行深度合并
  1503→            await execute(
  1504→                """UPDATE unified_profiles
  1505→                   SET profile = jsonb_set(
  1506→                       jsonb_set(
  1507→                           jsonb_set(
  1508→                               COALESCE(profile, '{}'::jsonb),
  1509→                               '{skills}',
  1510→                               COALESCE(profile -> 'skills', '{}'::jsonb)
  1511→                           ),
  1512→                           ARRAY['skills', $2::text],
  1513→                           COALESCE(profile -> 'skills' -> $2::text, '{}'::jsonb)
  1514→                       ),
  1515→                       ARRAY['skills', $2::text, $3::text],
  1516→                       COALESCE(profile -> 'skills' -> $2::text -> $3::text, '{}'::jsonb) || $4::jsonb
  1517→                   ),
  1518→                   updated_at = NOW()
  1519→                   WHERE user_id = $1""",
  1520→                user_id, skill_id, section, json.dumps(data, ensure_ascii=False, default=str)
  1521→            )
  1522→        else:
  1523→            # 创建新 profile
  1524→            await UnifiedProfileRepository.create_profile(
  1525→                user_id,
  1526→                {"skills": {skill_id: {section: data}}}
  1527→            )
  1528→
  1529→        # 失效缓存
  1530→        await UnifiedProfileRepository._invalidate_cache(user_id, skill_id)
  1531→
  1532→    @staticmethod
  1533→    async def append_to_skill_list(
  1534→        user_id: UUID,
  1535→        skill_id: str,
  1536→        path: str,
  1537→        entry: Dict[str, Any],
  1538→        max_items: int = 100
  1539→    ) -> None:
  1540→        """
  1541→        向 Skill 数据中的列表追加条目
  1542→
  1543→        Args:
  1544→            user_id: 用户 ID
  1545→            skill_id: Skill ID
  1546→            path: 列表路径，如 "journal" 或 "progress.milestones"
  1547→            entry: 要追加的条目
  1548→            max_items: 列表最大长度（超出则删除最旧的）
  1549→        """
  1550→        # 获取当前数据
  1551→        skill_data = await UnifiedProfileRepository.get_skill_state(user_id, skill_id)
  1552→
  1553→        # 解析路径
  1554→        parts = path.split(".")
  1555→        current = skill_data
  1556→        for part in parts[:-1]:
  1557→            current = current.setdefault(part, {})
  1558→
  1559→        # 获取或创建列表
  1560→        list_key = parts[-1]
  1561→        current_list = current.get(list_key, [])
  1562→        if not isinstance(current_list, list):
  1563→            current_list = []
  1564→
  1565→        # 追加并限制长度（新条目在前）
  1566→        current_list = [entry] + current_list[:max_items - 1]
  1567→        current[list_key] = current_list
  1568→
  1569→        # 写回
  1570→        if len(parts) > 1:
  1571→            # 多级路径：更新父级对象
  1572→            await UnifiedProfileRepository.update_skill_state(
  1573→                user_id, skill_id, parts[0], skill_data.get(parts[0], {})
  1574→            )
  1575→        else:
  1576→            # 单级路径：直接更新
  1577→            await UnifiedProfileRepository.update_skill_state(
  1578→                user_id, skill_id, list_key, current_list
  1579→            )
  1580→
  1581→    # ═══════════════════════════════════════════════════════════════════════════
  1582→    # 缓存管理
  1583→    # ═══════════════════════════════════════════════════════════════════════════
  1584→
  1585→    @staticmethod
  1586→    async def _invalidate_cache(user_id: UUID, skill: str = None) -> None:
  1587→        """
  1588→        失效缓存
  1589→
  1590→        Args:
  1591→            user_id: 用户 ID
  1592→            skill: 如果指定，只失效该 skill 的缓存；否则失效所有缓存
  1593→        """
  1594→        try:
  1595→            from stores.profile_cache import get_profile_cache
  1596→            cache = get_profile_cache()
  1597→
  1598→            if skill:
  1599→                # 只失效特定 skill 的缓存
  1600→                await cache.invalidate_by_key(f"{user_id}:{skill}")
  1601→                # 也失效 all 缓存
  1602→                await cache.invalidate_by_key(f"{user_id}:all")
  1603→            else:
  1604→                # 失效该用户所有缓存
  1605→                await cache.invalidate_by_prefix(str(user_id))
  1606→
  1607→            logger.debug(f"缓存已失效: user_id={user_id}, skill={skill}")
  1608→        except Exception as e:
  1609→            logger.warning(f"缓存失效失败: {e}")
  1610→
  1611→
  1612→# ═══════════════════════════════════════════════════════════════════════════
  1613→# Cold Layer - Insights & Timeline (v8)
  1614→# ═══════════════════════════════════════════════════════════════════════════
  1615→
  1616→@dataclass
  1617→class ProfileInsight:
  1618→    """AI 生成的洞察"""
  1619→    id: UUID
  1620→    user_id: UUID
  1621→    insight_type: str  # discovery | pattern | timing | growth
  1622→    skill_id: Optional[str]
  1623→    content: str
  1624→    metadata: Dict[str, Any]
  1625→    created_at: datetime
  1626→
  1627→
  1628→@dataclass
  1629→class TimelineEvent:
  1630→    """时间线事件"""
  1631→    id: UUID
  1632→    user_id: UUID
  1633→    event_type: str  # dayun_change | goal_completed | milestone | life_event
  1634→    event_date: date
  1635→    title: str
  1636→    data: Dict[str, Any]
  1637→    skill_id: Optional[str]
  1638→    created_at: datetime
  1639→
  1640→
  1641→class ColdLayerRepository:
  1642→    """Cold Layer 数据仓库 - 存储长期洞察和时间线事件"""
  1643→
  1644→    @staticmethod
  1645→    async def add_insight(
  1646→        user_id: UUID,
  1647→        insight_type: str,
  1648→        content: str,
  1649→        skill_id: Optional[str] = None,
  1650→        metadata: Optional[Dict[str, Any]] = None
  1651→    ) -> ProfileInsight:
  1652→        """添加 AI 洞察"""
  1653→        from uuid import uuid4
  1654→        insight_id = uuid4()
  1655→
  1656→        await execute(
  1657→            """INSERT INTO vibe_profile_insights (id, user_id, insight_type, skill_id, content, metadata)
  1658→               VALUES ($1, $2, $3, $4, $5, $6::jsonb)""",
  1659→            insight_id, user_id, insight_type, skill_id, content,
  1660→            json.dumps(metadata or {}, ensure_ascii=False)
  1661→        )
  1662→
  1663→        return ProfileInsight(
  1664→            id=insight_id,
  1665→            user_id=user_id,
  1666→            insight_type=insight_type,
  1667→            skill_id=skill_id,
  1668→            content=content,
  1669→            metadata=metadata or {},
  1670→            created_at=datetime.now(timezone.utc)
  1671→        )
  1672→
  1673→    @staticmethod
  1674→    async def get_insights(
  1675→        user_id: UUID,
  1676→        insight_type: Optional[str] = None,
  1677→        skill_id: Optional[str] = None,
  1678→        limit: int = 20
  1679→    ) -> List[ProfileInsight]:
  1680→        """获取用户洞察"""
  1681→        conditions = ["user_id = $1"]
  1682→        params = [user_id]
  1683→        param_idx = 2
  1684→
  1685→        if insight_type:
  1686→            conditions.append(f"insight_type = ${param_idx}")
  1687→            params.append(insight_type)
  1688→            param_idx += 1
  1689→
  1690→        if skill_id:
  1691→            conditions.append(f"skill_id = ${param_idx}")
  1692→            params.append(skill_id)
  1693→            param_idx += 1
  1694→
  1695→        params.append(limit)
  1696→
  1697→        rows = await fetch(
  1698→            f"""SELECT id, user_id, insight_type, skill_id, content, metadata, created_at
  1699→               FROM vibe_profile_insights
  1700→               WHERE {' AND '.join(conditions)}
  1701→               ORDER BY created_at DESC
  1702→               LIMIT ${param_idx}""",
  1703→            *params
  1704→        )
  1705→
  1706→        return [
  1707→            ProfileInsight(
  1708→                id=row["id"],
  1709→                user_id=row["user_id"],
  1710→                insight_type=row["insight_type"],
  1711→                skill_id=row["skill_id"],
  1712→                content=row["content"],
  1713→                metadata=row["metadata"] if isinstance(row["metadata"], dict) else json.loads(row["metadata"] or "{}"),
  1714→                created_at=row["created_at"]
  1715→            )
  1716→            for row in rows
  1717→        ]
  1718→
  1719→    @staticmethod
  1720→    async def add_timeline_event(
  1721→        user_id: UUID,
  1722→        event_type: str,
  1723→        event_date: date,
  1724→        title: str,
  1725→        data: Optional[Dict[str, Any]] = None,
  1726→        skill_id: Optional[str] = None
  1727→    ) -> TimelineEvent:
  1728→        """添加时间线事件"""
  1729→        from uuid import uuid4
  1730→        event_id = uuid4()
  1731→
  1732→        await execute(
  1733→            """INSERT INTO vibe_profile_timeline (id, user_id, event_type, event_date, title, data, skill_id)
  1734→               VALUES ($1, $2, $3, $4, $5, $6::jsonb, $7)""",
  1735→            event_id, user_id, event_type, event_date, title,
  1736→            json.dumps(data or {}, ensure_ascii=False), skill_id
  1737→        )
  1738→
  1739→        return TimelineEvent(
  1740→            id=event_id,
  1741→            user_id=user_id,
  1742→            event_type=event_type,
  1743→            event_date=event_date,
  1744→            title=title,
  1745→            data=data or {},
  1746→            skill_id=skill_id,
  1747→            created_at=datetime.now(timezone.utc)
  1748→        )
  1749→
  1750→    @staticmethod
  1751→    async def get_timeline(
  1752→        user_id: UUID,
  1753→        event_type: Optional[str] = None,
  1754→        start_date: Optional[date] = None,
  1755→        end_date: Optional[date] = None,
  1756→        limit: int = 50
  1757→    ) -> List[TimelineEvent]:
  1758→        """获取时间线事件"""
  1759→        conditions = ["user_id = $1"]
  1760→        params = [user_id]
  1761→        param_idx = 2
  1762→
  1763→        if event_type:
  1764→            conditions.append(f"event_type = ${param_idx}")
  1765→            params.append(event_type)
  1766→            param_idx += 1
  1767→
  1768→        if start_date:
  1769→            conditions.append(f"event_date >= ${param_idx}")
  1770→            params.append(start_date)
  1771→            param_idx += 1
  1772→
  1773→        if end_date:
  1774→            conditions.append(f"event_date <= ${param_idx}")
  1775→            params.append(end_date)
  1776→            param_idx += 1
  1777→
  1778→        params.append(limit)
  1779→
  1780→        rows = await fetch(
  1781→            f"""SELECT id, user_id, event_type, event_date, title, data, skill_id, created_at
  1782→               FROM vibe_profile_timeline
  1783→               WHERE {' AND '.join(conditions)}
  1784→               ORDER BY event_date DESC
  1785→               LIMIT ${param_idx}""",
  1786→            *params
  1787→        )
  1788→
  1789→        return [
  1790→            TimelineEvent(
  1791→                id=row["id"],
  1792→                user_id=row["user_id"],
  1793→                event_type=row["event_type"],
  1794→                event_date=row["event_date"],
  1795→                title=row["title"],
  1796→                data=row["data"] if isinstance(row["data"], dict) else json.loads(row["data"] or "{}"),
  1797→                skill_id=row["skill_id"],
  1798→                created_at=row["created_at"]
  1799→            )
  1800→            for row in rows
  1801→        ]
  1802→
  1803→
  1804→# ═══════════════════════════════════════════════════════════════════════════
  1805→# 便捷函数 (兼容旧代码)
  1806→# ═══════════════════════════════════════════════════════════════════════════
  1807→
  1808→async def get_unified_profile(user_id: UUID) -> Optional[Dict[str, Any]]:
  1809→    """获取统一 Profile (便捷函数)"""
  1810→    return await UnifiedProfileRepository.get_profile(user_id)
  1811→
  1812→
  1813→async def get_unified_profile_with_skill(user_id: UUID, skill: str = None) -> Dict[str, Any]:
  1814→    """
  1815→    获取 Profile 和 Skill 数据 (兼容 profile_cache 接口)
  1816→
  1817→    Returns:
  1818→        {
  1819→            "profile": {...},
  1820→            "skill_data": {...}
  1821→        }
  1822→    """
  1823→    profile = await UnifiedProfileRepository.get_profile(user_id)
  1824→
  1825→    if profile:
  1826→        skill_data = profile.get("skill_data", {})
  1827→        return {
  1828→            "profile": profile,
  1829→            "skill_data": skill_data
  1830→        }
  1831→
  1832→    return {"profile": {}, "skill_data": {}}
  1833→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
