     1→"""
     2→Agent Framework - V6 Architecture
     3→CoreAgent with LLM-based skill selection (Claude Agent SDK style)
     4→
     5→V6 Changes:
     6→- CoreAgent replaces Orchestrator + SkillAgents
     7→- LLM-based skill selection (no keyword matching)
     8→- SkillLoader loads SKILL.md files
     9→- Unified tool schema from YAML
    10→- SOP state persistence with Redis
    11→- Skill validation for CI
    12→"""
    13→
    14→# Core Agent
    15→from .core import CoreAgent, AgentContext, AgentEvent, AgentState, create_agent
    16→from .skill_loader import load_skill, build_system_prompt, get_available_skills, SkillConfig
    17→from .subagent import SkillSubAgent
    18→
    19→# Tier limits (简化版，完整配额管理使用 model_router.quota)
    20→TIER_LIMITS = {
    21→    "free": {"calls": 50, "tokens": 100000},
    22→    "paid": {"calls": 500, "tokens": 1000000},
    23→    "vip": {"calls": -1, "tokens": -1},
    24→}
    25→
    26→
    27→class QuotaTracker:
    28→    """简化配额追踪 - 委托到 UsageService"""
    29→
    30→    @classmethod
    31→    async def check(cls, user_id: str, tier: str):
    32→        """检查配额"""
    33→        if tier == "vip":
    34→            return True, ""
    35→
    36→        from services.usage import UsageService
    37→        from uuid import UUID
    38→
    39→        try:
    40→            usage = await UsageService.get_monthly_usage(UUID(user_id))
    41→            limits = TIER_LIMITS.get(tier, TIER_LIMITS["free"])
    42→
    43→            if limits["calls"] > 0 and usage["llm_calls"] >= limits["calls"]:
    44→                return False, "本月对话次数已用完"
    45→            return True, ""
    46→        except Exception:
    47→            return True, ""
    48→
    49→    @classmethod
    50→    async def record(cls, user_id: str, usage: dict):
    51→        """记录用量 - 已由 UsageService 处理"""
    52→        pass
    53→
    54→# Stream Adapters
    55→from .stream_adapter import (
    56→    BaseStreamAdapter,
    57→    AISDKv6Adapter,
    58→    LegacySSEAdapter,
    59→    StreamConfig,
    60→    get_adapter,
    61→)
    62→
    63→# V6 新增: 统一工具定义
    64→from .tool_schema import (
    65→    ToolDef,
    66→    ToolParam,
    67→    load_skill_tools,
    68→    get_skill_tools_openai,
    69→    get_global_tools_openai,
    70→    get_all_tools_for_skill,
    71→    get_tool_card_type,
    72→)
    73→
    74→# V6 新增: 统一工具注册表
    75→from .tool_registry import (
    76→    ToolRegistry,
    77→    ToolContext,
    78→    tool_handler,
    79→)
    80→
    81→# V6 新增: SOP 状态持久化
    82→from .sop_state import (
    83→    SOPState,
    84→    SOPStateManager,
    85→    SOPPhase,  # v7.2: 从 sop_state 导出，sop_engine 已删除
    86→    get_sop_manager,
    87→)
    88→
    89→# V6 新增: Skill 校验
    90→from .skill_validator import (
    91→    validate_skill,
    92→    validate_all_skills,
    93→    ValidationResult,
    94→    ValidationError,
    95→)
    96→
    97→__all__ = [
    98→    # Core Agent
    99→    "CoreAgent",
   100→    "AgentContext",
   101→    "AgentEvent",
   102→    "AgentState",
   103→    "SkillConfig",
   104→    "SkillSubAgent",
   105→    "QuotaTracker",
   106→    "TIER_LIMITS",
   107→    "create_agent",
   108→    "load_skill",
   109→    "build_system_prompt",
   110→    "get_available_skills",
   111→    # Stream Adapters
   112→    "BaseStreamAdapter",
   113→    "AISDKv6Adapter",
   114→    "LegacySSEAdapter",
   115→    "StreamConfig",
   116→    "get_adapter",
   117→    # Tool Schema
   118→    "ToolDef",
   119→    "ToolParam",
   120→    "load_skill_tools",
   121→    "get_skill_tools_openai",
   122→    "get_global_tools_openai",
   123→    "get_all_tools_for_skill",
   124→    "get_tool_card_type",
   125→    # Tool Registry
   126→    "ToolRegistry",
   127→    "ToolContext",
   128→    "tool_handler",
   129→    # SOP State
   130→    "SOPState",
   131→    "SOPStateManager",
   132→    "SOPPhase",
   133→    "get_sop_manager",
   134→    # Skill Validator
   135→    "validate_skill",
   136→    "validate_all_skills",
   137→    "ValidationResult",
   138→    "ValidationError",
   139→]
   140→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
