     1→version: "2.0"
     2→skill_id: core
     3→description: 全局工具 - 所有 Skill 共享 (V7 重构版)
     4→
     5→# ═══════════════════════════════════════════════════════════════════════════
     6→# 搜索型工具
     7→# ═══════════════════════════════════════════════════════════════════════════
     8→search:
     9→  - name: search_db
    10→    description: |
    11→      从数据库检索知识或案例。
    12→      - table='knowledge_chunks': 检索专业知识
    13→      - table='cases': 检索参考案例
    14→      LLM 根据 SOP 自己判断何时需要检索。
    15→    parameters:
    16→      - name: table
    17→        type: string
    18→        required: true
    19→        description: 要查询的表
    20→        enum:
    21→          - knowledge_chunks
    22→          - cases
    23→      - name: query
    24→        type: string
    25→        required: true
    26→        description: 检索查询词
    27→      - name: filters
    28→        type: object
    29→        required: false
    30→        description: 可选过滤条件，如 skill_id, scenario_id, tags 等
    31→      - name: top_k
    32→        type: integer
    33→        required: false
    34→        description: 返回结果数量
    35→        default: 5
    36→
    37→# ═══════════════════════════════════════════════════════════════════════════
    38→# 收集型工具
    39→# ═══════════════════════════════════════════════════════════════════════════
    40→collect:
    41→  - name: ask_user_question
    42→    description: |
    43→      主动向用户提问以获取更多信息。
    44→      何时调用：
    45→      - 用户意图不明确，需要澄清
    46→      - 需要用户做出选择
    47→      - 缺少必要信息无法继续
    48→      提问原则：
    49→      - 问题要具体、明确
    50→      - 提供选项时不超过4个
    51→      - 避免连续追问
    52→    card_type: question_card
    53→    parameters:
    54→      - name: question
    55→        type: string
    56→        required: true
    57→        description: 要问用户的问题
    58→      - name: options
    59→        type: array
    60→        required: false
    61→        description: 可选的选项列表（最多4个）
    62→
    63→  - name: request_info
    64→    description: |
    65→      向用户请求信息。当需要收集出生信息或其他必要信息时调用。
    66→    card_type: collect_form
    67→    parameters:
    68→      - name: info_type
    69→        type: string
    70→        required: true
    71→        description: 信息类型
    72→        enum:
    73→          - birth
    74→          - context
    75→          - goals
    76→          - concerns
    77→      - name: question
    78→        type: string
    79→        required: false
    80→        description: 自定义问题
    81→
    82→  - name: save_birth_info
    83→    description: |
    84→      保存用户的出生信息到个人档案。
    85→
    86→      重要：此工具会修改用户的核心档案数据，必须在用户明确同意后才能调用。
    87→
    88→      调用时机：
    89→      - calculate_bazi 或 calculate_zodiac 返回 _hint.action="ask_save_birth_info" 时
    90→      - 用户明确表示"保存"、"记住"、"好的"等同意词后
    91→      - 不要在用户给别人算命时调用
    92→
    93→      调用流程：
    94→      1. 计算工具返回 _hint，提示询问用户
    95→      2. 你询问用户："是否将此出生信息保存为您的个人档案？"
    96→      3. 用户同意后，调用此工具
    97→      4. 如果用户拒绝或说"不用"，则不调用
    98→    parameters:
    99→      - name: birth_date
   100→        type: string
   101→        required: true
   102→        description: 出生日期，格式 YYYY-MM-DD
   103→      - name: birth_time
   104→        type: string
   105→        required: false
   106→        description: 出生时间，格式 HH:MM
   107→      - name: gender
   108→        type: string
   109→        required: false
   110→        description: 性别 (male/female)
   111→      - name: place
   112→        type: string
   113→        required: false
   114→        description: 出生地点
   115→
   116→# ═══════════════════════════════════════════════════════════════════════════
   117→# Skill 数据工具 (V8 新增 - 统一 Skill Data 架构)
   118→# ═══════════════════════════════════════════════════════════════════════════
   119→action:
   120→  # ─────────────────────────────────────────────────────────────────────────
   121→  # 通用 Skill 状态工具 - REFACTOR_PLAN.md Phase 1
   122→  # ─────────────────────────────────────────────────────────────────────────
   123→  - name: read_state
   124→    description: |
   125→      读取当前 Skill 的用户状态。
   126→
   127→      这是一个通用工具，所有 Skill 共享。
   128→      自动使用当前 skill_id，无需手动指定。
   129→
   130→      数据存储在 profile.skills.{skill_id}
   131→
   132→      调用时机：
   133→      - 需要读取之前保存的数据时
   134→      - 检查协议状态时
   135→      - 获取用户目标、计划等业务数据时
   136→
   137→      示例调用：
   138→      read_state({})  # 读取全部数据
   139→      read_state({"sections": ["north_star", "goals"]})  # 只读取指定部分
   140→    parameters:
   141→      - name: sections
   142→        type: array
   143→        required: false
   144→        description: |
   145→          要读取的部分（可选）。
   146→          如果不指定，则读取全部数据。
   147→          示例：["north_star", "goals", "protocol"]
   148→
   149→  - name: write_state
   150→    description: |
   151→      写入当前 Skill 的用户状态。
   152→
   153→      这是一个通用工具，所有 Skill 共享。
   154→      自动使用当前 skill_id，无需手动指定。
   155→
   156→      支持深度合并，不会覆盖未指定的字段。
   157→      数据存储在 profile.skills.{skill_id}.{section}
   158→
   159→      调用时机：
   160→      - 保存协议数据时
   161→      - 更新用户目标、计划时
   162→      - 记录重要状态变化时
   163→
   164→      示例调用：
   165→      write_state({
   166→        "section": "north_star",
   167→        "data": {
   168→          "vision": "通过创作实现财务自由",
   169→          "anti_vision": "被困在无意义的工作中"
   170→        }
   171→      })
   172→
   173→      write_state({
   174→        "section": "protocol",
   175→        "data": {
   176→          "id": "dankoe",
   177→          "step": 2,
   178→          "started_at": "2026-01-20T10:00:00Z"
   179→        }
   180→      })
   181→    parameters:
   182→      - name: section
   183→        type: string
   184→        required: true
   185→        description: |
   186→          要写入的部分，如 "north_star"、"protocol"、"goals"。
   187→          数据会写入 profile.skills.{skill_id}.{section}
   188→      - name: data
   189→        type: object
   190→        required: true
   191→        description: |
   192→          要写入的数据。
   193→          会与现有数据深度合并，不会覆盖未指定的字段。
   194→
   195→  - name: append_to_list
   196→    description: |
   197→      向列表追加条目。
   198→
   199→      这是一个通用工具，所有 Skill 共享。
   200→      用于日志、记录等场景。
   201→
   202→      自动添加 _created_at 时间戳。
   203→      支持多级路径（如 "progress.milestones"）。
   204→      自动限制列表长度，删除最旧的条目。
   205→
   206→      调用时机：
   207→      - 添加日志条目时
   208→      - 记录里程碑时
   209→      - 保存历史记录时
   210→
   211→      示例调用：
   212→      append_to_list({
   213→        "path": "journal",
   214→        "entry": {
   215→          "content": "今天完成了第一个目标",
   216→          "mood": "excited"
   217→        },
   218→        "max_items": 100
   219→      })
   220→
   221→      append_to_list({
   222→        "path": "progress.milestones",
   223→        "entry": {
   224→          "title": "完成第一章",
   225→          "description": "书稿第一章完成"
   226→        }
   227→      })
   228→    parameters:
   229→      - name: path
   230→        type: string
   231→        required: true
   232→        description: |
   233→          列表路径。
   234→          单级路径：如 "journal"
   235→          多级路径：如 "progress.milestones"
   236→      - name: entry
   237→        type: object
   238→        required: true
   239→        description: |
   240→          要追加的条目。
   241→          会自动添加 _created_at 时间戳。
   242→      - name: max_items
   243→        type: integer
   244→        required: false
   245→        default: 100
   246→        description: |
   247→          列表最大长度。
   248→          超出时会删除最旧的条目（保留最新的）。
   249→
   250→  # ─────────────────────────────────────────────────────────────────────────
   251→  # 旧版工具（保留向后兼容）
   252→  # ─────────────────────────────────────────────────────────────────────────
   253→  - name: save_skill_data
   254→    description: |
   255→      保存当前 Skill 的数据到 VibeProfile.skill_data.{skill_id}。
   256→
   257→      这是一个通用工具，所有 Skill 都可以使用。
   258→      数据会自动与现有数据深度合并。
   259→
   260→      调用时机：
   261→      - 完成一个协议/流程后（如 Dan Koe 快速重置）
   262→      - 用户提供了重要信息需要记住
   263→      - 状态发生变化需要持久化
   264→
   265→      数据结构建议：
   266→      - 业务数据：north_star, identity, weekly 等
   267→      - 运行时状态：_state.current_protocol, _state.streak 等
   268→      - 元数据 _meta 会自动管理（version, updated_at）
   269→
   270→      示例调用：
   271→      save_skill_data({
   272→        "data": {
   273→          "north_star": {
   274→            "vision": "成为独立创业者",
   275→            "anti_vision": "继续打工"
   276→          },
   277→          "identity": {
   278→            "old": "我是那种会拖延的人",
   279→            "new": "我是那种说到做到的人"
   280→          },
   281→          "_state": {
   282→            "last_interaction": "2026-01-20"
   283→          }
   284→        }
   285→      })
   286→    parameters:
   287→      - name: data
   288→        type: object
   289→        required: true
   290→        description: |
   291→          要保存的数据，会与现有数据深度合并。
   292→          传入 null 值可删除对应字段。
   293→      - name: replace
   294→        type: boolean
   295→        required: false
   296→        description: |
   297→          是否完全替换（而非合并）。
   298→          默认 false，即深度合并现有数据。
   299→        default: false
   300→
   301→# ═══════════════════════════════════════════════════════════════════════════
   302→# 用户数据工具 (Core 零业务语义)
   303→# ═══════════════════════════════════════════════════════════════════════════
   304→
   305→  - name: read_user_data
   306→    description: |
   307→      读取用户存储的数据。
   308→      何时调用：
   309→      - 用户询问自己的目标、计划、任务时
   310→      - 需要获取用户之前保存的信息时
   311→      - 查看打卡记录或进度时
   312→    parameters:
   313→      - name: path
   314→        type: string
   315→        required: true
   316→        description: |
   317→          数据路径，如：
   318→          - goals/2026/year - 年度目标
   319→          - goals/2026/q1 - 季度目标
   320→          - plans/daily/2026-01-18 - 每日计划
   321→          - checkins/2026-01-18 - 打卡记录
   322→
   323→  - name: write_user_data
   324→    description: |
   325→      写入或更新用户数据。
   326→      何时调用：
   327→      - 用户设定新目标时
   328→      - 用户修改计划时
   329→      - 记录打卡或反思时
   330→      - 保存用户的任何结构化信息时
   331→    parameters:
   332→      - name: path
   333→        type: string
   334→        required: true
   335→        description: 数据路径
   336→      - name: content
   337→        type: object
   338→        required: true
   339→        description: |
   340→          JSON 数据内容。建议包含：
   341→          - title: 标题
   342→          - status: 状态 (active/completed/archived)
   343→          - items: 子项列表（如适用）
   344→          - notes: 用户备注
   345→      - name: expected_version
   346→        type: integer
   347→        required: false
   348→        description: |
   349→          乐观锁版本号（可选）。
   350→          如果指定，只有当前版本匹配时才会更新，否则返回 conflict 错误。
   351→          用于防止并发写入冲突。
   352→
   353→  - name: query_user_data
   354→    description: |
   355→      查询用户数据。支持按路径前缀、内容过滤。
   356→      何时调用：
   357→      - 列出用户所有目标
   358→      - 查找特定时间段的计划
   359→      - 搜索包含特定关键词的记录
   360→    parameters:
   361→      - name: path_prefix
   362→        type: string
   363→        required: false
   364→        description: |
   365→          路径前缀过滤，如 "goals/2026"、"plans/daily"。
   366→          这是主要的查询方式，路径规范由 scenarios/ 定义。
   367→      - name: filters
   368→        type: object
   369→        required: false
   370→        description: 'JSONB 过滤条件，如 {"status": "active"}'
   371→      - name: sort_by
   372→        type: string
   373→        required: false
   374→        description: 排序字段，如 "updated_at"、"created_at"
   375→      - name: limit
   376→        type: integer
   377→        required: false
   378→        description: 返回数量限制
   379→        default: 20
   380→
   381→  - name: delete_user_data
   382→    description: |
   383→      删除用户数据。
   384→      何时调用：
   385→      - 用户明确要求删除某个目标或计划时
   386→      注意：删除前应确认用户意图
   387→    parameters:
   388→      - name: path
   389→        type: string
   390→        required: true
   391→        description: 要删除的数据路径
   392→
   393→# ═══════════════════════════════════════════════════════════════════════════
   394→# 触发器工具 (V7 新增)
   395→# ═══════════════════════════════════════════════════════════════════════════
   396→  - name: create_trigger
   397→    description: |
   398→      创建用户触发器（提醒、条件触发、定时任务）。
   399→      何时调用：
   400→      - 用户要求每日提醒打卡时 (trigger_type: reminder)
   401→      - 设置目标截止日期提醒时 (trigger_type: reminder)
   402→      - 当某个数据满足条件时触发 (trigger_type: condition)
   403→      - 定时执行任务 (trigger_type: schedule)
   404→    parameters:
   405→      - name: trigger_type
   406→        type: string
   407→        required: true
   408→        description: 触发类型
   409→        enum:
   410→          - reminder
   411→          - condition
   412→          - schedule
   413→      - name: title
   414→        type: string
   415→        required: true
   416→        description: 触发器标题
   417→      - name: schedule
   418→        type: string
   419→        required: false
   420→        description: |
   421→          调度表达式（reminder/schedule 类型必填）：
   422→          - daily: "08:00" (每天8点)
   423→          - weekly: "1,3,5 09:00" (周一三五9点)
   424→          - once: "2026-01-20T10:00:00" (一次性)
   425→          - cron: "0 8 * * *" (cron 表达式)
   426→      - name: schedule_type
   427→        type: string
   428→        required: false
   429→        description: 调度类型
   430→        default: daily
   431→        enum:
   432→          - once
   433→          - daily
   434→          - weekly
   435→          - cron
   436→      - name: condition
   437→        type: object
   438→        required: false
   439→        description: |
   440→          条件规则（condition 类型必填）：
   441→          {field: "status", operator: "eq", value: "completed"}
   442→          支持的 operator: eq, ne, gt, gte, lt, lte, contains, exists, not_exists
   443→      - name: action
   444→        type: object
   445→        required: false
   446→        description: |
   447→          触发动作：
   448→          {type: "notify", payload: {title: "...", body: "..."}}
   449→          {type: "message", payload: {content: "..."}}
   450→      - name: source_path
   451→        type: string
   452→        required: false
   453→        description: 监控的数据路径（condition 类型）
   454→      - name: trigger_subtype
   455→        type: string
   456→        required: false
   457→        description: 子类型
   458→        default: custom
   459→        enum:
   460→          - goal_checkin
   461→          - daily_plan
   462→          - milestone
   463→          - custom
   464→
   465→  - name: list_triggers
   466→    description: |
   467→      列出用户的触发器。
   468→      何时调用：
   469→      - 用户询问"我有哪些提醒"时
   470→      - 需要展示用户的触发器设置时
   471→    parameters:
   472→      - name: trigger_type
   473→        type: string
   474→        required: false
   475→        description: 按触发类型过滤
   476→        enum:
   477→          - reminder
   478→          - condition
   479→          - schedule
   480→      - name: status
   481→        type: string
   482→        required: false
   483→        description: 按状态过滤
   484→        default: active
   485→        enum:
   486→          - active
   487→          - paused
   488→          - completed
   489→          - cancelled
   490→
   491→  - name: cancel_trigger
   492→    description: |
   493→      取消用户的触发器。
   494→      何时调用：
   495→      - 用户要求取消某个提醒时
   496→      - 目标完成后自动取消关联触发器时
   497→    parameters:
   498→      - name: trigger_id
   499→        type: string
   500→        required: true
   501→        description: 要取消的触发器 ID
   502→
   503→# ═══════════════════════════════════════════════════════════════════════════
   504→# 展示型工具 (V7 统一为 show_card)
   505→# ═══════════════════════════════════════════════════════════════════════════
   506→display:
   507→  - name: show_all_skills
   508→    description: |
   509→      展示所有可用 Skill 的 IntroCard 列表。
   510→
   511→      何时调用：
   512→      - 用户问题超出当前 Skill 能力范围时
   513→      - 用户询问"你能做什么"、"有什么功能"时
   514→      - 需要引导用户选择合适的 Skill 时
   515→
   516→      注意：
   517→      - 这是边界控制的核心工具
   518→      - 当无法处理用户请求时，优先调用此工具而不是简单拒绝
   519→      - 展示后让用户自己选择，不要替用户做决定
   520→    card_type: skill_list
   521→    parameters:
   522→      - name: category
   523→        type: string
   524→        required: false
   525→        description: 按分类过滤 Skill
   526→        enum:
   527→          - core
   528→          - default
   529→          - professional
   530→      - name: message
   531→        type: string
   532→        required: false
   533→        description: 展示给用户的引导语，如"这个问题超出了我的专长，以下是我能帮你的领域"
   534→
   535→  - name: show_card
   536→    description: |
   537→      统一卡片展示工具。支持 11 种通用视图类型和自定义卡片。
   538→
   539→      通用视图类型：
   540→      - list: 列表展示
   541→      - tree: 树形结构（目标层级）
   542→      - table: 表格数据
   543→      - timeline: 时间线
   544→      - form: 交互表单
   545→      - select: 选择器
   546→      - chart: 图表 (line, bar, pie, radar)
   547→      - progress: 进度条
   548→      - counter: 计数器
   549→      - modal: 模态框
   550→      - toast: 轻提示
   551→      - custom: 自定义组件（需指定 component_id）
   552→
   553→      何时调用：
   554→      - 展示目标树时 (card_type: tree)
   555→      - 展示今日计划时 (card_type: list)
   556→      - 展示打卡表单时 (card_type: form)
   557→      - 展示进度时 (card_type: progress)
   558→      - 展示 Skill 专属卡片时 (card_type: custom, component_id: bazi_chart)
   559→    parameters:
   560→      - name: card_type
   561→        type: string
   562→        required: true
   563→        description: 卡片类型
   564→        enum:
   565→          - list
   566→          - tree
   567→          - table
   568→          - timeline
   569→          - form
   570→          - select
   571→          - chart
   572→          - progress
   573→          - counter
   574→          - modal
   575→          - toast
   576→          - custom
   577→      - name: data_source
   578→        type: object
   579→        required: false
   580→        description: |
   581→          数据源配置：
   582→          - {type: "inline", data: [...]} - 内联数据
   583→          - {type: "path", path: "goals/2026"} - 从 user_data_store 读取
   584→          - {type: "api", endpoint: "/api/..."} - 前端调用 API
   585→      - name: options
   586→        type: object
   587→        required: false
   588→        description: |
   589→          视图选项，根据 card_type 不同：
   590→          - list: {emptyText, showIndex}
   591→          - tree: {expandLevel, showProgress}
   592→          - table: {columns, sortable, pagination}
   593→          - form: {fields, submitLabel, submitAction}
   594→          - chart: {chartType, xAxis, yAxis}
   595→          - progress: {max, label, showPercentage}
   596→          - custom: {componentId} - 必填，指定自定义组件
   597→
   598→  - name: recommend_skill
   599→    description: |
   600→      推荐 Skill 给用户。当判断用户可能对某个未订阅的 Skill 感兴趣时调用。
   601→
   602→      ## 何时调用
   603→      - 在主聊天（Phase 1，无 active skill）时
   604→      - 用户提到与某个 Skill 相关的话题，但当前未使用该 Skill
   605→      - 用户表达了某种需求，某个 Skill 可以更好地满足
   606→      - 对话中自然出现推荐时机
   607→
   608→      ## 何时不调用（重要！）
   609→      - **用户已经在某个 Skill 内执行任务时** → 用当前 Skill 的工具处理
   610→      - **用户的请求可以用当前 Skill 工具处理时** → 不要推荐换 Skill
   611→      - 用户说"今日指引"、"帮我看看"等模糊请求时 → 用当前 Skill 工具
   612→
   613→      ## 示例
   614→      ✅ 正确：用户在主聊天说"有什么推荐" → recommend_skill
   615→      ❌ 错误：用户在 tarot skill 内说"今日指引" → 不要调用 recommend_skill
   616→      ✅ 正确：用户在 tarot skill 内说"今日指引" → draw_tarot_cards
   617→
   618→      注意：
   619→      - 不要频繁推荐，每次对话最多推荐一次
   620→      - 推荐要自然，不要强行推销
   621→      - 如果用户已订阅该 Skill，工具会自动跳过
   622→    card_type: skill_recommendation
   623→    parameters:
   624→      - name: skill_id
   625→        type: string
   626→        required: true
   627→        description: 推荐的 Skill ID
   628→        enum:
   629→          - bazi
   630→          - zodiac
   631→          - tarot
   632→          - jungastro
   633→          - career
   634→          - mindfulness
   635→          - vibe_id
   636→      - name: reason
   637→        type: string
   638→        required: true
   639→        description: 推荐原因，基于对话内容生成，要自然、有说服力
   640→      - name: confidence
   641→        type: string
   642→        required: false
   643→        description: 推荐置信度
   644→        default: medium
   645→        enum:
   646→          - high
   647→          - medium
   648→          - low
   649→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
