     1→"""
     2→SOP State Manager v7.2 - Redis 持久化 SOP 状态
     3→
     4→v7.2 更新：
     5→- 移除硬编码的 skill 检查逻辑
     6→- 状态检查改为通用方式
     7→- SOPEngine 已删除，状态管理简化
     8→"""
     9→import json
    10→import logging
    11→from typing import Dict, Any, Optional
    12→from dataclasses import dataclass, field, asdict
    13→from datetime import datetime, timezone
    14→from enum import Enum
    15→
    16→logger = logging.getLogger(__name__)
    17→
    18→# Redis 已禁用 - 使用内存存储
    19→# 如需启用 Redis，设置环境变量 VIBELIFE_REDIS_ENABLED=1
    20→import os
    21→REDIS_AVAILABLE = False
    22→if os.getenv("VIBELIFE_REDIS_ENABLED") == "1":
    23→    try:
    24→        import redis
    25→        REDIS_AVAILABLE = True
    26→    except ImportError:
    27→        pass
    28→
    29→
    30→class SOPPhase(str, Enum):
    31→    """SOP 阶段 - v7.2: 保留用于状态标记"""
    32→    COLLECT = "collect"
    33→    COMPUTE = "compute"
    34→    SCAN = "scan"
    35→    PROACTIVE = "proactive"
    36→    ANALYZE = "analyze"
    37→    OUTPUT = "output"
    38→    DISCUSS = "discuss"
    39→
    40→
    41→@dataclass
    42→class SOPState:
    43→    """SOP 状态（可持久化）"""
    44→    conversation_id: str
    45→    skill_id: str
    46→    scenario_id: Optional[str] = None
    47→    current_phase: str = "collect"
    48→    completed_phases: list = field(default_factory=list)
    49→    collected_data: Dict[str, Any] = field(default_factory=dict)
    50→    has_birth_info: bool = False
    51→    has_chart_data: bool = False
    52→    has_proactive_asked: bool = False
    53→    created_at: str = field(default_factory=lambda: datetime.now(timezone.utc).isoformat())
    54→    updated_at: str = field(default_factory=lambda: datetime.now(timezone.utc).isoformat())
    55→
    56→    def to_dict(self) -> Dict[str, Any]:
    57→        return asdict(self)
    58→
    59→    @classmethod
    60→    def from_dict(cls, data: Dict[str, Any]) -> "SOPState":
    61→        return cls(**data)
    62→
    63→    def mark_phase_completed(self, phase: str):
    64→        """标记阶段完成"""
    65→        if phase not in self.completed_phases:
    66→            self.completed_phases.append(phase)
    67→        self.updated_at = datetime.now(timezone.utc).isoformat()
    68→
    69→    def advance_to_phase(self, phase: str):
    70→        """推进到指定阶段"""
    71→        self.current_phase = phase
    72→        self.updated_at = datetime.now(timezone.utc).isoformat()
    73→
    74→
    75→class SOPStateManager:
    76→    """SOP 状态管理器 - v7.2: 简化版"""
    77→
    78→    # 状态过期时间（秒）- 24小时
    79→    STATE_TTL = 86400
    80→
    81→    def __init__(self, redis_url: Optional[str] = None):
    82→        self._redis = None
    83→        self._memory_store: Dict[str, SOPState] = {}
    84→
    85→        if redis_url and REDIS_AVAILABLE:
    86→            try:
    87→                import redis as redis_lib
    88→                self._redis = redis_lib.from_url(redis_url, decode_responses=True)
    89→                self._redis.ping()
    90→                logger.info("SOP State Manager connected to Redis")
    91→            except Exception as e:
    92→                logger.warning(f"Failed to connect to Redis: {e}, using memory store")
    93→                self._redis = None
    94→
    95→    def _key(self, conversation_id: str) -> str:
    96→        return f"sop:state:{conversation_id}"
    97→
    98→    def get(self, conversation_id: str) -> Optional[SOPState]:
    99→        """获取 SOP 状态"""
   100→        if self._redis:
   101→            try:
   102→                data = self._redis.get(self._key(conversation_id))
   103→                if data:
   104→                    return SOPState.from_dict(json.loads(data))
   105→            except Exception as e:
   106→                logger.error(f"Redis get error: {e}")
   107→        else:
   108→            return self._memory_store.get(conversation_id)
   109→        return None
   110→
   111→    def save(self, state: SOPState):
   112→        """保存 SOP 状态"""
   113→        state.updated_at = datetime.now(timezone.utc).isoformat()
   114→
   115→        if self._redis:
   116→            try:
   117→                self._redis.setex(
   118→                    self._key(state.conversation_id),
   119→                    self.STATE_TTL,
   120→                    json.dumps(state.to_dict())
   121→                )
   122→            except Exception as e:
   123→                logger.error(f"Redis save error: {e}")
   124→                self._memory_store[state.conversation_id] = state
   125→        else:
   126→            self._memory_store[state.conversation_id] = state
   127→
   128→    def delete(self, conversation_id: str):
   129→        """删除 SOP 状态"""
   130→        if self._redis:
   131→            try:
   132→                self._redis.delete(self._key(conversation_id))
   133→            except Exception as e:
   134→                logger.error(f"Redis delete error: {e}")
   135→        else:
   136→            self._memory_store.pop(conversation_id, None)
   137→
   138→    def get_or_create(
   139→        self,
   140→        conversation_id: str,
   141→        skill_id: str,
   142→        scenario_id: Optional[str] = None
   143→    ) -> SOPState:
   144→        """获取或创建 SOP 状态"""
   145→        state = self.get(conversation_id)
   146→        if state:
   147→            # 如果 skill 变了，重置状态
   148→            if state.skill_id != skill_id:
   149→                state = SOPState(
   150→                    conversation_id=conversation_id,
   151→                    skill_id=skill_id,
   152→                    scenario_id=scenario_id
   153→                )
   154→                self.save(state)
   155→            return state
   156→
   157→        state = SOPState(
   158→            conversation_id=conversation_id,
   159→            skill_id=skill_id,
   160→            scenario_id=scenario_id
   161→        )
   162→        self.save(state)
   163→        return state
   164→
   165→    def update_from_context(
   166→        self,
   167→        conversation_id: str,
   168→        profile: Optional[Dict[str, Any]] = None,
   169→        skill_data: Optional[Dict[str, Any]] = None
   170→    ):
   171→        """
   172→        从上下文更新状态 - v7.2: 通用检查，移除硬编码
   173→        """
   174→        state = self.get(conversation_id)
   175→        if not state:
   176→            return
   177→
   178→        if profile:
   179→            identity = profile.get("identity", {})
   180→            birth_info = identity.get("birth_info", {})
   181→            state.has_birth_info = bool(
   182→                birth_info.get("birth_date") or birth_info.get("date")
   183→            )
   184→
   185→        if skill_data:
   186→            # v7.2: 通用检查，不再硬编码 skill_id
   187→            skill_id = state.skill_id
   188→            data = skill_data.get(skill_id, {})
   189→            # 检查 chart 或 cards（通用）
   190→            state.has_chart_data = bool(data.get("chart") or data.get("cards"))
   191→
   192→        self.save(state)
   193→
   194→
   195→# 全局实例（延迟初始化）
   196→_manager: Optional[SOPStateManager] = None
   197→
   198→
   199→def get_sop_manager(redis_url: Optional[str] = None) -> SOPStateManager:
   200→    """获取 SOP 状态管理器单例"""
   201→    global _manager
   202→    if _manager is None:
   203→        _manager = SOPStateManager(redis_url)
   204→    return _manager
   205→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
