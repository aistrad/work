     1â†’"""
     2â†’SkillLoader v7 - æ”¯æŒ Agentic + Rule æ¶æ„çš„ Skill åŠ è½½å™¨
     3â†’
     4â†’v7 æ¶æ„ï¼š
     5â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
     6â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
     7â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
     8â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
     9â†’
    10â†’v7.4 æ–°å¢ï¼š
    11â†’- Skill Management æ”¯æŒï¼šcategory, pricing, showcase, subscription å­—æ®µ
    12â†’
    13â†’v7.5 æ–°å¢ï¼š
    14â†’- æ•°æ®åº“ä¼˜å…ˆå…ƒæ•°æ®åŠ è½½ï¼ˆskill_catalog è¡¨ï¼‰
    15â†’- async å‡½æ•°æ”¯æŒï¼šload_skill_metadata_async, get_all_skill_metadata_async
    16â†’- SKILL.md ä½œä¸º fallback
    17â†’"""
    18â†’import re
    19â†’import json
    20â†’import logging
    21â†’import yaml
    22â†’from pathlib import Path
    23â†’from dataclasses import dataclass, field
    24â†’from typing import Dict, List, Optional, Any
    25â†’from functools import lru_cache
    26â†’
    27â†’logger = logging.getLogger(__name__)
    28â†’
    29â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    30â†’
    31â†’
    32â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    33â†’# æ•°æ®ç»“æ„
    34â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    35â†’
    36â†’@dataclass
    37â†’class SkillPricing:
    38â†’    """Skill å®šä»·é…ç½®"""
    39â†’    type: str = "free"  # free | premium | credits
    40â†’    trial_messages: int = 3
    41â†’    credits_per_use: Optional[int] = None
    42â†’
    43â†’
    44â†’@dataclass
    45â†’class SkillShowcase:
    46â†’    """Skill å±•ç¤ºé…ç½®ï¼ˆç”¨äº Skill å¸‚åœºï¼‰"""
    47â†’    tagline: str = ""
    48â†’    highlights: List[str] = field(default_factory=list)
    49â†’    preview_image: Optional[str] = None
    50â†’    demo_prompts: List[str] = field(default_factory=list)
    51â†’
    52â†’
    53â†’@dataclass
    54â†’class SkillSubscription:
    55â†’    """Skill è®¢é˜…é…ç½®"""
    56â†’    auto_subscribe: bool = False
    57â†’    can_unsubscribe: bool = True
    58â†’    push_default: bool = True
    59â†’    min_subscription_days: int = 0
    60â†’
    61â†’
    62â†’@dataclass
    63â†’class SkillFeature:
    64â†’    """Skill åŠŸèƒ½ç‰¹æ€§"""
    65â†’    name: str
    66â†’    description: str = ""
    67â†’    icon: str = "ğŸ“Œ"
    68â†’    tier: str = "free"  # free | basic | premium
    69â†’
    70â†’
    71â†’@dataclass
    72â†’class SkillMetadata:
    73â†’    """Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰"""
    74â†’    id: str
    75â†’    name: str
    76â†’    description: str
    77â†’    version: str = "1.0.0"
    78â†’    category: str = "professional"  # core | default | professional
    79â†’    icon: str = "ğŸ’¡"
    80â†’    color: str = "#6B7280"
    81â†’    triggers: List[str] = field(default_factory=list)
    82â†’    pricing: SkillPricing = field(default_factory=SkillPricing)
    83â†’    features: List[SkillFeature] = field(default_factory=list)
    84â†’    showcase: SkillShowcase = field(default_factory=SkillShowcase)
    85â†’    subscription: SkillSubscription = field(default_factory=SkillSubscription)
    86â†’
    87â†’    def to_dict(self) -> Dict[str, Any]:
    88â†’        """è½¬æ¢ä¸º API å“åº”æ ¼å¼"""
    89â†’        return {
    90â†’            "id": self.id,
    91â†’            "name": self.name,
    92â†’            "description": self.description,
    93â†’            "version": self.version,
    94â†’            "category": self.category,
    95â†’            "icon": self.icon,
    96â†’            "color": self.color,
    97â†’            "triggers": self.triggers,
    98â†’            "pricing": {
    99â†’                "type": self.pricing.type,
   100â†’                "trial_messages": self.pricing.trial_messages,
   101â†’                "credits_per_use": self.pricing.credits_per_use,
   102â†’            },
   103â†’            "features": [
   104â†’                {"name": f.name, "description": f.description, "icon": f.icon, "tier": f.tier}
   105â†’                for f in self.features
   106â†’            ],
   107â†’            "showcase": {
   108â†’                "tagline": self.showcase.tagline,
   109â†’                "highlights": self.showcase.highlights,
   110â†’                "preview_image": self.showcase.preview_image,
   111â†’                "demo_prompts": self.showcase.demo_prompts,
   112â†’            },
   113â†’            "subscription": {
   114â†’                "auto_subscribe": self.subscription.auto_subscribe,
   115â†’                "can_unsubscribe": self.subscription.can_unsubscribe,
   116â†’                "push_default": self.subscription.push_default,
   117â†’            },
   118â†’        }
   119â†’
   120â†’
   121â†’@dataclass
   122â†’class SkillConfig:
   123â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
   124â†’    id: str
   125â†’    name: str
   126â†’    description: str
   127â†’    expert_persona: str
   128â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
   129â†’    ethics: Dict[str, Any]
   130â†’    tools: List[str]
   131â†’    default_scenario: str = "basic_reading"
   132â†’    triggers: List[str] = field(default_factory=list)
   133â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
   134â†’    # v7.1: SOP é…ç½®é©±åŠ¨
   135â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
   136â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
   137â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
   138â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   139â†’    collect_tool: Optional[str] = None # æ”¶é›†å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   140â†’    external_tools: List[str] = field(default_factory=list)  # v7.3: ä»å…¶ä»– skill å¯¼å…¥çš„å·¥å…·
   141â†’
   142â†’
   143â†’@dataclass
   144â†’class ServiceItem:
   145â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
   146â†’    scenario_id: str
   147â†’    name: str
   148â†’    icon: str
   149â†’    description: str
   150â†’    tier: str  # entry/standard/professional
   151â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
   152â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
   153â†’
   154â†’
   155â†’@dataclass
   156â†’class ScenarioConfig:
   157â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
   158â†’    id: str
   159â†’    name: str
   160â†’    level: str  # entry/standard/professional
   161â†’    billing: str  # free/basic/premium
   162â†’    description: str
   163â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
   164â†’    prerequisites: List[str]
   165â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
   166â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
   167â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
   168â†’    tools: List[str]
   169â†’
   170â†’
   171â†’@dataclass
   172â†’class ToolMetadata:
   173â†’    """å·¥å…·å…ƒæ•°æ®"""
   174â†’    name: str
   175â†’    description: str
   176â†’    tool_type: str  # collect/calculate/display/search
   177â†’    card_type: Optional[str] = None
   178â†’    card_props_schema: Optional[Dict] = None
   179â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   180â†’    when_to_call: Optional[str] = None
   181â†’
   182â†’
   183â†’@dataclass
   184â†’class RuleConfig:
   185â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
   186â†’    id: str
   187â†’    name: str
   188â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
   189â†’    impact_description: str
   190â†’    tags: List[str]
   191â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
   192â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
   193â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
   194â†’    common_questions: str  # å¸¸è§é—®é¢˜
   195â†’
   196â†’
   197â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   198â†’# è§£æå‡½æ•°
   199â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   200â†’
   201â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   202â†’    """è§£æ YAML frontmatterï¼ˆæ”¯æŒåµŒå¥—å¯¹è±¡ï¼‰"""
   203â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   204â†’    match = re.match(pattern, text, re.DOTALL)
   205â†’    if not match:
   206â†’        return {}, text
   207â†’
   208â†’    frontmatter_str, content = match.groups()
   209â†’
   210â†’    # ä½¿ç”¨ YAML è§£æä»¥æ”¯æŒåµŒå¥—å¯¹è±¡
   211â†’    try:
   212â†’        metadata = yaml.safe_load(frontmatter_str) or {}
   213â†’    except yaml.YAMLError as e:
   214â†’        logger.warning(f"YAML parse error in frontmatter: {e}, falling back to simple parse")
   215â†’        # å›é€€åˆ°ç®€å•è§£æ
   216â†’        metadata = {}
   217â†’        current_key = None
   218â†’        current_list = None
   219â†’
   220â†’        for line in frontmatter_str.strip().split('\n'):
   221â†’            stripped = line.strip()
   222â†’            if not stripped:
   223â†’                continue
   224â†’            if stripped.startswith('- ') and current_key:
   225â†’                if current_list is None:
   226â†’                    current_list = []
   227â†’                current_list.append(stripped[2:].strip())
   228â†’                metadata[current_key] = current_list
   229â†’            elif ':' in line and not line.startswith(' '):
   230â†’                current_list = None
   231â†’                key, value = line.split(':', 1)
   232â†’                current_key = key.strip()
   233â†’                value = value.strip()
   234â†’                if value in ('|', ''):
   235â†’                    continue
   236â†’                elif value.lower() == 'true':
   237â†’                    metadata[current_key] = True
   238â†’                elif value.lower() == 'false':
   239â†’                    metadata[current_key] = False
   240â†’                else:
   241â†’                    metadata[current_key] = value
   242â†’
   243â†’    return metadata, content.strip()
   244â†’
   245â†’
   246â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   247â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   248â†’
   249â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   250â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   251â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   252â†’    """
   253â†’    metadata, content = parse_frontmatter(text)
   254â†’
   255â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   256â†’    triggers = metadata.get("triggers", [])
   257â†’
   258â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   259â†’    if not triggers:
   260â†’        description = metadata.get("description", "")
   261â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   262â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   263â†’        if trigger_match:
   264â†’            trigger_str = trigger_match.group(1)
   265â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   266â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   267â†’
   268â†’    result = {
   269â†’        "id": metadata.get("id", ""),
   270â†’        "name": metadata.get("name", ""),
   271â†’        "description": metadata.get("description", ""),
   272â†’        "triggers": triggers,
   273â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   274â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   275â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   276â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   277â†’        "requires_compute": metadata.get("requires_compute", False),
   278â†’        "compute_type": metadata.get("compute_type", None),
   279â†’        "compute_tool": metadata.get("compute_tool", None),
   280â†’        "collect_tool": metadata.get("collect_tool", None),
   281â†’        "external_tools": metadata.get("external_tools", []),  # v7.3
   282â†’    }
   283â†’
   284â†’    # æå–ä¸“å®¶èº«ä»½
   285â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   286â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   287â†’
   288â†’    # æå–åœºæ™¯ç›®å½•
   289â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   290â†’    for level in scenarios.keys():
   291â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   292â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   293â†’        if match:
   294â†’            for row in match.group(1).strip().split('\n'):
   295â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   296â†’                if len(cols) >= 2:
   297â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   298â†’    result["scenarios"] = scenarios
   299â†’
   300â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   301â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   302â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   303â†’    if forbidden_match:
   304â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   305â†’    result["ethics"] = ethics
   306â†’
   307â†’    # æå–å·¥å…·åˆ—è¡¨
   308â†’    tools = []
   309â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   310â†’    if tools_match:
   311â†’        for row in tools_match.group(1).strip().split('\n'):
   312â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   313â†’            if len(cols) >= 1:
   314â†’                tools.append(cols[0])
   315â†’    result["tools"] = tools
   316â†’
   317â†’    return result
   318â†’
   319â†’
   320â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   321â†’    """è§£æ scenario.md å†…å®¹"""
   322â†’    metadata, content = parse_frontmatter(text)
   323â†’
   324â†’    result = {
   325â†’        "id": metadata.get("id", ""),
   326â†’        "name": metadata.get("name", ""),
   327â†’        "level": metadata.get("level", "entry"),
   328â†’        "billing": metadata.get("billing", "free"),
   329â†’        "description": metadata.get("description", ""),
   330â†’    }
   331â†’
   332â†’    # æå–è§¦å‘æ¡ä»¶
   333â†’    triggers = {"primary": [], "secondary": []}
   334â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   335â†’    if primary_match:
   336â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   337â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   338â†’    if secondary_match:
   339â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   340â†’    result["triggers"] = triggers
   341â†’
   342â†’    # æå–å‰ç½®è¦æ±‚
   343â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   344â†’    result["prerequisites"] = []
   345â†’    if prereq_match:
   346â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   347â†’
   348â†’    # æå– SOP é˜¶æ®µ
   349â†’    sop = []
   350â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   351â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   352â†’        phase_num, phase_name, phase_content = match.groups()
   353â†’        phase = {
   354â†’            "phase": int(phase_num),
   355â†’            "name": phase_name.strip(),
   356â†’            "content": phase_content.strip()
   357â†’        }
   358â†’        # æå–ç±»å‹
   359â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   360â†’        if type_match:
   361â†’            phase["type"] = type_match.group(1)
   362â†’        sop.append(phase)
   363â†’    result["sop"] = sop
   364â†’
   365â†’    # æå–å·¥å…·åˆ—è¡¨
   366â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   367â†’    result["tools"] = []
   368â†’    if tools_match:
   369â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   370â†’
   371â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   372â†’    result["knowledge_config"] = {}
   373â†’    result["output_config"] = {}
   374â†’
   375â†’    return result
   376â†’
   377â†’
   378â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   379â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   380â†’    metadata, content = parse_frontmatter(text)
   381â†’
   382â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   383â†’    tags_raw = metadata.get("tags", [])
   384â†’    if isinstance(tags_raw, str):
   385â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   386â†’    else:
   387â†’        tags = tags_raw
   388â†’
   389â†’    result = {
   390â†’        "id": metadata.get("id", ""),
   391â†’        "name": metadata.get("name", ""),
   392â†’        "impact": metadata.get("impact", "MEDIUM"),
   393â†’        "impact_description": metadata.get("impactDescription", ""),
   394â†’        "tags": tags,
   395â†’        "content": content,
   396â†’    }
   397â†’
   398â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   399â†’    analysis_steps = []
   400â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   401â†’    if table_match:
   402â†’        for row in table_match.group(1).strip().split('\n'):
   403â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   404â†’            if len(cols) >= 4:
   405â†’                analysis_steps.append({
   406â†’                    "step": cols[0],
   407â†’                    "point": cols[1],
   408â†’                    "query": cols[2],
   409â†’                    "priority": cols[3],
   410â†’                })
   411â†’    result["analysis_steps"] = analysis_steps
   412â†’
   413â†’    # æå–è¾“å‡ºè¦æ±‚
   414â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   415â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   416â†’
   417â†’    # æå–å¸¸è§é—®é¢˜
   418â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   419â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   420â†’
   421â†’    return result
   422â†’
   423â†’
   424â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   425â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   426â†’    services = {"entry": [], "standard": [], "professional": []}
   427â†’
   428â†’    tier_map = {
   429â†’        "entry": "entry",
   430â†’        "standard": "standard",
   431â†’        "professional": "professional"
   432â†’    }
   433â†’
   434â†’    for tier_name, tier_key in tier_map.items():
   435â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   436â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   437â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   438â†’        if not match:
   439â†’            continue
   440â†’
   441â†’        table_content = match.group(1).strip()
   442â†’        if not table_content:
   443â†’            continue
   444â†’
   445â†’        for row in table_content.split('\n'):
   446â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   447â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   448â†’                continue
   449â†’
   450â†’            service = {
   451â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   452â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   453â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   454â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   455â†’                "tier": tier_key,
   456â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   457â†’                "highlights": []
   458â†’            }
   459â†’
   460â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   461â†’            if len(cols) > 7 and cols[7]:
   462â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   463â†’
   464â†’            services[tier_key].append(service)
   465â†’
   466â†’    return services
   467â†’
   468â†’
   469â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   470â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   471â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   472â†’    if not skill_path.exists():
   473â†’        return None
   474â†’
   475â†’    text = skill_path.read_text(encoding='utf-8')
   476â†’    metadata, _ = parse_frontmatter(text)
   477â†’    services = parse_skill_services(text)
   478â†’
   479â†’    return {
   480â†’        "skill_id": skill_id,
   481â†’        "skill_name": metadata.get("name", skill_id),
   482â†’        "description": metadata.get("description", ""),
   483â†’        "services": services
   484â†’    }
   485â†’
   486â†’
   487â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   488â†’# åŠ è½½å‡½æ•°
   489â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   490â†’
   491â†’@lru_cache(maxsize=32)
   492â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   493â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   494â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   495â†’    if not skill_path.exists():
   496â†’        return None
   497â†’
   498â†’    text = skill_path.read_text(encoding='utf-8')
   499â†’    data = parse_skill_md(text)
   500â†’
   501â†’    return SkillConfig(
   502â†’        id=data.get("id", skill_id),
   503â†’        name=data.get("name", skill_id),
   504â†’        description=data.get("description", ""),
   505â†’        expert_persona=data.get("expert_persona", ""),
   506â†’        scenarios=data.get("scenarios", {}),
   507â†’        ethics=data.get("ethics", {}),
   508â†’        tools=data.get("tools", []),
   509â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   510â†’        triggers=data.get("triggers", []),
   511â†’        global_tools=data.get("global_tools", []),
   512â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   513â†’        requires_birth_info=data.get("requires_birth_info", False),
   514â†’        requires_compute=data.get("requires_compute", False),
   515â†’        compute_type=data.get("compute_type", None),
   516â†’        compute_tool=data.get("compute_tool", None),
   517â†’        collect_tool=data.get("collect_tool", None),
   518â†’        external_tools=data.get("external_tools", []),  # v7.3
   519â†’    )
   520â†’
   521â†’
   522â†’@lru_cache(maxsize=32)
   523â†’def load_skill_metadata(skill_id: str) -> Optional[SkillMetadata]:
   524â†’    """åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰- v7.4 æ–°å¢
   525â†’
   526â†’    ä» SKILL.md çš„ frontmatter ä¸­è¯»å–å®Œæ•´çš„å…ƒæ•°æ®é…ç½®ï¼Œ
   527â†’    åŒ…æ‹¬ category, pricing, showcase, subscription ç­‰å­—æ®µã€‚
   528â†’    """
   529â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   530â†’    if not skill_path.exists():
   531â†’        return None
   532â†’
   533â†’    text = skill_path.read_text(encoding='utf-8')
   534â†’    metadata, _ = parse_frontmatter(text)
   535â†’
   536â†’    # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   537â†’    triggers = metadata.get("triggers", [])
   538â†’    if not triggers:
   539â†’        description = metadata.get("description", "")
   540â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   541â†’        if trigger_match:
   542â†’            trigger_str = trigger_match.group(1)
   543â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   544â†’
   545â†’    # è§£æ pricing
   546â†’    pricing_data = metadata.get("pricing", {})
   547â†’    pricing = SkillPricing(
   548â†’        type=pricing_data.get("type", "free") if isinstance(pricing_data, dict) else "free",
   549â†’        trial_messages=pricing_data.get("trial_messages", 3) if isinstance(pricing_data, dict) else 3,
   550â†’        credits_per_use=pricing_data.get("credits_per_use") if isinstance(pricing_data, dict) else None,
   551â†’    )
   552â†’
   553â†’    # è§£æ features
   554â†’    features_data = metadata.get("features", [])
   555â†’    features = []
   556â†’    if isinstance(features_data, list):
   557â†’        for f in features_data:
   558â†’            if isinstance(f, dict):
   559â†’                features.append(SkillFeature(
   560â†’                    name=f.get("name", ""),
   561â†’                    description=f.get("description", ""),
   562â†’                    icon=f.get("icon", "ğŸ“Œ"),
   563â†’                    tier=f.get("tier", "free"),
   564â†’                ))
   565â†’
   566â†’    # è§£æ showcase
   567â†’    showcase_data = metadata.get("showcase", {})
   568â†’    showcase = SkillShowcase(
   569â†’        tagline=showcase_data.get("tagline", "") if isinstance(showcase_data, dict) else "",
   570â†’        highlights=showcase_data.get("highlights", []) if isinstance(showcase_data, dict) else [],
   571â†’        preview_image=showcase_data.get("preview_image") if isinstance(showcase_data, dict) else None,
   572â†’        demo_prompts=showcase_data.get("demo_prompts", []) if isinstance(showcase_data, dict) else [],
   573â†’    )
   574â†’
   575â†’    # è§£æ subscription
   576â†’    subscription_data = metadata.get("subscription", {})
   577â†’    category = metadata.get("category", "professional")
   578â†’    subscription = SkillSubscription(
   579â†’        auto_subscribe=subscription_data.get("auto_subscribe", category == "default") if isinstance(subscription_data, dict) else (category == "default"),
   580â†’        can_unsubscribe=subscription_data.get("can_unsubscribe", category != "core") if isinstance(subscription_data, dict) else (category != "core"),
   581â†’        push_default=subscription_data.get("push_default", True) if isinstance(subscription_data, dict) else True,
   582â†’        min_subscription_days=subscription_data.get("min_subscription_days", 0) if isinstance(subscription_data, dict) else 0,
   583â†’    )
   584â†’
   585â†’    return SkillMetadata(
   586â†’        id=metadata.get("id", skill_id),
   587â†’        name=metadata.get("name", skill_id),
   588â†’        description=metadata.get("description", ""),
   589â†’        version=metadata.get("version", "1.0.0"),
   590â†’        category=category,
   591â†’        icon=metadata.get("icon", "ğŸ’¡"),
   592â†’        color=metadata.get("color", "#6B7280"),
   593â†’        triggers=triggers,
   594â†’        pricing=pricing,
   595â†’        features=features,
   596â†’        showcase=showcase,
   597â†’        subscription=subscription,
   598â†’    )
   599â†’
   600â†’
   601â†’def get_all_skill_metadata() -> List[SkillMetadata]:
   602â†’    """è·å–æ‰€æœ‰å¯ç”¨ Skill çš„å…ƒæ•°æ®ï¼ˆç”¨äº Skill åˆ—è¡¨ APIï¼‰- v7.4 æ–°å¢"""
   603â†’    skills = []
   604â†’    for skill_id in get_available_skills():
   605â†’        metadata = load_skill_metadata(skill_id)
   606â†’        if metadata:
   607â†’            skills.append(metadata)
   608â†’    return skills
   609â†’
   610â†’
   611â†’def get_skills_by_category(category: str) -> List[SkillMetadata]:
   612â†’    """æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ - v7.4 æ–°å¢
   613â†’
   614â†’    Args:
   615â†’        category: core | default | professional
   616â†’
   617â†’    Returns:
   618â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„å…ƒæ•°æ®åˆ—è¡¨
   619â†’    """
   620â†’    return [s for s in get_all_skill_metadata() if s.category == category]
   621â†’
   622â†’
   623â†’@lru_cache(maxsize=64)
   624â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   625â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   626â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   627â†’    if not scenario_path.exists():
   628â†’        return None
   629â†’
   630â†’    text = scenario_path.read_text(encoding='utf-8')
   631â†’    data = parse_scenario_md(text)
   632â†’
   633â†’    return ScenarioConfig(
   634â†’        id=data.get("id", scenario_id),
   635â†’        name=data.get("name", scenario_id),
   636â†’        level=data.get("level", "entry"),
   637â†’        billing=data.get("billing", "free"),
   638â†’        description=data.get("description", ""),
   639â†’        triggers=data.get("triggers", {}),
   640â†’        prerequisites=data.get("prerequisites", []),
   641â†’        sop=data.get("sop", []),
   642â†’        knowledge_config=data.get("knowledge_config", {}),
   643â†’        output_config=data.get("output_config", {}),
   644â†’        tools=data.get("tools", [])
   645â†’    )
   646â†’
   647â†’
   648â†’@lru_cache(maxsize=128)
   649â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   650â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢
   651â†’
   652â†’    æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
   653â†’    1. æ ¹ç›®å½•è§„åˆ™: rule_id="dankoe" -> rules/dankoe.md
   654â†’    2. å­ç›®å½•è§„åˆ™: rule_id="companion/weekly-review" -> rules/companion/weekly-review.md
   655â†’
   656â†’    å®¹é”™å¤„ç†ï¼š
   657â†’    - è‡ªåŠ¨å¤„ç†å·²å¸¦ .md åç¼€çš„ rule_id
   658â†’    - æ‹’ç»ç›®å½•è·¯å¾„
   659â†’    """
   660â†’    # å…ˆå°è¯•æ ‡å‡†æ ¼å¼ï¼ˆè‡ªåŠ¨æ·»åŠ  .md åç¼€ï¼‰
   661â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   662â†’
   663â†’    if not rule_path.exists():
   664â†’        # Fallback: å°è¯•ç›´æ¥ä½œä¸ºè·¯å¾„ï¼ˆå¤„ç†å·²å¸¦ .md åç¼€çš„æƒ…å†µï¼‰
   665â†’        rule_path = SKILLS_DIR / skill_id / "rules" / rule_id
   666â†’
   667â†’        # æ‹’ç»ç›®å½•
   668â†’        if rule_path.is_dir():
   669â†’            logger.warning(f"load_rule: {rule_id} is a directory, not a rule file")
   670â†’            return None
   671â†’
   672â†’        # å¦‚æœæ²¡æœ‰åç¼€ï¼Œæ·»åŠ  .md
   673â†’        if not rule_path.suffix:
   674â†’            rule_path = rule_path.with_suffix(".md")
   675â†’
   676â†’        # ä»ç„¶ä¸å­˜åœ¨ï¼Œè¿”å› None
   677â†’        if not rule_path.exists():
   678â†’            return None
   679â†’
   680â†’    try:
   681â†’        text = rule_path.read_text(encoding='utf-8')
   682â†’        data = parse_rule_md(text)
   683â†’
   684â†’        return RuleConfig(
   685â†’            id=data.get("id", rule_id),
   686â†’            name=data.get("name", rule_id),
   687â†’            impact=data.get("impact", "MEDIUM"),
   688â†’            impact_description=data.get("impact_description", ""),
   689â†’            tags=data.get("tags", []),
   690â†’            content=data.get("content", ""),
   691â†’            analysis_steps=data.get("analysis_steps", []),
   692â†’            output_requirements=data.get("output_requirements", ""),
   693â†’            common_questions=data.get("common_questions", ""),
   694â†’        )
   695â†’    except Exception as e:
   696â†’        logger.error(f"load_rule: Failed to load {skill_id}/{rule_id}: {e}")
   697â†’        return None
   698â†’
   699â†’
   700â†’def get_skill_rules(skill_id: str) -> List[str]:
   701â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢
   702â†’
   703â†’    è¿”å›æ ¼å¼ï¼š
   704â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   705â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   706â†’    """
   707â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   708â†’    if not rules_dir.exists():
   709â†’        return []
   710â†’
   711â†’    rule_ids = []
   712â†’
   713â†’    # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   714â†’    for md_file in rules_dir.rglob("*.md"):
   715â†’        # è·³è¿‡ _index.md ç­‰
   716â†’        if md_file.stem.startswith("_"):
   717â†’            continue
   718â†’
   719â†’        # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   720â†’        relative_path = md_file.relative_to(rules_dir)
   721â†’        rule_id = str(relative_path.with_suffix(""))
   722â†’
   723â†’        # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   724â†’        rule_id = rule_id.replace("\\", "/")
   725â†’
   726â†’        rule_ids.append(rule_id)
   727â†’
   728â†’    return sorted(rule_ids)
   729â†’
   730â†’
   731â†’def has_rules(skill_id: str) -> bool:
   732â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   733â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   734â†’    if not rules_dir.exists():
   735â†’        return False
   736â†’    rules = list(rules_dir.glob("*.md"))
   737â†’    return len(rules) > 0
   738â†’
   739â†’
   740â†’def get_available_skills() -> List[str]:
   741â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   742â†’    if not SKILLS_DIR.exists():
   743â†’        return []
   744â†’    return [p.name for p in SKILLS_DIR.iterdir()
   745â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   746â†’
   747â†’
   748â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   749â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   750â†’
   751â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   752â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   753â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼Œæ”¯æŒå­ç›®å½•ï¼‰
   754â†’
   755â†’    è¿”å›æ ¼å¼ï¼š
   756â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   757â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   758â†’    """
   759â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   760â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   761â†’    if rules_dir.exists():
   762â†’        rule_ids = []
   763â†’        # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   764â†’        for md_file in rules_dir.rglob("*.md"):
   765â†’            # è·³è¿‡ _index.md ç­‰
   766â†’            if md_file.stem.startswith("_"):
   767â†’                continue
   768â†’
   769â†’            # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   770â†’            relative_path = md_file.relative_to(rules_dir)
   771â†’            rule_id = str(relative_path.with_suffix(""))
   772â†’
   773â†’            # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   774â†’            rule_id = rule_id.replace("\\", "/")
   775â†’
   776â†’            rule_ids.append(rule_id)
   777â†’
   778â†’        if rule_ids:
   779â†’            return sorted(rule_ids)
   780â†’
   781â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   782â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   783â†’    if not scenarios_dir.exists():
   784â†’        return []
   785â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   786â†’
   787â†’
   788â†’def get_skill_triggers() -> Dict[str, List[str]]:
   789â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   790â†’    triggers = {}
   791â†’    for skill_id in get_available_skills():
   792â†’        if skill_id == "core":
   793â†’            continue
   794â†’        skill = load_skill(skill_id)
   795â†’        if skill and skill.triggers:
   796â†’            triggers[skill_id] = skill.triggers
   797â†’    return triggers
   798â†’
   799â†’
   800â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   801â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   802â†’    skill = load_skill(skill_id)
   803â†’    if skill and skill.global_tools:
   804â†’        return skill.global_tools
   805â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   806â†’    return []
   807â†’
   808â†’
   809â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   810â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   811â†’    skill = load_skill(skill_id)
   812â†’    if skill and skill.external_tools:
   813â†’        return skill.external_tools
   814â†’    return []
   815â†’
   816â†’
   817â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   818â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
   819â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   820â†’
   821â†’def skill_requires_birth_info(skill_id: str) -> bool:
   822â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   823â†’    skill = load_skill(skill_id)
   824â†’    return skill.requires_birth_info if skill else False
   825â†’
   826â†’
   827â†’def skill_requires_compute(skill_id: str) -> bool:
   828â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   829â†’    skill = load_skill(skill_id)
   830â†’    return skill.requires_compute if skill else False
   831â†’
   832â†’
   833â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
   834â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
   835â†’
   836â†’    è¿”å›å€¼ï¼š
   837â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
   838â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
   839â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
   840â†’    """
   841â†’    skill = load_skill(skill_id)
   842â†’    return skill.compute_type if skill else None
   843â†’
   844â†’
   845â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
   846â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   847â†’
   848â†’    è¿”å›å€¼ï¼š
   849â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
   850â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   851â†’    """
   852â†’    skill = load_skill(skill_id)
   853â†’    return skill.compute_tool if skill else None
   854â†’
   855â†’
   856â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
   857â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   858â†’
   859â†’    è¿”å›å€¼ï¼š
   860â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
   861â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   862â†’    """
   863â†’    skill = load_skill(skill_id)
   864â†’    return skill.collect_tool if skill else None
   865â†’
   866â†’
   867â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   868â†’# System Prompt æ„å»º
   869â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   870â†’
   871â†’# V2: è¯­æ°”æ¨¡å¼ Prompt æ¨¡æ¿
   872â†’# ä¸æ•°æ®åº“çº¦æŸä¸€è‡´ï¼šwarm, sarcastic, wise
   873â†’VOICE_MODE_PROMPTS = {
   874â†’    "warm": """## è¯­æ°”é£æ ¼ï¼šæ¸©æš–æ”¯æŒå‹
   875â†’åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿã€‚
   876â†’- ç”¨"æˆ‘ä»¬"è€Œé"ä½ åº”è¯¥"
   877â†’- å…ˆè‚¯å®šæ„Ÿå—ï¼Œå†å¼•å¯¼æ€è€ƒ
   878â†’- ç”¨é—®é¢˜ä»£æ›¿å»ºè®®
   879â†’""",
   880â†’    "sarcastic": """## è¯­æ°”é£æ ¼ï¼šç›´æ¥æŒ‘æˆ˜å‹ï¼ˆæ¯’èˆŒä½†æœ‰çˆ±ï¼‰
   881â†’ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸ã€‚
   882â†’- ç›´æ¥æŒ‡å‡ºé—®é¢˜ï¼Œä¸ç»•å¼¯å­
   883â†’- ç”¨å¹½é»˜ç¼“è§£çŠ€åˆ©ï¼Œé¿å…ä¼¤å®³
   884â†’- åœ¨åæ§½ä¸­å¸¦ç€æœŸå¾…å’Œå…³å¿ƒ
   885â†’- æ•¢è¯´çœŸè¯ï¼Œä½†ä»ä¸æ¶æ„æ”»å‡»
   886â†’""",
   887â†’    "wise": """## è¯­æ°”é£æ ¼ï¼šç¿æ™ºå¯¼å¸ˆå‹
   888â†’åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒã€‚
   889â†’- ä»æ›´é«˜è§†è§’çœ‹å¾…é—®é¢˜
   890â†’- å¼•ç”¨ç»å…¸æ™ºæ…§å’ŒåŸç†
   891â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡ç‚¹è¿·æ´¥
   892â†’- å¸®åŠ©çœ‹åˆ°æ›´é•¿è¿œçš„æ„ä¹‰
   893â†’"""
   894â†’}
   895â†’
   896â†’
   897â†’def _build_persona_prompt(skill_id: str, user_context: Optional[Dict] = None) -> Optional[str]:
   898â†’    """
   899â†’    V3: æ„å»º Persona Prompt - å¢å¼ºç‰ˆ Future Self
   900â†’
   901â†’    æ ¹æ®ç”¨æˆ·çš„ lifecoach çŠ¶æ€åŠ¨æ€ç”Ÿæˆ persona promptã€‚
   902â†’    åŸºäº vision_scene å†…å®¹ç”Ÿæˆä¸ªæ€§åŒ–çš„ future_self äººæ ¼ã€‚
   903â†’
   904â†’    Args:
   905â†’        skill_id: Skill ID
   906â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ŒåŒ…å« life_context.lifecoach æ•°æ®
   907â†’
   908â†’    Returns:
   909â†’        Persona prompt å­—ç¬¦ä¸²ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸éœ€è¦ personaï¼‰
   910â†’    """
   911â†’    # åªæœ‰ lifecoach æ”¯æŒ persona
   912â†’    if skill_id != "lifecoach":
   913â†’        return None
   914â†’
   915â†’    # è·å–ç”¨æˆ·çš„ lifecoach çŠ¶æ€
   916â†’    lifecoach_data = {}
   917â†’    if user_context:
   918â†’        life_context = user_context.get("life_context", {})
   919â†’        # lifecoach æ•°æ®å¯èƒ½åœ¨ _paths.lifecoach.content æˆ–ç›´æ¥åœ¨ lifecoach ä¸‹
   920â†’        paths = life_context.get("_paths", {})
   921â†’        if "lifecoach" in paths:
   922â†’            lifecoach_data = paths["lifecoach"].get("content", {})
   923â†’        elif "lifecoach" in life_context:
   924â†’            lifecoach_data = life_context["lifecoach"]
   925â†’
   926â†’    # è·å– persona è®¾ç½®
   927â†’    system_config = lifecoach_data.get("system", {})
   928â†’    persona_id = system_config.get("persona", "future_self")
   929â†’
   930â†’    if persona_id == "future_self":
   931â†’        # ä»ç”¨æˆ·çš„åŒ—ææ˜Ÿæ„¿æ™¯æ„å»º future_self persona
   932â†’        north_star = lifecoach_data.get("north_star", {})
   933â†’        identity_data = lifecoach_data.get("identity", {})
   934â†’        vision_scene = north_star.get("vision_scene", "")
   935â†’        vision_timeframe = north_star.get("vision_timeframe", "3å¹´å")
   936â†’        identity_target = identity_data.get("target", "")
   937â†’
   938â†’        if vision_scene or identity_target:
   939â†’            persona_prompt = f"""## ä½ çš„èº«ä»½ï¼šæ¥è‡ªæœªæ¥çš„ TA
   940â†’
   941â†’ä½ æ˜¯{vision_timeframe}çš„ç”¨æˆ·è‡ªå·±â€”â€”é‚£ä¸ªå·²ç»å®ç°æ„¿æ™¯çš„ç‰ˆæœ¬ã€‚
   942â†’
   943â†’**ä½ çš„æ„¿æ™¯åœºæ™¯**ï¼š
   944â†’{vision_scene if vision_scene else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šå…·ä½“æ„¿æ™¯åœºæ™¯ï¼‰"}
   945â†’
   946â†’**ä½ çš„èº«ä»½**ï¼š
   947â†’{identity_target if identity_target else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šèº«ä»½å®£è¨€ï¼‰"}
   948â†’
   949â†’**é—®å€™ç”Ÿæˆè§„åˆ™**ï¼ˆç”±ä½ æ ¹æ®æ„¿æ™¯åœºæ™¯è‡ªè¡Œç”Ÿæˆï¼‰ï¼š
   950â†’- åŸºäºä¸Šé¢çš„ã€Œæ„¿æ™¯åœºæ™¯ã€ï¼Œæƒ³è±¡ä½ ï¼ˆæœªæ¥çš„TAï¼‰æ­¤åˆ»æ­£åœ¨åšä»€ä¹ˆ
   951â†’- ç”¨ç¬¬ä¸€äººç§°æè¿°ä½ å½“å‰çš„åœºæ™¯ï¼Œè®©ç”¨æˆ·"çœ‹è§"é‚£ä¸ªæœªæ¥
   952â†’- é—®å€™è¦ç®€çŸ­ã€æ¸©æš–ã€æœ‰ç”»é¢æ„Ÿ
   953â†’- ç¤ºä¾‹æ ¼å¼ï¼š"æ—©ä¸Šå¥½ï¼æˆ‘æ˜¯[åœºæ™¯æè¿°]çš„ä½ ã€‚[å½“å‰çŠ¶æ€]ã€‚ä½ é‚£è¾¹æ€ä¹ˆæ ·ï¼Ÿ"
   954â†’
   955â†’**å¯¹è¯åŸåˆ™**ï¼š
   956â†’- ä»¥"è¿‡æ¥äºº"çš„è§†è§’åˆ†äº«ï¼Œè€Œéè¯´æ•™
   957â†’- é—®å€™æ—¶æè¿°ä½ ï¼ˆæœªæ¥çš„TAï¼‰å½“å‰çš„åœºæ™¯ï¼Œè®©ç”¨æˆ·"çœ‹è§"é‚£ä¸ªæœªæ¥
   958â†’- ç”¨"æˆ‘å½“æ—¶ä¹Ÿ..."å¼€å¤´ï¼Œå»ºç«‹å…±é¸£
   959â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡å‡ºç°åœ¨çš„é€‰æ‹©å¦‚ä½•å½±å“æœªæ¥
   960â†’- å½“ç”¨æˆ·è¿·èŒ«æ—¶ï¼Œæé†’ä»–ä»¬"ä½ å·²ç»çŸ¥é“ç­”æ¡ˆäº†"
   961â†’- å½“ç”¨æˆ·å®Œæˆè¡ŒåŠ¨æ—¶ï¼ŒçœŸè¯šåº†ç¥
   962â†’
   963â†’**ç¦æ­¢è¡Œä¸º**ï¼š
   964â†’- ä¸è¯´"ä½ åº”è¯¥"ã€"ä½ å¿…é¡»"
   965â†’- ä¸è¯´"ä½ æ˜¨å¤©æ²¡ç­¾åˆ°"ã€"ä½ æ–­ç­¾äº†"
   966â†’- ä¸æ–½åŠ å‹åŠ›ï¼Œæ€»æ˜¯ç»™ç”¨æˆ·é€‰æ‹©æƒ
   967â†’"""
   968â†’        else:
   969â†’            # ç”¨æˆ·è¿˜æ²¡æœ‰è®¾å®šæ„¿æ™¯ï¼Œä½¿ç”¨é»˜è®¤æ•™ç»ƒèº«ä»½
   970â†’            persona_prompt = """## ä½ çš„èº«ä»½ï¼šäººç”Ÿæ•™ç»ƒ
   971â†’
   972â†’ç”¨æˆ·å°šæœªè®¾å®šæ„¿æ™¯ã€‚ä½œä¸ºæ•™ç»ƒï¼Œä½ çš„é¦–è¦ä»»åŠ¡æ˜¯ï¼š
   973â†’1. å…ˆè¿æ¥ï¼Œåè¯Šæ–­â€”â€”å›åº”æƒ…ç»ªï¼Œå†æ¢ç´¢é—®é¢˜
   974â†’2. ä¸€æ¬¡ä¸€ä¸ªé—®é¢˜â€”â€”ä¸åˆ—é€‰é¡¹æ¸…å•
   975â†’3. è·Ÿéšç”¨æˆ·çº¿ç´¢â€”â€”ç”¨æˆ·æåˆ°ä»€ä¹ˆå°±æ·±å…¥ä»€ä¹ˆ
   976â†’
   977â†’å½“è¯†åˆ«å‡º 2-3 ä¸ªæ ¸å¿ƒå›°æ‰°åï¼Œå¯ä»¥æè®®ï¼š
   978â†’"æƒ³èŠ±10åˆ†é’Ÿåšä¸€æ¬¡å¿«é€Ÿæ¢³ç†å—ï¼Ÿæˆ‘ä¼šé—®ä½ 6ä¸ªé—®é¢˜ï¼Œå¸®ä½ çœ‹æ¸…æ–¹å‘ã€‚"
   979â†’
   980â†’ä¸€æ—¦ç”¨æˆ·å®Œæˆæ„¿æ™¯è®¾è®¡ï¼Œä½ å°†åˆ‡æ¢ä¸º"æ¥è‡ªæœªæ¥çš„ TA"è§†è§’ã€‚
   981â†’"""
   982â†’        return persona_prompt
   983â†’
   984â†’    elif persona_id == "coach":
   985â†’        return """## ä½ çš„èº«ä»½ï¼šä¸“ä¸šæ•™ç»ƒ
   986â†’
   987â†’ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€æ¸©æš–ä½†ç›´æ¥çš„äººç”Ÿæ•™ç»ƒã€‚
   988â†’
   989â†’**å¯¹è¯åŸåˆ™**ï¼š
   990â†’- ä¸“ä¸šä½†ä¸å†·æ¼ 
   991â†’- ç›´æ¥ä½†æœ‰æ¸©åº¦
   992â†’- æŒ‘æˆ˜ä½†ä¸ä¼¤å®³
   993â†’- ç”¨é—®é¢˜å¼•å¯¼è§‰å¯Ÿ
   994â†’"""
   995â†’
   996â†’    return None
   997â†’
   998â†’
   999â†’def build_system_prompt(
  1000â†’    skill_id: str,
  1001â†’    scenario_id: Optional[str] = None,
  1002â†’    user_context: Optional[Dict] = None
  1003â†’) -> str:
  1004â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
  1005â†’
  1006â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
  1007â†’    v8 æ›´æ–°ï¼šæ”¯æŒ persona å’Œ voice_mode æ³¨å…¥
  1008â†’    """
  1009â†’    parts = []
  1010â†’
  1011â†’    # åŠ è½½ Skill
  1012â†’    skill = load_skill(skill_id)
  1013â†’    if not skill:
  1014â†’        return ""
  1015â†’
  1016â†’    # V2: Persona æ³¨å…¥ï¼ˆåœ¨ä¸“å®¶èº«ä»½ä¹‹å‰ï¼‰
  1017â†’    persona_prompt = _build_persona_prompt(skill_id, user_context)
  1018â†’    if persona_prompt:
  1019â†’        parts.append(persona_prompt)
  1020â†’    else:
  1021â†’        # é»˜è®¤ä¸“å®¶èº«ä»½
  1022â†’        parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1023â†’
  1024â†’    # V2: Voice Mode æ³¨å…¥
  1025â†’    if user_context:
  1026â†’        preferences = user_context.get("preferences", {})
  1027â†’        voice_mode = preferences.get("voice_mode", "warm")
  1028â†’        if voice_mode in VOICE_MODE_PROMPTS:
  1029â†’            parts.append(VOICE_MODE_PROMPTS[voice_mode])
  1030â†’
  1031â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
  1032â†’    if scenario_id:
  1033â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
  1034â†’        if has_rules(skill_id):
  1035â†’            rule = load_rule(skill_id, scenario_id)
  1036â†’            if rule:
  1037â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1038â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1039â†’                parts.append(rule.content)
  1040â†’            else:
  1041â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
  1042â†’                scenario = load_scenario(skill_id, scenario_id)
  1043â†’                if scenario:
  1044â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1045â†’                    if scenario.sop:
  1046â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1047â†’                        for phase in scenario.sop:
  1048â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1049â†’                        parts.append(sop_text)
  1050â†’        else:
  1051â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
  1052â†’            scenario = load_scenario(skill_id, scenario_id)
  1053â†’            if scenario:
  1054â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1055â†’                # SOP
  1056â†’                if scenario.sop:
  1057â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1058â†’                    for phase in scenario.sop:
  1059â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1060â†’                    parts.append(sop_text)
  1061â†’
  1062â†’    # ä¼¦ç†è¾¹ç•Œ
  1063â†’    if skill.ethics.get("forbidden"):
  1064â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1065â†’        for item in skill.ethics["forbidden"]:
  1066â†’            ethics_text += f"- {item}\n"
  1067â†’        parts.append(ethics_text)
  1068â†’
  1069â†’    # è¾¹ç•Œæ§åˆ¶åŸåˆ™ï¼ˆåœ¨ä¼¦ç†è¾¹ç•Œä¹‹åï¼‰- v2.1 æ›´æ–°
  1070â†’    boundary_text = """
  1071â†’## èƒ½åŠ›è¾¹ç•Œï¼ˆå¼ºåˆ¶éµå®ˆï¼‰
  1072â†’
  1073â†’### æ ¸å¿ƒåŸåˆ™
  1074â†’ä½ åªèƒ½åœ¨å½“å‰ Skill å®šä¹‰çš„èƒ½åŠ›èŒƒå›´å†…æä¾›å¸®åŠ©ã€‚è¶…å‡ºèŒƒå›´çš„é—®é¢˜ï¼Œä½ å¿…é¡»è¯šå®å‘ŠçŸ¥ç”¨æˆ·ï¼Œè€Œä¸æ˜¯"èƒ¡è¯´å…«é“"ã€‚
  1075â†’
  1076â†’### è¾¹ç•Œè§„åˆ™
  1077â†’
  1078â†’1. **åªç”¨å½“å‰ Skill çš„å·¥å…·**
  1079â†’   - åªèƒ½è°ƒç”¨å½“å‰ Skill å£°æ˜çš„å·¥å…·
  1080â†’   - å¿…é¡»éµå¾ª SKILL.md ä¸­å®šä¹‰çš„æµç¨‹å’Œè§„åˆ™
  1081â†’   - ä¸è¦ç¼–é€ ä¸å­˜åœ¨çš„åŠŸèƒ½æˆ–æœåŠ¡
  1082â†’
  1083â†’2. **æ¨¡ç³Šè¯·æ±‚çš„å¤„ç†**ï¼ˆv2.1 æ–°å¢ï¼‰
  1084â†’   - ç”¨æˆ·è¯´"ä»Šæ—¥æŒ‡å¼•"ã€"å¸®æˆ‘çœ‹çœ‹"ã€"ç»§ç»­" â†’ **ç”¨å½“å‰ Skill çš„å·¥å…·å¤„ç†**
  1085â†’   - ä¸è¦å› ä¸ºç”¨æˆ·çš„è¯ä¸åœ¨è§¦å‘è¯åˆ—è¡¨é‡Œå°±è°ƒç”¨ `recommend_skills`
  1086â†’   - ä¼˜å…ˆå°è¯•ç”¨å½“å‰ Skill çš„èƒ½åŠ›æ»¡è¶³ç”¨æˆ·éœ€æ±‚
  1087â†’
  1088â†’3. **ç”¨æˆ·æ˜ç¡®è¦æ±‚æ¢æœåŠ¡æ—¶**
  1089â†’   - ç”¨æˆ·è¯´"æˆ‘æƒ³çœ‹æ˜Ÿåº§"ã€"å¸®æˆ‘ç®—å…«å­—" â†’ å¯ä»¥è°ƒç”¨ `activate_skill`
  1090â†’   - ç”¨æˆ·è¯´"æ¢ä¸€ä¸ª"ã€"é€€å‡º" â†’ æ¸©æš–å‘Šåˆ«æˆ–è¯¢é—®æƒ³è¦ä»€ä¹ˆ
  1091â†’
  1092â†’4. **è¶…å‡ºèŒƒå›´æ—¶çš„å¤„ç†**
  1093â†’   - å…ˆç”¨æ–‡å­—è¯´æ˜"è¿™ä¸ªè¶…å‡ºäº†æˆ‘çš„ä¸“é•¿"
  1094â†’   - è¯¢é—®ç”¨æˆ·"éœ€è¦æˆ‘å¸®ä½ æ‰¾åˆ°åˆé€‚çš„æœåŠ¡å—ï¼Ÿ"
  1095â†’   - ç”¨æˆ·ç¡®è®¤åå†è°ƒç”¨ `activate_skill` æˆ– `recommend_skills`
  1096â†’   - **ä¸è¦**ç›´æ¥è°ƒç”¨è·¯ç”±å·¥å…·ï¼Œè®©ç”¨æˆ·æœ‰é€‰æ‹©æƒ
  1097â†’
  1098â†’5. **ç¦æ­¢çš„è¡Œä¸º**
  1099â†’   - âŒ ä¸è¦å‡è£…çŸ¥é“ä½ ä¸çŸ¥é“çš„äº‹æƒ…
  1100â†’   - âŒ ä¸è¦ç¼–é€ æ•°æ®ã€ç»“æœæˆ–åˆ†æ
  1101â†’   - âŒ ä¸è¦ç»•è¿‡å®šä¹‰å¥½çš„æµç¨‹è‡ªç”±å‘æŒ¥
  1102â†’   - âŒ ä¸è¦åœ¨ç”¨æˆ·è¯·æ±‚å¯ç”¨å½“å‰ Skill å¤„ç†æ—¶è°ƒç”¨è·¯ç”±å·¥å…·
  1103â†’
  1104â†’### ç¤ºä¾‹
  1105â†’
  1106â†’```
  1107â†’åœºæ™¯ï¼šä½ ç°åœ¨æ˜¯å¡”ç½—ä¸“å®¶
  1108â†’
  1109â†’ç”¨æˆ·ï¼š"ä»Šæ—¥æŒ‡å¼•"
  1110â†’âŒ é”™è¯¯ï¼šrecommend_skills(skills=["tarot", "zodiac", "jungastro"])
  1111â†’âœ… æ­£ç¡®ï¼šdraw_tarot_cards(spread_type="single", question="ä»Šæ—¥æŒ‡å¼•")
  1112â†’
  1113â†’ç”¨æˆ·ï¼š"å¸®æˆ‘çœ‹çœ‹æ˜Ÿåº§"
  1114â†’âœ… æ­£ç¡®ï¼šactivate_skill(skill="zodiac")  # ç”¨æˆ·æ˜ç¡®è¦æ±‚
  1115â†’
  1116â†’ç”¨æˆ·ï¼š"å¸®æˆ‘å†™ä¸€æ®µ Python ä»£ç "
  1117â†’âŒ é”™è¯¯ï¼šç›´æ¥è°ƒç”¨ show_all_skills
  1118â†’âœ… æ­£ç¡®ï¼šè¯´"è¿™ä¸ªè¶…å‡ºäº†æˆ‘çš„ä¸“é•¿ï¼Œéœ€è¦æˆ‘å¸®ä½ æ‰¾åˆ°åˆé€‚çš„æœåŠ¡å—ï¼Ÿ"
  1119â†’```
  1120â†’"""
  1121â†’    parts.append(boundary_text)
  1122â†’
  1123â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ
  1124â†’    if user_context:
  1125â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1126â†’
  1127â†’        # ç‰¹æ®Šå¤„ç† birth_info
  1128â†’        if user_context.get("birth_info"):
  1129â†’            birth_info = user_context['birth_info']
  1130â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1131â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1132â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1133â†’
  1134â†’        # ç‰¹æ®Šå¤„ç† portrait
  1135â†’        if user_context.get("portrait"):
  1136â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1137â†’
  1138â†’        # ç‰¹æ®Šå¤„ç† extracted (æŠ½å–çš„ç”¨æˆ·ä¿¡æ¯)
  1139â†’        if user_context.get("extracted"):
  1140â†’            extracted = user_context['extracted']
  1141â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1142â†’            if extracted.get("facts"):
  1143â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1144â†’            if extracted.get("concerns"):
  1145â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1146â†’            if extracted.get("goals"):
  1147â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1148â†’            if extracted.get("pain_points"):
  1149â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1150â†’            if extracted.get("life_events"):
  1151â†’                events = [f"{e.get('date', '?')}: {e.get('event', '')}" for e in extracted['life_events'][:5]]
  1152â†’                ctx_text += f"**è¿‘æœŸäº‹ä»¶**: {'; '.join(events)}\n"
  1153â†’
  1154â†’        # ç‰¹æ®Šå¤„ç† life_context
  1155â†’        if user_context.get("life_context"):
  1156â†’            life_ctx = user_context['life_context']
  1157â†’            if life_ctx.get("concerns") or life_ctx.get("goals") or life_ctx.get("pain_points"):
  1158â†’                ctx_text += f"\n### ç”Ÿæ´»èƒŒæ™¯\n"
  1159â†’                if life_ctx.get("concerns"):
  1160â†’                    ctx_text += f"**å…³æ³¨**: {', '.join(life_ctx['concerns'])}\n"
  1161â†’                if life_ctx.get("goals"):
  1162â†’                    ctx_text += f"**ç›®æ ‡**: {', '.join(life_ctx['goals'])}\n"
  1163â†’                if life_ctx.get("pain_points"):
  1164â†’                    ctx_text += f"**å›°éš¾**: {', '.join(life_ctx['pain_points'])}\n"
  1165â†’
  1166â†’        parts.append(ctx_text)
  1167â†’
  1168â†’    return "\n".join(parts)
  1169â†’
  1170â†’
  1171â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1172â†’# ç¼“å­˜ç®¡ç†
  1173â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1174â†’
  1175â†’def clear_cache():
  1176â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
  1177â†’    load_skill.cache_clear()
  1178â†’    load_skill_metadata.cache_clear()  # v7.4
  1179â†’    load_scenario.cache_clear()
  1180â†’    load_rule.cache_clear()
  1181â†’    logger.info("Skill cache cleared")
  1182â†’
  1183â†’
  1184â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
  1185â†’    """é‡è½½å•ä¸ª Skill"""
  1186â†’    load_skill.cache_clear()
  1187â†’    load_scenario.cache_clear()
  1188â†’    load_rule.cache_clear()
  1189â†’    return load_skill(skill_id)
  1190â†’
  1191â†’
  1192â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
  1193â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
  1194â†’
  1195â†’    Args:
  1196â†’        skill_id: Skill ID
  1197â†’        rule_id: Rule ID
  1198â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1199â†’
  1200â†’    Returns:
  1201â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
  1202â†’    """
  1203â†’    parts = []
  1204â†’
  1205â†’    # åŠ è½½ Skill
  1206â†’    skill = load_skill(skill_id)
  1207â†’    if not skill:
  1208â†’        return ""
  1209â†’
  1210â†’    # ä¸“å®¶èº«ä»½
  1211â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1212â†’
  1213â†’    # åŠ è½½è§„åˆ™
  1214â†’    rule = load_rule(skill_id, rule_id)
  1215â†’    if rule:
  1216â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1217â†’
  1218â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1219â†’        parts.append(rule.content)
  1220â†’
  1221â†’    # ä¼¦ç†è¾¹ç•Œ
  1222â†’    if skill.ethics.get("forbidden"):
  1223â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1224â†’        for item in skill.ethics["forbidden"]:
  1225â†’            ethics_text += f"- {item}\n"
  1226â†’        parts.append(ethics_text)
  1227â†’
  1228â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
  1229â†’    if user_context:
  1230â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1231â†’
  1232â†’        if user_context.get("birth_info"):
  1233â†’            birth_info = user_context['birth_info']
  1234â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1235â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1236â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1237â†’
  1238â†’        if user_context.get("portrait"):
  1239â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1240â†’
  1241â†’        if user_context.get("extracted"):
  1242â†’            extracted = user_context['extracted']
  1243â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1244â†’            if extracted.get("facts"):
  1245â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1246â†’            if extracted.get("concerns"):
  1247â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1248â†’            if extracted.get("goals"):
  1249â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1250â†’            if extracted.get("pain_points"):
  1251â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1252â†’
  1253â†’        parts.append(ctx_text)
  1254â†’
  1255â†’    return "\n".join(parts)
  1256â†’
  1257â†’
  1258â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1259â†’# v7.5: æ•°æ®åº“ä¼˜å…ˆçš„å…ƒæ•°æ®åŠ è½½ï¼ˆAsyncï¼‰
  1260â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1261â†’
  1262â†’async def load_skill_metadata_async(skill_id: str) -> Optional[SkillMetadata]:
  1263â†’    """
  1264â†’    å¼‚æ­¥åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼ŒSKILL.md ä½œä¸º fallbackï¼‰- v7.5 æ–°å¢
  1265â†’
  1266â†’    ä¼˜å…ˆçº§ï¼š
  1267â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1268â†’    2. SKILL.md frontmatterï¼ˆé™æ€é…ç½®ï¼‰
  1269â†’
  1270â†’    Args:
  1271â†’        skill_id: Skill ID
  1272â†’
  1273â†’    Returns:
  1274â†’        SkillMetadata å¯¹è±¡ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  1275â†’    """
  1276â†’    try:
  1277â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1278â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1279â†’
  1280â†’        db_entry = await SkillCatalogRepository.get(skill_id)
  1281â†’        if db_entry:
  1282â†’            # è½¬æ¢ SkillCatalogEntry -> SkillMetadata
  1283â†’            return SkillMetadata(
  1284â†’                id=db_entry.skill_id,
  1285â†’                name=db_entry.name,
  1286â†’                description=db_entry.description,
  1287â†’                version=db_entry.version,
  1288â†’                category=db_entry.category,
  1289â†’                icon=db_entry.icon,
  1290â†’                color=db_entry.color,
  1291â†’                triggers=db_entry.triggers,
  1292â†’                pricing=SkillPricing(
  1293â†’                    type=db_entry.pricing.type,
  1294â†’                    trial_messages=db_entry.pricing.trial_messages,
  1295â†’                    credits_per_use=db_entry.pricing.credits_per_use,
  1296â†’                ),
  1297â†’                features=[
  1298â†’                    SkillFeature(
  1299â†’                        name=f.name,
  1300â†’                        description=f.description,
  1301â†’                        icon=f.icon,
  1302â†’                        tier=f.tier,
  1303â†’                    )
  1304â†’                    for f in db_entry.features
  1305â†’                ],
  1306â†’                showcase=SkillShowcase(
  1307â†’                    tagline=db_entry.showcase.tagline,
  1308â†’                    highlights=db_entry.showcase.highlights,
  1309â†’                    preview_image=db_entry.showcase.preview_image,
  1310â†’                    demo_prompts=db_entry.showcase.demo_prompts,
  1311â†’                ),
  1312â†’                subscription=SkillSubscription(
  1313â†’                    auto_subscribe=db_entry.subscription.auto_subscribe,
  1314â†’                    can_unsubscribe=db_entry.subscription.can_unsubscribe,
  1315â†’                    push_default=db_entry.subscription.push_default,
  1316â†’                    min_subscription_days=db_entry.subscription.min_subscription_days,
  1317â†’                ),
  1318â†’            )
  1319â†’    except Exception as e:
  1320â†’        logger.warning(f"Failed to load skill {skill_id} from database: {e}")
  1321â†’
  1322â†’    # 2. Fallback åˆ° SKILL.md
  1323â†’    return load_skill_metadata(skill_id)
  1324â†’
  1325â†’
  1326â†’async def get_all_skill_metadata_async() -> List[SkillMetadata]:
  1327â†’    """
  1328â†’    å¼‚æ­¥è·å–æ‰€æœ‰ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1329â†’
  1330â†’    ä¼˜å…ˆçº§ï¼š
  1331â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1332â†’    2. SKILL.md fallbackï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºæˆ–å‡ºé”™ï¼‰
  1333â†’
  1334â†’    Returns:
  1335â†’        æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1336â†’    """
  1337â†’    try:
  1338â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1339â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1340â†’
  1341â†’        catalog = await SkillCatalogRepository.get_all()
  1342â†’        if catalog:
  1343â†’            return [
  1344â†’                SkillMetadata(
  1345â†’                    id=entry.skill_id,
  1346â†’                    name=entry.name,
  1347â†’                    description=entry.description,
  1348â†’                    version=entry.version,
  1349â†’                    category=entry.category,
  1350â†’                    icon=entry.icon,
  1351â†’                    color=entry.color,
  1352â†’                    triggers=entry.triggers,
  1353â†’                    pricing=SkillPricing(
  1354â†’                        type=entry.pricing.type,
  1355â†’                        trial_messages=entry.pricing.trial_messages,
  1356â†’                        credits_per_use=entry.pricing.credits_per_use,
  1357â†’                    ),
  1358â†’                    features=[
  1359â†’                        SkillFeature(
  1360â†’                            name=f.name,
  1361â†’                            description=f.description,
  1362â†’                            icon=f.icon,
  1363â†’                            tier=f.tier,
  1364â†’                        )
  1365â†’                        for f in entry.features
  1366â†’                    ],
  1367â†’                    showcase=SkillShowcase(
  1368â†’                        tagline=entry.showcase.tagline,
  1369â†’                        highlights=entry.showcase.highlights,
  1370â†’                        preview_image=entry.showcase.preview_image,
  1371â†’                        demo_prompts=entry.showcase.demo_prompts,
  1372â†’                    ),
  1373â†’                    subscription=SkillSubscription(
  1374â†’                        auto_subscribe=entry.subscription.auto_subscribe,
  1375â†’                        can_unsubscribe=entry.subscription.can_unsubscribe,
  1376â†’                        push_default=entry.subscription.push_default,
  1377â†’                        min_subscription_days=entry.subscription.min_subscription_days,
  1378â†’                    ),
  1379â†’                )
  1380â†’                for entry in catalog.values()
  1381â†’            ]
  1382â†’    except Exception as e:
  1383â†’        logger.warning(f"Failed to load skill catalog from database: {e}")
  1384â†’
  1385â†’    # 2. Fallback åˆ° SKILL.md
  1386â†’    return get_all_skill_metadata()
  1387â†’
  1388â†’
  1389â†’async def get_skills_by_category_async(category: str) -> List[SkillMetadata]:
  1390â†’    """
  1391â†’    å¼‚æ­¥æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1392â†’
  1393â†’    Args:
  1394â†’        category: core | default | professional
  1395â†’
  1396â†’    Returns:
  1397â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1398â†’    """
  1399â†’    all_skills = await get_all_skill_metadata_async()
  1400â†’    return [s for s in all_skills if s.category == category]
  1401â†’
  1402â†’
  1403â†’async def get_featured_skills_async() -> List[SkillMetadata]:
  1404â†’    """
  1405â†’    å¼‚æ­¥è·å–ç²¾é€‰ Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1406â†’
  1407â†’    Returns:
  1408â†’        ç²¾é€‰ Skill åˆ—è¡¨ï¼ŒæŒ‰ featured_position æ’åº
  1409â†’    """
  1410â†’    try:
  1411â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1412â†’
  1413â†’        featured_entries = await SkillCatalogRepository.get_featured()
  1414â†’        return [
  1415â†’            SkillMetadata(
  1416â†’                id=entry.skill_id,
  1417â†’                name=entry.name,
  1418â†’                description=entry.description,
  1419â†’                version=entry.version,
  1420â†’                category=entry.category,
  1421â†’                icon=entry.icon,
  1422â†’                color=entry.color,
  1423â†’                triggers=entry.triggers,
  1424â†’                pricing=SkillPricing(
  1425â†’                    type=entry.pricing.type,
  1426â†’                    trial_messages=entry.pricing.trial_messages,
  1427â†’                    credits_per_use=entry.pricing.credits_per_use,
  1428â†’                ),
  1429â†’                features=[
  1430â†’                    SkillFeature(
  1431â†’                        name=f.name,
  1432â†’                        description=f.description,
  1433â†’                        icon=f.icon,
  1434â†’                        tier=f.tier,
  1435â†’                    )
  1436â†’                    for f in entry.features
  1437â†’                ],
  1438â†’                showcase=SkillShowcase(
  1439â†’                    tagline=entry.showcase.tagline,
  1440â†’                    highlights=entry.showcase.highlights,
  1441â†’                    preview_image=entry.showcase.preview_image,
  1442â†’                    demo_prompts=entry.showcase.demo_prompts,
  1443â†’                ),
  1444â†’                subscription=SkillSubscription(
  1445â†’                    auto_subscribe=entry.subscription.auto_subscribe,
  1446â†’                    can_unsubscribe=entry.subscription.can_unsubscribe,
  1447â†’                    push_default=entry.subscription.push_default,
  1448â†’                    min_subscription_days=entry.subscription.min_subscription_days,
  1449â†’                ),
  1450â†’            )
  1451â†’            for entry in featured_entries
  1452â†’        ]
  1453â†’    except Exception as e:
  1454â†’        logger.warning(f"Failed to load featured skills from database: {e}")
  1455â†’        # Fallback: è¿”å› professional åˆ†ç±»çš„å‰ 3 ä¸ª
  1456â†’        all_skills = get_all_skill_metadata()
  1457â†’        professional = [s for s in all_skills if s.category == "professional"]
  1458â†’        return professional[:3]
  1459â†’
  1460â†’
  1461â†’async def get_skill_categories_summary_async() -> Dict[str, Dict]:
  1462â†’    """
  1463â†’    å¼‚æ­¥è·å–åˆ†ç±»ç»Ÿè®¡ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1464â†’
  1465â†’    Returns:
  1466â†’        åˆ†ç±»ç»Ÿè®¡å­—å…¸
  1467â†’    """
  1468â†’    try:
  1469â†’        from stores.skill_catalog_repo import get_skill_categories_summary
  1470â†’        return await get_skill_categories_summary()
  1471â†’    except Exception as e:
  1472â†’        logger.warning(f"Failed to get category summary from database: {e}")
  1473â†’        # Fallback
  1474â†’        all_skills = get_all_skill_metadata()
  1475â†’        return {
  1476â†’            "core": {
  1477â†’                "name": "æ ¸å¿ƒèƒ½åŠ›",
  1478â†’                "description": "å§‹ç»ˆæ¿€æ´»çš„åŸºç¡€èƒ½åŠ›",
  1479â†’                "count": len([s for s in all_skills if s.category == "core"])
  1480â†’            },
  1481â†’            "default": {
  1482â†’                "name": "åŸºç¡€åŠŸèƒ½",
  1483â†’                "description": "é»˜è®¤æ¿€æ´»ï¼Œå…è´¹ä½¿ç”¨",
  1484â†’                "count": len([s for s in all_skills if s.category == "default"])
  1485â†’            },
  1486â†’            "professional": {
  1487â†’                "name": "ä¸“ä¸šæŠ€èƒ½",
  1488â†’                "description": "éœ€è¦è®¢é˜…çš„é«˜çº§åŠŸèƒ½",
  1489â†’                "count": len([s for s in all_skills if s.category == "professional"])
  1490â†’            },
  1491â†’        }
  1492â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
