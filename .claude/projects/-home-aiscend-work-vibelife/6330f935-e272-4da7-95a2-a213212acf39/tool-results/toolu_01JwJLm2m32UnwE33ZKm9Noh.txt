     1â†’"""
     2â†’SkillLoader v7 - æ”¯æŒ Agentic + Rule æ¶æ„çš„ Skill åŠ è½½å™¨
     3â†’
     4â†’v7 æ¶æ„ï¼š
     5â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
     6â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
     7â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
     8â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
     9â†’"""
    10â†’import re
    11â†’import json
    12â†’import logging
    13â†’from pathlib import Path
    14â†’from dataclasses import dataclass, field
    15â†’from typing import Dict, List, Optional, Any
    16â†’from functools import lru_cache
    17â†’
    18â†’logger = logging.getLogger(__name__)
    19â†’
    20â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    21â†’
    22â†’
    23â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    24â†’# æ•°æ®ç»“æ„
    25â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    26â†’
    27â†’@dataclass
    28â†’class SkillConfig:
    29â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
    30â†’    id: str
    31â†’    name: str
    32â†’    description: str
    33â†’    expert_persona: str
    34â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
    35â†’    ethics: Dict[str, Any]
    36â†’    tools: List[str]
    37â†’    default_scenario: str = "basic_reading"
    38â†’    triggers: List[str] = field(default_factory=list)
    39â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
    40â†’    # v7.1: SOP é…ç½®é©±åŠ¨
    41â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
    42â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
    43â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
    44â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
    45â†’
    46â†’
    47â†’@dataclass
    48â†’class ServiceItem:
    49â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
    50â†’    scenario_id: str
    51â†’    name: str
    52â†’    icon: str
    53â†’    description: str
    54â†’    tier: str  # entry/standard/professional
    55â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
    56â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
    57â†’
    58â†’
    59â†’@dataclass
    60â†’class ScenarioConfig:
    61â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
    62â†’    id: str
    63â†’    name: str
    64â†’    level: str  # entry/standard/professional
    65â†’    billing: str  # free/basic/premium
    66â†’    description: str
    67â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
    68â†’    prerequisites: List[str]
    69â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
    70â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
    71â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
    72â†’    tools: List[str]
    73â†’
    74â†’
    75â†’@dataclass
    76â†’class ToolMetadata:
    77â†’    """å·¥å…·å…ƒæ•°æ®"""
    78â†’    name: str
    79â†’    description: str
    80â†’    tool_type: str  # collect/calculate/display/search
    81â†’    card_type: Optional[str] = None
    82â†’    card_props_schema: Optional[Dict] = None
    83â†’    parameters: Dict[str, Any] = field(default_factory=dict)
    84â†’    when_to_call: Optional[str] = None
    85â†’
    86â†’
    87â†’@dataclass
    88â†’class RuleConfig:
    89â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
    90â†’    id: str
    91â†’    name: str
    92â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
    93â†’    impact_description: str
    94â†’    tags: List[str]
    95â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
    96â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
    97â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
    98â†’    common_questions: str  # å¸¸è§é—®é¢˜
    99â†’
   100â†’
   101â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   102â†’# è§£æå‡½æ•°
   103â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   104â†’
   105â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   106â†’    """è§£æ YAML frontmatter"""
   107â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   108â†’    match = re.match(pattern, text, re.DOTALL)
   109â†’    if not match:
   110â†’        return {}, text
   111â†’
   112â†’    frontmatter_str, content = match.groups()
   113â†’    metadata = {}
   114â†’    current_key = None
   115â†’    current_list = None
   116â†’
   117â†’    for line in frontmatter_str.strip().split('\n'):
   118â†’        stripped = line.strip()
   119â†’        if not stripped:
   120â†’            continue
   121â†’        if stripped.startswith('- ') and current_key:
   122â†’            if current_list is None:
   123â†’                current_list = []
   124â†’            current_list.append(stripped[2:].strip())
   125â†’            metadata[current_key] = current_list
   126â†’        elif ':' in line and not line.startswith(' '):
   127â†’            current_list = None
   128â†’            key, value = line.split(':', 1)
   129â†’            current_key = key.strip()
   130â†’            value = value.strip()
   131â†’            if value in ('|', ''):
   132â†’                continue
   133â†’            elif value.lower() == 'true':
   134â†’                metadata[current_key] = True
   135â†’            elif value.lower() == 'false':
   136â†’                metadata[current_key] = False
   137â†’            else:
   138â†’                metadata[current_key] = value
   139â†’
   140â†’    return metadata, content.strip()
   141â†’
   142â†’
   143â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   144â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   145â†’
   146â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   147â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   148â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   149â†’    """
   150â†’    metadata, content = parse_frontmatter(text)
   151â†’
   152â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   153â†’    triggers = metadata.get("triggers", [])
   154â†’
   155â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   156â†’    if not triggers:
   157â†’        description = metadata.get("description", "")
   158â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   159â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   160â†’        if trigger_match:
   161â†’            trigger_str = trigger_match.group(1)
   162â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   163â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   164â†’
   165â†’    result = {
   166â†’        "id": metadata.get("id", ""),
   167â†’        "name": metadata.get("name", ""),
   168â†’        "description": metadata.get("description", ""),
   169â†’        "triggers": triggers,
   170â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   171â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   172â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   173â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   174â†’        "requires_compute": metadata.get("requires_compute", False),
   175â†’        "compute_type": metadata.get("compute_type", None),
   176â†’        "compute_tool": metadata.get("compute_tool", None),
   177â†’    }
   178â†’
   179â†’    # æå–ä¸“å®¶èº«ä»½
   180â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   181â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   182â†’
   183â†’    # æå–åœºæ™¯ç›®å½•
   184â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   185â†’    for level in scenarios.keys():
   186â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   187â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   188â†’        if match:
   189â†’            for row in match.group(1).strip().split('\n'):
   190â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   191â†’                if len(cols) >= 2:
   192â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   193â†’    result["scenarios"] = scenarios
   194â†’
   195â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   196â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   197â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   198â†’    if forbidden_match:
   199â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   200â†’    result["ethics"] = ethics
   201â†’
   202â†’    # æå–å·¥å…·åˆ—è¡¨
   203â†’    tools = []
   204â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   205â†’    if tools_match:
   206â†’        for row in tools_match.group(1).strip().split('\n'):
   207â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   208â†’            if len(cols) >= 1:
   209â†’                tools.append(cols[0])
   210â†’    result["tools"] = tools
   211â†’
   212â†’    return result
   213â†’
   214â†’
   215â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   216â†’    """è§£æ scenario.md å†…å®¹"""
   217â†’    metadata, content = parse_frontmatter(text)
   218â†’
   219â†’    result = {
   220â†’        "id": metadata.get("id", ""),
   221â†’        "name": metadata.get("name", ""),
   222â†’        "level": metadata.get("level", "entry"),
   223â†’        "billing": metadata.get("billing", "free"),
   224â†’        "description": metadata.get("description", ""),
   225â†’    }
   226â†’
   227â†’    # æå–è§¦å‘æ¡ä»¶
   228â†’    triggers = {"primary": [], "secondary": []}
   229â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   230â†’    if primary_match:
   231â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   232â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   233â†’    if secondary_match:
   234â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   235â†’    result["triggers"] = triggers
   236â†’
   237â†’    # æå–å‰ç½®è¦æ±‚
   238â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   239â†’    result["prerequisites"] = []
   240â†’    if prereq_match:
   241â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   242â†’
   243â†’    # æå– SOP é˜¶æ®µ
   244â†’    sop = []
   245â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   246â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   247â†’        phase_num, phase_name, phase_content = match.groups()
   248â†’        phase = {
   249â†’            "phase": int(phase_num),
   250â†’            "name": phase_name.strip(),
   251â†’            "content": phase_content.strip()
   252â†’        }
   253â†’        # æå–ç±»å‹
   254â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   255â†’        if type_match:
   256â†’            phase["type"] = type_match.group(1)
   257â†’        sop.append(phase)
   258â†’    result["sop"] = sop
   259â†’
   260â†’    # æå–å·¥å…·åˆ—è¡¨
   261â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   262â†’    result["tools"] = []
   263â†’    if tools_match:
   264â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   265â†’
   266â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   267â†’    result["knowledge_config"] = {}
   268â†’    result["output_config"] = {}
   269â†’
   270â†’    return result
   271â†’
   272â†’
   273â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   274â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   275â†’    metadata, content = parse_frontmatter(text)
   276â†’
   277â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   278â†’    tags_raw = metadata.get("tags", [])
   279â†’    if isinstance(tags_raw, str):
   280â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   281â†’    else:
   282â†’        tags = tags_raw
   283â†’
   284â†’    result = {
   285â†’        "id": metadata.get("id", ""),
   286â†’        "name": metadata.get("name", ""),
   287â†’        "impact": metadata.get("impact", "MEDIUM"),
   288â†’        "impact_description": metadata.get("impactDescription", ""),
   289â†’        "tags": tags,
   290â†’        "content": content,
   291â†’    }
   292â†’
   293â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   294â†’    analysis_steps = []
   295â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   296â†’    if table_match:
   297â†’        for row in table_match.group(1).strip().split('\n'):
   298â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   299â†’            if len(cols) >= 4:
   300â†’                analysis_steps.append({
   301â†’                    "step": cols[0],
   302â†’                    "point": cols[1],
   303â†’                    "query": cols[2],
   304â†’                    "priority": cols[3],
   305â†’                })
   306â†’    result["analysis_steps"] = analysis_steps
   307â†’
   308â†’    # æå–è¾“å‡ºè¦æ±‚
   309â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   310â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   311â†’
   312â†’    # æå–å¸¸è§é—®é¢˜
   313â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   314â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   315â†’
   316â†’    return result
   317â†’
   318â†’
   319â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   320â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   321â†’    services = {"entry": [], "standard": [], "professional": []}
   322â†’
   323â†’    tier_map = {
   324â†’        "entry": "entry",
   325â†’        "standard": "standard",
   326â†’        "professional": "professional"
   327â†’    }
   328â†’
   329â†’    for tier_name, tier_key in tier_map.items():
   330â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   331â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   332â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   333â†’        if not match:
   334â†’            continue
   335â†’
   336â†’        table_content = match.group(1).strip()
   337â†’        if not table_content:
   338â†’            continue
   339â†’
   340â†’        for row in table_content.split('\n'):
   341â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   342â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   343â†’                continue
   344â†’
   345â†’            service = {
   346â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   347â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   348â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   349â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   350â†’                "tier": tier_key,
   351â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   352â†’                "highlights": []
   353â†’            }
   354â†’
   355â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   356â†’            if len(cols) > 7 and cols[7]:
   357â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   358â†’
   359â†’            services[tier_key].append(service)
   360â†’
   361â†’    return services
   362â†’
   363â†’
   364â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   365â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   366â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   367â†’    if not skill_path.exists():
   368â†’        return None
   369â†’
   370â†’    text = skill_path.read_text(encoding='utf-8')
   371â†’    metadata, _ = parse_frontmatter(text)
   372â†’    services = parse_skill_services(text)
   373â†’
   374â†’    return {
   375â†’        "skill_id": skill_id,
   376â†’        "skill_name": metadata.get("name", skill_id),
   377â†’        "description": metadata.get("description", ""),
   378â†’        "services": services
   379â†’    }
   380â†’
   381â†’
   382â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   383â†’# åŠ è½½å‡½æ•°
   384â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   385â†’
   386â†’@lru_cache(maxsize=32)
   387â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   388â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   389â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   390â†’    if not skill_path.exists():
   391â†’        return None
   392â†’
   393â†’    text = skill_path.read_text(encoding='utf-8')
   394â†’    data = parse_skill_md(text)
   395â†’
   396â†’    return SkillConfig(
   397â†’        id=data.get("id", skill_id),
   398â†’        name=data.get("name", skill_id),
   399â†’        description=data.get("description", ""),
   400â†’        expert_persona=data.get("expert_persona", ""),
   401â†’        scenarios=data.get("scenarios", {}),
   402â†’        ethics=data.get("ethics", {}),
   403â†’        tools=data.get("tools", []),
   404â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   405â†’        triggers=data.get("triggers", []),
   406â†’        global_tools=data.get("global_tools", []),
   407â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   408â†’        requires_birth_info=data.get("requires_birth_info", False),
   409â†’        requires_compute=data.get("requires_compute", False),
   410â†’        compute_type=data.get("compute_type", None),
   411â†’        compute_tool=data.get("compute_tool", None),
   412â†’    )
   413â†’
   414â†’
   415â†’@lru_cache(maxsize=64)
   416â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   417â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   418â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   419â†’    if not scenario_path.exists():
   420â†’        return None
   421â†’
   422â†’    text = scenario_path.read_text(encoding='utf-8')
   423â†’    data = parse_scenario_md(text)
   424â†’
   425â†’    return ScenarioConfig(
   426â†’        id=data.get("id", scenario_id),
   427â†’        name=data.get("name", scenario_id),
   428â†’        level=data.get("level", "entry"),
   429â†’        billing=data.get("billing", "free"),
   430â†’        description=data.get("description", ""),
   431â†’        triggers=data.get("triggers", {}),
   432â†’        prerequisites=data.get("prerequisites", []),
   433â†’        sop=data.get("sop", []),
   434â†’        knowledge_config=data.get("knowledge_config", {}),
   435â†’        output_config=data.get("output_config", {}),
   436â†’        tools=data.get("tools", [])
   437â†’    )
   438â†’
   439â†’
   440â†’@lru_cache(maxsize=128)
   441â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   442â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢"""
   443â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   444â†’    if not rule_path.exists():
   445â†’        return None
   446â†’
   447â†’    text = rule_path.read_text(encoding='utf-8')
   448â†’    data = parse_rule_md(text)
   449â†’
   450â†’    return RuleConfig(
   451â†’        id=data.get("id", rule_id),
   452â†’        name=data.get("name", rule_id),
   453â†’        impact=data.get("impact", "MEDIUM"),
   454â†’        impact_description=data.get("impact_description", ""),
   455â†’        tags=data.get("tags", []),
   456â†’        content=data.get("content", ""),
   457â†’        analysis_steps=data.get("analysis_steps", []),
   458â†’        output_requirements=data.get("output_requirements", ""),
   459â†’        common_questions=data.get("common_questions", ""),
   460â†’    )
   461â†’
   462â†’
   463â†’def get_skill_rules(skill_id: str) -> List[str]:
   464â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢"""
   465â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   466â†’    if not rules_dir.exists():
   467â†’        return []
   468â†’    return [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   469â†’
   470â†’
   471â†’def has_rules(skill_id: str) -> bool:
   472â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   473â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   474â†’    if not rules_dir.exists():
   475â†’        return False
   476â†’    rules = list(rules_dir.glob("*.md"))
   477â†’    return len(rules) > 0
   478â†’
   479â†’
   480â†’def get_available_skills() -> List[str]:
   481â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   482â†’    if not SKILLS_DIR.exists():
   483â†’        return []
   484â†’    return [p.name for p in SKILLS_DIR.iterdir()
   485â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   486â†’
   487â†’
   488â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   489â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   490â†’
   491â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   492â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   493â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼‰
   494â†’    """
   495â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   496â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   497â†’    if rules_dir.exists():
   498â†’        rules = [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   499â†’        if rules:
   500â†’            return rules
   501â†’
   502â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   503â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   504â†’    if not scenarios_dir.exists():
   505â†’        return []
   506â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   507â†’
   508â†’
   509â†’def get_skill_triggers() -> Dict[str, List[str]]:
   510â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   511â†’    triggers = {}
   512â†’    for skill_id in get_available_skills():
   513â†’        if skill_id == "core":
   514â†’            continue
   515â†’        skill = load_skill(skill_id)
   516â†’        if skill and skill.triggers:
   517â†’            triggers[skill_id] = skill.triggers
   518â†’    return triggers
   519â†’
   520â†’
   521â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   522â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   523â†’    skill = load_skill(skill_id)
   524â†’    if skill and skill.global_tools:
   525â†’        return skill.global_tools
   526â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   527â†’    return []
   528â†’
   529â†’
   530â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   531â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
   532â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   533â†’
   534â†’def skill_requires_birth_info(skill_id: str) -> bool:
   535â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   536â†’    skill = load_skill(skill_id)
   537â†’    return skill.requires_birth_info if skill else False
   538â†’
   539â†’
   540â†’def skill_requires_compute(skill_id: str) -> bool:
   541â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   542â†’    skill = load_skill(skill_id)
   543â†’    return skill.requires_compute if skill else False
   544â†’
   545â†’
   546â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
   547â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
   548â†’
   549â†’    è¿”å›å€¼ï¼š
   550â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
   551â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
   552â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
   553â†’    """
   554â†’    skill = load_skill(skill_id)
   555â†’    return skill.compute_type if skill else None
   556â†’
   557â†’
   558â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
   559â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   560â†’
   561â†’    è¿”å›å€¼ï¼š
   562â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
   563â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   564â†’    """
   565â†’    skill = load_skill(skill_id)
   566â†’    return skill.compute_tool if skill else None
   567â†’
   568â†’
   569â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   570â†’# System Prompt æ„å»º
   571â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   572â†’
   573â†’def build_system_prompt(
   574â†’    skill_id: str,
   575â†’    scenario_id: Optional[str] = None,
   576â†’    user_context: Optional[Dict] = None
   577â†’) -> str:
   578â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
   579â†’
   580â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
   581â†’    """
   582â†’    parts = []
   583â†’
   584â†’    # åŠ è½½ Skill
   585â†’    skill = load_skill(skill_id)
   586â†’    if not skill:
   587â†’        return ""
   588â†’
   589â†’    # ä¸“å®¶èº«ä»½
   590â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   591â†’
   592â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
   593â†’    if scenario_id:
   594â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
   595â†’        if has_rules(skill_id):
   596â†’            rule = load_rule(skill_id, scenario_id)
   597â†’            if rule:
   598â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
   599â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
   600â†’                parts.append(rule.content)
   601â†’            else:
   602â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
   603â†’                scenario = load_scenario(skill_id, scenario_id)
   604â†’                if scenario:
   605â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   606â†’                    if scenario.sop:
   607â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   608â†’                        for phase in scenario.sop:
   609â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   610â†’                        parts.append(sop_text)
   611â†’        else:
   612â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
   613â†’            scenario = load_scenario(skill_id, scenario_id)
   614â†’            if scenario:
   615â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   616â†’                # SOP
   617â†’                if scenario.sop:
   618â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   619â†’                    for phase in scenario.sop:
   620â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   621â†’                    parts.append(sop_text)
   622â†’
   623â†’    # ä¼¦ç†è¾¹ç•Œ
   624â†’    if skill.ethics.get("forbidden"):
   625â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   626â†’        for item in skill.ethics["forbidden"]:
   627â†’            ethics_text += f"- {item}\n"
   628â†’        parts.append(ethics_text)
   629â†’
   630â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ
   631â†’    if user_context:
   632â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   633â†’
   634â†’        # ç‰¹æ®Šå¤„ç† birth_info
   635â†’        if user_context.get("birth_info"):
   636â†’            birth_info = user_context['birth_info']
   637â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
   638â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
   639â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
   640â†’
   641â†’        # ç‰¹æ®Šå¤„ç† portrait
   642â†’        if user_context.get("portrait"):
   643â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
   644â†’
   645â†’        # ç‰¹æ®Šå¤„ç† extracted (æŠ½å–çš„ç”¨æˆ·ä¿¡æ¯)
   646â†’        if user_context.get("extracted"):
   647â†’            extracted = user_context['extracted']
   648â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
   649â†’            if extracted.get("facts"):
   650â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
   651â†’            if extracted.get("concerns"):
   652â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
   653â†’            if extracted.get("goals"):
   654â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
   655â†’            if extracted.get("pain_points"):
   656â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
   657â†’            if extracted.get("life_events"):
   658â†’                events = [f"{e.get('date', '?')}: {e.get('event', '')}" for e in extracted['life_events'][:5]]
   659â†’                ctx_text += f"**è¿‘æœŸäº‹ä»¶**: {'; '.join(events)}\n"
   660â†’
   661â†’        # ç‰¹æ®Šå¤„ç† identity_prism
   662â†’        if user_context.get("identity_prism"):
   663â†’            prism = user_context['identity_prism']
   664â†’            ctx_text += f"\n### èº«ä»½ç‰¹å¾\n"
   665â†’            if prism.get("core"):
   666â†’                ctx_text += f"**æ ¸å¿ƒç‰¹è´¨**: {prism['core']}\n"
   667â†’            if prism.get("inner"):
   668â†’                ctx_text += f"**å†…åœ¨éœ€æ±‚**: {prism['inner']}\n"
   669â†’            if prism.get("outer"):
   670â†’                ctx_text += f"**å¤–åœ¨è¡¨ç°**: {prism['outer']}\n"
   671â†’
   672â†’        # ç‰¹æ®Šå¤„ç† life_context
   673â†’        if user_context.get("life_context"):
   674â†’            life_ctx = user_context['life_context']
   675â†’            if life_ctx.get("concerns") or life_ctx.get("goals") or life_ctx.get("pain_points"):
   676â†’                ctx_text += f"\n### ç”Ÿæ´»èƒŒæ™¯\n"
   677â†’                if life_ctx.get("concerns"):
   678â†’                    ctx_text += f"**å…³æ³¨**: {', '.join(life_ctx['concerns'])}\n"
   679â†’                if life_ctx.get("goals"):
   680â†’                    ctx_text += f"**ç›®æ ‡**: {', '.join(life_ctx['goals'])}\n"
   681â†’                if life_ctx.get("pain_points"):
   682â†’                    ctx_text += f"**å›°éš¾**: {', '.join(life_ctx['pain_points'])}\n"
   683â†’
   684â†’        parts.append(ctx_text)
   685â†’
   686â†’    return "\n".join(parts)
   687â†’
   688â†’
   689â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   690â†’# ç¼“å­˜ç®¡ç†
   691â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   692â†’
   693â†’def clear_cache():
   694â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
   695â†’    load_skill.cache_clear()
   696â†’    load_scenario.cache_clear()
   697â†’    load_rule.cache_clear()
   698â†’    get_scenario_triggers.cache_clear()
   699â†’    get_rule_triggers.cache_clear()
   700â†’    logger.info("Skill cache cleared")
   701â†’
   702â†’
   703â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
   704â†’    """é‡è½½å•ä¸ª Skill"""
   705â†’    load_skill.cache_clear()
   706â†’    load_scenario.cache_clear()
   707â†’    load_rule.cache_clear()
   708â†’    return load_skill(skill_id)
   709â†’
   710â†’
   711â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   712â†’# åœºæ™¯è·¯ç”± (å†…å­˜åŒ¹é…)
   713â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   714â†’
   715â†’def parse_scenario_triggers(text: str) -> Dict[str, Dict[str, List[str]]]:
   716â†’    """ä» SKILL.md è§£æåœºæ™¯ç›®å½•è¡¨æ ¼ï¼Œæå–è§¦å‘è¯"""
   717â†’    triggers = {}  # {scenario_id: {primary: [...], secondary: [...]}}
   718â†’
   719â†’    # åŒ¹é…ä¸‰ä¸ªçº§åˆ«çš„è¡¨æ ¼
   720â†’    for level in ["entry", "standard", "professional"]:
   721â†’        pattern = rf'### {level.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   722â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   723â†’        if not match:
   724â†’            continue
   725â†’
   726â†’        for row in match.group(1).strip().split('\n'):
   727â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   728â†’            if len(cols) >= 3:
   729â†’                # cols[1] = æ–‡ä»¶å, cols[2] = è§¦å‘è¯
   730â†’                scenario_id = cols[1].replace('.md', '')
   731â†’                trigger_str = cols[2]
   732â†’                # è§£æè§¦å‘è¯ï¼ˆç”¨é¡¿å·æˆ–é€—å·åˆ†éš”ï¼‰
   733â†’                trigger_words = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   734â†’                triggers[scenario_id] = {
   735â†’                    "primary": trigger_words,
   736â†’                    "secondary": []
   737â†’                }
   738â†’
   739â†’    return triggers
   740â†’
   741â†’
   742â†’@lru_cache(maxsize=32)
   743â†’def get_scenario_triggers(skill_id: str) -> Dict[str, Dict[str, List[str]]]:
   744â†’    """è·å– Skill çš„åœºæ™¯è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
   745â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   746â†’    if not skill_path.exists():
   747â†’        return {}
   748â†’
   749â†’    text = skill_path.read_text(encoding='utf-8')
   750â†’    return parse_scenario_triggers(text)
   751â†’
   752â†’
   753â†’def route_scenario(skill_id: str, message: str) -> Optional[str]:
   754â†’    """
   755â†’    å†…å­˜åœºæ™¯è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³åœºæ™¯
   756â†’
   757â†’    Args:
   758â†’        skill_id: Skill ID
   759â†’        message: ç”¨æˆ·æ¶ˆæ¯
   760â†’
   761â†’    Returns:
   762â†’        åŒ¹é…çš„ scenario_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
   763â†’    """
   764â†’    triggers = get_scenario_triggers(skill_id)
   765â†’    if not triggers:
   766â†’        return None
   767â†’
   768â†’    best_match = None
   769â†’    best_score = 0
   770â†’
   771â†’    for scenario_id, trigger_config in triggers.items():
   772â†’        score = 0
   773â†’        # ä¸»è¦è§¦å‘è¯æƒé‡ 1.0
   774â†’        for word in trigger_config.get("primary", []):
   775â†’            if word in message:
   776â†’                score += 1.0
   777â†’        # æ¬¡è¦è§¦å‘è¯æƒé‡ 0.5
   778â†’        for word in trigger_config.get("secondary", []):
   779â†’            if word in message:
   780â†’                score += 0.5
   781â†’
   782â†’        if score > best_score:
   783â†’            best_score = score
   784â†’            best_match = scenario_id
   785â†’
   786â†’    return best_match
   787â†’
   788â†’
   789â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   790â†’# è§„åˆ™è·¯ç”± (v7 æ–°å¢)
   791â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   792â†’
   793â†’@lru_cache(maxsize=32)
   794â†’def get_rule_triggers(skill_id: str) -> Dict[str, List[str]]:
   795â†’    """è·å– Skill çš„è§„åˆ™è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰- v7 æ–°å¢
   796â†’
   797â†’    ä» rules/*.md çš„ frontmatter ä¸­è¯»å– tags ä½œä¸ºè§¦å‘è¯
   798â†’    """
   799â†’    triggers = {}  # {rule_id: [tag1, tag2, ...]}
   800â†’
   801â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   802â†’    if not rules_dir.exists():
   803â†’        return triggers
   804â†’
   805â†’    for rule_path in rules_dir.glob("*.md"):
   806â†’        if rule_path.stem.startswith("_"):
   807â†’            continue
   808â†’
   809â†’        rule = load_rule(skill_id, rule_path.stem)
   810â†’        if rule and rule.tags:
   811â†’            triggers[rule.id] = rule.tags
   812â†’
   813â†’    return triggers
   814â†’
   815â†’
   816â†’def route_to_rule(skill_id: str, message: str) -> Optional[str]:
   817â†’    """
   818â†’    è§„åˆ™è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³è§„åˆ™ - v7 æ–°å¢
   819â†’
   820â†’    ä½¿ç”¨ tags è¿›è¡Œè¯­ä¹‰åŒ¹é…ï¼Œæ”¯æŒæ›´çµæ´»çš„è·¯ç”±
   821â†’
   822â†’    Args:
   823â†’        skill_id: Skill ID
   824â†’        message: ç”¨æˆ·æ¶ˆæ¯
   825â†’
   826â†’    Returns:
   827â†’        åŒ¹é…çš„ rule_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
   828â†’    """
   829â†’    # ä¼˜å…ˆä½¿ç”¨è§„åˆ™è·¯ç”±
   830â†’    if has_rules(skill_id):
   831â†’        triggers = get_rule_triggers(skill_id)
   832â†’        if not triggers:
   833â†’            return None
   834â†’
   835â†’        best_match = None
   836â†’        best_score = 0
   837â†’
   838â†’        for rule_id, tags in triggers.items():
   839â†’            score = 0
   840â†’            for tag in tags:
   841â†’                if tag in message:
   842â†’                    score += 1.0
   843â†’
   844â†’            if score > best_score:
   845â†’                best_score = score
   846â†’                best_match = rule_id
   847â†’
   848â†’        return best_match
   849â†’
   850â†’    # å›é€€åˆ°åœºæ™¯è·¯ç”±ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
   851â†’    return route_scenario(skill_id, message)
   852â†’
   853â†’
   854â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
   855â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
   856â†’
   857â†’    Args:
   858â†’        skill_id: Skill ID
   859â†’        rule_id: Rule ID
   860â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
   861â†’
   862â†’    Returns:
   863â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
   864â†’    """
   865â†’    parts = []
   866â†’
   867â†’    # åŠ è½½ Skill
   868â†’    skill = load_skill(skill_id)
   869â†’    if not skill:
   870â†’        return ""
   871â†’
   872â†’    # ä¸“å®¶èº«ä»½
   873â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   874â†’
   875â†’    # åŠ è½½è§„åˆ™
   876â†’    rule = load_rule(skill_id, rule_id)
   877â†’    if rule:
   878â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
   879â†’
   880â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
   881â†’        parts.append(rule.content)
   882â†’
   883â†’    # ä¼¦ç†è¾¹ç•Œ
   884â†’    if skill.ethics.get("forbidden"):
   885â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   886â†’        for item in skill.ethics["forbidden"]:
   887â†’            ethics_text += f"- {item}\n"
   888â†’        parts.append(ethics_text)
   889â†’
   890â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
   891â†’    if user_context:
   892â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   893â†’
   894â†’        if user_context.get("birth_info"):
   895â†’            birth_info = user_context['birth_info']
   896â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
   897â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
   898â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
   899â†’
   900â†’        if user_context.get("portrait"):
   901â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
   902â†’
   903â†’        if user_context.get("extracted"):
   904â†’            extracted = user_context['extracted']
   905â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
   906â†’            if extracted.get("facts"):
   907â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
   908â†’            if extracted.get("concerns"):
   909â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
   910â†’            if extracted.get("goals"):
   911â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
   912â†’            if extracted.get("pain_points"):
   913â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
   914â†’
   915â†’        parts.append(ctx_text)
   916â†’
   917â†’    return "\n".join(parts)
   918â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
