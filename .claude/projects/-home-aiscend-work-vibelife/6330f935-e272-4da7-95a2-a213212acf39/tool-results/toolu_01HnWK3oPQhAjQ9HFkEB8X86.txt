     1→"""
     2→Zodiac Skill Tool Handlers - 星座工具执行器
     3→
     4→使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
     5→"""
     6→import logging
     7→from datetime import datetime
     8→from typing import Dict, Any
     9→
    10→from services.agent.tool_registry import tool_handler, ToolContext
    11→
    12→logger = logging.getLogger(__name__)
    13→
    14→
    15→@tool_handler("calculate_zodiac")
    16→async def execute_calculate_zodiac(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    17→    """
    18→    计算用户星盘 - 使用 Swiss Ephemeris 精确计算
    19→
    20→    这是 SOP P2 阶段的核心工具，负责：
    21→    1. 从 args 或 profile 获取出生信息
    22→    2. 调用 Swiss Ephemeris 计算精确星盘
    23→    3. 返回计算结果供后续分析使用
    24→    """
    25→    from services.agent.tool_registry import ToolRegistry
    26→    from skills.zodiac.services import calculate_zodiac as calc_zodiac
    27→
    28→    profile = context.profile or {}
    29→    birth_info = profile.get("birth_info", {})
    30→
    31→    # 优先使用 args 中的参数，否则从 profile 读取
    32→    birth_date = args.get("birth_date") or birth_info.get("date")
    33→    birth_time = args.get("birth_time") or birth_info.get("time", "12:00")
    34→    birth_place = args.get("birth_place") or birth_info.get("place", "Shanghai")
    35→
    36→    if not birth_date:
    37→        return {
    38→            "status": "error",
    39→            "error": "需要出生日期才能计算星盘",
    40→            "action": "collect_birth_info"
    41→        }
    42→
    43→    try:
    44→        # 使用 Swiss Ephemeris 计算精确星盘
    45→        chart = calc_zodiac(
    46→            birth_date=birth_date,
    47→            birth_time=birth_time,
    48→            birth_place=birth_place
    49→        )
    50→
    51→        logger.info(f"Calculated zodiac chart for user {context.user_id}: "
    52→                   f"Sun={chart.get('sun_sign')}, Moon={chart.get('moon_sign')}, "
    53→                   f"Rising={chart.get('rising_sign')}")
    54→
    55→        # 构建卡片数据用于展示
    56→        card_data = {
    57→            "userId": context.user_id,
    58→            "birthInfo": {
    59→                "date": birth_date,
    60→                "time": birth_time,
    61→                "place": birth_place,
    62→            },
    63→            "sunSign": chart.get("sun_sign_chinese", chart.get("sun_sign")),
    64→            "moonSign": chart.get("moon_sign_chinese", chart.get("moon_sign")),
    65→            "risingSign": chart.get("rising_sign_chinese", chart.get("rising_sign")),
    66→            "planets": chart.get("planets", []),
    67→            "aspects": chart.get("aspects", []),
    68→            "dominantElement": chart.get("dominant_element"),
    69→            "dominantModality": chart.get("dominant_modality"),
    70→            # 完整 chart 数据供后续使用
    71→            "_chart": chart,
    72→        }
    73→
    74→        # 展示星盘卡片
    75→        return await ToolRegistry.execute(
    76→            "show_card",
    77→            {
    78→                "card_type": "custom",
    79→                "data_source": {"type": "inline", "data": card_data},
    80→                "options": {"componentId": "zodiac_chart"}
    81→            },
    82→            context
    83→        )
    84→
    85→    except Exception as e:
    86→        logger.error(f"calculate_zodiac failed: {e}")
    87→        return {
    88→            "status": "error",
    89→            "error": f"星盘计算失败: {str(e)}",
    90→        }
    91→
    92→
    93→@tool_handler("collect_zodiac_info")
    94→async def execute_collect_zodiac_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    95→    """收集用户出生信息用于星盘分析"""
    96→    fields = [
    97→        {"id": "birthDate", "label": "出生日期", "type": "date", "required": True, "placeholder": ""},
    98→        {"id": "birthTime", "label": "出生时间", "type": "time", "required": True, "placeholder": ""},
    99→        {"id": "birthPlace", "label": "出生地点", "type": "location", "required": True, "placeholder": "城市名"},
   100→    ]
   101→
   102→    return {
   103→        "status": "collecting",
   104→        "cardType": "collect_form",
   105→        "formType": "birth_info",
   106→        "title": "请填写出生信息",
   107→        "description": "准确的出生时间和地点对于星盘分析至关重要",
   108→        "fields": fields,
   109→    }
   110→
   111→
   112→@tool_handler("show_zodiac_chart")
   113→async def execute_show_zodiac_chart(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   114→    """展示星盘 - V7 委托模式"""
   115→    from services.agent.tool_registry import ToolRegistry
   116→
   117→    profile = context.profile or {}
   118→    skill_data = context.skill_data or {}
   119→    birth_info = profile.get("birth_info", {})
   120→
   121→    # 从 skill_data 读取已计算的星盘
   122→    zodiac_data = skill_data.get("zodiac", {})
   123→    chart = zodiac_data.get("chart", {}) if zodiac_data else {}
   124→
   125→    # 如果没有星盘数据，提示先计算
   126→    if not chart:
   127→        return {
   128→            "status": "error",
   129→            "error": "尚未计算星盘，请先调用 calculate_zodiac",
   130→            "action": "calculate_zodiac"
   131→        }
   132→
   133→    # 构建卡片数据（只使用真实计算结果，不使用假数据）
   134→    card_data = {
   135→        "userId": context.user_id,
   136→        "birthInfo": {
   137→            "date": birth_info.get("date"),
   138→            "time": birth_info.get("time"),
   139→            "place": birth_info.get("place"),
   140→        },
   141→        "sunSign": chart.get("sun_sign_chinese") or chart.get("sun_sign"),
   142→        "moonSign": chart.get("moon_sign_chinese") or chart.get("moon_sign"),
   143→        "risingSign": chart.get("rising_sign_chinese") or chart.get("rising_sign"),
   144→        "planets": chart.get("planets", []),
   145→        "aspects": chart.get("aspects", []),
   146→        "dominantElement": chart.get("dominant_element"),
   147→        "dominantModality": chart.get("dominant_modality"),
   148→    }
   149→
   150→    logger.info(f"Showing zodiac chart via show_card for user {context.user_id}")
   151→
   152→    return await ToolRegistry.execute(
   153→        "show_card",
   154→        {
   155→            "card_type": "custom",
   156→            "data_source": {"type": "inline", "data": card_data},
   157→            "options": {"componentId": "zodiac_chart"}
   158→        },
   159→        context
   160→    )
   161→
   162→
   163→@tool_handler("show_zodiac_transit")
   164→async def execute_show_zodiac_transit(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   165→    """展示行运分析 - V7 委托模式"""
   166→    from services.agent.tool_registry import ToolRegistry
   167→    from skills.zodiac.services import calculate_transit, calculate_zodiac
   168→
   169→    profile = context.profile or {}
   170→    birth_info = profile.get("birth_info", {})
   171→
   172→    # 获取出生信息
   173→    birth_date = birth_info.get("date")
   174→    birth_time = birth_info.get("time", "12:00")
   175→    birth_place = birth_info.get("place", "Shanghai")
   176→
   177→    transit_date = args.get("date") or datetime.now().strftime("%Y-%m-%d")
   178→
   179→    # 如果没有出生信息，返回通用行运
   180→    if not birth_date:
   181→        card_data = {
   182→            "date": transit_date,
   183→            "transits": [],
   184→            "majorEvents": [],
   185→            "overallEnergy": "请先提供出生信息以获取个性化行运分析。",
   186→            "advice": "完善出生信息后，可以看到行星对你本命盘的具体影响。",
   187→            "needBirthInfo": True,
   188→        }
   189→        return await ToolRegistry.execute(
   190→            "show_card",
   191→            {
   192→                "card_type": "custom",
   193→                "data_source": {"type": "inline", "data": card_data},
   194→                "options": {"componentId": "zodiac_transit"}
   195→            },
   196→            context
   197→        )
   198→
   199→    try:
   200→        # 计算行运
   201→        transits = calculate_transit(
   202→            birth_date=birth_date,
   203→            birth_time=birth_time,
   204→            birth_place=birth_place,
   205→            transit_date=transit_date
   206→        )
   207→
   208→        # 生成整体能量描述
   209→        positive_count = sum(1 for t in transits if t.get("influence") == "positive")
   210→        challenging_count = sum(1 for t in transits if t.get("influence") == "challenging")
   211→
   212→        if positive_count > challenging_count:
   213→            overall_energy = "整体能量积极，适合推进重要事项。"
   214→            advice = "把握有利时机，主动出击。"
   215→        elif challenging_count > positive_count:
   216→            overall_energy = "整体能量需要调整，适合反思和准备。"
   217→            advice = "放慢脚步，处理好细节问题。"
   218→        else:
   219→            overall_energy = "能量平衡，稳中求进。"
   220→            advice = "保持节奏，按计划推进。"
   221→
   222→        card_data = {
   223→            "date": transit_date,
   224→            "transits": transits,
   225→            "majorEvents": [],
   226→            "overallEnergy": overall_energy,
   227→            "advice": advice,
   228→        }
   229→
   230→        logger.info(f"Showing zodiac transit via show_card for user {context.user_id}")
   231→
   232→        return await ToolRegistry.execute(
   233→            "show_card",
   234→            {
   235→                "card_type": "custom",
   236→                "data_source": {"type": "inline", "data": card_data},
   237→                "options": {"componentId": "zodiac_transit"}
   238→            },
   239→            context
   240→        )
   241→    except Exception as e:
   242→        logger.error(f"show_zodiac_transit failed: {e}")
   243→        return {
   244→            "status": "error",
   245→            "error": str(e),
   246→        }
   247→
   248→
   249→@tool_handler("show_zodiac_synastry")
   250→async def execute_show_zodiac_synastry(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   251→    """展示合盘分析 - V7 委托模式"""
   252→    from services.agent.tool_registry import ToolRegistry
   253→    from skills.zodiac.services import calculate_synastry
   254→
   255→    profile = context.profile or {}
   256→    birth_info = profile.get("birth_info", {})
   257→
   258→    # 获取用户出生信息
   259→    person1_birth_date = birth_info.get("date")
   260→    person1_birth_time = birth_info.get("time", "12:00")
   261→    person1_birth_place = birth_info.get("place", "Shanghai")
   262→
   263→    # 获取对方出生信息
   264→    person2_birth_date = args.get("partner_birth_date")
   265→    person2_birth_time = args.get("partner_birth_time", "12:00")
   266→    person2_birth_place = args.get("partner_birth_place", "Shanghai")
   267→
   268→    # 检查必要信息
   269→    if not person1_birth_date:
   270→        return {
   271→            "status": "error",
   272→            "error": "请先提供你的出生信息",
   273→            "needBirthInfo": True,
   274→        }
   275→
   276→    if not person2_birth_date:
   277→        return {
   278→            "status": "error",
   279→            "error": "请提供对方的出生日期",
   280→            "needPartnerInfo": True,
   281→        }
   282→
   283→    try:
   284→        # 计算合盘
   285→        result = calculate_synastry(
   286→            person1_birth_date=person1_birth_date,
   287→            person1_birth_time=person1_birth_time,
   288→            person1_birth_place=person1_birth_place,
   289→            person2_birth_date=person2_birth_date,
   290→            person2_birth_time=person2_birth_time,
   291→            person2_birth_place=person2_birth_place,
   292→        )
   293→
   294→        if "error" in result:
   295→            return {
   296→                "status": "error",
   297→                "error": result["error"],
   298→            }
   299→
   300→        logger.info(f"Showing zodiac synastry via show_card for user {context.user_id}")
   301→
   302→        return await ToolRegistry.execute(
   303→            "show_card",
   304→            {
   305→                "card_type": "custom",
   306→                "data_source": {"type": "inline", "data": result},
   307→                "options": {"componentId": "zodiac_synastry"}
   308→            },
   309→            context
   310→        )
   311→    except Exception as e:
   312→        logger.error(f"show_zodiac_synastry failed: {e}")
   313→        return {
   314→            "status": "error",
   315→            "error": str(e),
   316→        }
   317→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
