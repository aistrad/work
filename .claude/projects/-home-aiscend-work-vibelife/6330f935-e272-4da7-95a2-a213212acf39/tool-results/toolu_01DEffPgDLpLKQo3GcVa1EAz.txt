     1→"""
     2→JungAstro Skill 工具执行器
     3→
     4→架构说明：
     5→- 复用 zodiac skill 的计算服务 (calculate_zodiac)
     6→- 添加荣格心理学解读层 (JungianInterpreter)
     7→- 定义独立的卡片类型 (jungastro_*)
     8→
     9→数据获取方式：
    10→- 从 context.profile 获取用户出生信息
    11→- 从 context.skill_data 获取已计算的星盘数据
    12→- 调用 zodiac 的计算函数进行实时计算
    13→"""
    14→
    15→import logging
    16→from datetime import datetime
    17→from typing import Dict, Any, Optional
    18→
    19→from services.agent.tool_registry import tool_handler, ToolContext
    20→
    21→logger = logging.getLogger(__name__)
    22→
    23→
    24→# ═══════════════════════════════════════════════════════════════════════════════
    25→# 服务层导入 - 复用 zodiac 计算能力
    26→# ═══════════════════════════════════════════════════════════════════════════════
    27→
    28→def get_zodiac_chart(context: ToolContext) -> Optional[Dict[str, Any]]:
    29→    """
    30→    从 context 获取用户星盘数据
    31→
    32→    优先级：
    33→    1. context.skill_data["zodiac"]["chart"] - 已计算的完整星盘
    34→    2. 使用 birth_info 实时计算
    35→    """
    36→    profile = context.profile or {}
    37→    skill_data = context.skill_data or {}
    38→
    39→    # 优先从 skill_data 读取已计算的星盘
    40→    zodiac_data = skill_data.get("zodiac", {})
    41→    if zodiac_data.get("chart"):
    42→        return zodiac_data["chart"]
    43→
    44→    # 否则尝试实时计算
    45→    birth_info = profile.get("birth_info", {})
    46→    birth_date = birth_info.get("date")
    47→
    48→    if not birth_date:
    49→        return None
    50→
    51→    try:
    52→        from skills.zodiac.services import calculate_zodiac
    53→        chart = calculate_zodiac(
    54→            birth_date=birth_date,
    55→            birth_time=birth_info.get("time", "12:00"),
    56→            birth_place=birth_info.get("place", "Shanghai")
    57→        )
    58→        return chart
    59→    except Exception as e:
    60→        logger.error(f"Failed to calculate zodiac chart: {e}")
    61→        return None
    62→
    63→
    64→def get_jungian_interpreter():
    65→    """获取荣格心理解读器"""
    66→    try:
    67→        from skills.jungastro.services.interpreter import JungianInterpreter
    68→        return JungianInterpreter()
    69→    except ImportError:
    70→        logger.warning("JungianInterpreter not available")
    71→        return None
    72→
    73→
    74→# ═══════════════════════════════════════════════════════════════════════════════
    75→# 工具执行器
    76→# ═══════════════════════════════════════════════════════════════════════════════
    77→
    78→@tool_handler("show_psychological_portrait")
    79→async def handle_show_psychological_portrait(
    80→    args: Dict[str, Any],
    81→    context: ToolContext
    82→) -> Dict[str, Any]:
    83→    """
    84→    展示心理画像 - V7 委托模式
    85→
    86→    复用 zodiac 计算器获取星盘数据，
    87→    然后用 JungianInterpreter 进行心理学解读。
    88→    """
    89→    from services.agent.tool_registry import ToolRegistry
    90→
    91→    focus = args.get("focus", "full")
    92→
    93→    # 1. 获取用户星盘数据
    94→    chart_data = get_zodiac_chart(context)
    95→
    96→    if not chart_data:
    97→        return {
    98→            "status": "error",
    99→            "error": "需要出生信息才能进行心理画像分析",
   100→            "action": "collect_birth_info"
   101→        }
   102→
   103→    # 2. 荣格心理解读
   104→    portrait = {
   105→        "ego": _analyze_ego(chart_data),           # 太阳分析
   106→        "unconscious": _analyze_unconscious(chart_data),  # 月亮分析
   107→        "persona": _analyze_persona(chart_data),   # 上升分析
   108→        "functions": _analyze_functions(chart_data),  # 功能分布
   109→    }
   110→
   111→    # 3. 如果有解读器，使用更深度的分析
   112→    interpreter = get_jungian_interpreter()
   113→    if interpreter:
   114→        portrait = interpreter.analyze_psychological_portrait(chart_data, focus)
   115→
   116→    logger.info(f"Showing psychological portrait via show_card for user {context.user_id}")
   117→
   118→    return await ToolRegistry.execute(
   119→        "show_card",
   120→        {
   121→            "card_type": "custom",
   122→            "data_source": {"type": "inline", "data": portrait},
   123→            "options": {"componentId": "jungastro_portrait"}
   124→        },
   125→        context
   126→    )
   127→
   128→
   129→@tool_handler("show_shadow_analysis")
   130→async def handle_show_shadow_analysis(
   131→    args: Dict[str, Any],
   132→    context: ToolContext
   133→) -> Dict[str, Any]:
   134→    """
   135→    展示阴影分析 - V7 委托模式
   136→
   137→    分析困难相位、冥王星配置、12宫内容等。
   138→    """
   139→    from services.agent.tool_registry import ToolRegistry
   140→
   141→    chart_data = get_zodiac_chart(context)
   142→
   143→    if not chart_data:
   144→        return {
   145→            "status": "error",
   146→            "error": "需要出生信息才能进行阴影分析",
   147→            "action": "collect_birth_info"
   148→        }
   149→
   150→    shadow = {
   151→        "difficult_aspects": _find_difficult_aspects(chart_data),
   152→        "pluto_analysis": _analyze_pluto(chart_data),
   153→        "twelfth_house": _analyze_twelfth_house(chart_data),
   154→        "saturn_analysis": _analyze_saturn(chart_data),
   155→        "shadow_patterns": [],
   156→        "integration_path": ""
   157→    }
   158→
   159→    logger.info(f"Showing shadow analysis via show_card for user {context.user_id}")
   160→
   161→    return await ToolRegistry.execute(
   162→        "show_card",
   163→        {
   164→            "card_type": "custom",
   165→            "data_source": {"type": "inline", "data": shadow},
   166→            "options": {"componentId": "jungastro_shadow"}
   167→        },
   168→        context
   169→    )
   170→
   171→
   172→@tool_handler("show_individuation_path")
   173→async def handle_show_individuation_path(
   174→    args: Dict[str, Any],
   175→    context: ToolContext
   176→) -> Dict[str, Any]:
   177→    """
   178→    展示个体化路径 - V7 委托模式
   179→
   180→    分析土星周期、外行星行运、成长方向。
   181→    """
   182→    from services.agent.tool_registry import ToolRegistry
   183→
   184→    chart_data = get_zodiac_chart(context)
   185→
   186→    if not chart_data:
   187→        return {
   188→            "status": "error",
   189→            "error": "需要出生信息才能分析个体化路径",
   190→            "action": "collect_birth_info"
   191→        }
   192→
   193→    # 从 profile 获取出生日期计算年龄
   194→    profile = context.profile or {}
   195→    birth_info = profile.get("birth_info", {})
   196→    birth_date = birth_info.get("date")
   197→    age = _calculate_age(birth_date) if birth_date else None
   198→
   199→    individuation = {
   200→        "current_stage": _determine_life_stage(age),
   201→        "saturn_cycle": _analyze_saturn_cycle(chart_data, age),
   202→        "outer_planet_transits": [],  # 简化实现
   203→        "growth_direction": "",
   204→        "integration_tasks": []
   205→    }
   206→
   207→    logger.info(f"Showing individuation path via show_card for user {context.user_id}")
   208→
   209→    return await ToolRegistry.execute(
   210→        "show_card",
   211→        {
   212→            "card_type": "custom",
   213→            "data_source": {"type": "inline", "data": individuation},
   214→            "options": {"componentId": "jungastro_individuation"}
   215→        },
   216→        context
   217→    )
   218→
   219→
   220→@tool_handler("show_psychological_functions")
   221→async def handle_show_psychological_functions(
   222→    args: Dict[str, Any],
   223→    context: ToolContext
   224→) -> Dict[str, Any]:
   225→    """
   226→    展示心理功能分布 - V7 委托模式
   227→
   228→    分析元素分布、模式分布、主导/劣势功能。
   229→    """
   230→    from services.agent.tool_registry import ToolRegistry
   231→
   232→    chart_data = get_zodiac_chart(context)
   233→
   234→    if not chart_data:
   235→        return {
   236→            "status": "error",
   237→            "error": "需要出生信息才能分析心理功能",
   238→            "action": "collect_birth_info"
   239→        }
   240→
   241→    functions = _analyze_functions(chart_data)
   242→
   243→    logger.info(f"Showing psychological functions via show_card for user {context.user_id}")
   244→
   245→    return await ToolRegistry.execute(
   246→        "show_card",
   247→        {
   248→            "card_type": "custom",
   249→            "data_source": {"type": "inline", "data": functions},
   250→            "options": {"componentId": "jungastro_functions"}
   251→        },
   252→        context
   253→    )
   254→
   255→
   256→@tool_handler("show_relationship_dynamics")
   257→async def handle_show_relationship_dynamics(
   258→    args: Dict[str, Any],
   259→    context: ToolContext
   260→) -> Dict[str, Any]:
   261→    """
   262→    展示关系动力学 - V7 委托模式
   263→
   264→    分析7宫、金星火星配置、投射模式。
   265→    """
   266→    from services.agent.tool_registry import ToolRegistry
   267→
   268→    partner_birth_date = args.get("partner_birth_date")
   269→    partner_birth_time = args.get("partner_birth_time")
   270→    partner_birth_location = args.get("partner_birth_location")
   271→
   272→    chart_data = get_zodiac_chart(context)
   273→
   274→    if not chart_data:
   275→        return {
   276→            "status": "error",
   277→            "error": "需要出生信息才能分析关系动力学",
   278→            "action": "collect_birth_info"
   279→        }
   280→
   281→    # 如果有对方信息，计算合盘
   282→    partner_chart = None
   283→    if partner_birth_date:
   284→        try:
   285→            from skills.zodiac.services import calculate_zodiac
   286→            partner_chart = calculate_zodiac(
   287→                birth_date=partner_birth_date,
   288→                birth_time=partner_birth_time or "12:00",
   289→                birth_place=partner_birth_location or "Shanghai"
   290→            )
   291→        except Exception as e:
   292→            logger.warning(f"Failed to calculate partner chart: {e}")
   293→
   294→    dynamics = {
   295→        "seventh_house": _analyze_seventh_house(chart_data),
   296→        "venus_mars": _analyze_venus_mars(chart_data),
   297→        "projection_patterns": _identify_projections(chart_data),
   298→        "synastry": _analyze_synastry(chart_data, partner_chart) if partner_chart else None
   299→    }
   300→
   301→    logger.info(f"Showing relationship dynamics via show_card for user {context.user_id}")
   302→
   303→    return await ToolRegistry.execute(
   304→        "show_card",
   305→        {
   306→            "card_type": "custom",
   307→            "data_source": {"type": "inline", "data": dynamics},
   308→            "options": {"componentId": "jungastro_relationship"}
   309→        },
   310→        context
   311→    )
   312→
   313→
   314→# ═══════════════════════════════════════════════════════════════════════════════
   315→# 辅助函数 - 心理学分析
   316→# ═══════════════════════════════════════════════════════════════════════════════
   317→
   318→def _analyze_ego(chart_data: Dict) -> Dict:
   319→    """分析核心自我 (太阳)"""
   320→    sun_sign = chart_data.get("sun_sign", "")
   321→    planets = chart_data.get("planets", [])
   322→
   323→    sun_house = None
   324→    for planet in planets:
   325→        if planet.get("planet", "").lower() == "sun":
   326→            sun_house = planet.get("house")
   327→            break
   328→
   329→    return {
   330→        "planet": "sun",
   331→        "sign": sun_sign,
   332→        "house": sun_house,
   333→        "psychological_meaning": "核心自我认同、意识中心、人生目的感",
   334→        "expression": "",  # 由 LLM 填充
   335→        "integration_state": "",
   336→        "blocked_state": ""
   337→    }
   338→
   339→
   340→def _analyze_unconscious(chart_data: Dict) -> Dict:
   341→    """分析情感需求 (月亮)"""
   342→    moon_sign = chart_data.get("moon_sign", "")
   343→    planets = chart_data.get("planets", [])
   344→
   345→    moon_house = None
   346→    for planet in planets:
   347→        if planet.get("planet", "").lower() == "moon":
   348→            moon_house = planet.get("house")
   349→            break
   350→
   351→    return {
   352→        "planet": "moon",
   353→        "sign": moon_sign,
   354→        "house": moon_house,
   355→        "psychological_meaning": "情感本能、无意识模式、安全需求",
   356→        "expression": "",
   357→        "nurturing_needs": ""
   358→    }
   359→
   360→
   361→def _analyze_persona(chart_data: Dict) -> Dict:
   362→    """分析人格面具 (上升)"""
   363→    rising_sign = chart_data.get("rising_sign", "")
   364→    return {
   365→        "sign": rising_sign,
   366→        "psychological_meaning": "面对世界的方式、第一印象、适应策略",
   367→        "expression": "",
   368→        "relationship_to_ego": ""
   369→    }
   370→
   371→
   372→def _analyze_functions(chart_data: Dict) -> Dict:
   373→    """分析心理功能分布"""
   374→    planets = chart_data.get("planets", [])
   375→
   376→    # 元素计数
   377→    elements = {"fire": 0, "earth": 0, "air": 0, "water": 0}
   378→    modalities = {"cardinal": 0, "fixed": 0, "mutable": 0}
   379→
   380→    element_map = {
   381→        "aries": "fire", "leo": "fire", "sagittarius": "fire",
   382→        "taurus": "earth", "virgo": "earth", "capricorn": "earth",
   383→        "gemini": "air", "libra": "air", "aquarius": "air",
   384→        "cancer": "water", "scorpio": "water", "pisces": "water",
   385→        # 中文映射
   386→        "白羊座": "fire", "狮子座": "fire", "射手座": "fire",
   387→        "金牛座": "earth", "处女座": "earth", "摩羯座": "earth",
   388→        "双子座": "air", "天秤座": "air", "水瓶座": "air",
   389→        "巨蟹座": "water", "天蝎座": "water", "双鱼座": "water"
   390→    }
   391→
   392→    modality_map = {
   393→        "aries": "cardinal", "cancer": "cardinal", "libra": "cardinal", "capricorn": "cardinal",
   394→        "taurus": "fixed", "leo": "fixed", "scorpio": "fixed", "aquarius": "fixed",
   395→        "gemini": "mutable", "virgo": "mutable", "sagittarius": "mutable", "pisces": "mutable",
   396→        # 中文映射
   397→        "白羊座": "cardinal", "巨蟹座": "cardinal", "天秤座": "cardinal", "摩羯座": "cardinal",
   398→        "金牛座": "fixed", "狮子座": "fixed", "天蝎座": "fixed", "水瓶座": "fixed",
   399→        "双子座": "mutable", "处女座": "mutable", "射手座": "mutable", "双鱼座": "mutable"
   400→    }
   401→
   402→    for planet in planets:
   403→        sign = planet.get("sign", "").lower()
   404→        if sign in element_map:
   405→            elements[element_map[sign]] += 1
   406→        if sign in modality_map:
   407→            modalities[modality_map[sign]] += 1
   408→
   409→    # 确定主导和劣势功能
   410→    dominant_element = max(elements, key=elements.get) if any(elements.values()) else "unknown"
   411→    inferior_element = min(elements, key=elements.get) if any(elements.values()) else "unknown"
   412→
   413→    return {
   414→        "elements": elements,
   415→        "modalities": modalities,
   416→        "dominant_function": dominant_element,
   417→        "inferior_function": inferior_element,
   418→        "balance_suggestions": []
   419→    }
   420→
   421→
   422→def _find_difficult_aspects(chart_data: Dict) -> list:
   423→    """找出困难相位 (刑相、对冲)"""
   424→    aspects = chart_data.get("aspects", [])
   425→    difficult = []
   426→
   427→    for aspect in aspects:
   428→        aspect_type = aspect.get("type", "").lower()
   429→        if aspect_type in ["square", "opposition", "刑相", "冲相"]:
   430→            difficult.append({
   431→                "planet1": aspect.get("planet1"),
   432→                "planet2": aspect.get("planet2"),
   433→                "type": aspect_type,
   434→                "orb": aspect.get("orb"),
   435→                "psychological_tension": ""
   436→            })
   437→
   438→    return difficult
   439→
   440→
   441→def _analyze_pluto(chart_data: Dict) -> Dict:
   442→    """分析冥王星配置"""
   443→    planets = chart_data.get("planets", [])
   444→    pluto = None
   445→
   446→    for planet in planets:
   447→        name = planet.get("planet", "").lower()
   448→        if name in ["pluto", "冥王星"]:
   449→            pluto = planet
   450→            break
   451→
   452→    if not pluto:
   453→        return {}
   454→
   455→    return {
   456→        "sign": pluto.get("sign"),
   457→        "house": pluto.get("house"),
   458→        "shadow_domain": "",
   459→        "deep_fear": "",
   460→        "transformation_potential": "",
   461→        "integration_suggestions": []
   462→    }
   463→
   464→
   465→def _analyze_saturn(chart_data: Dict) -> Dict:
   466→    """分析土星配置"""
   467→    planets = chart_data.get("planets", [])
   468→    saturn = None
   469→
   470→    for planet in planets:
   471→        name = planet.get("planet", "").lower()
   472→        if name in ["saturn", "土星"]:
   473→            saturn = planet
   474→            break
   475→
   476→    if not saturn:
   477→        return {}
   478→
   479→    return {
   480→        "sign": saturn.get("sign"),
   481→        "house": saturn.get("house"),
   482→        "fear_domain": "",
   483→        "inner_authority": "",
   484→        "maturation_task": "",
   485→        "integration_suggestions": []
   486→    }
   487→
   488→
   489→def _analyze_twelfth_house(chart_data: Dict) -> Dict:
   490→    """分析12宫内容"""
   491→    planets = chart_data.get("planets", [])
   492→    planets_in_12th = []
   493→
   494→    for planet in planets:
   495→        if planet.get("house") == 12:
   496→            planets_in_12th.append(planet.get("planet"))
   497→
   498→    return {
   499→        "planets": planets_in_12th,
   500→        "hidden_energies": "",
   501→        "unconscious_patterns": "",
   502→        "integration_direction": ""
   503→    }
   504→
   505→
   506→def _calculate_age(birth_date: str) -> Optional[int]:
   507→    """计算年龄"""
   508→    try:
   509→        birth = datetime.strptime(birth_date, "%Y-%m-%d")
   510→        today = datetime.now()
   511→        age = today.year - birth.year
   512→        if (today.month, today.day) < (birth.month, birth.day):
   513→            age -= 1
   514→        return age
   515→    except:
   516→        return None
   517→
   518→
   519→def _determine_life_stage(age: Optional[int]) -> Dict:
   520→    """确定人生阶段"""
   521→    if age is None:
   522→        return {"name": "unknown", "description": ""}
   523→
   524→    if age < 29:
   525→        return {
   526→            "name": "pre_saturn_return",
   527→            "description": "探索身份期",
   528→            "key_task": "探索自我、建立身份认同"
   529→        }
   530→    elif 28 <= age <= 30:
   531→        return {
   532→            "name": "first_saturn_return",
   533→            "description": "第一次土星回归",
   534→            "key_task": "承担责任、成为真正的成年人"
   535→        }
   536→    elif 30 < age < 40:
   537→        return {
   538→            "name": "building_phase",
   539→            "description": "建设期",
   540→            "key_task": "建立事业和家庭"
   541→        }
   542→    elif 40 <= age <= 44:
   543→        return {
   544→            "name": "uranus_opposition",
   545→            "description": "中年觉醒期",
   546→            "key_task": "重新评估人生、打破旧模式"
   547→        }
   548→    elif 44 < age < 50:
   549→        return {
   550→            "name": "integration_phase",
   551→            "description": "整合期",
   552→            "key_task": "整合人生经验"
   553→        }
   554→    elif 49 <= age <= 51:
   555→        return {
   556→            "name": "chiron_return",
   557→            "description": "凯龙回归",
   558→            "key_task": "接受伤痛、成为疗愈者"
   559→        }
   560→    elif 57 <= age <= 60:
   561→        return {
   562→            "name": "second_saturn_return",
   563→            "description": "第二次土星回归",
   564→            "key_task": "传承智慧、成为长者"
   565→        }
   566→    else:
   567→        return {
   568→            "name": "elder_phase",
   569→            "description": "智慧长者期",
   570→            "key_task": "灵性深化、传承"
   571→        }
   572→
   573→
   574→def _analyze_saturn_cycle(chart_data: Dict, age: Optional[int]) -> Dict:
   575→    """分析土星周期"""
   576→    saturn = _analyze_saturn(chart_data)
   577→    return {
   578→        "natal_saturn": saturn,
   579→        "current_age": age,
   580→        "cycle_phase": _determine_life_stage(age).get("name"),
   581→        "life_lesson": ""
   582→    }
   583→
   584→
   585→def _analyze_seventh_house(chart_data: Dict) -> Dict:
   586→    """分析7宫"""
   587→    planets = chart_data.get("planets", [])
   588→    planets_in_7th = []
   589→
   590→    for planet in planets:
   591→        if planet.get("house") == 7:
   592→            planets_in_7th.append(planet.get("planet"))
   593→
   594→    return {
   595→        "sign": "",  # 需要从 houses 数据获取
   596→        "planets": planets_in_7th,
   597→        "relationship_seeking": "",
   598→        "projection_tendency": "",
   599→        "integration_direction": ""
   600→    }
   601→
   602→
   603→def _analyze_venus_mars(chart_data: Dict) -> Dict:
   604→    """分析金星火星配置"""
   605→    planets = chart_data.get("planets", [])
   606→    venus = None
   607→    mars = None
   608→
   609→    for planet in planets:
   610→        name = planet.get("planet", "").lower()
   611→        if name in ["venus", "金星"]:
   612→            venus = planet
   613→        elif name in ["mars", "火星"]:
   614→            mars = planet
   615→
   616→    return {
   617→        "venus": {
   618→            "sign": venus.get("sign") if venus else None,
   619→            "house": venus.get("house") if venus else None,
   620→            "love_style": ""
   621→        },
   622→        "mars": {
   623→            "sign": mars.get("sign") if mars else None,
   624→            "house": mars.get("house") if mars else None,
   625→            "desire_style": ""
   626→        },
   627→        "venus_mars_aspect": None,  # 需要从 aspects 中查找
   628→        "dynamics": ""
   629→    }
   630→
   631→
   632→def _identify_projections(chart_data: Dict) -> list:
   633→    """识别投射模式"""
   634→    projections = []
   635→
   636→    # 下降点分析 (7宫头)
   637→    # 简化实现：基于上升星座推断下降星座
   638→    rising_sign = chart_data.get("rising_sign", "")
   639→
   640→    opposite_signs = {
   641→        "aries": "libra", "libra": "aries",
   642→        "taurus": "scorpio", "scorpio": "taurus",
   643→        "gemini": "sagittarius", "sagittarius": "gemini",
   644→        "cancer": "capricorn", "capricorn": "cancer",
   645→        "leo": "aquarius", "aquarius": "leo",
   646→        "virgo": "pisces", "pisces": "virgo",
   647→        # 中文
   648→        "白羊座": "天秤座", "天秤座": "白羊座",
   649→        "金牛座": "天蝎座", "天蝎座": "金牛座",
   650→        "双子座": "射手座", "射手座": "双子座",
   651→        "巨蟹座": "摩羯座", "摩羯座": "巨蟹座",
   652→        "狮子座": "水瓶座", "水瓶座": "狮子座",
   653→        "处女座": "双鱼座", "双鱼座": "处女座"
   654→    }
   655→
   656→    descendant_sign = opposite_signs.get(rising_sign.lower(), "")
   657→
   658→    if descendant_sign:
   659→        projections.append({
   660→            "source": "descendant",
   661→            "sign": descendant_sign,
   662→            "projected_qualities": "",
   663→            "integration_suggestion": ""
   664→        })
   665→
   666→    return projections
   667→
   668→
   669→def _analyze_synastry(chart1: Dict, chart2: Dict) -> Dict:
   670→    """分析合盘心理动力"""
   671→    if not chart2:
   672→        return None
   673→
   674→    return {
   675→        "attraction_sources": [],
   676→        "growth_opportunities": [],
   677→        "potential_challenges": [],
   678→        "suggestions": []
   679→    }
   680→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
