     1→# VibeLife 系统配置手册
     2→
     3→> 本文档包含配置和运行整个系统所需的全部核心信息
     4→
     5→---
     6→
     7→## 1. 环境变量完整配置
     8→
     9→复制到 `.env` 文件（项目根目录）:
    10→
    11→```bash
    12→# ═══════════════════════════════════════════════════════════════
    13→# 数据库 (必需)
    14→# ═══════════════════════════════════════════════════════════════
    15→VIBELIFE_DB_URL=postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
    16→VIBELIFE_DB_HOST=106.37.170.238
    17→VIBELIFE_DB_PORT=8224
    18→VIBELIFE_DB_NAME=vibelife
    19→VIBELIFE_DB_USER=postgres
    20→VIBELIFE_DB_PASSWORD=Ak4_9lScd-69WX
    21→VIBELIFE_DB_SSLMODE=prefer
    22→
    23→# ═══════════════════════════════════════════════════════════════
    24→# JWT 认证 (必需)
    25→# ═══════════════════════════════════════════════════════════════
    26→VIBELIFE_JWT_SECRET=vibelife-jwt-secret-key-2026-aiscend
    27→VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
    28→VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30
    29→
    30→# ═══════════════════════════════════════════════════════════════
    31→# API 服务 (必需)
    32→# ═══════════════════════════════════════════════════════════════
    33→VIBELIFE_API_PORT=8000
    34→VIBELIFE_API_HOST=0.0.0.0
    35→VIBELIFE_DEV=1
    36→VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8230,http://106.37.170.238:8231,http://106.37.170.238:8232,http://localhost:3000
    37→
    38→# ═══════════════════════════════════════════════════════════════
    39→# LLM 服务 (必需，至少配置一个)
    40→# ═══════════════════════════════════════════════════════════════
    41→
    42→# 智谱 GLM (主要对话模型)
    43→GLM_API_KEY=42b82ed9a13e4e8890ef3854bb840ef8.TcWZ4DIq0NF2xElF
    44→GLM_CHAT_MODEL=glm-4-flash
    45→GLM_VISION_MODEL=glm-4.6v
    46→GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
    47→
    48→# Claude (备选)
    49→CLAUDE_API_KEY=sk-Z0kVvuz5cIwtomKfLQH23MuYxsTgG7IuFxSDaeYoV4xwHGqD
    50→CLAUDE_BASE_URL=https://api2.qiandao.mom/v1
    51→CLAUDE_MODEL=claude-3-5-sonnet-20241022
    52→
    53→# Gemini (生图 + Embedding)
    54→GEMINI_API_KEY=sk-ynk9oTMtjhszj4IDoyUZreMg04NfefVGTlFtW7QvGYw4k9Dg
    55→GEMINI_BASE_URL=https://new.12ai.org/v1
    56→GEMINI_CHAT_MODEL=gemini-2.5-flash
    57→GEMINI_IMAGE_MODEL=gemini-2.5-flash-image
    58→
    59→# 默认提供商 (已迁移到 config/models.yaml)
    60→# DEFAULT_LLM_PROVIDER 已废弃，从 models.yaml defaults.chat.primary 读取
    61→# DEFAULT_IMAGE_PROVIDER 已废弃，从 models.yaml defaults.image_gen.primary 读取
    62→
    63→# ═══════════════════════════════════════════════════════════════
    64→# 向量嵌入 + 存储 (知识库必需)
    65→# ═══════════════════════════════════════════════════════════════
    66→EMBEDDING_MODEL_NAME=BAAI/bge-m3
    67→EMBEDDING_DIMENSION=1024
    68→EMBEDDING_DEVICE=cuda
    69→EMBEDDING_LOCAL_DIR=/home/aiscend/.cache/vibelife/models/bge-m3
    70→# 向量存储使用 PostgreSQL pgvector，无需额外配置
    71→
    72→# ═══════════════════════════════════════════════════════════════
    73→# Stripe 支付 (商业化必需)
    74→# ═══════════════════════════════════════════════════════════════
    75→STRIPE_SECRET_KEY=sk_test_51Snq9KE8u1baYET0WjoEzHNCjlDAkaaATNEFyziJs4X1HF1AjPnV4YhrjS2Gy6UIhGApAenJn8BbP1uxwMrleRbS000LPmMzrC
    76→STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
    77→# STRIPE_WEBHOOK_SECRET=whsec_xxx  # Stripe Dashboard 创建 webhook 后获取
    78→
    79→# ═══════════════════════════════════════════════════════════════
    80→# 数据目录
    81→# ═══════════════════════════════════════════════════════════════
    82→VIBELIFE_DATA_ROOT=/data/vibelife
    83→VIBELIFE_KNOWLEDGE_ROOT=/data/vibelife/knowledge
    84→VIBELIFE_UPLOADS_ROOT=/data/vibelife/uploads
    85→VIBELIFE_CACHE_ROOT=/data/vibelife/cache
    86→VIBELIFE_LOGS_ROOT=/data/vibelife/logs
    87→
    88→# ═══════════════════════════════════════════════════════════════
    89→# 域名 (生产环境)
    90→# ═══════════════════════════════════════════════════════════════
    91→VIBELIFE_DOMAIN=vibelife.app
    92→BAZI_DOMAIN=bazi.vibelife.app
    93→ZODIAC_DOMAIN=zodiac.vibelife.app
    94→MBTI_DOMAIN=mbti.vibelife.app
    95→ID_DOMAIN=id.vibelife.app
    96→VIBELIFE_WEB_URL=http://106.37.170.238:8232
    97→```
    98→
    99→---
   100→
   101→## 2. 前端环境变量
   102→
   103→`apps/web/.env.local`:
   104→
   105→```bash
   106→NEXT_PUBLIC_API_URL=http://106.37.170.238:8100
   107→NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1
   108→NEXT_PUBLIC_WS_URL=ws://106.37.170.238:8100/ws
   109→VIBELIFE_API_INTERNAL=http://127.0.0.1:8100
   110→NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
   111→```
   112→
   113→---
   114→
   115→## 3. 数据库初始化
   116→
   117→```bash
   118→# 连接数据库
   119→psql postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
   120→
   121→# 按顺序执行迁移
   122→psql -f migrations/001_v3_schema.sql
   123→psql -f migrations/002_interview_sessions.sql
   124→psql -f migrations/003_model_router.sql
   125→psql -f migrations/004_update_model_routes.sql
   126→psql -f migrations/005_user_gender_voice_mode.sql
   127→psql -f migrations/006_fix_knowledge_table_refs.sql
   128→psql -f migrations/007_skill_terms.sql
   129→psql -f migrations/008_knowledge_converted_path.sql
   130→psql -f migrations/009_user_notifications.sql
   131→psql -f migrations/010_user_entitlements.sql
   132→psql -f migrations/011_guest_sessions.sql
   133→psql -f migrations/012_payment_dual_track.sql
   134→psql -f migrations/013_fortune_cache.sql
   135→psql -f migrations/014_user_skill_data.sql
   136→```
   137→
   138→必需扩展: `uuid-ossp`, `pgcrypto`, `vector` (pgvector)
   139→
   140→---
   141→
   142→## 4. 启动与部署
   143→
   144→### 4.1 基础依赖安装
   145→
   146→```bash
   147→# 前端依赖
   148→pnpm install
   149→
   150→# 后端依赖
   151→pip install -r apps/api/requirements.txt
   152→```
   153→
   154→### 4.2 开发与测试环境
   155→
   156→```bash
   157→# 开发环境 (API: 8000, Web: 3000)
   158→cd apps/api && uvicorn main:app --reload --host 0.0.0.0 --port 8000
   159→cd apps/web && pnpm dev
   160→
   161→# 测试环境 (API: 8100, Web: 8232)
   162→cd apps/api && uvicorn main:app --host 0.0.0.0 --port 8100
   163→cd apps/web && PORT=8232 pnpm dev
   164→```
   165→
   166→### 4.3 生产环境分布式部署 (Cloudflare + 火山香港 + 北京)
   167→
   168→**网络路径：** 用户 (全球) -> Cloudflare (边缘节点) -> [HTTPS加密隧道] -> 火山引擎香港 (源站Nginx) -> 火山引擎香港 (前端Next.js) -> 北京服务器 (API后端) -> 北京服务器 (PgSQL)
   169→
   170→#### A. Cloudflare 安全配置
   171→1. **Origin CA 证书**:
   172→   - `SSL/TLS` -> `Origin Server` -> `Create Certificate` (ECC, 15年)。
   173→   - 复制证书和私钥，分别保存至 `deploy/huoshan/vibelife.pem` 和 `vibelife.key`。
   174→2. **加密模式**: `SSL/TLS` -> `Overview` -> 选择 **Full (Strict) / 完全（严格）**。
   175→3. **DNS 代理**:
   176→   - 配置 `@` 及所有子域名 (`bazi/zodiac/id/mbti/m`) 的 A 记录指向香港服务器 `101.47.72.235`。
   177→   - 确保 **Proxy status** 为 **Proxied (开启代理/小黄云)** 以享受 DDoS 防护和加速。
   178→
   179→#### B. 火山香港服务器 (前端/入口)
   180→1. **工程同步**: `git clone git@github.com:aiscendtech/vibelife.git /opt/vibelife`
   181→2. **Nginx 配置**:
   182→   ```bash
   183→   cp /opt/vibelife/deploy/huoshan/vibelife.conf /etc/nginx/sites-enabled/
   184→   rm /etc/nginx/sites-enabled/default
   185→   nginx -t && systemctl reload nginx
   186→   ```
   187→3. **前端服务 (端口 8230)**:
   188→   ```bash
   189→   cd /opt/vibelife/apps/web
   190→   ./start_web.sh  # 首次需安装 Node 25/pnpm
   191→   ```
   192→
   193→#### C. 北京服务器 (后端/数据)
   194→1. **API 服务 (端口 8231)**:
   195→   ```bash
   196→   cd /opt/vibelife/apps/api
   197→   ./start_api.sh
   198→   ```
   199→2. **更新后重启**: 每次代码更新后，分别执行对应的 `start_web.sh` 或 `start_api.sh`。
   200→
   201→---
   202→
   203→## 5. 端口分配
   204→
   205→| 服务 | 开发 | 测试 | 生产 (分布式) |
   206→|------|------|------|--------------|
   207→| API Backend | 8000 | 8100 | 8231 (北京) |
   208→| Web Frontend | 3000 | 8232 | 8230 (香港) |
   209→| PostgreSQL | - | 8224 | 8224 (北京) |
   210→| Nginx (Entry) | - | - | 80/443 (香港) |
   211→
   212→---
   213→
   214→## 6. 核心目录结构
   215→
   216→```
   217→apps/api/
   218→├── main.py              # 入口，路由注册
   219→├── routes/              # API 路由 (17个)
   220→├── services/            # 业务服务 (21个模块)
   221→│   ├── vibe_engine/     # 核心引擎 (context, llm, portrait)
   222→│   ├── model_router/    # 模型路由 (多模型、配额、降级)
   223→│   ├── persona/         # 人格系统 (warm/sarcastic/wise)
   224→│   ├── knowledge/       # RAG 知识检索
   225→│   ├── identity/        # 认证 (JWT/OAuth)
   226→│   ├── billing/         # 账单
   227→│   ├── entitlement/     # 权益
   228→│   └── ...
   229→├── stores/db.py         # 数据库连接池
   230→├── tools/               # 命理计算 (bazi/zodiac)
   231→└── workers/             # 后台任务 (IngestionWorker)
   232→
   233→apps/web/src/
   234→├── app/                 # Next.js App Router 页面
   235→├── components/          # React 组件
   236→└── hooks/               # 自定义 Hooks
   237→```
   238→
   239→---
   240→
   241→## 7. API 路由清单
   242→
   243→| 路由 | 前缀 | 核心端点 |
   244→|------|------|----------|
   245→| auth | /api/v1 | POST /auth/login, /auth/register |
   246→| guest | /api/v1 | POST /guest/session |
   247→| users | /api/v1 | GET /users/me, PUT /users/profile |
   248→| chat | /api/v1 | POST /chat/message (SSE) |
   249→| onboarding | /api/v1 | POST /onboarding/start |
   250→| report | /api/v1 | POST /report/generate |
   251→| relationship | /api/v1 | POST /relationship/analyze |
   252→| skills | /api/v1 | POST /skills/{skill}/{action} (e.g. bazi: chart/fortune/kline/cycles; zodiac: chart/transit/synastry) |
   253→| notifications | /api/v1 | GET /notifications/daily |
   254→| payment | /api/v1 | POST /payment/create-session |
   255→| billing | /api/v1 | GET /billing/subscription |
   256→| entitlement | /api/v1 | GET /entitlement/check |
   257→| bazi | /api/v1 | POST /bazi/calculate |
   258→| zodiac | /api/v1 | POST /zodiac/chart |
   259→| memories | /api/v1 | GET /memories/insights |
   260→| identity | /api/v1 | POST /identity/link |
   261→| health | / | GET /health |
   262→
   263→---
   264→
   265→## 8. 数据库核心表
   266→
   267→| 表 | 主键 | 关键字段 |
   268→|----|------|----------|
   269→| vibe_users | id (UUID) | vibe_id, email, phone, is_guest |
   270→| user_auth | id | user_id, auth_type, auth_identifier, password_hash |
   271→| user_profiles | id | user_id, version, profile (JSONB) |
   272→| conversations | id | user_id, skill, voice_mode |
   273→| messages | id | conversation_id, role, content |
   274→| reports | id | user_id, skill, report_type, content (JSONB), is_paid |
   275→| relationships | id | initiator_id, partner_id, analysis (JSONB) |
   276→| subscriptions | id | user_id, plan_id, status, current_period_end |
   277→| payments | id | user_id, amount, currency, status |
   278→| user_entitlements | id | user_id, entitlement_type, remaining |
   279→| insights | id | user_id, category, content |
   280→
   281→---
   282→
   283→## 9. LLM 模型配置
   284→
   285→| 用途 | 提供商 | 模型 | 环境变量 |
   286→|------|--------|------|----------|
   287→| 主对话 | 智谱 | glm-4-flash | GLM_CHAT_MODEL |
   288→| 视觉 | 智谱 | glm-4.6v | GLM_VISION_MODEL |
   289→| 备选对话 | Claude | claude-3-5-sonnet | CLAUDE_MODEL |
   290→| 生图 | Gemini | gemini-2.5-flash-image | GEMINI_IMAGE_MODEL |
   291→| 向量嵌入 | 本地 | BAAI/bge-m3 (1024维) | EMBEDDING_MODEL_NAME |
   292→
   293→模型路由优先级: 数据库规则 > 代码默认值
   294→
   295→---
   296→
   297→## 10. 人格系统
   298→
   299→| 人格 | voice_mode | 风格 |
   300→|------|------------|------|
   301→| 暖心向导 | warm | 共情、支持、鼓励 |
   302→| 毒舌损友 | sarcastic | 直接、犀利、有趣 |
   303→| 人生导师 | wise | 理性、深度、像长辈指点 |
   304→
   305→存储: `user_profiles.profile.preferences.voice_mode`
   306→
   307→---
   308→
   309→## 11. 支付双轨制
   310→
   311→| 轨道 | 货币 | 类型 | 目标用户 |
   312→|------|------|------|----------|
   313→| 海外订阅 | USD | Recurring | 海外用户 |
   314→| 大陆预付 | HKD | One-time | 大陆/香港用户 |
   315→
   316→Stripe Price ID 需在 Dashboard 创建后填入环境变量。
   317→
   318→---
   319→
   320→## 12. 知识库配置
   321→
   322→向量嵌入: BAAI/bge-m3 (1024维, 本地 CUDA)
   323→向量存储: PostgreSQL pgvector (1024维, cosine)
   324→
   325→知识库目录:
   326→```
   327→packages/knowledge/
   328→├── bazi/      # 八字知识
   329→├── zodiac/    # 星座知识
   330→├── mbti/      # MBTI 知识
   331→└── shared/    # 共享知识
   332→```
   333→
   334→---
   335→
   336→## 13. 日志位置
   337→
   338→- API 请求日志: `/opt/vibelife/logs/api_requests.log`
   339→- 数据目录: `/data/vibelife/`
   340→- Docker 日志: `deploy/aiscend/logs/`
   341→
   342→---
   343→
   344→## 14. 健康检查
   345→
   346→```bash
   347→# API 健康检查
   348→curl http://localhost:8000/health
   349→
   350→# 数据库连接测试
   351→psql $VIBELIFE_DB_URL -c "SELECT 1"
   352→
   353→# 向量扩展测试
   354→psql $VIBELIFE_DB_URL -c "SELECT vector_dims('[1,2,3]'::vector)"
   355→```
   356→
   357→---
   358→
   359→## 15. 常见问题
   360→
   361→**Q: API 启动失败 "VIBELIFE_DB_URL not set"**
   362→A: 确保 `.env` 文件在项目根目录，且包含 `VIBELIFE_DB_URL`
   363→
   364→**Q: 前端无法连接 API**
   365→A: 检查 `VIBELIFE_CORS_ORIGINS` 是否包含前端地址
   366→
   367→**Q: 向量嵌入报错**
   368→A: 确保 `EMBEDDING_LOCAL_DIR` 路径存在，或首次运行时会自动下载模型
   369→
   370→**Q: Stripe 支付失败**
   371→A: 检查 `STRIPE_SECRET_KEY` 是否正确，测试环境用 `sk_test_` 开头的密钥
   372→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
