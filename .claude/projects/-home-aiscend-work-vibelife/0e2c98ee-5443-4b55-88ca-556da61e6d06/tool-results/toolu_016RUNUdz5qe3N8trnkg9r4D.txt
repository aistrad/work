     1â†’'use client'
     2â†’
     3â†’/**
     4â†’ * Settings Page - v6.0 ç»Ÿä¸€å¸ƒå±€ç‰ˆ
     5â†’ *
     6â†’ * v6.0 å˜æ›´:
     7â†’ * - ä½¿ç”¨ä¸ Chat é¡µç›¸åŒçš„ NavBar ç»„ä»¶ï¼Œä¿æŒå·¦ä¾§æ ä¸€è‡´æ€§
     8â†’ * - ç§»é™¤ PCLayoutï¼Œä½¿ç”¨è‡ªå®šä¹‰å¸ƒå±€
     9â†’ * - ä¿®å¤é€€å‡ºç™»å½•åŠŸèƒ½
    10â†’ *
    11â†’ * PCç«¯å¸ƒå±€: NavBar + è®¾ç½®èœå• + è®¾ç½®å†…å®¹
    12â†’ * ç§»åŠ¨ç«¯å¸ƒå±€: å•æ è®¾ç½®åˆ—è¡¨
    13â†’ */
    14â†’
    15â†’import { useState, useEffect, useCallback, memo, useMemo, useId, Suspense } from 'react'
    16â†’import { useRouter, useSearchParams } from 'next/navigation'
    17â†’import { NavBar } from '@/components/layout/NavBar'
    18â†’import { MobileHeader } from '@/components/layout/MobileHeader'
    19â†’import { BirthDateInputs } from '@/components/ui/Input'
    20â†’import { getLocalStorageJSON, getAccessToken, setLocalStorageJSON, invalidateStorageCache } from '@/utils/storage'
    21â†’import { AccountDeletionSection } from '@/components/settings/AccountDeletionSection'
    22â†’import { SkillCard } from '@/components/skill'
    23â†’import { useSkillSubscription, useSkills } from '@/hooks/useSkillSubscription'
    24â†’import { useAuth } from '@/providers/AuthProvider'
    25â†’import { cn } from '@/lib/utils'
    26â†’
    27â†’// Use Next.js API routes for server communication to avoid exposing backend URL
    28â†’const API_BASE = '/api'
    29â†’
    30â†’const SETTINGS_MENU = [
    31â†’  { id: 'profile', icon: 'ğŸ‘¤', label: 'ä¸ªäººèµ„æ–™' },
    32â†’  { id: 'skills', icon: 'ğŸ¯', label: 'Skill ç®¡ç†' },
    33â†’  { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥è®¾ç½®' },
    34â†’  { id: 'privacy', icon: 'ğŸ”', label: 'éšç§ä¸å®‰å…¨' },
    35â†’  { id: 'membership', icon: 'ğŸ’', label: 'ä¼šå‘˜ç®¡ç†' },
    36â†’  { id: 'memory', icon: 'ğŸ§ ', label: 'è®°å¿†ç®¡ç†' },
    37â†’  { id: 'preferences', icon: 'âš™ï¸', label: 'åå¥½è®¾ç½®' },
    38â†’  { id: 'account', icon: 'âš ï¸', label: 'è´¦æˆ·ç®¡ç†' },
    39â†’  { id: 'help', icon: 'â“', label: 'å¸®åŠ©ä¸åé¦ˆ' },
    40â†’  { id: 'about', icon: 'ğŸ“„', label: 'å…³äº' },
    41â†’]
    42â†’
    43â†’interface UserProfile {
    44â†’  nickname: string
    45â†’  email: string
    46â†’  avatar: string
    47â†’  birthDate: string
    48â†’  birthTime: string
    49â†’  timezone: string
    50â†’}
    51â†’
    52â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    53â†’// Skill ç®¡ç†åŒºå—
    54â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    55â†’
    56â†’function SkillSettingsSection({ router }: { router: ReturnType<typeof useRouter> }) {
    57â†’  const { skills } = useSkills()
    58â†’  const { subscriptions, togglePush, unsubscribe, userStatuses } = useSkillSubscription()
    59â†’
    60â†’  // åˆ†ç»„
    61â†’  const { subscribed, available } = useMemo(() => {
    62â†’    const subscribedIds = new Set(
    63â†’      subscriptions.filter(s => s.status === 'subscribed').map(s => s.skill_id)
    64â†’    )
    65â†’    return {
    66â†’      subscribed: skills.filter(s => subscribedIds.has(s.id)),
    67â†’      available: skills.filter(s => !subscribedIds.has(s.id) && s.category !== 'core'),
    68â†’    }
    69â†’  }, [skills, subscriptions])
    70â†’
    71â†’  const handleTogglePush = async (skillId: string, enabled: boolean) => {
    72â†’    try {
    73â†’      await togglePush(skillId, enabled)
    74â†’    } catch (err) {
    75â†’      console.error('Toggle push failed:', err)
    76â†’    }
    77â†’  }
    78â†’
    79â†’  const handleUnsubscribe = async (skillId: string) => {
    80â†’    try {
    81â†’      await unsubscribe(skillId)
    82â†’    } catch (err) {
    83â†’      console.error('Unsubscribe failed:', err)
    84â†’    }
    85â†’  }
    86â†’
    87â†’  return (
    88â†’    <div className="space-y-6">
    89â†’      <div className="flex items-center justify-between">
    90â†’        <h2 className="font-serif text-xl text-text-primary">Skill ç®¡ç†</h2>
    91â†’        <button
    92â†’          onClick={() => router.push('/skills')}
    93â†’          className="text-sm text-accent hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 rounded"
    94â†’          aria-label="æ¢ç´¢æ›´å¤š Skill"
    95â†’        >
    96â†’          æ¢ç´¢æ›´å¤š â†’
    97â†’        </button>
    98â†’      </div>
    99â†’
   100â†’      {/* å·²è®¢é˜… */}
   101â†’      <div>
   102â†’        <h3 className="text-sm font-medium text-text-secondary mb-3">
   103â†’          å·²è®¢é˜… ({subscribed.length})
   104â†’        </h3>
   105â†’        <div className="space-y-2">
   106â†’          {subscribed.map((skill) => {
   107â†’            const sub = subscriptions.find(s => s.skill_id === skill.id)
   108â†’            const isCore = skill.category === 'core'
   109â†’            return (
   110â†’              <div key={skill.id} className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)]">
   111â†’                <div
   112â†’                  className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
   113â†’                  style={{ backgroundColor: `${skill.color}20` }}
   114â†’                >
   115â†’                  {skill.icon}
   116â†’                </div>
   117â†’                <div className="flex-1 min-w-0">
   118â†’                  <div className="flex items-center gap-2">
   119â†’                    <span className="font-medium text-text-primary">{skill.name}</span>
   120â†’                    {isCore && (
   121â†’                      <span className="px-1.5 py-0.5 text-xs rounded bg-accent/10 text-accent">
   122â†’                        å§‹ç»ˆæ¿€æ´»
   123â†’                      </span>
   124â†’                    )}
   125â†’                  </div>
   126â†’                  <p className="text-xs text-text-secondary truncate">
   127â†’                    {skill.features?.slice(0, 2).map(f => f.name).join(' Â· ')}
   128â†’                  </p>
   129â†’                </div>
   130â†’                {!isCore && (
   131â†’                  <div className="flex items-center gap-3">
   132â†’                    <div className="flex items-center gap-2">
   133â†’                      <label
   134â†’                        htmlFor={`push-${skill.id}`}
   135â†’                        className="text-xs text-text-tertiary cursor-pointer"
   136â†’                      >
   137â†’                        æ¨é€
   138â†’                      </label>
   139â†’                      <div className="relative inline-flex items-center">
   140â†’                        <input
   141â†’                          id={`push-${skill.id}`}
   142â†’                          type="checkbox"
   143â†’                          checked={sub?.push_enabled ?? false}
   144â†’                          onChange={(e) => handleTogglePush(skill.id, e.target.checked)}
   145â†’                          className="sr-only peer"
   146â†’                          aria-describedby={`push-desc-${skill.id}`}
   147â†’                        />
   148â†’                        <div className="w-9 h-5 bg-[var(--bg-secondary)] peer-focus-visible:ring-2 peer-focus-visible:ring-accent/50 peer-focus-visible:ring-offset-2 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-transform peer-checked:bg-accent cursor-pointer" />
   149â†’                        <span id={`push-desc-${skill.id}`} className="sr-only">
   150â†’                          {sub?.push_enabled ? 'å…³é—­' : 'å¼€å¯'} {skill.name} æ¨é€é€šçŸ¥
   151â†’                        </span>
   152â†’                      </div>
   153â†’                    </div>
   154â†’                    <button
   155â†’                      onClick={() => handleUnsubscribe(skill.id)}
   156â†’                      className="text-xs text-error hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-error focus-visible:ring-offset-2 rounded"
   157â†’                      aria-label={`å–æ¶ˆè®¢é˜… ${skill.name}`}
   158â†’                    >
   159â†’                      å–æ¶ˆ
   160â†’                    </button>
   161â†’                  </div>
   162â†’                )}
   163â†’              </div>
   164â†’            )
   165â†’          })}
   166â†’        </div>
   167â†’      </div>
   168â†’
   169â†’      {/* å¯è®¢é˜… */}
   170â†’      {available.length > 0 && (
   171â†’        <div>
   172â†’          <h3 className="text-sm font-medium text-text-secondary mb-3">
   173â†’            å¯è®¢é˜… ({available.length})
   174â†’          </h3>
   175â†’          <div className="space-y-2">
   176â†’            {available.slice(0, 3).map((skill) => (
   177â†’              <div
   178â†’                key={skill.id}
   179â†’                role="button"
   180â†’                tabIndex={0}
   181â†’                onClick={() => router.push(`/skills/${skill.id}`)}
   182â†’                onKeyDown={(e) => {
   183â†’                  if (e.key === 'Enter' || e.key === ' ') {
   184â†’                    e.preventDefault()
   185â†’                    router.push(`/skills/${skill.id}`)
   186â†’                  }
   187â†’                }}
   188â†’                className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)] cursor-pointer hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   189â†’                aria-label={`æŸ¥çœ‹ ${skill.name} è¯¦æƒ…`}
   190â†’              >
   191â†’                <div
   192â†’                  className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
   193â†’                  style={{ backgroundColor: `${skill.color}20` }}
   194â†’                  aria-hidden="true"
   195â†’                >
   196â†’                  {skill.icon}
   197â†’                </div>
   198â†’                <div className="flex-1 min-w-0">
   199â†’                  <span className="font-medium text-text-primary">{skill.name}</span>
   200â†’                  <p className="text-xs text-text-secondary truncate">
   201â†’                    {skill.showcase?.tagline || skill.description}
   202â†’                  </p>
   203â†’                </div>
   204â†’                <span className="px-3 py-1 text-xs rounded-full bg-accent text-white" aria-hidden="true">
   205â†’                  è®¢é˜…
   206â†’                </span>
   207â†’              </div>
   208â†’            ))}
   209â†’          </div>
   210â†’        </div>
   211â†’      )}
   212â†’    </div>
   213â†’  )
   214â†’}
   215â†’
   216â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   217â†’// é€šçŸ¥è®¾ç½®åŒºå— - ä½¿ç”¨ Skill çº§åˆ«çš„æ¨é€è®¾ç½®
   218â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   219â†’
   220â†’function NotificationSettingsSection() {
   221â†’  const { skills } = useSkills()
   222â†’  const { subscriptions, togglePush } = useSkillSubscription()
   223â†’
   224â†’  // åªæ˜¾ç¤ºå·²è®¢é˜…çš„ Skills çš„æ¨é€è®¾ç½®
   225â†’  const subscribedSkills = useMemo(() => {
   226â†’    const subscribedIds = new Set(
   227â†’      subscriptions.filter(s => s.status === 'subscribed').map(s => s.skill_id)
   228â†’    )
   229â†’    return skills.filter(s => subscribedIds.has(s.id))
   230â†’  }, [skills, subscriptions])
   231â†’
   232â†’  const handleTogglePush = async (skillId: string, enabled: boolean) => {
   233â†’    try {
   234â†’      await togglePush(skillId, enabled)
   235â†’    } catch (err) {
   236â†’      console.error('Toggle push failed:', err)
   237â†’    }
   238â†’  }
   239â†’
   240â†’  return (
   241â†’    <div className="space-y-6">
   242â†’      <h2 className="font-serif text-xl text-text-primary">é€šçŸ¥è®¾ç½®</h2>
   243â†’      <p className="text-sm text-text-secondary">
   244â†’        ç®¡ç†ä½ è®¢é˜…çš„ Skills çš„æ¨é€é€šçŸ¥ã€‚
   245â†’      </p>
   246â†’
   247â†’      {subscribedSkills.length === 0 ? (
   248â†’        <div className="text-center py-8 text-text-secondary">
   249â†’          <p>æš‚æ— å·²è®¢é˜…çš„ Skill</p>
   250â†’          <p className="text-sm mt-2">è®¢é˜… Skill åå¯åœ¨æ­¤ç®¡ç†æ¨é€é€šçŸ¥</p>
   251â†’        </div>
   252â†’      ) : (
   253â†’        <div className="space-y-3">
   254â†’          {subscribedSkills.map((skill) => {
   255â†’            const sub = subscriptions.find(s => s.skill_id === skill.id)
   256â†’            const toggleId = `notify-${skill.id}`
   257â†’            return (
   258â†’              <div key={skill.id} className="flex items-center justify-between p-4 bg-[var(--bg-card-alt)] rounded-lg">
   259â†’                <label htmlFor={toggleId} className="flex items-center gap-3 cursor-pointer flex-1">
   260â†’                  <div
   261â†’                    className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
   262â†’                    style={{ backgroundColor: `${skill.color}20` }}
   263â†’                    aria-hidden="true"
   264â†’                  >
   265â†’                    {skill.icon}
   266â†’                  </div>
   267â†’                  <div>
   268â†’                    <p className="text-text-primary font-medium">{skill.name}</p>
   269â†’                    <p className="text-sm text-text-secondary">æ¥æ”¶ {skill.name} ç›¸å…³æ¨é€</p>
   270â†’                  </div>
   271â†’                </label>
   272â†’                <div className="relative inline-flex items-center">
   273â†’                  <input
   274â†’                    id={toggleId}
   275â†’                    type="checkbox"
   276â†’                    checked={sub?.push_enabled ?? false}
   277â†’                    onChange={(e) => handleTogglePush(skill.id, e.target.checked)}
   278â†’                    className="sr-only peer"
   279â†’                    aria-label={`${sub?.push_enabled ? 'å…³é—­' : 'å¼€å¯'} ${skill.name} æ¨é€é€šçŸ¥`}
   280â†’                  />
   281â†’                  <div className="w-11 h-6 bg-[var(--bg-secondary)] peer-focus-visible:ring-2 peer-focus-visible:ring-accent peer-focus-visible:ring-offset-2 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-transform peer-checked:bg-accent cursor-pointer"></div>
   282â†’                </div>
   283â†’              </div>
   284â†’            )
   285â†’          })}
   286â†’        </div>
   287â†’      )}
   288â†’
   289â†’      <div className="pt-4 border-t border-[var(--border-light)]">
   290â†’        <p className="text-xs text-text-tertiary">
   291â†’          æ¨é€é€šçŸ¥ç”¨äºæé†’ä½ é‡è¦çš„è¿åŠ¿å˜åŒ–å’Œä¸ªæ€§åŒ–å»ºè®®ã€‚ä½ å¯ä»¥éšæ—¶åœ¨è¿™é‡Œè°ƒæ•´è®¾ç½®ã€‚
   292â†’        </p>
   293â†’      </div>
   294â†’    </div>
   295â†’  )
   296â†’}
   297â†’
   298â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   299â†’// è®°å¿†ç®¡ç†åŒºå— - æ˜¾ç¤ºç”¨æˆ·æ´å¯Ÿ
   300â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   301â†’
   302â†’function MemoryManagementSection() {
   303â†’  const [insights, setInsights] = useState<Array<{ id: string; content: string; created_at: string }>>([])
   304â†’  const [isLoading, setIsLoading] = useState(true)
   305â†’
   306â†’  useEffect(() => {
   307â†’    const loadInsights = async () => {
   308â†’      try {
   309â†’        const token = getAccessToken()
   310â†’        if (!token) return
   311â†’
   312â†’        // å°è¯•ä» identity prism API è·å–è®°å¿†
   313â†’        const res = await fetch(`${API_BASE}/identity/prism`, {
   314â†’          headers: { Authorization: `Bearer ${token}` }
   315â†’        })
   316â†’        if (res.ok) {
   317â†’          const data = await res.json()
   318â†’          if (data.memories) {
   319â†’            setInsights(data.memories.map((m: { content: string; date: string }, i: number) => ({
   320â†’              id: String(i),
   321â†’              content: m.content,
   322â†’              created_at: m.date
   323â†’            })))
   324â†’          }
   325â†’        }
   326â†’      } catch (err) {
   327â†’        console.error('Failed to load insights:', err)
   328â†’      } finally {
   329â†’        setIsLoading(false)
   330â†’      }
   331â†’    }
   332â†’    loadInsights()
   333â†’  }, [])
   334â†’
   335â†’  if (isLoading) {
   336â†’    return (
   337â†’      <div className="space-y-6">
   338â†’        <h2 className="font-serif text-xl text-text-primary">è®°å¿†ç®¡ç†</h2>
   339â†’        <div className="animate-pulse space-y-3">
   340â†’          <div className="h-16 bg-[var(--bg-secondary)] rounded-lg" />
   341â†’          <div className="h-16 bg-[var(--bg-secondary)] rounded-lg" />
   342â†’        </div>
   343â†’      </div>
   344â†’    )
   345â†’  }
   346â†’
   347â†’  return (
   348â†’    <div className="space-y-6">
   349â†’      <h2 className="font-serif text-xl text-text-primary">è®°å¿†ç®¡ç†</h2>
   350â†’      <p className="text-sm text-text-secondary">
   351â†’        VibeLife ä¼šè®°ä½ä½ åˆ†äº«çš„ä¿¡æ¯ï¼Œä»¥æä¾›æ›´ä¸ªæ€§åŒ–çš„ä½“éªŒã€‚
   352â†’      </p>
   353â†’
   354â†’      {insights.length === 0 ? (
   355â†’        <div className="text-center py-8 text-text-secondary">
   356â†’          <p>æš‚æ— è®°å¿†</p>
   357â†’          <p className="text-sm mt-2">ä¸ VibeLife å¯¹è¯åï¼Œä¼šè‡ªåŠ¨ç§¯ç´¯å¯¹ä½ çš„äº†è§£</p>
   358â†’        </div>
   359â†’      ) : (
   360â†’        <div className="space-y-3">
   361â†’          {insights.map((insight) => (
   362â†’            <div key={insight.id} className="flex items-center justify-between p-4 bg-[var(--bg-callout)] rounded-lg">
   363â†’              <div>
   364â†’                <p className="text-text-primary">{insight.content}</p>
   365â†’                <p className="text-xs text-text-secondary mt-1">{insight.created_at}</p>
   366â†’              </div>
   367â†’            </div>
   368â†’          ))}
   369â†’        </div>
   370â†’      )}
   371â†’
   372â†’      <div className="pt-4 border-t border-[var(--border-light)]">
   373â†’        <p className="text-xs text-text-tertiary">
   374â†’          è®°å¿†å¸®åŠ© VibeLife æ›´å¥½åœ°ç†è§£ä½ ï¼Œæä¾›æ›´ç²¾å‡†çš„å»ºè®®ã€‚
   375â†’          å¦‚éœ€æ¸…é™¤æ‰€æœ‰è®°å¿†ï¼Œè¯·åœ¨è´¦æˆ·ç®¡ç†ä¸­åˆ é™¤è´¦æˆ·ã€‚
   376â†’        </p>
   377â†’      </div>
   378â†’    </div>
   379â†’  )
   380â†’}
   381â†’
   382â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   383â†’// éšç§ä¸å®‰å…¨åŒºå—
   384â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   385â†’
   386â†’function PrivacySecuritySection() {
   387â†’  const router = useRouter()
   388â†’
   389â†’  return (
   390â†’    <div className="space-y-6">
   391â†’      <h2 className="font-serif text-xl text-text-primary">éšç§ä¸å®‰å…¨</h2>
   392â†’
   393â†’      <div className="space-y-4">
   394â†’        <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
   395â†’          <div className="flex items-center justify-between">
   396â†’            <div>
   397â†’              <p className="text-text-primary font-medium">æ•°æ®å¯¼å‡º</p>
   398â†’              <p className="text-sm text-text-secondary">ä¸‹è½½ä½ åœ¨ VibeLife çš„æ‰€æœ‰æ•°æ®</p>
   399â†’            </div>
   400â†’            <button
   401â†’              onClick={() => {
   402â†’                const token = getAccessToken()
   403â†’                if (token) {
   404â†’                  window.open(`${API_BASE}/profile/export`, '_blank')
   405â†’                }
   406â†’              }}
   407â†’              className="px-4 py-2 text-sm bg-[var(--bg-secondary)] rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   408â†’              aria-label="å¯¼å‡ºä½ åœ¨ VibeLife çš„æ‰€æœ‰æ•°æ®"
   409â†’            >
   410â†’              å¯¼å‡ºæ•°æ®
   411â†’            </button>
   412â†’          </div>
   413â†’        </div>
   414â†’
   415â†’        <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
   416â†’          <div className="flex items-center justify-between">
   417â†’            <div>
   418â†’              <p className="text-text-primary font-medium">ç™»å½•è®¾å¤‡</p>
   419â†’              <p className="text-sm text-text-secondary">æŸ¥çœ‹å’Œç®¡ç†ä½ çš„ç™»å½•è®¾å¤‡</p>
   420â†’            </div>
   421â†’            <span className="text-sm text-text-tertiary">å³å°†æ¨å‡º</span>
   422â†’          </div>
   423â†’        </div>
   424â†’
   425â†’        <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
   426â†’          <div className="flex items-center justify-between">
   427â†’            <div>
   428â†’              <p className="text-text-primary font-medium">åŒé‡è®¤è¯</p>
   429â†’              <p className="text-sm text-text-secondary">å¢å¼ºè´¦æˆ·å®‰å…¨æ€§</p>
   430â†’            </div>
   431â†’            <span className="text-sm text-text-tertiary">å³å°†æ¨å‡º</span>
   432â†’          </div>
   433â†’        </div>
   434â†’      </div>
   435â†’
   436â†’      <div className="pt-4 border-t border-[var(--border-light)]">
   437â†’        <p className="text-xs text-text-tertiary">
   438â†’          æˆ‘ä»¬é‡è§†ä½ çš„éšç§ã€‚æŸ¥çœ‹æˆ‘ä»¬çš„
   439â†’          <a href="/privacy" className="text-accent hover:underline mx-1">éšç§æ”¿ç­–</a>
   440â†’          äº†è§£æ›´å¤šã€‚
   441â†’        </p>
   442â†’      </div>
   443â†’    </div>
   444â†’  )
   445â†’}
   446â†’
   447â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   448â†’// å¸®åŠ©ä¸åé¦ˆåŒºå—
   449â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   450â†’
   451â†’function HelpFeedbackSection() {
   452â†’  return (
   453â†’    <div className="space-y-6">
   454â†’      <h2 className="font-serif text-xl text-text-primary">å¸®åŠ©ä¸åé¦ˆ</h2>
   455â†’
   456â†’      <div className="space-y-4">
   457â†’        <a
   458â†’          href="mailto:support@vibelife.app"
   459â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   460â†’        >
   461â†’          <div className="flex items-center gap-3">
   462â†’            <span className="text-xl" aria-hidden="true">ğŸ“§</span>
   463â†’            <div>
   464â†’              <p className="text-text-primary font-medium">è”ç³»å®¢æœ</p>
   465â†’              <p className="text-sm text-text-secondary">support@vibelife.app</p>
   466â†’            </div>
   467â†’          </div>
   468â†’        </a>
   469â†’
   470â†’        <a
   471â†’          href="https://vibelife.app/faq"
   472â†’          target="_blank"
   473â†’          rel="noopener noreferrer"
   474â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   475â†’        >
   476â†’          <div className="flex items-center gap-3">
   477â†’            <span className="text-xl" aria-hidden="true">â“</span>
   478â†’            <div>
   479â†’              <p className="text-text-primary font-medium">å¸¸è§é—®é¢˜</p>
   480â†’              <p className="text-sm text-text-secondary">æŸ¥çœ‹å¸¸è§é—®é¢˜è§£ç­”</p>
   481â†’            </div>
   482â†’          </div>
   483â†’        </a>
   484â†’
   485â†’        <a
   486â†’          href="https://vibelife.app/feedback"
   487â†’          target="_blank"
   488â†’          rel="noopener noreferrer"
   489â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   490â†’        >
   491â†’          <div className="flex items-center gap-3">
   492â†’            <span className="text-xl" aria-hidden="true">ğŸ’¡</span>
   493â†’            <div>
   494â†’              <p className="text-text-primary font-medium">åŠŸèƒ½å»ºè®®</p>
   495â†’              <p className="text-sm text-text-secondary">å‘Šè¯‰æˆ‘ä»¬ä½ å¸Œæœ›çœ‹åˆ°çš„åŠŸèƒ½</p>
   496â†’            </div>
   497â†’          </div>
   498â†’        </a>
   499â†’
   500â†’        <a
   501â†’          href="https://vibelife.app/bug-report"
   502â†’          target="_blank"
   503â†’          rel="noopener noreferrer"
   504â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   505â†’        >
   506â†’          <div className="flex items-center gap-3">
   507â†’            <span className="text-xl" aria-hidden="true">ğŸ›</span>
   508â†’            <div>
   509â†’              <p className="text-text-primary font-medium">æŠ¥å‘Šé—®é¢˜</p>
   510â†’              <p className="text-sm text-text-secondary">å‘ç°é—®é¢˜ï¼Ÿå‘Šè¯‰æˆ‘ä»¬</p>
   511â†’            </div>
   512â†’          </div>
   513â†’        </a>
   514â†’      </div>
   515â†’    </div>
   516â†’  )
   517â†’}
   518â†’
   519â†’// ç™»å½•æ£€æŸ¥ Wrapper
   520â†’function SettingsAuthGuard({ children }: { children: React.ReactNode }) {
   521â†’  const router = useRouter()
   522â†’  const { user, isLoaded: authLoaded } = useAuth()
   523â†’
   524â†’  if (!authLoaded) {
   525â†’    return (
   526â†’      <div className="h-screen flex items-center justify-center bg-background">
   527â†’        <div className="animate-pulse text-muted-foreground">åŠ è½½ä¸­...</div>
   528â†’      </div>
   529â†’    )
   530â†’  }
   531â†’
   532â†’  if (!user) {
   533â†’    return (
   534â†’      <div className="h-screen flex flex-col bg-background">
   535â†’        <div className="flex-1 flex flex-col items-center justify-center p-8">
   536â†’          <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-vellum-200 to-vellum-300 flex items-center justify-center mb-6">
   537â†’            <span className="text-4xl">âš™ï¸</span>
   538â†’          </div>
   539â†’          <h2 className="text-2xl font-bold text-foreground mb-2">è®¾ç½®</h2>
   540â†’          <p className="text-muted-foreground text-center max-w-md mb-6">
   541â†’            ç™»å½•åå³å¯ç®¡ç†ä½ çš„ä¸ªäººèµ„æ–™ã€è®¢é˜…å’Œåå¥½è®¾ç½®ã€‚
   542â†’          </p>
   543â†’          <button
   544â†’            onClick={() => router.push('/auth/login?redirect=/settings')}
   545â†’            className="px-6 py-3 rounded-full bg-accent-primary text-white font-medium hover:bg-accent-primary/90 transition-colors"
   546â†’          >
   547â†’            ç™»å½•
   548â†’          </button>
   549â†’        </div>
   550â†’      </div>
   551â†’    )
   552â†’  }
   553â†’
   554â†’  return <>{children}</>
   555â†’}
   556â†’
   557â†’function SettingsPageContent() {
   558â†’  const router = useRouter()
   559â†’  const searchParams = useSearchParams()
   560â†’
   561â†’  // URL çŠ¶æ€åŒæ­¥ - ä» URL è¯»å– section å‚æ•°
   562â†’  const sectionFromUrl = searchParams.get('section')
   563â†’  const validSections = SETTINGS_MENU.map(m => m.id)
   564â†’  const initialSection = sectionFromUrl && validSections.includes(sectionFromUrl) ? sectionFromUrl : 'profile'
   565â†’
   566â†’  const [activeSection, setActiveSection] = useState(initialSection)
   567â†’
   568â†’  // åŒæ­¥ activeSection åˆ° URL
   569â†’  const handleSectionChange = useCallback((sectionId: string) => {
   570â†’    setActiveSection(sectionId)
   571â†’    const url = new URL(window.location.href)
   572â†’    url.searchParams.set('section', sectionId)
   573â†’    router.replace(url.pathname + url.search, { scroll: false })
   574â†’  }, [router])
   575â†’  const [loading, setLoading] = useState(false)
   576â†’  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic" | "wise">("warm")
   577â†’  const [profile, setProfile] = useState<UserProfile>(() => ({
   578â†’    nickname: 'ç”¨æˆ·',
   579â†’    email: 'user@example.com',
   580â†’    avatar: 'ğŸ‘¤',
   581â†’    // Do not prefill with fake defaults; leave empty until loaded
   582â†’    birthDate: '',
   583â†’    birthTime: '',
   584â†’    timezone: 'Asia/Shanghai',
   585â†’  }))
   586â†’  // Local Y/M/D states for better date UX (year select solves typing issue)
   587â†’  const [birthYear, setBirthYear] = useState('')
   588â†’  const [birthMonth, setBirthMonth] = useState('')
   589â†’  const [birthDay, setBirthDay] = useState('')
   590â†’
   591â†’  useEffect(() => {
   592â†’    // Prefer authoritative profile from API; fall back to cached localStorage
   593â†’    const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
   594â†’    if (user) {
   595â†’      setProfile(prev => ({
   596â†’        ...prev,
   597â†’        nickname: user.nickname || user.display_name || 'ç”¨æˆ·',
   598â†’        email: user.email || '',
   599â†’        avatar: user.avatar || 'ğŸ‘¤',
   600â†’        timezone: user.timezone || 'Asia/Shanghai',
   601â†’      }))
   602â†’    }
   603â†’
   604â†’    const token = getAccessToken()
   605â†’    if (!token) return
   606â†’
   607â†’    // Fetch current profile to populate birth date/time accurately
   608â†’    fetch(`${API_BASE}/profile`, {
   609â†’      headers: { 'Authorization': `Bearer ${token}` }
   610â†’    })
   611â†’      .then(async (res) => {
   612â†’        if (!res.ok) return null
   613â†’        return res.json()
   614â†’      })
   615â†’      .then((data) => {
   616â†’        if (!data) return
   617â†’        // Parse ISO like "YYYY-MM-DDTHH:MM:SS" without TZ shift
   618â†’        const iso: string | undefined = data.birth_datetime
   619â†’        let birthDate = ''
   620â†’        let birthTime = ''
   621â†’        if (iso && typeof iso === 'string') {
   622â†’          const [d, t] = iso.split('T')
   623â†’          birthDate = d || ''
   624â†’          if (t) birthTime = t.slice(0, 5) // HH:MM
   625â†’        }
   626â†’
   627â†’        setProfile(prev => ({
   628â†’          ...prev,
   629â†’          nickname: data.display_name ?? prev.nickname,
   630â†’          avatar: data.avatar_url ? 'ğŸ‘¤' : prev.avatar,
   631â†’          birthDate,
   632â†’          birthTime,
   633â†’          timezone: data.timezone || prev.timezone,
   634â†’        }))
   635â†’      })
   636â†’      .catch(() => {})
   637â†’
   638â†’    // Load voice mode preference
   639â†’    fetch(`${API_BASE}/preferences`, {
   640â†’      headers: { 'Authorization': `Bearer ${token}` }
   641â†’    })
   642â†’      .then(res => res.ok ? res.json() : null)
   643â†’      .then(data => {
   644â†’        if (data?.voice_mode) {
   645â†’          setVoiceModeState(data.voice_mode as "warm" | "sarcastic" | "wise")
   646â†’        }
   647â†’      })
   648â†’      .catch(() => {})
   649â†’  }, [])
   650â†’
   651â†’  // Save voice mode to API
   652â†’  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic" | "wise") => {
   653â†’    setVoiceModeState(mode)
   654â†’    const token = getAccessToken()
   655â†’    if (!token) return
   656â†’    try {
   657â†’      await fetch(`${API_BASE}/preferences`, {
   658â†’        method: 'PUT',
   659â†’        headers: {
   660â†’          'Authorization': `Bearer ${token}`,
   661â†’          'Content-Type': 'application/json'
   662â†’        },
   663â†’        body: JSON.stringify({ voice_mode: mode })
   664â†’      })
   665â†’    } catch (error) {
   666â†’      console.error('Failed to save voice mode:', error)
   667â†’    }
   668â†’  }, [])
   669â†’
   670â†’  // Keep local Y/M/D in sync when profile.birthDate changes (e.g., loaded from API)
   671â†’  useEffect(() => {
   672â†’    const [y, m, d] = (profile.birthDate || '').split('-')
   673â†’    setBirthYear(y || '')
   674â†’    setBirthMonth(m || '')
   675â†’    setBirthDay(d || '')
   676â†’  }, [profile.birthDate])
   677â†’
   678â†’  // Use useCallback for stable reference (Vercel rule: rerender-functional-setstate)
   679â†’  const handleProfileChange = useCallback((field: keyof UserProfile, value: string) => {
   680â†’    setProfile(prev => ({ ...prev, [field]: value }))
   681â†’  }, [])
   682â†’
   683â†’  const handleSaveProfile = useCallback(async () => {
   684â†’    setLoading(true)
   685â†’    try {
   686â†’      const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
   687â†’      const token = getAccessToken()
   688â†’
   689â†’      if (user?.user_id && token) {
   690â†’        const body: any = {
   691â†’          display_name: profile.nickname,
   692â†’          timezone: profile.timezone,
   693â†’        }
   694â†’        // When both date and time present -> set; otherwise explicitly clear on server
   695â†’        if (profile.birthDate && profile.birthTime) {
   696â†’          body.birth_datetime = `${profile.birthDate}T${profile.birthTime}:00`
   697â†’        } else {
   698â†’          body.birth_datetime = null
   699â†’        }
   700â†’
   701â†’        const res = await fetch(`${API_BASE}/profile`, {
   702â†’          method: 'PUT',
   703â†’          headers: {
   704â†’            'Content-Type': 'application/json',
   705â†’            'Authorization': `Bearer ${token}`
   706â†’          },
   707â†’          body: JSON.stringify(body),
   708â†’        })
   709â†’
   710â†’        if (res.ok) {
   711â†’          // Update local cache with normalized values
   712â†’          setLocalStorageJSON('user', {
   713â†’            ...user,
   714â†’            nickname: profile.nickname,
   715â†’            display_name: profile.nickname,
   716â†’            birth_date: profile.birthDate || undefined,
   717â†’            birth_time: profile.birthTime || undefined,
   718â†’            timezone: profile.timezone,
   719â†’          })
   720â†’        }
   721â†’      }
   722â†’    } catch (err) {
   723â†’      console.error('Failed to save profile:', err)
   724â†’    } finally {
   725â†’      setLoading(false)
   726â†’    }
   727â†’  }, [profile])
   728â†’
   729â†’  // è®¾ç½®å†…å®¹åŒºåŸŸ
   730â†’  const SettingsContent = () => {
   731â†’    switch (activeSection) {
   732â†’      case 'profile':
   733â†’        return (
   734â†’          <div className="space-y-6">
   735â†’            <h2 className="font-serif text-xl text-text-primary">ä¸ªäººèµ„æ–™</h2>
   736â†’            <div className="space-y-4">
   737â†’              <div>
   738â†’                <label className="block text-sm text-text-secondary mb-2">å¤´åƒ</label>
   739â†’                <div className="flex items-center gap-4">
   740â†’                  <div className="w-16 h-16 rounded-full bg-[var(--bg-secondary)] flex items-center justify-center text-3xl">
   741â†’                    {profile.avatar}
   742â†’                  </div>
   743â†’                  <button className="btn btn-secondary">æ›´æ¢å¤´åƒ</button>
   744â†’                </div>
   745â†’              </div>
   746â†’              <div>
   747â†’                <label htmlFor="nickname" className="block text-sm text-text-secondary mb-2">æ˜µç§°</label>
   748â†’                <input
   749â†’                  id="nickname"
   750â†’                  type="text"
   751â†’                  value={profile.nickname}
   752â†’                  onChange={(e) => handleProfileChange('nickname', e.target.value)}
   753â†’                  className="input"
   754â†’                  autoComplete="nickname"
   755â†’                />
   756â†’              </div>
   757â†’              <div>
   758â†’                <label htmlFor="email" className="block text-sm text-text-secondary mb-2">é‚®ç®±</label>
   759â†’                <input
   760â†’                  id="email"
   761â†’                  type="email"
   762â†’                  value={profile.email}
   763â†’                  disabled
   764â†’                  className="input bg-[var(--bg-secondary)]"
   765â†’                  autoComplete="email"
   766â†’                  aria-describedby="email-hint"
   767â†’                />
   768â†’                <p id="email-hint" className="sr-only">é‚®ç®±åœ°å€ä¸å¯ä¿®æ”¹</p>
   769â†’              </div>
   770â†’              <div>
   771â†’                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¥æœŸ</label>
   772â†’                <BirthDateInputs
   773â†’                  year={birthYear}
   774â†’                  month={birthMonth}
   775â†’                  day={birthDay}
   776â†’                  onYearChange={(v) => {
   777â†’                    setBirthYear(v)
   778â†’                    const dateStr = v && birthMonth && birthDay ? `${v}-${birthMonth}-${birthDay}` : ''
   779â†’                    handleProfileChange('birthDate', dateStr)
   780â†’                  }}
   781â†’                  onMonthChange={(v) => {
   782â†’                    setBirthMonth(v)
   783â†’                    const dateStr = birthYear && v && birthDay ? `${birthYear}-${v}-${birthDay}` : ''
   784â†’                    handleProfileChange('birthDate', dateStr)
   785â†’                  }}
   786â†’                  onDayChange={(v) => {
   787â†’                    setBirthDay(v)
   788â†’                    const dateStr = birthYear && birthMonth && v ? `${birthYear}-${birthMonth}-${v}` : ''
   789â†’                    handleProfileChange('birthDate', dateStr)
   790â†’                  }}
   791â†’                  showHour={false}
   792â†’                />
   793â†’              </div>
   794â†’              <div>
   795â†’                <label htmlFor="birthTime" className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¶é—´</label>
   796â†’                <div className="flex items-center gap-3">
   797â†’                  <input
   798â†’                    id="birthTime"
   799â†’                    type="time"
   800â†’                    step={60}
   801â†’                    value={profile.birthTime}
   802â†’                    onChange={(e) => handleProfileChange('birthTime', e.target.value)}
   803â†’                    className="input"
   804â†’                    placeholder="--:--"
   805â†’                    autoComplete="off"
   806â†’                  />
   807â†’                  <label htmlFor="birthTimeUnknown" className="inline-flex items-center gap-2 text-sm text-text-secondary cursor-pointer">
   808â†’                    <input
   809â†’                      id="birthTimeUnknown"
   810â†’                      type="checkbox"
   811â†’                      checked={!profile.birthTime}
   812â†’                      onChange={(e) => handleProfileChange('birthTime', e.target.checked ? '' : '12:00')}
   813â†’                      className="rounded border-gray-300 focus:ring-accent"
   814â†’                    />
   815â†’                    ä¸ç¡®å®š
   816â†’                  </label>
   817â†’                </div>
   818â†’              </div>
   819â†’              <div>
   820â†’                <label htmlFor="timezone" className="block text-sm text-text-secondary mb-2">æ—¶åŒº</label>
   821â†’                <select
   822â†’                  id="timezone"
   823â†’                  value={profile.timezone}
   824â†’                  onChange={(e) => handleProfileChange('timezone', e.target.value)}
   825â†’                  className="input"
   826â†’                >
   827â†’                  <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
   828â†’                  <option value="Asia/Hong_Kong">Asia/Hong_Kong (UTC+8)</option>
   829â†’                  <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
   830â†’                  <option value="America/New_York">America/New_York (UTC-5)</option>
   831â†’                  <option value="America/Los_Angeles">America/Los_Angeles (UTC-8)</option>
   832â†’                  <option value="Europe/London">Europe/London (UTC+0)</option>
   833â†’                </select>
   834â†’              </div>
   835â†’              <button onClick={handleSaveProfile} disabled={loading} className="btn btn-primary">
   836â†’                {loading ? 'ä¿å­˜ä¸­â€¦' : 'ä¿å­˜æ›´æ”¹'}
   837â†’              </button>
   838â†’            </div>
   839â†’          </div>
   840â†’        )
   841â†’      case 'skills':
   842â†’        return <SkillSettingsSection router={router} />
   843â†’      case 'notifications':
   844â†’        return <NotificationSettingsSection />
   845â†’      case 'membership':
   846â†’        return (
   847â†’          <div className="space-y-6">
   848â†’            <h2 className="font-serif text-xl text-text-primary">ä¼šå‘˜ç®¡ç†</h2>
   849â†’            <div className="card p-6">
   850â†’              <div className="flex items-center justify-between mb-4">
   851â†’                <div>
   852â†’                  <p className="text-text-primary font-medium">å½“å‰çŠ¶æ€</p>
   853â†’                  <p className="text-sm text-text-secondary">å…è´¹ç”¨æˆ·</p>
   854â†’                </div>
   855â†’                <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded-full text-sm text-text-secondary">Free</span>
   856â†’              </div>
   857â†’              <button onClick={() => router.push('/membership')} className="btn btn-premium w-full">
   858â†’                âœ¨ å‡çº§ Premium
   859â†’              </button>
   860â†’            </div>
   861â†’            <div className="space-y-3">
   862â†’              <p className="text-sm text-text-secondary">Premium ä¼šå‘˜æƒç›Šï¼š</p>
   863â†’              <ul className="space-y-2 text-sm text-text-secondary">
   864â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´æ¯æ—¥è¿åŠ¿</li>
   865â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> 30&#x00A0;æ¬¡/å¤© AIå¯¹è¯</li>
   866â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´å¤§è¿/æµå¹´åˆ†æ</li>
   867â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> Identity Prism æ·±åº¦è§£è¯»</li>
   868â†’              </ul>
   869â†’            </div>
   870â†’          </div>
   871â†’        )
   872â†’      case 'memory':
   873â†’        return <MemoryManagementSection />
   874â†’      case 'account':
   875â†’        return (
   876â†’          <div className="space-y-6">
   877â†’            <h2 className="font-serif text-xl text-text-primary">è´¦æˆ·ç®¡ç†</h2>
   878â†’            <AccountDeletionSection />
   879â†’          </div>
   880â†’        )
   881â†’      case 'preferences':
   882â†’        return (
   883â†’          <div className="space-y-6">
   884â†’            <h2 className="font-serif text-xl text-text-primary">åå¥½è®¾ç½®</h2>
   885â†’            <div className="space-y-4">
   886â†’              {/* è¯­æ°”æ¨¡å¼ */}
   887â†’              <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
   888â†’                <div className="mb-3">
   889â†’                  <h3 className="text-text-primary font-medium mb-1">è¯­æ°”æ¨¡å¼</h3>
   890â†’                  <p className="text-sm text-text-secondary">é€‰æ‹© AI çš„å¯¹è¯é£æ ¼</p>
   891â†’                </div>
   892â†’                <div className="flex gap-3" role="radiogroup" aria-label="é€‰æ‹©è¯­æ°”æ¨¡å¼">
   893â†’                  <button
   894â†’                    role="radio"
   895â†’                    aria-checked={voiceMode === 'warm'}
   896â†’                    onClick={() => setVoiceMode('warm')}
   897â†’                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 ${
   898â†’                      voiceMode === 'warm'
   899â†’                        ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 shadow-sm'
   900â†’                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
   901â†’                    }`}
   902â†’                  >
   903â†’                    <div className="text-2xl mb-1" aria-hidden="true">ğŸŒ</div>
   904â†’                    <div>æ¸©æš–æ”¯æŒ</div>
   905â†’                  </button>
   906â†’                  <button
   907â†’                    role="radio"
   908â†’                    aria-checked={voiceMode === 'sarcastic'}
   909â†’                    onClick={() => setVoiceMode('sarcastic')}
   910â†’                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 ${
   911â†’                      voiceMode === 'sarcastic'
   912â†’                        ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 shadow-sm'
   913â†’                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
   914â†’                    }`}
   915â†’                  >
   916â†’                    <div className="text-2xl mb-1" aria-hidden="true">ğŸ˜ˆ</div>
   917â†’                    <div>ç›´æ¥æŒ‘æˆ˜</div>
   918â†’                  </button>
   919â†’                  <button
   920â†’                    role="radio"
   921â†’                    aria-checked={voiceMode === 'wise'}
   922â†’                    onClick={() => setVoiceMode('wise')}
   923â†’                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 ${
   924â†’                      voiceMode === 'wise'
   925â†’                        ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 shadow-sm'
   926â†’                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
   927â†’                    }`}
   928â†’                  >
   929â†’                    <div className="text-2xl mb-1" aria-hidden="true">ğŸ§™</div>
   930â†’                    <div>ç¿æ™ºå¯¼å¸ˆ</div>
   931â†’                  </button>
   932â†’                </div>
   933â†’                <div className="mt-3 p-3 bg-[var(--bg-callout)] rounded text-xs text-text-secondary">
   934â†’                  {voiceMode === 'warm' && 'ğŸ’­ åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿ'}
   935â†’                  {voiceMode === 'sarcastic' && 'ğŸ’­ ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸'}
   936â†’                  {voiceMode === 'wise' && 'ğŸ’­ åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒ'}
   937â†’                </div>
   938â†’              </div>
   939â†’            </div>
   940â†’          </div>
   941â†’        )
   942â†’      case 'privacy':
   943â†’        return <PrivacySecuritySection />
   944â†’      case 'help':
   945â†’        return <HelpFeedbackSection />
   946â†’      case 'about':
   947â†’        return (
   948â†’          <div className="space-y-6">
   949â†’            <h2 className="font-serif text-xl text-text-primary">å…³äº VibeLife</h2>
   950â†’            <div className="text-center py-8">
   951â†’              <span className="text-5xl mb-4 block">ğŸŒŸ</span>
   952â†’              <h3 className="font-serif text-2xl text-text-primary mb-2">VibeLife</h3>
   953â†’              <p className="text-text-secondary mb-4">æ¢ç´¢å†…å¿ƒä¸–ç•Œ</p>
   954â†’              <p className="text-sm text-text-secondary">ç‰ˆæœ¬&#x00A0;6.0.0</p>
   955â†’            </div>
   956â†’            <div className="space-y-2 text-sm text-text-secondary">
   957â†’              <a href="/terms" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">ç”¨æˆ·åè®®</a>
   958â†’              <a href="/privacy" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">éšç§æ”¿ç­–</a>
   959â†’              <a href="mailto:support@vibelife.app" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">è”ç³»æˆ‘ä»¬</a>
   960â†’            </div>
   961â†’          </div>
   962â†’        )
   963â†’      default:
   964â†’        return (
   965â†’          <div className="text-center py-8 text-text-secondary">
   966â†’            <p>è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
   967â†’          </div>
   968â†’        )
   969â†’    }
   970â†’  }
   971â†’
   972â†’  // ä½¿ç”¨ AuthProvider çš„ logout åŠŸèƒ½
   973â†’  const { logout } = useAuth()
   974â†’
   975â†’  // å¤„ç†é€€å‡ºç™»å½•
   976â†’  const handleLogout = useCallback(async () => {
   977â†’    try {
   978â†’      await logout()
   979â†’      router.push('/auth/login')
   980â†’    } catch (err) {
   981â†’      console.error('Logout failed:', err)
   982â†’    }
   983â†’  }, [logout, router])
   984â†’
   985â†’  // PCç«¯è®¾ç½®èœå•åŒºå— - V10 æ¸å˜èƒŒæ™¯ emoji å›¾æ ‡é£æ ¼
   986â†’  const SettingsMenuSection = () => (
   987â†’    <div className="w-64 flex-shrink-0 bg-card border-r border-border h-full overflow-y-auto">
   988â†’      <div className="p-4 border-b border-border">
   989â†’        <h2 className="font-semibold text-foreground">è®¾ç½®</h2>
   990â†’      </div>
   991â†’      <nav className="p-2 space-y-1" aria-label="è®¾ç½®èœå•">
   992â†’        {SETTINGS_MENU.map((item) => (
   993â†’          <button
   994â†’            key={item.id}
   995â†’            onClick={() => handleSectionChange(item.id)}
   996â†’            aria-current={activeSection === item.id ? 'page' : undefined}
   997â†’            className={cn(
   998â†’              "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2",
   999â†’              activeSection === item.id
  1000â†’                ? 'bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]'
  1001â†’                : 'text-muted-foreground hover:bg-muted hover:text-foreground'
  1002â†’            )}
  1003â†’          >
  1004â†’            <div className={cn(
  1005â†’              "w-7 h-7 rounded-lg flex items-center justify-center flex-shrink-0 transition-all",
  1006â†’              activeSection === item.id
  1007â†’                ? "bg-gradient-to-br from-vellum-200 to-vellum-300"
  1008â†’                : "bg-gradient-to-br from-vellum-100 to-vellum-200"
  1009â†’            )}>
  1010â†’              <span className="text-base" aria-hidden="true">{item.icon}</span>
  1011â†’            </div>
  1012â†’            <span className="text-sm font-medium">{item.label}</span>
  1013â†’          </button>
  1014â†’        ))}
  1015â†’      </nav>
  1016â†’      <div className="p-2 border-t border-border mt-2">
  1017â†’        <button
  1018â†’          onClick={handleLogout}
  1019â†’          className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2"
  1020â†’          aria-label="é€€å‡ºç™»å½•å½“å‰è´¦æˆ·"
  1021â†’        >
  1022â†’          <div className="w-7 h-7 rounded-lg bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center flex-shrink-0">
  1023â†’            <span className="text-base" aria-hidden="true">ğŸšª</span>
  1024â†’          </div>
  1025â†’          <span className="text-sm font-medium">é€€å‡ºç™»å½•</span>
  1026â†’        </button>
  1027â†’      </div>
  1028â†’    </div>
  1029â†’  )
  1030â†’
  1031â†’  // PCç«¯ä¸»å†…å®¹
  1032â†’  const PCMainContent = () => (
  1033â†’    <div className="flex-1 overflow-y-auto p-6">
  1034â†’      <div className="max-w-2xl">
  1035â†’        <div className="bg-card rounded-xl p-6 shadow-sm">
  1036â†’          <SettingsContent />
  1037â†’        </div>
  1038â†’      </div>
  1039â†’    </div>
  1040â†’  )
  1041â†’
  1042â†’  // ç§»åŠ¨ç«¯å†…å®¹
  1043â†’  const MobileContentView = () => (
  1044â†’    <div className="min-h-screen bg-background lg:hidden">
  1045â†’      <MobileHeader skill="bazi" />
  1046â†’
  1047â†’      <main className="max-w-lg mx-auto px-4 py-6">
  1048â†’        <h1 className="font-serif text-xl text-foreground mb-4">è®¾ç½®</h1>
  1049â†’        <nav className="space-y-2" aria-label="è®¾ç½®èœå•">
  1050â†’          {SETTINGS_MENU.map((item) => (
  1051â†’            <button
  1052â†’              key={item.id}
  1053â†’              onClick={() => {
  1054â†’                if (item.id === 'membership') {
  1055â†’                  router.push('/membership')
  1056â†’                } else {
  1057â†’                  handleSectionChange(item.id)
  1058â†’                }
  1059â†’              }}
  1060â†’              aria-current={activeSection === item.id ? 'page' : undefined}
  1061â†’              className="w-full bg-card p-4 flex items-center gap-3 rounded-lg shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
  1062â†’            >
  1063â†’              <div className="w-9 h-9 rounded-lg bg-gradient-to-br from-vellum-100 to-vellum-200 flex items-center justify-center flex-shrink-0">
  1064â†’                <span className="text-lg" aria-hidden="true">{item.icon}</span>
  1065â†’              </div>
  1066â†’              <span className="text-foreground">{item.label}</span>
  1067â†’              <span className="ml-auto text-muted-foreground" aria-hidden="true">â€º</span>
  1068â†’            </button>
  1069â†’          ))}
  1070â†’        </nav>
  1071â†’
  1072â†’        <div className="mt-8">
  1073â†’          <button
  1074â†’            onClick={handleLogout}
  1075â†’            className="w-full p-4 text-center text-red-500 bg-card rounded-lg shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2"
  1076â†’            aria-label="é€€å‡ºç™»å½•å½“å‰è´¦æˆ·"
  1077â†’          >
  1078â†’            é€€å‡ºç™»å½•
  1079â†’          </button>
  1080â†’        </div>
  1081â†’
  1082â†’        <div className="mt-8 text-center text-sm text-muted-foreground">
  1083â†’          <p>VibeLife v&#x00A0;6.0.0</p>
  1084â†’        </div>
  1085â†’      </main>
  1086â†’    </div>
  1087â†’  )
  1088â†’
  1089â†’  return (
  1090â†’    <div className="h-screen flex flex-col bg-background">
  1091â†’      {/* PCç«¯å¸ƒå±€ */}
  1092â†’      <div className="hidden lg:flex h-full">
  1093â†’        {/* å·¦ä¾§ NavBar - ä¸ Chat é¡µä¿æŒä¸€è‡´ */}
  1094â†’        <NavBar
  1095â†’          skill="bazi"
  1096â†’          activeTab="me"
  1097â†’          onTabChange={(tab) => {
  1098â†’            if (tab === 'chat') router.push('/chat')
  1099â†’            else if (tab === 'journey') router.push('/chat?tab=journey')
  1100â†’            else if (tab === 'discover') router.push('/chat?tab=discover')
  1101â†’            else if (tab === 'me') router.push('/chat?tab=me')
  1102â†’          }}
  1103â†’          activeConversationId={null}
  1104â†’          onSelectConversation={() => {}}
  1105â†’          onNewChat={() => router.push('/chat')}
  1106â†’        />
  1107â†’
  1108â†’        {/* è®¾ç½®èœå•åŒºå— */}
  1109â†’        <SettingsMenuSection />
  1110â†’
  1111â†’        {/* ä¸»å†…å®¹åŒºåŸŸ */}
  1112â†’        <PCMainContent />
  1113â†’      </div>
  1114â†’
  1115â†’      {/* ç§»åŠ¨ç«¯å¸ƒå±€ */}
  1116â†’      <MobileContentView />
  1117â†’    </div>
  1118â†’  )
  1119â†’}
  1120â†’
  1121â†’// ä½¿ç”¨ Suspense åŒ…è£¹ï¼Œå› ä¸ºä½¿ç”¨äº† useSearchParams
  1122â†’export default function SettingsPage() {
  1123â†’  return (
  1124â†’    <Suspense fallback={
  1125â†’      <div className="h-screen flex items-center justify-center bg-background">
  1126â†’        <div className="animate-pulse text-muted-foreground">åŠ è½½ä¸­...</div>
  1127â†’      </div>
  1128â†’    }>
  1129â†’      <SettingsAuthGuard>
  1130â†’        <SettingsPageContent />
  1131â†’      </SettingsAuthGuard>
  1132â†’    </Suspense>
  1133â†’  )
  1134â†’}
  1135â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
