     1→"use client";
     2→
     3→/**
     4→ * NavBar - PC端左侧导航栏 v10.0
     5→ *
     6→ * V10 变更:
     7→ * - 对话历史整合到 NavBar 中
     8→ * - "对话"按钮 = 开始新对话
     9→ * - 历史对话列表显示在导航链接下方
    10→ */
    11→
    12→import { useState, useEffect } from "react";
    13→import { motion, AnimatePresence } from "framer-motion";
    14→import { cn } from "@/lib/utils";
    15→import {
    16→  MessageSquare,
    17→  Compass,
    18→  Sparkles,
    19→  User,
    20→  PanelLeftClose,
    21→  PanelLeft,
    22→  Settings,
    23→  Plus,
    24→  MoreHorizontal,
    25→  Pencil,
    26→  Trash2,
    27→  Heart,
    28→} from "lucide-react";
    29→import Link from "next/link";
    30→import type { LucideIcon } from "lucide-react";
    31→import { VibeGlyph, type SkillType } from "@/components/core";
    32→import { type TabType } from "./AppShell";
    33→import { useConversations, type ConversationItem } from "@/hooks/useConversations";
    34→
    35→// ═══════════════════════════════════════════════════════════════════════════
    36→// Types & Config
    37→// ═══════════════════════════════════════════════════════════════════════════
    38→
    39→interface NavBarProps {
    40→  skill: SkillType;
    41→  activeTab: TabType;
    42→  onTabChange: (tab: TabType) => void;
    43→  activeConversationId: string | null;
    44→  onSelectConversation: (id: string | null) => void;
    45→  onNewChat: () => void;
    46→  className?: string;
    47→}
    48→
    49→interface NavItem {
    50→  id: TabType;
    51→  icon: LucideIcon;
    52→  label: string;
    53→  description?: string;
    54→  color?: string;
    55→}
    56→
    57→// V10: 4 navigation items - 顺序：我、旅程、关系、探索
    58→const NAV_ITEMS: NavItem[] = [
    59→  {
    60→    id: "me",
    61→    icon: User,
    62→    label: "我",
    63→    description: "个人中心",
    64→    color: "#3b82f6", // 蓝色
    65→  },
    66→  {
    67→    id: "journey",
    68→    icon: Compass,
    69→    label: "目标",
    70→    description: "我的目标",
    71→    color: "#22c55e", // 翠绿
    72→  },
    73→  {
    74→    id: "relations",
    75→    icon: Heart,
    76→    label: "关系",
    77→    description: "人际关系",
    78→    color: "#ec4899", // 粉红
    79→  },
    80→  {
    81→    id: "discover",
    82→    icon: Sparkles,
    83→    label: "探索",
    84→    description: "发现更多 Skills",
    85→    color: "#a855f7", // 紫色
    86→  },
    87→];
    88→
    89→const STORAGE_KEY = "vibelife-navbar-expanded";
    90→
    91→// ═══════════════════════════════════════════════════════════════════════════
    92→// NavBar Component
    93→// ═══════════════════════════════════════════════════════════════════════════
    94→
    95→export function NavBar({
    96→  skill,
    97→  activeTab,
    98→  onTabChange,
    99→  activeConversationId,
   100→  onSelectConversation,
   101→  onNewChat,
   102→  className,
   103→}: NavBarProps) {
   104→  const [isExpanded, setIsExpanded] = useState(true); // 默认展开
   105→  const [hoveredItem, setHoveredItem] = useState<string | null>(null);
   106→  const [isMounted, setIsMounted] = useState(false);
   107→  const [menuOpenId, setMenuOpenId] = useState<string | null>(null);
   108→  const [editingId, setEditingId] = useState<string | null>(null);
   109→  const [editTitle, setEditTitle] = useState("");
   110→
   111→  const { conversations, isLoading, renameConversation, deleteConversation } = useConversations();
   112→
   113→  // 从 localStorage 恢复状态
   114→  useEffect(() => {
   115→    setIsMounted(true);
   116→    const saved = localStorage.getItem(STORAGE_KEY);
   117→    if (saved !== null) {
   118→      setIsExpanded(saved === "true");
   119→    }
   120→  }, []);
   121→
   122→  const toggleExpanded = () => {
   123→    setIsExpanded((prev) => {
   124→      const newValue = !prev;
   125→      if (typeof window !== "undefined") {
   126→        localStorage.setItem(STORAGE_KEY, String(newValue));
   127→      }
   128→      return newValue;
   129→    });
   130→  };
   131→
   132→  // 开始新对话
   133→  const handleNewChat = () => {
   134→    onNewChat();
   135→    onTabChange("chat");
   136→  };
   137→
   138→  // 选择对话
   139→  const handleSelectConversation = (id: string) => {
   140→    onSelectConversation(id);
   141→    onTabChange("chat");
   142→    setMenuOpenId(null);
   143→  };
   144→
   145→  // 重命名对话
   146→  const handleRename = async (id: string) => {
   147→    if (editTitle.trim()) {
   148→      await renameConversation(id, editTitle.trim());
   149→    }
   150→    setEditingId(null);
   151→    setEditTitle("");
   152→  };
   153→
   154→  // 删除对话
   155→  const handleDelete = async (id: string) => {
   156→    await deleteConversation(id);
   157→    if (activeConversationId === id) {
   158→      onSelectConversation(null);
   159→    }
   160→    setMenuOpenId(null);
   161→  };
   162→
   163→  return (
   164→    <motion.nav
   165→      initial={false}
   166→      animate={{ width: isExpanded ? 260 : 64 }}
   167→      transition={{ duration: 0.2, ease: "easeInOut" }}
   168→      className={cn(
   169→        "h-full flex flex-col bg-card border-r border-border",
   170→        className
   171→      )}
   172→    >
   173→      {/* Logo Area + Collapse Toggle */}
   174→      <div className="h-14 flex items-center justify-between px-3 border-b border-border">
   175→        <div className="flex items-center gap-2">
   176→          <VibeGlyph size="sm" skill={skill} showAura={false} animate={false} />
   177→          {isExpanded && (
   178→            <span className="font-serif font-semibold text-foreground whitespace-nowrap">
   179→              VibeLife
   180→            </span>
   181→          )}
   182→        </div>
   183→        <button
   184→          onClick={toggleExpanded}
   185→          aria-label={isExpanded ? "收起侧边栏" : "展开侧边栏"}
   186→          className="p-1.5 rounded-md text-muted-foreground/60 hover:text-muted-foreground hover:bg-muted/50 transition-colors"
   187→        >
   188→          {isExpanded ? <PanelLeftClose className="w-4 h-4" /> : <PanelLeft className="w-4 h-4" />}
   189→        </button>
   190→      </div>
   191→
   192→      {/* Main Nav Section - 新对话 + 导航项 */}
   193→      <div className="px-2 pt-3 pb-2 space-y-1">
   194→        {/* 新对话按钮 */}
   195→        <div className="relative">
   196→          <button
   197→            onClick={handleNewChat}
   198→            onMouseEnter={() => !isExpanded && setHoveredItem("chat")}
   199→            onMouseLeave={() => setHoveredItem(null)}
   200→            className={cn(
   201→              "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200",
   202→              isExpanded ? "justify-start" : "justify-center",
   203→              "bg-muted/60 text-foreground hover:bg-muted",
   204→              "border border-border/50"
   205→            )}
   206→          >
   207→            <Plus className="w-5 h-5 flex-shrink-0" />
   208→            {isExpanded && (
   209→              <span className="text-sm font-medium whitespace-nowrap">新对话</span>
   210→            )}
   211→          </button>
   212→          {!isExpanded && hoveredItem === "chat" && (
   213→            <motion.div
   214→              initial={{ opacity: 0, x: -4 }}
   215→              animate={{ opacity: 1, x: 0 }}
   216→              className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
   217→            >
   218→              <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
   219→                新对话
   220→                <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
   221→              </div>
   222→            </motion.div>
   223→          )}
   224→        </div>
   225→
   226→        {/* 导航项：我、旅程、关系、探索 */}
   227→        {NAV_ITEMS.map((item) => {
   228→          const Icon = item.icon;
   229→          const isActive = activeTab === item.id;
   230→
   231→          return (
   232→            <div key={item.id} className="relative">
   233→              <button
   234→                onClick={() => onTabChange(item.id)}
   235→                onMouseEnter={() => !isExpanded && setHoveredItem(item.id)}
   236→                onMouseLeave={() => setHoveredItem(null)}
   237→                className={cn(
   238→                  "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200",
   239→                  isExpanded ? "justify-start" : "justify-center",
   240→                  isActive
   241→                    ? "bg-black/5 dark:bg-white/10"
   242→                    : "hover:bg-muted"
   243→                )}
   244→              >
   245→                <Icon
   246→                  className="w-5 h-5 flex-shrink-0"
   247→                  style={{ color: item.color }}
   248→                />
   249→                {isExpanded && (
   250→                  <span className="text-sm font-medium text-foreground">{item.label}</span>
   251→                )}
   252→              </button>
   253→              {!isExpanded && hoveredItem === item.id && (
   254→                <motion.div
   255→                  initial={{ opacity: 0, x: -4 }}
   256→                  animate={{ opacity: 1, x: 0 }}
   257→                  className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
   258→                >
   259→                  <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
   260→                    {item.label}
   261→                    <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
   262→                  </div>
   263→                </motion.div>
   264→              )}
   265→            </div>
   266→          );
   267→        })}
   268→      </div>
   269→
   270→      {/* Conversation History Section - 展开态显示 */}
   271→      {isExpanded && (
   272→        <div className="flex-1 overflow-y-auto border-t border-border">
   273→          <div className="px-2 pt-2 pb-2">
   274→            <div className="text-xs text-muted-foreground px-3 py-2 font-medium">
   275→              对话历史
   276→            </div>
   277→            <div className="space-y-0.5">
   278→              {conversations.slice(0, 20).map((conv) => (
   279→                <ConversationItem
   280→                  key={conv.id}
   281→                  conversation={conv}
   282→                  isActive={activeConversationId === conv.id}
   283→                  isMenuOpen={menuOpenId === conv.id}
   284→                  isEditing={editingId === conv.id}
   285→                  editTitle={editTitle}
   286→                  onSelect={() => handleSelectConversation(conv.id)}
   287→                  onMenuToggle={() => setMenuOpenId(menuOpenId === conv.id ? null : conv.id)}
   288→                  onStartEdit={() => {
   289→                    setEditingId(conv.id);
   290→                    setEditTitle(conv.title || "");
   291→                    setMenuOpenId(null);
   292→                  }}
   293→                  onEditChange={setEditTitle}
   294→                  onEditSave={() => handleRename(conv.id)}
   295→                  onEditCancel={() => {
   296→                    setEditingId(null);
   297→                    setEditTitle("");
   298→                  }}
   299→                  onDelete={() => handleDelete(conv.id)}
   300→                />
   301→              ))}
   302→              {isLoading && (
   303→                <div className="px-3 py-2 text-xs text-muted-foreground">加载中...</div>
   304→              )}
   305→              {!isLoading && conversations.length === 0 && (
   306→                <div className="px-3 py-2 text-xs text-muted-foreground">暂无对话</div>
   307→              )}
   308→            </div>
   309→          </div>
   310→        </div>
   311→      )}
   312→
   313→      {/* 收起态时的占位 */}
   314→      {!isExpanded && <div className="flex-1" />}
   315→
   316→      {/* Settings Link */}
   317→      <div className="p-2 border-t border-border">
   318→        <Link
   319→          href="/settings"
   320→          className={cn(
   321→            "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200",
   322→            "text-muted-foreground hover:bg-muted hover:text-foreground"
   323→          )}
   324→        >
   325→          <Settings className="w-5 h-5 flex-shrink-0" />
   326→          <AnimatePresence>
   327→            {isExpanded && (
   328→              <motion.span
   329→                initial={{ opacity: 0, width: 0 }}
   330→                animate={{ opacity: 1, width: "auto" }}
   331→                exit={{ opacity: 0, width: 0 }}
   332→                className="text-sm font-medium overflow-hidden whitespace-nowrap"
   333→              >
   334→                设置
   335→              </motion.span>
   336→            )}
   337→          </AnimatePresence>
   338→        </Link>
   339→      </div>
   340→    </motion.nav>
   341→  );
   342→}
   343→
   344→// ═══════════════════════════════════════════════════════════════════════════
   345→// ConversationItem Component
   346→// ═══════════════════════════════════════════════════════════════════════════
   347→
   348→interface ConversationItemProps {
   349→  conversation: ConversationItem;
   350→  isActive: boolean;
   351→  isMenuOpen: boolean;
   352→  isEditing: boolean;
   353→  editTitle: string;
   354→  onSelect: () => void;
   355→  onMenuToggle: () => void;
   356→  onStartEdit: () => void;
   357→  onEditChange: (value: string) => void;
   358→  onEditSave: () => void;
   359→  onEditCancel: () => void;
   360→  onDelete: () => void;
   361→}
   362→
   363→function ConversationItem({
   364→  conversation,
   365→  isActive,
   366→  isMenuOpen,
   367→  isEditing,
   368→  editTitle,
   369→  onSelect,
   370→  onMenuToggle,
   371→  onStartEdit,
   372→  onEditChange,
   373→  onEditSave,
   374→  onEditCancel,
   375→  onDelete,
   376→}: ConversationItemProps) {
   377→  if (isEditing) {
   378→    return (
   379→      <div className="px-2 py-1">
   380→        <input
   381→          type="text"
   382→          value={editTitle}
   383→          onChange={(e) => onEditChange(e.target.value)}
   384→          onKeyDown={(e) => {
   385→            if (e.key === "Enter") onEditSave();
   386→            if (e.key === "Escape") onEditCancel();
   387→          }}
   388→          onBlur={onEditSave}
   389→          autoFocus
   390→          className="w-full px-2 py-1 text-sm bg-background border border-border rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--accent-primary)]"
   391→        />
   392→      </div>
   393→    );
   394→  }
   395→
   396→  return (
   397→    <div className="relative group">
   398→      <button
   399→        onClick={onSelect}
   400→        className={cn(
   401→          "w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left transition-all duration-200",
   402→          isActive
   403→            ? "bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]"
   404→            : "text-text-secondary hover:bg-muted hover:text-foreground"
   405→        )}
   406→      >
   407→        <MessageSquare className="w-4 h-4 flex-shrink-0 opacity-60" />
   408→        <span className="text-sm truncate flex-1">{conversation.title || "新对话"}</span>
   409→      </button>
   410→
   411→      {/* Menu Button */}
   412→      <button
   413→        onClick={(e) => {
   414→          e.stopPropagation();
   415→          onMenuToggle();
   416→        }}
   417→        className={cn(
   418→          "absolute right-1 top-1/2 -translate-y-1/2 p-1 rounded-md transition-opacity",
   419→          "opacity-0 group-hover:opacity-100",
   420→          isMenuOpen && "opacity-100",
   421→          "text-muted-foreground hover:text-foreground hover:bg-muted"
   422→        )}
   423→      >
   424→        <MoreHorizontal className="w-4 h-4" />
   425→      </button>
   426→
   427→      {/* Dropdown Menu */}
   428→      {isMenuOpen && (
   429→        <div className="absolute right-0 top-full mt-1 z-50 bg-card border border-border rounded-lg shadow-lg py-1 min-w-[120px]">
   430→          <button
   431→            onClick={(e) => {
   432→              e.stopPropagation();
   433→              onStartEdit();
   434→            }}
   435→            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left hover:bg-muted transition-colors"
   436→          >
   437→            <Pencil className="w-3.5 h-3.5" />
   438→            <span>重命名</span>
   439→          </button>
   440→          <button
   441→            onClick={(e) => {
   442→              e.stopPropagation();
   443→              onDelete();
   444→            }}
   445→            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-colors"
   446→          >
   447→            <Trash2 className="w-3.5 h-3.5" />
   448→            <span>删除</span>
   449→          </button>
   450→        </div>
   451→      )}
   452→    </div>
   453→  );
   454→}
   455→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
