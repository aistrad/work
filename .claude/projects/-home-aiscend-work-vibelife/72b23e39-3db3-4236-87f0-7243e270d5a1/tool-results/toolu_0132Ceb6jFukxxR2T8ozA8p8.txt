     1â†’"use client";
     2â†’
     3â†’/**
     4â†’ * AppShell - ä¸‰æ å¸ƒå±€å®¹å™¨ v8.0
     5â†’ * Based on: vibelife spec v8.0 - LifeCoach Dashboard
     6â†’ *
     7â†’ * V8 å˜æ›´:
     8â†’ * - å¯¼èˆªå…¥å£ä» 4 ä¸ªæ”¹ä¸º 3 ä¸ª: Dashboard / Chat / Me
     9â†’ * - é»˜è®¤é¦–é¡µä» Chat æ”¹ä¸º Dashboard
    10â†’ * - å³ä¾§è¾¹æ æ ¹æ®ä¸»èˆå°æ™ºèƒ½åˆ‡æ¢å†…å®¹
    11â†’ *
    12â†’ * å“åº”å¼æ–­ç‚¹ï¼ˆä¸ tailwind.config.ts ä¿æŒä¸€è‡´ï¼‰ï¼š
    13â†’ * - PC â‰¥1024px (lg): ä¸‰æ å¸ƒå±€
    14â†’ * - Tablet+Mobile <1024px: å•æ  + TabBar
    15â†’ *
    16â†’ * PCç«¯å¸ƒå±€ (â‰¥1024px):
    17â†’ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    18â†’ * â”‚ NavBar â”‚         ä¸»å†…å®¹åŒºåŸŸ             â”‚   Insight Panel        â”‚
    19â†’ * â”‚ (64px) â”‚       (flex-1, å·¦å¯¹é½)         â”‚    (320-600px å¯è°ƒ)    â”‚
    20â†’ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    21â†’ *
    22â†’ * Tablet+ç§»åŠ¨ç«¯å¸ƒå±€ (<1024px):
    23â†’ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    24â†’ * â”‚  Header                                  â”‚
    25â†’ * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    26â†’ * â”‚  å†…å®¹åŒºåŸŸ (æ ¹æ®Tabå®Œå…¨åˆ‡æ¢)              â”‚
    27â†’ * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    28â†’ * â”‚  ğŸ  Dashboard â”‚ ğŸ’¬ Chat â”‚ ğŸ‘¤ Me          â”‚
    29â†’ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    30â†’ */
    31â†’
    32â†’import { useState, useEffect, useCallback, createContext, useContext, ReactNode } from "react";
    33â†’import { useSearchParams, useRouter } from "next/navigation";
    34â†’import { apiClient } from "@/lib/api";
    35â†’import { cn } from "@/lib/utils";
    36â†’import { type SkillType } from "@/components/core";
    37â†’import { NavBar } from "./NavBar";
    38â†’import { MobileTabBar } from "./MobileTabBar";
    39â†’import { MobileHeader } from "./MobileHeader";
    40â†’import { ResizablePanel } from "./ResizablePanel";
    41â†’import { MobileConversationDrawer } from "@/components/chat/ConversationSidebar";
    42â†’
    43â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    44â†’// Types
    45â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    46â†’
    47â†’// V10: 5 entry points - Chat / Journey / Me / Relations / Discover
    48â†’export type TabType = "chat" | "journey" | "discover" | "me" | "relations";
    49â†’
    50â†’interface AppShellContextValue {
    51â†’  skill: SkillType;
    52â†’  activeTab: TabType;
    53â†’  setActiveTab: (tab: TabType) => void;
    54â†’  voiceMode: "warm" | "sarcastic" | "wise";
    55â†’  setVoiceMode: (mode: "warm" | "sarcastic" | "wise") => void;
    56â†’  // Conversation history management
    57â†’  activeConversationId: string | null;
    58â†’  setActiveConversationId: (id: string | null) => void;
    59â†’  isMobileDrawerOpen: boolean;
    60â†’  setMobileDrawerOpen: (open: boolean) => void;
    61â†’}
    62â†’
    63â†’const AppShellContext = createContext<AppShellContextValue | null>(null);
    64â†’
    65â†’export function useAppShell() {
    66â†’  const context = useContext(AppShellContext);
    67â†’  if (!context) {
    68â†’    throw new Error("useAppShell must be used within AppShell");
    69â†’  }
    70â†’  return context;
    71â†’}
    72â†’
    73â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    74â†’// AppShell Component
    75â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    76â†’
    77â†’interface AppShellProps {
    78â†’  skill: SkillType;
    79â†’  children: ReactNode;
    80â†’  /** Journey å†…å®¹ */
    81â†’  journeyContent?: ReactNode;
    82â†’  /** Discover å†…å®¹ - V9.1 æ–°å¢ */
    83â†’  discoverContent?: ReactNode;
    84â†’  /** Me é¡µé¢å†…å®¹ */
    85â†’  meContent?: ReactNode;
    86â†’  /** åˆå§‹æ¿€æ´»çš„ Tab - V9 é»˜è®¤ä¸º chat */
    87â†’  defaultTab?: TabType;
    88â†’}
    89â†’
    90â†’export function AppShell({
    91â†’  skill,
    92â†’  children,
    93â†’  journeyContent,
    94â†’  discoverContent,
    95â†’  meContent,
    96â†’  defaultTab = "chat",
    97â†’}: AppShellProps) {
    98â†’  const searchParams = useSearchParams();
    99â†’  const router = useRouter();
   100â†’
   101â†’  // ä» URL å‚æ•°è¯»å– tabï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ defaultTab
   102â†’  const urlTab = searchParams?.get("tab") as TabType | null;
   103â†’  const initialTab = (urlTab && ["chat", "journey", "discover", "me"].includes(urlTab))
   104â†’    ? urlTab
   105â†’    : defaultTab;
   106â†’
   107â†’  // ä» URL å‚æ•°è¯»å– conversation_id
   108â†’  const urlConversationId = searchParams?.get("conversation_id");
   109â†’
   110â†’  const [activeTab, setActiveTab] = useState<TabType>(initialTab);
   111â†’  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic" | "wise">("warm");
   112â†’  const [activeConversationId, setActiveConversationIdState] = useState<string | null>(
   113â†’    urlConversationId || null
   114â†’  );
   115â†’  const [isMobileDrawerOpen, setMobileDrawerOpen] = useState(false);
   116â†’
   117â†’  // ç›‘å¬ URL å‚æ•°å˜åŒ–ï¼ŒåŒæ­¥ activeTab
   118â†’  useEffect(() => {
   119â†’    if (urlTab && ["chat", "journey", "discover", "me"].includes(urlTab)) {
   120â†’      setActiveTab(urlTab);
   121â†’    }
   122â†’  }, [urlTab]);
   123â†’
   124â†’  // ç›‘å¬ URL å‚æ•°å˜åŒ–ï¼ŒåŒæ­¥ conversation_id
   125â†’  useEffect(() => {
   126â†’    setActiveConversationIdState(urlConversationId || null);
   127â†’  }, [urlConversationId]);
   128â†’
   129â†’  // è®¾ç½® conversation_id å¹¶æ›´æ–° URL
   130â†’  const setActiveConversationId = useCallback((id: string | null) => {
   131â†’    setActiveConversationIdState(id);
   132â†’    // Update URL without full page reload
   133â†’    const url = new URL(window.location.href);
   134â†’    if (id) {
   135â†’      url.searchParams.set("conversation_id", id);
   136â†’    } else {
   137â†’      url.searchParams.delete("conversation_id");
   138â†’    }
   139â†’    router.replace(url.pathname + url.search, { scroll: false });
   140â†’  }, [router]);
   141â†’
   142â†’  // Load voice_mode from backend on mount (only if authenticated)
   143â†’  // Vercel rule: bundle-defer-third-party - å»¶è¿ŸåŠ è½½éå…³é”®æ•°æ®
   144â†’  useEffect(() => {
   145â†’    // ä½¿ç”¨ requestIdleCallback å»¶è¿ŸåŠ è½½åå¥½è®¾ç½®ï¼Œä¸é˜»å¡é¦–å±æ¸²æŸ“
   146â†’    const loadPreferences = async () => {
   147â†’      try {
   148â†’        // Check if user is authenticated before making the request
   149â†’        const token = document.cookie.split(';').find(c => c.trim().startsWith('auth-token='));
   150â†’        if (!token) {
   151â†’          return; // Skip if not authenticated
   152â†’        }
   153â†’
   154â†’        const response = await apiClient.get<{ voice_mode: string; language: string }>("/preferences");
   155â†’        if (response.data?.voice_mode) {
   156â†’          setVoiceModeState(response.data.voice_mode as "warm" | "sarcastic" | "wise");
   157â†’        }
   158â†’      } catch (error) {
   159â†’        // Silently fail for 401 errors, log others
   160â†’        if (error && typeof error === 'object' && 'response' in error) {
   161â†’          const resp = error.response as { status?: number };
   162â†’          if (resp.status !== 401) {
   163â†’            console.error("Failed to load preferences:", error);
   164â†’          }
   165â†’        }
   166â†’      }
   167â†’    };
   168â†’
   169â†’    // ä½¿ç”¨ requestIdleCallback å»¶è¿Ÿæ‰§è¡Œï¼Œä¼˜å…ˆæ¸²æŸ“é¦–å±
   170â†’    if (typeof window !== 'undefined' && 'requestIdleCallback' in window) {
   171â†’      (window as any).requestIdleCallback(loadPreferences, { timeout: 2000 });
   172â†’    } else {
   173â†’      // Fallback: ä½¿ç”¨ setTimeout å»¶è¿Ÿ 100ms
   174â†’      setTimeout(loadPreferences, 100);
   175â†’    }
   176â†’  }, []);
   177â†’
   178â†’  // Save voice_mode to backend when changed
   179â†’  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic" | "wise") => {
   180â†’    setVoiceModeState(mode);
   181â†’    try {
   182â†’      await apiClient.put("/preferences", { voice_mode: mode });
   183â†’    } catch (error) {
   184â†’      console.error("Failed to save voice_mode:", error);
   185â†’    }
   186â†’  }, []);
   187â†’
   188â†’  // Handle new chat creation
   189â†’  const handleNewChat = useCallback(() => {
   190â†’    setActiveConversationId(null);
   191â†’  }, [setActiveConversationId]);
   192â†’
   193â†’  const contextValue: AppShellContextValue = {
   194â†’    skill,
   195â†’    activeTab,
   196â†’    setActiveTab,
   197â†’    voiceMode,
   198â†’    setVoiceMode,
   199â†’    activeConversationId,
   200â†’    setActiveConversationId,
   201â†’    isMobileDrawerOpen,
   202â†’    setMobileDrawerOpen,
   203â†’  };
   204â†’
   205â†’  return (
   206â†’    <AppShellContext.Provider value={contextValue}>
   207â†’      <div className="h-screen flex flex-col bg-background">
   208â†’        {/* Mobile Header - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
   209â†’        <div className="lg:hidden">
   210â†’          <MobileHeader skill={skill} />
   211â†’        </div>
   212â†’
   213â†’        {/* Main Content Area */}
   214â†’        <div className="flex-1 flex overflow-hidden">
   215â†’          {/* Left NavBar - ä»… PC ç«¯æ˜¾ç¤ºï¼ˆå«å¯¹è¯å†å²ï¼‰ */}
   216â†’          <div className="hidden lg:block">
   217â†’            <NavBar
   218â†’              skill={skill}
   219â†’              activeTab={activeTab}
   220â†’              onTabChange={setActiveTab}
   221â†’              activeConversationId={activeConversationId}
   222â†’              onSelectConversation={setActiveConversationId}
   223â†’              onNewChat={handleNewChat}
   224â†’            />
   225â†’          </div>
   226â†’
   227â†’          {/* Center - ä¸»å†…å®¹åŒºåŸŸ (å…¨å®½) */}
   228â†’          <main className="flex-1 min-h-0 flex flex-col">
   229â†’            {/* PCç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
   230â†’            <div className="hidden lg:flex lg:flex-col h-full min-h-0">
   231â†’              <PCContent
   232â†’                activeTab={activeTab}
   233â†’                chatContent={children}
   234â†’                journeyContent={journeyContent}
   235â†’                discoverContent={discoverContent}
   236â†’                meContent={meContent}
   237â†’              />
   238â†’            </div>
   239â†’
   240â†’            {/* ç§»åŠ¨ç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
   241â†’            <div className="lg:hidden h-full min-h-0 flex flex-col">
   242â†’              <MobileContent
   243â†’                activeTab={activeTab}
   244â†’                chatContent={children}
   245â†’                journeyContent={journeyContent}
   246â†’                discoverContent={discoverContent}
   247â†’                meContent={meContent}
   248â†’              />
   249â†’            </div>
   250â†’          </main>
   251â†’        </div>
   252â†’
   253â†’        {/* Mobile TabBar - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
   254â†’        <div className="lg:hidden">
   255â†’          <MobileTabBar activeTab={activeTab} onTabChange={setActiveTab} />
   256â†’        </div>
   257â†’
   258â†’        {/* Mobile Conversation Drawer */}
   259â†’        <MobileConversationDrawer
   260â†’          isOpen={isMobileDrawerOpen}
   261â†’          onClose={() => setMobileDrawerOpen(false)}
   262â†’          activeConversationId={activeConversationId}
   263â†’          onSelectConversation={setActiveConversationId}
   264â†’          onNewChat={handleNewChat}
   265â†’        />
   266â†’      </div>
   267â†’    </AppShellContext.Provider>
   268â†’  );
   269â†’}
   270â†’
   271â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   272â†’// PCContent - PCç«¯å†…å®¹åˆ‡æ¢
   273â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   274â†’
   275â†’interface ContentProps {
   276â†’  activeTab: TabType;
   277â†’  chatContent: ReactNode;
   278â†’  journeyContent?: ReactNode;
   279â†’  discoverContent?: ReactNode;
   280â†’  meContent?: ReactNode;
   281â†’}
   282â†’
   283â†’function PCContent({ activeTab, chatContent, journeyContent, discoverContent, meContent }: ContentProps) {
   284â†’  switch (activeTab) {
   285â†’    case "chat":
   286â†’      return <div className="h-full min-h-0 flex flex-col">{chatContent}</div>;
   287â†’    case "journey":
   288â†’      return (
   289â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   290â†’          {journeyContent || (
   291â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   292â†’              æˆ‘çš„æ—…ç¨‹
   293â†’            </div>
   294â†’          )}
   295â†’        </div>
   296â†’      );
   297â†’    case "discover":
   298â†’      return (
   299â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   300â†’          {discoverContent || (
   301â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   302â†’              æ¢ç´¢ Skills
   303â†’            </div>
   304â†’          )}
   305â†’        </div>
   306â†’      );
   307â†’    case "me":
   308â†’      return (
   309â†’        <div className="h-full overflow-y-auto">
   310â†’          {meContent || (
   311â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   312â†’              ä¸ªäººè®¾ç½®
   313â†’            </div>
   314â†’          )}
   315â†’        </div>
   316â†’      );
   317â†’    default:
   318â†’      return null;
   319â†’  }
   320â†’}
   321â†’
   322â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   323â†’// MobileContent - ç§»åŠ¨ç«¯å†…å®¹åˆ‡æ¢
   324â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   325â†’
   326â†’function MobileContent({ activeTab, chatContent, journeyContent, discoverContent, meContent }: ContentProps) {
   327â†’  switch (activeTab) {
   328â†’    case "chat":
   329â†’      return <div className="h-full min-h-0 flex flex-col">{chatContent}</div>;
   330â†’    case "journey":
   331â†’      return (
   332â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   333â†’          {journeyContent || (
   334â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   335â†’              æˆ‘çš„æ—…ç¨‹
   336â†’            </div>
   337â†’          )}
   338â†’        </div>
   339â†’      );
   340â†’    case "discover":
   341â†’      return (
   342â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   343â†’          {discoverContent || (
   344â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   345â†’              æ¢ç´¢ Skills
   346â†’            </div>
   347â†’          )}
   348â†’        </div>
   349â†’      );
   350â†’    case "me":
   351â†’      return (
   352â†’        <div className="h-full overflow-y-auto">
   353â†’          {meContent || (
   354â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   355â†’              ä¸ªäººè®¾ç½®
   356â†’            </div>
   357â†’          )}
   358â†’        </div>
   359â†’      );
   360â†’    default:
   361â†’      return null;
   362â†’  }
   363â†’}
   364â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
