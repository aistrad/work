     1â†’# VibeLife ç”¨æˆ·æ•°æ®æ²‰æ·€ä¸ Context æœºåˆ¶è®¾è®¡
     2â†’
     3â†’> åŸºäº MENTIS OSã€VIBE DIARYã€VibeLife Spec çš„æ·±åº¦ç ”ç©¶
     4â†’> æ ¸å¿ƒæ€æƒ³ï¼šè®© LLM åšè„æ´»ï¼Œæç®€è®¾è®¡
     5â†’
     6â†’---
     7â†’
     8â†’## 1. ç ”ç©¶èƒŒæ™¯
     9â†’
    10â†’### 1.1 æ–‡æ¡£æ¥æº
    11â†’
    12â†’- `MENTIS OS part1.md / part2.md` - åŸå§‹è®¾è®¡ç†å¿µ
    13â†’- `VIBE DIARY idea v1.md` - Vibe Diary æ¦‚å¿µ
    14â†’- `vibelife spec v2.0.md / v2.1.md` - å½“å‰äº§å“è§„èŒƒ
    15â†’
    16â†’### 1.2 æ ¸å¿ƒé—®é¢˜
    17â†’
    18â†’1. å¦‚ä½•æ²‰æ·€ç”¨æˆ·æ•°æ®ï¼Œè®© Vibe è¶Šæ¥è¶Š"æ‡‚"ç”¨æˆ·ï¼Ÿ
    19â†’2. å¦‚ä½•æ„å»ºæœ‰æ•ˆçš„ Contextï¼Œè®©æ¯æ¬¡å¯¹è¯éƒ½æœ‰è®°å¿†ï¼Ÿ
    20â†’3. å¦‚ä½•ç”¨æç®€çš„æ–¹å¼å®ç°ï¼Œè€Œéè¿‡åº¦å·¥ç¨‹åŒ–ï¼Ÿ
    21â†’
    22â†’---
    23â†’
    24â†’## 2. ä» Mentis åˆ° VibeLife çš„æ¼”è¿›
    25â†’
    26â†’### 2.1 MENTIS OS çš„å¤æ‚è®¾è®¡
    27â†’
    28â†’```
    29â†’ç”¨æˆ·è¾“å…¥ (Stream)
    30â†’    â”‚
    31â†’    â–¼
    32â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    33â†’â”‚                     å¤æ‚çš„æå–ç®¡é“                               â”‚
    34â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    35â†’â”‚ 1. æƒ…ç»ªè¯†åˆ« (8ç§ä¸»æƒ…ç»ª + 12ç§æ¬¡æƒ…ç»ª)                            â”‚
    36â†’â”‚ 2. è¡Œä¸ºåŒ¹é… (NLU â†’ Auto Checkin)                                â”‚
    37â†’â”‚ 3. èƒ½é‡è®¡ç®— (energy_score 0-100)                                â”‚
    38â†’â”‚ 4. åŠ¨é‡ç³»ç»Ÿ (momentum + streak)                                 â”‚
    39â†’â”‚ 5. è¿åŠ¿è®¡ç®— (å…«å­—æ—¥è¿ + ç´«å¾®æµæ—¥)                               â”‚
    40â†’â”‚ 6. Agent ä¸»åŠ¨å¹²é¢„ (4ç±»è§¦å‘å™¨)                                   â”‚
    41â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    42â†’    â”‚
    43â†’    â–¼
    44â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    45â†’â”‚               å¤§é‡ç»“æ„åŒ–å­˜å‚¨                                     â”‚
    46â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    47â†’â”‚ â€¢ emotion_history (æƒ…ç»ªå†å²)                                    â”‚
    48â†’â”‚ â€¢ behavior_checkins (è¡Œä¸ºæ‰“å¡)                                  â”‚
    49â†’â”‚ â€¢ momentum_log (åŠ¨é‡æ—¥å¿—)                                       â”‚
    50â†’â”‚ â€¢ energy_snapshots (èƒ½é‡å¿«ç…§)                                   â”‚
    51â†’â”‚ â€¢ fortune_cache (è¿åŠ¿ç¼“å­˜)                                      â”‚
    52â†’â”‚ â€¢ pattern_insights (æ¨¡å¼æ´å¯Ÿ)                                   â”‚
    53â†’â”‚ â€¢ ... åå‡ å¼ è¡¨                                                  â”‚
    54â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    55â†’```
    56â†’
    57â†’**é—®é¢˜**: è¿‡åº¦å·¥ç¨‹åŒ–ï¼Œç»´æŠ¤æˆæœ¬é«˜ï¼Œç”¨æˆ·ä»·å€¼ä¸æ˜æ˜¾
    58â†’
    59â†’### 2.2 VibeLife v2.1 çš„ç®€åŒ–æ–¹å‘
    60â†’
    61â†’```
    62â†’ç”¨æˆ·å¯¹è¯
    63â†’    â”‚
    64â†’    â–¼
    65â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    66â†’â”‚                  Vibe Engine (LLM é©±åŠ¨)                         â”‚
    67â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    68â†’â”‚ â€¢ æƒ…ç»ªæ„ŸçŸ¥ (è§„åˆ™ + LLM)                                         â”‚
    69â†’â”‚ â€¢ Skill è·¯ç”± (æ„å›¾è¯†åˆ«)                                         â”‚
    70â†’â”‚ â€¢ çŸ¥è¯†æ£€ç´¢ (RAG)                                                â”‚
    71â†’â”‚ â€¢ Insight ç”Ÿæˆ (4ç§ç±»å‹)                                        â”‚
    72â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    73â†’    â”‚
    74â†’    â–¼
    75â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    76â†’â”‚               æ ¸å¿ƒå­˜å‚¨ (å·²å®ç°)                                  â”‚
    77â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    78â†’â”‚ â€¢ vibe_users (ç”¨æˆ·åŸºç¡€ä¿¡æ¯)                                     â”‚
    79â†’â”‚ â€¢ skill_profiles (æŠ€èƒ½æ¡£æ¡ˆ)                                     â”‚
    80â†’â”‚ â€¢ skill_conversations (å¯¹è¯)                                    â”‚
    81â†’â”‚ â€¢ skill_messages (æ¶ˆæ¯)                                         â”‚
    82â†’â”‚ â€¢ skill_insights (æ´å¯Ÿ)                                         â”‚
    83â†’â”‚ â€¢ knowledge_chunks (çŸ¥è¯†åº“)                                     â”‚
    84â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    85â†’```
    86â†’
    87â†’**é—®é¢˜**: Insight Layer è§¦å‘è§„åˆ™è¿‡äºç®€å•ï¼Œç¼ºå°‘ç”¨æˆ·ç”»åƒç§¯ç´¯
    88â†’
    89â†’---
    90â†’
    91â†’## 3. æç®€è®¾è®¡æ–¹æ¡ˆï¼šè®© LLM åšè„æ´»
    92â†’
    93â†’### 3.1 è®¾è®¡åŸåˆ™
    94â†’
    95â†’```
    96â†’â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    97â†’â•‘                                                                               â•‘
    98â†’â•‘                        æç®€è®¾è®¡ä¸‰åŸåˆ™                                          â•‘
    99â†’â•‘                                                                               â•‘
   100â†’â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘
   101â†’â•‘                                                                               â•‘
   102â†’â•‘   1. å­˜å‚¨æ–‡æœ¬ï¼Œè€Œéç»“æ„                                                       â•‘
   103â†’â•‘      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â•‘
   104â†’â•‘      â€¢ ä¸è¦é¢„å®šä¹‰å¤æ‚çš„æ•°æ®ç»“æ„                                               â•‘
   105â†’â•‘      â€¢ å­˜å‚¨åŸå§‹å¯¹è¯ + LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€æ‘˜è¦                                  â•‘
   106â†’â•‘      â€¢ æŸ¥è¯¢æ—¶è®© LLM å®æ—¶ç†è§£å’Œæå–                                            â•‘
   107â†’â•‘                                                                               â•‘
   108â†’â•‘   2. Context = å¯¹è¯å†å² + ç”¨æˆ·ç”»åƒæ‘˜è¦ + ç›¸å…³çŸ¥è¯†                              â•‘
   109â†’â•‘      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â•‘
   110â†’â•‘      â€¢ å¯¹è¯å†å²: æœ€è¿‘ N æ¡æ¶ˆæ¯                                                â•‘
   111â†’â•‘      â€¢ ç”¨æˆ·ç”»åƒæ‘˜è¦: ä¸€æ®µ LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€æè¿°                              â•‘
   112â†’â•‘      â€¢ ç›¸å…³çŸ¥è¯†: RAG æ£€ç´¢çš„çŸ¥è¯†ç‰‡æ®µ                                           â•‘
   113â†’â•‘                                                                               â•‘
   114â†’â•‘   3. ç”¨ Agent åšå®šæœŸä»»åŠ¡ï¼Œè€Œéå®æ—¶è®¡ç®—                                        â•‘
   115â†’â•‘      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                    â•‘
   116â†’â•‘      â€¢ ä¸è¦åœ¨æ¯æ¡æ¶ˆæ¯ååšå¤æ‚è®¡ç®—                                             â•‘
   117â†’â•‘      â€¢ ç”¨åå° Agent å®šæœŸæ›´æ–°ç”¨æˆ·ç”»åƒ                                          â•‘
   118â†’â•‘      â€¢ ç”¨ Cron Job ç”Ÿæˆå‘¨æœŸæ€§æ´å¯Ÿ                                             â•‘
   119â†’â•‘                                                                               â•‘
   120â†’â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   121â†’```
   122â†’
   123â†’### 3.2 æ ¸å¿ƒåˆ›æ–°ï¼šUser Portrait (ç”¨æˆ·ç”»åƒæ‘˜è¦)
   124â†’
   125â†’**ä¼ ç»Ÿæ–¹å¼ (ä¸æ¨è)**:
   126â†’```sql
   127â†’-- å¤æ‚çš„ç»“æ„åŒ–å­˜å‚¨
   128â†’CREATE TABLE user_emotions (id, user_id, emotion, intensity, timestamp);
   129â†’CREATE TABLE user_topics (id, user_id, topic, frequency, last_mention);
   130â†’CREATE TABLE user_patterns (id, user_id, pattern_type, evidence, confidence);
   131â†’CREATE TABLE user_preferences (id, user_id, key, value);
   132â†’-- ... æ›´å¤šè¡¨
   133â†’```
   134â†’
   135â†’**æç®€æ–¹å¼ (æ¨è)**:
   136â†’```sql
   137â†’-- ä¸€å¼ è¡¨ï¼Œä¸€ä¸ªæ ¸å¿ƒå­—æ®µ
   138â†’CREATE TABLE user_portraits (
   139â†’    id UUID PRIMARY KEY,
   140â†’    user_id UUID REFERENCES vibe_users(id),
   141â†’    skill_id VARCHAR(50),
   142â†’
   143â†’    -- æ ¸å¿ƒ: LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€ç”»åƒ
   144â†’    portrait_text TEXT NOT NULL,
   145â†’
   146â†’    -- å…ƒæ•°æ®
   147â†’    generated_at TIMESTAMPTZ DEFAULT NOW(),
   148â†’    based_on_messages INT,  -- åŸºäºå¤šå°‘æ¡æ¶ˆæ¯ç”Ÿæˆ
   149â†’    version INT DEFAULT 1,
   150â†’
   151â†’    UNIQUE(user_id, skill_id)
   152â†’);
   153â†’```
   154â†’
   155â†’### 3.3 portrait_text ç¤ºä¾‹
   156â†’
   157â†’```
   158â†’å…³äºè¿™ä½ç”¨æˆ·ï¼Œæˆ‘äº†è§£åˆ°ï¼š
   159â†’
   160â†’ã€åŸºæœ¬ç‰¹å¾ã€‘
   161â†’- 1990å¹´3æœˆ15æ—¥å‡ºç”Ÿï¼Œç”²æœ¨æ—¥ä¸»ï¼Œåå°æ ¼
   162â†’- æ€§æ ¼ç‰¹ç‚¹ï¼šæ€è€ƒå‹ï¼Œè¿½æ±‚å®Œç¾ï¼Œæœ‰æ—¶è¿‡åº¦åˆ†æ
   163â†’- æ²Ÿé€šé£æ ¼ï¼šå–œæ¬¢æ·±åº¦äº¤æµï¼Œä¸å–œæ¬¢æ³›æ³›è€Œè°ˆ
   164â†’
   165â†’ã€è¿‘æœŸçŠ¶æ€ã€‘
   166â†’- æœ€è¿‘ä¸¤å‘¨ä¸»è¦è¯é¢˜ï¼šå·¥ä½œå‹åŠ›ã€èŒä¸šæ–¹å‘è¿·èŒ«
   167â†’- æƒ…ç»ªåŸºè°ƒï¼šç•¥æ˜¾ç„¦è™‘ï¼Œä½†åœ¨ç§¯æå¯»æ±‚æ”¹å˜
   168â†’- æåˆ°3æ¬¡"å·®ä¸€ç‚¹ç‚¹"ï¼Œå¯èƒ½ä¸åå°è¿æœ‰å…³
   169â†’
   170â†’ã€é‡è¦æ´å¯Ÿã€‘
   171â†’- å†³ç­–æ¨¡å¼ï¼šå®¹æ˜“çŠ¹è±«ï¼Œå€¾å‘äºè¿‡åº¦å‡†å¤‡
   172â†’- å‘ç°äº†ä¸€ä¸ªè§„å¾‹ï¼šå‘¨æœ«æƒ…ç»ªæ™®éæ¯”å·¥ä½œæ—¥å¥½
   173â†’- ä¸Šæ¬¡èŠåˆ°å®¶åº­æ—¶ï¼Œè¯­æ°”æ˜æ˜¾å˜æŸ”å’Œ
   174â†’
   175â†’ã€äº’åŠ¨åå¥½ã€‘
   176â†’- å–œæ¬¢æˆ‘ç»™å‡ºå…·ä½“çš„è¡ŒåŠ¨å»ºè®®
   177â†’- ä¸å–œæ¬¢è¿‡äºç¬¼ç»Ÿçš„å®‰æ…°
   178â†’- å¯¹å‘½ç†è§£é‡Šæ¥å—åº¦é«˜ï¼Œä½†ä¸æƒ³å¬"ç®—å‘½"
   179â†’
   180â†’ã€å½“å‰å…³æ³¨ã€‘
   181â†’- æ­£åœ¨è€ƒè™‘è·³æ§½ï¼Œä½†æ‹…å¿ƒæ—¶æœºä¸å¯¹
   182â†’- æåˆ°è¿‡æƒ³å­¦ä¹ å†¥æƒ³ï¼Œè¿˜æ²¡å¼€å§‹
   183â†’```
   184â†’
   185â†’---
   186â†’
   187â†’## 4. æ•°æ®æµè®¾è®¡
   188â†’
   189â†’### 4.1 å®æ—¶æµç¨‹ (æ¯æ¡æ¶ˆæ¯)
   190â†’
   191â†’```
   192â†’ç”¨æˆ·æ¶ˆæ¯
   193â†’    â”‚
   194â†’    â–¼
   195â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   196â†’â”‚  Context Assembly (å®æ—¶)                                            â”‚
   197â†’â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   198â†’â”‚  1. è¯»å– user_portraits.portrait_text (1æ¬¡æ•°æ®åº“æŸ¥è¯¢)               â”‚
   199â†’â”‚  2. è¯»å–æœ€è¿‘ 6 æ¡ skill_messages (1æ¬¡æ•°æ®åº“æŸ¥è¯¢)                    â”‚
   200â†’â”‚  3. RAG æ£€ç´¢ç›¸å…³çŸ¥è¯† (1æ¬¡å‘é‡æŸ¥è¯¢)                                  â”‚
   201â†’â”‚                                                                     â”‚
   202â†’â”‚  æ€»å…±: 3 æ¬¡æŸ¥è¯¢ï¼Œæ¯«ç§’çº§                                             â”‚
   203â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   204â†’    â”‚
   205â†’    â–¼
   206â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   207â†’â”‚  LLM System Prompt æ„å»º                                             â”‚
   208â†’â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   209â†’â”‚                                                                     â”‚
   210â†’â”‚  ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªæ¸©æš–çš„å‘½ç†åˆ†æå¸ˆ...                                 â”‚
   211â†’â”‚                                                                     â”‚
   212â†’â”‚  ## å…³äºè¿™ä½ç”¨æˆ·                                                    â”‚
   213â†’â”‚  {portrait_text}                                                    â”‚
   214â†’â”‚                                                                     â”‚
   215â†’â”‚  ## ç›¸å…³çŸ¥è¯†                                                        â”‚
   216â†’â”‚  {rag_context}                                                      â”‚
   217â†’â”‚                                                                     â”‚
   218â†’â”‚  ## æœ€è¿‘å¯¹è¯                                                        â”‚
   219â†’â”‚  {recent_messages}                                                  â”‚
   220â†’â”‚                                                                     â”‚
   221â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   222â†’    â”‚
   223â†’    â–¼
   224â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   225â†’â”‚  LLM ç”Ÿæˆå“åº”                                                       â”‚
   226â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   227â†’    â”‚
   228â†’    â–¼
   229â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   230â†’â”‚  ä¿å­˜æ¶ˆæ¯ (å®æ—¶)                                                    â”‚
   231â†’â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
   232â†’â”‚  â€¢ ä¿å­˜ç”¨æˆ·æ¶ˆæ¯åˆ° skill_messages                                    â”‚
   233â†’â”‚  â€¢ ä¿å­˜åŠ©æ‰‹å“åº”åˆ° skill_messages                                    â”‚
   234â†’â”‚  â€¢ ä¸åšå…¶ä»–ä»»ä½•è®¡ç®—                                                 â”‚
   235â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   236â†’```
   237â†’
   238â†’### 4.2 åå°æµç¨‹ (å®šæœŸæ‰§è¡Œ)
   239â†’
   240â†’```
   241â†’Portrait Agent (æ¯å¤©/æ¯10æ¡æ¶ˆæ¯è§¦å‘)
   242â†’    â”‚
   243â†’    â–¼
   244â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   245â†’â”‚  1. è¯»å–ç”¨æˆ·æœ€è¿‘ 50 æ¡æ¶ˆæ¯                                          â”‚
   246â†’â”‚  2. è¯»å–å½“å‰ portrait_text (å¦‚æœå­˜åœ¨)                               â”‚
   247â†’â”‚  3. è®© LLM ç”Ÿæˆ/æ›´æ–°ç”¨æˆ·ç”»åƒ                                        â”‚
   248â†’â”‚  4. ä¿å­˜æ–°çš„ portrait_text                                          â”‚
   249â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   250â†’
   251â†’Insight Agent (å¯¹è¯ç»“æŸåè§¦å‘)
   252â†’    â”‚
   253â†’    â–¼
   254â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   255â†’â”‚  1. è¯»å–ç”¨æˆ·ç”»åƒ + æœ¬æ¬¡å¯¹è¯å†…å®¹                                     â”‚
   256â†’â”‚  2. è®© LLM åˆ¤æ–­æ˜¯å¦å€¼å¾—ç”Ÿæˆæ´å¯Ÿ                                     â”‚
   257â†’â”‚  3. å¦‚æœå€¼å¾—ï¼Œç”Ÿæˆæ´å¯Ÿå¹¶ä¿å­˜åˆ° skill_insights                       â”‚
   258â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   259â†’```
   260â†’
   261â†’---
   262â†’
   263â†’## 5. æç¤ºè¯è®¾è®¡
   264â†’
   265â†’### 5.1 Portrait Agent æç¤ºè¯
   266â†’
   267â†’```python
   268â†’PORTRAIT_UPDATE_PROMPT = """
   269â†’ä½ æ˜¯ä¸€ä¸ªç”¨æˆ·ç”»åƒåˆ†æä¸“å®¶ã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºè¿™ä½ç”¨æˆ·ç”Ÿæˆæˆ–æ›´æ–°ç”»åƒæ‘˜è¦ã€‚
   270â†’
   271â†’## å½“å‰ç”»åƒ (å¦‚æœå­˜åœ¨)
   272â†’{current_portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰ç”»åƒ"}
   273â†’
   274â†’## ç”¨æˆ·åŸºç¡€ä¿¡æ¯
   275â†’- å‡ºç”Ÿæ—¥æœŸ: {birth_datetime}
   276â†’- å…«å­—: {bazi_chart}
   277â†’- ä½¿ç”¨æŠ€èƒ½: {skill_id}
   278â†’
   279â†’## æœ€è¿‘ {message_count} æ¡å¯¹è¯
   280â†’{recent_messages}
   281â†’
   282â†’## ä»»åŠ¡
   283â†’è¯·ç”Ÿæˆä¸€ä»½è‡ªç„¶è¯­è¨€çš„ç”¨æˆ·ç”»åƒï¼ŒåŒ…æ‹¬:
   284â†’
   285â†’1. ã€åŸºæœ¬ç‰¹å¾ã€‘- æ€§æ ¼ç‰¹ç‚¹ã€æ²Ÿé€šé£æ ¼
   286â†’2. ã€è¿‘æœŸçŠ¶æ€ã€‘- æœ€è¿‘çš„ä¸»è¦è¯é¢˜ã€æƒ…ç»ªåŸºè°ƒ
   287â†’3. ã€é‡è¦æ´å¯Ÿã€‘- å‘ç°çš„æ¨¡å¼ã€è§„å¾‹
   288â†’4. ã€äº’åŠ¨åå¥½ã€‘- å–œæ¬¢ä»€ä¹ˆæ ·çš„å›åº”æ–¹å¼
   289â†’5. ã€å½“å‰å…³æ³¨ã€‘- æ­£åœ¨æ€è€ƒæˆ–å¤„ç†çš„äº‹æƒ…
   290â†’
   291â†’è¦æ±‚:
   292â†’- ç”¨ç¬¬ä¸‰äººç§°æè¿°
   293â†’- å…·ä½“è€Œéç¬¼ç»Ÿ
   294â†’- å¦‚æœæ˜¯æ›´æ–°ï¼Œä¿ç•™é‡è¦çš„å†å²ä¿¡æ¯ï¼Œæ›´æ–°è¿‡æ—¶çš„ä¿¡æ¯
   295â†’- æ§åˆ¶åœ¨ 500 å­—ä»¥å†…
   296â†’- åªè¾“å‡ºç”»åƒå†…å®¹ï¼Œä¸è¦å…¶ä»–è§£é‡Š
   297â†’"""
   298â†’```
   299â†’
   300â†’### 5.2 Insight åˆ¤æ–­æç¤ºè¯
   301â†’
   302â†’```python
   303â†’INSIGHT_CHECK_PROMPT = """
   304â†’ä½ æ˜¯ä¸€ä¸ªæ´å¯Ÿåˆ¤æ–­ä¸“å®¶ã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œåˆ¤æ–­æ˜¯å¦åº”è¯¥ç”Ÿæˆæ´å¯Ÿã€‚
   305â†’
   306â†’## ç”¨æˆ·ç”»åƒ
   307â†’{portrait_text}
   308â†’
   309â†’## æœ¬æ¬¡å¯¹è¯
   310â†’{conversation}
   311â†’
   312â†’## æœ€è¿‘ç”Ÿæˆçš„æ´å¯Ÿ (é¿å…é‡å¤)
   313â†’{recent_insights}
   314â†’
   315â†’## ä»»åŠ¡
   316â†’åˆ¤æ–­æœ¬æ¬¡å¯¹è¯æ˜¯å¦åŒ…å«å€¼å¾—è®°å½•çš„æ´å¯Ÿã€‚
   317â†’
   318â†’æ´å¯Ÿç±»å‹:
   319â†’1. DISCOVERY - é¦–æ¬¡å‘ç°ç”¨æˆ·çš„æ–°ç‰¹å¾æˆ–æ¨¡å¼
   320â†’2. PATTERN - å‘ç°é‡å¤å‡ºç°çš„è§„å¾‹ (éœ€è¦è‡³å°‘å‡ºç°3æ¬¡)
   321â†’3. GROWTH - å‘ç°ç”¨æˆ·çš„ç§¯æå˜åŒ–æˆ–çªç ´
   322â†’4. TIMING - å‘ç°ä¸å½“å‰è¿åŠ¿ç›¸å…³çš„æ—¶æœºå»ºè®®
   323â†’
   324â†’è¯·è¿”å› JSON:
   325â†’{
   326â†’  "should_generate": true/false,
   327â†’  "reason": "ä¸ºä»€ä¹ˆå€¼å¾—/ä¸å€¼å¾—ç”Ÿæˆ",
   328â†’  "insight_type": "DISCOVERY/PATTERN/GROWTH/TIMING/null",
   329â†’  "insight_title": "æ´å¯Ÿæ ‡é¢˜ (å¦‚æœç”Ÿæˆ)",
   330â†’  "insight_content": "æ´å¯Ÿå†…å®¹ (å¦‚æœç”Ÿæˆ)"
   331â†’}
   332â†’
   333â†’æ³¨æ„:
   334â†’- ä¸è¦ä¸ºäº†ç”Ÿæˆè€Œç”Ÿæˆï¼Œåªæœ‰çœŸæ­£æœ‰ä»·å€¼çš„æ‰ç”Ÿæˆ
   335â†’- é¿å…ä¸æœ€è¿‘çš„æ´å¯Ÿé‡å¤
   336â†’- æ´å¯Ÿåº”è¯¥å…·ä½“ã€å¯è¡ŒåŠ¨
   337â†’"""
   338â†’```
   339â†’
   340â†’---
   341â†’
   342â†’## 6. æ•°æ®åº“ Schema
   343â†’
   344â†’### 6.1 ç”¨æˆ·ç”»åƒè¡¨
   345â†’
   346â†’```sql
   347â†’-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   348â†’-- æç®€ç‰ˆ User Insight æ²‰æ·€ Schema
   349â†’-- æ ¸å¿ƒç†å¿µ: å­˜å‚¨æ–‡æœ¬ï¼Œè®© LLM åšç†è§£
   350â†’-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   351â†’
   352â†’-- ç”¨æˆ·ç”»åƒè¡¨ (æ ¸å¿ƒ)
   353â†’CREATE TABLE user_portraits (
   354â†’    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   355â†’    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
   356â†’    skill_id VARCHAR(50) NOT NULL,
   357â†’
   358â†’    -- æ ¸å¿ƒ: LLM ç”Ÿæˆçš„è‡ªç„¶è¯­è¨€ç”»åƒ
   359â†’    portrait_text TEXT NOT NULL,
   360â†’
   361â†’    -- å…ƒæ•°æ®
   362â†’    based_on_messages INT DEFAULT 0,  -- åŸºäºå¤šå°‘æ¡æ¶ˆæ¯ç”Ÿæˆ
   363â†’    last_message_id UUID,             -- æœ€åå¤„ç†çš„æ¶ˆæ¯ID
   364â†’    generated_at TIMESTAMPTZ DEFAULT NOW(),
   365â†’    version INT DEFAULT 1,
   366â†’
   367â†’    UNIQUE(user_id, skill_id)
   368â†’);
   369â†’
   370â†’-- ç”»åƒå†å²è¡¨ (å¯é€‰ï¼Œç”¨äºè¿½è¸ªæ¼”å˜)
   371â†’CREATE TABLE user_portrait_history (
   372â†’    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
   373â†’    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
   374â†’    skill_id VARCHAR(50) NOT NULL,
   375â†’    portrait_text TEXT NOT NULL,
   376â†’    version INT NOT NULL,
   377â†’    created_at TIMESTAMPTZ DEFAULT NOW()
   378â†’);
   379â†’
   380â†’-- ç´¢å¼•
   381â†’CREATE INDEX idx_portraits_user_skill ON user_portraits(user_id, skill_id);
   382â†’CREATE INDEX idx_portrait_history_user ON user_portrait_history(user_id, created_at DESC);
   383â†’```
   384â†’
   385â†’---
   386â†’
   387â†’## 7. å®ç°ä»£ç 
   388â†’
   389â†’### 7.1 PortraitService
   390â†’
   391â†’```python
   392â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   393â†’# portrait_service.py - ç”¨æˆ·ç”»åƒæœåŠ¡
   394â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   395â†’
   396â†’from typing import Optional
   397â†’from uuid import UUID
   398â†’
   399â†’class PortraitService:
   400â†’    """
   401â†’    æç®€ç”¨æˆ·ç”»åƒæœåŠ¡
   402â†’    æ ¸å¿ƒæ€æƒ³: è®© LLM åšç†è§£å’Œæå–ï¼Œæˆ‘ä»¬åªè´Ÿè´£å­˜å‚¨å’Œè°ƒåº¦
   403â†’    """
   404â†’
   405â†’    # è§¦å‘æ¡ä»¶
   406â†’    UPDATE_INTERVAL_MESSAGES = 10  # æ¯ 10 æ¡æ¶ˆæ¯æ›´æ–°ä¸€æ¬¡
   407â†’
   408â†’    @staticmethod
   409â†’    async def get_portrait(user_id: UUID, skill_id: str) -> Optional[str]:
   410â†’        """è·å–ç”¨æˆ·ç”»åƒæ–‡æœ¬"""
   411â†’        async with get_connection() as conn:
   412â†’            row = await conn.fetchrow(
   413â†’                """
   414â†’                SELECT portrait_text FROM user_portraits
   415â†’                WHERE user_id = $1 AND skill_id = $2
   416â†’                """,
   417â†’                user_id, skill_id
   418â†’            )
   419â†’            return row["portrait_text"] if row else None
   420â†’
   421â†’    @staticmethod
   422â†’    async def should_update(user_id: UUID, skill_id: str) -> bool:
   423â†’        """æ£€æŸ¥æ˜¯å¦åº”è¯¥æ›´æ–°ç”»åƒ"""
   424â†’        async with get_connection() as conn:
   425â†’            portrait = await conn.fetchrow(
   426â†’                """
   427â†’                SELECT based_on_messages, last_message_id
   428â†’                FROM user_portraits
   429â†’                WHERE user_id = $1 AND skill_id = $2
   430â†’                """,
   431â†’                user_id, skill_id
   432â†’            )
   433â†’
   434â†’            # æ–°ç”¨æˆ·ï¼Œéœ€è¦ç”Ÿæˆ
   435â†’            if not portrait:
   436â†’                return True
   437â†’
   438â†’            # è®¡ç®—æ–°æ¶ˆæ¯æ•°é‡
   439â†’            new_messages = await conn.fetchval(
   440â†’                """
   441â†’                SELECT COUNT(*) FROM skill_messages sm
   442â†’                JOIN skill_conversations sc ON sm.conversation_id = sc.id
   443â†’                WHERE sc.user_id = $1 AND sc.skill_id = $2
   444â†’                  AND (sm.id > $3 OR $3 IS NULL)
   445â†’                """,
   446â†’                user_id, skill_id, portrait["last_message_id"]
   447â†’            )
   448â†’
   449â†’            return new_messages >= PortraitService.UPDATE_INTERVAL_MESSAGES
   450â†’
   451â†’    @staticmethod
   452â†’    async def update_portrait(
   453â†’        user_id: UUID,
   454â†’        skill_id: str,
   455â†’        llm_orchestrator
   456â†’    ) -> str:
   457â†’        """æ›´æ–°ç”¨æˆ·ç”»åƒ (åå°ä»»åŠ¡)"""
   458â†’
   459â†’        # 1. è·å–å½“å‰ç”»åƒ
   460â†’        current_portrait = await PortraitService.get_portrait(user_id, skill_id)
   461â†’
   462â†’        # 2. è·å–ç”¨æˆ·åŸºç¡€ä¿¡æ¯
   463â†’        async with get_connection() as conn:
   464â†’            user = await conn.fetchrow(
   465â†’                "SELECT * FROM vibe_users WHERE id = $1", user_id
   466â†’            )
   467â†’            profile = await conn.fetchrow(
   468â†’                """SELECT profile_data FROM skill_profiles
   469â†’                   WHERE user_id = $1 AND skill_id = $2""",
   470â†’                user_id, skill_id
   471â†’            )
   472â†’
   473â†’        # 3. è·å–æœ€è¿‘æ¶ˆæ¯
   474â†’        messages = await SkillRepository.get_recent_messages(
   475â†’            user_id, skill_id, limit=50
   476â†’        )
   477â†’
   478â†’        # 4. æ„å»ºæç¤ºè¯
   479â†’        prompt = PORTRAIT_UPDATE_PROMPT.format(
   480â†’            current_portrait=current_portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰ç”»åƒ",
   481â†’            birth_datetime=user["birth_datetime"],
   482â†’            bazi_chart=profile["profile_data"].get("bazi", {}) if profile else {},
   483â†’            skill_id=skill_id,
   484â†’            message_count=len(messages),
   485â†’            recent_messages=format_messages(messages)
   486â†’        )
   487â†’
   488â†’        # 5. è°ƒç”¨ LLM
   489â†’        response = await llm_orchestrator.chat(
   490â†’            [LLMMessage(role="user", content=prompt)],
   491â†’            temperature=0.3,
   492â†’            max_tokens=1000
   493â†’        )
   494â†’
   495â†’        new_portrait = response.content
   496â†’
   497â†’        # 6. ä¿å­˜ç”»åƒ
   498â†’        last_msg_id = messages[0]["id"] if messages else None
   499â†’
   500â†’        async with get_connection() as conn:
   501â†’            # ä¿å­˜å†å²
   502â†’            if current_portrait:
   503â†’                await conn.execute(
   504â†’                    """
   505â†’                    INSERT INTO user_portrait_history (user_id, skill_id, portrait_text, version)
   506â†’                    SELECT user_id, skill_id, portrait_text, version
   507â†’                    FROM user_portraits WHERE user_id = $1 AND skill_id = $2
   508â†’                    """,
   509â†’                    user_id, skill_id
   510â†’                )
   511â†’
   512â†’            # æ›´æ–°/æ’å…¥æ–°ç”»åƒ
   513â†’            await conn.execute(
   514â†’                """
   515â†’                INSERT INTO user_portraits (user_id, skill_id, portrait_text, based_on_messages, last_message_id, version)
   516â†’                VALUES ($1, $2, $3, $4, $5, 1)
   517â†’                ON CONFLICT (user_id, skill_id)
   518â†’                DO UPDATE SET
   519â†’                    portrait_text = $3,
   520â†’                    based_on_messages = user_portraits.based_on_messages + $4,
   521â†’                    last_message_id = $5,
   522â†’                    version = user_portraits.version + 1,
   523â†’                    generated_at = NOW()
   524â†’                """,
   525â†’                user_id, skill_id, new_portrait, len(messages), last_msg_id
   526â†’            )
   527â†’
   528â†’        return new_portrait
   529â†’```
   530â†’
   531â†’### 7.2 InsightService (ç®€åŒ–ç‰ˆ)
   532â†’
   533â†’```python
   534â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   535â†’# insight_service.py - æ´å¯ŸæœåŠ¡ (ç®€åŒ–ç‰ˆ)
   536â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   537â†’
   538â†’import json
   539â†’from typing import Optional
   540â†’from uuid import UUID
   541â†’
   542â†’class InsightService:
   543â†’    """
   544â†’    æç®€æ´å¯ŸæœåŠ¡
   545â†’    æ ¸å¿ƒæ€æƒ³: è®© LLM åˆ¤æ–­æ˜¯å¦å€¼å¾—ç”Ÿæˆæ´å¯Ÿï¼Œè€Œéå¤æ‚çš„è§„åˆ™å¼•æ“
   546â†’    """
   547â†’
   548â†’    @staticmethod
   549â†’    async def maybe_generate_insight(
   550â†’        user_id: UUID,
   551â†’        skill_id: str,
   552â†’        conversation_id: UUID,
   553â†’        llm_orchestrator
   554â†’    ) -> Optional[dict]:
   555â†’        """åœ¨å¯¹è¯ç»“æŸåè°ƒç”¨ï¼Œåˆ¤æ–­æ˜¯å¦ç”Ÿæˆæ´å¯Ÿ"""
   556â†’
   557â†’        # 1. è·å–ç”¨æˆ·ç”»åƒ
   558â†’        portrait = await PortraitService.get_portrait(user_id, skill_id)
   559â†’        if not portrait:
   560â†’            return None
   561â†’
   562â†’        # 2. è·å–æœ¬æ¬¡å¯¹è¯
   563â†’        conversation = await SkillRepository.get_messages(
   564â†’            conversation_id, limit=20
   565â†’        )
   566â†’
   567â†’        # 3. è·å–æœ€è¿‘æ´å¯Ÿ (é¿å…é‡å¤)
   568â†’        recent_insights = await SkillRepository.get_user_insights(
   569â†’            user_id, skill_id, limit=5
   570â†’        )
   571â†’
   572â†’        # 4. è®© LLM åˆ¤æ–­
   573â†’        prompt = INSIGHT_CHECK_PROMPT.format(
   574â†’            portrait_text=portrait,
   575â†’            conversation=format_messages(conversation),
   576â†’            recent_insights=format_insights(recent_insights)
   577â†’        )
   578â†’
   579â†’        response = await llm_orchestrator.chat(
   580â†’            [LLMMessage(role="user", content=prompt)],
   581â†’            temperature=0.3,
   582â†’            max_tokens=500
   583â†’        )
   584â†’
   585â†’        try:
   586â†’            result = json.loads(response.content)
   587â†’        except:
   588â†’            return None
   589â†’
   590â†’        # 5. å¦‚æœåˆ¤æ–­åº”è¯¥ç”Ÿæˆï¼Œä¿å­˜æ´å¯Ÿ
   591â†’        if result.get("should_generate"):
   592â†’            insight = await SkillRepository.create_insight(
   593â†’                user_id=user_id,
   594â†’                skill_id=skill_id,
   595â†’                insight_type=result["insight_type"].lower(),
   596â†’                title=result["insight_title"],
   597â†’                content=result["insight_content"],
   598â†’                confidence=0.8,
   599â†’                conversation_id=conversation_id
   600â†’            )
   601â†’            return insight
   602â†’
   603â†’        return None
   604â†’```
   605â†’
   606â†’### 7.3 AgentRuntime é›†æˆ
   607â†’
   608â†’```python
   609â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   610â†’# runtime.py ä¿®æ”¹
   611â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   612â†’
   613â†’import asyncio
   614â†’from typing import Optional
   615â†’from uuid import UUID
   616â†’
   617â†’class AgentRuntime:
   618â†’
   619â†’    @classmethod
   620â†’    async def process_message(
   621â†’        cls,
   622â†’        user_id: UUID,
   623â†’        skill_id: str,
   624â†’        message: str,
   625â†’        conversation_id: Optional[UUID] = None
   626â†’    ) -> AgentResponse:
   627â†’        """æç®€æ¶ˆæ¯å¤„ç†æµç¨‹"""
   628â†’
   629â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   630â†’        # 1. Context Assembly (3æ¬¡æŸ¥è¯¢)
   631â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   632â†’
   633â†’        # 1.1 è·å–ç”¨æˆ·ç”»åƒ (1æ¬¡æŸ¥è¯¢)
   634â†’        portrait = await PortraitService.get_portrait(user_id, skill_id)
   635â†’
   636â†’        # 1.2 è·å–å¯¹è¯å†å² (1æ¬¡æŸ¥è¯¢)
   637â†’        history = await SkillRepository.get_messages(conversation_id, limit=6)
   638â†’
   639â†’        # 1.3 çŸ¥è¯†æ£€ç´¢ (1æ¬¡å‘é‡æŸ¥è¯¢)
   640â†’        knowledge = await RetrievalService.get_context_for_query(message, skill_id)
   641â†’
   642â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   643â†’        # 2. æ„å»º System Prompt
   644â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   645â†’
   646â†’        system_prompt = f"""
   647â†’ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªæ¸©æš–çš„å‘½ç†åˆ†æå¸ˆ...
   648â†’
   649â†’## å…³äºè¿™ä½ç”¨æˆ·
   650â†’{portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰è¶³å¤Ÿçš„äº†è§£"}
   651â†’
   652â†’## ç›¸å…³çŸ¥è¯†
   653â†’{knowledge}
   654â†’"""
   655â†’
   656â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   657â†’        # 3. LLM ç”Ÿæˆ
   658â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   659â†’
   660â†’        messages = build_messages(system_prompt, history, message)
   661â†’        response = await LLMOrchestrator.chat(messages)
   662â†’
   663â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   664â†’        # 4. ä¿å­˜æ¶ˆæ¯ (åŒæ­¥ï¼Œå¿…é¡»)
   665â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   666â†’
   667â†’        await SkillRepository.add_message(conversation_id, "user", message)
   668â†’        await SkillRepository.add_message(conversation_id, "assistant", response.content)
   669â†’
   670â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   671â†’        # 5. åå°ä»»åŠ¡ (å¼‚æ­¥ï¼Œä¸é˜»å¡)
   672â†’        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   673â†’
   674â†’        # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ç”»åƒ
   675â†’        asyncio.create_task(
   676â†’            cls._maybe_update_portrait(user_id, skill_id)
   677â†’        )
   678â†’
   679â†’        return AgentResponse(content=response.content, ...)
   680â†’
   681â†’    @staticmethod
   682â†’    async def _maybe_update_portrait(user_id: UUID, skill_id: str):
   683â†’        """åå°æ£€æŸ¥å¹¶æ›´æ–°ç”»åƒ"""
   684â†’        try:
   685â†’            if await PortraitService.should_update(user_id, skill_id):
   686â†’                await PortraitService.update_portrait(
   687â†’                    user_id, skill_id, LLMOrchestrator
   688â†’                )
   689â†’        except Exception as e:
   690â†’            print(f"Portrait update failed: {e}")
   691â†’
   692â†’    @classmethod
   693â†’    async def on_conversation_end(
   694â†’        cls,
   695â†’        user_id: UUID,
   696â†’        skill_id: str,
   697â†’        conversation_id: UUID
   698â†’    ):
   699â†’        """å¯¹è¯ç»“æŸæ—¶è°ƒç”¨"""
   700â†’
   701â†’        # å°è¯•ç”Ÿæˆæ´å¯Ÿ
   702â†’        await InsightService.maybe_generate_insight(
   703â†’            user_id, skill_id, conversation_id, LLMOrchestrator
   704â†’        )
   705â†’```
   706â†’
   707â†’---
   708â†’
   709â†’## 8. æ–¹æ¡ˆå¯¹æ¯”
   710â†’
   711â†’### 8.1 å¤æ‚æ–¹æ¡ˆ vs æç®€æ–¹æ¡ˆ
   712â†’
   713â†’| ç»´åº¦ | å¤æ‚æ–¹æ¡ˆ | æç®€æ–¹æ¡ˆ |
   714â†’|------|---------|---------|
   715â†’| **æ•°æ®åº“è¡¨** | 5+ å¼  (topic_mentions, emotion_history, topic_dictionary...) | **1 å¼ ** (user_portraits) |
   716â†’| **æ–°æ¨¡å—** | 4 ä¸ª (~500è¡Œä»£ç ) | **2 ä¸ª** (~150è¡Œä»£ç ) |
   717â†’| **å®æ—¶è®¡ç®—** | è¯é¢˜æå–ã€æƒ…ç»ªåˆ†æã€é¦–æ¬¡æåŠã€æ¨¡å¼åŒ¹é… | **æ— ** |
   718â†’| **åå°ä»»åŠ¡** | å¤æ‚çš„æ¨¡å¼æ£€æµ‹ | ç®€å•çš„ LLM è°ƒç”¨ |
   719â†’| **è§¦å‘è§„åˆ™** | ç¡¬ç¼–ç çš„è§„åˆ™å¼•æ“ | LLM åˆ¤æ–­ (æç¤ºè¯å³è§„åˆ™) |
   720â†’| **å·¥ä½œé‡** | 5-7 å¤© | **1-2 å¤©** |
   721â†’| **ç»´æŠ¤æˆæœ¬** | é«˜ (ä»£ç  + è§„åˆ™) | **ä½** (åªéœ€è°ƒæç¤ºè¯) |
   722â†’
   723â†’### 8.2 æˆæœ¬åˆ†æ
   724â†’
   725â†’**LLM æˆæœ¬:**
   726â†’- ç”»åƒæ›´æ–°: æ¯ 10 æ¡æ¶ˆæ¯è°ƒç”¨ 1 æ¬¡ LLM (~$0.01)
   727â†’- æ´å¯Ÿåˆ¤æ–­: æ¯æ¬¡å¯¹è¯ç»“æŸè°ƒç”¨ 1 æ¬¡ LLM (~$0.005)
   728â†’- æ€»è®¡: ç”¨æˆ·æ¯å¤© $0.02-0.05 çš„ LLM æˆæœ¬
   729â†’
   730â†’**å¼€å‘æˆæœ¬:**
   731â†’- å¤æ‚æ–¹æ¡ˆ: 5-7 å¤©å¼€å‘ + æŒç»­ç»´æŠ¤
   732â†’- æç®€æ–¹æ¡ˆ: 1-2 å¤©å¼€å‘ + æç¤ºè¯è¿­ä»£
   733â†’
   734â†’**ç»“è®º**: LLM æˆæœ¬ << å¼€å‘ç»´æŠ¤æˆæœ¬
   735â†’
   736â†’---
   737â†’
   738â†’## 9. å®ç°è®¡åˆ’
   739â†’
   740â†’### Phase 1: æ•°æ®åº“ (0.5 å¤©)
   741â†’- [ ] åˆ›å»º `user_portraits` è¡¨
   742â†’- [ ] åˆ›å»º `user_portrait_history` è¡¨ (å¯é€‰)
   743â†’
   744â†’### Phase 2: æ ¸å¿ƒæœåŠ¡ (1 å¤©)
   745â†’- [ ] å®ç° `PortraitService`
   746â†’  - [ ] `get_portrait()` - è·å–ç”»åƒ
   747â†’  - [ ] `should_update()` - åˆ¤æ–­æ˜¯å¦æ›´æ–°
   748â†’  - [ ] `update_portrait()` - æ›´æ–°ç”»åƒ
   749â†’- [ ] ç®€åŒ– `InsightService`
   750â†’  - [ ] `maybe_generate_insight()` - LLM é©±åŠ¨çš„æ´å¯Ÿåˆ¤æ–­
   751â†’
   752â†’### Phase 3: é›†æˆ (0.5 å¤©)
   753â†’- [ ] ä¿®æ”¹ `AgentRuntime`
   754â†’  - [ ] Context Assembly ä½¿ç”¨ç”»åƒ
   755â†’  - [ ] åå°è§¦å‘ç”»åƒæ›´æ–°
   756â†’  - [ ] å¯¹è¯ç»“æŸè§¦å‘æ´å¯Ÿåˆ¤æ–­
   757â†’
   758â†’### å…³é”®ä¿®æ”¹æ–‡ä»¶
   759â†’
   760â†’| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
   761â†’|------|---------|------|
   762â†’| `migrations/002_user_portraits.sql` | æ–°å¢ | ç”»åƒè¡¨å®šä¹‰ |
   763â†’| `apps/api/services/vibe_engine/portrait_service.py` | æ–°å¢ | ç”»åƒæœåŠ¡ |
   764â†’| `apps/api/services/vibe_engine/insight_generator.py` | ä¿®æ”¹ | ç®€åŒ–ä¸º LLM é©±åŠ¨ |
   765â†’| `apps/api/services/agent/runtime.py` | ä¿®æ”¹ | é›†æˆç”»åƒåˆ° Context |
   766â†’
   767â†’---
   768â†’
   769â†’## 10. æ€»ç»“
   770â†’
   771â†’### æ ¸å¿ƒç†å¿µ
   772â†’
   773â†’```
   774â†’â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   775â†’â•‘                                                                               â•‘
   776â†’â•‘   ä¼ ç»Ÿæ–¹å¼: äººç±»è®¾è®¡è§„åˆ™ï¼Œä»£ç æ‰§è¡Œè§„åˆ™                                         â•‘
   777â†’â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘
   778â†’â•‘   â€¢ é¢„å®šä¹‰æ•°æ®ç»“æ„                                                            â•‘
   779â†’â•‘   â€¢ ç¼–å†™å¤æ‚çš„æå–è§„åˆ™                                                        â•‘
   780â†’â•‘   â€¢ ç»´æŠ¤è§„åˆ™å’Œè¾¹ç•Œæ¡ä»¶                                                        â•‘
   781â†’â•‘   â€¢ è§„åˆ™åƒµåŒ–ï¼Œéš¾ä»¥é€‚åº”å˜åŒ–                                                    â•‘
   782â†’â•‘                                                                               â•‘
   783â†’â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â•‘
   784â†’â•‘                                                                               â•‘
   785â†’â•‘   æç®€æ–¹å¼: å­˜å‚¨æ–‡æœ¬ï¼ŒLLM åšç†è§£                                              â•‘
   786â†’â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â•‘
   787â†’â•‘   â€¢ å­˜å‚¨åŸå§‹å¯¹è¯ + LLM ç”Ÿæˆçš„æ‘˜è¦                                             â•‘
   788â†’â•‘   â€¢ è®© LLM å®æ—¶ç†è§£å’Œæå–                                                     â•‘
   789â†’â•‘   â€¢ æç¤ºè¯å³è§„åˆ™ï¼Œæ˜“äºè¿­ä»£                                                    â•‘
   790â†’â•‘   â€¢ çµæ´»é€‚åº”å„ç§æƒ…å†µ                                                          â•‘
   791â†’â•‘                                                                               â•‘
   792â†’â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â•‘
   793â†’â•‘                                                                               â•‘
   794â†’â•‘                   "ä¸è¦ç”¨ä»£ç è§£å†³ LLM èƒ½è§£å†³çš„é—®é¢˜"                            â•‘
   795â†’â•‘                                                                               â•‘
   796â†’â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   797â†’```
   798â†’
   799â†’### ä¼˜åŠ¿
   800â†’
   801â†’1. **ä»£ç é‡å‡å°‘ 80%+** - ä» 5-7 å¤© â†’ 1-2 å¤©
   802â†’2. **ç»´æŠ¤æˆæœ¬ä½** - æ”¹æç¤ºè¯æ¯”æ”¹ä»£ç å®¹æ˜“
   803â†’3. **æ›´æ™ºèƒ½** - LLM ç†è§£èƒ½åŠ› > è§„åˆ™åŒ¹é…
   804â†’4. **æ›´çµæ´»** - é€‚åº”å„ç§è¾¹ç•Œæƒ…å†µ
   805â†’5. **æ›´å¿«è¿­ä»£** - A/B æµ‹è¯•ä¸åŒæç¤ºè¯
   806â†’
   807â†’---
   808â†’
   809â†’## 11. è¡¥ä¸ä¼˜åŒ–ï¼šé˜²æ­¢"JPEG å‹ç¼©æŸè€—"
   810â†’
   811â†’### 11.1 é—®é¢˜ï¼šä¼ å£°ç­’æ•ˆåº”
   812â†’
   813â†’éšç€å¯¹è¯è¶Šæ¥è¶Šå¤šï¼Œ`portrait_text` ä¼šè¢«åå¤é‡å†™ï¼Œå°±åƒå›¾ç‰‡è¢«åå¤ JPEG å‹ç¼©ï¼Œç»†èŠ‚ä¼šè¶Šæ¥è¶Šæ¨¡ç³Šã€‚
   814â†’
   815â†’**åœºæ™¯æ¨¡æ‹Ÿï¼š**
   816â†’- Day 1: ç”¨æˆ·è¯´"æˆ‘æœ‰ä¸€åªå«æ—ºè´¢çš„é‡‘æ¯›ï¼Œå®ƒæ€•æ°´" â†’ å†™å…¥ç”»åƒ
   817â†’- Day 30: ç”»åƒæ›´æ–° 10 æ¬¡ï¼Œè¢«å‹ç¼©æˆ"å…»æœ‰ä¸€åªå® ç‰©ç‹—"
   818â†’- Day 60: ç”¨æˆ·é—®"æˆ‘æƒ³å¸¦ç‹—å»æ¸¸æ³³ï¼Œåˆé€‚å—ï¼Ÿ"
   819â†’- AI å›å¤: "å½“ç„¶åˆé€‚å•Šï¼"ï¼ˆé”™è¯¯ï¼Œå¿˜äº†ç‹—æ€•æ°´ï¼‰
   820â†’
   821â†’### 11.2 è§£å†³æ–¹æ¡ˆï¼šHot & Cold åŒå±‚è®°å¿†
   822â†’
   823â†’```
   824â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   825â†’â”‚                                                                             â”‚
   826â†’â”‚                      Hot & Cold åŒå±‚è®°å¿†ä½“ç³»                                 â”‚
   827â†’â”‚                                                                             â”‚
   828â†’â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
   829â†’â”‚                                                                             â”‚
   830â†’â”‚   Hot Memory (çƒ­è®°å¿†) - user_portraits                                      â”‚
   831â†’â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
   832â†’â”‚   â€¢ å®è§‚çŠ¶æ€ï¼šæ€§æ ¼ã€è¿‘æœŸæƒ…ç»ªã€äº’åŠ¨åå¥½                                       â”‚
   833â†’â”‚   â€¢ é¢‘ç¹æ›´æ–°ï¼šæ¯ 10 æ¡æ¶ˆæ¯é‡å†™                                              â”‚
   834â†’â”‚   â€¢ ç‰¹ç‚¹ï¼šå‹ç¼©çš„ã€æµåŠ¨çš„ã€æ¦‚æ‹¬æ€§çš„                                          â”‚
   835â†’â”‚                                                                             â”‚
   836â†’â”‚   Cold Memory (å†·è®°å¿†) - skill_insights + embedding                         â”‚
   837â†’â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
   838â†’â”‚   â€¢ å¾®è§‚äº‹å®ï¼šå…·ä½“çš„å‘ç°ã€æ¨¡å¼ã€é‡è¦ç»†èŠ‚                                    â”‚
   839â†’â”‚   â€¢ åªå¢ä¸æ”¹ï¼šæ´å¯Ÿä¸€æ—¦ç”Ÿæˆä¸ä¼šè¢«è¦†ç›–                                        â”‚
   840â†’â”‚   â€¢ ç‰¹ç‚¹ï¼šç²¾ç¡®çš„ã€æŒä¹…çš„ã€å¯æ£€ç´¢çš„                                          â”‚
   841â†’â”‚                                                                             â”‚
   842â†’â”‚   æ£€ç´¢ç­–ç•¥ï¼šæ··åˆç­–ç•¥                                                        â”‚
   843â†’â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
   844â†’â”‚   1. å¯¹ç”¨æˆ·æ¶ˆæ¯ç”Ÿæˆ embedding                                               â”‚
   845â†’â”‚   2. å¿«é€ŸæŸ¥è¯¢ top-1 ç›¸ä¼¼ Insight                                            â”‚
   846â†’â”‚   3. å¦‚æœç›¸ä¼¼åº¦ > 0.75ï¼Œæ‰©å±•æ£€ç´¢ top-3 ä½œä¸º Context                         â”‚
   847â†’â”‚   4. æˆæœ¬çº¦ $0.0001/æ¬¡ï¼Œå¯æ¥å—                                              â”‚
   848â†’â”‚                                                                             â”‚
   849â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   850â†’```
   851â†’
   852â†’### 11.3 ç”»åƒç»“æ„åŒ–ï¼šFact Anchoring
   853â†’
   854â†’ä¸ºé˜²æ­¢ LLM åœ¨æ›´æ–°æ—¶ä¸¢å¤±é‡è¦äº‹å®ï¼Œå¼ºåˆ¶è¾“å‡ºç»“æ„åŒ–æ ¼å¼ï¼š
   855â†’
   856â†’```markdown
   857â†’# ç”¨æˆ·ç”»åƒ
   858â†’
   859â†’## ğŸ“Œ é•¿æœŸäº‹å® (Facts)
   860â†’*ä¸éšæ—¶é—´æ”¹å˜çš„ç¡¬äº‹å®ï¼Œæ›´æ–°æ—¶å¿…é¡»ä¿ç•™ï¼*
   861â†’- å…»æœ‰ä¸€åªé‡‘æ¯›å«"æ—ºè´¢"ï¼Œæ€•æ°´
   862â†’- å¯¹èŠ±ç”Ÿè¿‡æ•
   863â†’- 1990å¹´3æœˆ15æ—¥å‡ºç”Ÿï¼Œç”²æœ¨æ—¥ä¸»
   864â†’
   865â†’## ğŸŒŠ å½“å‰çŠ¶æ€ (State)
   866â†’*æµåŠ¨çš„æƒ…ç»ªå’Œè¿‘æœŸå…³æ³¨ï¼Œéšæ—¶æ›´æ–°*
   867â†’- è¿‘æœŸå·¥ä½œå‹åŠ›å¤§ï¼Œå¤„äºç„¦è™‘çŠ¶æ€
   868â†’- æ­£åœ¨è€ƒè™‘è·³æ§½ï¼Œæ‹…å¿ƒæ—¶æœºä¸å¯¹
   869â†’- æåˆ°3æ¬¡"å·®ä¸€ç‚¹ç‚¹"
   870â†’
   871â†’## ğŸ’¡ äº’åŠ¨åå¥½ (Preferences)
   872â†’- å–œæ¬¢ç›´çƒå»ºè®®ï¼Œä¸å–œæ¬¢é¸¡æ±¤
   873â†’- å¯¹å‘½ç†è§£é‡Šæ¥å—åº¦é«˜
   874â†’- ä¸å–œæ¬¢æ³›æ³›è€Œè°ˆ
   875â†’
   876â†’## ğŸ¯ å½“å‰å…³æ³¨ (Focus)
   877â†’- èŒä¸šæ–¹å‘é€‰æ‹©
   878â†’- æƒ³å­¦å†¥æƒ³ä½†è¿˜æ²¡å¼€å§‹
   879â†’```
   880â†’
   881â†’### 11.4 æ›´æ–°åçš„ Prompt
   882â†’
   883â†’```python
   884â†’PORTRAIT_UPDATE_PROMPT = """
   885â†’ä½ æ˜¯ä¸€ä¸ªç”¨æˆ·ç”»åƒåˆ†æä¸“å®¶ã€‚è¯·åŸºäºä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºè¿™ä½ç”¨æˆ·ç”Ÿæˆæˆ–æ›´æ–°ç”»åƒæ‘˜è¦ã€‚
   886â†’
   887â†’## å½“å‰ç”»åƒ (å¦‚æœå­˜åœ¨)
   888â†’{current_portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰ç”»åƒ"}
   889â†’
   890â†’## ç”¨æˆ·åŸºç¡€ä¿¡æ¯
   891â†’- å‡ºç”Ÿæ—¥æœŸ: {birth_datetime}
   892â†’- å…«å­—: {bazi_chart}
   893â†’- ä½¿ç”¨æŠ€èƒ½: {skill_id}
   894â†’
   895â†’## æœ€è¿‘ {message_count} æ¡å¯¹è¯
   896â†’{recent_messages}
   897â†’
   898â†’## ä»»åŠ¡
   899â†’è¯·ç”Ÿæˆç»“æ„åŒ–çš„ç”¨æˆ·ç”»åƒï¼Œ**å¿…é¡»**åŒ…å«ä»¥ä¸‹å››ä¸ªåŒºåŸŸï¼š
   900â†’
   901â†’# ç”¨æˆ·ç”»åƒ
   902â†’
   903â†’## ğŸ“Œ é•¿æœŸäº‹å® (Facts)
   904â†’*ä¸éšæ—¶é—´æ”¹å˜çš„ç¡¬äº‹å®ã€‚å¦‚ï¼šå§“åã€ç”Ÿæ—¥ã€å® ç‰©åã€é‡å¤§ç»å†ã€è¿‡æ•ä¿¡æ¯ã€‚*
   905â†’*ã€é‡è¦ã€‘æ›´æ–°æ—¶å¿…é¡»ä¿ç•™å·²æœ‰çš„äº‹å®ï¼Œé™¤éç”¨æˆ·æ˜ç¡®çº æ­£ï¼*
   906â†’
   907â†’## ğŸŒŠ å½“å‰çŠ¶æ€ (State)
   908â†’*æµåŠ¨çš„æƒ…ç»ªã€è¿‘æœŸè¯é¢˜ã€å½“å‰å›°æ‰°ã€‚å¯ä»¥éšæ—¶æ›´æ–°ã€‚*
   909â†’
   910â†’## ğŸ’¡ äº’åŠ¨åå¥½ (Preferences)
   911â†’*ç”¨æˆ·å–œæ¬¢ä»€ä¹ˆæ ·çš„å›åº”æ–¹å¼ã€æ²Ÿé€šé£æ ¼ã€‚*
   912â†’
   913â†’## ğŸ¯ å½“å‰å…³æ³¨ (Focus)
   914â†’*ç”¨æˆ·æ­£åœ¨æ€è€ƒæˆ–å¤„ç†çš„äº‹æƒ…ã€‚*
   915â†’
   916â†’è¦æ±‚:
   917â†’- æ¯ä¸ªåŒºåŸŸç”¨ bullet points
   918â†’- å…·ä½“è€Œéç¬¼ç»Ÿ
   919â†’- ğŸ“Œ Facts åŒºåŸŸï¼šåªå¢ä¸åˆ ï¼Œé™¤éç”¨æˆ·æ˜ç¡®çº æ­£
   920â†’- æ€»é•¿åº¦æ§åˆ¶åœ¨ 500 å­—ä»¥å†…
   921â†’- åªè¾“å‡ºç”»åƒå†…å®¹ï¼Œä¸è¦å…¶ä»–è§£é‡Š
   922â†’"""
   923â†’```
   924â†’
   925â†’### 11.5 æ•°æ®åº“æ›´æ–°
   926â†’
   927â†’```sql
   928â†’-- ä¸º skill_insights æ·»åŠ  embedding åˆ—
   929â†’ALTER TABLE skill_insights
   930â†’ADD COLUMN IF NOT EXISTS embedding vector(3072);
   931â†’
   932â†’-- æ·»åŠ å‘é‡ç´¢å¼•
   933â†’CREATE INDEX IF NOT EXISTS idx_skill_insights_embedding
   934â†’ON skill_insights USING ivfflat (embedding vector_cosine_ops)
   935â†’WITH (lists = 100);
   936â†’
   937â†’-- æ·»åŠ ç”¨æˆ·+æŠ€èƒ½çš„å¤åˆç´¢å¼•
   938â†’CREATE INDEX IF NOT EXISTS idx_skill_insights_user_skill
   939â†’ON skill_insights(user_id, skill_id);
   940â†’```
   941â†’
   942â†’### 11.6 æ›´æ–°åçš„ Context Assembly
   943â†’
   944â†’```python
   945â†’async def assemble_context(
   946â†’    user_id: UUID,
   947â†’    skill_id: str,
   948â†’    message: str,
   949â†’    conversation_id: UUID
   950â†’) -> Context:
   951â†’    """
   952â†’    Context Assembly with Hot & Cold Memory
   953â†’    """
   954â†’
   955â†’    # 1. Hot Memory: ç”¨æˆ·ç”»åƒ
   956â†’    portrait = await PortraitService.get_portrait(user_id, skill_id)
   957â†’
   958â†’    # 2. Buffer: æœ€è¿‘å¯¹è¯
   959â†’    history = await SkillRepository.get_messages(conversation_id, limit=6)
   960â†’
   961â†’    # 3. Cold Memory: ç›¸å…³ Insights (æ··åˆç­–ç•¥)
   962â†’    relevant_insights = await retrieve_relevant_insights(
   963â†’        user_id, skill_id, message
   964â†’    )
   965â†’
   966â†’    # 4. Knowledge: RAG æ£€ç´¢
   967â†’    knowledge = await RetrievalService.get_context_for_query(message, skill_id)
   968â†’
   969â†’    return Context(
   970â†’        portrait=portrait,
   971â†’        history=history,
   972â†’        insights=relevant_insights,
   973â†’        knowledge=knowledge
   974â†’    )
   975â†’
   976â†’
   977â†’async def retrieve_relevant_insights(
   978â†’    user_id: UUID,
   979â†’    skill_id: str,
   980â†’    query: str,
   981â†’    threshold: float = 0.75
   982â†’) -> List[dict]:
   983â†’    """
   984â†’    æ··åˆç­–ç•¥æ£€ç´¢ç›¸å…³ Insights
   985â†’    """
   986â†’    # 1. ç”Ÿæˆ query embedding
   987â†’    query_embedding = await EmbeddingService.embed_query(query)
   988â†’
   989â†’    # 2. å¿«é€ŸæŸ¥è¯¢ top-1
   990â†’    async with get_connection() as conn:
   991â†’        top1 = await conn.fetchrow(
   992â†’            """
   993â†’            SELECT id, title, content,
   994â†’                   1 - (embedding <=> $1::vector) as similarity
   995â†’            FROM skill_insights
   996â†’            WHERE user_id = $2 AND skill_id = $3 AND embedding IS NOT NULL
   997â†’            ORDER BY embedding <=> $1::vector
   998â†’            LIMIT 1
   999â†’            """,
  1000â†’            query_embedding, user_id, skill_id
  1001â†’        )
  1002â†’
  1003â†’    # 3. å¦‚æœç›¸ä¼¼åº¦é«˜ï¼Œæ‰©å±•æ£€ç´¢
  1004â†’    if top1 and top1["similarity"] > threshold:
  1005â†’        async with get_connection() as conn:
  1006â†’            rows = await conn.fetch(
  1007â†’                """
  1008â†’                SELECT title, content, insight_type,
  1009â†’                       1 - (embedding <=> $1::vector) as similarity
  1010â†’                FROM skill_insights
  1011â†’                WHERE user_id = $2 AND skill_id = $3 AND embedding IS NOT NULL
  1012â†’                ORDER BY embedding <=> $1::vector
  1013â†’                LIMIT 3
  1014â†’                """,
  1015â†’                query_embedding, user_id, skill_id
  1016â†’            )
  1017â†’            return [dict(r) for r in rows]
  1018â†’
  1019â†’    return []
  1020â†’```
  1021â†’
  1022â†’### 11.7 å¹¶å‘æ§åˆ¶ï¼šä¹è§‚é”
  1023â†’
  1024â†’```python
  1025â†’async def update_portrait_with_optimistic_lock(
  1026â†’    user_id: UUID,
  1027â†’    skill_id: str,
  1028â†’    new_portrait: str,
  1029â†’    expected_version: int,
  1030â†’    last_msg_id: UUID
  1031â†’) -> bool:
  1032â†’    """
  1033â†’    ä½¿ç”¨ä¹è§‚é”æ›´æ–°ç”»åƒï¼Œé˜²æ­¢å¹¶å‘è¦†ç›–
  1034â†’    """
  1035â†’    async with get_connection() as conn:
  1036â†’        result = await conn.execute(
  1037â†’            """
  1038â†’            UPDATE user_portraits
  1039â†’            SET portrait_text = $1,
  1040â†’                version = version + 1,
  1041â†’                last_message_id = $2,
  1042â†’                generated_at = NOW()
  1043â†’            WHERE user_id = $3 AND skill_id = $4 AND version = $5
  1044â†’            """,
  1045â†’            new_portrait, last_msg_id, user_id, skill_id, expected_version
  1046â†’        )
  1047â†’
  1048â†’        # å¦‚æœå½±å“è¡Œæ•°ä¸º 0ï¼Œè¯´æ˜æœ‰å¹¶å‘å†™å…¥ï¼Œä¸¢å¼ƒæœ¬æ¬¡æ›´æ–°
  1049â†’        return result == "UPDATE 1"
  1050â†’```
  1051â†’
  1052â†’---
  1053â†’
  1054â†’## 12. æœ€ç»ˆå®ç°è®¡åˆ’
  1055â†’
  1056â†’### Phase 1: æ•°æ®åº“ (0.5 å¤©)
  1057â†’- [ ] åˆ›å»º `user_portraits` è¡¨
  1058â†’- [ ] åˆ›å»º `user_portrait_history` è¡¨
  1059â†’- [ ] ä¸º `skill_insights` æ·»åŠ  `embedding` åˆ—å’Œç´¢å¼•
  1060â†’
  1061â†’### Phase 2: æ ¸å¿ƒæœåŠ¡ (1 å¤©)
  1062â†’- [ ] å®ç° `PortraitService`
  1063â†’  - [ ] ç»“æ„åŒ–ç”»åƒæ ¼å¼ (Facts/State/Preferences/Focus)
  1064â†’  - [ ] ä¹è§‚é”å¹¶å‘æ§åˆ¶
  1065â†’- [ ] å¢å¼º `InsightService`
  1066â†’  - [ ] ç”Ÿæˆ Insight æ—¶åŒæ—¶ç”Ÿæˆ embedding
  1067â†’  - [ ] ç›¸å…³ Insight æ£€ç´¢ (æ··åˆç­–ç•¥)
  1068â†’
  1069â†’### Phase 3: é›†æˆ (0.5 å¤©)
  1070â†’- [ ] ä¿®æ”¹ `AgentRuntime`
  1071â†’  - [ ] Context Assembly åŒ…å« Hot + Cold Memory
  1072â†’  - [ ] System Prompt æ•´åˆç”»åƒå’Œç›¸å…³ Insights
  1073â†’
  1074â†’### å…³é”®ä¿®æ”¹æ–‡ä»¶
  1075â†’
  1076â†’| æ–‡ä»¶ | ä¿®æ”¹ç±»å‹ | è¯´æ˜ |
  1077â†’|------|---------|------|
  1078â†’| `migrations/002_user_portraits.sql` | æ–°å¢ | ç”»åƒè¡¨ + insights embedding |
  1079â†’| `apps/api/services/vibe_engine/portrait_service.py` | æ–°å¢ | ç”»åƒæœåŠ¡ (ç»“æ„åŒ–+ä¹è§‚é”) |
  1080â†’| `apps/api/services/vibe_engine/insight_generator.py` | ä¿®æ”¹ | æ·»åŠ  embedding ç”Ÿæˆ |
  1081â†’| `apps/api/stores/skill_repo.py` | ä¿®æ”¹ | æ·»åŠ  Insight å‘é‡æ£€ç´¢ |
  1082â†’| `apps/api/services/agent/runtime.py` | ä¿®æ”¹ | Hot+Cold Context Assembly |
  1083â†’
  1084â†’---
  1085â†’
  1086â†’## 13. æ€»ç»“
  1087â†’
  1088â†’### æœ€ç»ˆæ¶æ„
  1089â†’
  1090â†’```
  1091â†’â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
  1092â†’â•‘                                                                               â•‘
  1093â†’â•‘                      VibeLife ç”¨æˆ·è®°å¿†ä½“ç³» (æœ€ç»ˆç‰ˆ)                            â•‘
  1094â†’â•‘                                                                               â•‘
  1095â†’â•‘   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•     â•‘
  1096â†’â•‘                                                                               â•‘
  1097â†’â•‘   ç”¨æˆ·æ¶ˆæ¯                                                                    â•‘
  1098â†’â•‘       â”‚                                                                       â•‘
  1099â†’â•‘       â–¼                                                                       â•‘
  1100â†’â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
  1101â†’â•‘   â”‚  Context Assembly                                                   â”‚     â•‘
  1102â†’â•‘   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â•‘
  1103â†’â•‘   â”‚                                                                     â”‚     â•‘
  1104â†’â•‘   â”‚  1. ğŸ”¥ Hot Memory: user_portraits                                   â”‚     â•‘
  1105â†’â•‘   â”‚     â€¢ ç»“æ„åŒ–ç”»åƒ (Facts/State/Preferences/Focus)                    â”‚     â•‘
  1106â†’â•‘   â”‚     â€¢ å®è§‚çŠ¶æ€ï¼Œé¢‘ç¹æ›´æ–°                                            â”‚     â•‘
  1107â†’â•‘   â”‚                                                                     â”‚     â•‘
  1108â†’â•‘   â”‚  2. ğŸ’¬ Buffer: skill_messages (æœ€è¿‘ 6 æ¡)                           â”‚     â•‘
  1109â†’â•‘   â”‚     â€¢ å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡                                                â”‚     â•‘
  1110â†’â•‘   â”‚                                                                     â”‚     â•‘
  1111â†’â•‘   â”‚  3. â„ï¸ Cold Memory: skill_insights + embedding                      â”‚     â•‘
  1112â†’â•‘   â”‚     â€¢ å¾®è§‚äº‹å®ï¼Œå‘é‡æ£€ç´¢                                            â”‚     â•‘
  1113â†’â•‘   â”‚     â€¢ æ··åˆç­–ç•¥ï¼štop-1 å¿«æ£€ â†’ æ‰©å±• top-3                             â”‚     â•‘
  1114â†’â•‘   â”‚                                                                     â”‚     â•‘
  1115â†’â•‘   â”‚  4. ğŸ“š Knowledge: RAG æ£€ç´¢                                          â”‚     â•‘
  1116â†’â•‘   â”‚     â€¢ ä¸“ä¸šçŸ¥è¯†åº“                                                    â”‚     â•‘
  1117â†’â•‘   â”‚                                                                     â”‚     â•‘
  1118â†’â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
  1119â†’â•‘       â”‚                                                                       â•‘
  1120â†’â•‘       â–¼                                                                       â•‘
  1121â†’â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
  1122â†’â•‘   â”‚  LLM ç”Ÿæˆå“åº”                                                       â”‚     â•‘
  1123â†’â•‘   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â•‘
  1124â†’â•‘   â”‚                                                                     â”‚     â•‘
  1125â†’â•‘   â”‚  System Prompt:                                                     â”‚     â•‘
  1126â†’â•‘   â”‚  â€¢ Persona (Vibe è§’è‰²)                                              â”‚     â•‘
  1127â†’â•‘   â”‚  â€¢ ç”¨æˆ·ç”»åƒ (Hot Memory)                                            â”‚     â•‘
  1128â†’â•‘   â”‚  â€¢ ç›¸å…³å†å²æ´å¯Ÿ (Cold Memory)                                       â”‚     â•‘
  1129â†’â•‘   â”‚  â€¢ ä¸“ä¸šçŸ¥è¯† (RAG)                                                   â”‚     â•‘
  1130â†’â•‘   â”‚                                                                     â”‚     â•‘
  1131â†’â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
  1132â†’â•‘       â”‚                                                                       â•‘
  1133â†’â•‘       â–¼                                                                       â•‘
  1134â†’â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘
  1135â†’â•‘   â”‚  åå°ä»»åŠ¡                                                           â”‚     â•‘
  1136â†’â•‘   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚     â•‘
  1137â†’â•‘   â”‚                                                                     â”‚     â•‘
  1138â†’â•‘   â”‚  Portrait Agent (æ¯ 10 æ¡æ¶ˆæ¯)                                      â”‚     â•‘
  1139â†’â•‘   â”‚  â€¢ æ›´æ–° Hot Memory                                                  â”‚     â•‘
  1140â†’â•‘   â”‚  â€¢ ä¹è§‚é”é˜²æ­¢å¹¶å‘è¦†ç›–                                               â”‚     â•‘
  1141â†’â•‘   â”‚  â€¢ ä¿æŠ¤ ğŸ“Œ Facts ä¸è¢«å‹ç¼©ä¸¢å¤±                                       â”‚     â•‘
  1142â†’â•‘   â”‚                                                                     â”‚     â•‘
  1143â†’â•‘   â”‚  Insight Agent (å¯¹è¯ç»“æŸå)                                         â”‚     â•‘
  1144â†’â•‘   â”‚  â€¢ åˆ¤æ–­æ˜¯å¦ç”Ÿæˆ Cold Memory                                         â”‚     â•‘
  1145â†’â•‘   â”‚  â€¢ ç”Ÿæˆ embedding æ”¯æŒå‘é‡æ£€ç´¢                                      â”‚     â•‘
  1146â†’â•‘   â”‚                                                                     â”‚     â•‘
  1147â†’â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘
  1148â†’â•‘                                                                               â•‘
  1149â†’â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1150â†’```
  1151â†’
  1152â†’### æ ¸å¿ƒç†å¿µ
  1153â†’
  1154â†’> **"Hot Memory è´Ÿè´£å…¨å±€è§‚ï¼ŒCold Memory è´Ÿè´£ç»†èŠ‚è®°å¿†"**
  1155â†’>
  1156â†’> - ç”»åƒè¢«å‹ç¼©ï¼Ÿæ²¡å…³ç³»ï¼ŒFacts åŒºåŸŸè¢«é”å®š
  1157â†’> - ç»†èŠ‚è¢«é—å¿˜ï¼Ÿæ²¡å…³ç³»ï¼ŒInsights æ°¸ä¹…ä¿å­˜ä¸”å¯å‘é‡æ£€ç´¢
  1158â†’> - è¿™æ˜¯ä¸€ä¸ª**æ—¢æœ‰å…¨å±€è§‚ã€åˆæœ‰ç»†èŠ‚è®°å¿†**çš„å®Œç¾ AI å¤§è„‘
  1159â†’
  1160â†’---
  1161â†’
  1162â†’*æ–‡æ¡£ç‰ˆæœ¬: 2.0*
  1163â†’*åˆ›å»ºæ—¥æœŸ: 2026-01-06*
  1164â†’*æ ¸å¿ƒæ€æƒ³: è®© LLM åšè„æ´»ï¼ŒHot & Cold åŒå±‚è®°å¿†*
  1165â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
