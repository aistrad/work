     1→"""
     2→Zodiac Skill Tool Handlers - 星座工具执行器
     3→
     4→使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
     5→"""
     6→import logging
     7→from datetime import datetime
     8→from typing import Dict, Any
     9→
    10→from services.agent.tool_registry import tool_handler, ToolContext
    11→
    12→logger = logging.getLogger(__name__)
    13→
    14→
    15→@tool_handler("calculate_zodiac")
    16→async def execute_calculate_zodiac(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    17→    """
    18→    计算用户星盘 - 使用 Swiss Ephemeris 精确计算
    19→
    20→    这是 SOP P2 阶段的核心工具，负责：
    21→    1. 从 args 或 profile 获取出生信息
    22→    2. 调用 Swiss Ephemeris 计算精确星盘
    23→    3. 返回计算结果供后续分析使用
    24→    """
    25→    from services.agent.tool_registry import ToolRegistry
    26→    from skills.zodiac.services import calculate_zodiac as calc_zodiac
    27→
    28→    profile = context.profile or {}
    29→    identity = profile.get("identity", {})
    30→    birth_info = identity.get("birth_info", {})
    31→
    32→    # 优先使用 args 中的参数，否则从 profile 读取
    33→    birth_date = args.get("birth_date") or birth_info.get("date")
    34→    birth_time = args.get("birth_time") or birth_info.get("time", "12:00")
    35→    birth_place = args.get("birth_place") or birth_info.get("place", "Shanghai")
    36→    gender = args.get("gender") or birth_info.get("gender")
    37→
    38→    if not birth_date:
    39→        return {
    40→            "status": "error",
    41→            "error": "需要出生日期才能计算星盘",
    42→            "action": "collect_birth_info"
    43→        }
    44→
    45→    try:
    46→        # 检查用户是否已有出生信息
    47→        user_has_birth_info = bool(birth_info.get("date"))
    48→
    49→        # 使用 Swiss Ephemeris 计算精确星盘
    50→        chart = calc_zodiac(
    51→            birth_date=birth_date,
    52→            birth_time=birth_time,
    53→            birth_place=birth_place
    54→        )
    55→
    56→        logger.info(f"Calculated zodiac chart for user {context.user_id}: "
    57→                   f"Sun={chart.get('sun_sign')}, Moon={chart.get('moon_sign')}, "
    58→                   f"Rising={chart.get('rising_sign')}")
    59→
    60→        # 构建卡片数据用于展示
    61→        card_data = {
    62→            "userId": context.user_id,
    63→            "birthInfo": {
    64→                "date": birth_date,
    65→                "time": birth_time,
    66→                "place": birth_place,
    67→            },
    68→            "sunSign": chart.get("sun_sign_chinese", chart.get("sun_sign")),
    69→            "moonSign": chart.get("moon_sign_chinese", chart.get("moon_sign")),
    70→            "risingSign": chart.get("rising_sign_chinese", chart.get("rising_sign")),
    71→            "planets": chart.get("planets", []),
    72→            "aspects": chart.get("aspects", []),
    73→            "dominantElement": chart.get("dominant_element"),
    74→            "dominantModality": chart.get("dominant_modality"),
    75→            # 完整 chart 数据供后续使用
    76→            "_chart": chart,
    77→        }
    78→
    79→        # v9.2: 如果用户没有保存出生信息，添加提示
    80→        if not user_has_birth_info and context.user_id and context.user_id != "guest":
    81→            card_data["_hint"] = {
    82→                "action": "ask_save_birth_info",
    83→                "message": "用户尚未保存出生信息。请询问用户是否将此出生信息保存为个人档案，方便下次使用。如果用户同意，调用 save_birth_info 工具。",
    84→                "birth_info_to_save": {
    85→                    "date": birth_date,
    86→                    "time": birth_time,
    87→                    "gender": gender,
    88→                    "place": birth_place,
    89→                }
    90→            }
    91→
    92→        # 展示星盘卡片
    93→        return await ToolRegistry.execute(
    94→            "show_card",
    95→            {
    96→                "card_type": "custom",
    97→                "data_source": {"type": "inline", "data": card_data},
    98→                "options": {"componentId": "zodiac_chart"}
    99→            },
   100→            context
   101→        )
   102→
   103→    except Exception as e:
   104→        logger.error(f"calculate_zodiac failed: {e}")
   105→        return {
   106→            "status": "error",
   107→            "error": f"星盘计算失败: {str(e)}",
   108→        }
   109→
   110→
   111→@tool_handler("collect_zodiac_info")
   112→async def execute_collect_zodiac_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   113→    """收集用户出生信息用于星盘分析"""
   114→    fields = [
   115→        {"id": "birthDate", "label": "出生日期", "type": "date", "required": True, "placeholder": ""},
   116→        {"id": "birthTime", "label": "出生时间", "type": "time", "required": True, "placeholder": ""},
   117→        {"id": "birthPlace", "label": "出生地点", "type": "location", "required": True, "placeholder": "城市名"},
   118→    ]
   119→
   120→    return {
   121→        "status": "collecting",
   122→        "cardType": "collect_form",
   123→        "formType": "birth_info",
   124→        "title": "请填写出生信息",
   125→        "description": "准确的出生时间和地点对于星盘分析至关重要",
   126→        "fields": fields,
   127→    }
   128→
   129→
   130→@tool_handler("show_zodiac_chart")
   131→async def execute_show_zodiac_chart(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   132→    """展示星盘 - V7 委托模式
   133→
   134→    支持两种数据来源：
   135→    1. args 参数直接传入（优先）- LLM 从 calculate_zodiac 结果传递
   136→    2. skill_data 缓存（备用）- 从用户数据读取
   137→    """
   138→    from services.agent.tool_registry import ToolRegistry
   139→
   140→    profile = context.profile or {}
   141→    skill_data = context.skill_data or {}
   142→    identity = profile.get("identity", {})
   143→    birth_info = identity.get("birth_info", {})
   144→
   145→    # 优先从 args 获取星盘数据（LLM 可以直接传递 calculate_zodiac 的结果）
   146→    chart = {}
   147→    if args.get("sun_sign") or args.get("sunSign"):
   148→        # 从 args 构建 chart
   149→        chart = {
   150→            "sun_sign": args.get("sun_sign") or args.get("sunSign"),
   151→            "moon_sign": args.get("moon_sign") or args.get("moonSign"),
   152→            "rising_sign": args.get("rising_sign") or args.get("risingSign"),
   153→            "planets": args.get("planets", []),
   154→            "aspects": args.get("aspects", []),
   155→            "dominant_element": args.get("dominant_element") or args.get("dominantElement"),
   156→            "dominant_modality": args.get("dominant_modality") or args.get("dominantModality"),
   157→        }
   158→        # 也更新 birth_info
   159→        if args.get("birth_date"):
   160→            birth_info = {
   161→                "date": args.get("birth_date"),
   162→                "time": args.get("birth_time"),
   163→                "place": args.get("birth_place"),
   164→            }
   165→
   166→    # 如果 args 没有，从 skill_data 读取
   167→    if not chart:
   168→        zodiac_data = skill_data.get("zodiac", {})
   169→        chart = zodiac_data.get("chart", {}) if zodiac_data else {}
   170→
   171→    # 如果仍然没有星盘数据，提示先计算
   172→    if not chart or not chart.get("sun_sign"):
   173→        return {
   174→            "status": "error",
   175→            "error": "尚未计算星盘，请先调用 calculate_zodiac",
   176→            "action": "calculate_zodiac"
   177→        }
   178→
   179→    # 构建卡片数据
   180→    card_data = {
   181→        "userId": context.user_id,
   182→        "birthInfo": {
   183→            "date": birth_info.get("date"),
   184→            "time": birth_info.get("time"),
   185→            "place": birth_info.get("place"),
   186→        },
   187→        "sunSign": chart.get("sun_sign_chinese") or chart.get("sun_sign"),
   188→        "moonSign": chart.get("moon_sign_chinese") or chart.get("moon_sign"),
   189→        "risingSign": chart.get("rising_sign_chinese") or chart.get("rising_sign"),
   190→        "planets": chart.get("planets", []),
   191→        "aspects": chart.get("aspects", []),
   192→        "dominantElement": chart.get("dominant_element"),
   193→        "dominantModality": chart.get("dominant_modality"),
   194→    }
   195→
   196→    logger.info(f"Showing zodiac chart via show_card for user {context.user_id}")
   197→
   198→    return await ToolRegistry.execute(
   199→        "show_card",
   200→        {
   201→            "card_type": "custom",
   202→            "data_source": {"type": "inline", "data": card_data},
   203→            "options": {"componentId": "zodiac_chart"}
   204→        },
   205→        context
   206→    )
   207→
   208→
   209→@tool_handler("show_zodiac_transit")
   210→async def execute_show_zodiac_transit(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   211→    """展示行运分析 - V7 委托模式"""
   212→    from services.agent.tool_registry import ToolRegistry
   213→    from skills.zodiac.services import calculate_transit, calculate_zodiac
   214→
   215→    profile = context.profile or {}
   216→    identity = profile.get("identity", {})
   217→    birth_info = identity.get("birth_info", {})
   218→
   219→    # 获取出生信息
   220→    birth_date = birth_info.get("date")
   221→    birth_time = birth_info.get("time", "12:00")
   222→    birth_place = birth_info.get("place", "Shanghai")
   223→
   224→    transit_date = args.get("date") or datetime.now().strftime("%Y-%m-%d")
   225→
   226→    # 如果没有出生信息，返回通用行运
   227→    if not birth_date:
   228→        card_data = {
   229→            "date": transit_date,
   230→            "transits": [],
   231→            "majorEvents": [],
   232→            "overallEnergy": "请先提供出生信息以获取个性化行运分析。",
   233→            "advice": "完善出生信息后，可以看到行星对你本命盘的具体影响。",
   234→            "needBirthInfo": True,
   235→        }
   236→        return await ToolRegistry.execute(
   237→            "show_card",
   238→            {
   239→                "card_type": "custom",
   240→                "data_source": {"type": "inline", "data": card_data},
   241→                "options": {"componentId": "zodiac_transit"}
   242→            },
   243→            context
   244→        )
   245→
   246→    try:
   247→        # 计算行运
   248→        transits = calculate_transit(
   249→            birth_date=birth_date,
   250→            birth_time=birth_time,
   251→            birth_place=birth_place,
   252→            transit_date=transit_date
   253→        )
   254→
   255→        # 生成整体能量描述
   256→        positive_count = sum(1 for t in transits if t.get("influence") == "positive")
   257→        challenging_count = sum(1 for t in transits if t.get("influence") == "challenging")
   258→
   259→        if positive_count > challenging_count:
   260→            overall_energy = "整体能量积极，适合推进重要事项。"
   261→            advice = "把握有利时机，主动出击。"
   262→        elif challenging_count > positive_count:
   263→            overall_energy = "整体能量需要调整，适合反思和准备。"
   264→            advice = "放慢脚步，处理好细节问题。"
   265→        else:
   266→            overall_energy = "能量平衡，稳中求进。"
   267→            advice = "保持节奏，按计划推进。"
   268→
   269→        card_data = {
   270→            "date": transit_date,
   271→            "transits": transits,
   272→            "majorEvents": [],
   273→            "overallEnergy": overall_energy,
   274→            "advice": advice,
   275→        }
   276→
   277→        logger.info(f"Showing zodiac transit via show_card for user {context.user_id}")
   278→
   279→        return await ToolRegistry.execute(
   280→            "show_card",
   281→            {
   282→                "card_type": "custom",
   283→                "data_source": {"type": "inline", "data": card_data},
   284→                "options": {"componentId": "zodiac_transit"}
   285→            },
   286→            context
   287→        )
   288→    except Exception as e:
   289→        logger.error(f"show_zodiac_transit failed: {e}")
   290→        return {
   291→            "status": "error",
   292→            "error": str(e),
   293→        }
   294→
   295→
   296→@tool_handler("show_zodiac_synastry")
   297→async def execute_show_zodiac_synastry(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   298→    """展示合盘分析 - V7 委托模式"""
   299→    from services.agent.tool_registry import ToolRegistry
   300→    from skills.zodiac.services import calculate_synastry
   301→
   302→    profile = context.profile or {}
   303→    identity = profile.get("identity", {})
   304→    birth_info = identity.get("birth_info", {})
   305→
   306→    # 获取用户出生信息
   307→    person1_birth_date = birth_info.get("date")
   308→    person1_birth_time = birth_info.get("time", "12:00")
   309→    person1_birth_place = birth_info.get("place", "Shanghai")
   310→
   311→    # 获取对方出生信息
   312→    person2_birth_date = args.get("partner_birth_date")
   313→    person2_birth_time = args.get("partner_birth_time", "12:00")
   314→    person2_birth_place = args.get("partner_birth_place", "Shanghai")
   315→
   316→    # 检查必要信息
   317→    if not person1_birth_date:
   318→        return {
   319→            "status": "error",
   320→            "error": "请先提供你的出生信息",
   321→            "needBirthInfo": True,
   322→        }
   323→
   324→    if not person2_birth_date:
   325→        return {
   326→            "status": "error",
   327→            "error": "请提供对方的出生日期",
   328→            "needPartnerInfo": True,
   329→        }
   330→
   331→    try:
   332→        # 计算合盘
   333→        result = calculate_synastry(
   334→            person1_birth_date=person1_birth_date,
   335→            person1_birth_time=person1_birth_time,
   336→            person1_birth_place=person1_birth_place,
   337→            person2_birth_date=person2_birth_date,
   338→            person2_birth_time=person2_birth_time,
   339→            person2_birth_place=person2_birth_place,
   340→        )
   341→
   342→        if "error" in result:
   343→            return {
   344→                "status": "error",
   345→                "error": result["error"],
   346→            }
   347→
   348→        logger.info(f"Showing zodiac synastry via show_card for user {context.user_id}")
   349→
   350→        return await ToolRegistry.execute(
   351→            "show_card",
   352→            {
   353→                "card_type": "custom",
   354→                "data_source": {"type": "inline", "data": result},
   355→                "options": {"componentId": "zodiac_synastry"}
   356→            },
   357→            context
   358→        )
   359→    except Exception as e:
   360→        logger.error(f"show_zodiac_synastry failed: {e}")
   361→        return {
   362→            "status": "error",
   363→            "error": str(e),
   364→        }
   365→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
