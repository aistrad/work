     1→"""
     2→Lifecoach Skill - Tool Handlers V2
     3→
     4→使用 @tool_handler 装饰器注册工具执行器。
     5→支持数据持久化和展示卡片生成。
     6→"""
     7→
     8→import uuid
     9→from typing import Any, Dict, List, Optional
    10→from datetime import datetime, date
    11→
    12→from services.agent.tool_registry import tool_handler, ToolContext
    13→from stores.unified_profile_repo import UnifiedProfileRepository
    14→
    15→
    16→# ═══════════════════════════════════════════════════════════════════════════
    17→# 数据工具 (V2 新增)
    18→# ═══════════════════════════════════════════════════════════════════════════
    19→
    20→@tool_handler("read_lifecoach_state")
    21→async def read_lifecoach_state(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    22→    """
    23→    读取用户的人生地图状态
    24→
    25→    从 unified_profile 的 life_context.lifecoach 路径读取数据
    26→    """
    27→    sections = args.get("sections", ["north_star", "roles", "weekly_rocks", "daily_levers"])
    28→
    29→    try:
    30→        # 从 unified_profile 读取 lifecoach 数据
    31→        data = await UnifiedProfileRepository.read_life_context_path(
    32→            context.user_id,
    33→            "lifecoach"
    34→        )
    35→
    36→        if not data or not data.content:
    37→            return {
    38→                "status": "empty",
    39→                "message": "尚未建立人生地图，让我们开始吧！",
    40→                "data": {}
    41→            }
    42→
    43→        # 按请求的 sections 过滤返回
    44→        result = {}
    45→        content = data.content
    46→        for section in sections:
    47→            if section in content:
    48→                result[section] = content[section]
    49→
    50→        return {
    51→            "status": "success",
    52→            "data": result,
    53→            "version": data.version,
    54→            "updated_at": data.updated_at.isoformat() if data.updated_at else None
    55→        }
    56→
    57→    except Exception as e:
    58→        return {
    59→            "status": "error",
    60→            "message": f"读取状态失败: {str(e)}",
    61→            "data": {}
    62→        }
    63→
    64→
    65→@tool_handler("write_lifecoach_state")
    66→async def write_lifecoach_state(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    67→    """
    68→    写入用户的人生地图状态
    69→
    70→    使用 jsonb_set 进行局部更新，避免覆盖其他 section
    71→    """
    72→    section = args.get("section")
    73→    data = args.get("data")
    74→
    75→    if not section or not data:
    76→        return {
    77→            "status": "error",
    78→            "message": "缺少必要参数: section 和 data"
    79→        }
    80→
    81→    try:
    82→        # 先读取现有数据
    83→        existing = await UnifiedProfileRepository.read_life_context_path(
    84→            context.user_id,
    85→            "lifecoach"
    86→        )
    87→
    88→        # 合并数据
    89→        content = existing.content if existing else {}
    90→        content[section] = data
    91→        content["_last_updated"] = datetime.utcnow().isoformat()
    92→        content["_last_section"] = section
    93→
    94→        # 写入
    95→        result = await UnifiedProfileRepository.write_life_context_path(
    96→            context.user_id,
    97→            "lifecoach",
    98→            content
    99→        )
   100→
   101→        return {
   102→            "status": "success",
   103→            "message": f"已保存 {section}",
   104→            "version": result.version
   105→        }
   106→
   107→    except Exception as e:
   108→        return {
   109→            "status": "error",
   110→            "message": f"保存失败: {str(e)}"
   111→        }
   112→
   113→
   114→@tool_handler("add_journal_entry")
   115→async def add_journal_entry(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   116→    """
   117→    添加复盘日志条目
   118→    """
   119→    entry_type = args.get("entry_type")
   120→    content = args.get("content")
   121→
   122→    if not entry_type or not content:
   123→        return {
   124→            "status": "error",
   125→            "message": "缺少必要参数: entry_type 和 content"
   126→        }
   127→
   128→    try:
   129→        # 读取现有数据
   130→        existing = await UnifiedProfileRepository.read_life_context_path(
   131→            context.user_id,
   132→            "lifecoach"
   133→        )
   134→
   135→        lifecoach_data = existing.content if existing else {}
   136→        journal = lifecoach_data.get("journal", {"entries": []})
   137→
   138→        # 创建新条目
   139→        entry = {
   140→            "id": str(uuid.uuid4())[:8],
   141→            "type": entry_type,
   142→            "content": content,
   143→            "created_at": datetime.utcnow().isoformat(),
   144→            "mood": args.get("mood"),
   145→            "energy": args.get("energy"),
   146→            "wins": args.get("wins", []),
   147→            "learnings": args.get("learnings", []),
   148→            "blockers": args.get("blockers", [])
   149→        }
   150→
   151→        # 添加到日志列表（最新在前）
   152→        journal["entries"] = [entry] + journal.get("entries", [])[:99]  # 保留最近100条
   153→        journal["last_entry_at"] = entry["created_at"]
   154→        journal["total_entries"] = len(journal["entries"])
   155→
   156→        # 保存
   157→        lifecoach_data["journal"] = journal
   158→        await UnifiedProfileRepository.write_life_context_path(
   159→            context.user_id,
   160→            "lifecoach",
   161→            lifecoach_data
   162→        )
   163→
   164→        return {
   165→            "status": "success",
   166→            "message": "日志已记录",
   167→            "entry_id": entry["id"]
   168→        }
   169→
   170→    except Exception as e:
   171→        return {
   172→            "status": "error",
   173→            "message": f"记录失败: {str(e)}"
   174→        }
   175→
   176→
   177→@tool_handler("update_progress")
   178→async def update_progress(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   179→    """
   180→    更新进度/签到
   181→    """
   182→    action_type = args.get("action_type")
   183→
   184→    if not action_type:
   185→        return {
   186→            "status": "error",
   187→            "message": "缺少必要参数: action_type"
   188→        }
   189→
   190→    try:
   191→        # 读取现有数据
   192→        existing = await UnifiedProfileRepository.read_life_context_path(
   193→            context.user_id,
   194→            "lifecoach"
   195→        )
   196→
   197→        lifecoach_data = existing.content if existing else {}
   198→        progress = lifecoach_data.get("progress", {
   199→            "current_streak": 0,
   200→            "longest_streak": 0,
   201→            "total_checkins": 0,
   202→            "last_checkin_date": None,
   203→            "checkin_history": [],
   204→            "completed_levers": [],
   205→            "completed_rocks": [],
   206→            "milestones": []
   207→        })
   208→
   209→        today = date.today().isoformat()
   210→        now = datetime.utcnow().isoformat()
   211→
   212→        if action_type == "daily_checkin":
   213→            # 检查是否今天已签到
   214→            if progress.get("last_checkin_date") == today:
   215→                return {
   216→                    "status": "already_checked_in",
   217→                    "message": "今天已经签到过了！",
   218→                    "current_streak": progress["current_streak"]
   219→                }
   220→
   221→            # 更新连续签到
   222→            last_date = progress.get("last_checkin_date")
   223→            if last_date:
   224→                last = date.fromisoformat(last_date)
   225→                today_date = date.today()
   226→                diff = (today_date - last).days
   227→                if diff == 1:
   228→                    progress["current_streak"] += 1
   229→                elif diff > 1:
   230→                    progress["current_streak"] = 1
   231→            else:
   232→                progress["current_streak"] = 1
   233→
   234→            # 更新最长连续
   235→            if progress["current_streak"] > progress.get("longest_streak", 0):
   236→                progress["longest_streak"] = progress["current_streak"]
   237→
   238→            progress["total_checkins"] = progress.get("total_checkins", 0) + 1
   239→            progress["last_checkin_date"] = today
   240→
   241→            # 记录签到历史
   242→            history = progress.get("checkin_history", [])
   243→            history.append({
   244→                "date": today,
   245→                "time": now,
   246→                "notes": args.get("notes")
   247→            })
   248→            progress["checkin_history"] = history[-30:]  # 保留最近30天
   249→
   250→        elif action_type == "lever_complete":
   251→            lever_id = args.get("lever_id")
   252→            if lever_id:
   253→                completed = progress.get("completed_levers", [])
   254→                completed.append({
   255→                    "id": lever_id,
   256→                    "completed_at": now,
   257→                    "notes": args.get("notes")
   258→                })
   259→                progress["completed_levers"] = completed[-100:]
   260→
   261→        elif action_type == "rock_complete":
   262→            rock_id = args.get("rock_id")
   263→            if rock_id:
   264→                completed = progress.get("completed_rocks", [])
   265→                completed.append({
   266→                    "id": rock_id,
   267→                    "completed_at": now,
   268→                    "notes": args.get("notes")
   269→                })
   270→                progress["completed_rocks"] = completed[-50:]
   271→
   272→        elif action_type == "milestone_reached":
   273→            milestones = progress.get("milestones", [])
   274→            milestones.append({
   275→                "reached_at": now,
   276→                "notes": args.get("notes")
   277→            })
   278→            progress["milestones"] = milestones
   279→
   280→        # 保存
   281→        lifecoach_data["progress"] = progress
   282→        await UnifiedProfileRepository.write_life_context_path(
   283→            context.user_id,
   284→            "lifecoach",
   285→            lifecoach_data
   286→        )
   287→
   288→        return {
   289→            "status": "success",
   290→            "message": "进度已更新",
   291→            "current_streak": progress.get("current_streak", 0),
   292→            "total_checkins": progress.get("total_checkins", 0)
   293→        }
   294→
   295→    except Exception as e:
   296→        return {
   297→            "status": "error",
   298→            "message": f"更新失败: {str(e)}"
   299→        }
   300→
   301→
   302→# ══════════════════��════════════════════════════════════════════════════════
   303→# 展示工具 - V2 新增
   304→# ═══════════════════════════════════════════════════════════════════════════
   305→
   306→@tool_handler("show_life_roadmap")
   307→async def show_life_roadmap(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   308→    """
   309→    展示人生路线图卡片
   310→    """
   311→    north_star = args.get("north_star", {})
   312→
   313→    return {
   314→        "card_type": "life_roadmap",
   315→        "data": {
   316→            "north_star": north_star,
   317→            "yearly_theme": args.get("yearly_theme"),
   318→            "quarterly_milestones": args.get("quarterly_milestones", []),
   319→            "current_focus": args.get("current_focus"),
   320→            "generated_at": datetime.utcnow().isoformat()
   321→        }
   322→    }
   323→
   324→
   325→@tool_handler("show_role_balance")
   326→async def show_role_balance(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   327→    """
   328→    展示目标平衡轮卡片
   329→    """
   330→    roles = args.get("roles", [])
   331→
   332→    # 计算平衡分数
   333→    if roles:
   334→        scores = [r.get("current_score", 0) for r in roles if r.get("current_score") is not None]
   335→        if scores:
   336→            avg = sum(scores) / len(scores)
   337→            variance = sum((s - avg) ** 2 for s in scores) / len(scores)
   338→            # 平衡分数：平均分越高、方差越小，分数越高
   339→            balance_score = min(100, max(0, avg * 10 - variance * 2))
   340→        else:
   341→            balance_score = 0
   342→    else:
   343→        balance_score = args.get("balance_score", 0)
   344→
   345→    return {
   346→        "card_type": "role_balance",
   347→        "data": {
   348→            "roles": roles,
   349→            "balance_score": round(balance_score, 1),
   350→            "insight": args.get("insight"),
   351→            "generated_at": datetime.utcnow().isoformat()
   352→        }
   353→    }
   354→
   355→
   356→@tool_handler("show_weekly_rocks")
   357→async def show_weekly_rocks(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   358→    """
   359→    展示周大石头卡片
   360→    """
   361→    rocks = args.get("rocks", [])
   362→
   363→    # 计算完成进度
   364→    total = len(rocks)
   365→    completed = sum(1 for r in rocks if r.get("status") == "completed")
   366→    in_progress = sum(1 for r in rocks if r.get("status") == "in_progress")
   367→
   368→    return {
   369→        "card_type": "weekly_rocks",
   370→        "data": {
   371→            "week_start": args.get("week_start", date.today().isoformat()),
   372→            "rocks": rocks,
   373→            "theme": args.get("theme"),
   374→            "energy_budget": args.get("energy_budget"),
   375→            "stats": {
   376→                "total": total,
   377→                "completed": completed,
   378→                "in_progress": in_progress,
   379→                "completion_rate": round(completed / total * 100, 1) if total > 0 else 0
   380→            },
   381→            "generated_at": datetime.utcnow().isoformat()
   382→        }
   383→    }
   384→
   385→
   386→@tool_handler("show_daily_levers")
   387→async def show_daily_levers(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   388→    """
   389→    展示每日杠杆行动卡片
   390→    """
   391→    levers = args.get("levers", [])
   392→
   393→    # 计算完成进度
   394→    total = len(levers)
   395→    completed = sum(1 for l in levers if l.get("status") == "completed")
   396→
   397→    return {
   398→        "card_type": "daily_levers",
   399→        "data": {
   400→            "date": args.get("date", date.today().isoformat()),
   401→            "levers": levers,
   402→            "energy_level": args.get("energy_level"),
   403→            "intention": args.get("intention"),
   404→            "stats": {
   405→                "total": total,
   406→                "completed": completed,
   407→                "completion_rate": round(completed / total * 100, 1) if total > 0 else 0
   408→            },
   409→            "generated_at": datetime.utcnow().isoformat()
   410→        }
   411→    }
   412→
   413→
   414→@tool_handler("show_progress_streak")
   415→async def show_progress_streak(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   416→    """
   417→    展示连续签到和进度统计卡片
   418→    """
   419→    current_streak = args.get("current_streak", 0)
   420→    longest_streak = args.get("longest_streak", current_streak)
   421→
   422→    # 计算激励消息
   423→    if current_streak >= 30:
   424→        motivation = "太棒了！一个月的坚持，你正在重塑自己！"
   425→    elif current_streak >= 14:
   426→        motivation = "两周了！习惯正在形成，继续保持！"
   427→    elif current_streak >= 7:
   428→        motivation = "一周连续签到！你已经超越了大多数人！"
   429→    elif current_streak >= 3:
   430→        motivation = "连续三天，好的开始！"
   431→    elif current_streak >= 1:
   432→        motivation = "今天是新的开始！"
   433→    else:
   434→        motivation = "准备好开始你的旅程了吗？"
   435→
   436→    return {
   437→        "card_type": "progress_streak",
   438→        "data": {
   439→            "current_streak": current_streak,
   440→            "longest_streak": longest_streak,
   441→            "total_checkins": args.get("total_checkins", 0),
   442→            "weekly_completion_rate": args.get("weekly_completion_rate", 0),
   443→            "monthly_stats": args.get("monthly_stats", {}),
   444→            "achievements": args.get("achievements", []),
   445→            "motivation": motivation,
   446→            "generated_at": datetime.utcnow().isoformat()
   447→        }
   448→    }
   449→
   450→
   451→# ═══════════════════════════════════════════════════════════════════════════
   452→# 展示工具 - V1 保留 (使用 @tool_handler 重写)
   453→# ═══════════════════════════════════════════════════════════════════════════
   454→
   455→@tool_handler("show_pattern_insight")
   456→async def show_pattern_insight(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   457→    """
   458→    展示行为模式洞察卡片
   459→    """
   460→    pattern_type = args.get("pattern_type", "behavior")
   461→
   462→    type_labels = {
   463→        "behavior": "行为模式",
   464→        "stuck": "卡点分析",
   465→        "conflict": "目标冲突",
   466→        "protection": "自我保护"
   467→    }
   468→
   469→    return {
   470→        "card_type": "pattern_insight",
   471→        "data": {
   472→            "type": pattern_type,
   473→            "type_label": type_labels.get(pattern_type, "模式分析"),
   474→            "surface_pattern": args.get("surface_pattern", ""),
   475→            "hidden_goal": args.get("hidden_goal"),
   476→            "cost": args.get("cost"),
   477→            "insight": args.get("insight"),
   478→            "generated_at": datetime.utcnow().isoformat()
   479→        }
   480→    }
   481→
   482→
   483→@tool_handler("show_identity_design")
   484→async def show_identity_design(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   485→    """
   486→    展示身份设计卡片
   487→    """
   488→    return {
   489→        "card_type": "identity_design",
   490→        "data": {
   491→            "old_identity": args.get("old_identity"),
   492→            "new_identity": args.get("new_identity", ""),
   493→            "bridge_belief": args.get("bridge_belief"),
   494→            "anchor_behaviors": args.get("anchor_behaviors", []),
   495→            "transformation_arrow": "→" if args.get("old_identity") else None,
   496→            "generated_at": datetime.utcnow().isoformat()
   497→        }
   498→    }
   499→
   500→
   501→@tool_handler("show_vision_map")
   502→async def show_vision_map(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   503→    """
   504→    展示愿景/反愿景地图
   505→    """
   506→    map_type = args.get("map_type", "vision")
   507→
   508→    return {
   509→        "card_type": "vision_map",
   510→        "data": {
   511→            "map_type": map_type,
   512→            "vision": {
   513→                "statement": args.get("vision_statement"),
   514→                "three_year_picture": args.get("three_year_picture"),
   515→                "identity_belief": args.get("identity_belief"),
   516→                "one_year_milestone": args.get("one_year_milestone")
   517→            } if map_type in ["vision", "both"] else None,
   518→            "anti_vision": {
   519→                "statement": args.get("anti_vision_statement"),
   520→                "five_year_picture": args.get("five_year_picture")
   521→            } if map_type in ["anti_vision", "both"] else None,
   522→            "generated_at": datetime.utcnow().isoformat()
   523→        }
   524→    }
   525→
   526→
   527→@tool_handler("show_action_plan")
   528→async def show_action_plan(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   529→    """
   530→    展示行动计划卡片
   531→    """
   532→    return {
   533→        "card_type": "action_plan",
   534→        "data": {
   535→            "context": args.get("context"),
   536→            "hierarchy": {
   537→                "one_year_goal": args.get("one_year_goal"),
   538→                "one_month_project": args.get("one_month_project"),
   539→                "daily_actions": args.get("daily_actions", [])
   540→            },
   541→            "first_step": args.get("first_step"),
   542→            "generated_at": datetime.utcnow().isoformat()
   543→        }
   544→    }
   545→
   546→
   547→@tool_handler("show_life_game")
   548→async def show_life_game(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
   549→    """
   550→    展示人生游戏设计卡片
   551→    """
   552→    return {
   553→        "card_type": "life_game",
   554→        "data": {
   555→            "win_condition": args.get("win_condition", ""),
   556→            "lose_condition": args.get("lose_condition", ""),
   557→            "main_mission": args.get("main_mission", ""),
   558→            "current_boss": {
   559→                "name": args.get("current_boss"),
   560→                "reward": args.get("boss_reward")
   561→            } if args.get("current_boss") else None,
   562→            "daily_quests": args.get("daily_quests", []),
   563→            "game_rules": args.get("game_rules", []),
   564→            "generated_at": datetime.utcnow().isoformat()
   565→        }
   566→    }
   567→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
