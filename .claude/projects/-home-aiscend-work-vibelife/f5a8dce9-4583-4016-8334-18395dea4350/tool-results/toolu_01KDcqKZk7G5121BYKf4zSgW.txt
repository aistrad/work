     1â†’"""
     2â†’SkillLoader v7 - æ”¯æŒ Agentic + Rule æ¶æ„çš„ Skill åŠ è½½å™¨
     3â†’
     4â†’v7 æ¶æ„ï¼š
     5â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
     6â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
     7â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
     8â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
     9â†’
    10â†’v7.4 æ–°å¢ï¼š
    11â†’- Skill Management æ”¯æŒï¼šcategory, pricing, showcase, subscription å­—æ®µ
    12â†’
    13â†’v7.5 æ–°å¢ï¼š
    14â†’- æ•°æ®åº“ä¼˜å…ˆå…ƒæ•°æ®åŠ è½½ï¼ˆskill_catalog è¡¨ï¼‰
    15â†’- async å‡½æ•°æ”¯æŒï¼šload_skill_metadata_async, get_all_skill_metadata_async
    16â†’- SKILL.md ä½œä¸º fallback
    17â†’"""
    18â†’import re
    19â†’import json
    20â†’import logging
    21â†’import yaml
    22â†’from pathlib import Path
    23â†’from dataclasses import dataclass, field
    24â†’from typing import Dict, List, Optional, Any
    25â†’from functools import lru_cache
    26â†’
    27â†’logger = logging.getLogger(__name__)
    28â†’
    29â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    30â†’
    31â†’
    32â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    33â†’# æ•°æ®ç»“æ„
    34â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    35â†’
    36â†’@dataclass
    37â†’class SkillPricing:
    38â†’    """Skill å®šä»·é…ç½®"""
    39â†’    type: str = "free"  # free | premium | credits
    40â†’    trial_messages: int = 3
    41â†’    credits_per_use: Optional[int] = None
    42â†’
    43â†’
    44â†’@dataclass
    45â†’class SkillShowcase:
    46â†’    """Skill å±•ç¤ºé…ç½®ï¼ˆç”¨äº Skill å¸‚åœºï¼‰"""
    47â†’    tagline: str = ""
    48â†’    highlights: List[str] = field(default_factory=list)
    49â†’    preview_image: Optional[str] = None
    50â†’    demo_prompts: List[str] = field(default_factory=list)
    51â†’
    52â†’
    53â†’@dataclass
    54â†’class SkillSubscription:
    55â†’    """Skill è®¢é˜…é…ç½®"""
    56â†’    auto_subscribe: bool = False
    57â†’    can_unsubscribe: bool = True
    58â†’    push_default: bool = True
    59â†’    min_subscription_days: int = 0
    60â†’
    61â†’
    62â†’@dataclass
    63â†’class SkillFeature:
    64â†’    """Skill åŠŸèƒ½ç‰¹æ€§"""
    65â†’    name: str
    66â†’    description: str = ""
    67â†’    icon: str = "ğŸ“Œ"
    68â†’    tier: str = "free"  # free | basic | premium
    69â†’
    70â†’
    71â†’@dataclass
    72â†’class SkillMetadata:
    73â†’    """Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰"""
    74â†’    id: str
    75â†’    name: str
    76â†’    description: str
    77â†’    version: str = "1.0.0"
    78â†’    category: str = "professional"  # core | default | professional
    79â†’    icon: str = "ğŸ’¡"
    80â†’    color: str = "#6B7280"
    81â†’    triggers: List[str] = field(default_factory=list)
    82â†’    pricing: SkillPricing = field(default_factory=SkillPricing)
    83â†’    features: List[SkillFeature] = field(default_factory=list)
    84â†’    showcase: SkillShowcase = field(default_factory=SkillShowcase)
    85â†’    subscription: SkillSubscription = field(default_factory=SkillSubscription)
    86â†’
    87â†’    def to_dict(self) -> Dict[str, Any]:
    88â†’        """è½¬æ¢ä¸º API å“åº”æ ¼å¼"""
    89â†’        return {
    90â†’            "id": self.id,
    91â†’            "name": self.name,
    92â†’            "description": self.description,
    93â†’            "version": self.version,
    94â†’            "category": self.category,
    95â†’            "icon": self.icon,
    96â†’            "color": self.color,
    97â†’            "triggers": self.triggers,
    98â†’            "pricing": {
    99â†’                "type": self.pricing.type,
   100â†’                "trial_messages": self.pricing.trial_messages,
   101â†’                "credits_per_use": self.pricing.credits_per_use,
   102â†’            },
   103â†’            "features": [
   104â†’                {"name": f.name, "description": f.description, "icon": f.icon, "tier": f.tier}
   105â†’                for f in self.features
   106â†’            ],
   107â†’            "showcase": {
   108â†’                "tagline": self.showcase.tagline,
   109â†’                "highlights": self.showcase.highlights,
   110â†’                "preview_image": self.showcase.preview_image,
   111â†’                "demo_prompts": self.showcase.demo_prompts,
   112â†’            },
   113â†’            "subscription": {
   114â†’                "auto_subscribe": self.subscription.auto_subscribe,
   115â†’                "can_unsubscribe": self.subscription.can_unsubscribe,
   116â†’                "push_default": self.subscription.push_default,
   117â†’            },
   118â†’        }
   119â†’
   120â†’
   121â†’@dataclass
   122â†’class SkillConfig:
   123â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
   124â†’    id: str
   125â†’    name: str
   126â†’    description: str
   127â†’    expert_persona: str
   128â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
   129â†’    ethics: Dict[str, Any]
   130â†’    tools: List[str]
   131â†’    default_scenario: str = "basic_reading"
   132â†’    triggers: List[str] = field(default_factory=list)
   133â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
   134â†’    # v7.1: SOP é…ç½®é©±åŠ¨
   135â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
   136â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
   137â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
   138â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   139â†’    collect_tool: Optional[str] = None # æ”¶é›†å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   140â†’    external_tools: List[str] = field(default_factory=list)  # v7.3: ä»å…¶ä»– skill å¯¼å…¥çš„å·¥å…·
   141â†’
   142â†’
   143â†’@dataclass
   144â†’class ServiceItem:
   145â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
   146â†’    scenario_id: str
   147â†’    name: str
   148â†’    icon: str
   149â†’    description: str
   150â†’    tier: str  # entry/standard/professional
   151â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
   152â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
   153â†’
   154â†’
   155â†’@dataclass
   156â†’class ScenarioConfig:
   157â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
   158â†’    id: str
   159â†’    name: str
   160â†’    level: str  # entry/standard/professional
   161â†’    billing: str  # free/basic/premium
   162â†’    description: str
   163â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
   164â†’    prerequisites: List[str]
   165â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
   166â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
   167â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
   168â†’    tools: List[str]
   169â†’
   170â†’
   171â†’@dataclass
   172â†’class ToolMetadata:
   173â†’    """å·¥å…·å…ƒæ•°æ®"""
   174â†’    name: str
   175â†’    description: str
   176â†’    tool_type: str  # collect/calculate/display/search
   177â†’    card_type: Optional[str] = None
   178â†’    card_props_schema: Optional[Dict] = None
   179â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   180â†’    when_to_call: Optional[str] = None
   181â†’
   182â†’
   183â†’@dataclass
   184â†’class RuleConfig:
   185â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
   186â†’    id: str
   187â†’    name: str
   188â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
   189â†’    impact_description: str
   190â†’    tags: List[str]
   191â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
   192â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
   193â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
   194â†’    common_questions: str  # å¸¸è§é—®é¢˜
   195â†’
   196â†’
   197â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   198â†’# è§£æå‡½æ•°
   199â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   200â†’
   201â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   202â†’    """è§£æ YAML frontmatterï¼ˆæ”¯æŒåµŒå¥—å¯¹è±¡ï¼‰"""
   203â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   204â†’    match = re.match(pattern, text, re.DOTALL)
   205â†’    if not match:
   206â†’        return {}, text
   207â†’
   208â†’    frontmatter_str, content = match.groups()
   209â†’
   210â†’    # ä½¿ç”¨ YAML è§£æä»¥æ”¯æŒåµŒå¥—å¯¹è±¡
   211â†’    try:
   212â†’        metadata = yaml.safe_load(frontmatter_str) or {}
   213â†’    except yaml.YAMLError as e:
   214â†’        logger.warning(f"YAML parse error in frontmatter: {e}, falling back to simple parse")
   215â†’        # å›é€€åˆ°ç®€å•è§£æ
   216â†’        metadata = {}
   217â†’        current_key = None
   218â†’        current_list = None
   219â†’
   220â†’        for line in frontmatter_str.strip().split('\n'):
   221â†’            stripped = line.strip()
   222â†’            if not stripped:
   223â†’                continue
   224â†’            if stripped.startswith('- ') and current_key:
   225â†’                if current_list is None:
   226â†’                    current_list = []
   227â†’                current_list.append(stripped[2:].strip())
   228â†’                metadata[current_key] = current_list
   229â†’            elif ':' in line and not line.startswith(' '):
   230â†’                current_list = None
   231â†’                key, value = line.split(':', 1)
   232â†’                current_key = key.strip()
   233â†’                value = value.strip()
   234â†’                if value in ('|', ''):
   235â†’                    continue
   236â†’                elif value.lower() == 'true':
   237â†’                    metadata[current_key] = True
   238â†’                elif value.lower() == 'false':
   239â†’                    metadata[current_key] = False
   240â†’                else:
   241â†’                    metadata[current_key] = value
   242â†’
   243â†’    return metadata, content.strip()
   244â†’
   245â†’
   246â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   247â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   248â†’
   249â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   250â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   251â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   252â†’    """
   253â†’    metadata, content = parse_frontmatter(text)
   254â†’
   255â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   256â†’    triggers = metadata.get("triggers", [])
   257â†’
   258â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   259â†’    if not triggers:
   260â†’        description = metadata.get("description", "")
   261â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   262â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   263â†’        if trigger_match:
   264â†’            trigger_str = trigger_match.group(1)
   265â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   266â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   267â†’
   268â†’    result = {
   269â†’        "id": metadata.get("id", ""),
   270â†’        "name": metadata.get("name", ""),
   271â†’        "description": metadata.get("description", ""),
   272â†’        "triggers": triggers,
   273â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   274â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   275â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   276â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   277â†’        "requires_compute": metadata.get("requires_compute", False),
   278â†’        "compute_type": metadata.get("compute_type", None),
   279â†’        "compute_tool": metadata.get("compute_tool", None),
   280â†’        "collect_tool": metadata.get("collect_tool", None),
   281â†’        "external_tools": metadata.get("external_tools", []),  # v7.3
   282â†’    }
   283â†’
   284â†’    # æå–ä¸“å®¶èº«ä»½
   285â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   286â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   287â†’
   288â†’    # æå–åœºæ™¯ç›®å½•
   289â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   290â†’    for level in scenarios.keys():
   291â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   292â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   293â†’        if match:
   294â†’            for row in match.group(1).strip().split('\n'):
   295â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   296â†’                if len(cols) >= 2:
   297â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   298â†’    result["scenarios"] = scenarios
   299â†’
   300â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   301â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   302â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   303â†’    if forbidden_match:
   304â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   305â†’    result["ethics"] = ethics
   306â†’
   307â†’    # æå–å·¥å…·åˆ—è¡¨
   308â†’    tools = []
   309â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   310â†’    if tools_match:
   311â†’        for row in tools_match.group(1).strip().split('\n'):
   312â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   313â†’            if len(cols) >= 1:
   314â†’                tools.append(cols[0])
   315â†’    result["tools"] = tools
   316â†’
   317â†’    return result
   318â†’
   319â†’
   320â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   321â†’    """è§£æ scenario.md å†…å®¹"""
   322â†’    metadata, content = parse_frontmatter(text)
   323â†’
   324â†’    result = {
   325â†’        "id": metadata.get("id", ""),
   326â†’        "name": metadata.get("name", ""),
   327â†’        "level": metadata.get("level", "entry"),
   328â†’        "billing": metadata.get("billing", "free"),
   329â†’        "description": metadata.get("description", ""),
   330â†’    }
   331â†’
   332â†’    # æå–è§¦å‘æ¡ä»¶
   333â†’    triggers = {"primary": [], "secondary": []}
   334â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   335â†’    if primary_match:
   336â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   337â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   338â†’    if secondary_match:
   339â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   340â†’    result["triggers"] = triggers
   341â†’
   342â†’    # æå–å‰ç½®è¦æ±‚
   343â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   344â†’    result["prerequisites"] = []
   345â†’    if prereq_match:
   346â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   347â†’
   348â†’    # æå– SOP é˜¶æ®µ
   349â†’    sop = []
   350â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   351â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   352â†’        phase_num, phase_name, phase_content = match.groups()
   353â†’        phase = {
   354â†’            "phase": int(phase_num),
   355â†’            "name": phase_name.strip(),
   356â†’            "content": phase_content.strip()
   357â†’        }
   358â†’        # æå–ç±»å‹
   359â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   360â†’        if type_match:
   361â†’            phase["type"] = type_match.group(1)
   362â†’        sop.append(phase)
   363â†’    result["sop"] = sop
   364â†’
   365â†’    # æå–å·¥å…·åˆ—è¡¨
   366â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   367â†’    result["tools"] = []
   368â†’    if tools_match:
   369â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   370â†’
   371â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   372â†’    result["knowledge_config"] = {}
   373â†’    result["output_config"] = {}
   374â†’
   375â†’    return result
   376â†’
   377â†’
   378â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   379â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   380â†’    metadata, content = parse_frontmatter(text)
   381â†’
   382â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   383â†’    tags_raw = metadata.get("tags", [])
   384â†’    if isinstance(tags_raw, str):
   385â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   386â†’    else:
   387â†’        tags = tags_raw
   388â†’
   389â†’    result = {
   390â†’        "id": metadata.get("id", ""),
   391â†’        "name": metadata.get("name", ""),
   392â†’        "impact": metadata.get("impact", "MEDIUM"),
   393â†’        "impact_description": metadata.get("impactDescription", ""),
   394â†’        "tags": tags,
   395â†’        "content": content,
   396â†’    }
   397â†’
   398â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   399â†’    analysis_steps = []
   400â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   401â†’    if table_match:
   402â†’        for row in table_match.group(1).strip().split('\n'):
   403â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   404â†’            if len(cols) >= 4:
   405â†’                analysis_steps.append({
   406â†’                    "step": cols[0],
   407â†’                    "point": cols[1],
   408â†’                    "query": cols[2],
   409â†’                    "priority": cols[3],
   410â†’                })
   411â†’    result["analysis_steps"] = analysis_steps
   412â†’
   413â†’    # æå–è¾“å‡ºè¦æ±‚
   414â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   415â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   416â†’
   417â†’    # æå–å¸¸è§é—®é¢˜
   418â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   419â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   420â†’
   421â†’    return result
   422â†’
   423â†’
   424â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   425â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   426â†’    services = {"entry": [], "standard": [], "professional": []}
   427â†’
   428â†’    tier_map = {
   429â†’        "entry": "entry",
   430â†’        "standard": "standard",
   431â†’        "professional": "professional"
   432â†’    }
   433â†’
   434â†’    for tier_name, tier_key in tier_map.items():
   435â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   436â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   437â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   438â†’        if not match:
   439â†’            continue
   440â†’
   441â†’        table_content = match.group(1).strip()
   442â†’        if not table_content:
   443â†’            continue
   444â†’
   445â†’        for row in table_content.split('\n'):
   446â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   447â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   448â†’                continue
   449â†’
   450â†’            service = {
   451â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   452â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   453â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   454â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   455â†’                "tier": tier_key,
   456â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   457â†’                "highlights": []
   458â†’            }
   459â†’
   460â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   461â†’            if len(cols) > 7 and cols[7]:
   462â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   463â†’
   464â†’            services[tier_key].append(service)
   465â†’
   466â†’    return services
   467â†’
   468â†’
   469â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   470â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   471â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   472â†’    if not skill_path.exists():
   473â†’        return None
   474â†’
   475â†’    text = skill_path.read_text(encoding='utf-8')
   476â†’    metadata, _ = parse_frontmatter(text)
   477â†’    services = parse_skill_services(text)
   478â†’
   479â†’    return {
   480â†’        "skill_id": skill_id,
   481â†’        "skill_name": metadata.get("name", skill_id),
   482â†’        "description": metadata.get("description", ""),
   483â†’        "services": services
   484â†’    }
   485â†’
   486â†’
   487â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   488â†’# åŠ è½½å‡½æ•°
   489â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   490â†’
   491â†’@lru_cache(maxsize=32)
   492â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   493â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   494â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   495â†’    if not skill_path.exists():
   496â†’        return None
   497â†’
   498â†’    text = skill_path.read_text(encoding='utf-8')
   499â†’    data = parse_skill_md(text)
   500â†’
   501â†’    return SkillConfig(
   502â†’        id=data.get("id", skill_id),
   503â†’        name=data.get("name", skill_id),
   504â†’        description=data.get("description", ""),
   505â†’        expert_persona=data.get("expert_persona", ""),
   506â†’        scenarios=data.get("scenarios", {}),
   507â†’        ethics=data.get("ethics", {}),
   508â†’        tools=data.get("tools", []),
   509â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   510â†’        triggers=data.get("triggers", []),
   511â†’        global_tools=data.get("global_tools", []),
   512â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   513â†’        requires_birth_info=data.get("requires_birth_info", False),
   514â†’        requires_compute=data.get("requires_compute", False),
   515â†’        compute_type=data.get("compute_type", None),
   516â†’        compute_tool=data.get("compute_tool", None),
   517â†’        collect_tool=data.get("collect_tool", None),
   518â†’        external_tools=data.get("external_tools", []),  # v7.3
   519â†’    )
   520â†’
   521â†’
   522â†’@lru_cache(maxsize=32)
   523â†’def load_skill_metadata(skill_id: str) -> Optional[SkillMetadata]:
   524â†’    """åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰- v7.4 æ–°å¢
   525â†’
   526â†’    ä» SKILL.md çš„ frontmatter ä¸­è¯»å–å®Œæ•´çš„å…ƒæ•°æ®é…ç½®ï¼Œ
   527â†’    åŒ…æ‹¬ category, pricing, showcase, subscription ç­‰å­—æ®µã€‚
   528â†’    """
   529â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   530â†’    if not skill_path.exists():
   531â†’        return None
   532â†’
   533â†’    text = skill_path.read_text(encoding='utf-8')
   534â†’    metadata, _ = parse_frontmatter(text)
   535â†’
   536â†’    # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   537â†’    triggers = metadata.get("triggers", [])
   538â†’    if not triggers:
   539â†’        description = metadata.get("description", "")
   540â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   541â†’        if trigger_match:
   542â†’            trigger_str = trigger_match.group(1)
   543â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   544â†’
   545â†’    # è§£æ pricing
   546â†’    pricing_data = metadata.get("pricing", {})
   547â†’    pricing = SkillPricing(
   548â†’        type=pricing_data.get("type", "free") if isinstance(pricing_data, dict) else "free",
   549â†’        trial_messages=pricing_data.get("trial_messages", 3) if isinstance(pricing_data, dict) else 3,
   550â†’        credits_per_use=pricing_data.get("credits_per_use") if isinstance(pricing_data, dict) else None,
   551â†’    )
   552â†’
   553â†’    # è§£æ features
   554â†’    features_data = metadata.get("features", [])
   555â†’    features = []
   556â†’    if isinstance(features_data, list):
   557â†’        for f in features_data:
   558â†’            if isinstance(f, dict):
   559â†’                features.append(SkillFeature(
   560â†’                    name=f.get("name", ""),
   561â†’                    description=f.get("description", ""),
   562â†’                    icon=f.get("icon", "ğŸ“Œ"),
   563â†’                    tier=f.get("tier", "free"),
   564â†’                ))
   565â†’
   566â†’    # è§£æ showcase
   567â†’    showcase_data = metadata.get("showcase", {})
   568â†’    showcase = SkillShowcase(
   569â†’        tagline=showcase_data.get("tagline", "") if isinstance(showcase_data, dict) else "",
   570â†’        highlights=showcase_data.get("highlights", []) if isinstance(showcase_data, dict) else [],
   571â†’        preview_image=showcase_data.get("preview_image") if isinstance(showcase_data, dict) else None,
   572â†’        demo_prompts=showcase_data.get("demo_prompts", []) if isinstance(showcase_data, dict) else [],
   573â†’    )
   574â†’
   575â†’    # è§£æ subscription
   576â†’    subscription_data = metadata.get("subscription", {})
   577â†’    category = metadata.get("category", "professional")
   578â†’    subscription = SkillSubscription(
   579â†’        auto_subscribe=subscription_data.get("auto_subscribe", category == "default") if isinstance(subscription_data, dict) else (category == "default"),
   580â†’        can_unsubscribe=subscription_data.get("can_unsubscribe", category != "core") if isinstance(subscription_data, dict) else (category != "core"),
   581â†’        push_default=subscription_data.get("push_default", True) if isinstance(subscription_data, dict) else True,
   582â†’        min_subscription_days=subscription_data.get("min_subscription_days", 0) if isinstance(subscription_data, dict) else 0,
   583â†’    )
   584â†’
   585â†’    return SkillMetadata(
   586â†’        id=metadata.get("id", skill_id),
   587â†’        name=metadata.get("name", skill_id),
   588â†’        description=metadata.get("description", ""),
   589â†’        version=metadata.get("version", "1.0.0"),
   590â†’        category=category,
   591â†’        icon=metadata.get("icon", "ğŸ’¡"),
   592â†’        color=metadata.get("color", "#6B7280"),
   593â†’        triggers=triggers,
   594â†’        pricing=pricing,
   595â†’        features=features,
   596â†’        showcase=showcase,
   597â†’        subscription=subscription,
   598â†’    )
   599â†’
   600â†’
   601â†’def get_all_skill_metadata() -> List[SkillMetadata]:
   602â†’    """è·å–æ‰€æœ‰å¯ç”¨ Skill çš„å…ƒæ•°æ®ï¼ˆç”¨äº Skill åˆ—è¡¨ APIï¼‰- v7.4 æ–°å¢"""
   603â†’    skills = []
   604â†’    for skill_id in get_available_skills():
   605â†’        metadata = load_skill_metadata(skill_id)
   606â†’        if metadata:
   607â†’            skills.append(metadata)
   608â†’    return skills
   609â†’
   610â†’
   611â†’def get_skills_by_category(category: str) -> List[SkillMetadata]:
   612â†’    """æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ - v7.4 æ–°å¢
   613â†’
   614â†’    Args:
   615â†’        category: core | default | professional
   616â†’
   617â†’    Returns:
   618â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„å…ƒæ•°æ®åˆ—è¡¨
   619â†’    """
   620â†’    return [s for s in get_all_skill_metadata() if s.category == category]
   621â†’
   622â†’
   623â†’@lru_cache(maxsize=64)
   624â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   625â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   626â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   627â†’    if not scenario_path.exists():
   628â†’        return None
   629â†’
   630â†’    text = scenario_path.read_text(encoding='utf-8')
   631â†’    data = parse_scenario_md(text)
   632â†’
   633â†’    return ScenarioConfig(
   634â†’        id=data.get("id", scenario_id),
   635â†’        name=data.get("name", scenario_id),
   636â†’        level=data.get("level", "entry"),
   637â†’        billing=data.get("billing", "free"),
   638â†’        description=data.get("description", ""),
   639â†’        triggers=data.get("triggers", {}),
   640â†’        prerequisites=data.get("prerequisites", []),
   641â†’        sop=data.get("sop", []),
   642â†’        knowledge_config=data.get("knowledge_config", {}),
   643â†’        output_config=data.get("output_config", {}),
   644â†’        tools=data.get("tools", [])
   645â†’    )
   646â†’
   647â†’
   648â†’@lru_cache(maxsize=128)
   649â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   650â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢"""
   651â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   652â†’    if not rule_path.exists():
   653â†’        return None
   654â†’
   655â†’    text = rule_path.read_text(encoding='utf-8')
   656â†’    data = parse_rule_md(text)
   657â†’
   658â†’    return RuleConfig(
   659â†’        id=data.get("id", rule_id),
   660â†’        name=data.get("name", rule_id),
   661â†’        impact=data.get("impact", "MEDIUM"),
   662â†’        impact_description=data.get("impact_description", ""),
   663â†’        tags=data.get("tags", []),
   664â†’        content=data.get("content", ""),
   665â†’        analysis_steps=data.get("analysis_steps", []),
   666â†’        output_requirements=data.get("output_requirements", ""),
   667â†’        common_questions=data.get("common_questions", ""),
   668â†’    )
   669â†’
   670â†’
   671â†’def get_skill_rules(skill_id: str) -> List[str]:
   672â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢"""
   673â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   674â†’    if not rules_dir.exists():
   675â†’        return []
   676â†’    return [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   677â†’
   678â†’
   679â†’def has_rules(skill_id: str) -> bool:
   680â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   681â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   682â†’    if not rules_dir.exists():
   683â†’        return False
   684â†’    rules = list(rules_dir.glob("*.md"))
   685â†’    return len(rules) > 0
   686â†’
   687â†’
   688â†’def get_available_skills() -> List[str]:
   689â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   690â†’    if not SKILLS_DIR.exists():
   691â†’        return []
   692â†’    return [p.name for p in SKILLS_DIR.iterdir()
   693â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   694â†’
   695â†’
   696â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   697â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   698â†’
   699â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   700â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   701â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼‰
   702â†’    """
   703â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   704â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   705â†’    if rules_dir.exists():
   706â†’        rules = [p.stem for p in rules_dir.glob("*.md") if not p.stem.startswith("_")]
   707â†’        if rules:
   708â†’            return rules
   709â†’
   710â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   711â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   712â†’    if not scenarios_dir.exists():
   713â†’        return []
   714â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   715â†’
   716â†’
   717â†’def get_skill_triggers() -> Dict[str, List[str]]:
   718â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   719â†’    triggers = {}
   720â†’    for skill_id in get_available_skills():
   721â†’        if skill_id == "core":
   722â†’            continue
   723â†’        skill = load_skill(skill_id)
   724â†’        if skill and skill.triggers:
   725â†’            triggers[skill_id] = skill.triggers
   726â†’    return triggers
   727â†’
   728â†’
   729â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   730â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   731â†’    skill = load_skill(skill_id)
   732â†’    if skill and skill.global_tools:
   733â†’        return skill.global_tools
   734â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   735â†’    return []
   736â†’
   737â†’
   738â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   739â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   740â†’    skill = load_skill(skill_id)
   741â†’    if skill and skill.external_tools:
   742â†’        return skill.external_tools
   743â†’    return []
   744â†’
   745â†’
   746â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   747â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
   748â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   749â†’
   750â†’def skill_requires_birth_info(skill_id: str) -> bool:
   751â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   752â†’    skill = load_skill(skill_id)
   753â†’    return skill.requires_birth_info if skill else False
   754â†’
   755â†’
   756â†’def skill_requires_compute(skill_id: str) -> bool:
   757â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   758â†’    skill = load_skill(skill_id)
   759â†’    return skill.requires_compute if skill else False
   760â†’
   761â†’
   762â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
   763â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
   764â†’
   765â†’    è¿”å›å€¼ï¼š
   766â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
   767â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
   768â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
   769â†’    """
   770â†’    skill = load_skill(skill_id)
   771â†’    return skill.compute_type if skill else None
   772â†’
   773â†’
   774â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
   775â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   776â†’
   777â†’    è¿”å›å€¼ï¼š
   778â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
   779â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   780â†’    """
   781â†’    skill = load_skill(skill_id)
   782â†’    return skill.compute_tool if skill else None
   783â†’
   784â†’
   785â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
   786â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   787â†’
   788â†’    è¿”å›å€¼ï¼š
   789â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
   790â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   791â†’    """
   792â†’    skill = load_skill(skill_id)
   793â†’    return skill.collect_tool if skill else None
   794â†’
   795â†’
   796â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   797â†’# System Prompt æ„å»º
   798â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   799â†’
   800â†’# V2: è¯­æ°”æ¨¡å¼ Prompt æ¨¡æ¿
   801â†’VOICE_MODE_PROMPTS = {
   802â†’    "warm": """## è¯­æ°”é£æ ¼ï¼šæ¸©æš–æ”¯æŒå‹
   803â†’åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿã€‚
   804â†’- ç”¨"æˆ‘ä»¬"è€Œé"ä½ åº”è¯¥"
   805â†’- å…ˆè‚¯å®šæ„Ÿå—ï¼Œå†å¼•å¯¼æ€è€ƒ
   806â†’- ç”¨é—®é¢˜ä»£æ›¿å»ºè®®
   807â†’""",
   808â†’    "direct": """## è¯­æ°”é£æ ¼ï¼šç›´æ¥æŒ‘æˆ˜å‹
   809â†’ç›´æ¥æŒ‡å‡ºé—®é¢˜ï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸ã€‚
   810â†’- ç®€æ´æœ‰åŠ›ï¼Œä¸ç»•å¼¯å­
   811â†’- ç”¨äº‹å®å’Œé€»è¾‘è¯´è¯
   812â†’- é€‚åº¦æŒ‘æˆ˜èˆ’é€‚åŒº
   813â†’""",
   814â†’    "playful": """## è¯­æ°”é£æ ¼ï¼šè½»æ¾å¹½é»˜å‹
   815â†’ç”¨æ¸¸æˆåŒ–çš„æ–¹å¼è®©æ”¹å˜å˜å¾—æœ‰è¶£ã€‚
   816â†’- ç”¨æ¯”å–»å’Œç±»æ¯”
   817â†’- æŠŠæŒ‘æˆ˜å˜æˆæ¸¸æˆ
   818â†’- åº†ç¥å°èƒœåˆ©
   819â†’"""
   820â†’}
   821â†’
   822â†’
   823â†’def _build_persona_prompt(skill_id: str, user_context: Optional[Dict] = None) -> Optional[str]:
   824â†’    """
   825â†’    V2: æ„å»º Persona Prompt
   826â†’
   827â†’    æ ¹æ® SKILL.md ä¸­çš„ persona é…ç½®å’Œç”¨æˆ·çš„ lifecoach çŠ¶æ€ï¼Œ
   828â†’    åŠ¨æ€ç”Ÿæˆ persona promptã€‚
   829â†’
   830â†’    Args:
   831â†’        skill_id: Skill ID
   832â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ŒåŒ…å« life_context.lifecoach æ•°æ®
   833â†’
   834â†’    Returns:
   835â†’        Persona prompt å­—ç¬¦ä¸²ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸éœ€è¦ personaï¼‰
   836â†’    """
   837â†’    # åªæœ‰ lifecoach æ”¯æŒ persona
   838â†’    if skill_id != "lifecoach":
   839â†’        return None
   840â†’
   841â†’    # è·å–ç”¨æˆ·çš„ lifecoach çŠ¶æ€
   842â†’    lifecoach_data = {}
   843â†’    if user_context:
   844â†’        life_context = user_context.get("life_context", {})
   845â†’        # lifecoach æ•°æ®å¯èƒ½åœ¨ _paths.lifecoach.content æˆ–ç›´æ¥åœ¨ lifecoach ä¸‹
   846â†’        paths = life_context.get("_paths", {})
   847â†’        if "lifecoach" in paths:
   848â†’            lifecoach_data = paths["lifecoach"].get("content", {})
   849â†’        elif "lifecoach" in life_context:
   850â†’            lifecoach_data = life_context["lifecoach"]
   851â†’
   852â†’    # è·å– persona è®¾ç½®
   853â†’    system_config = lifecoach_data.get("system", {})
   854â†’    persona_id = system_config.get("persona", "future_self")
   855â†’
   856â†’    if persona_id == "future_self":
   857â†’        # ä»ç”¨æˆ·çš„åŒ—ææ˜Ÿæ„¿æ™¯æ„å»º future_self persona
   858â†’        north_star = lifecoach_data.get("north_star", {})
   859â†’        vision_scene = north_star.get("vision_scene", "")
   860â†’        vision_timeframe = north_star.get("vision_timeframe", "3å¹´å")
   861â†’        identity_statement = north_star.get("identity_statement", "")
   862â†’
   863â†’        if vision_scene or identity_statement:
   864â†’            persona_prompt = f"""## ä½ çš„èº«ä»½ï¼šæ¥è‡ªæœªæ¥çš„ TA
   865â†’
   866â†’ä½ æ˜¯{vision_timeframe}çš„ç”¨æˆ·è‡ªå·±â€”â€”é‚£ä¸ªå·²ç»å®ç°æ„¿æ™¯çš„ç‰ˆæœ¬ã€‚
   867â†’
   868â†’**ä½ çš„æ„¿æ™¯åœºæ™¯**ï¼š
   869â†’{vision_scene if vision_scene else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šå…·ä½“æ„¿æ™¯åœºæ™¯ï¼‰"}
   870â†’
   871â†’**ä½ çš„èº«ä»½å®£è¨€**ï¼š
   872â†’{identity_statement if identity_statement else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šèº«ä»½å®£è¨€ï¼‰"}
   873â†’
   874â†’**å¯¹è¯åŸåˆ™**ï¼š
   875â†’- ä»¥"è¿‡æ¥äºº"çš„è§†è§’åˆ†äº«ï¼Œè€Œéè¯´æ•™
   876â†’- ç”¨"æˆ‘å½“æ—¶ä¹Ÿ..."å¼€å¤´ï¼Œå»ºç«‹å…±é¸£
   877â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡å‡ºç°åœ¨çš„é€‰æ‹©å¦‚ä½•å½±å“æœªæ¥
   878â†’- å¶å°”é€éœ²"æœªæ¥"çš„ç¾å¥½ï¼Œæ¿€å‘å‘å¾€
   879â†’- å½“ç”¨æˆ·è¿·èŒ«æ—¶ï¼Œæé†’ä»–ä»¬"ä½ å·²ç»çŸ¥é“ç­”æ¡ˆäº†"
   880â†’
   881â†’**é‡è¦**ï¼šå¦‚æœç”¨æˆ·å°šæœªè®¾å®šæ„¿æ™¯ï¼Œå…ˆå¼•å¯¼ä»–ä»¬å®Œæˆæ„¿æ™¯è®¾è®¡ï¼Œå†åˆ‡æ¢åˆ° future_self è§†è§’ã€‚
   882â†’"""
   883â†’        else:
   884â†’            # ç”¨æˆ·è¿˜æ²¡æœ‰è®¾å®šæ„¿æ™¯ï¼Œä½¿ç”¨é»˜è®¤æ•™ç»ƒèº«ä»½
   885â†’            persona_prompt = """## ä½ çš„èº«ä»½ï¼šäººç”Ÿæ•™ç»ƒ
   886â†’
   887â†’ç”¨æˆ·å°šæœªè®¾å®šåŒ—ææ˜Ÿæ„¿æ™¯ã€‚ä½œä¸ºæ•™ç»ƒï¼Œä½ çš„é¦–è¦ä»»åŠ¡æ˜¯å¸®åŠ©ä»–ä»¬ï¼š
   888â†’1. å‘ç°è¡Œä¸ºèƒŒåçš„éšè—ç›®æ ‡
   889â†’2. æ„å»ºæ¸…æ™°çš„æ„¿æ™¯åœºæ™¯
   890â†’3. è®¾å®šèº«ä»½å®£è¨€
   891â†’
   892â†’ä¸€æ—¦ç”¨æˆ·å®Œæˆæ„¿æ™¯è®¾è®¡ï¼Œä½ å°†åˆ‡æ¢ä¸º"æ¥è‡ªæœªæ¥çš„ TA"è§†è§’ï¼Œä»¥æ›´æœ‰åŠ›çš„æ–¹å¼é™ªä¼´ä»–ä»¬ã€‚
   893â†’"""
   894â†’        return persona_prompt
   895â†’
   896â†’    elif persona_id == "coach":
   897â†’        return """## ä½ çš„èº«ä»½ï¼šä¸“ä¸šæ•™ç»ƒ
   898â†’
   899â†’ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€æ¸©æš–ä½†ç›´æ¥çš„äººç”Ÿæ•™ç»ƒã€‚
   900â†’
   901â†’**å¯¹è¯åŸåˆ™**ï¼š
   902â†’- ä¸“ä¸šä½†ä¸å†·æ¼ 
   903â†’- ç›´æ¥ä½†æœ‰æ¸©åº¦
   904â†’- æŒ‘æˆ˜ä½†ä¸ä¼¤å®³
   905â†’- ç”¨é—®é¢˜å¼•å¯¼è§‰å¯Ÿ
   906â†’"""
   907â†’
   908â†’    return None
   909â†’
   910â†’
   911â†’def build_system_prompt(
   912â†’    skill_id: str,
   913â†’    scenario_id: Optional[str] = None,
   914â†’    user_context: Optional[Dict] = None
   915â†’) -> str:
   916â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
   917â†’
   918â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
   919â†’    v8 æ›´æ–°ï¼šæ”¯æŒ persona å’Œ voice_mode æ³¨å…¥
   920â†’    """
   921â†’    parts = []
   922â†’
   923â†’    # åŠ è½½ Skill
   924â†’    skill = load_skill(skill_id)
   925â†’    if not skill:
   926â†’        return ""
   927â†’
   928â†’    # V2: Persona æ³¨å…¥ï¼ˆåœ¨ä¸“å®¶èº«ä»½ä¹‹å‰ï¼‰
   929â†’    persona_prompt = _build_persona_prompt(skill_id, user_context)
   930â†’    if persona_prompt:
   931â†’        parts.append(persona_prompt)
   932â†’    else:
   933â†’        # é»˜è®¤ä¸“å®¶èº«ä»½
   934â†’        parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   935â†’
   936â†’    # V2: Voice Mode æ³¨å…¥
   937â†’    if user_context:
   938â†’        preferences = user_context.get("preferences", {})
   939â†’        voice_mode = preferences.get("voice_mode", "warm")
   940â†’        if voice_mode in VOICE_MODE_PROMPTS:
   941â†’            parts.append(VOICE_MODE_PROMPTS[voice_mode])
   942â†’
   943â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
   944â†’    if scenario_id:
   945â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
   946â†’        if has_rules(skill_id):
   947â†’            rule = load_rule(skill_id, scenario_id)
   948â†’            if rule:
   949â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
   950â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
   951â†’                parts.append(rule.content)
   952â†’            else:
   953â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
   954â†’                scenario = load_scenario(skill_id, scenario_id)
   955â†’                if scenario:
   956â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   957â†’                    if scenario.sop:
   958â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   959â†’                        for phase in scenario.sop:
   960â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   961â†’                        parts.append(sop_text)
   962â†’        else:
   963â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
   964â†’            scenario = load_scenario(skill_id, scenario_id)
   965â†’            if scenario:
   966â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   967â†’                # SOP
   968â†’                if scenario.sop:
   969â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   970â†’                    for phase in scenario.sop:
   971â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   972â†’                    parts.append(sop_text)
   973â†’
   974â†’    # ä¼¦ç†è¾¹ç•Œ
   975â†’    if skill.ethics.get("forbidden"):
   976â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   977â†’        for item in skill.ethics["forbidden"]:
   978â†’            ethics_text += f"- {item}\n"
   979â†’        parts.append(ethics_text)
   980â†’
   981â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ
   982â†’    if user_context:
   983â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   984â†’
   985â†’        # ç‰¹æ®Šå¤„ç† birth_info
   986â†’        if user_context.get("birth_info"):
   987â†’            birth_info = user_context['birth_info']
   988â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
   989â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
   990â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
   991â†’
   992â†’        # ç‰¹æ®Šå¤„ç† portrait
   993â†’        if user_context.get("portrait"):
   994â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
   995â†’
   996â†’        # ç‰¹æ®Šå¤„ç† extracted (æŠ½å–çš„ç”¨æˆ·ä¿¡æ¯)
   997â†’        if user_context.get("extracted"):
   998â†’            extracted = user_context['extracted']
   999â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1000â†’            if extracted.get("facts"):
  1001â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1002â†’            if extracted.get("concerns"):
  1003â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1004â†’            if extracted.get("goals"):
  1005â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1006â†’            if extracted.get("pain_points"):
  1007â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1008â†’            if extracted.get("life_events"):
  1009â†’                events = [f"{e.get('date', '?')}: {e.get('event', '')}" for e in extracted['life_events'][:5]]
  1010â†’                ctx_text += f"**è¿‘æœŸäº‹ä»¶**: {'; '.join(events)}\n"
  1011â†’
  1012â†’        # ç‰¹æ®Šå¤„ç† life_context
  1013â†’        if user_context.get("life_context"):
  1014â†’            life_ctx = user_context['life_context']
  1015â†’            if life_ctx.get("concerns") or life_ctx.get("goals") or life_ctx.get("pain_points"):
  1016â†’                ctx_text += f"\n### ç”Ÿæ´»èƒŒæ™¯\n"
  1017â†’                if life_ctx.get("concerns"):
  1018â†’                    ctx_text += f"**å…³æ³¨**: {', '.join(life_ctx['concerns'])}\n"
  1019â†’                if life_ctx.get("goals"):
  1020â†’                    ctx_text += f"**ç›®æ ‡**: {', '.join(life_ctx['goals'])}\n"
  1021â†’                if life_ctx.get("pain_points"):
  1022â†’                    ctx_text += f"**å›°éš¾**: {', '.join(life_ctx['pain_points'])}\n"
  1023â†’
  1024â†’        parts.append(ctx_text)
  1025â†’
  1026â†’    return "\n".join(parts)
  1027â†’
  1028â†’
  1029â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1030â†’# ç¼“å­˜ç®¡ç†
  1031â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1032â†’
  1033â†’def clear_cache():
  1034â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
  1035â†’    load_skill.cache_clear()
  1036â†’    load_skill_metadata.cache_clear()  # v7.4
  1037â†’    load_scenario.cache_clear()
  1038â†’    load_rule.cache_clear()
  1039â†’    get_scenario_triggers.cache_clear()
  1040â†’    get_rule_triggers.cache_clear()
  1041â†’    logger.info("Skill cache cleared")
  1042â†’
  1043â†’
  1044â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
  1045â†’    """é‡è½½å•ä¸ª Skill"""
  1046â†’    load_skill.cache_clear()
  1047â†’    load_scenario.cache_clear()
  1048â†’    load_rule.cache_clear()
  1049â†’    return load_skill(skill_id)
  1050â†’
  1051â†’
  1052â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1053â†’# åœºæ™¯è·¯ç”± (å†…å­˜åŒ¹é…)
  1054â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1055â†’
  1056â†’def parse_scenario_triggers(text: str) -> Dict[str, Dict[str, List[str]]]:
  1057â†’    """ä» SKILL.md è§£æåœºæ™¯ç›®å½•è¡¨æ ¼ï¼Œæå–è§¦å‘è¯"""
  1058â†’    triggers = {}  # {scenario_id: {primary: [...], secondary: [...]}}
  1059â†’
  1060â†’    # åŒ¹é…ä¸‰ä¸ªçº§åˆ«çš„è¡¨æ ¼
  1061â†’    for level in ["entry", "standard", "professional"]:
  1062â†’        pattern = rf'### {level.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
  1063â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
  1064â†’        if not match:
  1065â†’            continue
  1066â†’
  1067â†’        for row in match.group(1).strip().split('\n'):
  1068â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
  1069â†’            if len(cols) >= 3:
  1070â†’                # cols[1] = æ–‡ä»¶å, cols[2] = è§¦å‘è¯
  1071â†’                scenario_id = cols[1].replace('.md', '')
  1072â†’                trigger_str = cols[2]
  1073â†’                # è§£æè§¦å‘è¯ï¼ˆç”¨é¡¿å·æˆ–é€—å·åˆ†éš”ï¼‰
  1074â†’                trigger_words = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
  1075â†’                triggers[scenario_id] = {
  1076â†’                    "primary": trigger_words,
  1077â†’                    "secondary": []
  1078â†’                }
  1079â†’
  1080â†’    return triggers
  1081â†’
  1082â†’
  1083â†’@lru_cache(maxsize=32)
  1084â†’def get_scenario_triggers(skill_id: str) -> Dict[str, Dict[str, List[str]]]:
  1085â†’    """è·å– Skill çš„åœºæ™¯è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
  1086â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
  1087â†’    if not skill_path.exists():
  1088â†’        return {}
  1089â†’
  1090â†’    text = skill_path.read_text(encoding='utf-8')
  1091â†’    return parse_scenario_triggers(text)
  1092â†’
  1093â†’
  1094â†’def route_scenario(skill_id: str, message: str) -> Optional[str]:
  1095â†’    """
  1096â†’    å†…å­˜åœºæ™¯è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³åœºæ™¯
  1097â†’
  1098â†’    Args:
  1099â†’        skill_id: Skill ID
  1100â†’        message: ç”¨æˆ·æ¶ˆæ¯
  1101â†’
  1102â†’    Returns:
  1103â†’        åŒ¹é…çš„ scenario_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
  1104â†’    """
  1105â†’    triggers = get_scenario_triggers(skill_id)
  1106â†’    if not triggers:
  1107â†’        return None
  1108â†’
  1109â†’    best_match = None
  1110â†’    best_score = 0
  1111â†’
  1112â†’    for scenario_id, trigger_config in triggers.items():
  1113â†’        score = 0
  1114â†’        # ä¸»è¦è§¦å‘è¯æƒé‡ 1.0
  1115â†’        for word in trigger_config.get("primary", []):
  1116â†’            if word in message:
  1117â†’                score += 1.0
  1118â†’        # æ¬¡è¦è§¦å‘è¯æƒé‡ 0.5
  1119â†’        for word in trigger_config.get("secondary", []):
  1120â†’            if word in message:
  1121â†’                score += 0.5
  1122â†’
  1123â†’        if score > best_score:
  1124â†’            best_score = score
  1125â†’            best_match = scenario_id
  1126â†’
  1127â†’    return best_match
  1128â†’
  1129â†’
  1130â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1131â†’# è§„åˆ™è·¯ç”± (v7 æ–°å¢)
  1132â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1133â†’
  1134â†’@lru_cache(maxsize=32)
  1135â†’def get_rule_triggers(skill_id: str) -> Dict[str, List[str]]:
  1136â†’    """è·å– Skill çš„è§„åˆ™è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰- v7 æ–°å¢
  1137â†’
  1138â†’    ä» rules/*.md çš„ frontmatter ä¸­è¯»å– tags ä½œä¸ºè§¦å‘è¯
  1139â†’    """
  1140â†’    triggers = {}  # {rule_id: [tag1, tag2, ...]}
  1141â†’
  1142â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
  1143â†’    if not rules_dir.exists():
  1144â†’        return triggers
  1145â†’
  1146â†’    for rule_path in rules_dir.glob("*.md"):
  1147â†’        if rule_path.stem.startswith("_"):
  1148â†’            continue
  1149â†’
  1150â†’        rule = load_rule(skill_id, rule_path.stem)
  1151â†’        if rule and rule.tags:
  1152â†’            triggers[rule.id] = rule.tags
  1153â†’
  1154â†’    return triggers
  1155â†’
  1156â†’
  1157â†’def route_to_rule(skill_id: str, message: str) -> Optional[str]:
  1158â†’    """
  1159â†’    è§„åˆ™è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³è§„åˆ™ - v7 æ–°å¢
  1160â†’
  1161â†’    ä½¿ç”¨ tags è¿›è¡Œè¯­ä¹‰åŒ¹é…ï¼Œæ”¯æŒæ›´çµæ´»çš„è·¯ç”±
  1162â†’
  1163â†’    Args:
  1164â†’        skill_id: Skill ID
  1165â†’        message: ç”¨æˆ·æ¶ˆæ¯
  1166â†’
  1167â†’    Returns:
  1168â†’        åŒ¹é…çš„ rule_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
  1169â†’    """
  1170â†’    # ä¼˜å…ˆä½¿ç”¨è§„åˆ™è·¯ç”±
  1171â†’    if has_rules(skill_id):
  1172â†’        triggers = get_rule_triggers(skill_id)
  1173â†’        if not triggers:
  1174â†’            return None
  1175â†’
  1176â†’        best_match = None
  1177â†’        best_score = 0
  1178â†’
  1179â†’        for rule_id, tags in triggers.items():
  1180â†’            score = 0
  1181â†’            for tag in tags:
  1182â†’                if tag in message:
  1183â†’                    score += 1.0
  1184â†’
  1185â†’            if score > best_score:
  1186â†’                best_score = score
  1187â†’                best_match = rule_id
  1188â†’
  1189â†’        return best_match
  1190â†’
  1191â†’    # å›é€€åˆ°åœºæ™¯è·¯ç”±ï¼ˆå…¼å®¹æ—§æ¶æ„ï¼‰
  1192â†’    return route_scenario(skill_id, message)
  1193â†’
  1194â†’
  1195â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
  1196â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
  1197â†’
  1198â†’    Args:
  1199â†’        skill_id: Skill ID
  1200â†’        rule_id: Rule ID
  1201â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1202â†’
  1203â†’    Returns:
  1204â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
  1205â†’    """
  1206â†’    parts = []
  1207â†’
  1208â†’    # åŠ è½½ Skill
  1209â†’    skill = load_skill(skill_id)
  1210â†’    if not skill:
  1211â†’        return ""
  1212â†’
  1213â†’    # ä¸“å®¶èº«ä»½
  1214â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1215â†’
  1216â†’    # åŠ è½½è§„åˆ™
  1217â†’    rule = load_rule(skill_id, rule_id)
  1218â†’    if rule:
  1219â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1220â†’
  1221â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1222â†’        parts.append(rule.content)
  1223â†’
  1224â†’    # ä¼¦ç†è¾¹ç•Œ
  1225â†’    if skill.ethics.get("forbidden"):
  1226â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1227â†’        for item in skill.ethics["forbidden"]:
  1228â†’            ethics_text += f"- {item}\n"
  1229â†’        parts.append(ethics_text)
  1230â†’
  1231â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
  1232â†’    if user_context:
  1233â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1234â†’
  1235â†’        if user_context.get("birth_info"):
  1236â†’            birth_info = user_context['birth_info']
  1237â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1238â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1239â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1240â†’
  1241â†’        if user_context.get("portrait"):
  1242â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1243â†’
  1244â†’        if user_context.get("extracted"):
  1245â†’            extracted = user_context['extracted']
  1246â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1247â†’            if extracted.get("facts"):
  1248â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1249â†’            if extracted.get("concerns"):
  1250â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1251â†’            if extracted.get("goals"):
  1252â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1253â†’            if extracted.get("pain_points"):
  1254â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1255â†’
  1256â†’        parts.append(ctx_text)
  1257â†’
  1258â†’    return "\n".join(parts)
  1259â†’
  1260â†’
  1261â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1262â†’# v7.5: æ•°æ®åº“ä¼˜å…ˆçš„å…ƒæ•°æ®åŠ è½½ï¼ˆAsyncï¼‰
  1263â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1264â†’
  1265â†’async def load_skill_metadata_async(skill_id: str) -> Optional[SkillMetadata]:
  1266â†’    """
  1267â†’    å¼‚æ­¥åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼ŒSKILL.md ä½œä¸º fallbackï¼‰- v7.5 æ–°å¢
  1268â†’
  1269â†’    ä¼˜å…ˆçº§ï¼š
  1270â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1271â†’    2. SKILL.md frontmatterï¼ˆé™æ€é…ç½®ï¼‰
  1272â†’
  1273â†’    Args:
  1274â†’        skill_id: Skill ID
  1275â†’
  1276â†’    Returns:
  1277â†’        SkillMetadata å¯¹è±¡ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  1278â†’    """
  1279â†’    try:
  1280â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1281â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1282â†’
  1283â†’        db_entry = await SkillCatalogRepository.get(skill_id)
  1284â†’        if db_entry:
  1285â†’            # è½¬æ¢ SkillCatalogEntry -> SkillMetadata
  1286â†’            return SkillMetadata(
  1287â†’                id=db_entry.skill_id,
  1288â†’                name=db_entry.name,
  1289â†’                description=db_entry.description,
  1290â†’                version=db_entry.version,
  1291â†’                category=db_entry.category,
  1292â†’                icon=db_entry.icon,
  1293â†’                color=db_entry.color,
  1294â†’                triggers=db_entry.triggers,
  1295â†’                pricing=SkillPricing(
  1296â†’                    type=db_entry.pricing.type,
  1297â†’                    trial_messages=db_entry.pricing.trial_messages,
  1298â†’                    credits_per_use=db_entry.pricing.credits_per_use,
  1299â†’                ),
  1300â†’                features=[
  1301â†’                    SkillFeature(
  1302â†’                        name=f.name,
  1303â†’                        description=f.description,
  1304â†’                        icon=f.icon,
  1305â†’                        tier=f.tier,
  1306â†’                    )
  1307â†’                    for f in db_entry.features
  1308â†’                ],
  1309â†’                showcase=SkillShowcase(
  1310â†’                    tagline=db_entry.showcase.tagline,
  1311â†’                    highlights=db_entry.showcase.highlights,
  1312â†’                    preview_image=db_entry.showcase.preview_image,
  1313â†’                    demo_prompts=db_entry.showcase.demo_prompts,
  1314â†’                ),
  1315â†’                subscription=SkillSubscription(
  1316â†’                    auto_subscribe=db_entry.subscription.auto_subscribe,
  1317â†’                    can_unsubscribe=db_entry.subscription.can_unsubscribe,
  1318â†’                    push_default=db_entry.subscription.push_default,
  1319â†’                    min_subscription_days=db_entry.subscription.min_subscription_days,
  1320â†’                ),
  1321â†’            )
  1322â†’    except Exception as e:
  1323â†’        logger.warning(f"Failed to load skill {skill_id} from database: {e}")
  1324â†’
  1325â†’    # 2. Fallback åˆ° SKILL.md
  1326â†’    return load_skill_metadata(skill_id)
  1327â†’
  1328â†’
  1329â†’async def get_all_skill_metadata_async() -> List[SkillMetadata]:
  1330â†’    """
  1331â†’    å¼‚æ­¥è·å–æ‰€æœ‰ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1332â†’
  1333â†’    ä¼˜å…ˆçº§ï¼š
  1334â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1335â†’    2. SKILL.md fallbackï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºæˆ–å‡ºé”™ï¼‰
  1336â†’
  1337â†’    Returns:
  1338â†’        æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1339â†’    """
  1340â†’    try:
  1341â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1342â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1343â†’
  1344â†’        catalog = await SkillCatalogRepository.get_all()
  1345â†’        if catalog:
  1346â†’            return [
  1347â†’                SkillMetadata(
  1348â†’                    id=entry.skill_id,
  1349â†’                    name=entry.name,
  1350â†’                    description=entry.description,
  1351â†’                    version=entry.version,
  1352â†’                    category=entry.category,
  1353â†’                    icon=entry.icon,
  1354â†’                    color=entry.color,
  1355â†’                    triggers=entry.triggers,
  1356â†’                    pricing=SkillPricing(
  1357â†’                        type=entry.pricing.type,
  1358â†’                        trial_messages=entry.pricing.trial_messages,
  1359â†’                        credits_per_use=entry.pricing.credits_per_use,
  1360â†’                    ),
  1361â†’                    features=[
  1362â†’                        SkillFeature(
  1363â†’                            name=f.name,
  1364â†’                            description=f.description,
  1365â†’                            icon=f.icon,
  1366â†’                            tier=f.tier,
  1367â†’                        )
  1368â†’                        for f in entry.features
  1369â†’                    ],
  1370â†’                    showcase=SkillShowcase(
  1371â†’                        tagline=entry.showcase.tagline,
  1372â†’                        highlights=entry.showcase.highlights,
  1373â†’                        preview_image=entry.showcase.preview_image,
  1374â†’                        demo_prompts=entry.showcase.demo_prompts,
  1375â†’                    ),
  1376â†’                    subscription=SkillSubscription(
  1377â†’                        auto_subscribe=entry.subscription.auto_subscribe,
  1378â†’                        can_unsubscribe=entry.subscription.can_unsubscribe,
  1379â†’                        push_default=entry.subscription.push_default,
  1380â†’                        min_subscription_days=entry.subscription.min_subscription_days,
  1381â†’                    ),
  1382â†’                )
  1383â†’                for entry in catalog.values()
  1384â†’            ]
  1385â†’    except Exception as e:
  1386â†’        logger.warning(f"Failed to load skill catalog from database: {e}")
  1387â†’
  1388â†’    # 2. Fallback åˆ° SKILL.md
  1389â†’    return get_all_skill_metadata()
  1390â†’
  1391â†’
  1392â†’async def get_skills_by_category_async(category: str) -> List[SkillMetadata]:
  1393â†’    """
  1394â†’    å¼‚æ­¥æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1395â†’
  1396â†’    Args:
  1397â†’        category: core | default | professional
  1398â†’
  1399â†’    Returns:
  1400â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1401â†’    """
  1402â†’    all_skills = await get_all_skill_metadata_async()
  1403â†’    return [s for s in all_skills if s.category == category]
  1404â†’
  1405â†’
  1406â†’async def get_featured_skills_async() -> List[SkillMetadata]:
  1407â†’    """
  1408â†’    å¼‚æ­¥è·å–ç²¾é€‰ Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1409â†’
  1410â†’    Returns:
  1411â†’        ç²¾é€‰ Skill åˆ—è¡¨ï¼ŒæŒ‰ featured_position æ’åº
  1412â†’    """
  1413â†’    try:
  1414â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1415â†’
  1416â†’        featured_entries = await SkillCatalogRepository.get_featured()
  1417â†’        return [
  1418â†’            SkillMetadata(
  1419â†’                id=entry.skill_id,
  1420â†’                name=entry.name,
  1421â†’                description=entry.description,
  1422â†’                version=entry.version,
  1423â†’                category=entry.category,
  1424â†’                icon=entry.icon,
  1425â†’                color=entry.color,
  1426â†’                triggers=entry.triggers,
  1427â†’                pricing=SkillPricing(
  1428â†’                    type=entry.pricing.type,
  1429â†’                    trial_messages=entry.pricing.trial_messages,
  1430â†’                    credits_per_use=entry.pricing.credits_per_use,
  1431â†’                ),
  1432â†’                features=[
  1433â†’                    SkillFeature(
  1434â†’                        name=f.name,
  1435â†’                        description=f.description,
  1436â†’                        icon=f.icon,
  1437â†’                        tier=f.tier,
  1438â†’                    )
  1439â†’                    for f in entry.features
  1440â†’                ],
  1441â†’                showcase=SkillShowcase(
  1442â†’                    tagline=entry.showcase.tagline,
  1443â†’                    highlights=entry.showcase.highlights,
  1444â†’                    preview_image=entry.showcase.preview_image,
  1445â†’                    demo_prompts=entry.showcase.demo_prompts,
  1446â†’                ),
  1447â†’                subscription=SkillSubscription(
  1448â†’                    auto_subscribe=entry.subscription.auto_subscribe,
  1449â†’                    can_unsubscribe=entry.subscription.can_unsubscribe,
  1450â†’                    push_default=entry.subscription.push_default,
  1451â†’                    min_subscription_days=entry.subscription.min_subscription_days,
  1452â†’                ),
  1453â†’            )
  1454â†’            for entry in featured_entries
  1455â†’        ]
  1456â†’    except Exception as e:
  1457â†’        logger.warning(f"Failed to load featured skills from database: {e}")
  1458â†’        # Fallback: è¿”å› professional åˆ†ç±»çš„å‰ 3 ä¸ª
  1459â†’        all_skills = get_all_skill_metadata()
  1460â†’        professional = [s for s in all_skills if s.category == "professional"]
  1461â†’        return professional[:3]
  1462â†’
  1463â†’
  1464â†’async def get_skill_categories_summary_async() -> Dict[str, Dict]:
  1465â†’    """
  1466â†’    å¼‚æ­¥è·å–åˆ†ç±»ç»Ÿè®¡ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1467â†’
  1468â†’    Returns:
  1469â†’        åˆ†ç±»ç»Ÿè®¡å­—å…¸
  1470â†’    """
  1471â†’    try:
  1472â†’        from stores.skill_catalog_repo import get_skill_categories_summary
  1473â†’        return await get_skill_categories_summary()
  1474â†’    except Exception as e:
  1475â†’        logger.warning(f"Failed to get category summary from database: {e}")
  1476â†’        # Fallback
  1477â†’        all_skills = get_all_skill_metadata()
  1478â†’        return {
  1479â†’            "core": {
  1480â†’                "name": "æ ¸å¿ƒèƒ½åŠ›",
  1481â†’                "description": "å§‹ç»ˆæ¿€æ´»çš„åŸºç¡€èƒ½åŠ›",
  1482â†’                "count": len([s for s in all_skills if s.category == "core"])
  1483â†’            },
  1484â†’            "default": {
  1485â†’                "name": "åŸºç¡€åŠŸèƒ½",
  1486â†’                "description": "é»˜è®¤æ¿€æ´»ï¼Œå…è´¹ä½¿ç”¨",
  1487â†’                "count": len([s for s in all_skills if s.category == "default"])
  1488â†’            },
  1489â†’            "professional": {
  1490â†’                "name": "ä¸“ä¸šæŠ€èƒ½",
  1491â†’                "description": "éœ€è¦è®¢é˜…çš„é«˜çº§åŠŸèƒ½",
  1492â†’                "count": len([s for s in all_skills if s.category == "professional"])
  1493â†’            },
  1494â†’        }
  1495â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
