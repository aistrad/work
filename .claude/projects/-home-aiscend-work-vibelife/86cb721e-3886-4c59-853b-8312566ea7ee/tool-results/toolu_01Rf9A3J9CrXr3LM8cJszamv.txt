     1→"""
     2→Tools v6 - 标准化工具系统
     3→
     4→工具类型：
     5→- collect: 信息收集（表单 + 自然语言）
     6→- calculate: 确定性计算
     7→- display: 结果展示（映射到前端卡片）
     8→- search: 知识检索
     9→
    10→每个工具都有 card_type 映射到前端组件。
    11→"""
    12→import logging
    13→from typing import List, Dict, Any, Optional
    14→from dataclasses import dataclass, field
    15→from enum import Enum
    16→
    17→logger = logging.getLogger(__name__)
    18→
    19→
    20→class ToolType(str, Enum):
    21→    """工具类型"""
    22→    COLLECT = "collect"
    23→    CALCULATE = "calculate"
    24→    DISPLAY = "display"
    25→    SEARCH = "search"
    26→
    27→
    28→@dataclass
    29→class ToolMetadata:
    30→    """工具元数据"""
    31→    name: str
    32→    description: str
    33→    tool_type: ToolType
    34→    parameters: Dict[str, Any]
    35→    card_type: Optional[str] = None
    36→    card_props_schema: Optional[Dict] = None
    37→    when_to_call: Optional[str] = None
    38→
    39→
    40→# ═══════════════════════════════════════════════════════════════════════════
    41→# V6 全局工具
    42→# ═══════════════════════════════════════════════════════════════════════════
    43→
    44→SEARCH_DB_TOOL = {
    45→    "type": "function",
    46→    "function": {
    47→        "name": "search_db",
    48→        "description": """从数据库检索知识或案例。
    49→
    50→根据分析需要调用此工具检索相关信息：
    51→- 需要专业知识时：table="knowledge_chunks"
    52→- 需要参考案例时：table="cases"
    53→
    54→LLM 根据 SOP 自己判断何时需要检索，检索什么内容。""",
    55→        "parameters": {
    56→            "type": "object",
    57→            "properties": {
    58→                "table": {
    59→                    "type": "string",
    60→                    "enum": ["knowledge_chunks", "cases"],
    61→                    "description": "要查询的表"
    62→                },
    63→                "query": {
    64→                    "type": "string",
    65→                    "description": "检索查询词"
    66→                },
    67→                "filters": {
    68→                    "type": "object",
    69→                    "description": "可选过滤条件，如 skill_id, scenario_id, tags 等"
    70→                },
    71→                "top_k": {
    72→                    "type": "integer",
    73→                    "default": 5,
    74→                    "description": "返回结果数量"
    75→                }
    76→            },
    77→            "required": ["table", "query"]
    78→        }
    79→    },
    80→    "_metadata": {
    81→        "tool_type": "search",
    82→        "card_type": None
    83→    }
    84→}
    85→
    86→ASK_USER_QUESTION_TOOL = {
    87→    "type": "function",
    88→    "function": {
    89→        "name": "ask_user_question",
    90→        "description": """主动向用户提问以获取更多信息。
    91→
    92→何时调用：
    93→- 用户意图不明确，需要澄清
    94→- 需要用户做出选择
    95→- 缺少必要信息无法继续
    96→
    97→提问原则：
    98→- 问题要具体、明确
    99→- 提供选项时不超过4个
   100→- 避免连续追问""",
   101→        "parameters": {
   102→            "type": "object",
   103→            "properties": {
   104→                "question": {
   105→                    "type": "string",
   106→                    "description": "要问用户的问题"
   107→                },
   108→                "options": {
   109→                    "type": "array",
   110→                    "items": {"type": "string"},
   111→                    "description": "可选的选项列表（最多4个）"
   112→                }
   113→            },
   114→            "required": ["question"]
   115→        }
   116→    },
   117→    "_metadata": {
   118→        "tool_type": "collect",
   119→        "card_type": "question_card"
   120→    }
   121→}
   122→
   123→SHOW_SERVICE_MENU_TOOL = {
   124→    "type": "function",
   125→    "function": {
   126→        "name": "show_service_menu",
   127→        "description": """展示服务目录卡片。
   128→
   129→何时调用：
   130→- 新用户首次进入
   131→- 用户询问"有什么服务"
   132→- 用户表现出不知道如何开始""",
   133→        "parameters": {
   134→            "type": "object",
   135→            "properties": {
   136→                "services": {
   137→                    "type": "array",
   138→                    "items": {
   139→                        "type": "object",
   140→                        "properties": {
   141→                            "id": {"type": "string"},
   142→                            "name": {"type": "string"},
   143→                            "description": {"type": "string"},
   144→                            "icon": {"type": "string"}
   145→                        }
   146→                    },
   147→                    "description": "服务列表"
   148→                }
   149→            },
   150→            "required": ["services"]
   151→        }
   152→    },
   153→    "_metadata": {
   154→        "tool_type": "display",
   155→        "card_type": "service_menu"
   156→    }
   157→}
   158→
   159→# ═══════════════════════════════════════════════════════════════════════════
   160→# 服务发现工具
   161→# ═══════════════════════════════════════════════════════════════════════════
   162→
   163→SHOW_SKILL_SERVICES_TOOL = {
   164→    "type": "function",
   165→    "function": {
   166→        "name": "show_skill_services",
   167→        "description": """展示当前 Skill 的服务目录。
   168→
   169→何时调用：
   170→- 用户主动选择进入某个 Skill 时（如点击入口）
   171→- 用户询问"你能做什么"、"有什么服务"时
   172→- 用户表现出不知道如何开始时
   173→
   174→何时不调用：
   175→- 用户已经有明确需求时（如"帮我看看命盘"）
   176→- 对话已经在进行中时""",
   177→        "parameters": {
   178→            "type": "object",
   179→            "properties": {
   180→                "skill_id": {
   181→                    "type": "string",
   182→                    "description": "Skill ID (bazi/zodiac/tarot/career)"
   183→                }
   184→            },
   185→            "required": ["skill_id"]
   186→        }
   187→    },
   188→    "_metadata": {
   189→        "tool_type": "display",
   190→        "card_type": "skill_services",
   191→        "when_to_call": "用户主动进入Skill或询问有什么服务时"
   192→    }
   193→}
   194→
   195→RECOMMEND_SERVICE_TOOL = {
   196→    "type": "function",
   197→    "function": {
   198→        "name": "recommend_service",
   199→        "description": """根据对话上下文，向用户推荐相关的升级服务。
   200→
   201→何时调用：
   202→- 完成一个 entry 级别服务后，检测到用户可能需要更深入分析
   203→- 用户表现出对某个话题的持续关注
   204→- 用户的问题超出当前服务范围
   205→
   206→推荐原则：
   207→- 一次只推荐一个最相关的服务
   208→- 推荐要自然，不能太商业化
   209→- 用户可以选择忽略""",
   210→        "parameters": {
   211→            "type": "object",
   212→            "properties": {
   213→                "scenario_id": {
   214→                    "type": "string",
   215→                    "description": "推荐的场景 ID"
   216→                },
   217→                "reason": {
   218→                    "type": "string",
   219→                    "description": "推荐理由（对用户可见）"
   220→                },
   221→                "highlights": {
   222→                    "type": "array",
   223→                    "items": {"type": "string"},
   224→                    "description": "服务亮点（2-3个）"
   225→                }
   226→            },
   227→            "required": ["scenario_id", "reason"]
   228→        }
   229→    },
   230→    "_metadata": {
   231→        "tool_type": "display",
   232→        "card_type": "service_recommendation",
   233→        "when_to_call": "完成基础服务后推荐升级服务"
   234→    }
   235→}
   236→
   237→# ═══════════════════════════════════════════════════════════════════════════
   238→# 通用工具
   239→# ═══════════════════════════════════════════════════════════════════════════
   240→
   241→REQUEST_INFO_TOOL = {
   242→    "type": "function",
   243→    "function": {
   244→        "name": "request_info",
   245→        "description": "向用户请求信息。当需要收集出生信息或其他必要信息时调用。",
   246→        "parameters": {
   247→            "type": "object",
   248→            "properties": {
   249→                "info_type": {
   250→                    "type": "string",
   251→                    "enum": ["birth", "context", "goals", "concerns"],
   252→                    "description": "信息类型"
   253→                },
   254→                "question": {
   255→                    "type": "string",
   256→                    "description": "自定义问题（可选）"
   257→                }
   258→            },
   259→            "required": ["info_type"]
   260→        }
   261→    },
   262→    "_metadata": {
   263→        "tool_type": "collect",
   264→        "card_type": "collect_form"
   265→    }
   266→}
   267→
   268→SHOW_INSIGHT_TOOL = {
   269→    "type": "function",
   270→    "function": {
   271→        "name": "show_insight",
   272→        "description": "展示洞察卡片。当需要突出关键发现或建议时调用。",
   273→        "parameters": {
   274→            "type": "object",
   275→            "properties": {
   276→                "insight_type": {
   277→                    "type": "string",
   278→                    "enum": ["career", "relationship", "fortune", "health", "general"],
   279→                    "description": "洞察类型"
   280→                },
   281→                "title": {
   282→                    "type": "string",
   283→                    "description": "洞察标题"
   284→                },
   285→                "content": {
   286→                    "type": "string",
   287→                    "description": "洞察内容"
   288→                }
   289→            },
   290→            "required": ["insight_type", "title", "content"]
   291→        }
   292→    },
   293→    "_metadata": {
   294→        "tool_type": "display",
   295→        "card_type": "insight_card"
   296→    }
   297→}
   298→
   299→SHOW_REPORT_TOOL = {
   300→    "type": "function",
   301→    "function": {
   302→        "name": "show_report",
   303→        "description": "展示完整报告。当用户想查看详细分析报告时调用。",
   304→        "parameters": {
   305→            "type": "object",
   306→            "properties": {
   307→                "report_type": {
   308→                    "type": "string",
   309→                    "enum": ["lite", "full"],
   310→                    "description": "报告类型",
   311→                    "default": "lite"
   312→                }
   313→            }
   314→        }
   315→    },
   316→    "_metadata": {
   317→        "tool_type": "display",
   318→        "card_type": "report_card"
   319→    }
   320→}
   321→
   322→# ═══════════════════════════════════════════════════════════════════════════
   323→# Bazi 工具
   324→# ═══════════════════════════════════════════════════════════════════════════
   325→
   326→COLLECT_BAZI_INFO_TOOL = {
   327→    "type": "function",
   328→    "function": {
   329→        "name": "collect_bazi_info",
   330→        "description": "收集用户出生信息用于八字排盘。",
   331→        "parameters": {
   332→            "type": "object",
   333→            "properties": {
   334→                "include_question": {
   335→                    "type": "boolean",
   336→                    "description": "是否同时收集用户问题",
   337→                    "default": True
   338→                }
   339→            }
   340→        }
   341→    },
   342→    "_metadata": {
   343→        "tool_type": "collect",
   344→        "card_type": "collect_form",
   345→        "card_props_schema": {
   346→            "form_fields": [
   347→                {"name": "birth_date", "type": "date", "label": "出生日期", "required": True},
   348→                {"name": "birth_time", "type": "time", "label": "出生时间", "required": True},
   349→                {"name": "birth_place", "type": "location", "label": "出生地点", "required": False}
   350→            ],
   351→            "allow_text_input": True,
   352→            "text_input_placeholder": "请描述你当前的困惑或想了解的问题..."
   353→        }
   354→    }
   355→}
   356→
   357→CALCULATE_BAZI_TOOL = {
   358→    "type": "function",
   359→    "function": {
   360→        "name": "calculate_bazi",
   361→        "description": "计算八字命盘。在有出生信息后调用。",
   362→        "parameters": {
   363→            "type": "object",
   364→            "properties": {
   365→                "include_dayun": {
   366→                    "type": "boolean",
   367→                    "description": "是否包含大运",
   368→                    "default": True
   369→                }
   370→            }
   371→        }
   372→    },
   373→    "_metadata": {
   374→        "tool_type": "calculate",
   375→        "card_type": None
   376→    }
   377→}
   378→
   379→SHOW_BAZI_CHART_TOOL = {
   380→    "type": "function",
   381→    "function": {
   382→        "name": "show_bazi_chart",
   383→        "description": "展示八字命盘图。当用户想查看命盘时调用。",
   384→        "parameters": {
   385→            "type": "object",
   386→            "properties": {
   387→                "show_details": {
   388→                    "type": "boolean",
   389→                    "description": "是否显示详细信息",
   390→                    "default": True
   391→                }
   392→            }
   393→        }
   394→    },
   395→    "_metadata": {
   396→        "tool_type": "display",
   397→        "card_type": "bazi_chart",
   398→        "when_to_call": "用户想看命盘、四柱、八字时"
   399→    }
   400→}
   401→
   402→SHOW_BAZI_FORTUNE_TOOL = {
   403→    "type": "function",
   404→    "function": {
   405→        "name": "show_bazi_fortune",
   406→        "description": "展示大运流年分析。当用户问运势时调用。",
   407→        "parameters": {
   408→            "type": "object",
   409→            "properties": {
   410→                "year": {
   411→                    "type": "integer",
   412→                    "description": "指定年份（可选）"
   413→                }
   414→            }
   415→        }
   416→    },
   417→    "_metadata": {
   418→        "tool_type": "display",
   419→        "card_type": "bazi_fortune",
   420→        "when_to_call": "用户问今年运势、大运、流年时"
   421→    }
   422→}
   423→
   424→SHOW_BAZI_KLINE_TOOL = {
   425→    "type": "function",
   426→    "function": {
   427→        "name": "show_bazi_kline",
   428→        "description": "展示运势K线图。当用户想看运势趋势时调用。",
   429→        "parameters": {
   430→            "type": "object",
   431→            "properties": {
   432→                "start_year": {"type": "integer", "description": "起始年份"},
   433→                "end_year": {"type": "integer", "description": "结束年份"}
   434→            }
   435→        }
   436→    },
   437→    "_metadata": {
   438→        "tool_type": "display",
   439→        "card_type": "bazi_kline",
   440→        "when_to_call": "用户想看运势趋势、K线图时"
   441→    }
   442→}
   443→
   444→# ═══════════════════════════════════════════════════════════════════════════
   445→# Zodiac 工具
   446→# ═══════════════════════════════════════════════════════════════════════════
   447→
   448→SHOW_ZODIAC_CHART_TOOL = {
   449→    "type": "function",
   450→    "function": {
   451→        "name": "show_zodiac_chart",
   452→        "description": "展示星盘。当用户想查看星盘时调用。",
   453→        "parameters": {
   454→            "type": "object",
   455→            "properties": {
   456→                "show_aspects": {
   457→                    "type": "boolean",
   458→                    "description": "是否显示相位",
   459→                    "default": True
   460→                }
   461→            }
   462→        }
   463→    },
   464→    "_metadata": {
   465→        "tool_type": "display",
   466→        "card_type": "zodiac_chart"
   467→    }
   468→}
   469→
   470→SHOW_ZODIAC_TRANSIT_TOOL = {
   471→    "type": "function",
   472→    "function": {
   473→        "name": "show_zodiac_transit",
   474→        "description": "展示行运分析。当用户问行星运行影响时调用。",
   475→        "parameters": {
   476→            "type": "object",
   477→            "properties": {
   478→                "date": {
   479→                    "type": "string",
   480→                    "description": "日期 (YYYY-MM-DD)"
   481→                }
   482→            }
   483→        }
   484→    },
   485→    "_metadata": {
   486→        "tool_type": "display",
   487→        "card_type": "zodiac_transit"
   488→    }
   489→}
   490→
   491→# ═══════════════════════════════════════════════════════════════════════════
   492→# Tarot 工具
   493→# ═══════════════════════════════════════════════════════════════════════════
   494→
   495→DRAW_TAROT_CARDS_TOOL = {
   496→    "type": "function",
   497→    "function": {
   498→        "name": "draw_tarot_cards",
   499→        "description": "抽塔罗牌。当用户想抽牌时调用。",
   500→        "parameters": {
   501→            "type": "object",
   502→            "properties": {
   503→                "spread_type": {
   504→                    "type": "string",
   505→                    "enum": ["single", "three", "celtic_cross"],
   506→                    "description": "牌阵类型",
   507→                    "default": "single"
   508→                },
   509→                "question": {
   510→                    "type": "string",
   511→                    "description": "用户的问题"
   512→                }
   513→            }
   514→        }
   515→    },
   516→    "_metadata": {
   517→        "tool_type": "calculate",
   518→        "card_type": "tarot_spread"
   519→    }
   520→}
   521→
   522→SHOW_TAROT_SPREAD_TOOL = {
   523→    "type": "function",
   524→    "function": {
   525→        "name": "show_tarot_spread",
   526→        "description": "展示塔罗牌阵。抽牌后调用展示结果。",
   527→        "parameters": {
   528→            "type": "object",
   529→            "properties": {}
   530→        }
   531→    },
   532→    "_metadata": {
   533→        "tool_type": "display",
   534→        "card_type": "tarot_spread"
   535→    }
   536→}
   537→
   538→# ═══════════════════════════════════════════════════════════════════════════
   539→# Career 工具
   540→# ═══════════════════════════════════════════════════════════════════════════
   541→
   542→SHOW_CAREER_ANALYSIS_TOOL = {
   543→    "type": "function",
   544→    "function": {
   545→        "name": "show_career_analysis",
   546→        "description": "展示职业分析。当用户问职业方向时调用。",
   547→        "parameters": {
   548→            "type": "object",
   549→            "properties": {
   550→                "analysis_type": {
   551→                    "type": "string",
   552→                    "enum": ["direction", "industry", "skills", "transition"],
   553→                    "description": "分析类型"
   554→                }
   555→            }
   556→        }
   557→    },
   558→    "_metadata": {
   559→        "tool_type": "display",
   560→        "card_type": "career_analysis"
   561→    }
   562→}
   563→
   564→# ═══════════════════════════════════════════════════════════════════════════
   565→# 工具注册表
   566→# ═══════════════════════════════════════════════════════════════════════════
   567→
   568→SHARED_TOOLS = [
   569→    # V6 全局工具
   570→    SEARCH_DB_TOOL,
   571→    ASK_USER_QUESTION_TOOL,
   572→    SHOW_SERVICE_MENU_TOOL,
   573→    # 服务发现
   574→    SHOW_SKILL_SERVICES_TOOL,
   575→    RECOMMEND_SERVICE_TOOL,
   576→    # 通用工具
   577→    REQUEST_INFO_TOOL,
   578→    SHOW_INSIGHT_TOOL,
   579→    SHOW_REPORT_TOOL,
   580→]
   581→
   582→SKILL_TOOLS = {
   583→    "bazi": [
   584→        COLLECT_BAZI_INFO_TOOL,
   585→        CALCULATE_BAZI_TOOL,
   586→        SHOW_BAZI_CHART_TOOL,
   587→        SHOW_BAZI_FORTUNE_TOOL,
   588→        SHOW_BAZI_KLINE_TOOL,
   589→    ],
   590→    "zodiac": [
   591→        SHOW_ZODIAC_CHART_TOOL,
   592→        SHOW_ZODIAC_TRANSIT_TOOL,
   593→    ],
   594→    "tarot": [
   595→        DRAW_TAROT_CARDS_TOOL,
   596→        SHOW_TAROT_SPREAD_TOOL,
   597→    ],
   598→    "career": [
   599→        SHOW_CAREER_ANALYSIS_TOOL,
   600→    ],
   601→}
   602→
   603→
   604→class ToolRegistry:
   605→    """工具注册表"""
   606→
   607→    @staticmethod
   608→    def get_tools_for_skill(skill_id: str) -> List[Dict[str, Any]]:
   609→        """获取 Skill 的所有工具"""
   610→        tools = SHARED_TOOLS.copy()
   611→        skill_tools = SKILL_TOOLS.get(skill_id, [])
   612→        tools.extend(skill_tools)
   613→        return tools
   614→
   615→    @staticmethod
   616→    def get_tool_by_name(tool_name: str) -> Optional[Dict[str, Any]]:
   617→        """根据名称获取工具"""
   618→        all_tools = SHARED_TOOLS.copy()
   619→        for skill_tools in SKILL_TOOLS.values():
   620→            all_tools.extend(skill_tools)
   621→
   622→        for tool in all_tools:
   623→            if tool["function"]["name"] == tool_name:
   624→                return tool
   625→        return None
   626→
   627→    @staticmethod
   628→    def get_card_type(tool_name: str) -> Optional[str]:
   629→        """获取工具对应的卡片类型"""
   630→        tool = ToolRegistry.get_tool_by_name(tool_name)
   631→        if tool and "_metadata" in tool:
   632→            return tool["_metadata"].get("card_type")
   633→        return None
   634→
   635→
   636→def get_tools_for_scenario(skill_id: str, scenario_id: Optional[str] = None) -> List[Dict[str, Any]]:
   637→    """获取场景的工具列表"""
   638→    # 目前简单返回 skill 的所有工具
   639→    # 后续可以根据 scenario 配置过滤
   640→    return ToolRegistry.get_tools_for_skill(skill_id)
   641→
   642→
   643→def get_tool_card_type(tool_name: str) -> Optional[str]:
   644→    """获取工具对应的前端卡片类型"""
   645→    return ToolRegistry.get_card_type(tool_name)
   646→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
