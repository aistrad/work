     1→"""
     2→Notifications Routes 测试
     3→测试通知服务端点
     4→
     5→覆盖端点:
     6→- GET /notifications - 获取所有通知
     7→- GET /notifications/unread - 获取未读通知
     8→- POST /notifications/{notification_id}/read - 标记已读
     9→- GET /notifications/daily - 获取今日运势
    10→"""
    11→
    12→import pytest
    13→from datetime import datetime
    14→from unittest.mock import AsyncMock, MagicMock, patch
    15→from uuid import uuid4
    16→
    17→pytestmark = pytest.mark.asyncio
    18→
    19→
    20→# ═══════════════════════════════════════════════════════════════════════════
    21→# Get Notifications Endpoint Tests
    22→# ═══════════════════════════════════════════════════════════════════════════
    23→
    24→class TestGetNotificationsEndpoint:
    25→    """获取通知端点测试"""
    26→
    27→    async def test_get_notifications_authenticated(self, client, override_auth, mock_notification_service):
    28→        """测试已认证用户获取通知"""
    29→        response = await client.get(
    30→            "/api/v1/notifications",
    31→            headers={"Authorization": "Bearer test_token"}
    32→        )
    33→
    34→        assert response.status_code == 200
    35→        data = response.json()
    36→        assert "items" in data
    37→        assert "unread_count" in data
    38→
    39→    async def test_get_notifications_with_user_id_param(self, client, mock_notification_service):
    40→        """测试通过 user_id 参数获取通知"""
    41→        user_id = "550e8400-e29b-41d4-a716-446655440000"
    42→
    43→        response = await client.get(
    44→            f"/api/v1/notifications?user_id={user_id}"
    45→        )
    46→
    47→        assert response.status_code == 200
    48→
    49→    async def test_get_notifications_unauthenticated_no_user_id(self, client, override_auth_optional_none):
    50→        """测试未认证且无 user_id"""
    51→        response = await client.get("/api/v1/notifications")
    52→
    53→        assert response.status_code == 401
    54→
    55→    async def test_get_notifications_with_limit(self, client, override_auth, mock_notification_service):
    56→        """测试带 limit 参数获取通知"""
    57→        response = await client.get(
    58→            "/api/v1/notifications?limit=10",
    59→            headers={"Authorization": "Bearer test_token"}
    60→        )
    61→
    62→        assert response.status_code == 200
    63→
    64→    async def test_get_notifications_limit_validation(self, client, override_auth):
    65→        """测试 limit 参数验证"""
    66→        # limit 超出范围
    67→        response = await client.get(
    68→            "/api/v1/notifications?limit=200",
    69→            headers={"Authorization": "Bearer test_token"}
    70→        )
    71→
    72→        # 应该返回验证错误
    73→        assert response.status_code == 422
    74→
    75→    async def test_get_notifications_empty(self, client, override_auth):
    76→        """测试空通知列表"""
    77→        with patch("routes.notifications.NotificationService") as mock_cls:
    78→            mock_service = MagicMock()
    79→            mock_service.get_all = AsyncMock(return_value={
    80→                "items": [],
    81→                "unread_count": 0
    82→            })
    83→            mock_cls.return_value = mock_service
    84→
    85→            response = await client.get(
    86→                "/api/v1/notifications",
    87→                headers={"Authorization": "Bearer test_token"}
    88→            )
    89→
    90→        assert response.status_code == 200
    91→        data = response.json()
    92→        assert data["items"] == []
    93→        assert data["unread_count"] == 0
    94→
    95→
    96→# ═══════════════════════════════════════════════════════════════════════════
    97→# Get Unread Notifications Endpoint Tests
    98→# ═══════════════════════════════════════════════════════════════════════════
    99→
   100→class TestGetUnreadNotificationsEndpoint:
   101→    """获取未读通知端点测试"""
   102→
   103→    async def test_get_unread_notifications(self, client, override_auth, mock_notification_service):
   104→        """测试获取未读通知"""
   105→        response = await client.get(
   106→            "/api/v1/notifications/unread",
   107→            headers={"Authorization": "Bearer test_token"}
   108→        )
   109→
   110→        assert response.status_code == 200
   111→        data = response.json()
   112→        assert isinstance(data, list)
   113→
   114→    async def test_get_unread_notifications_with_limit(self, client, override_auth, mock_notification_service):
   115→        """测试带 limit 获取未读通知"""
   116→        response = await client.get(
   117→            "/api/v1/notifications/unread?limit=5",
   118→            headers={"Authorization": "Bearer test_token"}
   119→        )
   120→
   121→        assert response.status_code == 200
   122→
   123→    async def test_get_unread_notifications_unauthenticated(self, client, override_auth_optional_none):
   124→        """测试未认证获取未读通知"""
   125→        response = await client.get("/api/v1/notifications/unread")
   126→
   127→        assert response.status_code == 401
   128→
   129→    async def test_get_unread_notifications_empty(self, client, override_auth):
   130→        """测试无未读通知"""
   131→        with patch("routes.notifications.NotificationService") as mock_cls:
   132→            mock_service = MagicMock()
   133→            mock_service.get_unread = AsyncMock(return_value=[])
   134→            mock_cls.return_value = mock_service
   135→
   136→            response = await client.get(
   137→                "/api/v1/notifications/unread",
   138→                headers={"Authorization": "Bearer test_token"}
   139→            )
   140→
   141→        assert response.status_code == 200
   142→        assert response.json() == []
   143→
   144→
   145→# ═══════════════════════════════════════════════════════════════════════════
   146→# Mark Notification Read Endpoint Tests
   147→# ═══════════════════════════════════════════════════════════════════════════
   148→
   149→class TestMarkNotificationReadEndpoint:
   150→    """标记通知已读端点测试"""
   151→
   152→    async def test_mark_notification_read_success(self, client, mock_notification_service):
   153→        """测试标记通知已读成功"""
   154→        notification_id = str(uuid4())
   155→
   156→        response = await client.post(f"/api/v1/notifications/{notification_id}/read")
   157→
   158→        assert response.status_code == 200
   159→        assert response.json()["success"] is True
   160→
   161→    async def test_mark_notification_read_not_found(self, client):
   162→        """测试标记不存在的通知"""
   163→        notification_id = str(uuid4())
   164→
   165→        with patch("routes.notifications.NotificationService") as mock_cls:
   166→            mock_service = MagicMock()
   167→            mock_service.mark_read = AsyncMock(return_value=False)
   168→            mock_cls.return_value = mock_service
   169→
   170→            response = await client.post(f"/api/v1/notifications/{notification_id}/read")
   171→
   172→        assert response.status_code == 404
   173→
   174→    async def test_mark_notification_read_invalid_uuid(self, client):
   175→        """测试无效的通知 ID"""
   176→        response = await client.post("/api/v1/notifications/invalid-uuid/read")
   177→
   178→        assert response.status_code == 422
   179→
   180→
   181→# ═══════════════════════════════════════════════════════════════════════════
   182→# Get Daily Fortune Endpoint Tests
   183→# ═══════════════════════════════════════════════════════════════════════════
   184→
   185→class TestGetDailyFortuneEndpoint:
   186→    """获取今日运势端点测试"""
   187→
   188→    async def test_get_daily_fortune_success(self, client, override_auth, mock_notification_service):
   189→        """测试获取今日运势成功"""
   190→        response = await client.get(
   191→            "/api/v1/notifications/daily",
   192→            headers={"Authorization": "Bearer test_token"}
   193→        )
   194→
   195→        assert response.status_code == 200
   196→        data = response.json()
   197→        assert "id" in data
   198→        assert "type" in data
   199→        assert data["type"] == "daily_fortune"
   200→
   201→    async def test_get_daily_fortune_with_user_id(self, client, mock_notification_service):
   202→        """测试通过 user_id 获取今日运势"""
   203→        user_id = "550e8400-e29b-41d4-a716-446655440000"
   204→
   205→        response = await client.get(f"/api/v1/notifications/daily?user_id={user_id}")
   206→
   207→        assert response.status_code == 200
   208→
   209→    async def test_get_daily_fortune_not_found(self, client, override_auth):
   210→        """测试今日运势不存在"""
   211→        with patch("routes.notifications.NotificationService") as mock_cls:
   212→            mock_service = MagicMock()
   213→            mock_service.get_today_daily = AsyncMock(return_value=None)
   214→            mock_cls.return_value = mock_service
   215→
   216→            response = await client.get(
   217→                "/api/v1/notifications/daily",
   218→                headers={"Authorization": "Bearer test_token"}
   219→            )
   220→
   221→        assert response.status_code == 404
   222→
   223→    async def test_get_daily_fortune_unauthenticated(self, client, override_auth_optional_none):
   224→        """测试未认证获取今日运势"""
   225→        response = await client.get("/api/v1/notifications/daily")
   226→
   227→        assert response.status_code == 401
   228→
   229→
   230→# ═══════════════════════════════════════════════════════════════════════════
   231→# Notification Types Tests
   232→# ═══════════════════════════════════════════════════════════════════════════
   233→
   234→class TestNotificationTypes:
   235→    """通知类型测试"""
   236→
   237→    async def test_daily_fortune_notification(self, client, override_auth):
   238→        """测试每日运势通知"""
   239→        with patch("routes.notifications.NotificationService") as mock_cls:
   240→            mock_service = MagicMock()
   241→            mock_service.get_all = AsyncMock(return_value={
   242→                "items": [
   243→                    {
   244→                        "id": str(uuid4()),
   245→                        "type": "daily_fortune",
   246→                        "title": "今日运势",
   247→                        "content": "今天适合...",
   248→                        "is_read": False,
   249→                        "created_at": datetime.now().isoformat()
   250→                    }
   251→                ],
   252→                "unread_count": 1
   253→            })
   254→            mock_cls.return_value = mock_service
   255→
   256→            response = await client.get(
   257→                "/api/v1/notifications",
   258→                headers={"Authorization": "Bearer test_token"}
   259→            )
   260→
   261→        assert response.status_code == 200
   262→        data = response.json()
   263→        assert data["items"][0]["type"] == "daily_fortune"
   264→
   265→    async def test_system_notification(self, client, override_auth):
   266→        """测试系统通知"""
   267→        with patch("routes.notifications.NotificationService") as mock_cls:
   268→            mock_service = MagicMock()
   269→            mock_service.get_all = AsyncMock(return_value={
   270→                "items": [
   271→                    {
   272→                        "id": str(uuid4()),
   273→                        "type": "system",
   274→                        "title": "系统通知",
   275→                        "content": "系统维护通知",
   276→                        "is_read": False,
   277→                        "created_at": datetime.now().isoformat()
   278→                    }
   279→                ],
   280→                "unread_count": 1
   281→            })
   282→            mock_cls.return_value = mock_service
   283→
   284→            response = await client.get(
   285→                "/api/v1/notifications",
   286→                headers={"Authorization": "Bearer test_token"}
   287→            )
   288→
   289→        assert response.status_code == 200
   290→
   291→    async def test_reminder_notification(self, client, override_auth):
   292→        """测试提醒通知"""
   293→        with patch("routes.notifications.NotificationService") as mock_cls:
   294→            mock_service = MagicMock()
   295→            mock_service.get_all = AsyncMock(return_value={
   296→                "items": [
   297→                    {
   298→                        "id": str(uuid4()),
   299→                        "type": "reminder",
   300→                        "title": "运势提醒",
   301→                        "content": "今天是您的幸运日",
   302→                        "is_read": True,
   303→                        "created_at": datetime.now().isoformat()
   304→                    }
   305→                ],
   306→                "unread_count": 0
   307→            })
   308→            mock_cls.return_value = mock_service
   309→
   310→            response = await client.get(
   311→                "/api/v1/notifications",
   312→                headers={"Authorization": "Bearer test_token"}
   313→            )
   314→
   315→        assert response.status_code == 200
   316→
   317→
   318→# ═══════════════════════════════════════════════════════════════════════════
   319→# Edge Cases & Error Handling
   320→# ═══════════════════════════════════════════════════════════════════════════
   321→
   322→class TestNotificationsEdgeCases:
   323→    """边界情况和错误处理测试"""
   324→
   325→    @pytest.mark.skip(reason="路由未捕获服务层异常，异常直接传播到测试框架")
   326→    async def test_get_notifications_service_error(self, client, override_auth):
   327→        """测试服务层错误 - 路由未捕获异常"""
   328→        # 此测试验证当服务层抛出异常时的行为
   329→        # 由于路由没有 try-except，异常会直接传播
   330→        # 在生产环境中，FastAPI 的异常处理中间件会返回 500
   331→        pass
   332→
   333→    async def test_notifications_response_format(self, client, override_auth, mock_notification_service):
   334→        """测试响应格式一致性"""
   335→        response = await client.get(
   336→            "/api/v1/notifications",
   337→            headers={"Authorization": "Bearer test_token"}
   338→        )
   339→
   340→        assert response.status_code == 200
   341→        data = response.json()
   342→
   343→        # 验证响应格式
   344→        assert isinstance(data, dict)
   345→        assert "items" in data
   346→        assert "unread_count" in data
   347→        assert isinstance(data["items"], list)
   348→        assert isinstance(data["unread_count"], int)
   349→
   350→    async def test_notification_id_format(self, client, mock_notification_service):
   351→        """测试通知 ID 格式"""
   352→        # 有效 UUID
   353→        valid_uuid = str(uuid4())
   354→        response = await client.post(f"/api/v1/notifications/{valid_uuid}/read")
   355→        assert response.status_code == 200
   356→
   357→    async def test_concurrent_mark_read(self, client, mock_notification_service):
   358→        """测试并发标记已读"""
   359→        notification_id = str(uuid4())
   360→
   361→        # 模拟并发请求
   362→        responses = []
   363→        for _ in range(3):
   364→            response = await client.post(f"/api/v1/notifications/{notification_id}/read")
   365→            responses.append(response)
   366→
   367→        # 所有请求应该成功（幂等操作）
   368→        for response in responses:
   369→            assert response.status_code == 200
   370→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
