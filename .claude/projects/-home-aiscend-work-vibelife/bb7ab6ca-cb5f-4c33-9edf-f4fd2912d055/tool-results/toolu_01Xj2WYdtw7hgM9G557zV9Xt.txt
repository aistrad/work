     1→"""
     2→Tools Routes 测试
     3→测试工具 Schema 端点
     4→
     5→覆盖端点:
     6→- GET /tools/schema - 获取工具 Schema
     7→- GET /tools/list - 列出所有工具
     8→- GET /tools/card-type/{tool_name} - 获取工具卡片类型
     9→"""
    10→
    11→import pytest
    12→from unittest.mock import MagicMock, patch
    13→
    14→pytestmark = pytest.mark.asyncio
    15→
    16→
    17→# ═══════════════════════════════════════════════════════════════════════════
    18→# Get Tool Schema Endpoint Tests
    19→# ═══════════════════════════════════════════════════════════════════════════
    20→
    21→class TestGetToolSchemaEndpoint:
    22→    """获取工具 Schema 端点测试"""
    23→
    24→    async def test_get_all_tools_schema(self, client):
    25→        """测试获取所有工具 Schema"""
    26→        with patch("routes.tools.ToolRegistry") as mock_registry:
    27→            mock_registry.get_schema.return_value = {
    28→                "version": "6.0",
    29→                "skill_id": None,
    30→                "tools": [
    31→                    {
    32→                        "name": "show_bazi_chart",
    33→                        "description": "展示八字命盘",
    34→                        "tool_type": "display",
    35→                        "card_type": "bazi_chart",
    36→                        "parameters": []
    37→                    },
    38→                    {
    39→                        "name": "show_zodiac_chart",
    40→                        "description": "展示星座命盘",
    41→                        "tool_type": "display",
    42→                        "card_type": "zodiac_chart",
    43→                        "parameters": []
    44→                    }
    45→                ]
    46→            }
    47→
    48→            response = await client.get("/api/v1/tools/schema")
    49→
    50→        assert response.status_code == 200
    51→        data = response.json()
    52→        assert "version" in data
    53→        assert "tools" in data
    54→        assert len(data["tools"]) > 0
    55→
    56→    async def test_get_skill_specific_schema(self, client):
    57→        """测试获取特定 Skill 的工具 Schema"""
    58→        with patch("routes.tools.ToolRegistry") as mock_registry:
    59→            mock_registry.get_schema.return_value = {
    60→                "version": "6.0",
    61→                "skill_id": "bazi",
    62→                "tools": [
    63→                    {
    64→                        "name": "show_bazi_chart",
    65→                        "description": "展示八字命盘",
    66→                        "tool_type": "display",
    67→                        "card_type": "bazi_chart",
    68→                        "parameters": [
    69→                            {"name": "birth_date", "type": "string", "required": True}
    70→                        ]
    71→                    },
    72→                    {
    73→                        "name": "calculate_bazi",
    74→                        "description": "计算八字",
    75→                        "tool_type": "compute",
    76→                        "card_type": None,
    77→                        "parameters": []
    78→                    }
    79→                ]
    80→            }
    81→
    82→            response = await client.get("/api/v1/tools/schema?skill_id=bazi")
    83→
    84→        assert response.status_code == 200
    85→        data = response.json()
    86→        assert data["skill_id"] == "bazi"
    87→        assert all("bazi" in t["name"] for t in data["tools"])
    88→
    89→    async def test_get_schema_zodiac(self, client):
    90→        """测试获取 zodiac 工具 Schema"""
    91→        with patch("routes.tools.ToolRegistry") as mock_registry:
    92→            mock_registry.get_schema.return_value = {
    93→                "version": "6.0",
    94→                "skill_id": "zodiac",
    95→                "tools": [
    96→                    {
    97→                        "name": "show_zodiac_chart",
    98→                        "description": "展示星座命盘",
    99→                        "tool_type": "display",
   100→                        "card_type": "zodiac_chart"
   101→                    }
   102→                ]
   103→            }
   104→
   105→            response = await client.get("/api/v1/tools/schema?skill_id=zodiac")
   106→
   107→        assert response.status_code == 200
   108→
   109→    async def test_get_schema_empty(self, client):
   110→        """测试空 Schema"""
   111→        with patch("routes.tools.ToolRegistry") as mock_registry:
   112→            mock_registry.get_schema.return_value = {
   113→                "version": "6.0",
   114→                "skill_id": "nonexistent",
   115→                "tools": []
   116→            }
   117→
   118→            response = await client.get("/api/v1/tools/schema?skill_id=nonexistent")
   119→
   120→        assert response.status_code == 200
   121→        data = response.json()
   122→        assert data["tools"] == []
   123→
   124→
   125→# ═══════════════════════════════════════════════════════════════════════════
   126→# List Tools Endpoint Tests
   127→# ═══════════════════════════════════════════════════════════════════════════
   128→
   129→class TestListToolsEndpoint:
   130→    """列出工具端点测试"""
   131→
   132→    async def test_list_all_tools(self, client):
   133→        """测试列出所有工具"""
   134→        with patch("routes.tools.ToolRegistry") as mock_registry:
   135→            mock_registry.get_all_tools.return_value = [
   136→                {
   137→                    "type": "function",
   138→                    "function": {
   139→                        "name": "show_bazi_chart",
   140→                        "description": "展示八字命盘",
   141→                        "parameters": {"type": "object", "properties": {}}
   142→                    }
   143→                },
   144→                {
   145→                    "type": "function",
   146→                    "function": {
   147→                        "name": "search_db",
   148→                        "description": "搜索知识库",
   149→                        "parameters": {"type": "object", "properties": {}}
   150→                    }
   151→                }
   152→            ]
   153→
   154→            response = await client.get("/api/v1/tools/list")
   155→
   156→        assert response.status_code == 200
   157→        data = response.json()
   158→        assert "count" in data
   159→        assert "tools" in data
   160→        assert data["count"] == 2
   161→
   162→    async def test_list_tools_by_skill(self, client):
   163→        """测试按 Skill 列出工具"""
   164→        with patch("routes.tools.ToolRegistry") as mock_registry:
   165→            mock_registry.get_tools_for_skill.return_value = [
   166→                {
   167→                    "type": "function",
   168→                    "function": {
   169→                        "name": "show_bazi_chart",
   170→                        "description": "展示八字命盘"
   171→                    }
   172→                },
   173→                {
   174→                    "type": "function",
   175→                    "function": {
   176→                        "name": "calculate_bazi",
   177→                        "description": "计算八字"
   178→                    }
   179→                }
   180→            ]
   181→
   182→            response = await client.get("/api/v1/tools/list?skill_id=bazi")
   183→
   184→        assert response.status_code == 200
   185→        data = response.json()
   186→        assert data["count"] == 2
   187→
   188→    async def test_list_tools_empty(self, client):
   189→        """测试空工具列表"""
   190→        with patch("routes.tools.ToolRegistry") as mock_registry:
   191→            mock_registry.get_all_tools.return_value = []
   192→
   193→            response = await client.get("/api/v1/tools/list")
   194→
   195→        assert response.status_code == 200
   196→        data = response.json()
   197→        assert data["count"] == 0
   198→        assert data["tools"] == []
   199→
   200→
   201→# ═══════════════════════════════════════════════════════════════════════════
   202→# Get Card Type Endpoint Tests
   203→# ═══════════════════════════════════════════════════════════════════════════
   204→
   205→class TestGetCardTypeEndpoint:
   206→    """获取卡片类型端点测试"""
   207→
   208→    async def test_get_card_type_bazi_chart(self, client):
   209→        """测试获取八字命盘卡片类型"""
   210→        with patch("routes.tools.ToolRegistry") as mock_registry:
   211→            mock_registry.get_card_type.return_value = "bazi_chart"
   212→
   213→            response = await client.get("/api/v1/tools/card-type/show_bazi_chart")
   214→
   215→        assert response.status_code == 200
   216→        data = response.json()
   217→        assert data["tool_name"] == "show_bazi_chart"
   218→        assert data["card_type"] == "bazi_chart"
   219→
   220→    async def test_get_card_type_zodiac_chart(self, client):
   221→        """测试获取星座命盘卡片类型"""
   222→        with patch("routes.tools.ToolRegistry") as mock_registry:
   223→            mock_registry.get_card_type.return_value = "zodiac_chart"
   224→
   225→            response = await client.get("/api/v1/tools/card-type/show_zodiac_chart")
   226→
   227→        assert response.status_code == 200
   228→        data = response.json()
   229→        assert data["card_type"] == "zodiac_chart"
   230→
   231→    async def test_get_card_type_tarot(self, client):
   232→        """测试获取塔罗卡片类型"""
   233→        with patch("routes.tools.ToolRegistry") as mock_registry:
   234→            mock_registry.get_card_type.return_value = "tarot_spread"
   235→
   236→            response = await client.get("/api/v1/tools/card-type/draw_tarot_cards")
   237→
   238→        assert response.status_code == 200
   239→        data = response.json()
   240→        assert data["card_type"] == "tarot_spread"
   241→
   242→    async def test_get_card_type_none(self, client):
   243→        """测试工具无卡片类型"""
   244→        with patch("routes.tools.ToolRegistry") as mock_registry:
   245→            mock_registry.get_card_type.return_value = None
   246→
   247→            response = await client.get("/api/v1/tools/card-type/search_db")
   248→
   249→        assert response.status_code == 200
   250→        data = response.json()
   251→        assert data["tool_name"] == "search_db"
   252→        assert data["card_type"] is None
   253→
   254→    async def test_get_card_type_unknown_tool(self, client):
   255→        """测试未知工具"""
   256→        with patch("routes.tools.ToolRegistry") as mock_registry:
   257→            mock_registry.get_card_type.return_value = None
   258→
   259→            response = await client.get("/api/v1/tools/card-type/unknown_tool")
   260→
   261→        assert response.status_code == 200
   262→        data = response.json()
   263→        assert data["card_type"] is None
   264→
   265→
   266→# ═══════════════════════════════════════════════════════════════════════════
   267→# Tool Types Tests
   268→# ═══════════════════════════════════════════════════════════════════════════
   269→
   270→class TestToolTypes:
   271→    """工具类型测试"""
   272→
   273→    async def test_display_tools(self, client):
   274→        """测试展示类工具"""
   275→        with patch("routes.tools.ToolRegistry") as mock_registry:
   276→            mock_registry.get_schema.return_value = {
   277→                "version": "6.0",
   278→                "tools": [
   279→                    {"name": "show_bazi_chart", "tool_type": "display"},
   280→                    {"name": "show_zodiac_chart", "tool_type": "display"},
   281→                    {"name": "show_tarot_spread", "tool_type": "display"}
   282→                ]
   283→            }
   284→
   285→            response = await client.get("/api/v1/tools/schema")
   286→
   287→        assert response.status_code == 200
   288→        data = response.json()
   289→        display_tools = [t for t in data["tools"] if t.get("tool_type") == "display"]
   290→        assert len(display_tools) == 3
   291→
   292→    async def test_compute_tools(self, client):
   293→        """测试计算类工具"""
   294→        with patch("routes.tools.ToolRegistry") as mock_registry:
   295→            mock_registry.get_schema.return_value = {
   296→                "version": "6.0",
   297→                "tools": [
   298→                    {"name": "calculate_bazi", "tool_type": "compute"},
   299→                    {"name": "calculate_transit", "tool_type": "compute"}
   300→                ]
   301→            }
   302→
   303→            response = await client.get("/api/v1/tools/schema")
   304→
   305→        assert response.status_code == 200
   306→
   307→    async def test_search_tools(self, client):
   308→        """测试搜索类工具"""
   309→        with patch("routes.tools.ToolRegistry") as mock_registry:
   310→            mock_registry.get_schema.return_value = {
   311→                "version": "6.0",
   312→                "tools": [
   313→                    {"name": "search_db", "tool_type": "search"},
   314→                    {"name": "search_knowledge", "tool_type": "search"}
   315→                ]
   316→            }
   317→
   318→            response = await client.get("/api/v1/tools/schema")
   319→
   320→        assert response.status_code == 200
   321→
   322→
   323→# ═══════════════════════════════════════════════════════════════════════════
   324→# OpenAI Format Tests
   325→# ═══════════════════════════════════════════════════════════════════════════
   326→
   327→class TestOpenAIFormat:
   328→    """OpenAI 工具格式测试"""
   329→
   330→    async def test_openai_tool_format(self, client):
   331→        """测试 OpenAI 工具格式"""
   332→        with patch("routes.tools.ToolRegistry") as mock_registry:
   333→            mock_registry.get_all_tools.return_value = [
   334→                {
   335→                    "type": "function",
   336→                    "function": {
   337→                        "name": "show_bazi_chart",
   338→                        "description": "展示八字命盘",
   339→                        "parameters": {
   340→                            "type": "object",
   341→                            "properties": {
   342→                                "birth_date": {
   343→                                    "type": "string",
   344→                                    "description": "出生日期"
   345→                                },
   346→                                "birth_time": {
   347→                                    "type": "string",
   348→                                    "description": "出生时间"
   349→                                }
   350→                            },
   351→                            "required": ["birth_date"]
   352→                        }
   353→                    }
   354→                }
   355→            ]
   356→
   357→            response = await client.get("/api/v1/tools/list")
   358→
   359→        assert response.status_code == 200
   360→        data = response.json()
   361→        tool = data["tools"][0]
   362→
   363→        # 验证 OpenAI 格式
   364→        assert tool["type"] == "function"
   365→        assert "function" in tool
   366→        assert "name" in tool["function"]
   367→        assert "description" in tool["function"]
   368→        assert "parameters" in tool["function"]
   369→
   370→
   371→# ═══════════════════════════════════════════════════════════════════════════
   372→# Edge Cases & Error Handling
   373→# ═══════════════════════════════════════════════════════════════════════════
   374→
   375→class TestToolsEdgeCases:
   376→    """边界情况和错误处理测试"""
   377→
   378→    async def test_special_characters_in_tool_name(self, client):
   379→        """测试工具名中的特殊字符"""
   380→        with patch("routes.tools.ToolRegistry") as mock_registry:
   381→            mock_registry.get_card_type.return_value = None
   382→
   383→            response = await client.get("/api/v1/tools/card-type/tool-with-dash")
   384→
   385→        assert response.status_code == 200
   386→
   387→    async def test_unicode_in_tool_name(self, client):
   388→        """测试工具名中的 Unicode"""
   389→        with patch("routes.tools.ToolRegistry") as mock_registry:
   390→            mock_registry.get_card_type.return_value = None
   391→
   392→            response = await client.get("/api/v1/tools/card-type/工具名")
   393→
   394→        assert response.status_code == 200
   395→
   396→    @pytest.mark.skip(reason="路由未捕获 ToolRegistry 异常，异常直接传播到测试框架")
   397→    async def test_registry_error(self, client):
   398→        """测试注册表错误 - 路由未捕获异常"""
   399→        # 此测试验证当 ToolRegistry 抛出异常时的行为
   400→        # 由于路由没有 try-except，异常会直接传播
   401→        # 在生产环境中，FastAPI 的异常处理中间件会返回 500
   402→        pass
   403→
   404→    async def test_concurrent_requests(self, client):
   405→        """测试并发请求"""
   406→        with patch("routes.tools.ToolRegistry") as mock_registry:
   407→            mock_registry.get_schema.return_value = {"version": "6.0", "tools": []}
   408→            mock_registry.get_all_tools.return_value = []
   409→            mock_registry.get_card_type.return_value = None
   410→
   411→            # 模拟并发请求
   412→            responses = []
   413→            for endpoint in ["/api/v1/tools/schema", "/api/v1/tools/list", "/api/v1/tools/card-type/test"]:
   414→                response = await client.get(endpoint)
   415→                responses.append(response)
   416→
   417→            # 所有请求应该成功
   418→            for response in responses:
   419→                assert response.status_code == 200
   420→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
