The file /home/aiscend/work/vibelife/docs/components/VibeProfile/SPEC.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
     1→# VibeProfile - 用户画像数据层
     2→
     3→> Version: 3.0 | 三层架构：Identity + Skills + Vibe
     4→> Updated: 2026-01-22
     5→
     6→---
     7→
     8→## 1. 概述
     9→
    10→VibeProfile 是 VibeLife 用户数据的**画像层**，采用三层架构设计。
    11→
    12→### 核心理念
    13→
    14→```
    15→┌─────────────────────────────────────────────────────────────────┐
    16→│                      VibeProfile 三层架构                        │
    17→├─────────────────────────────────────────────────────────────────┤
    18→│                                                                  │
    19→│  Layer 1: Identity（基础信息）                                   │
    20→│  ────────────────────────────────────────────────────────────   │
    21→│  来源：用户填写                                                  │
    22→│  内容：birth_info, display_name, preferences                    │
    23→│                                                                  │
    24→│  Layer 2: Skills（Skill 原始数据）                              │
    25→│  ────────────────────────────────────────────────────────────   │
    26→│  来源：各 Skill 实时写入                                        │
    27→│  内容：bazi.chart, zodiac.chart, lifecoach.{...}, tarot.{...}  │
    28→│                                                                  │
    29→│  Layer 3: Vibe（共享深度信息）← 核心创新                        │
    30→│  ────────────────────────────────────────────────────────────   │
    31→│  来源：抽取（activities）+ 同步（skills）                        │
    32→│  内容：vibe.insight + vibe.target                               │
    33→│                                                                  │
    34→└─────────────────────────────────────────────────────────────────┘
    35→```
    36→
    37→### 设计原则
    38→
    39→| 原则 | 说明 |
    40→|------|------|
    41→| **三层分离** | Identity / Skills / Vibe 职责清晰 |
    42→| **Skills 是原始数据** | 每个 Skill 存自己的数据，互不干扰 |
    43→| **Vibe 是共享洞察** | 跨 Skill 共享，所有 Skill 都可读取 |
    44→| **Vibe 双来源** | 抽取（activities）+ 同步（skills） |
    45→| **Single JSONB** | 画像数据一张表 (`unified_profiles.profile`) |
    46→
    47→---
    48→
    49→## 2. 数据结构
    50→
    51→### 2.1 完整 Profile Schema
    52→
    53→```json
    54→{
    55→  "identity": {
    56→    "display_name": "用户名",
    57→    "birth_info": {
    58→      "date": "1990-01-01",
    59→      "time": "12:00",
    60→      "location": "北京",
    61→      "timezone": "Asia/Shanghai",
    62→      "gender": "male"
    63→    }
    64→  },
    65→
    66→  "skills": {
    67→    "bazi": {
    68→      "chart": { "year": {...}, "month": {...}, "day": {...}, "hour": {...} },
    69→      "dayun": { "current": {...}, "periods": [...] },
    70→      "features": { "daymaster": "甲木", "strength": "strong", "pattern": "..." }
    71→    },
    72→    "zodiac": {
    73→      "chart": { "sun": "Aries", "moon": "Leo", "ascendant": "Virgo", ... },
    74→      "houses": [...],
    75→      "aspects": [...]
    76→    },
    77→    "tarot": {
    78→      "last_reading": { "spread": "celtic_cross", "cards": [...], "date": "..." }
    79→    },
    80→    "lifecoach": {
    81→      "north_star": {
    82→        "vision_scene": "3年后的理想场景",
    83→        "anti_vision_scene": "不改变的后果",
    84→        "pain_points": ["持续的不满1", "持续的不满2"],
    85→        "vision_timeframe": "3年后"
    86→      },
    87→      "identity": {
    88→        "current": "我是那种会拖延的人",
    89→        "target": "我是那种说到做到的人"
    90→      },
    91→      "goals": [
    92→        {
    93→          "id": "goal_001",
    94→          "title": "完成写作项目",
    95→          "category": "career",
    96→          "status": "in_progress",
    97→          "progress": 0.6,
    98→          "year": 2026,
    99→          "created_at": "2026-01-10T08:00:00Z",
   100→          "milestones": [
   101→            { "id": "m1", "title": "完成大纲", "completed": true }
   102→          ]
   103→        }
   104→      ],
   105→      "current": {
   106→        "week": {
   107→          "week_start": "2026-01-20",
   108→          "rocks": [{ "id": "...", "task": "周大石头", "status": "pending" }]
   109→        },
   110→        "daily": {
   111→          "date": "2026-01-22",
   112→          "levers": [{ "id": "...", "task": "每日杠杆", "status": "pending" }]
   113→        },
   114→        "month": {
   115→          "id": "boss_001",
   116→          "title": "月度Boss",
   117→          "month": "2026-01",
   118→          "progress": 0.7
   119→        }
   120→      },
   121→      "progress": {
   122→        "current_streak": 7,
   123→        "longest_streak": 14,
   124→        "total_checkins": 50,
   125→        "last_checkin_date": "2026-01-21"
   126→      }
   127→    }
   128→  },
   129→
   130→  "vibe": {
   131→    "insight": {
   132→      "essence": {
   133→        "archetype": {
   134→          "primary": "creator",
   135→          "secondary": "explorer",
   136→          "shadow": "ruler"
   137→        },
   138→        "traits": [
   139→          { "source": "bazi", "trait": "表达力强" },
   140→          { "source": "zodiac", "trait": "好奇心旺" }
   141→        ]
   142→      },
   143→      "dynamic": {
   144→        "emotion": { "current": "calm", "intensity": 0.6 },
   145→        "energy": { "level": 0.7, "focus": ["career"] },
   146→        "active_archetype": "creator",
   147→        "trend": {
   148→          "archetype_shift": { "rising": "pioneer", "delta": 0.05 },
   149→          "emotion_trend": "stable",
   150→          "direction": "expansion"
   151→        }
   152→      },
   153→      "pattern": {
   154→        "behaviors": [
   155→          { "pattern": "晚间活跃", "confidence": 0.8 },
   156→          { "pattern": "周期性低落", "trigger": "周一" }
   157→        ],
   158→        "insights": [
   159→          "你在压力下倾向于独处思考",
   160→          "创意灵感常在深夜涌现"
   161→        ]
   162→      },
   163→      "updated_at": "2026-01-22T03:00:00Z"
   164→    },
   165→    "target": {
   166→      "north_star": {},
   167→      "goals": [],
   168→      "focus": {
   169→        "primary": "career",
   170→        "secondary": ["growth"],
   171→        "active_goal": "goal_001",
   172→        "heat_map": { "career": 0.8, "growth": 0.5, "health": 0.2 }
   173→      },
   174→      "milestones": {
   175→        "achieved": [],
   176→        "streak": { "current": 7, "best": 14 },
   177→        "moments": []
   178→      },
   179→      "updated_at": "2026-01-22T03:00:00Z"
   180→    }
   181→  },
   182→
   183→  "preferences": {
   184→    "voice_mode": "warm",
   185→    "language": "zh-CN",
   186→    "timezone": "Asia/Shanghai",
   187→    "subscribed_skills": {
   188→      "bazi": { "status": "subscribed", "push_enabled": true },
   189→      "zodiac": { "status": "subscribed", "push_enabled": true }
   190→    },
   191→    "push_settings": {
   192→      "default_push_hour": 8,
   193→      "quiet_start_hour": 22,
   194→      "quiet_end_hour": 7
   195→    }
   196→  }
   197→}
   198→```
   199→
   200→### 2.2 Layer 说明
   201→
   202→#### Layer 1: Identity（基础信息）
   203→
   204→| 字段 | 说明 | 来源 |
   205→|------|------|------|
   206→| `display_name` | 显示名称 | 用户填写 |
   207→| `birth_info` | 出生信息 | 用户填写 |
   208→
   209→#### Layer 2: Skills（Skill 原始数据）
   210→
   211→| Skill | 存储内容 | 写入时机 |
   212→|-------|---------|---------|
   213→| `bazi` | chart, dayun, features | 排盘时 |
   214→| `zodiac` | chart, houses, aspects | 排盘时 |
   215→| `tarot` | last_reading | 每次占卜后 |
   216→| `lifecoach` | north_star, goals, current, progress | 协议完成后 |
   217→| `mindfulness` | sessions, streaks | 冥想后 |
   218→
   219→#### Layer 3: Vibe（共享深度信息）
   220→
   221→| 字段 | 说明 | 来源 |
   222→|------|------|------|
   223→| `vibe.insight` | 我是谁（本质+动态+规律） | ProfileExtractor 融合生成 |
   224→| `vibe.target` | 我要成为谁（目标+聚焦+里程碑） | 抽取 + 同步自 skills |
   225→
   226→---
   227→
   228→## 3. 数据流
   229→
   230→### 3.1 写入流
   231→
   232→```
   233→用户交互
   234→    │
   235→    ├─► Bazi Skill ─────────► skills.bazi
   236→    │   （排盘计算）
   237→    │
   238→    ├─► Zodiac Skill ───────► skills.zodiac
   239→    │   （排盘计算）
   240→    │
   241→    ├─► Lifecoach Skill ────► skills.lifecoach
   242→    │   （协议对话）              ├─ north_star
   243→    │                            ├─ goals
   244→    │                            ├─ current
   245→    │                            └─ progress
   246→    │
   247→    ▼
   248→Activities (conversations/messages)
   249→    │
   250→    ▼ (每日凌晨 3 点)
   251→    │
   252→┌────────────────────────────────────────────────────────────────┐
   253→│  ProfileExtractor                                               │
   254→│  ───────────────────────────────────────────────────────────── │
   255→│                                                                 │
   256→│  输入：                                                         │
   257→│  • activities (对话记录)                                        │
   258→│  • skills.bazi.chart (命盘)                                    │
   259→│  • skills.zodiac.chart (星盘)                                  │
   260→│  • skills.lifecoach.goals (目标)                               │
   261→│                                                                 │
   262→│  处理：                                                         │
   263→│  • 融合生成 vibe.insight（本质+动态+规律）                      │
   264→│  • 同步+抽取 vibe.target（目标+聚焦+里程碑）                    │
   265→│                                                                 │
   266→│  输出：                                                         │
   267→│  • vibe.insight                                                │
   268→│  • vibe.target                                                 │
   269→│                                                                 │
   270→└────────────────────────────────────────────────────────────────┘
   271→```
   272→
   273→### 3.2 读取流
   274→
   275→```
   276→Chat（对话）
   277→    │
   278→    ├─ 读取 identity.birth_info（所有 Skill 共享）
   279→    ├─ 读取 skills.{skill_id}（当前 Skill 专属）
   280→    ├─ 读取 vibe.insight（共享洞察）
   281→    └─ 读取 vibe.target（共享目标）
   282→
   283→Me 页面
   284→    │
   285→    └─ 读取 vibe.insight（展示三维画像）
   286→
   287→Journey 页面
   288→    │
   289→    ├─ 读取 skills.lifecoach（原始数据）
   290→    └─ 读取 vibe.target（聚焦+里程碑）
   291→
   292→Proactive（主动推送）
   293→    │
   294→    ├─ 读取 vibe.insight.dynamic（情绪/能量）
   295→    └─ 读取 vibe.target.focus（当前聚焦）
   296→```
   297→
   298→---
   299→
   300→## 4. VibeInsight 三维模型
   301→
   302→### 4.1 维度 1: 本质 (Essence) — 我是什么
   303→
   304→**静态层：先天倾向**
   305→
   306→来源：`skills.bazi` + `skills.zodiac`
   307→
   308→```json
   309→{
   310→  "archetype": {
   311→    "primary": "creator",
   312→    "secondary": "explorer",
   313→    "shadow": "ruler"
   314→  },
   315→  "traits": [
   316→    { "source": "bazi", "trait": "表达力强" },
   317→    { "source": "zodiac", "trait": "好奇心旺" }
   318→  ]
   319→}
   320→```
   321→
   322→### 4.2 维度 2: 动态 (Dynamic) — 我现在怎么样
   323→
   324→**动态层：当前状态 + 变化趋势**
   325→
   326→来源：对话抽取（ProfileExtractor）
   327→
   328→```json
   329→{
   330→  "emotion": { "current": "calm", "intensity": 0.6 },
   331→  "energy": { "level": 0.7, "focus": ["career"] },
   332→  "active_archetype": "creator",
   333→  "trend": {
   334→    "archetype_shift": { "rising": "pioneer", "delta": 0.05 },
   335→    "emotion_trend": "stable",
   336→    "direction": "expansion"
   337→  }
   338→}
   339→```
   340→
   341→### 4.3 维度 3: 规律 (Pattern) — 我的行为模式
   342→
   343→**洞察层：长期规律**
   344→
   345→来源：历史行为分析
   346→
   347→```json
   348→{
   349→  "behaviors": [
   350→    { "pattern": "晚间活跃", "confidence": 0.8 },
   351→    { "pattern": "周期性低落", "trigger": "周一" }
   352→  ],
   353→  "insights": [
   354→    "你在压力下倾向于独处思考",
   355→    "创意灵感常在深夜涌现"
   356→  ]
   357→}
   358→```
   359→
   360→---
   361→
   362→## 5. VibeTarget 三维模型
   363→
   364→### 5.1 维度 1: 目标 (Goals) — 我想要什么
   365→
   366→来源：同步自 `skills.lifecoach.goals` + 对话抽取
   367→
   368→```json
   369→{
   370→  "goals": [
   371→    {
   372→      "id": "goal_001",
   373→      "title": "完成写作项目",
   374→      "source": "lifecoach",
   375→      "status": "in_progress",
   376→      "progress": 0.6
   377→    }
   378→  ]
   379→}
   380→```
   381→
   382→### 5.2 维度 2: 聚焦 (Focus) — 我现在关注什么
   383→
   384→来源：话题热度 + 目标活跃度
   385→
   386→```json
   387→{
   388→  "primary": "career",
   389→  "secondary": ["growth"],
   390→  "active_goal": "goal_001",
   391→  "heat_map": {
   392→    "career": 0.8,
   393→    "growth": 0.5,
   394→    "health": 0.2
   395→  }
   396→}
   397→```
   398→
   399→### 5.3 维度 3: 里程碑 (Milestones) — 我走过了什么
   400→
   401→来源：同步自 `skills.lifecoach.progress`
   402→
   403→```json
   404→{
   405→  "achieved": [
   406→    { "goal_id": "...", "title": "...", "achieved_at": "..." }
   407→  ],
   408→  "streak": { "current": 7, "best": 14 },
   409→  "moments": [
   410→    { "date": "...", "event": "首次公开分享写作" }
   411→  ]
   412→}
   413→```
   414→
   415→---
   416→
   417→## 6. 数据访问
   418→
   419→### 6.1 Repository API
   420→
   421→```python
   422→class UnifiedProfileRepository:
   423→    """唯一数据访问层"""
   424→
   425→    # ─────────────────────────────────────────────────────────────
   426→    # 读取
   427→    # ─────────────────────────────────────────────────────────────
   428→    async def get_profile(user_id: UUID) -> Dict
   429→    async def get_identity(user_id: UUID) -> Dict
   430→    async def get_skill_data(user_id: UUID, skill_id: str) -> Dict
   431→    async def get_vibe_insight(user_id: UUID) -> Dict
   432→    async def get_vibe_target(user_id: UUID) -> Dict
   433→    async def get_preferences(user_id: UUID) -> Dict
   434→
   435→    # ─────────────────────────────────────────────────────────────
   436→    # 写入（Layer 1: Identity）
   437→    # ─────────────────────────────────────────────────────────────
   438→    async def update_identity(user_id: UUID, identity: Dict)
   439→    async def update_birth_info(user_id: UUID, birth_info: Dict)
   440→
   441→    # ─────────────────────────────────────────────────────────────
   442→    # 写入（Layer 2: Skills）
   443→    # ─────────────────────────────────────────────────────────────
   444→    async def update_skill_data(user_id: UUID, skill_id: str, data: Dict)
   445→    async def merge_skill_data(user_id: UUID, skill_id: str, data: Dict)
   446→
   447→    # ─────────────────────────────────────────────────────────────
   448→    # 写入（Layer 3: Vibe）- 仅 ProfileExtractor 使用
   449→    # ─────────────────────────────────────────────────────────────
   450→    async def update_vibe_insight(user_id: UUID, insight: Dict)
   451→    async def update_vibe_target(user_id: UUID, target: Dict)
   452→
   453→    # ─────────────────────────────────────────────────────────────
   454→    # 写入（Preferences）
   455→    # ─────────────────────────────────────────────────────────────
   456→    async def update_preferences(user_id: UUID, preferences: Dict)
   457→```
   458→
   459→### 6.2 Prompt Builder 读取逻辑
   460→
   461→```python
   462→def _build_profile_context(self, profile: Dict, skill_id: str) -> str:
   463→    """构建 Profile 上下文注入到 System Prompt"""
   464→    parts = []
   465→
   466→    # Layer 1: Identity（所有 Skill 共享）
   467→    identity = profile.get("identity", {})
   468→    if identity.get("birth_info"):
   469→        parts.append(format_birth_info(identity["birth_info"]))
   470→
   471→    # Layer 2: Skill 专属数据
   472→    skill_data = profile.get("skills", {}).get(skill_id, {})
   473→    if skill_data:
   474→        parts.append(f"## {skill_id} 数据\n{json.dumps(skill_data)}")
   475→
   476→    # Layer 3: Vibe 共享深度信息（所有 Skill 可读）
   477→    vibe = profile.get("vibe", {})
   478→    if vibe.get("insight"):
   479→        parts.append(f"## 用户画像\n{format_insight(vibe['insight'])}")
   480→    if vibe.get("target"):
   481→        parts.append(f"## 用户目标\n{format_target(vibe['target'])}")
   482→
   483→    return "\n".join(parts)
   484→```
   485→
   486→---
   487→
   488→## 7. 迁移
   489→
   490→### 7.1 字段映射
   491→
   492→| 旧字段 | 新字段 | 说明 |
   493→|--------|--------|------|
   494→| `skill_data.bazi` | `skills.bazi` | 重命名 |
   495→| `skill_data.zodiac` | `skills.zodiac` | 重命名 |
   496→| `life_context._paths.lifecoach.content` | `skills.lifecoach` | 移动 |
   497→| `extracted.goals` | `vibe.target.goals` | 移动 |
   498→| `state.focus` | `vibe.target.focus` | 移动 |
   499→| `extracted.facts` | `vibe.insight.pattern.facts` | 移动 |
   500→| `extracted.concerns` | `vibe.insight.pattern.concerns` | 移动 |
   501→
   502→### 7.2 废弃的字段
   503→
   504→- `life_context._paths` - 整个结构废弃
   505→- `extracted.goals` - 移到 vibe.target
   506→- `state.focus` - 移到 vibe.target.focus
   507→- `state.emotion` - 移到 vibe.insight.dynamic
   508→
   509→---
   510→
   511→## 8. 与北极星对齐
   512→
   513→| 北极星 | 实现 |
   514→|--------|------|
   515→| **深度理解** | VibeInsight 三维模型（本质 + 动态 + 规律） |
   516→| **主动关心** | Proactive 读取 vibe.insight.dynamic + vibe.target.focus |
   517→| **无限扩展** | Skills 按领域划分，数据隔离 |
   518→| **温暖不粘腻** | VibeTarget 默认不加命理判断 |
   519→
   520→---
   521→
   522→## 附录：版本历史
   523→
   524→- **v3.0** (2026-01-22): 三层架构重构
   525→  - Identity + Skills + Vibe 三层分离
   526→  - 废弃 life_context._paths 结构
   527→  - 废弃 extracted.goals，移到 vibe.target
   528→  - 新增 vibe.insight 和 vibe.target 共享深度信息
   529→
   530→- **v2.3** (2026-01-19): UserDataSpace 统一管理
   531→- **v2.0** (2026-01-15): WHO/WHAT 分离
   532→- **v1.0** (2026-01-01): 初始版本
   533→