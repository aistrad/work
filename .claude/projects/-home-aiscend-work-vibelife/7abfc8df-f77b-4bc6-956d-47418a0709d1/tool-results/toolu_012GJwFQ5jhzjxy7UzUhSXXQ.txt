apps/api/workers/profile_extractor.py:7:- 输出结构化 JSON，写入 unified_profiles.profile.extracted
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-8-"""
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-9-import asyncio
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-10-import json
--
apps/api/workers/profile_extractor.py:103:async def _write_to_cold_layer(user_id: UUID, extracted: Dict[str, Any]) -> None:
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-104-    """
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-105-    将重要洞察和事件写入 Cold Layer
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-106-
--
apps/api/workers/profile_extractor.py:110:    if not extracted:
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-111-        return
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-112-
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-113-    # 写入生活事件到时间线
apps/api/workers/profile_extractor.py:114:    life_events = extracted.get("life_events", [])
apps/api/workers/profile_extractor.py-115-    for event in life_events:
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-116-        event_text = event.get("event", "")
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-117-        event_date_str = event.get("date", "")
--
apps/api/workers/profile_extractor.py:139:    patterns = extracted.get("patterns", {})
apps/api/workers/profile_extractor.py-140-    if patterns:
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-141-        # 从模式中提取重要发现
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-142-        conversation_style = patterns.get("conversation_style")
--
apps/api/workers/profile_extractor.py:156:def merge_extracted(current: Dict[str, Any], new: Dict[str, Any]) -> Dict[str, Any]:
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-157-    """合并抽取结果"""
apps/api/workers/profile_extractor.py-158-    if not new:
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-159-        return current
--
apps/api/workers/profile_extractor.py:223:    # 1. 获取现有 extracted 数据
apps/api/workers/profile_extractor.py:224:    current_extracted = await UnifiedProfileRepository.get_extracted(user_id)
apps/api/workers/profile_extractor.py:225:    last_extracted_at = current_extracted.get("last_extracted_at") if current_extracted else None
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-226-
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-227-    # 2. 确定抽取起始时间
apps/api/workers/profile_extractor.py:228:    if last_extracted_at:
apps/api/workers/profile_extractor.py-229-        try:
apps/api/workers/profile_extractor.py:230:            since = datetime.fromisoformat(last_extracted_at.replace("Z", "+00:00"))
apps/api/workers/profile_extractor.py-231-        except (ValueError, AttributeError):
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-232-            since = datetime.now() - timedelta(days=7)
apps/api/workers/profile_extractor.py-233-    else:
--
apps/api/workers/profile_extractor.py:241:        return current_extracted or {}
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-242-
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-243-    # 4. 格式化消息
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-244-    messages_text = "\n".join([
--
apps/api/workers/profile_extractor.py:252:        return current_extracted or {}
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-253-
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-254-    # 5. 构建 prompt
/home/aiscend/work/vibelife/apps/api/workers/profile_extractor.py-255-    prompt = f"""## 当前已有信息

[Showing results with pagination = limit: 50, offset: 0]