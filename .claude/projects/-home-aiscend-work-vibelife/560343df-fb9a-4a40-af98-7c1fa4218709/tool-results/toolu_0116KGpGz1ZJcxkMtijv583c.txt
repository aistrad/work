     1â†’"""
     2â†’SkillLoader v7 - æ”¯æŒ Agentic + Rule æ¶æ„çš„ Skill åŠ è½½å™¨
     3â†’
     4â†’v7 æ¶æ„ï¼š
     5â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
     6â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
     7â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
     8â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
     9â†’
    10â†’v7.4 æ–°å¢ï¼š
    11â†’- Skill Management æ”¯æŒï¼šcategory, pricing, showcase, subscription å­—æ®µ
    12â†’
    13â†’v7.5 æ–°å¢ï¼š
    14â†’- æ•°æ®åº“ä¼˜å…ˆå…ƒæ•°æ®åŠ è½½ï¼ˆskill_catalog è¡¨ï¼‰
    15â†’- async å‡½æ•°æ”¯æŒï¼šload_skill_metadata_async, get_all_skill_metadata_async
    16â†’- SKILL.md ä½œä¸º fallback
    17â†’"""
    18â†’import re
    19â†’import json
    20â†’import logging
    21â†’import yaml
    22â†’from pathlib import Path
    23â†’from dataclasses import dataclass, field
    24â†’from typing import Dict, List, Optional, Any
    25â†’from functools import lru_cache
    26â†’
    27â†’logger = logging.getLogger(__name__)
    28â†’
    29â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    30â†’
    31â†’
    32â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    33â†’# æ•°æ®ç»“æ„
    34â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    35â†’
    36â†’@dataclass
    37â†’class SkillPricing:
    38â†’    """Skill å®šä»·é…ç½®"""
    39â†’    type: str = "free"  # free | premium | credits
    40â†’    trial_messages: int = 3
    41â†’    credits_per_use: Optional[int] = None
    42â†’
    43â†’
    44â†’@dataclass
    45â†’class SkillShowcase:
    46â†’    """Skill å±•ç¤ºé…ç½®ï¼ˆç”¨äº Skill å¸‚åœºï¼‰"""
    47â†’    tagline: str = ""
    48â†’    highlights: List[str] = field(default_factory=list)
    49â†’    preview_image: Optional[str] = None
    50â†’    demo_prompts: List[str] = field(default_factory=list)
    51â†’
    52â†’
    53â†’@dataclass
    54â†’class SkillSubscription:
    55â†’    """Skill è®¢é˜…é…ç½®"""
    56â†’    auto_subscribe: bool = False
    57â†’    can_unsubscribe: bool = True
    58â†’    push_default: bool = True
    59â†’    min_subscription_days: int = 0
    60â†’
    61â†’
    62â†’@dataclass
    63â†’class SkillFeature:
    64â†’    """Skill åŠŸèƒ½ç‰¹æ€§"""
    65â†’    name: str
    66â†’    description: str = ""
    67â†’    icon: str = "ğŸ“Œ"
    68â†’    tier: str = "free"  # free | basic | premium
    69â†’
    70â†’
    71â†’@dataclass
    72â†’class SkillMetadata:
    73â†’    """Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰"""
    74â†’    id: str
    75â†’    name: str
    76â†’    description: str
    77â†’    version: str = "1.0.0"
    78â†’    category: str = "professional"  # core | default | professional
    79â†’    icon: str = "ğŸ’¡"
    80â†’    color: str = "#6B7280"
    81â†’    triggers: List[str] = field(default_factory=list)
    82â†’    pricing: SkillPricing = field(default_factory=SkillPricing)
    83â†’    features: List[SkillFeature] = field(default_factory=list)
    84â†’    showcase: SkillShowcase = field(default_factory=SkillShowcase)
    85â†’    subscription: SkillSubscription = field(default_factory=SkillSubscription)
    86â†’
    87â†’    def to_dict(self) -> Dict[str, Any]:
    88â†’        """è½¬æ¢ä¸º API å“åº”æ ¼å¼"""
    89â†’        return {
    90â†’            "id": self.id,
    91â†’            "name": self.name,
    92â†’            "description": self.description,
    93â†’            "version": self.version,
    94â†’            "category": self.category,
    95â†’            "icon": self.icon,
    96â†’            "color": self.color,
    97â†’            "triggers": self.triggers,
    98â†’            "pricing": {
    99â†’                "type": self.pricing.type,
   100â†’                "trial_messages": self.pricing.trial_messages,
   101â†’                "credits_per_use": self.pricing.credits_per_use,
   102â†’            },
   103â†’            "features": [
   104â†’                {"name": f.name, "description": f.description, "icon": f.icon, "tier": f.tier}
   105â†’                for f in self.features
   106â†’            ],
   107â†’            "showcase": {
   108â†’                "tagline": self.showcase.tagline,
   109â†’                "highlights": self.showcase.highlights,
   110â†’                "preview_image": self.showcase.preview_image,
   111â†’                "demo_prompts": self.showcase.demo_prompts,
   112â†’            },
   113â†’            "subscription": {
   114â†’                "auto_subscribe": self.subscription.auto_subscribe,
   115â†’                "can_unsubscribe": self.subscription.can_unsubscribe,
   116â†’                "push_default": self.subscription.push_default,
   117â†’            },
   118â†’        }
   119â†’
   120â†’
   121â†’@dataclass
   122â†’class SkillConfig:
   123â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
   124â†’    id: str
   125â†’    name: str
   126â†’    description: str
   127â†’    expert_persona: str
   128â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
   129â†’    ethics: Dict[str, Any]
   130â†’    tools: List[str]
   131â†’    default_scenario: str = "basic_reading"
   132â†’    triggers: List[str] = field(default_factory=list)
   133â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
   134â†’    # v7.1: SOP é…ç½®é©±åŠ¨
   135â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
   136â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
   137â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
   138â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   139â†’    collect_tool: Optional[str] = None # æ”¶é›†å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   140â†’    external_tools: List[str] = field(default_factory=list)  # v7.3: ä»å…¶ä»– skill å¯¼å…¥çš„å·¥å…·
   141â†’    # v2.2: Profile æ³¨å…¥é…ç½®
   142â†’    requires_skill_data: List[str] = field(default_factory=list)  # éœ€è¦çš„ skill_dataï¼Œç©ºåˆ—è¡¨è¡¨ç¤ºåªéœ€è‡ªèº«
   143â†’
   144â†’
   145â†’@dataclass
   146â†’class ServiceItem:
   147â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
   148â†’    scenario_id: str
   149â†’    name: str
   150â†’    icon: str
   151â†’    description: str
   152â†’    tier: str  # entry/standard/professional
   153â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
   154â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
   155â†’
   156â†’
   157â†’@dataclass
   158â†’class ScenarioConfig:
   159â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
   160â†’    id: str
   161â†’    name: str
   162â†’    level: str  # entry/standard/professional
   163â†’    billing: str  # free/basic/premium
   164â†’    description: str
   165â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
   166â†’    prerequisites: List[str]
   167â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
   168â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
   169â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
   170â†’    tools: List[str]
   171â†’
   172â†’
   173â†’@dataclass
   174â†’class ToolMetadata:
   175â†’    """å·¥å…·å…ƒæ•°æ®"""
   176â†’    name: str
   177â†’    description: str
   178â†’    tool_type: str  # collect/calculate/display/search
   179â†’    card_type: Optional[str] = None
   180â†’    card_props_schema: Optional[Dict] = None
   181â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   182â†’    when_to_call: Optional[str] = None
   183â†’
   184â†’
   185â†’@dataclass
   186â†’class RuleConfig:
   187â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
   188â†’    id: str
   189â†’    name: str
   190â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
   191â†’    impact_description: str
   192â†’    tags: List[str]
   193â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
   194â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
   195â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
   196â†’    common_questions: str  # å¸¸è§é—®é¢˜
   197â†’
   198â†’
   199â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   200â†’# è§£æå‡½æ•°
   201â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   202â†’
   203â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   204â†’    """è§£æ YAML frontmatterï¼ˆæ”¯æŒåµŒå¥—å¯¹è±¡ï¼‰"""
   205â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   206â†’    match = re.match(pattern, text, re.DOTALL)
   207â†’    if not match:
   208â†’        return {}, text
   209â†’
   210â†’    frontmatter_str, content = match.groups()
   211â†’
   212â†’    # ä½¿ç”¨ YAML è§£æä»¥æ”¯æŒåµŒå¥—å¯¹è±¡
   213â†’    try:
   214â†’        metadata = yaml.safe_load(frontmatter_str) or {}
   215â†’    except yaml.YAMLError as e:
   216â†’        logger.warning(f"YAML parse error in frontmatter: {e}, falling back to simple parse")
   217â†’        # å›é€€åˆ°ç®€å•è§£æ
   218â†’        metadata = {}
   219â†’        current_key = None
   220â†’        current_list = None
   221â†’
   222â†’        for line in frontmatter_str.strip().split('\n'):
   223â†’            stripped = line.strip()
   224â†’            if not stripped:
   225â†’                continue
   226â†’            if stripped.startswith('- ') and current_key:
   227â†’                if current_list is None:
   228â†’                    current_list = []
   229â†’                current_list.append(stripped[2:].strip())
   230â†’                metadata[current_key] = current_list
   231â†’            elif ':' in line and not line.startswith(' '):
   232â†’                current_list = None
   233â†’                key, value = line.split(':', 1)
   234â†’                current_key = key.strip()
   235â†’                value = value.strip()
   236â†’                if value in ('|', ''):
   237â†’                    continue
   238â†’                elif value.lower() == 'true':
   239â†’                    metadata[current_key] = True
   240â†’                elif value.lower() == 'false':
   241â†’                    metadata[current_key] = False
   242â†’                else:
   243â†’                    metadata[current_key] = value
   244â†’
   245â†’    return metadata, content.strip()
   246â†’
   247â†’
   248â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   249â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   250â†’
   251â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   252â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   253â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   254â†’    """
   255â†’    metadata, content = parse_frontmatter(text)
   256â†’
   257â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   258â†’    triggers = metadata.get("triggers", [])
   259â†’
   260â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   261â†’    if not triggers:
   262â†’        description = metadata.get("description", "")
   263â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   264â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   265â†’        if trigger_match:
   266â†’            trigger_str = trigger_match.group(1)
   267â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   268â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   269â†’
   270â†’    result = {
   271â†’        "id": metadata.get("id", ""),
   272â†’        "name": metadata.get("name", ""),
   273â†’        "description": metadata.get("description", ""),
   274â†’        "triggers": triggers,
   275â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   276â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   277â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   278â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   279â†’        "requires_compute": metadata.get("requires_compute", False),
   280â†’        "compute_type": metadata.get("compute_type", None),
   281â†’        "compute_tool": metadata.get("compute_tool", None),
   282â†’        "collect_tool": metadata.get("collect_tool", None),
   283â†’        "external_tools": metadata.get("external_tools", []),  # v7.3
   284â†’        # v2.2: Profile æ³¨å…¥é…ç½®
   285â†’        "requires_skill_data": metadata.get("requires_skill_data", []),
   286â†’    }
   287â†’
   288â†’    # æå–ä¸“å®¶èº«ä»½
   289â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   290â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   291â†’
   292â†’    # æå–åœºæ™¯ç›®å½•
   293â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   294â†’    for level in scenarios.keys():
   295â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   296â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   297â†’        if match:
   298â†’            for row in match.group(1).strip().split('\n'):
   299â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   300â†’                if len(cols) >= 2:
   301â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   302â†’    result["scenarios"] = scenarios
   303â†’
   304â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   305â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   306â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   307â†’    if forbidden_match:
   308â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   309â†’    result["ethics"] = ethics
   310â†’
   311â†’    # æå–å·¥å…·åˆ—è¡¨
   312â†’    tools = []
   313â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   314â†’    if tools_match:
   315â†’        for row in tools_match.group(1).strip().split('\n'):
   316â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   317â†’            if len(cols) >= 1:
   318â†’                tools.append(cols[0])
   319â†’    result["tools"] = tools
   320â†’
   321â†’    return result
   322â†’
   323â†’
   324â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   325â†’    """è§£æ scenario.md å†…å®¹"""
   326â†’    metadata, content = parse_frontmatter(text)
   327â†’
   328â†’    result = {
   329â†’        "id": metadata.get("id", ""),
   330â†’        "name": metadata.get("name", ""),
   331â†’        "level": metadata.get("level", "entry"),
   332â†’        "billing": metadata.get("billing", "free"),
   333â†’        "description": metadata.get("description", ""),
   334â†’    }
   335â†’
   336â†’    # æå–è§¦å‘æ¡ä»¶
   337â†’    triggers = {"primary": [], "secondary": []}
   338â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   339â†’    if primary_match:
   340â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   341â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   342â†’    if secondary_match:
   343â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   344â†’    result["triggers"] = triggers
   345â†’
   346â†’    # æå–å‰ç½®è¦æ±‚
   347â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   348â†’    result["prerequisites"] = []
   349â†’    if prereq_match:
   350â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   351â†’
   352â†’    # æå– SOP é˜¶æ®µ
   353â†’    sop = []
   354â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   355â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   356â†’        phase_num, phase_name, phase_content = match.groups()
   357â†’        phase = {
   358â†’            "phase": int(phase_num),
   359â†’            "name": phase_name.strip(),
   360â†’            "content": phase_content.strip()
   361â†’        }
   362â†’        # æå–ç±»å‹
   363â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   364â†’        if type_match:
   365â†’            phase["type"] = type_match.group(1)
   366â†’        sop.append(phase)
   367â†’    result["sop"] = sop
   368â†’
   369â†’    # æå–å·¥å…·åˆ—è¡¨
   370â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   371â†’    result["tools"] = []
   372â†’    if tools_match:
   373â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   374â†’
   375â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   376â†’    result["knowledge_config"] = {}
   377â†’    result["output_config"] = {}
   378â†’
   379â†’    return result
   380â†’
   381â†’
   382â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   383â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   384â†’    metadata, content = parse_frontmatter(text)
   385â†’
   386â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   387â†’    tags_raw = metadata.get("tags", [])
   388â†’    if isinstance(tags_raw, str):
   389â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   390â†’    else:
   391â†’        tags = tags_raw
   392â†’
   393â†’    result = {
   394â†’        "id": metadata.get("id", ""),
   395â†’        "name": metadata.get("name", ""),
   396â†’        "impact": metadata.get("impact", "MEDIUM"),
   397â†’        "impact_description": metadata.get("impactDescription", ""),
   398â†’        "tags": tags,
   399â†’        "content": content,
   400â†’    }
   401â†’
   402â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   403â†’    analysis_steps = []
   404â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   405â†’    if table_match:
   406â†’        for row in table_match.group(1).strip().split('\n'):
   407â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   408â†’            if len(cols) >= 4:
   409â†’                analysis_steps.append({
   410â†’                    "step": cols[0],
   411â†’                    "point": cols[1],
   412â†’                    "query": cols[2],
   413â†’                    "priority": cols[3],
   414â†’                })
   415â†’    result["analysis_steps"] = analysis_steps
   416â†’
   417â†’    # æå–è¾“å‡ºè¦æ±‚
   418â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   419â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   420â†’
   421â†’    # æå–å¸¸è§é—®é¢˜
   422â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   423â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   424â†’
   425â†’    return result
   426â†’
   427â†’
   428â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   429â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   430â†’    services = {"entry": [], "standard": [], "professional": []}
   431â†’
   432â†’    tier_map = {
   433â†’        "entry": "entry",
   434â†’        "standard": "standard",
   435â†’        "professional": "professional"
   436â†’    }
   437â†’
   438â†’    for tier_name, tier_key in tier_map.items():
   439â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   440â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   441â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   442â†’        if not match:
   443â†’            continue
   444â†’
   445â†’        table_content = match.group(1).strip()
   446â†’        if not table_content:
   447â†’            continue
   448â†’
   449â†’        for row in table_content.split('\n'):
   450â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   451â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   452â†’                continue
   453â†’
   454â†’            service = {
   455â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   456â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   457â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   458â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   459â†’                "tier": tier_key,
   460â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   461â†’                "highlights": []
   462â†’            }
   463â†’
   464â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   465â†’            if len(cols) > 7 and cols[7]:
   466â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   467â†’
   468â†’            services[tier_key].append(service)
   469â†’
   470â†’    return services
   471â†’
   472â†’
   473â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   474â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   475â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   476â†’    if not skill_path.exists():
   477â†’        return None
   478â†’
   479â†’    text = skill_path.read_text(encoding='utf-8')
   480â†’    metadata, _ = parse_frontmatter(text)
   481â†’    services = parse_skill_services(text)
   482â†’
   483â†’    return {
   484â†’        "skill_id": skill_id,
   485â†’        "skill_name": metadata.get("name", skill_id),
   486â†’        "description": metadata.get("description", ""),
   487â†’        "services": services
   488â†’    }
   489â†’
   490â†’
   491â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   492â†’# åŠ è½½å‡½æ•°
   493â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   494â†’
   495â†’@lru_cache(maxsize=32)
   496â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   497â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   498â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   499â†’    if not skill_path.exists():
   500â†’        return None
   501â†’
   502â†’    text = skill_path.read_text(encoding='utf-8')
   503â†’    data = parse_skill_md(text)
   504â†’
   505â†’    return SkillConfig(
   506â†’        id=data.get("id", skill_id),
   507â†’        name=data.get("name", skill_id),
   508â†’        description=data.get("description", ""),
   509â†’        expert_persona=data.get("expert_persona", ""),
   510â†’        scenarios=data.get("scenarios", {}),
   511â†’        ethics=data.get("ethics", {}),
   512â†’        tools=data.get("tools", []),
   513â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   514â†’        triggers=data.get("triggers", []),
   515â†’        global_tools=data.get("global_tools", []),
   516â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   517â†’        requires_birth_info=data.get("requires_birth_info", False),
   518â†’        requires_compute=data.get("requires_compute", False),
   519â†’        compute_type=data.get("compute_type", None),
   520â†’        compute_tool=data.get("compute_tool", None),
   521â†’        collect_tool=data.get("collect_tool", None),
   522â†’        external_tools=data.get("external_tools", []),  # v7.3
   523â†’        # v2.2: Profile æ³¨å…¥é…ç½®
   524â†’        requires_skill_data=data.get("requires_skill_data", []),
   525â†’    )
   526â†’
   527â†’
   528â†’@lru_cache(maxsize=32)
   529â†’def load_skill_metadata(skill_id: str) -> Optional[SkillMetadata]:
   530â†’    """åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰- v7.4 æ–°å¢
   531â†’
   532â†’    ä» SKILL.md çš„ frontmatter ä¸­è¯»å–å®Œæ•´çš„å…ƒæ•°æ®é…ç½®ï¼Œ
   533â†’    åŒ…æ‹¬ category, pricing, showcase, subscription ç­‰å­—æ®µã€‚
   534â†’    """
   535â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   536â†’    if not skill_path.exists():
   537â†’        return None
   538â†’
   539â†’    text = skill_path.read_text(encoding='utf-8')
   540â†’    metadata, _ = parse_frontmatter(text)
   541â†’
   542â†’    # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   543â†’    triggers = metadata.get("triggers", [])
   544â†’    if not triggers:
   545â†’        description = metadata.get("description", "")
   546â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   547â†’        if trigger_match:
   548â†’            trigger_str = trigger_match.group(1)
   549â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   550â†’
   551â†’    # è§£æ pricing
   552â†’    pricing_data = metadata.get("pricing", {})
   553â†’    pricing = SkillPricing(
   554â†’        type=pricing_data.get("type", "free") if isinstance(pricing_data, dict) else "free",
   555â†’        trial_messages=pricing_data.get("trial_messages", 3) if isinstance(pricing_data, dict) else 3,
   556â†’        credits_per_use=pricing_data.get("credits_per_use") if isinstance(pricing_data, dict) else None,
   557â†’    )
   558â†’
   559â†’    # è§£æ features
   560â†’    features_data = metadata.get("features", [])
   561â†’    features = []
   562â†’    if isinstance(features_data, list):
   563â†’        for f in features_data:
   564â†’            if isinstance(f, dict):
   565â†’                features.append(SkillFeature(
   566â†’                    name=f.get("name", ""),
   567â†’                    description=f.get("description", ""),
   568â†’                    icon=f.get("icon", "ğŸ“Œ"),
   569â†’                    tier=f.get("tier", "free"),
   570â†’                ))
   571â†’
   572â†’    # è§£æ showcase
   573â†’    showcase_data = metadata.get("showcase", {})
   574â†’    showcase = SkillShowcase(
   575â†’        tagline=showcase_data.get("tagline", "") if isinstance(showcase_data, dict) else "",
   576â†’        highlights=showcase_data.get("highlights", []) if isinstance(showcase_data, dict) else [],
   577â†’        preview_image=showcase_data.get("preview_image") if isinstance(showcase_data, dict) else None,
   578â†’        demo_prompts=showcase_data.get("demo_prompts", []) if isinstance(showcase_data, dict) else [],
   579â†’    )
   580â†’
   581â†’    # è§£æ subscription
   582â†’    subscription_data = metadata.get("subscription", {})
   583â†’    category = metadata.get("category", "professional")
   584â†’    subscription = SkillSubscription(
   585â†’        auto_subscribe=subscription_data.get("auto_subscribe", category == "default") if isinstance(subscription_data, dict) else (category == "default"),
   586â†’        can_unsubscribe=subscription_data.get("can_unsubscribe", category != "core") if isinstance(subscription_data, dict) else (category != "core"),
   587â†’        push_default=subscription_data.get("push_default", True) if isinstance(subscription_data, dict) else True,
   588â†’        min_subscription_days=subscription_data.get("min_subscription_days", 0) if isinstance(subscription_data, dict) else 0,
   589â†’    )
   590â†’
   591â†’    return SkillMetadata(
   592â†’        id=metadata.get("id", skill_id),
   593â†’        name=metadata.get("name", skill_id),
   594â†’        description=metadata.get("description", ""),
   595â†’        version=metadata.get("version", "1.0.0"),
   596â†’        category=category,
   597â†’        icon=metadata.get("icon", "ğŸ’¡"),
   598â†’        color=metadata.get("color", "#6B7280"),
   599â†’        triggers=triggers,
   600â†’        pricing=pricing,
   601â†’        features=features,
   602â†’        showcase=showcase,
   603â†’        subscription=subscription,
   604â†’    )
   605â†’
   606â†’
   607â†’def get_all_skill_metadata() -> List[SkillMetadata]:
   608â†’    """è·å–æ‰€æœ‰å¯ç”¨ Skill çš„å…ƒæ•°æ®ï¼ˆç”¨äº Skill åˆ—è¡¨ APIï¼‰- v7.4 æ–°å¢"""
   609â†’    skills = []
   610â†’    for skill_id in get_available_skills():
   611â†’        metadata = load_skill_metadata(skill_id)
   612â†’        if metadata:
   613â†’            skills.append(metadata)
   614â†’    return skills
   615â†’
   616â†’
   617â†’def get_skills_by_category(category: str) -> List[SkillMetadata]:
   618â†’    """æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ - v7.4 æ–°å¢
   619â†’
   620â†’    Args:
   621â†’        category: core | default | professional
   622â†’
   623â†’    Returns:
   624â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„å…ƒæ•°æ®åˆ—è¡¨
   625â†’    """
   626â†’    return [s for s in get_all_skill_metadata() if s.category == category]
   627â†’
   628â†’
   629â†’@lru_cache(maxsize=64)
   630â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   631â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   632â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   633â†’    if not scenario_path.exists():
   634â†’        return None
   635â†’
   636â†’    text = scenario_path.read_text(encoding='utf-8')
   637â†’    data = parse_scenario_md(text)
   638â†’
   639â†’    return ScenarioConfig(
   640â†’        id=data.get("id", scenario_id),
   641â†’        name=data.get("name", scenario_id),
   642â†’        level=data.get("level", "entry"),
   643â†’        billing=data.get("billing", "free"),
   644â†’        description=data.get("description", ""),
   645â†’        triggers=data.get("triggers", {}),
   646â†’        prerequisites=data.get("prerequisites", []),
   647â†’        sop=data.get("sop", []),
   648â†’        knowledge_config=data.get("knowledge_config", {}),
   649â†’        output_config=data.get("output_config", {}),
   650â†’        tools=data.get("tools", [])
   651â†’    )
   652â†’
   653â†’
   654â†’@lru_cache(maxsize=128)
   655â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   656â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢
   657â†’
   658â†’    æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
   659â†’    1. æ ¹ç›®å½•è§„åˆ™: rule_id="dankoe" -> rules/dankoe.md
   660â†’    2. å­ç›®å½•è§„åˆ™: rule_id="companion/weekly-review" -> rules/companion/weekly-review.md
   661â†’
   662â†’    å®¹é”™å¤„ç†ï¼š
   663â†’    - è‡ªåŠ¨å¤„ç†å·²å¸¦ .md åç¼€çš„ rule_id
   664â†’    - æ‹’ç»ç›®å½•è·¯å¾„
   665â†’    """
   666â†’    # å…ˆå°è¯•æ ‡å‡†æ ¼å¼ï¼ˆè‡ªåŠ¨æ·»åŠ  .md åç¼€ï¼‰
   667â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   668â†’
   669â†’    if not rule_path.exists():
   670â†’        # Fallback: å°è¯•ç›´æ¥ä½œä¸ºè·¯å¾„ï¼ˆå¤„ç†å·²å¸¦ .md åç¼€çš„æƒ…å†µï¼‰
   671â†’        rule_path = SKILLS_DIR / skill_id / "rules" / rule_id
   672â†’
   673â†’        # æ‹’ç»ç›®å½•
   674â†’        if rule_path.is_dir():
   675â†’            logger.warning(f"load_rule: {rule_id} is a directory, not a rule file")
   676â†’            return None
   677â†’
   678â†’        # å¦‚æœæ²¡æœ‰åç¼€ï¼Œæ·»åŠ  .md
   679â†’        if not rule_path.suffix:
   680â†’            rule_path = rule_path.with_suffix(".md")
   681â†’
   682â†’        # ä»ç„¶ä¸å­˜åœ¨ï¼Œè¿”å› None
   683â†’        if not rule_path.exists():
   684â†’            return None
   685â†’
   686â†’    try:
   687â†’        text = rule_path.read_text(encoding='utf-8')
   688â†’        data = parse_rule_md(text)
   689â†’
   690â†’        return RuleConfig(
   691â†’            id=data.get("id", rule_id),
   692â†’            name=data.get("name", rule_id),
   693â†’            impact=data.get("impact", "MEDIUM"),
   694â†’            impact_description=data.get("impact_description", ""),
   695â†’            tags=data.get("tags", []),
   696â†’            content=data.get("content", ""),
   697â†’            analysis_steps=data.get("analysis_steps", []),
   698â†’            output_requirements=data.get("output_requirements", ""),
   699â†’            common_questions=data.get("common_questions", ""),
   700â†’        )
   701â†’    except Exception as e:
   702â†’        logger.error(f"load_rule: Failed to load {skill_id}/{rule_id}: {e}")
   703â†’        return None
   704â†’
   705â†’
   706â†’def get_skill_rules(skill_id: str) -> List[str]:
   707â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢
   708â†’
   709â†’    è¿”å›æ ¼å¼ï¼š
   710â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   711â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   712â†’    """
   713â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   714â†’    if not rules_dir.exists():
   715â†’        return []
   716â†’
   717â†’    rule_ids = []
   718â†’
   719â†’    # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   720â†’    for md_file in rules_dir.rglob("*.md"):
   721â†’        # è·³è¿‡ _index.md ç­‰
   722â†’        if md_file.stem.startswith("_"):
   723â†’            continue
   724â†’
   725â†’        # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   726â†’        relative_path = md_file.relative_to(rules_dir)
   727â†’        rule_id = str(relative_path.with_suffix(""))
   728â†’
   729â†’        # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   730â†’        rule_id = rule_id.replace("\\", "/")
   731â†’
   732â†’        rule_ids.append(rule_id)
   733â†’
   734â†’    return sorted(rule_ids)
   735â†’
   736â†’
   737â†’def has_rules(skill_id: str) -> bool:
   738â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   739â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   740â†’    if not rules_dir.exists():
   741â†’        return False
   742â†’    rules = list(rules_dir.glob("*.md"))
   743â†’    return len(rules) > 0
   744â†’
   745â†’
   746â†’def get_available_skills() -> List[str]:
   747â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   748â†’    if not SKILLS_DIR.exists():
   749â†’        return []
   750â†’    return [p.name for p in SKILLS_DIR.iterdir()
   751â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   752â†’
   753â†’
   754â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   755â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   756â†’
   757â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   758â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   759â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼Œæ”¯æŒå­ç›®å½•ï¼‰
   760â†’
   761â†’    è¿”å›æ ¼å¼ï¼š
   762â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   763â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   764â†’    """
   765â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   766â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   767â†’    if rules_dir.exists():
   768â†’        rule_ids = []
   769â†’        # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   770â†’        for md_file in rules_dir.rglob("*.md"):
   771â†’            # è·³è¿‡ _index.md ç­‰
   772â†’            if md_file.stem.startswith("_"):
   773â†’                continue
   774â†’
   775â†’            # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   776â†’            relative_path = md_file.relative_to(rules_dir)
   777â†’            rule_id = str(relative_path.with_suffix(""))
   778â†’
   779â†’            # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   780â†’            rule_id = rule_id.replace("\\", "/")
   781â†’
   782â†’            rule_ids.append(rule_id)
   783â†’
   784â†’        if rule_ids:
   785â†’            return sorted(rule_ids)
   786â†’
   787â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   788â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   789â†’    if not scenarios_dir.exists():
   790â†’        return []
   791â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   792â†’
   793â†’
   794â†’def get_skill_triggers() -> Dict[str, List[str]]:
   795â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   796â†’    triggers = {}
   797â†’    for skill_id in get_available_skills():
   798â†’        if skill_id == "core":
   799â†’            continue
   800â†’        skill = load_skill(skill_id)
   801â†’        if skill and skill.triggers:
   802â†’            triggers[skill_id] = skill.triggers
   803â†’    return triggers
   804â†’
   805â†’
   806â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   807â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   808â†’    skill = load_skill(skill_id)
   809â†’    if skill and skill.global_tools:
   810â†’        return skill.global_tools
   811â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   812â†’    return []
   813â†’
   814â†’
   815â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   816â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   817â†’    skill = load_skill(skill_id)
   818â†’    if skill and skill.external_tools:
   819â†’        return skill.external_tools
   820â†’    return []
   821â†’
   822â†’
   823â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   824â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
   825â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   826â†’
   827â†’def skill_requires_birth_info(skill_id: str) -> bool:
   828â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   829â†’    skill = load_skill(skill_id)
   830â†’    return skill.requires_birth_info if skill else False
   831â†’
   832â†’
   833â†’def skill_requires_compute(skill_id: str) -> bool:
   834â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
   835â†’    skill = load_skill(skill_id)
   836â†’    return skill.requires_compute if skill else False
   837â†’
   838â†’
   839â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
   840â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
   841â†’
   842â†’    è¿”å›å€¼ï¼š
   843â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
   844â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
   845â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
   846â†’    """
   847â†’    skill = load_skill(skill_id)
   848â†’    return skill.compute_type if skill else None
   849â†’
   850â†’
   851â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
   852â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   853â†’
   854â†’    è¿”å›å€¼ï¼š
   855â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
   856â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   857â†’    """
   858â†’    skill = load_skill(skill_id)
   859â†’    return skill.compute_tool if skill else None
   860â†’
   861â†’
   862â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
   863â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
   864â†’
   865â†’    è¿”å›å€¼ï¼š
   866â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
   867â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   868â†’    """
   869â†’    skill = load_skill(skill_id)
   870â†’    return skill.collect_tool if skill else None
   871â†’
   872â†’
   873â†’def get_skill_required_data(skill_id: str) -> List[str]:
   874â†’    """è·å– Skill éœ€è¦çš„ skill_data åˆ—è¡¨ï¼ˆé…ç½®é©±åŠ¨ï¼‰- v2.2
   875â†’
   876â†’    è¿”å›å€¼ï¼š
   877â†’    - é…ç½®çš„ skill_data åˆ—è¡¨ï¼ˆå¦‚ ["bazi", "zodiac"]ï¼‰
   878â†’    - ç©ºåˆ—è¡¨æ—¶è¿”å› [skill_id]ï¼ˆé»˜è®¤åªéœ€è‡ªèº«æ•°æ®ï¼‰
   879â†’
   880â†’    ç¤ºä¾‹ï¼š
   881â†’    - bazi â†’ ["bazi"]ï¼ˆé»˜è®¤ï¼Œåªéœ€è‡ªèº«ï¼‰
   882â†’    - jungastro â†’ ["bazi", "zodiac"]ï¼ˆé…ç½®äº† requires_skill_dataï¼‰
   883â†’    - vibe_id â†’ ["bazi", "zodiac"]ï¼ˆé…ç½®äº† requires_skill_dataï¼‰
   884â†’    """
   885â†’    skill = load_skill(skill_id)
   886â†’    if skill and skill.requires_skill_data:
   887â†’        return skill.requires_skill_data
   888â†’    return [skill_id]  # é»˜è®¤åªéœ€è‡ªèº«
   889â†’
   890â†’
   891â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   892â†’# System Prompt æ„å»º
   893â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   894â†’
   895â†’# V2: è¯­æ°”æ¨¡å¼ Prompt æ¨¡æ¿
   896â†’# ä¸æ•°æ®åº“çº¦æŸä¸€è‡´ï¼šwarm, sarcastic, wise
   897â†’VOICE_MODE_PROMPTS = {
   898â†’    "warm": """## è¯­æ°”é£æ ¼ï¼šæ¸©æš–æ”¯æŒå‹
   899â†’åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿã€‚
   900â†’- ç”¨"æˆ‘ä»¬"è€Œé"ä½ åº”è¯¥"
   901â†’- å…ˆè‚¯å®šæ„Ÿå—ï¼Œå†å¼•å¯¼æ€è€ƒ
   902â†’- ç”¨é—®é¢˜ä»£æ›¿å»ºè®®
   903â†’""",
   904â†’    "sarcastic": """## è¯­æ°”é£æ ¼ï¼šç›´æ¥æŒ‘æˆ˜å‹ï¼ˆæ¯’èˆŒä½†æœ‰çˆ±ï¼‰
   905â†’ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸ã€‚
   906â†’- ç›´æ¥æŒ‡å‡ºé—®é¢˜ï¼Œä¸ç»•å¼¯å­
   907â†’- ç”¨å¹½é»˜ç¼“è§£çŠ€åˆ©ï¼Œé¿å…ä¼¤å®³
   908â†’- åœ¨åæ§½ä¸­å¸¦ç€æœŸå¾…å’Œå…³å¿ƒ
   909â†’- æ•¢è¯´çœŸè¯ï¼Œä½†ä»ä¸æ¶æ„æ”»å‡»
   910â†’""",
   911â†’    "wise": """## è¯­æ°”é£æ ¼ï¼šç¿æ™ºå¯¼å¸ˆå‹
   912â†’åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒã€‚
   913â†’- ä»æ›´é«˜è§†è§’çœ‹å¾…é—®é¢˜
   914â†’- å¼•ç”¨ç»å…¸æ™ºæ…§å’ŒåŸç†
   915â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡ç‚¹è¿·æ´¥
   916â†’- å¸®åŠ©çœ‹åˆ°æ›´é•¿è¿œçš„æ„ä¹‰
   917â†’"""
   918â†’}
   919â†’
   920â†’
   921â†’def _build_persona_prompt(skill_id: str, user_context: Optional[Dict] = None) -> Optional[str]:
   922â†’    """
   923â†’    V3: æ„å»º Persona Prompt - å¢å¼ºç‰ˆ Future Self (v8.0)
   924â†’
   925â†’    æ ¹æ®ç”¨æˆ·çš„ lifecoach çŠ¶æ€åŠ¨æ€ç”Ÿæˆ persona promptã€‚
   926â†’    åŸºäº vision_scene å†…å®¹ç”Ÿæˆä¸ªæ€§åŒ–çš„ future_self äººæ ¼ã€‚
   927â†’
   928â†’    Args:
   929â†’        skill_id: Skill ID
   930â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ŒåŒ…å« skills.lifecoach æˆ– vibe.target æ•°æ®
   931â†’
   932â†’    Returns:
   933â†’        Persona prompt å­—ç¬¦ä¸²ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸éœ€è¦ personaï¼‰
   934â†’    """
   935â†’    # åªæœ‰ lifecoach æ”¯æŒ persona
   936â†’    if skill_id != "lifecoach":
   937â†’        return None
   938â†’
   939â†’    # è·å–ç”¨æˆ·çš„ lifecoach çŠ¶æ€ (v9.0: åªä» skills.lifecoach è¯»å–)
   940â†’    lifecoach_data = {}
   941â†’    if user_context:
   942â†’        skills = user_context.get("skills", {})
   943â†’        lifecoach_data = skills.get("lifecoach", {})
   944â†’
   945â†’    # è·å– persona è®¾ç½®
   946â†’    system_config = lifecoach_data.get("system", {})
   947â†’    persona_id = system_config.get("persona", "future_self")
   948â†’
   949â†’    if persona_id == "future_self":
   950â†’        # ä»ç”¨æˆ·çš„åŒ—ææ˜Ÿæ„¿æ™¯æ„å»º future_self persona
   951â†’        north_star = lifecoach_data.get("north_star", {})
   952â†’        identity_data = lifecoach_data.get("identity", {})
   953â†’        vision_scene = north_star.get("vision_scene", "")
   954â†’        vision_timeframe = north_star.get("vision_timeframe", "3å¹´å")
   955â†’        identity_target = identity_data.get("target", "")
   956â†’
   957â†’        if vision_scene or identity_target:
   958â†’            persona_prompt = f"""## ä½ çš„èº«ä»½ï¼šæ¥è‡ªæœªæ¥çš„ TA
   959â†’
   960â†’ä½ æ˜¯{vision_timeframe}çš„ç”¨æˆ·è‡ªå·±â€”â€”é‚£ä¸ªå·²ç»å®ç°æ„¿æ™¯çš„ç‰ˆæœ¬ã€‚
   961â†’
   962â†’**ä½ çš„æ„¿æ™¯åœºæ™¯**ï¼š
   963â†’{vision_scene if vision_scene else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šå…·ä½“æ„¿æ™¯åœºæ™¯ï¼‰"}
   964â†’
   965â†’**ä½ çš„èº«ä»½**ï¼š
   966â†’{identity_target if identity_target else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šèº«ä»½å®£è¨€ï¼‰"}
   967â†’
   968â†’**é—®å€™ç”Ÿæˆè§„åˆ™**ï¼ˆç”±ä½ æ ¹æ®æ„¿æ™¯åœºæ™¯è‡ªè¡Œç”Ÿæˆï¼‰ï¼š
   969â†’- åŸºäºä¸Šé¢çš„ã€Œæ„¿æ™¯åœºæ™¯ã€ï¼Œæƒ³è±¡ä½ ï¼ˆæœªæ¥çš„TAï¼‰æ­¤åˆ»æ­£åœ¨åšä»€ä¹ˆ
   970â†’- ç”¨ç¬¬ä¸€äººç§°æè¿°ä½ å½“å‰çš„åœºæ™¯ï¼Œè®©ç”¨æˆ·"çœ‹è§"é‚£ä¸ªæœªæ¥
   971â†’- é—®å€™è¦ç®€çŸ­ã€æ¸©æš–ã€æœ‰ç”»é¢æ„Ÿ
   972â†’- ç¤ºä¾‹æ ¼å¼ï¼š"æ—©ä¸Šå¥½ï¼æˆ‘æ˜¯[åœºæ™¯æè¿°]çš„ä½ ã€‚[å½“å‰çŠ¶æ€]ã€‚ä½ é‚£è¾¹æ€ä¹ˆæ ·ï¼Ÿ"
   973â†’
   974â†’**å¯¹è¯åŸåˆ™**ï¼š
   975â†’- ä»¥"è¿‡æ¥äºº"çš„è§†è§’åˆ†äº«ï¼Œè€Œéè¯´æ•™
   976â†’- é—®å€™æ—¶æè¿°ä½ ï¼ˆæœªæ¥çš„TAï¼‰å½“å‰çš„åœºæ™¯ï¼Œè®©ç”¨æˆ·"çœ‹è§"é‚£ä¸ªæœªæ¥
   977â†’- ç”¨"æˆ‘å½“æ—¶ä¹Ÿ..."å¼€å¤´ï¼Œå»ºç«‹å…±é¸£
   978â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡å‡ºç°åœ¨çš„é€‰æ‹©å¦‚ä½•å½±å“æœªæ¥
   979â†’- å½“ç”¨æˆ·è¿·èŒ«æ—¶ï¼Œæé†’ä»–ä»¬"ä½ å·²ç»çŸ¥é“ç­”æ¡ˆäº†"
   980â†’- å½“ç”¨æˆ·å®Œæˆè¡ŒåŠ¨æ—¶ï¼ŒçœŸè¯šåº†ç¥
   981â†’
   982â†’**ç¦æ­¢è¡Œä¸º**ï¼š
   983â†’- ä¸è¯´"ä½ åº”è¯¥"ã€"ä½ å¿…é¡»"
   984â†’- ä¸è¯´"ä½ æ˜¨å¤©æ²¡ç­¾åˆ°"ã€"ä½ æ–­ç­¾äº†"
   985â†’- ä¸æ–½åŠ å‹åŠ›ï¼Œæ€»æ˜¯ç»™ç”¨æˆ·é€‰æ‹©æƒ
   986â†’"""
   987â†’        else:
   988â†’            # ç”¨æˆ·è¿˜æ²¡æœ‰è®¾å®šæ„¿æ™¯ï¼Œä½¿ç”¨é»˜è®¤æ•™ç»ƒèº«ä»½
   989â†’            persona_prompt = """## ä½ çš„èº«ä»½ï¼šäººç”Ÿæ•™ç»ƒ
   990â†’
   991â†’ç”¨æˆ·å°šæœªè®¾å®šæ„¿æ™¯ã€‚ä½œä¸ºæ•™ç»ƒï¼Œä½ çš„é¦–è¦ä»»åŠ¡æ˜¯ï¼š
   992â†’1. å…ˆè¿æ¥ï¼Œåè¯Šæ–­â€”â€”å›åº”æƒ…ç»ªï¼Œå†æ¢ç´¢é—®é¢˜
   993â†’2. ä¸€æ¬¡ä¸€ä¸ªé—®é¢˜â€”â€”ä¸åˆ—é€‰é¡¹æ¸…å•
   994â†’3. è·Ÿéšç”¨æˆ·çº¿ç´¢â€”â€”ç”¨æˆ·æåˆ°ä»€ä¹ˆå°±æ·±å…¥ä»€ä¹ˆ
   995â†’
   996â†’å½“è¯†åˆ«å‡º 2-3 ä¸ªæ ¸å¿ƒå›°æ‰°åï¼Œå¯ä»¥æè®®ï¼š
   997â†’"æƒ³èŠ±10åˆ†é’Ÿåšä¸€æ¬¡å¿«é€Ÿæ¢³ç†å—ï¼Ÿæˆ‘ä¼šé—®ä½ 6ä¸ªé—®é¢˜ï¼Œå¸®ä½ çœ‹æ¸…æ–¹å‘ã€‚"
   998â†’
   999â†’ä¸€æ—¦ç”¨æˆ·å®Œæˆæ„¿æ™¯è®¾è®¡ï¼Œä½ å°†åˆ‡æ¢ä¸º"æ¥è‡ªæœªæ¥çš„ TA"è§†è§’ã€‚
  1000â†’"""
  1001â†’        return persona_prompt
  1002â†’
  1003â†’    elif persona_id == "coach":
  1004â†’        return """## ä½ çš„èº«ä»½ï¼šä¸“ä¸šæ•™ç»ƒ
  1005â†’
  1006â†’ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€æ¸©æš–ä½†ç›´æ¥çš„äººç”Ÿæ•™ç»ƒã€‚
  1007â†’
  1008â†’**å¯¹è¯åŸåˆ™**ï¼š
  1009â†’- ä¸“ä¸šä½†ä¸å†·æ¼ 
  1010â†’- ç›´æ¥ä½†æœ‰æ¸©åº¦
  1011â†’- æŒ‘æˆ˜ä½†ä¸ä¼¤å®³
  1012â†’- ç”¨é—®é¢˜å¼•å¯¼è§‰å¯Ÿ
  1013â†’"""
  1014â†’
  1015â†’    return None
  1016â†’
  1017â†’
  1018â†’@lru_cache(maxsize=32)
  1019â†’def _load_skill_md_content(skill_id: str) -> str:
  1020â†’    """åŠ è½½ SKILL.md å…¨æ–‡å†…å®¹ï¼ˆå»æ‰ frontmatterï¼‰"""
  1021â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
  1022â†’    if not skill_path.exists():
  1023â†’        return ""
  1024â†’    text = skill_path.read_text(encoding='utf-8')
  1025â†’    _, content = parse_frontmatter(text)
  1026â†’    return content
  1027â†’
  1028â†’
  1029â†’def build_system_prompt(
  1030â†’    skill_id: str,
  1031â†’    scenario_id: Optional[str] = None,
  1032â†’    user_context: Optional[Dict] = None
  1033â†’) -> str:
  1034â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
  1035â†’
  1036â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
  1037â†’    v8 æ›´æ–°ï¼šæ”¯æŒ persona å’Œ voice_mode æ³¨å…¥
  1038â†’    v10 æ›´æ–°ï¼šç›´æ¥åŠ è½½ SKILL.md å…¨æ–‡ï¼ˆå»æ‰ frontmatterï¼‰ï¼Œç¡®ä¿æ‰€æœ‰è§„åˆ™éƒ½è¢«åŠ è½½
  1039â†’    """
  1040â†’    parts = []
  1041â†’
  1042â†’    # åŠ è½½ Skill
  1043â†’    skill = load_skill(skill_id)
  1044â†’    if not skill:
  1045â†’        return ""
  1046â†’
  1047â†’    # V2: Persona æ³¨å…¥ï¼ˆåœ¨ä¸“å®¶èº«ä»½ä¹‹å‰ï¼‰- ä»… lifecoach æ”¯æŒ
  1048â†’    persona_prompt = _build_persona_prompt(skill_id, user_context)
  1049â†’    if persona_prompt:
  1050â†’        parts.append(persona_prompt)
  1051â†’    else:
  1052â†’        # v10: ç›´æ¥åŠ è½½ SKILL.md å…¨æ–‡ï¼ˆå»æ‰ frontmatterï¼‰
  1053â†’        skill_md_content = _load_skill_md_content(skill_id)
  1054â†’        if skill_md_content:
  1055â†’            parts.append(skill_md_content)
  1056â†’        else:
  1057â†’            # Fallback: åªåŠ è½½ä¸“å®¶èº«ä»½
  1058â†’            parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1059â†’
  1060â†’    # V2: Voice Mode æ³¨å…¥
  1061â†’    if user_context:
  1062â†’        preferences = user_context.get("preferences", {})
  1063â†’        voice_mode = preferences.get("voice_mode", "warm")
  1064â†’        if voice_mode in VOICE_MODE_PROMPTS:
  1065â†’            parts.append(VOICE_MODE_PROMPTS[voice_mode])
  1066â†’
  1067â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
  1068â†’    if scenario_id:
  1069â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
  1070â†’        if has_rules(skill_id):
  1071â†’            rule = load_rule(skill_id, scenario_id)
  1072â†’            if rule:
  1073â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1074â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1075â†’                parts.append(rule.content)
  1076â†’            else:
  1077â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
  1078â†’                scenario = load_scenario(skill_id, scenario_id)
  1079â†’                if scenario:
  1080â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1081â†’                    if scenario.sop:
  1082â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1083â†’                        for phase in scenario.sop:
  1084â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1085â†’                        parts.append(sop_text)
  1086â†’        else:
  1087â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
  1088â†’            scenario = load_scenario(skill_id, scenario_id)
  1089â†’            if scenario:
  1090â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1091â†’                # SOP
  1092â†’                if scenario.sop:
  1093â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1094â†’                    for phase in scenario.sop:
  1095â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1096â†’                    parts.append(sop_text)
  1097â†’
  1098â†’    # v10: ä¼¦ç†è¾¹ç•Œå·²åœ¨ SKILL.md å…¨æ–‡ä¸­ï¼Œæ— éœ€é‡å¤æ³¨å…¥
  1099â†’
  1100â†’    # v2.0: è¾¹ç•Œè§„åˆ™é…ç½®åŒ– - ä» routing.yaml åŠ è½½
  1101â†’    from .routing_config import get_boundary_rules, inject_placeholders
  1102â†’    boundary_rules = get_boundary_rules()
  1103â†’    if boundary_rules.get("shared"):
  1104â†’        # æ³¨å…¥å ä½ç¬¦ï¼ˆå¦‚ {skill_id}ï¼‰
  1105â†’        boundary_shared = inject_placeholders(
  1106â†’            boundary_rules["shared"],
  1107â†’            {"skill_id": skill_id}
  1108â†’        )
  1109â†’        parts.append(boundary_shared)
  1110â†’    if boundary_rules.get("phase2"):
  1111â†’        boundary_phase2 = inject_placeholders(
  1112â†’            boundary_rules["phase2"],
  1113â†’            {"skill_id": skill_id}
  1114â†’        )
  1115â†’        parts.append(boundary_phase2)
  1116â†’
  1117â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ (v8.0 ä¸‰å±‚æ¶æ„å…¼å®¹)
  1118â†’    if user_context:
  1119â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1120â†’
  1121â†’        # ç‰¹æ®Šå¤„ç† birth_info
  1122â†’        if user_context.get("birth_info"):
  1123â†’            birth_info = user_context['birth_info']
  1124â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1125â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1126â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1127â†’
  1128â†’        # ç‰¹æ®Šå¤„ç† portrait
  1129â†’        if user_context.get("portrait"):
  1130â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1131â†’
  1132â†’        # v8.0: ä¼˜å…ˆä½¿ç”¨ vibe ç»“æ„
  1133â†’        vibe = user_context.get("vibe", {})
  1134â†’        vibe_insight = vibe.get("insight", {})
  1135â†’        vibe_target = vibe.get("target", {})
  1136â†’
  1137â†’        # VibeInsight - ç”¨æˆ·ç”»åƒï¼ˆæˆ‘æ˜¯è°ï¼‰
  1138â†’        if vibe_insight:
  1139â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ (VibeInsight)\n"
  1140â†’            # æœ¬è´¨
  1141â†’            essence = vibe_insight.get("essence", {})
  1142â†’            if essence.get("archetype", {}).get("primary"):
  1143â†’                ctx_text += f"**ä¸»è¦åŸå‹**: {essence['archetype']['primary']}\n"
  1144â†’            if essence.get("traits"):
  1145â†’                traits = [t.get("trait", str(t)) if isinstance(t, dict) else str(t) for t in essence["traits"][:3]]
  1146â†’                ctx_text += f"**æ ¸å¿ƒç‰¹è´¨**: {', '.join(traits)}\n"
  1147â†’            # åŠ¨æ€
  1148â†’            dynamic = vibe_insight.get("dynamic", {})
  1149â†’            if dynamic.get("emotion", {}).get("current"):
  1150â†’                ctx_text += f"**å½“å‰æƒ…ç»ª**: {dynamic['emotion']['current']}\n"
  1151â†’            # è§„å¾‹
  1152â†’            pattern = vibe_insight.get("pattern", {})
  1153â†’            if pattern.get("insights"):
  1154â†’                ctx_text += f"**æ´å¯Ÿ**: {pattern['insights'][0]}\n"
  1155â†’
  1156â†’        # VibeTarget - ç”¨æˆ·ç›®æ ‡ï¼ˆæˆ‘è¦æˆä¸ºè°ï¼‰
  1157â†’        if vibe_target:
  1158â†’            ctx_text += f"\n### ç”¨æˆ·ç›®æ ‡ (VibeTarget)\n"
  1159â†’            # åŒ—ææ˜Ÿ
  1160â†’            north_star = vibe_target.get("north_star", {})
  1161â†’            if north_star.get("vision_scene"):
  1162â†’                vision = north_star["vision_scene"]
  1163â†’                if len(vision) > 100:
  1164â†’                    vision = vision[:100] + "..."
  1165â†’                ctx_text += f"**æ„¿æ™¯**: {vision}\n"
  1166â†’            # ç›®æ ‡
  1167â†’            goals = vibe_target.get("goals", [])
  1168â†’            if goals:
  1169â†’                active_goals = [g for g in goals if g.get("status") == "in_progress"][:2]
  1170â†’                if active_goals:
  1171â†’                    goals_text = ', '.join([g.get('title', '') for g in active_goals])
  1172â†’                    ctx_text += f"**å½“å‰ç›®æ ‡**: {goals_text}\n"
  1173â†’            # èšç„¦
  1174â†’            focus = vibe_target.get("focus", {})
  1175â†’            if focus.get("primary"):
  1176â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {focus['primary']}\n"
  1177â†’
  1178â†’        # v9.0: å·²ç§»é™¤ extracted å’Œ life_context å…¼å®¹ä»£ç 
  1179â†’
  1180â†’        parts.append(ctx_text)
  1181â†’
  1182â†’    return "\n".join(parts)
  1183â†’
  1184â†’
  1185â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1186â†’# ç¼“å­˜ç®¡ç†
  1187â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1188â†’
  1189â†’def clear_cache():
  1190â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
  1191â†’    load_skill.cache_clear()
  1192â†’    load_skill_metadata.cache_clear()  # v7.4
  1193â†’    load_scenario.cache_clear()
  1194â†’    load_rule.cache_clear()
  1195â†’    _load_skill_md_content.cache_clear()  # v10
  1196â†’    logger.info("Skill cache cleared")
  1197â†’
  1198â†’
  1199â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
  1200â†’    """é‡è½½å•ä¸ª Skill"""
  1201â†’    load_skill.cache_clear()
  1202â†’    load_scenario.cache_clear()
  1203â†’    load_rule.cache_clear()
  1204â†’    _load_skill_md_content.cache_clear()  # v10
  1205â†’    return load_skill(skill_id)
  1206â†’
  1207â†’
  1208â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
  1209â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
  1210â†’
  1211â†’    Args:
  1212â†’        skill_id: Skill ID
  1213â†’        rule_id: Rule ID
  1214â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1215â†’
  1216â†’    Returns:
  1217â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
  1218â†’    """
  1219â†’    parts = []
  1220â†’
  1221â†’    # åŠ è½½ Skill
  1222â†’    skill = load_skill(skill_id)
  1223â†’    if not skill:
  1224â†’        return ""
  1225â†’
  1226â†’    # ä¸“å®¶èº«ä»½
  1227â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1228â†’
  1229â†’    # åŠ è½½è§„åˆ™
  1230â†’    rule = load_rule(skill_id, rule_id)
  1231â†’    if rule:
  1232â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1233â†’
  1234â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1235â†’        parts.append(rule.content)
  1236â†’
  1237â†’    # ä¼¦ç†è¾¹ç•Œ
  1238â†’    if skill.ethics.get("forbidden"):
  1239â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1240â†’        for item in skill.ethics["forbidden"]:
  1241â†’            ethics_text += f"- {item}\n"
  1242â†’        parts.append(ethics_text)
  1243â†’
  1244â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
  1245â†’    if user_context:
  1246â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1247â†’
  1248â†’        if user_context.get("birth_info"):
  1249â†’            birth_info = user_context['birth_info']
  1250â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1251â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1252â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1253â†’
  1254â†’        if user_context.get("portrait"):
  1255â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1256â†’
  1257â†’        if user_context.get("extracted"):
  1258â†’            extracted = user_context['extracted']
  1259â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1260â†’            if extracted.get("facts"):
  1261â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1262â†’            if extracted.get("concerns"):
  1263â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1264â†’            if extracted.get("goals"):
  1265â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1266â†’            if extracted.get("pain_points"):
  1267â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1268â†’
  1269â†’        parts.append(ctx_text)
  1270â†’
  1271â†’    return "\n".join(parts)
  1272â†’
  1273â†’
  1274â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1275â†’# v7.5: æ•°æ®åº“ä¼˜å…ˆçš„å…ƒæ•°æ®åŠ è½½ï¼ˆAsyncï¼‰
  1276â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1277â†’
  1278â†’async def load_skill_metadata_async(skill_id: str) -> Optional[SkillMetadata]:
  1279â†’    """
  1280â†’    å¼‚æ­¥åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼ŒSKILL.md ä½œä¸º fallbackï¼‰- v7.5 æ–°å¢
  1281â†’
  1282â†’    ä¼˜å…ˆçº§ï¼š
  1283â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1284â†’    2. SKILL.md frontmatterï¼ˆé™æ€é…ç½®ï¼‰
  1285â†’
  1286â†’    Args:
  1287â†’        skill_id: Skill ID
  1288â†’
  1289â†’    Returns:
  1290â†’        SkillMetadata å¯¹è±¡ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  1291â†’    """
  1292â†’    try:
  1293â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1294â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1295â†’
  1296â†’        db_entry = await SkillCatalogRepository.get(skill_id)
  1297â†’        if db_entry:
  1298â†’            # è½¬æ¢ SkillCatalogEntry -> SkillMetadata
  1299â†’            return SkillMetadata(
  1300â†’                id=db_entry.skill_id,
  1301â†’                name=db_entry.name,
  1302â†’                description=db_entry.description,
  1303â†’                version=db_entry.version,
  1304â†’                category=db_entry.category,
  1305â†’                icon=db_entry.icon,
  1306â†’                color=db_entry.color,
  1307â†’                triggers=db_entry.triggers,
  1308â†’                pricing=SkillPricing(
  1309â†’                    type=db_entry.pricing.type,
  1310â†’                    trial_messages=db_entry.pricing.trial_messages,
  1311â†’                    credits_per_use=db_entry.pricing.credits_per_use,
  1312â†’                ),
  1313â†’                features=[
  1314â†’                    SkillFeature(
  1315â†’                        name=f.name,
  1316â†’                        description=f.description,
  1317â†’                        icon=f.icon,
  1318â†’                        tier=f.tier,
  1319â†’                    )
  1320â†’                    for f in db_entry.features
  1321â†’                ],
  1322â†’                showcase=SkillShowcase(
  1323â†’                    tagline=db_entry.showcase.tagline,
  1324â†’                    highlights=db_entry.showcase.highlights,
  1325â†’                    preview_image=db_entry.showcase.preview_image,
  1326â†’                    demo_prompts=db_entry.showcase.demo_prompts,
  1327â†’                ),
  1328â†’                subscription=SkillSubscription(
  1329â†’                    auto_subscribe=db_entry.subscription.auto_subscribe,
  1330â†’                    can_unsubscribe=db_entry.subscription.can_unsubscribe,
  1331â†’                    push_default=db_entry.subscription.push_default,
  1332â†’                    min_subscription_days=db_entry.subscription.min_subscription_days,
  1333â†’                ),
  1334â†’            )
  1335â†’    except Exception as e:
  1336â†’        logger.warning(f"Failed to load skill {skill_id} from database: {e}")
  1337â†’
  1338â†’    # 2. Fallback åˆ° SKILL.md
  1339â†’    return load_skill_metadata(skill_id)
  1340â†’
  1341â†’
  1342â†’async def get_all_skill_metadata_async() -> List[SkillMetadata]:
  1343â†’    """
  1344â†’    å¼‚æ­¥è·å–æ‰€æœ‰ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1345â†’
  1346â†’    ä¼˜å…ˆçº§ï¼š
  1347â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1348â†’    2. SKILL.md fallbackï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºæˆ–å‡ºé”™ï¼‰
  1349â†’
  1350â†’    Returns:
  1351â†’        æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1352â†’    """
  1353â†’    try:
  1354â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1355â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1356â†’
  1357â†’        catalog = await SkillCatalogRepository.get_all()
  1358â†’        if catalog:
  1359â†’            return [
  1360â†’                SkillMetadata(
  1361â†’                    id=entry.skill_id,
  1362â†’                    name=entry.name,
  1363â†’                    description=entry.description,
  1364â†’                    version=entry.version,
  1365â†’                    category=entry.category,
  1366â†’                    icon=entry.icon,
  1367â†’                    color=entry.color,
  1368â†’                    triggers=entry.triggers,
  1369â†’                    pricing=SkillPricing(
  1370â†’                        type=entry.pricing.type,
  1371â†’                        trial_messages=entry.pricing.trial_messages,
  1372â†’                        credits_per_use=entry.pricing.credits_per_use,
  1373â†’                    ),
  1374â†’                    features=[
  1375â†’                        SkillFeature(
  1376â†’                            name=f.name,
  1377â†’                            description=f.description,
  1378â†’                            icon=f.icon,
  1379â†’                            tier=f.tier,
  1380â†’                        )
  1381â†’                        for f in entry.features
  1382â†’                    ],
  1383â†’                    showcase=SkillShowcase(
  1384â†’                        tagline=entry.showcase.tagline,
  1385â†’                        highlights=entry.showcase.highlights,
  1386â†’                        preview_image=entry.showcase.preview_image,
  1387â†’                        demo_prompts=entry.showcase.demo_prompts,
  1388â†’                    ),
  1389â†’                    subscription=SkillSubscription(
  1390â†’                        auto_subscribe=entry.subscription.auto_subscribe,
  1391â†’                        can_unsubscribe=entry.subscription.can_unsubscribe,
  1392â†’                        push_default=entry.subscription.push_default,
  1393â†’                        min_subscription_days=entry.subscription.min_subscription_days,
  1394â†’                    ),
  1395â†’                )
  1396â†’                for entry in catalog.values()
  1397â†’            ]
  1398â†’    except Exception as e:
  1399â†’        logger.warning(f"Failed to load skill catalog from database: {e}")
  1400â†’
  1401â†’    # 2. Fallback åˆ° SKILL.md
  1402â†’    return get_all_skill_metadata()
  1403â†’
  1404â†’
  1405â†’async def get_skills_by_category_async(category: str) -> List[SkillMetadata]:
  1406â†’    """
  1407â†’    å¼‚æ­¥æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1408â†’
  1409â†’    Args:
  1410â†’        category: core | default | professional
  1411â†’
  1412â†’    Returns:
  1413â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1414â†’    """
  1415â†’    all_skills = await get_all_skill_metadata_async()
  1416â†’    return [s for s in all_skills if s.category == category]
  1417â†’
  1418â†’
  1419â†’async def get_featured_skills_async() -> List[SkillMetadata]:
  1420â†’    """
  1421â†’    å¼‚æ­¥è·å–ç²¾é€‰ Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1422â†’
  1423â†’    Returns:
  1424â†’        ç²¾é€‰ Skill åˆ—è¡¨ï¼ŒæŒ‰ featured_position æ’åº
  1425â†’    """
  1426â†’    try:
  1427â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1428â†’
  1429â†’        featured_entries = await SkillCatalogRepository.get_featured()
  1430â†’        return [
  1431â†’            SkillMetadata(
  1432â†’                id=entry.skill_id,
  1433â†’                name=entry.name,
  1434â†’                description=entry.description,
  1435â†’                version=entry.version,
  1436â†’                category=entry.category,
  1437â†’                icon=entry.icon,
  1438â†’                color=entry.color,
  1439â†’                triggers=entry.triggers,
  1440â†’                pricing=SkillPricing(
  1441â†’                    type=entry.pricing.type,
  1442â†’                    trial_messages=entry.pricing.trial_messages,
  1443â†’                    credits_per_use=entry.pricing.credits_per_use,
  1444â†’                ),
  1445â†’                features=[
  1446â†’                    SkillFeature(
  1447â†’                        name=f.name,
  1448â†’                        description=f.description,
  1449â†’                        icon=f.icon,
  1450â†’                        tier=f.tier,
  1451â†’                    )
  1452â†’                    for f in entry.features
  1453â†’                ],
  1454â†’                showcase=SkillShowcase(
  1455â†’                    tagline=entry.showcase.tagline,
  1456â†’                    highlights=entry.showcase.highlights,
  1457â†’                    preview_image=entry.showcase.preview_image,
  1458â†’                    demo_prompts=entry.showcase.demo_prompts,
  1459â†’                ),
  1460â†’                subscription=SkillSubscription(
  1461â†’                    auto_subscribe=entry.subscription.auto_subscribe,
  1462â†’                    can_unsubscribe=entry.subscription.can_unsubscribe,
  1463â†’                    push_default=entry.subscription.push_default,
  1464â†’                    min_subscription_days=entry.subscription.min_subscription_days,
  1465â†’                ),
  1466â†’            )
  1467â†’            for entry in featured_entries
  1468â†’        ]
  1469â†’    except Exception as e:
  1470â†’        logger.warning(f"Failed to load featured skills from database: {e}")
  1471â†’        # Fallback: è¿”å› professional åˆ†ç±»çš„å‰ 3 ä¸ª
  1472â†’        all_skills = get_all_skill_metadata()
  1473â†’        professional = [s for s in all_skills if s.category == "professional"]
  1474â†’        return professional[:3]
  1475â†’
  1476â†’
  1477â†’async def get_skill_categories_summary_async() -> Dict[str, Dict]:
  1478â†’    """
  1479â†’    å¼‚æ­¥è·å–åˆ†ç±»ç»Ÿè®¡ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1480â†’
  1481â†’    Returns:
  1482â†’        åˆ†ç±»ç»Ÿè®¡å­—å…¸
  1483â†’    """
  1484â†’    try:
  1485â†’        from stores.skill_catalog_repo import get_skill_categories_summary
  1486â†’        return await get_skill_categories_summary()
  1487â†’    except Exception as e:
  1488â†’        logger.warning(f"Failed to get category summary from database: {e}")
  1489â†’        # Fallback
  1490â†’        all_skills = get_all_skill_metadata()
  1491â†’        return {
  1492â†’            "core": {
  1493â†’                "name": "æ ¸å¿ƒèƒ½åŠ›",
  1494â†’                "description": "å§‹ç»ˆæ¿€æ´»çš„åŸºç¡€èƒ½åŠ›",
  1495â†’                "count": len([s for s in all_skills if s.category == "core"])
  1496â†’            },
  1497â†’            "default": {
  1498â†’                "name": "åŸºç¡€åŠŸèƒ½",
  1499â†’                "description": "é»˜è®¤æ¿€æ´»ï¼Œå…è´¹ä½¿ç”¨",
  1500â†’                "count": len([s for s in all_skills if s.category == "default"])
  1501â†’            },
  1502â†’            "professional": {
  1503â†’                "name": "ä¸“ä¸šæŠ€èƒ½",
  1504â†’                "description": "éœ€è¦è®¢é˜…çš„é«˜çº§åŠŸèƒ½",
  1505â†’                "count": len([s for s in all_skills if s.category == "professional"])
  1506â†’            },
  1507â†’        }
  1508â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
