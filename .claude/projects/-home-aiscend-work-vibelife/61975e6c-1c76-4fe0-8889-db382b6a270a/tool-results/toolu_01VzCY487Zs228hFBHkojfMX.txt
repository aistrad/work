     1â†’"""
     2â†’Portrait Service - User portrait (Hot Memory) management
     3â†’
     4â†’Design: docs/user-data-context-design.md
     5â†’Core Idea: LLM-generated natural language portraits with structured format
     6â†’"""
     7â†’from typing import Optional, List, Dict, Any
     8â†’from uuid import UUID
     9â†’from datetime import datetime
    10â†’
    11â†’from stores.db import get_connection
    12â†’
    13â†’
    14â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    15â†’# Prompts
    16â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    17â†’
    18â†’PORTRAIT_UPDATE_PROMPT = """ä½ æ˜¯ä¸€ä¸ªç”¨æˆ·ç”»åƒåˆ†æžä¸“å®¶ã€‚è¯·åŸºäºŽä»¥ä¸‹ä¿¡æ¯ï¼Œä¸ºè¿™ä½ç”¨æˆ·ç”Ÿæˆæˆ–æ›´æ–°ç”»åƒæ‘˜è¦ã€‚
    19â†’
    20â†’## å½“å‰ç”»åƒ (å¦‚æžœå­˜åœ¨)
    21â†’{current_portrait}
    22â†’
    23â†’## ç”¨æˆ·åŸºç¡€ä¿¡æ¯
    24â†’- å‡ºç”Ÿæ—¥æœŸ: {birth_datetime}
    25â†’- å…«å­—: {bazi_chart}
    26â†’- ä½¿ç”¨æŠ€èƒ½: {skill_id}
    27â†’
    28â†’## æœ€è¿‘ {message_count} æ¡å¯¹è¯
    29â†’{recent_messages}
    30â†’
    31â†’## ä»»åŠ¡
    32â†’è¯·ç”Ÿæˆç»“æž„åŒ–çš„ç”¨æˆ·ç”»åƒï¼Œ**å¿…é¡»**åŒ…å«ä»¥ä¸‹å››ä¸ªåŒºåŸŸï¼š
    33â†’
    34â†’# ç”¨æˆ·ç”»åƒ
    35â†’
    36â†’## ðŸ“Œ é•¿æœŸäº‹å®ž (Facts)
    37â†’*ä¸éšæ—¶é—´æ”¹å˜çš„ç¡¬äº‹å®žã€‚å¦‚ï¼šå§“åã€ç”Ÿæ—¥ã€å® ç‰©åã€é‡å¤§ç»åŽ†ã€è¿‡æ•ä¿¡æ¯ã€‚*
    38â†’*ã€é‡è¦ã€‘æ›´æ–°æ—¶å¿…é¡»ä¿ç•™å·²æœ‰çš„äº‹å®žï¼Œé™¤éžç”¨æˆ·æ˜Žç¡®çº æ­£ï¼*
    39â†’
    40â†’## ðŸŒŠ å½“å‰çŠ¶æ€ (State)
    41â†’*æµåŠ¨çš„æƒ…ç»ªã€è¿‘æœŸè¯é¢˜ã€å½“å‰å›°æ‰°ã€‚å¯ä»¥éšæ—¶æ›´æ–°ã€‚*
    42â†’
    43â†’## ðŸ’¡ äº’åŠ¨åå¥½ (Preferences)
    44â†’*ç”¨æˆ·å–œæ¬¢ä»€ä¹ˆæ ·çš„å›žåº”æ–¹å¼ã€æ²Ÿé€šé£Žæ ¼ã€‚*
    45â†’
    46â†’## ðŸŽ¯ å½“å‰å…³æ³¨ (Focus)
    47â†’*ç”¨æˆ·æ­£åœ¨æ€è€ƒæˆ–å¤„ç†çš„äº‹æƒ…ã€‚*
    48â†’
    49â†’è¦æ±‚:
    50â†’- æ¯ä¸ªåŒºåŸŸç”¨ bullet points
    51â†’- å…·ä½“è€Œéžç¬¼ç»Ÿ
    52â†’- ðŸ“Œ Facts åŒºåŸŸï¼šåªå¢žä¸åˆ ï¼Œé™¤éžç”¨æˆ·æ˜Žç¡®çº æ­£
    53â†’- æ€»é•¿åº¦æŽ§åˆ¶åœ¨ 500 å­—ä»¥å†…
    54â†’- åªè¾“å‡ºç”»åƒå†…å®¹ï¼Œä¸è¦å…¶ä»–è§£é‡Š
    55â†’"""
    56â†’
    57â†’PORTRAIT_INIT_TEXT = """# ç”¨æˆ·ç”»åƒ
    58â†’
    59â†’## ðŸ“Œ é•¿æœŸäº‹å®ž (Facts)
    60â†’*ç­‰å¾…å‘çŽ°...*
    61â†’
    62â†’## ðŸŒŠ å½“å‰çŠ¶æ€ (State)
    63â†’*æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰è¶³å¤Ÿçš„äº†è§£*
    64â†’
    65â†’## ðŸ’¡ äº’åŠ¨åå¥½ (Preferences)
    66â†’*ç­‰å¾…è§‚å¯Ÿ...*
    67â†’
    68â†’## ðŸŽ¯ å½“å‰å…³æ³¨ (Focus)
    69â†’*ç­‰å¾…äº†è§£...*
    70â†’"""
    71â†’
    72â†’
    73â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    74â†’# Portrait Service
    75â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    76â†’
    77â†’class PortraitService:
    78â†’    """
    79â†’    User Portrait Service (Hot Memory)
    80â†’
    81â†’    Core Design:
    82â†’    - Stores LLM-generated natural language portraits
    83â†’    - Structured format: Facts/State/Preferences/Focus
    84â†’    - Facts are "anchored" and protected from compression loss
    85â†’    - Updated every N messages via background task
    86â†’
    87â†’    Phase 1.5:
    88â†’    - Portraits are isolated per skill_id (keeps persona pure)
    89â†’    - Reserved skill_id 'global' for future aggregation
    90â†’    """
    91â†’
    92â†’    # Trigger conditions
    93â†’    UPDATE_INTERVAL_MESSAGES = 10  # Update every 10 messages
    94â†’    PORTRAIT_MAX_TOKENS = 1000     # Max tokens for portrait generation
    95â†’
    96â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    97â†’    # Read Operations
    98â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    99â†’
   100â†’    @staticmethod
   101â†’    async def get_portrait(user_id: UUID, skill_id: str) -> Optional[str]:
   102â†’        """
   103â†’        Get user portrait text for a skill.
   104â†’        Returns None if no portrait exists yet.
   105â†’        """
   106â†’        async with get_connection() as conn:
   107â†’            row = await conn.fetchrow(
   108â†’                """
   109â†’                SELECT portrait_text FROM user_portraits
   110â†’                WHERE user_id = $1 AND skill_id = $2
   111â†’                """,
   112â†’                user_id, skill_id
   113â†’            )
   114â†’            return row["portrait_text"] if row else None
   115â†’
   116â†’    @staticmethod
   117â†’    async def get_portrait_metadata(user_id: UUID, skill_id: str) -> Optional[dict]:
   118â†’        """Get portrait with metadata (for update decision)"""
   119â†’        async with get_connection() as conn:
   120â†’            row = await conn.fetchrow(
   121â†’                """
   122â†’                SELECT id, portrait_text, based_on_messages, last_message_id, version
   123â†’                FROM user_portraits
   124â†’                WHERE user_id = $1 AND skill_id = $2
   125â†’                """,
   126â†’                user_id, skill_id
   127â†’            )
   128â†’            return dict(row) if row else None
   129â†’
   130â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   131â†’    # Update Decision
   132â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   133â†’
   134â†’    @classmethod
   135â†’    async def should_update(cls, user_id: UUID, skill_id: str) -> bool:
   136â†’        """
   137â†’        Check if portrait should be updated.
   138â†’        Returns True if:
   139â†’        - No portrait exists (new user)
   140â†’        - New messages >= UPDATE_INTERVAL_MESSAGES since last update
   141â†’        """
   142â†’        async with get_connection() as conn:
   143â†’            portrait = await conn.fetchrow(
   144â†’                """
   145â†’                SELECT based_on_messages, last_message_id
   146â†’                FROM user_portraits
   147â†’                WHERE user_id = $1 AND skill_id = $2
   148â†’                """,
   149â†’                user_id, skill_id
   150â†’            )
   151â†’
   152â†’            # New user, needs portrait
   153â†’            if not portrait:
   154â†’                # Check if user has any messages first
   155â†’                msg_count = await conn.fetchval(
   156â†’                    """
   157â†’                    SELECT COUNT(*) FROM skill_messages sm
   158â†’                    JOIN skill_conversations sc ON sm.conversation_id = sc.id
   159â†’                    WHERE sc.user_id = $1 AND sc.skill_id = $2
   160â†’                    """,
   161â†’                    user_id, skill_id
   162â†’                )
   163â†’                return msg_count >= 3  # At least 3 messages to generate portrait
   164â†’
   165â†’            # Count new messages since last update
   166â†’            new_messages = await conn.fetchval(
   167â†’                """
   168â†’                SELECT COUNT(*) FROM skill_messages sm
   169â†’                JOIN skill_conversations sc ON sm.conversation_id = sc.id
   170â†’                WHERE sc.user_id = $1 AND sc.skill_id = $2
   171â†’                  AND (sm.id > $3 OR $3 IS NULL)
   172â†’                """,
   173â†’                user_id, skill_id, portrait["last_message_id"]
   174â†’            )
   175â†’
   176â†’            return new_messages >= cls.UPDATE_INTERVAL_MESSAGES
   177â†’
   178â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   179â†’    # Update Operations
   180â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   181â†’
   182â†’    @classmethod
   183â†’    async def update_portrait(
   184â†’        cls,
   185â†’        user_id: UUID,
   186â†’        skill_id: str,
   187â†’        llm_orchestrator,
   188â†’        user_repo=None,
   189â†’        skill_repo=None
   190â†’    ) -> Optional[str]:
   191â†’        """
   192â†’        Update user portrait (background task).
   193â†’
   194â†’        Process:
   195â†’        1. Get current portrait
   196â†’        2. Get user basic info
   197â†’        3. Get recent messages
   198â†’        4. Call LLM to generate/update portrait
   199â†’        5. Save with optimistic lock
   200â†’
   201â†’        Returns new portrait text or None on failure.
   202â†’        """
   203â†’        from .llm_orchestrator import LLMMessage
   204â†’
   205â†’        # Late imports to avoid circular dependency
   206â†’        if user_repo is None:
   207â†’            from stores import UserRepository
   208â†’            user_repo = UserRepository
   209â†’        if skill_repo is None:
   210â†’            from stores import SkillRepository
   211â†’            skill_repo = SkillRepository
   212â†’
   213â†’        try:
   214â†’            # 1. Get current portrait and metadata
   215â†’            portrait_meta = await cls.get_portrait_metadata(user_id, skill_id)
   216â†’            current_portrait = portrait_meta["portrait_text"] if portrait_meta else None
   217â†’            expected_version = portrait_meta["version"] if portrait_meta else 0
   218â†’
   219â†’            # 2. Get user basic info
   220â†’            user_data = await user_repo.get_by_id(user_id)
   221â†’            profile = await skill_repo.get_or_create_profile(user_id, skill_id)
   222â†’
   223â†’            birth_datetime = user_data.get("birth_datetime") if user_data else None
   224â†’            bazi_chart = profile.get("profile_data", {}).get("bazi", {}) if profile else {}
   225â†’
   226â†’            # 3. Get recent messages
   227â†’            messages = await skill_repo.get_recent_messages(
   228â†’                user_id, skill_id, limit=50
   229â†’            )
   230â†’
   231â†’            if not messages:
   232â†’                return None  # No messages to process
   233â†’
   234â†’            # 4. Build prompt and call LLM
   235â†’            prompt = PORTRAIT_UPDATE_PROMPT.format(
   236â†’                current_portrait=current_portrait or "è¿™æ˜¯æ–°ç”¨æˆ·ï¼Œè¿˜æ²¡æœ‰ç”»åƒ",
   237â†’                birth_datetime=birth_datetime or "æœªçŸ¥",
   238â†’                bazi_chart=bazi_chart or "æœªæŽ’ç›˜",
   239â†’                skill_id=skill_id,
   240â†’                message_count=len(messages),
   241â†’                recent_messages=cls._format_messages(messages)
   242â†’            )
   243â†’
   244â†’            response = await llm_orchestrator.chat(
   245â†’                [LLMMessage(role="user", content=prompt)],
   246â†’                temperature=0.3,
   247â†’                max_tokens=cls.PORTRAIT_MAX_TOKENS
   248â†’            )
   249â†’
   250â†’            new_portrait = response.content
   251â†’
   252â†’            # 5. Save portrait with optimistic lock
   253â†’            last_msg_id = messages[0]["id"] if messages else None
   254â†’
   255â†’            success = await cls._save_portrait(
   256â†’                user_id=user_id,
   257â†’                skill_id=skill_id,
   258â†’                portrait_text=new_portrait,
   259â†’                message_count=len(messages),
   260â†’                last_message_id=last_msg_id,
   261â†’                expected_version=expected_version,
   262â†’                old_portrait=current_portrait
   263â†’            )
   264â†’
   265â†’            if success:
   266â†’                return new_portrait
   267â†’            else:
   268â†’                # Optimistic lock failed, concurrent update
   269â†’                print(f"Portrait update skipped (concurrent): user={user_id}, skill={skill_id}")
   270â†’                return None
   271â†’
   272â†’        except Exception as e:
   273â†’            print(f"Portrait update failed: user={user_id}, skill={skill_id}, error={e}")
   274â†’            import traceback
   275â†’            traceback.print_exc()
   276â†’            return None
   277â†’
   278â†’    @staticmethod
   279â†’    async def _save_portrait(
   280â†’        user_id: UUID,
   281â†’        skill_id: str,
   282â†’        portrait_text: str,
   283â†’        message_count: int,
   284â†’        last_message_id: Optional[UUID],
   285â†’        expected_version: int,
   286â†’        old_portrait: Optional[str]
   287â†’    ) -> bool:
   288â†’        """
   289â†’        Save portrait with optimistic lock.
   290â†’        Returns True if saved successfully, False if concurrent update detected.
   291â†’        """
   292â†’        async with get_connection() as conn:
   293â†’            async with conn.transaction():
   294â†’                # Archive old portrait to history (if exists)
   295â†’                if old_portrait and expected_version > 0:
   296â†’                    await conn.execute(
   297â†’                        """
   298â†’                        INSERT INTO user_portrait_history (user_id, skill_id, portrait_text, version)
   299â†’                        VALUES ($1, $2, $3, $4)
   300â†’                        """,
   301â†’                        user_id, skill_id, old_portrait, expected_version
   302â†’                    )
   303â†’
   304â†’                if expected_version == 0:
   305â†’                    # New portrait (INSERT)
   306â†’                    await conn.execute(
   307â†’                        """
   308â†’                        INSERT INTO user_portraits (
   309â†’                            user_id, skill_id, portrait_text,
   310â†’                            based_on_messages, last_message_id, version
   311â†’                        )
   312â†’                        VALUES ($1, $2, $3, $4, $5, 1)
   313â†’                        ON CONFLICT (user_id, skill_id) DO NOTHING
   314â†’                        """,
   315â†’                        user_id, skill_id, portrait_text, message_count, last_message_id
   316â†’                    )
   317â†’                    return True
   318â†’                else:
   319â†’                    # Update with optimistic lock
   320â†’                    result = await conn.execute(
   321â†’                        """
   322â†’                        UPDATE user_portraits
   323â†’                        SET portrait_text = $1,
   324â†’                            based_on_messages = based_on_messages + $2,
   325â†’                            last_message_id = $3,
   326â†’                            version = version + 1,
   327â†’                            generated_at = NOW()
   328â†’                        WHERE user_id = $4 AND skill_id = $5 AND version = $6
   329â†’                        """,
   330â†’                        portrait_text, message_count, last_message_id,
   331â†’                        user_id, skill_id, expected_version
   332â†’                    )
   333â†’
   334â†’                    return "UPDATE 1" in result
   335â†’
   336â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   337â†’    # Helper Methods
   338â†’    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   339â†’
   340â†’    @staticmethod
   341â†’    def _format_messages(messages: List[dict]) -> str:
   342â†’        """Format messages for portrait prompt"""
   343â†’        formatted = []
   344â†’        for msg in messages[-30:]:  # Limit to last 30 messages
   345â†’            role = "ç”¨æˆ·" if msg["role"] == "user" else "Vibe"
   346â†’            content = msg["content"][:200]  # Truncate long messages
   347â†’            formatted.append(f"[{role}]: {content}")
   348â†’        return "\n".join(formatted)
   349â†’
   350â†’    @staticmethod
   351â†’    def get_default_portrait() -> str:
   352â†’        """Get default portrait for new users"""
   353â†’        return PORTRAIT_INIT_TEXT
   354â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
