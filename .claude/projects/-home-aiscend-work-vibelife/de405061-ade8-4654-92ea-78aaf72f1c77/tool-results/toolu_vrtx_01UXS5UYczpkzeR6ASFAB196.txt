     1→"use client";
     2→
     3→/**
     4→ * useJourneyData Hook - Journey 页面数据管理
     5→ *
     6→ * 读取 lifecoach skill_data，支持乐观更新
     7→ * 遵循 React Best Practices: client-swr-dedup
     8→ */
     9→
    10→import useSWR from "swr";
    11→import { useCallback } from "react";
    12→import { apiClient } from "@/lib/api";
    13→import type {
    14→  LifecoachSkillData,
    15→  ReadLifecoachStateResponse,
    16→  JourneyState,
    17→  WeeklyAction,
    18→  DailyLever,
    19→  Milestone,
    20→} from "@/types/journey";
    21→import { getJourneyState } from "@/types/journey";
    22→
    23→const JOURNEY_KEY = "/journey";
    24→
    25→// ═══════════════════════════════════════════════════════════════════════════
    26→// Fetcher
    27→// ═══════════════════════════════════════════════════════════════════════════
    28→
    29→async function fetcher(): Promise<LifecoachSkillData> {
    30→  const { data } = await apiClient.get<ReadLifecoachStateResponse>(JOURNEY_KEY);
    31→
    32→  if (data.status === "error") {
    33→    throw new Error(data.message || "Failed to load journey data");
    34→  }
    35→
    36→  return data.data || {};
    37→}
    38→
    39→// ═══════════════════════════════════════════════════════════════════════════
    40→// Hook
    41→// ═══════════════════════════════════════════════════════════════════════════
    42→
    43→export function useJourneyData() {
    44→  const { data, error, isLoading, mutate } = useSWR<LifecoachSkillData>(
    45→    JOURNEY_KEY,
    46→    fetcher,
    47→    {
    48→      revalidateOnFocus: false,
    49→      revalidateOnReconnect: true,
    50→      dedupingInterval: 60000, // 1 minute dedup
    51→      errorRetryCount: 3,
    52→    }
    53→  );
    54→
    55→  // ═══════════════════════════════════════════════════════════════════════════
    56→  // Computed Values
    57→  // ═══════════════════════════════════════════════════════════════════════════
    58→
    59→  const journeyState: JourneyState = getJourneyState(data);
    60→  const hasNorthStar = !!data?.north_star?.vision_scene;
    61→  const hasIdentity = !!data?.identity?.target;
    62→  const hasRoadmap = (data?.roadmap?.goals?.length ?? 0) > 0 || (data?.goals?.length ?? 0) > 0;
    63→  const hasWeeklyActions = (data?.weekly?.rocks?.length ?? 0) > 0 || (data?.weekly_rocks?.rocks?.length ?? 0) > 0;
    64→  const hasMonthlyBoss = !!data?.monthly_boss?.title;
    65→  const hasDailyLevers = (data?.daily_levers?.levers?.length ?? 0) > 0;
    66→
    67→  // Normalize weekly data (support both formats)
    68→  const weekly = data?.weekly_rocks || data?.weekly;
    69→
    70→  // Normalize goals data
    71→  const goals = data?.roadmap?.goals || data?.goals || [];
    72→
    73→  // ═══════════════════════════════════════════════════════════════════════════
    74→  // Actions
    75→  // ═══════════════════════════════════════════════════════════════════════════
    76→
    77→  /**
    78→   * 切换周大石头完成状态
    79→   */
    80→  const toggleAction = useCallback(
    81→    async (actionId: string) => {
    82→      const rocks = weekly?.rocks;
    83→      if (!rocks) return;
    84→
    85→      const actionIndex = rocks.findIndex(
    86→        (r) => r.id === actionId || r.task === actionId
    87→      );
    88→      if (actionIndex === -1) return;
    89→
    90→      const action = rocks[actionIndex];
    91→      const newStatus: WeeklyAction["status"] =
    92→        action.status === "completed" ? "pending" : "completed";
    93→
    94→      // 1. Optimistic update
    95→      const updatedRocks = rocks.map((r, i) =>
    96→        i === actionIndex ? { ...r, status: newStatus } : r
    97→      );
    98→      const optimisticData: LifecoachSkillData = {
    99→        ...data,
   100→        weekly: data?.weekly ? { ...data.weekly, rocks: updatedRocks } : undefined,
   101→        weekly_rocks: data?.weekly_rocks ? { ...data.weekly_rocks, rocks: updatedRocks } : undefined,
   102→      };
   103→      await mutate(optimisticData, false);
   104→
   105→      try {
   106→        // 2. API call - 通过 Journey API route
   107→        await apiClient.post("/journey", {
   108→          args: {
   109→            section: "current",
   110→            data: {
   111→              week: {
   112→                rocks: updatedRocks,
   113→              },
   114→            },
   115→          },
   116→        });
   117→      } catch (err) {
   118→        // 3. Rollback on error
   119→        await mutate(data, false);
   120→        throw err;
   121→      }
   122→    },
   123→    [data, weekly, mutate]
   124→  );
   125→
   126→  /**
   127→   * 切换每日杠杆完成状态
   128→   */
   129→  const toggleLever = useCallback(
   130→    async (leverId: string) => {
   131→      const levers = data?.daily_levers?.levers;
   132→      if (!levers) return;
   133→
   134→      const leverIndex = levers.findIndex((l) => l.id === leverId);
   135→      if (leverIndex === -1) return;
   136→
   137→      const lever = levers[leverIndex];
   138→      const newStatus: DailyLever["status"] =
   139→        lever.status === "completed" ? "pending" : "completed";
   140→
   141→      // 1. Optimistic update
   142→      const updatedLevers = levers.map((l, i) =>
   143→        i === leverIndex
   144→          ? { ...l, status: newStatus, completed_at: newStatus === "completed" ? new Date().toISOString() : undefined }
   145→          : l
   146→      );
   147→      const optimisticData: LifecoachSkillData = {
   148→        ...data,
   149→        daily_levers: data?.daily_levers
   150→          ? { ...data.daily_levers, levers: updatedLevers }
   151→          : undefined,
   152→      };
   153→      await mutate(optimisticData, false);
   154→
   155→      try {
   156→        // 2. API call
   157→        await apiClient.post("/skills/lifecoach/lever_complete", {
   158→          lever_id: leverId,
   159→        });
   160→      } catch (err) {
   161→        // 3. Rollback on error
   162→        await mutate(data, false);
   163→        throw err;
   164→      }
   165→    },
   166→    [data, mutate]
   167→  );
   168→
   169→  /**
   170→   * 切换月度 Boss 里程碑完成状态
   171→   */
   172→  const toggleMilestone = useCallback(
   173→    async (milestoneId: string) => {
   174→      const milestones = data?.monthly_boss?.milestones;
   175→      if (!milestones) return;
   176→
   177→      const milestoneIndex = milestones.findIndex((m) => m.id === milestoneId);
   178→      if (milestoneIndex === -1) return;
   179→
   180→      const milestone = milestones[milestoneIndex];
   181→      const newCompleted = !milestone.completed;
   182→
   183→      // 1. Optimistic update
   184→      const updatedMilestones: Milestone[] = milestones.map((m, i) =>
   185→        i === milestoneIndex
   186→          ? { ...m, completed: newCompleted, completed_at: newCompleted ? new Date().toISOString() : undefined }
   187→          : m
   188→      );
   189→
   190→      // Calculate new progress
   191→      const completedCount = updatedMilestones.filter((m) => m.completed).length;
   192→      const newProgress = Math.round((completedCount / updatedMilestones.length) * 100);
   193→
   194→      const optimisticData: LifecoachSkillData = {
   195→        ...data,
   196→        monthly_boss: data?.monthly_boss
   197→          ? { ...data.monthly_boss, milestones: updatedMilestones, progress: newProgress }
   198→          : undefined,
   199→      };
   200→      await mutate(optimisticData, false);
   201→
   202→      try {
   203→        // 2. API call
   204→        await apiClient.post("/journey", {
   205→          args: {
   206→            section: "current",
   207→            data: {
   208→              month: {
   209→                milestones: updatedMilestones,
   210→                progress: newProgress,
   211→              },
   212→            },
   213→          },
   214→        });
   215→      } catch (err) {
   216→        // 3. Rollback on error
   217→        await mutate(data, false);
   218→        throw err;
   219→      }
   220→    },
   221→    [data, mutate]
   222→  );
   223→
   224→  /**
   225→   * 每日签到
   226→   */
   227→  const checkin = useCallback(
   228→    async (energyLevel?: number, intention?: string) => {
   229→      try {
   230→        const response = await apiClient.post<{
   231→          success: boolean;
   232→          streak: number;
   233→          message: string;
   234→          daily_levers?: LifecoachSkillData["daily_levers"];
   235→        }>("/skills/lifecoach/checkin", {
   236→          energy_level: energyLevel,
   237→          intention,
   238→        });
   239→
   240→        if (response.data.success) {
   241→          // Update local data with new streak and daily levers
   242→          const optimisticData: LifecoachSkillData = {
   243→            ...data,
   244→            progress: data?.progress
   245→              ? {
   246→                  ...data.progress,
   247→                  current_streak: response.data.streak,
   248→                  today_checked_in: true,
   249→                }
   250→              : undefined,
   251→            daily_levers: response.data.daily_levers || data?.daily_levers,
   252→          };
   253→          await mutate(optimisticData, false);
   254→        }
   255→
   256→        return response.data;
   257→      } catch (err) {
   258→        throw err;
   259→      }
   260→    },
   261→    [data, mutate]
   262→  );
   263→
   264→  /**
   265→   * 刷新数据
   266→   */
   267→  const refresh = useCallback(() => {
   268→    return mutate();
   269→  }, [mutate]);
   270→
   271→  return {
   272→    // Data
   273→    data,
   274→    isLoading,
   275→    error,
   276→
   277→    // Computed
   278→    journeyState,
   279→    hasNorthStar,
   280→    hasIdentity,
   281→    hasRoadmap,
   282→    hasWeeklyActions,
   283→    hasMonthlyBoss,
   284→    hasDailyLevers,
   285→
   286→    // Sections
   287→    northStar: data?.north_star,
   288→    identity: data?.identity,
   289→    roadmap: data?.roadmap,
   290→    goals,
   291→    weekly,
   292→    monthlyBoss: data?.monthly_boss,
   293→    dailyLevers: data?.daily_levers,
   294→    progress: data?.progress,
   295→    systemState: data?._state,
   296→
   297→    // Actions
   298→    toggleAction,
   299→    toggleLever,
   300→    toggleMilestone,
   301→    checkin,
   302→    refresh,
   303→  };
   304→}
   305→
   306→export default useJourneyData;
   307→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
