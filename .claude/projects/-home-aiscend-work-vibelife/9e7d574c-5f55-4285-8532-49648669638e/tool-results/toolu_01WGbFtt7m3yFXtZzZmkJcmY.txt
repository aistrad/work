     1→# VibeLife 系统配置手册
     2→
     3→> 本文档包含配置和运行整个系统所需的全部核心信息
     4→
     5→---
     6→
     7→## 1. 环境变量完整配置
     8→
     9→复制到 `.env` 文件（项目根目录）:
    10→
    11→```bash
    12→# ═══════════════════════════════════════════════════════════════
    13→# 数据库 (必需)
    14→# ═══════════════════════════════════════════════════════════════
    15→VIBELIFE_DB_URL=postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
    16→VIBELIFE_DB_HOST=106.37.170.238
    17→VIBELIFE_DB_PORT=8224
    18→VIBELIFE_DB_NAME=vibelife
    19→VIBELIFE_DB_USER=postgres
    20→VIBELIFE_DB_PASSWORD=Ak4_9lScd-69WX
    21→VIBELIFE_DB_SSLMODE=prefer
    22→
    23→# ═══════════════════════════════════════════════════════════════
    24→# JWT 认证 (必需)
    25→# ═══════════════════════════════════════════════════════════════
    26→VIBELIFE_JWT_SECRET=vibelife-jwt-secret-key-2026-aiscend
    27→VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
    28→VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30
    29→
    30→# ═══════════════════════════════════════════════════════════════
    31→# API 服务 (必需)
    32→# ═══════════════════════════════════════════════════════════════
    33→VIBELIFE_API_PORT=8000
    34→VIBELIFE_API_HOST=0.0.0.0
    35→VIBELIFE_DEV=1
    36→VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8230,http://106.37.170.238:8231,http://106.37.170.238:8232,http://localhost:3000
    37→
    38→# ═══════════════════════════════════════════════════════════════
    39→# LLM 服务 (必需，至少配置一个)
    40→# ═══════════════════════════════════════════════════════════════
    41→
    42→# 智谱 GLM (主要对话模型)
    43→GLM_API_KEY=42b82ed9a13e4e8890ef3854bb840ef8.TcWZ4DIq0NF2xElF
    44→GLM_CHAT_MODEL=glm-4-flash
    45→GLM_VISION_MODEL=glm-4.6v
    46→GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
    47→
    48→# Claude (备选)
    49→CLAUDE_API_KEY=sk-Z0kVvuz5cIwtomKfLQH23MuYxsTgG7IuFxSDaeYoV4xwHGqD
    50→CLAUDE_BASE_URL=https://api2.qiandao.mom/v1
    51→CLAUDE_MODEL=claude-3-5-sonnet-20241022
    52→
    53→# Gemini (生图 + Embedding)
    54→GEMINI_API_KEY=sk-ynk9oTMtjhszj4IDoyUZreMg04NfefVGTlFtW7QvGYw4k9Dg
    55→GEMINI_BASE_URL=https://new.12ai.org/v1
    56→GEMINI_CHAT_MODEL=gemini-2.5-flash
    57→GEMINI_IMAGE_MODEL=gemini-2.5-flash-image
    58→
    59→# 默认提供商 (已迁移到 config/models.yaml)
    60→# DEFAULT_LLM_PROVIDER 已废弃，从 models.yaml defaults.chat.primary 读取
    61→# DEFAULT_IMAGE_PROVIDER 已废弃，从 models.yaml defaults.image_gen.primary 读取
    62→
    63→# ═══════════════════════════════════════════════════════════════
    64→# 向量嵌入 (知识库必需)
    65→# ═══════════════════════════════════════════════════════════════
    66→EMBEDDING_MODEL_NAME=BAAI/bge-m3
    67→EMBEDDING_DIMENSION=1024
    68→EMBEDDING_DEVICE=cuda
    69→EMBEDDING_LOCAL_DIR=/home/aiscend/.cache/vibelife/models/bge-m3
    70→DEFAULT_EMBEDDING_PROVIDER=local
    71→
    72→# ═══════════════════════════════════════════════════════════════
    73→# 向量存储 Pinecone (知识库必需)
    74→# ═══════════════════════════════════════════════════════════════
    75→PINECONE_API_KEY=pcsk_tVETE_HsAhSvJG9yN2nSdGfkMz2aTefYa72inmvnp97musqf3twzRgDiLEtHDdYAsBmiQ
    76→PINECONE_HOST=mentis-streams-nkchadl.svc.aped-4627-b74a.pinecone.io
    77→PINECONE_INDEX=vibelife-knowledge
    78→DEFAULT_VECTOR_PROVIDER=pinecone
    79→
    80→# ═══════════════════════════════════════════════════════════════
    81→# Stripe 支付 (商业化必需)
    82→# ═══════════════════════════════════════════════════════════════
    83→STRIPE_SECRET_KEY=sk_test_51Snq9KE8u1baYET0WjoEzHNCjlDAkaaATNEFyziJs4X1HF1AjPnV4YhrjS2Gy6UIhGApAenJn8BbP1uxwMrleRbS000LPmMzrC
    84→STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
    85→# STRIPE_WEBHOOK_SECRET=whsec_xxx  # Stripe Dashboard 创建 webhook 后获取
    86→
    87→# ═══════════════════════════════════════════════════════════════
    88→# 数据目录
    89→# ═══════════════════════════════════════════════════════════════
    90→VIBELIFE_DATA_ROOT=/data/vibelife
    91→VIBELIFE_KNOWLEDGE_ROOT=/data/vibelife/knowledge
    92→VIBELIFE_UPLOADS_ROOT=/data/vibelife/uploads
    93→VIBELIFE_CACHE_ROOT=/data/vibelife/cache
    94→VIBELIFE_LOGS_ROOT=/data/vibelife/logs
    95→
    96→# ═══════════════════════════════════════════════════════════════
    97→# 域名 (生产环境)
    98→# ═══════════════════════════════════════════════════════════════
    99→VIBELIFE_DOMAIN=vibelife.app
   100→BAZI_DOMAIN=bazi.vibelife.app
   101→ZODIAC_DOMAIN=zodiac.vibelife.app
   102→MBTI_DOMAIN=mbti.vibelife.app
   103→ID_DOMAIN=id.vibelife.app
   104→VIBELIFE_WEB_URL=http://106.37.170.238:8232
   105→```
   106→
   107→---
   108→
   109→## 2. 前端环境变量
   110→
   111→`apps/web/.env.local`:
   112→
   113→```bash
   114→NEXT_PUBLIC_API_URL=http://106.37.170.238:8100
   115→NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1
   116→NEXT_PUBLIC_WS_URL=ws://106.37.170.238:8100/ws
   117→VIBELIFE_API_INTERNAL=http://127.0.0.1:8100
   118→NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
   119→```
   120→
   121→---
   122→
   123→## 3. 数据库初始化
   124→
   125→```bash
   126→# 连接数据库
   127→psql postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
   128→
   129→# 按顺序执行迁移
   130→psql -f migrations/001_v3_schema.sql
   131→psql -f migrations/002_interview_sessions.sql
   132→psql -f migrations/003_model_router.sql
   133→psql -f migrations/004_update_model_routes.sql
   134→psql -f migrations/005_user_gender_voice_mode.sql
   135→psql -f migrations/006_fix_knowledge_table_refs.sql
   136→psql -f migrations/007_skill_terms.sql
   137→psql -f migrations/008_knowledge_converted_path.sql
   138→psql -f migrations/009_user_notifications.sql
   139→psql -f migrations/010_user_entitlements.sql
   140→psql -f migrations/011_guest_sessions.sql
   141→psql -f migrations/012_payment_dual_track.sql
   142→psql -f migrations/013_fortune_cache.sql
   143→psql -f migrations/014_user_skill_data.sql
   144→```
   145→
   146→必需扩展: `uuid-ossp`, `pgcrypto`, `vector` (pgvector)
   147→
   148→---
   149→
   150→## 4. 启动与部署
   151→
   152→### 4.1 基础依赖安装
   153→
   154→```bash
   155→# 前端依赖
   156→pnpm install
   157→
   158→# 后端依赖
   159→pip install -r apps/api/requirements.txt
   160→```
   161→
   162→### 4.2 开发与测试环境
   163→
   164→```bash
   165→# 开发环境 (API: 8000, Web: 3000)
   166→cd apps/api && uvicorn main:app --reload --host 0.0.0.0 --port 8000
   167→cd apps/web && pnpm dev
   168→
   169→# 测试环境 (API: 8100, Web: 8232)
   170→cd apps/api && uvicorn main:app --host 0.0.0.0 --port 8100
   171→cd apps/web && PORT=8232 pnpm dev
   172→```
   173→
   174→### 4.3 生产环境分布式部署 (Cloudflare + 火山香港 + 北京)
   175→
   176→**网络路径：** 用户 (全球) -> Cloudflare (边缘节点) -> [HTTPS加密隧道] -> 火山引擎香港 (源站Nginx) -> 火山引擎香港 (前端Next.js) -> 北京服务器 (API后端) -> 北京服务器 (PgSQL)
   177→
   178→#### A. Cloudflare 安全配置
   179→1. **Origin CA 证书**:
   180→   - `SSL/TLS` -> `Origin Server` -> `Create Certificate` (ECC, 15年)。
   181→   - 复制证书和私钥，分别保存至 `deploy/huoshan/vibelife.pem` 和 `vibelife.key`。
   182→2. **加密模式**: `SSL/TLS` -> `Overview` -> 选择 **Full (Strict) / 完全（严格）**。
   183→3. **DNS 代理**:
   184→   - 配置 `@` 及所有子域名 (`bazi/zodiac/id/mbti/m`) 的 A 记录指向香港服务器 `101.47.72.235`。
   185→   - 确保 **Proxy status** 为 **Proxied (开启代理/小黄云)** 以享受 DDoS 防护和加速。
   186→
   187→#### B. 火山香港服务器 (前端/入口)
   188→1. **工程同步**: `git clone git@github.com:aiscendtech/vibelife.git /opt/vibelife`
   189→2. **Nginx 配置**:
   190→   ```bash
   191→   cp /opt/vibelife/deploy/huoshan/vibelife.conf /etc/nginx/sites-enabled/
   192→   rm /etc/nginx/sites-enabled/default
   193→   nginx -t && systemctl reload nginx
   194→   ```
   195→3. **前端服务 (端口 8230)**:
   196→   ```bash
   197→   cd /opt/vibelife/apps/web
   198→   ./start_web.sh  # 首次需安装 Node 25/pnpm
   199→   ```
   200→
   201→#### C. 北京服务器 (后端/数据)
   202→1. **API 服务 (端口 8231)**:
   203→   ```bash
   204→   cd /opt/vibelife/apps/api
   205→   ./start_api.sh
   206→   ```
   207→2. **更新后重启**: 每次代码更新后，分别执行对应的 `start_web.sh` 或 `start_api.sh`。
   208→
   209→---
   210→
   211→## 5. 端口分配
   212→
   213→| 服务 | 开发 | 测试 | 生产 (分布式) |
   214→|------|------|------|--------------|
   215→| API Backend | 8000 | 8100 | 8231 (北京) |
   216→| Web Frontend | 3000 | 8232 | 8230 (香港) |
   217→| PostgreSQL | - | 8224 | 8224 (北京) |
   218→| Nginx (Entry) | - | - | 80/443 (香港) |
   219→
   220→---
   221→
   222→## 6. 核心目录结构
   223→
   224→```
   225→apps/api/
   226→├── main.py              # 入口，路由注册
   227→├── routes/              # API 路由 (17个)
   228→├── services/            # 业务服务 (21个模块)
   229→│   ├── vibe_engine/     # 核心引擎 (context, llm, portrait)
   230→│   ├── model_router/    # 模型路由 (多模型、配额、降级)
   231→│   ├── persona/         # 人格系统 (warm/sarcastic/wise)
   232→│   ├── knowledge/       # RAG 知识检索
   233→│   ├── identity/        # 认证 (JWT/OAuth)
   234→│   ├── billing/         # 账单
   235→│   ├── entitlement/     # 权益
   236→│   └── ...
   237→├── stores/db.py         # 数据库连接池
   238→├── tools/               # 命理计算 (bazi/zodiac)
   239→└── workers/             # 后台任务 (IngestionWorker)
   240→
   241→apps/web/src/
   242→├── app/                 # Next.js App Router 页面
   243→├── components/          # React 组件
   244→└── hooks/               # 自定义 Hooks
   245→```
   246→
   247→---
   248→
   249→## 7. API 路由清单
   250→
   251→| 路由 | 前缀 | 核心端点 |
   252→|------|------|----------|
   253→| auth | /api/v1 | POST /auth/login, /auth/register |
   254→| guest | /api/v1 | POST /guest/session |
   255→| users | /api/v1 | GET /users/me, PUT /users/profile |
   256→| chat | /api/v1 | POST /chat/message (SSE) |
   257→| onboarding | /api/v1 | POST /onboarding/start |
   258→| report | /api/v1 | POST /report/generate |
   259→| relationship | /api/v1 | POST /relationship/analyze |
   260→| fortune | /api/v1 | GET /fortune/yearly |
   261→| payment | /api/v1 | POST /payment/create-session |
   262→| billing | /api/v1 | GET /billing/subscription |
   263→| entitlement | /api/v1 | GET /entitlement/check |
   264→| bazi | /api/v1 | POST /bazi/calculate |
   265→| zodiac | /api/v1 | POST /zodiac/chart |
   266→| memories | /api/v1 | GET /memories/insights |
   267→| identity | /api/v1 | POST /identity/link |
   268→| health | / | GET /health |
   269→
   270→---
   271→
   272→## 8. 数据库核心表
   273→
   274→| 表 | 主键 | 关键字段 |
   275→|----|------|----------|
   276→| vibe_users | id (UUID) | vibe_id, email, phone, is_guest |
   277→| user_auth | id | user_id, auth_type, auth_identifier, password_hash |
   278→| user_profiles | id | user_id, version, profile (JSONB) |
   279→| conversations | id | user_id, skill, voice_mode |
   280→| messages | id | conversation_id, role, content |
   281→| reports | id | user_id, skill, report_type, content (JSONB), is_paid |
   282→| relationships | id | initiator_id, partner_id, analysis (JSONB) |
   283→| subscriptions | id | user_id, plan_id, status, current_period_end |
   284→| payments | id | user_id, amount, currency, status |
   285→| user_entitlements | id | user_id, entitlement_type, remaining |
   286→| insights | id | user_id, category, content |
   287→
   288→---
   289→
   290→## 9. LLM 模型配置
   291→
   292→| 用途 | 提供商 | 模型 | 环境变量 |
   293→|------|--------|------|----------|
   294→| 主对话 | 智谱 | glm-4-flash | GLM_CHAT_MODEL |
   295→| 视觉 | 智谱 | glm-4.6v | GLM_VISION_MODEL |
   296→| 备选对话 | Claude | claude-3-5-sonnet | CLAUDE_MODEL |
   297→| 生图 | Gemini | gemini-2.5-flash-image | GEMINI_IMAGE_MODEL |
   298→| 向量嵌入 | 本地 | BAAI/bge-m3 (1024维) | EMBEDDING_MODEL_NAME |
   299→
   300→模型路由优先级: 数据库规则 > 代码默认值
   301→
   302→---
   303→
   304→## 10. 人格系统
   305→
   306→| 人格 | voice_mode | 风格 |
   307→|------|------------|------|
   308→| 暖心向导 | warm | 共情、支持、鼓励 |
   309→| 毒舌损友 | sarcastic | 直接、犀利、有趣 |
   310→| 人生导师 | wise | 理性、深度、像长辈指点 |
   311→
   312→存储: `user_profiles.profile.preferences.voice_mode`
   313→
   314→---
   315→
   316→## 11. 支付双轨制
   317→
   318→| 轨道 | 货币 | 类型 | 目标用户 |
   319→|------|------|------|----------|
   320→| 海外订阅 | USD | Recurring | 海外用户 |
   321→| 大陆预付 | HKD | One-time | 大陆/香港用户 |
   322→
   323→Stripe Price ID 需在 Dashboard 创建后填入环境变量。
   324→
   325→---
   326→
   327→## 12. 知识库配置
   328→
   329→向量存储: Pinecone (3072维, cosine)
   330→本地嵌入: BAAI/bge-m3 (1024维, CUDA)
   331→
   332→知识库目录:
   333→```
   334→packages/knowledge/
   335→├── bazi/      # 八字知识
   336→├── zodiac/    # 星座知识
   337→├── mbti/      # MBTI 知识
   338→└── shared/    # 共享知识
   339→```
   340→
   341→---
   342→
   343→## 13. 日志位置
   344→
   345→- API 请求日志: `/opt/vibelife/logs/api_requests.log`
   346→- 数据目录: `/data/vibelife/`
   347→- Docker 日志: `deploy/aiscend/logs/`
   348→
   349→---
   350→
   351→## 14. 健康检查
   352→
   353→```bash
   354→# API 健康检查
   355→curl http://localhost:8000/health
   356→
   357→# 数据库连接测试
   358→psql $VIBELIFE_DB_URL -c "SELECT 1"
   359→
   360→# Pinecone 连接测试
   361→curl -H "Api-Key: $PINECONE_API_KEY" https://$PINECONE_HOST/describe_index_stats
   362→```
   363→
   364→---
   365→
   366→## 15. 常见问题
   367→
   368→**Q: API 启动失败 "VIBELIFE_DB_URL not set"**
   369→A: 确保 `.env` 文件在项目根目录，且包含 `VIBELIFE_DB_URL`
   370→
   371→**Q: 前端无法连接 API**
   372→A: 检查 `VIBELIFE_CORS_ORIGINS` 是否包含前端地址
   373→
   374→**Q: 向量嵌入报错**
   375→A: 确保 `EMBEDDING_LOCAL_DIR` 路径存在，或首次运行时会自动下载模型
   376→
   377→**Q: Stripe 支付失败**
   378→A: 检查 `STRIPE_SECRET_KEY` 是否正确，测试环境用 `sk_test_` 开头的密钥
   379→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
