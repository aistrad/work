{"type":"summary","summary":"API Error 400: tool_result Missing Corresponding tool_use Block","leafUuid":"9df422ac-5148-4cf5-ac4e-9b7e0a50ab8c"}
{"type":"summary","summary":"Tool result without corresponding tool use block","leafUuid":"f564a0d9-b362-4b8d-8d2b-140edbec92dd"}
{"type":"summary","summary":"Fix tool_use_id error in Claude Code","leafUuid":"79e1a545-f1fd-49ad-acdd-295545462886"}
{"type":"summary","summary":"Fix tool_result message history bug in Claude API","leafUuid":"77ebf85f-2740-4f09-bd76-dd3f9c236a62"}
{"type":"summary","summary":"Fix tool_use_id error in message history","leafUuid":"bfbd750f-7bce-4f68-a163-ad3a42b0ce25"}
{"type":"file-history-snapshot","messageId":"46f9599e-c1ec-4e4c-b3b9-443153685e7e","snapshot":{"messageId":"46f9599e-c1ec-4e4c-b3b9-443153685e7e","trackedFileBackups":{},"timestamp":"2026-01-18T08:15:25.082Z"},"isSnapshotUpdate":false}
{"parentUuid":null,"isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","type":"user","message":{"role":"user","content":"修复/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md格式，不要改任何内容"},"uuid":"46f9599e-c1ec-4e4c-b3b9-443153685e7e","timestamp":"2026-01-18T08:15:25.039Z","thinkingMetadata":{"level":"high","disabled":false,"triggers":[]},"todos":[]}
{"type":"summary","summary":"Fix tool_use_id error in API message history","leafUuid":"2e94aa49-8904-490c-80a5-fc8b162a5e19"}
{"type":"summary","summary":"Tool message handling fix in Claude Code API","leafUuid":"e880a75d-3f62-4540-8505-5e6a26dafa01"}
{"type":"summary","summary":"Fix tool_use/tool_result mismatch in message history","leafUuid":"cd91f409-cda1-498e-80b7-2bf76bdaefc6"}
{"type":"summary","summary":"Fix Tool Message History API Error","leafUuid":"20b88d8f-8c3a-4301-8104-2bc0f3941974"}
{"parentUuid":"46f9599e-c1ec-4e4c-b3b9-443153685e7e","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LaMPZYbVYB7qvufFLBqYJh","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"用户希望我修复一个 Markdown 文件的格式问题，但不要改变任何内容。让我先读取这个文件，看看有什么格式问题需要修复。","signature":"EswCCkYICxgCKkAeQ6+fcwwpa6yZJX5T5Jzrg7k2N1+qYFqxVtAKjEk3fAotXZ4wc6vvJo4Dw5R4Ohszr0mRyR/N74hQU2Kdp00OEgzz+spxWAR9imXzCQMaDOSsNLnu/bA6cFLYGyIwbhAI4/WA+bLvZdICCFAXh5FcltIWM5UUmbENJAevnjsM5UCrMH2z/a02tyfQgQA2KrMBQZ1iSxVhfnD/0a48sQLTwQ23ZbOFgFzGgJywA6ocI0u4iajcocdykxudzQ1b0sMQaDeYA3C5/IpgJdv1NUpBn2sVJob4B2gjJZTHRGSyXpqF8k4l6yM1Y8Y3tJf+vmHNOR0B32SBtHOCM2oN6CtC02JeJ6ePmv4hq3+u4H9J5B+LRkBLS6oLHSqEMPfQiMlBNdPfZf82JIDhYCmV/C6Mk4gBqN9kucUxAjKL9ErfIreCw18YAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":37071,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":37071,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWawLUM327V5mwy9by1","type":"assistant","uuid":"e4a70500-6b82-4e08-8eca-c348ad1a208a","timestamp":"2026-01-18T08:15:31.023Z"}
{"parentUuid":"e4a70500-6b82-4e08-8eca-c348ad1a208a","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LaMPZYbVYB7qvufFLBqYJh","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XdZYqkq4NVv21pskQY8qMZ","name":"Read","input":{"file_path":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":10,"cache_creation_input_tokens":37071,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":37071,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWawLUM327V5mwy9by1","type":"assistant","uuid":"743ac2c5-41bd-4b6f-bf94-72f3d6791b01","timestamp":"2026-01-18T08:15:31.781Z"}
{"type":"summary","summary":"Tool result messaging bug fix","leafUuid":"0b0daa57-7e41-468a-9a9b-e3643ba8fe15"}
{"parentUuid":"743ac2c5-41bd-4b6f-bf94-72f3d6791b01","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XdZYqkq4NVv21pskQY8qMZ","type":"tool_result","content":"     1→Agentic Skill System 设计方案 v1.0                                                                                                        \n     2→                                                                                                                                            \n     3→  版本: 1.0 | 日期: 2026-01-18                                                                                                              \n     4→  状态: 设计稿                                                                                                                              \n     5→                                                                                                                                            \n     6→  ---                                                                                                                                       \n     7→  1. 概述                                                                                                                                   \n     8→                                                                                                                                            \n     9→  1.1 背景                                                                                                                                  \n    10→                                                                                                                                            \n    11→  当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：                                                                                      \n    12→  - 100+ 预定义 Scenario 文件                                                                                                               \n    13→  - 触发词匹配路由                                                                                                                          \n    14→  - 固定 SOP 流程执行                                                                                                                       \n    15→                                                                                                                                            \n    16→  问题：                                                                                                                                    \n    17→  - 场景数量爆炸，难以维护                                                                                                                  \n    18→  - 触发词冲突，路由不准确                                                                                                                  \n    19→  - LLM 抽取的 SOP 质量参差不齐                                                                                                             \n    20→  - 缺乏灵活性，无法处理预定义之外的需求                                                                                                    \n    21→                                                                                                                                            \n    22→  1.2 目标                                                                                                                                  \n    23→                                                                                                                                            \n    24→  设计 Agentic + 分析框架 的新架构：                                                                                                        \n    25→  - 删除 100+ Scenario 文件                                                                                                                 \n    26→  - LLM 自主理解用户意图，自主决策服务策略                                                                                                  \n    27→  - 通过\"分析框架\"确保专业性和完整性                                                                                                        \n    28→  - 知识库作为 RAG 支撑，按需检索                                                                                                           \n    29→                                                                                                                                            \n    30→  1.3 核心原则                                                                                                                              \n    31→  ┌──────────────┬──────────────────────────────────────┐                                                                                   \n    32→  │     原则     │                 说明                 │                                                                                   \n    33→  ├──────────────┼──────────────────────────────────────┤                                                                                   \n    34→  │ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │                                                                                   \n    35→  ├──────────────┼──────────────────────────────────────┤                                                                                   \n    36→  │ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │                                                                                   \n    37→  ├──────────────┼──────────────────────────────────────┤                                                                                   \n    38→  │ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │                                                                                   \n    39→  ├──────────────┼──────────────────────────────────────┤                                                                                   \n    40→  │ 工具优先     │ 用工具展示结果，而非纯文字           │                                                                                   \n    41→  └──────────────┴──────────────────────────────────────┘                                                                                   \n    42→  ---                                                                                                                                       \n    43→  2. 架构设计                                                                                                                               \n    44→                                                                                                                                            \n    45→  2.1 整体架构                                                                                                                              \n    46→                                                                                                                                            \n    47→  ┌─────────────────────────────────────────────────────────────────────┐                                                                   \n    48→  │                    Agentic Skill System                             │                                                                   \n    49→  ├─────────────────────────────────────────────────────────────────────┤                                                                   \n    50→  │                                                                     │                                                                   \n    51→  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    \n    52→  │  │                      SKILL.md (精简版)                       │   │                                                                   \n    53→  │  │                                                              │   │                                                                   \n    54→  │  │  • 专家身份 (Expert Persona)                                 │   │                                                                   \n    55→  │  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │                                                                   \n    56→  │  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │                                                                   \n    57→  │  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │                                                                   \n    58→  │  │  • 伦理边界 (Ethics)                                         │   │                                                                   \n    59→  │  │                                                              │   │                                                                   \n    60→  │  └─────────────────────────────────────────────────────────────┘   │                                                                    \n    61→  │                              │                                      │                                                                   \n    62→  │                              ▼                                      │                                                                   \n    63→  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    \n    64→  │  │                     CoreAgent (LLM)                          │   │                                                                   \n    65→  │  │                                                              │   │                                                                   \n    66→  │  │  System Prompt = SKILL.md + User Context                     │   │                                                                   \n    67→  │  │                                                              │   │                                                                   \n    68→  │  │  Agentic Loop:                                               │   │                                                                   \n    69→  │  │  1. 理解用户意图                                             │   │                                                                   \n    70→  │  │  2. 匹配核心能力，获取分析框架                               │   │                                                                   \n    71→  │  │  3. 按框架规划分析步骤                                       │   │                                                                   \n    72→  │  │  4. 按需检索知识 (search_db)                                 │   │                                                                   \n    73→  │  │  5. 调用工具展示结果                                         │   │                                                                   \n    74→  │  │  6. 引导后续对话                                             │   │                                                                   \n    75→  │  │                                                              │   │                                                                   \n    76→  │  └─────────────────────────────────────────────────────────────┘   │                                                                    \n    77→  │                              │                                      │                                                                   \n    78→  │              ┌───────────────┼───────────────┐                     │                                                                    \n    79→  │              ▼               ▼               ▼                     │                                                                    \n    80→  │         ┌────────┐     ┌──────────┐    ┌────────┐                 │                                                                     \n    81→  │         │ Tools  │     │Knowledge │    │ Cases  │                 │                                                                     \n    82→  │         │        │     │  (RAG)   │    │        │                 │                                                                     \n    83→  │         └────────┘     └──────────┘    └────────┘                 │                                                                     \n    84→  │                                                                     │                                                                   \n    85→  └─────────────────────────────────────────────────────────────────────┘                                                                   \n    86→                                                                                                                                            \n    87→  2.2 与传统架构对比                                                                                                                        \n    88→  ┌──────────┬──────────────────────────┬────────────────────────────────┐                                                                  \n    89→  │   维度   │    传统 Scenario 架构    │          Agentic 架构          │                                                                  \n    90→  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n    91→  │ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │                                                                  \n    92→  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n    93→  │ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │                                                                  \n    94→  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n    95→  │ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │                                                                  \n    96→  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n    97→  │ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │                                                                  \n    98→  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n    99→  │ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │                                                                  \n   100→  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n   101→  │ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │                                                                  \n   102→  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n   103→  │ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │                                                                  \n   104→  └──────────┴──────────────────────────┴────────────────────────────────┘                                                                  \n   105→  2.3 目录结构变化                                                                                                                          \n   106→                                                                                                                                            \n   107→  # 变更前                                                                                                                                  \n   108→  skills/bazi/                                                                                                                              \n   109→  ├── SKILL.md                    # 复杂，包含场景目录                                                                                      \n   110→  ├── scenarios/                  # 100+ 场景文件                                                                                           \n   111→  │   ├── basic_reading.md                                                                                                                  \n   112→  │   ├── career.md                                                                                                                         \n   113→  │   ├── relationship.md                                                                                                                   \n   114→  │   └── ... (100+ files)                                                                                                                  \n   115→  └── tools/                                                                                                                                \n   116→      ├── tools.yaml                                                                                                                        \n   117→      └── handlers.py                                                                                                                       \n   118→                                                                                                                                            \n   119→  # 变更后                                                                                                                                  \n   120→  skills/bazi/                                                                                                                              \n   121→  ├── SKILL.md                    # 精简版，包含分析框架                                                                                    \n   122→  ├── scenarios/                  # 删除或归档                                                                                              \n   123→  └── tools/                                                                                                                                \n   124→      ├── tools.yaml                                                                                                                        \n   125→      └── handlers.py                                                                                                                       \n   126→                                                                                                                                            \n   127→  ---                                                                                                                                       \n   128→  3. SKILL.md 模板设计                                                                                                                      \n   129→                                                                                                                                            \n   130→  3.1 结构概览                                                                                                                              \n   131→                                                                                                                                            \n   132→  ---                                                                                                                                       \n   133→  id: {skill_id}                                                                                                                            \n   134→  name: {skill_name}                                                                                                                        \n   135→  version: {version}                                                                                                                        \n   136→  description: {description}                                                                                                                \n   137→  ---                                                                                                                                       \n   138→                                                                                                                                            \n   139→  # {Skill Name}                                                                                                                            \n   140→                                                                                                                                            \n   141→  ## 专家身份                                                                                                                               \n   142→                                                                                                                                            \n   143→  ## 核心能力与分析框架                                                                                                                     \n   144→                                                                                                                                            \n   145→  ## 工具列表与调用指南                                                                                                                     \n   146→                                                                                                                                            \n   147→  ## 知识检索指南                                                                                                                           \n   148→                                                                                                                                            \n   149→  ## 服务原则                                                                                                                               \n   150→                                                                                                                                            \n   151→  ## 伦理边界                                                                                                                               \n   152→                                                                                                                                            \n   153→  3.2 Bazi SKILL.md 完整示例                                                                                                                \n   154→                                                                                                                                            \n   155→  ---                                                                                                                                       \n   156→  id: bazi                                                                                                                                  \n   157→  name: 八字命理                                                                                                                            \n   158→  version: 3.0.0                                                                                                                            \n   159→  description: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师                                                       \n   160→  ---                                                                                                                                       \n   161→                                                                                                                                            \n   162→  # 八字命理 Skill                                                                                                                          \n   163→                                                                                                                                            \n   164→  ## 专家身份                                                                                                                               \n   165→                                                                                                                                            \n   166→  我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。                                                      \n   167→                                                                                                                                            \n   168→  **核心理念**：                                                                                                                            \n   169→  - 以用神为纲、调候为急、格局为本、十神生克为用                                                                                            \n   170→  - 不故弄玄虚，用现代语言解读古老智慧                                                                                                      \n   171→  - 命理是趋势分析，不是宿命论                                                                                                              \n   172→                                                                                                                                            \n   173→  **知识来源优先级**：                                                                                                                      \n   174→  1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）                                                                                 \n   175→  2. 知识库检索结果                                                                                                                         \n   176→  3. 实战验证案例                                                                                                                           \n   177→  4. 通用命理知识                                                                                                                           \n   178→                                                                                                                                            \n   179→  ---                                                                                                                                       \n   180→                                                                                                                                            \n   181→  ## 核心能力与分析框架                                                                                                                     \n   182→                                                                                                                                            \n   183→  ### 能力 1: 命盘解读                                                                                                                      \n   184→                                                                                                                                            \n   185→  **适用场景**: 用户想了解自己的命盘、第一次算命、基础分析                                                                                  \n   186→                                                                                                                                            \n   187→  **分析框架** (必须覆盖):                                                                                                                  \n   188→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   189→  |-----|---------|---------------|                                                                                                         \n   190→  | 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |                                                                                       \n   191→  | 2 | 格局识别 | \"{日主} {月令} 格局\" |                                                                                                   \n   192→  | 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |                                                                                              \n   193→  | 4 | 关键十神状态 | 根据命盘特点检索 |                                                                                                   \n   194→                                                                                                                                            \n   195→  **输出要求**:                                                                                                                             \n   196→  - 必须调用 `show_bazi_chart` 展示命盘                                                                                                     \n   197→  - 必须调用 `show_insight` 展示核心洞察（不超过 4 点）                                                                                     \n   198→  - 引导用户深入探索                                                                                                                        \n   199→                                                                                                                                            \n   200→  ---                                                                                                                                       \n   201→                                                                                                                                            \n   202→  ### 能力 2: 事业分析                                                                                                                      \n   203→                                                                                                                                            \n   204→  **适用场景**: 事业发展、职业方向、跳槽时机、升职                                                                                          \n   205→                                                                                                                                            \n   206→  **分析框架** (必须覆盖):                                                                                                                  \n   207→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   208→  |-----|---------|---------------|                                                                                                         \n   209→  | 1 | 官杀状态 | \"官杀分析 事业\" |                                                                                                        \n   210→  | 2 | 财星状态 | \"财星分析 收入\" |                                                                                                        \n   211→  | 3 | 印星状态 | \"印星分析 贵人 学习\" |                                                                                                   \n   212→  | 4 | 食伤状态 | \"食伤分析 才华 创业\" |                                                                                                   \n   213→  | 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |                                                                                           \n   214→  | 6 | 时机建议 | 综合以上给出建议 |                                                                                                       \n   215→                                                                                                                                            \n   216→  **输出要求**:                                                                                                                             \n   217→  - 调用 `show_bazi_chart` 展示命盘                                                                                                         \n   218→  - 调用 `show_bazi_fortune` 展示大运流年                                                                                                   \n   219→  - 调用 `show_insight` 展示事业洞察                                                                                                        \n   220→  - 给出具体可操作的建议                                                                                                                    \n   221→                                                                                                                                            \n   222→  ---                                                                                                                                       \n   223→                                                                                                                                            \n   224→  ### 能力 3: 感情婚姻                                                                                                                      \n   225→                                                                                                                                            \n   226→  **适用场景**: 感情运势、婚姻状况、桃花、配偶特征                                                                                          \n   227→                                                                                                                                            \n   228→  **分析框架** (必须覆盖):                                                                                                                  \n   229→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   230→  |-----|---------|---------------|                                                                                                         \n   231→  | 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |                                                                                                   \n   232→  | 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |                                                                                           \n   233→  | 3 | 桃花状态 | \"桃花 感情\" |                                                                                                            \n   234→  | 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |                                                                                          \n   235→  | 5 | 婚姻建议 | 综合以上给出建议 |                                                                                                       \n   236→                                                                                                                                            \n   237→  **性别差异**:                                                                                                                             \n   238→  - 男命: 正财为妻星，偏财为情人                                                                                                            \n   239→  - 女命: 正官为夫星，七杀为情人                                                                                                            \n   240→                                                                                                                                            \n   241→  ---                                                                                                                                       \n   242→                                                                                                                                            \n   243→  ### 能力 4: 财运分析                                                                                                                      \n   244→                                                                                                                                            \n   245→  **适用场景**: 财运走势、投资方向、求财时机                                                                                                \n   246→                                                                                                                                            \n   247→  **分析框架** (必须覆盖):                                                                                                                  \n   248→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   249→  |-----|---------|---------------|                                                                                                         \n   250→  | 1 | 财星状态 | \"正财 偏财 财运\" |                                                                                                       \n   251→  | 2 | 财星与日主关系 | \"身强/身弱 财运\" |                                                                                                 \n   252→  | 3 | 食伤生财 | \"食伤生财 求财方式\" |                                                                                                    \n   253→  | 4 | 大运流年财运 | \"{大运} {流年} 财运\" |                                                                                               \n   254→  | 5 | 求财建议 | 综合以上给出建议 |                                                                                                       \n   255→                                                                                                                                            \n   256→  ---                                                                                                                                       \n   257→                                                                                                                                            \n   258→  ### 能力 5: 运势预测                                                                                                                      \n   259→                                                                                                                                            \n   260→  **适用场景**: 大运分析、流年运势、特定年份预测                                                                                            \n   261→                                                                                                                                            \n   262→  **分析框架** (必须覆盖):                                                                                                                  \n   263→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   264→  |-----|---------|---------------|                                                                                                         \n   265→  | 1 | 大运主题 | \"{大运干支} 大运 主题\" |                                                                                                 \n   266→  | 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |                                                                                               \n   267→  | 3 | 大运流年交互 | \"大运流年 交互 影响\" |                                                                                               \n   268→  | 4 | 关键月份 | 根据流年地支判断 |                                                                                                       \n   269→  | 5 | 趋吉避凶建议 | 综合以上给出建议 |                                                                                                   \n   270→                                                                                                                                            \n   271→  **输出要求**:                                                                                                                             \n   272→  - 必须调用 `show_bazi_fortune` 展示大运流年                                                                                               \n   273→  - 可选调用 `show_bazi_kline` 展示运势趋势图                                                                                               \n   274→                                                                                                                                            \n   275→  ---                                                                                                                                       \n   276→                                                                                                                                            \n   277→  ### 能力 6: 合婚配对                                                                                                                      \n   278→                                                                                                                                            \n   279→  **适用场景**: 双方八字合婚、配对分析                                                                                                      \n   280→                                                                                                                                            \n   281→  **分析框架** (必须覆盖):                                                                                                                  \n   282→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   283→  |-----|---------|---------------|                                                                                                         \n   284→  | 1 | 日主配合 | \"合婚 日主 配合\" |                                                                                                       \n   285→  | 2 | 用神互补 | \"合婚 用神 互补\" |                                                                                                       \n   286→  | 3 | 年柱纳音 | \"合婚 纳音 年柱\" |                                                                                                       \n   287→  | 4 | 冲合关系 | \"合婚 冲合 地支\" |                                                                                                       \n   288→  | 5 | 综合评分 | 综合以上给出评分和建议 |                                                                                                 \n   289→                                                                                                                                            \n   290→  **前置要求**: 必须收集双方出生信息                                                                                                        \n   291→                                                                                                                                            \n   292→  ---                                                                                                                                       \n   293→                                                                                                                                            \n   294→  ## 工具列表与调用指南                                                                                                                     \n   295→                                                                                                                                            \n   296→  ### 信息收集工具                                                                                                                          \n   297→                                                                                                                                            \n   298→  | 工具 | 用途 | 何时调用 |                                                                                                                \n   299→  |-----|------|---------|                                                                                                                  \n   300→  | `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |                                                                                 \n   301→  | `request_info` | 请求补充信息 | 需要更多信息时 |                                                                                        \n   302→                                                                                                                                            \n   303→  ### 计算工具                                                                                                                              \n   304→                                                                                                                                            \n   305→  | 工具 | 用途 | 何时调用 |                                                                                                                \n   306→  |-----|------|---------|                                                                                                                  \n   307→  | `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |                                                                                \n   308→                                                                                                                                            \n   309→  ### 展示工具                                                                                                                              \n   310→                                                                                                                                            \n   311→  | 工具 | 用途 | 何时调用 |                                                                                                                \n   312→  |-----|------|---------|                                                                                                                  \n   313→  | `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |                                                                                       \n   314→  | `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |                                                                                     \n   315→  | `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |                                                                                      \n   316→  | `show_insight` | 展示洞察卡片 | 总结分析结果时 |                                                                                        \n   317→  | `show_report` | 展示完整报告 | 深度分析完成时 |                                                                                         \n   318→                                                                                                                                            \n   319→  ### 检索工具                                                                                                                              \n   320→                                                                                                                                            \n   321→  | 工具 | 用途 | 何时调用 |                                                                                                                \n   322→  |-----|------|---------|                                                                                                                  \n   323→  | `search_db` | 检索知识/案例 | 需要专业知识支撑时 |                                                                                      \n   324→                                                                                                                                            \n   325→  ### 调用原则                                                                                                                              \n   326→                                                                                                                                            \n   327→  1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集                                                                               \n   328→  2. **检索支撑**: 分析前先 `search_db` 获取相关知识                                                                                        \n   329→  3. **工具展示**: 用工具呈现结果，比纯文字更直观                                                                                           \n   330→  4. **框架完整**: 按分析框架覆盖所有要点                                                                                                   \n   331→                                                                                                                                            \n   332→  ---                                                                                                                                       \n   333→                                                                                                                                            \n   334→  ## 知识检索指南                                                                                                                           \n   335→                                                                                                                                            \n   336→  ### 检索策略                                                                                                                              \n   337→                                                                                                                                            \n   338→  1. 理论知识: query = \"{概念} 理论 原理\"                                                                                                   \n   339→  2. 分析方法: query = \"{主题} 分析方法 步骤\"                                                                                               \n   340→  3. 规则依据: query = \"{主题} 规则 原则\"                                                                                                   \n   341→  4. 参考案例: query = \"{特征} 案例\"                                                                                                        \n   342→  5. 经典引用: query = \"{书名} {主题}\"                                                                                                      \n   343→                                                                                                                                            \n   344→  ### 检索示例                                                                                                                              \n   345→                                                                                                                                            \n   346→  | 需要什么 | query 示例 |                                                                                                                 \n   347→  |---------|-----------|                                                                                                                   \n   348→  | 日主强弱理论 | \"日主强弱 判断方法\" |                                                                                                    \n   349→  | 格局判断方法 | \"格局 判断 正格 变格\" |                                                                                                  \n   350→  | 用神取用规则 | \"用神 取用 扶抑 调候\" |                                                                                                  \n   351→  | 十神生克规则 | \"十神 生克 关系\" |                                                                                                       \n   352→  | 事业分析案例 | \"官杀 事业 案例\" |                                                                                                       \n   353→  | 经典引用 | \"滴天髓 用神\" |                                                                                                              \n   354→                                                                                                                                            \n   355→  ### 检索原则                                                                                                                              \n   356→                                                                                                                                            \n   357→  1. **不确定时先检索**: 专业问题先查知识库                                                                                                 \n   358→  2. **query 要具体**: 描述清楚需要什么                                                                                                     \n   359→  3. **多次检索**: 复杂问题可分多次检索                                                                                                     \n   360→  4. **结果作为依据**: 检索结果用于支撑分析                                                                                                 \n   361→                                                                                                                                            \n   362→  ---                                                                                                                                       \n   363→                                                                                                                                            \n   364→  ## 服务原则                                                                                                                               \n   365→                                                                                                                                            \n   366→  ### 1. 框架完整                                                                                                                           \n   367→  按分析框架覆盖关键要点，不遗漏重要分析。                                                                                                  \n   368→                                                                                                                                            \n   369→  ### 2. 知识支撑                                                                                                                           \n   370→  重要结论必须有知识库检索结果支撑，不凭空编造。                                                                                            \n   371→                                                                                                                                            \n   372→  ### 3. 工具优先                                                                                                                           \n   373→  用工具展示结果（命盘图、洞察卡片），而非纯文字描述。                                                                                      \n   374→                                                                                                                                            \n   375→  ### 4. 引导深入                                                                                                                           \n   376→  分析后引导用户探索更多方面，提供后续选项。                                                                                                \n   377→                                                                                                                                            \n   378→  ### 5. 语言亲和                                                                                                                           \n   379→  用现代语言解读，避免过多术语，必要时解释专业概念。                                                                                        \n   380→                                                                                                                                            \n   381→  ---                                                                                                                                       \n   382→                                                                                                                                            \n   383→  ## 伦理边界                                                                                                                               \n   384→                                                                                                                                            \n   385→  ### 绝对禁止                                                                                                                              \n   386→  - 预测具体事件发生的确切日期                                                                                                              \n   387→  - 给出\"命中注定\"的定论                                                                                                                    \n   388→  - 涉及健康诊断的具体预测                                                                                                                  \n   389→  - 替用户做重大人生决定                                                                                                                    \n   390→  - 预测死亡、重大灾难                                                                                                                      \n   391→                                                                                                                                            \n   392→  ### 表达原则                                                                                                                              \n   393→  - 命理是趋势分析，不是宿命论                                                                                                              \n   394→  - 困难时期是成长机会，不是灾难预言                                                                                                        \n   395→  - 人的主观能动性可以改变命运轨迹                                                                                                          \n   396→  - 提供建议而非决定                                                                                                                        \n   397→                                                                                                                                            \n   398→  ### 敏感话题处理                                                                                                                          \n   399→  | 话题 | 处理方式 |                                                                                                                       \n   400→  |-----|---------|                                                                                                                         \n   401→  | 健康 | 只分析五行倾向，建议咨询医生 |                                                                                                   \n   402→  | 寿命 | 不预测，转向生活质量建议 |                                                                                                       \n   403→  | 灾难 | 转化为\"需要注意的时期\" |                                                                                                         \n   404→  | 离婚 | 分析挑战，提供改善建议 |                                                                                                         \n   405→                                                                                                                                            \n   406→  3.3 Zodiac SKILL.md 完整示例                                                                                                              \n   407→                                                                                                                                            \n   408→  ---                                                                                                                                       \n   409→  id: zodiac                                                                                                                                \n   410→  name: 西方占星                                                                                                                            \n   411→  version: 3.0.0                                                                                                                            \n   412→  description: 融合现代心理占星与传统占星的专业占星师                                                                                       \n   413→  ---                                                                                                                                       \n   414→                                                                                                                                            \n   415→  # 西方占星 Skill                                                                                                                          \n   416→                                                                                                                                            \n   417→  ## 专家身份                                                                                                                               \n   418→                                                                                                                                            \n   419→  我是融合现代心理占星与传统占星的专业占星师。                                                                                              \n   420→                                                                                                                                            \n   421→  **核心理念**：                                                                                                                            \n   422→  - 星盘是潜能地图，不是命运判决书                                                                                                          \n   423→  - 行星能量可以有多种表达方式                                                                                                              \n   424→  - 占星是自我认知的工具                                                                                                                    \n   425→                                                                                                                                            \n   426→  **知识来源优先级**：                                                                                                                      \n   427→  1. 知识库检索结果                                                                                                                         \n   428→  2. 心理占星理论                                                                                                                           \n   429→  3. 传统占星规则                                                                                                                           \n   430→  4. 通用占星知识                                                                                                                           \n   431→                                                                                                                                            \n   432→  ---                                                                                                                                       \n   433→                                                                                                                                            \n   434→  ## 核心能力与分析框架                                                                                                                     \n   435→                                                                                                                                            \n   436→  ### 能力 1: 本命盘解读                                                                                                                    \n   437→                                                                                                                                            \n   438→  **适用场景**: 了解自己的星盘、性格分析、人生主题                                                                                          \n   439→                                                                                                                                            \n   440→  **分析框架** (必须覆盖):                                                                                                                  \n   441→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   442→  |-----|---------|---------------|                                                                                                         \n   443→  | 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |                                                                                             \n   444→  | 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |                                                                                             \n   445→  | 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |                                                                                             \n   446→  | 4 | 主要相位 | \"{相位类型} 相位 含义\" |                                                                                                 \n   447→  | 5 | 宫位分布 | 根据星盘特点检索 |                                                                                                       \n   448→                                                                                                                                            \n   449→  **输出要求**:                                                                                                                             \n   450→  - 必须调用 `show_zodiac_chart` 展示星盘                                                                                                   \n   451→  - 必须调用 `show_insight` 展示核心洞察                                                                                                    \n   452→                                                                                                                                            \n   453→  ---                                                                                                                                       \n   454→                                                                                                                                            \n   455→  ### 能力 2: 行运分析                                                                                                                      \n   456→                                                                                                                                            \n   457→  **适用场景**: 当前运势、行星过境影响、时机选择                                                                                            \n   458→                                                                                                                                            \n   459→  **分析框架** (必须覆盖):                                                                                                                  \n   460→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   461→  |-----|---------|---------------|                                                                                                         \n   462→  | 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |                                                                                                 \n   463→  | 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |                                                                                         \n   464→  | 3 | 影响领域 | 根据宫位判断 |                                                                                                           \n   465→  | 4 | 时间周期 | 根据行星速度判断 |                                                                                                       \n   466→  | 5 | 应对建议 | 综合以上给出建议 |                                                                                                       \n   467→                                                                                                                                            \n   468→  **输出要求**:                                                                                                                             \n   469→  - 调用 `show_zodiac_transit` 展示行运                                                                                                     \n   470→  - 调用 `show_insight` 展示行运洞察                                                                                                        \n   471→                                                                                                                                            \n   472→  ---                                                                                                                                       \n   473→                                                                                                                                            \n   474→  ### 能力 3: 合盘分析                                                                                                                      \n   475→                                                                                                                                            \n   476→  **适用场景**: 感情配对、关系分析、合作关系                                                                                                \n   477→                                                                                                                                            \n   478→  **分析框架** (必须覆盖):                                                                                                                  \n   479→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   480→  |-----|---------|---------------|                                                                                                         \n   481→  | 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |                                                                                              \n   482→  | 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |                                                                                                \n   483→  | 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |                                                                                                  \n   484→  | 4 | 宫位重叠 | \"合盘 宫位 重叠\" |                                                                                                       \n   485→  | 5 | 综合评估 | 综合以上给出评估 |                                                                                                       \n   486→                                                                                                                                            \n   487→  **输出要求**:                                                                                                                             \n   488→  - 调用 `show_zodiac_synastry` 展示合盘                                                                                                    \n   489→  - 调用 `show_insight` 展示关系洞察                                                                                                        \n   490→                                                                                                                                            \n   491→  ---                                                                                                                                       \n   492→                                                                                                                                            \n   493→  ### 能力 4: 流年预测                                                                                                                      \n   494→                                                                                                                                            \n   495→  **适用场景**: 年度运势、太阳回归、重要时间点                                                                                              \n   496→                                                                                                                                            \n   497→  **分析框架** (必须覆盖):                                                                                                                  \n   498→  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n   499→  |-----|---------|---------------|                                                                                                         \n   500→  | 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |                                                                                               \n   501→  | 2 | 外行星行运 | \"{行星} 行运 {年份}\" |                                                                                                 \n   502→  | 3 | 日月食影响 | \"日月食 {星座} 影响\" |                                                                                                 \n   503→  | 4 | 关键时间点 | 根据行运判断 |                                                                                                         \n   504→  | 5 | 年度建议 | 综合以上给出建议 |                                                                                                       \n   505→                                                                                                                                            \n   506→  ---                                                                                                                                       \n   507→                                                                                                                                            \n   508→  ## 工具列表与调用指南                                                                                                                     \n   509→                                                                                                                                            \n   510→  ### 信息收集工具                                                                                                                          \n   511→                                                                                                                                            \n   512→  | 工具 | 用途 | 何时调用 |                                                                                                                \n   513→  |-----|------|---------|                                                                                                                  \n   514→  | `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |                                                                                   \n   515→                                                                                                                                            \n   516→  ### 展示工具                                                                                                                              \n   517→                                                                                                                                            \n   518→  | 工具 | 用途 | 何时调用 |                                                                                                                \n   519→  |-----|------|---------|                                                                                                                  \n   520→  | `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |                                                                                     \n   521→  | `show_zodiac_transit` | 展示行运 | 用户问运势时 |                                                                                       \n   522→  | `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |                                                                                        \n   523→  | `show_insight` | 展示洞察 | 总结分析时 |                                                                                                \n   524→                                                                                                                                            \n   525→  ### 检索工具                                                                                                                              \n   526→                                                                                                                                            \n   527→  | 工具 | 用途 | 何时调用 |                                                                                                                \n   528→  |-----|------|---------|                                                                                                                  \n   529→  | `search_db` | 检索知识 | 需要专业知识时 |                                                                                               \n   530→                                                                                                                                            \n   531→  ---                                                                                                                                       \n   532→                                                                                                                                            \n   533→  ## 知识检索指南                                                                                                                           \n   534→                                                                                                                                            \n   535→  | 需要什么 | query 示例 |                                                                                                                 \n   536→  |---------|-----------|                                                                                                                   \n   537→  | 星座特质 | \"{星座} 特质 性格\" |                                                                                                         \n   538→  | 行星含义 | \"{行星} 含义 能量\" |                                                                                                         \n   539→  | 相位解读 | \"{相位} 解读 影响\" |                                                                                                         \n   540→  | 宫位意义 | \"第{N}宫 意义 领域\" |                                                                                                        \n   541→  | 行运影响 | \"{行星} 过境 {宫位}\" |                                                                                                       \n   542→                                                                                                                                            \n   543→  ---                                                                                                                                       \n   544→                                                                                                                                            \n   545→  ## 服务原则                                                                                                                               \n   546→                                                                                                                                            \n   547→  1. **框架完整**: 按分析框架覆盖关键要点                                                                                                   \n   548→  2. **知识支撑**: 重要结论有检索结果支撑                                                                                                   \n   549→  3. **工具优先**: 用工具展示星盘和洞察                                                                                                     \n   550→  4. **心理导向**: 强调自我认知和成长                                                                                                       \n   551→                                                                                                                                            \n   552→  ---                                                                                                                                       \n   553→                                                                                                                                            \n   554→  ## 伦理边界                                                                                                                               \n   555→                                                                                                                                            \n   556→  ### 绝对禁止                                                                                                                              \n   557→  - 预测具体事件日期                                                                                                                        \n   558→  - 给出宿命论断言                                                                                                                          \n   559→  - 健康诊断预测                                                                                                                            \n   560→  - 替用户做决定                                                                                                                            \n   561→                                                                                                                                            \n   562→  ### 表达原则                                                                                                                              \n   563→  - 星盘是潜能地图，不是命运判决                                                                                                            \n   564→  - 行星能量有多种表达方式                                                                                                                  \n   565→  - 强调自由意志和选择                                                                                                                      \n   566→                                                                                                                                            \n   567→  ---                                                                                                                                       \n   568→  4. 知识库设计                                                                                                                             \n   569→                                                                                                                                            \n   570→  4.1 知识库角色转变                                                                                                                        \n   571→                                                                                                                                            \n   572→  传统角色: Scenario 指定检索 → 固定知识                                                                                                    \n   573→  新角色: LLM 按需检索 → 动态知识支撑                                                                                                       \n   574→                                                                                                                                            \n   575→  4.2 知识库结构                                                                                                                            \n   576→                                                                                                                                            \n   577→  -- knowledge_chunks 表 (保持不变)                                                                                                         \n   578→  CREATE TABLE knowledge_chunks (                                                                                                           \n   579→      id              UUID PRIMARY KEY,                                                                                                     \n   580→      skill_id        VARCHAR(50) NOT NULL,                                                                                                 \n   581→      document_id     UUID REFERENCES knowledge_documents(id),                                                                              \n   582→      chunk_index     INT NOT NULL,                                                                                                         \n   583→      content         TEXT NOT NULL,                                                                                                        \n   584→      section_path    TEXT,                                                                                                                 \n   585→      section_title   VARCHAR(255),                                                                                                         \n   586→      embedding       VECTOR(1024),                                                                                                         \n   587→      search_text_preprocessed TEXT,                                                                                                        \n   588→      metadata        JSONB,                                                                                                                \n   589→      created_at      TIMESTAMP DEFAULT NOW()                                                                                               \n   590→  );                                                                                                                                        \n   591→                                                                                                                                            \n   592→  -- cases 表 (保持不变)                                                                                                                    \n   593→  CREATE TABLE cases (                                                                                                                      \n   594→      id              VARCHAR(50) PRIMARY KEY,                                                                                              \n   595→      skill_id        VARCHAR(50) NOT NULL,                                                                                                 \n   596→      scenario_ids    VARCHAR[],  -- 可选，用于分类                                                                                         \n   597→      name            VARCHAR(255) NOT NULL,                                                                                                \n   598→      core_data       JSONB NOT NULL,                                                                                                       \n   599→      features        JSONB NOT NULL,                                                                                                       \n   600→      tags            VARCHAR[] NOT NULL,                                                                                                   \n   601→      analysis        JSONB NOT NULL,                                                                                                       \n   602→      conclusion      JSONB NOT NULL,                                                                                                       \n   603→      authority       VARCHAR(20) DEFAULT 'medium',                                                                                         \n   604→      created_at      TIMESTAMP DEFAULT NOW()                                                                                               \n   605→  );                                                                                                                                        \n   606→                                                                                                                                            \n   607→  4.3 检索接口                                                                                                                              \n   608→                                                                                                                                            \n   609→  # search_db 工具实现                                                                                                                      \n   610→  async def search_db(                                                                                                                      \n   611→      table: str,           # \"knowledge_chunks\" 或 \"cases\"                                                                                 \n   612→      query: str,           # LLM 描述的检索需求                                                                                            \n   613→      skill_id: str,        # 限定 skill                                                                                                    \n   614→      top_k: int = 5,       # 返回数量                                                                                                      \n   615→      filters: dict = None  # 可选过滤条件                                                                                                  \n   616→  ) -> List[Dict]:                                                                                                                          \n   617→      \"\"\"                                                                                                                                   \n   618→      语义检索知识或案例。                                                                                                                  \n   619→                                                                                                                                            \n   620→      LLM 通过 query 描述需求，向量检索返回相关内容。                                                                                       \n   621→      \"\"\"                                                                                                                                   \n   622→      embedding = await embed(query)                                                                                                        \n   623→                                                                                                                                            \n   624→      if table == \"knowledge_chunks\":                                                                                                       \n   625→          return await search_knowledge(skill_id, query, embedding, top_k)                                                                  \n   626→      elif table == \"cases\":                                                                                                                \n   627→          return await search_cases(skill_id, query, embedding, top_k, filters)                                                             \n   628→                                                                                                                                            \n   629→  4.4 知识库质量要求                                                                                                                        \n   630→  ┌────────────┬───────────────────┬──────────────────┐                                                                                     \n   631→  │    指标    │       目标        │       说明       │                                                                                     \n   632→  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n   633→  │ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │                                                                                     \n   634→  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n   635→  │ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │                                                                                     \n   636→  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n   637→  │ 检索准确率 │ ≥70%              │ Top-5 结果相关   │                                                                                     \n   638→  └────────────┴───────────────────┴──────────────────┘                                                                                     \n   639→  ---                                                                                                                                       \n   640→  5. CoreAgent 调整                                                                                                                         \n   641→                                                                                                                                            \n   642→  5.1 System Prompt 构建                                                                                                                    \n   643→                                                                                                                                            \n   644→  def build_system_prompt(                                                                                                                  \n   645→      skill_id: str,                                                                                                                        \n   646→      user_context: Optional[Dict] = None                                                                                                   \n   647→  ) -> str:                                                                                                                                 \n   648→      \"\"\"                                                                                                                                   \n   649→      构建 System Prompt。                                                                                                                  \n   650→                                                                                                                                            \n   651→      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           \n   652→      \"\"\"                                                                                                                                   \n   653→      parts = []                                                                                                                            \n   654→                                                                                                                                            \n   655→      # 1. 加载 SKILL.md 全文                                                                                                               \n   656→      skill_md = load_skill_md(skill_id)                                                                                                    \n   657→      parts.append(skill_md)                                                                                                                \n   658→                                                                                                                                            \n   659→      # 2. 注入用户上下文 (如果有)                                                                                                          \n   660→      if user_context:                                                                                                                      \n   661→          ctx_text = format_user_context(user_context)                                                                                      \n   662→          parts.append(f\"\\n---\\n\\n## 用户上                                                              \n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"fd0932dc-9a23-43de-aaa4-7f131b87cb2a","timestamp":"2026-01-18T08:15:32.849Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","content":"Agentic Skill System 设计方案 v1.0                                                                                                        \n                                                                                                                                            \n  版本: 1.0 | 日期: 2026-01-18                                                                                                              \n  状态: 设计稿                                                                                                                              \n                                                                                                                                            \n  ---                                                                                                                                       \n  1. 概述                                                                                                                                   \n                                                                                                                                            \n  1.1 背景                                                                                                                                  \n                                                                                                                                            \n  当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：                                                                                      \n  - 100+ 预定义 Scenario 文件                                                                                                               \n  - 触发词匹配路由                                                                                                                          \n  - 固定 SOP 流程执行                                                                                                                       \n                                                                                                                                            \n  问题：                                                                                                                                    \n  - 场景数量爆炸，难以维护                                                                                                                  \n  - 触发词冲突，路由不准确                                                                                                                  \n  - LLM 抽取的 SOP 质量参差不齐                                                                                                             \n  - 缺乏灵活性，无法处理预定义之外的需求                                                                                                    \n                                                                                                                                            \n  1.2 目标                                                                                                                                  \n                                                                                                                                            \n  设计 Agentic + 分析框架 的新架构：                                                                                                        \n  - 删除 100+ Scenario 文件                                                                                                                 \n  - LLM 自主理解用户意图，自主决策服务策略                                                                                                  \n  - 通过\"分析框架\"确保专业性和完整性                                                                                                        \n  - 知识库作为 RAG 支撑，按需检索                                                                                                           \n                                                                                                                                            \n  1.3 核心原则                                                                                                                              \n  ┌──────────────┬──────────────────────────────────────┐                                                                                   \n  │     原则     │                 说明                 │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ 工具优先     │ 用工具展示结果，而非纯文字           │                                                                                   \n  └──────────────┴──────────────────────────────────────┘                                                                                   \n  ---                                                                                                                                       \n  2. 架构设计                                                                                                                               \n                                                                                                                                            \n  2.1 整体架构                                                                                                                              \n                                                                                                                                            \n  ┌─────────────────────────────────────────────────────────────────────┐                                                                   \n  │                    Agentic Skill System                             │                                                                   \n  ├─────────────────────────────────────────────────────────────────────┤                                                                   \n  │                                                                     │                                                                   \n  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    \n  │  │                      SKILL.md (精简版)                       │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  │  • 专家身份 (Expert Persona)                                 │   │                                                                   \n  │  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │                                                                   \n  │  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │                                                                   \n  │  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │                                                                   \n  │  │  • 伦理边界 (Ethics)                                         │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  └─────────────────────────────────────────────────────────────┘   │                                                                    \n  │                              │                                      │                                                                   \n  │                              ▼                                      │                                                                   \n  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    \n  │  │                     CoreAgent (LLM)                          │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  │  System Prompt = SKILL.md + User Context                     │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  │  Agentic Loop:                                               │   │                                                                   \n  │  │  1. 理解用户意图                                             │   │                                                                   \n  │  │  2. 匹配核心能力，获取分析框架                               │   │                                                                   \n  │  │  3. 按框架规划分析步骤                                       │   │                                                                   \n  │  │  4. 按需检索知识 (search_db)                                 │   │                                                                   \n  │  │  5. 调用工具展示结果                                         │   │                                                                   \n  │  │  6. 引导后续对话                                             │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  └─────────────────────────────────────────────────────────────┘   │                                                                    \n  │                              │                                      │                                                                   \n  │              ┌───────────────┼───────────────┐                     │                                                                    \n  │              ▼               ▼               ▼                     │                                                                    \n  │         ┌────────┐     ┌──────────┐    ┌────────┐                 │                                                                     \n  │         │ Tools  │     │Knowledge │    │ Cases  │                 │                                                                     \n  │         │        │     │  (RAG)   │    │        │                 │                                                                     \n  │         └────────┘     └──────────┘    └────────┘                 │                                                                     \n  │                                                                     │                                                                   \n  └─────────────────────────────────────────────────────────────────────┘                                                                   \n                                                                                                                                            \n  2.2 与传统架构对比                                                                                                                        \n  ┌──────────┬──────────────────────────┬────────────────────────────────┐                                                                  \n  │   维度   │    传统 Scenario 架构    │          Agentic 架构          │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │                                                                  \n  └──────────┴──────────────────────────┴────────────────────────────────┘                                                                  \n  2.3 目录结构变化                                                                                                                          \n                                                                                                                                            \n  # 变更前                                                                                                                                  \n  skills/bazi/                                                                                                                              \n  ├── SKILL.md                    # 复杂，包含场景目录                                                                                      \n  ├── scenarios/                  # 100+ 场景文件                                                                                           \n  │   ├── basic_reading.md                                                                                                                  \n  │   ├── career.md                                                                                                                         \n  │   ├── relationship.md                                                                                                                   \n  │   └── ... (100+ files)                                                                                                                  \n  └── tools/                                                                                                                                \n      ├── tools.yaml                                                                                                                        \n      └── handlers.py                                                                                                                       \n                                                                                                                                            \n  # 变更后                                                                                                                                  \n  skills/bazi/                                                                                                                              \n  ├── SKILL.md                    # 精简版，包含分析框架                                                                                    \n  ├── scenarios/                  # 删除或归档                                                                                              \n  └── tools/                                                                                                                                \n      ├── tools.yaml                                                                                                                        \n      └── handlers.py                                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n  3. SKILL.md 模板设计                                                                                                                      \n                                                                                                                                            \n  3.1 结构概览                                                                                                                              \n                                                                                                                                            \n  ---                                                                                                                                       \n  id: {skill_id}                                                                                                                            \n  name: {skill_name}                                                                                                                        \n  version: {version}                                                                                                                        \n  description: {description}                                                                                                                \n  ---                                                                                                                                       \n                                                                                                                                            \n  # {Skill Name}                                                                                                                            \n                                                                                                                                            \n  ## 专家身份                                                                                                                               \n                                                                                                                                            \n  ## 核心能力与分析框架                                                                                                                     \n                                                                                                                                            \n  ## 工具列表与调用指南                                                                                                                     \n                                                                                                                                            \n  ## 知识检索指南                                                                                                                           \n                                                                                                                                            \n  ## 服务原则                                                                                                                               \n                                                                                                                                            \n  ## 伦理边界                                                                                                                               \n                                                                                                                                            \n  3.2 Bazi SKILL.md 完整示例                                                                                                                \n                                                                                                                                            \n  ---                                                                                                                                       \n  id: bazi                                                                                                                                  \n  name: 八字命理                                                                                                                            \n  version: 3.0.0                                                                                                                            \n  description: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师                                                       \n  ---                                                                                                                                       \n                                                                                                                                            \n  # 八字命理 Skill                                                                                                                          \n                                                                                                                                            \n  ## 专家身份                                                                                                                               \n                                                                                                                                            \n  我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。                                                      \n                                                                                                                                            \n  **核心理念**：                                                                                                                            \n  - 以用神为纲、调候为急、格局为本、十神生克为用                                                                                            \n  - 不故弄玄虚，用现代语言解读古老智慧                                                                                                      \n  - 命理是趋势分析，不是宿命论                                                                                                              \n                                                                                                                                            \n  **知识来源优先级**：                                                                                                                      \n  1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）                                                                                 \n  2. 知识库检索结果                                                                                                                         \n  3. 实战验证案例                                                                                                                           \n  4. 通用命理知识                                                                                                                           \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 核心能力与分析框架                                                                                                                     \n                                                                                                                                            \n  ### 能力 1: 命盘解读                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 用户想了解自己的命盘、第一次算命、基础分析                                                                                  \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |                                                                                       \n  | 2 | 格局识别 | \"{日主} {月令} 格局\" |                                                                                                   \n  | 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |                                                                                              \n  | 4 | 关键十神状态 | 根据命盘特点检索 |                                                                                                   \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 必须调用 `show_bazi_chart` 展示命盘                                                                                                     \n  - 必须调用 `show_insight` 展示核心洞察（不超过 4 点）                                                                                     \n  - 引导用户深入探索                                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 2: 事业分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 事业发展、职业方向、跳槽时机、升职                                                                                          \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 官杀状态 | \"官杀分析 事业\" |                                                                                                        \n  | 2 | 财星状态 | \"财星分析 收入\" |                                                                                                        \n  | 3 | 印星状态 | \"印星分析 贵人 学习\" |                                                                                                   \n  | 4 | 食伤状态 | \"食伤分析 才华 创业\" |                                                                                                   \n  | 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |                                                                                           \n  | 6 | 时机建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 调用 `show_bazi_chart` 展示命盘                                                                                                         \n  - 调用 `show_bazi_fortune` 展示大运流年                                                                                                   \n  - 调用 `show_insight` 展示事业洞察                                                                                                        \n  - 给出具体可操作的建议                                                                                                                    \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 3: 感情婚姻                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 感情运势、婚姻状况、桃花、配偶特征                                                                                          \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |                                                                                                   \n  | 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |                                                                                           \n  | 3 | 桃花状态 | \"桃花 感情\" |                                                                                                            \n  | 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |                                                                                          \n  | 5 | 婚姻建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  **性别差异**:                                                                                                                             \n  - 男命: 正财为妻星，偏财为情人                                                                                                            \n  - 女命: 正官为夫星，七杀为情人                                                                                                            \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 4: 财运分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 财运走势、投资方向、求财时机                                                                                                \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 财星状态 | \"正财 偏财 财运\" |                                                                                                       \n  | 2 | 财星与日主关系 | \"身强/身弱 财运\" |                                                                                                 \n  | 3 | 食伤生财 | \"食伤生财 求财方式\" |                                                                                                    \n  | 4 | 大运流年财运 | \"{大运} {流年} 财运\" |                                                                                               \n  | 5 | 求财建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 5: 运势预测                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 大运分析、流年运势、特定年份预测                                                                                            \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 大运主题 | \"{大运干支} 大运 主题\" |                                                                                                 \n  | 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |                                                                                               \n  | 3 | 大运流年交互 | \"大运流年 交互 影响\" |                                                                                               \n  | 4 | 关键月份 | 根据流年地支判断 |                                                                                                       \n  | 5 | 趋吉避凶建议 | 综合以上给出建议 |                                                                                                   \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 必须调用 `show_bazi_fortune` 展示大运流年                                                                                               \n  - 可选调用 `show_bazi_kline` 展示运势趋势图                                                                                               \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 6: 合婚配对                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 双方八字合婚、配对分析                                                                                                      \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 日主配合 | \"合婚 日主 配合\" |                                                                                                       \n  | 2 | 用神互补 | \"合婚 用神 互补\" |                                                                                                       \n  | 3 | 年柱纳音 | \"合婚 纳音 年柱\" |                                                                                                       \n  | 4 | 冲合关系 | \"合婚 冲合 地支\" |                                                                                                       \n  | 5 | 综合评分 | 综合以上给出评分和建议 |                                                                                                 \n                                                                                                                                            \n  **前置要求**: 必须收集双方出生信息                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 工具列表与调用指南                                                                                                                     \n                                                                                                                                            \n  ### 信息收集工具                                                                                                                          \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |                                                                                 \n  | `request_info` | 请求补充信息 | 需要更多信息时 |                                                                                        \n                                                                                                                                            \n  ### 计算工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |                                                                                \n                                                                                                                                            \n  ### 展示工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |                                                                                       \n  | `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |                                                                                     \n  | `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |                                                                                      \n  | `show_insight` | 展示洞察卡片 | 总结分析结果时 |                                                                                        \n  | `show_report` | 展示完整报告 | 深度分析完成时 |                                                                                         \n                                                                                                                                            \n  ### 检索工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `search_db` | 检索知识/案例 | 需要专业知识支撑时 |                                                                                      \n                                                                                                                                            \n  ### 调用原则                                                                                                                              \n                                                                                                                                            \n  1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集                                                                               \n  2. **检索支撑**: 分析前先 `search_db` 获取相关知识                                                                                        \n  3. **工具展示**: 用工具呈现结果，比纯文字更直观                                                                                           \n  4. **框架完整**: 按分析框架覆盖所有要点                                                                                                   \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 知识检索指南                                                                                                                           \n                                                                                                                                            \n  ### 检索策略                                                                                                                              \n                                                                                                                                            \n  1. 理论知识: query = \"{概念} 理论 原理\"                                                                                                   \n  2. 分析方法: query = \"{主题} 分析方法 步骤\"                                                                                               \n  3. 规则依据: query = \"{主题} 规则 原则\"                                                                                                   \n  4. 参考案例: query = \"{特征} 案例\"                                                                                                        \n  5. 经典引用: query = \"{书名} {主题}\"                                                                                                      \n                                                                                                                                            \n  ### 检索示例                                                                                                                              \n                                                                                                                                            \n  | 需要什么 | query 示例 |                                                                                                                 \n  |---------|-----------|                                                                                                                   \n  | 日主强弱理论 | \"日主强弱 判断方法\" |                                                                                                    \n  | 格局判断方法 | \"格局 判断 正格 变格\" |                                                                                                  \n  | 用神取用规则 | \"用神 取用 扶抑 调候\" |                                                                                                  \n  | 十神生克规则 | \"十神 生克 关系\" |                                                                                                       \n  | 事业分析案例 | \"官杀 事业 案例\" |                                                                                                       \n  | 经典引用 | \"滴天髓 用神\" |                                                                                                              \n                                                                                                                                            \n  ### 检索原则                                                                                                                              \n                                                                                                                                            \n  1. **不确定时先检索**: 专业问题先查知识库                                                                                                 \n  2. **query 要具体**: 描述清楚需要什么                                                                                                     \n  3. **多次检索**: 复杂问题可分多次检索                                                                                                     \n  4. **结果作为依据**: 检索结果用于支撑分析                                                                                                 \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 服务原则                                                                                                                               \n                                                                                                                                            \n  ### 1. 框架完整                                                                                                                           \n  按分析框架覆盖关键要点，不遗漏重要分析。                                                                                                  \n                                                                                                                                            \n  ### 2. 知识支撑                                                                                                                           \n  重要结论必须有知识库检索结果支撑，不凭空编造。                                                                                            \n                                                                                                                                            \n  ### 3. 工具优先                                                                                                                           \n  用工具展示结果（命盘图、洞察卡片），而非纯文字描述。                                                                                      \n                                                                                                                                            \n  ### 4. 引导深入                                                                                                                           \n  分析后引导用户探索更多方面，提供后续选项。                                                                                                \n                                                                                                                                            \n  ### 5. 语言亲和                                                                                                                           \n  用现代语言解读，避免过多术语，必要时解释专业概念。                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 伦理边界                                                                                                                               \n                                                                                                                                            \n  ### 绝对禁止                                                                                                                              \n  - 预测具体事件发生的确切日期                                                                                                              \n  - 给出\"命中注定\"的定论                                                                                                                    \n  - 涉及健康诊断的具体预测                                                                                                                  \n  - 替用户做重大人生决定                                                                                                                    \n  - 预测死亡、重大灾难                                                                                                                      \n                                                                                                                                            \n  ### 表达原则                                                                                                                              \n  - 命理是趋势分析，不是宿命论                                                                                                              \n  - 困难时期是成长机会，不是灾难预言                                                                                                        \n  - 人的主观能动性可以改变命运轨迹                                                                                                          \n  - 提供建议而非决定                                                                                                                        \n                                                                                                                                            \n  ### 敏感话题处理                                                                                                                          \n  | 话题 | 处理方式 |                                                                                                                       \n  |-----|---------|                                                                                                                         \n  | 健康 | 只分析五行倾向，建议咨询医生 |                                                                                                   \n  | 寿命 | 不预测，转向生活质量建议 |                                                                                                       \n  | 灾难 | 转化为\"需要注意的时期\" |                                                                                                         \n  | 离婚 | 分析挑战，提供改善建议 |                                                                                                         \n                                                                                                                                            \n  3.3 Zodiac SKILL.md 完整示例                                                                                                              \n                                                                                                                                            \n  ---                                                                                                                                       \n  id: zodiac                                                                                                                                \n  name: 西方占星                                                                                                                            \n  version: 3.0.0                                                                                                                            \n  description: 融合现代心理占星与传统占星的专业占星师                                                                                       \n  ---                                                                                                                                       \n                                                                                                                                            \n  # 西方占星 Skill                                                                                                                          \n                                                                                                                                            \n  ## 专家身份                                                                                                                               \n                                                                                                                                            \n  我是融合现代心理占星与传统占星的专业占星师。                                                                                              \n                                                                                                                                            \n  **核心理念**：                                                                                                                            \n  - 星盘是潜能地图，不是命运判决书                                                                                                          \n  - 行星能量可以有多种表达方式                                                                                                              \n  - 占星是自我认知的工具                                                                                                                    \n                                                                                                                                            \n  **知识来源优先级**：                                                                                                                      \n  1. 知识库检索结果                                                                                                                         \n  2. 心理占星理论                                                                                                                           \n  3. 传统占星规则                                                                                                                           \n  4. 通用占星知识                                                                                                                           \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 核心能力与分析框架                                                                                                                     \n                                                                                                                                            \n  ### 能力 1: 本命盘解读                                                                                                                    \n                                                                                                                                            \n  **适用场景**: 了解自己的星盘、性格分析、人生主题                                                                                          \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |                                                                                             \n  | 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |                                                                                             \n  | 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |                                                                                             \n  | 4 | 主要相位 | \"{相位类型} 相位 含义\" |                                                                                                 \n  | 5 | 宫位分布 | 根据星盘特点检索 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 必须调用 `show_zodiac_chart` 展示星盘                                                                                                   \n  - 必须调用 `show_insight` 展示核心洞察                                                                                                    \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 2: 行运分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 当前运势、行星过境影响、时机选择                                                                                            \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |                                                                                                 \n  | 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |                                                                                         \n  | 3 | 影响领域 | 根据宫位判断 |                                                                                                           \n  | 4 | 时间周期 | 根据行星速度判断 |                                                                                                       \n  | 5 | 应对建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 调用 `show_zodiac_transit` 展示行运                                                                                                     \n  - 调用 `show_insight` 展示行运洞察                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 3: 合盘分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 感情配对、关系分析、合作关系                                                                                                \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |                                                                                              \n  | 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |                                                                                                \n  | 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |                                                                                                  \n  | 4 | 宫位重叠 | \"合盘 宫位 重叠\" |                                                                                                       \n  | 5 | 综合评估 | 综合以上给出评估 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 调用 `show_zodiac_synastry` 展示合盘                                                                                                    \n  - 调用 `show_insight` 展示关系洞察                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 4: 流年预测                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 年度运势、太阳回归、重要时间点                                                                                              \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |                                                                                               \n  | 2 | 外行星行运 | \"{行星} 行运 {年份}\" |                                                                                                 \n  | 3 | 日月食影响 | \"日月食 {星座} 影响\" |                                                                                                 \n  | 4 | 关键时间点 | 根据行运判断 |                                                                                                         \n  | 5 | 年度建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 工具列表与调用指南                                                                                                                     \n                                                                                                                                            \n  ### 信息收集工具                                                                                                                          \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |                                                                                   \n                                                                                                                                            \n  ### 展示工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |                                                                                     \n  | `show_zodiac_transit` | 展示行运 | 用户问运势时 |                                                                                       \n  | `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |                                                                                        \n  | `show_insight` | 展示洞察 | 总结分析时 |                                                                                                \n                                                                                                                                            \n  ### 检索工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `search_db` | 检索知识 | 需要专业知识时 |                                                                                               \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 知识检索指南                                                                                                                           \n                                                                                                                                            \n  | 需要什么 | query 示例 |                                                                                                                 \n  |---------|-----------|                                                                                                                   \n  | 星座特质 | \"{星座} 特质 性格\" |                                                                                                         \n  | 行星含义 | \"{行星} 含义 能量\" |                                                                                                         \n  | 相位解读 | \"{相位} 解读 影响\" |                                                                                                         \n  | 宫位意义 | \"第{N}宫 意义 领域\" |                                                                                                        \n  | 行运影响 | \"{行星} 过境 {宫位}\" |                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 服务原则                                                                                                                               \n                                                                                                                                            \n  1. **框架完整**: 按分析框架覆盖关键要点                                                                                                   \n  2. **知识支撑**: 重要结论有检索结果支撑                                                                                                   \n  3. **工具优先**: 用工具展示星盘和洞察                                                                                                     \n  4. **心理导向**: 强调自我认知和成长                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 伦理边界                                                                                                                               \n                                                                                                                                            \n  ### 绝对禁止                                                                                                                              \n  - 预测具体事件日期                                                                                                                        \n  - 给出宿命论断言                                                                                                                          \n  - 健康诊断预测                                                                                                                            \n  - 替用户做决定                                                                                                                            \n                                                                                                                                            \n  ### 表达原则                                                                                                                              \n  - 星盘是潜能地图，不是命运判决                                                                                                            \n  - 行星能量有多种表达方式                                                                                                                  \n  - 强调自由意志和选择                                                                                                                      \n                                                                                                                                            \n  ---                                                                                                                                       \n  4. 知识库设计                                                                                                                             \n                                                                                                                                            \n  4.1 知识库角色转变                                                                                                                        \n                                                                                                                                            \n  传统角色: Scenario 指定检索 → 固定知识                                                                                                    \n  新角色: LLM 按需检索 → 动态知识支撑                                                                                                       \n                                                                                                                                            \n  4.2 知识库结构                                                                                                                            \n                                                                                                                                            \n  -- knowledge_chunks 表 (保持不变)                                                                                                         \n  CREATE TABLE knowledge_chunks (                                                                                                           \n      id              UUID PRIMARY KEY,                                                                                                     \n      skill_id        VARCHAR(50) NOT NULL,                                                                                                 \n      document_id     UUID REFERENCES knowledge_documents(id),                                                                              \n      chunk_index     INT NOT NULL,                                                                                                         \n      content         TEXT NOT NULL,                                                                                                        \n      section_path    TEXT,                                                                                                                 \n      section_title   VARCHAR(255),                                                                                                         \n      embedding       VECTOR(1024),                                                                                                         \n      search_text_preprocessed TEXT,                                                                                                        \n      metadata        JSONB,                                                                                                                \n      created_at      TIMESTAMP DEFAULT NOW()                                                                                               \n  );                                                                                                                                        \n                                                                                                                                            \n  -- cases 表 (保持不变)                                                                                                                    \n  CREATE TABLE cases (                                                                                                                      \n      id              VARCHAR(50) PRIMARY KEY,                                                                                              \n      skill_id        VARCHAR(50) NOT NULL,                                                                                                 \n      scenario_ids    VARCHAR[],  -- 可选，用于分类                                                                                         \n      name            VARCHAR(255) NOT NULL,                                                                                                \n      core_data       JSONB NOT NULL,                                                                                                       \n      features        JSONB NOT NULL,                                                                                                       \n      tags            VARCHAR[] NOT NULL,                                                                                                   \n      analysis        JSONB NOT NULL,                                                                                                       \n      conclusion      JSONB NOT NULL,                                                                                                       \n      authority       VARCHAR(20) DEFAULT 'medium',                                                                                         \n      created_at      TIMESTAMP DEFAULT NOW()                                                                                               \n  );                                                                                                                                        \n                                                                                                                                            \n  4.3 检索接口                                                                                                                              \n                                                                                                                                            \n  # search_db 工具实现                                                                                                                      \n  async def search_db(                                                                                                                      \n      table: str,           # \"knowledge_chunks\" 或 \"cases\"                                                                                 \n      query: str,           # LLM 描述的检索需求                                                                                            \n      skill_id: str,        # 限定 skill                                                                                                    \n      top_k: int = 5,       # 返回数量                                                                                                      \n      filters: dict = None  # 可选过滤条件                                                                                                  \n  ) -> List[Dict]:                                                                                                                          \n      \"\"\"                                                                                                                                   \n      语义检索知识或案例。                                                                                                                  \n                                                                                                                                            \n      LLM 通过 query 描述需求，向量检索返回相关内容。                                                                                       \n      \"\"\"                                                                                                                                   \n      embedding = await embed(query)                                                                                                        \n                                                                                                                                            \n      if table == \"knowledge_chunks\":                                                                                                       \n          return await search_knowledge(skill_id, query, embedding, top_k)                                                                  \n      elif table == \"cases\":                                                                                                                \n          return await search_cases(skill_id, query, embedding, top_k, filters)                                                             \n                                                                                                                                            \n  4.4 知识库质量要求                                                                                                                        \n  ┌────────────┬───────────────────┬──────────────────┐                                                                                     \n  │    指标    │       目标        │       说明       │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 检索准确率 │ ≥70%              │ Top-5 结果相关   │                                                                                     \n  └────────────┴───────────────────┴──────────────────┘                                                                                     \n  ---                                                                                                                                       \n  5. CoreAgent 调整                                                                                                                         \n                                                                                                                                            \n  5.1 System Prompt 构建                                                                                                                    \n                                                                                                                                            \n  def build_system_prompt(                                                                                                                  \n      skill_id: str,                                                                                                                        \n      user_context: Optional[Dict] = None                                                                                                   \n  ) -> str:                                                                                                                                 \n      \"\"\"                                                                                                                                   \n      构建 System Prompt。                                                                                                                  \n                                                                                                                                            \n      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           \n      \"\"\"                                                                                                                                   \n      parts = []                                                                                                                            \n                                                                                                                                            \n      # 1. 加载 SKILL.md 全文                                                                                                               \n      skill_md = load_skill_md(skill_id)                                                                                                    \n      parts.append(skill_md)                                                                                                                \n                                                                                                                                            \n      # 2. 注入用户上下文 (如果有)                                                                                                          \n      if user_context:                                                                                                                      \n          ctx_text = format_user_context(user_context)                                                                                      \n          parts.append(f\"\\n---\\n\\n## 用户上                                                              ","numLines":662,"startLine":1,"totalLines":662}},"sourceToolAssistantUUID":"743ac2c5-41bd-4b6f-bf94-72f3d6791b01"}
{"type":"summary","summary":"Tool result blocks without matching tool use","leafUuid":"ef71ee82-4637-48ef-9432-ad27ab2798f4"}
{"type":"summary","summary":"Data Architecture Redesign & Tool Abstraction","leafUuid":"fc852a86-a305-44a7-9bef-55f87c87546f"}
{"type":"summary","summary":"Data architecture redesign & universal tool abstraction","leafUuid":"9279f685-c14c-4600-805b-a7687c542657"}
{"type":"summary","summary":"Data Architecture Redesign & Tool Generalization","leafUuid":"6f2282dd-0ed0-4d2b-ab05-03b786410438"}
{"type":"summary","summary":"Data Architecture Redesign & Tool Generalization","leafUuid":"bb56295d-9976-4069-b115-4ea7386782c9"}
{"parentUuid":"fd0932dc-9a23-43de-aaa4-7f131b87cb2a","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01616M2g5kX12T6LmQWmwUn4","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"文件被截断了，我需要继续读取剩余部分。让我看一下当前的格式问题：\n\n1. 第1行标题没有 `#` 标记\n2. 第7、9行的标题没有 `#` 标记\n3. 第22行的标题没有 `#` 标记\n4. 多处章节标题缺少 `#` 标记\n5. 第105行的标题缺少换行\n6. 第107行的代码块缺少语言标识\n7. 一些代码块没有用正确的代码块语法（```）包裹\n\n让我继续读取文件的其余部分。","signature":"EtcECkYICxgCKkAo7aVGvrasIA3bhhxQoshmLR6UxgdUXiqddsi/A5VarLw/mEKZHsKNJNyw/0th1jCOGQ0us5t1iQMP40drfxB6EgzHFGKXgnPM57yQNgYaDMN1d9iF5etNRQvU4SIwGg81cbwUTOd5HqHDzgwY2LBxsMAeMeYm4k1IZ21PeiOZ7gqmrztDGUh7GMeiy/SkKr4DN6Wylz9xHP0vJGpFhzP1y0MzaL8dA+MsrAmy3rghuVJ5coAkXAa8lbpOglarFRNJ9iJyCI9Uh2LQbhuOSth2BIPf/0Lz4xyT1n4O0qONyrS1e5yfZi8xJ0LBePrfUxRfiuOXX86uqKPm4IQZj5eDK9UXp7kXuyQDvOTTfOY+slRJyq77+gYp5XRBoU1trW9yxO+HvXTUr/UOvuEbz7qJy/oJaIMWLhM1Ym7BY7g6TiQMz13UVcAaBdH5JuGW3MVQth+geQjLaPwBrvv7Iqo2yxz+PU+T/0nPHJXI/FVd1uTC+nhj52iToATDpWGkJja148vdMfjvCfzqD6nKGAQCJuHd8gy2jz9pCtbu7tRgq6nE/9Tazn++vsxX1fCN5gXEaMygiyXFEdeHcTtQyExtsEPAzhF/+4vvrFx/SIRtZksnV5jBXfX2dhWSbW/5R/+cb+dNLuFcAnEBdbiwOmfhohRTDecJZ5chUmZBFe5O/sp4EJNhYJ8Tbk0/+geUuIccxZIZ4/P7pDDPPFHCRA3nnalX4JGYodRHuG4IwsSkvNvFCE0s0QQk+W7CYwhv3MQBEAjNVzRjJsrIFnXNhGUYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":16349,"cache_read_input_tokens":37071,"cache_creation":{"ephemeral_5m_input_tokens":16349,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWbXPqMCfBDsJaJy6CK","type":"assistant","uuid":"e4624ccd-3bac-443a-bc5d-711f9b3b5141","timestamp":"2026-01-18T08:15:41.593Z"}
{"type":"summary","summary":"Data Architecture Redesign & Tool Generalization","leafUuid":"211253f6-b5b0-4c48-baac-58d6f85abfcb"}
{"parentUuid":"e4624ccd-3bac-443a-bc5d-711f9b3b5141","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01616M2g5kX12T6LmQWmwUn4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RzJYMD8sxFDYxSZeaJ2sHX","name":"Read","input":{"file_path":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","offset":660}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":16349,"cache_read_input_tokens":37071,"cache_creation":{"ephemeral_5m_input_tokens":16349,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWbXPqMCfBDsJaJy6CK","type":"assistant","uuid":"e66569b3-95e0-4023-b0b3-7a028a1c222e","timestamp":"2026-01-18T08:15:43.172Z"}
{"parentUuid":"e66569b3-95e0-4023-b0b3-7a028a1c222e","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RzJYMD8sxFDYxSZeaJ2sHX","type":"tool_result","content":"   660→      if user_context:                                                                                                                      \n   661→          ctx_text = format_user_context(user_context)                                                                                      \n   662→          parts.append(f\"\\n---\\n\\n## 用户上                                                              \n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"a75ae9f9-ad2d-491d-8fe0-4b5a433668d2","timestamp":"2026-01-18T08:15:43.428Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","content":"      if user_context:                                                                                                                      \n          ctx_text = format_user_context(user_context)                                                                                      \n          parts.append(f\"\\n---\\n\\n## 用户上                                                              ","numLines":3,"startLine":660,"totalLines":662}},"sourceToolAssistantUUID":"e66569b3-95e0-4023-b0b3-7a028a1c222e"}
{"type":"summary","summary":"Data Architecture & Universal Tool Design","leafUuid":"93688dad-a6fc-4434-9051-84b91a54637f"}
{"type":"summary","summary":"Data architecture refactor: core tools generalization","leafUuid":"cb81187c-4bbd-4f6a-a4d7-e84a9369ea6a"}
{"parentUuid":"a75ae9f9-ad2d-491d-8fe0-4b5a433668d2","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_015GLDq5bPzyYnBTLDYd1dT2","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"看起来文件在第662行被截断了。让我继续读取更多内容。","signature":"EvMBCkYICxgCKkD7V1MaZ2h4t2QHZIEIix2bhzzyd22cw82Q5wFGUkCyCUxfv6d+NyN4dqmwKX1VgdQD6c58x+PTG7mRufY7QUnyEgzmVFfs+eo6TJiURcwaDCLGcPoPmIoDwNih/CIwZJLZzSv8JoOLi9rHJaUSRtPyKDB0BQmg/ClLCgkMnKYK62FGLHQRQ2LvCfDs0v9rKlvqh2JRioCJPkvy4syMNHp1Hxl+PSdXWVHEwZZEFyiNX9j+qURy1Q56nEJKN6l8flPQCgBDW0zvBlWujoMh6fR7kvqenCK/nCc1qKeVN08a1A5ffb7HpOsKTq6MGAE="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":459,"cache_read_input_tokens":53420,"cache_creation":{"ephemeral_5m_input_tokens":459,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWcJ8tsnVfLnb8vU38M","type":"assistant","uuid":"634b2076-f9f6-4c5c-9dbf-efe721cd323f","timestamp":"2026-01-18T08:15:47.511Z"}
{"parentUuid":"634b2076-f9f6-4c5c-9dbf-efe721cd323f","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_015GLDq5bPzyYnBTLDYd1dT2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GktyvjpRUqyGmCPUMJX65m","name":"Read","input":{"file_path":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","offset":640,"limit":500}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":459,"cache_read_input_tokens":53420,"cache_creation":{"ephemeral_5m_input_tokens":459,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWcJ8tsnVfLnb8vU38M","type":"assistant","uuid":"8f06873d-f9c2-435f-8f74-6d63bed15cb3","timestamp":"2026-01-18T08:15:48.688Z"}
{"parentUuid":"8f06873d-f9c2-435f-8f74-6d63bed15cb3","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GktyvjpRUqyGmCPUMJX65m","type":"tool_result","content":"   640→  5. CoreAgent 调整                                                                                                                         \n   641→                                                                                                                                            \n   642→  5.1 System Prompt 构建                                                                                                                    \n   643→                                                                                                                                            \n   644→  def build_system_prompt(                                                                                                                  \n   645→      skill_id: str,                                                                                                                        \n   646→      user_context: Optional[Dict] = None                                                                                                   \n   647→  ) -> str:                                                                                                                                 \n   648→      \"\"\"                                                                                                                                   \n   649→      构建 System Prompt。                                                                                                                  \n   650→                                                                                                                                            \n   651→      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           \n   652→      \"\"\"                                                                                                                                   \n   653→      parts = []                                                                                                                            \n   654→                                                                                                                                            \n   655→      # 1. 加载 SKILL.md 全文                                                                                                               \n   656→      skill_md = load_skill_md(skill_id)                                                                                                    \n   657→      parts.append(skill_md)                                                                                                                \n   658→                                                                                                                                            \n   659→      # 2. 注入用户上下文 (如果有)                                                                                                          \n   660→      if user_context:                                                                                                                      \n   661→          ctx_text = format_user_context(user_context)                                                                                      \n   662→          parts.append(f\"\\n---\\n\\n## 用户上                                                              \n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"2e0ec20a-5c62-4c56-89a3-7901dd47f301","timestamp":"2026-01-18T08:15:48.835Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","content":"  5. CoreAgent 调整                                                                                                                         \n                                                                                                                                            \n  5.1 System Prompt 构建                                                                                                                    \n                                                                                                                                            \n  def build_system_prompt(                                                                                                                  \n      skill_id: str,                                                                                                                        \n      user_context: Optional[Dict] = None                                                                                                   \n  ) -> str:                                                                                                                                 \n      \"\"\"                                                                                                                                   \n      构建 System Prompt。                                                                                                                  \n                                                                                                                                            \n      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           \n      \"\"\"                                                                                                                                   \n      parts = []                                                                                                                            \n                                                                                                                                            \n      # 1. 加载 SKILL.md 全文                                                                                                               \n      skill_md = load_skill_md(skill_id)                                                                                                    \n      parts.append(skill_md)                                                                                                                \n                                                                                                                                            \n      # 2. 注入用户上下文 (如果有)                                                                                                          \n      if user_context:                                                                                                                      \n          ctx_text = format_user_context(user_context)                                                                                      \n          parts.append(f\"\\n---\\n\\n## 用户上                                                              ","numLines":23,"startLine":640,"totalLines":662}},"sourceToolAssistantUUID":"8f06873d-f9c2-435f-8f74-6d63bed15cb3"}
{"parentUuid":"2e0ec20a-5c62-4c56-89a3-7901dd47f301","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LcKjVbNgiueViUqRzBTDa7","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"文件似乎只有到第662行就结束了，但行末被截断了。让我使用Bash来读取完整的文件。","signature":"EpkCCkYICxgCKkAxe38hark8Vo73V4qPG5tZx56VOAb6mPyyF8lD/psLS8BwsCs0vXMR9hFqiG+qktUD7aTAqRzDHruXRWWe/fgsEgw9jljP9wcy+p7VABwaDPkTGejQaayhjb+AayIwK+wL8N2qVCp1eWhEGdlPiImjuxUHdBuEsYTZ9EwYGlHKac3rD5FwS6zZsZPds4NIKoABs0AxGcnHpSZUI0B+t9kqclQZUeHCAHsSuleZoYNNv80VdxoIX1awi+gmXTzqvebdxKQKd2MNpqZgAL1GFzd0bw1wKTNCpBiCUJVkfrd3R+IfHmiDCRm80qNsNMjaDDETAMhIupAEuI4x7hsyg4Ed70Cym+knFKOwIr17SYq+s7kYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":718,"cache_read_input_tokens":53879,"cache_creation":{"ephemeral_5m_input_tokens":718,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWchLexKKCLoWGiqrM6","type":"assistant","uuid":"50e51bdc-dbb1-446c-988e-d33f03bce421","timestamp":"2026-01-18T08:15:53.151Z"}
{"parentUuid":"50e51bdc-dbb1-446c-988e-d33f03bce421","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LcKjVbNgiueViUqRzBTDa7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Nvsrtos1mWJPUThovgwobv","name":"Bash","input":{"command":"wc -l \"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md\"","description":"Count total lines in file"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":718,"cache_read_input_tokens":53879,"cache_creation":{"ephemeral_5m_input_tokens":718,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWchLexKKCLoWGiqrM6","type":"assistant","uuid":"1451e3bd-e3a6-4a65-a102-e3b706128611","timestamp":"2026-01-18T08:15:54.325Z"}
{"parentUuid":"1451e3bd-e3a6-4a65-a102-e3b706128611","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Nvsrtos1mWJPUThovgwobv","type":"tool_result","content":"661 /home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","is_error":false}]},"uuid":"803fd0d5-37b9-41d8-a140-cf3b943bfc92","timestamp":"2026-01-18T08:15:54.641Z","toolUseResult":{"stdout":"661 /home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"1451e3bd-e3a6-4a65-a102-e3b706128611"}
{"parentUuid":"803fd0d5-37b9-41d8-a140-cf3b943bfc92","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UtT4CJ2ZR2QsfKeVSGoDNx","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"文件有661行。让我读取最后20行看看文件结尾。","signature":"EuYBCkYICxgCKkCt0iWlpNEWHj0eI3w4yijDb5IvckqlBN5u7QUGBs07d9vC6muwKs4b4zh0/py2KxOQOHq+Y0mxD9ju4bTga+YIEgxDJOo3U+Rekr892tMaDLd/fLteSDrXRIrjvCIw57OjEqmfgnkobiMkKlSEaNYKiRTNLtt3x1JNSOQOXwrVOACdkfrfbpZYqhM1gnDVKk6laD6VPz9VA0VFtz6kx6541I7VpAwlVG0LsXqZ65H35geiyCd4q8are0c7PUscC7UrN5ncvmeHQWUpibKA7lzb/e6SEEmnuVD/nl4n2tYYAQ=="}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":217,"cache_read_input_tokens":54597,"cache_creation":{"ephemeral_5m_input_tokens":217,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWdE56ruppusfoD4rcX","type":"assistant","uuid":"dc78a759-ca4c-463b-ab45-62f6f2edb799","timestamp":"2026-01-18T08:16:00.575Z"}
{"parentUuid":"dc78a759-ca4c-463b-ab45-62f6f2edb799","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01UtT4CJ2ZR2QsfKeVSGoDNx","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AcGjNRs27kdbffpPU6Hh4g","name":"Bash","input":{"command":"tail -n 30 \"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md\"","description":"Read last 30 lines of file"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":217,"cache_read_input_tokens":54597,"cache_creation":{"ephemeral_5m_input_tokens":217,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWdE56ruppusfoD4rcX","type":"assistant","uuid":"d5f992fd-6316-4079-9993-d31a8bf6ca82","timestamp":"2026-01-18T08:16:01.722Z"}
{"parentUuid":"d5f992fd-6316-4079-9993-d31a8bf6ca82","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AcGjNRs27kdbffpPU6Hh4g","type":"tool_result","content":"  │ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 检索准确率 │ ≥70%              │ Top-5 结果相关   │                                                                                     \n  └────────────┴───────────────────┴──────────────────┘                                                                                     \n  ---                                                                                                                                       \n  5. CoreAgent 调整                                                                                                                         \n                                                                                                                                            \n  5.1 System Prompt 构建                                                                                                                    \n                                                                                                                                            \n  def build_system_prompt(                                                                                                                  \n      skill_id: str,                                                                                                                        \n      user_context: Optional[Dict] = None                                                                                                   \n  ) -> str:                                                                                                                                 \n      \"\"\"                                                                                                                                   \n      构建 System Prompt。                                                                                                                  \n                                                                                                                                            \n      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           \n      \"\"\"                                                                                                                                   \n      parts = []                                                                                                                            \n                                                                                                                                            \n      # 1. 加载 SKILL.md 全文                                                                                                               \n      skill_md = load_skill_md(skill_id)                                                                                                    \n      parts.append(skill_md)                                                                                                                \n                                                                                                                                            \n      # 2. 注入用户上下文 (如果有)                                                                                                          \n      if user_context:                                                                                                                      \n          ctx_text = format_user_context(user_context)                                                                                      \n          parts.append(f\"\\n---\\n\\n## 用户上","is_error":false}]},"uuid":"0a311252-72d7-48b7-b405-483bc20792ee","timestamp":"2026-01-18T08:16:01.874Z","toolUseResult":{"stdout":"  │ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 检索准确率 │ ≥70%              │ Top-5 结果相关   │                                                                                     \n  └────────────┴───────────────────┴──────────────────┘                                                                                     \n  ---                                                                                                                                       \n  5. CoreAgent 调整                                                                                                                         \n                                                                                                                                            \n  5.1 System Prompt 构建                                                                                                                    \n                                                                                                                                            \n  def build_system_prompt(                                                                                                                  \n      skill_id: str,                                                                                                                        \n      user_context: Optional[Dict] = None                                                                                                   \n  ) -> str:                                                                                                                                 \n      \"\"\"                                                                                                                                   \n      构建 System Prompt。                                                                                                                  \n                                                                                                                                            \n      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           \n      \"\"\"                                                                                                                                   \n      parts = []                                                                                                                            \n                                                                                                                                            \n      # 1. 加载 SKILL.md 全文                                                                                                               \n      skill_md = load_skill_md(skill_id)                                                                                                    \n      parts.append(skill_md)                                                                                                                \n                                                                                                                                            \n      # 2. 注入用户上下文 (如果有)                                                                                                          \n      if user_context:                                                                                                                      \n          ctx_text = format_user_context(user_context)                                                                                      \n          parts.append(f\"\\n---\\n\\n## 用户上","stderr":"","interrupted":false,"isImage":false},"sourceToolAssistantUUID":"d5f992fd-6316-4079-9993-d31a8bf6ca82"}
{"parentUuid":"0a311252-72d7-48b7-b405-483bc20792ee","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vwiir67jx8ze2prnK7NywP","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"看来文件末尾被截断了。不过用户让我只修复格式问题，不改变任何内容。文件末尾可能已经被截断了很久了。\n\n现在我需要分析格式问题：\n\n1. 第1行的标题没有 `#` 标记\n2. 第7、9、22、30、42、43、45等多处标题缺少 `#` 标记\n3. 一些代码块没有用 ``` 包裹\n4. 一些表格使用的是 ASCII art 的方式，但这不是格式问题，只是不同风格\n5. YAML frontmatter 应该在文件开头，但现在标题在第1行\n\n让我识别需要修复的具体格式问题：\n\n1. **标题格式**：缺少 `#` 标记\n   - 第1行：`Agentic Skill System 设计方案 v1.0` → `# Agentic Skill System 设计方案 v1.0`\n   - 第7行：`1. 概述` → `## 1. 概述`\n   - 第9行：`1.1 背景` → `### 1.1 背景`\n   - 第22行：`1.2 目标` → `### 1.2 目标`\n   - 第30行：`1.3 核心原则` → `### 1.3 核心原则`\n   - 第43行：`2. 架构设计` → `## 2. 架构设计`\n   - 第45行：`2.1 整体架构` → `### 2.1 整体架构`\n   - 第87行：`2.2 与传统架构对比` → `### 2.2 与传统架构对比`\n   - 第105行：`2.3 目录结构变化` → `### 2.3 目录结构变化`（并且需要前面加空行）\n   - 第128行：`3. SKILL.md 模板设计` → `## 3. SKILL.md 模板设计`\n   - 第130行：`3.1 结构概览` → `### 3.1 结构概览`\n\n继续检查后续的标题和其他格式问题。\n\n第153行的`3.2 Bazi SKILL.md 完整示例`需要升级为三级标题，第406行的`3.3 Zodiac SKILL.md 完整示例`同样处理。第568行的`4. 知识库设计`应该是二级标题，其下的`4.1 知识库角色转变`和`4.2 知识库结构`分别在第570和575行需要转换为三级标题。\n\n第607行的`4.3 检索接口`、第629行的`4.4 知识库质量要求`都需要加上三级标题符号。第640行的`5. CoreAgent 调整`要升级为二级标题，第642行的`5.1 System Prompt 构建`则为三级标题。\n\n此外，代码块的格式也需要调整——第107-125行的目录结构、第132-137行和155-160行的YAML frontmatter都应该用代码块包裹以提高可读性。\n\n同样地，第408-413行的YAML、第577-590行和593-605行的SQL代码、第609-628行和644-662行的Python代码都需要加上相应的代码块标记。\n\n用户明确说不要改变任何内容，所以我只需要添加Markdown格式标记，保持原有文字完全不变。","signature":"EvEWCkYICxgCKkBvTK4sJZqIxZEojA4bupBIwMfWGoB1eBkBGkmjdkm+B47HRUpwlfqyfRc+qn75hUIJjoUguQdGy932n+FXim8oEgy//wqEQJghmt+zDkAaDA+sWmaOTxuqnQgxtCIwebFC2ZZaXCQHHALkrhk5cTnaUYCMDPCwnOn69zsHzMif1RJtwYknZe8Uh7FEMYYMKtgVOYmtgathv+dXTQW/20LZjEDJQJFznBqdG1T4UzDYFphaxsYuGYtB0dAbVP8TP506Rt1N8P5R92p2k4jx91GrwCxwL901mraJgDuqP8JbhvqRlH33TE6HS95NFZpW0KdgygwvogM2hevtX7EesjMLTXgUGKkZTmY49Sj+yiuPtb9KCKFyJhS17YtvF/IO4WLRxZ7vZwopHcGgvpbdPWx54lyqh0FucsU1+zbjXW3kmhpGrQroTnnXil/RxPWQOwD1J0sqUGeJMQwenn/xZehACF7gyheZby3Jw1gFuC7Ojy2Q0ghc97JOh1n/yeVRxbqGvnPK5JfTQG6J+TbPilMY1QAkQ2Eqwutm/tW0MOS7vmDEYmUqADs4lcUZ5HA3jY7GSL5GU222nHjT2YNhIb3RR/lZ0xfvkVz61ci0FFzubwPxc05zr49hz4pE+/1aVaimuIvZ/fbw9H0JRFHtexGeIWt6fnllLX8mWXC1bfqHcxmMRja4ydFd82L/O53kl4IRwdJFTzNEsB2bUTx9CwHuXEHm9XAG/dBYPJUcjXXxnop3YiWeWcQbW7mUNiG0wu62Bs3RSPn5xXteJM1Y+8ev0vma86q9AGITgkMOzVOandAIRchJnbdWLVBJfKsxSoF9GBAuoLI2Ky7rhWGShJ6WGwe1tDAnl/N0NQvpSFHTGLMQcodA/NohHCM9YC41jfOUNzglf4GIgE5ysb/ov5dByJ87y4o/TGdRcu7I6eAXjz+FLC80jQ36/LgVOM57UYZMLqkLpgcrHhBPKQq3d+hlLdSzHjcRxJKaRPdRKDIXQGfCeOT41f0/Ja92GzcBPh5LUZPwcNUFW/3UGzuXASL60zPIPqC44To6/dkrIYkezrH/Nw7Hy8R1CsDjVyxxtBUuSLtRkFkABKODhxUuwRqyd6pwPnoXRQwZvVtfzfBN/x3JWFxDMbHprxO89RdZKIOwNnupILs/kxkrgP12KfairU1voNOOm4+lZb+2pGTcDklc7FhGOdFYc6DJRhaT4EkVayq7UiP8PoEmJ5oPuqdL8qc9BkO8Qoatz027otIK/6Ck0d1Pz1hml80yf6vQHBQUIK5n/DT/CIcfCTWEAjFwVywkREfR1etLJqlsXy+4HA67flxnOAQzbawku6XC5fZXAQC/F5VHNynimU1Y4YH0/nGpz5WaxiVn+CI+1NTkwlM4dw1VnG6QFiGy6WTSjhogyF2N1Cb3Fwp02fX6D5qZhHdTKt2jpvaaAi3mzEEYM0S3a3eSlZtYDOttJzEzZ6Oagrv/vP1YYDJBXoc88ar0Kg2y9UenQdHs2MbwpUwhHPsfS4EnGrXxT3eyjoFUTWc+unrx+pTyrIg+Qg3HymE4wsEwocbca3wC1AdzUyICedXD1C5duypRLUpdt51Nn8Gmy+f9D6vfMrzLpopc8/bNFuWXfgT8VTxNtBsWpMh22m+r5Yaik2tDKjDvJvOB0JS9K8V6t01aiL4mZHIMiQD3Gpds38o7Ow4VeBM60YvZIROIzWW3CnUPuV+mQuPLE7W5SMjrfb2reEFHsSDmmCqzqH5WSg01bH/LXIWJzUTKfWP7e3d/51cVqddpdea+K3ZWelN6S6yNkBFQmt1DWCB+qeHfjSoQc1lkctsAnVZFWz35CkF1rK3JaY/MJdIiYR4mXAQk8lUvXOZZfGISGMBOmQFIZ7Of1yoOq++fMqqAr/FUpjIsG5xiKQnLGAQoDi84XAaPNJvno1nYioJyt3NNJ2N+PPKHSko0R7asX7VeF0pwLbi9anyAs1wtYUXmRwRFSvqAbDGfJNKh43LLI62MvCZ1WAVfENphLMtvyBkyDlunuzs+T1BrGXR3zZmICchdFkIIoBHf64cqVQ025Y+uXa0SxKkxqa7q4MxI5ibgdmjBY8V93Eg6AO+Zizg56G5ztKwkLNGm8ypzWhoQ4XMf8tq+/clHiqGJIc8sDoZq1NpaXc4mKOPGHw7l1cVzwj7CmBeK8L1mKaHPjlzzGXvxy+46RxblrFuaIK5GfbjO6WgTTRDkjBZuRXU3b74h6YGWN+ZQxGzfD386d0IcfoYpEC7AB2N66/oifa+toUmOc0TK5Dsi16RuEP3WzGSVYTgLpPl57p1ZBdVOxfYwYMFa5FT0US68Qa4Im1FN7MZipkkvDiOmcaDKV+xmruZg2EirbjV0wadNdeQHxm4MLPzGTzkVFhbXe6To1Zdmoku7sYm37DsMwsJ6I8etrB2gCGbuheIsQMKDc8gytVd8pDYUZ+x99NETKpPm6jnpDmIghuijPXTZZ3kIbeSu5SWAjkoNoFgTKxUlhp+pk5V4x/9RA2thFxy3Vz3tO5YczEscQWqZmXdRP1cDtPYxxanuWro0QEgllHu2VhAiYdvrrzUDXUzzwUO/vLm+r32AtjJDd9QP337xkez13KtK0PdL3O1MRgqBlL6GwbK7kXGOHfzVo7iyuGImp+wLEx6K0I0JEwDmZjdV2mZQQdcasAXLzbmvDZFhVcyk0Btw0r3IH1ygb06bv6MP/mbl03vlQT1LXJcJxpRHuoE0LTk+/IkDaYxPtxEa8s6+ip6b83OHg3sOIKsIfM8fQgFmruRNvlohQWkZELYWIqWvS/rsb+ClqgRKmOykTUUMeynTZP91XnjjOBJVGzyDYJyby52Ki/WCID7Ti9lVN2iqh2hOS41X8n/7d8TSfv8RjQ0rz3EAgcSWUx7hrYfK0g4wVzzOVpif4DwuHbOUcu055GRoyCaYA6H9vYLKlXx1zjdyFDUBsg80oHm/DWanl5DluQLU/FXvoubl7164GEsRB6XYCiQp42lFsFVzDQSgyPd/ACjabfU/EDkFVS08EesvNhVmbuAtKm8LxElJfHAbgVFvvKq2ojgXHNhq+dJ5VC3arff0z21XwTk242GTha+/bfj0p0CbiI2st/6jbQ2va3RHoxjcXEAfDyN7NONrZSfiAq1DiGkzretseSe75utjLMMjrZHEfWSx0u+CHEnlMW1XIPyx16yTiACBa9Db+mJ4dv890ZVUxrMHht7S4TjG6iP/nxPOGt02uZfet4XpSYjvk34d/gpfqD8bJNEv1Zrg9q0Bf0FqrSgWQSBU8RwyRJq+EABqUg0gTTpu2FRoHq9a6P07GJ10p5N/prZgGRdP1me9UxIsw6P2PczNzVZSkAhn1PIJAfNWS4ZKCb7vqyq3eCDllrJ1B86WCnECPIG2h/CAilLDCRthCarnOHhemcDWcz3c4+Dt7hHb+tw5Yt/H8SqcadjREmggMHwx+AUnRjFh+kbDUlT997Zu5xGzikPzHBcsp1/qSVDei5bfgNjoMQdCCf8IaLCFmOpK1xqMvVC9sHoNtiMUCs/NyJIUmjhL/Kw0Ep2Ndf3Xt4KHER1bGd/x1lJeOeZx1t3cKSSV4Y5a0FONk6Frp96RroCJe8RnVatO9/7FiuojD1J+9b4VEKdfIIg+9an2L3MO4WhaLg9IbfpJ2DWXayfkURGGq9TyQFUBI2A1JhSba1XTB/E9Zg9p5E+FxofDQYvZrOnDQbJ9LAsFPEn2u0tDOUudq1lkfz4jP2R3CK/UcSLteYKenudThXNcmWTQp1+mHA0BQpM+77+fnG/Fxl0VOwXNMFwJzXyV8Yes2uJjTefrteqIMYRc1JwjW2HPiIW4ZjBK5tZJ3jMBvyI1QuiBZSyMdw42DVGiJmt3MopkuImB1BgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":776,"cache_read_input_tokens":54814,"cache_creation":{"ephemeral_5m_input_tokens":776,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXEWdeyZ1JJhzAcGbUieb","type":"assistant","uuid":"5605dcad-4446-45b4-bc0e-e03ba75d3ee0","timestamp":"2026-01-18T08:16:27.490Z"}
{"parentUuid":"5605dcad-4446-45b4-bc0e-e03ba75d3ee0","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vwiir67jx8ze2prnK7NywP","type":"message","role":"assistant","content":[{"type":"text","text":"我已读取完文件。主要格式问题是：标题缺少 `#` 标记，代码块缺少 ``` 包裹。让我修复这些格式问题。"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":776,"cache_read_input_tokens":54814,"cache_creation":{"ephemeral_5m_input_tokens":776,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXEWdeyZ1JJhzAcGbUieb","type":"assistant","uuid":"dfdb92c4-a596-4175-825f-d8bf6d85a407","timestamp":"2026-01-18T08:16:28.002Z"}
{"parentUuid":"dfdb92c4-a596-4175-825f-d8bf6d85a407","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vwiir67jx8ze2prnK7NywP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Un3BG7q5PVV4qX1QSCJt4v","name":"Write","input":{"file_path":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","content":"# Agentic Skill System 设计方案 v1.0\n\n版本: 1.0 | 日期: 2026-01-18\n状态: 设计稿\n\n---\n\n## 1. 概述\n\n### 1.1 背景\n\n当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：\n- 100+ 预定义 Scenario 文件\n- 触发词匹配路由\n- 固定 SOP 流程执行\n\n问题：\n- 场景数量爆炸，难以维护\n- 触发词冲突，路由不准确\n- LLM 抽取的 SOP 质量参差不齐\n- 缺乏灵活性，无法处理预定义之外的需求\n\n### 1.2 目标\n\n设计 Agentic + 分析框架 的新架构：\n- 删除 100+ Scenario 文件\n- LLM 自主理解用户意图，自主决策服务策略\n- 通过\"分析框架\"确保专业性和完整性\n- 知识库作为 RAG 支撑，按需检索\n\n### 1.3 核心原则\n\n┌──────────────┬──────────────────────────────────────┐\n│     原则     │                 说明                 │\n├──────────────┼──────────────────────────────────────┤\n│ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │\n├──────────────┼──────────────────────────────────────┤\n│ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │\n├──────────────┼──────────────────────────────────────┤\n│ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │\n├──────────────┼──────────────────────────────────────┤\n│ 工具优先     │ 用工具展示结果，而非纯文字           │\n└──────────────┴──────────────────────────────────────┘\n\n---\n\n## 2. 架构设计\n\n### 2.1 整体架构\n\n```\n┌─────────────────────────────────────────────────────────────────────┐\n│                    Agentic Skill System                             │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  ┌─────────────────────────────────────────────────────────────┐   │\n│  │                      SKILL.md (精简版)                       │   │\n│  │                                                              │   │\n│  │  • 专家身份 (Expert Persona)                                 │   │\n│  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │\n│  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │\n│  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │\n│  │  • 伦理边界 (Ethics)                                         │   │\n│  │                                                              │   │\n│  └─────────────────────────────────────────────────────────────┘   │\n│                              │                                      │\n│                              ▼                                      │\n│  ┌─────────────────────────────────────────────────────────────┐   │\n│  │                     CoreAgent (LLM)                          │   │\n│  │                                                              │   │\n│  │  System Prompt = SKILL.md + User Context                     │   │\n│  │                                                              │   │\n│  │  Agentic Loop:                                               │   │\n│  │  1. 理解用户意图                                             │   │\n│  │  2. 匹配核心能力，获取分析框架                               │   │\n│  │  3. 按框架规划分析步骤                                       │   │\n│  │  4. 按需检索知识 (search_db)                                 │   │\n│  │  5. 调用工具展示结果                                         │   │\n│  │  6. 引导后续对话                                             │   │\n│  │                                                              │   │\n│  └─────────────────────────────────────────────────────────────┘   │\n│                              │                                      │\n│              ┌───────────────┼───────────────┐                     │\n│              ▼               ▼               ▼                     │\n│         ┌────────┐     ┌──────────┐    ┌────────┐                 │\n│         │ Tools  │     │Knowledge │    │ Cases  │                 │\n│         │        │     │  (RAG)   │    │        │                 │\n│         └────────┘     └──────────┘    └────────┘                 │\n│                                                                     │\n└─────────────────────────────────────────────────────────────────────┘\n```\n\n### 2.2 与传统架构对比\n\n┌──────────┬──────────────────────────┬────────────────────────────────┐\n│   维度   │    传统 Scenario 架构    │          Agentic 架构          │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │\n└──────────┴──────────────────────────┴────────────────────────────────┘\n\n### 2.3 目录结构变化\n\n```\n# 变更前\nskills/bazi/\n├── SKILL.md                    # 复杂，包含场景目录\n├── scenarios/                  # 100+ 场景文件\n│   ├── basic_reading.md\n│   ├── career.md\n│   ├── relationship.md\n│   └── ... (100+ files)\n└── tools/\n    ├── tools.yaml\n    └── handlers.py\n\n# 变更后\nskills/bazi/\n├── SKILL.md                    # 精简版，包含分析框架\n├── scenarios/                  # 删除或归档\n└── tools/\n    ├── tools.yaml\n    └── handlers.py\n```\n\n---\n\n## 3. SKILL.md 模板设计\n\n### 3.1 结构概览\n\n```yaml\n---\nid: {skill_id}\nname: {skill_name}\nversion: {version}\ndescription: {description}\n---\n```\n\n```markdown\n# {Skill Name}\n\n## 专家身份\n\n## 核心能力与分析框架\n\n## 工具列表与调用指南\n\n## 知识检索指南\n\n## 服务原则\n\n## 伦理边界\n```\n\n### 3.2 Bazi SKILL.md 完整示例\n\n```yaml\n---\nid: bazi\nname: 八字命理\nversion: 3.0.0\ndescription: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师\n---\n```\n\n# 八字命理 Skill\n\n## 专家身份\n\n我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。\n\n**核心理念**：\n- 以用神为纲、调候为急、格局为本、十神生克为用\n- 不故弄玄虚，用现代语言解读古老智慧\n- 命理是趋势分析，不是宿命论\n\n**知识来源优先级**：\n1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）\n2. 知识库检索结果\n3. 实战验证案例\n4. 通用命理知识\n\n---\n\n## 核心能力与分析框架\n\n### 能力 1: 命盘解读\n\n**适用场景**: 用户想了解自己的命盘、第一次算命、基础分析\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |\n| 2 | 格局识别 | \"{日主} {月令} 格局\" |\n| 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |\n| 4 | 关键十神状态 | 根据命盘特点检索 |\n\n**输出要求**:\n- 必须调用 `show_bazi_chart` 展示命盘\n- 必须调用 `show_insight` 展示核心洞察（不超过 4 点）\n- 引导用户深入探索\n\n---\n\n### 能力 2: 事业分析\n\n**适用场景**: 事业发展、职业方向、跳槽时机、升职\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 官杀状态 | \"官杀分析 事业\" |\n| 2 | 财星状态 | \"财星分析 收入\" |\n| 3 | 印星状态 | \"印星分析 贵人 学习\" |\n| 4 | 食伤状态 | \"食伤分析 才华 创业\" |\n| 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |\n| 6 | 时机建议 | 综合以上给出建议 |\n\n**输出要求**:\n- 调用 `show_bazi_chart` 展示命盘\n- 调用 `show_bazi_fortune` 展示大运流年\n- 调用 `show_insight` 展示事业洞察\n- 给出具体可操作的建议\n\n---\n\n### 能力 3: 感情婚姻\n\n**适用场景**: 感情运势、婚姻状况、桃花、配偶特征\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |\n| 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |\n| 3 | 桃花状态 | \"桃花 感情\" |\n| 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |\n| 5 | 婚姻建议 | 综合以上给出建议 |\n\n**性别差异**:\n- 男命: 正财为妻星，偏财为情人\n- 女命: 正官为夫星，七杀为情人\n\n---\n\n### 能力 4: 财运分析\n\n**适用场景**: 财运走势、投资方向、求财时机\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 财星状态 | \"正财 偏财 财运\" |\n| 2 | 财星与日主关系 | \"身强/身弱 财运\" |\n| 3 | 食伤生财 | \"食伤生财 求财方式\" |\n| 4 | 大运流年财运 | \"{大运} {流年} 财运\" |\n| 5 | 求财建议 | 综合以上给出建议 |\n\n---\n\n### 能力 5: 运势预测\n\n**适用场景**: 大运分析、流年运势、特定年份预测\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 大运主题 | \"{大运干支} 大运 主题\" |\n| 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |\n| 3 | 大运流年交互 | \"大运流年 交互 影响\" |\n| 4 | 关键月份 | 根据流年地支判断 |\n| 5 | 趋吉避凶建议 | 综合以上给出建议 |\n\n**输出要求**:\n- 必须调用 `show_bazi_fortune` 展示大运流年\n- 可选调用 `show_bazi_kline` 展示运势趋势图\n\n---\n\n### 能力 6: 合婚配对\n\n**适用场景**: 双方八字合婚、配对分析\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 日主配合 | \"合婚 日主 配合\" |\n| 2 | 用神互补 | \"合婚 用神 互补\" |\n| 3 | 年柱纳音 | \"合婚 纳音 年柱\" |\n| 4 | 冲合关系 | \"合婚 冲合 地支\" |\n| 5 | 综合评分 | 综合以上给出评分和建议 |\n\n**前置要求**: 必须收集双方出生信息\n\n---\n\n## 工具列表与调用指南\n\n### 信息收集工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |\n| `request_info` | 请求补充信息 | 需要更多信息时 |\n\n### 计算工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |\n\n### 展示工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |\n| `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |\n| `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |\n| `show_insight` | 展示洞察卡片 | 总结分析结果时 |\n| `show_report` | 展示完整报告 | 深度分析完成时 |\n\n### 检索工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `search_db` | 检索知识/案例 | 需要专业知识支撑时 |\n\n### 调用原则\n\n1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集\n2. **检索支撑**: 分析前先 `search_db` 获取相关知识\n3. **工具展示**: 用工具呈现结果，比纯文字更直观\n4. **框架完整**: 按分析框架覆盖所有要点\n\n---\n\n## 知识检索指南\n\n### 检索策略\n\n1. 理论知识: query = \"{概念} 理论 原理\"\n2. 分析方法: query = \"{主题} 分析方法 步骤\"\n3. 规则依据: query = \"{主题} 规则 原则\"\n4. 参考案例: query = \"{特征} 案例\"\n5. 经典引用: query = \"{书名} {主题}\"\n\n### 检索示例\n\n| 需要什么 | query 示例 |\n|---------|-----------|\n| 日主强弱理论 | \"日主强弱 判断方法\" |\n| 格局判断方法 | \"格局 判断 正格 变格\" |\n| 用神取用规则 | \"用神 取用 扶抑 调候\" |\n| 十神生克规则 | \"十神 生克 关系\" |\n| 事业分析案例 | \"官杀 事业 案例\" |\n| 经典引用 | \"滴天髓 用神\" |\n\n### 检索原则\n\n1. **不确定时先检索**: 专业问题先查知识库\n2. **query 要具体**: 描述清楚需要什么\n3. **多次检索**: 复杂问题可分多次检索\n4. **结果作为依据**: 检索结果用于支撑分析\n\n---\n\n## 服务原则\n\n### 1. 框架完整\n按分析框架覆盖关键要点，不遗漏重要分析。\n\n### 2. 知识支撑\n重要结论必须有知识库检索结果支撑，不凭空编造。\n\n### 3. 工具优先\n用工具展示结果（命盘图、洞察卡片），而非纯文字描述。\n\n### 4. 引导深入\n分析后引导用户探索更多方面，提供后续选项。\n\n### 5. 语言亲和\n用现代语言解读，避免过多术语，必要时解释专业概念。\n\n---\n\n## 伦理边界\n\n### 绝对禁止\n- 预测具体事件发生的确切日期\n- 给出\"命中注定\"的定论\n- 涉及健康诊断的具体预测\n- 替用户做重大人生决定\n- 预测死亡、重大灾难\n\n### 表达原则\n- 命理是趋势分析，不是宿命论\n- 困难时期是成长机会，不是灾难预言\n- 人的主观能动性可以改变命运轨迹\n- 提供建议而非决定\n\n### 敏感话题处理\n\n| 话题 | 处理方式 |\n|-----|---------|\n| 健康 | 只分析五行倾向，建议咨询医生 |\n| 寿命 | 不预测，转向生活质量建议 |\n| 灾难 | 转化为\"需要注意的时期\" |\n| 离婚 | 分析挑战，提供改善建议 |\n\n### 3.3 Zodiac SKILL.md 完整示例\n\n```yaml\n---\nid: zodiac\nname: 西方占星\nversion: 3.0.0\ndescription: 融合现代心理占星与传统占星的专业占星师\n---\n```\n\n# 西方占星 Skill\n\n## 专家身份\n\n我是融合现代心理占星与传统占星的专业占星师。\n\n**核心理念**：\n- 星盘是潜能地图，不是命运判决书\n- 行星能量可以有多种表达方式\n- 占星是自我认知的工具\n\n**知识来源优先级**：\n1. 知识库检索结果\n2. 心理占星理论\n3. 传统占星规则\n4. 通用占星知识\n\n---\n\n## 核心能力与分析框架\n\n### 能力 1: 本命盘解读\n\n**适用场景**: 了解自己的星盘、性格分析、人生主题\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |\n| 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |\n| 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |\n| 4 | 主要相位 | \"{相位类型} 相位 含义\" |\n| 5 | 宫位分布 | 根据星盘特点检索 |\n\n**输出要求**:\n- 必须调用 `show_zodiac_chart` 展示星盘\n- 必须调用 `show_insight` 展示核心洞察\n\n---\n\n### 能力 2: 行运分析\n\n**适用场景**: 当前运势、行星过境影响、时机选择\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |\n| 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |\n| 3 | 影响领域 | 根据宫位判断 |\n| 4 | 时间周期 | 根据行星速度判断 |\n| 5 | 应对建议 | 综合以上给出建议 |\n\n**输出要求**:\n- 调用 `show_zodiac_transit` 展示行运\n- 调用 `show_insight` 展示行运洞察\n\n---\n\n### 能力 3: 合盘分析\n\n**适用场景**: 感情配对、关系分析、合作关系\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |\n| 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |\n| 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |\n| 4 | 宫位重叠 | \"合盘 宫位 重叠\" |\n| 5 | 综合评估 | 综合以上给出评估 |\n\n**输出要求**:\n- 调用 `show_zodiac_synastry` 展示合盘\n- 调用 `show_insight` 展示关系洞察\n\n---\n\n### 能力 4: 流年预测\n\n**适用场景**: 年度运势、太阳回归、重要时间点\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |\n| 2 | 外行星行运 | \"{行星} 行运 {年份}\" |\n| 3 | 日月食影响 | \"日月食 {星座} 影响\" |\n| 4 | 关键时间点 | 根据行运判断 |\n| 5 | 年度建议 | 综合以上给出建议 |\n\n---\n\n## 工具列表与调用指南\n\n### 信息收集工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |\n\n### 展示工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |\n| `show_zodiac_transit` | 展示行运 | 用户问运势时 |\n| `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |\n| `show_insight` | 展示洞察 | 总结分析时 |\n\n### 检索工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `search_db` | 检索知识 | 需要专业知识时 |\n\n---\n\n## 知识检索指南\n\n| 需要什么 | query 示例 |\n|---------|-----------|\n| 星座特质 | \"{星座} 特质 性格\" |\n| 行星含义 | \"{行星} 含义 能量\" |\n| 相位解读 | \"{相位} 解读 影响\" |\n| 宫位意义 | \"第{N}宫 意义 领域\" |\n| 行运影响 | \"{行星} 过境 {宫位}\" |\n\n---\n\n## 服务原则\n\n1. **框架完整**: 按分析框架覆盖关键要点\n2. **知识支撑**: 重要结论有检索结果支撑\n3. **工具优先**: 用工具展示星盘和洞察\n4. **心理导向**: 强调自我认知和成长\n\n---\n\n## 伦理边界\n\n### 绝对禁止\n- 预测具体事件日期\n- 给出宿命论断言\n- 健康诊断预测\n- 替用户做决定\n\n### 表达原则\n- 星盘是潜能地图，不是命运判决\n- 行星能量有多种表达方式\n- 强调自由意志和选择\n\n---\n\n## 4. 知识库设计\n\n### 4.1 知识库角色转变\n\n传统角色: Scenario 指定检索 → 固定知识\n新角色: LLM 按需检索 → 动态知识支撑\n\n### 4.2 知识库结构\n\n```sql\n-- knowledge_chunks 表 (保持不变)\nCREATE TABLE knowledge_chunks (\n    id              UUID PRIMARY KEY,\n    skill_id        VARCHAR(50) NOT NULL,\n    document_id     UUID REFERENCES knowledge_documents(id),\n    chunk_index     INT NOT NULL,\n    content         TEXT NOT NULL,\n    section_path    TEXT,\n    section_title   VARCHAR(255),\n    embedding       VECTOR(1024),\n    search_text_preprocessed TEXT,\n    metadata        JSONB,\n    created_at      TIMESTAMP DEFAULT NOW()\n);\n\n-- cases 表 (保持不变)\nCREATE TABLE cases (\n    id              VARCHAR(50) PRIMARY KEY,\n    skill_id        VARCHAR(50) NOT NULL,\n    scenario_ids    VARCHAR[],  -- 可选，用于分类\n    name            VARCHAR(255) NOT NULL,\n    core_data       JSONB NOT NULL,\n    features        JSONB NOT NULL,\n    tags            VARCHAR[] NOT NULL,\n    analysis        JSONB NOT NULL,\n    conclusion      JSONB NOT NULL,\n    authority       VARCHAR(20) DEFAULT 'medium',\n    created_at      TIMESTAMP DEFAULT NOW()\n);\n```\n\n### 4.3 检索接口\n\n```python\n# search_db 工具实现\nasync def search_db(\n    table: str,           # \"knowledge_chunks\" 或 \"cases\"\n    query: str,           # LLM 描述的检索需求\n    skill_id: str,        # 限定 skill\n    top_k: int = 5,       # 返回数量\n    filters: dict = None  # 可选过滤条件\n) -> List[Dict]:\n    \"\"\"\n    语义检索知识或案例。\n\n    LLM 通过 query 描述需求，向量检索返回相关内容。\n    \"\"\"\n    embedding = await embed(query)\n\n    if table == \"knowledge_chunks\":\n        return await search_knowledge(skill_id, query, embedding, top_k)\n    elif table == \"cases\":\n        return await search_cases(skill_id, query, embedding, top_k, filters)\n```\n\n### 4.4 知识库质量要求\n\n┌────────────┬───────────────────┬──────────────────┐\n│    指标    │       目标        │       说明       │\n├────────────┼───────────────────┼──────────────────┤\n│ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │\n├────────────┼───────────────────┼──────────────────┤\n│ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │\n├────────────┼───────────────────┼──────────────────┤\n│ 检索准确率 │ ≥70%              │ Top-5 结果相关   │\n└────────────┴───────────────────┴──────────────────┘\n\n---\n\n## 5. CoreAgent 调整\n\n### 5.1 System Prompt 构建\n\n```python\ndef build_system_prompt(\n    skill_id: str,\n    user_context: Optional[Dict] = None\n) -> str:\n    \"\"\"\n    构建 System Prompt。\n\n    变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。\n    \"\"\"\n    parts = []\n\n    # 1. 加载 SKILL.md 全文\n    skill_md = load_skill_md(skill_id)\n    parts.append(skill_md)\n\n    # 2. 注入用户上下文 (如果有)\n    if user_context:\n        ctx_text = format_user_context(user_context)\n        parts.append(f\"\\n---\\n\\n## 用户上下文\\n\\n{ctx_text}\")\n\n    return \"\\n\".join(parts)\n```\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":776,"cache_read_input_tokens":54814,"cache_creation":{"ephemeral_5m_input_tokens":776,"ephemeral_1h_input_tokens":0},"output_tokens":5,"service_tier":"standard"}},"requestId":"req_011CXEWdeyZ1JJhzAcGbUieb","type":"assistant","uuid":"33db8ecf-752b-4806-999c-5b570f32634d","timestamp":"2026-01-18T08:19:16.638Z"}
{"type":"file-history-snapshot","messageId":"33db8ecf-752b-4806-999c-5b570f32634d","snapshot":{"messageId":"46f9599e-c1ec-4e4c-b3b9-443153685e7e","trackedFileBackups":{"docs/components/skill/Agentic Skill System 设计方案 v1.md":{"backupFileName":"67c0472dd31fdb63@v1","version":1,"backupTime":"2026-01-18T08:19:17.066Z"}},"timestamp":"2026-01-18T08:15:25.082Z"},"isSnapshotUpdate":true}
{"parentUuid":"33db8ecf-752b-4806-999c-5b570f32634d","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Un3BG7q5PVV4qX1QSCJt4v","type":"tool_result","content":"The file /home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:\n     1→# Agentic Skill System 设计方案 v1.0\n     2→\n     3→版本: 1.0 | 日期: 2026-01-18\n     4→状态: 设计稿\n     5→\n     6→---\n     7→\n     8→## 1. 概述\n     9→\n    10→### 1.1 背景\n    11→\n    12→当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：\n    13→- 100+ 预定义 Scenario 文件\n    14→- 触发词匹配路由\n    15→- 固定 SOP 流程执行\n    16→\n    17→问题：\n    18→- 场景数量爆炸，难以维护\n    19→- 触发词冲突，路由不准确\n    20→- LLM 抽取的 SOP 质量参差不齐\n    21→- 缺乏灵活性，无法处理预定义之外的需求\n    22→\n    23→### 1.2 目标\n    24→\n    25→设计 Agentic + 分析框架 的新架构：\n    26→- 删除 100+ Scenario 文件\n    27→- LLM 自主理解用户意图，自主决策服务策略\n    28→- 通过\"分析框架\"确保专业性和完整性\n    29→- 知识库作为 RAG 支撑，按需检索\n    30→\n    31→### 1.3 核心原则\n    32→\n    33→┌──────────────┬──────────────────────────────────────┐\n    34→│     原则     │                 说明                 │\n    35→├──────────────┼──────────────────────────────────────┤\n    36→│ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │\n    37→├──────────────┼──────────────────────────────────────┤\n    38→│ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │\n    39→├──────────────┼──────────────────────────────────────┤\n    40→│ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │\n    41→├──────────────┼──────────────────────────────────────┤\n    42→│ 工具优先     │ 用工具展示结果，而非纯文字           │\n    43→└──────────────┴──────────────────────────────────────┘\n    44→\n    45→---\n    46→\n    47→## 2. 架构设计\n    48→\n    49→### 2.1 整体架构\n    50→\n    51→```\n    52→┌─────────────────────────────────────────────────────────────────────┐\n    53→│                    Agentic Skill System                             │\n    54→├─────────────────────────────────────────────────────────────────────┤\n    55→│                                                                     │\n    56→│  ┌─────────────────────────────────────────────────────────────┐   │\n    57→│  │                      SKILL.md (精简版)                       │   │\n    58→│  │                                                              │   │\n    59→│  │  • 专家身份 (Expert Persona)                                 │   │\n    60→│  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │\n    61→│  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │\n    62→│  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │\n    63→│  │  • 伦理边界 (Ethics)                                         │   │\n    64→│  │                                                              │   │\n    65→│  └─────────────────────────────────────────────────────────────┘   │\n    66→│                              │                                      │\n    67→│                              ▼                                      │\n    68→│  ┌─────────────────────────────────────────────────────────────┐   │\n    69→│  │                     CoreAgent (LLM)                          │   │\n    70→│  │                                                              │   │\n    71→│  │  System Prompt = SKILL.md + User Context                     │   │\n    72→│  │                                                              │   │\n    73→│  │  Agentic Loop:                                               │   │\n    74→│  │  1. 理解用户意图                                             │   │\n    75→│  │  2. 匹配核心能力，获取分析框架                               │   │\n    76→│  │  3. 按框架规划分析步骤                                       │   │\n    77→│  │  4. 按需检索知识 (search_db)                                 │   │\n    78→│  │  5. 调用工具展示结果                                         │   │\n    79→│  │  6. 引导后续对话                                             │   │\n    80→│  │                                                              │   │\n    81→│  └─────────────────────────────────────────────────────────────┘   │\n    82→│                              │                                      │\n    83→│              ┌───────────────┼───────────────┐                     │\n    84→│              ▼               ▼               ▼                     │\n    85→│         ┌────────┐     ┌──────────┐    ┌────────┐                 │\n    86→│         │ Tools  │     │Knowledge │    │ Cases  │                 │\n    87→│         │        │     │  (RAG)   │    │        │                 │\n    88→│         └────────┘     └──────────┘    └────────┘                 │\n    89→│                                                                     │\n    90→└─────────────────────────────────────────────────────────────────────┘\n    91→```\n    92→\n    93→### 2.2 与传统架构对比\n    94→\n    95→┌──────────┬──────────────────────────┬────────────────────────────────┐\n    96→│   维度   │    传统 Scenario 架构    │          Agentic 架构          │\n    97→├──────────┼──────────────────────────┼────────────────────────────────┤\n    98→│ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │\n    99→├──────────┼──────────────────────────┼────────────────────────────────┤\n   100→│ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │\n   101→├──────────┼──────────────────────────┼────────────────────────────────┤\n   102→│ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │\n   103→├──────────┼──────────────────────────┼────────────────────────────────┤\n   104→│ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │\n   105→├──────────┼──────────────────────────┼────────────────────────────────┤\n   106→│ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │\n   107→├──────────┼──────────────────────────┼────────────────────────────────┤\n   108→│ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │\n   109→├──────────┼──────────────────────────┼────────────────────────────────┤\n   110→│ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │\n   111→└──────────┴──────────────────────────┴────────────────────────────────┘\n   112→\n   113→### 2.3 目录结构变化\n   114→\n   115→```\n   116→# 变更前\n   117→skills/bazi/\n   118→├── SKILL.md                    # 复杂，包含场景目录\n   119→├── scenarios/                  # 100+ 场景文件\n   120→│   ├── basic_reading.md\n   121→│   ├── career.md\n   122→│   ├── relationship.md\n   123→│   └── ... (100+ files)\n   124→└── tools/\n   125→    ├── tools.yaml\n   126→    └── handlers.py\n   127→\n   128→# 变更后\n   129→skills/bazi/\n   130→├── SKILL.md                    # 精简版，包含分析框架\n   131→├── scenarios/                  # 删除或归档\n   132→└── tools/\n   133→    ├── tools.yaml\n   134→    └── handlers.py\n   135→```\n   136→\n   137→---\n   138→\n   139→## 3. SKILL.md 模板设计\n   140→\n   141→### 3.1 结构概览\n   142→\n   143→```yaml\n   144→---\n   145→id: {skill_id}\n   146→name: {skill_name}\n   147→version: {version}\n   148→description: {description}\n   149→---\n   150→```\n   151→\n   152→```markdown\n   153→# {Skill Name}\n   154→\n   155→## 专家身份\n   156→\n   157→## 核心能力与分析框架\n   158→\n   159→## 工具列表与调用指南\n   160→\n   161→## 知识检索指南\n   162→\n   163→## 服务原则\n   164→\n   165→## 伦理边界\n   166→```\n   167→\n   168→### 3.2 Bazi SKILL.md 完整示例\n   169→\n   170→```yaml\n   171→---\n   172→id: bazi\n   173→name: 八字命理\n   174→version: 3.0.0\n   175→description: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师\n   176→---\n   177→```\n   178→\n   179→# 八字命理 Skill\n   180→\n   181→## 专家身份\n   182→\n   183→我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。\n   184→\n   185→**核心理念**：\n   186→- 以用神为纲、调候为急、格局为本、十神生克为用\n   187→- 不故弄玄虚，用现代语言解读古老智慧\n   188→- 命理是趋势分析，不是宿命论\n   189→\n   190→**知识来源优先级**：\n   191→1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）\n   192→2. 知识库检索结果\n   193→3. 实战验证案例\n   194→4. 通用命理知识\n   195→\n   196→---\n   197→\n   198→## 核心能力与分析框架\n   199→\n   200→### 能力 1: 命盘解读\n   201→\n   202→**适用场景**: 用户想了解自己的命盘、第一次算命、基础分析\n   203→\n   204→**分析框架** (必须覆盖):\n   205→| 步骤 | 分析要点 | 知识检索 query |\n   206→|-----|---------|---------------|\n   207→| 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |\n   208→| 2 | 格局识别 | \"{日主} {月令} 格局\" |\n   209→| 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |\n   210→| 4 | 关键十神状态 | 根据命盘特点检索 |\n   211→\n   212→**输出要求**:\n   213→- 必须调用 `show_bazi_chart` 展示命盘\n   214→- 必须调用 `show_insight` 展示核心洞察（不超过 4 点）\n   215→- 引导用户深入探索\n   216→\n   217→---\n   218→\n   219→### 能力 2: 事业分析\n   220→\n   221→**适用场景**: 事业发展、职业方向、跳槽时机、升职\n   222→\n   223→**分析框架** (必须覆盖):\n   224→| 步骤 | 分析要点 | 知识检索 query |\n   225→|-----|---------|---------------|\n   226→| 1 | 官杀状态 | \"官杀分析 事业\" |\n   227→| 2 | 财星状态 | \"财星分析 收入\" |\n   228→| 3 | 印星状态 | \"印星分析 贵人 学习\" |\n   229→| 4 | 食伤状态 | \"食伤分析 才华 创业\" |\n   230→| 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |\n   231→| 6 | 时机建议 | 综合以上给出建议 |\n   232→\n   233→**输出要求**:\n   234→- 调用 `show_bazi_chart` 展示命盘\n   235→- 调用 `show_bazi_fortune` 展示大运流年\n   236→- 调用 `show_insight` 展示事业洞察\n   237→- 给出具体可操作的建议\n   238→\n   239→---\n   240→\n   241→### 能力 3: 感情婚姻\n   242→\n   243→**适用场景**: 感情运势、婚姻状况、桃花、配偶特征\n   244→\n   245→**分析框架** (必须覆盖):\n   246→| 步骤 | 分析要点 | 知识检索 query |\n   247→|-----|---------|---------------|\n   248→| 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |\n   249→| 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |\n   250→| 3 | 桃花状态 | \"桃花 感情\" |\n   251→| 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |\n   252→| 5 | 婚姻建议 | 综合以上给出建议 |\n   253→\n   254→**性别差异**:\n   255→- 男命: 正财为妻星，偏财为情人\n   256→- 女命: 正官为夫星，七杀为情人\n   257→\n   258→---\n   259→\n   260→### 能力 4: 财运分析\n   261→\n   262→**适用场景**: 财运走势、投资方向、求财时机\n   263→\n   264→**分析框架** (必须覆盖):\n   265→| 步骤 | 分析要点 | 知识检索 query |\n   266→|-----|---------|---------------|\n   267→| 1 | 财星状态 | \"正财 偏财 财运\" |\n   268→| 2 | 财星与日主关系 | \"身强/身弱 财运\" |\n   269→| 3 | 食伤生财 | \"食伤生财 求财方式\" |\n   270→| 4 | 大运流年财运 | \"{大运} {流年} 财运\" |\n   271→| 5 | 求财建议 | 综合以上给出建议 |\n   272→\n   273→---\n   274→\n   275→### 能力 5: 运势预测\n   276→\n   277→**适用场景**: 大运分析、流年运势、特定年份预测\n   278→\n   279→**分析框架** (必须覆盖):\n   280→| 步骤 | 分析要点 | 知识检索 query |\n   281→|-----|---------|---------------|\n   282→| 1 | 大运主题 | \"{大运干支} 大运 主题\" |\n   283→| 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |\n   284→| 3 | 大运流年交互 | \"大运流年 交互 影响\" |\n   285→| 4 | 关键月份 | 根据流年地支判断 |\n   286→| 5 | 趋吉避凶建议 | 综合以上给出建议 |\n   287→\n   288→**输出要求**:\n   289→- 必须调用 `show_bazi_fortune` 展示大运流年\n   290→- 可选调用 `show_bazi_kline` 展示运势趋势图\n   291→\n   292→---\n   293→\n   294→### 能力 6: 合婚配对\n   295→\n   296→**适用场景**: 双方八字合婚、配对分析\n   297→\n   298→**分析框架** (必须覆盖):\n   299→| 步骤 | 分析要点 | 知识检索 query |\n   300→|-----|---------|---------------|\n   301→| 1 | 日主配合 | \"合婚 日主 配合\" |\n   302→| 2 | 用神互补 | \"合婚 用神 互补\" |\n   303→| 3 | 年柱纳音 | \"合婚 纳音 年柱\" |\n   304→| 4 | 冲合关系 | \"合婚 冲合 地支\" |\n   305→| 5 | 综合评分 | 综合以上给出评分和建议 |\n   306→\n   307→**前置要求**: 必须收集双方出生信息\n   308→\n   309→---\n   310→\n   311→## 工具列表与调用指南\n   312→\n   313→### 信息收集工具\n   314→\n   315→| 工具 | 用途 | 何时调用 |\n   316→|-----|------|---------|\n   317→| `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |\n   318→| `request_info` | 请求补充信息 | 需要更多信息时 |\n   319→\n   320→### 计算工具\n   321→\n   322→| 工具 | 用途 | 何时调用 |\n   323→|-----|------|---------|\n   324→| `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |\n   325→\n   326→### 展示工具\n   327→\n   328→| 工具 | 用途 | 何时调用 |\n   329→|-----|------|---------|\n   330→| `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |\n   331→| `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |\n   332→| `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |\n   333→| `show_insight` | 展示洞察卡片 | 总结分析结果时 |\n   334→| `show_report` | 展示完整报告 | 深度分析完成时 |\n   335→\n   336→### 检索工具\n   337→\n   338→| 工具 | 用途 | 何时调用 |\n   339→|-----|------|---------|\n   340→| `search_db` | 检索知识/案例 | 需要专业知识支撑时 |\n   341→\n   342→### 调用原则\n   343→\n   344→1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集\n   345→2. **检索支撑**: 分析前先 `search_db` 获取相关知识\n   346→3. **工具展示**: 用工具呈现结果，比纯文字更直观\n   347→4. **框架完整**: 按分析框架覆盖所有要点\n   348→\n   349→---\n   350→\n   351→## 知识检索指南\n   352→\n   353→### 检索策略\n   354→\n   355→1. 理论知识: query = \"{概念} 理论 原理\"\n   356→2. 分析方法: query = \"{主题} 分析方法 步骤\"\n   357→3. 规则依据: query = \"{主题} 规则 原则\"\n   358→4. 参考案例: query = \"{特征} 案例\"\n   359→5. 经典引用: query = \"{书名} {主题}\"\n   360→\n   361→### 检索示例\n   362→\n   363→| 需要什么 | query 示例 |\n   364→|---------|-----------|\n   365→| 日主强弱理论 | \"日主强弱 判断方法\" |\n   366→| 格局判断方法 | \"格局 判断 正格 变格\" |\n   367→| 用神取用规则 | \"用神 取用 扶抑 调候\" |\n   368→| 十神生克规则 | \"十神 生克 关系\" |\n   369→| 事业分析案例 | \"官杀 事业 案例\" |\n   370→| 经典引用 | \"滴天髓 用神\" |\n   371→\n   372→### 检索原则\n   373→\n   374→1. **不确定时先检索**: 专业问题先查知识库\n   375→2. **query 要具体**: 描述清楚需要什么\n   376→3. **多次检索**: 复杂问题可分多次检索\n   377→4. **结果作为依据**: 检索结果用于支撑分析\n   378→\n   379→---\n   380→\n   381→## 服务原则\n   382→\n   383→### 1. 框架完整\n   384→按分析框架覆盖关键要点，不遗漏重要分析。\n   385→\n   386→### 2. 知识支撑\n   387→重要结论必须有知识库检索结果支撑，不凭空编造。\n   388→\n   389→### 3. 工具优先\n   390→用工具展示结果（命盘图、洞察卡片），而非纯文字描述。\n   391→\n   392→### 4. 引导深入\n   393→分析后引导用户探索更多方面，提供后续选项。\n   394→\n   395→### 5. 语言亲和\n   396→用现代语言解读，避免过多术语，必要时解释专业概念。\n   397→\n   398→---\n   399→\n   400→## 伦理边界\n   401→\n   402→### 绝对禁止\n   403→- 预测具体事件发生的确切日期\n   404→- 给出\"命中注定\"的定论\n   405→- 涉及健康诊断的具体预测\n   406→- 替用户做重大人生决定\n   407→- 预测死亡、重大灾难\n   408→\n   409→### 表达原则\n   410→- 命理是趋势分析，不是宿命论\n   411→- 困难时期是成长机会，不是灾难预言\n   412→- 人的主观能动性可以改变命运轨迹\n   413→- 提供建议而非决定\n   414→\n   415→### 敏感话题处理\n   416→\n   417→| 话题 | 处理方式 |\n   418→|-----|---------|\n   419→| 健康 | 只分析五行倾向，建议咨询医生 |\n   420→| 寿命 | 不预测，转向生活质量建议 |\n   421→| 灾难 | 转化为\"需要注意的时期\" |\n   422→| 离婚 | 分析挑战，提供改善建议 |\n   423→\n   424→### 3.3 Zodiac SKILL.md 完整示例\n   425→\n   426→```yaml\n   427→---\n   428→id: zodiac\n   429→name: 西方占星\n   430→version: 3.0.0\n   431→description: 融合现代心理占星与传统占星的专业占星师\n   432→---\n   433→```\n   434→\n   435→# 西方占星 Skill\n   436→\n   437→## 专家身份\n   438→\n   439→我是融合现代心理占星与传统占星的专业占星师。\n   440→\n   441→**核心理念**：\n   442→- 星盘是潜能地图，不是命运判决书\n   443→- 行星能量可以有多种表达方式\n   444→- 占星是自我认知的工具\n   445→\n   446→**知识来源优先级**：\n   447→1. 知识库检索结果\n   448→2. 心理占星理论\n   449→3. 传统占星规则\n   450→4. 通用占星知识\n   451→\n   452→---\n   453→\n   454→## 核心能力与分析框架\n   455→\n   456→### 能力 1: 本命盘解读\n   457→\n   458→**适用场景**: 了解自己的星盘、性格分析、人生主题\n   459→\n   460→**分析框架** (必须覆盖):\n   461→| 步骤 | 分析要点 | 知识检索 query |\n   462→|-----|---------|---------------|\n   463→| 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |\n   464→| 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |\n   465→| 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |\n   466→| 4 | 主要相位 | \"{相位类型} 相位 含义\" |\n   467→| 5 | 宫位分布 | 根据星盘特点检索 |\n   468→\n   469→**输出要求**:\n   470→- 必须调用 `show_zodiac_chart` 展示星盘\n   471→- 必须调用 `show_insight` 展示核心洞察\n   472→\n   473→---\n   474→\n   475→### 能力 2: 行运分析\n   476→\n   477→**适用场景**: 当前运势、行星过境影响、时机选择\n   478→\n   479→**分析框架** (必须覆盖):\n   480→| 步骤 | 分析要点 | 知识检索 query |\n   481→|-----|---------|---------------|\n   482→| 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |\n   483→| 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |\n   484→| 3 | 影响领域 | 根据宫位判断 |\n   485→| 4 | 时间周期 | 根据行星速度判断 |\n   486→| 5 | 应对建议 | 综合以上给出建议 |\n   487→\n   488→**输出要求**:\n   489→- 调用 `show_zodiac_transit` 展示行运\n   490→- 调用 `show_insight` 展示行运洞察\n   491→\n   492→---\n   493→\n   494→### 能力 3: 合盘分析\n   495→\n   496→**适用场景**: 感情配对、关系分析、合作关系\n   497→\n   498→**分析框架** (必须覆盖):\n   499→| 步骤 | 分析要点 | 知识检索 query |\n   500→|-----|---------|---------------|\n   501→| 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |\n   502→| 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |\n   503→| 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |\n   504→| 4 | 宫位重叠 | \"合盘 宫位 重叠\" |\n   505→| 5 | 综合评估 | 综合以上给出评估 |\n   506→\n   507→**输出要求**:\n   508→- 调用 `show_zodiac_synastry` 展示合盘\n   509→- 调用 `show_insight` 展示关系洞察\n   510→\n   511→---\n   512→\n   513→### 能力 4: 流年预测\n   514→\n   515→**适用场景**: 年度运势、太阳回归、重要时间点\n   516→\n   517→**分析框架** (必须覆盖):\n   518→| 步骤 | 分析要点 | 知识检索 query |\n   519→|-----|---------|---------------|\n   520→| 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |\n   521→| 2 | 外行星行运 | \"{行星} 行运 {年份}\" |\n   522→| 3 | 日月食影响 | \"日月食 {星座} 影响\" |\n   523→| 4 | 关键时间点 | 根据行运判断 |\n   524→| 5 | 年度建议 | 综合以上给出建议 |\n   525→\n   526→---\n   527→\n   528→## 工具列表与调用指南\n   529→\n   530→### 信息收集工具\n   531→\n   532→| 工具 | 用途 | 何时调用 |\n   533→|-----|------|---------|\n   534→| `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |\n   535→\n   536→### 展示工具\n   537→\n   538→| 工具 | 用途 | 何时调用 |\n   539→|-----|------|---------|\n   540→| `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |\n   541→| `show_zodiac_transit` | 展示行运 | 用户问运势时 |\n   542→| `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |\n   543→| `show_insight` | 展示洞察 | 总结分析时 |\n   544→\n   545→### 检索工具\n   546→\n   547→| 工具 | 用途 | 何时调用 |\n   548→|-----|------|---------|\n   549→| `search_db` | 检索知识 | 需要专业知识时 |\n   550→\n   551→---\n   552→\n   553→## 知识检索指南\n   554→\n   555→| 需要什么 | query 示例 |\n   556→|---------|-----------|\n   557→| 星座特质 | \"{星座} 特质 性格\" |\n   558→| 行星含义 | \"{行星} 含义 能量\" |\n   559→| 相位解读 | \"{相位} 解读 影响\" |\n   560→| 宫位意义 | \"第{N}宫 意义 领域\" |\n   561→| 行运影响 | \"{行星} 过境 {宫位}\" |\n   562→\n   563→---\n   564→\n   565→## 服务原则\n   566→\n   567→1. **框架完整**: 按分析框架覆盖关键要点\n   568→2. **知识支撑**: 重要结论有检索结果支撑\n   569→3. **工具优先**: 用工具展示星盘和洞察\n   570→4. **心理导向**: 强调自我认知和成长\n   571→\n   572→---\n   573→\n   574→## 伦理边界\n   575→\n   576→### 绝对禁止\n   577→- 预测具体事件日期\n   578→- 给出宿命论断言\n   579→- 健康诊断预测\n   580→- 替用户做决定\n   581→\n   582→### 表达原则\n   583→- 星盘是潜能地图，不是命运判决\n   584→- 行星能量有多种表达方式\n   585→- 强调自由意志和选择\n   586→\n   587→---\n   588→\n   589→## 4. 知识库设计\n   590→\n   591→### 4.1 知识库角色转变\n   592→\n   593→传统角色: Scenario 指定检索 → 固定知识\n   594→新角色: LLM 按需检索 → 动态知识支撑\n   595→\n   596→### 4.2 知识库结构\n   597→\n   598→```sql\n   599→-- knowledge_chunks 表 (保持不变)\n   600→CREATE TABLE knowledge_chunks (\n   601→    id              UUID PRIMARY KEY,\n   602→    skill_id        VARCHAR(50) NOT NULL,\n   603→    document_id     UUID REFERENCES knowledge_documents(id),\n   604→    chunk_index     INT NOT NULL,\n   605→    content         TEXT NOT NULL,\n   606→    section_path    TEXT,\n   607→    section_title   VARCHAR(255),\n   608→    embedding       VECTOR(1024),\n   609→    search_text_preprocessed TEXT,\n   610→    metadata        JSONB,\n   611→    created_at      TIMESTAMP DEFAULT NOW()\n   612→);\n   613→\n   614→-- cases 表 (保持不变)\n   615→CREATE TABLE cases (\n   616→    id              VARCHAR(50) PRIMARY KEY,\n   617→    skill_id        VARCHAR(50) NOT NULL,\n   618→    scenario_ids    VARCHAR[],  -- 可选，用于分类\n   619→    name            VARCHAR(255) NOT NULL,\n   620→    core_data       JSONB NOT NULL,\n   621→    features        JSONB NOT NULL,\n   622→    tags            VARCHAR[] NOT NULL,\n   623→    analysis        JSONB NOT NULL,\n   624→    conclusion      JSONB NOT NULL,\n   625→    authority       VARCHAR(20) DEFAULT 'medium',\n   626→    created_at      TIMESTAMP DEFAULT NOW()\n   627→);\n   628→```\n   629→\n   630→### 4.3 检索接口\n   631→\n   632→```python\n   633→# search_db 工具实现\n   634→async def search_db(\n   635→    table: str,           # \"knowledge_chunks\" 或 \"cases\"\n   636→    query: str,           # LLM 描述的检索需求\n   637→    skill_id: str,        # 限定 skill\n   638→    top_k: int = 5,       # 返回数量\n   639→    filters: dict = None  # 可选过滤条件\n   640→) -> List[Dict]:\n   641→    \"\"\"\n   642→    语义检索知识或案例。\n   643→\n   644→    LLM 通过 query 描述需求，向量检索返回相关内容。\n   645→    \"\"\"\n   646→    embedding = await embed(query)\n   647→\n   648→    if table == \"knowledge_chunks\":\n   649→        return await search_knowledge(skill_id, query, embedding, top_k)\n   650→    elif table == \"cases\":\n   651→        return await search_cases(skill_id, query, embedding, top_k, filters)\n   652→```\n   653→\n   654→### 4.4 知识库质量要求\n   655→\n   656→┌────────────┬───────────────────┬──────────────────┐\n   657→│    指标    │       目标        │       说明       │\n   658→├────────────┼───────────────────┼──────────────────┤\n   659→│ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │\n   660→├────────────┼───────────────────┼──────────────────┤\n   661→│ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │\n   662→├────────────┼───────────────────┼──────────────────┤\n   663→│ 检索准确率 │ ≥70%              │ Top-5 结果相关   │\n   664→└────────────┴───────────────────┴──────────────────┘\n   665→\n   666→---\n   667→\n   668→## 5. CoreAgent 调整\n   669→\n   670→### 5.1 System Prompt 构建\n   671→\n   672→```python\n   673→def build_system_prompt(\n   674→    skill_id: str,\n   675→    user_context: Optional[Dict] = None\n   676→) -> str:\n   677→    \"\"\"\n   678→    构建 System Prompt。\n   679→\n   680→    变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。\n   681→    \"\"\"\n   682→    parts = []\n   683→\n   684→    # 1. 加载 SKILL.md 全文\n   685→    skill_md = load_skill_md(skill_id)\n   686→    parts.append(skill_md)\n   687→\n   688→    # 2. 注入用户上下文 (如果有)\n   689→    if user_context:\n   690→        ctx_text = format_user_context(user_context)\n   691→        parts.append(f\"\\n---\\n\\n## 用户上下文\\n\\n{ctx_text}\")\n   692→\n   693→    return \"\\n\".join(parts)\n   694→```\n   695→"}]},"uuid":"db56a55f-0542-48a0-a570-030447d865ea","timestamp":"2026-01-18T08:19:17.048Z","toolUseResult":{"type":"update","filePath":"/home/aiscend/work/vibelife/docs/components/skill/Agentic Skill System 设计方案 v1.md","content":"# Agentic Skill System 设计方案 v1.0\n\n版本: 1.0 | 日期: 2026-01-18\n状态: 设计稿\n\n---\n\n## 1. 概述\n\n### 1.1 背景\n\n当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：\n- 100+ 预定义 Scenario 文件\n- 触发词匹配路由\n- 固定 SOP 流程执行\n\n问题：\n- 场景数量爆炸，难以维护\n- 触发词冲突，路由不准确\n- LLM 抽取的 SOP 质量参差不齐\n- 缺乏灵活性，无法处理预定义之外的需求\n\n### 1.2 目标\n\n设计 Agentic + 分析框架 的新架构：\n- 删除 100+ Scenario 文件\n- LLM 自主理解用户意图，自主决策服务策略\n- 通过\"分析框架\"确保专业性和完整性\n- 知识库作为 RAG 支撑，按需检索\n\n### 1.3 核心原则\n\n┌──────────────┬──────────────────────────────────────┐\n│     原则     │                 说明                 │\n├──────────────┼──────────────────────────────────────┤\n│ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │\n├──────────────┼──────────────────────────────────────┤\n│ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │\n├──────────────┼──────────────────────────────────────┤\n│ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │\n├──────────────┼──────────────────────────────────────┤\n│ 工具优先     │ 用工具展示结果，而非纯文字           │\n└──────────────┴──────────────────────────────────────┘\n\n---\n\n## 2. 架构设计\n\n### 2.1 整体架构\n\n```\n┌─────────────────────────────────────────────────────────────────────┐\n│                    Agentic Skill System                             │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                     │\n│  ┌─────────────────────────────────────────────────────────────┐   │\n│  │                      SKILL.md (精简版)                       │   │\n│  │                                                              │   │\n│  │  • 专家身份 (Expert Persona)                                 │   │\n│  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │\n│  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │\n│  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │\n│  │  • 伦理边界 (Ethics)                                         │   │\n│  │                                                              │   │\n│  └─────────────────────────────────────────────────────────────┘   │\n│                              │                                      │\n│                              ▼                                      │\n│  ┌─────────────────────────────────────────────────────────────┐   │\n│  │                     CoreAgent (LLM)                          │   │\n│  │                                                              │   │\n│  │  System Prompt = SKILL.md + User Context                     │   │\n│  │                                                              │   │\n│  │  Agentic Loop:                                               │   │\n│  │  1. 理解用户意图                                             │   │\n│  │  2. 匹配核心能力，获取分析框架                               │   │\n│  │  3. 按框架规划分析步骤                                       │   │\n│  │  4. 按需检索知识 (search_db)                                 │   │\n│  │  5. 调用工具展示结果                                         │   │\n│  │  6. 引导后续对话                                             │   │\n│  │                                                              │   │\n│  └─────────────────────────────────────────────────────────────┘   │\n│                              │                                      │\n│              ┌───────────────┼───────────────┐                     │\n│              ▼               ▼               ▼                     │\n│         ┌────────┐     ┌──────────┐    ┌────────┐                 │\n│         │ Tools  │     │Knowledge │    │ Cases  │                 │\n│         │        │     │  (RAG)   │    │        │                 │\n│         └────────┘     └──────────┘    └────────┘                 │\n│                                                                     │\n└─────────────────────────────────────────────────────────────────────┘\n```\n\n### 2.2 与传统架构对比\n\n┌──────────┬──────────────────────────┬────────────────────────────────┐\n│   维度   │    传统 Scenario 架构    │          Agentic 架构          │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │\n├──────────┼──────────────────────────┼────────────────────────────────┤\n│ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │\n└──────────┴──────────────────────────┴────────────────────────────────┘\n\n### 2.3 目录结构变化\n\n```\n# 变更前\nskills/bazi/\n├── SKILL.md                    # 复杂，包含场景目录\n├── scenarios/                  # 100+ 场景文件\n│   ├── basic_reading.md\n│   ├── career.md\n│   ├── relationship.md\n│   └── ... (100+ files)\n└── tools/\n    ├── tools.yaml\n    └── handlers.py\n\n# 变更后\nskills/bazi/\n├── SKILL.md                    # 精简版，包含分析框架\n├── scenarios/                  # 删除或归档\n└── tools/\n    ├── tools.yaml\n    └── handlers.py\n```\n\n---\n\n## 3. SKILL.md 模板设计\n\n### 3.1 结构概览\n\n```yaml\n---\nid: {skill_id}\nname: {skill_name}\nversion: {version}\ndescription: {description}\n---\n```\n\n```markdown\n# {Skill Name}\n\n## 专家身份\n\n## 核心能力与分析框架\n\n## 工具列表与调用指南\n\n## 知识检索指南\n\n## 服务原则\n\n## 伦理边界\n```\n\n### 3.2 Bazi SKILL.md 完整示例\n\n```yaml\n---\nid: bazi\nname: 八字命理\nversion: 3.0.0\ndescription: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师\n---\n```\n\n# 八字命理 Skill\n\n## 专家身份\n\n我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。\n\n**核心理念**：\n- 以用神为纲、调候为急、格局为本、十神生克为用\n- 不故弄玄虚，用现代语言解读古老智慧\n- 命理是趋势分析，不是宿命论\n\n**知识来源优先级**：\n1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）\n2. 知识库检索结果\n3. 实战验证案例\n4. 通用命理知识\n\n---\n\n## 核心能力与分析框架\n\n### 能力 1: 命盘解读\n\n**适用场景**: 用户想了解自己的命盘、第一次算命、基础分析\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |\n| 2 | 格局识别 | \"{日主} {月令} 格局\" |\n| 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |\n| 4 | 关键十神状态 | 根据命盘特点检索 |\n\n**输出要求**:\n- 必须调用 `show_bazi_chart` 展示命盘\n- 必须调用 `show_insight` 展示核心洞察（不超过 4 点）\n- 引导用户深入探索\n\n---\n\n### 能力 2: 事业分析\n\n**适用场景**: 事业发展、职业方向、跳槽时机、升职\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 官杀状态 | \"官杀分析 事业\" |\n| 2 | 财星状态 | \"财星分析 收入\" |\n| 3 | 印星状态 | \"印星分析 贵人 学习\" |\n| 4 | 食伤状态 | \"食伤分析 才华 创业\" |\n| 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |\n| 6 | 时机建议 | 综合以上给出建议 |\n\n**输出要求**:\n- 调用 `show_bazi_chart` 展示命盘\n- 调用 `show_bazi_fortune` 展示大运流年\n- 调用 `show_insight` 展示事业洞察\n- 给出具体可操作的建议\n\n---\n\n### 能力 3: 感情婚姻\n\n**适用场景**: 感情运势、婚姻状况、桃花、配偶特征\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |\n| 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |\n| 3 | 桃花状态 | \"桃花 感情\" |\n| 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |\n| 5 | 婚姻建议 | 综合以上给出建议 |\n\n**性别差异**:\n- 男命: 正财为妻星，偏财为情人\n- 女命: 正官为夫星，七杀为情人\n\n---\n\n### 能力 4: 财运分析\n\n**适用场景**: 财运走势、投资方向、求财时机\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 财星状态 | \"正财 偏财 财运\" |\n| 2 | 财星与日主关系 | \"身强/身弱 财运\" |\n| 3 | 食伤生财 | \"食伤生财 求财方式\" |\n| 4 | 大运流年财运 | \"{大运} {流年} 财运\" |\n| 5 | 求财建议 | 综合以上给出建议 |\n\n---\n\n### 能力 5: 运势预测\n\n**适用场景**: 大运分析、流年运势、特定年份预测\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 大运主题 | \"{大运干支} 大运 主题\" |\n| 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |\n| 3 | 大运流年交互 | \"大运流年 交互 影响\" |\n| 4 | 关键月份 | 根据流年地支判断 |\n| 5 | 趋吉避凶建议 | 综合以上给出建议 |\n\n**输出要求**:\n- 必须调用 `show_bazi_fortune` 展示大运流年\n- 可选调用 `show_bazi_kline` 展示运势趋势图\n\n---\n\n### 能力 6: 合婚配对\n\n**适用场景**: 双方八字合婚、配对分析\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 日主配合 | \"合婚 日主 配合\" |\n| 2 | 用神互补 | \"合婚 用神 互补\" |\n| 3 | 年柱纳音 | \"合婚 纳音 年柱\" |\n| 4 | 冲合关系 | \"合婚 冲合 地支\" |\n| 5 | 综合评分 | 综合以上给出评分和建议 |\n\n**前置要求**: 必须收集双方出生信息\n\n---\n\n## 工具列表与调用指南\n\n### 信息收集工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |\n| `request_info` | 请求补充信息 | 需要更多信息时 |\n\n### 计算工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |\n\n### 展示工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |\n| `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |\n| `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |\n| `show_insight` | 展示洞察卡片 | 总结分析结果时 |\n| `show_report` | 展示完整报告 | 深度分析完成时 |\n\n### 检索工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `search_db` | 检索知识/案例 | 需要专业知识支撑时 |\n\n### 调用原则\n\n1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集\n2. **检索支撑**: 分析前先 `search_db` 获取相关知识\n3. **工具展示**: 用工具呈现结果，比纯文字更直观\n4. **框架完整**: 按分析框架覆盖所有要点\n\n---\n\n## 知识检索指南\n\n### 检索策略\n\n1. 理论知识: query = \"{概念} 理论 原理\"\n2. 分析方法: query = \"{主题} 分析方法 步骤\"\n3. 规则依据: query = \"{主题} 规则 原则\"\n4. 参考案例: query = \"{特征} 案例\"\n5. 经典引用: query = \"{书名} {主题}\"\n\n### 检索示例\n\n| 需要什么 | query 示例 |\n|---------|-----------|\n| 日主强弱理论 | \"日主强弱 判断方法\" |\n| 格局判断方法 | \"格局 判断 正格 变格\" |\n| 用神取用规则 | \"用神 取用 扶抑 调候\" |\n| 十神生克规则 | \"十神 生克 关系\" |\n| 事业分析案例 | \"官杀 事业 案例\" |\n| 经典引用 | \"滴天髓 用神\" |\n\n### 检索原则\n\n1. **不确定时先检索**: 专业问题先查知识库\n2. **query 要具体**: 描述清楚需要什么\n3. **多次检索**: 复杂问题可分多次检索\n4. **结果作为依据**: 检索结果用于支撑分析\n\n---\n\n## 服务原则\n\n### 1. 框架完整\n按分析框架覆盖关键要点，不遗漏重要分析。\n\n### 2. 知识支撑\n重要结论必须有知识库检索结果支撑，不凭空编造。\n\n### 3. 工具优先\n用工具展示结果（命盘图、洞察卡片），而非纯文字描述。\n\n### 4. 引导深入\n分析后引导用户探索更多方面，提供后续选项。\n\n### 5. 语言亲和\n用现代语言解读，避免过多术语，必要时解释专业概念。\n\n---\n\n## 伦理边界\n\n### 绝对禁止\n- 预测具体事件发生的确切日期\n- 给出\"命中注定\"的定论\n- 涉及健康诊断的具体预测\n- 替用户做重大人生决定\n- 预测死亡、重大灾难\n\n### 表达原则\n- 命理是趋势分析，不是宿命论\n- 困难时期是成长机会，不是灾难预言\n- 人的主观能动性可以改变命运轨迹\n- 提供建议而非决定\n\n### 敏感话题处理\n\n| 话题 | 处理方式 |\n|-----|---------|\n| 健康 | 只分析五行倾向，建议咨询医生 |\n| 寿命 | 不预测，转向生活质量建议 |\n| 灾难 | 转化为\"需要注意的时期\" |\n| 离婚 | 分析挑战，提供改善建议 |\n\n### 3.3 Zodiac SKILL.md 完整示例\n\n```yaml\n---\nid: zodiac\nname: 西方占星\nversion: 3.0.0\ndescription: 融合现代心理占星与传统占星的专业占星师\n---\n```\n\n# 西方占星 Skill\n\n## 专家身份\n\n我是融合现代心理占星与传统占星的专业占星师。\n\n**核心理念**：\n- 星盘是潜能地图，不是命运判决书\n- 行星能量可以有多种表达方式\n- 占星是自我认知的工具\n\n**知识来源优先级**：\n1. 知识库检索结果\n2. 心理占星理论\n3. 传统占星规则\n4. 通用占星知识\n\n---\n\n## 核心能力与分析框架\n\n### 能力 1: 本命盘解读\n\n**适用场景**: 了解自己的星盘、性格分析、人生主题\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |\n| 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |\n| 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |\n| 4 | 主要相位 | \"{相位类型} 相位 含义\" |\n| 5 | 宫位分布 | 根据星盘特点检索 |\n\n**输出要求**:\n- 必须调用 `show_zodiac_chart` 展示星盘\n- 必须调用 `show_insight` 展示核心洞察\n\n---\n\n### 能力 2: 行运分析\n\n**适用场景**: 当前运势、行星过境影响、时机选择\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |\n| 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |\n| 3 | 影响领域 | 根据宫位判断 |\n| 4 | 时间周期 | 根据行星速度判断 |\n| 5 | 应对建议 | 综合以上给出建议 |\n\n**输出要求**:\n- 调用 `show_zodiac_transit` 展示行运\n- 调用 `show_insight` 展示行运洞察\n\n---\n\n### 能力 3: 合盘分析\n\n**适用场景**: 感情配对、关系分析、合作关系\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |\n| 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |\n| 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |\n| 4 | 宫位重叠 | \"合盘 宫位 重叠\" |\n| 5 | 综合评估 | 综合以上给出评估 |\n\n**输出要求**:\n- 调用 `show_zodiac_synastry` 展示合盘\n- 调用 `show_insight` 展示关系洞察\n\n---\n\n### 能力 4: 流年预测\n\n**适用场景**: 年度运势、太阳回归、重要时间点\n\n**分析框架** (必须覆盖):\n| 步骤 | 分析要点 | 知识检索 query |\n|-----|---------|---------------|\n| 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |\n| 2 | 外行星行运 | \"{行星} 行运 {年份}\" |\n| 3 | 日月食影响 | \"日月食 {星座} 影响\" |\n| 4 | 关键时间点 | 根据行运判断 |\n| 5 | 年度建议 | 综合以上给出建议 |\n\n---\n\n## 工具列表与调用指南\n\n### 信息收集工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |\n\n### 展示工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |\n| `show_zodiac_transit` | 展示行运 | 用户问运势时 |\n| `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |\n| `show_insight` | 展示洞察 | 总结分析时 |\n\n### 检索工具\n\n| 工具 | 用途 | 何时调用 |\n|-----|------|---------|\n| `search_db` | 检索知识 | 需要专业知识时 |\n\n---\n\n## 知识检索指南\n\n| 需要什么 | query 示例 |\n|---------|-----------|\n| 星座特质 | \"{星座} 特质 性格\" |\n| 行星含义 | \"{行星} 含义 能量\" |\n| 相位解读 | \"{相位} 解读 影响\" |\n| 宫位意义 | \"第{N}宫 意义 领域\" |\n| 行运影响 | \"{行星} 过境 {宫位}\" |\n\n---\n\n## 服务原则\n\n1. **框架完整**: 按分析框架覆盖关键要点\n2. **知识支撑**: 重要结论有检索结果支撑\n3. **工具优先**: 用工具展示星盘和洞察\n4. **心理导向**: 强调自我认知和成长\n\n---\n\n## 伦理边界\n\n### 绝对禁止\n- 预测具体事件日期\n- 给出宿命论断言\n- 健康诊断预测\n- 替用户做决定\n\n### 表达原则\n- 星盘是潜能地图，不是命运判决\n- 行星能量有多种表达方式\n- 强调自由意志和选择\n\n---\n\n## 4. 知识库设计\n\n### 4.1 知识库角色转变\n\n传统角色: Scenario 指定检索 → 固定知识\n新角色: LLM 按需检索 → 动态知识支撑\n\n### 4.2 知识库结构\n\n```sql\n-- knowledge_chunks 表 (保持不变)\nCREATE TABLE knowledge_chunks (\n    id              UUID PRIMARY KEY,\n    skill_id        VARCHAR(50) NOT NULL,\n    document_id     UUID REFERENCES knowledge_documents(id),\n    chunk_index     INT NOT NULL,\n    content         TEXT NOT NULL,\n    section_path    TEXT,\n    section_title   VARCHAR(255),\n    embedding       VECTOR(1024),\n    search_text_preprocessed TEXT,\n    metadata        JSONB,\n    created_at      TIMESTAMP DEFAULT NOW()\n);\n\n-- cases 表 (保持不变)\nCREATE TABLE cases (\n    id              VARCHAR(50) PRIMARY KEY,\n    skill_id        VARCHAR(50) NOT NULL,\n    scenario_ids    VARCHAR[],  -- 可选，用于分类\n    name            VARCHAR(255) NOT NULL,\n    core_data       JSONB NOT NULL,\n    features        JSONB NOT NULL,\n    tags            VARCHAR[] NOT NULL,\n    analysis        JSONB NOT NULL,\n    conclusion      JSONB NOT NULL,\n    authority       VARCHAR(20) DEFAULT 'medium',\n    created_at      TIMESTAMP DEFAULT NOW()\n);\n```\n\n### 4.3 检索接口\n\n```python\n# search_db 工具实现\nasync def search_db(\n    table: str,           # \"knowledge_chunks\" 或 \"cases\"\n    query: str,           # LLM 描述的检索需求\n    skill_id: str,        # 限定 skill\n    top_k: int = 5,       # 返回数量\n    filters: dict = None  # 可选过滤条件\n) -> List[Dict]:\n    \"\"\"\n    语义检索知识或案例。\n\n    LLM 通过 query 描述需求，向量检索返回相关内容。\n    \"\"\"\n    embedding = await embed(query)\n\n    if table == \"knowledge_chunks\":\n        return await search_knowledge(skill_id, query, embedding, top_k)\n    elif table == \"cases\":\n        return await search_cases(skill_id, query, embedding, top_k, filters)\n```\n\n### 4.4 知识库质量要求\n\n┌────────────┬───────────────────┬──────────────────┐\n│    指标    │       目标        │       说明       │\n├────────────┼───────────────────┼──────────────────┤\n│ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │\n├────────────┼───────────────────┼──────────────────┤\n│ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │\n├────────────┼───────────────────┼──────────────────┤\n│ 检索准确率 │ ≥70%              │ Top-5 结果相关   │\n└────────────┴───────────────────┴──────────────────┘\n\n---\n\n## 5. CoreAgent 调整\n\n### 5.1 System Prompt 构建\n\n```python\ndef build_system_prompt(\n    skill_id: str,\n    user_context: Optional[Dict] = None\n) -> str:\n    \"\"\"\n    构建 System Prompt。\n\n    变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。\n    \"\"\"\n    parts = []\n\n    # 1. 加载 SKILL.md 全文\n    skill_md = load_skill_md(skill_id)\n    parts.append(skill_md)\n\n    # 2. 注入用户上下文 (如果有)\n    if user_context:\n        ctx_text = format_user_context(user_context)\n        parts.append(f\"\\n---\\n\\n## 用户上下文\\n\\n{ctx_text}\")\n\n    return \"\\n\".join(parts)\n```\n","structuredPatch":[{"oldStart":1,"oldLines":662,"newStart":1,"newLines":694,"lines":["-Agentic Skill System 设计方案 v1.0                                                                                                        ","-                                                                                                                                            ","-  版本: 1.0 | 日期: 2026-01-18                                                                                                              ","-  状态: 设计稿                                                                                                                              ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-  1. 概述                                                                                                                                   ","-                                                                                                                                            ","-  1.1 背景                                                                                                                                  ","-                                                                                                                                            ","-  当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：                                                                                      ","-  - 100+ 预定义 Scenario 文件                                                                                                               ","-  - 触发词匹配路由                                                                                                                          ","-  - 固定 SOP 流程执行                                                                                                                       ","-                                                                                                                                            ","-  问题：                                                                                                                                    ","-  - 场景数量爆炸，难以维护                                                                                                                  ","-  - 触发词冲突，路由不准确                                                                                                                  ","-  - LLM 抽取的 SOP 质量参差不齐                                                                                                             ","-  - 缺乏灵活性，无法处理预定义之外的需求                                                                                                    ","-                                                                                                                                            ","-  1.2 目标                                                                                                                                  ","-                                                                                                                                            ","-  设计 Agentic + 分析框架 的新架构：                                                                                                        ","-  - 删除 100+ Scenario 文件                                                                                                                 ","-  - LLM 自主理解用户意图，自主决策服务策略                                                                                                  ","-  - 通过\"分析框架\"确保专业性和完整性                                                                                                        ","-  - 知识库作为 RAG 支撑，按需检索                                                                                                           ","-                                                                                                                                            ","-  1.3 核心原则                                                                                                                              ","-  ┌──────────────┬──────────────────────────────────────┐                                                                                   ","-  │     原则     │                 说明                 │                                                                                   ","-  ├──────────────┼──────────────────────────────────────┤                                                                                   ","-  │ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │                                                                                   ","-  ├──────────────┼──────────────────────────────────────┤                                                                                   ","-  │ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │                                                                                   ","-  ├──────────────┼──────────────────────────────────────┤                                                                                   ","-  │ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │                                                                                   ","-  ├──────────────┼──────────────────────────────────────┤                                                                                   ","-  │ 工具优先     │ 用工具展示结果，而非纯文字           │                                                                                   ","-  └──────────────┴──────────────────────────────────────┘                                                                                   ","-  ---                                                                                                                                       ","-  2. 架构设计                                                                                                                               ","-                                                                                                                                            ","-  2.1 整体架构                                                                                                                              ","-                                                                                                                                            ","-  ┌─────────────────────────────────────────────────────────────────────┐                                                                   ","-  │                    Agentic Skill System                             │                                                                   ","-  ├─────────────────────────────────────────────────────────────────────┤                                                                   ","-  │                                                                     │                                                                   ","-  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    ","-  │  │                      SKILL.md (精简版)                       │   │                                                                   ","-  │  │                                                              │   │                                                                   ","-  │  │  • 专家身份 (Expert Persona)                                 │   │                                                                   ","-  │  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │                                                                   ","-  │  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │                                                                   ","-  │  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │                                                                   ","-  │  │  • 伦理边界 (Ethics)                                         │   │                                                                   ","-  │  │                                                              │   │                                                                   ","-  │  └─────────────────────────────────────────────────────────────┘   │                                                                    ","-  │                              │                                      │                                                                   ","-  │                              ▼                                      │                                                                   ","-  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    ","-  │  │                     CoreAgent (LLM)                          │   │                                                                   ","-  │  │                                                              │   │                                                                   ","-  │  │  System Prompt = SKILL.md + User Context                     │   │                                                                   ","-  │  │                                                              │   │                                                                   ","-  │  │  Agentic Loop:                                               │   │                                                                   ","-  │  │  1. 理解用户意图                                             │   │                                                                   ","-  │  │  2. 匹配核心能力，获取分析框架                               │   │                                                                   ","-  │  │  3. 按框架规划分析步骤                                       │   │                                                                   ","-  │  │  4. 按需检索知识 (search_db)                                 │   │                                                                   ","-  │  │  5. 调用工具展示结果                                         │   │                                                                   ","-  │  │  6. 引导后续对话                                             │   │                                                                   ","-  │  │                                                              │   │                                                                   ","-  │  └─────────────────────────────────────────────────────────────┘   │                                                                    ","-  │                              │                                      │                                                                   ","-  │              ┌───────────────┼───────────────┐                     │                                                                    ","-  │              ▼               ▼               ▼                     │                                                                    ","-  │         ┌────────┐     ┌──────────┐    ┌────────┐                 │                                                                     ","-  │         │ Tools  │     │Knowledge │    │ Cases  │                 │                                                                     ","-  │         │        │     │  (RAG)   │    │        │                 │                                                                     ","-  │         └────────┘     └──────────┘    └────────┘                 │                                                                     ","-  │                                                                     │                                                                   ","-  └─────────────────────────────────────────────────────────────────────┘                                                                   ","-                                                                                                                                            ","-  2.2 与传统架构对比                                                                                                                        ","-  ┌──────────┬──────────────────────────┬────────────────────────────────┐                                                                  ","-  │   维度   │    传统 Scenario 架构    │          Agentic 架构          │                                                                  ","-  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  ","-  │ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │                                                                  ","-  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  ","-  │ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │                                                                  ","-  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  ","-  │ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │                                                                  ","-  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  ","-  │ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │                                                                  ","-  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  ","-  │ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │                                                                  ","-  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  ","-  │ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │                                                                  ","-  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  ","-  │ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │                                                                  ","-  └──────────┴──────────────────────────┴────────────────────────────────┘                                                                  ","-  2.3 目录结构变化                                                                                                                          ","-                                                                                                                                            ","-  # 变更前                                                                                                                                  ","-  skills/bazi/                                                                                                                              ","-  ├── SKILL.md                    # 复杂，包含场景目录                                                                                      ","-  ├── scenarios/                  # 100+ 场景文件                                                                                           ","-  │   ├── basic_reading.md                                                                                                                  ","-  │   ├── career.md                                                                                                                         ","-  │   ├── relationship.md                                                                                                                   ","-  │   └── ... (100+ files)                                                                                                                  ","-  └── tools/                                                                                                                                ","-      ├── tools.yaml                                                                                                                        ","-      └── handlers.py                                                                                                                       ","-                                                                                                                                            ","-  # 变更后                                                                                                                                  ","-  skills/bazi/                                                                                                                              ","-  ├── SKILL.md                    # 精简版，包含分析框架                                                                                    ","-  ├── scenarios/                  # 删除或归档                                                                                              ","-  └── tools/                                                                                                                                ","-      ├── tools.yaml                                                                                                                        ","-      └── handlers.py                                                                                                                       ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-  3. SKILL.md 模板设计                                                                                                                      ","-                                                                                                                                            ","-  3.1 结构概览                                                                                                                              ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-  id: {skill_id}                                                                                                                            ","-  name: {skill_name}                                                                                                                        ","-  version: {version}                                                                                                                        ","-  description: {description}                                                                                                                ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  # {Skill Name}                                                                                                                            ","-                                                                                                                                            ","-  ## 专家身份                                                                                                                               ","-                                                                                                                                            ","-  ## 核心能力与分析框架                                                                                                                     ","-                                                                                                                                            ","-  ## 工具列表与调用指南                                                                                                                     ","-                                                                                                                                            ","-  ## 知识检索指南                                                                                                                           ","-                                                                                                                                            ","-  ## 服务原则                                                                                                                               ","-                                                                                                                                            ","-  ## 伦理边界                                                                                                                               ","-                                                                                                                                            ","-  3.2 Bazi SKILL.md 完整示例                                                                                                                ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-  id: bazi                                                                                                                                  ","-  name: 八字命理                                                                                                                            ","-  version: 3.0.0                                                                                                                            ","-  description: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师                                                       ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  # 八字命理 Skill                                                                                                                          ","-                                                                                                                                            ","-  ## 专家身份                                                                                                                               ","-                                                                                                                                            ","-  我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。                                                      ","-                                                                                                                                            ","-  **核心理念**：                                                                                                                            ","-  - 以用神为纲、调候为急、格局为本、十神生克为用                                                                                            ","-  - 不故弄玄虚，用现代语言解读古老智慧                                                                                                      ","-  - 命理是趋势分析，不是宿命论                                                                                                              ","-                                                                                                                                            ","-  **知识来源优先级**：                                                                                                                      ","-  1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）                                                                                 ","-  2. 知识库检索结果                                                                                                                         ","-  3. 实战验证案例                                                                                                                           ","-  4. 通用命理知识                                                                                                                           ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 核心能力与分析框架                                                                                                                     ","-                                                                                                                                            ","-  ### 能力 1: 命盘解读                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 用户想了解自己的命盘、第一次算命、基础分析                                                                                  ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |                                                                                       ","-  | 2 | 格局识别 | \"{日主} {月令} 格局\" |                                                                                                   ","-  | 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |                                                                                              ","-  | 4 | 关键十神状态 | 根据命盘特点检索 |                                                                                                   ","-                                                                                                                                            ","-  **输出要求**:                                                                                                                             ","-  - 必须调用 `show_bazi_chart` 展示命盘                                                                                                     ","-  - 必须调用 `show_insight` 展示核心洞察（不超过 4 点）                                                                                     ","-  - 引导用户深入探索                                                                                                                        ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 2: 事业分析                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 事业发展、职业方向、跳槽时机、升职                                                                                          ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 官杀状态 | \"官杀分析 事业\" |                                                                                                        ","-  | 2 | 财星状态 | \"财星分析 收入\" |                                                                                                        ","-  | 3 | 印星状态 | \"印星分析 贵人 学习\" |                                                                                                   ","-  | 4 | 食伤状态 | \"食伤分析 才华 创业\" |                                                                                                   ","-  | 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |                                                                                           ","-  | 6 | 时机建议 | 综合以上给出建议 |                                                                                                       ","-                                                                                                                                            ","-  **输出要求**:                                                                                                                             ","-  - 调用 `show_bazi_chart` 展示命盘                                                                                                         ","-  - 调用 `show_bazi_fortune` 展示大运流年                                                                                                   ","-  - 调用 `show_insight` 展示事业洞察                                                                                                        ","-  - 给出具体可操作的建议                                                                                                                    ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 3: 感情婚姻                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 感情运势、婚姻状况、桃花、配偶特征                                                                                          ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |                                                                                                   ","-  | 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |                                                                                           ","-  | 3 | 桃花状态 | \"桃花 感情\" |                                                                                                            ","-  | 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |                                                                                          ","-  | 5 | 婚姻建议 | 综合以上给出建议 |                                                                                                       ","-                                                                                                                                            ","-  **性别差异**:                                                                                                                             ","-  - 男命: 正财为妻星，偏财为情人                                                                                                            ","-  - 女命: 正官为夫星，七杀为情人                                                                                                            ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 4: 财运分析                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 财运走势、投资方向、求财时机                                                                                                ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 财星状态 | \"正财 偏财 财运\" |                                                                                                       ","-  | 2 | 财星与日主关系 | \"身强/身弱 财运\" |                                                                                                 ","-  | 3 | 食伤生财 | \"食伤生财 求财方式\" |                                                                                                    ","-  | 4 | 大运流年财运 | \"{大运} {流年} 财运\" |                                                                                               ","-  | 5 | 求财建议 | 综合以上给出建议 |                                                                                                       ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 5: 运势预测                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 大运分析、流年运势、特定年份预测                                                                                            ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 大运主题 | \"{大运干支} 大运 主题\" |                                                                                                 ","-  | 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |                                                                                               ","-  | 3 | 大运流年交互 | \"大运流年 交互 影响\" |                                                                                               ","-  | 4 | 关键月份 | 根据流年地支判断 |                                                                                                       ","-  | 5 | 趋吉避凶建议 | 综合以上给出建议 |                                                                                                   ","-                                                                                                                                            ","-  **输出要求**:                                                                                                                             ","-  - 必须调用 `show_bazi_fortune` 展示大运流年                                                                                               ","-  - 可选调用 `show_bazi_kline` 展示运势趋势图                                                                                               ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 6: 合婚配对                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 双方八字合婚、配对分析                                                                                                      ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 日主配合 | \"合婚 日主 配合\" |                                                                                                       ","-  | 2 | 用神互补 | \"合婚 用神 互补\" |                                                                                                       ","-  | 3 | 年柱纳音 | \"合婚 纳音 年柱\" |                                                                                                       ","-  | 4 | 冲合关系 | \"合婚 冲合 地支\" |                                                                                                       ","-  | 5 | 综合评分 | 综合以上给出评分和建议 |                                                                                                 ","-                                                                                                                                            ","-  **前置要求**: 必须收集双方出生信息                                                                                                        ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 工具列表与调用指南                                                                                                                     ","-                                                                                                                                            ","-  ### 信息收集工具                                                                                                                          ","-                                                                                                                                            ","-  | 工具 | 用途 | 何时调用 |                                                                                                                ","-  |-----|------|---------|                                                                                                                  ","-  | `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |                                                                                 ","-  | `request_info` | 请求补充信息 | 需要更多信息时 |                                                                                        ","-                                                                                                                                            ","-  ### 计算工具                                                                                                                              ","-                                                                                                                                            ","-  | 工具 | 用途 | 何时调用 |                                                                                                                ","-  |-----|------|---------|                                                                                                                  ","-  | `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |                                                                                ","-                                                                                                                                            ","-  ### 展示工具                                                                                                                              ","-                                                                                                                                            ","-  | 工具 | 用途 | 何时调用 |                                                                                                                ","-  |-----|------|---------|                                                                                                                  ","-  | `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |                                                                                       ","-  | `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |                                                                                     ","-  | `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |                                                                                      ","-  | `show_insight` | 展示洞察卡片 | 总结分析结果时 |                                                                                        ","-  | `show_report` | 展示完整报告 | 深度分析完成时 |                                                                                         ","-                                                                                                                                            ","-  ### 检索工具                                                                                                                              ","-                                                                                                                                            ","-  | 工具 | 用途 | 何时调用 |                                                                                                                ","-  |-----|------|---------|                                                                                                                  ","-  | `search_db` | 检索知识/案例 | 需要专业知识支撑时 |                                                                                      ","-                                                                                                                                            ","-  ### 调用原则                                                                                                                              ","-                                                                                                                                            ","-  1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集                                                                               ","-  2. **检索支撑**: 分析前先 `search_db` 获取相关知识                                                                                        ","-  3. **工具展示**: 用工具呈现结果，比纯文字更直观                                                                                           ","-  4. **框架完整**: 按分析框架覆盖所有要点                                                                                                   ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 知识检索指南                                                                                                                           ","-                                                                                                                                            ","-  ### 检索策略                                                                                                                              ","-                                                                                                                                            ","-  1. 理论知识: query = \"{概念} 理论 原理\"                                                                                                   ","-  2. 分析方法: query = \"{主题} 分析方法 步骤\"                                                                                               ","-  3. 规则依据: query = \"{主题} 规则 原则\"                                                                                                   ","-  4. 参考案例: query = \"{特征} 案例\"                                                                                                        ","-  5. 经典引用: query = \"{书名} {主题}\"                                                                                                      ","-                                                                                                                                            ","-  ### 检索示例                                                                                                                              ","-                                                                                                                                            ","-  | 需要什么 | query 示例 |                                                                                                                 ","-  |---------|-----------|                                                                                                                   ","-  | 日主强弱理论 | \"日主强弱 判断方法\" |                                                                                                    ","-  | 格局判断方法 | \"格局 判断 正格 变格\" |                                                                                                  ","-  | 用神取用规则 | \"用神 取用 扶抑 调候\" |                                                                                                  ","-  | 十神生克规则 | \"十神 生克 关系\" |                                                                                                       ","-  | 事业分析案例 | \"官杀 事业 案例\" |                                                                                                       ","-  | 经典引用 | \"滴天髓 用神\" |                                                                                                              ","-                                                                                                                                            ","-  ### 检索原则                                                                                                                              ","-                                                                                                                                            ","-  1. **不确定时先检索**: 专业问题先查知识库                                                                                                 ","-  2. **query 要具体**: 描述清楚需要什么                                                                                                     ","-  3. **多次检索**: 复杂问题可分多次检索                                                                                                     ","-  4. **结果作为依据**: 检索结果用于支撑分析                                                                                                 ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 服务原则                                                                                                                               ","-                                                                                                                                            ","-  ### 1. 框架完整                                                                                                                           ","-  按分析框架覆盖关键要点，不遗漏重要分析。                                                                                                  ","-                                                                                                                                            ","-  ### 2. 知识支撑                                                                                                                           ","-  重要结论必须有知识库检索结果支撑，不凭空编造。                                                                                            ","-                                                                                                                                            ","-  ### 3. 工具优先                                                                                                                           ","-  用工具展示结果（命盘图、洞察卡片），而非纯文字描述。                                                                                      ","-                                                                                                                                            ","-  ### 4. 引导深入                                                                                                                           ","-  分析后引导用户探索更多方面，提供后续选项。                                                                                                ","-                                                                                                                                            ","-  ### 5. 语言亲和                                                                                                                           ","-  用现代语言解读，避免过多术语，必要时解释专业概念。                                                                                        ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 伦理边界                                                                                                                               ","-                                                                                                                                            ","-  ### 绝对禁止                                                                                                                              ","-  - 预测具体事件发生的确切日期                                                                                                              ","-  - 给出\"命中注定\"的定论                                                                                                                    ","-  - 涉及健康诊断的具体预测                                                                                                                  ","-  - 替用户做重大人生决定                                                                                                                    ","-  - 预测死亡、重大灾难                                                                                                                      ","-                                                                                                                                            ","-  ### 表达原则                                                                                                                              ","-  - 命理是趋势分析，不是宿命论                                                                                                              ","-  - 困难时期是成长机会，不是灾难预言                                                                                                        ","-  - 人的主观能动性可以改变命运轨迹                                                                                                          ","-  - 提供建议而非决定                                                                                                                        ","-                                                                                                                                            ","-  ### 敏感话题处理                                                                                                                          ","-  | 话题 | 处理方式 |                                                                                                                       ","-  |-----|---------|                                                                                                                         ","-  | 健康 | 只分析五行倾向，建议咨询医生 |                                                                                                   ","-  | 寿命 | 不预测，转向生活质量建议 |                                                                                                       ","-  | 灾难 | 转化为\"需要注意的时期\" |                                                                                                         ","-  | 离婚 | 分析挑战，提供改善建议 |                                                                                                         ","-                                                                                                                                            ","-  3.3 Zodiac SKILL.md 完整示例                                                                                                              ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-  id: zodiac                                                                                                                                ","-  name: 西方占星                                                                                                                            ","-  version: 3.0.0                                                                                                                            ","-  description: 融合现代心理占星与传统占星的专业占星师                                                                                       ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  # 西方占星 Skill                                                                                                                          ","-                                                                                                                                            ","-  ## 专家身份                                                                                                                               ","-                                                                                                                                            ","-  我是融合现代心理占星与传统占星的专业占星师。                                                                                              ","-                                                                                                                                            ","-  **核心理念**：                                                                                                                            ","-  - 星盘是潜能地图，不是命运判决书                                                                                                          ","-  - 行星能量可以有多种表达方式                                                                                                              ","-  - 占星是自我认知的工具                                                                                                                    ","-                                                                                                                                            ","-  **知识来源优先级**：                                                                                                                      ","-  1. 知识库检索结果                                                                                                                         ","-  2. 心理占星理论                                                                                                                           ","-  3. 传统占星规则                                                                                                                           ","-  4. 通用占星知识                                                                                                                           ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 核心能力与分析框架                                                                                                                     ","-                                                                                                                                            ","-  ### 能力 1: 本命盘解读                                                                                                                    ","-                                                                                                                                            ","-  **适用场景**: 了解自己的星盘、性格分析、人生主题                                                                                          ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |                                                                                             ","-  | 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |                                                                                             ","-  | 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |                                                                                             ","-  | 4 | 主要相位 | \"{相位类型} 相位 含义\" |                                                                                                 ","-  | 5 | 宫位分布 | 根据星盘特点检索 |                                                                                                       ","-                                                                                                                                            ","-  **输出要求**:                                                                                                                             ","-  - 必须调用 `show_zodiac_chart` 展示星盘                                                                                                   ","-  - 必须调用 `show_insight` 展示核心洞察                                                                                                    ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 2: 行运分析                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 当前运势、行星过境影响、时机选择                                                                                            ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |                                                                                                 ","-  | 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |                                                                                         ","-  | 3 | 影响领域 | 根据宫位判断 |                                                                                                           ","-  | 4 | 时间周期 | 根据行星速度判断 |                                                                                                       ","-  | 5 | 应对建议 | 综合以上给出建议 |                                                                                                       ","-                                                                                                                                            ","-  **输出要求**:                                                                                                                             ","-  - 调用 `show_zodiac_transit` 展示行运                                                                                                     ","-  - 调用 `show_insight` 展示行运洞察                                                                                                        ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 3: 合盘分析                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 感情配对、关系分析、合作关系                                                                                                ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |                                                                                              ","-  | 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |                                                                                                ","-  | 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |                                                                                                  ","-  | 4 | 宫位重叠 | \"合盘 宫位 重叠\" |                                                                                                       ","-  | 5 | 综合评估 | 综合以上给出评估 |                                                                                                       ","-                                                                                                                                            ","-  **输出要求**:                                                                                                                             ","-  - 调用 `show_zodiac_synastry` 展示合盘                                                                                                    ","-  - 调用 `show_insight` 展示关系洞察                                                                                                        ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ### 能力 4: 流年预测                                                                                                                      ","-                                                                                                                                            ","-  **适用场景**: 年度运势、太阳回归、重要时间点                                                                                              ","-                                                                                                                                            ","-  **分析框架** (必须覆盖):                                                                                                                  ","-  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      ","-  |-----|---------|---------------|                                                                                                         ","-  | 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |                                                                                               ","-  | 2 | 外行星行运 | \"{行星} 行运 {年份}\" |                                                                                                 ","-  | 3 | 日月食影响 | \"日月食 {星座} 影响\" |                                                                                                 ","-  | 4 | 关键时间点 | 根据行运判断 |                                                                                                         ","-  | 5 | 年度建议 | 综合以上给出建议 |                                                                                                       ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 工具列表与调用指南                                                                                                                     ","-                                                                                                                                            ","-  ### 信息收集工具                                                                                                                          ","-                                                                                                                                            ","-  | 工具 | 用途 | 何时调用 |                                                                                                                ","-  |-----|------|---------|                                                                                                                  ","-  | `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |                                                                                   ","-                                                                                                                                            ","-  ### 展示工具                                                                                                                              ","-                                                                                                                                            ","-  | 工具 | 用途 | 何时调用 |                                                                                                                ","-  |-----|------|---------|                                                                                                                  ","-  | `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |                                                                                     ","-  | `show_zodiac_transit` | 展示行运 | 用户问运势时 |                                                                                       ","-  | `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |                                                                                        ","-  | `show_insight` | 展示洞察 | 总结分析时 |                                                                                                ","-                                                                                                                                            ","-  ### 检索工具                                                                                                                              ","-                                                                                                                                            ","-  | 工具 | 用途 | 何时调用 |                                                                                                                ","-  |-----|------|---------|                                                                                                                  ","-  | `search_db` | 检索知识 | 需要专业知识时 |                                                                                               ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 知识检索指南                                                                                                                           ","-                                                                                                                                            ","-  | 需要什么 | query 示例 |                                                                                                                 ","-  |---------|-----------|                                                                                                                   ","-  | 星座特质 | \"{星座} 特质 性格\" |                                                                                                         ","-  | 行星含义 | \"{行星} 含义 能量\" |                                                                                                         ","-  | 相位解读 | \"{相位} 解读 影响\" |                                                                                                         ","-  | 宫位意义 | \"第{N}宫 意义 领域\" |                                                                                                        ","-  | 行运影响 | \"{行星} 过境 {宫位}\" |                                                                                                       ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 服务原则                                                                                                                               ","-                                                                                                                                            ","-  1. **框架完整**: 按分析框架覆盖关键要点                                                                                                   ","-  2. **知识支撑**: 重要结论有检索结果支撑                                                                                                   ","-  3. **工具优先**: 用工具展示星盘和洞察                                                                                                     ","-  4. **心理导向**: 强调自我认知和成长                                                                                                       ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-                                                                                                                                            ","-  ## 伦理边界                                                                                                                               ","-                                                                                                                                            ","-  ### 绝对禁止                                                                                                                              ","-  - 预测具体事件日期                                                                                                                        ","-  - 给出宿命论断言                                                                                                                          ","-  - 健康诊断预测                                                                                                                            ","-  - 替用户做决定                                                                                                                            ","-                                                                                                                                            ","-  ### 表达原则                                                                                                                              ","-  - 星盘是潜能地图，不是命运判决                                                                                                            ","-  - 行星能量有多种表达方式                                                                                                                  ","-  - 强调自由意志和选择                                                                                                                      ","-                                                                                                                                            ","-  ---                                                                                                                                       ","-  4. 知识库设计                                                                                                                             ","-                                                                                                                                            ","-  4.1 知识库角色转变                                                                                                                        ","-                                                                                                                                            ","-  传统角色: Scenario 指定检索 → 固定知识                                                                                                    ","-  新角色: LLM 按需检索 → 动态知识支撑                                                                                                       ","-                                                                                                                                            ","-  4.2 知识库结构                                                                                                                            ","-                                                                                                                                            ","-  -- knowledge_chunks 表 (保持不变)                                                                                                         ","-  CREATE TABLE knowledge_chunks (                                                                                                           ","-      id              UUID PRIMARY KEY,                                                                                                     ","-      skill_id        VARCHAR(50) NOT NULL,                                                                                                 ","-      document_id     UUID REFERENCES knowledge_documents(id),                                                                              ","-      chunk_index     INT NOT NULL,                                                                                                         ","-      content         TEXT NOT NULL,                                                                                                        ","-      section_path    TEXT,                                                                                                                 ","-      section_title   VARCHAR(255),                                                                                                         ","-      embedding       VECTOR(1024),                                                                                                         ","-      search_text_preprocessed TEXT,                                                                                                        ","-      metadata        JSONB,                                                                                                                ","-      created_at      TIMESTAMP DEFAULT NOW()                                                                                               ","-  );                                                                                                                                        ","-                                                                                                                                            ","-  -- cases 表 (保持不变)                                                                                                                    ","-  CREATE TABLE cases (                                                                                                                      ","-      id              VARCHAR(50) PRIMARY KEY,                                                                                              ","-      skill_id        VARCHAR(50) NOT NULL,                                                                                                 ","-      scenario_ids    VARCHAR[],  -- 可选，用于分类                                                                                         ","-      name            VARCHAR(255) NOT NULL,                                                                                                ","-      core_data       JSONB NOT NULL,                                                                                                       ","-      features        JSONB NOT NULL,                                                                                                       ","-      tags            VARCHAR[] NOT NULL,                                                                                                   ","-      analysis        JSONB NOT NULL,                                                                                                       ","-      conclusion      JSONB NOT NULL,                                                                                                       ","-      authority       VARCHAR(20) DEFAULT 'medium',                                                                                         ","-      created_at      TIMESTAMP DEFAULT NOW()                                                                                               ","-  );                                                                                                                                        ","-                                                                                                                                            ","-  4.3 检索接口                                                                                                                              ","-                                                                                                                                            ","-  # search_db 工具实现                                                                                                                      ","-  async def search_db(                                                                                                                      ","-      table: str,           # \"knowledge_chunks\" 或 \"cases\"                                                                                 ","-      query: str,           # LLM 描述的检索需求                                                                                            ","-      skill_id: str,        # 限定 skill                                                                                                    ","-      top_k: int = 5,       # 返回数量                                                                                                      ","-      filters: dict = None  # 可选过滤条件                                                                                                  ","-  ) -> List[Dict]:                                                                                                                          ","-      \"\"\"                                                                                                                                   ","-      语义检索知识或案例。                                                                                                                  ","-                                                                                                                                            ","-      LLM 通过 query 描述需求，向量检索返回相关内容。                                                                                       ","-      \"\"\"                                                                                                                                   ","-      embedding = await embed(query)                                                                                                        ","-                                                                                                                                            ","-      if table == \"knowledge_chunks\":                                                                                                       ","-          return await search_knowledge(skill_id, query, embedding, top_k)                                                                  ","-      elif table == \"cases\":                                                                                                                ","-          return await search_cases(skill_id, query, embedding, top_k, filters)                                                             ","-                                                                                                                                            ","-  4.4 知识库质量要求                                                                                                                        ","-  ┌────────────┬───────────────────┬──────────────────┐                                                                                     ","-  │    指标    │       目标        │       说明       │                                                                                     ","-  ├────────────┼───────────────────┼──────────────────┤                                                                                     ","-  │ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │                                                                                     ","-  ├────────────┼───────────────────┼──────────────────┤                                                                                     ","-  │ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │                                                                                     ","-  ├────────────┼───────────────────┼──────────────────┤                                                                                     ","-  │ 检索准确率 │ ≥70%              │ Top-5 结果相关   │                                                                                     ","-  └────────────┴───────────────────┴──────────────────┘                                                                                     ","-  ---                                                                                                                                       ","-  5. CoreAgent 调整                                                                                                                         ","-                                                                                                                                            ","-  5.1 System Prompt 构建                                                                                                                    ","-                                                                                                                                            ","-  def build_system_prompt(                                                                                                                  ","-      skill_id: str,                                                                                                                        ","-      user_context: Optional[Dict] = None                                                                                                   ","-  ) -> str:                                                                                                                                 ","-      \"\"\"                                                                                                                                   ","-      构建 System Prompt。                                                                                                                  ","-                                                                                                                                            ","-      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           ","-      \"\"\"                                                                                                                                   ","-      parts = []                                                                                                                            ","-                                                                                                                                            ","-      # 1. 加载 SKILL.md 全文                                                                                                               ","-      skill_md = load_skill_md(skill_id)                                                                                                    ","-      parts.append(skill_md)                                                                                                                ","-                                                                                                                                            ","-      # 2. 注入用户上下文 (如果有)                                                                                                          ","-      if user_context:                                                                                                                      ","-          ctx_text = format_user_context(user_context)                                                                                      ","-          parts.append(f\"\\n---\\n\\n## 用户上                                                              ","\\ No newline at end of file","+# Agentic Skill System 设计方案 v1.0","+","+版本: 1.0 | 日期: 2026-01-18","+状态: 设计稿","+","+---","+","+## 1. 概述","+","+### 1.1 背景","+","+当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：","+- 100+ 预定义 Scenario 文件","+- 触发词匹配路由","+- 固定 SOP 流程执行","+","+问题：","+- 场景数量爆炸，难以维护","+- 触发词冲突，路由不准确","+- LLM 抽取的 SOP 质量参差不齐","+- 缺乏灵活性，无法处理预定义之外的需求","+","+### 1.2 目标","+","+设计 Agentic + 分析框架 的新架构：","+- 删除 100+ Scenario 文件","+- LLM 自主理解用户意图，自主决策服务策略","+- 通过\"分析框架\"确保专业性和完整性","+- 知识库作为 RAG 支撑，按需检索","+","+### 1.3 核心原则","+","+┌──────────────┬──────────────────────────────────────┐","+│     原则     │                 说明                 │","+├──────────────┼──────────────────────────────────────┤","+│ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │","+├──────────────┼──────────────────────────────────────┤","+│ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │","+├──────────────┼──────────────────────────────────────┤","+│ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │","+├──────────────┼──────────────────────────────────────┤","+│ 工具优先     │ 用工具展示结果，而非纯文字           │","+└──────────────┴──────────────────────────────────────┘","+","+---","+","+## 2. 架构设计","+","+### 2.1 整体架构","+","+```","+┌─────────────────────────────────────────────────────────────────────┐","+│                    Agentic Skill System                             │","+├─────────────────────────────────────────────────────────────────────┤","+│                                                                     │","+│  ┌─────────────────────────────────────────────────────────────┐   │","+│  │                      SKILL.md (精简版)                       │   │","+│  │                                                              │   │","+│  │  • 专家身份 (Expert Persona)                                 │   │","+│  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │","+│  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │","+│  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │","+│  │  • 伦理边界 (Ethics)                                         │   │","+│  │                                                              │   │","+│  └─────────────────────────────────────────────────────────────┘   │","+│                              │                                      │","+│                              ▼                                      │","+│  ┌─────────────────────────────────────────────────────────────┐   │","+│  │                     CoreAgent (LLM)                          │   │","+│  │                                                              │   │","+│  │  System Prompt = SKILL.md + User Context                     │   │","+│  │                                                              │   │","+│  │  Agentic Loop:                                               │   │","+│  │  1. 理解用户意图                                             │   │","+│  │  2. 匹配核心能力，获取分析框架                               │   │","+│  │  3. 按框架规划分析步骤                                       │   │","+│  │  4. 按需检索知识 (search_db)                                 │   │","+│  │  5. 调用工具展示结果                                         │   │","+│  │  6. 引导后续对话                                             │   │","+│  │                                                              │   │","+│  └─────────────────────────────────────────────────────────────┘   │","+│                              │                                      │","+│              ┌───────────────┼───────────────┐                     │","+│              ▼               ▼               ▼                     │","+│         ┌────────┐     ┌──────────┐    ┌────────┐                 │","+│         │ Tools  │     │Knowledge │    │ Cases  │                 │","+│         │        │     │  (RAG)   │    │        │                 │","+│         └────────┘     └──────────┘    └────────┘                 │","+│                                                                     │","+└─────────────────────────────────────────────────────────────────────┘","+```","+","+### 2.2 与传统架构对比","+","+┌──────────┬──────────────────────────┬────────────────────────────────┐","+│   维度   │    传统 Scenario 架构    │          Agentic 架构          │","+├──────────┼──────────────────────────┼────────────────────────────────┤","+│ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │","+├──────────┼──────────────────────────┼────────────────────────────────┤","+│ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │","+├──────────┼──────────────────────────┼────────────────────────────────┤","+│ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │","+├──────────┼──────────────────────────┼────────────────────────────────┤","+│ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │","+├──────────┼──────────────────────────┼────────────────────────────────┤","+│ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │","+├──────────┼──────────────────────────┼────────────────────────────────┤","+│ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │","+├──────────┼──────────────────────────┼────────────────────────────────┤","+│ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │","+└──────────┴──────────────────────────┴────────────────────────────────┘","+","+### 2.3 目录结构变化","+","+```","+# 变更前","+skills/bazi/","+├── SKILL.md                    # 复杂，包含场景目录","+├── scenarios/                  # 100+ 场景文件","+│   ├── basic_reading.md","+│   ├── career.md","+│   ├── relationship.md","+│   └── ... (100+ files)","+└── tools/","+    ├── tools.yaml","+    └── handlers.py","+","+# 变更后","+skills/bazi/","+├── SKILL.md                    # 精简版，包含分析框架","+├── scenarios/                  # 删除或归档","+└── tools/","+    ├── tools.yaml","+    └── handlers.py","+```","+","+---","+","+## 3. SKILL.md 模板设计","+","+### 3.1 结构概览","+","+```yaml","+---","+id: {skill_id}","+name: {skill_name}","+version: {version}","+description: {description}","+---","+```","+","+```markdown","+# {Skill Name}","+","+## 专家身份","+","+## 核心能力与分析框架","+","+## 工具列表与调用指南","+","+## 知识检索指南","+","+## 服务原则","+","+## 伦理边界","+```","+","+### 3.2 Bazi SKILL.md 完整示例","+","+```yaml","+---","+id: bazi","+name: 八字命理","+version: 3.0.0","+description: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师","+---","+```","+","+# 八字命理 Skill","+","+## 专家身份","+","+我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。","+","+**核心理念**：","+- 以用神为纲、调候为急、格局为本、十神生克为用","+- 不故弄玄虚，用现代语言解读古老智慧","+- 命理是趋势分析，不是宿命论","+","+**知识来源优先级**：","+1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）","+2. 知识库检索结果","+3. 实战验证案例","+4. 通用命理知识","+","+---","+","+## 核心能力与分析框架","+","+### 能力 1: 命盘解读","+","+**适用场景**: 用户想了解自己的命盘、第一次算命、基础分析","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |","+| 2 | 格局识别 | \"{日主} {月令} 格局\" |","+| 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |","+| 4 | 关键十神状态 | 根据命盘特点检索 |","+","+**输出要求**:","+- 必须调用 `show_bazi_chart` 展示命盘","+- 必须调用 `show_insight` 展示核心洞察（不超过 4 点）","+- 引导用户深入探索","+","+---","+","+### 能力 2: 事业分析","+","+**适用场景**: 事业发展、职业方向、跳槽时机、升职","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 官杀状态 | \"官杀分析 事业\" |","+| 2 | 财星状态 | \"财星分析 收入\" |","+| 3 | 印星状态 | \"印星分析 贵人 学习\" |","+| 4 | 食伤状态 | \"食伤分析 才华 创业\" |","+| 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |","+| 6 | 时机建议 | 综合以上给出建议 |","+","+**输出要求**:","+- 调用 `show_bazi_chart` 展示命盘","+- 调用 `show_bazi_fortune` 展示大运流年","+- 调用 `show_insight` 展示事业洞察","+- 给出具体可操作的建议","+","+---","+","+### 能力 3: 感情婚姻","+","+**适用场景**: 感情运势、婚姻状况、桃花、配偶特征","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |","+| 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |","+| 3 | 桃花状态 | \"桃花 感情\" |","+| 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |","+| 5 | 婚姻建议 | 综合以上给出建议 |","+","+**性别差异**:","+- 男命: 正财为妻星，偏财为情人","+- 女命: 正官为夫星，七杀为情人","+","+---","+","+### 能力 4: 财运分析","+","+**适用场景**: 财运走势、投资方向、求财时机","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 财星状态 | \"正财 偏财 财运\" |","+| 2 | 财星与日主关系 | \"身强/身弱 财运\" |","+| 3 | 食伤生财 | \"食伤生财 求财方式\" |","+| 4 | 大运流年财运 | \"{大运} {流年} 财运\" |","+| 5 | 求财建议 | 综合以上给出建议 |","+","+---","+","+### 能力 5: 运势预测","+","+**适用场景**: 大运分析、流年运势、特定年份预测","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 大运主题 | \"{大运干支} 大运 主题\" |","+| 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |","+| 3 | 大运流年交互 | \"大运流年 交互 影响\" |","+| 4 | 关键月份 | 根据流年地支判断 |","+| 5 | 趋吉避凶建议 | 综合以上给出建议 |","+","+**输出要求**:","+- 必须调用 `show_bazi_fortune` 展示大运流年","+- 可选调用 `show_bazi_kline` 展示运势趋势图","+","+---","+","+### 能力 6: 合婚配对","+","+**适用场景**: 双方八字合婚、配对分析","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 日主配合 | \"合婚 日主 配合\" |","+| 2 | 用神互补 | \"合婚 用神 互补\" |","+| 3 | 年柱纳音 | \"合婚 纳音 年柱\" |","+| 4 | 冲合关系 | \"合婚 冲合 地支\" |","+| 5 | 综合评分 | 综合以上给出评分和建议 |","+","+**前置要求**: 必须收集双方出生信息","+","+---","+","+## 工具列表与调用指南","+","+### 信息收集工具","+","+| 工具 | 用途 | 何时调用 |","+|-----|------|---------|","+| `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |","+| `request_info` | 请求补充信息 | 需要更多信息时 |","+","+### 计算工具","+","+| 工具 | 用途 | 何时调用 |","+|-----|------|---------|","+| `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |","+","+### 展示工具","+","+| 工具 | 用途 | 何时调用 |","+|-----|------|---------|","+| `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |","+| `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |","+| `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |","+| `show_insight` | 展示洞察卡片 | 总结分析结果时 |","+| `show_report` | 展示完整报告 | 深度分析完成时 |","+","+### 检索工具","+","+| 工具 | 用途 | 何时调用 |","+|-----|------|---------|","+| `search_db` | 检索知识/案例 | 需要专业知识支撑时 |","+","+### 调用原则","+","+1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集","+2. **检索支撑**: 分析前先 `search_db` 获取相关知识","+3. **工具展示**: 用工具呈现结果，比纯文字更直观","+4. **框架完整**: 按分析框架覆盖所有要点","+","+---","+","+## 知识检索指南","+","+### 检索策略","+","+1. 理论知识: query = \"{概念} 理论 原理\"","+2. 分析方法: query = \"{主题} 分析方法 步骤\"","+3. 规则依据: query = \"{主题} 规则 原则\"","+4. 参考案例: query = \"{特征} 案例\"","+5. 经典引用: query = \"{书名} {主题}\"","+","+### 检索示例","+","+| 需要什么 | query 示例 |","+|---------|-----------|","+| 日主强弱理论 | \"日主强弱 判断方法\" |","+| 格局判断方法 | \"格局 判断 正格 变格\" |","+| 用神取用规则 | \"用神 取用 扶抑 调候\" |","+| 十神生克规则 | \"十神 生克 关系\" |","+| 事业分析案例 | \"官杀 事业 案例\" |","+| 经典引用 | \"滴天髓 用神\" |","+","+### 检索原则","+","+1. **不确定时先检索**: 专业问题先查知识库","+2. **query 要具体**: 描述清楚需要什么","+3. **多次检索**: 复杂问题可分多次检索","+4. **结果作为依据**: 检索结果用于支撑分析","+","+---","+","+## 服务原则","+","+### 1. 框架完整","+按分析框架覆盖关键要点，不遗漏重要分析。","+","+### 2. 知识支撑","+重要结论必须有知识库检索结果支撑，不凭空编造。","+","+### 3. 工具优先","+用工具展示结果（命盘图、洞察卡片），而非纯文字描述。","+","+### 4. 引导深入","+分析后引导用户探索更多方面，提供后续选项。","+","+### 5. 语言亲和","+用现代语言解读，避免过多术语，必要时解释专业概念。","+","+---","+","+## 伦理边界","+","+### 绝对禁止","+- 预测具体事件发生的确切日期","+- 给出\"命中注定\"的定论","+- 涉及健康诊断的具体预测","+- 替用户做重大人生决定","+- 预测死亡、重大灾难","+","+### 表达原则","+- 命理是趋势分析，不是宿命论","+- 困难时期是成长机会，不是灾难预言","+- 人的主观能动性可以改变命运轨迹","+- 提供建议而非决定","+","+### 敏感话题处理","+","+| 话题 | 处理方式 |","+|-----|---------|","+| 健康 | 只分析五行倾向，建议咨询医生 |","+| 寿命 | 不预测，转向生活质量建议 |","+| 灾难 | 转化为\"需要注意的时期\" |","+| 离婚 | 分析挑战，提供改善建议 |","+","+### 3.3 Zodiac SKILL.md 完整示例","+","+```yaml","+---","+id: zodiac","+name: 西方占星","+version: 3.0.0","+description: 融合现代心理占星与传统占星的专业占星师","+---","+```","+","+# 西方占星 Skill","+","+## 专家身份","+","+我是融合现代心理占星与传统占星的专业占星师。","+","+**核心理念**：","+- 星盘是潜能地图，不是命运判决书","+- 行星能量可以有多种表达方式","+- 占星是自我认知的工具","+","+**知识来源优先级**：","+1. 知识库检索结果","+2. 心理占星理论","+3. 传统占星规则","+4. 通用占星知识","+","+---","+","+## 核心能力与分析框架","+","+### 能力 1: 本命盘解读","+","+**适用场景**: 了解自己的星盘、性格分析、人生主题","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |","+| 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |","+| 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |","+| 4 | 主要相位 | \"{相位类型} 相位 含义\" |","+| 5 | 宫位分布 | 根据星盘特点检索 |","+","+**输出要求**:","+- 必须调用 `show_zodiac_chart` 展示星盘","+- 必须调用 `show_insight` 展示核心洞察","+","+---","+","+### 能力 2: 行运分析","+","+**适用场景**: 当前运势、行星过境影响、时机选择","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |","+| 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |","+| 3 | 影响领域 | 根据宫位判断 |","+| 4 | 时间周期 | 根据行星速度判断 |","+| 5 | 应对建议 | 综合以上给出建议 |","+","+**输出要求**:","+- 调用 `show_zodiac_transit` 展示行运","+- 调用 `show_insight` 展示行运洞察","+","+---","+","+### 能力 3: 合盘分析","+","+**适用场景**: 感情配对、关系分析、合作关系","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |","+| 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |","+| 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |","+| 4 | 宫位重叠 | \"合盘 宫位 重叠\" |","+| 5 | 综合评估 | 综合以上给出评估 |","+","+**输出要求**:","+- 调用 `show_zodiac_synastry` 展示合盘","+- 调用 `show_insight` 展示关系洞察","+","+---","+","+### 能力 4: 流年预测","+","+**适用场景**: 年度运势、太阳回归、重要时间点","+","+**分析框架** (必须覆盖):","+| 步骤 | 分析要点 | 知识检索 query |","+|-----|---------|---------------|","+| 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |","+| 2 | 外行星行运 | \"{行星} 行运 {年份}\" |","+| 3 | 日月食影响 | \"日月食 {星座} 影响\" |","+| 4 | 关键时间点 | 根据行运判断 |","+| 5 | 年度建议 | 综合以上给出建议 |","+","+---","+","+## 工具列表与调用指南","+","+### 信息收集工具","+","+| 工具 | 用途 | 何时调用 |","+|-----|------|---------|","+| `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |","+","+### 展示工具","+","+| 工具 | 用途 | 何时调用 |","+|-----|------|---------|","+| `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |","+| `show_zodiac_transit` | 展示行运 | 用户问运势时 |","+| `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |","+| `show_insight` | 展示洞察 | 总结分析时 |","+","+### 检索工具","+","+| 工具 | 用途 | 何时调用 |","+|-----|------|---------|","+| `search_db` | 检索知识 | 需要专业知识时 |","+","+---","+","+## 知识检索指南","+","+| 需要什么 | query 示例 |","+|---------|-----------|","+| 星座特质 | \"{星座} 特质 性格\" |","+| 行星含义 | \"{行星} 含义 能量\" |","+| 相位解读 | \"{相位} 解读 影响\" |","+| 宫位意义 | \"第{N}宫 意义 领域\" |","+| 行运影响 | \"{行星} 过境 {宫位}\" |","+","+---","+","+## 服务原则","+","+1. **框架完整**: 按分析框架覆盖关键要点","+2. **知识支撑**: 重要结论有检索结果支撑","+3. **工具优先**: 用工具展示星盘和洞察","+4. **心理导向**: 强调自我认知和成长","+","+---","+","+## 伦理边界","+","+### 绝对禁止","+- 预测具体事件日期","+- 给出宿命论断言","+- 健康诊断预测","+- 替用户做决定","+","+### 表达原则","+- 星盘是潜能地图，不是命运判决","+- 行星能量有多种表达方式","+- 强调自由意志和选择","+","+---","+","+## 4. 知识库设计","+","+### 4.1 知识库角色转变","+","+传统角色: Scenario 指定检索 → 固定知识","+新角色: LLM 按需检索 → 动态知识支撑","+","+### 4.2 知识库结构","+","+```sql","+-- knowledge_chunks 表 (保持不变)","+CREATE TABLE knowledge_chunks (","+    id              UUID PRIMARY KEY,","+    skill_id        VARCHAR(50) NOT NULL,","+    document_id     UUID REFERENCES knowledge_documents(id),","+    chunk_index     INT NOT NULL,","+    content         TEXT NOT NULL,","+    section_path    TEXT,","+    section_title   VARCHAR(255),","+    embedding       VECTOR(1024),","+    search_text_preprocessed TEXT,","+    metadata        JSONB,","+    created_at      TIMESTAMP DEFAULT NOW()","+);","+","+-- cases 表 (保持不变)","+CREATE TABLE cases (","+    id              VARCHAR(50) PRIMARY KEY,","+    skill_id        VARCHAR(50) NOT NULL,","+    scenario_ids    VARCHAR[],  -- 可选，用于分类","+    name            VARCHAR(255) NOT NULL,","+    core_data       JSONB NOT NULL,","+    features        JSONB NOT NULL,","+    tags            VARCHAR[] NOT NULL,","+    analysis        JSONB NOT NULL,","+    conclusion      JSONB NOT NULL,","+    authority       VARCHAR(20) DEFAULT 'medium',","+    created_at      TIMESTAMP DEFAULT NOW()","+);","+```","+","+### 4.3 检索接口","+","+```python","+# search_db 工具实现","+async def search_db(","+    table: str,           # \"knowledge_chunks\" 或 \"cases\"","+    query: str,           # LLM 描述的检索需求","+    skill_id: str,        # 限定 skill","+    top_k: int = 5,       # 返回数量","+    filters: dict = None  # 可选过滤条件","+) -> List[Dict]:","+    \"\"\"","+    语义检索知识或案例。","+","+    LLM 通过 query 描述需求，向量检索返回相关内容。","+    \"\"\"","+    embedding = await embed(query)","+","+    if table == \"knowledge_chunks\":","+        return await search_knowledge(skill_id, query, embedding, top_k)","+    elif table == \"cases\":","+        return await search_cases(skill_id, query, embedding, top_k, filters)","+```","+","+### 4.4 知识库质量要求","+","+┌────────────┬───────────────────┬──────────────────┐","+│    指标    │       目标        │       说明       │","+├────────────┼───────────────────┼──────────────────┤","+│ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │","+├────────────┼───────────────────┼──────────────────┤","+│ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │","+├────────────┼───────────────────┼──────────────────┤","+│ 检索准确率 │ ≥70%              │ Top-5 结果相关   │","+└────────────┴───────────────────┴──────────────────┘","+","+---","+","+## 5. CoreAgent 调整","+","+### 5.1 System Prompt 构建","+","+```python","+def build_system_prompt(","+    skill_id: str,","+    user_context: Optional[Dict] = None","+) -> str:","+    \"\"\"","+    构建 System Prompt。","+","+    变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。","+    \"\"\"","+    parts = []","+","+    # 1. 加载 SKILL.md 全文","+    skill_md = load_skill_md(skill_id)","+    parts.append(skill_md)","+","+    # 2. 注入用户上下文 (如果有)","+    if user_context:","+        ctx_text = format_user_context(user_context)","+        parts.append(f\"\\n---\\n\\n## 用户上下文\\n\\n{ctx_text}\")","+","+    return \"\\n\".join(parts)","+```"]}],"originalFile":"Agentic Skill System 设计方案 v1.0                                                                                                        \n                                                                                                                                            \n  版本: 1.0 | 日期: 2026-01-18                                                                                                              \n  状态: 设计稿                                                                                                                              \n                                                                                                                                            \n  ---                                                                                                                                       \n  1. 概述                                                                                                                                   \n                                                                                                                                            \n  1.1 背景                                                                                                                                  \n                                                                                                                                            \n  当前 VibeLife 的 Skill 系统采用 Scenario 驱动 架构：                                                                                      \n  - 100+ 预定义 Scenario 文件                                                                                                               \n  - 触发词匹配路由                                                                                                                          \n  - 固定 SOP 流程执行                                                                                                                       \n                                                                                                                                            \n  问题：                                                                                                                                    \n  - 场景数量爆炸，难以维护                                                                                                                  \n  - 触发词冲突，路由不准确                                                                                                                  \n  - LLM 抽取的 SOP 质量参差不齐                                                                                                             \n  - 缺乏灵活性，无法处理预定义之外的需求                                                                                                    \n                                                                                                                                            \n  1.2 目标                                                                                                                                  \n                                                                                                                                            \n  设计 Agentic + 分析框架 的新架构：                                                                                                        \n  - 删除 100+ Scenario 文件                                                                                                                 \n  - LLM 自主理解用户意图，自主决策服务策略                                                                                                  \n  - 通过\"分析框架\"确保专业性和完整性                                                                                                        \n  - 知识库作为 RAG 支撑，按需检索                                                                                                           \n                                                                                                                                            \n  1.3 核心原则                                                                                                                              \n  ┌──────────────┬──────────────────────────────────────┐                                                                                   \n  │     原则     │                 说明                 │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ Agentic 决策 │ LLM 自主理解意图、规划步骤、调用工具 │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ 框架保障     │ 分析框架确保覆盖关键要点，不遗漏     │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ 知识驱动     │ 通过 RAG 检索专业知识，而非硬编码    │                                                                                   \n  ├──────────────┼──────────────────────────────────────┤                                                                                   \n  │ 工具优先     │ 用工具展示结果，而非纯文字           │                                                                                   \n  └──────────────┴──────────────────────────────────────┘                                                                                   \n  ---                                                                                                                                       \n  2. 架构设计                                                                                                                               \n                                                                                                                                            \n  2.1 整体架构                                                                                                                              \n                                                                                                                                            \n  ┌─────────────────────────────────────────────────────────────────────┐                                                                   \n  │                    Agentic Skill System                             │                                                                   \n  ├─────────────────────────────────────────────────────────────────────┤                                                                   \n  │                                                                     │                                                                   \n  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    \n  │  │                      SKILL.md (精简版)                       │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  │  • 专家身份 (Expert Persona)                                 │   │                                                                   \n  │  │  • 核心能力 + 分析框架 (Capabilities + Frameworks)           │   │                                                                   \n  │  │  • 工具列表 + 调用指南 (Tools + Guidelines)                  │   │                                                                   \n  │  │  • 知识检索指南 (Knowledge Retrieval Guide)                  │   │                                                                   \n  │  │  • 伦理边界 (Ethics)                                         │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  └─────────────────────────────────────────────────────────────┘   │                                                                    \n  │                              │                                      │                                                                   \n  │                              ▼                                      │                                                                   \n  │  ┌─────────────────────────────────────────────────────────────┐   │                                                                    \n  │  │                     CoreAgent (LLM)                          │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  │  System Prompt = SKILL.md + User Context                     │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  │  Agentic Loop:                                               │   │                                                                   \n  │  │  1. 理解用户意图                                             │   │                                                                   \n  │  │  2. 匹配核心能力，获取分析框架                               │   │                                                                   \n  │  │  3. 按框架规划分析步骤                                       │   │                                                                   \n  │  │  4. 按需检索知识 (search_db)                                 │   │                                                                   \n  │  │  5. 调用工具展示结果                                         │   │                                                                   \n  │  │  6. 引导后续对话                                             │   │                                                                   \n  │  │                                                              │   │                                                                   \n  │  └─────────────────────────────────────────────────────────────┘   │                                                                    \n  │                              │                                      │                                                                   \n  │              ┌───────────────┼───────────────┐                     │                                                                    \n  │              ▼               ▼               ▼                     │                                                                    \n  │         ┌────────┐     ┌──────────┐    ┌────────┐                 │                                                                     \n  │         │ Tools  │     │Knowledge │    │ Cases  │                 │                                                                     \n  │         │        │     │  (RAG)   │    │        │                 │                                                                     \n  │         └────────┘     └──────────┘    └────────┘                 │                                                                     \n  │                                                                     │                                                                   \n  └─────────────────────────────────────────────────────────────────────┘                                                                   \n                                                                                                                                            \n  2.2 与传统架构对比                                                                                                                        \n  ┌──────────┬──────────────────────────┬────────────────────────────────┐                                                                  \n  │   维度   │    传统 Scenario 架构    │          Agentic 架构          │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 场景定义 │ 100+ 预定义 .md 文件     │ 0 个，LLM 自主决策             │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 路由方式 │ 触发词关键词匹配         │ LLM 语义理解                   │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 服务流程 │ 预定义 SOP 步骤          │ LLM 根据分析框架自主规划       │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 知识使用 │ Scenario 指定检索        │ 按需语义检索                   │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 灵活性   │ 低（只能处理预定义场景） │ 高（任意组合）                 │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 维护成本 │ 高（每个场景都要维护）   │ 低（只维护 SKILL.md + 知识库） │                                                                  \n  ├──────────┼──────────────────────────┼────────────────────────────────┤                                                                  \n  │ 质量保障 │ 通过 SOP 硬编码          │ 通过分析框架 + 知识库质量      │                                                                  \n  └──────────┴──────────────────────────┴────────────────────────────────┘                                                                  \n  2.3 目录结构变化                                                                                                                          \n                                                                                                                                            \n  # 变更前                                                                                                                                  \n  skills/bazi/                                                                                                                              \n  ├── SKILL.md                    # 复杂，包含场景目录                                                                                      \n  ├── scenarios/                  # 100+ 场景文件                                                                                           \n  │   ├── basic_reading.md                                                                                                                  \n  │   ├── career.md                                                                                                                         \n  │   ├── relationship.md                                                                                                                   \n  │   └── ... (100+ files)                                                                                                                  \n  └── tools/                                                                                                                                \n      ├── tools.yaml                                                                                                                        \n      └── handlers.py                                                                                                                       \n                                                                                                                                            \n  # 变更后                                                                                                                                  \n  skills/bazi/                                                                                                                              \n  ├── SKILL.md                    # 精简版，包含分析框架                                                                                    \n  ├── scenarios/                  # 删除或归档                                                                                              \n  └── tools/                                                                                                                                \n      ├── tools.yaml                                                                                                                        \n      └── handlers.py                                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n  3. SKILL.md 模板设计                                                                                                                      \n                                                                                                                                            \n  3.1 结构概览                                                                                                                              \n                                                                                                                                            \n  ---                                                                                                                                       \n  id: {skill_id}                                                                                                                            \n  name: {skill_name}                                                                                                                        \n  version: {version}                                                                                                                        \n  description: {description}                                                                                                                \n  ---                                                                                                                                       \n                                                                                                                                            \n  # {Skill Name}                                                                                                                            \n                                                                                                                                            \n  ## 专家身份                                                                                                                               \n                                                                                                                                            \n  ## 核心能力与分析框架                                                                                                                     \n                                                                                                                                            \n  ## 工具列表与调用指南                                                                                                                     \n                                                                                                                                            \n  ## 知识检索指南                                                                                                                           \n                                                                                                                                            \n  ## 服务原则                                                                                                                               \n                                                                                                                                            \n  ## 伦理边界                                                                                                                               \n                                                                                                                                            \n  3.2 Bazi SKILL.md 完整示例                                                                                                                \n                                                                                                                                            \n  ---                                                                                                                                       \n  id: bazi                                                                                                                                  \n  name: 八字命理                                                                                                                            \n  version: 3.0.0                                                                                                                            \n  description: 融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》的八字命理大师                                                       \n  ---                                                                                                                                       \n                                                                                                                                            \n  # 八字命理 Skill                                                                                                                          \n                                                                                                                                            \n  ## 专家身份                                                                                                                               \n                                                                                                                                            \n  我是融汇《滴天髓》《穷通宝鉴》《子平真诠》《东方代码启示录》四大经典的八字命理宗师。                                                      \n                                                                                                                                            \n  **核心理念**：                                                                                                                            \n  - 以用神为纲、调候为急、格局为本、十神生克为用                                                                                            \n  - 不故弄玄虚，用现代语言解读古老智慧                                                                                                      \n  - 命理是趋势分析，不是宿命论                                                                                                              \n                                                                                                                                            \n  **知识来源优先级**：                                                                                                                      \n  1. 经典著作（滴天髓、穷通宝鉴、子平真诠、东方代码启示录）                                                                                 \n  2. 知识库检索结果                                                                                                                         \n  3. 实战验证案例                                                                                                                           \n  4. 通用命理知识                                                                                                                           \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 核心能力与分析框架                                                                                                                     \n                                                                                                                                            \n  ### 能力 1: 命盘解读                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 用户想了解自己的命盘、第一次算命、基础分析                                                                                  \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 日主强弱判断 | \"{日主}日主 {月令} 强弱判断\" |                                                                                       \n  | 2 | 格局识别 | \"{日主} {月令} 格局\" |                                                                                                   \n  | 3 | 用神取用 | \"{日主} {月令} 用神 调候\" |                                                                                              \n  | 4 | 关键十神状态 | 根据命盘特点检索 |                                                                                                   \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 必须调用 `show_bazi_chart` 展示命盘                                                                                                     \n  - 必须调用 `show_insight` 展示核心洞察（不超过 4 点）                                                                                     \n  - 引导用户深入探索                                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 2: 事业分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 事业发展、职业方向、跳槽时机、升职                                                                                          \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 官杀状态 | \"官杀分析 事业\" |                                                                                                        \n  | 2 | 财星状态 | \"财星分析 收入\" |                                                                                                        \n  | 3 | 印星状态 | \"印星分析 贵人 学习\" |                                                                                                   \n  | 4 | 食伤状态 | \"食伤分析 才华 创业\" |                                                                                                   \n  | 5 | 大运流年影响 | \"{当前大运} {流年} 事业\" |                                                                                           \n  | 6 | 时机建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 调用 `show_bazi_chart` 展示命盘                                                                                                         \n  - 调用 `show_bazi_fortune` 展示大运流年                                                                                                   \n  - 调用 `show_insight` 展示事业洞察                                                                                                        \n  - 给出具体可操作的建议                                                                                                                    \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 3: 感情婚姻                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 感情运势、婚姻状况、桃花、配偶特征                                                                                          \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 夫妻宫状态 | \"日支 夫妻宫 婚姻\" |                                                                                                   \n  | 2 | 配偶星状态 | \"正财/正官 配偶星\" (男/女) |                                                                                           \n  | 3 | 桃花状态 | \"桃花 感情\" |                                                                                                            \n  | 4 | 大运流年影响 | \"{大运} {流年} 感情 婚姻\" |                                                                                          \n  | 5 | 婚姻建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  **性别差异**:                                                                                                                             \n  - 男命: 正财为妻星，偏财为情人                                                                                                            \n  - 女命: 正官为夫星，七杀为情人                                                                                                            \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 4: 财运分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 财运走势、投资方向、求财时机                                                                                                \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 财星状态 | \"正财 偏财 财运\" |                                                                                                       \n  | 2 | 财星与日主关系 | \"身强/身弱 财运\" |                                                                                                 \n  | 3 | 食伤生财 | \"食伤生财 求财方式\" |                                                                                                    \n  | 4 | 大运流年财运 | \"{大运} {流年} 财运\" |                                                                                               \n  | 5 | 求财建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 5: 运势预测                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 大运分析、流年运势、特定年份预测                                                                                            \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 大运主题 | \"{大运干支} 大运 主题\" |                                                                                                 \n  | 2 | 流年细节 | \"{流年干支} 流年 {日主}\" |                                                                                               \n  | 3 | 大运流年交互 | \"大运流年 交互 影响\" |                                                                                               \n  | 4 | 关键月份 | 根据流年地支判断 |                                                                                                       \n  | 5 | 趋吉避凶建议 | 综合以上给出建议 |                                                                                                   \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 必须调用 `show_bazi_fortune` 展示大运流年                                                                                               \n  - 可选调用 `show_bazi_kline` 展示运势趋势图                                                                                               \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 6: 合婚配对                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 双方八字合婚、配对分析                                                                                                      \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 日主配合 | \"合婚 日主 配合\" |                                                                                                       \n  | 2 | 用神互补 | \"合婚 用神 互补\" |                                                                                                       \n  | 3 | 年柱纳音 | \"合婚 纳音 年柱\" |                                                                                                       \n  | 4 | 冲合关系 | \"合婚 冲合 地支\" |                                                                                                       \n  | 5 | 综合评分 | 综合以上给出评分和建议 |                                                                                                 \n                                                                                                                                            \n  **前置要求**: 必须收集双方出生信息                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 工具列表与调用指南                                                                                                                     \n                                                                                                                                            \n  ### 信息收集工具                                                                                                                          \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `collect_bazi_info` | 收集出生信息 | 用户未提供生辰时 |                                                                                 \n  | `request_info` | 请求补充信息 | 需要更多信息时 |                                                                                        \n                                                                                                                                            \n  ### 计算工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `calculate_bazi` | 计算八字命盘 | 内部计算，用户不可见 |                                                                                \n                                                                                                                                            \n  ### 展示工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `show_bazi_chart` | 展示命盘图 | 用户想看命盘时 |                                                                                       \n  | `show_bazi_fortune` | 展示大运流年 | 用户问运势时 |                                                                                     \n  | `show_bazi_kline` | 展示运势K线 | 用户想看趋势时 |                                                                                      \n  | `show_insight` | 展示洞察卡片 | 总结分析结果时 |                                                                                        \n  | `show_report` | 展示完整报告 | 深度分析完成时 |                                                                                         \n                                                                                                                                            \n  ### 检索工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `search_db` | 检索知识/案例 | 需要专业知识支撑时 |                                                                                      \n                                                                                                                                            \n  ### 调用原则                                                                                                                              \n                                                                                                                                            \n  1. **信息优先**: 用户已有出生信息时，直接分析，无需再次收集                                                                               \n  2. **检索支撑**: 分析前先 `search_db` 获取相关知识                                                                                        \n  3. **工具展示**: 用工具呈现结果，比纯文字更直观                                                                                           \n  4. **框架完整**: 按分析框架覆盖所有要点                                                                                                   \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 知识检索指南                                                                                                                           \n                                                                                                                                            \n  ### 检索策略                                                                                                                              \n                                                                                                                                            \n  1. 理论知识: query = \"{概念} 理论 原理\"                                                                                                   \n  2. 分析方法: query = \"{主题} 分析方法 步骤\"                                                                                               \n  3. 规则依据: query = \"{主题} 规则 原则\"                                                                                                   \n  4. 参考案例: query = \"{特征} 案例\"                                                                                                        \n  5. 经典引用: query = \"{书名} {主题}\"                                                                                                      \n                                                                                                                                            \n  ### 检索示例                                                                                                                              \n                                                                                                                                            \n  | 需要什么 | query 示例 |                                                                                                                 \n  |---------|-----------|                                                                                                                   \n  | 日主强弱理论 | \"日主强弱 判断方法\" |                                                                                                    \n  | 格局判断方法 | \"格局 判断 正格 变格\" |                                                                                                  \n  | 用神取用规则 | \"用神 取用 扶抑 调候\" |                                                                                                  \n  | 十神生克规则 | \"十神 生克 关系\" |                                                                                                       \n  | 事业分析案例 | \"官杀 事业 案例\" |                                                                                                       \n  | 经典引用 | \"滴天髓 用神\" |                                                                                                              \n                                                                                                                                            \n  ### 检索原则                                                                                                                              \n                                                                                                                                            \n  1. **不确定时先检索**: 专业问题先查知识库                                                                                                 \n  2. **query 要具体**: 描述清楚需要什么                                                                                                     \n  3. **多次检索**: 复杂问题可分多次检索                                                                                                     \n  4. **结果作为依据**: 检索结果用于支撑分析                                                                                                 \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 服务原则                                                                                                                               \n                                                                                                                                            \n  ### 1. 框架完整                                                                                                                           \n  按分析框架覆盖关键要点，不遗漏重要分析。                                                                                                  \n                                                                                                                                            \n  ### 2. 知识支撑                                                                                                                           \n  重要结论必须有知识库检索结果支撑，不凭空编造。                                                                                            \n                                                                                                                                            \n  ### 3. 工具优先                                                                                                                           \n  用工具展示结果（命盘图、洞察卡片），而非纯文字描述。                                                                                      \n                                                                                                                                            \n  ### 4. 引导深入                                                                                                                           \n  分析后引导用户探索更多方面，提供后续选项。                                                                                                \n                                                                                                                                            \n  ### 5. 语言亲和                                                                                                                           \n  用现代语言解读，避免过多术语，必要时解释专业概念。                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 伦理边界                                                                                                                               \n                                                                                                                                            \n  ### 绝对禁止                                                                                                                              \n  - 预测具体事件发生的确切日期                                                                                                              \n  - 给出\"命中注定\"的定论                                                                                                                    \n  - 涉及健康诊断的具体预测                                                                                                                  \n  - 替用户做重大人生决定                                                                                                                    \n  - 预测死亡、重大灾难                                                                                                                      \n                                                                                                                                            \n  ### 表达原则                                                                                                                              \n  - 命理是趋势分析，不是宿命论                                                                                                              \n  - 困难时期是成长机会，不是灾难预言                                                                                                        \n  - 人的主观能动性可以改变命运轨迹                                                                                                          \n  - 提供建议而非决定                                                                                                                        \n                                                                                                                                            \n  ### 敏感话题处理                                                                                                                          \n  | 话题 | 处理方式 |                                                                                                                       \n  |-----|---------|                                                                                                                         \n  | 健康 | 只分析五行倾向，建议咨询医生 |                                                                                                   \n  | 寿命 | 不预测，转向生活质量建议 |                                                                                                       \n  | 灾难 | 转化为\"需要注意的时期\" |                                                                                                         \n  | 离婚 | 分析挑战，提供改善建议 |                                                                                                         \n                                                                                                                                            \n  3.3 Zodiac SKILL.md 完整示例                                                                                                              \n                                                                                                                                            \n  ---                                                                                                                                       \n  id: zodiac                                                                                                                                \n  name: 西方占星                                                                                                                            \n  version: 3.0.0                                                                                                                            \n  description: 融合现代心理占星与传统占星的专业占星师                                                                                       \n  ---                                                                                                                                       \n                                                                                                                                            \n  # 西方占星 Skill                                                                                                                          \n                                                                                                                                            \n  ## 专家身份                                                                                                                               \n                                                                                                                                            \n  我是融合现代心理占星与传统占星的专业占星师。                                                                                              \n                                                                                                                                            \n  **核心理念**：                                                                                                                            \n  - 星盘是潜能地图，不是命运判决书                                                                                                          \n  - 行星能量可以有多种表达方式                                                                                                              \n  - 占星是自我认知的工具                                                                                                                    \n                                                                                                                                            \n  **知识来源优先级**：                                                                                                                      \n  1. 知识库检索结果                                                                                                                         \n  2. 心理占星理论                                                                                                                           \n  3. 传统占星规则                                                                                                                           \n  4. 通用占星知识                                                                                                                           \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 核心能力与分析框架                                                                                                                     \n                                                                                                                                            \n  ### 能力 1: 本命盘解读                                                                                                                    \n                                                                                                                                            \n  **适用场景**: 了解自己的星盘、性格分析、人生主题                                                                                          \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 太阳星座 | \"{太阳星座} 太阳 核心自我\" |                                                                                             \n  | 2 | 月亮星座 | \"{月亮星座} 月亮 情感需求\" |                                                                                             \n  | 3 | 上升星座 | \"{上升星座} 上升 外在形象\" |                                                                                             \n  | 4 | 主要相位 | \"{相位类型} 相位 含义\" |                                                                                                 \n  | 5 | 宫位分布 | 根据星盘特点检索 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 必须调用 `show_zodiac_chart` 展示星盘                                                                                                   \n  - 必须调用 `show_insight` 展示核心洞察                                                                                                    \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 2: 行运分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 当前运势、行星过境影响、时机选择                                                                                            \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 外行星行运 | \"{行星} 过境 {宫位}\" |                                                                                                 \n  | 2 | 行运相位 | \"{行运行星} {相位} {本命行星}\" |                                                                                         \n  | 3 | 影响领域 | 根据宫位判断 |                                                                                                           \n  | 4 | 时间周期 | 根据行星速度判断 |                                                                                                       \n  | 5 | 应对建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 调用 `show_zodiac_transit` 展示行运                                                                                                     \n  - 调用 `show_insight` 展示行运洞察                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 3: 合盘分析                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 感情配对、关系分析、合作关系                                                                                                \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 日月相位 | \"合盘 日月 相位 情感基础\" |                                                                                              \n  | 2 | 金火相位 | \"合盘 金星 火星 吸引力\" |                                                                                                \n  | 3 | 土星相位 | \"合盘 土星 承诺 挑战\" |                                                                                                  \n  | 4 | 宫位重叠 | \"合盘 宫位 重叠\" |                                                                                                       \n  | 5 | 综合评估 | 综合以上给出评估 |                                                                                                       \n                                                                                                                                            \n  **输出要求**:                                                                                                                             \n  - 调用 `show_zodiac_synastry` 展示合盘                                                                                                    \n  - 调用 `show_insight` 展示关系洞察                                                                                                        \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ### 能力 4: 流年预测                                                                                                                      \n                                                                                                                                            \n  **适用场景**: 年度运势、太阳回归、重要时间点                                                                                              \n                                                                                                                                            \n  **分析框架** (必须覆盖):                                                                                                                  \n  | 步骤 | 分析要点 | 知识检索 query |                                                                                                      \n  |-----|---------|---------------|                                                                                                         \n  | 1 | 太阳回归盘 | \"太阳回归 {年份} 主题\" |                                                                                               \n  | 2 | 外行星行运 | \"{行星} 行运 {年份}\" |                                                                                                 \n  | 3 | 日月食影响 | \"日月食 {星座} 影响\" |                                                                                                 \n  | 4 | 关键时间点 | 根据行运判断 |                                                                                                         \n  | 5 | 年度建议 | 综合以上给出建议 |                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 工具列表与调用指南                                                                                                                     \n                                                                                                                                            \n  ### 信息收集工具                                                                                                                          \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `collect_zodiac_info` | 收集出生信息 | 用户未提供时 |                                                                                   \n                                                                                                                                            \n  ### 展示工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `show_zodiac_chart` | 展示本命盘 | 用户想看星盘时 |                                                                                     \n  | `show_zodiac_transit` | 展示行运 | 用户问运势时 |                                                                                       \n  | `show_zodiac_synastry` | 展示合盘 | 合盘分析时 |                                                                                        \n  | `show_insight` | 展示洞察 | 总结分析时 |                                                                                                \n                                                                                                                                            \n  ### 检索工具                                                                                                                              \n                                                                                                                                            \n  | 工具 | 用途 | 何时调用 |                                                                                                                \n  |-----|------|---------|                                                                                                                  \n  | `search_db` | 检索知识 | 需要专业知识时 |                                                                                               \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 知识检索指南                                                                                                                           \n                                                                                                                                            \n  | 需要什么 | query 示例 |                                                                                                                 \n  |---------|-----------|                                                                                                                   \n  | 星座特质 | \"{星座} 特质 性格\" |                                                                                                         \n  | 行星含义 | \"{行星} 含义 能量\" |                                                                                                         \n  | 相位解读 | \"{相位} 解读 影响\" |                                                                                                         \n  | 宫位意义 | \"第{N}宫 意义 领域\" |                                                                                                        \n  | 行运影响 | \"{行星} 过境 {宫位}\" |                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 服务原则                                                                                                                               \n                                                                                                                                            \n  1. **框架完整**: 按分析框架覆盖关键要点                                                                                                   \n  2. **知识支撑**: 重要结论有检索结果支撑                                                                                                   \n  3. **工具优先**: 用工具展示星盘和洞察                                                                                                     \n  4. **心理导向**: 强调自我认知和成长                                                                                                       \n                                                                                                                                            \n  ---                                                                                                                                       \n                                                                                                                                            \n  ## 伦理边界                                                                                                                               \n                                                                                                                                            \n  ### 绝对禁止                                                                                                                              \n  - 预测具体事件日期                                                                                                                        \n  - 给出宿命论断言                                                                                                                          \n  - 健康诊断预测                                                                                                                            \n  - 替用户做决定                                                                                                                            \n                                                                                                                                            \n  ### 表达原则                                                                                                                              \n  - 星盘是潜能地图，不是命运判决                                                                                                            \n  - 行星能量有多种表达方式                                                                                                                  \n  - 强调自由意志和选择                                                                                                                      \n                                                                                                                                            \n  ---                                                                                                                                       \n  4. 知识库设计                                                                                                                             \n                                                                                                                                            \n  4.1 知识库角色转变                                                                                                                        \n                                                                                                                                            \n  传统角色: Scenario 指定检索 → 固定知识                                                                                                    \n  新角色: LLM 按需检索 → 动态知识支撑                                                                                                       \n                                                                                                                                            \n  4.2 知识库结构                                                                                                                            \n                                                                                                                                            \n  -- knowledge_chunks 表 (保持不变)                                                                                                         \n  CREATE TABLE knowledge_chunks (                                                                                                           \n      id              UUID PRIMARY KEY,                                                                                                     \n      skill_id        VARCHAR(50) NOT NULL,                                                                                                 \n      document_id     UUID REFERENCES knowledge_documents(id),                                                                              \n      chunk_index     INT NOT NULL,                                                                                                         \n      content         TEXT NOT NULL,                                                                                                        \n      section_path    TEXT,                                                                                                                 \n      section_title   VARCHAR(255),                                                                                                         \n      embedding       VECTOR(1024),                                                                                                         \n      search_text_preprocessed TEXT,                                                                                                        \n      metadata        JSONB,                                                                                                                \n      created_at      TIMESTAMP DEFAULT NOW()                                                                                               \n  );                                                                                                                                        \n                                                                                                                                            \n  -- cases 表 (保持不变)                                                                                                                    \n  CREATE TABLE cases (                                                                                                                      \n      id              VARCHAR(50) PRIMARY KEY,                                                                                              \n      skill_id        VARCHAR(50) NOT NULL,                                                                                                 \n      scenario_ids    VARCHAR[],  -- 可选，用于分类                                                                                         \n      name            VARCHAR(255) NOT NULL,                                                                                                \n      core_data       JSONB NOT NULL,                                                                                                       \n      features        JSONB NOT NULL,                                                                                                       \n      tags            VARCHAR[] NOT NULL,                                                                                                   \n      analysis        JSONB NOT NULL,                                                                                                       \n      conclusion      JSONB NOT NULL,                                                                                                       \n      authority       VARCHAR(20) DEFAULT 'medium',                                                                                         \n      created_at      TIMESTAMP DEFAULT NOW()                                                                                               \n  );                                                                                                                                        \n                                                                                                                                            \n  4.3 检索接口                                                                                                                              \n                                                                                                                                            \n  # search_db 工具实现                                                                                                                      \n  async def search_db(                                                                                                                      \n      table: str,           # \"knowledge_chunks\" 或 \"cases\"                                                                                 \n      query: str,           # LLM 描述的检索需求                                                                                            \n      skill_id: str,        # 限定 skill                                                                                                    \n      top_k: int = 5,       # 返回数量                                                                                                      \n      filters: dict = None  # 可选过滤条件                                                                                                  \n  ) -> List[Dict]:                                                                                                                          \n      \"\"\"                                                                                                                                   \n      语义检索知识或案例。                                                                                                                  \n                                                                                                                                            \n      LLM 通过 query 描述需求，向量检索返回相关内容。                                                                                       \n      \"\"\"                                                                                                                                   \n      embedding = await embed(query)                                                                                                        \n                                                                                                                                            \n      if table == \"knowledge_chunks\":                                                                                                       \n          return await search_knowledge(skill_id, query, embedding, top_k)                                                                  \n      elif table == \"cases\":                                                                                                                \n          return await search_cases(skill_id, query, embedding, top_k, filters)                                                             \n                                                                                                                                            \n  4.4 知识库质量要求                                                                                                                        \n  ┌────────────┬───────────────────┬──────────────────┐                                                                                     \n  │    指标    │       目标        │       说明       │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 知识覆盖   │ ≥300 chunks/skill │ 覆盖所有核心能力 │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 案例数量   │ ≥50 cases/skill   │ 覆盖常见场景     │                                                                                     \n  ├────────────┼───────────────────┼──────────────────┤                                                                                     \n  │ 检索准确率 │ ≥70%              │ Top-5 结果相关   │                                                                                     \n  └────────────┴───────────────────┴──────────────────┘                                                                                     \n  ---                                                                                                                                       \n  5. CoreAgent 调整                                                                                                                         \n                                                                                                                                            \n  5.1 System Prompt 构建                                                                                                                    \n                                                                                                                                            \n  def build_system_prompt(                                                                                                                  \n      skill_id: str,                                                                                                                        \n      user_context: Optional[Dict] = None                                                                                                   \n  ) -> str:                                                                                                                                 \n      \"\"\"                                                                                                                                   \n      构建 System Prompt。                                                                                                                  \n                                                                                                                                            \n      变更: 不再注入 Scenario SOP，只注入 SKILL.md + 用户上下文。                                                                           \n      \"\"\"                                                                                                                                   \n      parts = []                                                                                                                            \n                                                                                                                                            \n      # 1. 加载 SKILL.md 全文                                                                                                               \n      skill_md = load_skill_md(skill_id)                                                                                                    \n      parts.append(skill_md)                                                                                                                \n                                                                                                                                            \n      # 2. 注入用户上下文 (如果有)                                                                                                          \n      if user_context:                                                                                                                      \n          ctx_text = format_user_context(user_context)                                                                                      \n          parts.append(f\"\\n---\\n\\n## 用户上                                                              "},"sourceToolAssistantUUID":"33db8ecf-752b-4806-999c-5b570f32634d"}
{"parentUuid":"db56a55f-0542-48a0-a570-030447d865ea","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AQkjvj5eS8P2eWWQByWV93","type":"message","role":"assistant","content":[{"type":"thinking","thinking":"格式已修复完成。主要修复包括：\n1. 添加了 `#` 标题标记\n2. 代码块用 ``` 包裹\n3. 修复了末尾被截断的代码（补全了 `用户上下文` 部分）\n\n文件格式现在是正确的 Markdown 了。","signature":"EooDCkYICxgCKkBNUsxMy3KaDt8mOEJTldNu1wYa0csvIbcZY5xUa8oIr1iVGtdBqz34KG+SIXeSxnr3eKjXaVOtqtXvV7Y6KLLgEgzFJxZqGPKE9dPUEjwaDBjImYgoFQNa8yBLdCIwt7z30cK4WOyBx7+lsqh9fqB+ar3FvxwIkcJkj6r2+6OjdRVP/79ImTuNmNoFDV/CKvEBBJaG+eEGf/fLC0FTR2SVP6XP5fUpdtpfTLSTSVKcrndM0ddRSz7c2ZcIruQ41rW10I8WJ59I60lz4GEBgLPqSi0+Fv+PAx+Tdl6QTQV3HiQVH3opgQSR8YdvRSY+G54FrSsey93PwG2ax/pF3zU9WwVgufonafyYUrNs3I/HMnFOY2CljhaFDPcIH/gg31RytZyT+8uFiO+/uq0ziMAGvU2r0F+sHd9BO2O35kuSJtGkytaqb4RNtRxRSWHC3m2o8YE6j0f977pXgRRrJg7OAphsX2jbG5FfNhRs5jIkXaSOH5oJ/ZAZd6RIOef6qAkMVRgB"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":20937,"cache_read_input_tokens":55590,"cache_creation":{"ephemeral_5m_input_tokens":20937,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWtFcHumv5cFK76VTbe","type":"assistant","uuid":"27fcfcea-26fd-4edf-bfde-3929c8e43988","timestamp":"2026-01-18T08:19:26.397Z"}
{"parentUuid":"27fcfcea-26fd-4edf-bfde-3929c8e43988","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AQkjvj5eS8P2eWWQByWV93","type":"message","role":"assistant","content":[{"type":"text","text":"格式修复完成。主要修复：\n1. 添加了 Markdown 标题标记（`#`、`##`、`###`）\n2. 代码块（架构图、目录结构、SQL、Python）用 ``` 包裹\n3. 修复了文件末尾被截断的代码（补全了 `用户上下文` 部分）"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":8,"cache_creation_input_tokens":20937,"cache_read_input_tokens":55590,"cache_creation":{"ephemeral_5m_input_tokens":20937,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CXEWtFcHumv5cFK76VTbe","type":"assistant","uuid":"ec33bbfd-7608-48f5-ac97-d3e3ccc66191","timestamp":"2026-01-18T08:19:28.245Z"}
{"parentUuid":"ec33bbfd-7608-48f5-ac97-d3e3ccc66191","isSidechain":false,"userType":"external","cwd":"/home/aiscend/work/vibelife","sessionId":"15e8430b-fe20-4571-896d-b38edc2ac427","version":"2.1.12","gitBranch":"master","slug":"glimmering-wandering-panda","type":"system","subtype":"turn_duration","durationMs":243264,"timestamp":"2026-01-18T08:19:28.341Z","uuid":"d1c29c54-4c80-43f6-8558-932521a44669","isMeta":false}
{"type":"summary","summary":"Fix Agentic Skill System Design Doc Formatting","leafUuid":"ec33bbfd-7608-48f5-ac97-d3e3ccc66191"}
