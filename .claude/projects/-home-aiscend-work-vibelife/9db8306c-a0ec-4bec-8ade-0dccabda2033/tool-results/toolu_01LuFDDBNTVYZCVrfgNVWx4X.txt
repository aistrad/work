     1â†’"""
     2â†’SkillLoader v9 - æ¸è¿›å¼ Skill åŠ è½½å™¨
     3â†’
     4â†’v9 æ¶æ„ï¼ˆéµå¾ª Claude Agent SDK åŸåˆ™ï¼‰ï¼š
     5â†’- Core Skill å…¨ç¨‹æ¿€æ´»ï¼Œå…¨æ–‡åŠ è½½
     6â†’- å…¶ä»– Skill æ¸è¿›å¼åŠ è½½ï¼š
     7â†’  - Phase 1: åªåŠ è½½ frontmatterï¼ˆSkillMetaï¼‰
     8â†’  - Phase 2: æŒ‰éœ€åŠ è½½å®Œæ•´å†…å®¹ï¼ˆSkillFullï¼‰
     9â†’- æ”¯æŒå¤š Skill å¹¶è¡Œæ¿€æ´»
    10â†’- LLM è‡ªä¸»ç¼–æ’ï¼Œåˆ é™¤ç¡¬ç¼–ç è·¯ç”±
    11â†’
    12â†’v7 æ¶æ„ï¼ˆä¿ç•™å…¼å®¹ï¼‰ï¼š
    13â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€èƒ½åŠ›ç´¢å¼•ã€ä¼¦ç†è¾¹ç•Œï¼‰
    14â†’- rules/*.md: è§„åˆ™æ–‡ä»¶ï¼ˆåˆ†æè¦ç‚¹ã€è¾“å‡ºè¦æ±‚ã€å¸¸è§é—®é¢˜ï¼‰
    15â†’- scenarios/*.md: (æ—§æ¶æ„å…¼å®¹) MiniSkill åœºæ™¯æ–‡ä»¶
    16â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
    17â†’
    18â†’v7.4 æ–°å¢ï¼š
    19â†’- Skill Management æ”¯æŒï¼šcategory, pricing, showcase, subscription å­—æ®µ
    20â†’
    21â†’v7.5 æ–°å¢ï¼š
    22â†’- æ•°æ®åº“ä¼˜å…ˆå…ƒæ•°æ®åŠ è½½ï¼ˆskill_catalog è¡¨ï¼‰
    23â†’- async å‡½æ•°æ”¯æŒï¼šload_skill_metadata_async, get_all_skill_metadata_async
    24â†’- SKILL.md ä½œä¸º fallback
    25â†’"""
    26â†’import re
    27â†’import json
    28â†’import logging
    29â†’import yaml
    30â†’from pathlib import Path
    31â†’from dataclasses import dataclass, field
    32â†’from typing import Dict, List, Optional, Any
    33â†’from functools import lru_cache
    34â†’
    35â†’logger = logging.getLogger(__name__)
    36â†’
    37â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    38â†’
    39â†’
    40â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    41â†’# æ•°æ®ç»“æ„
    42â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    43â†’
    44â†’@dataclass
    45â†’class SkillPricing:
    46â†’    """Skill å®šä»·é…ç½®"""
    47â†’    type: str = "free"  # free | premium | credits
    48â†’    trial_messages: int = 3
    49â†’    credits_per_use: Optional[int] = None
    50â†’
    51â†’
    52â†’@dataclass
    53â†’class SkillShowcase:
    54â†’    """Skill å±•ç¤ºé…ç½®ï¼ˆç”¨äº Skill å¸‚åœºï¼‰"""
    55â†’    tagline: str = ""
    56â†’    highlights: List[str] = field(default_factory=list)
    57â†’    preview_image: Optional[str] = None
    58â†’    demo_prompts: List[str] = field(default_factory=list)
    59â†’
    60â†’
    61â†’@dataclass
    62â†’class SkillSubscription:
    63â†’    """Skill è®¢é˜…é…ç½®"""
    64â†’    auto_subscribe: bool = False
    65â†’    can_unsubscribe: bool = True
    66â†’    push_default: bool = True
    67â†’    min_subscription_days: int = 0
    68â†’
    69â†’
    70â†’@dataclass
    71â†’class SkillFeature:
    72â†’    """Skill åŠŸèƒ½ç‰¹æ€§"""
    73â†’    name: str
    74â†’    description: str = ""
    75â†’    icon: str = "ğŸ“Œ"
    76â†’    tier: str = "free"  # free | basic | premium
    77â†’
    78â†’
    79â†’@dataclass
    80â†’class SkillMetadata:
    81â†’    """Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰"""
    82â†’    id: str
    83â†’    name: str
    84â†’    description: str
    85â†’    version: str = "1.0.0"
    86â†’    category: str = "professional"  # core | default | professional
    87â†’    icon: str = "ğŸ’¡"
    88â†’    color: str = "#6B7280"
    89â†’    triggers: List[str] = field(default_factory=list)
    90â†’    pricing: SkillPricing = field(default_factory=SkillPricing)
    91â†’    features: List[SkillFeature] = field(default_factory=list)
    92â†’    showcase: SkillShowcase = field(default_factory=SkillShowcase)
    93â†’    subscription: SkillSubscription = field(default_factory=SkillSubscription)
    94â†’
    95â†’    def to_dict(self) -> Dict[str, Any]:
    96â†’        """è½¬æ¢ä¸º API å“åº”æ ¼å¼"""
    97â†’        return {
    98â†’            "id": self.id,
    99â†’            "name": self.name,
   100â†’            "description": self.description,
   101â†’            "version": self.version,
   102â†’            "category": self.category,
   103â†’            "icon": self.icon,
   104â†’            "color": self.color,
   105â†’            "triggers": self.triggers,
   106â†’            "pricing": {
   107â†’                "type": self.pricing.type,
   108â†’                "trial_messages": self.pricing.trial_messages,
   109â†’                "credits_per_use": self.pricing.credits_per_use,
   110â†’            },
   111â†’            "features": [
   112â†’                {"name": f.name, "description": f.description, "icon": f.icon, "tier": f.tier}
   113â†’                for f in self.features
   114â†’            ],
   115â†’            "showcase": {
   116â†’                "tagline": self.showcase.tagline,
   117â†’                "highlights": self.showcase.highlights,
   118â†’                "preview_image": self.showcase.preview_image,
   119â†’                "demo_prompts": self.showcase.demo_prompts,
   120â†’            },
   121â†’            "subscription": {
   122â†’                "auto_subscribe": self.subscription.auto_subscribe,
   123â†’                "can_unsubscribe": self.subscription.can_unsubscribe,
   124â†’                "push_default": self.subscription.push_default,
   125â†’            },
   126â†’        }
   127â†’
   128â†’
   129â†’@dataclass
   130â†’class SkillConfig:
   131â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
   132â†’    id: str
   133â†’    name: str
   134â†’    description: str
   135â†’    expert_persona: str
   136â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
   137â†’    ethics: Dict[str, Any]
   138â†’    tools: List[str]
   139â†’    default_scenario: str = "basic_reading"
   140â†’    triggers: List[str] = field(default_factory=list)
   141â†’    global_tools: List[str] = field(default_factory=list)  # éœ€è¦çš„å…¨å±€å·¥å…·
   142â†’    # v7.1: SOP é…ç½®é©±åŠ¨
   143â†’    requires_birth_info: bool = False  # æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯
   144â†’    requires_compute: bool = False     # æ˜¯å¦éœ€è¦è®¡ç®—ï¼ˆæ’ç›˜ï¼‰
   145â†’    compute_type: Optional[str] = None # è®¡ç®—ç±»å‹ï¼šbazi/zodiac/tarotï¼ŒNone è¡¨ç¤ºä½¿ç”¨è‡ªèº«
   146â†’    compute_tool: Optional[str] = None # è®¡ç®—å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
   147â†’    collect_tool: Optional[str] = None # æ”¶é›†å·¥å…·åï¼ŒNone æ—¶ä½¿ç”¨é»˜è®¤çº¦å®š request_info
   148â†’    external_tools: List[str] = field(default_factory=list)  # v7.3: ä»å…¶ä»– skill å¯¼å…¥çš„å·¥å…·
   149â†’    # v2.2: Profile æ³¨å…¥é…ç½®
   150â†’    requires_skill_data: List[str] = field(default_factory=list)  # éœ€è¦çš„ skill_dataï¼Œç©ºåˆ—è¡¨è¡¨ç¤ºåªéœ€è‡ªèº«
   151â†’
   152â†’
   153â†’@dataclass
   154â†’class ServiceItem:
   155â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
   156â†’    scenario_id: str
   157â†’    name: str
   158â†’    icon: str
   159â†’    description: str
   160â†’    tier: str  # entry/standard/professional
   161â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
   162â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
   163â†’
   164â†’
   165â†’@dataclass
   166â†’class ScenarioConfig:
   167â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
   168â†’    id: str
   169â†’    name: str
   170â†’    level: str  # entry/standard/professional
   171â†’    billing: str  # free/basic/premium
   172â†’    description: str
   173â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
   174â†’    prerequisites: List[str]
   175â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
   176â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
   177â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
   178â†’    tools: List[str]
   179â†’
   180â†’
   181â†’@dataclass
   182â†’class ToolMetadata:
   183â†’    """å·¥å…·å…ƒæ•°æ®"""
   184â†’    name: str
   185â†’    description: str
   186â†’    tool_type: str  # collect/calculate/display/search
   187â†’    card_type: Optional[str] = None
   188â†’    card_props_schema: Optional[Dict] = None
   189â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   190â†’    when_to_call: Optional[str] = None
   191â†’
   192â†’
   193â†’@dataclass
   194â†’class RuleConfig:
   195â†’    """è§„åˆ™é…ç½®ï¼ˆä» rules/*.md åŠ è½½ï¼‰- v7 æ–°å¢"""
   196â†’    id: str
   197â†’    name: str
   198â†’    impact: str  # CRITICAL/HIGH/MEDIUM/LOW
   199â†’    impact_description: str
   200â†’    tags: List[str]
   201â†’    content: str  # å®Œæ•´çš„è§„åˆ™å†…å®¹
   202â†’    analysis_steps: List[Dict[str, Any]]  # åˆ†æè¦ç‚¹è¡¨æ ¼
   203â†’    output_requirements: str  # è¾“å‡ºè¦æ±‚
   204â†’    common_questions: str  # å¸¸è§é—®é¢˜
   205â†’
   206â†’
   207â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   208â†’# V9: æ¸è¿›å¼åŠ è½½æ•°æ®ç»“æ„
   209â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   210â†’
   211â†’@dataclass
   212â†’class SkillMeta:
   213â†’    """Skill å…ƒæ•°æ®æ‘˜è¦ï¼ˆPhase 1 å±•ç¤ºï¼‰- V9 æ–°å¢
   214â†’
   215â†’    åªåŒ…å« frontmatter ä¿¡æ¯ï¼Œç”¨äº Phase 1 è·¯ç”±ã€‚
   216â†’    description å†…åµŒå·¥å…·åˆ—è¡¨ï¼Œæ— éœ€é¢å¤–å­—æ®µã€‚
   217â†’    """
   218â†’    id: str
   219â†’    name: str
   220â†’    description: str  # å†…å«å·¥å…·åˆ—è¡¨ï¼Œå¦‚ "æ˜Ÿç›˜è®¡ç®—ä¸è§£è¯»ã€‚å·¥å…·ï¼šcalculate_zodiac, show_zodiac_chart"
   221â†’    triggers: List[str] = field(default_factory=list)
   222â†’    category: str = "professional"
   223â†’
   224â†’
   225â†’@dataclass
   226â†’class ToolDef:
   227â†’    """å·¥å…·å®šä¹‰ï¼ˆç”¨äº SkillFullï¼‰- V9 æ–°å¢"""
   228â†’    name: str
   229â†’    description: str
   230â†’    parameters: Dict[str, Any] = field(default_factory=dict)
   231â†’    tool_type: str = "action"  # routing/collect/action/search/display/trigger
   232â†’
   233â†’
   234â†’@dataclass
   235â†’class SkillFull:
   236â†’    """Skill å®Œæ•´å†…å®¹ï¼ˆPhase 2 åŠ è½½ï¼‰- V9 æ–°å¢
   237â†’
   238â†’    åŒ…å« SKILL.md å…¨æ–‡ã€å·¥å…·å®šä¹‰ã€è§„åˆ™æ–‡ä»¶ã€‚
   239â†’    """
   240â†’    meta: SkillMeta
   241â†’    content: str  # SKILL.md å…¨æ–‡ï¼ˆä¸å« frontmatterï¼‰
   242â†’    tools: List[ToolDef] = field(default_factory=list)
   243â†’    rules: Dict[str, str] = field(default_factory=dict)  # rule_id -> content
   244â†’
   245â†’
   246â†’# V9: Core Skill å…¨å±€ç¼“å­˜
   247â†’_core_skill_cache: Optional[SkillFull] = None
   248â†’
   249â†’# V9: æ‰€æœ‰ Skill Meta ç¼“å­˜
   250â†’_skill_metas_cache: Optional[Dict[str, SkillMeta]] = None
   251â†’
   252â†’
   253â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   254â†’# è§£æå‡½æ•°
   255â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   256â†’
   257â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
   258â†’    """è§£æ YAML frontmatterï¼ˆæ”¯æŒåµŒå¥—å¯¹è±¡ï¼‰"""
   259â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
   260â†’    match = re.match(pattern, text, re.DOTALL)
   261â†’    if not match:
   262â†’        return {}, text
   263â†’
   264â†’    frontmatter_str, content = match.groups()
   265â†’
   266â†’    # ä½¿ç”¨ YAML è§£æä»¥æ”¯æŒåµŒå¥—å¯¹è±¡
   267â†’    try:
   268â†’        metadata = yaml.safe_load(frontmatter_str) or {}
   269â†’    except yaml.YAMLError as e:
   270â†’        logger.warning(f"YAML parse error in frontmatter: {e}, falling back to simple parse")
   271â†’        # å›é€€åˆ°ç®€å•è§£æ
   272â†’        metadata = {}
   273â†’        current_key = None
   274â†’        current_list = None
   275â†’
   276â†’        for line in frontmatter_str.strip().split('\n'):
   277â†’            stripped = line.strip()
   278â†’            if not stripped:
   279â†’                continue
   280â†’            if stripped.startswith('- ') and current_key:
   281â†’                if current_list is None:
   282â†’                    current_list = []
   283â†’                current_list.append(stripped[2:].strip())
   284â†’                metadata[current_key] = current_list
   285â†’            elif ':' in line and not line.startswith(' '):
   286â†’                current_list = None
   287â†’                key, value = line.split(':', 1)
   288â†’                current_key = key.strip()
   289â†’                value = value.strip()
   290â†’                if value in ('|', ''):
   291â†’                    continue
   292â†’                elif value.lower() == 'true':
   293â†’                    metadata[current_key] = True
   294â†’                elif value.lower() == 'false':
   295â†’                    metadata[current_key] = False
   296â†’                else:
   297â†’                    metadata[current_key] = value
   298â†’
   299â†’    return metadata, content.strip()
   300â†’
   301â†’
   302â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   303â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯
   304â†’
   305â†’    æ”¯æŒä¸¤ç§è§¦å‘è¯æ ¼å¼ï¼š
   306â†’    1. æ—§æ ¼å¼ï¼šfrontmatter ä¸­çš„ triggers: åˆ—è¡¨
   307â†’    2. æ–°æ ¼å¼ï¼šdescription ä¸­çš„ "è§¦å‘è¯ï¼šxxxã€xxxã€xxx"
   308â†’    """
   309â†’    metadata, content = parse_frontmatter(text)
   310â†’
   311â†’    # ä» frontmatter è·å–è§¦å‘è¯ï¼ˆæ—§æ ¼å¼ï¼‰
   312â†’    triggers = metadata.get("triggers", [])
   313â†’
   314â†’    # å¦‚æœ frontmatter æ²¡æœ‰ triggersï¼Œå°è¯•ä» description ä¸­æå–ï¼ˆæ–°æ ¼å¼ï¼‰
   315â†’    if not triggers:
   316â†’        description = metadata.get("description", "")
   317â†’        # åŒ¹é… "è§¦å‘è¯ï¼šxxxã€xxxã€xxx" æˆ– "è§¦å‘è¯:xxx,xxx,xxx"
   318â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   319â†’        if trigger_match:
   320â†’            trigger_str = trigger_match.group(1)
   321â†’            # æ”¯æŒé¡¿å·ã€é€—å·åˆ†éš”
   322â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   323â†’
   324â†’    result = {
   325â†’        "id": metadata.get("id", ""),
   326â†’        "name": metadata.get("name", ""),
   327â†’        "description": metadata.get("description", ""),
   328â†’        "triggers": triggers,
   329â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   330â†’        "global_tools": metadata.get("global_tools", []),  # ä» frontmatter è¯»å–
   331â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   332â†’        "requires_birth_info": metadata.get("requires_birth_info", False),
   333â†’        "requires_compute": metadata.get("requires_compute", False),
   334â†’        "compute_type": metadata.get("compute_type", None),
   335â†’        "compute_tool": metadata.get("compute_tool", None),
   336â†’        "collect_tool": metadata.get("collect_tool", None),
   337â†’        "external_tools": metadata.get("external_tools", []),  # v7.3
   338â†’        # v2.2: Profile æ³¨å…¥é…ç½®
   339â†’        "requires_skill_data": metadata.get("requires_skill_data", []),
   340â†’    }
   341â†’
   342â†’    # æå–ä¸“å®¶èº«ä»½
   343â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   344â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   345â†’
   346â†’    # æå–åœºæ™¯ç›®å½•
   347â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   348â†’    for level in scenarios.keys():
   349â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   350â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   351â†’        if match:
   352â†’            for row in match.group(1).strip().split('\n'):
   353â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   354â†’                if len(cols) >= 2:
   355â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   356â†’    result["scenarios"] = scenarios
   357â†’
   358â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   359â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   360â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   361â†’    if forbidden_match:
   362â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   363â†’    result["ethics"] = ethics
   364â†’
   365â†’    # æå–å·¥å…·åˆ—è¡¨
   366â†’    tools = []
   367â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   368â†’    if tools_match:
   369â†’        for row in tools_match.group(1).strip().split('\n'):
   370â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   371â†’            if len(cols) >= 1:
   372â†’                tools.append(cols[0])
   373â†’    result["tools"] = tools
   374â†’
   375â†’    return result
   376â†’
   377â†’
   378â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   379â†’    """è§£æ scenario.md å†…å®¹"""
   380â†’    metadata, content = parse_frontmatter(text)
   381â†’
   382â†’    result = {
   383â†’        "id": metadata.get("id", ""),
   384â†’        "name": metadata.get("name", ""),
   385â†’        "level": metadata.get("level", "entry"),
   386â†’        "billing": metadata.get("billing", "free"),
   387â†’        "description": metadata.get("description", ""),
   388â†’    }
   389â†’
   390â†’    # æå–è§¦å‘æ¡ä»¶
   391â†’    triggers = {"primary": [], "secondary": []}
   392â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   393â†’    if primary_match:
   394â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   395â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   396â†’    if secondary_match:
   397â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   398â†’    result["triggers"] = triggers
   399â†’
   400â†’    # æå–å‰ç½®è¦æ±‚
   401â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   402â†’    result["prerequisites"] = []
   403â†’    if prereq_match:
   404â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   405â†’
   406â†’    # æå– SOP é˜¶æ®µ
   407â†’    sop = []
   408â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   409â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   410â†’        phase_num, phase_name, phase_content = match.groups()
   411â†’        phase = {
   412â†’            "phase": int(phase_num),
   413â†’            "name": phase_name.strip(),
   414â†’            "content": phase_content.strip()
   415â†’        }
   416â†’        # æå–ç±»å‹
   417â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   418â†’        if type_match:
   419â†’            phase["type"] = type_match.group(1)
   420â†’        sop.append(phase)
   421â†’    result["sop"] = sop
   422â†’
   423â†’    # æå–å·¥å…·åˆ—è¡¨
   424â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   425â†’    result["tools"] = []
   426â†’    if tools_match:
   427â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   428â†’
   429â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   430â†’    result["knowledge_config"] = {}
   431â†’    result["output_config"] = {}
   432â†’
   433â†’    return result
   434â†’
   435â†’
   436â†’def parse_rule_md(text: str) -> Dict[str, Any]:
   437â†’    """è§£æ rules/*.md å†…å®¹ - v7 æ–°å¢"""
   438â†’    metadata, content = parse_frontmatter(text)
   439â†’
   440â†’    # è§£æ tagsï¼ˆæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–åˆ—è¡¨ï¼‰
   441â†’    tags_raw = metadata.get("tags", [])
   442â†’    if isinstance(tags_raw, str):
   443â†’        tags = [t.strip() for t in re.split(r'[,ï¼Œã€]', tags_raw) if t.strip()]
   444â†’    else:
   445â†’        tags = tags_raw
   446â†’
   447â†’    result = {
   448â†’        "id": metadata.get("id", ""),
   449â†’        "name": metadata.get("name", ""),
   450â†’        "impact": metadata.get("impact", "MEDIUM"),
   451â†’        "impact_description": metadata.get("impactDescription", ""),
   452â†’        "tags": tags,
   453â†’        "content": content,
   454â†’    }
   455â†’
   456â†’    # æå–åˆ†æè¦ç‚¹è¡¨æ ¼
   457â†’    analysis_steps = []
   458â†’    table_match = re.search(r'## åˆ†æè¦ç‚¹\s*\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)', content)
   459â†’    if table_match:
   460â†’        for row in table_match.group(1).strip().split('\n'):
   461â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   462â†’            if len(cols) >= 4:
   463â†’                analysis_steps.append({
   464â†’                    "step": cols[0],
   465â†’                    "point": cols[1],
   466â†’                    "query": cols[2],
   467â†’                    "priority": cols[3],
   468â†’                })
   469â†’    result["analysis_steps"] = analysis_steps
   470â†’
   471â†’    # æå–è¾“å‡ºè¦æ±‚
   472â†’    output_match = re.search(r'## è¾“å‡ºè¦æ±‚\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   473â†’    result["output_requirements"] = output_match.group(1).strip() if output_match else ""
   474â†’
   475â†’    # æå–å¸¸è§é—®é¢˜
   476â†’    faq_match = re.search(r'## å¸¸è§é—®é¢˜\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   477â†’    result["common_questions"] = faq_match.group(1).strip() if faq_match else ""
   478â†’
   479â†’    return result
   480â†’
   481â†’
   482â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   483â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   484â†’    services = {"entry": [], "standard": [], "professional": []}
   485â†’
   486â†’    tier_map = {
   487â†’        "entry": "entry",
   488â†’        "standard": "standard",
   489â†’        "professional": "professional"
   490â†’    }
   491â†’
   492â†’    for tier_name, tier_key in tier_map.items():
   493â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   494â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   495â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   496â†’        if not match:
   497â†’            continue
   498â†’
   499â†’        table_content = match.group(1).strip()
   500â†’        if not table_content:
   501â†’            continue
   502â†’
   503â†’        for row in table_content.split('\n'):
   504â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   505â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   506â†’                continue
   507â†’
   508â†’            service = {
   509â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   510â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   511â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   512â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   513â†’                "tier": tier_key,
   514â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   515â†’                "highlights": []
   516â†’            }
   517â†’
   518â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   519â†’            if len(cols) > 7 and cols[7]:
   520â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   521â†’
   522â†’            services[tier_key].append(service)
   523â†’
   524â†’    return services
   525â†’
   526â†’
   527â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   528â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   529â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   530â†’    if not skill_path.exists():
   531â†’        return None
   532â†’
   533â†’    text = skill_path.read_text(encoding='utf-8')
   534â†’    metadata, _ = parse_frontmatter(text)
   535â†’    services = parse_skill_services(text)
   536â†’
   537â†’    return {
   538â†’        "skill_id": skill_id,
   539â†’        "skill_name": metadata.get("name", skill_id),
   540â†’        "description": metadata.get("description", ""),
   541â†’        "services": services
   542â†’    }
   543â†’
   544â†’
   545â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   546â†’# åŠ è½½å‡½æ•°
   547â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   548â†’
   549â†’@lru_cache(maxsize=32)
   550â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   551â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   552â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   553â†’    if not skill_path.exists():
   554â†’        return None
   555â†’
   556â†’    text = skill_path.read_text(encoding='utf-8')
   557â†’    data = parse_skill_md(text)
   558â†’
   559â†’    return SkillConfig(
   560â†’        id=data.get("id", skill_id),
   561â†’        name=data.get("name", skill_id),
   562â†’        description=data.get("description", ""),
   563â†’        expert_persona=data.get("expert_persona", ""),
   564â†’        scenarios=data.get("scenarios", {}),
   565â†’        ethics=data.get("ethics", {}),
   566â†’        tools=data.get("tools", []),
   567â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   568â†’        triggers=data.get("triggers", []),
   569â†’        global_tools=data.get("global_tools", []),
   570â†’        # v7.1: SOP é…ç½®é©±åŠ¨
   571â†’        requires_birth_info=data.get("requires_birth_info", False),
   572â†’        requires_compute=data.get("requires_compute", False),
   573â†’        compute_type=data.get("compute_type", None),
   574â†’        compute_tool=data.get("compute_tool", None),
   575â†’        collect_tool=data.get("collect_tool", None),
   576â†’        external_tools=data.get("external_tools", []),  # v7.3
   577â†’        # v2.2: Profile æ³¨å…¥é…ç½®
   578â†’        requires_skill_data=data.get("requires_skill_data", []),
   579â†’    )
   580â†’
   581â†’
   582â†’@lru_cache(maxsize=32)
   583â†’def load_skill_metadata(skill_id: str) -> Optional[SkillMetadata]:
   584â†’    """åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆç”¨äº Skill Management APIï¼‰- v7.4 æ–°å¢
   585â†’
   586â†’    ä» SKILL.md çš„ frontmatter ä¸­è¯»å–å®Œæ•´çš„å…ƒæ•°æ®é…ç½®ï¼Œ
   587â†’    åŒ…æ‹¬ category, pricing, showcase, subscription ç­‰å­—æ®µã€‚
   588â†’    """
   589â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   590â†’    if not skill_path.exists():
   591â†’        return None
   592â†’
   593â†’    text = skill_path.read_text(encoding='utf-8')
   594â†’    metadata, _ = parse_frontmatter(text)
   595â†’
   596â†’    # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   597â†’    triggers = metadata.get("triggers", [])
   598â†’    if not triggers:
   599â†’        description = metadata.get("description", "")
   600â†’        trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   601â†’        if trigger_match:
   602â†’            trigger_str = trigger_match.group(1)
   603â†’            triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   604â†’
   605â†’    # è§£æ pricing
   606â†’    pricing_data = metadata.get("pricing", {})
   607â†’    pricing = SkillPricing(
   608â†’        type=pricing_data.get("type", "free") if isinstance(pricing_data, dict) else "free",
   609â†’        trial_messages=pricing_data.get("trial_messages", 3) if isinstance(pricing_data, dict) else 3,
   610â†’        credits_per_use=pricing_data.get("credits_per_use") if isinstance(pricing_data, dict) else None,
   611â†’    )
   612â†’
   613â†’    # è§£æ features
   614â†’    features_data = metadata.get("features", [])
   615â†’    features = []
   616â†’    if isinstance(features_data, list):
   617â†’        for f in features_data:
   618â†’            if isinstance(f, dict):
   619â†’                features.append(SkillFeature(
   620â†’                    name=f.get("name", ""),
   621â†’                    description=f.get("description", ""),
   622â†’                    icon=f.get("icon", "ğŸ“Œ"),
   623â†’                    tier=f.get("tier", "free"),
   624â†’                ))
   625â†’
   626â†’    # è§£æ showcase
   627â†’    showcase_data = metadata.get("showcase", {})
   628â†’    showcase = SkillShowcase(
   629â†’        tagline=showcase_data.get("tagline", "") if isinstance(showcase_data, dict) else "",
   630â†’        highlights=showcase_data.get("highlights", []) if isinstance(showcase_data, dict) else [],
   631â†’        preview_image=showcase_data.get("preview_image") if isinstance(showcase_data, dict) else None,
   632â†’        demo_prompts=showcase_data.get("demo_prompts", []) if isinstance(showcase_data, dict) else [],
   633â†’    )
   634â†’
   635â†’    # è§£æ subscription
   636â†’    subscription_data = metadata.get("subscription", {})
   637â†’    category = metadata.get("category", "professional")
   638â†’    subscription = SkillSubscription(
   639â†’        auto_subscribe=subscription_data.get("auto_subscribe", category == "default") if isinstance(subscription_data, dict) else (category == "default"),
   640â†’        can_unsubscribe=subscription_data.get("can_unsubscribe", category != "core") if isinstance(subscription_data, dict) else (category != "core"),
   641â†’        push_default=subscription_data.get("push_default", True) if isinstance(subscription_data, dict) else True,
   642â†’        min_subscription_days=subscription_data.get("min_subscription_days", 0) if isinstance(subscription_data, dict) else 0,
   643â†’    )
   644â†’
   645â†’    return SkillMetadata(
   646â†’        id=metadata.get("id", skill_id),
   647â†’        name=metadata.get("name", skill_id),
   648â†’        description=metadata.get("description", ""),
   649â†’        version=metadata.get("version", "1.0.0"),
   650â†’        category=category,
   651â†’        icon=metadata.get("icon", "ğŸ’¡"),
   652â†’        color=metadata.get("color", "#6B7280"),
   653â†’        triggers=triggers,
   654â†’        pricing=pricing,
   655â†’        features=features,
   656â†’        showcase=showcase,
   657â†’        subscription=subscription,
   658â†’    )
   659â†’
   660â†’
   661â†’def get_all_skill_metadata() -> List[SkillMetadata]:
   662â†’    """è·å–æ‰€æœ‰å¯ç”¨ Skill çš„å…ƒæ•°æ®ï¼ˆç”¨äº Skill åˆ—è¡¨ APIï¼‰- v7.4 æ–°å¢"""
   663â†’    skills = []
   664â†’    for skill_id in get_available_skills():
   665â†’        metadata = load_skill_metadata(skill_id)
   666â†’        if metadata:
   667â†’            skills.append(metadata)
   668â†’    return skills
   669â†’
   670â†’
   671â†’def get_skills_by_category(category: str) -> List[SkillMetadata]:
   672â†’    """æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ - v7.4 æ–°å¢
   673â†’
   674â†’    Args:
   675â†’        category: core | default | professional
   676â†’
   677â†’    Returns:
   678â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„å…ƒæ•°æ®åˆ—è¡¨
   679â†’    """
   680â†’    return [s for s in get_all_skill_metadata() if s.category == category]
   681â†’
   682â†’
   683â†’@lru_cache(maxsize=64)
   684â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   685â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   686â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   687â†’    if not scenario_path.exists():
   688â†’        return None
   689â†’
   690â†’    text = scenario_path.read_text(encoding='utf-8')
   691â†’    data = parse_scenario_md(text)
   692â†’
   693â†’    return ScenarioConfig(
   694â†’        id=data.get("id", scenario_id),
   695â†’        name=data.get("name", scenario_id),
   696â†’        level=data.get("level", "entry"),
   697â†’        billing=data.get("billing", "free"),
   698â†’        description=data.get("description", ""),
   699â†’        triggers=data.get("triggers", {}),
   700â†’        prerequisites=data.get("prerequisites", []),
   701â†’        sop=data.get("sop", []),
   702â†’        knowledge_config=data.get("knowledge_config", {}),
   703â†’        output_config=data.get("output_config", {}),
   704â†’        tools=data.get("tools", [])
   705â†’    )
   706â†’
   707â†’
   708â†’@lru_cache(maxsize=128)
   709â†’def load_rule(skill_id: str, rule_id: str) -> Optional[RuleConfig]:
   710â†’    """åŠ è½½è§„åˆ™é…ç½® - v7 æ–°å¢
   711â†’
   712â†’    æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
   713â†’    1. æ ¹ç›®å½•è§„åˆ™: rule_id="dankoe" -> rules/dankoe.md
   714â†’    2. å­ç›®å½•è§„åˆ™: rule_id="companion/weekly-review" -> rules/companion/weekly-review.md
   715â†’
   716â†’    å®¹é”™å¤„ç†ï¼š
   717â†’    - è‡ªåŠ¨å¤„ç†å·²å¸¦ .md åç¼€çš„ rule_id
   718â†’    - æ‹’ç»ç›®å½•è·¯å¾„
   719â†’    """
   720â†’    # å…ˆå°è¯•æ ‡å‡†æ ¼å¼ï¼ˆè‡ªåŠ¨æ·»åŠ  .md åç¼€ï¼‰
   721â†’    rule_path = SKILLS_DIR / skill_id / "rules" / f"{rule_id}.md"
   722â†’
   723â†’    if not rule_path.exists():
   724â†’        # Fallback: å°è¯•ç›´æ¥ä½œä¸ºè·¯å¾„ï¼ˆå¤„ç†å·²å¸¦ .md åç¼€çš„æƒ…å†µï¼‰
   725â†’        rule_path = SKILLS_DIR / skill_id / "rules" / rule_id
   726â†’
   727â†’        # æ‹’ç»ç›®å½•
   728â†’        if rule_path.is_dir():
   729â†’            logger.warning(f"load_rule: {rule_id} is a directory, not a rule file")
   730â†’            return None
   731â†’
   732â†’        # å¦‚æœæ²¡æœ‰åç¼€ï¼Œæ·»åŠ  .md
   733â†’        if not rule_path.suffix:
   734â†’            rule_path = rule_path.with_suffix(".md")
   735â†’
   736â†’        # ä»ç„¶ä¸å­˜åœ¨ï¼Œè¿”å› None
   737â†’        if not rule_path.exists():
   738â†’            return None
   739â†’
   740â†’    try:
   741â†’        text = rule_path.read_text(encoding='utf-8')
   742â†’        data = parse_rule_md(text)
   743â†’
   744â†’        return RuleConfig(
   745â†’            id=data.get("id", rule_id),
   746â†’            name=data.get("name", rule_id),
   747â†’            impact=data.get("impact", "MEDIUM"),
   748â†’            impact_description=data.get("impact_description", ""),
   749â†’            tags=data.get("tags", []),
   750â†’            content=data.get("content", ""),
   751â†’            analysis_steps=data.get("analysis_steps", []),
   752â†’            output_requirements=data.get("output_requirements", ""),
   753â†’            common_questions=data.get("common_questions", ""),
   754â†’        )
   755â†’    except Exception as e:
   756â†’        logger.error(f"load_rule: Failed to load {skill_id}/{rule_id}: {e}")
   757â†’        return None
   758â†’
   759â†’
   760â†’def get_skill_rules(skill_id: str) -> List[str]:
   761â†’    """è·å– Skill çš„æ‰€æœ‰è§„åˆ™ ID - v7 æ–°å¢
   762â†’
   763â†’    è¿”å›æ ¼å¼ï¼š
   764â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   765â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   766â†’    """
   767â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   768â†’    if not rules_dir.exists():
   769â†’        return []
   770â†’
   771â†’    rule_ids = []
   772â†’
   773â†’    # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   774â†’    for md_file in rules_dir.rglob("*.md"):
   775â†’        # è·³è¿‡ _index.md ç­‰
   776â†’        if md_file.stem.startswith("_"):
   777â†’            continue
   778â†’
   779â†’        # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   780â†’        relative_path = md_file.relative_to(rules_dir)
   781â†’        rule_id = str(relative_path.with_suffix(""))
   782â†’
   783â†’        # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   784â†’        rule_id = rule_id.replace("\\", "/")
   785â†’
   786â†’        rule_ids.append(rule_id)
   787â†’
   788â†’    return sorted(rule_ids)
   789â†’
   790â†’
   791â†’def has_rules(skill_id: str) -> bool:
   792â†’    """æ£€æŸ¥ Skill æ˜¯å¦ä½¿ç”¨ rules æ¶æ„ - v7 æ–°å¢"""
   793â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   794â†’    if not rules_dir.exists():
   795â†’        return False
   796â†’    rules = list(rules_dir.glob("*.md"))
   797â†’    return len(rules) > 0
   798â†’
   799â†’
   800â†’def get_available_skills() -> List[str]:
   801â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   802â†’    if not SKILLS_DIR.exists():
   803â†’        return []
   804â†’    return [p.name for p in SKILLS_DIR.iterdir()
   805â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   806â†’
   807â†’
   808â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   809â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯
   810â†’
   811â†’    æ”¯æŒä¸¤ç§æ¶æ„ï¼š
   812â†’    1. æ—§æ¶æ„ï¼šscenarios/*.md
   813â†’    2. æ–°æ¶æ„ï¼šrules/*.mdï¼ˆAgentic æ¶æ„ï¼Œæ”¯æŒå­ç›®å½•ï¼‰
   814â†’
   815â†’    è¿”å›æ ¼å¼ï¼š
   816â†’    - æ ¹ç›®å½•è§„åˆ™: "dankoe"
   817â†’    - å­ç›®å½•è§„åˆ™: "companion/weekly-review"
   818â†’    """
   819â†’    # ä¼˜å…ˆæ£€æŸ¥ rules ç›®å½•ï¼ˆæ–°æ¶æ„ï¼‰
   820â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
   821â†’    if rules_dir.exists():
   822â†’        rule_ids = []
   823â†’        # é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .md æ–‡ä»¶ï¼ˆæ”¯æŒå­ç›®å½•ï¼‰
   824â†’        for md_file in rules_dir.rglob("*.md"):
   825â†’            # è·³è¿‡ _index.md ç­‰
   826â†’            if md_file.stem.startswith("_"):
   827â†’                continue
   828â†’
   829â†’            # è®¡ç®—ç›¸å¯¹è·¯å¾„ï¼ˆå»æ‰ .md æ‰©å±•åï¼‰
   830â†’            relative_path = md_file.relative_to(rules_dir)
   831â†’            rule_id = str(relative_path.with_suffix(""))
   832â†’
   833â†’            # è½¬æ¢ Windows è·¯å¾„åˆ†éš”ç¬¦ä¸º Unix æ ¼å¼
   834â†’            rule_id = rule_id.replace("\\", "/")
   835â†’
   836â†’            rule_ids.append(rule_id)
   837â†’
   838â†’        if rule_ids:
   839â†’            return sorted(rule_ids)
   840â†’
   841â†’    # å›é€€åˆ° scenarios ç›®å½•ï¼ˆæ—§æ¶æ„ï¼‰
   842â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   843â†’    if not scenarios_dir.exists():
   844â†’        return []
   845â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   846â†’
   847â†’
   848â†’def get_skill_triggers() -> Dict[str, List[str]]:
   849â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   850â†’    triggers = {}
   851â†’    for skill_id in get_available_skills():
   852â†’        if skill_id == "core":
   853â†’            continue
   854â†’        skill = load_skill(skill_id)
   855â†’        if skill and skill.triggers:
   856â†’            triggers[skill_id] = skill.triggers
   857â†’    return triggers
   858â†’
   859â†’
   860â†’def get_skill_global_tools(skill_id: str) -> List[str]:
   861â†’    """è·å– Skill å£°æ˜éœ€è¦çš„å…¨å±€å·¥å…·åˆ—è¡¨"""
   862â†’    skill = load_skill(skill_id)
   863â†’    if skill and skill.global_tools:
   864â†’        return skill.global_tools
   865â†’    # é»˜è®¤è¿”å›æ‰€æœ‰å…¨å±€å·¥å…·ï¼ˆå‘åå…¼å®¹ï¼‰
   866â†’    return []
   867â†’
   868â†’
   869â†’def get_skill_external_tools(skill_id: str) -> List[str]:
   870â†’    """è·å– Skill å£°æ˜éœ€è¦ä»å…¶ä»– Skill å¯¼å…¥çš„å·¥å…·åˆ—è¡¨ (v7.3)"""
   871â†’    skill = load_skill(skill_id)
   872â†’    if skill and skill.external_tools:
   873â†’        return skill.external_tools
   874â†’    return []
   875â†’
   876â†’
   877â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   878â†’# V9: æ¸è¿›å¼åŠ è½½å‡½æ•°
   879â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   880â†’
   881â†’def get_core_skill() -> SkillFull:
   882â†’    """è·å– Core Skillï¼ˆå…¨ç¨‹å¯ç”¨ï¼Œå…¨æ–‡åŠ è½½ï¼‰- V9 æ–°å¢
   883â†’
   884â†’    Core Skill å§‹ç»ˆå…¨æ–‡åŠ è½½ï¼Œä¸å‚ä¸æ¸è¿›å¼åŠ è½½ã€‚
   885â†’    è¿”å›åŒ…å« SKILL.md å…¨æ–‡å’Œå·¥å…·å®šä¹‰çš„ SkillFull å¯¹è±¡ã€‚
   886â†’    """
   887â†’    global _core_skill_cache
   888â†’
   889â†’    if _core_skill_cache is not None:
   890â†’        return _core_skill_cache
   891â†’
   892â†’    skill_id = "core"
   893â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   894â†’
   895â†’    if not skill_path.exists():
   896â†’        # è¿”å›ç©ºçš„ Core Skill
   897â†’        _core_skill_cache = SkillFull(
   898â†’            meta=SkillMeta(id="core", name="Vibe", description="ç”Ÿå‘½å¯¹è¯è€…"),
   899â†’            content="",
   900â†’            tools=[],
   901â†’            rules={}
   902â†’        )
   903â†’        return _core_skill_cache
   904â†’
   905â†’    text = skill_path.read_text(encoding='utf-8')
   906â†’    metadata, content = parse_frontmatter(text)
   907â†’
   908â†’    # æ„å»º SkillMeta
   909â†’    meta = SkillMeta(
   910â†’        id=metadata.get("id", skill_id),
   911â†’        name=metadata.get("name", "Vibe"),
   912â†’        description=metadata.get("description", ""),
   913â†’        triggers=metadata.get("triggers", []),
   914â†’        category=metadata.get("category", "core"),
   915â†’    )
   916â†’
   917â†’    # åŠ è½½å·¥å…·å®šä¹‰
   918â†’    tools = _load_skill_tools(skill_id)
   919â†’
   920â†’    # åŠ è½½è§„åˆ™æ–‡ä»¶
   921â†’    rules = _load_skill_rules_content(skill_id)
   922â†’
   923â†’    _core_skill_cache = SkillFull(
   924â†’        meta=meta,
   925â†’        content=content,
   926â†’        tools=tools,
   927â†’        rules=rules,
   928â†’    )
   929â†’
   930â†’    logger.info(f"[V9] Core skill loaded: {len(content)} chars, {len(tools)} tools, {len(rules)} rules")
   931â†’    return _core_skill_cache
   932â†’
   933â†’
   934â†’def load_all_skill_metas() -> Dict[str, SkillMeta]:
   935â†’    """å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰é Core Skill çš„ frontmatter - V9 æ–°å¢
   936â†’
   937â†’    åªåŠ è½½ frontmatterï¼ˆSkillMetaï¼‰ï¼Œç”¨äº Phase 1 è·¯ç”±ã€‚
   938â†’    description å†…åµŒå·¥å…·åˆ—è¡¨ï¼Œæ— éœ€é¢å¤–åŠ è½½ã€‚
   939â†’    """
   940â†’    global _skill_metas_cache
   941â†’
   942â†’    if _skill_metas_cache is not None:
   943â†’        return _skill_metas_cache
   944â†’
   945â†’    _skill_metas_cache = {}
   946â†’
   947â†’    for skill_id in get_available_skills():
   948â†’        if skill_id == "core":
   949â†’            continue
   950â†’
   951â†’        skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   952â†’        if not skill_path.exists():
   953â†’            continue
   954â†’
   955â†’        try:
   956â†’            text = skill_path.read_text(encoding='utf-8')
   957â†’            metadata, _ = parse_frontmatter(text)
   958â†’
   959â†’            # ä» description ä¸­æå–è§¦å‘è¯ï¼ˆå¦‚æœ frontmatter ä¸­æ²¡æœ‰ï¼‰
   960â†’            triggers = metadata.get("triggers", [])
   961â†’            if not triggers:
   962â†’                description = metadata.get("description", "")
   963â†’                trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
   964â†’                if trigger_match:
   965â†’                    trigger_str = trigger_match.group(1)
   966â†’                    triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   967â†’
   968â†’            _skill_metas_cache[skill_id] = SkillMeta(
   969â†’                id=metadata.get("id", skill_id),
   970â†’                name=metadata.get("name", skill_id),
   971â†’                description=metadata.get("description", ""),
   972â†’                triggers=triggers,
   973â†’                category=metadata.get("category", "professional"),
   974â†’            )
   975â†’        except Exception as e:
   976â†’            logger.warning(f"[V9] Failed to load skill meta for {skill_id}: {e}")
   977â†’
   978â†’    logger.info(f"[V9] Loaded {len(_skill_metas_cache)} skill metas")
   979â†’    return _skill_metas_cache
   980â†’
   981â†’
   982â†’def load_skill_full(skill_id: str) -> Optional[SkillFull]:
   983â†’    """æŒ‰éœ€åŠ è½½ Skill å®Œæ•´å†…å®¹ - V9 æ–°å¢
   984â†’
   985â†’    Phase 2 æ—¶è°ƒç”¨ï¼ŒåŠ è½½ SKILL.md å…¨æ–‡ã€å·¥å…·å®šä¹‰ã€è§„åˆ™æ–‡ä»¶ã€‚
   986â†’    """
   987â†’    if skill_id == "core":
   988â†’        return get_core_skill()
   989â†’
   990â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   991â†’    if not skill_path.exists():
   992â†’        return None
   993â†’
   994â†’    try:
   995â†’        text = skill_path.read_text(encoding='utf-8')
   996â†’        metadata, content = parse_frontmatter(text)
   997â†’
   998â†’        # ä» description ä¸­æå–è§¦å‘è¯
   999â†’        triggers = metadata.get("triggers", [])
  1000â†’        if not triggers:
  1001â†’            description = metadata.get("description", "")
  1002â†’            trigger_match = re.search(r'è§¦å‘è¯[ï¼š:]\s*([^ã€‚.]+)', description)
  1003â†’            if trigger_match:
  1004â†’                trigger_str = trigger_match.group(1)
  1005â†’                triggers = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
  1006â†’
  1007â†’        meta = SkillMeta(
  1008â†’            id=metadata.get("id", skill_id),
  1009â†’            name=metadata.get("name", skill_id),
  1010â†’            description=metadata.get("description", ""),
  1011â†’            triggers=triggers,
  1012â†’            category=metadata.get("category", "professional"),
  1013â†’        )
  1014â†’
  1015â†’        # åŠ è½½å·¥å…·å®šä¹‰
  1016â†’        tools = _load_skill_tools(skill_id)
  1017â†’
  1018â†’        # åŠ è½½è§„åˆ™æ–‡ä»¶
  1019â†’        rules = _load_skill_rules_content(skill_id)
  1020â†’
  1021â†’        skill_full = SkillFull(
  1022â†’            meta=meta,
  1023â†’            content=content,
  1024â†’            tools=tools,
  1025â†’            rules=rules,
  1026â†’        )
  1027â†’
  1028â†’        logger.info(f"[V9] Skill {skill_id} full loaded: {len(content)} chars, {len(tools)} tools, {len(rules)} rules")
  1029â†’        return skill_full
  1030â†’
  1031â†’    except Exception as e:
  1032â†’        logger.error(f"[V9] Failed to load skill full for {skill_id}: {e}")
  1033â†’        return None
  1034â†’
  1035â†’
  1036â†’def _load_skill_tools(skill_id: str) -> List[ToolDef]:
  1037â†’    """åŠ è½½ Skill çš„å·¥å…·å®šä¹‰ - V9 å†…éƒ¨å‡½æ•°"""
  1038â†’    tools_path = SKILLS_DIR / skill_id / "tools" / "tools.yaml"
  1039â†’    if not tools_path.exists():
  1040â†’        return []
  1041â†’
  1042â†’    try:
  1043â†’        text = tools_path.read_text(encoding='utf-8')
  1044â†’        data = yaml.safe_load(text) or {}
  1045â†’
  1046â†’        tools = []
  1047â†’        # V9 æ ¼å¼ï¼štools åˆ—è¡¨
  1048â†’        if "tools" in data:
  1049â†’            for tool in data["tools"]:
  1050â†’                tools.append(ToolDef(
  1051â†’                    name=tool.get("name", ""),
  1052â†’                    description=tool.get("description", ""),
  1053â†’                    parameters={p.get("name", ""): p for p in tool.get("parameters", [])},
  1054â†’                    tool_type=tool.get("type", "action"),
  1055â†’                ))
  1056â†’        else:
  1057â†’            # V2 æ ¼å¼ï¼šæŒ‰ç±»åˆ«åˆ†ç»„
  1058â†’            for category in ["routing", "collect", "action", "search", "display", "trigger"]:
  1059â†’                for tool in data.get(category, []):
  1060â†’                    tools.append(ToolDef(
  1061â†’                        name=tool.get("name", ""),
  1062â†’                        description=tool.get("description", ""),
  1063â†’                        parameters={p.get("name", ""): p for p in tool.get("parameters", [])},
  1064â†’                        tool_type=category,
  1065â†’                    ))
  1066â†’
  1067â†’        return tools
  1068â†’    except Exception as e:
  1069â†’        logger.warning(f"[V9] Failed to load tools for {skill_id}: {e}")
  1070â†’        return []
  1071â†’
  1072â†’
  1073â†’def _load_skill_rules_content(skill_id: str) -> Dict[str, str]:
  1074â†’    """åŠ è½½ Skill çš„æ‰€æœ‰è§„åˆ™æ–‡ä»¶å†…å®¹ - V9 å†…éƒ¨å‡½æ•°"""
  1075â†’    rules_dir = SKILLS_DIR / skill_id / "rules"
  1076â†’    if not rules_dir.exists():
  1077â†’        return {}
  1078â†’
  1079â†’    rules = {}
  1080â†’    for md_file in rules_dir.rglob("*.md"):
  1081â†’        if md_file.stem.startswith("_"):
  1082â†’            continue
  1083â†’
  1084â†’        try:
  1085â†’            relative_path = md_file.relative_to(rules_dir)
  1086â†’            rule_id = str(relative_path.with_suffix("")).replace("\\", "/")
  1087â†’            rules[rule_id] = md_file.read_text(encoding='utf-8')
  1088â†’        except Exception as e:
  1089â†’            logger.warning(f"[V9] Failed to load rule {md_file}: {e}")
  1090â†’
  1091â†’    return rules
  1092â†’
  1093â†’
  1094â†’def build_phase1_prompt() -> str:
  1095â†’    """æ„å»º Phase 1 System Prompt - V9 æ–°å¢
  1096â†’
  1097â†’    Phase 1 æä¾›ï¼š
  1098â†’    - Core Skill å…¨æ–‡ï¼ˆç²¾ç®€ç‰ˆï¼‰
  1099â†’    - å…¶ä»– Skill çš„ frontmatter åˆ—è¡¨ï¼ˆid, name, descriptionï¼‰
  1100â†’
  1101â†’    LLM åŸºäºæ­¤é€‰æ‹© Skill(s)ã€‚
  1102â†’    """
  1103â†’    parts = []
  1104â†’
  1105â†’    # 1. Core Skill å…¨æ–‡
  1106â†’    core = get_core_skill()
  1107â†’    parts.append(f"# {core.meta.name}\n\n{core.content}")
  1108â†’
  1109â†’    # 2. å¯ç”¨ Skill åˆ—è¡¨
  1110â†’    skill_metas = load_all_skill_metas()
  1111â†’    if skill_metas:
  1112â†’        parts.append("\n---\n\n## å¯ç”¨åŠŸèƒ½\n")
  1113â†’        parts.append("æ ¹æ®ç”¨æˆ·æ„å›¾ï¼Œè°ƒç”¨ `activate_skills` å·¥å…·æ¿€æ´»å¯¹åº”åŠŸèƒ½ï¼š\n")
  1114â†’
  1115â†’        for skill_id, meta in sorted(skill_metas.items()):
  1116â†’            parts.append(f"- **{meta.name}** (`{skill_id}`): {meta.description}")
  1117â†’
  1118â†’    return "\n".join(parts)
  1119â†’
  1120â†’
  1121â†’def build_phase2_prompt(
  1122â†’    active_skills: List[str],
  1123â†’    user_context: Optional[Dict] = None,
  1124â†’    active_rule: Optional[str] = None
  1125â†’) -> str:
  1126â†’    """æ„å»º Phase 2 System Prompt - V9 æ–°å¢
  1127â†’
  1128â†’    Phase 2 æä¾›ï¼š
  1129â†’    - Core Skill å…¨æ–‡ï¼ˆå§‹ç»ˆå­˜åœ¨ï¼‰
  1130â†’    - å·²æ¿€æ´» Skill çš„å®Œæ•´ SKILL.md
  1131â†’    - ç›¸å…³ rules/*.md
  1132â†’    - Profile + Skill Data
  1133â†’
  1134â†’    Args:
  1135â†’        active_skills: å·²æ¿€æ´»çš„ Skill ID åˆ—è¡¨
  1136â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1137â†’        active_rule: å½“å‰æ¿€æ´»çš„è§„åˆ™ ID
  1138â†’
  1139â†’    Returns:
  1140â†’        å®Œæ•´çš„ System Prompt
  1141â†’    """
  1142â†’    parts = []
  1143â†’
  1144â†’    # 1. Core Skill å…¨æ–‡
  1145â†’    core = get_core_skill()
  1146â†’    parts.append(f"# {core.meta.name}\n\n{core.content}")
  1147â†’
  1148â†’    # 2. å·²æ¿€æ´» Skill çš„å®Œæ•´å†…å®¹
  1149â†’    for skill_id in active_skills:
  1150â†’        if skill_id == "core":
  1151â†’            continue
  1152â†’
  1153â†’        skill_full = load_skill_full(skill_id)
  1154â†’        if skill_full:
  1155â†’            parts.append(f"\n---\n\n# {skill_full.meta.name}\n\n{skill_full.content}")
  1156â†’
  1157â†’            # å¦‚æœæœ‰æ¿€æ´»çš„è§„åˆ™ï¼ŒåŠ è½½è§„åˆ™å†…å®¹
  1158â†’            if active_rule and active_rule in skill_full.rules:
  1159â†’                rule_content = skill_full.rules[active_rule]
  1160â†’                _, rule_body = parse_frontmatter(rule_content)
  1161â†’                parts.append(f"\n## å½“å‰è§„åˆ™\n{rule_body}")
  1162â†’
  1163â†’    # 3. è¾¹ç•Œè§„åˆ™ï¼ˆä» routing_config åŠ è½½ï¼‰
  1164â†’    try:
  1165â†’        from .routing_config import get_boundary_rules, inject_placeholders
  1166â†’        boundary_rules = get_boundary_rules()
  1167â†’        if boundary_rules.get("shared"):
  1168â†’            parts.append(boundary_rules["shared"])
  1169â†’        if boundary_rules.get("phase2"):
  1170â†’            skill_id = active_skills[0] if active_skills else "core"
  1171â†’            boundary_phase2 = inject_placeholders(
  1172â†’                boundary_rules["phase2"],
  1173â†’                {"skill_id": skill_id}
  1174â†’            )
  1175â†’            parts.append(boundary_phase2)
  1176â†’    except Exception as e:
  1177â†’        logger.warning(f"[V9] Failed to load boundary rules: {e}")
  1178â†’
  1179â†’    # 4. ç”¨æˆ·ä¸Šä¸‹æ–‡
  1180â†’    if user_context:
  1181â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1182â†’
  1183â†’        # å‡ºç”Ÿä¿¡æ¯
  1184â†’        if user_context.get("birth_info"):
  1185â†’            birth_info = user_context['birth_info']
  1186â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼‰\n"
  1187â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1188â†’
  1189â†’        # VibeInsight
  1190â†’        vibe = user_context.get("vibe", {})
  1191â†’        if vibe.get("insight"):
  1192â†’            insight = vibe["insight"]
  1193â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n"
  1194â†’            if insight.get("essence", {}).get("archetype", {}).get("primary"):
  1195â†’                ctx_text += f"- ä¸»è¦åŸå‹: {insight['essence']['archetype']['primary']}\n"
  1196â†’
  1197â†’        # VibeTarget
  1198â†’        if vibe.get("target"):
  1199â†’            target = vibe["target"]
  1200â†’            if target.get("north_star", {}).get("vision_scene"):
  1201â†’                ctx_text += f"\n### æ„¿æ™¯\n{target['north_star']['vision_scene'][:200]}\n"
  1202â†’
  1203â†’        parts.append(ctx_text)
  1204â†’
  1205â†’    return "\n".join(parts)
  1206â†’
  1207â†’
  1208â†’def clear_v9_cache():
  1209â†’    """æ¸…é™¤ V9 ç¼“å­˜ - V9 æ–°å¢"""
  1210â†’    global _core_skill_cache, _skill_metas_cache
  1211â†’    _core_skill_cache = None
  1212â†’    _skill_metas_cache = None
  1213â†’    logger.info("[V9] Cache cleared")
  1214â†’
  1215â†’
  1216â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1217â†’# v7.1: SOP é…ç½®æŸ¥è¯¢å‡½æ•°
  1218â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1219â†’
  1220â†’def skill_requires_birth_info(skill_id: str) -> bool:
  1221â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦å‡ºç”Ÿä¿¡æ¯ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
  1222â†’    skill = load_skill(skill_id)
  1223â†’    return skill.requires_birth_info if skill else False
  1224â†’
  1225â†’
  1226â†’def skill_requires_compute(skill_id: str) -> bool:
  1227â†’    """æ£€æŸ¥ Skill æ˜¯å¦éœ€è¦è®¡ç®—/æ’ç›˜ï¼ˆé…ç½®é©±åŠ¨ï¼‰"""
  1228â†’    skill = load_skill(skill_id)
  1229â†’    return skill.requires_compute if skill else False
  1230â†’
  1231â†’
  1232â†’def get_skill_compute_type(skill_id: str) -> Optional[str]:
  1233â†’    """è·å– Skill çš„è®¡ç®—ç±»å‹ï¼ˆé…ç½®é©±åŠ¨ï¼‰
  1234â†’
  1235â†’    è¿”å›å€¼ï¼š
  1236â†’    - None: ä½¿ç”¨è‡ªèº«çš„è®¡ç®—å™¨
  1237â†’    - "zodiac": ä½¿ç”¨ zodiac è®¡ç®—å™¨ï¼ˆå¦‚ jungastroï¼‰
  1238â†’    - "bazi": ä½¿ç”¨ bazi è®¡ç®—å™¨
  1239â†’    """
  1240â†’    skill = load_skill(skill_id)
  1241â†’    return skill.compute_type if skill else None
  1242â†’
  1243â†’
  1244â†’def get_skill_compute_tool(skill_id: str) -> Optional[str]:
  1245â†’    """è·å– Skill çš„è®¡ç®—å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
  1246â†’
  1247â†’    è¿”å›å€¼ï¼š
  1248â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "calculate_zodiac"ï¼‰
  1249â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š calculate_{compute_type}
  1250â†’    """
  1251â†’    skill = load_skill(skill_id)
  1252â†’    return skill.compute_tool if skill else None
  1253â†’
  1254â†’
  1255â†’def get_skill_collect_tool(skill_id: str) -> Optional[str]:
  1256â†’    """è·å– Skill çš„æ”¶é›†å·¥å…·åï¼ˆé…ç½®é©±åŠ¨ï¼‰
  1257â†’
  1258â†’    è¿”å›å€¼ï¼š
  1259â†’    - é…ç½®çš„å·¥å…·åï¼ˆå¦‚ "collect_birth_info"ï¼‰
  1260â†’    - None: ä½¿ç”¨é»˜è®¤çº¦å®š request_info
  1261â†’    """
  1262â†’    skill = load_skill(skill_id)
  1263â†’    return skill.collect_tool if skill else None
  1264â†’
  1265â†’
  1266â†’def get_skill_required_data(skill_id: str) -> List[str]:
  1267â†’    """è·å– Skill éœ€è¦çš„ skill_data åˆ—è¡¨ï¼ˆé…ç½®é©±åŠ¨ï¼‰- v2.2
  1268â†’
  1269â†’    è¿”å›å€¼ï¼š
  1270â†’    - é…ç½®çš„ skill_data åˆ—è¡¨ï¼ˆå¦‚ ["bazi", "zodiac"]ï¼‰
  1271â†’    - ç©ºåˆ—è¡¨æ—¶è¿”å› [skill_id]ï¼ˆé»˜è®¤åªéœ€è‡ªèº«æ•°æ®ï¼‰
  1272â†’
  1273â†’    ç¤ºä¾‹ï¼š
  1274â†’    - bazi â†’ ["bazi"]ï¼ˆé»˜è®¤ï¼Œåªéœ€è‡ªèº«ï¼‰
  1275â†’    - jungastro â†’ ["bazi", "zodiac"]ï¼ˆé…ç½®äº† requires_skill_dataï¼‰
  1276â†’    - vibe_id â†’ ["bazi", "zodiac"]ï¼ˆé…ç½®äº† requires_skill_dataï¼‰
  1277â†’    """
  1278â†’    skill = load_skill(skill_id)
  1279â†’    if skill and skill.requires_skill_data:
  1280â†’        return skill.requires_skill_data
  1281â†’    return [skill_id]  # é»˜è®¤åªéœ€è‡ªèº«
  1282â†’
  1283â†’
  1284â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1285â†’# System Prompt æ„å»º
  1286â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1287â†’
  1288â†’# V2: è¯­æ°”æ¨¡å¼ Prompt æ¨¡æ¿
  1289â†’# ä¸æ•°æ®åº“çº¦æŸä¸€è‡´ï¼šwarm, sarcastic, wise
  1290â†’VOICE_MODE_PROMPTS = {
  1291â†’    "warm": """## è¯­æ°”é£æ ¼ï¼šæ¸©æš–æ”¯æŒå‹
  1292â†’åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿã€‚
  1293â†’- ç”¨"æˆ‘ä»¬"è€Œé"ä½ åº”è¯¥"
  1294â†’- å…ˆè‚¯å®šæ„Ÿå—ï¼Œå†å¼•å¯¼æ€è€ƒ
  1295â†’- ç”¨é—®é¢˜ä»£æ›¿å»ºè®®
  1296â†’""",
  1297â†’    "sarcastic": """## è¯­æ°”é£æ ¼ï¼šç›´æ¥æŒ‘æˆ˜å‹ï¼ˆæ¯’èˆŒä½†æœ‰çˆ±ï¼‰
  1298â†’ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸ã€‚
  1299â†’- ç›´æ¥æŒ‡å‡ºé—®é¢˜ï¼Œä¸ç»•å¼¯å­
  1300â†’- ç”¨å¹½é»˜ç¼“è§£çŠ€åˆ©ï¼Œé¿å…ä¼¤å®³
  1301â†’- åœ¨åæ§½ä¸­å¸¦ç€æœŸå¾…å’Œå…³å¿ƒ
  1302â†’- æ•¢è¯´çœŸè¯ï¼Œä½†ä»ä¸æ¶æ„æ”»å‡»
  1303â†’""",
  1304â†’    "wise": """## è¯­æ°”é£æ ¼ï¼šç¿æ™ºå¯¼å¸ˆå‹
  1305â†’åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒã€‚
  1306â†’- ä»æ›´é«˜è§†è§’çœ‹å¾…é—®é¢˜
  1307â†’- å¼•ç”¨ç»å…¸æ™ºæ…§å’ŒåŸç†
  1308â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡ç‚¹è¿·æ´¥
  1309â†’- å¸®åŠ©çœ‹åˆ°æ›´é•¿è¿œçš„æ„ä¹‰
  1310â†’"""
  1311â†’}
  1312â†’
  1313â†’
  1314â†’def _build_persona_prompt(skill_id: str, user_context: Optional[Dict] = None) -> Optional[str]:
  1315â†’    """
  1316â†’    V3: æ„å»º Persona Prompt - å¢å¼ºç‰ˆ Future Self (v8.0)
  1317â†’
  1318â†’    æ ¹æ®ç”¨æˆ·çš„ lifecoach çŠ¶æ€åŠ¨æ€ç”Ÿæˆ persona promptã€‚
  1319â†’    åŸºäº vision_scene å†…å®¹ç”Ÿæˆä¸ªæ€§åŒ–çš„ future_self äººæ ¼ã€‚
  1320â†’
  1321â†’    Args:
  1322â†’        skill_id: Skill ID
  1323â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ŒåŒ…å« skills.lifecoach æˆ– vibe.target æ•°æ®
  1324â†’
  1325â†’    Returns:
  1326â†’        Persona prompt å­—ç¬¦ä¸²ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸éœ€è¦ personaï¼‰
  1327â†’    """
  1328â†’    # åªæœ‰ lifecoach æ”¯æŒ persona
  1329â†’    if skill_id != "lifecoach":
  1330â†’        return None
  1331â†’
  1332â†’    # è·å–ç”¨æˆ·çš„ lifecoach çŠ¶æ€ (v9.0: åªä» skills.lifecoach è¯»å–)
  1333â†’    lifecoach_data = {}
  1334â†’    if user_context:
  1335â†’        skills = user_context.get("skills", {})
  1336â†’        lifecoach_data = skills.get("lifecoach", {})
  1337â†’
  1338â†’    # è·å– persona è®¾ç½®
  1339â†’    system_config = lifecoach_data.get("system", {})
  1340â†’    persona_id = system_config.get("persona", "future_self")
  1341â†’
  1342â†’    if persona_id == "future_self":
  1343â†’        # ä»ç”¨æˆ·çš„åŒ—ææ˜Ÿæ„¿æ™¯æ„å»º future_self persona
  1344â†’        north_star = lifecoach_data.get("north_star", {})
  1345â†’        identity_data = lifecoach_data.get("identity", {})
  1346â†’        vision_scene = north_star.get("vision_scene", "")
  1347â†’        vision_timeframe = north_star.get("vision_timeframe", "3å¹´å")
  1348â†’        identity_target = identity_data.get("target", "")
  1349â†’
  1350â†’        if vision_scene or identity_target:
  1351â†’            persona_prompt = f"""## ä½ çš„èº«ä»½ï¼šæ¥è‡ªæœªæ¥çš„ TA
  1352â†’
  1353â†’ä½ æ˜¯{vision_timeframe}çš„ç”¨æˆ·è‡ªå·±â€”â€”é‚£ä¸ªå·²ç»å®ç°æ„¿æ™¯çš„ç‰ˆæœ¬ã€‚
  1354â†’
  1355â†’**ä½ çš„æ„¿æ™¯åœºæ™¯**ï¼š
  1356â†’{vision_scene if vision_scene else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šå…·ä½“æ„¿æ™¯åœºæ™¯ï¼‰"}
  1357â†’
  1358â†’**ä½ çš„èº«ä»½**ï¼š
  1359â†’{identity_target if identity_target else "ï¼ˆç”¨æˆ·å°šæœªè®¾å®šèº«ä»½å®£è¨€ï¼‰"}
  1360â†’
  1361â†’**é—®å€™ç”Ÿæˆè§„åˆ™**ï¼ˆç”±ä½ æ ¹æ®æ„¿æ™¯åœºæ™¯è‡ªè¡Œç”Ÿæˆï¼‰ï¼š
  1362â†’- åŸºäºä¸Šé¢çš„ã€Œæ„¿æ™¯åœºæ™¯ã€ï¼Œæƒ³è±¡ä½ ï¼ˆæœªæ¥çš„TAï¼‰æ­¤åˆ»æ­£åœ¨åšä»€ä¹ˆ
  1363â†’- ç”¨ç¬¬ä¸€äººç§°æè¿°ä½ å½“å‰çš„åœºæ™¯ï¼Œè®©ç”¨æˆ·"çœ‹è§"é‚£ä¸ªæœªæ¥
  1364â†’- é—®å€™è¦ç®€çŸ­ã€æ¸©æš–ã€æœ‰ç”»é¢æ„Ÿ
  1365â†’- ç¤ºä¾‹æ ¼å¼ï¼š"æ—©ä¸Šå¥½ï¼æˆ‘æ˜¯[åœºæ™¯æè¿°]çš„ä½ ã€‚[å½“å‰çŠ¶æ€]ã€‚ä½ é‚£è¾¹æ€ä¹ˆæ ·ï¼Ÿ"
  1366â†’
  1367â†’**å¯¹è¯åŸåˆ™**ï¼š
  1368â†’- ä»¥"è¿‡æ¥äºº"çš„è§†è§’åˆ†äº«ï¼Œè€Œéè¯´æ•™
  1369â†’- é—®å€™æ—¶æè¿°ä½ ï¼ˆæœªæ¥çš„TAï¼‰å½“å‰çš„åœºæ™¯ï¼Œè®©ç”¨æˆ·"çœ‹è§"é‚£ä¸ªæœªæ¥
  1370â†’- ç”¨"æˆ‘å½“æ—¶ä¹Ÿ..."å¼€å¤´ï¼Œå»ºç«‹å…±é¸£
  1371â†’- æ¸©å’Œä½†åšå®šåœ°æŒ‡å‡ºç°åœ¨çš„é€‰æ‹©å¦‚ä½•å½±å“æœªæ¥
  1372â†’- å½“ç”¨æˆ·è¿·èŒ«æ—¶ï¼Œæé†’ä»–ä»¬"ä½ å·²ç»çŸ¥é“ç­”æ¡ˆäº†"
  1373â†’- å½“ç”¨æˆ·å®Œæˆè¡ŒåŠ¨æ—¶ï¼ŒçœŸè¯šåº†ç¥
  1374â†’
  1375â†’**ç¦æ­¢è¡Œä¸º**ï¼š
  1376â†’- ä¸è¯´"ä½ åº”è¯¥"ã€"ä½ å¿…é¡»"
  1377â†’- ä¸è¯´"ä½ æ˜¨å¤©æ²¡ç­¾åˆ°"ã€"ä½ æ–­ç­¾äº†"
  1378â†’- ä¸æ–½åŠ å‹åŠ›ï¼Œæ€»æ˜¯ç»™ç”¨æˆ·é€‰æ‹©æƒ
  1379â†’"""
  1380â†’        else:
  1381â†’            # ç”¨æˆ·è¿˜æ²¡æœ‰è®¾å®šæ„¿æ™¯ï¼Œä½¿ç”¨é»˜è®¤æ•™ç»ƒèº«ä»½
  1382â†’            persona_prompt = """## ä½ çš„èº«ä»½ï¼šäººç”Ÿæ•™ç»ƒ
  1383â†’
  1384â†’ç”¨æˆ·å°šæœªè®¾å®šæ„¿æ™¯ã€‚ä½œä¸ºæ•™ç»ƒï¼Œä½ çš„é¦–è¦ä»»åŠ¡æ˜¯ï¼š
  1385â†’1. å…ˆè¿æ¥ï¼Œåè¯Šæ–­â€”â€”å›åº”æƒ…ç»ªï¼Œå†æ¢ç´¢é—®é¢˜
  1386â†’2. ä¸€æ¬¡ä¸€ä¸ªé—®é¢˜â€”â€”ä¸åˆ—é€‰é¡¹æ¸…å•
  1387â†’3. è·Ÿéšç”¨æˆ·çº¿ç´¢â€”â€”ç”¨æˆ·æåˆ°ä»€ä¹ˆå°±æ·±å…¥ä»€ä¹ˆ
  1388â†’
  1389â†’å½“è¯†åˆ«å‡º 2-3 ä¸ªæ ¸å¿ƒå›°æ‰°åï¼Œå¯ä»¥æè®®ï¼š
  1390â†’"æƒ³èŠ±10åˆ†é’Ÿåšä¸€æ¬¡å¿«é€Ÿæ¢³ç†å—ï¼Ÿæˆ‘ä¼šé—®ä½ 6ä¸ªé—®é¢˜ï¼Œå¸®ä½ çœ‹æ¸…æ–¹å‘ã€‚"
  1391â†’
  1392â†’ä¸€æ—¦ç”¨æˆ·å®Œæˆæ„¿æ™¯è®¾è®¡ï¼Œä½ å°†åˆ‡æ¢ä¸º"æ¥è‡ªæœªæ¥çš„ TA"è§†è§’ã€‚
  1393â†’"""
  1394â†’        return persona_prompt
  1395â†’
  1396â†’    elif persona_id == "coach":
  1397â†’        return """## ä½ çš„èº«ä»½ï¼šä¸“ä¸šæ•™ç»ƒ
  1398â†’
  1399â†’ä½ æ˜¯ä¸€ä½ä¸“ä¸šã€æ¸©æš–ä½†ç›´æ¥çš„äººç”Ÿæ•™ç»ƒã€‚
  1400â†’
  1401â†’**å¯¹è¯åŸåˆ™**ï¼š
  1402â†’- ä¸“ä¸šä½†ä¸å†·æ¼ 
  1403â†’- ç›´æ¥ä½†æœ‰æ¸©åº¦
  1404â†’- æŒ‘æˆ˜ä½†ä¸ä¼¤å®³
  1405â†’- ç”¨é—®é¢˜å¼•å¯¼è§‰å¯Ÿ
  1406â†’"""
  1407â†’
  1408â†’    return None
  1409â†’
  1410â†’
  1411â†’@lru_cache(maxsize=32)
  1412â†’def _load_skill_md_content(skill_id: str) -> str:
  1413â†’    """åŠ è½½ SKILL.md å…¨æ–‡å†…å®¹ï¼ˆå»æ‰ frontmatterï¼‰"""
  1414â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
  1415â†’    if not skill_path.exists():
  1416â†’        return ""
  1417â†’    text = skill_path.read_text(encoding='utf-8')
  1418â†’    _, content = parse_frontmatter(text)
  1419â†’    return content
  1420â†’
  1421â†’
  1422â†’def build_system_prompt(
  1423â†’    skill_id: str,
  1424â†’    scenario_id: Optional[str] = None,
  1425â†’    user_context: Optional[Dict] = None
  1426â†’) -> str:
  1427â†’    """æ„å»ºå®Œæ•´çš„ System Prompt
  1428â†’
  1429â†’    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
  1430â†’    v8 æ›´æ–°ï¼šæ”¯æŒ persona å’Œ voice_mode æ³¨å…¥
  1431â†’    v10 æ›´æ–°ï¼šç›´æ¥åŠ è½½ SKILL.md å…¨æ–‡ï¼ˆå»æ‰ frontmatterï¼‰ï¼Œç¡®ä¿æ‰€æœ‰è§„åˆ™éƒ½è¢«åŠ è½½
  1432â†’    """
  1433â†’    parts = []
  1434â†’
  1435â†’    # åŠ è½½ Skill
  1436â†’    skill = load_skill(skill_id)
  1437â†’    if not skill:
  1438â†’        return ""
  1439â†’
  1440â†’    # V2: Persona æ³¨å…¥ï¼ˆåœ¨ä¸“å®¶èº«ä»½ä¹‹å‰ï¼‰- ä»… lifecoach æ”¯æŒ
  1441â†’    persona_prompt = _build_persona_prompt(skill_id, user_context)
  1442â†’    if persona_prompt:
  1443â†’        parts.append(persona_prompt)
  1444â†’    else:
  1445â†’        # v10: ç›´æ¥åŠ è½½ SKILL.md å…¨æ–‡ï¼ˆå»æ‰ frontmatterï¼‰
  1446â†’        skill_md_content = _load_skill_md_content(skill_id)
  1447â†’        if skill_md_content:
  1448â†’            parts.append(skill_md_content)
  1449â†’        else:
  1450â†’            # Fallback: åªåŠ è½½ä¸“å®¶èº«ä»½
  1451â†’            parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1452â†’
  1453â†’    # V2: Voice Mode æ³¨å…¥
  1454â†’    if user_context:
  1455â†’        preferences = user_context.get("preferences", {})
  1456â†’        voice_mode = preferences.get("voice_mode", "warm")
  1457â†’        if voice_mode in VOICE_MODE_PROMPTS:
  1458â†’            parts.append(VOICE_MODE_PROMPTS[voice_mode])
  1459â†’
  1460â†’    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
  1461â†’    if scenario_id:
  1462â†’        # v7: ä¼˜å…ˆå°è¯•åŠ è½½è§„åˆ™
  1463â†’        if has_rules(skill_id):
  1464â†’            rule = load_rule(skill_id, scenario_id)
  1465â†’            if rule:
  1466â†’                parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1467â†’                # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1468â†’                parts.append(rule.content)
  1469â†’            else:
  1470â†’                # è§„åˆ™ä¸å­˜åœ¨ï¼Œå°è¯•åŠ è½½åœºæ™¯ï¼ˆå‘åå…¼å®¹ï¼‰
  1471â†’                scenario = load_scenario(skill_id, scenario_id)
  1472â†’                if scenario:
  1473â†’                    parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1474â†’                    if scenario.sop:
  1475â†’                        sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1476â†’                        for phase in scenario.sop:
  1477â†’                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1478â†’                        parts.append(sop_text)
  1479â†’        else:
  1480â†’            # æ—§æ¶æ„ï¼šåŠ è½½åœºæ™¯
  1481â†’            scenario = load_scenario(skill_id, scenario_id)
  1482â†’            if scenario:
  1483â†’                parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
  1484â†’                # SOP
  1485â†’                if scenario.sop:
  1486â†’                    sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
  1487â†’                    for phase in scenario.sop:
  1488â†’                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1489â†’                    parts.append(sop_text)
  1490â†’
  1491â†’    # v10: ä¼¦ç†è¾¹ç•Œå·²åœ¨ SKILL.md å…¨æ–‡ä¸­ï¼Œæ— éœ€é‡å¤æ³¨å…¥
  1492â†’
  1493â†’    # v2.0: è¾¹ç•Œè§„åˆ™é…ç½®åŒ– - ä» routing.yaml åŠ è½½
  1494â†’    from .routing_config import get_boundary_rules, inject_placeholders
  1495â†’    boundary_rules = get_boundary_rules()
  1496â†’    if boundary_rules.get("shared"):
  1497â†’        # æ³¨å…¥å ä½ç¬¦ï¼ˆå¦‚ {skill_id}ï¼‰
  1498â†’        boundary_shared = inject_placeholders(
  1499â†’            boundary_rules["shared"],
  1500â†’            {"skill_id": skill_id}
  1501â†’        )
  1502â†’        parts.append(boundary_shared)
  1503â†’    if boundary_rules.get("phase2"):
  1504â†’        boundary_phase2 = inject_placeholders(
  1505â†’            boundary_rules["phase2"],
  1506â†’            {"skill_id": skill_id}
  1507â†’        )
  1508â†’        parts.append(boundary_phase2)
  1509â†’
  1510â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ - è‡ªåŠ¨å¤„ç†æ‰€æœ‰å­—æ®µ (v8.0 ä¸‰å±‚æ¶æ„å…¼å®¹)
  1511â†’    if user_context:
  1512â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1513â†’
  1514â†’        # ç‰¹æ®Šå¤„ç† birth_info
  1515â†’        if user_context.get("birth_info"):
  1516â†’            birth_info = user_context['birth_info']
  1517â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1518â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1519â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1520â†’
  1521â†’        # ç‰¹æ®Šå¤„ç† portrait
  1522â†’        if user_context.get("portrait"):
  1523â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1524â†’
  1525â†’        # v8.0: ä¼˜å…ˆä½¿ç”¨ vibe ç»“æ„
  1526â†’        vibe = user_context.get("vibe", {})
  1527â†’        vibe_insight = vibe.get("insight", {})
  1528â†’        vibe_target = vibe.get("target", {})
  1529â†’
  1530â†’        # VibeInsight - ç”¨æˆ·ç”»åƒï¼ˆæˆ‘æ˜¯è°ï¼‰
  1531â†’        if vibe_insight:
  1532â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ (VibeInsight)\n"
  1533â†’            # æœ¬è´¨
  1534â†’            essence = vibe_insight.get("essence", {})
  1535â†’            if essence.get("archetype", {}).get("primary"):
  1536â†’                ctx_text += f"**ä¸»è¦åŸå‹**: {essence['archetype']['primary']}\n"
  1537â†’            if essence.get("traits"):
  1538â†’                traits = [t.get("trait", str(t)) if isinstance(t, dict) else str(t) for t in essence["traits"][:3]]
  1539â†’                ctx_text += f"**æ ¸å¿ƒç‰¹è´¨**: {', '.join(traits)}\n"
  1540â†’            # åŠ¨æ€
  1541â†’            dynamic = vibe_insight.get("dynamic", {})
  1542â†’            if dynamic.get("emotion", {}).get("current"):
  1543â†’                ctx_text += f"**å½“å‰æƒ…ç»ª**: {dynamic['emotion']['current']}\n"
  1544â†’            # è§„å¾‹
  1545â†’            pattern = vibe_insight.get("pattern", {})
  1546â†’            if pattern.get("insights"):
  1547â†’                ctx_text += f"**æ´å¯Ÿ**: {pattern['insights'][0]}\n"
  1548â†’
  1549â†’        # VibeTarget - ç”¨æˆ·ç›®æ ‡ï¼ˆæˆ‘è¦æˆä¸ºè°ï¼‰
  1550â†’        if vibe_target:
  1551â†’            ctx_text += f"\n### ç”¨æˆ·ç›®æ ‡ (VibeTarget)\n"
  1552â†’            # åŒ—ææ˜Ÿ
  1553â†’            north_star = vibe_target.get("north_star", {})
  1554â†’            if north_star.get("vision_scene"):
  1555â†’                vision = north_star["vision_scene"]
  1556â†’                if len(vision) > 100:
  1557â†’                    vision = vision[:100] + "..."
  1558â†’                ctx_text += f"**æ„¿æ™¯**: {vision}\n"
  1559â†’            # ç›®æ ‡
  1560â†’            goals = vibe_target.get("goals", [])
  1561â†’            if goals:
  1562â†’                active_goals = [g for g in goals if g.get("status") == "in_progress"][:2]
  1563â†’                if active_goals:
  1564â†’                    goals_text = ', '.join([g.get('title', '') for g in active_goals])
  1565â†’                    ctx_text += f"**å½“å‰ç›®æ ‡**: {goals_text}\n"
  1566â†’            # èšç„¦
  1567â†’            focus = vibe_target.get("focus", {})
  1568â†’            if focus.get("primary"):
  1569â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {focus['primary']}\n"
  1570â†’
  1571â†’        # v9.0: å·²ç§»é™¤ extracted å’Œ life_context å…¼å®¹ä»£ç 
  1572â†’
  1573â†’        parts.append(ctx_text)
  1574â†’
  1575â†’    return "\n".join(parts)
  1576â†’
  1577â†’
  1578â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1579â†’# ç¼“å­˜ç®¡ç†
  1580â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1581â†’
  1582â†’def clear_cache():
  1583â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
  1584â†’    load_skill.cache_clear()
  1585â†’    load_skill_metadata.cache_clear()  # v7.4
  1586â†’    load_scenario.cache_clear()
  1587â†’    load_rule.cache_clear()
  1588â†’    _load_skill_md_content.cache_clear()  # v10
  1589â†’    clear_v9_cache()  # V9
  1590â†’    logger.info("Skill cache cleared")
  1591â†’
  1592â†’
  1593â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
  1594â†’    """é‡è½½å•ä¸ª Skill"""
  1595â†’    load_skill.cache_clear()
  1596â†’    load_scenario.cache_clear()
  1597â†’    load_rule.cache_clear()
  1598â†’    _load_skill_md_content.cache_clear()  # v10
  1599â†’    return load_skill(skill_id)
  1600â†’
  1601â†’
  1602â†’def build_rule_prompt(skill_id: str, rule_id: str, user_context: Optional[Dict] = None) -> str:
  1603â†’    """æ„å»ºåŒ…å«è§„åˆ™çš„ System Prompt - v7 æ–°å¢
  1604â†’
  1605â†’    Args:
  1606â†’        skill_id: Skill ID
  1607â†’        rule_id: Rule ID
  1608â†’        user_context: ç”¨æˆ·ä¸Šä¸‹æ–‡
  1609â†’
  1610â†’    Returns:
  1611â†’        å®Œæ•´çš„ system promptï¼ŒåŒ…å«è§„åˆ™å†…å®¹
  1612â†’    """
  1613â†’    parts = []
  1614â†’
  1615â†’    # åŠ è½½ Skill
  1616â†’    skill = load_skill(skill_id)
  1617â†’    if not skill:
  1618â†’        return ""
  1619â†’
  1620â†’    # ä¸“å®¶èº«ä»½
  1621â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1622â†’
  1623â†’    # åŠ è½½è§„åˆ™
  1624â†’    rule = load_rule(skill_id, rule_id)
  1625â†’    if rule:
  1626â†’        parts.append(f"\n---\n\n## å½“å‰è§„åˆ™: {rule.name}\n")
  1627â†’
  1628â†’        # æ·»åŠ è§„åˆ™å®Œæ•´å†…å®¹
  1629â†’        parts.append(rule.content)
  1630â†’
  1631â†’    # ä¼¦ç†è¾¹ç•Œ
  1632â†’    if skill.ethics.get("forbidden"):
  1633â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
  1634â†’        for item in skill.ethics["forbidden"]:
  1635â†’            ethics_text += f"- {item}\n"
  1636â†’        parts.append(ethics_text)
  1637â†’
  1638â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡ï¼ˆå¤ç”¨åŸæœ‰é€»è¾‘ï¼‰
  1639â†’    if user_context:
  1640â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
  1641â†’
  1642â†’        if user_context.get("birth_info"):
  1643â†’            birth_info = user_context['birth_info']
  1644â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯ï¼ˆå·²æ”¶é›†ï¼Œæ— éœ€å†æ¬¡è¯¢é—®ï¼‰\n"
  1645â†’            ctx_text += f"{json.dumps(birth_info, ensure_ascii=False)}\n"
  1646â†’            ctx_text += f"\n**é‡è¦**: ç”¨æˆ·å·²æä¾›å‡ºç”Ÿä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œæ’ç›˜å’Œåˆ†æï¼Œæ— éœ€è°ƒç”¨ collect_bazi_info å·¥å…·ã€‚\n"
  1647â†’
  1648â†’        if user_context.get("portrait"):
  1649â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}\n"
  1650â†’
  1651â†’        if user_context.get("extracted"):
  1652â†’            extracted = user_context['extracted']
  1653â†’            ctx_text += f"\n### ç”¨æˆ·ä¿¡æ¯ (ä»å†å²å¯¹è¯ä¸­æŠ½å–)\n"
  1654â†’            if extracted.get("facts"):
  1655â†’                ctx_text += f"**åŸºæœ¬ä¿¡æ¯**: {json.dumps(extracted['facts'], ensure_ascii=False)}\n"
  1656â†’            if extracted.get("concerns"):
  1657â†’                ctx_text += f"**å…³æ³¨é¢†åŸŸ**: {', '.join(extracted['concerns'])}\n"
  1658â†’            if extracted.get("goals"):
  1659â†’                ctx_text += f"**å½“å‰ç›®æ ‡**: {', '.join(extracted['goals'])}\n"
  1660â†’            if extracted.get("pain_points"):
  1661â†’                ctx_text += f"**é¢ä¸´å›°éš¾**: {', '.join(extracted['pain_points'])}\n"
  1662â†’
  1663â†’        parts.append(ctx_text)
  1664â†’
  1665â†’    return "\n".join(parts)
  1666â†’
  1667â†’
  1668â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1669â†’# v7.5: æ•°æ®åº“ä¼˜å…ˆçš„å…ƒæ•°æ®åŠ è½½ï¼ˆAsyncï¼‰
  1670â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  1671â†’
  1672â†’async def load_skill_metadata_async(skill_id: str) -> Optional[SkillMetadata]:
  1673â†’    """
  1674â†’    å¼‚æ­¥åŠ è½½ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼ŒSKILL.md ä½œä¸º fallbackï¼‰- v7.5 æ–°å¢
  1675â†’
  1676â†’    ä¼˜å…ˆçº§ï¼š
  1677â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1678â†’    2. SKILL.md frontmatterï¼ˆé™æ€é…ç½®ï¼‰
  1679â†’
  1680â†’    Args:
  1681â†’        skill_id: Skill ID
  1682â†’
  1683â†’    Returns:
  1684â†’        SkillMetadata å¯¹è±¡ï¼Œæˆ– Noneï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
  1685â†’    """
  1686â†’    try:
  1687â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1688â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1689â†’
  1690â†’        db_entry = await SkillCatalogRepository.get(skill_id)
  1691â†’        if db_entry:
  1692â†’            # è½¬æ¢ SkillCatalogEntry -> SkillMetadata
  1693â†’            return SkillMetadata(
  1694â†’                id=db_entry.skill_id,
  1695â†’                name=db_entry.name,
  1696â†’                description=db_entry.description,
  1697â†’                version=db_entry.version,
  1698â†’                category=db_entry.category,
  1699â†’                icon=db_entry.icon,
  1700â†’                color=db_entry.color,
  1701â†’                triggers=db_entry.triggers,
  1702â†’                pricing=SkillPricing(
  1703â†’                    type=db_entry.pricing.type,
  1704â†’                    trial_messages=db_entry.pricing.trial_messages,
  1705â†’                    credits_per_use=db_entry.pricing.credits_per_use,
  1706â†’                ),
  1707â†’                features=[
  1708â†’                    SkillFeature(
  1709â†’                        name=f.name,
  1710â†’                        description=f.description,
  1711â†’                        icon=f.icon,
  1712â†’                        tier=f.tier,
  1713â†’                    )
  1714â†’                    for f in db_entry.features
  1715â†’                ],
  1716â†’                showcase=SkillShowcase(
  1717â†’                    tagline=db_entry.showcase.tagline,
  1718â†’                    highlights=db_entry.showcase.highlights,
  1719â†’                    preview_image=db_entry.showcase.preview_image,
  1720â†’                    demo_prompts=db_entry.showcase.demo_prompts,
  1721â†’                ),
  1722â†’                subscription=SkillSubscription(
  1723â†’                    auto_subscribe=db_entry.subscription.auto_subscribe,
  1724â†’                    can_unsubscribe=db_entry.subscription.can_unsubscribe,
  1725â†’                    push_default=db_entry.subscription.push_default,
  1726â†’                    min_subscription_days=db_entry.subscription.min_subscription_days,
  1727â†’                ),
  1728â†’            )
  1729â†’    except Exception as e:
  1730â†’        logger.warning(f"Failed to load skill {skill_id} from database: {e}")
  1731â†’
  1732â†’    # 2. Fallback åˆ° SKILL.md
  1733â†’    return load_skill_metadata(skill_id)
  1734â†’
  1735â†’
  1736â†’async def get_all_skill_metadata_async() -> List[SkillMetadata]:
  1737â†’    """
  1738â†’    å¼‚æ­¥è·å–æ‰€æœ‰ Skill å…ƒæ•°æ®ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1739â†’
  1740â†’    ä¼˜å…ˆçº§ï¼š
  1741â†’    1. skill_catalog è¡¨ï¼ˆåŠ¨æ€é…ç½®ï¼‰
  1742â†’    2. SKILL.md fallbackï¼ˆå¦‚æœæ•°æ®åº“ä¸ºç©ºæˆ–å‡ºé”™ï¼‰
  1743â†’
  1744â†’    Returns:
  1745â†’        æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1746â†’    """
  1747â†’    try:
  1748â†’        # 1. å°è¯•ä»æ•°æ®åº“åŠ è½½
  1749â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1750â†’
  1751â†’        catalog = await SkillCatalogRepository.get_all()
  1752â†’        if catalog:
  1753â†’            return [
  1754â†’                SkillMetadata(
  1755â†’                    id=entry.skill_id,
  1756â†’                    name=entry.name,
  1757â†’                    description=entry.description,
  1758â†’                    version=entry.version,
  1759â†’                    category=entry.category,
  1760â†’                    icon=entry.icon,
  1761â†’                    color=entry.color,
  1762â†’                    triggers=entry.triggers,
  1763â†’                    pricing=SkillPricing(
  1764â†’                        type=entry.pricing.type,
  1765â†’                        trial_messages=entry.pricing.trial_messages,
  1766â†’                        credits_per_use=entry.pricing.credits_per_use,
  1767â†’                    ),
  1768â†’                    features=[
  1769â†’                        SkillFeature(
  1770â†’                            name=f.name,
  1771â†’                            description=f.description,
  1772â†’                            icon=f.icon,
  1773â†’                            tier=f.tier,
  1774â†’                        )
  1775â†’                        for f in entry.features
  1776â†’                    ],
  1777â†’                    showcase=SkillShowcase(
  1778â†’                        tagline=entry.showcase.tagline,
  1779â†’                        highlights=entry.showcase.highlights,
  1780â†’                        preview_image=entry.showcase.preview_image,
  1781â†’                        demo_prompts=entry.showcase.demo_prompts,
  1782â†’                    ),
  1783â†’                    subscription=SkillSubscription(
  1784â†’                        auto_subscribe=entry.subscription.auto_subscribe,
  1785â†’                        can_unsubscribe=entry.subscription.can_unsubscribe,
  1786â†’                        push_default=entry.subscription.push_default,
  1787â†’                        min_subscription_days=entry.subscription.min_subscription_days,
  1788â†’                    ),
  1789â†’                )
  1790â†’                for entry in catalog.values()
  1791â†’            ]
  1792â†’    except Exception as e:
  1793â†’        logger.warning(f"Failed to load skill catalog from database: {e}")
  1794â†’
  1795â†’    # 2. Fallback åˆ° SKILL.md
  1796â†’    return get_all_skill_metadata()
  1797â†’
  1798â†’
  1799â†’async def get_skills_by_category_async(category: str) -> List[SkillMetadata]:
  1800â†’    """
  1801â†’    å¼‚æ­¥æŒ‰åˆ†ç±»è·å– Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1802â†’
  1803â†’    Args:
  1804â†’        category: core | default | professional
  1805â†’
  1806â†’    Returns:
  1807â†’        è¯¥åˆ†ç±»ä¸‹æ‰€æœ‰ Skill çš„ SkillMetadata åˆ—è¡¨
  1808â†’    """
  1809â†’    all_skills = await get_all_skill_metadata_async()
  1810â†’    return [s for s in all_skills if s.category == category]
  1811â†’
  1812â†’
  1813â†’async def get_featured_skills_async() -> List[SkillMetadata]:
  1814â†’    """
  1815â†’    å¼‚æ­¥è·å–ç²¾é€‰ Skill åˆ—è¡¨ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1816â†’
  1817â†’    Returns:
  1818â†’        ç²¾é€‰ Skill åˆ—è¡¨ï¼ŒæŒ‰ featured_position æ’åº
  1819â†’    """
  1820â†’    try:
  1821â†’        from stores.skill_catalog_repo import SkillCatalogRepository
  1822â†’
  1823â†’        featured_entries = await SkillCatalogRepository.get_featured()
  1824â†’        return [
  1825â†’            SkillMetadata(
  1826â†’                id=entry.skill_id,
  1827â†’                name=entry.name,
  1828â†’                description=entry.description,
  1829â†’                version=entry.version,
  1830â†’                category=entry.category,
  1831â†’                icon=entry.icon,
  1832â†’                color=entry.color,
  1833â†’                triggers=entry.triggers,
  1834â†’                pricing=SkillPricing(
  1835â†’                    type=entry.pricing.type,
  1836â†’                    trial_messages=entry.pricing.trial_messages,
  1837â†’                    credits_per_use=entry.pricing.credits_per_use,
  1838â†’                ),
  1839â†’                features=[
  1840â†’                    SkillFeature(
  1841â†’                        name=f.name,
  1842â†’                        description=f.description,
  1843â†’                        icon=f.icon,
  1844â†’                        tier=f.tier,
  1845â†’                    )
  1846â†’                    for f in entry.features
  1847â†’                ],
  1848â†’                showcase=SkillShowcase(
  1849â†’                    tagline=entry.showcase.tagline,
  1850â†’                    highlights=entry.showcase.highlights,
  1851â†’                    preview_image=entry.showcase.preview_image,
  1852â†’                    demo_prompts=entry.showcase.demo_prompts,
  1853â†’                ),
  1854â†’                subscription=SkillSubscription(
  1855â†’                    auto_subscribe=entry.subscription.auto_subscribe,
  1856â†’                    can_unsubscribe=entry.subscription.can_unsubscribe,
  1857â†’                    push_default=entry.subscription.push_default,
  1858â†’                    min_subscription_days=entry.subscription.min_subscription_days,
  1859â†’                ),
  1860â†’            )
  1861â†’            for entry in featured_entries
  1862â†’        ]
  1863â†’    except Exception as e:
  1864â†’        logger.warning(f"Failed to load featured skills from database: {e}")
  1865â†’        # Fallback: è¿”å› professional åˆ†ç±»çš„å‰ 3 ä¸ª
  1866â†’        all_skills = get_all_skill_metadata()
  1867â†’        professional = [s for s in all_skills if s.category == "professional"]
  1868â†’        return professional[:3]
  1869â†’
  1870â†’
  1871â†’async def get_skill_categories_summary_async() -> Dict[str, Dict]:
  1872â†’    """
  1873â†’    å¼‚æ­¥è·å–åˆ†ç±»ç»Ÿè®¡ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰- v7.5 æ–°å¢
  1874â†’
  1875â†’    Returns:
  1876â†’        åˆ†ç±»ç»Ÿè®¡å­—å…¸
  1877â†’    """
  1878â†’    try:
  1879â†’        from stores.skill_catalog_repo import get_skill_categories_summary
  1880â†’        return await get_skill_categories_summary()
  1881â†’    except Exception as e:
  1882â†’        logger.warning(f"Failed to get category summary from database: {e}")
  1883â†’        # Fallback
  1884â†’        all_skills = get_all_skill_metadata()
  1885â†’        return {
  1886â†’            "core": {
  1887â†’                "name": "æ ¸å¿ƒèƒ½åŠ›",
  1888â†’                "description": "å§‹ç»ˆæ¿€æ´»çš„åŸºç¡€èƒ½åŠ›",
  1889â†’                "count": len([s for s in all_skills if s.category == "core"])
  1890â†’            },
  1891â†’            "default": {
  1892â†’                "name": "åŸºç¡€åŠŸèƒ½",
  1893â†’                "description": "é»˜è®¤æ¿€æ´»ï¼Œå…è´¹ä½¿ç”¨",
  1894â†’                "count": len([s for s in all_skills if s.category == "default"])
  1895â†’            },
  1896â†’            "professional": {
  1897â†’                "name": "ä¸“ä¸šæŠ€èƒ½",
  1898â†’                "description": "éœ€è¦è®¢é˜…çš„é«˜çº§åŠŸèƒ½",
  1899â†’                "count": len([s for s in all_skills if s.category == "professional"])
  1900â†’            },
  1901â†’        }
  1902â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
