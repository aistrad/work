     1→# VibeLife 矩阵战略架构方案
     2→
     3→> **文档版本**: v1.0
     4→> **更新日期**: 2026-01-07
     5→> **战略阶段**: Phase 1 & 2 去中心化流量验证 → Phase 3 中心化生态聚合
     6→
     7→---
     8→
     9→## 1. 战略概述
    10→
    11→### 1.1 矩阵战略核心
    12→
    13→| 阶段 | 目标 | 架构特征 |
    14→|------|------|----------|
    15→| **Phase 1** | 去中心化获客 + 验证 | 独立子域名，快速试错 |
    16→| **Phase 2** | 矩阵扩展 + 交叉销售 | 统一账户，独立收费 |
    17→| **Phase 3** | 中心化生态 | 主 App 聚合，子域名变落地页 |
    18→
    19→### 1.2 核心决策
    20→
    21→| 决策点 | 选择 | 理由 |
    22→|--------|------|------|
    23→| **域名策略** | 子域名 (Subdomain) | 工程速度 + 风险隔离 + 独立品牌感 |
    24→| **命名风格** | 直接命名 (bazi/zodiac) | SEO 友好 + 中文用户易记 |
    25→| **路由策略** | 路由组物理隔离 | (bazi)/ (zodiac)/ 独立页面文件，深度定制 UI |
    26→| **账户体系** | 共享注册登录 | Cookie 设在 .vibelife.app，跨子域名 SSO |
    27→| **收费模式** | 各 Skill 独立收费 | 系统支持差异化定价，具体价格待定 |
    28→| **数据策略** | 深度共享 | 「了解你越多越深」核心价值 |
    29→| **视觉关联** | 强关联 - 统一顶栏 | 品牌矩阵感 |
    30→| **主站定位** | 品牌索引页 (Phase 1) | www.vibelife.app 作为品牌入口 |
    31→| **支付架构** | Stripe + Airwallex 双轨 | 海外主体，国内外用户各半 |
    32→| **定价币种** | 双币种 (CNY/USD) | 根据用户地区自动切换 |
    33→| **计费模型** | 订阅 + 单次 + 增值服务 | 灵活的商业模式 |
    34→
    35→---
    36→
    37→## 2. 域名架构
    38→
    39→### 2.1 子域名规划
    40→
    41→```
    42→┌─────────────────────────────────────────────────────────────────┐
    43→│                     vibelife.app 域名矩阵                        │
    44→├─────────────────────────────────────────────────────────────────┤
    45→│                                                                 │
    46→│   www.vibelife.app          ← 品牌索引页（Phase 1）             │
    47→│        │                                                        │
    48→│        ├── bazi.vibelife.app    ← 八字命理（P1 上线）           │
    49→│        │                                                        │
    50→│        ├── zodiac.vibelife.app  ← 星座占星（P1 上线）           │
    51→│        │                                                        │
    52→│        ├── mbti.vibelife.app    ← MBTI 人格（P2 规划）          │
    53→│        │                                                        │
    54→│        ├── career.vibelife.app  ← 职业发展（P2 规划）           │
    55→│        │                                                        │
    56→│        └── app.vibelife.app     ← 主 App（Phase 3）             │
    57→│                                                                 │
    58→└─────────────────────────────────────────────────────────────────┘
    59→```
    60→
    61→### 2.2 DNS 配置
    62→
    63→```
    64→# Vercel/Cloudflare DNS 配置
    65→*.vibelife.app    CNAME    cname.vercel-dns.com
    66→www.vibelife.app  CNAME    cname.vercel-dns.com
    67→```
    68→
    69→### 2.3 Vercel 配置 (vercel.json)
    70→
    71→> **路由策略**：采用路由组物理隔离模式，每个子域名映射到对应的路由组目录，实现深度定制 UI。
    72→
    73→```json
    74→{
    75→  "rewrites": [
    76→    {
    77→      "source": "/:path*",
    78→      "has": [{ "type": "host", "value": "www.vibelife.app" }],
    79→      "destination": "/www/:path*"
    80→    },
    81→    {
    82→      "source": "/:path*",
    83→      "has": [{ "type": "host", "value": "bazi.vibelife.app" }],
    84→      "destination": "/bazi/:path*"
    85→    },
    86→    {
    87→      "source": "/:path*",
    88→      "has": [{ "type": "host", "value": "zodiac.vibelife.app" }],
    89→      "destination": "/zodiac/:path*"
    90→    }
    91→  ]
    92→}
    93→```
    94→
    95→---
    96→
    97→## 3. 账户与认证架构
    98→
    99→### 3.1 共享账户 + 独立订阅模型
   100→
   101→```
   102→┌─────────────────────────────────────────────────────────────────┐
   103→│                        用户账户层（全局共享）                     │
   104→│                                                                 │
   105→│   ┌─────────────────────────────────────────────────────────┐   │
   106→│   │  User                                                   │   │
   107→│   │  ├── id: UUID (全局唯一)                                │   │
   108→│   │  ├── email / phone / oauth_provider                     │   │
   109→│   │  ├── created_at                                         │   │
   110→│   │  └── Cookie Domain: .vibelife.app (根域名)              │   │
   111→│   └─────────────────────────────────────────────────────────┘   │
   112→│                              │                                   │
   113→│              ┌───────────────┼───────────────┐                   │
   114→│              ▼               ▼               ▼                   │
   115→│   ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐   │
   116→│   │  Bazi Profile   │ │ Zodiac Profile  │ │  MBTI Profile   │   │
   117→│   │                 │ │                 │ │                 │   │
   118→│   │ • 命盘数据      │ │ • 星盘数据      │ │ • 类型数据      │   │
   119→│   │ • 对话历史      │ │ • 对话历史      │ │ • 对话历史      │   │
   120→│   │ • 报告记录      │ │ • 报告记录      │ │ • 报告记录      │   │
   121→│   └────────┬────────┘ └────────┬────────┘ └────────┬────────┘   │
   122→│            │                   │                   │             │
   123→│   ┌────────▼────────┐ ┌────────▼────────┐ ┌────────▼────────┐   │
   124→│   │ Bazi Subscribe  │ │Zodiac Subscribe │ │ MBTI Subscribe  │   │
   125→│   │                 │ │                 │ │                 │   │
   126→│   │ tier: pro       │ │ tier: free      │ │ tier: free      │   │
   127→│   │ price: ¥19.9/mo │ │ price: ¥19.9/mo │ │ price: ¥19.9/mo │   │
   128→│   └─────────────────┘ └─────────────────┘ └─────────────────┘   │
   129→│                                                                 │
   130→├─────────────────────────────────────────────────────────────────┤
   131→│                        共享数据层                                │
   132→│                                                                 │
   133→│   ┌─────────────────────────────────────────────────────────┐   │
   134→│   │  Shared Profile (深度共享)                              │   │
   135→│   │  ├── basic: { birth_datetime, birth_location, gender }  │   │
   136→│   │  ├── life_context: { career, relationship, events }     │   │
   137→│   │  ├── ai_insights: { traits, patterns, growth_areas }    │   │
   138→│   │  └── identity_prism: { core, inner, outer }             │   │
   139→│   └─────────────────────────────────────────────────────────┘   │
   140→│                                                                 │
   141→└─────────────────────────────────────────────────────────────────┘
   142→```
   143→
   144→### 3.2 SSO 技术实现
   145→
   146→**Cookie 设置（根域名共享）**：
   147→```typescript
   148→// apps/api/services/identity/auth.py
   149→def set_auth_cookie(response: Response, token: str):
   150→    response.set_cookie(
   151→        key="vibelife_token",
   152→        value=token,
   153→        domain=".vibelife.app",  # 关键：根域名
   154→        httponly=True,
   155→        secure=True,
   156→        samesite="lax",
   157→        max_age=60 * 60 * 24 * 30  # 30 天
   158→    )
   159→```
   160→
   161→**前端 Cookie 读取**：
   162→```typescript
   163→// apps/web/src/lib/auth.ts
   164→export function getAuthToken(): string | null {
   165→  // Cookie 自动在所有 *.vibelife.app 子域名共享
   166→  return Cookies.get('vibelife_token');
   167→}
   168→```
   169→
   170→### 3.3 数据库 Schema 扩展
   171→
   172→```sql
   173→-- 用户表（已有）
   174→CREATE TABLE users (
   175→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   176→    email TEXT UNIQUE,
   177→    phone TEXT UNIQUE,
   178→    created_at TIMESTAMPTZ DEFAULT NOW()
   179→);
   180→
   181→-- 订阅表（按 Skill 独立）
   182→CREATE TABLE subscriptions (
   183→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   184→    user_id UUID REFERENCES users(id),
   185→    skill TEXT NOT NULL,  -- 'bazi', 'zodiac', 'mbti', 'career'
   186→    tier TEXT NOT NULL DEFAULT 'free',  -- 'free', 'pro', 'premium'
   187→    price_cents INT,  -- 支持差异化定价
   188→    status TEXT NOT NULL DEFAULT 'active',
   189→    starts_at TIMESTAMPTZ DEFAULT NOW(),
   190→    expires_at TIMESTAMPTZ,
   191→    stripe_subscription_id TEXT,
   192→    UNIQUE(user_id, skill)
   193→);
   194→
   195→-- Phase 2: 全家桶套餐
   196→CREATE TABLE bundle_subscriptions (
   197→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   198→    user_id UUID REFERENCES users(id),
   199→    bundle_type TEXT NOT NULL,  -- 'all_access'
   200→    price_cents INT,
   201→    status TEXT,
   202→    starts_at TIMESTAMPTZ,
   203→    expires_at TIMESTAMPTZ
   204→);
   205→
   206→-- 共享 Profile（已有 user_profiles 表）
   207→-- ai_insights, identity_prism 等数据全局共享
   208→
   209→-- Skill 专属数据
   210→CREATE TABLE skill_data (
   211→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   212→    user_id UUID REFERENCES users(id),
   213→    skill TEXT NOT NULL,
   214→    data_type TEXT NOT NULL,  -- 'conversation', 'report', 'chart'
   215→    data JSONB,
   216→    created_at TIMESTAMPTZ DEFAULT NOW()
   217→);
   218→```
   219→
   220→---
   221→
   222→## 4. 前端架构
   223→
   224→### 4.1 代码组织（Monorepo + 路由组）
   225→
   226→```
   227→apps/web/src/
   228→├── app/
   229→│   │
   230→│   ├── (www)/                    # 主站（品牌索引页）
   231→│   │   ├── layout.tsx            # 主站布局
   232→│   │   └── page.tsx              # 品牌索引页
   233→│   │
   234→│   ├── (bazi)/                   # Bazi 路由组
   235→│   │   ├── layout.tsx            # Bazi 专属布局
   236→│   │   ├── page.tsx              # Bazi 首页
   237→│   │   ├── chat/page.tsx         # 聊天
   238→│   │   ├── chart/page.tsx        # 命盘
   239→│   │   ├── report/page.tsx       # 报告
   240→│   │   └── relationship/page.tsx # 关系
   241→│   │
   242→│   ├── (zodiac)/                 # Zodiac 路由组
   243→│   │   ├── layout.tsx            # Zodiac 专属布局
   244→│   │   ├── page.tsx              # Zodiac 首页
   245→│   │   ├── chat/page.tsx
   246→│   │   ├── chart/page.tsx
   247→│   │   ├── report/page.tsx
   248→│   │   └── relationship/page.tsx
   249→│   │
   250→│   ├── (shared)/                 # 共享路由
   251→│   │   ├── auth/
   252→│   │   │   ├── login/page.tsx
   253→│   │   │   ├── register/page.tsx
   254→│   │   │   └── sso-callback/page.tsx
   255→│   │   └── me/
   256→│   │       ├── page.tsx          # 个人中心
   257→│   │       └── subscriptions/page.tsx  # 订阅管理
   258→│   │
   259→│   └── middleware.ts             # 子域名路由中间件
   260→│
   261→├── components/
   262→│   ├── core/                     # 共享核心组件
   263→│   │   ├── LuminousPaper.tsx
   264→│   │   ├── BreathAura.tsx
   265→│   │   ├── InsightCard.tsx
   266→│   │   └── GlobalNav.tsx         # 统一顶栏
   267→│   │
   268→│   ├── chat/                     # 共享聊天组件
   269→│   │   ├── ChatContainer.tsx
   270→│   │   ├── ChatMessage.tsx
   271→│   │   └── ChatInput.tsx
   272→│   │
   273→│   ├── bazi/                     # Bazi 专属组件
   274→│   │   ├── BaziChart.tsx
   275→│   │   ├── WuxingDisplay.tsx
   276→│   │   ├── DayunTimeline.tsx
   277→│   │   └── BaziThemeProvider.tsx
   278→│   │
   279→│   └── zodiac/                   # Zodiac 专属组件
   280→│       ├── NatalChart.tsx
   281→│       ├── PlanetPositions.tsx
   282→│       ├── TransitOverlay.tsx
   283→│       └── ZodiacThemeProvider.tsx
   284→│
   285→└── styles/
   286→    ├── globals.css               # 共享基础样式
   287→    ├── themes/
   288→    │   ├── bazi.css              # 玄金 #8B7355 + 朱砂 #C45C48
   289→    │   └── zodiac.css            # 星蓝 #4A5568 + 金线 #D4AF37
   290→    └── components/               # 组件样式
   291→```
   292→
   293→### 4.2 Middleware 子域名路由
   294→
   295→```typescript
   296→// apps/web/src/middleware.ts
   297→import { NextRequest, NextResponse } from 'next/server';
   298→
   299→const SKILL_DOMAINS: Record<string, string> = {
   300→  'bazi': 'bazi',
   301→  'zodiac': 'zodiac',
   302→  'mbti': 'mbti',
   303→  'career': 'career',
   304→  'www': 'www',
   305→};
   306→
   307→export function middleware(request: NextRequest) {
   308→  const hostname = request.headers.get('host') || '';
   309→  const subdomain = hostname.split('.')[0];
   310→
   311→  // 识别 skill
   312→  const skill = SKILL_DOMAINS[subdomain] || 'bazi';
   313→
   314→  // 设置 skill 到 Cookie 和 Header
   315→  const response = NextResponse.next();
   316→  response.cookies.set('vibelife_skill', skill, {
   317→    domain: '.vibelife.app',
   318→    path: '/',
   319→  });
   320→  response.headers.set('x-vibelife-skill', skill);
   321→
   322→  return response;
   323→}
   324→
   325→export const config = {
   326→  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],
   327→};
   328→```
   329→
   330→### 4.3 统一顶栏组件
   331→
   332→```typescript
   333→// apps/web/src/components/core/GlobalNav.tsx
   334→'use client';
   335→
   336→import { useSkill } from '@/providers/SkillProvider';
   337→import Link from 'next/link';
   338→
   339→const SKILL_LINKS = [
   340→  { skill: 'bazi', label: '八字', href: 'https://bazi.vibelife.app' },
   341→  { skill: 'zodiac', label: '星座', href: 'https://zodiac.vibelife.app' },
   342→  { skill: 'mbti', label: 'MBTI', href: 'https://mbti.vibelife.app', disabled: true },
   343→];
   344→
   345→export function GlobalNav() {
   346→  const { skill: currentSkill } = useSkill();
   347→
   348→  return (
   349→    <nav className="h-12 border-b border-vellum-200 bg-vellum/80 backdrop-blur">
   350→      <div className="flex items-center justify-between px-4 h-full">
   351→        {/* Logo */}
   352→        <Link href="https://www.vibelife.app" className="flex items-center gap-2">
   353→          <span className="text-lg font-serif text-ink">VibeLife</span>
   354→        </Link>
   355→
   356→        {/* Skill 导航 */}
   357→        <div className="flex items-center gap-4">
   358→          {SKILL_LINKS.map(({ skill, label, href, disabled }) => (
   359→            <a
   360→              key={skill}
   361→              href={disabled ? undefined : href}
   362→              className={`
   363→                text-sm transition-colors
   364→                ${currentSkill === skill
   365→                  ? 'text-ink font-medium'
   366→                  : 'text-ink/60 hover:text-ink'}
   367→                ${disabled ? 'opacity-40 cursor-not-allowed' : ''}
   368→              `}
   369→            >
   370→              {label}
   371→            </a>
   372→          ))}
   373→        </div>
   374→
   375→        {/* 用户菜单 */}
   376→        <UserMenu />
   377→      </div>
   378→    </nav>
   379→  );
   380→}
   381→```
   382→
   383→---
   384→
   385→## 5. 后端服务架构
   386→
   387→### 5.1 服务共享模型
   388→
   389→```
   390→┌─────────────────────────────────────────────────────────────────┐
   391→│                        API Gateway                               │
   392→│                   api.vibelife.app                              │
   393→├─────────────────────────────────────────────────────────────────┤
   394→│                                                                 │
   395→│   所有子域名共享同一个后端 API                                    │
   396→│                                                                 │
   397→│   bazi.vibelife.app  ─┐                                        │
   398→│                       │                                         │
   399→│   zodiac.vibelife.app ├──▶  api.vibelife.app                   │
   400→│                       │                                         │
   401→│   mbti.vibelife.app  ─┘                                        │
   402→│                                                                 │
   403→├─────────────────────────────────────────────────────────────────┤
   404→│                                                                 │
   405→│   API 路由                                                      │
   406→│   ─────────────────────────────────────────────────────────     │
   407→│                                                                 │
   408→│   POST /api/v1/chat/stream                                      │
   409→│        Body: { skill: "bazi", message: "..." }                  │
   410→│                                                                 │
   411→│   POST /api/v1/report/generate                                  │
   412→│        Body: { skill: "zodiac", level: "full" }                 │
   413→│                                                                 │
   414→│   GET /api/v1/user/subscriptions                                │
   415→│        Response: [                                              │
   416→│          { skill: "bazi", tier: "pro", expires_at: "..." },     │
   417→│          { skill: "zodiac", tier: "free" }                      │
   418→│        ]                                                        │
   419→│                                                                 │
   420→└─────────────────────────────────────────────────────────────────┘
   421→```
   422→
   423→### 5.2 订阅验证中间件
   424→
   425→```python
   426→# apps/api/middleware/subscription.py
   427→from functools import wraps
   428→from fastapi import HTTPException, Request
   429→
   430→def require_subscription(skill: str, min_tier: str = "pro"):
   431→    """检查用户是否有指定 Skill 的订阅"""
   432→    def decorator(func):
   433→        @wraps(func)
   434→        async def wrapper(request: Request, *args, **kwargs):
   435→            user_id = request.state.user_id
   436→
   437→            # 检查订阅
   438→            subscription = await get_user_subscription(user_id, skill)
   439→
   440→            if not subscription or subscription.tier < min_tier:
   441→                raise HTTPException(
   442→                    status_code=402,
   443→                    detail={
   444→                        "error": "subscription_required",
   445→                        "skill": skill,
   446→                        "required_tier": min_tier,
   447→                        "current_tier": subscription.tier if subscription else "free"
   448→                    }
   449→                )
   450→
   451→            return await func(request, *args, **kwargs)
   452→        return wrapper
   453→    return decorator
   454→
   455→# 使用示例
   456→@router.post("/report/generate")
   457→@require_subscription(skill_from_body=True, min_tier="pro")
   458→async def generate_report(request: ReportRequest):
   459→    ...
   460→```
   461→
   462→### 5.3 定价配置
   463→
   464→> **定价策略**：Phase 1 定价待定，系统先支持差异化定价能力。以下为示例配置。
   465→
   466→```python
   467→# apps/api/config/pricing.py
   468→from typing import Dict
   469→from dataclasses import dataclass
   470→
   471→@dataclass
   472→class SkillPricing:
   473→    skill: str
   474→    tiers: Dict[str, int]  # tier -> price_cents
   475→
   476→# Phase 1: 定价待定，系统支持差异化定价
   477→# 以下为示例配置，上线前确认具体价格
   478→SKILL_PRICING = {
   479→    "bazi": SkillPricing(
   480→        skill="bazi",
   481→        tiers={
   482→            "free": 0,
   483→            "pro": 1990,      # ¥19.9/月（待定）
   484→            "premium": 2990,  # ¥29.9/月（预留）
   485→        }
   486→    ),
   487→    "zodiac": SkillPricing(
   488→        skill="zodiac",
   489→        tiers={
   490→            "free": 0,
   491→            "pro": 1990,      # ¥19.9/月（待定）
   492→            "premium": 2990,
   493→        }
   494→    ),
   495→}
   496→
   497→# Phase 2: 全家桶套餐
   498→BUNDLE_PRICING = {
   499→    "all_access": {
   500→        "monthly": 4990,   # ¥49.9/月
   501→        "yearly": 39900,   # ¥399/年
   502→    }
   503→}
   504→```
   505→
   506→---
   507→
   508→## 6. 支付与收费架构
   509→
   510→### 6.1 支付服务商策略
   511→
   512→> **核心决策**：网站部署海外，仅海外主体，采用 **Stripe 为主 + Airwallex 补充** 的双轨支付架构。
   513→
   514→```
   515→┌─────────────────────────────────────────────────────────────────┐
   516→│                        支付架构总览                              │
   517→├─────────────────────────────────────────────────────────────────┤
   518→│                                                                 │
   519→│   用户地区识别                                                   │
   520→│        │                                                        │
   521→│        ├─── 海外用户 ──────────────────────┐                    │
   522→│        │                                   │                    │
   523→│        │    ┌─────────────────────────┐    │                    │
   524→│        │    │       Stripe            │    │                    │
   525→│        │    │                         │    │                    │
   526→│        │    │  • Credit Card          │    │                    │
   527→│        │    │  • Apple Pay            │    │                    │
   528→│        │    │  • Google Pay           │    │                    │
   529→│        │    │  • PayPal (via Stripe)  │    │                    │
   530→│        │    └─────────────────────────┘    │                    │
   531→│        │                                   │                    │
   532→│        └─── 国内用户 ──────────────────────┤                    │
   533→│                                            │                    │
   534→│             ┌─────────────────────────┐    │                    │
   535→│             │      Airwallex          │    │                    │
   536→│             │    (跨境收单)            │    │                    │
   537→│             │                         │    │                    │
   538→│             │  • 微信支付 (WeChat Pay) │    │                    │
   539→│             │  • 支付宝 (Alipay)       │    │                    │
   540→│             └─────────────────────────┘    │                    │
   541→│                                            │                    │
   542→│                                            ▼                    │
   543→│                              ┌─────────────────────────┐        │
   544→│                              │     海外银行账户         │        │
   545→│                              │   (统一结算)            │        │
   546→│                              └─────────────────────────┘        │
   547→│                                                                 │
   548→└─────────────────────────────────────────────────────────────────┘
   549→```
   550→
   551→### 6.2 Stripe vs Airwallex 对比
   552→
   553→| 维度 | Stripe | Airwallex |
   554→|------|--------|-----------|
   555→| **海外信用卡** | ✅ 最佳体验 | ✅ 支持 |
   556→| **Apple Pay / Google Pay** | ✅ 原生支持 | ⚠️ 有限支持 |
   557→| **微信支付 (跨境)** | ⚠️ 需中国实体 | ✅ 海外主体可用 |
   558→| **支付宝 (跨境)** | ⚠️ 需中国实体 | ✅ 海外主体可用 |
   559→| **订阅管理** | ✅ Stripe Billing 强大 | ⚠️ 需自建 |
   560→| **费率 (海外)** | 2.9% + $0.30 | 2.5% + $0.30 |
   561→| **费率 (国内)** | N/A | 3.5% + ¥0.50 |
   562→| **适用场景** | 海外用户为主 | 国内用户跨境收款 |
   563→
   564→### 6.3 双轨支付技术实现
   565→
   566→```python
   567→# apps/api/services/billing/payment_router.py
   568→from enum import Enum
   569→from typing import Optional
   570→
   571→class PaymentProvider(Enum):
   572→    STRIPE = "stripe"
   573→    AIRWALLEX = "airwallex"
   574→
   575→class PaymentRouter:
   576→    """根据用户地区和支付方式路由到对应支付服务商"""
   577→
   578→    def get_provider(
   579→        self,
   580→        user_region: str,
   581→        payment_method: str
   582→    ) -> PaymentProvider:
   583→        # 国内用户 + 微信/支付宝 → Airwallex
   584→        if user_region == "CN" and payment_method in ["wechat_pay", "alipay"]:
   585→            return PaymentProvider.AIRWALLEX
   586→
   587→        # 其他情况 → Stripe
   588→        return PaymentProvider.STRIPE
   589→
   590→    async def create_checkout_session(
   591→        self,
   592→        user_id: str,
   593→        product_type: str,  # 'subscription' | 'one_time' | 'addon'
   594→        product_id: str,
   595→        currency: str,
   596→        user_region: str,
   597→        payment_method: Optional[str] = None
   598→    ):
   599→        provider = self.get_provider(user_region, payment_method)
   600→
   601→        if provider == PaymentProvider.STRIPE:
   602→            return await self.stripe_service.create_session(...)
   603→        else:
   604→            return await self.airwallex_service.create_session(...)
   605→```
   606→
   607→### 6.4 双币种定价策略
   608→
   609→```python
   610→# apps/api/config/pricing.py
   611→from dataclasses import dataclass
   612→from typing import Dict
   613→
   614→@dataclass
   615→class MultiCurrencyPrice:
   616→    cny: int  # 人民币（分）
   617→    usd: int  # 美元（美分）
   618→
   619→# 订阅定价（双币种）
   620→SUBSCRIPTION_PRICING = {
   621→    "bazi": {
   622→        "pro": {
   623→            "monthly": MultiCurrencyPrice(cny=1990, usd=299),   # ¥19.9 / $2.99
   624→            "yearly": MultiCurrencyPrice(cny=15900, usd=2399),  # ¥159 / $23.99
   625→        }
   626→    },
   627→    "zodiac": {
   628→        "pro": {
   629→            "monthly": MultiCurrencyPrice(cny=1990, usd=299),
   630→            "yearly": MultiCurrencyPrice(cny=15900, usd=2399),
   631→        }
   632→    },
   633→}
   634→
   635→# 单次购买定价
   636→ONE_TIME_PRICING = {
   637→    "full_report": MultiCurrencyPrice(cny=1990, usd=299),      # ¥19.9 / $2.99
   638→    "ai_portrait": MultiCurrencyPrice(cny=990, usd=149),       # ¥9.9 / $1.49
   639→    "relationship_report": MultiCurrencyPrice(cny=1990, usd=299),
   640→}
   641→
   642→# 增值服务定价
   643→ADDON_PRICING = {
   644→    "ai_art_report": MultiCurrencyPrice(cny=990, usd=149),     # AI 生图报告
   645→    "deep_analysis": MultiCurrencyPrice(cny=1990, usd=299),    # 深度分析
   646→    "extra_chat_quota": MultiCurrencyPrice(cny=590, usd=99),   # 额外对话额度
   647→}
   648→
   649→# Phase 2: 全家桶套餐
   650→BUNDLE_PRICING = {
   651→    "all_access": {
   652→        "monthly": MultiCurrencyPrice(cny=4990, usd=699),      # ¥49.9 / $6.99
   653→        "yearly": MultiCurrencyPrice(cny=39900, usd=5999),     # ¥399 / $59.99
   654→    }
   655→}
   656→
   657→def get_price(price: MultiCurrencyPrice, region: str) -> tuple[int, str]:
   658→    """根据用户地区返回对应币种价格"""
   659→    if region == "CN":
   660→        return price.cny, "CNY"
   661→    return price.usd, "USD"
   662→```
   663→
   664→### 6.5 产品类型与计费模型
   665→
   666→```
   667→┌─────────────────────────────────────────────────────────────────┐
   668→│                        计费模型总览                              │
   669→├─────────────────────────────────────────────────────────────────┤
   670→│                                                                 │
   671→│   1. 订阅 (Subscription)                                        │
   672→│   ─────────────────────────────────────────────────────────     │
   673→│   • 按 Skill 独立订阅（bazi_pro, zodiac_pro）                   │
   674→│   • 支持月付 / 年付（年付享折扣）                                │
   675→│   • Stripe Billing 管理订阅生命周期                             │
   676→│   • 自动续费 + 到期提醒                                         │
   677→│                                                                 │
   678→│   2. 单次购买 (One-time)                                        │
   679→│   ─────────────────────────────────────────────────────────     │
   680→│   • 完整报告套餐                                                │
   681→│   • AI 生图报告                                                 │
   682→│   • 关系分析报告                                                │
   683→│   • 购买后永久有效                                              │
   684→│                                                                 │
   685→│   3. 增值服务 (Add-on)                                          │
   686→│   ─────────────────────────────────────────────────────────     │
   687→│   • 订阅用户可额外购买                                          │
   688→│   • AI 艺术报告（高清海报）                                     │
   689→│   • 深度咨询时长                                                │
   690→│   • 额外对话额度                                                │
   691→│                                                                 │
   692→│   4. 全家桶套餐 (Bundle) - Phase 2                              │
   693→│   ─────────────────────────────────────────────────────────     │
   694→│   • All Access：解锁所有 Skill                                  │
   695→│   • 月付 / 年付                                                 │
   696→│                                                                 │
   697→└─────────────────────────────────────────────────────────────────┘
   698→```
   699→
   700→### 6.6 数据库 Schema（支付相关）
   701→
   702→```sql
   703→-- 订阅表（按 Skill 独立）
   704→CREATE TABLE subscriptions (
   705→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   706→    user_id UUID REFERENCES users(id),
   707→    skill TEXT NOT NULL,  -- 'bazi', 'zodiac', 'mbti', 'career'
   708→    tier TEXT NOT NULL DEFAULT 'free',
   709→    billing_cycle TEXT,  -- 'monthly', 'yearly'
   710→    currency TEXT NOT NULL,  -- 'CNY', 'USD'
   711→    price_cents INT,
   712→    status TEXT NOT NULL DEFAULT 'active',
   713→    payment_provider TEXT,  -- 'stripe', 'airwallex'
   714→    provider_subscription_id TEXT,  -- Stripe/Airwallex 订阅 ID
   715→    starts_at TIMESTAMPTZ DEFAULT NOW(),
   716→    current_period_start TIMESTAMPTZ,
   717→    current_period_end TIMESTAMPTZ,
   718→    cancel_at_period_end BOOLEAN DEFAULT FALSE,
   719→    canceled_at TIMESTAMPTZ,
   720→    created_at TIMESTAMPTZ DEFAULT NOW(),
   721→    updated_at TIMESTAMPTZ DEFAULT NOW(),
   722→    UNIQUE(user_id, skill)
   723→);
   724→
   725→-- 单次购买记录
   726→CREATE TABLE purchases (
   727→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   728→    user_id UUID REFERENCES users(id),
   729→    product_type TEXT NOT NULL,  -- 'report', 'ai_portrait', 'relationship'
   730→    product_id TEXT,  -- 关联的报告/产品 ID
   731→    skill TEXT,
   732→    currency TEXT NOT NULL,
   733→    amount_cents INT NOT NULL,
   734→    payment_provider TEXT,
   735→    provider_payment_id TEXT,
   736→    status TEXT NOT NULL DEFAULT 'pending',
   737→    created_at TIMESTAMPTZ DEFAULT NOW(),
   738→    completed_at TIMESTAMPTZ
   739→);
   740→
   741→-- 增值服务购买记录
   742→CREATE TABLE addon_purchases (
   743→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   744→    user_id UUID REFERENCES users(id),
   745→    addon_type TEXT NOT NULL,  -- 'ai_art_report', 'deep_analysis', 'extra_chat_quota'
   746→    skill TEXT,
   747→    currency TEXT NOT NULL,
   748→    amount_cents INT NOT NULL,
   749→    quantity INT DEFAULT 1,
   750→    payment_provider TEXT,
   751→    provider_payment_id TEXT,
   752→    status TEXT NOT NULL,
   753→    created_at TIMESTAMPTZ DEFAULT NOW(),
   754→    expires_at TIMESTAMPTZ  -- 部分增值服务有有效期
   755→);
   756→
   757→-- 支付事件日志（对账用）
   758→CREATE TABLE payment_events (
   759→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   760→    user_id UUID REFERENCES users(id),
   761→    event_type TEXT NOT NULL,  -- 'checkout.completed', 'subscription.renewed', etc.
   762→    payment_provider TEXT NOT NULL,
   763→    provider_event_id TEXT,
   764→    payload JSONB,
   765→    created_at TIMESTAMPTZ DEFAULT NOW()
   766→);
   767→
   768→-- 索引
   769→CREATE INDEX idx_subscriptions_user ON subscriptions(user_id);
   770→CREATE INDEX idx_subscriptions_provider ON subscriptions(payment_provider, provider_subscription_id);
   771→CREATE INDEX idx_purchases_user ON purchases(user_id);
   772→CREATE INDEX idx_payment_events_provider ON payment_events(payment_provider, provider_event_id);
   773→```
   774→
   775→### 6.7 Webhook 处理
   776→
   777→```python
   778→# apps/api/routes/webhooks.py
   779→from fastapi import APIRouter, Request, HTTPException
   780→import stripe
   781→from services.billing import SubscriptionService, PurchaseService
   782→
   783→router = APIRouter()
   784→
   785→# Stripe Webhook
   786→@router.post("/webhooks/stripe")
   787→async def stripe_webhook(request: Request):
   788→    payload = await request.body()
   789→    sig_header = request.headers.get("stripe-signature")
   790→
   791→    try:
   792→        event = stripe.Webhook.construct_event(
   793→            payload, sig_header, settings.STRIPE_WEBHOOK_SECRET
   794→        )
   795→    except ValueError:
   796→        raise HTTPException(status_code=400, detail="Invalid payload")
   797→    except stripe.error.SignatureVerificationError:
   798→        raise HTTPException(status_code=400, detail="Invalid signature")
   799→
   800→    # 处理事件
   801→    if event["type"] == "checkout.session.completed":
   802→        await handle_checkout_completed(event["data"]["object"])
   803→    elif event["type"] == "customer.subscription.updated":
   804→        await handle_subscription_updated(event["data"]["object"])
   805→    elif event["type"] == "customer.subscription.deleted":
   806→        await handle_subscription_canceled(event["data"]["object"])
   807→    elif event["type"] == "invoice.payment_failed":
   808→        await handle_payment_failed(event["data"]["object"])
   809→
   810→    return {"status": "ok"}
   811→
   812→# Airwallex Webhook
   813→@router.post("/webhooks/airwallex")
   814→async def airwallex_webhook(request: Request):
   815→    payload = await request.json()
   816→    signature = request.headers.get("x-signature")
   817→
   818→    # 验证签名
   819→    if not verify_airwallex_signature(payload, signature):
   820→        raise HTTPException(status_code=400, detail="Invalid signature")
   821→
   822→    event_type = payload.get("name")
   823→
   824→    if event_type == "payment_intent.succeeded":
   825→        await handle_airwallex_payment_success(payload["data"]["object"])
   826→    elif event_type == "payment_intent.payment_failed":
   827→        await handle_airwallex_payment_failed(payload["data"]["object"])
   828→
   829→    return {"status": "ok"}
   830→```
   831→
   832→### 6.8 前端支付流程
   833→
   834→```typescript
   835→// apps/web/src/lib/checkout.ts
   836→import { loadStripe } from '@stripe/stripe-js';
   837→
   838→const stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_KEY!);
   839→
   840→interface CheckoutParams {
   841→  productType: 'subscription' | 'one_time' | 'addon';
   842→  productId: string;
   843→  skill?: string;
   844→}
   845→
   846→export async function initiateCheckout(params: CheckoutParams) {
   847→  // 1. 获取用户地区
   848→  const region = await detectUserRegion();
   849→
   850→  // 2. 调用后端创建 checkout session
   851→  const response = await fetch('/api/v1/billing/checkout', {
   852→    method: 'POST',
   853→    headers: { 'Content-Type': 'application/json' },
   854→    body: JSON.stringify({
   855→      ...params,
   856→      region,
   857→    }),
   858→  });
   859→
   860→  const { provider, sessionId, redirectUrl } = await response.json();
   861→
   862→  // 3. 根据支付服务商跳转
   863→  if (provider === 'stripe') {
   864→    const stripe = await stripePromise;
   865→    await stripe?.redirectToCheckout({ sessionId });
   866→  } else if (provider === 'airwallex') {
   867→    // Airwallex 跳转到支付页面
   868→    window.location.href = redirectUrl;
   869→  }
   870→}
   871→
   872→// 用户地区检测
   873→async function detectUserRegion(): Promise<string> {
   874→  // 优先使用用户设置
   875→  const savedRegion = localStorage.getItem('user_region');
   876→  if (savedRegion) return savedRegion;
   877→
   878→  // 其次使用 IP 地理位置
   879→  try {
   880→    const response = await fetch('https://ipapi.co/json/');
   881→    const data = await response.json();
   882→    return data.country_code;
   883→  } catch {
   884→    return 'US'; // 默认海外
   885→  }
   886→}
   887→```
   888→
   889→---
   890→
   891→## 7. 数据共享策略
   892→
   893→### 7.1 共享数据范围
   894→
   895→| 数据类型 | 共享级别 | 说明 |
   896→|----------|----------|------|
   897→| **基础信息** | ✅ 全局共享 | birth_datetime, birth_location, gender, name |
   898→| **生活上下文** | ✅ 全局共享 | career, relationship, life_stage, recent_events |
   899→| **AI 洞察** | ✅ 全局共享 | personality_traits, communication_style, emotional_patterns |
   900→| **Identity Prism** | ✅ 全局共享 | core, inner, outer 三元身份 |
   901→| **对话历史** | ❌ Skill 独立 | 各 Skill 对话分开存储 |
   902→| **报告记录** | ❌ Skill 独立 | 各 Skill 报告分开存储 |
   903→| **订阅状态** | ❌ Skill 独立 | 各 Skill 独立收费 |
   904→
   905→### 7.2 跨 Skill 数据利用
   906→
   907→```python
   908→# 用户在 bazi 积累的画像可在 zodiac 使用
   909→async def build_context(user_id: str, skill: str):
   910→    # 1. 加载共享 Profile（所有 Skill 贡献的数据）
   911→    shared_profile = await get_shared_profile(user_id)
   912→
   913→    # 2. 加载 Skill 专属数据
   914→    skill_data = await get_skill_data(user_id, skill)
   915→
   916→    # 3. 构建上下文
   917→    context = {
   918→        "shared": {
   919→            "basic": shared_profile.basic,
   920→            "life_context": shared_profile.life_context,
   921→            "ai_insights": shared_profile.ai_insights,
   922→            "identity_prism": shared_profile.identity_prism,
   923→        },
   924→        "skill_specific": skill_data,
   925→    }
   926→
   927→    return context
   928→```
   929→
   930→---
   931→
   932→## 8. 部署架构
   933→
   934→### 8.1 Vercel 多域名部署
   935→
   936→```
   937→┌─────────────────────────────────────────────────────────────────┐
   938→│                        Vercel Project                            │
   939→│                      vibelife-web                                │
   940→├─────────────────────────────────────────────────────────────────┤
   941→│                                                                 │
   942→│   Domains:                                                      │
   943→│   ├── www.vibelife.app      (Primary)                          │
   944→│   ├── bazi.vibelife.app     (Alias)                            │
   945→│   ├── zodiac.vibelife.app   (Alias)                            │
   946→│   └── *.vibelife.app        (Wildcard)                         │
   947→│                                                                 │
   948→│   Environment Variables:                                        │
   949→│   ├── NEXT_PUBLIC_API_URL=https://api.vibelife.app             │
   950→│   ├── NEXT_PUBLIC_COOKIE_DOMAIN=.vibelife.app                  │
   951→│   └── NEXT_PUBLIC_DEFAULT_SKILL=bazi                           │
   952→│                                                                 │
   953→└─────────────────────────────────────────────────────────────────┘
   954→```
   955→
   956→### 8.2 本地开发配置
   957→
   958→```bash
   959→# /etc/hosts (本地开发)
   960→127.0.0.1 www.vibelife.local
   961→127.0.0.1 bazi.vibelife.local
   962→127.0.0.1 zodiac.vibelife.local
   963→```
   964→
   965→```env
   966→# .env.local
   967→NEXT_PUBLIC_API_URL=http://localhost:8000
   968→NEXT_PUBLIC_COOKIE_DOMAIN=.vibelife.local
   969→```
   970→
   971→---
   972→
   973→## 9. 实施路线图
   974→
   975→### Phase 1 (当前)
   976→
   977→- [x] 子域名架构设计
   978→- [x] 支付架构设计（Stripe + Airwallex 双轨）
   979→- [ ] middleware.ts 子域名路由完善
   980→- [ ] (www)/ (bazi)/ (zodiac)/ 路由组创建
   981→- [ ] 统一顶栏 GlobalNav 实现
   982→- [ ] SSO Cookie 跨域配置
   983→- [ ] 订阅表 Schema 扩展（支持多币种、多支付商）
   984→- [ ] Stripe 集成（海外信用卡、订阅管理）
   985→- [ ] Airwallex 集成（国内微信/支付宝跨境收单）
   986→- [ ] 双币种定价系统
   987→- [ ] Webhook 处理（Stripe + Airwallex）
   988→
   989→### Phase 2
   990→
   991→- [ ] 全家桶套餐（All Access）
   992→- [ ] MBTI Skill 上线
   993→- [ ] 增值服务商店
   994→- [ ] 跨 Skill 数据分析
   995→- [ ] 订阅用户留存优化
   996→
   997→### Phase 3
   998→
   999→- [ ] 主 App (app.vibelife.app) 开发
  1000→- [ ] 子域名转为落地页
  1001→- [ ] 原生 App 开发
  1002→
  1003→---
  1004→
  1005→## 10. 关键文件清单
  1006→
  1007→### 前端
  1008→
  1009→| 文件 | 作用 |
  1010→|------|------|
  1011→| `apps/web/src/middleware.ts` | 子域名路由 |
  1012→| `apps/web/src/providers/SkillProvider.tsx` | Skill 上下文 |
  1013→| `apps/web/src/components/core/GlobalNav.tsx` | 统一顶栏 |
  1014→| `apps/web/src/app/(www)/layout.tsx` | 主站布局 |
  1015→| `apps/web/src/app/(bazi)/layout.tsx` | Bazi 专属布局 |
  1016→| `apps/web/src/app/(zodiac)/layout.tsx` | Zodiac 专属布局 |
  1017→| `apps/web/src/lib/checkout.ts` | 支付流程 |
  1018→| `vercel.json` | 部署配置 |
  1019→
  1020→### 后端
  1021→
  1022→| 文件 | 作用 |
  1023→|------|------|
  1024→| `apps/api/services/billing/payment_router.py` | 支付路由（Stripe/Airwallex） |
  1025→| `apps/api/services/billing/stripe_service.py` | Stripe 服务 |
  1026→| `apps/api/services/billing/airwallex_service.py` | Airwallex 服务 |
  1027→| `apps/api/config/pricing.py` | 定价配置（双币种） |
  1028→| `apps/api/middleware/subscription.py` | 订阅验证 |
  1029→| `apps/api/routes/webhooks.py` | Webhook 处理 |
  1030→| `apps/api/routes/billing.py` | 计费 API |
  1031→
  1032→### 数据库
  1033→
  1034→| 文件 | 作用 |
  1035→|------|------|
  1036→| `migrations/002_subscriptions.sql` | 订阅表 Schema |
  1037→| `migrations/003_purchases.sql` | 单次购买表 |
  1038→| `migrations/004_addon_purchases.sql` | 增值服务表 |
  1039→| `migrations/005_payment_events.sql` | 支付事件日志 |
  1040→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
