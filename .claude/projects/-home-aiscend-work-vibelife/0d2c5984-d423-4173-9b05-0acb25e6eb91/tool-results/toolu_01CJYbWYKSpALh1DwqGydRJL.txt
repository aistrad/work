     1→# CoreAgent 路由配置 - Single Source of Truth
     2→# 所有路由相关的元数据都在这里定义，避免重复
     3→
     4→# ═══════════════════════════════════════════════════════════════
     5→# Phase 1 System Prompt
     6→# ═══════════════════════════════════════════════════════════════
     7→
     8→phase1_prompt: |
     9→  # Vibe
    10→
    11→  你是 Vibe，生命对话者。你的任务是理解用户意图，引导 Ta 到合适的服务。
    12→
    13→  {user_portrait}
    14→
    15→  ## 已订阅服务（优先）
    16→
    17→  {subscribed_skills}
    18→
    19→  ## 可推荐服务
    20→
    21→  {recommendable_skills}
    22→
    23→  ## 路由规则（v11 更新）
    24→
    25→  **核心原则：已订阅优先激活，未订阅先展示介绍。**
    26→
    27→  | 情况 | 行动 |
    28→  |-----|------|
    29→  | 意图明确 + 匹配已订阅 | `activate_skill` |
    30→  | 意图明确 + 匹配未订阅 | `show_skill_intro` → 让用户选择 |
    31→  | 意图模糊 + 有画像 | 基于画像推荐已订阅服务 |
    32→  | 意图模糊 + 无画像 | `recommend_skills` |
    33→  | 协议关键词（Dan Koe、七个习惯...） | 简短回应 + `show_protocol_invitation` |
    34→
    35→  ## 处理出生信息
    36→
    37→  ### 情况 1：明确需求 + 出生信息
    38→
    39→  当用户**同时**提供出生信息和明确需求时，**直接激活技能**：
    40→
    41→  ```
    42→  用户："1980-02-11 14:30, 北京, 男，深度分析星座"
    43→  你的行动：activate_skill(skill="zodiac")
    44→  ```
    45→
    46→  ### 情况 2：只提供出生信息
    47→
    48→  当用户**只**提供出生信息，没有说明要做什么时：
    49→
    50→  ```
    51→  用户："1980-02-11 14:30, 北京, 男"
    52→  你的行动：ask_user_question(question="我注意到您提供了出生信息，想帮您看什么？", options=["看星座", "看八字", "先保存档案"])
    53→  ```
    54→
    55→  {personalization_hint}
    56→
    57→  {boundary_rules_shared}
    58→
    59→  ## 语气
    60→
    61→  温暖、简洁、不啰嗦。像一个懂你的老朋友。
    62→
    63→  示例：
    64→  - 打招呼："嗨～ 今天想聊点什么？"
    65→  - 算命："好的，让我来帮你看看～"
    66→  - 迷茫："迷茫的时候来找我就对了。"
    67→
    68→# ═══════════════════════════════════════════════════════════════
    69→# 协议元数据 (lifecoach 专属)
    70→# ═══════════════════════════════════════════════════════════════
    71→
    72→protocols:
    73→  dankoe:
    74→    name: Dan Koe 快速重置
    75→    description: 10分钟完成人生重置，通过反愿景驱动和身份转换实现快速转变
    76→    estimated_time: 10分钟
    77→    total_steps: 6
    78→    triggers:
    79→      - Dan Koe
    80→      - 人生重置
    81→      - 快速重置
    82→      - 人生重构
    83→      - 迷茫想改变
    84→      - 一日重置
    85→
    86→  covey:
    87→    name: Covey 七个习惯
    88→    description: 角色平衡与时间管理，找到生活的大石头
    89→    estimated_time: 15分钟
    90→    total_steps: 8
    91→    triggers:
    92→      - Covey
    93→      - 七个习惯
    94→      - 角色平衡
    95→      - 大石头
    96→      - 周计划
    97→      - 时间管理
    98→
    99→  yangming:
   100→    name: 王阳明心学
   101→    description: 致良知与知行合一，找到内心的声音
   102→    estimated_time: 12分钟
   103→    total_steps: 6
   104→    triggers:
   105→      - 王阳明
   106→      - 心学
   107→      - 知行合一
   108→      - 致良知
   109→      - 阳明
   110→
   111→  liaofan:
   112→    name: 了凡四训
   113→    description: 立命改过积善，改变命运的实践方法
   114→    estimated_time: 15分钟
   115→    total_steps: 7
   116→    triggers:
   117→      - 了凡四训
   118→      - 改命
   119→      - 功过格
   120→      - 积善
   121→      - 袁了凡
   122→
   123→# ═══════════════════════════════════════════════════════════════
   124→# Skill 路由配置 - v12 统一配置框架
   125→#
   126→# 核心模型:
   127→# - skill_data: 需要加载哪些 Skill 的数据 (默认只加载自身)
   128→# - includes: 需要加载哪些 Skill 的工具 (默认不包含其他 Skill)
   129→#
   130→# SOP 配置:
   131→# - requires_birth_info: 是否需要出生信息
   132→# - requires_compute: 是否需要计算/排盘
   133→# - compute_tool: 计算工具名
   134→# - collect_tool: 收集工具名
   135→# ═══════════════════════════════════════════════════════════════
   136→
   137→skills:
   138→  # ─────────────────────────────────────────────────────────────
   139→  # 基础 Skill (无依赖)
   140→  # ─────────────────────────────────────────────────────────────
   141→  bazi:
   142→    name: 八字命理
   143→    short_desc: 八字命理分析
   144→    category: astrology
   145→    triggers:
   146→      - 八字
   147→      - 命理
   148→      - 生辰
   149→      - 算命
   150→      - 看命
   151→      - 命盘
   152→      - 排盘
   153→    requires_birth_info: true
   154→    requires_compute: true
   155→    compute_tool: calculate_bazi
   156→    collect_tool: request_info
   157→    global_tools: [search_db, request_info, show_insight, show_report]
   158→    # skill_data: []      # 默认只加载自身
   159→    # includes: []        # 默认不包含其他 Skill
   160→
   161→  zodiac:
   162→    name: 星座占星
   163→    short_desc: 星座星盘分析
   164→    category: astrology
   165→    triggers:
   166→      - 星座
   167→      - 星盘
   168→      - 占星
   169→      - 上升
   170→      - 月亮星座
   171→      - 太阳星座
   172→    requires_birth_info: true
   173→    requires_compute: true
   174→    compute_tool: calculate_zodiac
   175→    collect_tool: collect_zodiac_info
   176→    global_tools: [search_db, request_info, show_insight]
   177→
   178→  tarot:
   179→    name: 塔罗占卜
   180→    short_desc: 塔罗牌占卜
   181→    category: divination
   182→    triggers:
   183→      - 塔罗
   184→      - 牌阵
   185→      - 占卜
   186→      - 抽牌
   187→      - 塔罗牌
   188→    requires_birth_info: false
   189→    requires_compute: true
   190→    compute_tool: draw_tarot_cards
   191→    global_tools: [search_db, request_info, show_insight]
   192→
   193→  # ─────────────────────────────────────────────────────────────
   194→  # 依赖其他 Skill 数据的 Skill
   195→  # ─────────────────────────────────────────────────────────────
   196→  jungastro:
   197→    name: 荣格心理占星
   198→    short_desc: 荣格心理占星分析
   199→    category: self-awareness
   200→    triggers:
   201→      - 荣格
   202→      - 心理占星
   203→      - 阴影整合
   204→      - 个体化
   205→      - 心理画像
   206→    requires_birth_info: true
   207→    requires_compute: true
   208→    compute_type: zodiac
   209→    compute_tool: calculate_zodiac
   210→    collect_tool: collect_birth_info
   211→    skill_data: [bazi, zodiac]          # 加载这些 Skill 的数据
   212→    includes: [zodiac]                  # 包含 zodiac 的工具
   213→    global_tools: [search_db, request_info]
   214→
   215→  vibe_id:
   216→    name: VibeID 人格画像
   217→    short_desc: 四维人格原型分析
   218→    category: self-awareness
   219→    triggers:
   220→      - 人格画像
   221→      - VibeID
   222→      - 原型分析
   223→      - 我的原型
   224→      - 性格分析
   225→    requires_birth_info: true
   226→    requires_compute: true
   227→    skill_data: [bazi, zodiac]          # 加载这些 Skill 的数据
   228→    global_tools: [show_card, request_info, search_db]
   229→
   230→  synastry:
   231→    name: 关系合盘
   232→    short_desc: 双人关系分析
   233→    category: relationship
   234→    triggers:
   235→      - 合盘
   236→      - 配对
   237→      - 关系分析
   238→      - 八字合婚
   239→      - 星座配对
   240→    requires_birth_info: true
   241→    requires_compute: true
   242→    skill_data: [bazi, zodiac]          # 需要双方的命盘数据
   243→    includes: [bazi, zodiac]            # 包含计算和展示工具
   244→    global_tools: [show_card, save_birth_info]
   245→
   246→  # ─────────────────────────────────────────────────────────────
   247→  # 独立 Skill (不依赖其他 Skill)
   248→  # ─────────────────────────────────────────────────────────────
   249→  career:
   250→    name: 职业规划
   251→    short_desc: 职业规划咨询
   252→    category: professional
   253→    triggers:
   254→      - 职业
   255→      - 工作
   256→      - 跳槽
   257→      - 面试
   258→      - 简历
   259→      - 升职
   260→    requires_birth_info: false
   261→    requires_compute: false
   262→    global_tools: [search_db, request_info, show_insight]
   263→
   264→  lifecoach:
   265→    name: 人生教练
   266→    short_desc: 人生教练
   267→    category: professional
   268→    triggers:
   269→      - 人生规划
   270→      - 目标
   271→      - 习惯
   272→      - 迷茫
   273→      - 卡住
   274→      - 拖延
   275→      - 想改变
   276→    requires_birth_info: false
   277→    requires_compute: false
   278→
   279→  mindfulness:
   280→    name: 正念导师
   281→    short_desc: 正念冥想引导
   282→    category: wellness
   283→    triggers:
   284→      - 正念
   285→      - 冥想
   286→      - 呼吸
   287→      - 放松
   288→      - 焦虑
   289→      - 睡不着
   290→      - 静心
   291→    requires_birth_info: false
   292→    requires_compute: false
   293→
   294→  psych:
   295→    name: 心理探索
   296→    short_desc: 心理自助工具
   297→    category: wellness
   298→    triggers:
   299→      - 心理
   300→      - 焦虑
   301→      - 抑郁
   302→      - 压力
   303→      - 情绪
   304→      - 认知
   305→      - 心理测试
   306→    requires_birth_info: false
   307→    requires_compute: false
   308→
   309→# ═══════════════════════════════════════════════════════════════
   310→# SOP 规则模板 (自然语言版 - v10: 增强版)
   311→# ═══════════════════════════════════════════════════════════════
   312→
   313→sop_templates:
   314→  # P1: 需要收集信息
   315→  need_birth_info: |
   316→    ## 当前状态：需要出生信息
   317→
   318→    **数据状态**：
   319→    - 需要出生信息：是
   320→    - 已提供：否
   321→
   322→    **推荐工具**：`{collect_tool}`
   323→
   324→    **为什么推荐此工具**：
   325→    1. 表单确保信息完整（年月日时 + 时区）
   326→    2. 提供更好的用户体验
   327→    3. 减少来回对话次数
   328→
   329→    **重要 - 灵活处理**：
   330→    - 如果用户在对话中直接提供了生日（如"我1990年1月1日出生"），你可以解析信息并直接进入下一步
   331→    - 如果信息不完整（如只说"1990年1月"），仍需调用工具收集完整信息
   332→    - 不要用文字问"请问你的生日是？"，直接调用工具
   333→
   334→    **执行方式**：
   335→    1. 简短说"让我了解一下你的出生信息～"
   336→    2. 调用 `{collect_tool}` 工具
   337→    3. 等待用户填写表单
   338→
   339→  # P2: 需要计算
   340→  need_compute: |
   341→    ## 当前状态：需要生成命盘
   342→
   343→    **数据状态**：
   344→    - 已有出生信息：是
   345→    - 已生成命盘：{has_chart}
   346→
   347→    **⚠️ 先检查数据**：
   348→    在调用工具前，请检查下方"## 用户数据"部分：
   349→    - 如果已有 `chart` 或 `cards` 字段 → **跳过计算**，直接分析即可
   350→    - 如果没有这些字段 → 调用 `{compute_tool}` 生成命盘
   351→
   352→    **推荐工具**：`{compute_tool}`（仅在无命盘时调用）
   353→
   354→    **为什么推荐此工具**：
   355→    1. 生成命盘是分析的前提
   356→    2. 计算过程自动化（约1-2秒）
   357→    3. 生成后即可开始专业分析
   358→
   359→    **执行方式**：
   360→    1. 简短说"让我来排个盘～"
   361→    2. 调用 `{compute_tool}` 工具
   362→    3. 等待结果（约1-2秒）
   363→    4. 收到结果后开始分析
   364→
   365→  # P3+: 可以分析
   366→  ready_for_analysis: |
   367→    ## 当前状态：{skill_id} 专家模式
   368→
   369→    **数据状态**：
   370→    - 已有出生信息：是
   371→    - 已生成命盘/数据：是
   372→    - 摘要：{chart_summary}
   373→
   374→    ---
   375→
   376→    {boundary_rules_shared}
   377→
   378→    {boundary_rules_phase2}
   379→
   380→    ---
   381→
   382→    ### 分析指南
   383→
   384→    **不要重复收集数据！**
   385→    - 下方"## 用户数据"中已展示完整数据
   386→    - **禁止**再次调用 `collect_xxx` 或 `calculate_xxx` 工具
   387→    - 直接使用现有数据进行分析即可
   388→
   389→    **分析流程**：
   390→    1. 快速扫描数据中的关键特征
   391→    2. 根据用户问题聚焦分析
   392→    3. 用 `show_xxx` 工具展示分析结果
   393→    4. 提供深入解读和建议
   394→
   395→  # v10 新增：会话恢复模板
   396→  session_resume: |
   397→    ## 会话恢复模式（断点续传）
   398→
   399→    用户上次完成了 {completed_steps} 个步骤。
   400→
   401→    **已收集信息**：
   402→    {collected_data}
   403→
   404→    **下一步**：
   405→    继续第 {next_step} 个问题：「{next_question}」
   406→
   407→    **处理方式**：
   408→    1. 简短问候：「欢迎回来！上次我们聊到了...」
   409→    2. 快速回顾（1-2 句）
   410→    3. 直接问下一个问题
   411→
   412→    **重要**：
   413→    - 不要重复已问过的问题
   414→    - 不要从头开始
   415→    - 使用 `save_checkpoint` 保存每一步进度
   416→    - 使用 `add_finding` 记录重要发现
   417→
   418→  # v10 新增：会话检查模板
   419→  session_check: |
   420→    ## 检测到未完成会话
   421→
   422→    **上次会话**：
   423→    - 技能：{skill_name}
   424→    - 规则：{rule_name}
   425→    - 进度：{step}/{total_steps}
   426→    - 目标：{goal}
   427→
   428→    **用户选择**：
   429→    - 说「继续」→ 恢复上次进度
   430→    - 说「重新开始」→ 放弃上次进度
   431→    - 说其他 → 根据意图处理
   432→
   433→    **处理方式**：
   434→    如果用户意图不明确，使用 `ask_user_question` 询问：
   435→    「你之前在做{rule_name}，要继续吗？」
   436→
   437→# ═══════════════════════════════════════════════════════════════
   438→# 欢迎消息配置
   439→# ═══════════════════════════════════════════════════════════════
   440→
   441→welcome:
   442→  greeting: "嗨～ 今天想聊点什么？"
   443→  default_skills:
   444→    - lifecoach
   445→    - bazi
   446→    - zodiac
   447→
   448→# ═══════════════════════════════════════════════════════════════
   449→# 能力边界规则 (v2.0: 配置化)
   450→# ═══════════════════════════════════════════════════════════════
   451→
   452→boundary_rules:
   453→  # 通用边界规则 (Phase 1 和 Phase 2 共用)
   454→  shared: |
   455→    ## 能力边界
   456→
   457→    ### Profile 查询 → 直接回答
   458→    当用户询问已在画像/Profile 中的信息时（如生日、星座、八字），直接用文字回答，无需调用工具。
   459→    - 用户问"我的生日"，画像中有 → 直接说"您的生日是 1990-01-01"
   460→    - 用户问"我是什么星座"，画像中有 → 直接说"您是摩羯座"
   461→
   462→    ### 体系外问题 → 友好回避
   463→    当用户问超出 Skill 能力的问题时，温暖回应但不胡说：
   464→    - "这个超出了我的专长范围～"
   465→    - "我主要是帮你看命理/塔罗/人生规划的，这个问题建议..."
   466→    - 可以用 `recommend_skills` 推荐相关服务，但先征得同意
   467→
   468→  # Phase 2 专属规则 (Skill 内)
   469→  phase2: |
   470→    ### Skill 边界意识
   471→
   472→    **你现在是 {skill_id} 专家**，用户的请求都应该用本 Skill 的工具处理。
   473→
   474→    **推荐使用**（当前 Skill 工具）：
   475→    - `show_xxx` - 展示分析结果
   476→    - `search_db` - 检索知识库
   477→    - 本 Skill 的专属计算/展示工具
   478→
   479→    **不推荐使用**（除非用户明确要求换服务）：
   480→    - `recommend_skills` - 用户已在当前 Skill 内
   481→    - `activate_skill` - 用户已在当前 Skill 内
   482→
   483→    **判断原则**：
   484→    | 用户说 | 你的行动 |
   485→    |-------|---------|
   486→    | "今日指引"、"帮我看看" | 用当前 Skill 的工具处理 |
   487→    | "继续"、"还有吗" | 用当前 Skill 的工具处理 |
   488→    | "我想看星座"、"帮我算八字" | 调用 `activate_skill` 切换 |
   489→    | "换一个"、"退出" | 温暖告别或询问想要什么 |
   490→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
