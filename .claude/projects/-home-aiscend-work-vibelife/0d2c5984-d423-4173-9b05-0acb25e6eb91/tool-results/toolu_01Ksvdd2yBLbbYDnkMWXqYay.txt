     1→"""
     2→Prompt Builder v10 - System Prompt 构建
     3→
     4→从 core.py 拆分出来的 Prompt 构建逻辑，支持：
     5→- Phase 1/Phase 2 分阶段 Prompt
     6→- 会话恢复 Prompt（断点续传）
     7→- SOP 规则注入
     8→- 案例匹配
     9→
    10→与 ContextManager 协作：
    11→- 读取会话上下文
    12→- 注入断点信息
    13→"""
    14→import json
    15→import logging
    16→from typing import Optional, Dict, Any, List
    17→
    18→from .skill_loader import (
    19→    load_skill, build_system_prompt,
    20→    skill_requires_birth_info, skill_requires_compute,
    21→    get_skill_compute_type, get_skill_compute_tool, get_skill_collect_tool,
    22→    get_skill_required_data
    23→)
    24→from .routing_config import get_phase1_prompt, get_sop_template, inject_placeholders
    25→from .context_manager import SessionContext
    26→
    27→logger = logging.getLogger(__name__)
    28→
    29→
    30→class PromptBuilder:
    31→    """
    32→    System Prompt 构建器
    33→
    34→    职责：
    35→    1. 根据 Phase 构建不同的 Prompt
    36→    2. 注入会话恢复上下文
    37→    3. 注入 SOP 规则
    38→    4. 动态加载案例
    39→    5. v10.1: 用户画像注入（让 Coach 了解用户）
    40→    """
    41→
    42→    # 需要详细用户画像的 Skill（注入 goals, patterns, findings）
    43→    PORTRAIT_FULL_SKILLS = {"lifecoach", "career"}
    44→
    45→    # 需要出生信息的 Skill
    46→    BIRTH_INFO_SKILLS = {"bazi", "zodiac", "jungastro"}
    47→
    48→    def __init__(self):
    49→        self.case_index = None  # Lazy init
    50→
    51→    async def build(
    52→        self,
    53→        skill_id: Optional[str],
    54→        rule_id: Optional[str],
    55→        message: str,
    56→        profile: Optional[Dict[str, Any]] = None,
    57→        skill_data: Optional[Dict[str, Any]] = None,
    58→        session_context: Optional[SessionContext] = None,
    59→        protocol_prompt: Optional[str] = None
    60→    ) -> str:
    61→        """
    62→        构建 System Prompt
    63→
    64→        Args:
    65→            skill_id: 当前技能 ID
    66→            rule_id: 当前规则 ID
    67→            message: 用户消息
    68→            profile: 用户 Profile
    69→            skill_data: Skill 数据
    70→            session_context: 会话上下文（断点续传）
    71→            protocol_prompt: 协议专用 Prompt（可选）
    72→
    73→        Returns:
    74→            完整的 System Prompt
    75→        """
    76→        parts = []
    77→
    78→        # ═══════════════════════════════════════════════════════════════
    79→        # 协议模式：使用协议专用 Prompt
    80→        # ═══════════════════════════════════════════════════════════════
    81→        if protocol_prompt:
    82→            skill = load_skill("lifecoach")
    83→            if skill:
    84→                parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
    85→            parts.append("\n---\n")
    86→            parts.append(protocol_prompt)
    87→            return "\n".join(parts)
    88→
    89→        if skill_id:
    90→            # ═══════════════════════════════════════════════════════════════
    91→            # Phase 2: Skill 执行阶段 - 完整上下文
    92→            # ═══════════════════════════════════════════════════════════════
    93→
    94→            # 基础 Skill Prompt
    95→            user_ctx = dict(profile) if profile else {}
    96→            base_prompt = build_system_prompt(skill_id, rule_id, user_ctx)
    97→            parts.append(base_prompt)
    98→
    99→            # ═══════════════════════════════════════════════════════════════
   100→            # Profile 注入（简化版 v2.2）- 两层架构
   101→            # ═══════════════════════════════════════════════════════════════
   102→            profile_context = self._build_profile_context(profile, skill_data, skill_id)
   103→            if profile_context:
   104→                parts.append(profile_context)
   105→
   106→            # 会话恢复上下文（断点续传核心）
   107→            if session_context and session_context.has_checkpoint:
   108→                resume_context = session_context.to_prompt_context()
   109→                if resume_context:
   110→                    parts.append(resume_context)
   111→
   112→            # SOP 规则
   113→            sop_rules = self._build_sop_rules(skill_id, profile, skill_data)
   114→            if sop_rules:
   115→                parts.append(sop_rules)
   116→
   117→            # 案例匹配
   118→            cases_text = await self._match_cases(skill_id, skill_data)
   119→            if cases_text:
   120→                parts.append(cases_text)
   121→
   122→        else:
   123→            # ═══════════════════════════════════════════════════════════════
   124→            # Phase 1: Skill 选择阶段 - v11 个性化路由
   125→            # ═══════════════════════════════════════════════════════════════
   126→
   127→            core_prompt = get_phase1_prompt()
   128→            if not core_prompt:
   129→                # Fallback
   130→                core_prompt = self._get_fallback_phase1_prompt()
   131→
   132→            # v11: 注入用户画像和订阅信息（用于个性化路由）
   133→            if profile:
   134→                core_prompt = self._inject_phase1_context(core_prompt, profile)
   135→
   136→            parts.append(core_prompt)
   137→
   138→        return "\n".join(parts)
   139→
   140→    def _build_profile_context(
   141→        self,
   142→        profile: Optional[Dict[str, Any]],
   143→        skill_data: Optional[Dict[str, Any]],
   144→        skill_id: str
   145→    ) -> str:
   146→        """
   147→        构建 Profile 上下文（v3.0 三层架构）
   148→
   149→        三层架构：
   150→        - Layer 1: Identity（共享）- 基本信息
   151→        - Layer 2: Skills（当前 Skill 专属）- skills.{skill_id}
   152→        - Layer 3: Vibe（共享深度信息）- vibe.insight + vibe.target
   153→        """
   154→        parts = []
   155→
   156→        # ═══════════════════════════════════════════════════════════════
   157→        # Layer 1: Identity（所有 Skill 共享，~200 tokens）
   158→        # ═══════════════════════════════════════════════════════════════
   159→        if profile:
   160→            identity = profile.get("identity", {})
   161→
   162→            base_info = []
   163→
   164→            # 用户名
   165→            name = identity.get("display_name")
   166→            if name:
   167→                base_info.append(f"- 用户名：{name}")
   168→
   169→            # 出生信息（如有）
   170→            birth = identity.get("birth_info", {})
   171→            if birth:
   172→                birth_date = birth.get("birth_date") or birth.get("date")
   173→                if birth_date:
   174→                    base_info.append(f"- 出生日期：{birth_date}")
   175→                birth_time = birth.get("birth_time") or birth.get("time")
   176→                if birth_time:
   177→                    base_info.append(f"- 出生时间：{birth_time}")
   178→                birth_place = birth.get("birth_place") or birth.get("location")
   179→                if birth_place:
   180→                    base_info.append(f"- 出生地点：{birth_place}")
   181→
   182→            if base_info:
   183→                parts.append("## 用户信息\n\n" + "\n".join(base_info))
   184→
   185→        # ═══════════════════════════════════════════════════════════════
   186→        # Layer 2: Skills（当前 Skill 专属，~300 tokens）
   187→        # ═══════════════════════════════════════════════════════════════
   188→        if skill_data:
   189→            # 获取该 Skill 需要的 skill_data（从 SKILL.md 配置读取）
   190→            skill_ids = get_skill_required_data(skill_id)
   191→
   192→            for sid in skill_ids:
   193→                data = skill_data.get(sid, {})
   194→                if data:
   195→                    # 过滤掉内部字段（以 _ 开头）
   196→                    filtered_data = {k: v for k, v in data.items() if not k.startswith("_")}
   197→                    if filtered_data:
   198→                        parts.append(f"\n## {sid} 数据\n\n```json\n{json.dumps(filtered_data, ensure_ascii=False, indent=2)}\n```")
   199→
   200→        # ═══════════════════════════════════════════════════════════════
   201→        # Layer 3: Vibe（共享深度信息，~200 tokens）
   202→        # ═══════════════════════════════════════════════════════════════
   203→        if profile:
   204→            vibe = profile.get("vibe", {})
   205→
   206→            # VibeInsight - 我是谁
   207→            insight = vibe.get("insight", {})
   208→            if insight:
   209→                insight_parts = []
   210→
   211→                # 本质
   212→                essence = insight.get("essence", {})
   213→                if essence:
   214→                    archetype = essence.get("archetype", {})
   215→                    if archetype.get("primary"):
   216→                        insight_parts.append(f"- 主要原型：{archetype['primary']}")
   217→                    traits = essence.get("traits", [])
   218→                    if traits:
   219→                        trait_text = ", ".join([t.get("trait", str(t)) if isinstance(t, dict) else str(t) for t in traits[:3]])
   220→                        insight_parts.append(f"- 核心特质：{trait_text}")
   221→
   222→                # 动态
   223→                dynamic = insight.get("dynamic", {})
   224→                if dynamic:
   225→                    emotion = dynamic.get("emotion", {})
   226→                    if emotion.get("current"):
   227→                        insight_parts.append(f"- 当前情绪：{emotion['current']}")
   228→                    energy = dynamic.get("energy", {})
   229→                    if energy.get("level"):
   230→                        insight_parts.append(f"- 能量水平：{energy['level']}")
   231→
   232→                # 规律
   233→                pattern = insight.get("pattern", {})
   234→                if pattern:
   235→                    insights_list = pattern.get("insights", [])
   236→                    if insights_list:
   237→                        insight_parts.append(f"- 洞察：{insights_list[0]}")
   238→
   239→                if insight_parts:
   240→                    parts.append("\n## 用户画像\n\n" + "\n".join(insight_parts))
   241→
   242→            # VibeTarget - 我要成为谁
   243→            target = vibe.get("target", {})
   244→            if target:
   245→                target_parts = []
   246→
   247→                # 北极星
   248→                north_star = target.get("north_star", {})
   249→                if north_star.get("vision_scene"):
   250→                    vision = north_star["vision_scene"]
   251→                    if len(vision) > 100:
   252→                        vision = vision[:100] + "..."
   253→                    target_parts.append(f"- 愿景：{vision}")
   254→
   255→                # 目标
   256→                goals = target.get("goals", [])
   257→                if goals:
   258→                    active_goals = [g for g in goals if g.get("status") == "in_progress"][:2]
   259→                    if active_goals:
   260→                        goals_text = ", ".join([g.get("title", "") for g in active_goals])
   261→                        target_parts.append(f"- 当前目标：{goals_text}")
   262→
   263→                # 聚焦
   264→                focus = target.get("focus", {})
   265→                if focus.get("primary"):
   266→                    target_parts.append(f"- 关注领域：{focus['primary']}")
   267→
   268→                if target_parts:
   269→                    parts.append("\n## 用户目标\n\n" + "\n".join(target_parts))
   270→
   271→        return "\n".join(parts) if parts else ""
   272→
   273→    def _build_sop_rules(
   274→        self,
   275→        skill_id: str,
   276→        profile: Optional[Dict[str, Any]],
   277→        skill_data: Optional[Dict[str, Any]]
   278→    ) -> str:
   279→        """
   280→        构建 SOP 规则（自然语言版）
   281→
   282→        根据当前状态生成教练式指导。
   283→        """
   284→        needs_birth = skill_requires_birth_info(skill_id)
   285→        needs_compute = skill_requires_compute(skill_id)
   286→
   287→        # 计算当前状态
   288→        status = self._compute_status(skill_id, profile, skill_data)
   289→
   290→        # 如果已经可以分析，使用简洁的状态提示
   291→        if status["ready_for_analysis"]:
   292→            template = get_sop_template("ready_for_analysis")
   293→            if template:
   294→                chart_summary = self._extract_chart_summary(skill_id, skill_data)
   295→                # v2.0: 使用 inject_placeholders 替换边界规则和其他占位符
   296→                return inject_placeholders(template, {
   297→                    "chart_summary": chart_summary,
   298→                    "skill_id": skill_id
   299→                })
   300→            return self._get_ready_prompt()
   301→
   302→        rules_parts = []
   303→
   304→        # P1: 需要收集信息
   305→        if needs_birth and not status["has_birth_info"]:
   306→            collect_tool = get_skill_collect_tool(skill_id) or "request_info"
   307→            template = get_sop_template("need_birth_info")
   308→            if template:
   309→                rules_parts.append(template.format(collect_tool=collect_tool))
   310→            else:
   311→                rules_parts.append(self._get_need_birth_prompt(collect_tool))
   312→
   313→        # P2: 需要计算
   314→        elif needs_compute and not status["has_chart_data"]:
   315→            compute_type = get_skill_compute_type(skill_id) or skill_id
   316→            compute_tool = get_skill_compute_tool(skill_id) or f"calculate_{compute_type}"
   317→
   318→            template = get_sop_template("need_compute")
   319→            if template:
   320→                rules_parts.append(template.format(compute_tool=compute_tool, has_chart="否"))
   321→            else:
   322→                rules_parts.append(self._get_need_compute_prompt(compute_tool))
   323→
   324→        return "\n".join(rules_parts)
   325→
   326→    def _compute_status(
   327→        self,
   328→        skill_id: str,
   329→        profile: Optional[Dict[str, Any]],
   330→        skill_data: Optional[Dict[str, Any]]
   331→    ) -> Dict[str, Any]:
   332→        """计算当前 SOP 状态"""
   333→        needs_birth = skill_requires_birth_info(skill_id)
   334→        needs_compute = skill_requires_compute(skill_id)
   335→
   336→        # 检查出生信息
   337→        has_birth = False
   338→        if profile:
   339→            identity = profile.get("identity", {})
   340→            birth_info = identity.get("birth_info", {})
   341→            has_birth = bool(birth_info.get("birth_date") or birth_info.get("date"))
   342→
   343→        # 检查命盘数据
   344→        has_chart = False
   345→        if skill_data:
   346→            compute_type = get_skill_compute_type(skill_id) or skill_id
   347→            data = skill_data.get(compute_type, {})
   348→            has_chart = bool(data.get("chart") or data.get("cards"))
   349→
   350→        return {
   351→            "skill_id": skill_id,
   352→            "needs_birth_info": needs_birth,
   353→            "has_birth_info": has_birth,
   354→            "needs_compute": needs_compute,
   355→            "has_chart_data": has_chart,
   356→            "ready_for_analysis": (not needs_birth or has_birth) and (not needs_compute or has_chart)
   357→        }
   358→
   359→    def _extract_chart_summary(
   360→        self,
   361→        skill_id: str,
   362→        skill_data: Optional[Dict[str, Any]]
   363→    ) -> str:
   364→        """从命盘数据中提取关键摘要"""
   365→        if not skill_data:
   366→            return "无命盘数据"
   367→
   368→        compute_type = get_skill_compute_type(skill_id) or skill_id
   369→        data = skill_data.get(compute_type, {})
   370→
   371→        if not data:
   372→            return "无命盘数据"
   373→
   374→        summary_parts = []
   375→
   376→        # 八字
   377→        if compute_type == "bazi" and "chart" in data:
   378→            chart = data["chart"]
   379→            if "pillars" in chart and len(chart["pillars"]) > 2:
   380→                day_pillar = chart["pillars"][2]
   381→                summary_parts.append(f"日主{day_pillar.get('day_stem', '')}{day_pillar.get('day_branch', '')}")
   382→            if "month_order" in chart:
   383→                summary_parts.append(f"月令{chart['month_order']}")
   384→
   385→        # 星盘
   386→        elif compute_type == "zodiac" and "chart" in data:
   387→            chart = data["chart"]
   388→            planets = chart.get("planets", {})
   389→            if "sun" in planets:
   390→                summary_parts.append(f"太阳{planets['sun'].get('sign', '')}")
   391→            if "moon" in planets:
   392→                summary_parts.append(f"月亮{planets['moon'].get('sign', '')}")
   393→
   394→        # 塔罗
   395→        elif compute_type == "tarot" and "cards" in data:
   396→            cards = data["cards"]
   397→            if isinstance(cards, list) and len(cards) > 0:
   398→                summary_parts.append(f"{len(cards)}张牌")
   399→
   400→        if summary_parts:
   401→            return "、".join(summary_parts)
   402→        else:
   403→            return "已生成命盘"
   404→
   405→    async def _match_cases(
   406→        self,
   407→        skill_id: str,
   408→        skill_data: Optional[Dict[str, Any]]
   409→    ) -> str:
   410→        """匹配相关案例"""
   411→        if not skill_data:
   412→            return ""
   413→
   414→        try:
   415→            from .case_index import get_case_index, extract_features
   416→
   417→            if self.case_index is None:
   418→                self.case_index = get_case_index()
   419→
   420→            features = extract_features(skill_data)
   421→            if not features:
   422→                return ""
   423→
   424→            cases = await self.case_index.get_matched_cases(skill_id, features, top_k=2)
   425→            if not cases:
   426→                return ""
   427→
   428→            cases_text = "\n## 相关案例\n\n"
   429→            for case in cases:
   430→                cases_text += f"### {case.name}\n{case.content}\n\n"
   431→
   432→            return cases_text
   433→
   434→        except Exception as e:
   435→            logger.warning(f"[PromptBuilder] Case matching failed: {e}")
   436→            return ""
   437→
   438→    # ═══════════════════════════════════════════════════════════════════════════
   439→    # Phase 1 个性化路由 (v11 新增)
   440→    # ═══════════════════════════════════════════════════════════════════════════
   441→
   442→    def _inject_phase1_context(self, prompt: str, profile: Dict[str, Any]) -> str:
   443→        """
   444→        注入 Phase 1 上下文（v11 个性化路由）
   445→
   446→        将以下占位符替换为实际内容：
   447→        - {user_portrait} - 用户画像
   448→        - {subscribed_skills} - 已订阅服务
   449→        - {recommendable_skills} - 可推荐服务
   450→        - {personalization_hint} - 个性化提示
   451→        - {boundary_rules_shared} - 能力边界规则 (v2.0)
   452→        """
   453→        # v2.0: 注入能力边界规则
   454→        prompt = inject_placeholders(prompt, {})
   455→
   456→        # 用户画像
   457→        user_portrait = self._build_user_portrait(profile)
   458→        prompt = prompt.replace("{user_portrait}", user_portrait)
   459→
   460→        # 已订阅服务
   461→        subscribed = profile.get("subscribed_skills", [])
   462→        subscribed_text = self._build_subscribed_skills_text(subscribed)
   463→        prompt = prompt.replace("{subscribed_skills}", subscribed_text)
   464→
   465→        # 可推荐服务
   466→        recommendable_text = self._build_recommendable_skills_text(subscribed)
   467→        prompt = prompt.replace("{recommendable_skills}", recommendable_text)
   468→
   469→        # 个性化提示
   470→        hint = self._build_personalization_hint(profile)
   471→        prompt = prompt.replace("{personalization_hint}", hint)
   472→
   473→        return prompt
   474→
   475→    def _build_user_portrait(self, profile: Dict[str, Any]) -> str:
   476→        """构建用户画像（~100 tokens）"""
   477→        if not profile:
   478→            return ""
   479→
   480→        lines = []
   481→
   482→        # 身份
   483→        identity = profile.get("identity", {})
   484→        if identity.get("display_name"):
   485→            lines.append(f"- 用户名：{identity['display_name']}")
   486→
   487→        # v2.0: 出生信息（用于直接回答 Profile 查询）
   488→        birth_info = identity.get("birth_info", {})
   489→        if birth_info:
   490→            birth_date = birth_info.get("birth_date") or birth_info.get("date")
   491→            if birth_date:
   492→                lines.append(f"- 出生日期：{birth_date}")
   493→            birth_time = birth_info.get("birth_time") or birth_info.get("time")
   494→            if birth_time:
   495→                lines.append(f"- 出生时间：{birth_time}")
   496→            birth_place = birth_info.get("birth_place") or birth_info.get("location")
   497→            if birth_place:
   498→                lines.append(f"- 出生地点：{birth_place}")
   499→
   500→        # Vibe.insight（原型）
   501→        vibe = profile.get("vibe", {})
   502→        insight = vibe.get("insight", {})
   503→        essence = insight.get("essence", {})
   504→
   505→        archetype = essence.get("archetype", {})
   506→        if archetype.get("primary"):
   507→            lines.append(f"- 原型：{archetype['primary']}")
   508→
   509→        traits = essence.get("traits", [])
   510→        if traits:
   511→            trait_names = [t.get("trait", str(t)) if isinstance(t, dict) else str(t) for t in traits[:3]]
   512→            lines.append(f"- 特质：{', '.join(trait_names)}")
   513→
   514→        # Vibe.target（关注领域）
   515→        target = vibe.get("target", {})
   516→
   517→        north_star = target.get("north_star", {})
   518→        if north_star.get("statement"):
   519→            statement = north_star["statement"]
   520→            if len(statement) > 50:
   521→                statement = statement[:50] + "..."
   522→            lines.append(f"- 愿景：{statement}")
   523→
   524→        focus = target.get("focus", {})
   525→        if focus.get("primary"):
   526→            lines.append(f"- 关注：{focus['primary']}")
   527→
   528→        if not lines:
   529→            return ""
   530→
   531→        return "## 用户画像\n\n" + "\n".join(lines)
   532→
   533→    def _build_subscribed_skills_text(self, subscribed: List[str]) -> str:
   534→        """构建已订阅服务列表"""
   535→        from .skill_loader import load_skill, get_available_skills
   536→        from .routing_config import get_skill_routing_config
   537→
   538→        if not subscribed:
   539→            return "用户暂未订阅任何服务。"
   540→
   541→        lines = ["用户已订阅的服务，可直接激活：\n"]
   542→
   543→        for skill_id in subscribed:
   544→            skill = load_skill(skill_id)
   545→            routing = get_skill_routing_config(skill_id) or {}
   546→
   547→            if skill:
   548→                desc = routing.get("short_desc") or skill.description
   549→                if len(desc) > 30:
   550→                    desc = desc[:30] + "..."
   551→                lines.append(f"- **{skill_id}**: {desc}")
   552→
   553→        return "\n".join(lines)
   554→
   555→    def _build_recommendable_skills_text(self, subscribed: List[str]) -> str:
   556→        """构建可推荐服务列表"""
   557→        from .skill_loader import load_skill, get_available_skills
   558→        from .routing_config import get_skill_routing_config
   559→
   560→        all_skills = [s for s in get_available_skills() if s != "core"]
   561→        not_subscribed = [s for s in all_skills if s not in subscribed]
   562→
   563→        if not not_subscribed:
   564→            return "用户已订阅所有服务。"
   565→
   566→        lines = ["用户未订阅但可能感兴趣（需先展示介绍卡片）：\n"]
   567→
   568→        for skill_id in not_subscribed[:4]:  # 最多显示 4 个
   569→            skill = load_skill(skill_id)
   570→            routing = get_skill_routing_config(skill_id) or {}
   571→
   572→            if skill:
   573→                desc = routing.get("short_desc") or skill.description
   574→                if len(desc) > 30:
   575→                    desc = desc[:30] + "..."
   576→                lines.append(f"- **{skill_id}**: {desc}")
   577→
   578→        return "\n".join(lines)
   579→
   580→    def _build_personalization_hint(self, profile: Dict[str, Any]) -> str:
   581→        """根据用户画像生成个性化路由提示"""
   582→        if not profile:
   583→            return ""
   584→
   585→        hints = []
   586→
   587→        vibe = profile.get("vibe", {})
   588→        target = vibe.get("target", {})
   589→        insight = vibe.get("insight", {})
   590→
   591→        # 如果有北极星目标
   592→        if target.get("north_star", {}).get("vision_scene"):
   593→            hints.append("用户有明确的人生愿景，优先考虑 lifecoach")
   594→
   595→        # 如果有关注领域
   596→        focus = target.get("focus", {}).get("primary")
   597→        if focus:
   598→            if "career" in focus.lower() or "职业" in focus:
   599→                hints.append("用户关注职业发展，优先考虑 career/lifecoach")
   600→            elif "relationship" in focus.lower() or "关系" in focus or "感情" in focus:
   601→                hints.append("用户关注关系，适合 bazi/zodiac 合盘分析")
   602→            elif "health" in focus.lower() or "健康" in focus:
   603→                hints.append("用户关注健康，适合 mindfulness")
   604→
   605→        # 如果有原型
   606→        archetype = insight.get("essence", {}).get("archetype", {}).get("primary")
   607→        if archetype:
   608→            if archetype in ["成长者", "探索者"]:
   609→                hints.append(f"用户是{archetype}人格，适合规划类服务")
   610→            elif archetype in ["智慧者", "洞察者"]:
   611→                hints.append(f"用户是{archetype}人格，适合深度分析服务")
   612→            elif archetype in ["稳定者", "守护者"]:
   613→                hints.append(f"用户是{archetype}人格，适合陪伴类服务")
   614→
   615→        if hints:
   616→            return "\n## 个性化提示\n\n" + "\n".join(f"- {h}" for h in hints)
   617→        return ""
   618→
   619→    def _get_fallback_phase1_prompt(self) -> str:
   620→        """Fallback Phase 1 Prompt"""
   621→        return """# Vibe
   622→
   623→你是 Vibe，生命对话者。你的任务是理解用户意图，引导 Ta 到合适的服务。
   624→
   625→## 行为准则
   626→
   627→1. **识别意图 → 调用工具**：不要只用文字回复，要调用工具
   628→2. **简短回应 + 工具**：调用工具时配合一句暖心的话
   629→3. **不确定 → 推荐**：调用 recommend_skills 让用户选择
   630→
   631→## 语气
   632→
   633→温暖、简洁、不啰嗦。像一个懂你的老朋友。
   634→
   635→示例：
   636→- "嗨～ 今天想聊点什么？"
   637→- "好的，让我来帮你看看～"
   638→- "迷茫的时候来找我就对了。"
   639→"""
   640→
   641→    def _get_ready_prompt(self) -> str:
   642→        """已准备好分析的 Prompt"""
   643→        return """## 当前状态
   644→
   645→用户信息已完整，命盘已生成。你可以开始分析了。
   646→
   647→**分析流程**：
   648→1. 快速扫描命盘中的关键特征
   649→2. 根据用户问题聚焦分析
   650→3. 用 `show_xxx` 工具展示分析结果
   651→4. 回答用户的追问
   652→"""
   653→
   654→    def _get_need_birth_prompt(self, collect_tool: str) -> str:
   655→        """需要收集出生信息的 Prompt"""
   656→        return f"""## 当前状态
   657→
   658→用户还没有告诉你出生信息。在深入分析之前，你需要先了解 Ta 的出生时间。
   659→
   660→**下一步**：调用 `{collect_tool}` 工具，让用户填写出生信息表单。
   661→不要用文字问"请问你的生日是？"——表单体验更好。
   662→"""
   663→
   664→    def _get_need_compute_prompt(self, compute_tool: str) -> str:
   665→        """需要计算的 Prompt"""
   666→        return f"""## 当前状态
   667→
   668→用户已提供出生信息，但还没有生成命盘。
   669→
   670→**下一步**：调用 `{compute_tool}` 工具生成命盘数据。
   671→计算完成后你就可以开始分析了。
   672→"""
   673→
   674→    def build_session_resume_prompt(
   675→        self,
   676→        session_context: SessionContext,
   677→        rule_name: Optional[str] = None
   678→    ) -> str:
   679→        """
   680→        构建会话恢复 Prompt（用于 SOP 模板）
   681→
   682→        专门用于断点续传场景
   683→        """
   684→        if not session_context or not session_context.has_checkpoint:
   685→            return ""
   686→
   687→        cp = session_context.checkpoint
   688→        session = session_context.session
   689→
   690→        lines = ["## 会话恢复模式\n"]
   691→
   692→        if cp:
   693→            lines.append(f"用户上次完成了 {cp.step} 个步骤。\n")
   694→
   695→            if cp.collected_data:
   696→                lines.append("**已收集信息**：")
   697→                for key, value in cp.collected_data.items():
   698→                    lines.append(f"- {key}: {value}")
   699→                lines.append("")
   700→
   701→            next_step = cp.step + 1
   702→            lines.append(f"**下一步**：")
   703→            lines.append(f"继续第 {next_step} 个问题\n")
   704→
   705→        lines.append("**处理方式**：")
   706→        lines.append("1. 简短问候：「欢迎回来！上次我们聊到了...」")
   707→        lines.append("2. 快速回顾（1-2 句）")
   708→        lines.append("3. 直接问下一个问题")
   709→
   710→        return "\n".join(lines)
   711→
   712→
   713→# ═══════════════════════════════════════════════════════════════════════════
   714→# Singleton
   715→# ═══════════════════════════════════════════════════════════════════════════
   716→
   717→_prompt_builder: Optional[PromptBuilder] = None
   718→
   719→
   720→def get_prompt_builder() -> PromptBuilder:
   721→    """获取 PromptBuilder 单例"""
   722→    global _prompt_builder
   723→    if _prompt_builder is None:
   724→        _prompt_builder = PromptBuilder()
   725→    return _prompt_builder
   726→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
