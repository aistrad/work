     1→"""
     2→Fortune API Routes - K-Line and Fortune Data
     3→Based on: vibelife spec v3.0, section 2.2.5
     4→
     5→Endpoints:
     6→- GET /api/v1/fortune/kline - Get K-Line visualization data
     7→- GET /api/v1/fortune/year/{year} - Get specific year detail
     8→- GET /api/v1/fortune/greeting - Get daily greeting
     9→- GET /api/v1/fortune/cycles - Get major luck cycles
    10→"""
    11→
    12→import logging
    13→from typing import Optional
    14→from datetime import date
    15→from uuid import UUID
    16→from fastapi import APIRouter, HTTPException, Query
    17→from pydantic import BaseModel, Field
    18→
    19→from services.fortune import (
    20→    get_kline_service,
    21→    calculate_major_cycles,
    22→    calculate_annual_fortune,
    23→)
    24→from services.greeting import (
    25→    get_greeting_service,
    26→)
    27→
    28→logger = logging.getLogger(__name__)
    29→router = APIRouter(prefix="/fortune", tags=["fortune"])
    30→
    31→
    32→# ═══════════════════════════════════════════════════════════════════════════
    33→# Request/Response Models
    34→# ═══════════════════════════════════════════════════════════════════════════
    35→
    36→class KLineRequest(BaseModel):
    37→    """Request for K-Line data"""
    38→    user_id: str
    39→    profile: dict
    40→    start_year: Optional[int] = None
    41→    end_year: Optional[int] = None
    42→
    43→
    44→class KLineResponse(BaseModel):
    45→    """Response for K-Line data"""
    46→    success: bool
    47→    data: Optional[dict] = None
    48→    error: Optional[str] = None
    49→
    50→
    51→class YearDetailResponse(BaseModel):
    52→    """Response for year detail"""
    53→    success: bool
    54→    data: Optional[dict] = None
    55→    error: Optional[str] = None
    56→
    57→
    58→class GreetingRequest(BaseModel):
    59→    """Request for daily greeting"""
    60→    profile: dict
    61→    voice_mode: str = Field(default="warm")
    62→    greeting_type: str = Field(default="morning")
    63→
    64→
    65→class GreetingResponse(BaseModel):
    66→    """Response for daily greeting"""
    67→    success: bool
    68→    greeting: Optional[dict] = None
    69→    error: Optional[str] = None
    70→
    71→
    72→class CyclesResponse(BaseModel):
    73→    """Response for major cycles"""
    74→    success: bool
    75→    cycles: list = []
    76→    error: Optional[str] = None
    77→
    78→
    79→# ═══════════════════════════════════════════════════════════════════════════
    80→# Routes
    81→# ═══════════════════════════════════════════════════════════════════════════
    82→
    83→@router.post("/kline", response_model=KLineResponse)
    84→async def get_kline(request: KLineRequest):
    85→    """
    86→    Get K-Line visualization data.
    87→
    88→    Returns data points, phases, and inflection points
    89→    for rendering the Life K-Line chart.
    90→    """
    91→    try:
    92→        service = get_kline_service()
    93→
    94→        year_range = None
    95→        if request.start_year and request.end_year:
    96→            year_range = (request.start_year, request.end_year)
    97→
    98→        kline_data = service.generate_kline(
    99→            user_id=UUID(request.user_id),
   100→            profile=request.profile,
   101→            year_range=year_range,
   102→        )
   103→
   104→        return KLineResponse(
   105→            success=True,
   106→            data=kline_data.to_dict(),
   107→        )
   108→
   109→    except Exception as e:
   110→        logger.error(f"K-Line generation failed: {e}")
   111→        return KLineResponse(
   112→            success=False,
   113→            error=str(e),
   114→        )
   115→
   116→
   117→@router.post("/year/{year}", response_model=YearDetailResponse)
   118→async def get_year_detail(
   119→    year: int,
   120→    user_id: str = Query(...),
   121→    profile: dict = None,
   122→):
   123→    """
   124→    Get detailed fortune information for a specific year.
   125→
   126→    Use this when user clicks on a year in the K-Line chart.
   127→    """
   128→    try:
   129→        service = get_kline_service()
   130→
   131→        detail = service.get_year_detail(
   132→            user_id=UUID(user_id),
   133→            profile=profile or {},
   134→            year=year,
   135→        )
   136→
   137→        return YearDetailResponse(
   138→            success=True,
   139→            data=detail,
   140→        )
   141→
   142→    except Exception as e:
   143→        logger.error(f"Year detail failed: {e}")
   144→        return YearDetailResponse(
   145→            success=False,
   146→            error=str(e),
   147→        )
   148→
   149→
   150→@router.post("/greeting", response_model=GreetingResponse)
   151→async def get_daily_greeting(request: GreetingRequest):
   152→    """
   153→    Get personalized daily greeting.
   154→
   155→    Returns greeting text, fortune hint, and action tip.
   156→    """
   157→    try:
   158→        service = get_greeting_service()
   159→
   160→        greeting = await service.generate_greeting(
   161→            profile=request.profile,
   162→            greeting_type=request.greeting_type,
   163→            voice_mode=request.voice_mode,
   164→        )
   165→
   166→        return GreetingResponse(
   167→            success=True,
   168→            greeting=greeting.to_dict(),
   169→        )
   170→
   171→    except Exception as e:
   172→        logger.error(f"Greeting generation failed: {e}")
   173→        return GreetingResponse(
   174→            success=False,
   175→            error=str(e),
   176→        )
   177→
   178→
   179→@router.get("/cycles", response_model=CyclesResponse)
   180→async def get_major_cycles(
   181→    birth_year: int = Query(..., description="Year of birth"),
   182→    day_master_element: str = Query("wood", description="Day master element"),
   183→    gender: str = Query("unknown", description="Gender for cycle direction"),
   184→):
   185→    """
   186→    Get major luck cycles (大运).
   187→
   188→    Returns list of 10-year cycles with themes and scores.
   189→    """
   190→    try:
   191→        cycles = calculate_major_cycles(
   192→            birth_year=birth_year,
   193→            day_master_element=day_master_element,
   194→            gender=gender,
   195→        )
   196→
   197→        return CyclesResponse(
   198→            success=True,
   199→            cycles=[c.to_dict() for c in cycles],
   200→        )
   201→
   202→    except Exception as e:
   203→        logger.error(f"Cycles calculation failed: {e}")
   204→        return CyclesResponse(
   205→            success=False,
   206→            error=str(e),
   207→        )
   208→
   209→
   210→@router.get("/annual/{year}")
   211→async def get_annual_fortune(
   212→    year: int,
   213→    day_master_element: str = Query("wood", description="Day master element"),
   214→):
   215→    """
   216→    Get annual fortune for a specific year.
   217→
   218→    Returns theme, highlights, and cautions for the year.
   219→    """
   220→    try:
   221→        fortune = calculate_annual_fortune(
   222→            day_master_element=day_master_element,
   223→            year=year,
   224→        )
   225→
   226→        return {
   227→            "success": True,
   228→            "fortune": fortune.to_dict(),
   229→        }
   230→
   231→    except Exception as e:
   232→        logger.error(f"Annual fortune failed: {e}")
   233→        return {
   234→            "success": False,
   235→            "error": str(e),
   236→        }
   237→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
