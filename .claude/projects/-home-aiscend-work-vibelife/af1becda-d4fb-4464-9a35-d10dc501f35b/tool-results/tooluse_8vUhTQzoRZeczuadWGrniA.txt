     1→import { NextResponse } from "next/server";
     2→import type { NextRequest } from "next/server";
     3→
     4→/**
     5→ * Middleware - 子域名检测
     6→ *
     7→ * 支持的子域名:
     8→ * - bazi.vibelife.app -> skill=bazi
     9→ * - zodiac.vibelife.app -> skill=zodiac
    10→ * - mbti.vibelife.app -> skill=mbti
    11→ *
    12→ * 本地开发:
    13→ * - localhost:3000 -> 默认 skill=bazi
    14→ * - bazi.localhost:3000 -> skill=bazi
    15→ * - zodiac.localhost:3000 -> skill=zodiac
    16→ */
    17→
    18→// 支持的 skill 类型
    19→const VALID_SKILLS = ["bazi", "zodiac", "mbti", "attach", "career"] as const;
    20→type ValidSkill = (typeof VALID_SKILLS)[number];
    21→
    22→// 默认 skill
    23→const DEFAULT_SKILL: ValidSkill = "bazi";
    24→
    25→export function middleware(request: NextRequest) {
    26→  const url = request.nextUrl.clone();
    27→  const hostname = request.headers.get("host") || "";
    28→
    29→  // 提取子域名
    30→  let skill: ValidSkill = DEFAULT_SKILL;
    31→
    32→  // 检测子域名
    33→  // 格式: {skill}.vibelife.app 或 {skill}.localhost:xxxx
    34→  const parts = hostname.split(".");
    35→
    36→  if (parts.length >= 2) {
    37→    const subdomain = parts[0].toLowerCase();
    38→
    39→    // 检查是否是有效的 skill 子域名
    40→    if (VALID_SKILLS.includes(subdomain as ValidSkill)) {
    41→      skill = subdomain as ValidSkill;
    42→    }
    43→  }
    44→
    45→  // 设置 skill 到请求头，供后续使用
    46→  const requestHeaders = new Headers(request.headers);
    47→  requestHeaders.set("x-vibelife-skill", skill);
    48→
    49→  // 同时设置 cookie 以便客户端读取
    50→  const response = NextResponse.next({
    51→    request: {
    52→      headers: requestHeaders,
    53→    },
    54→  });
    55→
    56→  // 设置 cookie（非 httpOnly，允许客户端 JS 读取）
    57→  response.cookies.set("vibelife-skill", skill, {
    58→    path: "/",
    59→    sameSite: "lax",
    60→    secure: process.env.NODE_ENV === "production",
    61→    maxAge: 60 * 60 * 24 * 365, // 1 year
    62→  });
    63→
    64→  return response;
    65→}
    66→
    67→export const config = {
    68→  matcher: [
    69→    /*
    70→     * Match all request paths except:
    71→     * - _next/static (static files)
    72→     * - _next/image (image optimization files)
    73→     * - favicon.ico (favicon file)
    74→     * - public folder files
    75→     */
    76→    "/((?!_next/static|_next/image|favicon.ico|.*\\..*|api).*)",
    77→  ],
    78→};
    79→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
