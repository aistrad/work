     1→# VibeLife V8 系统架构文档
     2→
     3→> Version: 8.0 | 2026-01-19
     4→> 核心理念：AI 原生的个人成长陪伴平台
     5→
     6→---
     7→
     8→## 1. 产品定位
     9→
    10→VibeLife 是一个 AI 原生的个人成长陪伴平台，通过多个专业 Skill 提供深度理解和主动关怀。
    11→
    12→### 1.1 三大差异化
    13→
    14→| 差异化 | 说明 |
    15→|--------|------|
    16→| **Deep Understanding** | 理解你这个人，而非只是问题 |
    17→| **Proactive Agency** | 主动关心，而非等你开口 |
    18→| **Infinite Extensibility** | 通过 Skills 无限扩展能力 |
    19→
    20→### 1.2 设计原则
    21→
    22→| 原则 | 说明 |
    23→|------|------|
    24→| **Simplicity** | 保持简单，避免过度工程 |
    25→| **Config-Driven** | Skill 层配置驱动，平台层代码驱动 |
    26→| **Single Source of Truth** | 工具定义、模型配置等只有一个数据源 |
    27→| **DDD** | 领域驱动设计，每个 Skill 独立管理自己的服务 |
    28→
    29→---
    30→
    31→## 2. 整体架构
    32→
    33→```
    34→┌─────────────────────────────────────────────────────────────────────────┐
    35→│                         VibeLife V8 Architecture                         │
    36→├─────────────────────────────────────────────────────────────────────────┤
    37→│                                                                          │
    38→│   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐          │
    39→│   │   Browser    │─────▶│   Next.js    │─────▶│  Python API  │          │
    40→│   │  (AI SDK 4)  │      │   (Proxy)    │      │  (FastAPI)   │          │
    41→│   └──────────────┘      └──────────────┘      └──────────────┘          │
    42→│                                                      │                   │
    43→│                         ┌────────────────────────────┼────────────────┐  │
    44→│                         │                            ▼                │  │
    45→│                         │   ┌────────────────────────────────────┐    │  │
    46→│                         │   │            CoreAgent               │    │  │
    47→│                         │   │     (Agentic Loop + Tool Calling)  │    │  │
    48→│                         │   └────────────────────────────────────┘    │  │
    49→│                         │              │              │               │  │
    50→│                         │    ┌─────────┴──────┐      │               │  │
    51→│                         │    ▼                ▼      ▼               │  │
    52→│                         │ ┌────────┐  ┌────────────┐ ┌────────────┐  │  │
    53→│                         │ │  Tool  │  │   Skill    │ │  Knowledge │  │  │
    54→│                         │ │Registry│  │  Loader    │ │  (Cases)   │  │  │
    55→│                         │ └────────┘  └────────────┘ └────────────┘  │  │
    56→│                         │                    │                       │  │
    57→│                         │    ┌───────────────┼───────────────┐       │  │
    58→│                         │    ▼               ▼               ▼       │  │
    59→│                         │ ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐    │  │
    60→│                         │ │ Bazi │  │Zodiac│  │Tarot │  │Career│    │  │
    61→│                         │ │Skill │  │Skill │  │Skill │  │Skill │    │  │
    62→│                         │ └──────┘  └──────┘  └──────┘  └──────┘    │  │
    63→│                         └──────────────────┬─────────────────────────┘  │
    64→│                                            ▼                            │
    65→│   ┌──────────────────────────────────────────────────────────────────┐  │
    66→│   │                      VibeProfile Layer                            │  │
    67→│   │          UnifiedProfileRepository (统一数据访问)                  │  │
    68→│   │  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐  │  │
    69→│   │  │  Identity  │  │   State    │  │Life Context│  │Skill Data  │  │  │
    70→│   │  │ (出生信息)  │  │ (情绪状态)  │  │(目标/提醒) │  │(命盘数据)  │  │  │
    71→│   │  └────────────┘  └────────────┘  └────────────┘  └────────────┘  │  │
    72→│   └──────────────────────────────────────────────────────────────────┘  │
    73→│                                            │                            │
    74→│   ┌──────────────────────────────────────────────────────────────────┐  │
    75→│   │                    UserDataSpace (数据层)                         │  │
    76→│   │  ┌─────────────────────┐  ┌─────────────────────────────────┐    │  │
    77→│   │  │ VibeProfile (WHO)   │  │   Operational (WHAT)            │    │  │
    78→│   │  │ unified_profiles    │  │   conversations, messages       │    │  │
    79→│   │  │ (JSONB)             │  │   notifications, payments       │    │  │
    80→│   │  └─────────────────────┘  └─────────────────────────────────┘    │  │
    81→│   └──────────────────────────────────────────────────────────────────┘  │
    82→│                                                                          │
    83→└─────────────────────────────────────────────────────────────────────────┘
    84→```
    85→
    86→---
    87→
    88→## 3. 核心引擎
    89→
    90→### 3.1 CoreAgent
    91→
    92→基于 Anthropic Agent 设计原则的对话引擎，是系统的核心。
    93→
    94→**核心流程**：
    95→```
    96→用户消息 → CoreAgent.run()
    97→    │
    98→    ├─ 1. Skill 路由（LLM 自动选择或前端指定）
    99→    │
   100→    ├─ 2. 构建 System Prompt
   101→    │      ├─ Skill 专家身份
   102→    │      ├─ SOP 规则（配置驱动）
   103→    │      ├─ 相关 Cases（倒排索引匹配）
   104→    │      └─ 用户上下文（Profile + Skill Data）
   105→    │
   106→    ├─ 3. LLM 调用（支持 Tool Calling）
   107→    │
   108→    ├─ 4. 工具执行（ToolRegistry）
   109→    │
   110→    └─ 5. 流式输出（AI SDK Data Stream Protocol）
   111→```
   112→
   113→**关键特性**：
   114→- **LLM 自动路由**：通过 `use_skill` 工具让 LLM 决定使用哪个 Skill
   115→- **SOP 配置驱动**：从 SKILL.md 读取 `requires_birth_info`、`requires_compute` 等配置
   116→- **Case 匹配**：使用倒排索引匹配相似案例，注入 System Prompt
   117→
   118→### 3.2 Skill System
   119→
   120→配置驱动的技能系统，支持自动发现。
   121→
   122→**Skill 分类**：
   123→```
   124→┌─────────────────────────────────────────────────────────────┐
   125→│  Core Layer (始终激活，不可取消)                              │
   126→│  └─ core: 生命对话者 - AI 的灵魂                             │
   127→├─────────────────────────────────────────────────────────────┤
   128→│  Default Layer (默认激活，免费，可取消)                       │
   129→│  ├─ mindfulness: 正念导师                                    │
   130→│  └─ lifecoach: 人生教练                                      │
   131→├─────────────────────────────────────────────────────────────┤
   132→│  Professional Layer (需订阅，付费)                           │
   133→│  ├─ bazi: 八字命理                                          │
   134→│  ├─ zodiac: 西方占星                                        │
   135→│  ├─ tarot: 塔罗占卜                                         │
   136→│  ├─ jungastro: 荣格占星                                     │
   137→│  └─ career: 职业规划                                        │
   138→└─────────────────────────────────────────────────────────────┘
   139→```
   140→
   141→**Skill 目录结构**：
   142→```
   143→skills/{skill_id}/
   144→├── SKILL.md              # Skill 定义（专家身份、触发词、配置）
   145→├── rules/                # 规则文件（分析要点、输出要求）
   146→│   ├── basic-reading.md
   147→│   └── career.md
   148→├── tools/                # 工具定义
   149→│   ├── tools.yaml        # 工具 Schema
   150→│   └── handlers.py       # 工具执行器
   151→├── services/             # 领域服务
   152→│   └── api.py            # API 服务（@skill_service 装饰器）
   153→├── scenarios/            # 场景文件（旧架构兼容）
   154→└── reminders.yaml        # 主动推送配置
   155→```
   156→
   157→### 3.3 Tool Registry
   158→
   159→统一的工具注册表，支持自动发现。
   160→
   161→**工具类型**：
   162→| 类型 | 说明 | 示例 |
   163→|------|------|------|
   164→| collect | 收集用户信息 | request_info |
   165→| calculate | 计算/排盘 | calculate_bazi |
   166→| display | 展示结果 | show_bazi_chart |
   167→| search | 知识检索 | search_db |
   168→| action | 执行操作 | write_user_data |
   169→
   170→**工具定义**（tools.yaml）：
   171→```yaml
   172→- name: show_bazi_chart
   173→  description: 展示八字命盘
   174→  tool_type: display
   175→  card_type: BaziChart
   176→  parameters:
   177→    - name: chart
   178→      type: object
   179→      required: true
   180→```
   181→
   182→**工具执行器**（handlers.py）：
   183→```python
   184→@tool_handler("show_bazi_chart")
   185→async def execute_show_bazi_chart(args: Dict, context: ToolContext) -> Dict:
   186→    return {"cardType": "bazi_chart", **args}
   187→```
   188→
   189→---
   190→
   191→## 4. 知识系统
   192→
   193→### 4.1 Knowledge Base v2
   194→
   195→基于 Case 倒排索引的知识检索系统，替代传统向量检索。
   196→
   197→**核心概念**：
   198→- **Cases**：从原文 LLM 抽取的结构化案例，存储在数据库中
   199→- **倒排索引**：基于 tags 的内存索引，快速匹配相似案例
   200→- **Rule 关联**：Cases 通过 `rule_ids` 关联到规则文件
   201→
   202→**数据流**：
   203→```
   204→原文 (PDF/MD)
   205→    │
   206→    ▼ LLM 抽取
   207→数据库: skill_cases 表
   208→    │
   209→    ▼ tags
   210→Case 倒排索引（内存缓存）
   211→    │
   212→    ▼ 用户命盘特征匹配
   213→System Prompt 注入
   214→```
   215→
   216→**Case 数据模型**：
   217→| 字段 | 类型 | 说明 |
   218→|------|------|------|
   219→| id | string | 案例 ID |
   220→| skill_id | string | 所属 Skill |
   221→| name | string | 案例名称 |
   222→| tags | string[] | 特征标签（用于匹配） |
   223→| rule_ids | string[] | 关联的规则 ID |
   224→| content | text | 案例正文（Markdown） |
   225→
   226→---
   227→
   228→## 5. 主动模块
   229→
   230→### 5.1 Proactive Engine
   231→
   232→主动触达用户，增强粘性和业务转化。通过 **VibeProfile** 统一管理用户订阅、推送偏好和提醒设置。
   233→
   234→**架构**：
   235→```
   236→每日 04:00 凌晨扫描
   237→    │
   238→    ▼
   239→┌─────────────────────────────────────────────────────────────┐
   240→│  ProactiveWorker.daily_scan()                                │
   241→│                                                              │
   242→│  1. 从 VibeProfile 获取所有 push_enabled 用户                │
   243→│     WHERE profile->'preferences'->'push_settings'->          │
   244→│           'push_enabled' = true                              │
   245→│                                                              │
   246→│  2. 为每个用户生成今日内容:                                  │
   247→│     • 检查 subscribed_skills，生成运势推送                   │
   248→│     • 检查 life_context.reminders，生成提醒推送              │
   249→│     • 检查 life_context.goals，生成目标进度推送              │
   250→│                                                              │
   251→│  3. 存入 notifications 表，标记 deliver_hour                 │
   252→│                                                              │
   253→└─────────────────────────────────────────────────────────────┘
   254→    │
   255→    ▼
   256→每小时投递 (00, 01, 02, ...)
   257→    │
   258→    ▼
   259→┌─────────────────────────────────────────────────────────────┐
   260→│  NotificationWorker.deliver()                                │
   261→│                                                              │
   262→│  SELECT * FROM notifications                                 │
   263→│  WHERE deliver_hour = current_hour AND delivered = false     │
   264→│                                                              │
   265→│  投递到用户设备                                              │
   266→└─────────────────────────────────────────────────────────────┘
   267→```
   268→
   269→**触发器类型**：
   270→| 类型 | 说明 | 数据来源 | 示例 |
   271→|------|------|---------|------|
   272→| time_based | 定时触发 | reminders.yaml | 每日运势 |
   273→| event_based | 事件触发 | VibeProfile.identity | 生日、节气 |
   274→| threshold_based | 阈值触发 | VibeProfile.state | 运势低于 40 分 |
   275→| emotion_based | 情绪触发 | VibeProfile.state | 检测到焦虑 |
   276→| skill_completion | 完成触发 | conversations | 深度对话后推荐 |
   277→| reminder_based | 用户提醒 | VibeProfile.life_context.reminders | 目标打卡、喝水 |
   278→
   279→**配置示例**（reminders.yaml）：
   280→```yaml
   281→skill_id: bazi
   282→enabled: true
   283→
   284→reminders:
   285→  - id: daily_fortune
   286→    name: 每日运势
   287→    trigger:
   288→      type: time_based
   289→      schedule: "0 4 * * *"
   290→    content:
   291→      generator: rules/daily-fortune.md
   292→      suggested_prompt: "想了解今天的运势详情？"
   293→      quick_actions:
   294→        - label: "今日宜忌"
   295→          prompt: "今天适合做什么？"
   296→```
   297→
   298→**用户提醒流程**（基于 VibeProfile）：
   299→```python
   300→# 每日扫描时检查用户的 reminders
   301→profile = await VibeProfileRepository.get_profile(user_id)
   302→reminders = profile.get("life_context", {}).get("reminders", [])
   303→
   304→for reminder in reminders:
   305→    if reminder["status"] != "active":
   306→        continue
   307→
   308→    # 检查今天是否应该触发
   309→    if should_trigger_today(reminder):
   310→        # 生成通知，在 trigger_hour 投递
   311→        await create_notification(
   312→            user_id=user_id,
   313→            type="reminder",
   314→            content=reminder["title"],
   315→            deliver_hour=reminder["trigger_hour"]
   316→        )
   317→```
   318→
   319→### 5.2 Skill Management
   320→
   321→让用户发现、订阅、管理 Skill。订阅信息存储在 **VibeProfile.preferences.subscribed_skills**。
   322→
   323→**订阅状态与推送**：
   324→| Skill 类别 | 订阅要求 | 推送条件 | 存储位置 |
   325→|-----------|---------|---------|---------|
   326→| core | 始终激活 | 始终推送 | - |
   327→| default | 默认激活，可取消 | status=subscribed && push_enabled=true | VibeProfile |
   328→| professional | 需订阅 | status=subscribed && push_enabled=true | VibeProfile |
   329→
   330→**数据结构**：
   331→```yaml
   332→preferences:
   333→  subscribed_skills:
   334→    bazi:
   335→      status: "subscribed"           # subscribed | unsubscribed
   336→      push_enabled: true
   337→      subscribed_at: "2026-01-01T00:00:00Z"
   338→      trial_messages_used: 0
   339→```
   340→
   341→---
   342→
   343→## 6. 用户体验
   344→
   345→### 6.1 对话体验
   346→
   347→**Core Skill 人格**：
   348→- 温暖但不粘腻
   349→- 智慧但不说教
   350→- 好奇但不窥探
   351→- 诚实但不伤害
   352→
   353→**能力层次**：
   354→1. **倾听与共情**：深度倾听、情绪感知、不评判
   355→2. **记忆与累积**：跨对话记忆、模式识别、变化觉察
   356→3. **引导探索**：苏格拉底式提问、重框架、联结
   357→4. **适度引导**：知道边界、轻推、播种、庆祝
   358→
   359→### 6.2 新用户流程
   360→
   361→```
   362→Landing → Loading → Aha Moment → Conversion
   363→   │          │          │           │
   364→   │          │          │           └─ 付费转化
   365→   │          │          └─ 日主洞察 + 今日运势
   366→   │          └─ 命盘渐进绘制 + 计算步骤展示
   367→   └─ 零摩擦入口（键盘直接输入生辰）
   368→```
   369→
   370→### 6.3 ShowCard Fallback 机制
   371→
   372→"专用优先，通用兜底"的卡片渲染策略：
   373→1. 优先使用注册的专用组件
   374→2. 不存在时根据 `fallbackType` 降级到通用视图
   375→3. 智能推断：根据 data/items/nodes 等属性自动选择
   376→
   377→**通用视图类型**：list, tree, table, timeline, form, select, chart, progress, counter, modal, toast, custom
   378→
   379→---
   380→
   381→## 7. 技术栈
   382→
   383→### 7.1 后端
   384→
   385→| 组件 | 技术 |
   386→|------|------|
   387→| 框架 | FastAPI (Python 3.11+) |
   388→| 数据库 | PostgreSQL 16 + pgvector |
   389→| LLM | DeepSeek / GLM / Claude (Anthropic 兼容 API) |
   390→| 向量嵌入 | BAAI/bge-m3 (1024维，本地 CUDA) |
   391→
   392→### 7.2 前端
   393→
   394→| 组件 | 技术 |
   395→|------|------|
   396→| 框架 | Next.js 14 (App Router) |
   397→| 语言 | TypeScript 5.3+ |
   398→| 样式 | Tailwind CSS 3.4 |
   399→| 动画 | Framer Motion |
   400→| AI SDK | Vercel AI SDK 4.x |
   401→
   402→### 7.3 LLM 模型配置
   403→
   404→**唯一配置源**：`config/models.yaml`
   405→
   406→```yaml
   407→providers:
   408→  deepseek:
   409→    base_url: https://api.deepseek.com/anthropic
   410→    is_anthropic_compatible: true
   411→  glm:
   412→    base_url: https://open.bigmodel.cn/api/anthropic/v1
   413→    is_anthropic_compatible: true
   414→
   415→routing:
   416→  chat:
   417→    free: deepseek-chat
   418→    paid: deepseek-chat
   419→    fallback: [glm-4.7]
   420→```
   421→
   422→---
   423→
   424→## 8. API 架构
   425→
   426→### 8.1 路由结构
   427→
   428→```
   429→routes/ (7 个核心路由文件)
   430→├── health.py           # 健康检查
   431→├── chat_v5.py          # CoreAgent 对话入口
   432→├── tools.py            # 工具 Schema API
   433→├── skills.py           # Skill Gateway（配置驱动）
   434→├── account.py          # 用户域（认证、用户、访客、身份）
   435→├── commerce.py         # 支付域（支付、订阅、权益）
   436→└── notifications.py    # 通知域
   437→```
   438→
   439→### 8.2 核心端点
   440→
   441→| 域 | 端点前缀 | 说明 |
   442→|----|----------|------|
   443→| Chat | `/api/v1/chat/v5/*` | CoreAgent 对话 |
   444→| Skills | `/api/v1/skills/{skill}/{action}` | 统一 Skill Gateway |
   445→| Account | `/api/v1/account/*` | 认证、用户、访客、身份 |
   446→| Commerce | `/api/v1/commerce/*` | 支付、订阅、权益 |
   447→| Tools | `/api/v1/tools/*` | 工具 Schema |
   448→| Notifications | `/api/v1/notifications/*` | 通知管理 |
   449→
   450→---
   451→
   452→## 9. 数据模型
   453→
   454→### 9.1 UserDataSpace - 数据空间划分
   455→
   456→VibeLife 采用 UserDataSpace 统一管理用户数据，区分 **WHO**（画像）和 **WHAT**（操作）：
   457→
   458→```
   459→┌─────────────────────────────────────────────────────────────────┐
   460→│                        UserDataSpace                             │
   461→├─────────────────────────────────────────────────────────────────┤
   462→│                                                                  │
   463→│   VibeProfile (WHO)              Operational (WHAT)              │
   464→│   ─────────────────              ──────────────────              │
   465→│   用户是谁                       用户做了什么                    │
   466→│   • unified_profiles             • conversations                 │
   467→│                                  • messages                      │
   468→│                                  • reports                       │
   469→│                                  • notifications                 │
   470→│                                  • subscriptions                 │
   471→│                                  • payments                      │
   472→│                                                                  │
   473→└─────────────────────────────────────────────────────────────────┘
   474→```
   475→
   476→### 9.2 核心表
   477→
   478→| 表 | 说明 | 数据类型 |
   479→|----|------|----------|
   480→| **VibeProfile (WHO)** | | |
   481→| unified_profiles | 用户画像（JSONB） | WHO |
   482→| vibe_profile_insights | AI 洞察（Cold Layer） | WHO |
   483→| vibe_profile_timeline | 重要事件时间线 | WHO |
   484→| **Operational (WHAT)** | | |
   485→| vibe_users | 用户基本信息 | WHAT |
   486→| conversations | 对话会话 | WHAT |
   487→| messages | 对话消息 | WHAT |
   488→| notifications | 通知记录 | WHAT |
   489→| skill_cases | 知识案例（Case 系统） | WHAT |
   490→| **Billing (WHAT)** | | |
   491→| subscriptions | 付费订阅记录 | WHAT |
   492→| payments | 支付记录 | WHAT |
   493→
   494→### 9.3 VibeProfile 数据结构
   495→
   496→**统一画像存储**（unified_profiles.profile JSONB）：
   497→
   498→```yaml
   499→profile:
   500→  account: { vibe_id, display_name, tier, status }  # 从 vibe_users 同步
   501→  identity:
   502→    birth_info: { date, time, place, timezone, gender }
   503→  state:
   504→    emotion: "neutral"              # anxious | sad | neutral | content | excited
   505→    focus: ["career"]
   506→    life_stage: "career_growth"
   507→  preferences:
   508→    voice_mode: "warm"
   509→    language: "zh-CN"
   510→    subscribed_skills:              # 整合 user_skill_subscriptions
   511→      bazi: { status, push_enabled, subscribed_at, trial_messages_used }
   512→    push_settings:                  # 整合 user_push_preferences
   513→      { default_push_hour, max_daily_pushes, quiet_start_hour, quiet_end_hour }
   514→    data_retention:
   515→      conversations: "1y"           # "1y" | "3y" | "forever"
   516→    blocked_skills: []
   517→  skill_data:
   518→    bazi: { chart, features, current_dayun, current_liunian }
   519→    zodiac: { chart, current_transits }
   520→    tarot: { last_reading }
   521→    career: { assessment }
   522→  extracted:                        # 从对话抽取
   523→    facts: []
   524→    goals: []
   525→    concerns: []
   526→    pain_points: []
   527→  life_context:                     # 整合 user_data_store
   528→    occupation: { title, industry }
   529→    focus_areas: ["career", "health"]
   530→    goals: [{ id, title, category, status, progress, deadline }]
   531→    tasks: [{ id, title, status, due_date, goal_id }]
   532→    checkins: { "2026-01-19": { mood, energy, notes } }  # 只保留 30 天
   533→    reminders: [{ id, type, title, schedule_type, trigger_hour, status }]
   534→    tracking: { last_checkin, streak_days }
   535→```
   536→
   537→**详细文档**：参见 `/docs/components/VibeProfile/SPEC.md`
   538→
   539→### 9.4 数据访问层
   540→
   541→**UnifiedProfileRepository** 提供统一的 Profile 访问接口（使用 jsonb_set 局部更新）：
   542→
   543→```python
   544→class UnifiedProfileRepository:
   545→    # 读取：get_profile, get_birth_info, get_skill_data, get_preferences,
   546→    #       get_life_context, get_extracted
   547→    # 写入：update_birth_info, update_skill_data, update_preferences,
   548→    #       update_life_context, update_extracted
   549→    # 生活管理：add_goal, update_goal, add_task, add_checkin, add_reminder
   550→    # Skill 订阅：subscribe, unsubscribe, is_subscribed, can_use_skill
   551→    # 推送管理：get_push_settings, is_push_enabled, get_users_with_push_enabled
   552→    # 缓存：_invalidate_cache (内存缓存，5分钟 TTL)
   553→```
   554→
   555→**实现位置**：`apps/api/stores/unified_profile_repo.py`
   556→
   557→### 9.5 Skill 访问规则
   558→
   559→| Skill | 可读 | 可写 |
   560→|-------|------|------|
   561→| **Core Layer** | | |
   562→| core | 全部 | state, extracted |
   563→| lifecoach | 全部 | state, extracted, life_context |
   564→| mindfulness | 全部 | state |
   565→| **Professional Layer** | | |
   566→| bazi | identity, state | skill_data.bazi |
   567→| zodiac | identity, state | skill_data.zodiac |
   568→| tarot | identity, state | skill_data.tarot |
   569→| career | identity, state, life_context | skill_data.career |
   570→
   571→### 9.6 数据生命周期
   572→
   573→| 领域 | 默认保留 | 用户可选 | 清理规则 |
   574→|------|---------|---------|---------|
   575→| **VibeProfile** | 永久 | - | checkins 保留 30 天 |
   576→| **Conversations** | 1 年 | 1年 / 3年 / 永久 | 按 data_retention 设置清理 |
   577→| **Content** | 永久 | 可手动删除 | - |
   578→| **Billing** | 7 年 | 不可更改 | 法规要求 |
   579→| **Logs** | 90 天 | - | 滚动清理 |
   580→| **Notifications** | 30 天 | - | 已读 30 天后清理 |
   581→
   582→### 9.7 已整合的废弃表
   583→
   584→以下表的数据已迁移到 VibeProfile，可以删除：
   585→- `user_skill_subscriptions` → `profile.preferences.subscribed_skills`
   586→- `user_push_preferences` → `profile.preferences.push_settings`
   587→- `user_data_store` → `profile.life_context`
   588→- `skill_recommendation_blocks` → `profile.preferences.blocked_skills`
   589→
   590→---
   591→
   592→## 10. 部署架构
   593→
   594→### 10.1 环境配置
   595→
   596→| 环境 | API 端口 | Web 端口 | 说明 |
   597→|------|----------|----------|------|
   598→| 开发 | 8000 | 3000 | 本地开发 |
   599→| 测试 | 8100 | 8232 | aiscend 服务器 |
   600→| 生产 | 8231 | 8230 | 分布式部署 |
   601→
   602→### 10.2 生产部署
   603→
   604→```
   605→用户 (全球)
   606→    │
   607→    ▼
   608→Cloudflare (边缘节点 + DDoS 防护)
   609→    │
   610→    ▼ HTTPS 加密隧道
   611→火山引擎香港 (Nginx + Next.js)
   612→    │
   613→    ▼
   614→北京服务器 (FastAPI + PostgreSQL)
   615→```
   616→
   617→---
   618→
   619→## 附录
   620→
   621→### A. AI SDK Data Stream Protocol
   622→
   623→```
   624→0:"text chunk"           # 文本块
   625→9:{"toolCallId":"..."}   # 工具调用开始
   626→a:{"toolCallId":"..."}   # 工具调用结果
   627→e:{"finishReason":"..."}  # 完成
   628→d:{"finishReason":"..."}  # 结束
   629→```
   630→
   631→### B. 添加新 Skill 流程
   632→
   633→1. 创建目录：`skills/newskill/{SKILL.md, rules/, tools/, services/}`
   634→2. 定义 SKILL.md：专家身份、触发词、配置
   635→3. 创建工具：tools.yaml + handlers.py
   636→4. 创建 API 服务：services/api.py（@skill_service 装饰器）
   637→5. 配置推送：reminders.yaml
   638→6. 重启服务 - 自动发现新 Skill
   639→
   640→### C. 版本历史
   641→
   642→- **V8.0** (2026-01-19):
   643→  - VibeProfile 整合：WHO/WHAT 数据分离，统一 JSONB 存储
   644→  - 整合 user_skill_subscriptions, user_push_preferences, user_data_store
   645→  - UnifiedProfileRepository 统一数据访问层
   646→  - Knowledge v2（Case 倒排索引）、Proactive 模块
   647→- **V7.1** (2026-01-18): LLM 自动路由、ShowCard Fallback 机制
   648→- **V7.0** (2026-01-15): SkillServiceRegistry、统一 Skill Gateway、路由精简
   649→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
