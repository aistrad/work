   730→
   731→        elif event_type == "invoice.paid":
   732→            await _handle_invoice_paid(data)
   733→
   734→        return {"received": True}
   735→
   736→    except HTTPException:
   737→        raise
   738→    except Exception as e:
   739→        logger.error(f"Webhook processing failed: {e}")
   740→        raise HTTPException(status_code=400, detail=str(e))
   741→
   742→
   743→async def _handle_checkout_completed(session):
   744→    """Handle checkout.session.completed - activate subscription or prepaid"""
   745→    session_id = session.get("id") if isinstance(session, dict) else session.id
   746→    metadata = session.get("metadata", {}) if isinstance(session, dict) else session.metadata
   747→
   748→    user_id = metadata.get("user_id")
   749→    region = metadata.get("region", "GLOBAL")
   750→    plan = metadata.get("plan_type")
   751→
   752→    if not user_id:
   753→        logger.warning(f"Checkout completed without user_id: {session_id}")
   754→        return
   755→
   756→    # Mark payment as success
   757→    payment = await payment_repo.get_payment_by_provider_id("stripe", session_id)
   758→    if payment:
   759→        await payment_repo.mark_payment_success(payment["id"])
   760→        logger.info(f"Payment {payment['id']} marked as success")
   761→
   762→    # Handle based on region (dual-track)
   763→    if region == "CN":
   764→        # Prepaid mode: calculate expiry based on service_days
   765→        service_days = int(metadata.get("service_days", 30))
   766→        expire_at = datetime.now() + timedelta(days=service_days)
   767→
   768→        logger.info(f"Prepaid activation: user={user_id}, days={service_days}, expires={expire_at}")
   769→        # TODO: Update user subscription in database
   770→        # await subscription_repo.create_or_extend_prepaid(user_id, service_days, session_id)
   771→
   772→    else:
   773→        # Subscription mode: link Stripe subscription
   774→        subscription_id = session.get("subscription") if isinstance(session, dict) else session.subscription
   775→        customer_id = session.get("customer") if isinstance(session, dict) else session.customer
   776→
   777→        logger.info(f"Subscription activation: user={user_id}, sub={subscription_id}, customer={customer_id}")
   778→        # TODO: Update user subscription in database
   779→        # await subscription_repo.create_subscription(user_id, subscription_id, customer_id)
   780→
   781→
   782→async def _handle_payment_intent_succeeded(payment_intent):
   783→    """
   784→    Handle payment_intent.succeeded - 支付成功
   785→
   786→    根据 Stripe 最佳实践：使用 webhook 确认支付，而非依赖客户端回调
   787→    """
   788→    intent_id = payment_intent.get("id") if isinstance(payment_intent, dict) else payment_intent.id
   789→    metadata = payment_intent.get("metadata", {}) if isinstance(payment_intent, dict) else payment_intent.metadata
   790→    amount = payment_intent.get("amount") if isinstance(payment_intent, dict) else payment_intent.amount
   791→
   792→    user_id = metadata.get("user_id")
   793→
   794→    logger.info(f"PaymentIntent succeeded: {intent_id}, user={user_id}, amount={amount}")
   795→
   796→    # 更新支付记录状态
   797→    payment = await payment_repo.get_payment_by_provider_id("stripe", intent_id)
   798→    if payment:
   799→        await payment_repo.mark_payment_success(payment["id"])
   800→        logger.info(f"Payment {payment['id']} marked as success via PaymentIntent")
   801→
   802→
   803→async def _handle_payment_intent_failed(payment_intent):
   804→    """
   805→    Handle payment_intent.payment_failed - 支付失败
   806→
   807→    记录失败原因，便于排查问题
   808→    """
   809→    intent_id = payment_intent.get("id") if isinstance(payment_intent, dict) else payment_intent.id
   810→    metadata = payment_intent.get("metadata", {}) if isinstance(payment_intent, dict) else payment_intent.metadata
   811→
   812→    # 获取失败原因
   813→    last_error = payment_intent.get("last_payment_error", {}) if isinstance(payment_intent, dict) else payment_intent.last_payment_error
   814→    error_message = last_error.get("message", "Unknown error") if isinstance(last_error, dict) else (last_error.message if last_error else "Unknown error")
   815→
   816→    user_id = metadata.get("user_id")
   817→
   818→    logger.warning(f"PaymentIntent failed: {intent_id}, user={user_id}, error={error_message}")
   819→
   820→    # 更新支付记录状态为失败
   821→    payment = await payment_repo.get_payment_by_provider_id("stripe", intent_id)
   822→    if payment:
   823→        await payment_repo.update_payment_status(payment["id"], "failed")
   824→        logger.info(f"Payment {payment['id']} marked as failed")
   825→
   826→
   827→async def _handle_subscription_updated(subscription):
   828→    """Handle subscription updates (plan changes, etc.)"""
   829→    subscription_id = subscription.get("id") if isinstance(subscription, dict) else subscription.id

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
