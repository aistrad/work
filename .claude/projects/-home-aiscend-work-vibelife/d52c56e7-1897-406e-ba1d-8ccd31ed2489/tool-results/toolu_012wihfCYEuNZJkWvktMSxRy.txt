     1→"""
     2→Entitlement Routes - User tier and quota management API
     3→"""
     4→from datetime import datetime, timedelta
     5→from typing import Optional
     6→from uuid import UUID
     7→
     8→from fastapi import APIRouter, HTTPException, Depends
     9→from pydantic import BaseModel
    10→
    11→from services.identity import get_current_user, CurrentUser
    12→from services.entitlement import EntitlementService
    13→
    14→router = APIRouter(prefix="/entitlement", tags=["Entitlement"])
    15→
    16→
    17→class UpgradeRequest(BaseModel):
    18→    """Upgrade request (for testing)"""
    19→    months: int = 1
    20→
    21→
    22→@router.get("")
    23→async def get_entitlements(current_user: CurrentUser = Depends(get_current_user)):
    24→    """Get current user's entitlements"""
    25→    entitlements = await EntitlementService.get_entitlements(current_user.user_id)
    26→    return entitlements
    27→
    28→
    29→@router.get("/can-chat")
    30→async def can_chat(current_user: CurrentUser = Depends(get_current_user)):
    31→    """Check if user can start a conversation"""
    32→    result = await EntitlementService.check_can_chat(current_user.user_id)
    33→    return result
    34→
    35→
    36→@router.post("/upgrade")
    37→async def upgrade_to_paid(
    38→    request: UpgradeRequest,
    39→    current_user: CurrentUser = Depends(get_current_user)
    40→):
    41→    """Upgrade to paid tier (for testing)"""
    42→    expires_at = datetime.now() + timedelta(days=30 * request.months)
    43→    success = await EntitlementService.upgrade_to_paid(current_user.user_id, expires_at)
    44→
    45→    if success:
    46→        return {
    47→            "success": True,
    48→            "message": f"Upgraded to paid tier for {request.months} month(s)",
    49→            "expires_at": expires_at.isoformat(),
    50→        }
    51→    raise HTTPException(status_code=500, detail="Upgrade failed")
    52→
    53→
    54→@router.post("/downgrade")
    55→async def downgrade_to_free(current_user: CurrentUser = Depends(get_current_user)):
    56→    """Downgrade to free tier (for testing)"""
    57→    success = await EntitlementService.downgrade_to_free(current_user.user_id)
    58→
    59→    if success:
    60→        return {"success": True, "message": "Downgraded to free tier"}
    61→    raise HTTPException(status_code=500, detail="Downgrade failed")
    62→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
