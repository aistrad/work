     1→# VibeLife 系统配置手册
     2→
     3→> 本文档包含配置和运行整个系统所需的全部核心信息
     4→
     5→---
     6→
     7→## 1. 环境变量完整配置
     8→
     9→复制到 `.env` 文件（项目根目录）:
    10→
    11→```bash
    12→# ═══════════════════════════════════════════════════════════════
    13→# 数据库 (必需)
    14→# ═══════════════════════════════════════════════════════════════
    15→VIBELIFE_DB_URL=postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
    16→VIBELIFE_DB_HOST=106.37.170.238
    17→VIBELIFE_DB_PORT=8224
    18→VIBELIFE_DB_NAME=vibelife
    19→VIBELIFE_DB_USER=postgres
    20→VIBELIFE_DB_PASSWORD=Ak4_9lScd-69WX
    21→VIBELIFE_DB_SSLMODE=prefer
    22→
    23→# ═══════════════════════════════════════════════════════════════
    24→# JWT 认证 (必需)
    25→# ═══════════════════════════════════════════════════════════════
    26→VIBELIFE_JWT_SECRET=vibelife-jwt-secret-key-2026-aiscend
    27→VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
    28→VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30
    29→
    30→# ═══════════════════════════════════════════════════════════════
    31→# API 服务 (必需)
    32→# ═══════════════════════════════════════════════════════════════
    33→VIBELIFE_API_PORT=8000
    34→VIBELIFE_API_HOST=0.0.0.0
    35→VIBELIFE_DEV=1
    36→VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8230,http://106.37.170.238:8231,http://106.37.170.238:8232,http://localhost:3000
    37→
    38→# ═══════════════════════════════════════════════════════════════
    39→# LLM 服务 (必需，至少配置一个)
    40→# ═══════════════════════════════════════════════════════════════
    41→
    42→# 智谱 GLM (主要对话模型)
    43→GLM_API_KEY=42b82ed9a13e4e8890ef3854bb840ef8.TcWZ4DIq0NF2xElF
    44→GLM_CHAT_MODEL=glm-4-flash
    45→GLM_VISION_MODEL=glm-4.6v
    46→GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
    47→
    48→# Claude (备选)
    49→CLAUDE_API_KEY=sk-Z0kVvuz5cIwtomKfLQH23MuYxsTgG7IuFxSDaeYoV4xwHGqD
    50→CLAUDE_BASE_URL=https://api2.qiandao.mom/v1
    51→CLAUDE_MODEL=claude-3-5-sonnet-20241022
    52→
    53→# Gemini (生图 + Embedding)
    54→GEMINI_API_KEY=sk-ynk9oTMtjhszj4IDoyUZreMg04NfefVGTlFtW7QvGYw4k9Dg
    55→GEMINI_BASE_URL=https://new.12ai.org/v1
    56→GEMINI_CHAT_MODEL=gemini-2.5-flash
    57→GEMINI_IMAGE_MODEL=gemini-2.5-flash-image
    58→
    59→# 默认提供商 (已迁移到 config/models.yaml)
    60→# DEFAULT_LLM_PROVIDER 已废弃，从 models.yaml defaults.chat.primary 读取
    61→# DEFAULT_IMAGE_PROVIDER 已废弃，从 models.yaml defaults.image_gen.primary 读取
    62→
    63→# ═══════════════════════════════════════════════════════════════
    64→# 向量嵌入 (知识库必需)
    65→# ═══════════════════════════════════════════════════════════════
    66→EMBEDDING_MODEL_NAME=BAAI/bge-m3
    67→EMBEDDING_DIMENSION=1024
    68→EMBEDDING_DEVICE=cuda
    69→EMBEDDING_LOCAL_DIR=/home/aiscend/.cache/vibelife/models/bge-m3
    70→DEFAULT_EMBEDDING_PROVIDER=local
    71→
    72→# ═══════════════════════════════════════════════════════════════
    73→# 向量存储 Pinecone (知识库必需)
    74→# ═══════════════════════════════════════════════════════════════
    75→PINECONE_API_KEY=pcsk_tVETE_HsAhSvJG9yN2nSdGfkMz2aTefYa72inmvnp97musqf3twzRgDiLEtHDdYAsBmiQ
    76→PINECONE_HOST=mentis-streams-nkchadl.svc.aped-4627-b74a.pinecone.io
    77→PINECONE_INDEX=vibelife-knowledge
    78→DEFAULT_VECTOR_PROVIDER=pinecone
    79→
    80→# ═══════════════════════════════════════════════════════════════
    81→# Stripe 支付 (商业化必需)
    82→# ═══════════════════════════════════════════════════════════════
    83→STRIPE_SECRET_KEY=sk_test_51Snq9KE8u1baYET0WjoEzHNCjlDAkaaATNEFyziJs4X1HF1AjPnV4YhrjS2Gy6UIhGApAenJn8BbP1uxwMrleRbS000LPmMzrC
    84→STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
    85→# STRIPE_WEBHOOK_SECRET=whsec_xxx  # Stripe Dashboard 创建 webhook 后获取
    86→
    87→# ═══════════════════════════════════════════════════════════════
    88→# 数据目录
    89→# ═══════════════════════════════════════════════════════════════
    90→VIBELIFE_DATA_ROOT=/data/vibelife
    91→VIBELIFE_KNOWLEDGE_ROOT=/data/vibelife/knowledge
    92→VIBELIFE_UPLOADS_ROOT=/data/vibelife/uploads
    93→VIBELIFE_CACHE_ROOT=/data/vibelife/cache
    94→VIBELIFE_LOGS_ROOT=/data/vibelife/logs
    95→
    96→# ═══════════════════════════════════════════════════════════════
    97→# 域名 (生产环境)
    98→# ═══════════════════════════════════════════════════════════════
    99→VIBELIFE_DOMAIN=vibelife.app
   100→BAZI_DOMAIN=bazi.vibelife.app
   101→ZODIAC_DOMAIN=zodiac.vibelife.app
   102→MBTI_DOMAIN=mbti.vibelife.app
   103→ID_DOMAIN=id.vibelife.app
   104→VIBELIFE_WEB_URL=http://106.37.170.238:8232
   105→```
   106→
   107→---
   108→
   109→## 2. 前端环境变量
   110→
   111→`apps/web/.env.local`:
   112→
   113→```bash
   114→NEXT_PUBLIC_API_URL=http://106.37.170.238:8100
   115→NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1
   116→NEXT_PUBLIC_WS_URL=ws://106.37.170.238:8100/ws
   117→VIBELIFE_API_INTERNAL=http://127.0.0.1:8100
   118→NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51Snq9KE8u1baYET0sdytV9kjJbap7twi1CldxH2Jxkv4oPz7crnXIP110JbS3ufdXk6Tf1amsRaIYiFzeyBOR6UL00Qww7hoY0
   119→```
   120→
   121→---
   122→
   123→## 3. 数据库初始化
   124→
   125→```bash
   126→# 连接数据库
   127→psql postgresql://postgres:Ak4_9lScd-69WX@106.37.170.238:8224/vibelife
   128→
   129→# 按顺序执行迁移
   130→psql -f migrations/001_v3_schema.sql
   131→psql -f migrations/002_interview_sessions.sql
   132→psql -f migrations/003_model_router.sql
   133→psql -f migrations/004_update_model_routes.sql
   134→psql -f migrations/005_user_gender_voice_mode.sql
   135→psql -f migrations/006_fix_knowledge_table_refs.sql
   136→psql -f migrations/007_skill_terms.sql
   137→psql -f migrations/008_knowledge_converted_path.sql
   138→psql -f migrations/009_user_notifications.sql
   139→psql -f migrations/010_user_entitlements.sql
   140→psql -f migrations/011_guest_sessions.sql
   141→psql -f migrations/012_payment_dual_track.sql
   142→psql -f migrations/013_fortune_cache.sql
   143→psql -f migrations/014_user_skill_data.sql
   144→```
   145→
   146→必需扩展: `uuid-ossp`, `pgcrypto`, `vector` (pgvector)
   147→
   148→---
   149→
   150→## 4. 启动命令
   151→
   152→```bash
   153→# 安装依赖
   154→pnpm install                              # 前端
   155→pip install -r apps/api/requirements.txt  # 后端
   156→
   157→# 开发环境
   158→cd apps/api && uvicorn main:app --reload --host 0.0.0.0 --port 8000  # API
   159→cd apps/web && pnpm dev                                               # Web
   160→
   161→# 测试环境 (端口 8100/8232)
   162→cd apps/api && uvicorn main:app --host 0.0.0.0 --port 8100
   163→cd apps/web && PORT=8232 pnpm dev
   164→
   165→# 生产环境 (Docker)
   166→cd deploy/aiscend && docker-compose up -d
   167→```
   168→
   169→---
   170→
   171→## 5. 端口分配
   172→
   173→| 服务 | 开发 | 测试 | 生产 |
   174→|------|------|------|------|
   175→| API | 8000 | 8100 | 8000 |
   176→| Web | 3000 | 8232 | 3000 |
   177→| PostgreSQL | - | 8224 | 8224 |
   178→
   179→---
   180→
   181→## 6. 核心目录结构
   182→
   183→```
   184→apps/api/
   185→├── main.py              # 入口，路由注册
   186→├── routes/              # API 路由 (17个)
   187→├── services/            # 业务服务 (21个模块)
   188→│   ├── vibe_engine/     # 核心引擎 (context, llm, portrait)
   189→│   ├── model_router/    # 模型路由 (多模型、配额、降级)
   190→│   ├── persona/         # 人格系统 (warm/sarcastic/wise)
   191→│   ├── knowledge/       # RAG 知识检索
   192→│   ├── identity/        # 认证 (JWT/OAuth)
   193→│   ├── billing/         # 账单
   194→│   ├── entitlement/     # 权益
   195→│   └── ...
   196→├── stores/db.py         # 数据库连接池
   197→├── tools/               # 命理计算 (bazi/zodiac)
   198→└── workers/             # 后台任务 (IngestionWorker)
   199→
   200→apps/web/src/
   201→├── app/                 # Next.js App Router 页面
   202→├── components/          # React 组件
   203→└── hooks/               # 自定义 Hooks
   204→```
   205→
   206→---
   207→
   208→## 7. API 路由清单
   209→
   210→| 路由 | 前缀 | 核心端点 |
   211→|------|------|----------|
   212→| auth | /api/v1 | POST /auth/login, /auth/register |
   213→| guest | /api/v1 | POST /guest/session |
   214→| users | /api/v1 | GET /users/me, PUT /users/profile |
   215→| chat | /api/v1 | POST /chat/message (SSE) |
   216→| onboarding | /api/v1 | POST /onboarding/start |
   217→| report | /api/v1 | POST /report/generate |
   218→| relationship | /api/v1 | POST /relationship/analyze |
   219→| fortune | /api/v1 | GET /fortune/yearly |
   220→| payment | /api/v1 | POST /payment/create-session |
   221→| billing | /api/v1 | GET /billing/subscription |
   222→| entitlement | /api/v1 | GET /entitlement/check |
   223→| bazi | /api/v1 | POST /bazi/calculate |
   224→| zodiac | /api/v1 | POST /zodiac/chart |
   225→| memories | /api/v1 | GET /memories/insights |
   226→| identity | /api/v1 | POST /identity/link |
   227→| health | / | GET /health |
   228→
   229→---
   230→
   231→## 8. 数据库核心表
   232→
   233→| 表 | 主键 | 关键字段 |
   234→|----|------|----------|
   235→| vibe_users | id (UUID) | vibe_id, email, phone, is_guest |
   236→| user_auth | id | user_id, auth_type, auth_identifier, password_hash |
   237→| user_profiles | id | user_id, version, profile (JSONB) |
   238→| conversations | id | user_id, skill, voice_mode |
   239→| messages | id | conversation_id, role, content |
   240→| reports | id | user_id, skill, report_type, content (JSONB), is_paid |
   241→| relationships | id | initiator_id, partner_id, analysis (JSONB) |
   242→| subscriptions | id | user_id, plan_id, status, current_period_end |
   243→| payments | id | user_id, amount, currency, status |
   244→| user_entitlements | id | user_id, entitlement_type, remaining |
   245→| insights | id | user_id, category, content |
   246→
   247→---
   248→
   249→## 9. LLM 模型配置
   250→
   251→| 用途 | 提供商 | 模型 | 环境变量 |
   252→|------|--------|------|----------|
   253→| 主对话 | 智谱 | glm-4-flash | GLM_CHAT_MODEL |
   254→| 视觉 | 智谱 | glm-4.6v | GLM_VISION_MODEL |
   255→| 备选对话 | Claude | claude-3-5-sonnet | CLAUDE_MODEL |
   256→| 生图 | Gemini | gemini-2.5-flash-image | GEMINI_IMAGE_MODEL |
   257→| 向量嵌入 | 本地 | BAAI/bge-m3 (1024维) | EMBEDDING_MODEL_NAME |
   258→
   259→模型路由优先级: 数据库规则 > 代码默认值
   260→
   261→---
   262→
   263→## 10. 人格系统
   264→
   265→| 人格 | voice_mode | 风格 |
   266→|------|------------|------|
   267→| 暖心向导 | warm | 共情、支持、鼓励 |
   268→| 毒舌损友 | sarcastic | 直接、犀利、有趣 |
   269→| 人生导师 | wise | 理性、深度、像长辈指点 |
   270→
   271→存储: `user_profiles.profile.preferences.voice_mode`
   272→
   273→---
   274→
   275→## 11. 支付双轨制
   276→
   277→| 轨道 | 货币 | 类型 | 目标用户 |
   278→|------|------|------|----------|
   279→| 海外订阅 | USD | Recurring | 海外用户 |
   280→| 大陆预付 | HKD | One-time | 大陆/香港用户 |
   281→
   282→Stripe Price ID 需在 Dashboard 创建后填入环境变量。
   283→
   284→---
   285→
   286→## 12. 知识库配置
   287→
   288→向量存储: Pinecone (3072维, cosine)
   289→本地嵌入: BAAI/bge-m3 (1024维, CUDA)
   290→
   291→知识库目录:
   292→```
   293→packages/knowledge/
   294→├── bazi/      # 八字知识
   295→├── zodiac/    # 星座知识
   296→├── mbti/      # MBTI 知识
   297→└── shared/    # 共享知识
   298→```
   299→
   300→---
   301→
   302→## 13. 日志位置
   303→
   304→- API 请求日志: `/opt/vibelife/logs/api_requests.log`
   305→- 数据目录: `/data/vibelife/`
   306→- Docker 日志: `deploy/aiscend/logs/`
   307→
   308→---
   309→
   310→## 14. 健康检查
   311→
   312→```bash
   313→# API 健康检查
   314→curl http://localhost:8000/health
   315→
   316→# 数据库连接测试
   317→psql $VIBELIFE_DB_URL -c "SELECT 1"
   318→
   319→# Pinecone 连接测试
   320→curl -H "Api-Key: $PINECONE_API_KEY" https://$PINECONE_HOST/describe_index_stats
   321→```
   322→
   323→---
   324→
   325→## 15. 常见问题
   326→
   327→**Q: API 启动失败 "VIBELIFE_DB_URL not set"**
   328→A: 确保 `.env` 文件在项目根目录，且包含 `VIBELIFE_DB_URL`
   329→
   330→**Q: 前端无法连接 API**
   331→A: 检查 `VIBELIFE_CORS_ORIGINS` 是否包含前端地址
   332→
   333→**Q: 向量嵌入报错**
   334→A: 确保 `EMBEDDING_LOCAL_DIR` 路径存在，或首次运行时会自动下载模型
   335→
   336→**Q: Stripe 支付失败**
   337→A: 检查 `STRIPE_SECRET_KEY` 是否正确，测试环境用 `sk_test_` 开头的密钥
   338→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
