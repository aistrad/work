     1→# VibeLife 登录体系设计文档 v1.0
     2→
     3→> **版本**: 1.0
     4→> **日期**: 2026-01-10
     5→> **状态**: 已实现
     6→
     7→---
     8→
     9→## 一、核心设计原则
    10→
    11→```
    12→游客��先 → 价值先行 → 转化自然
    13→```
    14→
    15→用户无需注册即可体验核心价值，在感受到「被理解」后自然转化。
    16→
    17→---
    18→
    19→## 二、用户身份状态
    20→
    21→| 状态 | 标识 | 权限 |
    22→|------|------|------|
    23→| **游客** | session_id (cookie) | 完整 onboarding + 简版报告 |
    24→| **免费用户** | user_id + vibe_id | 简版报告 + 有限次对话/功能 |
    25→| **付费用户** | user_id + subscription | 完整报告 + 无限对话 + 全功能 |
    26→
    27→---
    28→
    29→## 三、免费用户权限配置
    30→
    31→```python
    32→# apps/api/services/identity/usage_limits.py
    33→
    34→FREE_USER_LIMITS = {
    35→    "chat_message": {"daily": 10},           # 每日对话次数
    36→    "relationship_analysis": {"total": 3},   # 关系模拟器总次数
    37→    "life_kline": {"total": 3},              # 人生K线查看次数
    38→    "report_generation": {"total": 1},       # 简版报告生成次数
    39→}
    40→```
    41→
    42→---
    43→
    44→## 四、完整用户流程
    45→
    46→```
    47→┌─────────────────────────────────────────────────────────────────────────────┐
    48→│                           VibeLife 用户流程                                  │
    49→├─────────────────────────────────────────────────────────────────────────────┤
    50→│                                                                             │
    51→│  [游客] Landing Page                                                        │
    52→│      │                                                                      │
    53→│      ▼                                                                      │
    54→│  输入生辰 → AI访谈 → 简版报告 ──────────────────────────────────────┐       │
    55→│      │                                                              │       │
    56→│      │ (后端生成 session_id，存 cookie)                             │       │
    57→│      │                                                              │       │
    58→│      ▼                                                              ▼       │
    59→│  ┌─────────────────────────────────────────────────────────────────────┐   │
    60→│  │                         付费墙 / 注册墙                              │   │
    61→│  │                                                                     │   │
    62→│  │   「解锁完整报告 + 高清海报」                                        │   │
    63→│  │                                                                     │   │
    64→│  │   ┌─────────────────────────────────────────────────────────────┐  │   │
    65→│  │   │  注册方式（统一展示，用户自选）                               │  │   │
    66→│  │   │                                                             │  │   │
    67→│  │   │  [Continue with Google]                                     │  │   │
    68→│  │   │  [Continue with Apple]                                      │  │   │
    69→│  │   │  ─────────── or ───────────                                 │  │   │
    70→│  │   │  [手机号注册]  [邮箱注册]                                     │  │   │
    71→│  │   └─────────────────────────────────────────────────────────────┘  │   │
    72→│  │                                                                     │   │
    73→│  │   已有账号？ [登录]                                                 │   │
    74→│  │                                                                     │   │
    75→│  └─────────────────────────────────────────────────────────────────────┘   │
    76→│      │                                                                      │
    77→│      ▼                                                                      │
    78→│  [注册成功] → 自动关联 session 数据                                         │
    79→│      │                                                                      │
    80→│      ▼                                                                      │
    81→│  ┌─────────────────────────────────────────────────────────────────────┐   │
    82→│  │  「是否立即购买完整报告？」                                          │   │
    83→│  │                                                                     │   │
    84→│  │  [立即购买 ¥19.9]     [稍后再说，先体验]                            │   │
    85→│  └─────────────────────────────────────────────────────────────────────┘   │
    86→│      │                           │                                          │
    87→│      ▼                           ▼                                          │
    88→│  [付费用户]                   [免费用户]                                    │
    89→│  完整报告+全功能              简版报告+有限次数                             │
    90→│                                                                             │
    91→└─────────────────────────────────────────────────────────────────────────────┘
    92→```
    93→
    94→---
    95→
    96→## 五、技术实现
    97→
    98→### 5.1 数据库表
    99→
   100→```sql
   101→-- migrations/011_guest_sessions.sql
   102→
   103→-- 游客会话表
   104→CREATE TABLE guest_sessions (
   105→    id UUID PRIMARY KEY,
   106→    session_id VARCHAR(32) UNIQUE NOT NULL,  -- gs_xxxxxxxxxxxx
   107→    birth_datetime TIMESTAMPTZ,
   108→    birth_location VARCHAR(255),
   109→    gender VARCHAR(20),
   110→    voice_mode VARCHAR(20) DEFAULT 'warm',
   111→    skill VARCHAR(50),
   112→    interview_responses JSONB DEFAULT '{}',
   113→    focus_areas JSONB DEFAULT '[]',
   114→    converted_user_id UUID REFERENCES vibe_users(id),
   115→    converted_at TIMESTAMPTZ,
   116→    expires_at TIMESTAMPTZ NOT NULL,  -- 30天后过期
   117→    created_at TIMESTAMPTZ DEFAULT NOW()
   118→);
   119→
   120→-- 用户使用次数表
   121→CREATE TABLE user_usage (
   122→    id UUID PRIMARY KEY,
   123→    user_id UUID NOT NULL REFERENCES vibe_users(id),
   124→    usage_type VARCHAR(50) NOT NULL,
   125→    count INT DEFAULT 0,
   126→    period_start DATE NOT NULL,
   127→    period_type VARCHAR(20) DEFAULT 'daily',
   128→    UNIQUE(user_id, usage_type, period_start, period_type)
   129→);
   130→
   131→-- 密码重置令牌表
   132→CREATE TABLE password_reset_tokens (
   133→    id UUID PRIMARY KEY,
   134→    user_id UUID NOT NULL REFERENCES vibe_users(id),
   135→    token VARCHAR(100) UNIQUE NOT NULL,
   136→    token_type VARCHAR(20) NOT NULL,  -- email | phone
   137→    used_at TIMESTAMPTZ,
   138→    expires_at TIMESTAMPTZ NOT NULL,  -- 1小时后过期
   139→    created_at TIMESTAMPTZ DEFAULT NOW()
   140→);
   141→```
   142→
   143→### 5.2 后端服务
   144→
   145→| 文件 | 说明 |
   146→|------|------|
   147→| `stores/guest_session_repo.py` | 游客会话数据访问层 |
   148→| `stores/usage_repo.py` | 使用次数数据访问层 |
   149→| `stores/password_reset_repo.py` | 密码重置令牌数据访问层 |
   150→| `services/identity/guest_session.py` | 游客会话业务逻辑 |
   151→| `services/identity/usage_limits.py` | 使用次数限制业务逻辑 |
   152→| `services/identity/password_reset.py` | 密码重置业务逻辑 |
   153→| `routes/guest.py` | 游客会话 API 路由 |
   154→
   155→### 5.3 API 端点
   156→
   157→#### 游客会话
   158→
   159→| 方法 | 端点 | 说明 |
   160→|------|------|------|
   161→| POST | `/api/v1/guest/session` | 创建游客会话 |
   162→| GET | `/api/v1/guest/session` | 获取当前游客会话 |
   163→| PUT | `/api/v1/guest/session/onboarding` | 保存 onboarding 数据 |
   164→| DELETE | `/api/v1/guest/session` | 清除游客会话 |
   165→
   166→#### 认证
   167→
   168→| 方法 | 端点 | 说明 |
   169→|------|------|------|
   170→| POST | `/api/v1/auth/register` | 注册（支持 session_id 关联） |
   171→| POST | `/api/v1/auth/login` | 登录 |
   172→| POST | `/api/v1/auth/oauth/google` | Google OAuth 登录 |
   173→| POST | `/api/v1/auth/oauth/apple` | Apple OAuth 登录 |
   174→| POST | `/api/v1/auth/password/reset-request` | 请求密码重置 |
   175→| POST | `/api/v1/auth/password/verify-token` | 验证重置令牌 |
   176→| POST | `/api/v1/auth/password/reset` | 重置密码 |
   177→
   178→### 5.4 前端组件
   179→
   180→| 文件 | 说明 |
   181→|------|------|
   182→| `hooks/useGuestSession.ts` | 游客会话管理 hook |
   183→| `components/auth/OAuthButtons.tsx` | Google/Apple OAuth 按钮 |
   184→| `components/auth/PurchasePrompt.tsx` | 注册后购买询问弹窗 |
   185→| `app/auth/login/page.tsx` | 登录页面（含 OAuth） |
   186→| `app/auth/register/page.tsx` | 注册页面 |
   187→| `app/auth/forgot-password/page.tsx` | 忘记密码页面 |
   188→| `app/auth/reset-password/page.tsx` | 重置密码页面 |
   189→
   190→---
   191→
   192→## 六、配置要求
   193→
   194→### 6.1 环境变量
   195→
   196→```bash
   197→# OAuth
   198→GOOGLE_CLIENT_ID=your_google_client_id
   199→GOOGLE_CLIENT_SECRET=your_google_client_secret
   200→APPLE_CLIENT_ID=your_apple_client_id
   201→APPLE_TEAM_ID=your_apple_team_id
   202→APPLE_KEY_ID=your_apple_key_id
   203→
   204→# 前端
   205→NEXT_PUBLIC_GOOGLE_CLIENT_ID=your_google_client_id
   206→NEXT_PUBLIC_APPLE_CLIENT_ID=your_apple_client_id
   207→```
   208→
   209→### 6.2 CORS 配置
   210→
   211→确保 `VIBELIFE_CORS_ORIGINS` 包含前端域名，并启用 `credentials: true`。
   212→
   213→---
   214→
   215→## 七、访谈决策记录
   216→
   217→| 问题 | 决策 |
   218→|------|------|
   219→| 游客数据存储 | 后端临时会话 (session_id)，30天有效期 |
   220→| 地区适配 | 统一展示所有选项，用户自选 |
   221→| 注册+支付 | 先注册 → 再问是否购买 |
   222→| 支付失败 | 账号已创建，可登录看简版 |
   223→| OAuth 关联 | 只看后台数据库，不检测 localStorage |
   224→| 登录入口 | 双入口（导航栏 + 付费墙） |
   225→| 密码找回 | 邮箱/手机都支持 |
   226→| 手机号验证 | 保持「手机号 + 密码」 |
   227→| 国际区号 | 支持所有（第一阶段先不实现） |
   228→
   229→---
   230→
   231→## 八、后续迭代
   232→
   233→- [ ] 国际区号支持
   234→- [ ] 短信验证码登录
   235→- [ ] 微信登录（大陆用户）
   236→- [ ] 邮件发送服务集成
   237→- [ ] 短信发送服务集成
   238→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
