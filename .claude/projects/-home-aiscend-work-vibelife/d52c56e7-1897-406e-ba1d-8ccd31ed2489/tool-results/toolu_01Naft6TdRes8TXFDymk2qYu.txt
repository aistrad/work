     1â†’# Vibelife æ”¯ä»˜ä½“ç³»å®æ–½ä¸é›†æˆæ‰‹å†Œ (Ver 2.0)
     2â†’
     3â†’> ğŸ“… æ›´æ–°æ—¥æœŸï¼š2025å¹´1æœˆ  
     4â†’> ğŸ¯ ç›®æ ‡è¯»è€…ï¼šCTO / å…¨æ ˆå·¥ç¨‹å¸ˆ / äº§å“ç»ç†  
     5â†’> ğŸ“ é€‚ç”¨å¹³å°ï¼šStripe Hong Kong è´¦æˆ·
     6â†’
     7â†’---
     8â†’
     9â†’## âš ï¸ å…³é”®æ›´æ–°è¯´æ˜ (v2.0 é‡å¤§å˜æ›´)
    10â†’
    11â†’> **ã€å¿…è¯»ã€‘** æœ¬æ‰‹å†ŒåŸºäº Stripe 2025 å¹´æœ€æ–°æ”¿ç­–è¿›è¡Œäº†é‡å¤§æ›´æ–°ï¼š
    12â†’> 
    13â†’> 1. **æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜ä¸æ”¯æŒ Recurring è®¢é˜…** - åœ¨ Stripe Checkout ä¸­ä»…æ”¯æŒä¸€æ¬¡æ€§æ”¯ä»˜ (One-time Payment)
    14â†’> 2. **å¿…é¡»é‡‡ç”¨åŒè½¨åˆ¶** - æµ·å¤–ç”¨æˆ·èµ°ä¿¡ç”¨å¡è®¢é˜…ï¼Œå¤§é™†ç”¨æˆ·èµ°é¢„ä»˜æ—¶é•¿æ¨¡å¼
    15â†’> 3. **è´¹ç‡å·²æ›´æ–°** - åæ˜  Stripe HK æœ€æ–°å®šä»·ç»“æ„
    16â†’
    17â†’---
    18â†’
    19â†’## 1. Stripe é¦™æ¸¯è´¦æˆ·è´¹ç‡ç»“æ„ (2025)
    20â†’
    21â†’### 1.1 äº¤æ˜“æ‰‹ç»­è´¹
    22â†’
    23â†’| æ”¯ä»˜æ–¹å¼ | è´¹ç‡ | é€‚ç”¨åœºæ™¯ |
    24â†’|---------|------|---------|
    25â†’| ä¿¡ç”¨å¡/å€Ÿè®°å¡ (æœ¬åœ°) | **3.4% + HK$2.35** | é¦™æ¸¯å‘è¡Œçš„å¡ç‰‡ |
    26â†’| ä¿¡ç”¨å¡/å€Ÿè®°å¡ (å›½é™…) | **3.4% + HK$2.35 + 0.5%** | éé¦™æ¸¯å‘è¡Œçš„å¡ç‰‡ |
    27â†’| æ”¯ä»˜å® / å¾®ä¿¡æ”¯ä»˜ | **2.2% + HK$2.00** | âš ï¸ ä»…æ”¯æŒä¸€æ¬¡æ€§æ”¯ä»˜ |
    28â†’| è´§å¸è½¬æ¢è´¹ | **+2%** | éœ€è¦è´§å¸è½¬æ¢æ—¶é¢å¤–æ”¶å– |
    29â†’
    30â†’### 1.2 å…¶ä»–è´¹ç”¨
    31â†’
    32â†’| é¡¹ç›® | è´¹ç”¨ | è¯´æ˜ |
    33â†’|-----|------|-----|
    34â†’| äº‰è®®/é€€æ¬¾ (Dispute) | HK$85.00 | æ¯ç¬”äº‰è®®æ”¶å–ï¼›èƒœè¯‰å¯é€€è¿˜ |
    35â†’| 3D Secure éªŒè¯ | å…è´¹ | æ ‡å‡†å®šä»·ç”¨æˆ·å…è´¹ |
    36â†’| USD å‡ºæ¬¾ | 1% (æœ€ä½ $5) | ææ¬¾åˆ° USD é“¶è¡Œè´¦æˆ· |
    37â†’| Billing (è®¢é˜…ç®¡ç†) | 0.7% | æŒ‰éœ€ä»˜è´¹æ¨¡å¼ |
    38â†’
    39â†’### 1.3 é€€æ¬¾æœŸé™
    40â†’
    41â†’| æ”¯ä»˜æ–¹å¼ | é€€æ¬¾æœŸé™ |
    42â†’|---------|---------|
    43â†’| æ”¯ä»˜å® | 90 å¤©å†… |
    44â†’| å¾®ä¿¡æ”¯ä»˜ | 180 å¤©å†… |
    45â†’| ä¿¡ç”¨å¡ | æ— é™åˆ¶ |
    46â†’
    47â†’> ğŸ’¡ **æˆæœ¬ä¼˜åŒ–æç¤º**ï¼šå¦‚æœä½¿ç”¨ HKD æ”¶æ¬¾å¹¶ç»“ç®—åˆ° HKD é“¶è¡Œè´¦æˆ·ï¼Œå¯é¿å… 2% è´§å¸è½¬æ¢è´¹ã€‚
    48â†’
    49â†’---
    50â†’
    51â†’## 2. å®šä»·ç­–ç•¥è®¾è®¡ (Pricing Strategy)
    52â†’
    53â†’### 2.1 æ ¸å¿ƒç­–ç•¥ï¼šåŒè½¨åˆ¶
    54â†’
    55â†’ç”±äºæ”¯ä»˜å®/å¾®ä¿¡**ä¸æ”¯æŒ Stripe çš„ Recurring è®¢é˜…**ï¼Œæˆ‘ä»¬é‡‡ç”¨ã€ŒåŒè½¨åˆ¶ã€ï¼š
    56â†’
    57â†’| ç”¨æˆ·ç¾¤ä½“ | æ”¯ä»˜æ¨¡å¼ | Stripe Mode | è´§å¸ |
    58â†’|---------|---------|-------------|-----|
    59â†’| æµ·å¤–ç”¨æˆ· (Global) | ä¿¡ç”¨å¡è‡ªåŠ¨ç»­è´¹è®¢é˜… | `subscription` | USD |
    60â†’| å¤§é™†/é¦™æ¸¯ç”¨æˆ· (CN/HK) | é¢„ä»˜æ—¶é•¿ï¼ˆä¸€æ¬¡æ€§è´­ä¹°ï¼‰ | `payment` | HKD |
    61â†’
    62â†’### 2.2 ä»·æ ¼é…ç½®è¡¨
    63â†’
    64â†’#### æµ·å¤–ç”¨æˆ· - USD ä¿¡ç”¨å¡è®¢é˜… (Recurring)
    65â†’
    66â†’| å‘¨æœŸ | ä»·æ ¼ (USD) | æœˆå‡æˆæœ¬ | èŠ‚çœå¹…åº¦ | Stripe Mode |
    67â†’|-----|-----------|---------|---------|------------|
    68â†’| æœˆä»˜ | **$9.90** | $9.90 | åŸºå‡†ä»· | `subscription` |
    69â†’| å­£ä»˜ | **$24.90** | $8.30 | çœ 16% | `subscription` |
    70â†’| å¹´ä»˜ | **$69.90** | $5.83 | çœ 41% | `subscription` |
    71â†’
    72â†’#### å¤§é™†/é¦™æ¸¯ç”¨æˆ· - HKD é¢„ä»˜æ—¶é•¿ (One-time)
    73â†’
    74â†’| å‘¨æœŸ | ä»·æ ¼ (HKD) | çº¦åˆäººæ°‘å¸ | èŠ‚çœå¹…åº¦ | Stripe Mode |
    75â†’|-----|-----------|-----------|---------|------------|
    76â†’| 1ä¸ªæœˆ | **HK$39** | â‰ˆ Â¥36 | åŸºå‡†ä»· | `payment` |
    77â†’| 3ä¸ªæœˆ | **HK$99** | â‰ˆ Â¥92 | çœ 15% | `payment` |
    78â†’| 12ä¸ªæœˆ | **HK$298** | â‰ˆ Â¥275 | çœ 36% | `payment` |
    79â†’
    80â†’> ğŸ’¡ **æ±‡ç‡è¯´æ˜**ï¼šå¤§é™†ç”¨æˆ·æ”¯ä»˜ HKD æ—¶ï¼Œæ”¯ä»˜å®/å¾®ä¿¡ä¼šè‡ªåŠ¨æ˜¾ç¤ºäººæ°‘å¸é‡‘é¢ï¼ˆåŸºäºå®æ—¶æ±‡ç‡ï¼‰ã€‚å‰ç«¯éœ€æ³¨æ˜ã€Œä»¥æ¸¯å¸ç»“ç®—ï¼Œæ”¯ä»˜å®è‡ªåŠ¨æ¢æ±‡ã€ã€‚
    81â†’
    82â†’---
    83â†’
    84â†’## 3. Stripe åå°é…ç½®æŒ‡å—
    85â†’
    86â†’### 3.1 æ¿€æ´»æ”¯ä»˜æ–¹å¼
    87â†’
    88â†’è¿›å…¥ `Settings` â†’ `Payment methods`ï¼Œç¡®ä¿æ¿€æ´»ï¼š
    89â†’
    90â†’- [x] **Cards** (Visa, Mastercard, Amex) - é»˜è®¤å¼€å¯
    91â†’- [x] **Alipay (æ”¯ä»˜å®)** - âš ï¸ éœ€æ‰‹åŠ¨æ¿€æ´»
    92â†’- [x] **WeChat Pay (å¾®ä¿¡æ”¯ä»˜)** - éœ€ç”³è¯·æ¿€æ´»ï¼ˆå®¡æ ¸å‘¨æœŸçº¦ 1-2 å‘¨ï¼‰
    93â†’- [x] **Link** - æ¨èå¼€å¯ï¼Œæå‡æµ·å¤–è½¬åŒ–ç‡
    94â†’
    95â†’### 3.2 åˆ›å»ºäº§å“ä¸ä»·æ ¼ (Product & Prices)
    96â†’
    97â†’è¿›å…¥ `Product catalog` â†’ `Add product`
    98â†’
    99â†’#### äº§å“ç»“æ„è®¾è®¡
   100â†’
   101â†’```
   102â†’Vibelife Premium (äº§å“)
   103â†’â”œâ”€â”€ è®¢é˜…ç±» Prices (Recurring) - æµ·å¤–ç”¨æˆ·
   104â†’â”‚   â”œâ”€â”€ price_sub_monthly_usd    ($9.90/æœˆ)
   105â†’â”‚   â”œâ”€â”€ price_sub_quarterly_usd  ($24.90/3æœˆ)
   106â†’â”‚   â””â”€â”€ price_sub_yearly_usd     ($69.90/å¹´)
   107â†’â”‚
   108â†’â””â”€â”€ ä¸€æ¬¡æ€§ Prices (One-time) - å¤§é™†/é¦™æ¸¯ç”¨æˆ·
   109â†’    â”œâ”€â”€ price_prepaid_1m_hkd     (HK$39)
   110â†’    â”œâ”€â”€ price_prepaid_3m_hkd     (HK$99)
   111â†’    â””â”€â”€ price_prepaid_12m_hkd    (HK$298)
   112â†’```
   113â†’
   114â†’#### åˆ›å»ºæ­¥éª¤
   115â†’
   116â†’**A. è®¢é˜…ç±» (Recurring) - æµ·å¤–ç”¨æˆ·ï¼š**
   117â†’
   118â†’1. Add product â†’ Name: `Vibelife Premium`
   119â†’2. Add price:
   120â†’   - Pricing model: `Standard pricing`
   121â†’   - Amount: `9.90` â†’ Currency: `USD`
   122â†’   - Billing period: `Monthly` â†’ âœ… **Recurring**
   123â†’3. é‡å¤åˆ›å»ºå­£ä»˜ã€å¹´ä»˜ä»·æ ¼
   124â†’
   125â†’**B. ä¸€æ¬¡æ€§ (One-time) - å¤§é™†/é¦™æ¸¯ç”¨æˆ·ï¼š**
   126â†’
   127â†’1. åœ¨åŒä¸€äº§å“ä¸‹ Add price
   128â†’2. Amount: `39` â†’ Currency: `HKD`
   129â†’3. âš ï¸ é€‰æ‹© **One time** (é Recurring)
   130â†’4. é‡å¤åˆ›å»º 3ä¸ªæœˆã€12ä¸ªæœˆä»·æ ¼
   131â†’
   132â†’> âš ï¸ **é‡è¦**ï¼šRecurring ç±»å‹çš„ Price æ— æ³•ä½¿ç”¨æ”¯ä»˜å®/å¾®ä¿¡æ”¯ä»˜ã€‚One-time ç±»å‹å¯ä»¥ä½¿ç”¨æ‰€æœ‰æ”¯ä»˜æ–¹å¼ã€‚
   133â†’
   134â†’### 3.3 è®°å½• Price ID
   135â†’
   136â†’é…ç½®å®Œæˆåï¼Œè®°å½•ä»¥ä¸‹ 6 ä¸ªæ ¸å¿ƒ Price IDï¼š
   137â†’
   138â†’```javascript
   139â†’const PRICE_IDS = {
   140â†’  // æµ·å¤–è®¢é˜… (Recurring)
   141â†’  SUB_MONTHLY_USD: 'price_1Ox...xxx',
   142â†’  SUB_QUARTERLY_USD: 'price_1Oy...xxx',
   143â†’  SUB_YEARLY_USD: 'price_1Oz...xxx',
   144â†’  
   145â†’  // å¤§é™†é¢„ä»˜ (One-time)
   146â†’  PREPAID_1M_HKD: 'price_1Pa...xxx',
   147â†’  PREPAID_3M_HKD: 'price_1Pb...xxx',
   148â†’  PREPAID_12M_HKD: 'price_1Pc...xxx',
   149â†’};
   150â†’```
   151â†’
   152â†’---
   153â†’
   154â†’## 4. ç¼–ç¨‹é›†æˆé€»è¾‘
   155â†’
   156â†’### 4.1 å‰ç«¯ï¼šæ™ºèƒ½è·¯ç”±ä¸ä»·æ ¼å±•ç¤º
   157â†’
   158â†’#### åœ°åŒºæ£€æµ‹é€»è¾‘
   159â†’
   160â†’```javascript
   161â†’// IP åœ°åŒºåˆ¤æ–­
   162â†’async function detectUserRegion() {
   163â†’  const response = await fetch('https://api.ip.sb/geoip');
   164â†’  const { country_code } = await response.json();
   165â†’  
   166â†’  // CN/HK ç”¨æˆ·èµ°é¢„ä»˜æ¨¡å¼ï¼Œå…¶ä»–èµ°è®¢é˜…æ¨¡å¼
   167â†’  return ['CN', 'HK'].includes(country_code) ? 'CN' : 'GLOBAL';
   168â†’}
   169â†’```
   170â†’
   171â†’#### UI æ¸²æŸ“å·®å¼‚
   172â†’
   173â†’| å…ƒç´  | CN æ¨¡å¼ | Global æ¨¡å¼ |
   174â†’|-----|--------|------------|
   175â†’| ä»·æ ¼æ˜¾ç¤º | HK$39 / HK$99 / HK$298 | $9.90/mo / $24.90/3mo / $69.90/yr |
   176â†’| æ”¯ä»˜å›¾æ ‡ | æ”¯ä»˜å®ã€å¾®ä¿¡ã€Visa | Visaã€MasterCardã€Apple Pay |
   177â†’| æŒ‰é’®æ–‡æ¡ˆ | ã€Œç«‹å³è´­ä¹°ã€ | ã€ŒSubscribe Nowã€ |
   178â†’| è¯´æ˜æ–‡å­— | ä¸€æ¬¡æ€§è´­ä¹°ï¼Œæ”¯æŒæ”¯ä»˜å® | è‡ªåŠ¨ç»­è´¹ï¼Œå¯éšæ—¶å–æ¶ˆ |
   179â†’| ç»­è´¹æç¤º | æ˜¾ç¤ºåˆ°æœŸæ—¶é—´ | æ˜¾ç¤ºä¸‹æ¬¡æ‰£æ¬¾æ—¥æœŸ |
   180â†’
   181â†’### 4.2 åç«¯ï¼šåˆ›å»º Checkout Session
   182â†’
   183â†’#### Price ID æ˜ å°„é…ç½®
   184â†’
   185â†’```python
   186â†’PRICE_MAP = {
   187â†’    'CN': {
   188â†’        '1m': 'price_prepaid_1m_hkd_xxx',
   189â†’        '3m': 'price_prepaid_3m_hkd_xxx',
   190â†’        '12m': 'price_prepaid_12m_hkd_xxx',
   191â†’    },
   192â†’    'GLOBAL': {
   193â†’        'monthly': 'price_sub_monthly_usd_xxx',
   194â†’        'quarterly': 'price_sub_quarterly_usd_xxx',
   195â†’        'yearly': 'price_sub_yearly_usd_xxx',
   196â†’    }
   197â†’}
   198â†’
   199â†’# é¢„ä»˜æ—¶é•¿æ˜ å°„ (å¤©æ•°)
   200â†’SERVICE_DAYS = {
   201â†’    '1m': 30,
   202â†’    '3m': 90,
   203â†’    '12m': 365,
   204â†’}
   205â†’```
   206â†’
   207â†’#### åˆ›å»º Session - Python å®Œæ•´ç¤ºä¾‹
   208â†’
   209â†’```python
   210â†’import stripe
   211â†’from datetime import datetime, timedelta
   212â†’
   213â†’stripe.api_key = 'sk_live_xxx'
   214â†’
   215â†’def create_checkout_session(user_id: str, plan: str, region: str, user_email: str):
   216â†’    """
   217â†’    åˆ›å»º Stripe Checkout Session
   218â†’    
   219â†’    Args:
   220â†’        user_id: ç”¨æˆ·ID
   221â†’        plan: å¥—é¤ç±»å‹ ('1m', '3m', '12m' for CN; 'monthly', 'quarterly', 'yearly' for GLOBAL)
   222â†’        region: åœ°åŒº ('CN' or 'GLOBAL')
   223â†’        user_email: ç”¨æˆ·é‚®ç®±
   224â†’    """
   225â†’    price_id = PRICE_MAP[region][plan]
   226â†’    
   227â†’    # ğŸ”‘ å…³é”®åŒºåˆ«ï¼šCN ç”¨ payment æ¨¡å¼ï¼ŒGlobal ç”¨ subscription æ¨¡å¼
   228â†’    mode = 'payment' if region == 'CN' else 'subscription'
   229â†’    
   230â†’    # æ„å»º metadata
   231â†’    metadata = {
   232â†’        'user_id': user_id,
   233â†’        'plan_type': plan,
   234â†’        'region': region,
   235â†’    }
   236â†’    
   237â†’    # é¢„ä»˜æ¨¡å¼éœ€è¦è®°å½•æœåŠ¡æ—¶é•¿
   238â†’    if region == 'CN':
   239â†’        metadata['service_days'] = str(SERVICE_DAYS.get(plan, 30))
   240â†’    
   241â†’    session = stripe.checkout.Session.create(
   242â†’        customer_email=user_email,
   243â†’        line_items=[{
   244â†’            'price': price_id,
   245â†’            'quantity': 1,
   246â†’        }],
   247â†’        mode=mode,
   248â†’        
   249â†’        # è‡ªåŠ¨åŒ¹é…æ”¯ä»˜æ–¹å¼
   250â†’        automatic_payment_methods={'enabled': True},
   251â†’        
   252â†’        # å›è°ƒ URL
   253â†’        success_url='https://vibelife.com/success?session_id={CHECKOUT_SESSION_ID}',
   254â†’        cancel_url='https://vibelife.com/pricing',
   255â†’        
   256â†’        metadata=metadata,
   257â†’        
   258â†’        # è®¢é˜…æ¨¡å¼é¢å¤–é…ç½®
   259â†’        **(
   260â†’            {'subscription_data': {'metadata': metadata}}
   261â†’            if mode == 'subscription' else {}
   262â†’        ),
   263â†’    )
   264â†’    
   265â†’    return session.url
   266â†’```
   267â†’
   268â†’#### Node.js ç‰ˆæœ¬
   269â†’
   270â†’```javascript
   271â†’const stripe = require('stripe')('sk_live_xxx');
   272â†’
   273â†’async function createCheckoutSession({ userId, plan, region, userEmail }) {
   274â†’  const priceId = PRICE_MAP[region][plan];
   275â†’  const mode = region === 'CN' ? 'payment' : 'subscription';
   276â†’  
   277â†’  const metadata = {
   278â†’    user_id: userId,
   279â†’    plan_type: plan,
   280â†’    region: region,
   281â†’  };
   282â†’  
   283â†’  if (region === 'CN') {
   284â†’    metadata.service_days = String(SERVICE_DAYS[plan] || 30);
   285â†’  }
   286â†’  
   287â†’  const session = await stripe.checkout.sessions.create({
   288â†’    customer_email: userEmail,
   289â†’    line_items: [{ price: priceId, quantity: 1 }],
   290â†’    mode: mode,
   291â†’    automatic_payment_methods: { enabled: true },
   292â†’    success_url: 'https://vibelife.com/success?session_id={CHECKOUT_SESSION_ID}',
   293â†’    cancel_url: 'https://vibelife.com/pricing',
   294â†’    metadata: metadata,
   295â†’    ...(mode === 'subscription' && {
   296â†’      subscription_data: { metadata: metadata }
   297â†’    }),
   298â†’  });
   299â†’  
   300â†’  return session.url;
   301â†’}
   302â†’```
   303â†’
   304â†’---
   305â†’
   306â†’## 5. Webhook å¤„ç†ä¸æƒç›Šå‘æ”¾
   307â†’
   308â†’### 5.1 éœ€è¦ç›‘å¬çš„äº‹ä»¶
   309â†’
   310â†’| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | å¤„ç†é€»è¾‘ |
   311â†’|---------|---------|---------|
   312â†’| `checkout.session.completed` | æ”¯ä»˜æˆåŠŸ | å¼€é€šä¼šå‘˜æƒç›Š |
   313â†’| `customer.subscription.updated` | è®¢é˜…å˜æ›´ | æ›´æ–°è®¢é˜…çŠ¶æ€ |
   314â†’| `customer.subscription.deleted` | è®¢é˜…å–æ¶ˆ | åˆ°æœŸåå…³é—­æƒç›Š |
   315â†’| `invoice.payment_failed` | ç»­è´¹å¤±è´¥ | å‘é€æé†’/æš‚åœæƒç›Š |
   316â†’| `invoice.paid` | ç»­è´¹æˆåŠŸ | å»¶é•¿åˆ°æœŸæ—¶é—´ |
   317â†’
   318â†’### 5.2 Webhook å¤„ç† - Python ç¤ºä¾‹
   319â†’
   320â†’```python
   321â†’import stripe
   322â†’from flask import Flask, request, jsonify
   323â†’from datetime import datetime, timedelta
   324â†’
   325â†’app = Flask(__name__)
   326â†’endpoint_secret = 'whsec_xxx'
   327â†’
   328â†’@app.route('/webhook/stripe', methods=['POST'])
   329â†’def stripe_webhook():
   330â†’    payload = request.get_data(as_text=True)
   331â†’    sig_header = request.headers.get('Stripe-Signature')
   332â†’    
   333â†’    try:
   334â†’        event = stripe.Webhook.construct_event(payload, sig_header, endpoint_secret)
   335â†’    except ValueError:
   336â†’        return 'Invalid payload', 400
   337â†’    except stripe.error.SignatureVerificationError:
   338â†’        return 'Invalid signature', 400
   339â†’    
   340â†’    # è·¯ç”±åˆ°å…·ä½“å¤„ç†å‡½æ•°
   341â†’    handlers = {
   342â†’        'checkout.session.completed': handle_checkout_completed,
   343â†’        'customer.subscription.updated': handle_subscription_updated,
   344â†’        'customer.subscription.deleted': handle_subscription_deleted,
   345â†’        'invoice.payment_failed': handle_payment_failed,
   346â†’    }
   347â†’    
   348â†’    handler = handlers.get(event['type'])
   349â†’    if handler:
   350â†’        handler(event['data']['object'])
   351â†’    
   352â†’    return jsonify({'status': 'success'})
   353â†’
   354â†’
   355â†’def handle_checkout_completed(session):
   356â†’    """å¤„ç†æ”¯ä»˜æˆåŠŸ"""
   357â†’    metadata = session.get('metadata', {})
   358â†’    user_id = metadata.get('user_id')
   359â†’    region = metadata.get('region')
   360â†’    plan = metadata.get('plan_type')
   361â†’    
   362â†’    if not user_id:
   363â†’        return
   364â†’    
   365â†’    if region == 'CN':
   366â†’        # é¢„ä»˜æ¨¡å¼ï¼šè®¡ç®—åˆ°æœŸæ—¶é—´
   367â†’        service_days = int(metadata.get('service_days', 30))
   368â†’        expire_at = datetime.now() + timedelta(days=service_days)
   369â†’        
   370â†’        User.objects.filter(id=user_id).update(
   371â†’            vip_status='active',
   372â†’            vip_type='prepaid',
   373â†’            expire_at=expire_at,
   374â†’            stripe_payment_id=session['id'],
   375â†’        )
   376â†’    else:
   377â†’        # è®¢é˜…æ¨¡å¼ï¼šå…³è” Stripe Subscription
   378â†’        subscription_id = session.get('subscription')
   379â†’        
   380â†’        User.objects.filter(id=user_id).update(
   381â†’            vip_status='active',
   382â†’            vip_type='subscription',
   383â†’            stripe_subscription_id=subscription_id,
   384â†’            stripe_customer_id=session.get('customer'),
   385â†’        )
   386â†’
   387â†’
   388â†’def handle_subscription_updated(subscription):
   389â†’    """å¤„ç†è®¢é˜…å˜æ›´ï¼ˆå‡çº§/é™çº§ï¼‰"""
   390â†’    user = User.objects.filter(
   391â†’        stripe_subscription_id=subscription['id']
   392â†’    ).first()
   393â†’    
   394â†’    if user:
   395â†’        # æ›´æ–°å¥—é¤ä¿¡æ¯
   396â†’        user.current_plan = subscription['items']['data'][0]['price']['id']
   397â†’        user.save()
   398â†’
   399â†’
   400â†’def handle_subscription_deleted(subscription):
   401â†’    """å¤„ç†è®¢é˜…å–æ¶ˆ"""
   402â†’    User.objects.filter(
   403â†’        stripe_subscription_id=subscription['id']
   404â†’    ).update(
   405â†’        vip_status='cancelled',
   406â†’        expire_at=datetime.fromtimestamp(subscription['current_period_end']),
   407â†’    )
   408â†’
   409â†’
   410â†’def handle_payment_failed(invoice):
   411â†’    """å¤„ç†ç»­è´¹å¤±è´¥"""
   412â†’    subscription_id = invoice.get('subscription')
   413â†’    user = User.objects.filter(stripe_subscription_id=subscription_id).first()
   414â†’    
   415â†’    if user:
   416â†’        # å‘é€ç»­è´¹å¤±è´¥é€šçŸ¥
   417â†’        send_payment_failed_notification(user)
   418â†’        
   419â†’        # å¦‚æœè¿ç»­å¤±è´¥å¤šæ¬¡ï¼Œæš‚åœæƒç›Š
   420â†’        user.payment_failed_count += 1
   421â†’        if user.payment_failed_count >= 3:
   422â†’            user.vip_status = 'suspended'
   423â†’        user.save()
   424â†’```
   425â†’
   426â†’---
   427â†’
   428â†’## 6. è®¢é˜…ç®¡ç† - Customer Portal
   429â†’
   430â†’Stripe æä¾›å†…ç½®çš„ Customer Portalï¼Œè®©**è®¢é˜…ç”¨æˆ·**è‡ªåŠ©ç®¡ç†è´¦å•ã€‚
   431â†’
   432â†’### 6.1 Portal åŠŸèƒ½
   433â†’
   434â†’- âœ… æ›´æ–°æ”¯ä»˜æ–¹å¼ï¼ˆä¿¡ç”¨å¡ï¼‰
   435â†’- âœ… æŸ¥çœ‹è´¦å•å†å²
   436â†’- âœ… å‡çº§/é™çº§è®¢é˜…è®¡åˆ’
   437â†’- âœ… å–æ¶ˆè®¢é˜…
   438â†’- âœ… ä¸‹è½½å‘ç¥¨ PDF
   439â†’
   440â†’### 6.2 åç«¯åˆ›å»º Portal Session
   441â†’
   442â†’```python
   443â†’def create_portal_session(user):
   444â†’    """
   445â†’    åˆ›å»º Customer Portal Session
   446â†’    ä»…å¯¹è®¢é˜…ç”¨æˆ·æœ‰æ•ˆï¼ˆé¢„ä»˜ç”¨æˆ·æ— éœ€æ­¤åŠŸèƒ½ï¼‰
   447â†’    """
   448â†’    if user.vip_type != 'subscription' or not user.stripe_customer_id:
   449â†’        return None
   450â†’    
   451â†’    session = stripe.billing_portal.Session.create(
   452â†’        customer=user.stripe_customer_id,
   453â†’        return_url='https://vibelife.com/account',
   454â†’    )
   455â†’    
   456â†’    return session.url
   457â†’```
   458â†’
   459â†’### 6.3 å‰ç«¯é›†æˆ
   460â†’
   461â†’```javascript
   462â†’// è´¦æˆ·é¡µé¢
   463â†’async function openBillingPortal() {
   464â†’  const response = await fetch('/api/billing/portal', {
   465â†’    method: 'POST',
   466â†’    headers: { 'Authorization': `Bearer ${token}` },
   467â†’  });
   468â†’  
   469â†’  const { url } = await response.json();
   470â†’  
   471â†’  if (url) {
   472â†’    window.location.href = url;
   473â†’  } else {
   474â†’    // é¢„ä»˜ç”¨æˆ·æ˜¾ç¤ºä¸åŒçš„ç®¡ç†ç•Œé¢
   475â†’    showPrepaidManagement();
   476â†’  }
   477â†’}
   478â†’```
   479â†’
   480â†’### 6.4 Dashboard é…ç½®
   481â†’
   482â†’è¿›å…¥ `Settings` â†’ `Billing` â†’ `Customer portal`ï¼š
   483â†’
   484â†’1. âœ… å…è®¸æ›´æ–°æ”¯ä»˜æ–¹å¼
   485â†’2. âœ… æ˜¾ç¤ºè´¦å•å†å²
   486â†’3. âœ… é…ç½®å¯åˆ‡æ¢çš„äº§å“ç›®å½•ï¼ˆæœ€å¤š10ä¸ªï¼‰
   487â†’4. âœ… è®¾ç½®å–æ¶ˆè®¢é˜…æ—¶çš„æŒ½ç•™ä¼˜æƒ åˆ¸
   488â†’
   489â†’---
   490â†’
   491â†’## 7. å¤§é™†ç”¨æˆ·ç»­è´¹ç­–ç•¥
   492â†’
   493â†’ç”±äºé¢„ä»˜æ¨¡å¼æ— æ³•è‡ªåŠ¨ç»­è´¹ï¼Œéœ€è¦è®¾è®¡å®Œå–„çš„åˆ°æœŸæé†’å’Œç»­è´¹å¼•å¯¼æµç¨‹ã€‚
   494â†’
   495â†’### 7.1 åˆ°æœŸæé†’æ—¶é—´çº¿
   496â†’
   497â†’| æ—¶é—´èŠ‚ç‚¹ | è§¦å‘åŠ¨ä½œ | æ¸ é“ |
   498â†’|---------|---------|-----|
   499â†’| åˆ°æœŸå‰ 7 å¤© | å‘é€ç»­è´¹æé†’ | App æ¨é€ + é‚®ä»¶ |
   500â†’| åˆ°æœŸå‰ 3 å¤© | å‘é€ç´§æ€¥æé†’ + ä¼˜æƒ  | App æ¨é€ + å¾®ä¿¡æœåŠ¡å· |
   501â†’| åˆ°æœŸå‰ 1 å¤© | æœ€åæé†’ | App å¼¹çª— |
   502â†’| åˆ°æœŸå½“å¤© | æƒç›Šæš‚åœï¼Œä¿ç•™æ•°æ® 30 å¤© | çŠ¶æ€å˜æ›´ |
   503â†’| åˆ°æœŸå 30 å¤© | æ•°æ®å½’æ¡£æé†’ | é‚®ä»¶ |
   504â†’
   505â†’### 7.2 ç»­è´¹æ¿€åŠ±è®¾è®¡
   506â†’
   507â†’| åœºæ™¯ | æ¿€åŠ±æªæ–½ |
   508â†’|-----|---------|
   509â†’| åˆ°æœŸå‰ç»­è´¹å¹´ä»˜ | é¢å¤–èµ é€ 1 ä¸ªæœˆ |
   510â†’| è¿ç»­ç»­è´¹ 2 å¹´ä»¥ä¸Š | äº«å— 9 æŠ˜æ°¸ä¹…ä¼˜æƒ  |
   511â†’| æ¨èå¥½å‹è´­ä¹° | åŒæ–¹å„å¾— 1 ä¸ªæœˆä¼šå‘˜ |
   512â†’| æµå¤±ç”¨æˆ·å¬å› | é¦–æœˆ 5 æŠ˜ä¼˜æƒ  |
   513â†’
   514â†’### 7.3 ç»­è´¹æé†’å®ç°
   515â†’
   516â†’```python
   517â†’from celery import shared_task
   518â†’from datetime import datetime, timedelta
   519â†’
   520â†’@shared_task
   521â†’def check_expiring_users():
   522â†’    """æ¯æ—¥å®šæ—¶ä»»åŠ¡ï¼šæ£€æŸ¥å³å°†åˆ°æœŸçš„é¢„ä»˜ç”¨æˆ·"""
   523â†’    
   524â†’    now = datetime.now()
   525â†’    
   526â†’    # 7å¤©å†…åˆ°æœŸçš„ç”¨æˆ·
   527â†’    users_7d = User.objects.filter(
   528â†’        vip_type='prepaid',
   529â†’        vip_status='active',
   530â†’        expire_at__lte=now + timedelta(days=7),
   531â†’        expire_at__gt=now + timedelta(days=3),
   532â†’    )
   533â†’    
   534â†’    for user in users_7d:
   535â†’        send_renewal_reminder(user, days_left=7)
   536â†’    
   537â†’    # 3å¤©å†…åˆ°æœŸçš„ç”¨æˆ·ï¼ˆé™„å¸¦ä¼˜æƒ ï¼‰
   538â†’    users_3d = User.objects.filter(
   539â†’        vip_type='prepaid',
   540â†’        vip_status='active',
   541â†’        expire_at__lte=now + timedelta(days=3),
   542â†’        expire_at__gt=now + timedelta(days=1),
   543â†’    )
   544â†’    
   545â†’    for user in users_3d:
   546â†’        send_renewal_reminder(user, days_left=3, include_discount=True)
   547â†’    
   548â†’    # å·²åˆ°æœŸçš„ç”¨æˆ·
   549â†’    expired_users = User.objects.filter(
   550â†’        vip_type='prepaid',
   551â†’        vip_status='active',
   552â†’        expire_at__lte=now,
   553â†’    )
   554â†’    
   555â†’    for user in expired_users:
   556â†’        user.vip_status = 'expired'
   557â†’        user.save()
   558â†’        send_expiration_notice(user)
   559â†’```
   560â†’
   561â†’---
   562â†’
   563â†’## 8. æµ‹è¯•æŒ‡å—
   564â†’
   565â†’### 8.1 æµ‹è¯•æ¨¡å¼
   566â†’
   567â†’ä½¿ç”¨ Stripe Test Mode éªŒè¯æ‰€æœ‰æµç¨‹ï¼š
   568â†’
   569â†’- Dashboard å·¦ä¸‹è§’åˆ‡æ¢ Test/Live æ¨¡å¼
   570â†’- æµ‹è¯•ç¯å¢ƒçš„ API Key ä»¥ `sk_test_` å¼€å¤´
   571â†’- æ‰€æœ‰æµ‹è¯•äº¤æ˜“ä¸ä¼šäº§ç”ŸçœŸå®è´¹ç”¨
   572â†’
   573â†’### 8.2 æµ‹è¯•å¡å·
   574â†’
   575â†’| å¡å· | åœºæ™¯ |
   576â†’|-----|-----|
   577â†’| `4242 4242 4242 4242` | æˆåŠŸæ”¯ä»˜ |
   578â†’| `4000 0000 0000 9995` | æ”¯ä»˜å¤±è´¥ï¼ˆä½™é¢ä¸è¶³ï¼‰ |
   579â†’| `4000 0025 0000 3155` | éœ€è¦ 3D Secure éªŒè¯ |
   580â†’| `4000 0000 0000 0341` | é™„åŠ å¡æ—¶å¤±è´¥ |
   581â†’
   582â†’### 8.3 æµ‹è¯•æ”¯ä»˜å®/å¾®ä¿¡
   583â†’
   584â†’- Stripe æµ‹è¯•æ¨¡å¼æä¾›æ¨¡æ‹Ÿè·³è½¬é¡µé¢
   585â†’- ç‚¹å‡» `Authorize test payment` æ¨¡æ‹Ÿæ”¯ä»˜æˆåŠŸ
   586â†’- ç‚¹å‡» `Fail test payment` æ¨¡æ‹Ÿæ”¯ä»˜å¤±è´¥
   587â†’
   588â†’### 8.4 æµ‹è¯• Webhook
   589â†’
   590â†’```bash
   591â†’# ä½¿ç”¨ Stripe CLI è½¬å‘ webhook åˆ°æœ¬åœ°
   592â†’stripe listen --forward-to localhost:8000/webhook/stripe
   593â†’
   594â†’# è§¦å‘æµ‹è¯•äº‹ä»¶
   595â†’stripe trigger checkout.session.completed
   596â†’stripe trigger customer.subscription.deleted
   597â†’```
   598â†’
   599â†’---
   600â†’
   601â†’## 9. ä¸Šçº¿æ£€æŸ¥æ¸…å•
   602â†’
   603â†’### 9.1 Stripe é…ç½®
   604â†’
   605â†’- [ ] åˆ‡æ¢åˆ° Live æ¨¡å¼
   606â†’- [ ] æ›´æ–° API Keys (sk_live_xxx)
   607â†’- [ ] æ›´æ–° Webhook Secret (whsec_xxx)
   608â†’- [ ] ç¡®è®¤æ‰€æœ‰ Price ID ä½¿ç”¨ Live ç‰ˆæœ¬
   609â†’- [ ] æ¿€æ´» Alipay / WeChat Pay
   610â†’- [ ] é…ç½® Customer Portal
   611â†’
   612â†’### 9.2 ä»£ç é…ç½®
   613â†’
   614â†’- [ ] ç¯å¢ƒå˜é‡å·²æ›´æ–°ä¸ºç”Ÿäº§é…ç½®
   615â†’- [ ] Webhook URL å·²æ›´æ–°ä¸ºç”Ÿäº§åŸŸå
   616â†’- [ ] Success/Cancel URL å·²æ›´æ–°
   617â†’- [ ] é”™è¯¯å¤„ç†å’Œæ—¥å¿—å®Œå–„
   618â†’
   619â†’### 9.3 ä¸šåŠ¡æµç¨‹
   620â†’
   621â†’- [ ] æ”¯ä»˜æˆåŠŸé‚®ä»¶æ¨¡æ¿å‡†å¤‡
   622â†’- [ ] ç»­è´¹æé†’é‚®ä»¶æ¨¡æ¿å‡†å¤‡
   623â†’- [ ] å®¢æœè¯æœ¯å‡†å¤‡ï¼ˆé€€æ¬¾ã€äº‰è®®å¤„ç†ï¼‰
   624â†’- [ ] è´¢åŠ¡å¯¹è´¦æµç¨‹ç¡®è®¤
   625â†’
   626â†’---
   627â†’
   628â†’## 10. å¸¸è§é—®é¢˜ FAQ
   629â†’
   630â†’### Q1: ä¸ºä»€ä¹ˆå¤§é™†ç”¨æˆ·ä¸èƒ½ç”¨ä¿¡ç”¨å¡è®¢é˜…ï¼Ÿ
   631â†’
   632â†’A: å¯ä»¥ï¼Œä½†éœ€è¦æ³¨æ„ï¼š
   633â†’1. å¤§é™†å‘è¡Œçš„ Visa/MasterCard å±äºã€Œå›½é™…å¡ã€ï¼Œä¼šé¢å¤–æ”¶å– 0.5% è´¹ç”¨
   634â†’2. éƒ¨åˆ†å¤§é™†é“¶è¡Œå¡å¯èƒ½å› è·¨å¢ƒé™åˆ¶å¯¼è‡´æ‰£æ¬¾å¤±è´¥
   635â†’3. æ”¯ä»˜å®/å¾®ä¿¡æ›´ç¬¦åˆå›½å†…ç”¨æˆ·ä¹ æƒ¯ï¼Œè½¬åŒ–ç‡æ›´é«˜
   636â†’
   637â†’### Q2: é¢„ä»˜ç”¨æˆ·å¦‚ä½•å¤„ç†é€€æ¬¾ï¼Ÿ
   638â†’
   639â†’A: 
   640â†’1. æ”¯ä»˜å®é€€æ¬¾æœŸé™ä¸º 90 å¤©ï¼Œå¾®ä¿¡ä¸º 180 å¤©
   641â†’2. é€€æ¬¾éœ€æŒ‰å‰©ä½™å¤©æ•°æ¯”ä¾‹è®¡ç®—
   642â†’3. å»ºè®®é€šè¿‡ Stripe Dashboard æ‰‹åŠ¨å¤„ç†é€€æ¬¾
   643â†’
   644â†’### Q3: ç”¨æˆ·åˆ‡æ¢åœ°åŒºæ€ä¹ˆåŠï¼Ÿ
   645â†’
   646â†’A: 
   647â†’1. é¢„ä»˜ç”¨æˆ·å¯ä»¥ç»§ç»­ä½¿ç”¨ç›´åˆ°åˆ°æœŸ
   648â†’2. è®¢é˜…ç”¨æˆ·å¯ä»¥å–æ¶ˆåé‡æ–°è´­ä¹°
   649â†’3. å»ºè®®æä¾›ã€Œå¥—é¤è¿ç§»ã€åŠŸèƒ½ï¼ŒæŠ˜ç®—å‰©ä½™ä»·å€¼
   650â†’
   651â†’### Q4: å¦‚ä½•å¤„ç†æ±‡ç‡æ³¢åŠ¨ï¼Ÿ
   652â†’
   653â†’A: 
   654â†’1. HKD ä»·æ ¼å›ºå®šï¼Œæ±‡ç‡é£é™©ç”±ç”¨æˆ·æ‰¿æ‹…
   655â†’2. å‰ç«¯æ˜¾ç¤ºã€Œä»¥æ¸¯å¸ç»“ç®—ï¼Œæ”¯ä»˜å®è‡ªåŠ¨æ¢æ±‡ã€
   656â†’3. å¯è€ƒè™‘æ¯å­£åº¦æ ¹æ®æ±‡ç‡è°ƒæ•´ HKD å®šä»·
   657â†’
   658â†’---
   659â†’
   660â†’## é™„å½• A: æ•°æ®åº“ Schema å»ºè®®
   661â†’
   662â†’```sql
   663â†’-- ç”¨æˆ·è¡¨æ‰©å±•å­—æ®µ
   664â†’ALTER TABLE users ADD COLUMN vip_status VARCHAR(20) DEFAULT 'inactive';
   665â†’-- inactive | active | expired | cancelled | suspended
   666â†’
   667â†’ALTER TABLE users ADD COLUMN vip_type VARCHAR(20);
   668â†’-- prepaid | subscription
   669â†’
   670â†’ALTER TABLE users ADD COLUMN expire_at TIMESTAMP;
   671â†’ALTER TABLE users ADD COLUMN stripe_customer_id VARCHAR(100);
   672â†’ALTER TABLE users ADD COLUMN stripe_subscription_id VARCHAR(100);
   673â†’ALTER TABLE users ADD COLUMN current_plan VARCHAR(50);
   674â†’ALTER TABLE users ADD COLUMN payment_failed_count INT DEFAULT 0;
   675â†’
   676â†’-- æ”¯ä»˜è®°å½•è¡¨
   677â†’CREATE TABLE payment_records (
   678â†’    id SERIAL PRIMARY KEY,
   679â†’    user_id INT REFERENCES users(id),
   680â†’    stripe_session_id VARCHAR(100),
   681â†’    stripe_payment_intent_id VARCHAR(100),
   682â†’    amount DECIMAL(10,2),
   683â†’    currency VARCHAR(10),
   684â†’    plan_type VARCHAR(20),
   685â†’    region VARCHAR(10),
   686â†’    status VARCHAR(20),
   687â†’    created_at TIMESTAMP DEFAULT NOW()
   688â†’);
   689â†’```
   690â†’
   691â†’---
   692â†’
   693â†’## é™„å½• B: ç¯å¢ƒå˜é‡é…ç½®
   694â†’
   695â†’```bash
   696â†’# .env.production
   697â†’
   698â†’# Stripe Live Keys
   699â†’STRIPE_SECRET_KEY=sk_live_xxx
   700â†’STRIPE_PUBLISHABLE_KEY=pk_live_xxx
   701â†’STRIPE_WEBHOOK_SECRET=whsec_xxx
   702â†’
   703â†’# Price IDs (Live)
   704â†’PRICE_SUB_MONTHLY_USD=price_xxx
   705â†’PRICE_SUB_QUARTERLY_USD=price_xxx
   706â†’PRICE_SUB_YEARLY_USD=price_xxx
   707â†’PRICE_PREPAID_1M_HKD=price_xxx
   708â†’PRICE_PREPAID_3M_HKD=price_xxx
   709â†’PRICE_PREPAID_12M_HKD=price_xxx
   710â†’
   711â†’# URLs
   712â†’SUCCESS_URL=https://vibelife.com/payment/success
   713â†’CANCEL_URL=https://vibelife.com/pricing
   714â†’PORTAL_RETURN_URL=https://vibelife.com/account
   715â†’```
   716â†’
   717â†’---
   718â†’
   719â†’## ç‰ˆæœ¬å†å²
   720â†’
   721â†’| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
   722â†’|-----|------|---------|
   723â†’| 1.0 | 2024-12 | åˆå§‹ç‰ˆæœ¬ |
   724â†’| 2.0 | 2025-01 | é‡å¤§æ›´æ–°ï¼šæ”¯ä»˜å®/å¾®ä¿¡æ”¹ä¸ºé¢„ä»˜æ¨¡å¼ï¼›æ›´æ–°è´¹ç‡ï¼›æ·»åŠ  Customer Portal é›†æˆ |
   725â†’
   726â†’---
   727â†’
   728â†’> ğŸ“§ å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯å›¢é˜Ÿ

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
