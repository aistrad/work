     1→"""
     2→VibeLife API - The Living Companion Backend
     3→"""
     4→import os
     5→import time
     6→import logging
     7→from pathlib import Path
     8→from contextlib import asynccontextmanager
     9→
    10→from fastapi import FastAPI, Request
    11→from fastapi.middleware.cors import CORSMiddleware
    12→
    13→from stores.db import init_db, close_db
    14→from workers import IngestionWorker
    15→
    16→# ─────────────────────────────────────────────────────────────────
    17→# Logging Configuration
    18→# ─────────────────────────────────────────────────────────────────
    19→
    20→# 确保日志目录存在 (支持环境变量配置，fallback 到 /tmp)
    21→log_dir = Path(os.environ.get("VIBELIFE_LOGS_ROOT", "/tmp/vibelife/logs"))
    22→log_dir.mkdir(parents=True, exist_ok=True)
    23→
    24→# 配置请求日志
    25→request_logger = logging.getLogger("vibelife.requests")
    26→request_logger.setLevel(logging.INFO)
    27→
    28→# 文件处理器
    29→file_handler = logging.FileHandler(log_dir / "api_requests.log")
    30→file_handler.setFormatter(logging.Formatter(
    31→    '%(asctime)s - %(message)s',
    32→    datefmt='%Y-%m-%d %H:%M:%S'
    33→))
    34→request_logger.addHandler(file_handler)
    35→
    36→# ─────────────────────────────────────────────────────────────────
    37→# Load environment (.env at repo root)
    38→# ─────────────────────────────────────────────────────────────────
    39→
    40→try:
    41→    from dotenv import load_dotenv
    42→except ImportError:  # pragma: no cover
    43→    load_dotenv = None
    44→
    45→if load_dotenv:
    46→    env_path = Path(__file__).resolve().parents[2] / ".env"
    47→    if env_path.exists():
    48→        load_dotenv(env_path, override=False)
    49→
    50→# ─────────────────────────────────────────────────────────────────
    51→# Lifespan (startup/shutdown)
    52→# ─────────────────────────────────────────────────────────────────
    53→
    54→@asynccontextmanager
    55→async def lifespan(app: FastAPI):
    56→    """Application lifespan handler"""
    57→    # Startup
    58→    print("Starting VibeLife API...")
    59→    await init_db()
    60→    print("Database connected")
    61→
    62→    # Initialize Tool Registry (v6.0)
    63→    from services.agent import ToolRegistry
    64→    # 导入全局处理器以触发 @tool_handler 装饰器注册
    65→    import services.agent.global_handlers  # noqa: F401
    66→    ToolRegistry.initialize()
    67→    print(f"ToolRegistry initialized: {len(ToolRegistry._handlers)} handlers")
    68→
    69→    # Start ingestion worker (if enabled)
    70→    ingestion_worker = None
    71→    if os.getenv("VIBELIFE_WORKER_ENABLED", "1") == "1":
    72→        ingestion_worker = IngestionWorker()
    73→        await ingestion_worker.start()
    74→        print("Ingestion worker started")
    75→
    76→    yield
    77→
    78→    # Shutdown
    79→    print("Shutting down VibeLife API...")
    80→
    81→    # Stop worker
    82→    if ingestion_worker:
    83→        await ingestion_worker.stop()
    84→        print("Ingestion worker stopped")
    85→
    86→    await close_db()
    87→    print("Database closed")
    88→
    89→
    90→# ─────────────────────────────────────────────────────────────────
    91→# App Creation
    92→# ─────────────────────────────────────────────────────────────────
    93→
    94→# 生产环境禁用文档
    95→app = FastAPI(
    96→    title="VibeLife API",
    97→    description="The Living Companion - AI-powered personal growth platform",
    98→    version="1.0.0",
    99→    lifespan=lifespan,
   100→    docs_url=None,

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
