     1→"""
     2→UsageService - Usage tracking for LLM calls, conversations, reports
     3→"""
     4→from datetime import date
     5→from typing import Optional
     6→from uuid import UUID
     7→import logging
     8→
     9→from stores.db import get_db_pool
    10→
    11→logger = logging.getLogger(__name__)
    12→
    13→
    14→class UsageService:
    15→    """Usage tracking service"""
    16→
    17→    @staticmethod
    18→    async def record_usage(
    19→        user_id: UUID,
    20→        usage_type: str,
    21→        metadata: Optional[dict] = None
    22→    ) -> None:
    23→        """Record a usage event (llm_call / conversation / report)"""
    24→        pool = await get_db_pool()
    25→
    26→        await pool.execute("""
    27→            INSERT INTO user_usage (user_id, usage_type, metadata)
    28→            VALUES ($1, $2, $3)
    29→        """, user_id, usage_type, metadata)
    30→
    31→    @staticmethod
    32→    async def get_daily_usage(user_id: UUID) -> dict:
    33→        """Get today's usage statistics"""
    34→        pool = await get_db_pool()
    35→
    36→        rows = await pool.fetch("""
    37→            SELECT usage_type, SUM(count) as total
    38→            FROM user_usage
    39→            WHERE user_id = $1 AND created_at >= CURRENT_DATE
    40→            GROUP BY usage_type
    41→        """, user_id)
    42→
    43→        return {row["usage_type"]: row["total"] for row in rows}
    44→
    45→    @staticmethod
    46→    async def get_monthly_usage(user_id: UUID) -> dict:
    47→        """Get this month's usage statistics"""
    48→        pool = await get_db_pool()
    49→
    50→        rows = await pool.fetch("""
    51→            SELECT usage_type, SUM(count) as total
    52→            FROM user_usage
    53→            WHERE user_id = $1 AND created_at >= DATE_TRUNC('month', CURRENT_DATE)
    54→            GROUP BY usage_type
    55→        """, user_id)
    56→
    57→        return {row["usage_type"]: row["total"] for row in rows}
    58→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
