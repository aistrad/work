  1018→def build_system_prompt(
  1019→    skill_id: str,
  1020→    scenario_id: Optional[str] = None,
  1021→    user_context: Optional[Dict] = None
  1022→) -> str:
  1023→    """构建完整的 System Prompt
  1024→
  1025→    v7 更新：支持 rules 架构，scenario_id 可以是 rule_id
  1026→    v8 更新：支持 persona 和 voice_mode 注入
  1027→    """
  1028→    parts = []
  1029→
  1030→    # 加载 Skill
  1031→    skill = load_skill(skill_id)
  1032→    if not skill:
  1033→        return ""
  1034→
  1035→    # V2: Persona 注入（在专家身份之前）
  1036→    persona_prompt = _build_persona_prompt(skill_id, user_context)
  1037→    if persona_prompt:
  1038→        parts.append(persona_prompt)
  1039→    else:
  1040→        # 默认专家身份
  1041→        parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
  1042→
  1043→    # V2: Voice Mode 注入
  1044→    if user_context:
  1045→        preferences = user_context.get("preferences", {})
  1046→        voice_mode = preferences.get("voice_mode", "warm")
  1047→        if voice_mode in VOICE_MODE_PROMPTS:
  1048→            parts.append(VOICE_MODE_PROMPTS[voice_mode])
  1049→
  1050→    # 加载场景或规则
  1051→    if scenario_id:
  1052→        # v7: 优先尝试加载规则
  1053→        if has_rules(skill_id):
  1054→            rule = load_rule(skill_id, scenario_id)
  1055→            if rule:
  1056→                parts.append(f"\n---\n\n## 当前规则: {rule.name}\n")
  1057→                # 添加规则完整内容
  1058→                parts.append(rule.content)
  1059→            else:
  1060→                # 规则不存在，尝试加载场景（向后兼容）
  1061→                scenario = load_scenario(skill_id, scenario_id)
  1062→                if scenario:
  1063→                    parts.append(f"\n---\n\n## 当前场景: {scenario.name}\n\n{scenario.description}")
  1064→                    if scenario.sop:
  1065→                        sop_text = "\n## 服务流程 (SOP)\n\n"
  1066→                        for phase in scenario.sop:
  1067→                            sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1068→                        parts.append(sop_text)
  1069→        else:
  1070→            # 旧架构：加载场景
  1071→            scenario = load_scenario(skill_id, scenario_id)
  1072→            if scenario:
  1073→                parts.append(f"\n---\n\n## 当前场景: {scenario.name}\n\n{scenario.description}")
  1074→                # SOP
  1075→                if scenario.sop:
  1076→                    sop_text = "\n## 服务流程 (SOP)\n\n"
  1077→                    for phase in scenario.sop:
  1078→                        sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
  1079→                    parts.append(sop_text)
  1080→
  1081→    # 伦理边界
  1082→    if skill.ethics.get("forbidden"):
  1083→        ethics_text = "\n## 伦理边界\n\n### 绝对禁止\n"
  1084→        for item in skill.ethics["forbidden"]:
  1085→            ethics_text += f"- {item}\n"
  1086→        parts.append(ethics_text)
  1087→
  1088→    # 边界控制原则（在伦理边界之后）- v2.1 更新
  1089→    boundary_text = """
  1090→## 能力边界（强制遵守）
  1091→
  1092→### 核心原则
  1093→你只能在当前 Skill 定义的能力范围内提供帮助。超出范围的问题，你必须诚实告知用户，而不是"胡说八道"。
  1094→
  1095→### 边界规则
  1096→
  1097→1. **只用当前 Skill 的工具**
  1098→   - 只能调用当前 Skill 声明的工具
  1099→   - 必须遵循 SKILL.md 中定义的流程和规则
  1100→   - 不要编造不存在的功能或服务
  1101→
  1102→2. **模糊请求的处理**（v2.1 新增）
  1103→   - 用户说"今日指引"、"帮我看看"、"继续" → **用当前 Skill 的工具处理**
  1104→   - 不要因为用户的话不在触发词列表里就调用 `recommend_skills`
  1105→   - 优先尝试用当前 Skill 的能力满足用户需求
  1106→
  1107→3. **用户明确要求换服务时**
  1108→   - 用户说"我想看星座"、"帮我算八字" → 可以调用 `activate_skill`
  1109→   - 用户说"换一个"、"退出" → 温暖告别或询问想要什么
  1110→
  1111→4. **超出范围时的处理**
  1112→   - 先用文字说明"这个超出了我的专长"
  1113→   - 询问用户"需要我帮你找到合适的服务吗？"
  1114→   - 用户确认后再调用 `activate_skill` 或 `recommend_skills`
  1115→   - **不要**直接调用路由工具，让用户有选择权
  1116→
  1117→5. **禁止的行为**

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
