    89→        if skill_id:
    90→            # ═══════════════════════════════════════════════════════════════
    91→            # Phase 2: Skill 执行阶段 - 完整上下文
    92→            # ═══════════════════════════════════════════════════════════════
    93→
    94→            # 基础 Skill Prompt
    95→            user_ctx = dict(profile) if profile else {}
    96→            base_prompt = build_system_prompt(skill_id, rule_id, user_ctx)
    97→            parts.append(base_prompt)
    98→
    99→            # ═══════════════════════════════════════════════════════════════
   100→            # Profile 注入（简化版 v2.2）- 两层架构
   101→            # ═══════════════════════════════════════════════════════════════
   102→            profile_context = self._build_profile_context(profile, skill_data, skill_id)
   103→            if profile_context:
   104→                parts.append(profile_context)
   105→
   106→            # 会话恢复上下文（断点续传核心）
   107→            if session_context and session_context.has_checkpoint:
   108→                resume_context = session_context.to_prompt_context()
   109→                if resume_context:
   110→                    parts.append(resume_context)
   111→
   112→            # SOP 规则
   113→            sop_rules = self._build_sop_rules(skill_id, profile, skill_data)
   114→            if sop_rules:
   115→                parts.append(sop_rules)
   116→
   117→            # 案例匹配
   118→            cases_text = await self._match_cases(skill_id, skill_data)
   119→            if cases_text:
   120→                parts.append(cases_text)
   121→
   122→        else:
   123→            # ═══════════════════════════════════════════════════════════════
   124→            # Phase 1: Skill 选择阶段 - 轻量级
   125→            # ═══════════════════════════════════════════════════════════════
   126→
   127→            core_prompt = get_phase1_prompt()
   128→            if not core_prompt:
   129→                # Fallback
   130→                core_prompt = self._get_fallback_phase1_prompt()
   131→
   132→            parts.append(core_prompt)
   133→
   134→        return "\n".join(parts)
   135→
   136→    def _build_profile_context(
   137→        self,
   138→        profile: Optional[Dict[str, Any]],

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
