     1→"""
     2→Lifecoach Skill API Services - 人生仪表盘 API 服务
     3→
     4→使用 @skill_service 装饰器自动注册到 SkillServiceRegistry
     5→通过 /api/v1/skills/lifecoach/{action} 访问
     6→
     7→端点:
     8→- state_read: 读取人生地图状态
     9→- checkin: 每日签到
    10→- lever_complete: 完成每日杠杆
    11→- rock_complete: 完成周大石头
    12→- lever_skip: 跳过每日杠杆
    13→- journal_add: 添加日志
    14→- journal_list: 获取日志列表
    15→- weekly_review: 获取周复盘数据
    16→"""
    17→import logging
    18→from typing import Dict, Any, List, Optional
    19→from datetime import datetime, date, timezone
    20→from uuid import UUID
    21→
    22→from services.agent.skill_service_registry import skill_service, ServiceContext
    23→from stores.unified_profile_repo import UnifiedProfileRepository
    24→
    25→logger = logging.getLogger(__name__)
    26→
    27→
    28→# ═══════════════════════════════════════════════════════════════════════════
    29→# Helper Functions
    30→# ═══════════════════════════════════════════════════════════════════════════
    31→
    32→async def get_lifecoach_data(user_id: str) -> Dict[str, Any]:
    33→    """从 unified_profile 获取 lifecoach 数据"""
    34→    user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
    35→    data = await UnifiedProfileRepository.read_life_context_path(user_uuid, "lifecoach")
    36→    return data.content if data else {}
    37→
    38→
    39→async def save_lifecoach_data(user_id: str, data: Dict[str, Any]) -> None:
    40→    """保存 lifecoach 数据到 unified_profile"""
    41→    user_uuid = UUID(user_id) if isinstance(user_id, str) else user_id
    42→    data["_last_updated"] = datetime.now(timezone.utc).isoformat()
    43→    await UnifiedProfileRepository.write_life_context_path(user_uuid, "lifecoach", data)
    44→
    45→
    46→def transform_to_frontend_format(data: Dict[str, Any]) -> Dict[str, Any]:
    47→    """将存储格式转换为前端期望的格式"""
    48→    result = {}
    49→
    50→    # north_star
    51→    if "north_star" in data:
    52→        result["north_star"] = data["north_star"]
    53→
    54→    # goals
    55→    if "goals" in data:
    56→        goals_data = data["goals"]
    57→        if isinstance(goals_data, dict):
    58→            result["goals"] = goals_data.get("items", [])
    59→        elif isinstance(goals_data, list):
    60→            result["goals"] = goals_data
    61→
    62→    # roles
    63→    if "roles" in data or "identity" in data:
    64→        identity = data.get("identity", {})
    65→        result["roles"] = identity.get("roles", [])
    66→
    67→    # identity
    68→    if "identity" in data:
    69→        result["identity"] = data["identity"]
    70→
    71→    # weekly_rocks -> current.week
    72→    current = data.get("current", {})
    73→    if "week" in current:
    74→        week_data = current["week"]
    75→        result["weekly_rocks"] = {
    76→            "week_start": week_data.get("week_start", date.today().isoformat()),
    77→            "rocks": week_data.get("rocks", []),
    78→            "theme": week_data.get("theme"),
    79→            "energy_budget": week_data.get("energy_budget"),
    80→            "stats": _calculate_rock_stats(week_data.get("rocks", []))
    81→        }
    82→
    83→    # daily_levers -> current.daily
    84→    if "daily" in current:
    85→        daily_data = current["daily"]
    86→        result["daily_levers"] = {
    87→            "date": daily_data.get("date", date.today().isoformat()),
    88→            "levers": daily_data.get("levers", []),
    89→            "energy_level": daily_data.get("energy_level"),
    90→            "intention": daily_data.get("intention"),
    91→            "stats": _calculate_lever_stats(daily_data.get("levers", []))
    92→        }
    93→
    94→    # monthly_boss -> current.month
    95→    if "month" in current:
    96→        result["monthly_boss"] = current["month"]
    97→
    98→    # progress
    99→    if "progress" in data:
   100→        progress = data["progress"]
   101→        today = date.today().isoformat()
   102→        result["progress"] = {
   103→            "current_streak": progress.get("current_streak", 0),
   104→            "longest_streak": progress.get("longest_streak", 0),
   105→            "total_checkins": progress.get("total_checkins", 0),
   106→            "weekly_completion_rate": _calculate_weekly_completion_rate(current),
   107→            "monthly_stats": progress.get("monthly_stats"),
   108→            "achievements": progress.get("achievements", []),
   109→            "last_checkin_date": progress.get("last_checkin_date"),
   110→            "today_checked_in": progress.get("last_checkin_date") == today,
   111→        }
   112→
   113→    return result
   114→
   115→
   116→def _calculate_rock_stats(rocks: List[Dict]) -> Dict[str, Any]:
   117→    """计算周大石头统计"""
   118→    total = len(rocks)
   119→    completed = sum(1 for r in rocks if r.get("status") == "completed")
   120→    in_progress = sum(1 for r in rocks if r.get("status") == "in_progress")
   121→    return {
   122→        "total": total,
   123→        "completed": completed,
   124→        "in_progress": in_progress,
   125→        "completion_rate": round(completed / total * 100) if total > 0 else 0
   126→    }
   127→
   128→
   129→def _calculate_lever_stats(levers: List[Dict]) -> Dict[str, Any]:
   130→    """计算每日杠杆统计"""
   131→    total = len(levers)
   132→    completed = sum(1 for l in levers if l.get("status") == "completed")
   133→    return {
   134→        "total": total,
   135→        "completed": completed,
   136→        "completion_rate": round(completed / total * 100) if total > 0 else 0
   137→    }
   138→
   139→
   140→def _calculate_weekly_completion_rate(current: Dict[str, Any]) -> int:
   141→    """计算本周完成率"""
   142→    week_data = current.get("week", {})
   143→    rocks = week_data.get("rocks", [])
   144→    if not rocks:
   145→        return 0
   146→    completed = sum(1 for r in rocks if r.get("status") == "completed")
   147→    return round(completed / len(rocks) * 100)
   148→
   149→
   150→# ═══════════════════════════════════════════════════════════════════════════
   151→# State Read Service
   152→# ═══════════════════════════════════════════════════════════════════════════
   153→
   154→@skill_service("lifecoach", "state_read", description="读取人生地图状态", auth_required=True)
   155→async def read_state(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   156→    """
   157→    读取用户的人生地图状态
   158→
   159→    Args:
   160→        sections: 要读取的数据部分，如 ["north_star", "identity", "current", "progress"]
   161→
   162→    Returns:
   163→        status: success/empty/error
   164→        data: LifecoachSkillData 格式的数据
   165→    """
   166→    sections = args.get("sections", ["system", "north_star", "identity", "current", "progress"])
   167→
   168→    if not context.user_id:
   169→        return {"status": "error", "message": "Authentication required", "data": {}}
   170→
   171→    try:
   172→        # 获取完整数据
   173→        raw_data = await get_lifecoach_data(context.user_id)
   174→
   175→        if not raw_data:
   176→            return {
   177→                "status": "empty",
   178→                "message": "尚未建立人生地图",
   179→                "data": {}
   180→            }
   181→
   182→        # 转换为前端期望的格式
   183→        result_data: Dict[str, Any] = {}
   184→
   185→        # north_star
   186→        if "north_star" in sections and "north_star" in raw_data:
   187→            result_data["north_star"] = raw_data["north_star"]
   188→
   189→        # identity
   190→        if "identity" in sections and "identity" in raw_data:
   191→            result_data["identity"] = raw_data["identity"]
   192→
   193→        # goals
   194→        if "goals" in sections and "goals" in raw_data:
   195→            result_data["goals"] = raw_data["goals"]
   196→
   197→        # focus (自动计算)
   198→        if "focus" in sections:
   199→            if "focus" in raw_data:
   200→                result_data["focus"] = raw_data["focus"]
   201→            else:
   202→                # 如果没有 focus 字段，自动计算
   203→                result_data["focus"] = _calculate_focus(
   204→                    raw_data.get("goals", []),
   205→                    raw_data.get("current", {})
   206→                )
   207→
   208→        # weekly (从 current.week 转换)
   209→        if "current" in sections:
   210→            current = raw_data.get("current", {})
   211→            if "week" in current:
   212→                week_data = current["week"]
   213→                result_data["weekly"] = {
   214→                    "week_start": week_data.get("week_start"),
   215→                    "rocks": week_data.get("rocks", []),
   216→                    "theme": week_data.get("theme"),
   217→                }
   218→
   219→        # progress
   220→        if "progress" in sections and "progress" in raw_data:
   221→            result_data["progress"] = raw_data["progress"]
   222→
   223→        # system state
   224→        if "system" in sections:
   225→            result_data["_state"] = raw_data.get("system", {})
   226→
   227→        return {
   228→            "status": "success",
   229→            "data": result_data
   230→        }
   231→
   232→    except Exception as e:
   233→        logger.error(f"Read lifecoach state failed: {e}")
   234→        return {"status": "error", "message": str(e), "data": {}}
   235→
   236→
   237→# ═══════════════════════════════════════════════════════════════════════════
   238→# Checkin Service
   239→# ═══════════════════════════════════════════════════════════════════════════
   240→
   241→@skill_service("lifecoach", "checkin", description="每日签到", auth_required=True)
   242→async def daily_checkin(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   243→    """
   244→    每日签到
   245→
   246→    Args:
   247→        energy_level: 能量等级 (1-10)
   248→        intention: 今日意图
   249→        mood: 心情
   250→
   251→    Returns:
   252→        success: 是否成功
   253→        streak: 当前连续天数
   254→        daily_levers: 今日杠杆行动
   255→    """
   256→    if not context.user_id:
   257→        return {"error": "Authentication required", "status": "error"}
   258→
   259→    energy_level = args.get("energy_level")
   260→    intention = args.get("intention")
   261→    mood = args.get("mood")
   262→
   263→    try:
   264→        data = await get_lifecoach_data(context.user_id)
   265→        progress = data.get("progress", {
   266→            "current_streak": 0,
   267→            "longest_streak": 0,
   268→            "total_checkins": 0,
   269→            "last_checkin_date": None,
   270→            "checkin_history": []
   271→        })
   272→
   273→        today = date.today().isoformat()
   274→        now = datetime.now(timezone.utc).isoformat()
   275→
   276→        # 检查是否今天已签到
   277→        if progress.get("last_checkin_date") == today:
   278→            return {
   279→                "success": True,
   280→                "streak": progress["current_streak"],
   281→                "message": "今天已经签到过了",
   282→                "already_checked_in": True
   283→            }
   284→
   285→        # 计算连续签到
   286→        last_date = progress.get("last_checkin_date")
   287→        old_streak = progress.get("current_streak", 0)
   288→
   289→        if last_date:
   290→            days_since = (date.today() - date.fromisoformat(last_date)).days
   291→            new_streak = old_streak + 1 if days_since == 1 else 1
   292→        else:
   293→            new_streak = 1
   294→
   295→        # 更新进度
   296→        progress["current_streak"] = new_streak
   297→        progress["longest_streak"] = max(new_streak, progress.get("longest_streak", 0))
   298→        progress["total_checkins"] = progress.get("total_checkins", 0) + 1
   299→        progress["last_checkin_date"] = today
   300→
   301→        # 记录签到历史
   302→        history = progress.get("checkin_history", [])
   303→        history.append({
   304→            "date": today,
   305→            "time": now,
   306→            "energy_level": energy_level,
   307→            "mood": mood,
   308→            "intention": intention
   309→        })
   310→        progress["checkin_history"] = history[-30:]  # 保留最近30天
   311→
   312→        # 更新 current.daily 的 intention 和 energy_level
   313→        current = data.get("current", {})
   314→        daily = current.get("daily", {"date": today, "levers": []})
   315→        if daily.get("date") != today:
   316→            daily = {"date": today, "levers": daily.get("levers", [])}
   317→        daily["energy_level"] = energy_level
   318→        daily["intention"] = intention
   319→        current["daily"] = daily
   320→
   321→        data["progress"] = progress
   322→        data["current"] = current
   323→
   324→        await save_lifecoach_data(context.user_id, data)
   325→
   326→        # 准备返回的 daily_levers
   327→        daily_levers = {
   328→            "date": today,
   329→            "levers": daily.get("levers", []),
   330→            "energy_level": energy_level,
   331→            "intention": intention,
   332→            "stats": _calculate_lever_stats(daily.get("levers", []))
   333→        }
   334→
   335→        return {
   336→            "success": True,
   337→            "streak": new_streak,
   338→            "message": f"签到成功！连续 {new_streak} 天",
   339→            "daily_levers": daily_levers
   340→        }
   341→
   342→    except Exception as e:
   343→        logger.error(f"Checkin failed: {e}")
   344→        return {"success": False, "error": str(e)}
   345→
   346→
   347→# ═══════════════════════════════════════════════════════════════════════════
   348→# Lever Complete Service
   349→# ═══════════════════════════════════════════════════════════════════════════
   350→
   351→@skill_service("lifecoach", "lever_complete", description="完成每日杠杆", auth_required=True)
   352→async def complete_lever(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   353→    """
   354→    完成每日杠杆行动
   355→
   356→    Args:
   357→        lever_id: 杠杆 ID
   358→        notes: 完成备注
   359→
   360→    Returns:
   361→        success: 是否成功
   362→        progress: 更新后的进度
   363→    """
   364→    if not context.user_id:
   365→        return {"error": "Authentication required", "status": "error"}
   366→
   367→    lever_id = args.get("lever_id")
   368→    notes = args.get("notes")
   369→
   370→    if not lever_id:
   371→        return {"success": False, "error": "lever_id is required"}
   372→
   373→    try:
   374→        data = await get_lifecoach_data(context.user_id)
   375→        current = data.get("current", {})
   376→        daily = current.get("daily", {"date": date.today().isoformat(), "levers": []})
   377→
   378→        now = datetime.now(timezone.utc).isoformat()
   379→
   380→        # 更新杠杆状态
   381→        levers = daily.get("levers", [])
   382→        lever_found = False
   383→        for lever in levers:
   384→            if lever.get("id") == lever_id:
   385→                lever["status"] = "completed"
   386→                lever["completed_at"] = now
   387→                if notes:
   388→                    lever["notes"] = notes
   389→                lever_found = True
   390→                break
   391→
   392→        if not lever_found:
   393→            return {"success": False, "error": f"Lever {lever_id} not found"}
   394→
   395→        daily["levers"] = levers
   396→        current["daily"] = daily
   397→
   398→        # 记录到 progress.completed_levers
   399→        progress = data.get("progress", {})
   400→        completed_levers = progress.get("completed_levers", [])
   401→        completed_levers.append({
   402→            "id": lever_id,
   403→            "completed_at": now,
   404→            "notes": notes
   405→        })
   406→        progress["completed_levers"] = completed_levers[-100:]  # 保留最近100条
   407→
   408→        data["current"] = current
   409→        data["progress"] = progress
   410→
   411→        await save_lifecoach_data(context.user_id, data)
   412→
   413→        # 转换返回格式
   414→        transformed = transform_to_frontend_format(data)
   415→
   416→        return {
   417→            "success": True,
   418→            "message": "杠杆已完成",
   419→            "progress": transformed.get("progress")
   420→        }
   421→
   422→    except Exception as e:
   423→        logger.error(f"Complete lever failed: {e}")
   424→        return {"success": False, "error": str(e)}
   425→
   426→
   427→# ═══════════════════════════════════════════════════════════════════════════
   428→# Rock Complete Service
   429→# ═══════════════════════════════════════════════════════════════════════════
   430→
   431→@skill_service("lifecoach", "rock_complete", description="完成周大石头", auth_required=True)
   432→async def complete_rock(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   433→    """
   434→    完成周大石头
   435→
   436→    Args:
   437→        rock_id: 大石头 ID
   438→        reflection: 完成反思
   439→
   440→    Returns:
   441→        success: 是否成功
   442→        progress: 更新后的进度
   443→    """
   444→    if not context.user_id:
   445→        return {"error": "Authentication required", "status": "error"}
   446→
   447→    rock_id = args.get("rock_id")
   448→    reflection = args.get("reflection")
   449→
   450→    if not rock_id:
   451→        return {"success": False, "error": "rock_id is required"}
   452→
   453→    try:
   454→        data = await get_lifecoach_data(context.user_id)
   455→        current = data.get("current", {})
   456→        week = current.get("week", {"rocks": []})
   457→
   458→        now = datetime.now(timezone.utc).isoformat()
   459→
   460→        # 更新大石头状态
   461→        rocks = week.get("rocks", [])
   462→        rock_found = False
   463→        for rock in rocks:
   464→            if rock.get("id") == rock_id:
   465→                rock["status"] = "completed"
   466→                rock["progress"] = 100
   467→                rock["completed_at"] = now
   468→                if reflection:
   469→                    rock["reflection"] = reflection
   470→                rock_found = True
   471→                break
   472→
   473→        if not rock_found:
   474→            return {"success": False, "error": f"Rock {rock_id} not found"}
   475→
   476→        week["rocks"] = rocks
   477→        current["week"] = week
   478→
   479→        # 记录到 progress.completed_rocks
   480→        progress = data.get("progress", {})
   481→        completed_rocks = progress.get("completed_rocks", [])
   482→        completed_rocks.append({
   483→            "id": rock_id,
   484→            "completed_at": now,
   485→            "reflection": reflection
   486→        })
   487→        progress["completed_rocks"] = completed_rocks[-50:]
   488→
   489→        data["current"] = current
   490→        data["progress"] = progress
   491→
   492→        await save_lifecoach_data(context.user_id, data)
   493→
   494→        transformed = transform_to_frontend_format(data)
   495→
   496→        return {
   497→            "success": True,
   498→            "message": "大石头已完成！",
   499→            "progress": transformed.get("progress")
   500→        }
   501→
   502→    except Exception as e:
   503→        logger.error(f"Complete rock failed: {e}")
   504→        return {"success": False, "error": str(e)}
   505→
   506→
   507→# ═══════════════════════════════════════════════════════════════════════════
   508→# Lever Skip Service
   509→# ═══════════════════════════════════════════════════════════════════════════
   510→
   511→@skill_service("lifecoach", "lever_skip", description="跳过每日杠杆", auth_required=True)
   512→async def skip_lever(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   513→    """
   514→    跳过每日杠杆
   515→
   516→    Args:
   517→        lever_id: 杠杆 ID
   518→        reason: 跳过原因
   519→
   520→    Returns:
   521→        success: 是否成功
   522→    """
   523→    if not context.user_id:
   524→        return {"error": "Authentication required", "status": "error"}
   525→
   526→    lever_id = args.get("lever_id")
   527→    reason = args.get("reason")
   528→
   529→    if not lever_id:
   530→        return {"success": False, "error": "lever_id is required"}
   531→
   532→    try:
   533→        data = await get_lifecoach_data(context.user_id)
   534→        current = data.get("current", {})
   535→        daily = current.get("daily", {"date": date.today().isoformat(), "levers": []})
   536→
   537→        # 更新杠杆状态
   538→        levers = daily.get("levers", [])
   539→        lever_found = False
   540→        for lever in levers:
   541→            if lever.get("id") == lever_id:
   542→                lever["status"] = "skipped"
   543→                if reason:
   544→                    lever["skip_reason"] = reason
   545→                lever_found = True
   546→                break
   547→
   548→        if not lever_found:
   549→            return {"success": False, "error": f"Lever {lever_id} not found"}
   550→
   551→        daily["levers"] = levers
   552→        current["daily"] = daily
   553→        data["current"] = current
   554→
   555→        await save_lifecoach_data(context.user_id, data)
   556→
   557→        return {
   558→            "success": True,
   559→            "message": "已跳过"
   560→        }
   561→
   562→    except Exception as e:
   563→        logger.error(f"Skip lever failed: {e}")
   564→        return {"success": False, "error": str(e)}
   565→
   566→
   567→# ═══════════════════════════════════════════════════════════════════════════
   568→# Journal Services
   569→# ═══════════════════════════════════════════════════════════════════════════
   570→
   571→@skill_service("lifecoach", "journal_add", description="添加日志条目", auth_required=True)
   572→async def add_journal_entry(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   573→    """
   574→    添加复盘日志
   575→
   576→    Args:
   577→        type: 日志类型 (reflection, gratitude, insight, note)
   578→        content: 内容
   579→        mood: 心情
   580→        tags: 标签列表
   581→    """
   582→    if not context.user_id:
   583→        return {"error": "Authentication required", "status": "error"}
   584→
   585→    entry_type = args.get("type", "note")
   586→    content = args.get("content")
   587→
   588→    if not content:
   589→        return {"success": False, "error": "content is required"}
   590→
   591→    try:
   592→        data = await get_lifecoach_data(context.user_id)
   593→        journal = data.get("journal", [])
   594→
   595→        import uuid
   596→        entry = {
   597→            "id": str(uuid.uuid4()),
   598→            "date": date.today().isoformat(),
   599→            "type": entry_type,
   600→            "content": content,
   601→            "mood": args.get("mood"),
   602→            "tags": args.get("tags", []),
   603→            "created_at": datetime.now(timezone.utc).isoformat()
   604→        }
   605→
   606→        journal = [entry] + journal[:99]  # 保留最近100条
   607→        data["journal"] = journal
   608→
   609→        await save_lifecoach_data(context.user_id, data)
   610→
   611→        return {
   612→            "success": True,
   613→            "entry": entry
   614→        }
   615→
   616→    except Exception as e:
   617→        logger.error(f"Add journal entry failed: {e}")
   618→        return {"success": False, "error": str(e)}
   619→
   620→
   621→@skill_service("lifecoach", "journal_list", description="获取日志列表", auth_required=True)
   622→async def list_journal_entries(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   623→    """
   624→    获取日志列表
   625→
   626→    Args:
   627→        limit: 返回数量，默认 10
   628→        offset: 偏移量，默认 0
   629→    """
   630→    if not context.user_id:
   631→        return {"error": "Authentication required", "status": "error"}
   632→
   633→    limit = args.get("limit", 10)
   634→    offset = args.get("offset", 0)
   635→
   636→    try:
   637→        data = await get_lifecoach_data(context.user_id)
   638→        journal = data.get("journal", [])
   639→
   640→        entries = journal[offset:offset + limit]
   641→
   642→        return {
   643→            "entries": entries,
   644→            "total": len(journal),
   645→            "limit": limit,
   646→            "offset": offset
   647→        }
   648→
   649→    except Exception as e:
   650→        logger.error(f"List journal entries failed: {e}")
   651→        return {"entries": [], "error": str(e)}
   652→
   653→
   654→# ═══════════════════════════════════════════════════════════════════════════
   655→# Weekly Review Service
   656→# ═══════════════════════════════════════════════════════════════════════════
   657→
   658→@skill_service("lifecoach", "weekly_review", description="获取周复盘数据", auth_required=True)
   659→async def get_weekly_review(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   660→    """
   661→    获取周复盘数据
   662→
   663→    Args:
   664→        week_start: 周起始日期，默认本周
   665→    """
   666→    if not context.user_id:
   667→        return {"error": "Authentication required", "status": "error"}
   668→
   669→    try:
   670→        data = await get_lifecoach_data(context.user_id)
   671→        current = data.get("current", {})
   672→        week = current.get("week", {})
   673→        daily = current.get("daily", {})
   674→
   675→        rocks = week.get("rocks", [])
   676→        levers = daily.get("levers", [])
   677→
   678→        review = {
   679→            "week_start": week.get("week_start", date.today().isoformat()),
   680→            "rocks_completed": sum(1 for r in rocks if r.get("status") == "completed"),
   681→            "rocks_total": len(rocks),
   682→            "levers_completed": sum(1 for l in levers if l.get("status") == "completed"),
   683→            "levers_total": len(levers),
   684→            "theme": week.get("theme"),
   685→        }
   686→
   687→        # 从 journal 获取本周的洞察
   688→        journal = data.get("journal", [])
   689→        week_start = week.get("week_start", date.today().isoformat())
   690→        week_insights = [
   691→            j for j in journal
   692→            if j.get("date", "") >= week_start and j.get("type") in ["insight", "reflection"]
   693→        ]
   694→
   695→        if week_insights:
   696→            review["highlights"] = [j.get("content") for j in week_insights[:3]]
   697→
   698→        return review
   699→
   700→    except Exception as e:
   701→        logger.error(f"Get weekly review failed: {e}")
   702→        return {"error": str(e)}
   703→
   704→
   705→# ═══════════════════════════════════════════════════════════════════════════
   706→# State Write Service
   707→# ═══════════════════════════════════════════════════════════════════════════
   708→
   709→def deep_merge(base: Dict[str, Any], update: Dict[str, Any]) -> Dict[str, Any]:
   710→    """深度合并两个字典"""
   711→    result = base.copy()
   712→    for key, value in update.items():
   713→        if key in result and isinstance(result[key], dict) and isinstance(value, dict):
   714→            result[key] = deep_merge(result[key], value)
   715→        elif value is not None:
   716→            result[key] = value
   717→    return result
   718→
   719→
   720→def _enrich_goals(goals: List[Dict[str, Any]]) -> List[Dict[str, Any]]:
   721→    """为 goals 补齐缺失字段"""
   722→    now = datetime.now(timezone.utc).isoformat()
   723→    enriched = []
   724→
   725→    for goal in goals:
   726→        enriched_goal = goal.copy()
   727→
   728→        # 补齐 source 字段
   729→        if "source" not in enriched_goal:
   730→            enriched_goal["source"] = "lifecoach"  # 默认来源
   731→
   732→        # 补齐 created_at 字段
   733→        if "created_at" not in enriched_goal:
   734→            enriched_goal["created_at"] = now
   735→
   736→        # 补齐 check_ins 字段
   737→        if "check_ins" not in enriched_goal:
   738→            enriched_goal["check_ins"] = []
   739→
   740→        enriched.append(enriched_goal)
   741→
   742→    return enriched
   743→
   744→
   745→def _calculate_focus(goals: List[Dict[str, Any]], current: Dict[str, Any]) -> Dict[str, Any]:
   746→    """计算聚焦领域热力图"""
   747→    if not goals:
   748→        return {
   749→            "primary": None,
   750→            "active_goal": None,
   751→            "heat_map": {}
   752→        }
   753→
   754→    # 统计各类别目标数量和活跃度
   755→    category_scores = {}
   756→    active_goal_id = None
   757→    max_activity = 0
   758→
   759→    for goal in goals:
   760→        category = goal.get("category", "other")
   761→        status = goal.get("status", "pending")
   762→        progress = goal.get("progress", 0)
   763→
   764→        # 计算活跃度分数
   765→        activity_score = 0
   766→        if status == "in_progress":
   767→            activity_score = 0.5 + (progress * 0.5)  # 进行中的目标，基础0.5 + 进度加成
   768→        elif status == "completed":
   769→            activity_score = 0.2  # 已完成的目标，低权重
   770→
   771→        if activity_score > max_activity:
   772→            max_activity = activity_score
   773→            active_goal_id = goal.get("id")
   774→
   775→        # 累加类别分数
   776→        category_scores[category] = category_scores.get(category, 0) + activity_score
   777→
   778→    # 归一化热力图（0-1范围）
   779→    max_score = max(category_scores.values()) if category_scores else 1
   780→    heat_map = {cat: round(score / max_score, 2) for cat, score in category_scores.items()}
   781→
   782→    # 找出主要聚焦领域
   783→    primary = max(category_scores, key=category_scores.get) if category_scores else None
   784→
   785→    return {
   786→        "primary": primary,
   787→        "active_goal": active_goal_id,
   788→        "heat_map": heat_map
   789→    }
   790→
   791→
   792→VALID_SECTIONS = ["system", "north_star", "goals", "roadmap", "current", "identity", "progress", "journal", "focus"]
   793→
   794→
   795→@skill_service("lifecoach", "state_write", description="写入人生地图状态", auth_required=True)
   796→async def write_state(args: Dict[str, Any], context: ServiceContext) -> Dict[str, Any]:
   797→    """
   798→    写入用户的人生地图状态
   799→
   800→    Args:
   801→        section: 要写入的部分 (system, north_star, goals, roadmap, current, identity, progress, journal)
   802→        data: 要写入的数据
   803→
   804→    Returns:
   805→        status: success/error
   806→        message: 结果消息
   807→    """
   808→    section = args.get("section")
   809→    write_data = args.get("data")
   810→
   811→    if not section or not write_data:
   812→        return {"status": "error", "message": "缺少必要参数: section 和 data"}
   813→
   814→    if section not in VALID_SECTIONS:
   815→        return {"status": "error", "message": f"无效的 section: {section}"}
   816→
   817→    if not context.user_id:
   818→        return {"status": "error", "message": "Authentication required"}
   819→
   820→    try:
   821→        # 获取现有数据
   822→        existing_data = await get_lifecoach_data(context.user_id)
   823→
   824→        # 特殊处理：为 goals 补齐缺失字段
   825→        if section == "goals" and isinstance(write_data, list):
   826→            write_data = _enrich_goals(write_data)
   827→
   828→        # 特殊处理：自动计算 focus
   829→        if section == "goals" or section == "current":
   830→            existing_data["focus"] = _calculate_focus(
   831→                existing_data.get("goals", []) if section != "goals" else write_data,
   832→                existing_data.get("current", {})
   833→            )
   834→
   835→        # 深度合并
   836→        if section in existing_data and isinstance(existing_data[section], dict) and isinstance(write_data, dict):
   837→            existing_data[section] = deep_merge(existing_data[section], write_data)
   838→        else:
   839→            existing_data[section] = write_data
   840→
   841→        existing_data["_last_updated"] = datetime.now(timezone.utc).isoformat()
   842→        existing_data["_last_section"] = section
   843→
   844→        # 保存
   845→        await save_lifecoach_data(context.user_id, existing_data)
   846→
   847→        return {"status": "success", "message": f"已保存 {section}"}
   848→
   849→    except Exception as e:
   850→        logger.error(f"Write lifecoach state failed: {e}")
   851→        return {"status": "error", "message": str(e)}
   852→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
