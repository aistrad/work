The file /home/aiscend/.claude/plans/swift-herding-peacock.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   477→```
   478→
   479→---
   480→
   481→## 四、增量逻辑详解
   482→
   483→### 4.1 基于文件的状态追踪
   484→
   485→**核心原理**：使用 MD5 哈希检测文件变化，而非数据库状态
   486→
   487→```
   488→extraction_log.json
   489→{
   490→  "files": {
   491→    "file.md": {
   492→      "md5": "abc123",        ← 文件内容哈希
   493→      "status": "extracted",
   494→      "extracted_at": "..."
   495→    }
   496→  },
   497→  "prompt_version": 2         ← Prompt 版本号
   498→}
   499→
   500→状态判断：
   501→┌─────────────────────────────────────────────────────────────────────────┐
   502→│                                                                         │
   503→│   文件不在 log 中？             → 新文件，需要处理                        │
   504→│   文件 MD5 变化？               → 内容更新，需要重新处理                  │
   505→│   prompt_version 变化？         → Prompt 更新，全部重新处理               │
   506→│   其他情况                      → 跳过（已处理且未变化）                  │
   507→│                                                                         │
   508→└─────────────────────────────────────────────────────────────────────────┘
   509→```
   510→
   511→### 4.2 融合策略（基于文件）
   512→
   513→**场景 A：新增 MD 文件**
   514→```
   515→1. 用户添加新 MD 文件到 converted/ 目录
   516→2. Stage 4 运行 → 检测到新文件（不在 log 中）
   517→3. 抽取 Cases + Scenarios
   518→4. Cases → 写入 DB (status='pending')
   519→   Scenarios → 写入 extracted/scenarios/*.md
   520→5. 更新 extraction_log.json
   521→```
   522→
   523→**场景 B：修改已有 MD 文件**
   524→```
   525→1. 用户编辑 converted/ 目录中的 MD 文件
   526→2. Stage 4 运行 → 检测到 MD5 变化
   527→3. 重新抽取该文件
   528→4. Cases → UPSERT（基于 source_file 匹配）
   529→   Scenarios → 覆盖写入 extracted/scenarios/
   530→5. 更新 extraction_log.json
   531→```
   532→
   533→**场景 C：更新 Prompt 模板**
   534→```
   535→1. 编辑 UNIFIED_EXTRACTION_PROMPT.md
   536→2. 递增 extraction_log.json 中的 prompt_version
   537→3. 运行: python build_knowledge.py --skill bazi --stages 4 --force-reextract
   538→4. 所有文件重新处理
   539→5. 旧结果被新结果覆盖/更新
   540→```
   541→
   542→**场景 D：删除 MD 源文件**
   543→```
   544→1. 用户从 converted/ 删除 MD 文件
   545→2. 运行清理命令: python build_knowledge.py --skill bazi --cleanup
   546→3. 查找 cases 表中 source_file 指向已删除文件的记录
   547→4. 标记或删除这些 Cases
   548→5. 从 extracted/scenarios/ 删除相关 Scenario 候选
   549→```
   550→
   551→### 4.3 来源追溯查询
   552→
   553→```sql
   554→-- 查看某个 Case 来源于哪个 MD 文件
   555→SELECT
   556→    c.id,
   557→    c.name,
   558→    c.source_file,        -- 例: "manual/第六章_十神的深层心理与事件对应.md"
   559→    c.source_section,     -- 例: "第六节：正偏转换"
   560→    c.status,
   561→    c.quality_score
   562→FROM cases c
   563→WHERE c.id = 'CASE_bazi_xxxx';
   564→
   565→-- 查看某个 MD 文件产出了哪些 Cases
   566→SELECT
   567→    source_file,
   568→    COUNT(*) as cases_count,
   569→    AVG(quality_score) as avg_quality,
   570→    SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END) as approved_count
   571→FROM cases
   572→WHERE skill_id = 'bazi'
   573→GROUP BY source_file
   574→ORDER BY cases_count DESC;
   575→
   576→-- 查找质量评分低的 Cases（需人工审核）
   577→SELECT id, name, source_file, quality_score
   578→FROM cases
   579→WHERE skill_id = 'bazi'
   580→  AND status = 'pending'
   581→  AND quality_score < 0.6
   582→ORDER BY quality_score ASC;
   583→```
   584→
   585→---
   586→
   587→## 五、关键文件修改清单