The file /home/aiscend/.claude/plans/swift-herding-peacock.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   426→            output_path.write_text(md_content)
   427→        return len(scenarios)
   428→```
   429→
   430→### 3.5 流水线整合
   431→
   432→**修改**: `apps/api/scripts/build_knowledge.py`
   433→
   434→```python
   435→# 原来（两个独立步骤）
   436→async def run_stage_4a(self, limit: int = 100):
   437→    """Stage 4a: Extract cases from DB chunks"""
   438→    ...
   439→
   440→async def run_stage_4b(self, limit: int = 50):
   441→    """Stage 4b: Generate scenarios from DB chunks"""
   442→    ...
   443→
   444→# 新增（统一抽取，直接从 MD 文件）
   445→async def run_stage_4(self, force_reextract: bool = False):
   446→    """
   447→    Stage 4: Unified Extraction from MD Files
   448→
   449→    读取 /data/vibelife/knowledge/{skill}/converted/*.md
   450→    输出:
   451→    - Cases → cases 表 (status='pending')
   452→    - Scenarios → extracted/scenarios/*.md (候选)
   453→    """
   454→    from workers.unified_extractor import UnifiedExtractor
   455→
   456→    extractor = UnifiedExtractor(self.skill_id)
   457→    results = await extractor.process_pending_files(force_reextract=force_reextract)
   458→
   459→    logger.info(f"Stage 4 complete: {results['cases_count']} cases, {results['scenarios_count']} scenarios from {results['files_processed']} files")
   460→    return results
   461→```
   462→
   463→### 3.6 CLI 参数扩展
   464→
   465→```bash
   466→# 增量处理（默认行为，只处理新增/修改的 MD 文件）
   467→python build_knowledge.py --skill bazi --stages 4
   468→
   469→# 强制重新抽取所有文件
   470→python build_knowledge.py --skill bazi --stages 4 --force-reextract
   471→
   472→# 只处理特定文件
   473→python build_knowledge.py --skill bazi --stages 4 --files "manual/*.md"
   474→
   475→# 查看抽取状态（不执行）
   476→python build_knowledge.py --skill bazi --stages 4 --dry-run
   477→```
   478→
   479→---
   480→
   481→## 四、增量逻辑详解