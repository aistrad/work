     1â†’"""
     2â†’SkillLoader v6 - æ”¯æŒ Scenario è·¯ç”±çš„ Skill åŠ è½½å™¨
     3â†’
     4â†’v6 æ¶æ„ï¼š
     5â†’- SKILL.md: æ ¸å¿ƒå®šä¹‰ï¼ˆä¸“å®¶èº«ä»½ã€åœºæ™¯ç›®å½•ã€ä¼¦ç†è¾¹ç•Œï¼‰
     6â†’- scenarios/*.md: MiniSkill åœºæ™¯æ–‡ä»¶ï¼ˆSOPã€çŸ¥è¯†æ£€ç´¢é…ç½®ã€è¾“å‡ºæ¨¡æ¿ï¼‰
     7â†’- tools/*.py: å·¥å…·å®šä¹‰ï¼ˆæ”¶é›†/è®¡ç®—/å±•ç¤º/æ£€ç´¢ï¼‰
     8â†’"""
     9â†’import re
    10â†’import json
    11â†’import logging
    12â†’from pathlib import Path
    13â†’from dataclasses import dataclass, field
    14â†’from typing import Dict, List, Optional, Any
    15â†’from functools import lru_cache
    16â†’
    17â†’logger = logging.getLogger(__name__)
    18â†’
    19â†’SKILLS_DIR = Path(__file__).parent.parent.parent / "skills"
    20â†’
    21â†’
    22â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    23â†’# æ•°æ®ç»“æ„
    24â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    25â†’
    26â†’@dataclass
    27â†’class SkillConfig:
    28â†’    """Skill æ ¸å¿ƒé…ç½®ï¼ˆä» SKILL.md åŠ è½½ï¼‰"""
    29â†’    id: str
    30â†’    name: str
    31â†’    description: str
    32â†’    expert_persona: str
    33â†’    scenarios: Dict[str, List[str]]  # {entry: [...], standard: [...], professional: [...]}
    34â†’    ethics: Dict[str, Any]
    35â†’    tools: List[str]
    36â†’    default_scenario: str = "basic_reading"
    37â†’    triggers: List[str] = field(default_factory=list)
    38â†’
    39â†’
    40â†’@dataclass
    41â†’class ServiceItem:
    42â†’    """æœåŠ¡é¡¹ï¼ˆç”¨äºæœåŠ¡ç›®å½•å±•ç¤ºï¼‰"""
    43â†’    scenario_id: str
    44â†’    name: str
    45â†’    icon: str
    46â†’    description: str
    47â†’    tier: str  # entry/standard/professional
    48â†’    billing: str  # å…è´¹/åŸºç¡€/é«˜çº§
    49â†’    highlights: List[str] = field(default_factory=list)  # ä»·å€¼ç‚¹
    50â†’
    51â†’
    52â†’@dataclass
    53â†’class ScenarioConfig:
    54â†’    """åœºæ™¯é…ç½®ï¼ˆä» scenarios/*.md åŠ è½½ï¼‰"""
    55â†’    id: str
    56â†’    name: str
    57â†’    level: str  # entry/standard/professional
    58â†’    billing: str  # free/basic/premium
    59â†’    description: str
    60â†’    triggers: Dict[str, List[str]]  # {primary: [...], secondary: [...]}
    61â†’    prerequisites: List[str]
    62â†’    sop: List[Dict[str, Any]]  # SOP é˜¶æ®µåˆ—è¡¨
    63â†’    knowledge_config: Dict[str, Any]  # çŸ¥è¯†æ£€ç´¢é…ç½®
    64â†’    output_config: Dict[str, Any]  # è¾“å‡ºé…ç½®
    65â†’    tools: List[str]
    66â†’
    67â†’
    68â†’@dataclass
    69â†’class ToolMetadata:
    70â†’    """å·¥å…·å…ƒæ•°æ®"""
    71â†’    name: str
    72â†’    description: str
    73â†’    tool_type: str  # collect/calculate/display/search
    74â†’    card_type: Optional[str] = None
    75â†’    card_props_schema: Optional[Dict] = None
    76â†’    parameters: Dict[str, Any] = field(default_factory=dict)
    77â†’    when_to_call: Optional[str] = None
    78â†’
    79â†’
    80â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    81â†’# è§£æå‡½æ•°
    82â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    83â†’
    84â†’def parse_frontmatter(text: str) -> tuple[Dict, str]:
    85â†’    """è§£æ YAML frontmatter"""
    86â†’    pattern = r'^---\s*\n(.*?)\n---\s*\n(.*)$'
    87â†’    match = re.match(pattern, text, re.DOTALL)
    88â†’    if not match:
    89â†’        return {}, text
    90â†’
    91â†’    frontmatter_str, content = match.groups()
    92â†’    metadata = {}
    93â†’    current_key = None
    94â†’    current_list = None
    95â†’
    96â†’    for line in frontmatter_str.strip().split('\n'):
    97â†’        stripped = line.strip()
    98â†’        if not stripped:
    99â†’            continue
   100â†’        if stripped.startswith('- ') and current_key:
   101â†’            if current_list is None:
   102â†’                current_list = []
   103â†’            current_list.append(stripped[2:].strip())
   104â†’            metadata[current_key] = current_list
   105â†’        elif ':' in line and not line.startswith(' '):
   106â†’            current_list = None
   107â†’            key, value = line.split(':', 1)
   108â†’            current_key = key.strip()
   109â†’            value = value.strip()
   110â†’            if value in ('|', ''):
   111â†’                continue
   112â†’            elif value.lower() == 'true':
   113â†’                metadata[current_key] = True
   114â†’            elif value.lower() == 'false':
   115â†’                metadata[current_key] = False
   116â†’            else:
   117â†’                metadata[current_key] = value
   118â†’
   119â†’    return metadata, content.strip()
   120â†’
   121â†’
   122â†’def parse_skill_md(text: str) -> Dict[str, Any]:
   123â†’    """è§£æ SKILL.md å†…å®¹ï¼Œæå–ç»“æ„åŒ–ä¿¡æ¯"""
   124â†’    metadata, content = parse_frontmatter(text)
   125â†’
   126â†’    result = {
   127â†’        "id": metadata.get("id", ""),
   128â†’        "name": metadata.get("name", ""),
   129â†’        "description": metadata.get("description", ""),
   130â†’        "triggers": metadata.get("triggers", []),
   131â†’        "default_scenario": metadata.get("default_scenario", "basic_reading"),
   132â†’    }
   133â†’
   134â†’    # æå–ä¸“å®¶èº«ä»½
   135â†’    expert_match = re.search(r'## ä¸“å®¶èº«ä»½\s*\n(.*?)(?=\n## |\Z)', content, re.DOTALL)
   136â†’    result["expert_persona"] = expert_match.group(1).strip() if expert_match else ""
   137â†’
   138â†’    # æå–åœºæ™¯ç›®å½•
   139â†’    scenarios = {"entry": [], "standard": [], "professional": []}
   140â†’    for level in scenarios.keys():
   141â†’        pattern = rf'### {level.capitalize()}.*?\n\|.*?\n\|.*?\n((?:\|.*?\n)*)'
   142â†’        match = re.search(pattern, content, re.IGNORECASE | re.DOTALL)
   143â†’        if match:
   144â†’            for row in match.group(1).strip().split('\n'):
   145â†’                cols = [c.strip() for c in row.split('|')[1:-1]]
   146â†’                if len(cols) >= 2:
   147â†’                    scenarios[level].append(cols[1])  # æ–‡ä»¶å
   148â†’    result["scenarios"] = scenarios
   149â†’
   150â†’    # æå–ä¼¦ç†è¾¹ç•Œ
   151â†’    ethics = {"forbidden": [], "sensitive": [], "principles": []}
   152â†’    forbidden_match = re.search(r'### ç»å¯¹ç¦æ­¢\s*\n((?:- .*?\n)*)', content)
   153â†’    if forbidden_match:
   154â†’        ethics["forbidden"] = [l[2:].strip() for l in forbidden_match.group(1).strip().split('\n')]
   155â†’    result["ethics"] = ethics
   156â†’
   157â†’    # æå–å·¥å…·åˆ—è¡¨
   158â†’    tools = []
   159â†’    tools_match = re.search(r'## å·¥å…·åˆ—è¡¨\s*\n\|.*?\n\|.*?\n((?:\|.*?\n)*)', content)
   160â†’    if tools_match:
   161â†’        for row in tools_match.group(1).strip().split('\n'):
   162â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   163â†’            if len(cols) >= 1:
   164â†’                tools.append(cols[0])
   165â†’    result["tools"] = tools
   166â†’
   167â†’    return result
   168â†’
   169â†’
   170â†’def parse_scenario_md(text: str) -> Dict[str, Any]:
   171â†’    """è§£æ scenario.md å†…å®¹"""
   172â†’    metadata, content = parse_frontmatter(text)
   173â†’
   174â†’    result = {
   175â†’        "id": metadata.get("id", ""),
   176â†’        "name": metadata.get("name", ""),
   177â†’        "level": metadata.get("level", "entry"),
   178â†’        "billing": metadata.get("billing", "free"),
   179â†’        "description": metadata.get("description", ""),
   180â†’    }
   181â†’
   182â†’    # æå–è§¦å‘æ¡ä»¶
   183â†’    triggers = {"primary": [], "secondary": []}
   184â†’    primary_match = re.search(r'\*\*ä¸»è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   185â†’    if primary_match:
   186â†’        triggers["primary"] = [t.strip() for t in primary_match.group(1).split(',')]
   187â†’    secondary_match = re.search(r'\*\*æ¬¡è¦è§¦å‘è¯\*\*:\s*(.*?)(?:\n|$)', content)
   188â†’    if secondary_match:
   189â†’        triggers["secondary"] = [t.strip() for t in secondary_match.group(1).split(',')]
   190â†’    result["triggers"] = triggers
   191â†’
   192â†’    # æå–å‰ç½®è¦æ±‚
   193â†’    prereq_match = re.search(r'## å‰ç½®è¦æ±‚\s*\n((?:- .*?\n)*)', content)
   194â†’    result["prerequisites"] = []
   195â†’    if prereq_match:
   196â†’        result["prerequisites"] = [l[2:].strip() for l in prereq_match.group(1).strip().split('\n')]
   197â†’
   198â†’    # æå– SOP é˜¶æ®µ
   199â†’    sop = []
   200â†’    phase_pattern = r'### Phase (\d+):\s*(.*?)\n(.*?)(?=### Phase|\Z)'
   201â†’    for match in re.finditer(phase_pattern, content, re.DOTALL):
   202â†’        phase_num, phase_name, phase_content = match.groups()
   203â†’        phase = {
   204â†’            "phase": int(phase_num),
   205â†’            "name": phase_name.strip(),
   206â†’            "content": phase_content.strip()
   207â†’        }
   208â†’        # æå–ç±»å‹
   209â†’        type_match = re.search(r'\*\*ç±»å‹\*\*:\s*(\w+)', phase_content)
   210â†’        if type_match:
   211â†’            phase["type"] = type_match.group(1)
   212â†’        sop.append(phase)
   213â†’    result["sop"] = sop
   214â†’
   215â†’    # æå–å·¥å…·åˆ—è¡¨
   216â†’    tools_match = re.search(r'\*\*ä½¿ç”¨å·¥å…·\*\*:\s*\n((?:- .*?\n)*)', content)
   217â†’    result["tools"] = []
   218â†’    if tools_match:
   219â†’        result["tools"] = [l[2:].strip() for l in tools_match.group(1).strip().split('\n')]
   220â†’
   221â†’    # çŸ¥è¯†æ£€ç´¢é…ç½®
   222â†’    result["knowledge_config"] = {}
   223â†’    result["output_config"] = {}
   224â†’
   225â†’    return result
   226â†’
   227â†’
   228â†’def parse_skill_services(text: str) -> Dict[str, List[Dict[str, Any]]]:
   229â†’    """è§£æ SKILL.md ä¸­çš„æœåŠ¡ç›®å½•ï¼Œæå–å±•ç¤ºä¿¡æ¯"""
   230â†’    services = {"entry": [], "standard": [], "professional": []}
   231â†’
   232â†’    tier_map = {
   233â†’        "entry": "entry",
   234â†’        "standard": "standard",
   235â†’        "professional": "professional"
   236â†’    }
   237â†’
   238â†’    for tier_name, tier_key in tier_map.items():
   239â†’        # åŒ¹é…è¡¨æ ¼å¤´å’Œå†…å®¹
   240â†’        pattern = rf'### {tier_name.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   241â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   242â†’        if not match:
   243â†’            continue
   244â†’
   245â†’        table_content = match.group(1).strip()
   246â†’        if not table_content:
   247â†’            continue
   248â†’
   249â†’        for row in table_content.split('\n'):
   250â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   251â†’            if len(cols) < 7:  # è‡³å°‘éœ€è¦ 7 åˆ—ï¼ˆåœºæ™¯ã€æ–‡ä»¶ã€è§¦å‘è¯ã€è®¡è´¹ã€å±•ç¤ºåç§°ã€å›¾æ ‡ã€ç®€ä»‹ï¼‰
   252â†’                continue
   253â†’
   254â†’            service = {
   255â†’                "scenario_id": cols[1].replace('.md', '') if cols[1] else cols[0].lower().replace(' ', '_'),
   256â†’                "name": cols[4] if len(cols) > 4 and cols[4] else cols[0],
   257â†’                "icon": cols[5] if len(cols) > 5 and cols[5] else "ğŸ“Œ",
   258â†’                "description": cols[6] if len(cols) > 6 and cols[6] else "",
   259â†’                "tier": tier_key,
   260â†’                "billing": cols[3] if len(cols) > 3 else "å…è´¹",
   261â†’                "highlights": []
   262â†’            }
   263â†’
   264â†’            # è§£æä»·å€¼ç‚¹ï¼ˆç¬¬8åˆ—ï¼Œå¦‚æœå­˜åœ¨ï¼‰
   265â†’            if len(cols) > 7 and cols[7]:
   266â†’                service["highlights"] = [h.strip() for h in cols[7].split(',')]
   267â†’
   268â†’            services[tier_key].append(service)
   269â†’
   270â†’    return services
   271â†’
   272â†’
   273â†’def get_skill_services(skill_id: str) -> Optional[Dict[str, Any]]:
   274â†’    """è·å– Skill çš„æœåŠ¡ç›®å½•æ•°æ®ï¼ˆç”¨äº show_skill_services å·¥å…·ï¼‰"""
   275â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   276â†’    if not skill_path.exists():
   277â†’        return None
   278â†’
   279â†’    text = skill_path.read_text(encoding='utf-8')
   280â†’    metadata, _ = parse_frontmatter(text)
   281â†’    services = parse_skill_services(text)
   282â†’
   283â†’    return {
   284â†’        "skill_id": skill_id,
   285â†’        "skill_name": metadata.get("name", skill_id),
   286â†’        "description": metadata.get("description", ""),
   287â†’        "services": services
   288â†’    }
   289â†’
   290â†’
   291â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   292â†’# åŠ è½½å‡½æ•°
   293â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   294â†’
   295â†’@lru_cache(maxsize=32)
   296â†’def load_skill(skill_id: str) -> Optional[SkillConfig]:
   297â†’    """åŠ è½½ Skill æ ¸å¿ƒé…ç½®"""
   298â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   299â†’    if not skill_path.exists():
   300â†’        return None
   301â†’
   302â†’    text = skill_path.read_text(encoding='utf-8')
   303â†’    data = parse_skill_md(text)
   304â†’
   305â†’    return SkillConfig(
   306â†’        id=data.get("id", skill_id),
   307â†’        name=data.get("name", skill_id),
   308â†’        description=data.get("description", ""),
   309â†’        expert_persona=data.get("expert_persona", ""),
   310â†’        scenarios=data.get("scenarios", {}),
   311â†’        ethics=data.get("ethics", {}),
   312â†’        tools=data.get("tools", []),
   313â†’        default_scenario=data.get("default_scenario", "basic_reading"),
   314â†’        triggers=data.get("triggers", [])
   315â†’    )
   316â†’
   317â†’
   318â†’@lru_cache(maxsize=64)
   319â†’def load_scenario(skill_id: str, scenario_id: str) -> Optional[ScenarioConfig]:
   320â†’    """åŠ è½½åœºæ™¯é…ç½®"""
   321â†’    scenario_path = SKILLS_DIR / skill_id / "scenarios" / f"{scenario_id}.md"
   322â†’    if not scenario_path.exists():
   323â†’        return None
   324â†’
   325â†’    text = scenario_path.read_text(encoding='utf-8')
   326â†’    data = parse_scenario_md(text)
   327â†’
   328â†’    return ScenarioConfig(
   329â†’        id=data.get("id", scenario_id),
   330â†’        name=data.get("name", scenario_id),
   331â†’        level=data.get("level", "entry"),
   332â†’        billing=data.get("billing", "free"),
   333â†’        description=data.get("description", ""),
   334â†’        triggers=data.get("triggers", {}),
   335â†’        prerequisites=data.get("prerequisites", []),
   336â†’        sop=data.get("sop", []),
   337â†’        knowledge_config=data.get("knowledge_config", {}),
   338â†’        output_config=data.get("output_config", {}),
   339â†’        tools=data.get("tools", [])
   340â†’    )
   341â†’
   342â†’
   343â†’def get_available_skills() -> List[str]:
   344â†’    """è·å–æ‰€æœ‰å¯ç”¨çš„ Skill"""
   345â†’    if not SKILLS_DIR.exists():
   346â†’        return []
   347â†’    return [p.name for p in SKILLS_DIR.iterdir()
   348â†’            if p.is_dir() and (p / "SKILL.md").exists()]
   349â†’
   350â†’
   351â†’def get_skill_scenarios(skill_id: str) -> List[str]:
   352â†’    """è·å– Skill çš„æ‰€æœ‰åœºæ™¯"""
   353â†’    scenarios_dir = SKILLS_DIR / skill_id / "scenarios"
   354â†’    if not scenarios_dir.exists():
   355â†’        return []
   356â†’    return [p.stem for p in scenarios_dir.glob("*.md")]
   357â†’
   358â†’
   359â†’def get_skill_triggers() -> Dict[str, List[str]]:
   360â†’    """è·å–æ‰€æœ‰ Skill çš„è§¦å‘è¯"""
   361â†’    triggers = {}
   362â†’    for skill_id in get_available_skills():
   363â†’        if skill_id == "core":
   364â†’            continue
   365â†’        skill = load_skill(skill_id)
   366â†’        if skill and skill.triggers:
   367â†’            triggers[skill_id] = skill.triggers
   368â†’    return triggers
   369â†’
   370â†’
   371â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   372â†’# System Prompt æ„å»º
   373â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   374â†’
   375â†’def build_system_prompt(
   376â†’    skill_id: str,
   377â†’    scenario_id: Optional[str] = None,
   378â†’    user_context: Optional[Dict] = None
   379â†’) -> str:
   380â†’    """æ„å»ºå®Œæ•´çš„ System Prompt"""
   381â†’    parts = []
   382â†’
   383â†’    # åŠ è½½ Skill
   384â†’    skill = load_skill(skill_id)
   385â†’    if not skill:
   386â†’        return ""
   387â†’
   388â†’    # ä¸“å®¶èº«ä»½
   389â†’    parts.append(f"# {skill.name}\n\n{skill.expert_persona}")
   390â†’
   391â†’    # åŠ è½½åœºæ™¯
   392â†’    if scenario_id:
   393â†’        scenario = load_scenario(skill_id, scenario_id)
   394â†’        if scenario:
   395â†’            parts.append(f"\n---\n\n## å½“å‰åœºæ™¯: {scenario.name}\n\n{scenario.description}")
   396â†’
   397â†’            # SOP
   398â†’            if scenario.sop:
   399â†’                sop_text = "\n## æœåŠ¡æµç¨‹ (SOP)\n\n"
   400â†’                for phase in scenario.sop:
   401â†’                    sop_text += f"### Phase {phase['phase']}: {phase['name']}\n{phase['content']}\n\n"
   402â†’                parts.append(sop_text)
   403â†’
   404â†’    # ä¼¦ç†è¾¹ç•Œ
   405â†’    if skill.ethics.get("forbidden"):
   406â†’        ethics_text = "\n## ä¼¦ç†è¾¹ç•Œ\n\n### ç»å¯¹ç¦æ­¢\n"
   407â†’        for item in skill.ethics["forbidden"]:
   408â†’            ethics_text += f"- {item}\n"
   409â†’        parts.append(ethics_text)
   410â†’
   411â†’    # ç”¨æˆ·ä¸Šä¸‹æ–‡
   412â†’    if user_context:
   413â†’        ctx_text = "\n## ç”¨æˆ·ä¸Šä¸‹æ–‡\n"
   414â†’        if user_context.get("birth_info"):
   415â†’            ctx_text += f"\n### å‡ºç”Ÿä¿¡æ¯\n{json.dumps(user_context['birth_info'], ensure_ascii=False)}"
   416â†’        if user_context.get("portrait"):
   417â†’            ctx_text += f"\n### ç”¨æˆ·ç”»åƒ\n{user_context['portrait']}"
   418â†’        parts.append(ctx_text)
   419â†’
   420â†’    return "\n".join(parts)
   421â†’
   422â†’
   423â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   424â†’# ç¼“å­˜ç®¡ç†
   425â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   426â†’
   427â†’def clear_cache():
   428â†’    """æ¸…é™¤æ‰€æœ‰ç¼“å­˜"""
   429â†’    load_skill.cache_clear()
   430â†’    load_scenario.cache_clear()
   431â†’    logger.info("Skill cache cleared")
   432â†’
   433â†’
   434â†’def reload_skill(skill_id: str) -> Optional[SkillConfig]:
   435â†’    """é‡è½½å•ä¸ª Skill"""
   436â†’    load_skill.cache_clear()
   437â†’    load_scenario.cache_clear()
   438â†’    return load_skill(skill_id)
   439â†’
   440â†’
   441â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   442â†’# åœºæ™¯è·¯ç”± (å†…å­˜åŒ¹é…)
   443â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   444â†’
   445â†’def parse_scenario_triggers(text: str) -> Dict[str, Dict[str, List[str]]]:
   446â†’    """ä» SKILL.md è§£æåœºæ™¯ç›®å½•è¡¨æ ¼ï¼Œæå–è§¦å‘è¯"""
   447â†’    triggers = {}  # {scenario_id: {primary: [...], secondary: [...]}}
   448â†’
   449â†’    # åŒ¹é…ä¸‰ä¸ªçº§åˆ«çš„è¡¨æ ¼
   450â†’    for level in ["entry", "standard", "professional"]:
   451â†’        pattern = rf'### {level.capitalize()}.*?\n\|[^\n]+\n\|[-\s|]+\n((?:\|[^\n]+\n)*)'
   452â†’        match = re.search(pattern, text, re.IGNORECASE | re.DOTALL)
   453â†’        if not match:
   454â†’            continue
   455â†’
   456â†’        for row in match.group(1).strip().split('\n'):
   457â†’            cols = [c.strip() for c in row.split('|')[1:-1]]
   458â†’            if len(cols) >= 3:
   459â†’                # cols[1] = æ–‡ä»¶å, cols[2] = è§¦å‘è¯
   460â†’                scenario_id = cols[1].replace('.md', '')
   461â†’                trigger_str = cols[2]
   462â†’                # è§£æè§¦å‘è¯ï¼ˆç”¨é¡¿å·æˆ–é€—å·åˆ†éš”ï¼‰
   463â†’                trigger_words = [t.strip() for t in re.split(r'[ã€,ï¼Œ]', trigger_str) if t.strip()]
   464â†’                triggers[scenario_id] = {
   465â†’                    "primary": trigger_words,
   466â†’                    "secondary": []
   467â†’                }
   468â†’
   469â†’    return triggers
   470â†’
   471â†’
   472â†’@lru_cache(maxsize=32)
   473â†’def get_scenario_triggers(skill_id: str) -> Dict[str, Dict[str, List[str]]]:
   474â†’    """è·å– Skill çš„åœºæ™¯è§¦å‘è¯æ˜ å°„ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
   475â†’    skill_path = SKILLS_DIR / skill_id / "SKILL.md"
   476â†’    if not skill_path.exists():
   477â†’        return {}
   478â†’
   479â†’    text = skill_path.read_text(encoding='utf-8')
   480â†’    return parse_scenario_triggers(text)
   481â†’
   482â†’
   483â†’def route_scenario(skill_id: str, message: str) -> Optional[str]:
   484â†’    """
   485â†’    å†…å­˜åœºæ™¯è·¯ç”± - æ ¹æ®ç”¨æˆ·æ¶ˆæ¯åŒ¹é…æœ€ä½³åœºæ™¯
   486â†’
   487â†’    Args:
   488â†’        skill_id: Skill ID
   489â†’        message: ç”¨æˆ·æ¶ˆæ¯
   490â†’
   491â†’    Returns:
   492â†’        åŒ¹é…çš„ scenario_idï¼Œæ— åŒ¹é…åˆ™è¿”å› None
   493â†’    """
   494â†’    triggers = get_scenario_triggers(skill_id)
   495â†’    if not triggers:
   496â†’        return None
   497â†’
   498â†’    best_match = None
   499â†’    best_score = 0
   500â†’
   501â†’    for scenario_id, trigger_config in triggers.items():
   502â†’        score = 0
   503â†’        # ä¸»è¦è§¦å‘è¯æƒé‡ 1.0
   504â†’        for word in trigger_config.get("primary", []):
   505â†’            if word in message:
   506â†’                score += 1.0
   507â†’        # æ¬¡è¦è§¦å‘è¯æƒé‡ 0.5
   508â†’        for word in trigger_config.get("secondary", []):
   509â†’            if word in message:
   510â†’                score += 0.5
   511â†’
   512â†’        if score > best_score:
   513â†’            best_score = score
   514â†’            best_match = scenario_id
   515â†’
   516â†’    return best_match
   517â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
