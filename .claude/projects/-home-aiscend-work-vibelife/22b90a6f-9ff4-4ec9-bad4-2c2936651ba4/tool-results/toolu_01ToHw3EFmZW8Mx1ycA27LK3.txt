The file /home/aiscend/.claude/plans/swift-herding-peacock.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   608→- Stage 4a/4b CLI 参数继续可用（内部调用新的统一抽取器）
   609→
   610→---
   611→
   612→## 六、验证方案
   613→
   614→### 6.1 单元测试
   615→
   616→```python
   617→# test_unified_extractor.py
   618→
   619→async def test_extract_from_file_returns_both():
   620→    """验证单次文件处理能同时返回 Case 和 Scenario"""
   621→    extractor = UnifiedExtractor("bazi")
   622→    result = await extractor.extract_from_file(Path("test.md"))
   623→    assert "cases" in result
   624→    assert "scenarios" in result
   625→
   626→async def test_incremental_skips_unchanged_files():
   627→    """验证增量逻辑会跳过未修改的文件"""
   628→    # 首次运行
   629→    results1 = await extractor.process_pending_files()
   630→    # 再次运行（文件未变）
   631→    results2 = await extractor.process_pending_files()
   632→    assert results2["files_processed"] == 0
   633→
   634→async def test_md5_change_triggers_reextract():
   635→    """验证文件内容变化会触发重新抽取"""
   636→    # 首次运行
   637→    await extractor.process_pending_files()
   638→    # 修改文件内容
   639→    test_file.write_text(test_file.read_text() + "\n新内容")
   640→    # 再次运行
   641→    results = await extractor.process_pending_files()
   642→    assert results["files_processed"] == 1
   643→
   644→async def test_cases_saved_to_db_scenarios_to_files():
   645→    """验证 Cases 写入 DB，Scenarios 写入文件"""
   646→    results = await extractor.process_pending_files()
   647→    # 检查 DB
   648→    cases = await db.fetch("SELECT * FROM cases WHERE skill_id = 'bazi'")
   649→    assert len(cases) > 0
   650→    # 检查文件
   651→    scenario_files = list((extracted_dir / "scenarios").glob("*.md"))
   652→    assert len(scenario_files) > 0
   653→```
   654→
   655→### 6.2 端到端测试
   656→
   657→```bash
   658→# 1. 准备测试 MD 文件
   659→echo "# 测试章节\n\n乾隆案例分析..." > /data/vibelife/knowledge/bazi/converted/test.md
   660→
   661→# 2. 首次运行
   662→python build_knowledge.py --skill bazi --stages 4
   663→# 日志应显示 "1 file processed, X cases, Y scenarios"
   664→
   665→# 3. 验证结果
   666→# 检查 DB
   667→psql -c "SELECT COUNT(*), source_file FROM cases WHERE skill_id = 'bazi' GROUP BY source_file;"
   668→# 检查文件
   669→ls /data/vibelife/knowledge/bazi/extracted/scenarios/
   670→cat /data/vibelife/knowledge/bazi/extracted/extraction_log.json
   671→
   672→# 4. 再次运行（应该跳过已处理的）
   673→python build_knowledge.py --skill bazi --stages 4
   674→# 日志应显示 "0 files to process (all up to date)"
   675→
   676→# 5. 修改源文件触发重新抽取
   677→echo "\n新增内容" >> /data/vibelife/knowledge/bazi/converted/test.md
   678→python build_knowledge.py --skill bazi --stages 4
   679→# 日志应显示 "1 file processed (content changed)"
   680→
   681→# 6. 强制全部重新抽取
   682→python build_knowledge.py --skill bazi --stages 4 --force-reextract
   683→# 日志应显示所有文件都被处理
   684→```
   685→
   686→---
   687→
   688→## 七、后续可选优化