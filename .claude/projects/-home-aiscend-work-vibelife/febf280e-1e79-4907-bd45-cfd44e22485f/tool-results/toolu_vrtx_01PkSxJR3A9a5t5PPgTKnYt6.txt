   500→            # 失效缓存
   501→            await UnifiedProfileRepository._invalidate_cache(user_id)
   502→
   503→    @staticmethod
   504→    async def update_deletion_status(
   505→        user_id: UUID,
   506→        status: str,
   507→        deletion_requested_at: datetime = None,
   508→        deletion_scheduled_at: datetime = None
   509→    ) -> None:
   510→        """
   511→        更新账户删除状态 (Migration 022 compatible)
   512→
   513→        Post-Migration 022:
   514→        - status: 更新 vibe_users.status (触发器自动同步到 unified_profiles)
   515→        - deletion_*: 只存在于 unified_profiles.profile.account
   516→
   517→        Args:
   518→            user_id: 用户 ID
   519→            status: 账户状态 ('active' | 'pending_deletion' | 'deleted')
   520→            deletion_requested_at: 删除请求时间
   521→            deletion_scheduled_at: 计划删除时间
   522→        """
   523→        from .user_repo import UserRepository
   524→
   525→        # Update status in vibe_users (trigger will sync to unified_profiles)
   526→        await UserRepository.update(user_id, status=status)
   527→
   528→        # Update deletion timestamps in unified_profiles (vibe_users doesn't have these fields)
   529→        if deletion_requested_at is not None or deletion_scheduled_at is not None:
   530→            async with get_connection() as conn:
   531→                account_updates = {}
   532→                if deletion_requested_at is not None:
   533→                    account_updates['deletion_requested_at'] = deletion_requested_at.isoformat() if deletion_requested_at else None
   534→                if deletion_scheduled_at is not None:
   535→                    account_updates['deletion_scheduled_at'] = deletion_scheduled_at.isoformat() if deletion_scheduled_at else None
   536→
   537→                # Update unified_profiles.profile.account with deletion timestamps
   538→                for key, value in account_updates.items():
   539→                    await conn.execute(
   540→                        """
   541→                        UPDATE unified_profiles
   542→                        SET profile = jsonb_set(
   543→                            COALESCE(profile, '{}'::jsonb),
   544→                            $2,
   545→                            to_jsonb($3::text),
   546→                            true
   547→                        ),
   548→                        updated_at = NOW()
   549→                        WHERE user_id = $1
   550→                        """,
   551→                        user_id,
   552→                        ['account', key],
   553→                        value
   554→                    )
   555→
   556→        # 失效缓存
   557→        await UnifiedProfileRepository._invalidate_cache(user_id)
   558→
   559→    @staticmethod
   560→    async def update_life_context(user_id: UUID, life_context: Dict[str, Any]) -> None:
   561→        """更新生活上下文 (使用 jsonb_set 局部更新)"""
   562→        exists = await fetchval(
   563→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   564→            user_id
   565→        )
   566→
   567→        if exists:
   568→            # 合并现有上下文
   569→            current_ctx = await UnifiedProfileRepository.get_life_context(user_id)
   570→            merged_ctx = deep_merge(current_ctx, life_context)
   571→
   572→            await execute(
   573→                """UPDATE unified_profiles
   574→                   SET profile = jsonb_set(
   575→                       COALESCE(profile, '{}'::jsonb),
   576→                       '{life_context}',
   577→                       $2::jsonb
   578→                   ),
   579→                   updated_at = NOW()
   580→                   WHERE user_id = $1""",
   581→                user_id, json.dumps(merged_ctx, ensure_ascii=False, default=str)
   582→            )
   583→        else:
   584→            await UnifiedProfileRepository.create_profile(user_id, {"life_context": life_context})
   585→
   586→        await UnifiedProfileRepository._invalidate_cache(user_id)
   587→
   588→    # ═══════════════════════════════════════════════════════════════════════════
   589→    # State 管理 (v7.7 新增)
   590→    # ═══════════════════════════════════════════════════════════════════════════
   591→
   592→    @staticmethod
   593→    async def update_state(user_id: UUID, state: Dict[str, Any]) -> None:
   594→        """
   595→        更新用户状态 (使用 jsonb_set 局部更新)
   596→
   597→        Args:
   598→            user_id: 用户 ID
   599→            state: 状态数据 {focus: [...], updated_at: ...}

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
