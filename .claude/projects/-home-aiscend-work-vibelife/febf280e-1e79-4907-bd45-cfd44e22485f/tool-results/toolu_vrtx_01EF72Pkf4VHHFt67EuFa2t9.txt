     1â†’/home/aiscend/work/vibelife/CORE.md-123-psql -f migrations/002_interview_sessions.sql
     2â†’/home/aiscend/work/vibelife/CORE.md-124-psql -f migrations/003_model_router.sql
     3â†’/home/aiscend/work/vibelife/CORE.md-125-psql -f migrations/004_update_model_routes.sql
     4â†’CORE.md:126:psql -f migrations/005_user_gender_voice_mode.sql
     5â†’/home/aiscend/work/vibelife/CORE.md-127-psql -f migrations/006_fix_knowledge_table_refs.sql
     6â†’/home/aiscend/work/vibelife/CORE.md-128-psql -f migrations/007_skill_terms.sql
     7â†’/home/aiscend/work/vibelife/CORE.md-129-psql -f migrations/008_knowledge_converted_path.sql
     8â†’--
     9â†’/home/aiscend/work/vibelife/CORE.md-269-| vibe_users | id (UUID) | vibe_id, email, phone, is_guest |
    10â†’/home/aiscend/work/vibelife/CORE.md-270-| user_auth | id | user_id, auth_type, auth_identifier, password_hash |
    11â†’/home/aiscend/work/vibelife/CORE.md-271-| user_profiles | id | user_id, version, profile (JSONB) |
    12â†’CORE.md:272:| conversations | id | user_id, skill, voice_mode |
    13â†’/home/aiscend/work/vibelife/CORE.md-273-| messages | id | conversation_id, role, content |
    14â†’/home/aiscend/work/vibelife/CORE.md-274-| reports | id | user_id, skill, report_type, content (JSONB), is_paid |
    15â†’/home/aiscend/work/vibelife/CORE.md-275-| relationships | id | initiator_id, partner_id, analysis (JSONB) |
    16â†’--
    17â†’/home/aiscend/work/vibelife/CORE.md-296-
    18â†’/home/aiscend/work/vibelife/CORE.md-297-## 10. äººæ ¼ç³»ç»Ÿ
    19â†’/home/aiscend/work/vibelife/CORE.md-298-
    20â†’CORE.md:299:| äººæ ¼ | voice_mode | é£æ ¼ |
    21â†’/home/aiscend/work/vibelife/CORE.md-300-|------|------------|------|
    22â†’/home/aiscend/work/vibelife/CORE.md-301-| æš–å¿ƒå‘å¯¼ | warm | å…±æƒ…ã€æ”¯æŒã€é¼“åŠ± |
    23â†’/home/aiscend/work/vibelife/CORE.md-302-| æ¯’èˆŒæŸå‹ | sarcastic | ç›´æ¥ã€çŠ€åˆ©ã€æœ‰è¶£ |
    24â†’/home/aiscend/work/vibelife/CORE.md-303-| äººç”Ÿå¯¼å¸ˆ | wise | ç†æ€§ã€æ·±åº¦ã€åƒé•¿è¾ˆæŒ‡ç‚¹ |
    25â†’/home/aiscend/work/vibelife/CORE.md-304-
    26â†’CORE.md:305:å­˜å‚¨: `user_profiles.profile.preferences.voice_mode`
    27â†’/home/aiscend/work/vibelife/CORE.md-306-
    28â†’/home/aiscend/work/vibelife/CORE.md-307----
    29â†’/home/aiscend/work/vibelife/CORE.md-308-
    30â†’--
    31â†’migrations/005_user_gender_voice_mode.sql:1:-- Migration: Add gender field and update voice_mode constraint
    32â†’migrations/005_user_gender_voice_mode.sql-2--- Based on: user-flow-design-v2.1.md, vibelife spec v3.0.md
    33â†’migrations/005_user_gender_voice_mode.sql-3--- Created: 2026-01-09
    34â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-4-
    35â†’--
    36â†’migrations/005_user_gender_voice_mode.sql-13-COMMENT ON COLUMN vibe_users.gender IS 'User gender for persona name adaptation: male/female/private';
    37â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-14-
    38â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-15--- ============================================================================
    39â†’migrations/005_user_gender_voice_mode.sql:16:-- UPDATE VOICE_MODE CONSTRAINT (add wise mode)
    40â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-17--- ============================================================================
    41â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-18-
    42â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-19--- Drop old constraint and add new one with 3 voice modes
    43â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-20-ALTER TABLE conversations
    44â†’migrations/005_user_gender_voice_mode.sql:21:DROP CONSTRAINT IF EXISTS conversations_voice_mode_check;
    45â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-22-
    46â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-23-ALTER TABLE conversations
    47â†’migrations/005_user_gender_voice_mode.sql:24:ADD CONSTRAINT conversations_voice_mode_check
    48â†’migrations/005_user_gender_voice_mode.sql:25:CHECK (voice_mode IN ('warm', 'sarcastic', 'wise'));
    49â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-26-
    50â†’migrations/005_user_gender_voice_mode.sql:27:-- Update default voice_mode in user_profiles JSONB
    51â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-28--- (This is informational - actual default is handled in code)
    52â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-29-
    53â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-30--- ============================================================================
    54â†’migrations/005_user_gender_voice_mode.sql:31:-- ADD VOICE_MODE TO SKILL_PROFILES (if table exists)
    55â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-32--- ============================================================================
    56â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-33-
    57â†’migrations/005_user_gender_voice_mode.sql:34:-- Check if skill_profiles table exists and add voice_mode column
    58â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-35-DO $$
    59â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-36-BEGIN
    60â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-37-    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'skill_profiles') THEN
    61â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-38-        ALTER TABLE skill_profiles
    62â†’migrations/005_user_gender_voice_mode.sql:39:        ADD COLUMN IF NOT EXISTS voice_mode VARCHAR(20) DEFAULT 'warm'
    63â†’migrations/005_user_gender_voice_mode.sql:40:        CHECK (voice_mode IN ('warm', 'sarcastic', 'wise'));
    64â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-41-    END IF;
    65â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-42-END $$;
    66â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-43-
    67â†’--
    68â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-49-    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    69â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-50-    user_id UUID NOT NULL REFERENCES vibe_users(id) ON DELETE CASCADE,
    70â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-51-    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac', 'mbti', 'tarot')),
    71â†’migrations/005_user_gender_voice_mode.sql:52:    voice_mode VARCHAR(20) DEFAULT 'warm' CHECK (voice_mode IN ('warm', 'sarcastic', 'wise')),
    72â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-53-    profile_data JSONB DEFAULT '{}',  -- interview_responses, preferences, etc.
    73â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-54-    first_use_at TIMESTAMPTZ DEFAULT NOW(),
    74â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-55-    last_use_at TIMESTAMPTZ DEFAULT NOW(),
    75â†’--
    76â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-62-CREATE INDEX IF NOT EXISTS idx_skill_profiles_user_id ON skill_profiles(user_id);
    77â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-63-CREATE INDEX IF NOT EXISTS idx_skill_profiles_skill ON skill_profiles(skill);
    78â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-64-
    79â†’migrations/005_user_gender_voice_mode.sql:65:COMMENT ON TABLE skill_profiles IS 'Per-skill user profiles with voice_mode preference';
    80â†’migrations/005_user_gender_voice_mode.sql:66:COMMENT ON COLUMN skill_profiles.voice_mode IS 'Persona voice mode: warm (æš–å¿ƒé—ºèœœ), sarcastic (æ¯’èˆŒæŸå‹), wise (äººç”Ÿå¯¼å¸ˆ)';
    81â†’/home/aiscend/work/vibelife/migrations/005_user_gender_voice_mode.sql-67-COMMENT ON COLUMN skill_profiles.profile_data IS 'JSONB storage for interview_responses and other skill-specific data';
    82â†’--
    83â†’migrations/016_deprecate_old_profile_tables.sql-33-        EXECUTE 'COMMENT ON TABLE skill_profiles IS ''âš ï¸ DEPRECATED: æ­¤è¡¨å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ unified_profiles è¡¨ã€‚
    84â†’/home/aiscend/work/vibelife/migrations/016_deprecate_old_profile_tables.sql-34-è¿ç§»æŒ‡å—ï¼š
    85â†’/home/aiscend/work/vibelife/migrations/016_deprecate_old_profile_tables.sql-35-- skill_profiles.profile_data â†’ unified_profiles.profile.preferences
    86â†’migrations/016_deprecate_old_profile_tables.sql:36:- skill_profiles.voice_mode â†’ unified_profiles.profile.preferences.voice_mode
    87â†’/home/aiscend/work/vibelife/migrations/016_deprecate_old_profile_tables.sql-37-ä¿ç•™æ­¤è¡¨ç”¨äºå›æ»šå’Œæ•°æ®éªŒè¯ã€‚''';
    88â†’/home/aiscend/work/vibelife/migrations/016_deprecate_old_profile_tables.sql-38-    END IF;
    89â†’/home/aiscend/work/vibelife/migrations/016_deprecate_old_profile_tables.sql-39-END $$;
    90â†’--
    91â†’migrations/016_deprecate_old_profile_tables.sql-46-- birth_info: å‡ºç”Ÿä¿¡æ¯ (date, time, place, gender, timezone)
    92â†’migrations/016_deprecate_old_profile_tables.sql-47-- life_context: ç”Ÿæ´»ä¸Šä¸‹æ–‡
    93â†’migrations/016_deprecate_old_profile_tables.sql-48-- identity_prism: èº«ä»½æ£±é•œ
    94â†’migrations/016_deprecate_old_profile_tables.sql:49:- preferences: ç”¨æˆ·åå¥½ (voice_mode, language)
    95â†’migrations/016_deprecate_old_profile_tables.sql-50-- skill_data: Skill æ•°æ® (bazi, zodiac ç­‰å‘½ç›˜æ•°æ®)
    96â†’/home/aiscend/work/vibelife/migrations/016_deprecate_old_profile_tables.sql-51-
    97â†’/home/aiscend/work/vibelife/migrations/016_deprecate_old_profile_tables.sql-52-ä½¿ç”¨ jsonb_set() è¿›è¡Œå±€éƒ¨æ›´æ–°ï¼Œé¿å…é‡å†™æ•´ä¸ª profileã€‚';
    98â†’--
    99â†’migrations/001_v3_schema.sql-52-        "ai_insights": {},
   100â†’migrations/001_v3_schema.sql-53-        "identity_prism": {},
   101â†’migrations/001_v3_schema.sql-54-        "preferences": {
   102â†’migrations/001_v3_schema.sql:55:            "voice_mode": "warm",
   103â†’migrations/001_v3_schema.sql-56-            "language": "zh-CN"
   104â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-57-        }
   105â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-58-    }',
   106â†’--
   107â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-69-    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   108â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-70-    user_id UUID REFERENCES vibe_users(id) ON DELETE SET NULL,
   109â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-71-    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac')),
   110â†’migrations/001_v3_schema.sql:72:    voice_mode VARCHAR(20) DEFAULT 'warm' CHECK (voice_mode IN ('warm', 'sarcastic')),
   111â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-73-    title VARCHAR(255),  -- ä¼šè¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
   112â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-74-    is_active BOOLEAN DEFAULT TRUE,
   113â†’/home/aiscend/work/vibelife/migrations/001_v3_schema.sql-75-    created_at TIMESTAMPTZ DEFAULT NOW(),
   114â†’--
   115â†’/home/aiscend/work/vibelife/migrations/011_guest_sessions.sql-14-    birth_datetime TIMESTAMPTZ,
   116â†’/home/aiscend/work/vibelife/migrations/011_guest_sessions.sql-15-    birth_location VARCHAR(255),
   117â†’/home/aiscend/work/vibelife/migrations/011_guest_sessions.sql-16-    gender VARCHAR(20),  -- male | female | private
   118â†’migrations/011_guest_sessions.sql:17:    voice_mode VARCHAR(20) DEFAULT 'warm',  -- warm | sarcastic | wise
   119â†’/home/aiscend/work/vibelife/migrations/011_guest_sessions.sql-18-    skill VARCHAR(50),  -- bazi | zodiac
   120â†’/home/aiscend/work/vibelife/migrations/011_guest_sessions.sql-19-    interview_responses JSONB DEFAULT '{}',
   121â†’/home/aiscend/work/vibelife/migrations/011_guest_sessions.sql-20-    focus_areas JSONB DEFAULT '[]',
   122â†’--
   123â†’/home/aiscend/work/vibelife/apps/web/src/hooks/useVibeChat.ts-64-    () => ({
   124â†’apps/web/src/hooks/useVibeChat.ts-65-      ...(skillId && { skill: skillId }),
   125â†’/home/aiscend/work/vibelife/apps/web/src/hooks/useVibeChat.ts-66-      ...(scenario && { scenario }),
   126â†’apps/web/src/hooks/useVibeChat.ts:67:      voice_mode: voiceMode,
   127â†’apps/web/src/hooks/useVibeChat.ts-68-      conversation_id: conversationId,
   128â†’/home/aiscend/work/vibelife/apps/web/src/hooks/useVibeChat.ts-69-    }),
   129â†’/home/aiscend/work/vibelife/apps/web/src/hooks/useVibeChat.ts-70-    [skillId, scenario, voiceMode, conversationId]
   130â†’--
   131â†’apps/web/src/skills/bazi/tools/show-fortune.tsx-56-  profile: unknown;
   132â†’apps/web/src/skills/bazi/tools/show-fortune.tsx-57-  cycles: MajorCycle[];
   133â†’apps/web/src/skills/bazi/tools/show-fortune.tsx-58-  annual: AnnualFortune | null;
   134â†’apps/web/src/skills/bazi/tools/show-fortune.tsx:59:  voice_mode: string;
   135â†’/home/aiscend/work/vibelife/apps/web/src/skills/bazi/tools/show-fortune.tsx-60-}
   136â†’/home/aiscend/work/vibelife/apps/web/src/skills/bazi/tools/show-fortune.tsx-61-
   137â†’apps/web/src/skills/bazi/tools/show-fortune.tsx-62-function getOrCreateGuestUserId(): string {
   138â†’--
   139â†’apps/web/src/skills/bazi/tools/show-fortune.tsx-132-      profile: { basic: { birth_year: 1990, day_master_element: dayMasterElement, gender: "unknown" } },
   140â†’/home/aiscend/work/vibelife/apps/web/src/skills/bazi/tools/show-fortune.tsx-133-      cycles,
   141â†’/home/aiscend/work/vibelife/apps/web/src/skills/bazi/tools/show-fortune.tsx-134-      annual,
   142â†’apps/web/src/skills/bazi/tools/show-fortune.tsx:135:      voice_mode: "warm",
   143â†’/home/aiscend/work/vibelife/apps/web/src/skills/bazi/tools/show-fortune.tsx-136-    };
   144â†’/home/aiscend/work/vibelife/apps/web/src/skills/bazi/tools/show-fortune.tsx-137-  },
   145â†’/home/aiscend/work/vibelife/apps/web/src/skills/bazi/tools/show-fortune.tsx-138-
   146â†’--
   147â†’/home/aiscend/work/vibelife/apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx-107-    switch (key) {
   148â†’apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx-108-      case 'push_enabled':
   149â†’/home/aiscend/work/vibelife/apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx-109-        return subscription?.push_enabled ?? defaultValue;
   150â†’apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx:110:      case 'voice_mode':
   151â†’apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx:111:        return userSettings.voice_mode ?? defaultValue;
   152â†’apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx-112-      case 'reminder_hour':
   153â†’/home/aiscend/work/vibelife/apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx-113-        return userSettings.reminder_hour ?? defaultValue;
   154â†’apps/web/src/skills/shared/SkillIntroCard/SettingsSection.tsx-114-      default:
   155â†’--
   156â†’/home/aiscend/work/vibelife/apps/web/src/skills/shared/SkillIntroCard/types.ts-98-
   157â†’/home/aiscend/work/vibelife/apps/web/src/skills/shared/SkillIntroCard/types.ts-99-export interface UserSkillSettings {
   158â†’apps/web/src/skills/shared/SkillIntroCard/types.ts-100-  skill_id: string;
   159â†’apps/web/src/skills/shared/SkillIntroCard/types.ts:101:  voice_mode?: 'warm' | 'direct' | 'playful';
   160â†’apps/web/src/skills/shared/SkillIntroCard/types.ts-102-  reminder_hour?: number;
   161â†’apps/web/src/skills/shared/SkillIntroCard/types.ts-103-  custom_settings?: Record<string, unknown>;
   162â†’/home/aiscend/work/vibelife/apps/web/src/skills/shared/SkillIntroCard/types.ts-104-}
   163â†’--
   164â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-94-  const [activeTab, setActiveTab] = useState<TabType>(defaultTab);
   165â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-95-  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic">("warm");
   166â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-96-
   167â†’apps/web/src/components/layout/AppShell.tsx:97:  // Load voice_mode from backend on mount
   168â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-98-  useEffect(() => {
   169â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-99-    const loadPreferences = async () => {
   170â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-100-      try {
   171â†’apps/web/src/components/layout/AppShell.tsx:101:        const response = await apiClient.get<{ voice_mode: string; language: string }>("/preferences");
   172â†’apps/web/src/components/layout/AppShell.tsx:102:        if (response.data?.voice_mode) {
   173â†’apps/web/src/components/layout/AppShell.tsx:103:          setVoiceModeState(response.data.voice_mode as "warm" | "sarcastic");
   174â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-104-        }
   175â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-105-      } catch (error) {
   176â†’apps/web/src/components/layout/AppShell.tsx-106-        console.error("Failed to load preferences:", error);
   177â†’--
   178â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-109-    loadPreferences();
   179â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-110-  }, []);
   180â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-111-
   181â†’apps/web/src/components/layout/AppShell.tsx:112:  // Save voice_mode to backend when changed
   182â†’apps/web/src/components/layout/AppShell.tsx-113-  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic") => {
   183â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-114-    setVoiceModeState(mode);
   184â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-115-    try {
   185â†’apps/web/src/components/layout/AppShell.tsx:116:      await apiClient.put("/preferences", { voice_mode: mode });
   186â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-117-    } catch (error) {
   187â†’apps/web/src/components/layout/AppShell.tsx:118:      console.error("Failed to save voice_mode:", error);
   188â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-119-    }
   189â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-120-  }, []);
   190â†’/home/aiscend/work/vibelife/apps/web/src/components/layout/AppShell.tsx-121-
   191â†’--
   192â†’apps/web/src/lib/api.ts-25-  message: string;
   193â†’apps/web/src/lib/api.ts-26-  skill: string;           // Changed from skill_id to match backend
   194â†’apps/web/src/lib/api.ts-27-  conversation_id?: string;
   195â†’apps/web/src/lib/api.ts:28:  voice_mode?: string;     // Added voice mode support
   196â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-29-}
   197â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-30-
   198â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-31-export interface ChatResponse {
   199â†’--
   200â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-203-export interface StreamChatResult {
   201â†’apps/web/src/lib/api.ts-204-  conversation_id?: string;
   202â†’apps/web/src/lib/api.ts-205-  skill?: string;
   203â†’apps/web/src/lib/api.ts:206:  voice_mode?: string;
   204â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-207-}
   205â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-208-
   206â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-209-export async function streamChat(
   207â†’--
   208â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-261-              onDone({
   209â†’apps/web/src/lib/api.ts-262-                conversation_id: data.conversation_id,
   210â†’apps/web/src/lib/api.ts-263-                skill: data.skill,
   211â†’apps/web/src/lib/api.ts:264:                voice_mode: data.voice_mode,
   212â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-265-              });
   213â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-266-              return;
   214â†’/home/aiscend/work/vibelife/apps/web/src/lib/api.ts-267-            } else if (data.type === "error") {
   215â†’--
   216â†’apps/web/src/lib/api.ts-415-  birth_datetime?: string;
   217â†’apps/web/src/lib/api.ts-416-  birth_location?: string;
   218â†’apps/web/src/lib/api.ts-417-  gender?: string;
   219â†’apps/web/src/lib/api.ts:418:  voice_mode?: string;
   220â†’apps/web/src/lib/api.ts-419-  skill?: string;
   221â†’apps/web/src/lib/api.ts-420-  interview_responses?: Record<string, unknown>;
   222â†’apps/web/src/lib/api.ts-421-  focus_areas?: string[];
   223â†’--
   224â†’apps/web/src/lib/api.ts-426-  birth_datetime?: string;
   225â†’apps/web/src/lib/api.ts-427-  birth_location?: string;
   226â†’apps/web/src/lib/api.ts-428-  gender?: string;
   227â†’apps/web/src/lib/api.ts:429:  voice_mode?: string;
   228â†’apps/web/src/lib/api.ts-430-  skill?: string;
   229â†’apps/web/src/lib/api.ts-431-  interview_responses?: Record<string, unknown>;
   230â†’apps/web/src/lib/api.ts-432-  focus_areas?: string[];
   231â†’--
   232â†’/home/aiscend/work/vibelife/apps/web/src/app/test/page.tsx-158-        const res = await fetch(`/api/proxy?endpoint=${encodeURIComponent(endpoint)}`, {
   233â†’apps/web/src/app/test/page.tsx-159-          method: "POST",
   234â†’apps/web/src/app/test/page.tsx-160-          headers: { "Content-Type": "application/json", ...(t && { Authorization: `Bearer ${t}` }) },
   235â†’apps/web/src/app/test/page.tsx:161:          body: JSON.stringify({ message: msg, skill, conversation_id: conversationId, voice_mode: "warm" }),
   236â†’/home/aiscend/work/vibelife/apps/web/src/app/test/page.tsx-162-        });
   237â†’/home/aiscend/work/vibelife/apps/web/src/app/test/page.tsx-163-
   238â†’/home/aiscend/work/vibelife/apps/web/src/app/test/page.tsx-164-        const reader = res.body?.getReader();
   239â†’--
   240â†’apps/web/src/app/test/page.tsx-325-        birth_datetime: `${birthData.birth_date}T${birthData.birth_time}:00`,
   241â†’apps/web/src/app/test/page.tsx-326-        birth_location: birthData.birth_location,
   242â†’apps/web/src/app/test/page.tsx-327-        gender: birthData.gender,
   243â†’apps/web/src/app/test/page.tsx:328:        voice_mode: "warm",
   244â†’apps/web/src/app/test/page.tsx-329-        skill: skill,
   245â†’apps/web/src/app/test/page.tsx-330-        focus_areas: ["äº‹ä¸š", "æ„Ÿæƒ…"],
   246â†’apps/web/src/app/test/page.tsx-331-      }), desc: "PUT /guest/session/onboarding" },
   247â†’--
   248â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-869-# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   249â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-870-
   250â†’apps/api/services/agent/skill_loader.py-871-# V2: è¯­æ°”æ¨¡å¼ Prompt æ¨¡æ¿
   251â†’apps/api/services/agent/skill_loader.py:872:VOICE_MODE_PROMPTS = {
   252â†’apps/api/services/agent/skill_loader.py-873-    "warm": """## è¯­æ°”é£æ ¼ï¼šæ¸©æš–æ”¯æŒå‹
   253â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-874-åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿã€‚
   254â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-875-- ç”¨"æˆ‘ä»¬"è€Œé"ä½ åº”è¯¥"
   255â†’--
   256â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1001-    """æ„å»ºå®Œæ•´çš„ System Prompt
   257â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1002-
   258â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1003-    v7 æ›´æ–°ï¼šæ”¯æŒ rules æ¶æ„ï¼Œscenario_id å¯ä»¥æ˜¯ rule_id
   259â†’apps/api/services/agent/skill_loader.py:1004:    v8 æ›´æ–°ï¼šæ”¯æŒ persona å’Œ voice_mode æ³¨å…¥
   260â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1005-    """
   261â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1006-    parts = []
   262â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1007-
   263â†’--
   264â†’apps/api/services/agent/skill_loader.py-1021-    # V2: Voice Mode æ³¨å…¥
   265â†’apps/api/services/agent/skill_loader.py-1022-    if user_context:
   266â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1023-        preferences = user_context.get("preferences", {})
   267â†’apps/api/services/agent/skill_loader.py:1024:        voice_mode = preferences.get("voice_mode", "warm")
   268â†’apps/api/services/agent/skill_loader.py:1025:        if voice_mode in VOICE_MODE_PROMPTS:
   269â†’apps/api/services/agent/skill_loader.py:1026:            parts.append(VOICE_MODE_PROMPTS[voice_mode])
   270â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1027-
   271â†’/home/aiscend/work/vibelife/apps/api/services/agent/skill_loader.py-1028-    # åŠ è½½åœºæ™¯æˆ–è§„åˆ™
   272â†’apps/api/services/agent/skill_loader.py-1029-    if scenario_id:
   273â†’--
   274â†’apps/api/services/agent/core.py-74-    skill: Optional[str] = None
   275â†’apps/api/services/agent/core.py-75-    scenario: Optional[str] = None
   276â†’apps/api/services/agent/core.py-76-    conversation_id: Optional[str] = None
   277â†’apps/api/services/agent/core.py:77:    voice_mode: Optional[str] = "warm"
   278â†’apps/api/services/agent/core.py-78-    protocol_prompt: Optional[str] = None  # åè®®æ¨¡å¼ä¸“ç”¨ prompt
   279â†’/home/aiscend/work/vibelife/apps/api/services/agent/core.py-79-
   280â†’/home/aiscend/work/vibelife/apps/api/services/agent/core.py-80-
   281â†’--
   282â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-3-
   283â†’apps/api/services/proactive/content_generator.py-4-ç‰¹ç‚¹:
   284â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-5-1. åŸºäº life_context ä¸ªæ€§åŒ–
   285â†’apps/api/services/proactive/content_generator.py:6:2. æ”¯æŒå¤šç§è¯­æ°”é£æ ¼ (voice_mode)
   286â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-7-3. ä½¿ç”¨ LLM ç”Ÿæˆè‡ªç„¶è¯­è¨€å†…å®¹
   287â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-8-4. æ”¯æŒå¤ç”¨ rules/ æ¶æ„ç”Ÿæˆå†…å®¹
   288â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-9-5. æ”¯æŒå¯¹è¯å¼•å¯¼é…ç½®
   289â†’--
   290â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-290-        # è·å–ç”¨æˆ·ç‰¹å¾
   291â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-291-        life_context = profile.get("life_context", {})
   292â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-292-        preferences = profile.get("preferences", {})
   293â†’apps/api/services/proactive/content_generator.py:293:        voice_mode = preferences.get("voice_mode", "warm")
   294â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-294-
   295â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-295-        # æ„å»º prompt
   296â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-296-        context_str = "\n".join([
   297â†’--
   298â†’apps/api/services/proactive/content_generator.py-312-                "goals": goals[:2] if goals else [],
   299â†’apps/api/services/proactive/content_generator.py-313-                "date": date.today().strftime("%Yå¹´%mæœˆ%dæ—¥"),
   300â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-314-            },
   301â†’apps/api/services/proactive/content_generator.py:315:            voice_mode=voice_mode,
   302â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-316-        )
   303â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-317-
   304â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-318-        # ä½¿ç”¨é…ç½®æ¨¡æ¿è·å– title/bodyï¼ŒLLM ç»“æœä½œä¸º fallback
   305â†’--
   306â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-356-        # è·å–ç”¨æˆ·å…³æ³¨ç‚¹
   307â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-357-        concerns = life_context.get("concerns", [])
   308â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-358-        goals = life_context.get("goals", [])
   309â†’apps/api/services/proactive/content_generator.py:359:        voice_mode = preferences.get("voice_mode", "warm")
   310â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-360-
   311â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-361-        # è®¡ç®—ä»Šæ—¥è¿åŠ¿
   312â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-362-        from skills.bazi.services import BaziComputer
   313â†’--
   314â†’apps/api/services/proactive/content_generator.py-371-                "daily_fortune": daily_fortune,
   315â†’apps/api/services/proactive/content_generator.py-372-                "concerns": concerns[:3] if concerns else [],
   316â†’apps/api/services/proactive/content_generator.py-373-                "goals": goals[:2] if goals else [],
   317â†’apps/api/services/proactive/content_generator.py:374:                "voice_mode": voice_mode,
   318â†’apps/api/services/proactive/content_generator.py-375-                "date": date.today().strftime("%Yå¹´%mæœˆ%dæ—¥"),
   319â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-376-            },
   320â†’apps/api/services/proactive/content_generator.py:377:            voice_mode=voice_mode,
   321â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-378-        )
   322â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-379-
   323â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-380-        return ReminderContent(
   324â†’--
   325â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-733-        self,
   326â†’apps/api/services/proactive/content_generator.py-734-        template_type: str,
   327â†’apps/api/services/proactive/content_generator.py-735-        context: Dict[str, Any],
   328â†’apps/api/services/proactive/content_generator.py:736:        voice_mode: str = "warm",
   329â†’apps/api/services/proactive/content_generator.py-737-    ) -> Dict[str, Any]:
   330â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-738-        """ä½¿ç”¨ LLM ç”Ÿæˆä¸ªæ€§åŒ–å†…å®¹"""
   331â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-739-        from services.llm import create_system_message, create_user_message
   332â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-740-
   333â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-741-        # æ„å»º prompt
   334â†’apps/api/services/proactive/content_generator.py:742:        system_prompt = self._get_system_prompt(template_type, voice_mode)
   335â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-743-        user_prompt = self._get_user_prompt(template_type, context)
   336â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-744-
   337â†’apps/api/services/proactive/content_generator.py-745-        try:
   338â†’--
   339â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-765-            # è¿”å›é»˜è®¤å†…å®¹
   340â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-766-            return self._get_fallback_content(template_type, context)
   341â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-767-
   342â†’apps/api/services/proactive/content_generator.py:768:    def _get_system_prompt(self, template_type: str, voice_mode: str) -> str:
   343â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-769-        """è·å–ç³»ç»Ÿæç¤ºè¯"""
   344â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-770-        voice_styles = {
   345â†’apps/api/services/proactive/content_generator.py-771-            "warm": "ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªæ¸©æš–ã€å…±æƒ…ã€æ”¯æŒçš„ AI çŸ¥å·±ã€‚ç”¨æ¸©æš–çš„è¯­æ°”ä¸ç”¨æˆ·äº¤æµã€‚",
   346â†’--
   347â†’apps/api/services/proactive/content_generator.py-773-            "wise": "ä½ æ˜¯ Vibeï¼Œä¸€ä¸ªç†æ€§ã€æ·±åº¦ã€åƒé•¿è¾ˆä¸€æ ·çš„ AI å¯¼å¸ˆã€‚ç”¨ç¿æ™ºçš„æ–¹å¼æŒ‡ç‚¹è¿·æ´¥ã€‚",
   348â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-774-        }
   349â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-775-
   350â†’apps/api/services/proactive/content_generator.py:776:        base_prompt = voice_styles.get(voice_mode, voice_styles["warm"])
   351â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-777-
   352â†’apps/api/services/proactive/content_generator.py-778-        if template_type == "daily_fortune":
   353â†’/home/aiscend/work/vibelife/apps/api/services/proactive/content_generator.py-779-            return f"""{base_prompt}
   354â†’--
   355â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-145-                await UserRepository.create_skill_profile(
   356â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-146-                    user_id=user["id"],
   357â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-147-                    skill=onboarding_data["skill"],
   358â†’apps/api/services/identity/oauth.py:148:                    voice_mode=onboarding_data.get("voice_mode", "warm"),
   359â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-149-                    profile_data={
   360â†’apps/api/services/identity/oauth.py-150-                        "interview_responses": onboarding_data.get("interview_responses", {}),
   361â†’apps/api/services/identity/oauth.py-151-                        "focus_areas": onboarding_data.get("focus_areas", [])
   362â†’--
   363â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-303-                await UserRepository.create_skill_profile(
   364â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-304-                    user_id=user["id"],
   365â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-305-                    skill=onboarding_data["skill"],
   366â†’apps/api/services/identity/oauth.py:306:                    voice_mode=onboarding_data.get("voice_mode", "warm"),
   367â†’/home/aiscend/work/vibelife/apps/api/services/identity/oauth.py-307-                    profile_data={
   368â†’apps/api/services/identity/oauth.py-308-                        "interview_responses": onboarding_data.get("interview_responses", {}),
   369â†’apps/api/services/identity/oauth.py-309-                        "focus_areas": onboarding_data.get("focus_areas", [])
   370â†’--
   371â†’/home/aiscend/work/vibelife/apps/api/services/identity/wechat.py-348-                await UserRepository.create_skill_profile(
   372â†’/home/aiscend/work/vibelife/apps/api/services/identity/wechat.py-349-                    user_id=user["id"],
   373â†’/home/aiscend/work/vibelife/apps/api/services/identity/wechat.py-350-                    skill=onboarding_data["skill"],
   374â†’apps/api/services/identity/wechat.py:351:                    voice_mode=onboarding_data.get("voice_mode", "warm"),
   375â†’/home/aiscend/work/vibelife/apps/api/services/identity/wechat.py-352-                    profile_data={
   376â†’apps/api/services/identity/wechat.py-353-                        "interview_responses": onboarding_data.get("interview_responses", {}),
   377â†’apps/api/services/identity/wechat.py-354-                        "focus_areas": onboarding_data.get("focus_areas", [])
   378â†’--
   379â†’apps/api/services/identity/guest_session.py-35-        birth_datetime: Optional[datetime] = None,
   380â†’apps/api/services/identity/guest_session.py-36-        birth_location: Optional[str] = None,
   381â†’apps/api/services/identity/guest_session.py-37-        gender: Optional[str] = None,
   382â†’apps/api/services/identity/guest_session.py:38:        voice_mode: Optional[str] = None,
   383â†’apps/api/services/identity/guest_session.py-39-        skill: Optional[str] = None,
   384â†’apps/api/services/identity/guest_session.py-40-        interview_responses: Optional[dict] = None,
   385â†’apps/api/services/identity/guest_session.py-41-        focus_areas: Optional[list] = None
   386â†’--
   387â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-46-            birth_datetime=birth_datetime,
   388â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-47-            birth_location=birth_location,
   389â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-48-            gender=gender,
   390â†’apps/api/services/identity/guest_session.py:49:            voice_mode=voice_mode,
   391â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-50-            skill=skill,
   392â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-51-            interview_responses=interview_responses,
   393â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-52-            focus_areas=focus_areas
   394â†’--
   395â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-87-        profile_updates = {}
   396â†’apps/api/services/identity/guest_session.py-88-        if birth_info:
   397â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-89-            profile_updates["birth_info"] = birth_info
   398â†’apps/api/services/identity/guest_session.py:90:        if session.get("voice_mode"):
   399â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-91-            profile_updates["preferences"] = {
   400â†’apps/api/services/identity/guest_session.py:92:                "voice_mode": session["voice_mode"]
   401â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-93-            }
   402â†’/home/aiscend/work/vibelife/apps/api/services/identity/guest_session.py-94-
   403â†’apps/api/services/identity/guest_session.py-95-        if profile_updates:
   404â†’--
   405â†’/home/aiscend/work/vibelife/apps/api/scripts/test_coreagent_zodiac.py-189-        await UnifiedProfileRepository.create_profile(test_user_id, {
   406â†’apps/api/scripts/test_coreagent_zodiac.py-190-            "birth_info": test_user["birth_info"],
   407â†’apps/api/scripts/test_coreagent_zodiac.py-191-            "life_context": {"test": True},
   408â†’apps/api/scripts/test_coreagent_zodiac.py:192:            "preferences": {"voice_mode": "warm"}
   409â†’/home/aiscend/work/vibelife/apps/api/scripts/test_coreagent_zodiac.py-193-        })
   410â†’/home/aiscend/work/vibelife/apps/api/scripts/test_coreagent_zodiac.py-194-        results.add_pass("åˆ›å»º Profile")
   411â†’/home/aiscend/work/vibelife/apps/api/scripts/test_coreagent_zodiac.py-195-
   412â†’--
   413â†’/home/aiscend/work/vibelife/apps/api/scripts/test_core_agent.py-124-        skill_data=user_data["skill_data"],
   414â†’/home/aiscend/work/vibelife/apps/api/scripts/test_core_agent.py-125-        history=[],
   415â†’/home/aiscend/work/vibelife/apps/api/scripts/test_core_agent.py-126-        skill=scenario.get("skill"),
   416â†’apps/api/scripts/test_core_agent.py:127:        voice_mode="warm"
   417â†’/home/aiscend/work/vibelife/apps/api/scripts/test_core_agent.py-128-    )
   418â†’/home/aiscend/work/vibelife/apps/api/scripts/test_core_agent.py-129-
   419â†’apps/api/scripts/test_core_agent.py-130-    print(f"\nğŸ”¹ ç”¨æˆ·è¾“å…¥: {scenario['message']}")
   420â†’--
   421â†’/home/aiscend/work/vibelife/apps/api/scripts/test_real_user_scenarios.py-363-        skill_data=user_data["profile"].get("skill_data", {}),
   422â†’/home/aiscend/work/vibelife/apps/api/scripts/test_real_user_scenarios.py-364-        history=[],
   423â†’/home/aiscend/work/vibelife/apps/api/scripts/test_real_user_scenarios.py-365-        skill=scenario.skill,
   424â†’apps/api/scripts/test_real_user_scenarios.py:366:        voice_mode="warm"
   425â†’/home/aiscend/work/vibelife/apps/api/scripts/test_real_user_scenarios.py-367-    )
   426â†’/home/aiscend/work/vibelife/apps/api/scripts/test_real_user_scenarios.py-368-
   427â†’/home/aiscend/work/vibelife/apps/api/scripts/test_real_user_scenarios.py-369-    # åˆ›å»º Agent
   428â†’--
   429â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-360-
   430â†’apps/api/routes/skills.py-361-class UpdateSettingsRequest(BaseModel):
   431â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-362-    """æ›´æ–°è®¾ç½®è¯·æ±‚"""
   432â†’apps/api/routes/skills.py:363:    voice_mode: Optional[str] = None
   433â†’apps/api/routes/skills.py-364-    reminder_hour: Optional[int] = None
   434â†’apps/api/routes/skills.py-365-    push_enabled: Optional[bool] = None
   435â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-366-
   436â†’--
   437â†’apps/api/routes/skills.py-402-            "description": "æ¥æ”¶æ¯æ—¥ç­¾åˆ°å’Œå¤ç›˜æé†’"
   438â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-403-        },
   439â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-404-        {
   440â†’apps/api/routes/skills.py:405:            "key": "voice_mode",
   441â†’apps/api/routes/skills.py-406-            "name": "è¯­éŸ³æ¨¡å¼",
   442â†’apps/api/routes/skills.py-407-            "type": "select",
   443â†’apps/api/routes/skills.py-408-            "default": "warm",
   444â†’--
   445â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-454-            push_settings = preferences.get("push_settings", {})
   446â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-455-            settings = {
   447â†’apps/api/routes/skills.py-456-                "skill_id": skill_id,
   448â†’apps/api/routes/skills.py:457:                "voice_mode": preferences.get("voice_mode", "warm"),
   449â†’apps/api/routes/skills.py-458-                "reminder_hour": push_settings.get("default_push_hour", 8),
   450â†’apps/api/routes/skills.py-459-                "custom_settings": {},
   451â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-460-            }
   452â†’--
   453â†’apps/api/routes/skills.py-494-    if not metadata:
   454â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-495-        raise HTTPException(status_code=404, detail="Skill not found")
   455â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-496-
   456â†’apps/api/routes/skills.py:497:    # æ›´æ–° voice_mode
   457â†’apps/api/routes/skills.py:498:    if request.voice_mode is not None:
   458â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-499-        await UnifiedProfileRepository.update_preferences(
   459â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-500-            user_id=current_user.user_id,
   460â†’apps/api/routes/skills.py:501:            updates={"voice_mode": request.voice_mode}
   461â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-502-        )
   462â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-503-
   463â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-504-    # æ›´æ–° push_enabled
   464â†’--
   465â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-523-
   466â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-524-    settings = {
   467â†’apps/api/routes/skills.py-525-        "skill_id": skill_id,
   468â†’apps/api/routes/skills.py:526:        "voice_mode": preferences.get("voice_mode", "warm"),
   469â†’apps/api/routes/skills.py-527-        "reminder_hour": push_settings.get("default_push_hour", 8),
   470â†’apps/api/routes/skills.py-528-        "custom_settings": {},
   471â†’/home/aiscend/work/vibelife/apps/api/routes/skills.py-529-    }
   472â†’--
   473â†’apps/api/routes/chat_v5.py-57-    conversation_id: Optional[UUID] = Field(None, description="Conversation ID")
   474â†’apps/api/routes/chat_v5.py-58-    skill: Optional[str] = Field(None, description="Skill ID (bazi/zodiac/career/tarot)")
   475â†’apps/api/routes/chat_v5.py-59-    scenario: Optional[str] = Field(None, description="Scenario/Rule ID (dankoe/covey/weekly-review)")
   476â†’apps/api/routes/chat_v5.py:60:    voice_mode: Optional[str] = Field(None, description="Voice mode (warm/sarcastic)")
   477â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-61-
   478â†’apps/api/routes/chat_v5.py-62-    def get_user_message(self) -> str:
   479â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-63-        """Extract user message from either format"""
   480â†’--
   481â†’apps/api/routes/chat_v5.py-141-    conversation_id: UUID,
   482â†’apps/api/routes/chat_v5.py-142-    user_id: Optional[UUID],
   483â†’apps/api/routes/chat_v5.py-143-    skill: Optional[str] = None,
   484â†’apps/api/routes/chat_v5.py:144:    voice_mode: Optional[str] = None
   485â†’apps/api/routes/chat_v5.py-145-) -> None:
   486â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-146-    """Ensure conversation exists in database, create if not"""
   487â†’apps/api/routes/chat_v5.py-147-    try:
   488â†’--
   489â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-150-            await conversation_repo.create_conversation(
   490â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-151-                skill=skill or "core",
   491â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-152-                user_id=user_id,
   492â†’apps/api/routes/chat_v5.py:153:                voice_mode=voice_mode or "warm",
   493â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-154-                conversation_id=conversation_id
   494â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-155-            )
   495â†’apps/api/routes/chat_v5.py-156-    except Exception as e:
   496â†’--
   497â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-243-                conversation_id=conversation_id,
   498â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-244-                user_id=user_id,
   499â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-245-                skill=request.skill,
   500â†’apps/api/routes/chat_v5.py:246:                voice_mode=request.voice_mode
   501â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-247-            )
   502â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-248-            perf_log["T4_ensure_conv_ms"] = int((time.time() - t4_start) * 1000)
   503â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-249-
   504â†’--
   505â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-283-                history=history,  # ä»æ•°æ®åº“è·å–ï¼Œä¸å†ä¾èµ–å‰ç«¯ä¼ å…¥
   506â†’apps/api/routes/chat_v5.py-284-                skill=active_skill,  # v8: å¯èƒ½ä» conversation æ¢å¤
   507â†’apps/api/routes/chat_v5.py-285-                scenario=active_scenario,  # v8.1: æ”¯æŒ scenario ä¼ é€’
   508â†’apps/api/routes/chat_v5.py:286:                voice_mode=request.voice_mode,
   509â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-287-                conversation_id=str(conversation_id)
   510â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-288-            )
   511â†’/home/aiscend/work/vibelife/apps/api/routes/chat_v5.py-289-
   512â†’--
   513â†’apps/api/routes/account.py-42-    birth_datetime: Optional[datetime] = None
   514â†’apps/api/routes/account.py-43-    birth_location: Optional[str] = None
   515â†’apps/api/routes/account.py-44-    gender: Optional[str] = None
   516â†’apps/api/routes/account.py:45:    voice_mode: Optional[str] = "warm"
   517â†’apps/api/routes/account.py-46-    skill: Optional[str] = "bazi"
   518â†’apps/api/routes/account.py-47-    interview_responses: Optional[dict] = None
   519â†’apps/api/routes/account.py-48-    focus_areas: Optional[List[str]] = None
   520â†’--
   521â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-144-# --- Preferences Models ---
   522â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-145-
   523â†’apps/api/routes/account.py-146-class PreferencesResponse(BaseModel):
   524â†’apps/api/routes/account.py:147:    voice_mode: str = "warm"
   525â†’apps/api/routes/account.py-148-    language: str = "zh-CN"
   526â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-149-
   527â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-150-
   528â†’apps/api/routes/account.py-151-class PreferencesUpdateRequest(BaseModel):
   529â†’apps/api/routes/account.py:152:    voice_mode: Optional[str] = None
   530â†’apps/api/routes/account.py-153-    language: Optional[str] = None
   531â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-154-
   532â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-155-
   533â†’--
   534â†’apps/api/routes/account.py-160-    birth_datetime: Optional[datetime] = None
   535â†’apps/api/routes/account.py-161-    birth_location: Optional[str] = None
   536â†’apps/api/routes/account.py-162-    gender: Optional[str] = None
   537â†’apps/api/routes/account.py:163:    voice_mode: Optional[str] = None
   538â†’apps/api/routes/account.py-164-    skill: Optional[str] = None
   539â†’apps/api/routes/account.py-165-    interview_responses: Optional[dict] = None
   540â†’apps/api/routes/account.py-166-    focus_areas: Optional[list] = None
   541â†’--
   542â†’apps/api/routes/account.py-171-    birth_datetime: Optional[datetime] = None
   543â†’apps/api/routes/account.py-172-    birth_location: Optional[str] = None
   544â†’apps/api/routes/account.py-173-    gender: Optional[str] = None
   545â†’apps/api/routes/account.py:174:    voice_mode: Optional[str] = None
   546â†’apps/api/routes/account.py-175-    skill: Optional[str] = None
   547â†’apps/api/routes/account.py-176-    interview_responses: Optional[dict] = None
   548â†’apps/api/routes/account.py-177-    focus_areas: Optional[List[str]] = None
   549â†’--
   550â†’apps/api/routes/account.py-217-        "birth_datetime": onboarding.birth_datetime,
   551â†’apps/api/routes/account.py-218-        "birth_location": onboarding.birth_location,
   552â†’apps/api/routes/account.py-219-        "gender": onboarding.gender,
   553â†’apps/api/routes/account.py:220:        "voice_mode": onboarding.voice_mode,
   554â†’apps/api/routes/account.py-221-        "skill": onboarding.skill,
   555â†’apps/api/routes/account.py-222-        "interview_responses": onboarding.interview_responses,
   556â†’apps/api/routes/account.py-223-        "focus_areas": onboarding.focus_areas
   557â†’--
   558â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-553-
   559â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-554-@router.get("/preferences", response_model=PreferencesResponse)
   560â†’apps/api/routes/account.py-555-async def get_preferences(current_user: CurrentUser = Depends(get_current_user)):
   561â†’apps/api/routes/account.py:556:    """Get current user's preferences (voice_mode, language, etc.)"""
   562â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-557-    preferences = await UnifiedProfileRepository.get_preferences(current_user.user_id)
   563â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-558-    return PreferencesResponse(
   564â†’apps/api/routes/account.py:559:        voice_mode=preferences.get("voice_mode", "warm"),
   565â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-560-        language=preferences.get("language", "zh-CN")
   566â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-561-    )
   567â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-562-
   568â†’--
   569â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-575-    # Return updated preferences
   570â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-576-    preferences = await UnifiedProfileRepository.get_preferences(current_user.user_id)
   571â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-577-    return PreferencesResponse(
   572â†’apps/api/routes/account.py:578:        voice_mode=preferences.get("voice_mode", "warm"),
   573â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-579-        language=preferences.get("language", "zh-CN")
   574â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-580-    )
   575â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-581-
   576â†’--
   577â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-718-        birth_datetime=session.get("birth_datetime"),
   578â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-719-        birth_location=session.get("birth_location"),
   579â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-720-        gender=session.get("gender"),
   580â†’apps/api/routes/account.py:721:        voice_mode=session.get("voice_mode"),
   581â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-722-        skill=session.get("skill"),
   582â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-723-        interview_responses=session.get("interview_responses"),
   583â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-724-        focus_areas=session.get("focus_areas"),
   584â†’--
   585â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-740-        birth_datetime=data.birth_datetime,
   586â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-741-        birth_location=data.birth_location,
   587â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-742-        gender=data.gender,
   588â†’apps/api/routes/account.py:743:        voice_mode=data.voice_mode,
   589â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-744-        skill=data.skill,
   590â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-745-        interview_responses=data.interview_responses,
   591â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-746-        focus_areas=data.focus_areas
   592â†’--
   593â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-754-        birth_datetime=session.get("birth_datetime"),
   594â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-755-        birth_location=session.get("birth_location"),
   595â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-756-        gender=session.get("gender"),
   596â†’apps/api/routes/account.py:757:        voice_mode=session.get("voice_mode"),
   597â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-758-        skill=session.get("skill"),
   598â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-759-        interview_responses=session.get("interview_responses"),
   599â†’/home/aiscend/work/vibelife/apps/api/routes/account.py-760-        focus_areas=session.get("focus_areas"),
   600â†’--
   601â†’apps/api/stores/guest_session_repo.py-56-        birth_datetime: Optional[datetime] = None,
   602â†’apps/api/stores/guest_session_repo.py-57-        birth_location: Optional[str] = None,
   603â†’apps/api/stores/guest_session_repo.py-58-        gender: Optional[str] = None,
   604â†’apps/api/stores/guest_session_repo.py:59:        voice_mode: Optional[str] = None,
   605â†’apps/api/stores/guest_session_repo.py-60-        skill: Optional[str] = None,
   606â†’apps/api/stores/guest_session_repo.py-61-        interview_responses: Optional[dict] = None,
   607â†’apps/api/stores/guest_session_repo.py-62-        focus_areas: Optional[list] = None
   608â†’--
   609â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-72-                    birth_datetime = COALESCE($2, birth_datetime),
   610â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-73-                    birth_location = COALESCE($3, birth_location),
   611â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-74-                    gender = COALESCE($4, gender),
   612â†’apps/api/stores/guest_session_repo.py:75:                    voice_mode = COALESCE($5, voice_mode),
   613â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-76-                    skill = COALESCE($6, skill),
   614â†’apps/api/stores/guest_session_repo.py-77-                    interview_responses = COALESCE($7::jsonb, interview_responses),
   615â†’apps/api/stores/guest_session_repo.py-78-                    focus_areas = COALESCE($8::jsonb, focus_areas),
   616â†’--
   617â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-84-                birth_datetime,
   618â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-85-                birth_location,
   619â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-86-                gender,
   620â†’apps/api/stores/guest_session_repo.py:87:                voice_mode,
   621â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-88-                skill,
   622â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-89-                json.dumps(interview_responses) if interview_responses else None,
   623â†’/home/aiscend/work/vibelife/apps/api/stores/guest_session_repo.py-90-                json.dumps(focus_areas) if focus_areas else None
   624â†’--
   625â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-375-    async def create_skill_profile(
   626â†’apps/api/stores/user_repo.py-376-        user_id: UUID,
   627â†’apps/api/stores/user_repo.py-377-        skill: str,
   628â†’apps/api/stores/user_repo.py:378:        voice_mode: str = "warm",
   629â†’apps/api/stores/user_repo.py-379-        profile_data: Optional[dict] = None
   630â†’apps/api/stores/user_repo.py-380-    ) -> dict:
   631â†’apps/api/stores/user_repo.py:381:        """Create or update skill profile with voice_mode and profile_data"""
   632â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-382-        import json
   633â†’apps/api/stores/user_repo.py:383:        # Merge voice_mode into profile_data since table doesn't have voice_mode column
   634â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-384-        merged_data = profile_data or {}
   635â†’apps/api/stores/user_repo.py:385:        merged_data['voice_mode'] = voice_mode
   636â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-386-
   637â†’apps/api/stores/user_repo.py-387-        async with get_connection() as conn:
   638â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-388-            row = await conn.fetchrow(
   639â†’--
   640â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-418-            return dict(row) if row else None
   641â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-419-
   642â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-420-    @staticmethod
   643â†’apps/api/stores/user_repo.py:421:    async def update_skill_voice_mode(
   644â†’apps/api/stores/user_repo.py-422-        user_id: UUID,
   645â†’apps/api/stores/user_repo.py-423-        skill: str,
   646â†’apps/api/stores/user_repo.py:424:        voice_mode: str
   647â†’apps/api/stores/user_repo.py-425-    ) -> Optional[dict]:
   648â†’apps/api/stores/user_repo.py:426:        """Update voice_mode for a skill profile"""
   649â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-427-        import json
   650â†’apps/api/stores/user_repo.py-428-        async with get_connection() as conn:
   651â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-429-            row = await conn.fetchrow(
   652â†’--
   653â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-433-                WHERE user_id = $1 AND skill_id = $2
   654â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-434-                RETURNING *
   655â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-435-                """,
   656â†’apps/api/stores/user_repo.py:436:                user_id, skill, json.dumps({'voice_mode': voice_mode})
   657â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-437-            )
   658â†’/home/aiscend/work/vibelife/apps/api/stores/user_repo.py-438-            return dict(row) if row else None
   659â†’--
   660â†’apps/api/stores/migrations/022_cleanup_vibe_users.sql-251-    RAISE NOTICE 'All business data is now in unified_profiles:';
   661â†’apps/api/stores/migrations/022_cleanup_vibe_users.sql-252-    RAISE NOTICE '  - account: vibe_id, display_name, avatar_url, tier, status, deletion_*';
   662â†’apps/api/stores/migrations/022_cleanup_vibe_users.sql-253-    RAISE NOTICE '  - birth_info: date, time, place, gender, timezone';
   663â†’apps/api/stores/migrations/022_cleanup_vibe_users.sql:254:    RAISE NOTICE '  - preferences: timezone, language, voice_mode, subscriptions, etc.';
   664â†’apps/api/stores/migrations/022_cleanup_vibe_users.sql-255-    RAISE NOTICE '  - skill_data: bazi, zodiac, tarot, career, etc.';
   665â†’apps/api/stores/migrations/022_cleanup_vibe_users.sql-256-    RAISE NOTICE '  - life_context: goals, events, patterns, etc.';
   666â†’/home/aiscend/work/vibelife/apps/api/stores/migrations/022_cleanup_vibe_users.sql-257-    RAISE NOTICE '';
   667â†’--
   668â†’apps/api/stores/conversation_repo.py-25-        id: UUID,
   669â†’apps/api/stores/conversation_repo.py-26-        user_id: Optional[UUID],
   670â†’apps/api/stores/conversation_repo.py-27-        skill: str,
   671â†’apps/api/stores/conversation_repo.py:28:        voice_mode: str,
   672â†’apps/api/stores/conversation_repo.py-29-        title: Optional[str],
   673â†’apps/api/stores/conversation_repo.py-30-        is_active: bool,
   674â†’apps/api/stores/conversation_repo.py-31-        created_at: datetime,
   675â†’--
   676â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-34-        self.id = id
   677â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-35-        self.user_id = user_id
   678â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-36-        self.skill = skill
   679â†’apps/api/stores/conversation_repo.py:37:        self.voice_mode = voice_mode
   680â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-38-        self.title = title
   681â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-39-        self.is_active = is_active
   682â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-40-        self.created_at = created_at
   683â†’--
   684â†’apps/api/stores/conversation_repo.py-45-            "id": str(self.id),
   685â†’apps/api/stores/conversation_repo.py-46-            "user_id": str(self.user_id) if self.user_id else None,
   686â†’apps/api/stores/conversation_repo.py-47-            "skill": self.skill,
   687â†’apps/api/stores/conversation_repo.py:48:            "voice_mode": self.voice_mode,
   688â†’apps/api/stores/conversation_repo.py-49-            "title": self.title,
   689â†’apps/api/stores/conversation_repo.py-50-            "is_active": self.is_active,
   690â†’apps/api/stores/conversation_repo.py-51-            "created_at": self.created_at.isoformat() if self.created_at else None,
   691â†’--
   692â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-58-            id=row["id"],
   693â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-59-            user_id=row.get("user_id"),
   694â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-60-            skill=row["skill"],
   695â†’apps/api/stores/conversation_repo.py:61:            voice_mode=row.get("voice_mode", "warm"),
   696â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-62-            title=row.get("title"),
   697â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-63-            is_active=row.get("is_active", True),
   698â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-64-            created_at=row.get("created_at"),
   699â†’--
   700â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-73-async def create_conversation(
   701â†’apps/api/stores/conversation_repo.py-74-    skill: str,
   702â†’apps/api/stores/conversation_repo.py-75-    user_id: Optional[UUID] = None,
   703â†’apps/api/stores/conversation_repo.py:76:    voice_mode: str = "warm",
   704â†’apps/api/stores/conversation_repo.py-77-    title: Optional[str] = None,
   705â†’apps/api/stores/conversation_repo.py-78-    conversation_id: Optional[UUID] = None
   706â†’apps/api/stores/conversation_repo.py-79-) -> ConversationRecord:
   707â†’--
   708â†’apps/api/stores/conversation_repo.py-83-    Args:
   709â†’apps/api/stores/conversation_repo.py-84-        skill: bazi or zodiac
   710â†’apps/api/stores/conversation_repo.py-85-        user_id: Optional user ID (None for guests)
   711â†’apps/api/stores/conversation_repo.py:86:        voice_mode: warm or sarcastic
   712â†’apps/api/stores/conversation_repo.py-87-        title: Optional conversation title
   713â†’apps/api/stores/conversation_repo.py-88-        conversation_id: Optional specific ID to use
   714â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-89-
   715â†’--
   716â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-93-    conversation_id = conversation_id or uuid4()
   717â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-94-
   718â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-95-    query = """
   719â†’apps/api/stores/conversation_repo.py:96:        INSERT INTO conversations (id, user_id, skill, voice_mode, title)
   720â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-97-        VALUES ($1, $2, $3, $4, $5)
   721â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-98-        RETURNING *
   722â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-99-    """
   723â†’--
   724â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-105-                conversation_id,
   725â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-106-                user_id,
   726â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-107-                skill,
   727â†’apps/api/stores/conversation_repo.py:108:                voice_mode,
   728â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-109-                title
   729â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-110-            )
   730â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-111-            return ConversationRecord.from_row(dict(row))
   731â†’--
   732â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-182-
   733â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-183-async def update_conversation(
   734â†’apps/api/stores/conversation_repo.py-184-    conversation_id: UUID,
   735â†’apps/api/stores/conversation_repo.py:185:    voice_mode: Optional[str] = None,
   736â†’apps/api/stores/conversation_repo.py-186-    title: Optional[str] = None,
   737â†’apps/api/stores/conversation_repo.py-187-    is_active: Optional[bool] = None
   738â†’apps/api/stores/conversation_repo.py-188-) -> Optional[ConversationRecord]:
   739â†’--
   740â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-191-    params = []
   741â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-192-    param_idx = 1
   742â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-193-
   743â†’apps/api/stores/conversation_repo.py:194:    if voice_mode is not None:
   744â†’apps/api/stores/conversation_repo.py:195:        updates.append(f"voice_mode = ${param_idx}")
   745â†’apps/api/stores/conversation_repo.py:196:        params.append(voice_mode)
   746â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-197-        param_idx += 1
   747â†’/home/aiscend/work/vibelife/apps/api/stores/conversation_repo.py-198-
   748â†’apps/api/stores/conversation_repo.py-199-    if title is not None:
   749â†’--
   750â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-29-    },
   751â†’apps/api/stores/unified_profile_repo.py-30-    "life_context": {...},
   752â†’apps/api/stores/unified_profile_repo.py-31-    "preferences": {
   753â†’apps/api/stores/unified_profile_repo.py:32:        "voice_mode": "warm",
   754â†’apps/api/stores/unified_profile_repo.py-33-        "language": "zh-CN",
   755â†’apps/api/stores/unified_profile_repo.py-34-        "timezone": "Asia/Shanghai",
   756â†’apps/api/stores/unified_profile_repo.py-35-        "subscribed_skills": {
   757â†’--
   758â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-193-        """è·å–ç”¨æˆ·åå¥½"""
   759â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-194-        profile = await UnifiedProfileRepository.get_profile(user_id)
   760â†’apps/api/stores/unified_profile_repo.py-195-        if profile:
   761â†’apps/api/stores/unified_profile_repo.py:196:            return profile.get("preferences", {"voice_mode": "warm", "language": "zh-CN"})
   762â†’apps/api/stores/unified_profile_repo.py:197:        return {"voice_mode": "warm", "language": "zh-CN"}
   763â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-198-
   764â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-199-    @staticmethod
   765â†’apps/api/stores/unified_profile_repo.py-200-    async def get_life_context(user_id: UUID) -> Dict[str, Any]:
   766â†’--
   767â†’apps/api/stores/unified_profile_repo.py-300-            "birth_info": {},
   768â†’apps/api/stores/unified_profile_repo.py-301-            "state": {"focus": [], "updated_at": None},
   769â†’apps/api/stores/unified_profile_repo.py-302-            "life_context": {},
   770â†’apps/api/stores/unified_profile_repo.py:303:            "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   771â†’apps/api/stores/unified_profile_repo.py-304-            "skill_data": {}
   772â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-305-        }
   773â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-306-
   774â†’--
   775â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-337-            default_profile = {
   776â†’apps/api/stores/unified_profile_repo.py-338-                "birth_info": {},
   777â†’apps/api/stores/unified_profile_repo.py-339-                "life_context": {},
   778â†’apps/api/stores/unified_profile_repo.py:340:                "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   779â†’apps/api/stores/unified_profile_repo.py-341-                "skill_data": {}
   780â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-342-            }
   781â†’/home/aiscend/work/vibelife/apps/api/stores/unified_profile_repo.py-343-            merged = deep_merge(default_profile, updates)

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
