  1000→│                     │ 邀请链接 │                                            │
  1001→│                     └────┬────┘                                            │
  1002→│                          │                                                 │
  1003→│                          ▼                                                 │
  1004→│                     ┌─────────┐    ┌─────────┐                             │
  1005→│                     │ 对方也做 │───▶│ 新用户  │                             │
  1006→│                     │  分析   │    │  转化   │                             │
  1007→│                     └─────────┘    └─────────┘                             │
  1008→│                                                                             │
  1009→└─────────────────────────────────────────────────────────────────────────────┘
  1010→```
  1011→
  1012→## 3.4 Persona 语言规范
  1013→
  1014→```
  1015→╔═══════════════════════════════════════════════════════════════════════════════╗
  1016→║                                                                               ║
  1017→║   VIBE PERSONA 语言规范                                                       ║
  1018→║                                                                               ║
  1019→╠═══════════════════════════════════════════════════════════════════════════════╣
  1020→║                                                                               ║
  1021→║   核心身份                                                                    ║
  1022→║   ─────────────────────────────────────────────────────────────────────────   ║
  1023→║                                                                               ║
  1024→║   Vibe 是用户的知己——懂命理、懂心理，更懂你。                                ║
  1025→║   不是冰冷的分析师，是温暖的朋友。                                            ║
  1026→║   不是预测命运的大师，是帮你看见自己的镜子。                                  ║
  1027→║                                                                               ║
  1028→║   ─────────────────────────────────────────────────────────────────────────   ║
  1029→║                                                                               ║
  1030→║   语气模式                                                                    ║
  1031→║   ─────────────────────────────────────────────────────────────────────────   ║
  1032→║                                                                               ║
  1033→║   温暖模式（默认）                                                            ║
  1034→║   ├── 共情、支持、鼓励                                                        ║
  1035→║   ├── 用词：「我感觉到...」「你可能...」「值得尝试...」                        ║
  1036→║   └── 示例：                                                                  ║
  1037→║       「我感觉到你最近压力挺大的。你是甲木人，天生有一种                       ║
  1038→║        想要突破的冲劲，但现在的环境可能让你觉得被困住了。                      ║
  1039→║        这不是你的问题，是阶段。要不要聊聊？」                                 ║
  1040→║                                                                               ║
  1041→║   吐槽模式                                                                    ║
  1042→║   ├── 直接、犀利、有趣                                                        ║
  1043→║   ├── 用词：「得了吧」「说白了」「典型的...」                                  ║
  1044→║   └── 示例：                                                                  ║
  1045→║       「得了吧，你这就是典型的甲木人纠结症。想那么多干嘛？                     ║
  1046→║        甲木最怕犹豫，一犹豫气势就散了。你现在需要的不是分析，                  ║
  1047→║        是找个事儿先干起来。」                                                 ║
  1048→║                                                                               ║
  1049→║   ─────────────────────────────────────────────────────────────────────────   ║
  1050→║                                                                               ║
  1051→║   语言风格对比                                                                ║
  1052→║   ─────────────────────────────────────────────────────────────────────────   ║
  1053→║                                                                               ║
  1054→║   ❌ 禁用                           ✅ 使用                                   ║
  1055→║   ─────────────────────────────     ─────────────────────────────             ║
  1056→║   「您」「用户」                    「你」                                     ║
  1057→║   「分析结果显示」                  「我发现」「我感觉」                       ║
  1058→║   「根据八字理论」                  「你天生...」                              ║
  1059→║   「财滋弱杀」                      「你的财运和事业有关联」                   ║
  1060→║   「你注定...」                     「你更可能...」                            ║
  1061→║   「你一定会...」                   「在这个阶段，适合...」                    ║
  1062→║   「不这样会很惨」                  「可以尝试...」                            ║
  1063→║                                                                               ║
  1064→║   ─────────────────────────────────────────────────────────────────────────   ║
  1065→║                                                                               ║
  1066→║   绝对禁止                                                                    ║
  1067→║   ─────────────────────────────────────────────────────────────────────────   ║
  1068→║                                                                               ║
  1069→║   • 以恐惧驱动的句式                                                          ║
  1070→║   • 具体事件预测（「你明年会结婚」）                                          ║
  1071→║   • 贩卖焦虑（「不买就错过窗口期」）                                          ║
  1072→║   • 宿命论（「这是命」）                                                      ║
  1073→║                                                                               ║
  1074→╚═══════════════════════════════════════════════════════════════════════════════╝
  1075→```
  1076→
  1077→---
  1078→
  1079→# Part 4: 用户数据系统（核心）
  1080→
  1081→> **本章是 VibeLife「深度理解」能力的技术基础，优先级极高。**
  1082→
  1083→## 4.1 系统总览
  1084→
  1085→```
  1086→╔═══════════════════════════════════════════════════════════════════════════════╗
  1087→║                                                                               ║
  1088→║   用户数据系统架构                                                            ║
  1089→║                                                                               ║
  1090→║   「了解你越多，理解你越深。」                                                ║
  1091→║                                                                               ║
  1092→╠═══════════════════════════════════════════════════════════════════════════════╣
  1093→║                                                                               ║
  1094→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
  1095→║   │                                                                         │ ║
  1096→║   │                      信息采集层                                         │ ║
  1097→║   │   ═════════════════════════════════════════════════════════════════     │ ║
  1098→║   │                                                                         │ ║
  1099→║   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐           │ ║
  1100→║   │   │  基础表单  │  │  对话采集  │  │  文件上传  │  │  AI 访谈  │           │ ║
  1101→║   │   │           │  │           │  │           │  │           │           │ ║
  1102→║   │   │ • 生日    │  │ • 自然抽取│  │ • 截图    │  │ • 强制问答│           │ ║
  1103→║   │   │ • 时辰    │  │ • 实体识别│  │ • 文档    │  │ • 报告前  │           │ ║
  1104→║   │   │ • 地点    │  │ • 情感分析│  │ • 聊天记录│  │ • 触发式  │           │ ║
  1105→║   │   └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘           │ ║
  1106→║   │         │              │              │              │                 │ ║
  1107→║   │         └──────────────┴──────────────┴──────────────┘                 │ ║
  1108→║   │                               │                                         │ ║
  1109→║   │                               ▼                                         │ ║
  1110→║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
  1111→║   │   │                    信息抽取引擎                                  │   │ ║
  1112→║   │   │                                                                 │   │ ║
  1113→║   │   │   • LLM 结构化抽取（JSON Schema 输出）                          │   │ ║
  1114→║   │   │   • 实体识别（人物、事件、情绪、关系）                          │   │ ║
  1115→║   │   │   • 图片理解（OCR + Vision LLM）                                │   │ ║
  1116→║   │   │   • 文档解析（PDF、Word、TXT）                                  │   │ ║
  1117→║   │   │                                                                 │   │ ║
  1118→║   │   └───────────────────────────┬─────────────────────────────────────┘   │ ║
  1119→║   │                               │                                         │ ║
  1120→║   │                               ▼                                         │ ║
  1121→║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
  1122→║   │   │                    用户 Profile                                 │   │ ║
  1123→║   │   │                                                                 │   │ ║
  1124→║   │   │   • 基础信息层                                                  │   │ ║
  1125→║   │   │   • 生活上下文层                                                │   │ ║
  1126→║   │   │   • AI 洞察层                                                   │   │ ║
  1127→║   │   │   • Identity Prism 层                                           │   │ ║
  1128→║   │   │                                                                 │   │ ║
  1129→║   │   └───────────────────────────┬─────────────────────────────────────┘   │ ║
  1130→║   │                               │                                         │ ║
  1131→║   │                               ▼                                         │ ║
  1132→║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
  1133→║   │   │                    Context 构建                                 │   │ ║
  1134→║   │   │                                                                 │   │ ║
  1135→║   │   │   System Prompt + 话题相关 Profile + 知识库 + 对话历史          │   │ ║
  1136→║   │   │                                                                 │   │ ║
  1137→║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
  1138→║   │                                                                         │ ║
  1139→║   └─────────────────────────────────────────────────────────────────────────┘ ║
  1140→║                                                                               ║
  1141→╚═══════════════════════════════════════════════════════════════════════════════╝
  1142→```
  1143→
  1144→## 4.2 AI 强制访谈系统
  1145→
  1146→```
  1147→┌─────────────────────────────────────────────────────────────────────────────┐
  1148→│                                                                             │
  1149→│   AI 强制访谈系统                                                           │
  1150→│                                                                             │
  1151→│   ═══════════════════════════════════════════════════════════════════════   │
  1152→│                                                                             │
  1153→│   核心原则                                                                  │
  1154→│   ─────────────────────────────────────────────────────────────────────     │
  1155→│                                                                             │
  1156→│   「生成报告前，必须完成访谈。」                                            │
  1157→│                                                                             │
  1158→│   这是确保报告质量的关键——没有足够的用户信息，                              │
  1159→│   再好的命盘分析也只是泛泛而谈。                                            │
  1160→│                                                                             │
  1161→│   ─────────────────────────────────────────────────────────────────────     │
  1162→│                                                                             │
  1163→│   触发时机                                                                  │
  1164→│   ─────────────────────────────────────────────────────────────────────     │
  1165→│                                                                             │
  1166→│   • 用户请求生成报告时                                                      │
  1167→│   • 用户信息不完整时（Profile 评分 < 阈值）                                 │
  1168→│   • 用户首次使用时                                                          │
  1169→│                                                                             │
  1170→│   ─────────────────────────────────────────────────────────────────────     │
  1171→│                                                                             │
  1172→│   访谈问题设计                                                              │
  1173→│   ─────────────────────────────────────────────────────────────────────     │
  1174→│                                                                             │
  1175→│   核心问题（必问，2-3 个）：                                                │
  1176→│                                                                             │
  1177→│   1. 当前困境/关注点                                                        │
  1178→│      「你现在最想解决的问题是什么？或者，最困扰你的是什么？」               │
  1179→│      → 抽取：current_concerns, pain_points                                  │
  1180→│                                                                             │
  1181→│   2. 生活状态                                                               │
  1182→│      「简单说说你现在的状态？工作、感情、还是其他方面？」                   │
  1183→│      → 抽取：career_status, relationship_status, life_stage                 │
  1184→│                                                                             │
  1185→│   3. 期望与目标                                                             │
  1186→│      「你希望从这次分析中获得什么？」                                       │
  1187→│      → 抽取：expectations, goals                                            │
  1188→│                                                                             │
  1189→│   补充问题（根据上下文选择性追问）：                                        │
  1190→│                                                                             │
  1191→│   • 「你提到了 [X]，能具体说说吗？」                                        │
  1192→│   • 「这种情况持续多久了？」                                                │
  1193→│   • 「之前有过类似的经历吗？」                                              │
  1194→│                                                                             │
  1195→│   ─────────────────────────────────────────────────────────────────────     │
  1196→│                                                                             │
  1197→│   访谈交互设计                                                              │
  1198→│   ─────────────────────────────────────────────────────────────────────     │
  1199→│                                                                             │
  1200→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1201→│   │                                                                     │   │
  1202→│   │   🌟 在生成你的专属报告之前...                                      │   │
  1203→│   │                                                                     │   │
  1204→│   │   我想更了解你一点。这样我才能给你真正有用的分析，                   │   │
  1205→│   │   而不是泛泛而谈。                                                  │   │
  1206→│   │                                                                     │   │
  1207→│   │   ─────────────────────────────────────────────────────────         │   │
  1208→│   │                                                                     │   │
  1209→│   │   你现在最想解决的问题是什么？                                      │   │
  1210→│   │   或者，最困扰你的是什么？                                          │   │
  1211→│   │                                                                     │   │
  1212→│   │   ┌───────────────────────────────────────────────────────────┐     │   │
  1213→│   │   │                                                           │     │   │
  1214→│   │   │ [用户输入区]                                              │     │   │
  1215→│   │   │                                                           │     │   │
  1216→│   │   └───────────────────────────────────────────────────────────┘     │   │
  1217→│   │                                                                     │   │
  1218→│   │   [跳过] [继续]                                                     │   │
  1219→│   │                                                                     │   │
  1220→│   └─────────────────────────────────────────────────────────────────────┘   │
  1221→│                                                                             │
  1222→│   注意：                                                                    │
  1223→│   • 允许用户跳过，但会提示「跳过后报告可能不够精准」                        │
  1224→│   • 进度条显示「还需 2 个问题」                                             │
  1225→│   • 语气温暖，不像审问                                                      │
  1226→│                                                                             │
  1227→└─────────────────────────────────────────────────────────────────────────────┘
  1228→```
  1229→
  1230→## 4.3 文件上传与信息抽取
  1231→
  1232→```
  1233→┌─────────────────────────────────────────────────────────────────────────────┐
  1234→│                                                                             │
  1235→│   文件上传与信息抽取                                                        │
  1236→│                                                                             │
  1237→│   ═══════════════════════════════════════════════════════════════════════   │
  1238→│                                                                             │
  1239→│   支持的文件类型                                                            │
  1240→│   ─────────────────────────────────────────────────────────────────────     │
  1241→│                                                                             │
  1242→│   图片（JPG, PNG, HEIC）                                                    │
  1243→│   ├── 其他 App 的排盘截图 → 抽取八字/星盘信息                               │
  1244→│   ├── 聊天记录截图 → 抽取关系模式、沟通风格                                 │
  1245→│   └── 手写笔记 → OCR + 内容理解                                             │
  1246→│                                                                             │
  1247→│   文档（PDF, DOCX, TXT）                                                    │
  1248→│   ├── 简历 → 抽取职业经历、技能、发展轨迹                                   │
  1249→│   ├── 日记/随笔 → 抽取情绪模式、价值观、关注点                              │
  1250→│   └── 其他文档 → 自由抽取相关信息                                           │
  1251→│                                                                             │
  1252→│   ─────────────────────────────────────────────────────────────────────     │
  1253→│                                                                             │
  1254→│   抽取流程                                                                  │
  1255→│   ─────────────────────────────────────────────────────────────────────     │
  1256→│                                                                             │
  1257→│   1. 文件预处理                                                             │
  1258→│      • 图片：压缩 + OCR                                                     │
  1259→│      • PDF：文本提取 + 图片提取                                             │
  1260→│      • 文档：格式转换 + 文本提取                                            │
  1261→│                                                                             │
  1262→│   2. LLM 结构化抽取                                                         │
  1263→│      • 使用 Claude 3 Vision / GPT-4V 进行图片理解                           │
  1264→│      • 输出 JSON Schema 格式的结构化数据                                    │
  1265→│      • 置信度评分                                                           │
  1266→│                                                                             │
  1267→│   3. Profile 更新                                                           │
  1268→│      • 新信息与现有 Profile 融合                                            │
  1269→│      • 冲突检测 + 用新值覆盖                                                │
  1270→│      • 版本记录                                                             │
  1271→│                                                                             │
  1272→│   ─────────────────────────────────────────────────────────────────────     │
  1273→│                                                                             │
  1274→│   抽取示例：聊天记录截图                                                    │
  1275→│   ─────────────────────────────────────────────────────────────────────     │
  1276→│                                                                             │
  1277→│   输入：用户上传与伴侣的聊天截图                                            │
  1278→│                                                                             │
  1279→│   抽取输出：                                                                │
  1280→│   {                                                                         │
  1281→│     "relationship_context": {                                               │
  1282→│       "type": "romantic",                                                   │
  1283→│       "status": "in_conflict",                                              │
  1284→│       "duration_hint": "seems established"                                  │
  1285→│     },                                                                      │
  1286→│     "communication_patterns": {                                             │
  1287→│       "user_style": "tends to explain, seeks understanding",                │
  1288→│       "partner_style": "short responses, seems frustrated"                  │
  1289→│     },                                                                      │
  1290→│     "emotional_cues": {                                                     │
  1291→│       "user_emotion": "anxious, trying to fix",                             │
  1292→│       "conflict_topic": "time/attention allocation"                         │
  1293→│     },                                                                      │
  1294→│     "insights": [                                                           │
  1295→│       "用户习惯付出和解释",                                                 │
  1296→│       "对方可能需要空间而非解释",                                           │
  1297→│       "存在沟通方式不匹配"                                                  │
  1298→│     ]                                                                       │
  1299→│   }                                                                         │
  1300→│                                                                             │
  1301→└─────────────────────────────────────────────────────────────────────────────┘
  1302→```
  1303→
  1304→## 4.4 Profile 结构设计
  1305→
  1306→```
  1307→┌─────────────────────────────────────────────────────────────────────────────┐
  1308→│                                                                             │
  1309→│   USER PROFILE 结构设计                                                     │
  1310→│                                                                             │
  1311→│   ═══════════════════════════════════════════════════════════════════════   │
  1312→│                                                                             │
  1313→│   存储方式：JSON（PostgreSQL JSONB 字段）                                   │
  1314→│   更新机制：融合式 + 版本化（保留历史，支持回溯）                           │
  1315→│                                                                             │
  1316→│   ─────────────────────────────────────────────────────────────────────     │
  1317→│                                                                             │
  1318→│   Profile JSON Schema                                                       │
  1319→│   ─────────────────────────────────────────────────────────────────────     │
  1320→│                                                                             │
  1321→│   {                                                                         │
  1322→│     "version": "1.0",                                                       │
  1323→│     "updated_at": "2026-01-07T10:30:00Z",                                  │
  1324→│                                                                             │
  1325→│     // ═══════════════════════════════════════════════════════════════      │
  1326→│     // Layer 1: 基础信息（硬数据，用户提供）                                │
  1327→│     // ═══════════════════════════════════════════════════════════════      │
  1328→│     "basic": {                                                              │
  1329→│       "birth_datetime": "1990-03-15T08:30:00",                             │
  1330→│       "birth_location": {                                                   │
  1331→│         "city": "上海",                                                     │
  1332→│         "country": "中国",                                                  │
  1333→│         "timezone": "Asia/Shanghai",                                        │
  1334→│         "coordinates": [121.4737, 31.2304]                                 │
  1335→│       },                                                                    │
  1336→│       "gender": "male",                                                     │
  1337→│       "name": "Alex",                                                       │
  1338→│       "occupation": "产品经理"                                              │
  1339→│     },                                                                      │
  1340→│                                                                             │
  1341→│     // ═══════════════════════════════════════════════════════════════      │
  1342→│     // Layer 2: 生活上下文（软数据，AI 采集/抽取）                          │
  1343→│     // ═══════════════════════════════════════════════════════════════      │
  1344→│     "life_context": {                                                       │
  1345→│       "career": {                                                           │
  1346→│         "status": "employed_considering_change",                            │
  1347→│         "industry": "互联网",                                               │
  1348→│         "years_experience": 8,                                              │
  1349→│         "concerns": ["职业瓶颈", "想尝试创业"]                              │
  1350→│       },                                                                    │
  1351→│       "relationship": {                                                     │
  1352→│         "status": "in_relationship",                                        │
  1353→│         "duration": "3 years",                                              │
  1354→│         "concerns": ["沟通问题", "未来规划不一致"]                          │
  1355→│       },                                                                    │
  1356→│       "current_focus": ["职业方向", "关系问题"],                            │
  1357→│       "life_stage": "career_transition",                                    │
  1358→│       "recent_events": [                                                    │
  1359→│         {"date": "2025-12", "event": "被裁员", "impact": "high"},           │
  1360→│         {"date": "2026-01", "event": "和伴侣争吵", "impact": "medium"}      │
  1361→│       ]                                                                     │
  1362→│     },                                                                      │
  1363→│                                                                             │
  1364→│     // ═══════════════════════════════════════════════════════════════      │
  1365→│     // Layer 3: AI 洞察（LLM 综合推断）                                     │
  1366→│     // ═══════════════════════════════════════════════════════════════      │
  1367→│     "ai_insights": {                                                        │
  1368→│       "personality_traits": [                                               │
  1369→│         {"trait": "追求完美", "confidence": 0.85},                          │
  1370→│         {"trait": "不善表达需求", "confidence": 0.78},                      │
  1371→│         {"trait": "责任感强", "confidence": 0.92}                           │
  1372→│       ],                                                                    │
  1373→│       "communication_style": "理性分析型，倾向于讲道理",                    │
  1374→│       "emotional_patterns": {                                               │
  1375→│         "triggers": ["被忽视", "失去控制感"],                               │
  1376→│         "coping": "压抑然后爆发"                                            │
  1377→│       },                                                                    │
  1378→│       "relationship_patterns": {                                            │
  1379→│         "style": "付出型，不善索取",                                        │
  1380→│         "blind_spots": ["忽视自己的需求"]                                   │
  1381→│       },                                                                    │
  1382→│       "growth_areas": ["学会表达需求", "接受不完美"]                        │
  1383→│     },                                                                      │
  1384→│                                                                             │
  1385→│     // ═══════════════════════════════════════════════════════════════      │
  1386→│     // Layer 4: Identity Prism（心理学框架层）                              │
  1387→│     // ═══════════════════════════════════════════════════════════════      │
  1388→│     "identity_prism": {                                                     │
  1389→│       "core": {                                                             │
  1390→│         "keyword": "追求深度理解",                                          │
  1391→│         "description": "你天生对表象不满足，总想探究本质",                  │
  1392→│         "data_source": "bazi_daymaster + mbti_dominant"                     │
  1393→│       },                                                                    │
  1394→│       "inner": {                                                            │
  1395→│         "keyword": "渴望被认可",                                            │
  1396→│         "description": "在你心里，其实最在意的是被看见和肯定",              │
  1397→│         "data_source": "ai_insight + conversation"                          │
  1398→│       },                                                                    │
  1399→│       "outer": {                                                            │
  1400→│         "keyword": "冷静可靠",                                              │
  1401→│         "description": "你给人的感觉是理性、稳定、可依赖",                  │
  1402→│         "data_source": "bazi_shishen + behavior_pattern"                    │
  1403→│       }                                                                     │
  1404→│     },                                                                      │
  1405→│                                                                             │
  1406→│     // ═══════════════════════════════════════════════════════════════      │
  1407→│     // 用户偏好                                                             │
  1408→│     // ═══════════════════════════════════════════════════════════════      │
  1409→│     "preferences": {                                                        │
  1410→│       "voice_mode": "warm",  // warm | sarcastic                            │
  1411→│       "language": "zh-CN",                                                  │
  1412→│       "notification": false                                                 │
  1413→│     }                                                                       │
  1414→│   }                                                                         │
  1415→│                                                                             │
  1416→│   ─────────────────────────────────────────────────────────────────────     │
  1417→│                                                                             │
  1418→│   版本管理                                                                  │
  1419→│   ─────────────────────────────────────────────────────────────────────     │
  1420→│                                                                             │
  1421→│   • 每次重大更新创建新版本快照                                              │
  1422→│   • 保留最近 10 个版本                                                      │
  1423→│   • 支持回溯查看「你当时是这么说的...」                                     │
  1424→│                                                                             │
  1425→└─────────────────────────────────────────────────────────────────────────────┘
  1426→```
  1427→
  1428→## 4.5 Context 构建机制
  1429→
  1430→```
  1431→┌─────────────────────────────────────────────────────────────────────────────┐
  1432→│                                                                             │
  1433→│   CONTEXT 构建机制                                                          │
  1434→│                                                                             │
  1435→│   ═══════════════════════════════════════════════════════════════════════   │
  1436→│                                                                             │
  1437→│   核心原则                                                                  │
  1438→│   ─────────────────────────────────────────────────────────────────────     │
  1439→│                                                                             │
  1440→│   「充分利用模型的上下文能力，减少系统复杂度。」                            │
  1441→│                                                                             │
  1442→│   • 不做对话摘要，直接使用原始对话                                          │
  1443→│   • 不做过度压缩，保留信息丰富度                                            │
  1444→│   • 根据话题动态选择 Profile 相关部分                                       │
  1445→│                                                                             │
  1446→│   ─────────────────────────────────────────────────────────────────────     │
  1447→│                                                                             │
  1448→│   Context 组成                                                              │
  1449→│   ─────────────────────────────────────────────────────────────────────     │
  1450→│                                                                             │
  1451→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1452→│   │                                                                     │   │
  1453→│   │   1. System Prompt                                                  │   │
  1454→│   │   ─────────────────────────────────────────────────────────         │   │
  1455→│   │   • Vibe Persona 定义                                               │   │
  1456→│   │   • 语气模式设置（温暖/吐槽）                                        │   │
  1457→│   │   • 禁止事项（不预测、不恐吓、不评判）                              │   │
  1458→│   │   • 当前 Skill 上下文（八字/星座）                                  │   │
  1459→│   │                                                                     │   │
  1460→│   │   2. 话题相关 Profile                                               │   │
  1461→│   │   ─────────────────────────────────────────────────────────         │   │
  1462→│   │   • 根据当前话题动态选择 Profile 中的相关部分                       │   │
  1463→│   │   • 例：聊职业 → 注入 career 和 ai_insights.growth_areas           │   │
  1464→│   │   • 例：聊关系 → 注入 relationship 和 relationship_patterns        │   │
  1465→│   │                                                                     │   │
  1466→│   │   3. 知识库检索结果                                                 │   │
  1467→│   │   ─────────────────────────────────────────────────────────         │   │
  1468→│   │   • 根据话题从知识库检索相关内容                                    │   │
  1469→│   │   • 八字理论、格局解读、星座特质等                                  │   │
  1470→│   │                                                                     │   │
  1471→│   │   4. 对话历史                                                       │   │
  1472→│   │   ─────────────────────────────────────────────────────────         │   │
  1473→│   │   • 最近 N 轮对话（不做摘要，原始保留）                             │   │
  1474→│   │   • N 根据 token 预算动态调整                                       │   │
  1475→│   │                                                                     │   │
  1476→│   └─────────────────────────────────────────────────────────────────────┘   │
  1477→│                                                                             │
  1478→│   ─────────────────────────────────────────────────────────────────────     │
  1479→│                                                                             │
  1480→│   Context 构建伪代码                                                        │
  1481→│   ─────────────────────────────────────────────────────────────────────     │
  1482→│                                                                             │
  1483→│   def build_context(user_id, current_message, skill):                       │
  1484→│       # 1. 加载 System Prompt                                               │
  1485→│       system_prompt = load_system_prompt(                                   │
  1486→│           skill=skill,                                                      │
  1487→│           voice_mode=user.preferences.voice_mode                            │
  1488→│       )                                                                     │
  1489→│                                                                             │
  1490→│       # 2. 识别话题，选择相关 Profile 部分                                  │
  1491→│       topic = classify_topic(current_message)                               │
  1492→│       relevant_profile = select_profile_sections(                           │
  1493→│           profile=user.profile,                                             │
  1494→│           topic=topic                                                       │
  1495→│       )                                                                     │
  1496→│                                                                             │
  1497→│       # 3. 检索知识库                                                       │
  1498→│       knowledge = retrieve_knowledge(                                       │
  1499→│           skill=skill,                                                      │

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
