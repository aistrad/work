     1→"use client";
     2→
     3→import { useState, useRef, useEffect } from "react";
     4→import { ChatMessage } from "./ChatMessage";
     5→import { ChatInput } from "./ChatInput";
     6→import { InsightCard, InsightType } from "@/components/insight/InsightCard";
     7→import { VibeGlyph, BreathAura, type SkillType } from "@/components/core";
     8→import { getTokens, sendGuestMessage, sendMessage, ChatResponse } from "@/lib/api";
     9→
    10→interface Message {
    11→  id: string;
    12→  role: "user" | "assistant";
    13→  content: string;
    14→  timestamp?: string;
    15→  insight?: {
    16→    id: string;
    17→    insight_type: InsightType;
    18→    title: string;
    19→    content: string;
    20→  };
    21→}
    22→
    23→export type VoiceMode = "warm" | "sarcastic";
    24→
    25→export interface ChatContainerProps {
    26→  skillId: string;
    27→  skill?: SkillType;
    28→  conversationId?: string;
    29→  voiceMode?: VoiceMode;
    30→  onConversationStart?: (id: string) => void;
    31→}
    32→
    33→// ═══════════════════════════════════════════════════════════════════════════
    34→// ChatEmptyState - LUMINOUS PAPER Design System
    35→// 空状态：居中 VibeGlyph + 技能感知文案 + 呼吸光晕
    36→// ═══════════════════════════════════════════════════════════════════════════
    37→
    38→const SKILL_EMPTY_STATE: Record<SkillType, { title: string; subtitle: string }> = {
    39→  bazi: {
    40→    title: "探索你的命理",
    41→    subtitle: "分享你的生辰，开启八字解读之旅",
    42→  },
    43→  zodiac: {
    44→    title: "倾听星辰的声音",
    45→    subtitle: "让星盘为你揭示宇宙的密语",
    46→  },
    47→  mbti: {
    48→    title: "发现真实的自己",
    49→    subtitle: "通过对话，探索你的人格特质",
    50→  },
    51→  attach: {
    52→    title: "理解你的依恋模式",
    53→    subtitle: "探索亲密关系中的自我",
    54→  },
    55→  career: {
    56→    title: "规划你的职业蓝图",
    57→    subtitle: "让我们一起探索你的职业发展方向",
    58→  },
    59→};
    60→
    61→// Quick prompts for each skill
    62→const SKILL_QUICK_PROMPTS: Record<SkillType, string[]> = {
    63→  bazi: [
    64→    "我是1990年5月15日早上8点出生的",
    65→    "帮我分析今年的运势",
    66→    "我的事业运如何？",
    67→    "什么时候适合做重大决定？",
    68→  ],
    69→  zodiac: [
    70→    "我是双子座，帮我看看本周运势",
    71→    "我的太阳星座和上升星座有什么区别？",
    72→    "双子座和什么星座最配？",
    73→    "水逆对我有什么影响？",
    74→  ],
    75→  mbti: [
    76→    "帮我测测我的MBTI类型",
    77→    "INFP适合什么职业？",
    78→    "我是INTJ，如何改善人际关系？",
    79→    "E人和I人有什么本质区别？",
    80→  ],
    81→  attach: [
    82→    "帮我分析我的依恋类型",
    83→    "回避型依恋如何建立亲密关系？",
    84→    "为什么我总是害怕被抛弃？",
    85→    "如何治愈童年的情感创伤？",
    86→  ],
    87→  career: [
    88→    "我该如何规划职业发展？",
    89→    "我适合创业还是打工？",
    90→    "如何在面试中展现自己？",
    91→    "转行需要考虑什么？",
    92→  ],
    93→};
    94→
    95→function ChatEmptyState({ skill, onQuickPrompt }: { skill: SkillType; onQuickPrompt?: (prompt: string) => void }) {
    96→  const config = SKILL_EMPTY_STATE[skill] || SKILL_EMPTY_STATE.bazi;
    97→  const quickPrompts = SKILL_QUICK_PROMPTS[skill] || SKILL_QUICK_PROMPTS.bazi;
    98→
    99→  return (
   100→    <div className="flex flex-col items-center justify-center max-w-xl mx-auto px-4 py-8">
   101→      {/* Animated glyph with enhanced aura */}
   102→      <div className="relative flex items-center justify-center mb-6">
   103→        {/* Outer pulsing ring */}
   104→        <div className="absolute w-20 h-20 rounded-full border border-skill-primary/20 animate-pulse-slow" />
   105→        <div className="absolute w-28 h-28 rounded-full border border-skill-primary/10 animate-pulse-slower" />
   106→
   107→        {/* Breath aura */}
   108→        <BreathAura
   109→          skill={skill}
   110→          size="md"
   111→          position="center"
   112→          intensity="medium"
   113→          className="opacity-40"
   114→        />
   115→
   116→        {/* Central glyph */}
   117→        <VibeGlyph
   118→          size="sm"
   119→          skill={skill}
   120→          showAura={true}
   121→          animate={true}
   122→          className="relative z-10"
   123→        />
   124→      </div>
   125→
   126→      {/* Title */}
   127→      <h3 className="text-lg md:text-xl font-serif font-semibold text-foreground mb-1 text-center">
   128→        {config.title}
   129→      </h3>
   130→
   131→      {/* Subtitle */}
   132→      <p className="text-sm text-muted-foreground max-w-sm text-center mb-6">
   133→        {config.subtitle}
   134→      </p>
   135→
   136→      {/* Quick prompt suggestions */}
   137→      <div className="w-full space-y-2">
   138→        <p className="text-xs text-muted-foreground/60 text-center mb-2">
   139→          试试这样问
   140→        </p>
   141→        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
   142→          {quickPrompts.map((prompt, index) => (
   143→            <button
   144→              key={index}
   145→              onClick={() => onQuickPrompt?.(prompt)}
   146→              className="group relative px-3 py-2 text-left text-sm text-muted-foreground
   147→                       bg-card hover:bg-card/80 border border-border/50 hover:border-border
   148→                       rounded-lg transition-all duration-200
   149→                       hover:shadow-sm"
   150→            >
   151→              <span className="line-clamp-2">{prompt}</span>
   152→            </button>
   153→          ))}
   154→        </div>
   155→      </div>
   156→    </div>
   157→  );
   158→}
   159→
   160→export function ChatContainer({
   161→  skillId,
   162→  skill = "bazi",
   163→  conversationId,
   164→  voiceMode = "warm",
   165→  onConversationStart,
   166→}: ChatContainerProps) {
   167→  const [messages, setMessages] = useState<Message[]>([]);
   168→  const [isLoading, setIsLoading] = useState(false);
   169→  const [currentConvoId, setCurrentConvoId] = useState(conversationId);
   170→  const messagesEndRef = useRef<HTMLDivElement>(null);
   171→
   172→  // Map skillId to SkillType if not provided
   173→  const activeSkill: SkillType = skill || (skillId as SkillType) || "bazi";
   174→
   175→  const scrollToBottom = () => {
   176→    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
   177→  };
   178→
   179→  useEffect(() => {
   180→    scrollToBottom();
   181→  }, [messages]);
   182→
   183→  const handleSend = async (content: string) => {
   184→    // Add user message
   185→    const userMessage: Message = {
   186→      id: Date.now().toString(),
   187→      role: "user",
   188→      content,
   189→      timestamp: new Date().toLocaleTimeString(),
   190→    };
   191→    setMessages((prev) => [...prev, userMessage]);
   192→    setIsLoading(true);
   193→
   194→    try {
   195→      const { accessToken } = getTokens();
   196→
   197→      if (accessToken) {
   198→        const response: ChatResponse = await sendMessage({
   199→          message: content,
   200→          skill_id: skillId,
   201→          conversation_id: currentConvoId,
   202→        });
   203→
   204→        // Update conversation ID
   205→        if (!currentConvoId && response.conversation_id) {
   206→          setCurrentConvoId(response.conversation_id);
   207→          onConversationStart?.(response.conversation_id);
   208→        }
   209→
   210→        // Add assistant message with potential insight
   211→        const assistantMessage: Message = {
   212→          id: (Date.now() + 1).toString(),
   213→          role: "assistant",
   214→          content: response.content,
   215→          timestamp: new Date().toLocaleTimeString(),
   216→          insight: response.insight ? {
   217→            id: response.insight.id,
   218→            insight_type: response.insight.insight_type as InsightType,
   219→            title: response.insight.title,
   220→            content: response.insight.content,
   221→          } : undefined,
   222→        };
   223→        setMessages((prev) => [...prev, assistantMessage]);
   224→      } else {
   225→        // Guest mode: use the public endpoint for progressive disclosure
   226→        const response = await sendGuestMessage(content, skillId);
   227→        const assistantMessage: Message = {
   228→          id: (Date.now() + 1).toString(),
   229→          role: "assistant",
   230→          content: response.content,
   231→          timestamp: new Date().toLocaleTimeString(),
   232→        };
   233→        setMessages((prev) => [...prev, assistantMessage]);
   234→
   235→        if (response.suggestion) {
   236→          setMessages((prev) => [
   237→            ...prev,
   238→            {
   239→              id: (Date.now() + 2).toString(),
   240→              role: "assistant",
   241→              content: response.suggestion,
   242→              timestamp: new Date().toLocaleTimeString(),
   243→            },
   244→          ]);
   245→        }
   246→      }
   247→    } catch (error) {
   248→      console.error("Chat error:", error);
   249→      // Add error message
   250→      setMessages((prev) => [...prev, {
   251→        id: (Date.now() + 1).toString(),
   252→        role: "assistant",
   253→        content: "抱歉，出了点问题。请稍后再试。",
   254→      }]);
   255→    } finally {
   256→      setIsLoading(false);
   257→    }
   258→  };
   259→
   260→  const hasMessages = messages.length > 0;
   261→
   262→  return (
   263→    <div className="flex flex-col h-full" data-skill={activeSkill}>
   264→      {/* Messages area */}
   265→      <div className={`flex-1 overflow-y-auto relative min-h-0 ${hasMessages ? 'px-4 pt-4 pb-2' : 'flex items-end justify-center pb-4'}`}>
   266→        {!hasMessages ? (
   267→          <ChatEmptyState skill={activeSkill} onQuickPrompt={handleSend} />
   268→        ) : null}
   269→        {messages.map((message) => (
   270→          <div key={message.id}>
   271→            <ChatMessage
   272→              role={message.role}
   273→              content={message.content}
   274→              timestamp={message.timestamp}
   275→            />
   276→            {/* Show insight card if present */}
   277→            {message.insight && (
   278→              <div className="ml-12 mt-2 mb-4">
   279→                <InsightCard
   280→                  type={message.insight.insight_type}
   281→                  title={message.insight.title}
   282→                  content={message.insight.content}
   283→                  onSave={() => console.log("Save insight:", message.insight?.id)}
   284→                  onShare={() => console.log("Share insight:", message.insight?.id)}
   285→                />
   286→              </div>
   287→            )}
   288→          </div>
   289→        ))}
   290→        {isLoading && (
   291→          <ChatMessage
   292→            role="assistant"
   293→            content=""
   294→            isStreaming
   295→          />
   296→        )}
   297→        <div ref={messagesEndRef} />
   298→      </div>
   299→
   300→      {/* Input */}
   301→      <ChatInput onSend={handleSend} disabled={isLoading} />
   302→    </div>
   303→  );
   304→}
   305→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
