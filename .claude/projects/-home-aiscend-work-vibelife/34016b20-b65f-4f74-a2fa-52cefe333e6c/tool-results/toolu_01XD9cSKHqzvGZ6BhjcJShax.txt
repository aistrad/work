     1→"use client";
     2→
     3→/**
     4→ * ChartPanel - Chart Tab 的右侧 Panel 内容
     5→ * 显示: BaziChart + Identity Prism + 人生 K 线 + Now/Next 趋势 + 报告入口
     6→ *
     7→ * 注: Bazi/Zodiac/MBTI 各自设计不同的内容
     8→ */
     9→
    10→import { cn } from "@/lib/utils";
    11→import { type SkillType } from "@/components/core";
    12→import { IdentityPrism, type PrismContent } from "@/components/identity/IdentityPrism";
    13→import { LifeKLine, type FortuneDataPoint } from "@/components/trend/LifeKLine";
    14→import { NowNextCard as NowNextCardComponent } from "@/components/trend/NowNextCard";
    15→import { BaziChart } from "@/components/chart/BaziChart";
    16→import {
    17→  FileText,
    18→  TrendingUp,
    19→  Calendar,
    20→  Sparkles,
    21→  ChevronRight,
    22→  Download,
    23→} from "lucide-react";
    24→
    25→// ═══════════════════════════════════════════════════════════════════════════
    26→// Types
    27→// ═══════════════════════════════════════════════════════════════════════════
    28→
    29→// 五行类型
    30→type Element = "wood" | "fire" | "earth" | "metal" | "water";
    31→
    32→// 天干地支数据
    33→interface Pillar {
    34→  stem: string;
    35→  branch: string;
    36→  element: Element;
    37→  tenGod?: string;
    38→}
    39→
    40→interface BaziData {
    41→  year: Pillar;
    42→  month: Pillar;
    43→  day: Pillar;
    44→  hour?: Pillar;
    45→}
    46→
    47→interface ChartPanelProps {
    48→  skill: SkillType;
    49→  /** 八字数据 (仅 bazi skill) */
    50→  baziData?: BaziData;
    51→  /** Now/Next 数据 (新格式) */
    52→  nowNextData?: {
    53→    now: {
    54→      theme: string;
    55→      warning?: string;
    56→      action?: string;
    57→    };
    58→    next: {
    59→      startDate: string;
    60→      theme: string;
    61→    };
    62→  };
    63→  /** K线简要数据 */
    64→  klinePreview?: {
    65→    currentScore: number;
    66→    trend: "up" | "down" | "stable";
    67→    period: string;
    68→  };
    69→  /** 完整 K 线数据 */
    70→  klineData?: FortuneDataPoint[];
    71→  /** Identity Prism 数据 */
    72→  prismContent?: PrismContent;
    73→  /** 是否有完整报告 */
    74→  hasReport?: boolean;
    75→  /** 是否展开 K 线 */
    76→  showFullKLine?: boolean;
    77→  onViewKLine?: () => void;
    78→  onGenerateReport?: () => void;
    79→  onDownloadReport?: () => void;
    80→  className?: string;
    81→}
    82→
    83→// ═══════════════════════════════════════════════════════════════════════════
    84→// Skill-specific Content
    85→// ═══════════════════════════════════════════════════════════════════════════
    86→
    87→const SKILL_CHART_CONFIG: Record<SkillType, {
    88→  klineLabel: string;
    89→  reportLabel: string;
    90→  identityLabel: string;
    91→}> = {
    92→  bazi: {
    93→    klineLabel: "人生 K 线",
    94→    reportLabel: "八字完整报告",
    95→    identityLabel: "命盘身份视角",
    96→  },
    97→  zodiac: {
    98→    klineLabel: "星象周期",
    99→    reportLabel: "星盘完整报告",
   100→    identityLabel: "星盘身份视角",
   101→  },
   102→  mbti: {
   103→    klineLabel: "成长轨迹",
   104→    reportLabel: "人格完整报告",
   105→    identityLabel: "人格身份视角",
   106→  },
   107→  attach: {
   108→    klineLabel: "关系轨迹",
   109→    reportLabel: "依恋模式报告",
   110→    identityLabel: "依恋身份视角",
   111→  },
   112→  career: {
   113→    klineLabel: "职业轨迹",
   114→    reportLabel: "职业发展报告",
   115→    identityLabel: "职业身份视角",
   116→  },
   117→};
   118→
   119→// ═══════════════════════════════════════════════════════════════════════════
   120→// Sub-components
   121→// ═══════════════════════════════════════════════════════════════════════════
   122→
   123→function NowNextCard({ data }: { data: ChartPanelProps["nowNextData"] }) {
   124→  if (!data) {
   125→    return (
   126→      <div className="glass-card rounded-xl p-4 text-center text-muted-foreground text-sm">
   127→        完成更多对话后，这里会显示你的当前阶段和下一步建议
   128→      </div>
   129→    );
   130→  }
   131→
   132→  return <NowNextCardComponent now={data.now} next={data.next} />;
   133→}
   134→
   135→function KLinePreviewCard({
   136→  data,
   137→  label,
   138→  onClick,
   139→}: {
   140→  data?: ChartPanelProps["klinePreview"];
   141→  label: string;
   142→  onClick?: () => void;
   143→}) {
   144→  const getTrendIcon = () => {
   145→    if (!data) return null;
   146→    switch (data.trend) {
   147→      case "up":
   148→        return <TrendingUp className="w-4 h-4 text-emerald-500" />;
   149→      case "down":
   150→        return <TrendingUp className="w-4 h-4 text-red-500 rotate-180" />;
   151→      default:
   152→        return <div className="w-4 h-0.5 bg-muted-foreground" />;
   153→    }
   154→  };
   155→
   156→  return (
   157→    <button
   158→      onClick={onClick}
   159→      className="w-full glass-card rounded-xl p-4 text-left hover:shadow-md transition-all group"
   160→    >
   161→      <div className="flex items-center justify-between mb-3">
   162→        <div className="flex items-center gap-2">
   163→          <Calendar className="w-4 h-4 text-skill-primary" />
   164→          <span className="text-sm font-medium text-foreground">{label}</span>
   165→        </div>
   166→        <ChevronRight className="w-4 h-4 text-muted-foreground group-hover:translate-x-1 transition-transform" />
   167→      </div>
   168→
   169→      {data ? (
   170→        <div className="flex items-center justify-between">
   171→          <div>
   172→            <div className="text-2xl font-serif font-bold text-foreground">
   173→              {data.currentScore}
   174→            </div>
   175→            <div className="text-xs text-muted-foreground">{data.period}</div>
   176→          </div>
   177→          <div className="flex items-center gap-1">
   178→            {getTrendIcon()}
   179→            <span className={cn(
   180→              "text-sm font-medium",
   181→              data.trend === "up" && "text-emerald-500",
   182→              data.trend === "down" && "text-red-500",
   183→              data.trend === "stable" && "text-muted-foreground"
   184→            )}>
   185→              {data.trend === "up" ? "上升" : data.trend === "down" ? "下降" : "平稳"}
   186→            </span>
   187→          </div>
   188→        </div>
   189→      ) : (
   190→        <p className="text-sm text-muted-foreground">
   191→          查看你的运势走势图
   192→        </p>
   193→      )}
   194→    </button>
   195→  );
   196→}
   197→
   198→function ReportCard({
   199→  label,
   200→  hasReport,
   201→  onGenerate,
   202→  onDownload,
   203→}: {
   204→  label: string;
   205→  hasReport?: boolean;
   206→  onGenerate?: () => void;
   207→  onDownload?: () => void;
   208→}) {
   209→  return (
   210→    <div className="glass-card rounded-xl p-4">
   211→      <div className="flex items-center gap-2 mb-3">
   212→        <FileText className="w-4 h-4 text-skill-primary" />
   213→        <span className="text-sm font-medium text-foreground">{label}</span>
   214→      </div>
   215→
   216→      {hasReport ? (
   217→        <div className="space-y-2">
   218→          <p className="text-sm text-muted-foreground">
   219→            你的专属报告已生成
   220→          </p>
   221→          <div className="flex gap-2">
   222→            <button
   223→              onClick={onDownload}
   224→              className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-skill-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity"
   225→            >
   226→              <Download className="w-4 h-4" />
   227→              下载报告
   228→            </button>
   229→          </div>
   230→        </div>
   231→      ) : (
   232→        <div className="space-y-2">
   233→          <p className="text-sm text-muted-foreground">
   234→            生成一份专属于你的深度分析报告
   235→          </p>
   236→          <button
   237→            onClick={onGenerate}
   238→            className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-skill-primary text-white rounded-lg text-sm font-medium hover:opacity-90 transition-opacity"
   239→          >
   240→            <Sparkles className="w-4 h-4" />
   241→            生成报告
   242→          </button>
   243→        </div>
   244→      )}
   245→    </div>
   246→  );
   247→}
   248→
   249→// ═══════════════════════════════════════════════════════════════════════════
   250→// ChartPanel Component
   251→// ═══════════════════════════════════════════════════════════════════════════
   252→
   253→export function ChartPanel({
   254→  skill,
   255→  baziData,
   256→  nowNextData,
   257→  klinePreview,
   258→  klineData,
   259→  prismContent,
   260→  hasReport,
   261→  showFullKLine = false,
   262→  onViewKLine,
   263→  onGenerateReport,
   264→  onDownloadReport,
   265→  className,
   266→}: ChartPanelProps) {
   267→  const config = SKILL_CHART_CONFIG[skill];
   268→
   269→  return (
   270→    <div className={cn("h-full overflow-y-auto p-5 space-y-6", className)}>
   271→      {/* Bazi Chart Section (仅 bazi skill) */}
   272→      {skill === "bazi" && baziData && (
   273→        <section>
   274→          <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
   275→            八字命盘
   276→          </h2>
   277→          <div className="glass-card rounded-xl p-4">
   278→            <BaziChart
   279→              pillars={baziData}
   280→              showTenGods={true}
   281→              showElements={true}
   282→              size="md"
   283→              variant="full"
   284→            />
   285→          </div>
   286→        </section>
   287→      )}
   288→
   289→      {/* Identity Prism Section */}
   290→      {prismContent && (
   291→        <section>
   292→          <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
   293→            {config.identityLabel}
   294→          </h2>
   295→          <IdentityPrism content={prismContent} />
   296→        </section>
   297→      )}
   298→
   299→      {/* Now/Next Section */}
   300→      <section>
   301→        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
   302→          当前与下一步
   303→        </h2>
   304→        <NowNextCard data={nowNextData} />
   305→      </section>
   306→
   307→      {/* K-Line Section */}
   308→      <section>
   309→        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
   310→          {config.klineLabel}
   311→        </h2>
   312→        {klineData && klineData.length > 0 ? (
   313→          /* Full K-Line Chart */
   314→          <LifeKLine
   315→            data={klineData}
   316→            dimension="year"
   317→            height={280}
   318→            onPointClick={(point) => console.log("Clicked:", point)}
   319→          />
   320→        ) : (
   321→          /* Preview Card */
   322→          <KLinePreviewCard
   323→            data={klinePreview}
   324→            label={config.klineLabel}
   325→            onClick={onViewKLine}
   326→          />
   327→        )}
   328→      </section>
   329→
   330→      {/* Report Section */}
   331→      <section>
   332→        <h2 className="font-serif text-lg font-semibold text-foreground mb-3">
   333→          深度报告
   334→        </h2>
   335→        <ReportCard
   336→          label={config.reportLabel}
   337→          hasReport={hasReport}
   338→          onGenerate={onGenerateReport}
   339→          onDownload={onDownloadReport}
   340→        />
   341→      </section>
   342→    </div>
   343→  );
   344→}
   345→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
