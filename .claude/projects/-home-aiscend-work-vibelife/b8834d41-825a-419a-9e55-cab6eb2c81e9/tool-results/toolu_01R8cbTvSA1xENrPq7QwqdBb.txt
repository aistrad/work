     1â†’"use client";
     2â†’
     3â†’/**
     4â†’ * ChatContainer - v5.2 æ€§èƒ½ä¼˜åŒ–ç‰ˆ
     5â†’ *
     6â†’ * ä¼˜åŒ–ç‚¹:
     7â†’ * 1. ä½¿ç”¨ content-visibility ä¼˜åŒ–é•¿æ¶ˆæ¯åˆ—è¡¨ (Vercel rule: rendering-content-visibility)
     8â†’ * 2. Memoize ChatEmptyState ç»„ä»¶ (Vercel rule: rerender-extract-component)
     9â†’ * 3. ä½¿ç”¨ç¼“å­˜çš„ localStorage å·¥å…· (Vercel rule: js-cache-storage)
    10â†’ */
    11â†’
    12â†’import { useRef, useEffect, useMemo, useCallback, useState, memo } from "react";
    13â†’import type { Message } from "ai/react";
    14â†’import { toast } from "sonner";
    15â†’import { ChatMessage } from "./ChatMessage";
    16â†’import { ChatInput } from "./ChatInput";
    17â†’import { InsightCard, InsightType } from "@/components/insight/InsightCard";
    18â†’import { VibeGlyph, BreathAura, type SkillType } from "@/components/core";
    19â†’import { DailyGreeting } from "@/components/greeting/DailyGreeting";
    20â†’import { useVibeChat, type SkillId } from "@/hooks/useVibeChat";
    21â†’import { getLocalStorageJSON, getLocalStorage, setLocalStorage } from "@/utils/storage";
    22â†’
    23â†’interface InsightData {
    24â†’  id: string;
    25â†’  insight_type: InsightType;
    26â†’  title: string;
    27â†’  content: string;
    28â†’}
    29â†’
    30â†’/**
    31â†’ * Extract text content from AI SDK Message
    32â†’ */
    33â†’function getMessageContent(message: Message): string {
    34â†’  return message.content || '';
    35â†’}
    36â†’
    37â†’export type VoiceMode = "warm" | "sarcastic";
    38â†’
    39â†’export interface ChatContainerProps {
    40â†’  skillId: string;
    41â†’  skill?: SkillType;
    42â†’  conversationId?: string;
    43â†’  voiceMode?: VoiceMode;
    44â†’  onConversationStart?: (id: string) => void;
    45â†’}
    46â†’
    47â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    48â†’// ChatEmptyState - LUMINOUS PAPER Design System
    49â†’// ç©ºçŠ¶æ€ï¼šå±…ä¸­ VibeGlyph + æŠ€èƒ½æ„ŸçŸ¥æ–‡æ¡ˆ + å‘¼å¸å…‰æ™•
    50â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    51â†’
    52â†’const SKILL_EMPTY_STATE: Record<SkillType, { title: string; subtitle: string }> = {
    53â†’  bazi: {
    54â†’    title: "æ¢ç´¢ä½ çš„å‘½ç†",
    55â†’    subtitle: "åˆ†äº«ä½ çš„ç”Ÿè¾°ï¼Œå¼€å¯å…«å­—è§£è¯»ä¹‹æ—…",
    56â†’  },
    57â†’  zodiac: {
    58â†’    title: "å€¾å¬æ˜Ÿè¾°çš„å£°éŸ³",
    59â†’    subtitle: "è®©æ˜Ÿç›˜ä¸ºä½ æ­ç¤ºå®‡å®™çš„å¯†è¯­",
    60â†’  },
    61â†’  mbti: {
    62â†’    title: "å‘ç°çœŸå®çš„è‡ªå·±",
    63â†’    subtitle: "é€šè¿‡å¯¹è¯ï¼Œæ¢ç´¢ä½ çš„äººæ ¼ç‰¹è´¨",
    64â†’  },
    65â†’  attach: {
    66â†’    title: "ç†è§£ä½ çš„ä¾æ‹æ¨¡å¼",
    67â†’    subtitle: "æ¢ç´¢äº²å¯†å…³ç³»ä¸­çš„è‡ªæˆ‘",
    68â†’  },
    69â†’  career: {
    70â†’    title: "è§„åˆ’ä½ çš„èŒä¸šè“å›¾",
    71â†’    subtitle: "è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä½ çš„èŒä¸šå‘å±•æ–¹å‘",
    72â†’  },
    73â†’};
    74â†’
    75â†’// Quick prompts for each skill with icons and categories
    76â†’interface QuickPromptItem {
    77â†’  icon: string;
    78â†’  category: string;
    79â†’  question: string;
    80â†’  gradient: string;
    81â†’}
    82â†’
    83â†’const SKILL_QUICK_PROMPTS: Record<SkillType, QuickPromptItem[]> = {
    84â†’  bazi: [
    85â†’    { icon: "ğŸ‚", category: "ç”Ÿè¾°ä¿¡æ¯", question: "æˆ‘æ˜¯1990å¹´5æœˆ15æ—¥æ—©ä¸Š8ç‚¹å‡ºç”Ÿçš„", gradient: "from-blue-500/10 to-cyan-500/10" },
    86â†’    { icon: "ğŸ“ˆ", category: "è¿åŠ¿åˆ†æ", question: "å¸®æˆ‘åˆ†æä»Šå¹´çš„è¿åŠ¿", gradient: "from-purple-500/10 to-pink-500/10" },
    87â†’    { icon: "ğŸ’¼", category: "äº‹ä¸šå‘å±•", question: "æˆ‘çš„äº‹ä¸šè¿å¦‚ä½•ï¼Ÿ", gradient: "from-orange-500/10 to-red-500/10" },
    88â†’    { icon: "â°", category: "æ—¶æœºé€‰æ‹©", question: "ä»€ä¹ˆæ—¶å€™é€‚åˆåšé‡å¤§å†³å®šï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
    89â†’  ],
    90â†’  zodiac: [
    91â†’    { icon: "â­", category: "è¿åŠ¿æŸ¥è¯¢", question: "æˆ‘æ˜¯åŒå­åº§ï¼Œå¸®æˆ‘çœ‹çœ‹æœ¬å‘¨è¿åŠ¿", gradient: "from-purple-500/10 to-pink-500/10" },
    92â†’    { icon: "ğŸŒ™", category: "æ˜Ÿç›˜è§£è¯»", question: "æˆ‘çš„å¤ªé˜³æ˜Ÿåº§å’Œä¸Šå‡æ˜Ÿåº§æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ", gradient: "from-indigo-500/10 to-purple-500/10" },
    93â†’    { icon: "ğŸ’•", category: "å…³ç³»åŒ¹é…", question: "åŒå­åº§å’Œä»€ä¹ˆæ˜Ÿåº§æœ€é…ï¼Ÿ", gradient: "from-rose-500/10 to-pink-500/10" },
    94â†’    { icon: "ğŸŒ€", category: "æ˜Ÿè±¡å½±å“", question: "æ°´é€†å¯¹æˆ‘æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ", gradient: "from-blue-500/10 to-cyan-500/10" },
    95â†’  ],
    96â†’  mbti: [
    97â†’    { icon: "ğŸ”", category: "ç±»å‹æµ‹è¯•", question: "å¸®æˆ‘æµ‹æµ‹æˆ‘çš„MBTIç±»å‹", gradient: "from-blue-500/10 to-cyan-500/10" },
    98â†’    { icon: "ğŸ’¼", category: "èŒä¸šå»ºè®®", question: "INFPé€‚åˆä»€ä¹ˆèŒä¸šï¼Ÿ", gradient: "from-orange-500/10 to-amber-500/10" },
    99â†’    { icon: "ğŸ‘¥", category: "äººé™…å…³ç³»", question: "æˆ‘æ˜¯INTJï¼Œå¦‚ä½•æ”¹å–„äººé™…å…³ç³»ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   100â†’    { icon: "âš¡", category: "ç±»å‹å¯¹æ¯”", question: "Eäººå’ŒIäººæœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ", gradient: "from-purple-500/10 to-pink-500/10" },
   101â†’  ],
   102â†’  attach: [
   103â†’    { icon: "ğŸ”", category: "ç±»å‹åˆ†æ", question: "å¸®æˆ‘åˆ†ææˆ‘çš„ä¾æ‹ç±»å‹", gradient: "from-blue-500/10 to-cyan-500/10" },
   104â†’    { icon: "ğŸ’‘", category: "å…³ç³»å»ºè®¾", question: "å›é¿å‹ä¾æ‹å¦‚ä½•å»ºç«‹äº²å¯†å…³ç³»ï¼Ÿ", gradient: "from-rose-500/10 to-pink-500/10" },
   105â†’    { icon: "ğŸ›¡ï¸", category: "å†…å¿ƒæ¢ç´¢", question: "ä¸ºä»€ä¹ˆæˆ‘æ€»æ˜¯å®³æ€•è¢«æŠ›å¼ƒï¼Ÿ", gradient: "from-amber-500/10 to-orange-500/10" },
   106â†’    { icon: "ğŸ’š", category: "è‡ªæˆ‘ç–—æ„ˆ", question: "å¦‚ä½•æ²»æ„ˆç«¥å¹´çš„æƒ…æ„Ÿåˆ›ä¼¤ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   107â†’  ],
   108â†’  career: [
   109â†’    { icon: "ğŸ¯", category: "èŒä¸šè§„åˆ’", question: "æˆ‘è¯¥å¦‚ä½•è§„åˆ’èŒä¸šå‘å±•ï¼Ÿ", gradient: "from-blue-500/10 to-cyan-500/10" },
   110â†’    { icon: "ğŸš€", category: "æ–¹å‘é€‰æ‹©", question: "æˆ‘é€‚åˆåˆ›ä¸šè¿˜æ˜¯æ‰“å·¥ï¼Ÿ", gradient: "from-orange-500/10 to-red-500/10" },
   111â†’    { icon: "ğŸ’ª", category: "é¢è¯•æŠ€å·§", question: "å¦‚ä½•åœ¨é¢è¯•ä¸­å±•ç°è‡ªå·±ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   112â†’    { icon: "ğŸ”„", category: "èŒä¸šè½¬å‹", question: "è½¬è¡Œéœ€è¦è€ƒè™‘ä»€ä¹ˆï¼Ÿ", gradient: "from-purple-500/10 to-pink-500/10" },
   113â†’  ],
   114â†’};
   115â†’
   116â†’// API calls now go through Next.js API routes
   117â†’
   118â†’// æœ¬åœ° fallback æ•°æ®ç”Ÿæˆ
   119â†’function getLocalGreetingData(skill: SkillType) {
   120â†’  const now = new Date();
   121â†’  const hour = now.getHours();
   122â†’  const month = now.getMonth();
   123â†’  const day = now.getDate();
   124â†’  const isoDate = now.toISOString().slice(0, 10);
   125â†’
   126â†’  // ç¡®å®šæ—¶æ®µ
   127â†’  type TimeOfDay = "dawn" | "morning" | "afternoon" | "evening" | "night";
   128â†’  let timeOfDay: TimeOfDay = "morning";
   129â†’  let greeting = "æ–°çš„ä¸€å¤©å¼€å§‹äº†";
   130â†’
   131â†’  if (hour >= 5 && hour < 7) {
   132â†’    timeOfDay = "dawn";
   133â†’    greeting = "æ™¨å…‰ç†¹å¾®";
   134â†’  } else if (hour >= 7 && hour < 12) {
   135â†’    timeOfDay = "morning";
   136â†’    greeting = "æ„¿ä½ èƒ½é‡æ»¡æ»¡";
   137â†’  } else if (hour >= 12 && hour < 18) {
   138â†’    timeOfDay = "afternoon";
   139â†’    greeting = "ä¿æŒä¸“æ³¨";
   140â†’  } else if (hour >= 18 && hour < 21) {
   141â†’    timeOfDay = "evening";
   142â†’    greeting = "è¾›è‹¦ä¸€å¤©äº†";
   143â†’  } else {
   144â†’    timeOfDay = "night";
   145â†’    greeting = "å¤œæ·±äº†ï¼Œæ—©ç‚¹ä¼‘æ¯";
   146â†’  }
   147â†’
   148â†’  const solarTerms = [
   149â†’    "å°å¯’", "å¤§å¯’", "ç«‹æ˜¥", "é›¨æ°´", "æƒŠè›°", "æ˜¥åˆ†",
   150â†’    "æ¸…æ˜", "è°·é›¨", "ç«‹å¤", "å°æ»¡", "èŠ’ç§", "å¤è‡³",
   151â†’    "å°æš‘", "å¤§æš‘", "ç«‹ç§‹", "å¤„æš‘", "ç™½éœ²", "ç§‹åˆ†",
   152â†’    "å¯’éœ²", "éœœé™", "ç«‹å†¬", "å°é›ª", "å¤§é›ª", "å†¬è‡³",
   153â†’  ];
   154â†’  const termIdx = month * 2 + (day >= 15 ? 1 : 0);
   155â†’  const solarTerm = solarTerms[termIdx % 24];
   156â†’
   157â†’  const seasonTips: Record<string, string> = {
   158â†’    å°å¯’: "å†¬è—æ—¶èŠ‚ï¼Œåˆ©äºå›é¡¾ä¸è§„åˆ’", å¤§å¯’: "ä¸¥å¯’ä¹‹é™…ï¼Œè“„åŠ›å¾…å‘",
   159â†’    ç«‹æ˜¥: "ä¸‡ç‰©å¤è‹ï¼Œé€‚åˆå¯åŠ¨æ–°è®¡åˆ’", é›¨æ°´: "æ¶¦ç‰©æ— å£°ï¼Œé™å¿ƒæ»‹å…»",
   160â†’    æƒŠè›°: "æ˜¥é›·æƒŠé†’ï¼Œè¡ŒåŠ¨èµ·æ¥", æ˜¥åˆ†: "æ˜¼å¤œå¹³åˆ†ï¼Œè°ƒå’Œèº«å¿ƒ",
   161â†’    æ¸…æ˜: "å¤©æ¸…åœ°æ˜ï¼Œæ•´ç†æ€ç»ª", è°·é›¨: "é›¨ç”Ÿç™¾è°·ï¼Œæ’­ç§å¸Œæœ›",
   162â†’    ç«‹å¤: "å¤æ°”æ¸ç››ï¼Œä¿æŒæ´»åŠ›", å°æ»¡: "å°æœ‰æ‰€æˆï¼Œç»§ç»­åŠªåŠ›",
   163â†’    èŠ’ç§: "æ’­ç§æ”¶è·ï¼Œå‹¤å‹‰ä¸æ‡ˆ", å¤è‡³: "é˜³æ°”é¼ç››ï¼Œé€‚åº¦ä¼‘æ¯",
   164â†’    å°æš‘: "æš‘æ°”åˆå‡ï¼Œæ¸…å¿ƒå®ç¥", å¤§æš‘: "é…·æš‘éš¾è€ï¼Œé™ä»¥å…»å¿ƒ",
   165â†’    ç«‹ç§‹: "ç§‹æ„æ¸èµ·ï¼Œæ”¶è·æ—¶èŠ‚", å¤„æš‘: "æš‘æ°”æ¸æ¶ˆï¼Œè°ƒæ•´èŠ‚å¥",
   166â†’    ç™½éœ²: "ç§‹å‡‰æ¸æµ“ï¼Œæ”¶æ•›å¿ƒç¥", ç§‹åˆ†: "ç§‹é«˜æ°”çˆ½ï¼Œå¹³è¡¡å·¥ä½œä¸ç”Ÿæ´»",
   167â†’    å¯’éœ²: "éœ²æ°´æ¸å¯’ï¼Œæ³¨æ„ä¿å…»", éœœé™: "éœœé™æ°´æ³½ï¼Œæ²‰æ·€ç§¯ç´¯",
   168â†’    ç«‹å†¬: "å†¬å­£æ¥ä¸´ï¼Œå‚¨å¤‡èƒ½é‡", å°é›ª: "é›ªèŠ±åˆé™ï¼Œå†…çœæ—¶åˆ»",
   169â†’    å¤§é›ª: "ç‘é›ªå…†ä¸°ï¼Œé™å¾…æ¥å¹´", å†¬è‡³: "ä¸€é˜³åˆç”Ÿï¼Œå¦ææ³°æ¥",
   170â†’  };
   171â†’
   172â†’  const baziHints: Record<string, string> = {
   173â†’    å°å¯’: "æ°´æ—ºä¹‹å­£ï¼Œåˆ©äºæ€è€ƒä¸è§„åˆ’", å¤§å¯’: "æ°´æ°”æœ€ç››ï¼Œé€‚åˆå†…çœæ²‰æ·€",
   174â†’    ç«‹æ˜¥: "æœ¨æ°”åˆç”Ÿï¼Œå®œå¼€å¯æ–°äº‹ä¸š", æ˜¥åˆ†: "æœ¨æ°”æ—ºç››ï¼Œé€‚åˆæ‹“å±•äººè„‰",
   175â†’    ç«‹å¤: "ç«æ°”æ¸å‡ï¼Œåˆ©äºè¡¨è¾¾å±•ç°", å¤è‡³: "ç«æ°”æ­£ç››ï¼Œæ³¨æ„å¹³è¡¡",
   176â†’    ç«‹ç§‹: "é‡‘æ°”åˆç”Ÿï¼Œé€‚åˆå†³æ–­å–èˆ", ç§‹åˆ†: "é‡‘æ°”æ—ºç››ï¼Œåˆ©äºæ”¶è·æˆæœ",
   177â†’    ç«‹å†¬: "æ°´æ°”åˆç”Ÿï¼Œå®œä¼‘å…»ç”Ÿæ¯", å†¬è‡³: "ä¸€é˜³å¤å§‹ï¼Œåšç§¯è–„å‘",
   178â†’  };
   179â†’
   180â†’  const dateStr = `${month + 1}æœˆ${day}æ—¥`;
   181â†’  const seedStr = `${isoDate}:${skill}:${solarTerm}:${timeOfDay}`;
   182â†’  let hash = 0;
   183â†’  for (let i = 0; i < seedStr.length; i += 1) {
   184â†’    hash = (hash * 31 + seedStr.charCodeAt(i)) % 100000;
   185â†’  }
   186â†’  const fortuneScore = Math.max(32, Math.min(92, 42 + (hash % 51)));
   187â†’  const fortuneHint = skill === "bazi"
   188â†’    ? (baziHints[solarTerm] || "ä»Šå¤©é€‚åˆç¨³ä½èŠ‚å¥ï¼ŒæŠŠåŠ›æ°”ç”¨åœ¨å…³é”®å¤„ã€‚")
   189â†’    : (seasonTips[solarTerm] || "ä»Šå¤©é€‚åˆæŠŠæ³¨æ„åŠ›æ”¶å›åˆ°è‡ªå·±èº«ä¸Šã€‚");
   190â†’
   191â†’  const actionText =
   192â†’    timeOfDay === "dawn" || timeOfDay === "morning"
   193â†’      ? "å†™ä¸‹ä»Šå¤©æœ€é‡è¦çš„ä¸€ä»¶äº‹ï¼Œå¹¶ç”¨ 25 åˆ†é’Ÿå¯åŠ¨å®ƒ"
   194â†’      : timeOfDay === "afternoon"
   195â†’        ? "æŠŠä¸€ä»¶æ‚¬è€Œæœªå†³çš„å°äº‹æ”¶å°¾ï¼Œç»™è‡ªå·±ä¸€ä¸ªç¡®å®šæ„Ÿ"
   196â†’        : timeOfDay === "evening"
   197â†’          ? "ç”¨ 10 åˆ†é’Ÿå¤ç›˜ä»Šå¤©ï¼šåšå¯¹äº†ä»€ä¹ˆã€ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆ"
   198â†’          : "å…³æœºå‰å†™ä¸€å¥æ„Ÿè°¢ï¼Œç»™å¤§è„‘ä¸€ä¸ªæŸ”è½¯çš„ç»“å°¾";
   199â†’
   200â†’  return {
   201â†’    greeting, solarTerm, timeOfDay, date: dateStr, isoDate,
   202â†’    todayTip: seasonTips[solarTerm] || "ä¸“æ³¨å½“ä¸‹ï¼Œç¨³æ­¥å‰è¡Œ",
   203â†’    baziHint: skill === "bazi" ? (baziHints[solarTerm] || null) : null,
   204â†’    fortuneScore, fortuneHint, actionText, isFromApi: false,
   205â†’  };
   206â†’}
   207â†’
   208â†’// ç”Ÿæˆå½“æ—¥é—®å€™æ•°æ® - ä½¿ç”¨æœ¬åœ°ç®—æ³•ç”Ÿæˆ
   209â†’// Vercel rule: rerender-lazy-state-init - ä½¿ç”¨å‡½æ•°åˆå§‹åŒ–é¿å…é‡å¤è®¡ç®—
   210â†’// NOTE: åŸ API è°ƒç”¨å·²ç§»é™¤ï¼Œå› åç«¯ /api/v1/fortune/greeting æœªå®ç°
   211â†’// æœ¬åœ°ç®—æ³•å·²æä¾›å®Œæ•´åŠŸèƒ½ï¼šèŠ‚æ°”ã€æ—¶è¾°ã€è¿åŠ¿è¯„åˆ†ç­‰
   212â†’function useDailyGreeting(skill: SkillType) {
   213â†’  const [data] = useState(() => getLocalGreetingData(skill));
   214â†’  const [loading] = useState(false);
   215â†’
   216â†’  return { ...data, loading };
   217â†’}
   218â†’
   219â†’// Memoized ChatEmptyState (Vercel rule: rerender-extract-component)
   220â†’const ChatEmptyState = memo(function ChatEmptyState({ skill, onQuickPrompt }: { skill: SkillType; onQuickPrompt?: (prompt: string) => void }) {
   221â†’  const config = SKILL_EMPTY_STATE[skill] || SKILL_EMPTY_STATE.bazi;
   222â†’  const quickPrompts = SKILL_QUICK_PROMPTS[skill] || SKILL_QUICK_PROMPTS.bazi;
   223â†’  const dailyData = useDailyGreeting(skill);
   224â†’  const actionKey = useMemo(
   225â†’    () => `vibelife-daily-action:${skill}:${dailyData.isoDate}`,
   226â†’    [skill, dailyData.isoDate]
   227â†’  );
   228â†’  const [actionCompleted, setActionCompleted] = useState(false);
   229â†’
   230â†’  useEffect(() => {
   231â†’    if (typeof window === "undefined") return;
   232â†’    // Use cached localStorage (Vercel rule: js-cache-storage)
   233â†’    setActionCompleted(getLocalStorage(actionKey) === "1");
   234â†’  }, [actionKey]);
   235â†’
   236â†’  const toggleAction = useCallback(() => {
   237â†’    setActionCompleted((prev) => {
   238â†’      const next = !prev;
   239â†’      // Use cached localStorage (Vercel rule: js-cache-storage)
   240â†’      setLocalStorage(actionKey, next ? "1" : "0");
   241â†’      return next;
   242â†’    });
   243â†’  }, [actionKey]);
   244â†’
   245â†’  const shareText = useMemo(() => {
   246â†’    const term = dailyData.solarTerm ? ` Â· ${dailyData.solarTerm}` : "";
   247â†’    return [
   248â†’      `VibeLife${term} Â· ${dailyData.date}`,
   249â†’      dailyData.greeting,
   250â†’      `è¿åŠ¿æŒ‡æ•°ï¼š${dailyData.fortuneScore}/100`,
   251â†’      `ä»Šæ—¥ä¸€æ­¥ï¼š${dailyData.actionText}`,
   252â†’      "#VibeLife",
   253â†’    ].join("\n");
   254â†’  }, [dailyData]);
   255â†’
   256â†’  return (
   257â†’    <div className="flex flex-col items-center justify-center w-full md:max-w-xl mx-auto px-4 py-6">
   258â†’      {/* Daily Greeting æ¯æ—¥é—®å€™ */}
   259â†’      <DailyGreeting
   260â†’        greeting={dailyData.greeting}
   261â†’        solarTerm={dailyData.solarTerm}
   262â†’        timeOfDay={dailyData.timeOfDay}
   263â†’        date={dailyData.date}
   264â†’        todayTip={dailyData.todayTip}
   265â†’        baziHint={dailyData.baziHint || undefined}
   266â†’        fortuneScore={dailyData.fortuneScore}
   267â†’        fortuneHint={dailyData.fortuneHint}
   268â†’        actionItem={{ text: dailyData.actionText, completed: actionCompleted }}
   269â†’        onActionToggle={toggleAction}
   270â†’        shareText={shareText}
   271â†’        className="mb-6 w-full"
   272â†’      />
   273â†’
   274â†’      {/* Animated glyph with enhanced aura */}
   275â†’      <div className="relative flex items-center justify-center mb-4">
   276â†’        {/* Outer pulsing ring */}
   277â†’        <div className="absolute w-16 h-16 rounded-full border border-skill-primary/20 animate-pulse-slow" />
   278â†’        <div className="absolute w-24 h-24 rounded-full border border-skill-primary/10 animate-pulse-slower" />
   279â†’
   280â†’        {/* Breath aura */}
   281â†’        <BreathAura
   282â†’          skill={skill}
   283â†’          size="sm"
   284â†’          position="center"
   285â†’          intensity="medium"
   286â†’          className="opacity-40"
   287â†’        />
   288â†’
   289â†’        {/* Central glyph */}
   290â†’        <VibeGlyph
   291â†’          size="sm"
   292â†’          skill={skill}
   293â†’          showAura={true}
   294â†’          animate={true}
   295â†’          className="relative z-10"
   296â†’        />
   297â†’      </div>
   298â†’
   299â†’      {/* Title */}
   300â†’      <h3 className="text-base md:text-lg font-serif font-semibold text-foreground mb-1 text-center">
   301â†’        {config.title}
   302â†’      </h3>
   303â†’
   304â†’      {/* Subtitle */}
   305â†’      <p className="text-sm text-muted-foreground max-w-sm text-center mb-4">
   306â†’        {config.subtitle}
   307â†’      </p>
   308â†’
   309â†’      {/* Quick prompt suggestions */}
   310â†’      <div className="w-full space-y-3">
   311â†’        <p className="text-xs text-muted-foreground/60 text-center">
   312â†’          è¯•è¯•è¿™æ ·é—®
   313â†’        </p>
   314â†’        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
   315â†’          {quickPrompts.slice(0, 4).map((prompt, index) => (
   316â†’            <button
   317â†’              key={index}
   318â†’              onClick={() => onQuickPrompt?.(prompt.question)}
   319â†’              className={`
   320â†’                group relative px-3 py-3 text-left
   321â†’                bg-gradient-to-br ${prompt.gradient}
   322â†’                border border-border/50 hover:border-skill-primary/30
   323â†’                rounded-xl transition-all duration-200
   324â†’                hover:shadow-md hover:-translate-y-0.5
   325â†’              `}
   326â†’            >
   327â†’              <div className="flex items-start gap-2.5">
   328â†’                <span className="text-lg flex-shrink-0">{prompt.icon}</span>
   329â†’                <div className="flex-1 min-w-0">
   330â†’                  <span className="text-[10px] font-medium text-muted-foreground/70 uppercase tracking-wide">
   331â†’                    {prompt.category}
   332â†’                  </span>
   333â†’                  <p className="text-sm text-foreground line-clamp-2 mt-0.5">
   334â†’                    {prompt.question}
   335â†’                  </p>
   336â†’                </div>
   337â†’              </div>
   338â†’            </button>
   339â†’          ))}
   340â†’        </div>
   341â†’      </div>
   342â†’    </div>
   343â†’  );
   344â†’});
   345â†’
   346â†’export function ChatContainer({
   347â†’  skillId,
   348â†’  skill = "bazi",
   349â†’  conversationId,
   350â†’  voiceMode = "warm",
   351â†’  onConversationStart,
   352â†’}: ChatContainerProps) {
   353â†’  const messagesEndRef = useRef<HTMLDivElement>(null);
   354â†’
   355â†’  // Map skillId to SkillType if not provided
   356â†’  const activeSkill: SkillType = skill || (skillId as SkillType) || "bazi";
   357â†’
   358â†’  // Use AI SDK powered chat hook
   359â†’  const {
   360â†’    messages,
   361â†’    isLoading,
   362â†’    sendMessage,
   363â†’    sendQuickPrompt,
   364â†’    error,
   365â†’  } = useVibeChat({
   366â†’    skillId: (skillId || skill) as SkillId,
   367â†’    voiceMode,
   368â†’    conversationId,
   369â†’    onConversationStart,
   370â†’    onError: (err) => {
   371â†’      console.error("Chat error:", err);
   372â†’      // Show user-friendly toast notification with retry option
   373â†’      const errorMessage = err instanceof Error ? err.message : "æœªçŸ¥é”™è¯¯";
   374â†’      const isNetworkError = errorMessage.includes("network") || errorMessage.includes("fetch");
   375â†’      const isTimeoutError = errorMessage.includes("timeout") || errorMessage.includes("è¶…æ—¶");
   376â†’
   377â†’      toast.error(
   378â†’        isNetworkError ? "ç½‘ç»œè¿æ¥å¤±è´¥" : isTimeoutError ? "è¯·æ±‚è¶…æ—¶" : "å‘é€å¤±è´¥",
   379â†’        {
   380â†’          description: isNetworkError
   381â†’            ? "è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•"
   382â†’            : isTimeoutError
   383â†’              ? "æœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•"
   384â†’              : "è¯·ç¨åé‡è¯•ï¼Œæˆ–åˆ·æ–°é¡µé¢",
   385â†’          duration: 5000,
   386â†’        }
   387â†’      );
   388â†’    },
   389â†’  });
   390â†’
   391â†’  const scrollToBottom = useCallback(() => {
   392â†’    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
   393â†’  }, []);
   394â†’
   395â†’  useEffect(() => {
   396â†’    scrollToBottom();
   397â†’  }, [messages, scrollToBottom]);
   398â†’
   399â†’  // Handle send from ChatInput
   400â†’  const handleSend = useCallback(
   401â†’    async (content: string) => {
   402â†’      await sendMessage(content);
   403â†’    },
   404â†’    [sendMessage]
   405â†’  );
   406â†’
   407â†’  // Handle quick prompt from empty state
   408â†’  const handleQuickPrompt = useCallback(
   409â†’    async (content: string) => {
   410â†’      await sendQuickPrompt(content);
   411â†’    },
   412â†’    [sendQuickPrompt]
   413â†’  );
   414â†’
   415â†’  const hasMessages = messages.length > 0;
   416â†’
   417â†’  return (
   418â†’    <div className="flex flex-col h-full" data-skill={activeSkill}>
   419â†’      {/* Messages area - always flex-1 to push input to bottom */}
   420â†’      <main
   421â†’        id="main-content"
   422â†’        className="flex-1 overflow-y-auto relative min-h-0"
   423â†’        role="log"
   424â†’        aria-label="å¯¹è¯æ¶ˆæ¯"
   425â†’        aria-live="polite"
   426â†’      >
   427â†’        {!hasMessages ? (
   428â†’          /* Empty state - centered within scrollable area */
   429â†’          <div className="flex flex-col items-center justify-end h-full pb-4 px-4">
   430â†’            <ChatEmptyState skill={activeSkill} onQuickPrompt={handleQuickPrompt} />
   431â†’          </div>
   432â†’        ) : (
   433â†’          /* Messages list - PCç«¯å·¦å¯¹é½ï¼Œç§»åŠ¨ç«¯å±…ä¸­ */
   434â†’          <div className="px-4 pt-4 pb-2 max-w-3xl lg:ml-4 lg:mr-auto mx-auto">
   435â†’            {messages.map((message) => (
   436â†’              // Use chat-message-item class for content-visibility optimization (Vercel rule: rendering-content-visibility)
   437â†’              <div key={message.id} className="chat-message-item">
   438â†’                <ChatMessage
   439â†’                  role={message.role as "user" | "assistant"}
   440â†’                  content={getMessageContent(message)}
   441â†’                  skill={activeSkill}
   442â†’                  isStreaming={isLoading && message.role === "assistant" && message === messages[messages.length - 1]}
   443â†’                />
   444â†’              </div>
   445â†’            ))}
   446â†’            {/* Show loading indicator when waiting for first response chunk */}
   447â†’            {isLoading && messages.length > 0 && messages[messages.length - 1].role === "user" && (
   448â†’              <ChatMessage
   449â†’                role="assistant"
   450â†’                content=""
   451â†’                skill={activeSkill}
   452â†’                isStreaming
   453â†’              />
   454â†’            )}
   455â†’            {/* Error is now handled via toast notification in onError callback */}
   456â†’            <div ref={messagesEndRef} />
   457â†’          </div>
   458â†’        )}
   459â†’      </main>
   460â†’
   461â†’      {/* Input - fixed at bottom */}
   462â†’      <div className="flex-shrink-0">
   463â†’        <ChatInput onSend={handleSend} disabled={isLoading} />
   464â†’      </div>
   465â†’    </div>
   466â†’  );
   467â†’}
   468â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
