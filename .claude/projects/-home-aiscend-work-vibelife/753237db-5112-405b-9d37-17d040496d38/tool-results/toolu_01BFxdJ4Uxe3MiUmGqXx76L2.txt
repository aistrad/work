     1→"""
     2→Session Manager v10 - 会话状态管理
     3→
     4→管理用户的活跃会话生命周期：
     5→- 获取当前活跃会话
     6→- 开始新会话
     7→- 暂停/恢复会话
     8→- 完成会话
     9→
    10→与 ContextManager 协作：
    11→- SessionManager: 管理会话生命周期
    12→- ContextManager: 管理会话内的数据
    13→"""
    14→import logging
    15→from dataclasses import dataclass, field, asdict
    16→from datetime import datetime, timezone
    17→from typing import Optional, Dict, Any, List
    18→from uuid import UUID
    19→from enum import Enum
    20→
    21→logger = logging.getLogger(__name__)
    22→
    23→
    24→class SessionStatus(str, Enum):
    25→    """会话状态"""
    26→    IN_PROGRESS = "in_progress"
    27→    PAUSED = "paused"
    28→    COMPLETED = "completed"
    29→    ABANDONED = "abandoned"
    30→
    31→
    32→@dataclass
    33→class ActiveSession:
    34→    """活跃会话信息"""
    35→    skill_id: str
    36→    rule_id: Optional[str] = None
    37→    conversation_id: Optional[str] = None
    38→    started_at: Optional[str] = None
    39→    last_activity: Optional[str] = None
    40→    status: str = SessionStatus.IN_PROGRESS
    41→    goal: Optional[str] = None
    42→    checkpoint_step: int = 0
    43→    checkpoint_total: int = 0
    44→
    45→    def to_dict(self) -> Dict[str, Any]:
    46→        return asdict(self)
    47→
    48→    @classmethod
    49→    def from_dict(cls, data: Dict[str, Any]) -> "ActiveSession":
    50→        return cls(
    51→            skill_id=data.get("skill_id", ""),
    52→            rule_id=data.get("rule_id"),
    53→            conversation_id=data.get("conversation_id"),
    54→            started_at=data.get("started_at"),
    55→            last_activity=data.get("last_activity"),
    56→            status=data.get("status", SessionStatus.IN_PROGRESS),
    57→            goal=data.get("goal"),
    58→            checkpoint_step=data.get("checkpoint_step", 0),
    59→            checkpoint_total=data.get("checkpoint_total", 0)
    60→        )
    61→
    62→    @property
    63→    def is_active(self) -> bool:
    64→        """会话是否活跃"""
    65→        return self.status in (SessionStatus.IN_PROGRESS, SessionStatus.PAUSED)
    66→
    67→    @property
    68→    def progress_text(self) -> str:
    69→        """进度文本"""
    70→        if self.checkpoint_total > 0:
    71→            return f"{self.checkpoint_step}/{self.checkpoint_total}"
    72→        return ""
    73→
    74→
    75→class SessionManager:
    76→    """
    77→    会话状态管理器
    78→
    79→    职责：
    80→    1. 检测活跃会话
    81→    2. 判断是否应该恢复会话
    82→    3. 管理会话生命周期
    83→    """
    84→
    85→    # 会话恢复关键词
    86→    RESUME_KEYWORDS = ["继续", "接着", "上次", "回来了", "继续聊", "接着说", "where we left"]
    87→    # 放弃会话关键词
    88→    ABANDON_KEYWORDS = ["算了", "不用了", "重新开始", "换个", "别的"]
    89→
    90→    def __init__(self):
    91→        from .context_manager import get_context_manager
    92→        self.context_manager = get_context_manager()
    93→
    94→    async def get_active_session(self, user_id: str) -> Optional[ActiveSession]:
    95→        """
    96→        获取当前活跃会话
    97→
    98→        从 profile.state.active_session 读取
    99→        """
   100→        from stores.unified_profile_repo import UnifiedProfileRepository
   101→
   102→        if user_id == "guest":
   103→            return None
   104→
   105→        try:
   106→            user_uuid = UUID(user_id)
   107→            state = await UnifiedProfileRepository.get_state(user_uuid)
   108→
   109→            active_session_data = state.get("active_session")
   110→            if not active_session_data:
   111→                return None
   112→
   113→            session = ActiveSession.from_dict(active_session_data)
   114→
   115→            # 检查是否仍然活跃
   116→            if not session.is_active:
   117→                return None
   118→
   119→            # 获取最新的 checkpoint 信息
   120→            if session.skill_id:
   121→                skill_state = await UnifiedProfileRepository.get_skill_state(
   122→                    user_uuid, session.skill_id
   123→                )
   124→                skill_session = skill_state.get("_session", {})
   125→                checkpoint = skill_session.get("checkpoint", {})
   126→                session.checkpoint_step = checkpoint.get("step", 0)
   127→                session.checkpoint_total = checkpoint.get("total_steps", 0)
   128→
   129→            logger.info(f"[SessionManager] Found active session: skill={session.skill_id}, rule={session.rule_id}, step={session.checkpoint_step}")
   130→
   131→            return session
   132→
   133→        except Exception as e:
   134→            logger.error(f"[SessionManager] Failed to get active session: {e}")
   135→            return None
   136→
   137→    def should_resume(
   138→        self,
   139→        message: str,
   140→        active_session: Optional[ActiveSession]
   141→    ) -> bool:
   142→        """
   143→        判断是否应该恢复会话
   144→
   145→        检查：
   146→        1. 是否有活跃会话
   147→        2. 用户消息是否包含恢复关键词
   148→        3. 用户消息是否包含放弃关键词
   149→        """
   150→        if not active_session:
   151→            return False
   152→
   153→        message_lower = message.lower().strip()
   154→
   155→        # 检查放弃关键词
   156→        for keyword in self.ABANDON_KEYWORDS:
   157→            if keyword in message_lower:
   158→                return False
   159→
   160→        # 检查恢复关键词
   161→        for keyword in self.RESUME_KEYWORDS:
   162→            if keyword in message_lower:
   163→                return True
   164→
   165→        # 如果消息很短（可能是简单回复），倾向于继续
   166→        if len(message_lower) < 20:
   167→            return True
   168→
   169→        # 默认：如果有未完成的会话，提示用户
   170→        return False
   171→
   172→    def should_ask_resume(
   173→        self,
   174→        message: str,
   175→        active_session: Optional[ActiveSession]
   176→    ) -> bool:
   177→        """
   178→        判断是否应该询问用户是否继续
   179→
   180→        如果：
   181→        1. 有活跃会话
   182→        2. 不是明确的恢复或放弃
   183→        3. 消息与会话主题相关
   184→
   185→        则应该询问
   186→        """
   187→        if not active_session:
   188→            return False
   189→
   190→        message_lower = message.lower().strip()
   191→
   192→        # 明确恢复或放弃，不需要询问
   193→        for keyword in self.RESUME_KEYWORDS + self.ABANDON_KEYWORDS:
   194→            if keyword in message_lower:
   195→                return False
   196→
   197→        # 有未完成的会话，应该询问
   198→        return active_session.is_active and active_session.checkpoint_step > 0
   199→
   200→    async def start_session(
   201→        self,
   202→        user_id: str,
   203→        skill_id: str,
   204→        rule_id: Optional[str] = None,
   205→        conversation_id: Optional[str] = None,
   206→        goal: Optional[str] = None,
   207→        total_steps: int = 0
   208→    ) -> ActiveSession:
   209→        """
   210→        开始新会话
   211→
   212→        写入 profile.state.active_session
   213→        初始化 profile.skills.{skill_id}._session
   214→        """
   215→        from stores.unified_profile_repo import UnifiedProfileRepository
   216→
   217→        now = datetime.now(timezone.utc).isoformat()
   218→
   219→        session = ActiveSession(
   220→            skill_id=skill_id,
   221→            rule_id=rule_id,
   222→            conversation_id=conversation_id,
   223→            started_at=now,
   224→            last_activity=now,
   225→            status=SessionStatus.IN_PROGRESS,
   226→            goal=goal,
   227→            checkpoint_step=0,
   228→            checkpoint_total=total_steps
   229→        )
   230→
   231→        if user_id == "guest":
   232→            return session
   233→
   234→        try:
   235→            user_uuid = UUID(user_id)
   236→
   237→            # 更新全局 active_session
   238→            await UnifiedProfileRepository.update_state(user_uuid, {
   239→                "active_session": session.to_dict()
   240→            })
   241→
   242→            # 初始化 skill session
   243→            await self.context_manager.start_session(
   244→                user_id, skill_id, rule_id, goal, total_steps
   245→            )
   246→
   247→            logger.info(f"[SessionManager] Started session: skill={skill_id}, rule={rule_id}")
   248→
   249→            return session
   250→
   251→        except Exception as e:
   252→            logger.error(f"[SessionManager] Failed to start session: {e}")
   253→            return session
   254→
   255→    async def pause_session(self, user_id: str) -> None:
   256→        """
   257→        暂停会话
   258→
   259→        更新 status 为 paused
   260→        """
   261→        from stores.unified_profile_repo import UnifiedProfileRepository
   262→
   263→        if user_id == "guest":
   264→            return
   265→
   266→        try:
   267→            user_uuid = UUID(user_id)
   268→            state = await UnifiedProfileRepository.get_state(user_uuid)
   269→
   270→            active_session = state.get("active_session", {})
   271→            if active_session:
   272→                active_session["status"] = SessionStatus.PAUSED
   273→                active_session["last_activity"] = datetime.now(timezone.utc).isoformat()
   274→
   275→                await UnifiedProfileRepository.update_state(user_uuid, {
   276→                    "active_session": active_session
   277→                })
   278→
   279→            logger.info(f"[SessionManager] Paused session for user={user_id}")
   280→
   281→        except Exception as e:
   282→            logger.error(f"[SessionManager] Failed to pause session: {e}")
   283→
   284→    async def resume_session(self, user_id: str) -> Optional[ActiveSession]:
   285→        """
   286→        恢复会话
   287→
   288→        更新 status 为 in_progress
   289→        返回完整的会话上下文
   290→        """
   291→        from stores.unified_profile_repo import UnifiedProfileRepository
   292→
   293→        session = await self.get_active_session(user_id)
   294→        if not session:
   295→            return None
   296→
   297→        if user_id == "guest":
   298→            return session
   299→
   300→        try:
   301→            user_uuid = UUID(user_id)
   302→
   303→            # 更新状态
   304→            session.status = SessionStatus.IN_PROGRESS
   305→            session.last_activity = datetime.now(timezone.utc).isoformat()
   306→
   307→            await UnifiedProfileRepository.update_state(user_uuid, {
   308→                "active_session": session.to_dict()
   309→            })
   310→
   311→            logger.info(f"[SessionManager] Resumed session: skill={session.skill_id}")
   312→
   313→            return session
   314→
   315→        except Exception as e:
   316→            logger.error(f"[SessionManager] Failed to resume session: {e}")
   317→            return session
   318→
   319→    async def complete_session(
   320→        self,
   321→        user_id: str,
   322→        summary: Optional[str] = None
   323→    ) -> None:
   324→        """
   325→        完成会话
   326→
   327→        更新 status 为 completed
   328→        清理 checkpoint，保留 findings
   329→        """
   330→        session = await self.get_active_session(user_id)
   331→        if not session:
   332→            return
   333→
   334→        from stores.unified_profile_repo import UnifiedProfileRepository
   335→
   336→        if user_id == "guest":
   337→            return
   338→
   339→        try:
   340→            user_uuid = UUID(user_id)
   341→
   342→            # 清除 active_session
   343→            await UnifiedProfileRepository.update_state(user_uuid, {
   344→                "active_session": None
   345→            })
   346→
   347→            # 完成 skill session
   348→            await self.context_manager.complete_session(
   349→                user_id, session.skill_id, summary
   350→            )
   351→
   352→            logger.info(f"[SessionManager] Completed session: skill={session.skill_id}")
   353→
   354→        except Exception as e:
   355→            logger.error(f"[SessionManager] Failed to complete session: {e}")
   356→
   357→    async def abandon_session(self, user_id: str) -> None:
   358→        """
   359→        放弃会话
   360→
   361→        更新 status 为 abandoned
   362→        清理所有状态
   363→        """
   364→        session = await self.get_active_session(user_id)
   365→        if not session:
   366→            return
   367→
   368→        from stores.unified_profile_repo import UnifiedProfileRepository
   369→
   370→        if user_id == "guest":
   371→            return
   372→
   373→        try:
   374→            user_uuid = UUID(user_id)
   375→
   376→            # 清除 active_session
   377→            await UnifiedProfileRepository.update_state(user_uuid, {
   378→                "active_session": None
   379→            })
   380→
   381→            # 清理 skill session（不保留 findings）
   382→            await self.context_manager.clear_session(
   383→                user_id, session.skill_id, keep_findings=False
   384→            )
   385→
   386→            logger.info(f"[SessionManager] Abandoned session: skill={session.skill_id}")
   387→
   388→        except Exception as e:
   389→            logger.error(f"[SessionManager] Failed to abandon session: {e}")
   390→
   391→    async def update_activity(
   392→        self,
   393→        user_id: str,
   394→        conversation_id: Optional[str] = None
   395→    ) -> None:
   396→        """
   397→        更新会话活动时间
   398→
   399→        每次用户交互时调用
   400→        """
   401→        from stores.unified_profile_repo import UnifiedProfileRepository
   402→
   403→        if user_id == "guest":
   404→            return
   405→
   406→        try:
   407→            user_uuid = UUID(user_id)
   408→            state = await UnifiedProfileRepository.get_state(user_uuid)
   409→
   410→            active_session = state.get("active_session", {})
   411→            if active_session:
   412→                active_session["last_activity"] = datetime.now(timezone.utc).isoformat()
   413→                if conversation_id:
   414→                    active_session["conversation_id"] = conversation_id
   415→
   416→                await UnifiedProfileRepository.update_state(user_uuid, {
   417→                    "active_session": active_session
   418→                })
   419→
   420→        except Exception as e:
   421→            logger.error(f"[SessionManager] Failed to update activity: {e}")
   422→
   423→    def build_resume_prompt(self, session: ActiveSession) -> str:
   424→        """
   425→        构建会话恢复提示（用于询问用户）
   426→
   427→        返回一段友好的提示文本
   428→        """
   429→        if not session:
   430→            return ""
   431→
   432→        lines = []
   433→
   434→        # 根据 skill 和 rule 生成友好描述
   435→        skill_names = {
   436→            "lifecoach": "人生教练",
   437→            "bazi": "八字",
   438→            "zodiac": "星座",
   439→            "tarot": "塔罗",
   440→            "career": "职业规划"
   441→        }
   442→
   443→        skill_name = skill_names.get(session.skill_id, session.skill_id)
   444→
   445→        if session.rule_id:
   446→            rule_names = {
   447→                "dankoe": "Dan Koe 人生重置",
   448→                "covey": "七个习惯",
   449→                "yangming": "阳明心学",
   450→                "liaofan": "了凡四训"
   451→            }
   452→            rule_name = rule_names.get(session.rule_id, session.rule_id)
   453→            lines.append(f"你之前在进行「{rule_name}」流程")
   454→        else:
   455→            lines.append(f"你之前在使用「{skill_name}」")
   456→
   457→        if session.checkpoint_step > 0 and session.checkpoint_total > 0:
   458→            lines.append(f"已完成 {session.checkpoint_step}/{session.checkpoint_total} 步")
   459→
   460→        if session.goal:
   461→            lines.append(f"目标：{session.goal}")
   462→
   463→        lines.append("\n要继续上次的进度吗？说「继续」可以接着聊，说「重新开始」可以从头来。")
   464→
   465→        return "\n".join(lines)
   466→
   467→
   468→# ═══════════════════════════════════════════════════════════════════════════
   469→# Singleton
   470→# ═══════════════════════════════════════════════════════════════════════════
   471→
   472→_session_manager: Optional[SessionManager] = None
   473→
   474→
   475→def get_session_manager() -> SessionManager:
   476→    """获取 SessionManager 单例"""
   477→    global _session_manager
   478→    if _session_manager is None:
   479→        _session_manager = SessionManager()
   480→    return _session_manager
   481→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
