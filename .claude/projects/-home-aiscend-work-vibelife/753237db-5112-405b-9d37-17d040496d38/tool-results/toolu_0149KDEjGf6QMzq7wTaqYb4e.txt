     1→"""
     2→Agent Framework - V10 Architecture (Context Engineering)
     3→
     4→V10 Changes:
     5→- Context Engineering: 文件/JSONB 持久化状态，断点续传
     6→- 模块化: ContextManager, SessionManager, PromptBuilder, ToolExecutor
     7→- 会话恢复: 自动检测未完成会话，支持断点续传
     8→- 跨 Skill 共享: profile.extracted + identity
     9→
    10→V9 Features (retained):
    11→- Phase 1 提供所有路由工具，LLM 一次性决策
    12→- 移除 Python 硬编码决策逻辑
    13→- 工具即行为：activate_skill, show_protocol_invitation, show_skill_intro
    14→
    15→V6 Features (retained):
    16→- CoreAgent replaces Orchestrator + SkillAgents
    17→- LLM-based skill selection (no keyword matching)
    18→- SkillLoader loads SKILL.md files
    19→- Unified tool schema from YAML
    20→- Skill validation for CI
    21→"""
    22→
    23→# Core Agent
    24→from .core import CoreAgent, AgentContext, AgentEvent, AgentState, create_agent
    25→from .skill_loader import load_skill, build_system_prompt, get_available_skills, SkillConfig
    26→
    27→# Tier limits (简化版，完整配额管理使用 model_router.quota)
    28→TIER_LIMITS = {
    29→    "free": {"calls": 50, "tokens": 100000},
    30→    "paid": {"calls": 500, "tokens": 1000000},
    31→    "vip": {"calls": -1, "tokens": -1},
    32→}
    33→
    34→
    35→class QuotaTracker:
    36→    """简化配额追踪 - 委托到 UsageService"""
    37→
    38→    @classmethod
    39→    async def check(cls, user_id: str, tier: str):
    40→        """检查配额"""
    41→        if tier == "vip":
    42→            return True, ""
    43→
    44→        from services.usage import UsageService
    45→        from uuid import UUID
    46→
    47→        try:
    48→            usage = await UsageService.get_monthly_usage(UUID(user_id))
    49→            limits = TIER_LIMITS.get(tier, TIER_LIMITS["free"])
    50→
    51→            if limits["calls"] > 0 and usage["llm_calls"] >= limits["calls"]:
    52→                return False, "本月对话次数已用完"
    53→            return True, ""
    54→        except Exception:
    55→            return True, ""
    56→
    57→    @classmethod
    58→    async def record(cls, user_id: str, usage: dict):
    59→        """记录用量 - 已由 UsageService 处理"""
    60→        pass
    61→
    62→# Stream Adapters
    63→from .stream_adapter import (
    64→    BaseStreamAdapter,
    65→    AISDKv6Adapter,
    66→    LegacySSEAdapter,
    67→    StreamConfig,
    68→    get_adapter,
    69→)
    70→
    71→# V6 新增: 统一工具定义
    72→from .tool_schema import (
    73→    ToolDef,
    74→    ToolParam,
    75→    load_skill_tools,
    76→    get_skill_tools_openai,
    77→    get_global_tools_openai,
    78→    get_all_tools_for_skill,
    79→    get_tool_card_type,
    80→)
    81→
    82→# V6 新增: 统一工具注册表
    83→from .tool_registry import (
    84→    ToolRegistry,
    85→    ToolContext,
    86→    tool_handler,
    87→)
    88→
    89→# V10 新增: Context Engineering
    90→from .context_manager import (
    91→    ContextManager,
    92→    SessionContext,
    93→    Checkpoint,
    94→    Finding,
    95→    get_context_manager,
    96→)
    97→from .session_manager import (
    98→    SessionManager,
    99→    ActiveSession,
   100→    SessionStatus,
   101→    get_session_manager,
   102→)
   103→from .prompt_builder import PromptBuilder, get_prompt_builder
   104→from .tool_executor import ToolExecutor, get_tool_executor
   105→
   106→# V6 新增: Skill 校验
   107→from .skill_validator import (
   108→    validate_skill,
   109→    validate_all_skills,
   110→    ValidationResult,
   111→    ValidationError,
   112→)
   113→
   114→__all__ = [
   115→    # Core Agent
   116→    "CoreAgent",
   117→    "AgentContext",
   118→    "AgentEvent",
   119→    "AgentState",
   120→    "SkillConfig",
   121→    "QuotaTracker",
   122→    "TIER_LIMITS",
   123→    "create_agent",
   124→    "load_skill",
   125→    "build_system_prompt",
   126→    "get_available_skills",
   127→    # Stream Adapters
   128→    "BaseStreamAdapter",
   129→    "AISDKv6Adapter",
   130→    "LegacySSEAdapter",
   131→    "StreamConfig",
   132→    "get_adapter",
   133→    # Tool Schema
   134→    "ToolDef",
   135→    "ToolParam",
   136→    "load_skill_tools",
   137→    "get_skill_tools_openai",
   138→    "get_global_tools_openai",
   139→    "get_all_tools_for_skill",
   140→    "get_tool_card_type",
   141→    # Tool Registry
   142→    "ToolRegistry",
   143→    "ToolContext",
   144→    "tool_handler",
   145→    # Context Engineering (v10)
   146→    "ContextManager",
   147→    "SessionContext",
   148→    "Checkpoint",
   149→    "Finding",
   150→    "get_context_manager",
   151→    "SessionManager",
   152→    "ActiveSession",
   153→    "SessionStatus",
   154→    "get_session_manager",
   155→    "PromptBuilder",
   156→    "get_prompt_builder",
   157→    "ToolExecutor",
   158→    "get_tool_executor",
   159→    # Skill Validator
   160→    "validate_skill",
   161→    "validate_all_skills",
   162→    "ValidationResult",
   163→    "ValidationError",
   164→]
   165→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
