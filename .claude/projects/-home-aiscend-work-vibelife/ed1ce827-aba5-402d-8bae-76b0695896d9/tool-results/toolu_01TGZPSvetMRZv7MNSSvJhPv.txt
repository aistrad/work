     1→/**
     2→ * ShowCard - 统一卡片渲染器 (V7.1)
     3→ *
     4→ * v7.1 新增: 专用优先，通用兜底
     5→ * - 如果 card_type 有注册的专用组件 → 使用专用
     6→ * - 如果没有专用组件 → 使用 fallback_type 的通用视图
     7→ * - 如果没有 fallback_type → 根据数据结构自动推断
     8→ *
     9→ * 根据 card_type 渲染对应的视图组件:
    10→ * - 通用视图类型: list, tree, table, timeline, form, select, chart, progress, counter, modal, toast
    11→ * - 自定义卡片: custom + componentId
    12→ */
    13→
    14→import React from 'react';
    15→import {
    16→  ListView,
    17→  TreeView,
    18→  TableView,
    19→  Timeline,
    20→  FormView,
    21→  SelectView,
    22→  ChartView,
    23→  ProgressView,
    24→  CounterView,
    25→  ModalView,
    26→  ToastView,
    27→} from './views';
    28→import { getCard, hasCard } from '../CardRegistry';
    29→
    30→// 通用视图类型
    31→const GENERIC_CARD_TYPES = [
    32→  'list',
    33→  'tree',
    34→  'table',
    35→  'timeline',
    36→  'form',
    37→  'select',
    38→  'chart',
    39→  'progress',
    40→  'counter',
    41→  'modal',
    42→  'toast',
    43→  'custom',
    44→] as const;
    45→
    46→type GenericCardType = typeof GENERIC_CARD_TYPES[number];
    47→
    48→interface ShowCardProps {
    49→  cardType: string;
    50→  /** v7.1: 当 cardType 没有专用组件时，fallback 到此通用类型 */
    51→  fallbackType?: GenericCardType;
    52→  data?: any;
    53→  items?: any[];
    54→  nodes?: any[];
    55→  events?: any[];
    56→  fields?: any[];
    57→  values?: Record<string, any>;
    58→  options?: Record<string, any>;
    59→  componentId?: string;
    60→  onAction?: (action: string, payload?: any) => void;
    61→  className?: string;
    62→  [key: string]: any;
    63→}
    64→
    65→const isGenericType = (type: string): type is GenericCardType => {
    66→  return GENERIC_CARD_TYPES.includes(type as GenericCardType);
    67→};
    68→
    69→/**
    70→ * 根据数据结构自动推断通用视图类型
    71→ */
    72→const inferGenericType = (props: ShowCardProps): GenericCardType => {
    73→  const { data, items, nodes, events, fields, options } = props;
    74→
    75→  // 有 nodes → tree
    76→  if (nodes && Array.isArray(nodes)) return 'tree';
    77→  // 有 events → timeline
    78→  if (events && Array.isArray(events)) return 'timeline';
    79→  // 有 fields → form
    80→  if (fields && Array.isArray(fields)) return 'form';
    81→  // 有 items → list
    82→  if (items && Array.isArray(items)) return 'list';
    83→  // options.columns → table
    84→  if (options?.columns) return 'table';
    85→  // options.chartType → chart
    86→  if (options?.chartType) return 'chart';
    87→  // data 是数组 → list
    88→  if (Array.isArray(data)) return 'list';
    89→  // data 是数字 → counter
    90→  if (typeof data === 'number') return 'counter';
    91→  // 默认 list
    92→  return 'list';
    93→};
    94→
    95→export const ShowCard: React.FC<ShowCardProps> = ({
    96→  cardType,
    97→  fallbackType,
    98→  data,
    99→  items,
   100→  nodes,
   101→  events,
   102→  fields,
   103→  values,
   104→  options = {},
   105→  componentId,
   106→  onAction,
   107→  className = '',
   108→  ...rest
   109→}) => {
   110→  // ═══════════════════════════════════════════════════════════════════════════
   111→  // v7.1: 专用优先，通用兜底
   112→  // ═══════════════════════════════════════════════════════════════════════════
   113→
   114→  // 1. 如果是通用类型，直接处理
   115→  if (isGenericType(cardType)) {
   116→    return renderGenericView(cardType, {
   117→      data, items, nodes, events, fields, values, options, componentId, onAction, className, ...rest
   118→    });
   119→  }
   120→
   121→  // 2. 检查是否有注册的专用组件
   122→  if (hasCard(cardType)) {
   123→    const RegisteredComponent = getCard(cardType);
   124→    if (RegisteredComponent) {
   125→      return (
   126→        <RegisteredComponent
   127→          data={data}
   128→          items={items}
   129→          nodes={nodes}
   130→          events={events}
   131→          fields={fields}
   132→          values={values}
   133→          options={options}
   134→          onAction={onAction}
   135→          className={className}
   136→          {...rest}
   137→        />
   138→      );
   139→    }
   140→  }
   141→
   142→  // 3. 没有专用组件，使用 fallback
   143→  const effectiveFallback = fallbackType || options?.fallbackType || inferGenericType({
   144→    cardType, data, items, nodes, events, fields, values, options
   145→  });
   146→
   147→  // 仅在开发环境输出调试信息
   148→  if (process.env.NODE_ENV === 'development') {
   149→    console.log(`[ShowCard] No component for "${cardType}", fallback to "${effectiveFallback}"`);
   150→  }
   151→
   152→  return renderGenericView(effectiveFallback, {
   153→    data, items, nodes, events, fields, values, options, componentId, onAction, className, ...rest
   154→  });
   155→};
   156→
   157→/**
   158→ * 渲染通用视图
   159→ */
   160→function renderGenericView(
   161→  viewType: GenericCardType,
   162→  props: Omit<ShowCardProps, 'cardType' | 'fallbackType'>
   163→): React.ReactElement | null {
   164→  const {
   165→    data, items, nodes, events, fields, values,
   166→    options = {}, componentId, onAction, className = '', ...rest
   167→  } = props;
   168→
   169→  switch (viewType) {
   170→    case 'list':
   171→      return (
   172→        <ListView
   173→          items={items || data || []}
   174→          emptyText={options.emptyText}
   175→          showIndex={options.showIndex}
   176→          onItemClick={(item) => onAction?.('item_click', item)}
   177→          className={className}
   178→        />
   179→      );
   180→
   181→    case 'tree':
   182→      return (
   183→        <TreeView
   184→          nodes={nodes || data || []}
   185→          expandLevel={options.expandLevel}
   186→          showProgress={options.showProgress}
   187→          onNodeClick={(node) => onAction?.('node_click', node)}
   188→          className={className}
   189→        />
   190→      );
   191→
   192→    case 'table':
   193→      return (
   194→        <TableView
   195→          columns={options.columns || []}
   196→          data={data || []}
   197→          striped={options.striped}
   198→          emptyText={options.emptyText}
   199→          onRowClick={(row, index) => onAction?.('row_click', { row, index })}
   200→          className={className}
   201→        />
   202→      );
   203→
   204→    case 'timeline':
   205→      return (
   206→        <Timeline
   207→          events={events || data || []}
   208→          emptyText={options.emptyText}
   209→          onEventClick={(event) => onAction?.('event_click', event)}
   210→          className={className}
   211→        />
   212→      );
   213→
   214→    case 'form':
   215→      return (
   216→        <FormView
   217→          fields={fields || options.fields || []}
   218→          values={values || data || {}}
   219→          submitLabel={options.submitLabel}
   220→          onSubmit={(formValues) => onAction?.('submit', formValues)}
   221→          onChange={(name, value) => onAction?.('change', { name, value })}
   222→          className={className}
   223→        />
   224→      );
   225→
   226→    case 'select':
   227→      return (
   228→        <SelectView
   229→          options={data || options.options || []}
   230→          value={values?.selected || options.value}
   231→          multiple={options.multiple}
   232→          emptyText={options.emptyText}
   233→          onChange={(value) => onAction?.('select', value)}
   234→          className={className}
   235→        />
   236→      );
   237→
   238→    case 'chart':
   239→      return (
   240→        <ChartView
   241→          chartType={options.chartType || 'bar'}
   242→          data={data || []}
   243→          title={options.title}
   244→          showLegend={options.showLegend}
   245→          showValues={options.showValues}
   246→          maxValue={options.maxValue}
   247→          className={className}
   248→        />
   249→      );
   250→
   251→    case 'progress':
   252→      return (
   253→        <ProgressView
   254→          value={typeof data === 'number' ? data : options.value || 0}
   255→          max={options.max}
   256→          label={options.label}
   257→          showPercentage={options.showPercentage}
   258→          size={options.size}
   259→          color={options.color}
   260→          variant={options.variant}
   261→          className={className}
   262→        />
   263→      );
   264→
   265→    case 'counter':
   266→      return (
   267→        <CounterView
   268→          value={data ?? options.value ?? 0}
   269→          label={options.label}
   270→          prefix={options.prefix}
   271→          suffix={options.suffix}
   272→          size={options.size}
   273→          className={className}
   274→        />
   275→      );
   276→
   277→    case 'modal':
   278→      return (
   279→        <ModalView
   280→          isOpen={options.isOpen ?? true}
   281→          title={options.title}
   282→          content={typeof data === 'string' ? data : options.content}
   283→          size={options.size}
   284→          onClose={() => onAction?.('close')}
   285→          onConfirm={options.onConfirm ? () => onAction?.('confirm') : undefined}
   286→          className={className}
   287→        />
   288→      );
   289→
   290→    case 'toast':
   291→      return (
   292→        <ToastView
   293→          message={typeof data === 'string' ? data : options.message || ''}
   294→          type={options.type}
   295→          duration={options.duration}
   296→          position={options.position}
   297→          onClose={() => onAction?.('close')}
   298→          className={className}
   299→        />
   300→      );
   301→
   302→    case 'custom': {
   303→      // 自定义组件通过 componentId 查找
   304→      // V7: 兼容 ToolCardRenderer 传递的嵌套结构 { data: toolData }
   305→      // toolData 包含 { cardType, componentId, data, options }
   306→      const nestedData = data as Record<string, any> | undefined;
   307→      const customComponentId =
   308→        componentId ||
   309→        options?.componentId ||
   310→        nestedData?.componentId ||
   311→        nestedData?.options?.componentId;
   312→
   313→      if (!customComponentId) {
   314→        console.warn('ShowCard: custom type requires componentId');
   315→        return null;
   316→      }
   317→
   318→      const CustomComponent = getCard(customComponentId);
   319→      if (!CustomComponent) {
   320→        console.warn(`ShowCard: component not found: ${customComponentId}`);
   321→        return null;
   322→      }
   323→
   324→      // V7: 提取实际的卡片数据（可能在 data.data 或 data.props 中）
   325→      const actualCardData = nestedData?.data || nestedData?.props || data;
   326→      const actualOptions = nestedData?.options || options;
   327→
   328→      return (
   329→        <CustomComponent
   330→          data={actualCardData}
   331→          options={actualOptions}
   332→          onAction={onAction}
   333→          className={className}
   334→          {...rest}
   335→        />
   336→      );
   337→    }
   338→
   339→    default:
   340→      return null;
   341→  }
   342→}
   343→
   344→export default ShowCard;
   345→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
