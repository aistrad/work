     1â†’/**
     2â†’ * BaziChartCard - å…«å­—å‘½ç›˜å¡ç‰‡
     3â†’ *
     4â†’ * ä» show-bazi-chart.tsx æå–çš„çº¯æ¸²æŸ“ç»„ä»¶
     5â†’ * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "bazi_chart" è§¦å‘
     6â†’ */
     7â†’
     8â†’"use client";
     9â†’
    10â†’import { useState } from "react";
    11â†’import { motion, AnimatePresence } from "framer-motion";
    12â†’import { registerCard } from "@/skills/CardRegistry";
    13â†’
    14â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    15â†’// Types
    16â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    17â†’
    18â†’interface Pillar {
    19â†’  stem: string;
    20â†’  branch: string;
    21â†’}
    22â†’
    23â†’interface BaziChartData {
    24â†’  birthInfo?: { date?: string; time?: string; gender?: string };
    25â†’  birth_info?: { date?: string; time?: string; gender?: string };
    26â†’  fourPillars?: { year?: Pillar; month?: Pillar; day?: Pillar; hour?: Pillar | null };
    27â†’  four_pillars?: { year?: Pillar; month?: Pillar; day?: Pillar; hour?: Pillar | null };
    28â†’  dayMaster?: { element?: string; stem?: string; description?: string };
    29â†’  day_master?: { element?: string; stem?: string; description?: string };
    30â†’  fiveElements?: Record<string, number>;
    31â†’  five_elements?: Record<string, number>;
    32â†’  pattern?: { name?: string; description?: string };
    33â†’}
    34â†’
    35â†’interface BaziChartCardProps {
    36â†’  data: BaziChartData;
    37â†’  cardProps?: Record<string, unknown>;
    38â†’}
    39â†’
    40â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    41â†’// Constants
    42â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    43â†’
    44â†’const PILLAR_LABELS = {
    45â†’  year: "å¹´æŸ±",
    46â†’  month: "æœˆæŸ±",
    47â†’  day: "æ—¥æŸ±",
    48â†’  hour: "æ—¶æŸ±",
    49â†’} as const;
    50â†’
    51â†’const ELEMENT_EMOJI: Record<string, string> = {
    52â†’  æœ¨: "ğŸŒ²",
    53â†’  ç«: "ğŸ”¥",
    54â†’  åœŸ: "ğŸ”ï¸",
    55â†’  é‡‘: "âš”ï¸",
    56â†’  æ°´: "ğŸ’§",
    57â†’};
    58â†’
    59â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    60â†’// Helpers
    61â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    62â†’
    63â†’function getElementColor(element: "wood" | "fire" | "earth" | "metal" | "water"): string {
    64â†’  const colors = {
    65â†’    wood: "#22c55e",
    66â†’    fire: "#ef4444",
    67â†’    earth: "#eab308",
    68â†’    metal: "#f5f5f5",
    69â†’    water: "#3b82f6",
    70â†’  };
    71â†’  return colors[element];
    72â†’}
    73â†’
    74â†’function getElementChinese(element: "wood" | "fire" | "earth" | "metal" | "water"): string {
    75â†’  const chinese = { wood: "æœ¨", fire: "ç«", earth: "åœŸ", metal: "é‡‘", water: "æ°´" };
    76â†’  return chinese[element];
    77â†’}
    78â†’
    79â†’function getStemElement(stem: string): string | null {
    80â†’  const stemElements: Record<string, string> = {
    81â†’    ç”²: "æœ¨", ä¹™: "æœ¨", ä¸™: "ç«", ä¸: "ç«",
    82â†’    æˆŠ: "åœŸ", å·±: "åœŸ", åºš: "é‡‘", è¾›: "é‡‘",
    83â†’    å£¬: "æ°´", ç™¸: "æ°´",
    84â†’  };
    85â†’  return stemElements[stem] || null;
    86â†’}
    87â†’
    88â†’function getBranchElement(branch: string): string | null {
    89â†’  const branchElements: Record<string, string> = {
    90â†’    å¯…: "æœ¨", å¯: "æœ¨", å·³: "ç«", åˆ: "ç«",
    91â†’    è¾°: "åœŸ", æˆŒ: "åœŸ", ä¸‘: "åœŸ", æœª: "åœŸ",
    92â†’    ç”³: "é‡‘", é…‰: "é‡‘", äº¥: "æ°´", å­: "æ°´",
    93â†’  };
    94â†’  return branchElements[branch] || null;
    95â†’}
    96â†’
    97â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    98â†’// Component
    99â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   100â†’
   101â†’function BaziChartCard({ data }: BaziChartCardProps) {
   102â†’  const [expandedPillar, setExpandedPillar] = useState<string | null>(null);
   103â†’
   104â†’  // V7: é”™è¯¯çŠ¶æ€æ£€æŸ¥ - ä¸æ¸²æŸ“é”™è¯¯å¡ç‰‡
   105â†’  if ((data as any)?.status === "error" || (data as any)?.need_info) {
   106â†’    return null;
   107â†’  }
   108â†’
   109â†’  // V7: å…¼å®¹å¤šç§æ•°æ®æ¥æº
   110â†’  // 1. show_bazi_chart å§”æ‰˜æ¨¡å¼: { fourPillars, dayMaster, ... }
   111â†’  // 2. calculate_bazi ç›´æ¥è¿”å›: { status, chart: { four_pillars, ... }, message }
   112â†’  const chartData = (data as any)?.chart || data;
   113â†’
   114â†’  // å…¼å®¹ snake_case å’Œ camelCase
   115â†’  const birthInfo = chartData.birthInfo || chartData.birth_info || data.birthInfo || data.birth_info || {};
   116â†’  const fourPillars = chartData.fourPillars || chartData.four_pillars || {};
   117â†’  const dayMaster = chartData.dayMaster || chartData.day_master || {};
   118â†’  const fiveElements = chartData.fiveElements || chartData.five_elements || {};
   119â†’  const pattern = chartData.pattern || {};
   120â†’
   121â†’  // V7: æ•°æ®æœ‰æ•ˆæ€§æ£€æŸ¥ - æ²¡æœ‰å››æŸ±æ•°æ®ä¸æ¸²æŸ“
   122â†’  const hasPillars = fourPillars.year || fourPillars.month || fourPillars.day || fourPillars.hour;
   123â†’  if (!hasPillars) {
   124â†’    return null;
   125â†’  }
   126â†’
   127â†’  // è®¡ç®—äº”è¡Œæ€»æ•°ç”¨äºç™¾åˆ†æ¯”
   128â†’  const totalElements = Object.values(fiveElements).reduce((sum: number, val) => sum + (Number(val) || 0), 0) || 1;
   129â†’
   130â†’  return (
   131â†’    <motion.div
   132â†’      initial={{ opacity: 0, y: 20 }}
   133â†’      animate={{ opacity: 1, y: 0 }}
   134â†’      transition={{ duration: 0.5 }}
   135â†’      className="bazi-chart-card bg-gradient-to-br from-amber-50 to-orange-50 dark:from-amber-950/30 dark:to-orange-950/30 rounded-xl border border-amber-200 dark:border-amber-800 p-4 my-2 overflow-hidden"
   136â†’    >
   137â†’      {/* Header */}
   138â†’      <motion.div
   139â†’        initial={{ opacity: 0 }}
   140â†’        animate={{ opacity: 1 }}
   141â†’        transition={{ delay: 0.2 }}
   142â†’        className="flex items-center justify-between mb-4"
   143â†’      >
   144â†’        <h3 className="text-lg font-semibold text-accent-900 dark:text-accent-100 flex items-center gap-2">
   145â†’          <span>ğŸ›ï¸</span>
   146â†’          <span>å…«å­—å‘½ç›˜</span>
   147â†’        </h3>
   148â†’        <span className="text-sm text-accent-700 dark:text-accent-300">
   149â†’          {birthInfo.date || ""}
   150â†’        </span>
   151â†’      </motion.div>
   152â†’
   153â†’      {/* Four Pillars */}
   154â†’      <div className="grid grid-cols-4 gap-2 mb-4">
   155â†’        {(["year", "month", "day", "hour"] as const).map((pillar, index) => {
   156â†’          const pillarData = fourPillars[pillar];
   157â†’          const isExpanded = expandedPillar === pillar;
   158â†’          const stemElement = pillarData?.stem ? getStemElement(pillarData.stem) : null;
   159â†’          const branchElement = pillarData?.branch ? getBranchElement(pillarData.branch) : null;
   160â†’
   161â†’          return (
   162â†’            <motion.div
   163â†’              key={pillar}
   164â†’              initial={{ opacity: 0, scale: 0.8 }}
   165â†’              animate={{ opacity: 1, scale: 1 }}
   166â†’              transition={{ delay: 0.3 + index * 0.1, duration: 0.3 }}
   167â†’              onClick={() => pillarData && setExpandedPillar(isExpanded ? null : pillar)}
   168â†’              className={`text-center p-2 bg-white/50 dark:bg-black/20 rounded-lg cursor-pointer transition-all duration-200 ${
   169â†’                pillarData ? "hover:bg-white/80 dark:hover:bg-black/40 hover:shadow-md" : ""
   170â†’              } ${isExpanded ? "ring-2 ring-amber-400" : ""}`}
   171â†’            >
   172â†’              <div className="text-xs text-muted-foreground mb-1">
   173â†’                {PILLAR_LABELS[pillar]}
   174â†’              </div>
   175â†’              {pillarData ? (
   176â†’                <>
   177â†’                  <motion.div
   178â†’                    className="text-lg font-medium flex items-center justify-center gap-1"
   179â†’                    whileHover={{ scale: 1.05 }}
   180â†’                  >
   181â†’                    <span>{pillarData.stem}</span>
   182â†’                    {stemElement && <span className="text-sm">{ELEMENT_EMOJI[stemElement]}</span>}
   183â†’                  </motion.div>
   184â†’                  <motion.div
   185â†’                    className="text-lg flex items-center justify-center gap-1"
   186â†’                    whileHover={{ scale: 1.05 }}
   187â†’                  >
   188â†’                    <span>{pillarData.branch}</span>
   189â†’                    {branchElement && <span className="text-sm">{ELEMENT_EMOJI[branchElement]}</span>}
   190â†’                  </motion.div>
   191â†’                </>
   192â†’              ) : (
   193â†’                <div className="text-lg text-muted-foreground">?</div>
   194â†’              )}
   195â†’            </motion.div>
   196â†’          );
   197â†’        })}
   198â†’      </div>
   199â†’
   200â†’      {/* Expanded Pillar Detail */}
   201â†’      <AnimatePresence>
   202â†’        {expandedPillar && fourPillars[expandedPillar as keyof typeof fourPillars] && (
   203â†’          <motion.div
   204â†’            initial={{ height: 0, opacity: 0 }}
   205â†’            animate={{ height: "auto", opacity: 1 }}
   206â†’            exit={{ height: 0, opacity: 0 }}
   207â†’            transition={{ duration: 0.2 }}
   208â†’            className="mb-4 overflow-hidden"
   209â†’          >
   210â†’            <div className="bg-accent-100/50 dark:bg-accent-900/20 rounded-lg p-3 text-sm">
   211â†’              <div className="font-medium mb-1">
   212â†’                {PILLAR_LABELS[expandedPillar as keyof typeof PILLAR_LABELS]} è¯¦è§£
   213â†’              </div>
   214â†’              <div className="text-muted-foreground">
   215â†’                ç‚¹å‡»å…¶ä»–æŸ±ä½æŸ¥çœ‹è¯¦æƒ…ï¼Œæˆ–å†æ¬¡ç‚¹å‡»æ”¶èµ·ã€‚
   216â†’              </div>
   217â†’            </div>
   218â†’          </motion.div>
   219â†’        )}
   220â†’      </AnimatePresence>
   221â†’
   222â†’      {/* Day Master */}
   223â†’      <motion.div
   224â†’        initial={{ opacity: 0, x: -20 }}
   225â†’        animate={{ opacity: 1, x: 0 }}
   226â†’        transition={{ delay: 0.7 }}
   227â†’        className="bg-white/60 dark:bg-black/30 rounded-lg p-3 mb-4"
   228â†’      >
   229â†’        <div className="flex items-center gap-2 mb-1">
   230â†’          <span className="text-sm font-medium">æ—¥ä¸»</span>
   231â†’          <span className="px-2 py-0.5 bg-accent-200 dark:bg-accent-800 rounded text-sm font-medium">
   232â†’            {dayMaster.stem || ""} ({dayMaster.element || ""})
   233â†’          </span>
   234â†’        </div>
   235â†’        <p className="text-sm text-muted-foreground">{dayMaster.description || ""}</p>
   236â†’      </motion.div>
   237â†’
   238â†’      {/* Five Elements */}
   239â†’      <motion.div
   240â†’        initial={{ opacity: 0 }}
   241â†’        animate={{ opacity: 1 }}
   242â†’        transition={{ delay: 0.9 }}
   243â†’        className="mb-4"
   244â†’      >
   245â†’        <div className="text-sm font-medium mb-2">äº”è¡Œåˆ†å¸ƒ</div>
   246â†’        <div className="space-y-1.5">
   247â†’          {(["wood", "fire", "earth", "metal", "water"] as const).map((element, index) => {
   248â†’            const count = fiveElements[element] || 0;
   249â†’            const percentage = Math.round((count / totalElements) * 100);
   250â†’            return (
   251â†’              <div key={element} className="flex items-center gap-2">
   252â†’                <span className="w-6 text-center">{getElementChinese(element)}</span>
   253â†’                <div className="flex-1 h-4 bg-white/50 dark:bg-black/20 rounded-full overflow-hidden">
   254â†’                  <motion.div
   255â†’                    initial={{ width: 0 }}
   256â†’                    animate={{ width: `${percentage}%` }}
   257â†’                    transition={{ delay: 1 + index * 0.1, duration: 0.5 }}
   258â†’                    className="h-full rounded-full"
   259â†’                    style={{ backgroundColor: getElementColor(element) }}
   260â†’                  />
   261â†’                </div>
   262â†’                <span className="w-10 text-xs text-right text-muted-foreground">{percentage}%</span>
   263â†’              </div>
   264â†’            );
   265â†’          })}
   266â†’        </div>
   267â†’      </motion.div>
   268â†’
   269â†’      {/* Pattern */}
   270â†’      {pattern?.name && (
   271â†’        <motion.div
   272â†’          initial={{ opacity: 0, y: 10 }}
   273â†’          animate={{ opacity: 1, y: 0 }}
   274â†’          transition={{ delay: 1.5 }}
   275â†’          className="text-sm bg-accent-100 dark:bg-accent-900/30 rounded-lg p-2"
   276â†’        >
   277â†’          <span className="font-medium">æ ¼å±€ï¼š</span>
   278â†’          <span>{pattern.name}</span>
   279â†’          {pattern.description && (
   280â†’            <p className="text-xs text-muted-foreground mt-1">{pattern.description}</p>
   281â†’          )}
   282â†’        </motion.div>
   283â†’      )}
   284â†’
   285â†’      {/* Hint */}
   286â†’      <motion.div
   287â†’        initial={{ opacity: 0 }}
   288â†’        animate={{ opacity: 1 }}
   289â†’        transition={{ delay: 1.8 }}
   290â†’        className="mt-3 text-xs text-center text-muted-foreground"
   291â†’      >
   292â†’        ğŸ’¡ ç‚¹å‡»æŸ±ä½æŸ¥çœ‹è¯¦ç»†è§£è¯»
   293â†’      </motion.div>
   294â†’    </motion.div>
   295â†’  );
   296â†’}
   297â†’
   298â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   299â†’// Register to CardRegistry
   300â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   301â†’
   302â†’registerCard("bazi_chart", BaziChartCard);
   303â†’
   304â†’export default BaziChartCard;
   305â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
