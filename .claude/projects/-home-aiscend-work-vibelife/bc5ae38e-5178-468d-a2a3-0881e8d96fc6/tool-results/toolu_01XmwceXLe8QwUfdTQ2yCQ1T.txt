     1→-- VibeLife v3.0 Database Schema
     2→-- Based on spec v3.0.md
     3→-- Created: 2026-01-07
     4→
     5→-- Enable required extensions
     6→CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
     7→CREATE EXTENSION IF NOT EXISTS "pgcrypto";
     8→CREATE EXTENSION IF NOT EXISTS "vector";
     9→
    10→-- ============================================================================
    11→-- USERS & AUTHENTICATION
    12→-- ============================================================================
    13→
    14→-- Users table - core user identity
    15→CREATE TABLE IF NOT EXISTS users (
    16→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    17→    vibe_id VARCHAR(50) UNIQUE NOT NULL,  -- 用户唯一标识 (e.g., VIBE-XXXX)
    18→    email VARCHAR(255) UNIQUE,
    19→    phone VARCHAR(20) UNIQUE,
    20→    name VARCHAR(100),
    21→    avatar_url TEXT,
    22→    is_guest BOOLEAN DEFAULT TRUE,  -- 游客状态
    23→    created_at TIMESTAMPTZ DEFAULT NOW(),
    24→    updated_at TIMESTAMPTZ DEFAULT NOW()
    25→);
    26→
    27→-- User authentication methods (email, phone, wechat, apple, google)
    28→CREATE TABLE IF NOT EXISTS user_auth (
    29→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    30→    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    31→    auth_type VARCHAR(20) NOT NULL,  -- email | phone | wechat | apple | google
    32→    auth_identifier VARCHAR(255) NOT NULL,  -- email/phone/openid
    33→    password_hash VARCHAR(255),  -- for email/phone auth
    34→    metadata JSONB DEFAULT '{}',  -- additional auth data
    35→    created_at TIMESTAMPTZ DEFAULT NOW(),
    36→    UNIQUE(auth_type, auth_identifier)
    37→);
    38→
    39→-- ============================================================================
    40→-- USER PROFILE (按 spec 4.4 设计)
    41→-- ============================================================================
    42→
    43→-- User profiles with versioning (JSONB storage)
    44→CREATE TABLE IF NOT EXISTS user_profiles (
    45→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    46→    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    47→    version INT DEFAULT 1,
    48→    profile JSONB NOT NULL DEFAULT '{
    49→        "version": "1.0",
    50→        "basic": {},
    51→        "life_context": {},
    52→        "ai_insights": {},
    53→        "identity_prism": {},
    54→        "preferences": {
    55→            "voice_mode": "warm",
    56→            "language": "zh-CN"
    57→        }
    58→    }',
    59→    created_at TIMESTAMPTZ DEFAULT NOW(),
    60→    UNIQUE(user_id, version)
    61→);
    62→
    63→-- ============================================================================
    64→-- CONVERSATIONS & MESSAGES
    65→-- ============================================================================
    66→
    67→-- Conversation sessions
    68→CREATE TABLE IF NOT EXISTS conversations (
    69→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    70→    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    71→    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac')),
    72→    voice_mode VARCHAR(20) DEFAULT 'warm' CHECK (voice_mode IN ('warm', 'sarcastic')),
    73→    title VARCHAR(255),  -- 会话标题（可选）
    74→    is_active BOOLEAN DEFAULT TRUE,
    75→    created_at TIMESTAMPTZ DEFAULT NOW(),
    76→    updated_at TIMESTAMPTZ DEFAULT NOW()
    77→);
    78→
    79→-- Chat messages
    80→CREATE TABLE IF NOT EXISTS messages (
    81→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    82→    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    83→    role VARCHAR(20) NOT NULL CHECK (role IN ('user', 'assistant', 'system')),
    84→    content TEXT NOT NULL,
    85→    metadata JSONB DEFAULT '{}',  -- tool calls, extracted info, etc.
    86→    created_at TIMESTAMPTZ DEFAULT NOW()
    87→);
    88→
    89→-- ============================================================================
    90→-- REPORTS
    91→-- ============================================================================
    92→
    93→-- Generated reports
    94→CREATE TABLE IF NOT EXISTS reports (
    95→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    96→    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    97→    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac')),
    98→    report_type VARCHAR(20) NOT NULL CHECK (report_type IN ('brief', 'full')),
    99→
   100→    -- 报告内容 (结构化 JSON)
   101→    content JSONB NOT NULL DEFAULT '{}',
   102→    -- 卷首语 (综合判断)
   103→    prologue TEXT,
   104→    -- AI 生图 URL
   105→    image_url TEXT,
   106→    image_thumbnail_url TEXT,
   107→
   108→    -- 付费状态
   109→    is_paid BOOLEAN DEFAULT FALSE,
   110→
   111→    -- 元数据
   112→    interview_data JSONB,  -- AI 访谈数据
   113→    generation_metadata JSONB,  -- 生成时的配置
   114→
   115→    created_at TIMESTAMPTZ DEFAULT NOW(),
   116→    updated_at TIMESTAMPTZ DEFAULT NOW()
   117→);
   118→
   119→-- ============================================================================
   120→-- RELATIONSHIPS (关系模拟器)
   121→-- ============================================================================
   122→
   123→-- Relationship analysis records
   124→CREATE TABLE IF NOT EXISTS relationships (
   125→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   126→
   127→    -- 发起者
   128→    initiator_id UUID REFERENCES users(id) ON DELETE SET NULL,
   129→
   130→    -- 对方 (可以是注册用户或匿名信息)
   131→    partner_id UUID REFERENCES users(id) ON DELETE SET NULL,
   132→    partner_info JSONB,  -- 单人模式下对方的基本信息
   133→
   134→    -- 分析配置
   135→    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac')),
   136→    relationship_type VARCHAR(50),  -- romantic | friend | family | work
   137→
   138→    -- 分析结果
   139→    analysis JSONB NOT NULL DEFAULT '{}',
   140→    action_tips JSONB DEFAULT '[]',  -- 行动建议列表
   141→
   142→    -- Vibe Link 分享
   143→    share_token VARCHAR(100) UNIQUE,
   144→    privacy_level VARCHAR(20) DEFAULT 'private' CHECK (privacy_level IN ('private', 'basic', 'detailed')),
   145→
   146→    -- 付费状态
   147→    is_paid BOOLEAN DEFAULT FALSE,
   148→    image_url TEXT,  -- 关系海报
   149→
   150→    created_at TIMESTAMPTZ DEFAULT NOW(),
   151→    expires_at TIMESTAMPTZ  -- Vibe Link 过期时间
   152→);
   153→
   154→-- ============================================================================
   155→-- KNOWLEDGE BASE (向量存储)
   156→-- ============================================================================
   157→
   158→-- Knowledge chunks for RAG
   159→CREATE TABLE IF NOT EXISTS knowledge_chunks (
   160→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   161→    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac', 'shared')),
   162→    category VARCHAR(100),  -- e.g., "十神", "格局", "星座特质"
   163→    subcategory VARCHAR(100),
   164→
   165→    -- 内容
   166→    title VARCHAR(255),
   167→    content TEXT NOT NULL,
   168→
   169→    -- 向量 (BGE-M3, 1024 维)
   170→    embedding vector(1024),
   171→
   172→    -- 元数据
   173→    source VARCHAR(255),  -- 来源文件
   174→    metadata JSONB DEFAULT '{}',
   175→
   176→    created_at TIMESTAMPTZ DEFAULT NOW()
   177→);
   178→
   179→-- ============================================================================
   180→-- SUBSCRIPTIONS & PAYMENTS
   181→-- ============================================================================
   182→
   183→-- Subscription plans
   184→CREATE TABLE IF NOT EXISTS subscription_plans (
   185→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   186→    code VARCHAR(50) UNIQUE NOT NULL,  -- monthly | yearly
   187→    name VARCHAR(100) NOT NULL,
   188→    description TEXT,
   189→    price_cents INT NOT NULL,  -- 单位：分
   190→    currency VARCHAR(10) DEFAULT 'CNY',
   191→    duration_days INT NOT NULL,  -- 有效期天数
   192→    features JSONB DEFAULT '[]',
   193→    is_active BOOLEAN DEFAULT TRUE,
   194→    created_at TIMESTAMPTZ DEFAULT NOW()
   195→);
   196→
   197→-- User subscriptions
   198→CREATE TABLE IF NOT EXISTS subscriptions (
   199→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   200→    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
   201→    plan_id UUID REFERENCES subscription_plans(id),
   202→    plan_code VARCHAR(50) NOT NULL,
   203→
   204→    status VARCHAR(20) NOT NULL CHECK (status IN ('active', 'canceled', 'expired', 'trial')),
   205→
   206→    started_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
   207→    expires_at TIMESTAMPTZ NOT NULL,
   208→    canceled_at TIMESTAMPTZ,
   209→
   210→    -- 来源
   211→    source VARCHAR(50),  -- report_purchase | direct | promo
   212→
   213→    created_at TIMESTAMPTZ DEFAULT NOW(),
   214→    updated_at TIMESTAMPTZ DEFAULT NOW()
   215→);
   216→
   217→-- Payment records
   218→CREATE TABLE IF NOT EXISTS payments (
   219→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   220→    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
   221→
   222→    -- 产品信息
   223→    product_type VARCHAR(50) NOT NULL,  -- report | subscription | relationship
   224→    product_id UUID,
   225→
   226→    -- 金额
   227→    amount_cents INT NOT NULL,  -- 单位：分
   228→    currency VARCHAR(10) DEFAULT 'CNY',
   229→
   230→    -- 状态
   231→    status VARCHAR(20) NOT NULL CHECK (status IN ('pending', 'success', 'failed', 'refunded')),
   232→
   233→    -- 支付渠道
   234→    provider VARCHAR(20),  -- wechat | alipay | stripe
   235→    provider_payment_id VARCHAR(255),
   236→    provider_metadata JSONB DEFAULT '{}',
   237→
   238→    -- 回调
   239→    paid_at TIMESTAMPTZ,
   240→
   241→    created_at TIMESTAMPTZ DEFAULT NOW(),
   242→    updated_at TIMESTAMPTZ DEFAULT NOW()
   243→);
   244→
   245→-- ============================================================================
   246→-- DAILY GREETING & FORTUNE
   247→-- ============================================================================
   248→
   249→-- Pre-generated daily greetings cache
   250→CREATE TABLE IF NOT EXISTS daily_greetings (
   251→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   252→    date DATE NOT NULL,
   253→    skill VARCHAR(20) NOT NULL CHECK (skill IN ('bazi', 'zodiac', 'shared')),
   254→
   255→    -- 内容
   256→    greeting TEXT NOT NULL,
   257→    fortune_hint TEXT,
   258→    celestial_event TEXT,  -- 天象事件
   259→    solar_term VARCHAR(50),  -- 节气
   260→
   261→    -- 元数据
   262→    metadata JSONB DEFAULT '{}',
   263→
   264→    created_at TIMESTAMPTZ DEFAULT NOW(),
   265→    UNIQUE(date, skill)
   266→);
   267→
   268→-- ============================================================================
   269→-- INSIGHTS (洞察卡片)
   270→-- ============================================================================
   271→
   272→-- User insights collected from conversations
   273→CREATE TABLE IF NOT EXISTS insights (
   274→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   275→    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
   276→    conversation_id UUID REFERENCES conversations(id) ON DELETE SET NULL,
   277→
   278→    -- 洞察类型
   279→    insight_type VARCHAR(50) NOT NULL,  -- discovery | pattern | timing | growth
   280→
   281→    -- 内容
   282→    title VARCHAR(255),
   283→    content TEXT NOT NULL,
   284→
   285→    -- 来源
   286→    source_skill VARCHAR(20),
   287→    source_context TEXT,  -- 相关对话片段
   288→
   289→    -- 状态
   290→    is_bookmarked BOOLEAN DEFAULT FALSE,
   291→    is_shared BOOLEAN DEFAULT FALSE,
   292→
   293→    created_at TIMESTAMPTZ DEFAULT NOW()
   294→);
   295→
   296→-- ============================================================================
   297→-- ANALYTICS & EVENTS
   298→-- ============================================================================
   299→
   300→-- User events for analytics
   301→CREATE TABLE IF NOT EXISTS user_events (
   302→    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
   303→    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
   304→    session_id VARCHAR(100),
   305→
   306→    -- 事件信息
   307→    event_name VARCHAR(100) NOT NULL,
   308→    event_data JSONB DEFAULT '{}',
   309→
   310→    -- 来源
   311→    source VARCHAR(50),  -- web | mobile | api
   312→    user_agent TEXT,
   313→    ip_address INET,
   314→
   315→    created_at TIMESTAMPTZ DEFAULT NOW()
   316→);
   317→
   318→-- ============================================================================
   319→-- INDEXES
   320→-- ============================================================================
   321→
   322→-- Users
   323→CREATE INDEX IF NOT EXISTS idx_users_vibe_id ON users(vibe_id);
   324→CREATE INDEX IF NOT EXISTS idx_users_email ON users(email) WHERE email IS NOT NULL;
   325→CREATE INDEX IF NOT EXISTS idx_users_phone ON users(phone) WHERE phone IS NOT NULL;
   326→
   327→-- User Auth
   328→CREATE INDEX IF NOT EXISTS idx_user_auth_user ON user_auth(user_id);
   329→
   330→-- User Profiles
   331→CREATE INDEX IF NOT EXISTS idx_user_profiles_user ON user_profiles(user_id);
   332→CREATE INDEX IF NOT EXISTS idx_user_profiles_latest ON user_profiles(user_id, version DESC);
   333→
   334→-- Conversations
   335→CREATE INDEX IF NOT EXISTS idx_conversations_user ON conversations(user_id);
   336→CREATE INDEX IF NOT EXISTS idx_conversations_skill ON conversations(skill);
   337→CREATE INDEX IF NOT EXISTS idx_conversations_active ON conversations(user_id, is_active) WHERE is_active = TRUE;
   338→
   339→-- Messages
   340→CREATE INDEX IF NOT EXISTS idx_messages_conversation ON messages(conversation_id);
   341→CREATE INDEX IF NOT EXISTS idx_messages_created ON messages(conversation_id, created_at);
   342→
   343→-- Reports
   344→CREATE INDEX IF NOT EXISTS idx_reports_user ON reports(user_id);
   345→CREATE INDEX IF NOT EXISTS idx_reports_skill ON reports(skill);
   346→
   347→-- Relationships
   348→CREATE INDEX IF NOT EXISTS idx_relationships_initiator ON relationships(initiator_id);
   349→CREATE INDEX IF NOT EXISTS idx_relationships_partner ON relationships(partner_id) WHERE partner_id IS NOT NULL;
   350→CREATE INDEX IF NOT EXISTS idx_relationships_token ON relationships(share_token) WHERE share_token IS NOT NULL;
   351→
   352→-- Knowledge
   353→CREATE INDEX IF NOT EXISTS idx_knowledge_skill ON knowledge_chunks(skill);
   354→CREATE INDEX IF NOT EXISTS idx_knowledge_category ON knowledge_chunks(skill, category);
   355→CREATE INDEX IF NOT EXISTS idx_knowledge_embedding ON knowledge_chunks USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
   356→
   357→-- Subscriptions
   358→CREATE INDEX IF NOT EXISTS idx_subscriptions_user ON subscriptions(user_id);
   359→CREATE INDEX IF NOT EXISTS idx_subscriptions_active ON subscriptions(user_id, status) WHERE status = 'active';
   360→
   361→-- Payments
   362→CREATE INDEX IF NOT EXISTS idx_payments_user ON payments(user_id);
   363→CREATE INDEX IF NOT EXISTS idx_payments_status ON payments(status);
   364→
   365→-- Daily Greetings
   366→CREATE INDEX IF NOT EXISTS idx_daily_greetings_date ON daily_greetings(date, skill);
   367→
   368→-- Insights
   369→CREATE INDEX IF NOT EXISTS idx_insights_user ON insights(user_id);
   370→CREATE INDEX IF NOT EXISTS idx_insights_bookmarked ON insights(user_id, is_bookmarked) WHERE is_bookmarked = TRUE;
   371→
   372→-- Events
   373→CREATE INDEX IF NOT EXISTS idx_events_user ON user_events(user_id);
   374→CREATE INDEX IF NOT EXISTS idx_events_name ON user_events(event_name);
   375→CREATE INDEX IF NOT EXISTS idx_events_created ON user_events(created_at);
   376→
   377→-- ============================================================================
   378→-- INITIAL DATA
   379→-- ============================================================================
   380→
   381→-- Insert default subscription plans
   382→INSERT INTO subscription_plans (code, name, description, price_cents, duration_days, features) VALUES
   383→    ('monthly', '月度订阅', '每月订阅，畅享所有高级功能', 1990, 30, '["无限报告生成", "无限对话", "Identity Prism", "人生K线", "关系分析"]'),
   384→    ('yearly', '年度订阅', '年度订阅，省80元', 15900, 365, '["无限报告生成", "无限对话", "Identity Prism", "人生K线", "关系分析", "优先支持"]')
   385→ON CONFLICT (code) DO NOTHING;
   386→
   387→-- ============================================================================
   388→-- FUNCTIONS & TRIGGERS
   389→-- ============================================================================
   390→
   391→-- Function to update updated_at timestamp
   392→CREATE OR REPLACE FUNCTION update_updated_at_column()
   393→RETURNS TRIGGER AS $$
   394→BEGIN
   395→    NEW.updated_at = NOW();
   396→    RETURN NEW;
   397→END;
   398→$$ language 'plpgsql';
   399→
   400→-- Apply updated_at trigger to relevant tables
   401→DROP TRIGGER IF EXISTS update_users_updated_at ON users;
   402→CREATE TRIGGER update_users_updated_at
   403→    BEFORE UPDATE ON users
   404→    FOR EACH ROW
   405→    EXECUTE FUNCTION update_updated_at_column();
   406→
   407→DROP TRIGGER IF EXISTS update_conversations_updated_at ON conversations;
   408→CREATE TRIGGER update_conversations_updated_at
   409→    BEFORE UPDATE ON conversations
   410→    FOR EACH ROW
   411→    EXECUTE FUNCTION update_updated_at_column();
   412→
   413→DROP TRIGGER IF EXISTS update_reports_updated_at ON reports;
   414→CREATE TRIGGER update_reports_updated_at
   415→    BEFORE UPDATE ON reports
   416→    FOR EACH ROW
   417→    EXECUTE FUNCTION update_updated_at_column();
   418→
   419→DROP TRIGGER IF EXISTS update_subscriptions_updated_at ON subscriptions;
   420→CREATE TRIGGER update_subscriptions_updated_at
   421→    BEFORE UPDATE ON subscriptions
   422→    FOR EACH ROW
   423→    EXECUTE FUNCTION update_updated_at_column();
   424→
   425→DROP TRIGGER IF EXISTS update_payments_updated_at ON payments;
   426→CREATE TRIGGER update_payments_updated_at
   427→    BEFORE UPDATE ON payments
   428→    FOR EACH ROW
   429→    EXECUTE FUNCTION update_updated_at_column();
   430→
   431→-- Function to generate vibe_id
   432→CREATE OR REPLACE FUNCTION generate_vibe_id()
   433→RETURNS VARCHAR(50) AS $$
   434→DECLARE
   435→    chars VARCHAR(36) := 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
   436→    result VARCHAR(50) := 'VIBE-';
   437→    i INTEGER;
   438→BEGIN
   439→    FOR i IN 1..8 LOOP
   440→        result := result || substr(chars, floor(random() * length(chars) + 1)::int, 1);
   441→    END LOOP;
   442→    RETURN result;
   443→END;
   444→$$ LANGUAGE plpgsql;
   445→
   446→-- Trigger to auto-generate vibe_id on user creation
   447→CREATE OR REPLACE FUNCTION auto_generate_vibe_id()
   448→RETURNS TRIGGER AS $$
   449→BEGIN
   450→    IF NEW.vibe_id IS NULL OR NEW.vibe_id = '' THEN
   451→        NEW.vibe_id := generate_vibe_id();
   452→    END IF;
   453→    RETURN NEW;
   454→END;
   455→$$ LANGUAGE plpgsql;
   456→
   457→DROP TRIGGER IF EXISTS trigger_auto_vibe_id ON users;
   458→CREATE TRIGGER trigger_auto_vibe_id
   459→    BEFORE INSERT ON users
   460→    FOR EACH ROW
   461→    EXECUTE FUNCTION auto_generate_vibe_id();
   462→
   463→-- ============================================================================
   464→-- COMMENTS
   465→-- ============================================================================
   466→
   467→COMMENT ON TABLE users IS 'Core user identity table';
   468→COMMENT ON TABLE user_profiles IS 'User profiles with versioning, stores complete profile JSON';
   469→COMMENT ON TABLE conversations IS 'Chat conversation sessions';
   470→COMMENT ON TABLE messages IS 'Individual chat messages';
   471→COMMENT ON TABLE reports IS 'Generated analysis reports (brief/full)';
   472→COMMENT ON TABLE relationships IS 'Relationship analysis records with Vibe Link sharing';
   473→COMMENT ON TABLE knowledge_chunks IS 'RAG knowledge base with vector embeddings';
   474→COMMENT ON TABLE subscriptions IS 'User subscription records';
   475→COMMENT ON TABLE payments IS 'Payment transaction records';
   476→COMMENT ON TABLE daily_greetings IS 'Pre-generated daily greetings cache';
   477→COMMENT ON TABLE insights IS 'User insights extracted from conversations';
   478→COMMENT ON TABLE user_events IS 'Analytics events tracking';
   479→
   480→-- ============================================================================
   481→-- DONE
   482→-- ============================================================================
   483→
   484→SELECT 'VibeLife v3.0 Schema created successfully!' as status;
   485→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
