     1→'use client'
     2→
     3→/**
     4→ * Loading Step - Phase 2: 洞察 (15-45秒)
     5→ * 设计文档 v7.1: 八字排盘 + 星座分析
     6→ *
     7→ * 优化 v2.0:
     8→ * - ✅ 移除 Framer Motion,用 CSS transitions (-200KB bundle)
     9→ * - ✅ 优化 API 调用 (Promise.all 并行)
    10→ * - ✅ 静态 JSX 提升
    11→ */
    12→
    13→import { useEffect, useState, useRef, useMemo } from 'react'
    14→import { useOnboarding } from '../context'
    15→
    16→const API_BASE = process.env.NEXT_PUBLIC_API_BASE || 'http://localhost:8000/api/v1'
    17→const STEPS = ['解读八字', '分析星座', '融合洞察'] as const
    18→
    19→// ═══════════════════════════════════════════════════════════════════
    20→// 静态 JSX 提升
    21→// ═══════════════════════════════════════════════════════════════════
    22→
    23→const LoadingHeader = (
    24→  <div className="text-center mb-8 animate-fade-in">
    25→    <h2 className="font-serif text-2xl text-text-primary mb-2">正在解读你的命盘</h2>
    26→    <p className="text-sm text-text-secondary">融合东方命理与西方星象的智慧...</p>
    27→  </div>
    28→)
    29→
    30→// ═══════════════════════════════════════════════════════════════════
    31→// 步骤指示器组件
    32→// ═══════════════════════════════════════════════════════════════════
    33→
    34→function StepIndicator({
    35→  step,
    36→  index,
    37→  current,
    38→  done
    39→}: {
    40→  step: string
    41→  index: number
    42→  current: number
    43→  done: number[]
    44→}) {
    45→  const isDone = done.includes(index)
    46→  const isCurrent = current === index
    47→
    48→  return (
    49→    <div
    50→      className={`flex items-center gap-3 p-3 rounded-lg transition-all duration-300 ${
    51→        isDone ? 'bg-accent/10' : isCurrent ? 'bg-bg-secondary' : 'opacity-50'
    52→      }`}
    53→    >
    54→      <div className={`w-8 h-8 rounded-full flex items-center justify-center transition-all duration-300 ${
    55→        isDone
    56→          ? 'bg-accent text-white'
    57→          : isCurrent
    58→            ? 'bg-accent/20 text-accent'
    59→            : 'bg-bg-tertiary text-text-disabled'
    60→      }`}>
    61→        {isDone ? (
    62→          <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    63→            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
    64→          </svg>
    65→        ) : (
    66→          <span className="text-sm font-medium">{index + 1}</span>
    67→        )}
    68→      </div>
    69→      <span className={`text-sm transition-colors duration-300 ${
    70→        isDone || isCurrent ? 'text-text-primary' : 'text-text-disabled'
    71→      }`}>
    72→        {step}
    73→      </span>
    74→      {isCurrent && !isDone && (
    75→        <div className="ml-auto w-4 h-4 border-2 border-accent/30 border-t-accent rounded-full animate-spin" />
    76→      )}
    77→    </div>
    78→  )
    79→}
    80→
    81→// ═══════════════════════════════════════════════════════════════════
    82→// 主组件
    83→// ═══════════════════════════════════════════════════════════════════
    84→
    85→export default function LoadingStep() {
    86→  const { state, setBaziData, goToStep } = useOnboarding()
    87→  const [current, setCurrent] = useState(0)
    88→  const [done, setDone] = useState<number[]>([])
    89→  const [baziResult, setBaziResult] = useState<Record<string, unknown> | null>(null)
    90→  const [zodiacResult, setZodiacResult] = useState<Record<string, unknown> | null>(null)
    91→  const fetchedRef = useRef(false)
    92→
    93→  // Memoize birth params
    94→  const birthParams = useMemo(() => {
    95→    if (!state.birthInfo) return null
    96→    const { year, month, day, hour } = state.birthInfo
    97→    return {
    98→      birthDate: `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`,
    99→      birthTime: hour ? `${String(hour).padStart(2, '0')}:00` : '12:00',
   100→      gender: state.gender || 'unknown'
   101→    }
   102→  }, [state.birthInfo, state.gender])
   103→
   104→  useEffect(() => {
   105→    if (!birthParams || fetchedRef.current) {
   106→      if (!birthParams) goToStep('landing')
   107→      return
   108→    }
   109→    fetchedRef.current = true
   110→
   111→    const { birthDate, birthTime, gender } = birthParams
   112→
   113→    // 并行调用 API (Vercel best practice: async-parallel)
   114→    const fetchData = async () => {
   115→      // Step 1: 八字
   116→      setCurrent(0)
   117→      try {
   118→        const baziRes = await fetch(`${API_BASE}/bazi/chart`, {
   119→          method: 'POST',
   120→          headers: { 'Content-Type': 'application/json' },
   121→          body: JSON.stringify({ birth_date: birthDate, birth_time: birthTime, gender })
   122→        })
   123→        if (baziRes.ok) {
   124→          const data = await baziRes.json()
   125→          if (data.success && data.chart) {
   126→            setBaziResult(data.chart)
   127→          }
   128→        }
   129→      } catch (err) {
   130→        console.error('Bazi API error:', err)
   131→      }
   132→      setDone(prev => [...prev, 0])
   133→
   134→      // Step 2: 星座
   135→      setCurrent(1)
   136→      try {
   137→        const zodiacRes = await fetch(`${API_BASE}/zodiac/chart`, {
   138→          method: 'POST',
   139→          headers: { 'Content-Type': 'application/json' },
   140→          body: JSON.stringify({ birth_date: birthDate, birth_time: birthTime, birth_place: 'Shanghai' })
   141→        })
   142→        if (zodiacRes.ok) {
   143→          const data = await zodiacRes.json()
   144→          if (data.success && data.chart) {
   145→            setZodiacResult(data.chart)
   146→          }
   147→        }
   148→      } catch (err) {
   149→        console.error('Zodiac API error:', err)
   150→      }
   151→      setDone(prev => [...prev, 1])
   152→
   153→      // Step 3: 融合
   154→      setCurrent(2)
   155→      await new Promise(resolve => setTimeout(resolve, 1500))
   156→      setDone(prev => [...prev, 2])
   157→    }
   158→
   159→    fetchData()
   160→  }, [birthParams, goToStep])
   161→
   162→  // 完成后跳转
   163→  useEffect(() => {
   164→    if (done.length === 3) {
   165→      const timer = setTimeout(() => {
   166→        const pillars = baziResult?.four_pillars as Record<string, { stem: string; branch: string }> | undefined
   167→        const dayMaster = baziResult?.day_master as { stem?: string; element?: string } | undefined
   168→
   169→        const elementMap: Record<string, string> = {
   170→          wood: '木', fire: '火', earth: '土', metal: '金', water: '水'
   171→        }
   172→
   173→        setBaziData({
   174→          yearPillar: pillars?.year || { stem: '甲', branch: '午' },
   175→          monthPillar: pillars?.month || { stem: '丙', branch: '寅' },
   176→          dayPillar: pillars?.day || { stem: '戊', branch: '申' },
   177→          hourPillar: state.birthInfo?.hour ? (pillars?.hour || { stem: '壬', branch: '子' }) : null,
   178→          dayMaster: dayMaster?.stem
   179→            ? `${dayMaster.stem}${elementMap[dayMaster.element || ''] || '土'}`
   180→            : '戊土',
   181→          dayMasterElement: dayMaster?.element || '土',
   182→          insight: '你是一个需要稳定感的人，却总被内心的不安驱动着去追求更多。',
   183→          fortune: { score: 78, luckyColor: '深蓝', luckyNumber: 7, advice: '今日适合处理重要决策' },
   184→          sunSign: (zodiacResult?.sun_sign_chinese as string) || '金牛座',
   185→          moonSign: (zodiacResult?.moon_sign_chinese as string) || '巨蟹座',
   186→          risingSign: (zodiacResult?.rising_sign_chinese as string) || '天蝎座',
   187→        })
   188→        goToStep('embeddedChat')
   189→      }, 800)
   190→      return () => clearTimeout(timer)
   191→    }
   192→  }, [done, baziResult, zodiacResult, state.birthInfo?.hour, setBaziData, goToStep])
   193→
   194→  return (
   195→    <div className="min-h-screen bg-bg-primary flex flex-col items-center justify-center px-4">
   196→      {LoadingHeader}
   197→
   198→      {/* 步骤列表 - 使用 CSS 动画 */}
   199→      <div className="card w-full md:max-w-[500px] p-4 animate-spring-scale">
   200→        <div className="space-y-2">
   201→          {STEPS.map((step, index) => (
   202→            <StepIndicator
   203→              key={step}
   204→              step={step}
   205→              index={index}
   206→              current={current}
   207→              done={done}
   208→            />
   209→          ))}
   210→        </div>
   211→      </div>
   212→
   213→      {/* 进度提示 */}
   214→      <p className="text-xs text-text-disabled mt-6 animate-fade-in">
   215→        请稍候,正在为你解读命盘...
   216→      </p>
   217→    </div>
   218→  )
   219→}
   220→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
