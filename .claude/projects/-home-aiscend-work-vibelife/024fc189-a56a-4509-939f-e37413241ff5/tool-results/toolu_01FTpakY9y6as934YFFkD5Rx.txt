     1→'use client';
     2→
     3→/**
     4→ * Discover Content - App Store 风格的 Skill 探索页面
     5→ *
     6→ * 在 AppShell 的 discover tab 中显示
     7→ * 参考 Apple App Store 的设计理念
     8→ */
     9→
    10→import React, { useMemo } from 'react';
    11→import { useRouter } from 'next/navigation';
    12→import { AlertCircle, Sparkles } from 'lucide-react';
    13→import { FeaturedSkillBanner } from './FeaturedSkillBanner';
    14→import { CategorySection } from './CategorySection';
    15→import { SkillShowcaseCard } from './SkillShowcaseCard';
    16→import { useSkills, useSkillSubscription, useSkillRecommendations } from '@/hooks/useSkillSubscription';
    17→import { useAuth } from '@/providers/AuthProvider';
    18→import type { SkillMetadata } from '@/types/skill';
    19→
    20→export function DiscoverContent() {
    21→  const router = useRouter();
    22→  const { user, isLoaded: authLoaded } = useAuth();
    23→
    24→  // 所有 hooks 必须在条件判断之前调用
    25→  const { skills, categories, isLoading: skillsLoading, error: skillsError } = useSkills();
    26→  const {
    27→    userStatuses,
    28→    subscribe,
    29→    unsubscribe,
    30→    isLoading: subscriptionsLoading,
    31→  } = useSkillSubscription();
    32→  const { recommendations } = useSkillRecommendations({ limit: 3, enabled: !!user });
    33→
    34→  // 只依赖 skillsLoading 和 authLoaded
    35→  const isLoading = !authLoaded || skillsLoading;
    36→
    37→  // 按分类分组 Skills
    38→  const skillsByCategory = useMemo(() => {
    39→    const grouped: Record<string, SkillMetadata[]> = {
    40→      professional: [],
    41→      core: [], // 合并 default 和 core 到这里
    42→    };
    43→
    44→    for (const skill of skills) {
    45→      if (skill.category === 'professional') {
    46→        grouped.professional.push(skill);
    47→      } else {
    48→        // default 和 core 都归入 core
    49→        grouped.core.push(skill);
    50→      }
    51→    }
    52→
    53→    return grouped;
    54→  }, [skills]);
    55→
    56→  // 精选 Skill (选择最有特色的)
    57→  const featuredSkill = useMemo(() => {
    58→    // 优先选择 professional 分类的第一个
    59→    return skillsByCategory.professional[0] || skillsByCategory.core[0] || skills[0];
    60→  }, [skillsByCategory, skills]);
    61→
    62→  // 推荐 Skills - 排除精选和已订阅的
    63→  const recommendedSkills = useMemo(() => {
    64→    if (recommendations.length === 0) return [];
    65→
    66→    const recommendedIds = new Set(recommendations.map(r => r.skill_id));
    67→    // 过滤掉精选的和已订阅的，只显示真正需要推荐的
    68→    return skills.filter(s =>
    69→      recommendedIds.has(s.id) &&
    70→      s.id !== featuredSkill?.id &&
    71→      !userStatuses[s.id]?.subscribed
    72→    );
    73→  }, [skills, recommendations, featuredSkill, userStatuses]);
    74→
    75→  // 专业技能 - 排除精选的
    76→  const professionalSkillsFiltered = useMemo(() => {
    77→    return skillsByCategory.professional.filter(s => s.id !== featuredSkill?.id);
    78→  }, [skillsByCategory.professional, featuredSkill]);
    79→
    80→  // 处理订阅
    81→  const handleSubscribe = async (skillId: string) => {
    82→    if (!user) {
    83→      router.push('/auth/login?redirect=/chat');
    84→      return;
    85→    }
    86→    try {
    87→      await subscribe(skillId);
    88→    } catch (error: any) {
    89→      // 处理 Premium 要求错误 (402)
    90→      if (error?.response?.status === 402) {
    91→        const detail = error.response.data?.detail;
    92→        if (detail?.code === 'PREMIUM_REQUIRED') {
    93→          router.push(`/membership?reason=skill_subscribe&skill=${skillId}`);
    94→          return;
    95→        }
    96→      }
    97→      console.error('Subscribe failed:', error);
    98→    }
    99→  };
   100→
   101→  // 处理取消订阅
   102→  const handleUnsubscribe = async (skillId: string) => {
   103→    if (!user) return;
   104→    try {
   105→      await unsubscribe(skillId);
   106→    } catch (error) {
   107→      console.error('Unsubscribe failed:', error);
   108→    }
   109→  };
   110→
   111→  // 处理点击 Skill
   112→  const handleSkillClick = (skillId: string) => {
   113→    router.push(`/skills/${skillId}`);
   114→  };
   115→
   116→  // 未登录用户显示登录提示
   117→  if (authLoaded && !user) {
   118→    return (
   119→      <div className="h-full overflow-y-auto bg-bg-primary">
   120→        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8">
   121→          <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
   122→            <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-vellum-200 to-vellum-300 flex items-center justify-center">
   123→              <span className="text-4xl">✨</span>
   124→            </div>
   125→            <div className="text-center space-y-2">
   126→              <h2 className="text-2xl font-bold text-text-primary">探索更多 Skills</h2>
   127→              <p className="text-text-secondary max-w-md">
   128→                登录后即可浏览和订阅各种专业技能，开启你的自我探索之旅。
   129→              </p>
   130→            </div>
   131→            <button
   132→              onClick={() => router.push('/auth/login?redirect=/chat?tab=discover')}
   133→              className="px-6 py-3 rounded-full bg-accent-primary text-text-inverse font-medium hover:bg-accent-primary/90 transition-colors"
   134→            >
   135→              登录探索
   136→            </button>
   137→          </div>
   138→        </div>
   139→      </div>
   140→    );
   141→  }
   142→
   143→  // Loading 状态 - 优化的骨架屏动画
   144→  if (isLoading) {
   145→    return (
   146→      <div className="h-full overflow-y-auto bg-bg-primary">
   147→        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8 space-y-8">
   148→          {/* 加载提示 */}
   149→          <div className="flex items-center justify-center gap-3 py-4">
   150→            <div className="w-2 h-2 bg-accent-primary rounded-full animate-bounce [animation-delay:-0.3s]" />
   151→            <div className="w-2 h-2 bg-accent-primary rounded-full animate-bounce [animation-delay:-0.15s]" />
   152→            <div className="w-2 h-2 bg-accent-primary rounded-full animate-bounce" />
   153→            <span className="text-text-secondary ml-2">正在加载 Skills...</span>
   154→          </div>
   155→
   156→          {/* Featured 骨架屏 - 渐变动画 */}
   157→          <div className="relative h-[300px] lg:h-[400px] rounded-3xl overflow-hidden">
   158→            <div className="absolute inset-0 bg-gradient-to-r from-bg-secondary via-bg-tertiary to-bg-secondary animate-shimmer"
   159→                 style={{ backgroundSize: '200% 100%' }} />
   160→          </div>
   161→
   162→          {/* Section 骨架屏 */}
   163→          {[1, 2].map((i) => (
   164→            <div key={i} className="space-y-4">
   165→              <div className="flex items-center gap-3">
   166→                <div className="h-6 w-32 bg-bg-secondary rounded-lg animate-pulse" />
   167→                <div className="h-4 w-48 bg-bg-tertiary rounded animate-pulse" />
   168→              </div>
   169→              <div className="flex gap-4 overflow-hidden">
   170→                {[1, 2, 3, 4].map((j) => (
   171→                  <div
   172→                    key={j}
   173→                    className="w-72 h-56 rounded-2xl overflow-hidden flex-shrink-0"
   174→                    style={{ animationDelay: `${j * 0.1}s` }}
   175→                  >
   176→                    <div className="h-full bg-gradient-to-br from-bg-secondary to-bg-tertiary animate-pulse" />
   177→                  </div>
   178→                ))}
   179→              </div>
   180→            </div>
   181→          ))}
   182→        </div>
   183→      </div>
   184→    );
   185→  }
   186→
   187→  // 错误状态
   188→  if (skillsError) {
   189→    return (
   190→      <div className="h-full overflow-y-auto bg-bg-primary">
   191→        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8">
   192→          <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
   193→            <div className="w-20 h-20 rounded-full bg-red-500/10 flex items-center justify-center">
   194→              <AlertCircle className="w-10 h-10 text-red-500" />
   195→            </div>
   196→            <div className="text-center space-y-2">
   197→              <h2 className="text-2xl font-bold text-text-primary">加载失败</h2>
   198→              <p className="text-text-secondary max-w-md">
   199→                无法加载 Skill 列表。请稍后重试或联系支持。
   200→              </p>
   201→            </div>
   202→            <button
   203→              onClick={() => window.location.reload()}
   204→              className="px-6 py-3 rounded-full bg-accent-primary text-text-inverse font-medium hover:bg-accent-primary/90 transition-colors"
   205→            >
   206→              重新加载
   207→            </button>
   208→          </div>
   209→        </div>
   210→      </div>
   211→    );
   212→  }
   213→
   214→  // 空状态
   215→  if (!skills || skills.length === 0) {
   216→    return (
   217→      <div className="h-full overflow-y-auto bg-bg-primary">
   218→        <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8">
   219→          <div className="flex flex-col items-center justify-center min-h-[60vh] space-y-6">
   220→            <div className="w-20 h-20 rounded-full bg-accent-primary/10 flex items-center justify-center">
   221→              <Sparkles className="w-10 h-10 text-accent-primary" />
   222→            </div>
   223→            <div className="text-center space-y-2">
   224→              <h2 className="text-2xl font-bold text-text-primary">即将推出</h2>
   225→              <p className="text-text-secondary max-w-md">
   226→                我们正在准备更多精彩的 Skills，敬请期待！
   227→              </p>
   228→            </div>
   229→          </div>
   230→        </div>
   231→      </div>
   232→    );
   233→  }
   234→
   235→  return (
   236→    <div className="h-full overflow-y-auto bg-bg-primary">
   237→      <div className="max-w-7xl mx-auto px-4 lg:px-8 py-8 space-y-12">
   238→        {/* 精选横幅 */}
   239→        {featuredSkill && (
   240→          <FeaturedSkillBanner
   241→            skill={featuredSkill}
   242→            campaign={{
   243→              title: '精选推荐',
   244→              subtitle: '开启你的自我探索之旅',
   245→              badge: '编辑推荐',
   246→            }}
   247→            onClick={() => handleSkillClick(featuredSkill.id)}
   248→          />
   249→        )}
   250→
   251→        {/* 为你推荐 */}
   252→        {recommendedSkills.length > 0 && (
   253→          <CategorySection
   254→            title="为你推荐"
   255→            subtitle="基于你的使用习惯智能推荐"
   256→            skills={recommendedSkills}
   257→            userStatuses={userStatuses}
   258→            onSkillClick={handleSkillClick}
   259→            onSubscribe={handleSubscribe}
   260→          />
   261→        )}
   262→
   263→        {/* 专业技能 - 使用过滤后的列表 */}
   264→        {professionalSkillsFiltered.length > 0 && (
   265→          <CategorySection
   266→            title="专业技能"
   267→            subtitle="深度探索，专业洞察"
   268→            skills={professionalSkillsFiltered}
   269→            userStatuses={userStatuses}
   270→            onSkillClick={handleSkillClick}
   271→            onSubscribe={handleSubscribe}
   272→          />
   273→        )}
   274→
   275→        {/* 核心能力（合并了基础功能和原核心能力）*/}
   276→        {skillsByCategory.core.length > 0 && (
   277→          <CategorySection
   278→            title="核心能力"
   279→            subtitle="人人可用的实用工具，始终激活助你成长"
   280→            skills={skillsByCategory.core}
   281→            userStatuses={userStatuses}
   282→            onSkillClick={handleSkillClick}
   283→            onSubscribe={handleSubscribe}
   284→          />
   285→        )}
   286→
   287→        {/* 底部空白 */}
   288→        <div className="h-8" />
   289→      </div>
   290→    </div>
   291→  );
   292→}
   293→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
