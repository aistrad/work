     1→# VibeLife 专家系统引擎构建方案
     2→## 基于 Claude Code + Agentic 方法的知识服务基础设施
     3→
     4→> Version: 1.0 | 2026-01-18
     5→> 核心目标: 通过自动化流水线，将任何领域的专家知识转化为可运营的AI专家服务
     6→
     7→---
     8→
     9→## 一、核心理念
    10→
    11→```
    12→┌─────────────────────────────────────────────────────────────────────────────┐
    13→│                                                                             │
    14→│   问题: 如何让AI具备真人专家的分析能力？                                      │
    15→│                                                                             │
    16→│   答案: 不是训练模型，而是构建"专家思维操作系统"                              │
    17→│                                                                             │
    18→│   ┌─────────────────────────────────────────────────────────────────────┐   │
    19→│   │                                                                     │   │
    20→│   │   真人专家的三层能力                    VibeLife的技术实现            │   │
    21→│   │   ══════════════════                   ══════════════════            │   │
    22→│   │                                                                     │   │
    23→│   │   1. 思维架构                          → 结构化知识图谱              │   │
    24→│   │      (怎么看问题)                         (Thinking Frameworks)      │   │
    25→│   │                                                                     │   │
    26→│   │   2. 推理链条                          → 案例库 + 推理路径           │   │
    27→│   │      (怎么想问题)                         (Reasoning Chains)         │   │
    28→│   │                                                                     │   │
    29→│   │   3. 指导模式                          → 可复用建议模板              │   │
    30→│   │      (怎么给建议)                         (Guidance Patterns)        │   │
    31→│   │                                                                     │   │
    32→│   └─────────────────────────────────────────────────────────────────────┘   │
    33→│                                                                             │
    34→│   关键洞察:                                                                 │
    35→│   ────────                                                                  │
    36→│   LLM已经有海量通用知识，我们要做的是:                                       │
    37→│   1. 提供专业领域的"思维框架"让LLM知道怎么分析                              │
    38→│   2. 提供真实案例的"推理过程"让LLM学习怎么思考                              │
    39→│   3. 提供可复用的"指导模式"让LLM知道怎么给出有价值的建议                    │
    40→│                                                                             │
    41→└─────────────────────────────────────────────────────────────────────────────┘
    42→```
    43→
    44→---
    45→
    46→## 二、整体架构
    47→
    48→```
    49→┌─────────────────────────────────────────────────────────────────────────────┐
    50→│                    专家系统引擎构建架构                                       │
    51→├─────────────────────────────────────────────────────────────────────────────┤
    52→│                                                                             │
    53→│  ════════════════════════ 构建时 (Build Time) ════════════════════════════  │
    54→│                                                                             │
    55→│   ┌─────────────────────────────────────────────────────────────────────┐  │
    56→│   │                                                                     │  │
    57→│   │  原始知识源                                                          │  │
    58→│   │  ────────────                                                        │  │
    59→│   │  • 经典书籍 (PDF/EPUB)        如: 滴天髓、穷通宝鉴                   │  │
    60→│   │  • 教学视频 (字幕)            如: 大师讲座、实战课程                  │  │
    61→│   │  • 专家访谈 (文字稿)          如: 真实咨询案例记录                    │  │
    62→│   │  • 网络文章 (结构化)          如: 知乎专栏、公众号精选                │  │
    63→│   │                                                                     │  │
    64→│   └──────────────────────────────┬──────────────────────────────────────┘  │
    65→│                                  │                                         │
    66→│                                  ▼                                         │
    67→│   ┌─────────────────────────────────────────────────────────────────────┐  │
    68→│   │                                                                     │  │
    69→│   │                 Claude Code 智能构建引擎                              │  │
    70→│   │                 ════════════════════════                              │  │
    71→│   │                                                                     │  │
    72→│   │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │  │
    73→│   │   │   Stage 1     │  │   Stage 2     │  │   Stage 3     │          │  │
    74→│   │   │   格式转换    │→│   智能切分    │→│   三要素抽取  │          │  │
    75→│   │   │   PDF→MD     │  │   语义边界    │  │   思维+推理   │          │  │
    76→│   │   └───────────────┘  └───────────────┘  │   +指导       │          │  │
    77→│   │                                         └───────────────┘          │  │
    78→│   │                                                │                    │  │
    79→│   │                         ┌──────────────────────┼──────────────────┐ │  │
    80→│   │                         ▼                      ▼                  ▼ │  │
    81→│   │                   ┌──────────┐          ┌──────────┐      ┌────────┐│  │
    82→│   │                   │ 思维架构 │          │ 推理链条 │      │指导模式││  │
    83→│   │                   │ 知识图谱 │          │ 案例库   │      │ 模板库 ││  │
    84→│   │                   └──────────┘          └──────────┘      └────────┘│  │
    85→│   │                                                                     │  │
    86→│   │   ┌───────────────┐  ┌───────────────┐                             │  │
    87→│   │   │   Stage 4     │  │   Stage 5     │                             │  │
    88→│   │   │   LLM审核     │→│   场景生成    │                             │  │
    89→│   │   │   质量评分    │  │   SOP组装     │                             │  │
    90→│   │   └───────────────┘  └───────────────┘                             │  │
    91→│   │                                                                     │  │
    92→│   └──────────────────────────────┬──────────────────────────────────────┘  │
    93→│                                  │                                         │
    94→│                                  ▼                                         │
    95→│   ┌─────────────────────────────────────────────────────────────────────┐  │
    96→│   │                                                                     │  │
    97→│   │  输出产物                                                            │  │
    98→│   │  ──────────                                                          │  │
    99→│   │                                                                     │  │
   100→│   │  /skills/{skill_id}/                                                │  │
   101→│   │  ├── SKILL.md              # 专家身份 + 思维架构定义                 │  │
   102→│   │  ├── scenarios/            # 服务场景 + SOP流程                     │  │
   103→│   │  │   ├── basic_reading.md                                           │  │
   104→│   │  │   ├── career.md                                                  │  │
   105→│   │  │   └── ...                                                        │  │
   106→│   │  └── tools/                # 计算工具 + 展示组件                    │  │
   107→│   │                                                                     │  │
   108→│   │  PostgreSQL:                                                        │  │
   109→│   │  ├── knowledge_chunks      # 知识块 + 向量索引                      │  │
   110→│   │  ├── cases                 # 案例库 (含推理链条+指导模式)            │  │
   111→│   │  └── skill_metadata        # Skill元数据                            │  │
   112→│   │                                                                     │  │
   113→│   └─────────────────────────────────────────────────────────────────────┘  │
   114→│                                                                             │
   115→│  ════════════════════════ 运行时 (Runtime) ════════════════════════════════ │
   116→│                                                                             │
   117→│   ┌─────────────────────────────────────────────────────────────────────┐  │
   118→│   │                                                                     │  │
   119→│   │                      CoreAgent 推理引擎                               │  │
   120→│   │                      ═══════════════════                               │  │
   121→│   │                                                                     │  │
   122→│   │   用户问题 → 场景路由 → 加载SKILL.md → RAG检索 → 案例匹配            │  │
   123→│   │                              ↓                                       │  │
   124→│   │                    注入思维架构+推理链条+指导模式                       │  │
   125→│   │                              ↓                                       │  │
   126→│   │                    LLM生成专家级分析                                   │  │
   127→│   │                              ↓                                       │  │
   128→│   │                    工具调用(计算/展示)                                 │  │
   129→│   │                              ↓                                       │  │
   130→│   │                    交付用户                                           │  │
   131→│   │                                                                     │  │
   132→│   └─────────────────────────────────────────────────────────────────────┘  │
   133→│                                                                             │
   134→└─────────────────────────────────────────────────────────────────────────────┘
   135→```
   136→
   137→---
   138→
   139→## 三、Claude Code 智能构建引擎
   140→
   141→### 3.1 为什么用 Claude Code？
   142→
   143→```
   144→┌─────────────────────────────────────────────────────────────────────────────┐
   145→│                     Claude Code 的核心优势                                   │
   146→├─────────────────────────────────────────────────────────────────────────────┤
   147→│                                                                             │
   148→│  传统方法的问题:                                                             │
   149→│  ────────────────                                                           │
   150→│  • 手工整理知识 → 效率低、不可规模化                                         │
   151→│  • 简单RAG → 只能检索，不能理解和重组                                        │
   152→│  • 规则系统 → 无法处理知识的模糊性和复杂关联                                  │
   153→│                                                                             │
   154→│  Claude Code 解决方案:                                                       │
   155→│  ─────────────────────                                                       │
   156→│                                                                             │
   157→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   158→│  │                                                                     │   │
   159→│  │  1. Agentic 工作流                                                   │   │
   160→│  │     ─────────────────                                                │   │
   161→│  │     Claude Code 可以自主规划、执行、验证                              │   │
   162→│  │     不需要人工定义每个步骤                                            │   │
   163→│  │                                                                     │   │
   164→│  │  2. 代码生成能力                                                     │   │
   165→│  │     ─────────────────                                                │   │
   166→│  │     可以自动生成数据处理脚本、SQL查询、测试用例                        │   │
   167→│  │     知识处理流程可以完全自动化                                        │   │
   168→│  │                                                                     │   │
   169→│  │  3. 深度语义理解                                                     │   │
   170→│  │     ─────────────────                                                │   │
   171→│  │     理解专业领域的术语、概念、关系                                    │   │
   172→│  │     能够识别和提取"隐性知识"                                          │   │
   173→│  │                                                                     │   │
   174→│  │  4. 质量自检能力                                                     │   │
   175→│  │     ─────────────────                                                │   │
   176→│  │     可以审核自己生成的内容                                            │   │
   177→│  │     发现问题后自动修正                                                │   │
   178→│  │                                                                     │   │
   179→│  └─────────────────────────────────────────────────────────────────────┘   │
   180→│                                                                             │
   181→└─────────────────────────────────────────────────────────────────────────────┘
   182→```
   183→
   184→### 3.2 构建流水线详细设计
   185→
   186→```
   187→┌─────────────────────────────────────────────────────────────────────────────┐
   188→│                    Stage 1: 智能格式转换                                     │
   189→├─────────────────────────────────────────────────────────────────────────────┤
   190→│                                                                             │
   191→│  输入: /data/vibelife/{skill}/source/*.pdf                                 │
   192→│  输出: /data/vibelife/{skill}/converted/*.md                               │
   193→│                                                                             │
   194→│  Claude Code Agent 任务:                                                    │
   195→│  ──────────────────────                                                     │
   196→│                                                                             │
   197→│  ```python                                                                  │
   198→│  # 由 Claude Code 自动执行                                                  │
   199→│                                                                             │
   200→│  async def convert_source_to_markdown(source_file: Path) -> Path:          │
   201→│      """                                                                    │
   202→│      1. 识别文件类型 (PDF/EPUB/DOCX/SRT)                                    │
   203→│      2. 提取文本内容                                                        │
   204→│      3. 识别文档结构 (章节/标题/列表)                                       │
   205→│      4. 处理特殊内容 (表格/图片/公式)                                       │
   206→│      5. 生成结构化Markdown                                                  │
   207→│      6. 保留原始引用信息                                                    │
   208→│      """                                                                    │
   209→│      pass                                                                   │
   210→│  ```                                                                        │
   211→│                                                                             │
   212→│  关键能力:                                                                   │
   213→│  • OCR + 结构识别 (处理扫描版古籍)                                          │
   214→│  • 专业术语识别 (如八字中的"食神"、"七杀")                                  │
   215→│  • 跨页内容连接                                                             │
   216→│  • 脚注/引用处理                                                            │
   217→│                                                                             │
   218→└─────────────────────────────────────────────────────────────────────────────┘
   219→
   220→┌─────────────────────────────────────────────────────────────────────────────┐
   221→│                    Stage 2: 语义智能切分                                     │
   222→├─────────────────────────────────────────────────────────────────────────────┤
   223→│                                                                             │
   224→│  目标: 按语义边界切分，而不是固定长度                                         │
   225→│                                                                             │
   226→│  Claude Code Agent 任务:                                                    │
   227→│  ──────────────────────                                                     │
   228→│                                                                             │
   229→│  ```python                                                                  │
   230→│  async def semantic_chunking(markdown_file: Path) -> List[Chunk]:          │
   231→│      """                                                                    │
   232→│      切分策略 (由Claude动态决定):                                            │
   233→│                                                                             │
   234→│      1. 理论知识块 (theory)                                                 │
   235→│         - 完整概念定义                                                      │
   236→│         - 原理解释                                                          │
   237→│         - 如: "食神是日主所生之物，代表才华、口福、子女..."                 │
   238→│                                                                             │
   239→│      2. 规则知识块 (rule)                                                   │
   240→│         - 判断规则                                                          │
   241→│         - 组合条件                                                          │
   242→│         - 如: "食神见枭，谓之枭神夺食，主..."                               │
   243→│                                                                             │
   244→│      3. 案例知识块 (case)                                                   │
   245→│         - 真实案例                                                          │
   246→│         - 分析过程                                                          │
   247→│         - 如: "乾造: 甲寅 丙寅 甲子 甲戌，此造..."                          │
   248→│                                                                             │
   249→│      4. 方法知识块 (method)                                                 │
   250→│         - 分析步骤                                                          │
   251→│         - 操作指南                                                          │
   252→│         - 如: "论命先看月令，次看日主强弱..."                               │
   253→│      """                                                                    │
   254→│      pass                                                                   │
   255→│  ```                                                                        │
   256→│                                                                             │
   257→│  输出结构:                                                                   │
   258→│  ```json                                                                    │
   259→│  {                                                                          │
   260→│    "chunk_id": "CHK_bazi_ditianshui_001",                                  │
   261→│    "chunk_type": "theory",                                                  │
   262→│    "chunk_text": "食神者，日主所生之物也...",                               │
   263→│    "source": {"book": "滴天髓", "chapter": "论食神"},                       │
   264→│    "keywords": ["食神", "日主", "生"],                                      │
   265→│    "related_concepts": ["伤官", "才华", "子女"]                             │
   266→│  }                                                                          │
   267→│  ```                                                                        │
   268→│                                                                             │
   269→└─────────────────────────────────────────────────────────────────────────────┘
   270→
   271→┌─────────────────────────────────────────────────────────────────────────────┐
   272→│              Stage 3: 三要素抽取 (核心创新)                                   │
   273→├─────────────────────────────────────────────────────────────────────────────┤
   274→│                                                                             │
   275→│  这是整个系统的核心 — 从原始知识中抽取专家的"认知结构"                        │
   276→│                                                                             │
   277→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   278→│  │                                                                     │   │
   279→│  │  要素1: 思维架构 (Thinking Framework)                                │   │
   280→│  │  ══════════════════════════════════════                              │   │
   281→│  │                                                                     │   │
   282→│  │  定义: 专家分析问题时使用的"视角"和"维度"                            │   │
   283→│  │                                                                     │   │
   284→│  │  抽取 Prompt:                                                        │   │
   285→│  │  ```                                                                 │   │
   286→│  │  分析这段文本，识别作者使用的分析框架:                                │   │
   287→│  │                                                                     │   │
   288→│  │  1. 他从哪些维度/角度来分析问题？                                     │   │
   289→│  │  2. 这些维度之间的关系是什么？                                        │   │
   290→│  │  3. 在什么场景下使用这个分析框架？                                    │   │
   291→│  │                                                                     │   │
   292→│  │  输出格式:                                                            │   │
   293→│  │  {                                                                   │   │
   294→│  │    "framework_name": "主体思维架构",                                  │   │
   295→│  │    "dimensions": ["日主强弱", "格局定位", "用神喜忌"],                │   │
   296→│  │    "dimension_relations": "先定强弱→再定格局→最后取用神",            │   │
   297→│  │    "applicable_scenarios": ["基础命盘分析", "年度运势"]               │   │
   298→│  │  }                                                                   │   │
   299→│  │  ```                                                                 │   │
   300→│  │                                                                     │   │
   301→│  │  八字领域示例:                                                        │   │
   302→│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
   303→│  │  │ 架构名称         分析维度                 适用场景           │    │   │
   304→│  │  │ ────────        ────────                ────────           │    │   │
   305→│  │  │ 主体思维架构    日主强弱→格局→用神      基础分析、流年     │    │   │
   306→│  │  │ 客体思维架构    六亲→十神→宫位          关系、事业         │    │   │
   307→│  │  │ 时运思维架构    大运→流年→流月          时机选择           │    │   │
   308→│  │  │ 象法思维架构    取象→类象→应象          具体事件预测       │    │   │
   309→│  │  └─────────────────────────────────────────────────────────────┘    │   │
   310→│  │                                                                     │   │
   311→│  └─────────────────────────────────────────────────────────────────────┘   │
   312→│                                                                             │
   313→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   314→│  │                                                                     │   │
   315→│  │  要素2: 推理链条 (Reasoning Chain)                                   │   │
   316→│  │  ══════════════════════════════════                                  │   │
   317→│  │                                                                     │   │
   318→│  │  定义: 专家从"观察"到"结论"的完整思维过程                            │   │
   319→│  │                                                                     │   │
   320→│  │  抽取 Prompt:                                                        │   │
   321→│  │  ```                                                                 │   │
   322→│  │  分析这个案例，还原专家的完整推理过程:                                │   │
   323→│  │                                                                     │   │
   324→│  │  1. 他首先观察到了什么？(Observation)                                │   │
   325→│  │  2. 使用了什么分析框架？(Framework)                                  │   │
   326→│  │  3. 中间推理步骤是什么？(Analysis)                                   │   │
   327→│  │  4. 最终得出什么结论？(Conclusion)                                   │   │
   328→│  │  5. 每一步的依据是什么？(Evidence)                                   │   │
   329→│  │                                                                     │   │
   330→│  │  输出格式:                                                            │   │
   331→│  │  [                                                                   │   │
   332→│  │    {                                                                 │   │
   333→│  │      "step": 1,                                                      │   │
   334→│  │      "type": "observation",                                          │   │
   335→│  │      "content": "日主甲木，生于酉月",                                 │   │
   336→│  │      "evidence": "命盘四柱"                                           │   │
   337→│  │    },                                                                │   │
   338→│  │    {                                                                 │   │
   339→│  │      "step": 2,                                                      │   │
   340→│  │      "type": "framework",                                            │   │
   341→│  │      "framework": "主体思维架构",                                     │   │
   342→│  │      "content": "酉月金旺，秋木凋零"                                   │   │
   343→│  │    },                                                                │   │
   344→│  │    {                                                                 │   │
   345→│  │      "step": 3,                                                      │   │
   346→│  │      "type": "analysis",                                             │   │
   347→│  │      "content": "甲木无根，身弱无疑",                                 │   │
   348→│  │      "evidence": "地支无寅卯木"                                       │   │
   349→│  │    },                                                                │   │
   350→│  │    {                                                                 │   │
   351→│  │      "step": 4,                                                      │   │
   352→│  │      "type": "conclusion",                                           │   │
   353→│  │      "content": "身弱宜水木相助，忌金土克泄"                          │   │
   354→│  │    }                                                                 │   │
   355→│  │  ]                                                                   │   │
   356→│  │  ```                                                                 │   │
   357→│  │                                                                     │   │
   358→│  └─────────────────────────────────────────────────────────────────────┘   │
   359→│                                                                             │
   360→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   361→│  │                                                                     │   │
   362→│  │  要素3: 指导模式 (Guidance Pattern)                                  │   │
   363→│  │  ══════════════════════════════════                                  │   │
   364→│  │                                                                     │   │
   365→│  │  定义: 可复用的建议模板，这是专家系统最有价值的输出                    │   │
   366→│  │                                                                     │   │
   367→│  │  抽取 Prompt:                                                        │   │
   368→│  │  ```                                                                 │   │
   369→│  │  从这段分析中提取可复用的指导建议:                                    │   │
   370→│  │                                                                     │   │
   371→│  │  1. 适用条件是什么？(在什么情况下给这个建议)                          │   │
   372→│  │  2. 核心建议是什么？(具体建议内容)                                    │   │
   373→│  │  3. 建议的依据是什么？(为什么这样建议)                                │   │
   374→│  │  4. 建议的类型是什么？(时机/方向/策略/心态)                           │   │
   375→│  │                                                                     │   │
   376→│  │  输出格式:                                                            │   │
   377→│  │  {                                                                   │   │
   378→│  │    "pattern_name": "身弱逢水运事业建议",                              │   │
   379→│  │    "condition": {                                                    │   │
   380→│  │      "daymaster": "甲木",                                            │   │
   381→│  │      "strength": "身弱",                                             │   │
   382→│  │      "current_luck": "水运"                                          │   │
   383→│  │    },                                                                │   │
   384→│  │    "advice": "水为印星生身，此运贵人运，宜主动结交贵人，借力发展",    │   │
   385→│  │    "advice_type": "策略",                                            │   │
   386→│  │    "reason": "水生木，印星主贵人、学历、靠山",                        │   │
   387→│  │    "source": "滴天髓·论印"                                           │   │
   388→│  │  }                                                                   │   │
   389→│  │  ```                                                                 │   │
   390→│  │                                                                     │   │
   391→│  │  指导模式类型:                                                        │   │
   392→│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
   393→│  │  │ 类型         说明                     示例                   │    │   │
   394→│  │  │ ────        ────                     ────                   │    │   │
   395→│  │  │ 时机建议    何时行动                 "今年下半年是换工作的   │    │   │
   396→│  │  │                                      好时机"                 │    │   │
   397→│  │  │ 方向建议    往哪里发展               "适合往北方发展"        │    │   │
   398→│  │  │ 策略建议    怎么做                   "多借助团队力量"        │    │   │
   399→│  │  │ 心态建议    如何调整心态             "保持耐心，厚积薄发"    │    │   │
   400→│  │  │ 关系建议    如何处理关系             "与领导保持距离"        │    │   │
   401→│  │  └─────────────────────────────────────────────────────────────┘    │   │
   402→│  │                                                                     │   │
   403→│  └─────────────────────────────────────────────────────────────────────┘   │
   404→│                                                                             │
   405→└─────────────────────────────────────────────────────────────────────────────┘
   406→
   407→┌─────────────────────────────────────────────────────────────────────────────┐
   408→│                    Stage 4: LLM自动审核                                      │
   409→├─────────────────────────────────────────────────────────────────────────────┤
   410→│                                                                             │
   411→│  Claude Code Agent 自动审核每个抽取结果:                                     │
   412→│                                                                             │
   413→│  ```python                                                                  │
   414→│  async def auto_review(extracted_item: dict) -> ReviewResult:              │
   415→│      """                                                                    │
   416→│      审核维度:                                                               │
   417→│      1. 完整性: 推理链条是否完整？指导模式是否有具体建议？                   │
   418→│      2. 准确性: 是否符合领域知识？有无明显错误？                             │
   419→│      3. 可用性: 在实际场景中是否可以直接使用？                               │
   420→│      4. 独特性: 与现有内容是否重复？(相似度检查)                             │
   421→│                                                                             │
   422→│      评分规则:                                                               │
   423→│      - score >= 0.8: 直接发布                                               │
   424→│      - 0.6 <= score < 0.8: 需要人工review                                   │
   425→│      - score < 0.6: 丢弃或重新抽取                                          │
   426→│      """                                                                    │
   427→│      pass                                                                   │
   428→│  ```                                                                        │
   429→│                                                                             │
   430→│  审核 Prompt:                                                                │
   431→│  ```                                                                        │
   432→│  作为八字命理专家，审核以下抽取结果:                                         │
   433→│                                                                             │
   434→│  [推理链条]                                                                  │
   435→│  {reasoning_chain}                                                          │
   436→│                                                                             │
   437→│  请评估:                                                                     │
   438→│  1. 推理逻辑是否完整？(1-10分)                                              │
   439→│  2. 专业术语使用是否准确？(1-10分)                                          │
   440→│  3. 结论是否有足够依据？(1-10分)                                            │
   441→│  4. 是否可以直接用于用户咨询？(1-10分)                                      │
   442→│                                                                             │
   443→│  如有问题请指出，并给出修改建议。                                            │
   444→│  ```                                                                        │
   445→│                                                                             │
   446→└─────────────────────────────────────────────────────────────────────────────┘
   447→
   448→┌─────────────────────────────────────────────────────────────────────────────┐
   449→│                    Stage 5: 场景与SOP自动生成                                │
   450→├─────────────────────────────────────────────────────────────────────────────┤
   451→│                                                                             │
   452→│  基于抽取的三要素，自动生成服务场景:                                         │
   453→│                                                                             │
   454→│  ```python                                                                  │
   455→│  async def generate_scenario(                                              │
   456→│      frameworks: List[ThinkingFramework],                                  │
   457→│      reasoning_chains: List[ReasoningChain],                               │
   458→│      guidance_patterns: List[GuidancePattern]                              │
   459→│  ) -> Scenario:                                                            │
   460→│      """                                                                    │
   461→│      1. 分析哪些框架+推理+指导可以组合成一个完整服务                        │
   462→│      2. 生成服务流程 (SOP)                                                  │
   463→│      3. 定义触发条件                                                        │
   464→│      4. 设计工具调用序列                                                    │
   465→│      """                                                                    │
   466→│      pass                                                                   │
   467→│  ```                                                                        │
   468→│                                                                             │
   469→│  生成 Prompt:                                                                │
   470→│  ```                                                                        │
   471→│  基于以下知识资产，设计一个"事业运势咨询"服务场景:                           │
   472→│                                                                             │
   473→│  可用的思维架构:                                                             │
   474→│  - 主体思维架构: 分析日主强弱、格局                                          │
   475→│  - 客体思维架构: 分析官星、财星                                              │
   476→│  - 时运思维架构: 分析大运流年                                                │
   477→│                                                                             │
   478→│  可用的推理链条: [列出相关案例]                                              │
   479→│  可用的指导模式: [列出相关建议模板]                                          │
   480→│                                                                             │
   481→│  请设计:                                                                     │
   482→│  1. 服务流程 (SOP) - 从用户提问到给出建议的完整步骤                          │
   483→│  2. 每个步骤使用什么框架/工具/知识                                           │
   484→│  3. 如何组织输出让用户满意                                                   │
   485→│  ```                                                                        │
   486→│                                                                             │
   487→│  输出示例 (scenarios/career.md):                                            │
   488→│  ```markdown                                                                │
   489→│  # 事业运势分析                                                              │
   490→│                                                                             │
   491→│  ## 触发条件                                                                 │
   492→│  关键词: 事业, 工作, 升职, 跳槽, 创业, 职业发展                              │
   493→│                                                                             │
   494→│  ## 服务流程 (SOP)                                                           │
   495→│                                                                             │
   496→│  ### Phase 1: 信息确认                                                       │
   497→│  - 确认用户出生信息                                                          │
   498→│  - 询问当前职业状况                                                          │
   499→│  - 了解具体关注点 (升职/跳槽/转行)                                           │
   500→│                                                                             │
   501→│  ### Phase 2: 基础分析 (使用:主体思维架构)                                   │
   502→│  - 计算命盘，展示八字                                                        │
   503→│  - 分析日主强弱                                                              │
   504→│  - 定位格局                                                                  │
   505→│                                                                             │
   506→│  ### Phase 3: 事业分析 (使用:客体思维架构)                                   │
   507→│  - 分析官星状态 (代表事业、地位)                                             │
   508→│  - 分析财星状态 (代表收入、资源)                                             │
   509→│  - 分析印星状态 (代表贵人、平台)                                             │
   510→│                                                                             │
   511→│  ### Phase 4: 时机分析 (使用:时运思维架构)                                   │
   512→│  - 分析当前大运对事业的影响                                                  │
   513→│  - 分析今年流年的事业机会                                                    │
   514→│  - 找出最佳行动时间窗口                                                      │
   515→│                                                                             │
   516→│  ### Phase 5: 建议输出 (使用:指导模式)                                       │
   517→│  - 匹配适用的指导模式                                                        │
   518→│  - 给出时机建议                                                              │
   519→│  - 给出策略建议                                                              │
   520→│  - 给出心态建议                                                              │
   521→│  ```                                                                        │
   522→│                                                                             │
   523→└─────────────────────────────────────────────────────────────────────────────┘
   524→```
   525→
   526→---
   527→
   528→## 四、Agentic 构建工作流
   529→
   530→### 4.1 Claude Code Agent 配置
   531→
   532→```yaml
   533→# expert_builder_agent.yaml
   534→# Claude Code 专家系统构建Agent配置
   535→
   536→name: "Expert System Builder"
   537→description: "自动构建知识服务专家系统"
   538→
   539→# Agent 能力
   540→capabilities:
   541→  - file_operations      # 文件读写
   542→  - code_execution       # 运行Python脚本
   543→  - database_operations  # 数据库操作
   544→  - web_search          # 搜索补充知识
   545→  - self_reflection     # 自我审核
   546→
   547→# 工作流定义
   548→workflow:
   549→  # 阶段1: 知识源处理
   550→  stage_1_convert:
   551→    trigger: "new files in /data/vibelife/{skill}/source/"
   552→    actions:
   553→      - detect_file_type
   554→      - convert_to_markdown
   555→      - validate_conversion
   556→    output: "/data/vibelife/{skill}/converted/"
   557→  
   558→  # 阶段2: 智能切分
   559→  stage_2_chunk:
   560→    trigger: "stage_1 complete"
   561→    actions:
   562→      - analyze_document_structure
   563→      - semantic_chunking
   564→      - classify_chunk_types
   565→      - extract_keywords
   566→    output: "knowledge_chunks table"
   567→  
   568→  # 阶段3: 三要素抽取
   569→  stage_3_extract:
   570→    trigger: "stage_2 complete"
   571→    actions:
   572→      - extract_thinking_frameworks
   573→      - extract_reasoning_chains  
   574→      - extract_guidance_patterns
   575→      - link_elements
   576→    output: "cases table + frameworks metadata"
   577→  
   578→  # 阶段4: 质量审核
   579→  stage_4_review:
   580→    trigger: "stage_3 complete"
   581→    actions:
   582→      - self_review_quality
   583→      - check_duplicates
   584→      - validate_domain_accuracy
   585→      - score_and_filter
   586→    output: "approved items"
   587→  
   588→  # 阶段5: 场景生成
   589→  stage_5_generate:
   590→    trigger: "stage_4 complete"
   591→    actions:
   592→      - cluster_related_knowledge
   593→      - generate_scenarios
   594→      - create_sop_flows
   595→      - generate_skill_md
   596→    output: "/skills/{skill}/"
   597→
   598→# 自主决策规则
   599→decision_rules:
   600→  # 切分粒度
   601→  chunking:
   602→    min_tokens: 100
   603→    max_tokens: 2000
   604→    prefer_semantic_boundary: true
   605→  
   606→  # 质量阈值
   607→  quality:
   608→    auto_approve_threshold: 0.8
   609→    manual_review_threshold: 0.6
   610→    reject_threshold: 0.4
   611→  
   612→  # 相似度检查
   613→  similarity:
   614→    duplicate_threshold: 0.9
   615→    merge_threshold: 0.7
   616→```
   617→
   618→### 4.2 自动执行脚本
   619→
   620→```python
   621→# build_expert_system.py
   622→# Claude Code 执行的主脚本
   623→
   624→"""
   625→专家系统自动构建脚本
   626→
   627→使用方法:
   628→    claude code run build_expert_system.py --skill bazi --source /data/vibelife/bazi/source/
   629→
   630→功能:
   631→    1. 自动处理所有源文件
   632→    2. 智能抽取三要素
   633→    3. 质量审核和过滤
   634→    4. 生成完整的Skill定义
   635→"""
   636→
   637→import asyncio
   638→from pathlib import Path
   639→from typing import List, Dict, Any
   640→
   641→# ============================================
   642→# Stage 1: 格式转换
   643→# ============================================
   644→
   645→async def convert_all_sources(skill_id: str, source_dir: Path) -> List[Path]:
   646→    """
   647→    Claude Code 会自动:
   648→    1. 扫描source_dir下的所有文件
   649→    2. 根据文件类型选择合适的转换方法
   650→    3. 生成结构化的Markdown
   651→    """
   652→    converted_files = []
   653→    
   654→    for source_file in source_dir.glob("*"):
   655→        if source_file.suffix in ['.pdf', '.epub', '.docx', '.srt']:
   656→            # Claude Code 自动处理转换
   657→            output_path = await convert_file(source_file, skill_id)
   658→            converted_files.append(output_path)
   659→    
   660→    return converted_files
   661→
   662→
   663→# ============================================
   664→# Stage 2: 语义切分
   665→# ============================================
   666→
   667→async def semantic_chunk(markdown_file: Path, skill_id: str) -> List[Dict]:
   668→    """
   669→    Claude Code 会自动:
   670→    1. 分析文档结构
   671→    2. 识别语义边界
   672→    3. 分类chunk类型
   673→    4. 提取关键词
   674→    """
   675→    chunks = []
   676→    
   677→    content = markdown_file.read_text()
   678→    
   679→    # Claude Code 动态决定如何切分
   680→    # 不是固定规则，而是理解内容后智能切分
   681→    
   682→    return chunks
   683→
   684→
   685→# ============================================
   686→# Stage 3: 三要素抽取 (核心)
   687→# ============================================
   688→
   689→async def extract_thinking_framework(chunk: Dict) -> Dict:
   690→    """
   691→    从知识块中抽取思维架构
   692→    
   693→    Claude Code 会分析:
   694→    - 作者使用了什么分析视角？
   695→    - 分析维度之间的关系是什么？
   696→    - 这个框架适用于什么场景？
   697→    """
   698→    # 抽取逻辑由Claude Code自主完成
   699→    pass
   700→
   701→
   702→async def extract_reasoning_chain(case_chunk: Dict) -> Dict:
   703→    """
   704→    从案例中抽取推理链条
   705→    
   706→    Claude Code 会还原:
   707→    - 专家观察到了什么？
   708→    - 使用了什么分析框架？
   709→    - 推理步骤是什么？
   710→    - 结论和依据是什么？
   711→    """
   712→    # 抽取逻辑由Claude Code自主完成
   713→    pass
   714→
   715→
   716→async def extract_guidance_pattern(analysis_chunk: Dict) -> Dict:
   717→    """
   718→    从分析中抽取指导模式
   719→    
   720→    Claude Code 会提取:
   721→    - 适用条件
   722→    - 具体建议
   723→    - 建议依据
   724→    - 建议类型
   725→    """
   726→    # 抽取逻辑由Claude Code自主完成
   727→    pass
   728→
   729→
   730→# ============================================
   731→# Stage 4: 质量审核
   732→# ============================================
   733→
   734→async def auto_review(item: Dict, item_type: str) -> float:
   735→    """
   736→    Claude Code 自动审核抽取质量
   737→    
   738→    审核维度:
   739→    - 完整性
   740→    - 准确性
   741→    - 可用性
   742→    - 独特性
   743→    """
   744→    # 审核逻辑由Claude Code自主完成
   745→    pass
   746→
   747→
   748→# ============================================
   749→# Stage 5: 场景生成
   750→# ============================================
   751→
   752→async def generate_scenario(
   753→    skill_id: str,
   754→    scenario_type: str,
   755→    frameworks: List[Dict],
   756→    reasoning_chains: List[Dict],
   757→    guidance_patterns: List[Dict]
   758→) -> str:
   759→    """
   760→    基于抽取的三要素，生成服务场景
   761→    
   762→    Claude Code 会:
   763→    1. 分析哪些元素可以组合
   764→    2. 设计服务流程 (SOP)
   765→    3. 生成Markdown场景文件
   766→    """
   767→    # 生成逻辑由Claude Code自主完成
   768→    pass
   769→
   770→
   771→async def generate_skill_md(
   772→    skill_id: str,
   773→    frameworks: List[Dict],
   774→    scenarios: List[str]
   775→) -> str:
   776→    """
   777→    生成完整的SKILL.md文件
   778→    
   779→    包含:
   780→    - 专家身份定义
   781→    - 思维架构体系
   782→    - 场景目录
   783→    - 工具列表
   784→    - 伦理边界
   785→    """
   786→    # 生成逻辑由Claude Code自主完成
   787→    pass
   788→
   789→
   790→# ============================================
   791→# 主流程
   792→# ============================================
   793→
   794→async def build_expert_system(skill_id: str, source_dir: str):
   795→    """
   796→    完整构建流程
   797→    """
   798→    source_path = Path(source_dir)
   799→    
   800→    print(f"🚀 开始构建 {skill_id} 专家系统...")
   801→    
   802→    # Stage 1: 格式转换
   803→    print("📄 Stage 1: 转换源文件...")
   804→    converted_files = await convert_all_sources(skill_id, source_path)
   805→    print(f"   完成: {len(converted_files)} 个文件")
   806→    
   807→    # Stage 2: 智能切分
   808→    print("✂️ Stage 2: 语义切分...")
   809→    all_chunks = []
   810→    for md_file in converted_files:
   811→        chunks = await semantic_chunk(md_file, skill_id)
   812→        all_chunks.extend(chunks)
   813→    print(f"   完成: {len(all_chunks)} 个知识块")
   814→    
   815→    # Stage 3: 三要素抽取
   816→    print("🧠 Stage 3: 抽取三要素...")
   817→    frameworks = []
   818→    reasoning_chains = []
   819→    guidance_patterns = []
   820→    
   821→    for chunk in all_chunks:
   822→        if chunk['type'] == 'theory':
   823→            fw = await extract_thinking_framework(chunk)
   824→            if fw:
   825→                frameworks.append(fw)
   826→        elif chunk['type'] == 'case':
   827→            rc = await extract_reasoning_chain(chunk)
   828→            if rc:
   829→                reasoning_chains.append(rc)
   830→            gp = await extract_guidance_pattern(chunk)
   831→            if gp:
   832→                guidance_patterns.append(gp)
   833→    
   834→    print(f"   思维架构: {len(frameworks)} 个")
   835→    print(f"   推理链条: {len(reasoning_chains)} 个")
   836→    print(f"   指导模式: {len(guidance_patterns)} 个")
   837→    
   838→    # Stage 4: 质量审核
   839→    print("✅ Stage 4: 质量审核...")
   840→    approved_frameworks = [f for f in frameworks if await auto_review(f, 'framework') >= 0.8]
   841→    approved_chains = [c for c in reasoning_chains if await auto_review(c, 'chain') >= 0.8]
   842→    approved_patterns = [p for p in guidance_patterns if await auto_review(p, 'pattern') >= 0.8]
   843→    
   844→    print(f"   通过审核: {len(approved_frameworks)} 架构, {len(approved_chains)} 链条, {len(approved_patterns)} 模式")
   845→    
   846→    # Stage 5: 生成Skill
   847→    print("📦 Stage 5: 生成Skill定义...")
   848→    
   849→    # 生成场景
   850→    scenarios = []
   851→    for scenario_type in ['basic_reading', 'career', 'relationship', 'yearly_report']:
   852→        scenario = await generate_scenario(
   853→            skill_id, scenario_type,
   854→            approved_frameworks, approved_chains, approved_patterns
   855→        )
   856→        scenarios.append(scenario)
   857→    
   858→    # 生成SKILL.md
   859→    skill_md = await generate_skill_md(skill_id, approved_frameworks, scenarios)
   860→    
   861→    print(f"✨ 完成! 输出到 /skills/{skill_id}/")
   862→
   863→
   864→# 运行
   865→if __name__ == "__main__":
   866→    import sys
   867→    skill_id = sys.argv[1] if len(sys.argv) > 1 else "bazi"
   868→    source_dir = sys.argv[2] if len(sys.argv) > 2 else f"/data/vibelife/{skill_id}/source/"
   869→    
   870→    asyncio.run(build_expert_system(skill_id, source_dir))
   871→```
   872→
   873→---
   874→
   875→## 五、运行时推理引擎
   876→
   877→### 5.1 CoreAgent 如何使用三要素
   878→
   879→```
   880→┌─────────────────────────────────────────────────────────────────────────────┐
   881→│                    CoreAgent 运行时推理流程                                  │
   882→├─────────────────────────────────────────────────────────────────────────────┤
   883→│                                                                             │
   884→│  用户输入: "我今年想换工作，帮我看看运势"                                     │
   885→│                                                                             │
   886→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   887→│  │ Step 1: 场景路由                                                     │   │
   888→│  ├─────────────────────────────────────────────────────────────────────┤   │
   889→│  │                                                                     │   │
   890→│  │ 触发词匹配: "换工作" → career 场景                                   │   │
   891→│  │ 加载: scenarios/career.md                                           │   │
   892→│  │                                                                     │   │
   893→│  └─────────────────────────────────────────────────────────────────────┘   │
   894→│                                        │                                    │
   895→│                                        ▼                                    │
   896→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   897→│  │ Step 2: 构建 System Prompt                                           │   │
   898→│  ├─────────────────────────────────────────────────────────────────────┤   │
   899→│  │                                                                     │   │
   900→│  │ System Prompt 结构:                                                  │   │
   901→│  │                                                                     │   │
   902→│  │ ```                                                                  │   │
   903→│  │ # 专家身份                                                           │   │
   904→│  │ 你是一位专业的八字命理师，精通子平真诠、滴天髓等经典...              │   │
   905→│  │                                                                     │   │
   906→│  │ # 本次服务场景                                                       │   │
   907→│  │ 用户想了解事业运势，请按以下流程分析:                                │   │
   908→│  │ [SOP流程]                                                            │   │
   909→│  │                                                                     │   │
   910→│  │ # 可用的思维架构                                                     │   │
   911→│  │ 1. 主体思维架构: 先看日主强弱，再定格局...                           │   │
   912→│  │ 2. 客体思维架构: 官星代表事业，财星代表收入...                       │   │
   913→│  │ 3. 时运思维架构: 大运流年的影响...                                   │   │
   914→│  │                                                                     │   │
   915→│  │ # 用户信息                                                           │   │
   916→│  │ 命盘: [从profile获取]                                                │   │
   917→│  │ 当前大运: [计算得出]                                                 │   │
   918→│  │ 今年流年: 丙午年                                                     │   │
   919→│  │ ```                                                                  │   │
   920→│  │                                                                     │   │
   921→│  └─────────────────────────────────────────────────────────────────────┘   │
   922→│                                        │                                    │
   923→│                                        ▼                                    │
   924→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   925→│  │ Step 3: RAG 检索相关知识                                             │   │
   926→│  ├─────────────────────────────────────────────────────────────────────┤   │
   927→│  │                                                                     │   │
   928→│  │ 查询: "甲木身弱 官星 事业 大运"                                      │   │
   929→│  │                                                                     │   │
   930→│  │ 检索结果:                                                            │   │
   931→│  │ - [knowledge] 甲木见官，需要印星化杀...                              │   │
   932→│  │ - [knowledge] 身弱官旺，宜走印运...                                  │   │
   933→│  │                                                                     │   │
   934→│  │ 注入到 Context                                                       │   │
   935→│  │                                                                     │   │
   936→│  └─────────────────────────────────────────────────────────────────────┘   │
   937→│                                        │                                    │
   938→│                                        ▼                                    │
   939→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   940→│  │ Step 4: 案例匹配 (获取推理链条)                                       │   │
   941→│  ├─────────────────────────────────────────────────────────────────────┤   │
   942→│  │                                                                     │   │
   943→│  │ 匹配条件:                                                            │   │
   944→│  │ - daymaster: 甲木                                                   │   │
   945→│  │ - strength: 身弱                                                    │   │
   946→│  │ - scenario: career                                                  │   │
   947→│  │                                                                     │   │
   948→│  │ 匹配到案例: CASE_BAZI_042                                            │   │
   949→│  │                                                                     │   │
   950→│  │ 推理链条:                                                            │   │
   951→│  │ [1] 观察: 日主甲木，生于酉月，地支无根                               │   │
   952→│  │ [2] 框架: 使用主体思维架构，判定身弱                                 │   │
   953→│  │ [3] 分析: 官星透出，身弱难担官                                       │   │
   954→│  │ [4] 结论: 需要印星来化官生身                                         │   │
   955→│  │                                                                     │   │
   956→│  │ 注入到 Context: "参考以下推理过程..."                                │   │
   957→│  │                                                                     │   │
   958→│  └─────────────────────────────────────────────────────────────────────┘   │
   959→│                                        │                                    │
   960→│                                        ▼                                    │
   961→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   962→│  │ Step 5: 匹配指导模式                                                  │   │
   963→│  ├─────────────────────────────────────────────────────────────────────┤   │
   964→│  │                                                                     │   │
   965→│  │ 匹配条件:                                                            │   │
   966→│  │ - daymaster: 甲木                                                   │   │
   967→│  │ - strength: 身弱                                                    │   │
   968→│  │ - topic: career                                                     │   │
   969→│  │ - current_luck: 水运 (印运)                                         │   │
   970→│  │                                                                     │   │
   971→│  │ 匹配到的指导模式:                                                    │   │
   972→│  │                                                                     │   │
   973→│  │ [时机建议] 今年下半年是换工作的好时机                                │   │
   974→│  │   条件: 身弱逢印运 + 流年生大运                                      │   │
   975→│  │   原因: 印星主贵人、平台，此时跳槽容易遇贵人                         │   │
   976→│  │                                                                     │   │
   977→│  │ [策略建议] 借助平台和团队力量，不要单打独斗                          │   │
   978→│  │   条件: 身弱无根                                                     │   │
   979→│  │   原因: 甲木无根难以独立支撑大事业                                   │   │
   980→│  │                                                                     │   │
   981→│  │ [方向建议] 适合往北方或水旺的行业发展                                │   │
   982→│  │   条件: 喜水木                                                       │   │
   983→│  │   原因: 水生木，北方属水                                             │   │
   984→│  │                                                                     │   │
   985→│  │ 注入到 Context: "根据你的情况，可以参考以下建议..."                  │   │
   986→│  │                                                                     │   │
   987→│  └─────────────────────────────────────────────────────────────────────┘   │
   988→│                                        │                                    │
   989→│                                        ▼                                    │
   990→│  ┌─────────────────────────────────────────────────────────────────────┐   │
   991→│  │ Step 6: LLM 生成回复                                                  │   │
   992→│  ├─────────────────────────────────────────────────────────────────────┤   │
   993→│  │                                                                     │   │
   994→│  │ LLM 收到的完整 Context:                                              │   │
   995→│  │ - System: 专家身份 + SOP + 思维架构                                  │   │
   996→│  │ - Context: RAG知识 + 推理链条示例 + 指导模式                         │   │
   997→│  │ - User: 用户问题                                                     │   │
   998→│  │                                                                     │   │
   999→│  │ LLM 生成:                                                            │   │
  1000→│  │ 1. 按SOP流程逐步分析                                                 │   │
  1001→│  │ 2. 使用思维架构组织分析                                              │   │
  1002→│  │ 3. 参考推理链条的方式展示过程                                        │   │
  1003→│  │ 4. 输出匹配的指导建议                                                │   │
  1004→│  │                                                                     │   │
  1005→│  │ 调用工具:                                                            │   │
  1006→│  │ - show_bazi_chart: 展示命盘                                          │   │
  1007→│  │ - show_bazi_fortune: 展示运势分析                                    │   │
  1008→│  │                                                                     │   │
  1009→│  └─────────────────────────────────────────────────────────────────────┘   │
  1010→│                                        │                                    │
  1011→│                                        ▼                                    │
  1012→│  ┌─────────────────────────────────────────────────────────────────────┐   │
  1013→│  │ 最终输出                                                              │   │
  1014→│  ├─────────────────────────────────────────────────────────────────────┤   │
  1015→│  │                                                                     │   │
  1016→│  │ "根据你的八字分析...                                                 │   │
  1017→│  │                                                                     │   │
  1018→│  │  [展示命盘卡片]                                                      │   │
  1019→│  │                                                                     │   │
  1020→│  │  从你的命盘来看，你是甲木日主，生于酉月金旺之时，                     │   │
  1021→│  │  日主偏弱。官星代表事业，你的官星透出但身弱难担，                     │   │
  1022→│  │  这意味着...                                                         │   │
  1023→│  │                                                                     │   │
  1024→│  │  好消息是，你目前正在走水运(印运)，水能生木，                         │   │
  1025→│  │  这步大运对你的事业发展是有利的...                                   │   │
  1026→│  │                                                                     │   │
  1027→│  │  [展示运势卡片]                                                      │   │
  1028→│  │                                                                     │   │
  1029→│  │  给你几个建议:                                                       │   │
  1030→│  │  1. 时机: 今年下半年是换工作的好时机...                              │   │
  1031→│  │  2. 策略: 建议借助平台和团队...                                      │   │
  1032→│  │  3. 方向: 北方或水旺的行业..."                                       │   │
  1033→│  │                                                                     │   │
  1034→│  └─────────────────────────────────────────────────────────────────────┘   │
  1035→│                                                                             │
  1036→└─────────────────────────────────────────────────────────────────────────────┘
  1037→```
  1038→
  1039→### 5.2 核心代码实现
  1040→
  1041→```python
  1042→# services/agent/core.py
  1043→# CoreAgent 核心实现
  1044→
  1045→class CoreAgent:
  1046→    """
  1047→    CoreAgent - 专家系统推理引擎
  1048→    
  1049→    核心职责:
  1050→    1. 加载SKILL.md和Scenario定义
  1051→    2. 注入思维架构到System Prompt
  1052→    3. RAG检索相关知识
  1053→    4. 匹配案例获取推理链条
  1054→    5. 匹配指导模式
  1055→    6. 编排工具调用
  1056→    """
  1057→    
  1058→    async def run(
  1059→        self, 
  1060→        message: str, 
  1061→        context: AgentContext
  1062→    ) -> AsyncGenerator[AgentEvent, None]:
  1063→        
  1064→        # 1. 场景路由
  1065→        scenario = await self._route_scenario(message, context.skill)
  1066→        
  1067→        # 2. 构建System Prompt (注入思维架构)
  1068→        system_prompt = await self._build_system_prompt(
  1069→            skill_id=context.skill,
  1070→            scenario=scenario,
  1071→            user_profile=context.profile
  1072→        )
  1073→        
  1074→        # 3. RAG检索相关知识
  1075→        knowledge_context = await self._retrieve_knowledge(
  1076→            query=message,
  1077→            skill_id=context.skill,
  1078→            scenario=scenario
  1079→        )
  1080→        
  1081→        # 4. 匹配案例 (获取推理链条)
  1082→        matched_cases = await self._match_cases(
  1083→            features=context.profile.get('skill_data', {}).get('features', {}),
  1084→            scenario=scenario
  1085→        )
  1086→        
  1087→        reasoning_examples = self._extract_reasoning_chains(matched_cases)
  1088→        
  1089→        # 5. 匹配指导模式
  1090→        guidance_patterns = await self._match_guidance_patterns(
  1091→            features=context.profile.get('skill_data', {}).get('features', {}),
  1092→            scenario=scenario,
  1093→            current_luck=context.profile.get('skill_data', {}).get('current_luck', {})
  1094→        )
  1095→        
  1096→        # 6. 构建完整Context
  1097→        full_context = self._build_context(
  1098→            knowledge=knowledge_context,
  1099→            reasoning_examples=reasoning_examples,
  1100→            guidance_patterns=guidance_patterns
  1101→        )
  1102→        
  1103→        # 7. LLM生成 + 工具调用
  1104→        async for event in self._generate_response(
  1105→            system_prompt=system_prompt,
  1106→            context=full_context,
  1107→            user_message=message,
  1108→            tools=await self._get_tools(context.skill)
  1109→        ):
  1110→            yield event
  1111→    
  1112→    
  1113→    async def _build_system_prompt(
  1114→        self,
  1115→        skill_id: str,
  1116→        scenario: str,
  1117→        user_profile: dict
  1118→    ) -> str:
  1119→        """
  1120→        构建System Prompt
  1121→        
  1122→        结构:
  1123→        1. 专家身份 (from SKILL.md)
  1124→        2. 思维架构 (from SKILL.md)
  1125→        3. 当前场景SOP (from scenario.md)
  1126→        4. 用户信息 (from profile)
  1127→        """
  1128→        
  1129→        # 加载SKILL.md
  1130→        skill_def = await SkillLoader.load_skill(skill_id)
  1131→        
  1132→        # 加载Scenario
  1133→        scenario_def = await SkillLoader.load_scenario(skill_id, scenario)
  1134→        
  1135→        # 构建Prompt
  1136→        prompt = f"""
  1137→# 专家身份
  1138→{skill_def.expert_persona}
  1139→
  1140→# 知识来源优先级
  1141→{skill_def.knowledge_priority}
  1142→
  1143→# 思维架构体系
  1144→你在分析问题时，请使用以下思维架构:
  1145→
  1146→{self._format_thinking_frameworks(skill_def.thinking_frameworks)}
  1147→
  1148→# 当前服务场景: {scenario_def.name}
  1149→
  1150→## 服务流程 (请严格按此流程)
  1151→{scenario_def.sop}
  1152→
  1153→# 用户信息
  1154→{self._format_user_info(user_profile)}
  1155→
  1156→# 输出要求
  1157→1. 分析过程要展示你的思维路径，让用户理解你是怎么得出结论的
  1158→2. 建议要具体可行，不要泛泛而谈
  1159→3. 语气温和专业，不要故弄玄虚
  1160→"""
  1161→        return prompt
  1162→    
  1163→    
  1164→    async def _match_cases(
  1165→        self,
  1166→        features: dict,
  1167→        scenario: str
  1168→    ) -> List[Case]:
  1169→        """
  1170→        匹配相似案例
  1171→        
  1172→        匹配维度:
  1173→        - 日主类型
  1174→        - 强弱状态
  1175→        - 格局类型
  1176→        - 场景类型
  1177→        """
  1178→        
  1179→        query = """
  1180→        SELECT * FROM cases
  1181→        WHERE skill_id = $1
  1182→          AND $2 = ANY(scenario_ids)
  1183→          AND features->>'daymaster' = $3
  1184→          AND features->>'strength' = $4
  1185→        ORDER BY 
  1186→          -- 特征相似度
  1187→          similarity(features::text, $5::text) DESC
  1188→        LIMIT 3
  1189→        """
  1190→        
  1191→        return await self.db.fetch(query, ...)
  1192→    
  1193→    
  1194→    async def _match_guidance_patterns(
  1195→        self,
  1196→        features: dict,
  1197→        scenario: str,
  1198→        current_luck: dict
  1199→    ) -> List[GuidancePattern]:
  1200→        """
  1201→        匹配指导模式
  1202→        
  1203→        匹配条件:
  1204→        - 用户特征匹配
  1205→        - 当前运势匹配
  1206→        - 场景匹配
  1207→        """
  1208→        
  1209→        # 从cases表中提取guidance_patterns
  1210→        cases = await self._match_cases(features, scenario)
  1211→        
  1212→        patterns = []
  1213→        for case in cases:
  1214→            if case.guidance_patterns:
  1215→                for pattern in case.guidance_patterns:
  1216→                    if self._pattern_matches(pattern, features, current_luck):
  1217→                        patterns.append(pattern)
  1218→        
  1219→        # 去重和排序
  1220→        return self._dedupe_and_rank_patterns(patterns)
  1221→```
  1222→
  1223→---
  1224→
  1225→## 六、效果保证机制
  1226→
  1227→### 6.1 质量闭环
  1228→
  1229→```
  1230→┌─────────────────────────────────────────────────────────────────────────────┐
  1231→│                          专家系统质量保证闭环                                │
  1232→├─────────────────────────────────────────────────────────────────────────────┤
  1233→│                                                                             │
  1234→│  ┌─────────────────────────────────────────────────────────────────────┐   │
  1235→│  │                                                                     │   │
  1236→│  │                        构建时质量保证                                │   │
  1237→│  │                                                                     │   │
  1238→│  │  1. 多层审核                                                         │   │
  1239→│  │     ────────────                                                     │   │
  1240→│  │     • Claude Code 自动抽取                                           │   │
  1241→│  │     • Claude Code 自动审核 (第一道)                                  │   │
  1242→│  │     • 不同模型交叉验证 (第二道)                                      │   │
  1243→│  │     • 领域专家抽检 (第三道，高价值内容)                              │   │
  1244→│  │                                                                     │   │
  1245→│  │  2. 相似度检查                                                       │   │
  1246→│  │     ────────────                                                     │   │
  1247→│  │     • 新抽取内容 vs 现有内容                                         │   │
  1248→│  │     • similarity > 0.9: 丢弃 (重复)                                 │   │
  1249→│  │     • 0.7 < similarity < 0.9: 合并 (补充)                           │   │
  1250→│  │     • similarity < 0.7: 新增                                        │   │
  1251→│  │                                                                     │   │
  1252→│  │  3. 领域一致性检查                                                   │   │
  1253→│  │     ────────────────                                                 │   │
  1254→│  │     • 术语使用是否正确                                               │   │
  1255→│  │     • 逻辑是否符合领域规则                                           │   │
  1256→│  │     • 建议是否有依据                                                 │   │
  1257→│  │                                                                     │   │
  1258→│  └─────────────────────────────────────────────────────────────────────┘   │
  1259→│                                        │                                    │
  1260→│                                        ▼                                    │
  1261→│  ┌─────────────────────────────────────────────────────────────────────┐   │
  1262→│  │                                                                     │   │
  1263→│  │                        运行时质量保证                                │   │
  1264→│  │                                                                     │   │
  1265→│  │  1. 推理过程可验证                                                   │   │
  1266→│  │     ────────────────                                                 │   │
  1267→│  │     • 每个分析步骤都有依据                                           │   │
  1268→│  │     • 用户可以追问"为什么"                                           │   │
  1269→│  │     • 系统能展示推理链条                                             │   │
  1270→│  │                                                                     │   │
  1271→│  │  2. 建议有溯源                                                       │   │
  1272→│  │     ────────────                                                     │   │
  1273→│  │     • 每个建议来自哪个指导模式                                       │   │
  1274→│  │     • 指导模式的原始出处 (经典/案例)                                 │   │
  1275→│  │     • 用户可以查看详细解释                                           │   │
  1276→│  │                                                                     │   │
  1277→│  │  3. 用户反馈闭环                                                     │   │
  1278→│  │     ────────────────                                                 │   │
  1279→│  │     • 收集用户满意度                                                 │   │
  1280→│  │     • 分析不满意的案例                                               │   │
  1281→│  │     • 反馈到知识库迭代                                               │   │
  1282→│  │                                                                     │   │
  1283→│  └─────────────────────────────────────────────────────────────────────┘   │
  1284→│                                        │                                    │
  1285→│                                        ▼                                    │
  1286→│  ┌─────────────────────────────────────────────────────────────────────┐   │
  1287→│  │                                                                     │   │
  1288→│  │                        持续迭代机制                                  │   │
  1289→│  │                                                                     │   │
  1290→│  │  1. 知识库持续扩充                                                   │   │
  1291→│  │     ────────────────                                                 │   │
  1292→│  │     • 定期处理新的知识源                                             │   │
  1293→│  │     • 从用户对话中学习                                               │   │
  1294→│  │     • 专家定期补充高价值内容                                         │   │
  1295→│  │                                                                     │   │
  1296→│  │  2. 指导模式进化                                                     │   │
  1297→│  │     ────────────────                                                 │   │
  1298→│  │     • 跟踪哪些建议被用户采纳                                         │   │
  1299→│  │     • 跟踪哪些建议用户反馈好                                         │   │
  1300→│  │     • 提升高效模式的权重                                             │   │
  1301→│  │                                                                     │   │
  1302→│  │  3. 场景优化                                                         │   │
  1303→│  │     ────────────                                                     │   │
  1304→│  │     • 分析用户最常问的问题                                           │   │
  1305→│  │     • 发现缺失的场景                                                 │   │
  1306→│  │     • 自动生成新场景                                                 │   │
  1307→│  │                                                                     │   │
  1308→│  └─────────────────────────────────────────────────────────────────────┘   │
  1309→│                                                                             │
  1310→└─────────────────────────────────────────────────────────────────────────────┘
  1311→```
  1312→
  1313→---
  1314→
  1315→## 七、扩展到新领域
  1316→
  1317→### 7.1 新Skill创建流程
  1318→
  1319→```
  1320→┌─────────────────────────────────────────────────────────────────────────────┐
  1321→│                    创建新领域专家系统 (以心理咨询为例)                        │
  1322→├─────────────────────────────────────────────────────────────────────────────┤
  1323→│                                                                             │
  1324→│  Step 1: 准备知识源                                                          │
  1325→│  ══════════════════                                                         │
  1326→│                                                                             │
  1327→│  /data/vibelife/psychology/source/                                         │
  1328→│  ├── cbt_handbook.pdf           # 认知行为疗法手册                          │
  1329→│  ├── attachment_theory.epub     # 依恋理论                                  │
  1330→│  ├── counseling_cases/          # 咨询案例集                                │
  1331→│  │   ├── case_001.md                                                       │
  1332→│  │   ├── case_002.md                                                       │
  1333→│  │   └── ...                                                               │
  1334→│  └── expert_interviews/         # 专家访谈                                  │
  1335→│      └── ...                                                               │
  1336→│                                                                             │
  1337→│  ───────────────────────────────────────────────────────────────────────    │
  1338→│                                                                             │
  1339→│  Step 2: 运行 Claude Code 构建                                               │
  1340→│  ══════════════════════════════                                             │
  1341→│                                                                             │
  1342→│  ```bash                                                                    │
  1343→│  claude code run build_expert_system.py \                                  │
  1344→│      --skill psychology \                                                  │
  1345→│      --source /data/vibelife/psychology/source/                            │
  1346→│  ```                                                                        │
  1347→│                                                                             │
  1348→│  Claude Code 自动:                                                          │
  1349→│  • 识别心理学领域的特殊结构                                                 │
  1350→│  • 抽取心理学的思维架构 (如: 认知三角、ABC模型)                            │
  1351→│  • 抽取咨询案例的推理过程                                                   │
  1352→│  • 抽取干预建议模式                                                         │
  1353→│                                                                             │
  1354→│  ───────────────────────────────────────────────────────────────────────    │
  1355→│                                                                             │
  1356→│  Step 3: 验证和调优                                                          │
  1357→│  ══════════════════                                                         │
  1358→│                                                                             │
  1359→│  1. 检查 SKILL.md 中的思维架构是否正确                                      │
  1360→│  2. 验证 scenarios/ 中的SOP流程是否合理                                     │
  1361→│  3. 测试几个真实咨询场景                                                    │
  1362→│  4. 根据反馈调整                                                            │
  1363→│                                                                             │
  1364→│  ───────────────────────────────────────────────────────────────────────    │
  1365→│                                                                             │
  1366→│  Step 4: 上线                                                                │
  1367→│  ═════════                                                                  │
  1368→│                                                                             │
  1369→│  • 新Skill自动被 SkillServiceRegistry 发现                                  │
  1370→│  • 无需修改代码，重启服务即可                                               │
  1371→│                                                                             │
  1372→└─────────────────────────────────────────────────────────────────────────────┘
  1373→```
  1374→
  1375→### 7.2 心理咨询领域示例
  1376→
  1377→```markdown
  1378→# 心理咨询 Skill (自动生成示例)
  1379→
  1380→## 专家身份
  1381→
  1382→你是一位专业的心理咨询师，熟悉认知行为疗法(CBT)、人本主义疗法、
  1383→精神分析等多种流派。你的目标是帮助来访者觉察自己的情绪和认知模式，
  1384→找到更健康的应对方式。
  1385→
  1386→## 思维架构体系
  1387→
  1388→### 核心架构
  1389→
  1390→| 架构名称 | 分析维度 | 适用场景 |
  1391→|---------|---------|---------|
  1392→| 认知三角架构 | 想法→情绪→行为 | 情绪困扰、行为问题 |
  1393→| ABC模型架构 | 事件→信念→结果 | 认知扭曲识别 |
  1394→| 依恋模式架构 | 安全/焦虑/回避/混乱 | 关系问题 |
  1395→| 需求层次架构 | 生理→安全→归属→尊重→自我实现 | 人生迷茫 |
  1396→
  1397→## 场景目录
  1398→
  1399→### 入门级
  1400→
  1401→| 场景 | 触发词 | 描述 |
  1402→|-----|--------|------|
  1403→| 情绪疏导 | 焦虑、难过、压力 | 倾听和共情 |
  1404→| 自我觉察 | 不知道为什么、莫名其妙 | 帮助觉察情绪 |
  1405→
  1406→### 标准级
  1407→
  1408→| 场景 | 触发词 | 描述 |
  1409→|-----|--------|------|
  1410→| 认知重构 | 总是、一定、必须 | 识别和调整认知扭曲 |
  1411→| 关系探索 | 和父母、和伴侣、和朋友 | 探索关系模式 |
  1412→
  1413→## 伦理边界
  1414→
  1415→### 绝对禁止
  1416→- 诊断精神疾病
  1417→- 替代专业治疗
  1418→- 给出伤害性建议
  1419→
  1420→### 必须转介
  1421→- 有自杀/自伤倾向
  1422→- 需要药物治疗
  1423→- 症状严重影响生活
  1424→```
  1425→
  1426→---
  1427→
  1428→## 八、总结
  1429→
  1430→```
  1431→┌─────────────────────────────────────────────────────────────────────────────┐
  1432→│                                                                             │
  1433→│                    专家系统引擎: 技术护城河的核心                             │
  1434→│                                                                             │
  1435→├─────────────────────────────────────────────────────────────────────────────┤
  1436→│                                                                             │
  1437→│  核心创新:                                                                   │
  1438→│  ══════════                                                                 │
  1439→│                                                                             │
  1440→│  1. 三要素抽取 (思维架构 + 推理链条 + 指导模式)                              │
  1441→│     不是简单的RAG，而是抽取专家的"认知结构"                                  │
  1442→│                                                                             │
  1443→│  2. Claude Code 自动构建                                                    │
  1444→│     知识处理完全自动化，可规模化扩展到任何领域                               │
  1445→│                                                                             │
  1446→│  3. 运行时动态注入                                                          │
  1447→│     根据用户情况实时匹配最相关的推理链条和指导模式                           │
  1448→│                                                                             │
  1449→│  ────────────────────────────────────────────────────────────────────────   │
  1450→│                                                                             │
  1451→│  竞争壁垒:                                                                   │
  1452→│  ══════════                                                                 │
  1453→│                                                                             │
  1454→│  • 知识资产: 结构化的东方智慧 + 西方心理学                                  │
  1455→│  • 抽取能力: Claude Code + 领域专家联合                                     │
  1456→│  • 积累效应: 越用越准的推理链条和指导模式                                   │
  1457→│                                                                             │
  1458→│  ────────────────────────────────────────────────────────────────────────   │
  1459→│                                                                             │
  1460→│  关键指标:                                                                   │
  1461→│  ══════════                                                                 │
  1462→│                                                                             │
  1463→│  构建效率: 1本书 → 1天自动处理 → 100+指导模式                              │
  1464→│  服务质量: 用户满意度 > 真人咨询师 (因为记忆完整、响应及时)                  │
  1465→│  扩展速度: 1个新领域 → 2周上线                                             │
  1466→│                                                                             │
  1467→└─────────────────────────────────────────────────────────────────────────────┘
  1468→```
  1469→
  1470→---
  1471→
  1472→*"The biggest risk is not taking any risk. In a world that's changing really quickly, the only strategy that is guaranteed to fail is not taking risks."*
  1473→
  1474→*— Mark Zuckerberg*
  1475→
  1476→**应用到VibeLife:**
  1477→
  1478→*"最大的风险是不冒任何风险。用Claude Code自动化构建专家系统，这是最大胆也是最正确的选择。"*

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
