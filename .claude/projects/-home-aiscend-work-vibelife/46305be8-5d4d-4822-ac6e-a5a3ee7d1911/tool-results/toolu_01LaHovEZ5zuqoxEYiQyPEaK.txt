     1→# Proactive 模块设计规范 v2.0
     2→
     3→> 更新日志:
     4→> - v2.0 (2026-01-19): 统一配置格式，新增触发器类型，添加 global_config
     5→
     6→## 概述
     7→
     8→Proactive 模块负责主动触达用户，通过推送通知增强用户粘性和业务转化。本模块与 Skill Management 深度集成，实现订阅感知的精准推送。
     9→
    10→## 核心原则
    11→
    12→| 原则 | 说明 |
    13→|-----|------|
    14→| 订阅感知 | 根据 Skill 订阅状态决定是否推送 |
    15→| 配置独立 | reminders.yaml 独立于 SKILL.md，便于运营调整 |
    16→| Skill 级开关 | 用户通过 Skill 总开关控制推送，简化设置 |
    17→| 对话引导 | 每条推送提供一键开始对话入口 |
    18→| **配置驱动** | 所有内容生成通过 rules/*.md，避免代码硬编码 |
    19→
    20→## 架构设计
    21→
    22→```
    23→┌─────────────────────────────────────────────────────────────────┐
    24→│                    Proactive 架构                               │
    25→├─────────────────────────────────────────────────────────────────┤
    26→│                                                                 │
    27→│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
    28→│  │  Scheduler  │───▶│   Engine    │───▶│  Delivery   │        │
    29→│  │  (Cron)     │    │             │    │  (Push)     │        │
    30→│  └─────────────┘    └──────┬──────┘    └─────────────┘        │
    31→│                            │                                   │
    32→│           ┌────────────────┼────────────────┐                  │
    33→│           │                │                │                  │
    34→│           ▼                ▼                ▼                  │
    35→│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
    36→│  │  Trigger    │  │  Content    │  │ Subscription │            │
    37→│  │  Detector   │  │  Generator  │  │   Checker    │            │
    38→│  └─────────────┘  └─────────────┘  └─────────────┘            │
    39→│         │                │                │                    │
    40→│         │                │                │                    │
    41→│         ▼                ▼                ▼                    │
    42→│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
    43→│  │ reminders   │  │   rules/    │  │ user_skill  │            │
    44→│  │   .yaml     │  │   *.md      │  │ subscriptions│           │
    45→│  └─────────────┘  └─────────────┘  └─────────────┘            │
    46→│                                                                 │
    47→└─────────────────────────────────────────────────────────────────┘
    48→```
    49→
    50→---
    51→
    52→## 配置规范 v2.0
    53→
    54→### reminders.yaml 结构
    55→
    56→reminders.yaml 独立存放于 `apps/api/skills/{skill_id}/reminders.yaml`，与 SKILL.md 通过 skill_id 关联。
    57→
    58→```yaml
    59→# v2.0 配置格式
    60→skill_id: bazi
    61→enabled: true
    62→
    63→# 使用 reminders (不是 reminder_types)
    64→reminders:
    65→  - id: daily_fortune
    66→    name: 每日运势
    67→    trigger:
    68→      type: time_based
    69→      schedule: "0 4 * * *"
    70→    content:
    71→      generator: rules/daily-fortune.md  # 必须使用 rules/ 路径
    72→      card_type: DailyFortuneCard
    73→      # 对话引导配置 (必须)
    74→      suggested_prompt: "想了解今天的运势详情？"
    75→      quick_actions:
    76→        - label: "今日宜忌"
    77→          prompt: "今天适合做什么？有什么需要注意的？"
    78→    priority: medium
    79→
    80→# 全局配置
    81→global_config:
    82→  default_push_hour: 4      # 默认推送时间
    83→  cooldown_hours: 24        # 同类型冷却时间
    84→```
    85→
    86→### 必须字段
    87→
    88→| 字段 | 类型 | 说明 |
    89→|-----|------|------|
    90→| skill_id | string | Skill 标识符，与 SKILL.md 一致 |
    91→| enabled | boolean | 是否启用推送 |
    92→| reminders | array | 提醒配置列表 |
    93→| reminders[].id | string | 提醒唯一标识 (snake_case) |
    94→| reminders[].name | string | 提醒名称 (中文) |
    95→| reminders[].trigger | object | 触发配置 |
    96→| reminders[].content | object | 内容配置 |
    97→| reminders[].content.generator | string | **必须** 使用 `rules/*.md` 路径 |
    98→| reminders[].content.suggested_prompt | string | **必须** 对话引导提示语 |
    99→| reminders[].content.quick_actions | array | **必须** 快捷操作按钮 |
   100→
   101→---
   102→
   103→## 触发器类型
   104→
   105→### 1. time_based - 定时触发
   106→
   107→```yaml
   108→trigger:
   109→  type: time_based
   110→  schedule: "0 4 * * *"     # Cron 表达式
   111→  time_window: "04:00-06:00" # 可选: 允许的时间窗口
   112→  condition: has_active_goals # 可选: 前置条件
   113→```
   114→
   115→### 2. event_based - 事件触发
   116→
   117→```yaml
   118→trigger:
   119→  type: event_based
   120→  event: birthday           # 事件类型
   121→  advance_days: [7, 0]      # 提前多少天触发
   122→```
   123→
   124→**支持的事件类型:**
   125→
   126→| 事件 | 说明 | 来源 |
   127→|-----|------|------|
   128→| birthday | 阳历生日 | unified_profiles |
   129→| lunar_birthday | 农历生日 | unified_profiles |
   130→| dayun_change | 大运交接 | bazi.services |
   131→| liunian_change | 流年交接 | bazi.services |
   132→| solar_term | 节气 | global_events |
   133→| lunar_phase | 月相 (新月/满月) | zodiac.services |
   134→| mercury_retrograde | 水逆 | zodiac.services |
   135→| significant_transit | 重要行运 | zodiac.services |
   136→| checkin_streak | 连续打卡里程碑 | core |
   137→| practice_milestone | 累计练习里程碑 | mindfulness |
   138→| goal_deadline_approaching | 目标截止日期临近 | core |
   139→
   140→### 3. threshold_based - 阈值触发
   141→
   142→```yaml
   143→trigger:
   144→  type: threshold_based
   145→  metric: daily_fortune_score
   146→  condition: "<"
   147→  threshold: 40
   148→  cooldown_days: 7          # 冷却期，避免重复推送
   149→```
   150→
   151→**支持的指标:**
   152→
   153→| 指标 | 说明 | 来源 |
   154→|-----|------|------|
   155→| daily_fortune_score | 每日运势分数 | bazi.services |
   156→| health_score | 健康指数 | zodiac.services |
   157→| streak_days | 连续打卡天数 | core |
   158→| total_minutes | 累计练习时长 | mindfulness |
   159→
   160→### 4. emotion_based - 情绪触发 (Mindfulness 专用)
   161→
   162→```yaml
   163→trigger:
   164→  type: emotion_based
   165→  emotion: anxiety
   166→  keywords:
   167→    - 焦虑
   168→    - 着急
   169→    - 担心
   170→```
   171→
   172→**支持的情绪类型:**
   173→
   174→| 情绪 | 关键词示例 |
   175→|-----|-----------|
   176→| anxiety | 焦虑、着急、担心、紧张 |
   177→| anger | 生气、愤怒、火大、气死 |
   178→| sadness | 难过、悲伤、想哭、失落 |
   179→| overwhelm | 崩溃、受不了、压力大 |
   180→
   181→### 5. skill_completion - Skill 完成触发
   182→
   183→```yaml
   184→trigger:
   185→  type: skill_completion
   186→  preceding_skill: bazi
   187→  condition:
   188→    session_depth: ">= 3"
   189→    topic_depth: deep
   190→```
   191→
   192→---
   193→
   194→## Subscription 集成
   195→
   196→### 推送决策逻辑
   197→
   198→```python
   199→async def _should_send_to_user(
   200→    self,
   201→    user_id: UUID,
   202→    skill_id: str,
   203→) -> bool:
   204→    """
   205→    检查是否应该发送推送
   206→    - 粒度: Skill 级别总开关
   207→    """
   208→    # 1. 获取 Skill 元数据
   209→    skill_meta = load_skill_metadata(skill_id)
   210→    category = skill_meta.category if skill_meta else "professional"
   211→
   212→    # 2. Core Skill 始终发送
   213→    if category == "core":
   214→        return True
   215→
   216→    # 3. 获取用户订阅状态
   217→    subscription = await SkillSubscriptionRepo.get(user_id, skill_id)
   218→
   219→    # 4. Default Skill: 检查是否取消订阅或关闭推送
   220→    if category == "default":
   221→        if subscription and subscription.status == "unsubscribed":
   222→            return False
   223→        if subscription and not subscription.push_enabled:
   224→            return False
   225→        return True
   226→
   227→    # 5. Professional Skill: 需要有效订阅且开启推送
   228→    if not subscription or subscription.status != "subscribed":
   229→        return False
   230→
   231→    return subscription.push_enabled
   232→```
   233→
   234→### 订阅状态与推送关系
   235→
   236→| Skill 类别 | 订阅状态 | push_enabled | 是否推送 |
   237→|-----------|---------|--------------|---------|
   238→| core | - | - | ✅ 始终推送 |
   239→| default | 无/subscribed | true (默认) | ✅ 推送 |
   240→| default | unsubscribed | - | ❌ 不推送 |
   241→| default | subscribed | false | ❌ 不推送 |
   242→| professional | subscribed | true | ✅ 推送 |
   243→| professional | 无/unsubscribed | - | ❌ 不推送 |
   244→| professional | subscribed | false | ❌ 不推送 |
   245→
   246→---
   247→
   248→## ContentGenerator 设计
   249→
   250→### 配置驱动原则
   251→
   252→**所有内容生成必须通过 rules/*.md 配置，禁止在代码中硬编码文案。**
   253→
   254→```python
   255→class ContentGenerator:
   256→    """配置驱动的内容生成器"""
   257→
   258→    async def generate(
   259→        self,
   260→        task: ReminderTask,
   261→        profile: Dict[str, Any],
   262→        config: Dict[str, Any],
   263→    ) -> ReminderContent:
   264→        """
   265→        流程:
   266→        1. 加载 content.generator 指定的 rule 文件
   267→        2. 使用 rule 中的分析要点和检索 Query
   268→        3. 调用 LLM 生成个性化内容
   269→        4. 附加对话引导信息
   270→        """
   271→        generator_path = config.get("content", {}).get("generator", "")
   272→
   273→        # 必须使用 rules/ 路径
   274→        if not generator_path.startswith("rules/"):
   275→            raise ValueError(f"generator must use rules/ path: {generator_path}")
   276→
   277→        rule = load_rule(task.skill_id, generator_path)
   278→        content = await self._generate_from_rule(task, profile, rule)
   279→
   280→        # 附加对话引导
   281→        content.suggested_prompt = config["content"]["suggested_prompt"]
   282→        content.quick_actions = config["content"]["quick_actions"]
   283→
   284→        return content
   285→```
   286→
   287→---
   288→
   289→## 通知数据结构
   290→
   291→### ProactiveNotification
   292→
   293→```typescript
   294→interface ProactiveNotification {
   295→  id: string;
   296→  skill_id: string;
   297→  reminder_type: string;
   298→  title: string;
   299→  content: {
   300→    body: string;
   301→    fortune_hint?: string;
   302→    action_tip?: string;
   303→    // 对话引导 (必须)
   304→    suggested_prompt: string;
   305→    quick_actions: Array<{
   306→      label: string;
   307→      prompt: string;  // 点击后发送的消息
   308→    }>;
   309→  };
   310→  card_type?: string;
   311→  created_at: string;
   312→  read_at?: string;
   313→}
   314→```
   315→
   316→---
   317→
   318→## 目录结构
   319→
   320→```
   321→apps/api/
   322→├── skills/{skill_id}/
   323→│   ├── SKILL.md
   324→│   ├── reminders.yaml        # Proactive 配置 (v2.0 格式)
   325→│   ├── rules/
   326→│   │   ├── daily-fortune.md  # 推送内容生成规则
   327→│   │   └── ...
   328→│   └── tools/
   329→│
   330→├── services/
   331→│   └── proactive/
   332→│       ├── engine.py         # 集成 Subscription 检查
   333→│       ├── trigger_detector.py  # 支持 5 种触发器
   334→│       ├── content_generator.py  # 配置驱动生成
   335→│       └── __init__.py
   336→│
   337→└── workers/
   338→    └── proactive_worker.py
   339→
   340→apps/web/
   341→├── components/
   342→│   └── layout/
   343→│       └── NotificationBell.tsx  # 支持 quick_actions
   344→│
   345→└── app/
   346→    └── chat/
   347→        └── page.tsx              # 支持 skill/prompt 参数
   348→```
   349→
   350→---
   351→
   352→## 迁移指南 (v1.0 → v2.0)
   353→
   354→### 1. 配置格式迁移
   355→
   356→```yaml
   357→# v1.0 (旧)
   358→reminder_types:
   359→  - id: daily_fortune
   360→    ...
   361→
   362→# v2.0 (新)
   363→reminders:
   364→  - id: daily_fortune
   365→    ...
   366→```
   367→
   368→### 2. 添加必须字段
   369→
   370→每个 reminder 必须包含:
   371→- `content.generator`: 使用 `rules/*.md` 路径
   372→- `content.suggested_prompt`: 对话引导提示
   373→- `content.quick_actions`: 至少 1 个快捷操作
   374→
   375→### 3. 添加 global_config
   376→
   377→```yaml
   378→global_config:
   379→  default_push_hour: 4
   380→  cooldown_hours: 24
   381→```
   382→
   383→### 4. 创建缺失的 rules 文件
   384→
   385→参考 [MISSING_RULES.md](./MISSING_RULES.md) 补齐缺失的规则文件。
   386→
   387→---
   388→
   389→## API 接口
   390→
   391→### 获取推送通知列表
   392→
   393→```
   394→GET /api/notifications
   395→```
   396→
   397→Response:
   398→```json
   399→{
   400→  "items": [
   401→    {
   402→      "id": "uuid",
   403→      "skill_id": "bazi",
   404→      "reminder_type": "daily_fortune",
   405→      "title": "今日运势",
   406→      "content": {
   407→        "body": "甲木日主，今日戊土当令...",
   408→        "suggested_prompt": "想了解今天的运势详情？",
   409→        "quick_actions": [
   410→          {"label": "今日宜忌", "prompt": "今天适合做什么？"},
   411→          {"label": "开运建议", "prompt": "今天如何提升运势？"}
   412→        ]
   413→      },
   414→      "created_at": "2026-01-19T04:00:00Z"
   415→    }
   416→  ],
   417→  "unread_count": 1
   418→}
   419→```
   420→
   421→### 更新 Skill 推送开关
   422→
   423→```
   424→PUT /api/skills/{skill_id}/subscription
   425→```
   426→
   427→Request:
   428→```json
   429→{
   430→  "push_enabled": false
   431→}
   432→```
   433→
   434→---
   435→
   436→## 相关文档
   437→
   438→- [MISSING_RULES.md](./MISSING_RULES.md) - 缺失的 rules 文件清单
   439→- [reminders-schema.yaml](./reminders-schema.yaml) - 配置 JSON Schema
   440→- [README.md](./README.md) - 模块概览
   441→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
