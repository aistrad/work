     1→# Skill 统一配置框架（routing.yaml 升级）
     2→
     3→> 统一模型：`skill_data` + `includes`，无需区分类型
     4→
     5→## 核心思想
     6→
     7→所有 Skill 使用相同的配置模型：
     8→- `skill_data`: 需要加载哪些 Skill 的数据
     9→- `includes`: 需要加载哪些 Skill 的工具
    10→
    11→不再区分"能力型"和"编排型"，统一处理。
    12→
    13→---
    14→
    15→## routing.yaml 统一结构
    16→
    17→```yaml
    18→skills:
    19→  # 基础 Skill
    20→  bazi:
    21→    name: 八字命理
    22→    short_desc: 八字命理分析
    23→    category: astrology
    24→    triggers: [八字, 命理, 生辰, 算命, 命盘]
    25→    requires_birth_info: true
    26→    requires_compute: true
    27→    compute_tool: calculate_bazi
    28→    collect_tool: request_info
    29→    global_tools: [search_db, request_info, show_insight]
    30→    # skill_data: []      # 默认只加载自身
    31→    # includes: []        # 默认不包含其他 Skill
    32→
    33→  zodiac:
    34→    name: 星座占星
    35→    short_desc: 星座星盘分析
    36→    category: astrology
    37→    triggers: [星座, 星盘, 占星, 上升]
    38→    requires_birth_info: true
    39→    requires_compute: true
    40→    compute_tool: calculate_zodiac
    41→    collect_tool: request_info
    42→    global_tools: [search_db, request_info, show_insight]
    43→
    44→  # 依赖其他 Skill 数据的 Skill
    45→  jungastro:
    46→    name: 荣格心理占星
    47→    short_desc: 荣格心理占星分析
    48→    category: self-awareness
    49→    triggers: [荣格, 心理占星, 阴影整合]
    50→    requires_birth_info: true
    51→    requires_compute: true
    52→    compute_tool: calculate_zodiac
    53→    skill_data: [bazi, zodiac]          # 加载这些 Skill 的数据
    54→    includes: [zodiac]                  # 包含 zodiac 的工具
    55→    global_tools: [search_db, request_info]
    56→
    57→  vibe_id:
    58→    name: VibeID 人格画像
    59→    short_desc: 四维人格原型分析
    60→    category: self-awareness
    61→    triggers: [人格画像, VibeID, 原型分析]
    62→    requires_birth_info: true
    63→    requires_compute: true
    64→    skill_data: [bazi, zodiac]
    65→    global_tools: [show_card, request_info, search_db]
    66→
    67→  # 包含多个 Skill 工具的 Skill
    68→  career_timing:
    69→    name: 职场时机
    70→    short_desc: 职场时机分析
    71→    category: professional
    72→    triggers: [职场时机, 跳槽时机, 什么时候换工作]
    73→    requires_birth_info: true
    74→    skill_data: [bazi, zodiac]
    75→    includes: [bazi, zodiac, career]    # 包含这些 Skill 的工具
    76→
    77→  relationship_intel:
    78→    name: 关系经营
    79→    short_desc: 关系经营智能
    80→    category: relationship
    81→    triggers: [合盘, 配对, 关系分析]
    82→    requires_birth_info: true
    83→    skill_data: [bazi, zodiac]
    84→    includes: [bazi, zodiac]
    85→```
    86→
    87→---
    88→
    89→## 配置字段说明
    90→
    91→| 字段 | 类型 | 默认值 | 说明 |
    92→|------|------|--------|------|
    93→| `name` | string | - | Skill 显示名称 |
    94→| `short_desc` | string | - | 一句话描述 |
    95→| `category` | string | - | 分类（astrology/self-awareness/professional/relationship） |
    96→| `triggers` | list | [] | 触发词列表 |
    97→| `requires_birth_info` | bool | false | 是否需要出生信息 |
    98→| `requires_compute` | bool | false | 是否需要排盘/计算 |
    99→| `compute_tool` | string | - | 计算工具名 |
   100→| `collect_tool` | string | request_info | 收集工具名 |
   101→| `global_tools` | list | [] | 需要的全局工具 |
   102→| `skill_data` | list | [self] | 需要加载的 skill_data |
   103→| `includes` | list | [] | 需要包含工具的 Skill |
   104→
   105→---
   106→
   107→## 实施步骤
   108→
   109→### Step 1: 升级 routing.yaml
   110→
   111→将所有 SKILL.md frontmatter 中的机器配置迁移到 routing.yaml。
   112→
   113→### Step 2: 新增查询函数
   114→
   115→**文件**: `services/agent/routing_config.py`
   116→
   117→```python
   118→def get_skill_data_deps(skill_id: str) -> List[str]:
   119→    """获取需要加载的 skill_data 列表"""
   120→    config = get_skill_routing(skill_id)
   121→    deps = config.get("skill_data", [])
   122→    # 始终包含自身
   123→    if skill_id not in deps:
   124→        deps = [skill_id] + deps
   125→    return deps
   126→
   127→def get_skill_includes(skill_id: str) -> List[str]:
   128→    """获取需要加载工具的 Skill 列表"""
   129→    config = get_skill_routing(skill_id)
   130→    return config.get("includes", [])
   131→```
   132→
   133→### Step 3: 修改数据加载
   134→
   135→**文件**: `stores/profile_cache.py`
   136→
   137→```python
   138→async def get_cached_profile_with_skill(user_id, skill):
   139→    deps = get_skill_data_deps(skill) if skill else [skill]
   140→    skill_data_dict = {sid: skills_store.get(sid, {}) for sid in deps}
   141→    return {"profile": profile, "skill_data": skill_data_dict}
   142→```
   143→
   144→### Step 4: 修改工具加载
   145→
   146→**文件**: `services/agent/tool_registry.py`
   147→
   148→```python
   149→def get_tools_for_skill(skill_id):
   150→    tools = []
   151→    # 加载 includes 列表中的工具
   152→    for inc_skill in get_skill_includes(skill_id):
   153→        tools.extend(_load_skill_tools(inc_skill))
   154→    # 加载自身工具
   155→    tools.extend(_load_skill_tools(skill_id))
   156→    return tools
   157→```
   158→
   159→### Step 5: 简化 SKILL.md
   160→
   161→移除机器配置，只保留 prompt 内容：
   162→- 专家身份
   163→- 服务原则
   164→- 伦理边界
   165→- 详细规则索引
   166→
   167→---
   168→
   169→## 修改文件清单
   170→
   171→| 文件 | 改动 |
   172→|------|------|
   173→| `skills/core/config/routing.yaml` | 迁入所有配置 |
   174→| `services/agent/routing_config.py` | 新增 2 个查询函数 |
   175→| `stores/profile_cache.py` | 使用 `get_skill_data_deps()` |
   176→| `services/agent/tool_registry.py` | 使用 `get_skill_includes()` |
   177→| `services/agent/skill_loader.py` | 优先从 routing.yaml 读配置 |
   178→| `skills/*/SKILL.md` | 简化 |
   179→
   180→---
   181→
   182→## 配置字段分工
   183→
   184→| 字段 | routing.yaml | SKILL.md |
   185→|------|--------------|----------|
   186→| name, short_desc | ✅ | - |
   187→| triggers | ✅ | - |
   188→| category | ✅ | - |
   189→| requires_birth_info | ✅ | - |
   190→| requires_compute | ✅ | - |
   191→| compute_tool, collect_tool | ✅ | - |
   192→| global_tools | ✅ | - |
   193→| skill_data, includes | ✅ | - |
   194→| 专家身份 | - | ✅ |
   195→| 服务原则 | - | ✅ |
   196→| 伦理边界 | - | ✅ |
   197→| 核心能力索引 | - | ✅ |
   198→
   199→---
   200→
   201→## 验证
   202→
   203→1. `get_skill_data_deps("jungastro")` → `["jungastro", "bazi", "zodiac"]`
   204→2. `get_skill_includes("career_timing")` → `["bazi", "zodiac", "career"]`
   205→3. 激活 career_timing 后 context.skill_data 包含 bazi + zodiac 数据
   206→4. LLM 能看到 bazi/zodiac/career 的所有工具
   207→
   208→---
   209→
   210→## 示例：创建新的编排 Skill
   211→
   212→### 1. 在 routing.yaml 添加配置
   213→
   214→```yaml
   215→skills:
   216→  life_milestone:
   217→    name: 人生节点导航
   218→    short_desc: 人生重大决策时机分析
   219→    category: professional
   220→    triggers: [买房, 结婚时机, 要不要生孩子, 创业时机]
   221→    requires_birth_info: true
   222→    skill_data: [bazi, zodiac]
   223→    includes: [bazi, zodiac, career, lifecoach]
   224→```
   225→
   226→### 2. 创建 SKILL.md
   227→
   228→```markdown
   229→# 人生节点导航 Skill
   230→
   231→## 专家身份
   232→
   233→你是一位融合命理智慧和人生规划经验的导航师...
   234→
   235→## 服务原则
   236→
   237→1. 综合多维度分析
   238→2. 提供时机窗口建议
   239→3. 全程陪伴式服务
   240→
   241→## 伦理边界
   242→
   243→- 不替用户做决定
   244→- 强调人的主观能动性
   245→```
   246→
   247→### 3. 创建 rules/（可选）
   248→
   249→```
   250→skills/life_milestone/
   251→├── SKILL.md
   252→└── rules/
   253→    ├── house-buying.md
   254→    ├── marriage.md
   255→    └── startup.md
   256→```
   257→
   258→无需其他代码，系统自动：
   259→- 根据 triggers 路由到此 Skill
   260→- 加载 bazi + zodiac 数据
   261→- 加载 bazi/zodiac/career/lifecoach 的工具
   262→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
