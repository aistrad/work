     1→"""
     2→路由配置加载器 - Single Source of Truth
     3→
     4→从 skills/core/config/routing.yaml 加载所有路由相关配置，
     5→避免在代码中重复定义元数据。
     6→"""
     7→import os
     8→import yaml
     9→import logging
    10→from typing import Dict, Any, List, Optional
    11→from functools import lru_cache
    12→
    13→logger = logging.getLogger(__name__)
    14→
    15→# 配置文件路径
    16→CONFIG_PATH = os.path.join(
    17→    os.path.dirname(__file__),
    18→    "../../skills/core/config/routing.yaml"
    19→)
    20→
    21→
    22→@lru_cache(maxsize=1)
    23→def load_routing_config() -> Dict[str, Any]:
    24→    """加载路由配置（带缓存）"""
    25→    try:
    26→        with open(CONFIG_PATH, "r", encoding="utf-8") as f:
    27→            config = yaml.safe_load(f)
    28→            logger.info(f"[RoutingConfig] Loaded from {CONFIG_PATH}")
    29→            return config or {}
    30→    except Exception as e:
    31→        logger.error(f"[RoutingConfig] Failed to load config: {e}")
    32→        return {}
    33→
    34→
    35→def get_phase1_prompt() -> str:
    36→    """获取 Phase 1 System Prompt"""
    37→    config = load_routing_config()
    38→    return config.get("phase1_prompt", "")
    39→
    40→
    41→def get_protocol_meta(protocol_id: str) -> Optional[Dict[str, Any]]:
    42→    """获取协议元数据"""
    43→    config = load_routing_config()
    44→    protocols = config.get("protocols", {})
    45→    return protocols.get(protocol_id)
    46→
    47→
    48→def get_all_protocols() -> Dict[str, Dict[str, Any]]:
    49→    """获取所有协议元数据"""
    50→    config = load_routing_config()
    51→    return config.get("protocols", {})
    52→
    53→
    54→def get_skill_routing_config(skill_id: str) -> Optional[Dict[str, Any]]:
    55→    """获取 Skill 路由配置"""
    56→    config = load_routing_config()
    57→    skills = config.get("skills", {})
    58→    return skills.get(skill_id)
    59→
    60→
    61→def get_all_skill_routing() -> Dict[str, Dict[str, Any]]:
    62→    """获取所有 Skill 路由配置"""
    63→    config = load_routing_config()
    64→    return config.get("skills", {})
    65→
    66→
    67→def get_sop_template(template_name: str) -> str:
    68→    """获取 SOP 规则模板"""
    69→    config = load_routing_config()
    70→    templates = config.get("sop_templates", {})
    71→    return templates.get(template_name, "")
    72→
    73→
    74→def get_welcome_config() -> Dict[str, Any]:
    75→    """获取欢迎消息配置"""
    76→    config = load_routing_config()
    77→    return config.get("welcome", {})
    78→
    79→
    80→def build_protocol_tool_description() -> str:
    81→    """
    82→    构建 show_protocol_invitation 工具的描述
    83→    从配置文件动态生成，避免硬编码
    84→    """
    85→    protocols = get_all_protocols()
    86→    if not protocols:
    87→        return "展示协议邀请卡片"
    88→
    89→    lines = ["展示协议邀请卡片，引导用户进入结构化协议流程。\n"]
    90→    lines.append("## 可用协议\n")
    91→    lines.append("| protocol_id | 名称 | 适用场景 | 时长 |")
    92→    lines.append("|-------------|------|---------|------|")
    93→
    94→    for pid, meta in protocols.items():
    95→        name = meta.get("name", pid)
    96→        desc = meta.get("description", "")[:20] + "..."
    97→        time = meta.get("estimated_time", "10分钟")
    98→        lines.append(f"| {pid} | {name} | {desc} | {time} |")
    99→
   100→    lines.append("\n## 触发词映射\n")
   101→    for pid, meta in protocols.items():
   102→        triggers = meta.get("triggers", [])
   103→        if triggers:
   104→            lines.append(f"- {pid}: {', '.join(triggers[:3])}")
   105→
   106→    lines.append("\n## 重要")
   107→    lines.append("匹配到协议关键词时，必须调用此工具！")
   108→
   109→    return "\n".join(lines)
   110→
   111→
   112→def build_skill_tool_description() -> str:
   113→    """
   114→    构建 activate_skill 工具的描述 - v10.1: 包含 rule 选择指引
   115→    从配置文件动态生成
   116→    """
   117→    from .skill_loader import load_skill, get_available_skills, get_skill_rules, load_rule
   118→
   119→    available_skills = [s for s in get_available_skills() if s != "core"]
   120→    skill_routing = get_all_skill_routing()
   121→
   122→    lines = ["激活专业技能来回答用户问题。\n"]
   123→    lines.append("## 可用技能\n")
   124→
   125→    for skill_id in available_skills:
   126→        skill = load_skill(skill_id)
   127→        routing = skill_routing.get(skill_id, {})
   128→
   129→        if skill:
   130→            desc = routing.get("short_desc") or skill.description
   131→            if len(desc) > 50:
   132→                desc = desc[:50] + "..."
   133→            triggers = routing.get("triggers", skill.triggers or [])[:3]
   134→            trigger_text = "、".join(triggers) if triggers else ""
   135→            lines.append(f"- **{skill_id}**: {desc}（{trigger_text}）")
   136→
   137→            # v10.1: 列出可选 rules
   138→            rules = get_skill_rules(skill_id)
   139→            if rules and len(rules) > 0:
   140→                lines.append(f"  可选规则（rule 参数）：")
   141→                for rule_id in rules[:3]:  # 最多显示 3 个
   142→                    rule = load_rule(skill_id, rule_id)
   143→                    if rule:
   144→                        rule_name = getattr(rule, 'name', rule_id)
   145→                        tags = getattr(rule, 'tags', [])
   146→                        tags_text = "、".join(tags[:2]) if tags else ""
   147→                        lines.append(f"    - `{rule_id}`: {rule_name}（{tags_text}）")
   148→
   149→    lines.append("\n## 参数说明")
   150→    lines.append("- `skill`: 必需，技能 ID")
   151→    lines.append("- `rule`: 可选，规则 ID。用户意图明确匹配某规则时传入")
   152→
   153→    lines.append("\n## rule 参数使用指南")
   154→    lines.append("- 用户说'做人生重置' → `activate_skill(skill='lifecoach', rule='dankoe')`")
   155→    lines.append("- 用户说'算命'（无明确 rule）→ `activate_skill(skill='bazi')`")
   156→    lines.append("- 用户说'七个习惯' → `activate_skill(skill='lifecoach', rule='covey')`")
   157→
   158→    lines.append("\n## 何时调用")
   159→    lines.append("- 用户明确需要某个专业领域的帮助")
   160→    lines.append("- 用户提到了技能相关的关键词")
   161→
   162→    return "\n".join(lines)
   163→
   164→
   165→def reload_config():
   166→    """重新加载配置（清除缓存）"""
   167→    load_routing_config.cache_clear()
   168→    logger.info("[RoutingConfig] Cache cleared, will reload on next access")
   169→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
