     1→# VibeLife 测试环境配置
     2→
     3→> **版本**: v6.9 | **环境**: 测试 (aiscend) | **更新**: 2026-01-19
     4→
     5→## 服务架构
     6→
     7→| 组件 | 技术栈 | 端口 | 运行模式 |
     8→|------|--------|------|----------|
     9→| 后端 API | FastAPI + Python 3.13 | 8100 | uvicorn |
    10→| 前端 Web | Next.js 14 + React 18 | 8232 | Production (`pnpm start`) |
    11→| 数据库 | PostgreSQL 16 + pgvector | 8224 | - |
    12→
    13→## 数据库
    14→
    15→| 配置项 | 值 |
    16→|--------|-----|
    17→| 主机 | `106.37.170.238` |
    18→| 端口 | `8224` |
    19→| 数据库 | `vibelife` |
    20→| 连接串 | `postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife` |
    21→
    22→**核心表**:
    23→- `vibe_users` - 用户
    24→- `unified_profiles` - 用户画像 (JSONB)
    25→- `conversations` / `messages` - 对话
    26→- `knowledge_chunks` - 知识库 (pgvector 1024维)
    27→- `cases` / `scenarios` - 专家系统
    28→
    29→## LLM 配置
    30→
    31→**配置文件**: `apps/api/config/models.yaml` (唯一配置源)
    32→
    33→**默认路由顺序**: deepseek → glm → claude
    34→
    35→| 提供商 | 模型 | 用途 | 环境变量 |
    36→|--------|------|------|----------|
    37→| DeepSeek | deepseek-chat | 主力对话 | `DEEPSEEK_API_KEY` |
    38→| GLM | glm-4.7 | 备选对话 | `GLM_API_KEY` |
    39→| Claude | claude-opus-4-5 | 备选对话 | `CLAUDE_API_KEY` |
    40→| Gemini | gemini-image | 图像生成 | `GEMINI_API_KEY` |
    41→
    42→```yaml
    43→# config/models.yaml 核心配置
    44→defaults:
    45→  chat:
    46→    primary: deepseek-v3
    47→    fallback: [glm-4.7, claude-opus]
    48→  image_gen:
    49→    primary: gemini-image
    50→global_fallback: glm-4.7
    51→```
    52→
    53→## 向量嵌入
    54→
    55→| 配置项 | 值 |
    56→|--------|-----|
    57→| 模型 | `BAAI/bge-m3` |
    58→| 维度 | `1024` |
    59→| 推理 | 本地 SentenceTransformers (CUDA) |
    60→| 存储 | PostgreSQL pgvector |
    61→
    62→```bash
    63→EMBEDDING_MODEL_NAME=BAAI/bge-m3
    64→EMBEDDING_DIMENSION=1024
    65→EMBEDDING_DEVICE=cuda
    66→EMBEDDING_LOCAL_DIR=/home/aiscend/.cache/vibelife/models/bge-m3
    67→```
    68→
    69→## 数据目录
    70→
    71→```
    72→/data/vibelife/
    73→├── knowledge/     # 知识库源文件
    74→│   ├── bazi/
    75→│   ├── zodiac/
    76→│   └── career/
    77→├── uploads/       # 用户上传
    78→├── cache/         # 缓存
    79→└── logs/          # 日志
    80→```
    81→
    82→## API 路由 (v6.8)
    83→
    84→| 路由 | 说明 |
    85→|------|------|
    86→| `/health` | 健康检查 |
    87→| `/api/v1/chat/*` | 对话 (SSE) |
    88→| `/api/v1/tools/*` | 工具调用 |
    89→| `/api/v1/skills/*` | Skill Gateway |
    90→| `/api/v1/account/*` | 用户账户 |
    91→| `/api/v1/commerce/*` | 支付订阅 |
    92→| `/api/v1/vibe-id/*` | VibeID |
    93→
    94→## 项目结构 (v6.8)
    95→
    96→```
    97→apps/api/
    98→├── main.py                    # 入口 (7 路由)
    99→├── config/models.yaml         # LLM 配置 (唯一源)
   100→├── routes/                    # API 路由
   101→│   ├── chat_v5.py            # 对话 (CoreAgent)
   102→│   ├── skills.py             # Skill Gateway
   103→│   ├── account.py            # 账户
   104→│   └── commerce.py           # 支付
   105→├── services/
   106→│   ├── agent/                # CoreAgent + ToolRegistry
   107→│   ├── llm/                  # LLM 客户端
   108→│   ├── knowledge/            # RAG 检索
   109→│   └── proactive/            # 主动推送
   110→├── skills/                   # Skill 定义 (DDD)
   111→│   ├── bazi/
   112→│   │   ├── SKILL.md
   113→│   │   ├── services/         # 领域服务
   114→│   │   ├── tools/            # 工具定义
   115→│   │   └── scenarios/        # 场景
   116→│   ├── zodiac/
   117→│   ├── tarot/
   118→│   └── career/
   119→└── stores/                   # 数据访问层
   120→
   121→apps/web/src/
   122→├── app/                      # Next.js App Router
   123→├── components/               # React 组件
   124→├── hooks/useVibeChat.ts      # AI SDK 6 集成
   125→└── skills/                   # 前端 Skill 卡片
   126→```
   127→
   128→## 环境变量
   129→
   130→完整配置见 `.env.test`，核心变量：
   131→
   132→```bash
   133→# 数据库
   134→VIBELIFE_DB_URL=postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife
   135→
   136→# LLM
   137→DEEPSEEK_API_KEY=<KEY>
   138→GLM_API_KEY=<KEY>
   139→CLAUDE_API_KEY=<KEY>
   140→GEMINI_API_KEY=<KEY>
   141→
   142→# 向量嵌入
   143→EMBEDDING_MODEL_NAME=BAAI/bge-m3
   144→EMBEDDING_DIMENSION=1024
   145→
   146→# JWT
   147→VIBELIFE_JWT_SECRET=<SECRET>
   148→
   149→# CORS
   150→VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8232,http://localhost:8232,http://localhost:3000
   151→
   152→# 数据目录
   153→VIBELIFE_DATA_ROOT=/data/vibelife
   154→```
   155→
   156→## 健康检查
   157→
   158→```bash
   159→# API
   160→curl http://106.37.170.238:8100/health
   161→
   162→# 数据库
   163→psql $VIBELIFE_DB_URL -c "SELECT 1"
   164→
   165→# pgvector
   166→psql $VIBELIFE_DB_URL -c "SELECT vector_dims('[1,2,3]'::vector)"
   167→```
   168→
   169→## 支付 (Stripe)
   170→
   171→| 配置项 | 环境变量 |
   172→|--------|----------|
   173→| Secret Key | `STRIPE_SECRET_KEY` |
   174→| Publishable Key | `STRIPE_PUBLISHABLE_KEY` |
   175→| Webhook Secret | `STRIPE_WEBHOOK_SECRET` |
   176→
   177→详见 `docs/archive/v5/stripe-best-practices.md`
   178→
   179→## 前端配置
   180→
   181→**配置文件**: `apps/web/.env.local`
   182→
   183→```bash
   184→# API 地址
   185→NEXT_PUBLIC_API_URL=http://106.37.170.238:8100
   186→NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1
   187→NEXT_PUBLIC_WS_URL=ws://106.37.170.238:8100/ws
   188→
   189→# 内部 API (SSR)
   190→VIBELIFE_API_INTERNAL=http://127.0.0.1:8100
   191→```
   192→
   193→**运行要求**:
   194→- 必须使用 `pnpm build` 构建后以 `pnpm start` 运行
   195→- 不要使用 `pnpm dev` 运行测试环境，会导致静态资源 404
   196→
   197→**启动命令**:
   198→```bash
   199→cd /home/aiscend/work/vibelife/apps/web
   200→pnpm build
   201→pnpm start -H 0.0.0.0 -p 8232
   202→```
   203→
   204→## 更新历史
   205→
   206→| 版本 | 日期 | 变更 |
   207→|------|------|------|
   208→| v6.9 | 2026-01-19 | 添加前端配置说明，明确生产模式运行要求 |
   209→| v6.8 | 2026-01-17 | 初始版本 |
   210→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
