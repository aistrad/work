     1→# VibeLife 测试环境部署指南
     2→
     3→> 最后更新: 2026-01-19 | v7.0 已验证 | 测试环境 (aiscend)
     4→
     5→---
     6→
     7→## 部署架构
     8→
     9→### 测试环境架构
    10→
    11→```
    12→┌─────────────────────────────────────────────────────────────────────────────┐
    13→│                              用户浏览器                                      │
    14→└─────────────────────────────────┬───────────────────────────────────────────┘
    15→                                  │
    16→                                  ▼
    17→┌─────────────────────────────────────────────────────────────────────────────┐
    18→│                         aiscend 服务器                                       │
    19→│                         106.37.170.238                                       │
    20→│                                                                             │
    21→│   ┌─────────────────────────┐     ┌─────────────────────────────────────┐   │
    22→│   │  前端 (Next.js)         │     │  后端 (FastAPI)                     │   │
    23→│   │  Port: 8232             │────►│  Port: 8100                         │   │
    24→│   │  Production Mode        │     │                                     │   │
    25→│   └─────────────────────────┘     └──────────────┬──────────────────────┘   │
    26→│                                                  │                          │
    27→│                                                  ▼                          │
    28→│                                   ┌─────────────────────────────────────┐   │
    29→│                                   │  PostgreSQL 16 + pgvector           │   │
    30→│                                   │  Port: 8224                         │   │
    31→│                                   └─────────────────────────────────────┘   │
    32→└─────────────────────────────────────────────────────────────────────────────┘
    33→```
    34→
    35→### 服务分布
    36→
    37→| 组件 | 位置 | 端口 | 运行模式 |
    38→|------|------|------|----------|
    39→| 前端 (Next.js) | aiscend 服务器 | 8232 | Production (`pnpm start`) |
    40→| 后端 (FastAPI) | aiscend 服务器 | 8100 | uvicorn |
    41→| 数据库 (PostgreSQL 16) | aiscend 服务器 | 8224 | - |
    42→
    43→---
    44→
    45→## 快速启动
    46→
    47→### 1. 启动后端 API (端口 8100)
    48→
    49→```bash
    50→cd /home/aiscend/work/vibelife/apps/api
    51→
    52→# 激活虚拟环境
    53→source venv/bin/activate
    54→
    55→# 使用测试环境配置
    56→cp /home/aiscend/work/vibelife/.env.test .env
    57→
    58→# 启动服务
    59→uvicorn main:app --port 8100 --host 0.0.0.0 --reload
    60→
    61→# 或后台运行
    62→nohup uvicorn main:app --host 0.0.0.0 --port 8100 > /tmp/vibelife-api.log 2>&1 &
    63→```
    64→
    65→### 2. 启动前端 Web (端口 8232)
    66→
    67→> **重要**: 必须使用生产模式运行，开发模式会导致静态资源 404 错误
    68→
    69→```bash
    70→cd /home/aiscend/work/vibelife/apps/web
    71→
    72→# 步骤 1: 构建生产版本 (必需)
    73→pnpm build
    74→
    75→# 步骤 2: 启动生产服务器
    76→pnpm start -H 0.0.0.0 -p 8232
    77→
    78→# 后台运行
    79→nohup pnpm start -H 0.0.0.0 -p 8232 > /tmp/vibelife-web-8232.log 2>&1 &
    80→```
    81→
    82→> 注意: 不要使用 `pnpm dev` 运行测试环境，会导致 `/_next/static/*` 资源 404
    83→
    84→### 3. 一键启动脚本
    85→
    86→创建 `~/start-test.sh`:
    87→
    88→```bash
    89→#!/bin/bash
    90→# VibeLife 测试环境启动脚本 v2.0
    91→
    92→set -e
    93→
    94→cd /home/aiscend/work/vibelife
    95→
    96→# 启动后端
    97→echo "Starting API on port 8100..."
    98→cd apps/api
    99→source venv/bin/activate
   100→nohup uvicorn main:app --host 0.0.0.0 --port 8100 > /tmp/vibelife-api.log 2>&1 &
   101→API_PID=$!
   102→echo "API PID: $API_PID"
   103→
   104→# 等待 API 启动
   105→sleep 3
   106→
   107→# 启动前端 (生产模式)
   108→echo "Starting Web on port 8232 (production mode)..."
   109→cd ../web
   110→
   111→# 检查是否需要重新构建
   112→if [ ! -d ".next" ] || [ "$(find src -newer .next -type f | head -1)" ]; then
   113→    echo "Building frontend..."
   114→    pnpm build
   115→fi
   116→
   117→nohup pnpm start -H 0.0.0.0 -p 8232 > /tmp/vibelife-web-8232.log 2>&1 &
   118→WEB_PID=$!
   119→echo "Web PID: $WEB_PID"
   120→
   121→# 等待服务启动
   122→sleep 5
   123→
   124→echo ""
   125→echo "=== VibeLife Test Environment ==="
   126→echo "API: http://106.37.170.238:8100"
   127→echo "Web: http://106.37.170.238:8232"
   128→echo ""
   129→echo "Health Check:"
   130→curl -s http://localhost:8100/health | head -1 || echo "API not ready"
   131→curl -s -o /dev/null -w "Web: %{http_code}\n" http://localhost:8232 || echo "Web not ready"
   132→echo ""
   133→echo "Logs:"
   134→echo "  API: tail -f /tmp/vibelife-api.log"
   135→echo "  Web: tail -f /tmp/vibelife-web-8232.log"
   136→```
   137→
   138→```bash
   139→chmod +x ~/start-test.sh
   140→~/start-test.sh
   141→```
   142→
   143→---
   144→
   145→## 停止服务
   146→
   147→```bash
   148→# 查找进程
   149→ps aux | grep -E "(uvicorn|next-server)" | grep -v grep
   150→
   151→# 停止后端
   152→pkill -f "uvicorn main:app.*8100"
   153→
   154→# 停止前端
   155→pkill -f "next.*8232"
   156→
   157→# 或一键停止
   158→pkill -f "uvicorn main:app" && pkill -f "next-server"
   159→```
   160→
   161→---
   162→
   163→## 环境要求
   164→
   165→### 系统要求
   166→- Node.js 18+
   167→- Python 3.11+
   168→- PostgreSQL 16+ (with pgvector extension)
   169→- CUDA (可选，用于 GPU 加速 embedding)
   170→
   171→### 云服务
   172→- Stripe 账户 (支付)
   173→- 智谱 API (LLM)
   174→- DeepSeek API (LLM)
   175→
   176→---
   177→
   178→## 环境变量配置
   179→
   180→### 后端环境变量 (.env)
   181→
   182→```bash
   183→# ─────────────────────────────────────────────────────────────────
   184→# 数据库
   185→# ─────────────────────────────────────────────────────────────────
   186→VIBELIFE_DB_URL=postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife
   187→VIBELIFE_DB_HOST=106.37.170.238
   188→VIBELIFE_DB_PORT=8224
   189→VIBELIFE_DB_NAME=vibelife
   190→VIBELIFE_DB_USER=postgres
   191→VIBELIFE_DB_PASSWORD=<PASSWORD>
   192→
   193→# ─────────────────────────────────────────────────────────────────
   194→# JWT 认证
   195→# ─────────────────────────────────────────────────────────────────
   196→VIBELIFE_JWT_SECRET=your-jwt-secret-key
   197→VIBELIFE_ACCESS_TOKEN_EXPIRE_MINUTES=60
   198→VIBELIFE_REFRESH_TOKEN_EXPIRE_DAYS=30
   199→
   200→# ─────────────────────────────────────────────────────────────────
   201→# API 配置 (测试环境端口)
   202→# ─────────────────────────────────────────────────────────────────
   203→VIBELIFE_API_HOST=0.0.0.0
   204→VIBELIFE_API_PORT=8100
   205→VIBELIFE_DEV=1
   206→
   207→# ─────────────────────────────────────────────────────────────────
   208→# CORS (测试环境)
   209→# ─────────────────────────────────────────────────────────────────
   210→VIBELIFE_CORS_ORIGINS=http://106.37.170.238:8232,http://localhost:8232,http://localhost:3000
   211→
   212→# ─────────────────────────────────────────────────────────────────
   213→# LLM 服务 - DeepSeek (主力)
   214→# ─────────────────────────────────────────────────────────────────
   215→DEEPSEEK_API_KEY=your-deepseek-api-key
   216→
   217→# ─────────────────────────────────────────────────────────────────
   218→# LLM 服务 - 智谱 GLM (备选)
   219→# ─────────────────────────────────────────────────────────────────
   220→GLM_API_KEY=your-glm-api-key
   221→GLM_CHAT_MODEL=glm-4.7
   222→GLM_VISION_MODEL=glm-4.6v
   223→GLM_BASE_URL=https://open.bigmodel.cn/api/paas/v4
   224→
   225→# ─────────────────────────────────────────────────────────────────
   226→# Claude (备选)
   227→# ─────────────────────────────────────────────────────────────────
   228→CLAUDE_API_KEY=your-claude-api-key
   229→
   230→# ─────────────────────────────────────────────────────────────────
   231→# 数据目录 (独立数据盘)
   232→# ─────────────────────────────────────────────────────────────────
   233→VIBELIFE_DATA_ROOT=/data/vibelife
   234→VIBELIFE_KNOWLEDGE_ROOT=/data/vibelife/knowledge
   235→VIBELIFE_UPLOADS_ROOT=/data/vibelife/uploads
   236→VIBELIFE_CACHE_ROOT=/data/vibelife/cache
   237→VIBELIFE_LOGS_ROOT=/data/vibelife/logs
   238→
   239→# ─────────────────────────────────────────────────────────────────
   240→# Embedding - BAAI/bge-m3 (本地)
   241→# ─────────────────────────────────────────────────────────────────
   242→EMBEDDING_MODEL_NAME=BAAI/bge-m3
   243→EMBEDDING_DIMENSION=1024
   244→EMBEDDING_DEVICE=cuda
   245→
   246→# ─────────────────────────────────────────────────────────────────
   247→# Stripe 支付
   248→# ─────────────────────────────────────────────────────────────────
   249→STRIPE_SECRET_KEY=sk_test_...
   250→STRIPE_PUBLISHABLE_KEY=pk_test_...
   251→STRIPE_WEBHOOK_SECRET=whsec_...
   252→```
   253→
   254→### 前端环境变量
   255→
   256→```bash
   257→# 测试环境 (apps/web/.env.local)
   258→NEXT_PUBLIC_API_URL=http://106.37.170.238:8100
   259→NEXT_PUBLIC_API_BASE=http://106.37.170.238:8100/api/v1
   260→NEXT_PUBLIC_WS_URL=ws://106.37.170.238:8100/ws
   261→
   262→# 内部 API (SSR) - 关键配置！
   263→# Next.js rewrites 使用此地址转发 /api/v1/* 请求到后端
   264→# 必须指向本地 API，不要使用外部 IP
   265→VIBELIFE_API_INTERNAL=http://127.0.0.1:8100
   266→```
   267→
   268→> **重要**: `VIBELIFE_API_INTERNAL` 是 API 路由的关键配置。前端通过 Next.js rewrites 将 `/api/v1/*` 请求转发到此地址。使用 `127.0.0.1:8100` 而非外部 IP，因为外部 IP 可能不可达或返回 503。
   269→
   270→---
   271→
   272→## 数据库初始化
   273→
   274→### 运行 Schema 迁移
   275→
   276→```bash
   277→# 连接数据库
   278→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife
   279→
   280→# 运行迁移
   281→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
   282→  -f /home/aiscend/work/vibelife/apps/api/stores/migrations/001_init.sql
   283→```
   284→
   285→### 验证表创建
   286→
   287→```bash
   288→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife \
   289→  -c "SELECT tablename FROM pg_tables WHERE schemaname = 'public' ORDER BY tablename;"
   290→```
   291→
   292→---
   293→
   294→## 健康检查
   295→
   296→```bash
   297→# API 健康检查
   298→curl http://106.37.170.238:8100/health
   299→# 期望输出: {"status":"ok","service":"vibelife-api","version":"6.9.0","database":"ok"}
   300→
   301→# 前端检查
   302→curl -I http://106.37.170.238:8232
   303→# 期望: HTTP/1.1 200 OK
   304→
   305→# 数据库检查
   306→psql postgresql://postgres:<PASSWORD>@106.37.170.238:8224/vibelife -c "SELECT 1"
   307→```
   308→
   309→---
   310→
   311→## API 端点验证
   312→
   313→部署完成后，验证以下核心端点:
   314→
   315→```bash
   316→# 1. 健康检查
   317→curl http://106.37.170.238:8100/health
   318→
   319→# 2. 对话 API (SSE)
   320→curl -X POST http://106.37.170.238:8100/api/v1/chat/v5/stream \
   321→  -H "Content-Type: application/json" \
   322→  -d '{"message": "你好", "skill": "bazi"}'
   323→
   324→# 3. 工具 Schema
   325→curl http://106.37.170.238:8100/api/v1/tools/schema
   326→
   327→# 4. Skill 列表
   328→curl http://106.37.170.238:8100/api/v1/skills
   329→```
   330→
   331→---
   332→
   333→## 查看日志
   334→
   335→```bash
   336→# API 日志
   337→tail -f /tmp/vibelife-api.log
   338→
   339→# Web 日志
   340→tail -f /tmp/vibelife-web-8232.log
   341→
   342→# API 请求日志
   343→tail -f /data/vibelife/logs/api_requests.log
   344→```
   345→
   346→---
   347→
   348→## 端口检查
   349→
   350→```bash
   351→# 检查端口占用
   352→lsof -i :8100  # API
   353→lsof -i :8232  # Web
   354→lsof -i :8224  # PostgreSQL
   355→
   356→# 检查所有 vibelife 相关端口
   357→netstat -tuln | grep -E "(8100|8232|8224)"
   358→```
   359→
   360→---
   361→
   362→## 故障排查
   363→
   364→### 1. API 无法访问
   365→
   366→```bash
   367→# 检查进程
   368→ps aux | grep uvicorn
   369→
   370→# 检查端口
   371→netstat -tlnp | grep 8100
   372→
   373→# 检查防火墙
   374→sudo ufw status
   375→```
   376→
   377→### 2. 数据库连接失败
   378→
   379→```bash
   380→# 测试连接
   381→PGPASSWORD="<PASSWORD>" psql -h 106.37.170.238 -p 8224 -U postgres -d vibelife -c "SELECT 1"
   382→
   383→# 检查 PostgreSQL 状态
   384→systemctl status postgresql
   385→```
   386→
   387→### 3. LLM 调用失败
   388→
   389→```bash
   390→# 检查环境变量
   391→echo $DEEPSEEK_API_KEY
   392→echo $GLM_API_KEY
   393→
   394→# 查看 config/models.yaml 配置
   395→cat /home/aiscend/work/vibelife/apps/api/config/models.yaml
   396→```
   397→
   398→### 4. 前端无法调用 API / Chat 发送失败
   399→
   400→**常见原因**:
   401→1. `VIBELIFE_API_INTERNAL` 配置错误或未设置
   402→2. API 服务未运行在 localhost:8100
   403→3. 外部 IP (106.37.170.238:8100) 返回 503
   404→
   405→**排查步骤**:
   406→```bash
   407→# 1. 检查本地 API 是否运行
   408→curl http://127.0.0.1:8100/health
   409→
   410→# 2. 测试 chat 端点
   411→curl -X POST http://127.0.0.1:8100/api/v1/chat/v5/stream \
   412→  -H "Content-Type: application/json" \
   413→  -d '{"message": "hi"}'
   414→
   415→# 3. 通过 Web rewrite 测试 (确保 Web 在运行)
   416→curl http://localhost:8232/api/v1/chat/v5/stream \
   417→  -H "Content-Type: application/json" \
   418→  -d '{"message": "hi"}'
   419→```
   420→
   421→**解决方案**:
   422→- 确保 `VIBELIFE_API_INTERNAL=http://127.0.0.1:8100` 在启动 Web 时设置
   423→- 如果直接启动: `VIBELIFE_API_INTERNAL=http://127.0.0.1:8100 pnpm dev -p 8232`
   424→- 检查 CORS 配置是否包含前端域名
   425→- 查看浏览器 Network 面板的错误信息
   426→
   427→### 5. 静态资源 404 错误
   428→
   429→如果浏览器控制台出现 `/_next/static/*` 404 错误：
   430→
   431→```bash
   432→# 原因: 使用了开发模式运行，或构建产物过期
   433→
   434→# 解决方案:
   435→cd /home/aiscend/work/vibelife/apps/web
   436→
   437→# 1. 停止旧进程
   438→pkill -f "next.*8232"
   439→
   440→# 2. 重新构建
   441→pnpm build
   442→
   443→# 3. 以生产模式启动
   444→nohup pnpm start -H 0.0.0.0 -p 8232 > /tmp/vibelife-web-8232.log 2>&1 &
   445→
   446→# 4. 验证
   447→curl -I http://106.37.170.238:8232/_next/static/css/*.css
   448→# 应返回 200 OK
   449→```
   450→
   451→### 6. TypeScript 构建错误
   452→
   453→```bash
   454→# 清理缓存
   455→cd /home/aiscend/work/vibelife/apps/web
   456→rm -rf .next
   457→pnpm build
   458→```
   459→
   460→---
   461→
   462→## 与生产环境对比
   463→
   464→| 项目 | 测试环境 | 生产环境 |
   465→|------|----------|----------|
   466→| 用户 | aiscend | vibelife |
   467→| API 端口 | 8100 | 8000 |
   468→| Web 端口 | 8232 | 8230 |
   469→| 工作目录 | /home/aiscend/work/vibelife | /home/vibelife/vibelife |
   470→| 启动方式 | 手动/脚本 | Systemd |
   471→| 前端模式 | Production (`pnpm start`) | Production |
   472→| 域名 | IP:Port | vibelife.app |
   473→
   474→---
   475→
   476→## 安全建议
   477→
   478→1. **API 密钥**: 使用环境变量，不要提交到代码库
   479→2. **CORS**: 限制允许的来源域名
   480→3. **防火墙**: 只开放必要端口 (8100, 8224, 8232)
   481→4. **日志脱敏**: 不要记录敏感信息
   482→5. **定期更新**: 保持依赖包更新
   483→6. **数据库**: 使用强密码，限制访问 IP
   484→
   485→---
   486→
   487→## 版本历史
   488→
   489→| 版本 | 日期 | 说明 |
   490→|------|------|------|
   491→| v7.0 | 2026-01-19 | 添加 Chat 发送失败故障排查，强调 VIBELIFE_API_INTERNAL 配置重要性 |
   492→| v6.9 | 2026-01-19 | 修复静态资源404问题，强制使用生产模式运行前端 |
   493→| v6.8 | 2026-01-17 | 初始版本，基于 deployment.md 适配测试端口 |
   494→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
