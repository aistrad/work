     1â†’"""
     2â†’Unified Skill Gateway - ç»Ÿä¸€ Skill API å…¥å£
     3â†’
     4â†’æ‰€æœ‰ Skill æ•°æ®æœåŠ¡é€šè¿‡æ­¤è·¯ç”±è®¿é—®:
     5â†’- POST /api/v1/skills/{skill_id}/{action}
     6â†’- GET /api/v1/skills/{skill_id}/services
     7â†’- GET /api/v1/skills
     8â†’
     9â†’v7.4 æ–°å¢è®¢é˜…ç®¡ç†ç«¯ç‚¹:
    10â†’- GET /api/v1/skills/subscriptions
    11â†’- POST /api/v1/skills/{skill_id}/subscribe
    12â†’- POST /api/v1/skills/{skill_id}/unsubscribe
    13â†’- POST /api/v1/skills/{skill_id}/push
    14â†’- GET /api/v1/skills/recommendations
    15â†’- GET /api/v1/skills/featured
    16â†’
    17â†’v7.5 æ–°å¢:
    18â†’- æ•°æ®åº“ä¼˜å…ˆå…ƒæ•°æ®åŠ è½½ï¼ˆskill_catalog è¡¨ï¼‰
    19â†’- async å‡½æ•°æ”¯æŒï¼ŒSKILL.md ä½œä¸º fallback
    20â†’
    21â†’ç¤ºä¾‹:
    22â†’- POST /api/v1/skills/bazi/chart
    23â†’- POST /api/v1/skills/zodiac/fortune
    24â†’- POST /api/v1/skills/tarot/draw
    25â†’"""
    26â†’import logging
    27â†’from datetime import datetime
    28â†’from typing import Optional, Dict, Any, List
    29â†’from uuid import UUID
    30â†’
    31â†’from fastapi import APIRouter, Depends, HTTPException, Header, Query
    32â†’from pydantic import BaseModel, Field
    33â†’
    34â†’from services.identity import get_optional_user, get_current_user, CurrentUser
    35â†’from services.agent.skill_service_registry import (
    36â†’    SkillServiceRegistry, ServiceContext
    37â†’)
    38â†’# v7.5: ä¼˜å…ˆä½¿ç”¨ async å‡½æ•°ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰ï¼Œsync å‡½æ•°ä½œä¸º fallback
    39â†’from services.agent.skill_loader import (
    40â†’    load_skill_metadata, get_all_skill_metadata, get_skills_by_category,
    41â†’    load_skill_metadata_async, get_all_skill_metadata_async, get_skills_by_category_async,
    42â†’    get_featured_skills_async, get_skill_categories_summary_async,
    43â†’)
    44â†’from stores.profile_cache import get_cached_profile_with_skill
    45â†’# v7.6: ä½¿ç”¨ UnifiedProfileRepository æ›¿ä»£åˆ†æ•£çš„ Repository
    46â†’from stores.unified_profile_repo import UnifiedProfileRepository
    47â†’
    48â†’router = APIRouter(prefix="/skills", tags=["Skills"])
    49â†’logger = logging.getLogger(__name__)
    50â†’
    51â†’
    52â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    53â†’# Request/Response Models
    54â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    55â†’
    56â†’class SkillRequest(BaseModel):
    57â†’    """é€šç”¨ Skill è¯·æ±‚"""
    58â†’    args: Dict[str, Any] = Field(default_factory=dict, description="æœåŠ¡å‚æ•°")
    59â†’
    60â†’
    61â†’class SkillResponse(BaseModel):
    62â†’    """é€šç”¨ Skill å“åº”"""
    63â†’    status: str = "success"
    64â†’    data: Optional[Dict[str, Any]] = None
    65â†’    error: Optional[str] = None
    66â†’
    67â†’
    68â†’class ServiceInfo(BaseModel):
    69â†’    """æœåŠ¡ä¿¡æ¯"""
    70â†’    skill_id: str
    71â†’    action: str
    72â†’    description: str = ""
    73â†’    auth_required: bool = True
    74â†’    entitlement: Optional[str] = None
    75â†’
    76â†’
    77â†’# v7.4: è®¢é˜…ç®¡ç†ç›¸å…³æ¨¡å‹
    78â†’class SubscribeRequest(BaseModel):
    79â†’    """è®¢é˜…è¯·æ±‚"""
    80â†’    push_enabled: bool = True
    81â†’
    82â†’
    83â†’class PushToggleRequest(BaseModel):
    84â†’    """æ¨é€å¼€å…³è¯·æ±‚"""
    85â†’    enabled: bool
    86â†’
    87â†’
    88â†’class SkillUserStatus(BaseModel):
    89â†’    """ç”¨æˆ·å¯¹ Skill çš„çŠ¶æ€"""
    90â†’    subscribed: bool = False
    91â†’    push_enabled: bool = False
    92â†’    trial_messages_used: int = 0
    93â†’    trial_messages_remaining: Optional[int] = None
    94â†’
    95â†’
    96â†’class SkillWithStatus(BaseModel):
    97â†’    """å¸¦ç”¨æˆ·çŠ¶æ€çš„ Skill ä¿¡æ¯"""
    98â†’    id: str
    99â†’    name: str
   100â†’    description: str
   101â†’    icon: str = "ğŸ’¡"
   102â†’    color: str = "#6B7280"
   103â†’    category: str
   104â†’    pricing: Dict[str, Any]
   105â†’    features: List[Dict[str, Any]] = []
   106â†’    showcase: Dict[str, Any] = {}
   107â†’    triggers: List[str] = []
   108â†’    user_status: Optional[SkillUserStatus] = None
   109â†’
   110â†’
   111â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   112â†’# Helper Functions
   113â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   114â†’
   115â†’async def build_service_context(
   116â†’    user_id: Optional[UUID],
   117â†’    skill_id: str,
   118â†’    user_tier: str = "free"
   119â†’) -> ServiceContext:
   120â†’    """æ„å»ºæœåŠ¡ä¸Šä¸‹æ–‡"""
   121â†’    profile = {}
   122â†’    skill_data = {}
   123â†’
   124â†’    if user_id:
   125â†’        try:
   126â†’            result = await get_cached_profile_with_skill(user_id, skill_id)
   127â†’            profile = result.get("profile", {})
   128â†’            skill_data = result.get("skill_data", {})
   129â†’        except Exception as e:
   130â†’            logger.warning(f"Failed to get user context: {e}")
   131â†’
   132â†’    return ServiceContext(
   133â†’        user_id=str(user_id) if user_id else None,
   134â†’        user_tier=user_tier,
   135â†’        profile=profile,
   136â†’        skill_data=skill_data
   137â†’    )
   138â†’
   139â†’
   140â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   141â†’# Endpoints
   142â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   143â†’
   144â†’@router.get("")
   145â†’async def list_skills(
   146â†’    category: Optional[str] = Query(None, description="æŒ‰åˆ†ç±»ç­›é€‰: core, default, professional"),
   147â†’    subscribed: Optional[bool] = Query(None, description="åªè¿”å›å·²è®¢é˜…çš„ Skill"),
   148â†’    current_user: Optional[CurrentUser] = Depends(get_optional_user),
   149â†’):
   150â†’    """
   151â†’    è·å–æ‰€æœ‰ Skill åˆ—è¡¨ï¼ˆå¸¦å…ƒæ•°æ®å’Œè®¢é˜…çŠ¶æ€ï¼‰
   152â†’
   153â†’    v7.5: ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆåŠ è½½ï¼Œæ”¯æŒåŠ¨æ€é…ç½®
   154â†’
   155â†’    Args:
   156â†’        category: æŒ‰åˆ†ç±»ç­›é€‰ (core/default/professional)
   157â†’        subscribed: åªè¿”å›å·²è®¢é˜…çš„ Skill
   158â†’
   159â†’    Returns:
   160â†’        skills: Skill åˆ—è¡¨ï¼ŒåŒ…å«å…ƒæ•°æ®å’Œç”¨æˆ·è®¢é˜…çŠ¶æ€
   161â†’        categories: åˆ†ç±»ç»Ÿè®¡
   162â†’        total: æ€»æ•°
   163â†’    """
   164â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°ï¼ˆæ•°æ®åº“ä¼˜å…ˆï¼‰
   165â†’    if category:
   166â†’        all_metadata = await get_skills_by_category_async(category)
   167â†’    else:
   168â†’        all_metadata = await get_all_skill_metadata_async()
   169â†’
   170â†’    # è·å–ç”¨æˆ·è®¢é˜…çŠ¶æ€
   171â†’    user_statuses = {}
   172â†’    if current_user:
   173â†’        subscriptions = await UnifiedProfileRepository.get_user_subscriptions(current_user.user_id)
   174â†’        user_statuses = {s.skill_id: s for s in subscriptions}
   175â†’
   176â†’    # æ„å»ºå“åº”
   177â†’    skills = []
   178â†’    for metadata in all_metadata:
   179â†’        skill_dict = metadata.to_dict()
   180â†’        sub = user_statuses.get(metadata.id)
   181â†’
   182â†’        # è®¡ç®—è¯•ç”¨å‰©ä½™æ¬¡æ•°
   183â†’        trial_limit = metadata.pricing.trial_messages if metadata.pricing.type != "free" else None
   184â†’        trial_used = sub.trial_messages_used if sub else 0
   185â†’
   186â†’        skill_dict["user_status"] = {
   187â†’            "subscribed": sub.status == "subscribed" if sub else False,
   188â†’            "push_enabled": sub.push_enabled if sub else False,
   189â†’            "trial_messages_used": trial_used,
   190â†’            "trial_messages_remaining": (trial_limit - trial_used) if trial_limit else None,
   191â†’        }
   192â†’
   193â†’        # ç­›é€‰å·²è®¢é˜…
   194â†’        if subscribed is not None:
   195â†’            is_subscribed = skill_dict["user_status"]["subscribed"]
   196â†’            if subscribed and not is_subscribed:
   197â†’                continue
   198â†’            if not subscribed and is_subscribed:
   199â†’                continue
   200â†’
   201â†’        skills.append(skill_dict)
   202â†’
   203â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°è·å–åˆ†ç±»ç»Ÿè®¡
   204â†’    categories = await get_skill_categories_summary_async()
   205â†’
   206â†’    return {"skills": skills, "categories": categories, "total": len(skills)}
   207â†’
   208â†’
   209â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   210â†’# è®¢é˜…ç®¡ç†ç«¯ç‚¹ (v7.4)
   211â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   212â†’
   213â†’@router.get("/subscriptions")
   214â†’async def get_subscriptions(current_user: CurrentUser = Depends(get_current_user)):
   215â†’    """
   216â†’    è·å–ç”¨æˆ·è®¢é˜…åˆ—è¡¨
   217â†’
   218â†’    v7.5: ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆåŠ è½½
   219â†’
   220â†’    Returns:
   221â†’        subscriptions: æ‰€æœ‰ Skill çš„è®¢é˜…çŠ¶æ€åˆ—è¡¨
   222â†’        summary: ç»Ÿè®¡æ‘˜è¦
   223â†’    """
   224â†’    subscriptions = await UnifiedProfileRepository.get_user_subscriptions(current_user.user_id)
   225â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°
   226â†’    all_skills = await get_all_skill_metadata_async()
   227â†’
   228â†’    result = []
   229â†’    for skill in all_skills:
   230â†’        sub = next((s for s in subscriptions if s.skill_id == skill.id), None)
   231â†’        result.append({
   232â†’            "skill_id": skill.id,
   233â†’            "skill_name": skill.name,
   234â†’            "status": sub.status if sub else "not_subscribed",
   235â†’            "push_enabled": sub.push_enabled if sub else False,
   236â†’            "subscribed_at": sub.subscribed_at.isoformat() if sub and sub.subscribed_at else None,
   237â†’            "can_unsubscribe": skill.subscription.can_unsubscribe,
   238â†’            "trial_messages_used": sub.trial_messages_used if sub else 0,
   239â†’        })
   240â†’
   241â†’    return {
   242â†’        "subscriptions": result,
   243â†’        "summary": {
   244â†’            "total_subscribed": len([s for s in result if s["status"] == "subscribed"]),
   245â†’            "total_available": len(all_skills),
   246â†’            "push_enabled_count": len([s for s in result if s["push_enabled"]]),
   247â†’        }
   248â†’    }
   249â†’
   250â†’
   251â†’@router.get("/recommendations")
   252â†’async def get_recommendations(
   253â†’    limit: int = Query(default=3, le=10, description="è¿”å›æ•°é‡"),
   254â†’    context: Optional[str] = Query(None, description="å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡"),
   255â†’    current_user: CurrentUser = Depends(get_current_user),
   256â†’):
   257â†’    """
   258â†’    è·å–æ¨è Skill
   259â†’
   260â†’    v7.5: ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆåŠ è½½
   261â†’
   262â†’    åŸºäºç”¨æˆ·æ¡£æ¡ˆã€ä½¿ç”¨å†å²å’Œå¯¹è¯ä¸Šä¸‹æ–‡æ¨è Skillã€‚
   263â†’
   264â†’    Args:
   265â†’        limit: è¿”å›æ•°é‡ï¼Œé»˜è®¤ 3ï¼Œæœ€å¤§ 10
   266â†’        context: å½“å‰å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆå…³é”®è¯ï¼‰
   267â†’
   268â†’    Returns:
   269â†’        recommendations: æ¨è Skill åˆ—è¡¨
   270â†’    """
   271â†’    # è·å–ç”¨æˆ·å·²è®¢é˜…å’Œå·²å±è”½çš„ Skill
   272â†’    subscribed_ids = await UnifiedProfileRepository.get_subscribed_skill_ids(current_user.user_id)
   273â†’    blocked_ids = await UnifiedProfileRepository.get_blocked_skills(current_user.user_id)
   274â†’
   275â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°
   276â†’    all_skills = await get_all_skill_metadata_async()
   277â†’
   278â†’    # è¿‡æ»¤ï¼šæœªè®¢é˜… + æœªå±è”½ + é core
   279â†’    candidates = [
   280â†’        s for s in all_skills
   281â†’        if s.id not in subscribed_ids
   282â†’        and s.id not in blocked_ids
   283â†’        and s.category != "core"
   284â†’    ]
   285â†’
   286â†’    recommendations = []
   287â†’    for skill in candidates[:limit]:
   288â†’        # ç®€å•æ¨èé€»è¾‘ï¼šåŸºäºè§¦å‘è¯åŒ¹é…
   289â†’        reason = "featured"
   290â†’        context_text = f"è¯•è¯•ã€Œ{skill.name}ã€ï¼Œ{skill.showcase.tagline or skill.description}"
   291â†’
   292â†’        if context:
   293â†’            # æ£€æŸ¥ä¸Šä¸‹æ–‡æ˜¯å¦åŒ¹é…è§¦å‘è¯
   294â†’            for trigger in skill.triggers:
   295â†’                if trigger in context:
   296â†’                    reason = "based_on_conversation"
   297â†’                    context_text = f"ä½ æåˆ°äº†ã€Œ{trigger}ã€ï¼Œ{skill.name} å¯ä»¥å¸®åŠ©ä½ ã€‚"
   298â†’                    break
   299â†’
   300â†’        # è·å–è¯•ç”¨æ¬¡æ•°
   301â†’        trial_used = await UnifiedProfileRepository.get_trial_usage(current_user.user_id, skill.id)
   302â†’        trial_remaining = skill.pricing.trial_messages - trial_used if skill.pricing.type != "free" else None
   303â†’
   304â†’        recommendations.append({
   305â†’            "skill_id": skill.id,
   306â†’            "skill": {
   307â†’                "id": skill.id,
   308â†’                "name": skill.name,
   309â†’                "icon": skill.icon,
   310â†’                "color": skill.color,
   311â†’                "tagline": skill.showcase.tagline,
   312â†’            },
   313â†’            "reason": reason,
   314â†’            "context": context_text,
   315â†’            "score": 0.8,
   316â†’            "trial_messages_remaining": trial_remaining,
   317â†’        })
   318â†’
   319â†’    return {
   320â†’        "recommendations": recommendations,
   321â†’        "generated_at": datetime.utcnow().isoformat(),
   322â†’    }
   323â†’
   324â†’
   325â†’@router.get("/featured")
   326â†’async def get_featured():
   327â†’    """
   328â†’    è·å–ç²¾é€‰ Skillï¼ˆç”¨äºé¦–é¡µè½®æ’­ç­‰ï¼‰
   329â†’
   330â†’    v7.5: ä»æ•°æ®åº“ skill_catalog è¯»å– is_featured=true çš„è®°å½•
   331â†’
   332â†’    Returns:
   333â†’        featured: ç²¾é€‰ Skill åˆ—è¡¨
   334â†’    """
   335â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°ä»æ•°æ®åº“è·å–ç²¾é€‰åˆ—è¡¨
   336â†’    featured_skills = await get_featured_skills_async()
   337â†’
   338â†’    featured = []
   339â†’    for idx, metadata in enumerate(featured_skills):
   340â†’        featured.append({
   341â†’            "skill_id": metadata.id,
   342â†’            "skill": {
   343â†’                "id": metadata.id,
   344â†’                "name": metadata.name,
   345â†’                "icon": metadata.icon,
   346â†’                "color": metadata.color,
   347â†’                "tagline": metadata.showcase.tagline,
   348â†’                "preview_image": metadata.showcase.preview_image,
   349â†’            },
   350â†’            "position": idx + 1,
   351â†’            "campaign": None,  # å¯æ‰©å±•ä¸ºä» featured_campaign å­—æ®µè¯»å–
   352â†’        })
   353â†’
   354â†’    return {"featured": featured}
   355â†’
   356â†’
   357â†’@router.get("/{skill_id}")
   358â†’async def get_skill_detail(
   359â†’    skill_id: str,
   360â†’    current_user: Optional[CurrentUser] = Depends(get_optional_user),
   361â†’):
   362â†’    """
   363â†’    è·å–å•ä¸ª Skill è¯¦æƒ…
   364â†’
   365â†’    v7.5: ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆåŠ è½½
   366â†’
   367â†’    Args:
   368â†’        skill_id: Skill ID
   369â†’
   370â†’    Returns:
   371â†’        skill: Skill å®Œæ•´è¯¦æƒ…
   372â†’        user_status: ç”¨æˆ·è®¢é˜…çŠ¶æ€ï¼ˆå¦‚å·²ç™»å½•ï¼‰
   373â†’    """
   374â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°
   375â†’    metadata = await load_skill_metadata_async(skill_id)
   376â†’    if not metadata:
   377â†’        raise HTTPException(status_code=404, detail="Skill not found")
   378â†’
   379â†’    skill_dict = metadata.to_dict()
   380â†’
   381â†’    # è·å–æœåŠ¡åˆ—è¡¨
   382â†’    services = SkillServiceRegistry.list_services(skill_id)
   383â†’    skill_dict["services"] = services or []
   384â†’
   385â†’    # è·å–ç”¨æˆ·çŠ¶æ€
   386â†’    user_status = None
   387â†’    if current_user:
   388â†’        sub = await UnifiedProfileRepository.get_skill_subscription(current_user.user_id, skill_id)
   389â†’        if sub:
   390â†’            trial_limit = metadata.pricing.trial_messages if metadata.pricing.type != "free" else None
   391â†’            user_status = {
   392â†’                "subscribed": sub.status == "subscribed",
   393â†’                "push_enabled": sub.push_enabled,
   394â†’                "subscribed_at": sub.subscribed_at.isoformat() if sub.subscribed_at else None,
   395â†’                "trial_messages_used": sub.trial_messages_used,
   396â†’                "trial_messages_remaining": (trial_limit - sub.trial_messages_used) if trial_limit else None,
   397â†’            }
   398â†’
   399â†’    return {"skill": skill_dict, "user_status": user_status}
   400â†’
   401â†’
   402â†’@router.post("/{skill_id}/subscribe")
   403â†’async def subscribe_skill(
   404â†’    skill_id: str,
   405â†’    request: SubscribeRequest,
   406â†’    current_user: CurrentUser = Depends(get_current_user),
   407â†’):
   408â†’    """
   409â†’    è®¢é˜… Skill
   410â†’
   411â†’    v7.5: ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆåŠ è½½
   412â†’    v7.6: æ·»åŠ  Premium æ£€æŸ¥
   413â†’
   414â†’    Args:
   415â†’        skill_id: Skill ID
   416â†’        request: è®¢é˜…è¯·æ±‚ï¼ˆpush_enabledï¼‰
   417â†’
   418â†’    Returns:
   419â†’        success: æ˜¯å¦æˆåŠŸ
   420â†’        subscription: è®¢é˜…çŠ¶æ€
   421â†’        message: æç¤ºæ¶ˆæ¯
   422â†’    """
   423â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°
   424â†’    metadata = await load_skill_metadata_async(skill_id)
   425â†’    if not metadata:
   426â†’        raise HTTPException(status_code=404, detail="Skill not found")
   427â†’
   428â†’    # æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
   429â†’    existing = await UnifiedProfileRepository.get_skill_subscription(current_user.user_id, skill_id)
   430â†’    if existing and existing.status == "subscribed":
   431â†’        raise HTTPException(status_code=400, detail="Already subscribed")
   432â†’
   433â†’    # v7.6: Premium æ£€æŸ¥
   434â†’    if metadata.pricing.type == "premium":
   435â†’        trial_used = existing.trial_messages_used if existing else 0
   436â†’        trial_limit = metadata.pricing.trial_messages
   437â†’
   438â†’        if trial_used >= trial_limit:
   439â†’            # è¯•ç”¨å·²ç”¨å®Œï¼Œæ£€æŸ¥ Premium çŠ¶æ€
   440â†’            from services.entitlement import EntitlementService
   441â†’            entitlements = await EntitlementService.get_entitlements(current_user.user_id)
   442â†’
   443â†’            if entitlements.get("tier") != "paid":
   444â†’                raise HTTPException(
   445â†’                    status_code=402,
   446â†’                    detail={
   447â†’                        "code": "PREMIUM_REQUIRED",
   448â†’                        "message": f"è®¢é˜…ã€Œ{metadata.name}ã€éœ€è¦ Premium ä¼šå‘˜",
   449â†’                        "skill_id": skill_id,
   450â†’                        "trial_exhausted": True,
   451â†’                        "trial_used": trial_used,
   452â†’                        "trial_limit": trial_limit,
   453â†’                    }
   454â†’                )
   455â†’
   456â†’    # åˆ›å»º/æ›´æ–°è®¢é˜…
   457â†’    subscription = await UnifiedProfileRepository.subscribe(
   458â†’        user_id=current_user.user_id,
   459â†’        skill_id=skill_id,
   460â†’        push_enabled=request.push_enabled,
   461â†’    )
   462â†’
   463â†’    return {
   464â†’        "success": True,
   465â†’        "subscription": subscription.to_dict(),
   466â†’        "message": f"å·²æˆåŠŸè®¢é˜…ã€Œ{metadata.name}ã€",
   467â†’    }
   468â†’
   469â†’
   470â†’@router.post("/{skill_id}/unsubscribe")
   471â†’async def unsubscribe_skill(
   472â†’    skill_id: str,
   473â†’    current_user: CurrentUser = Depends(get_current_user),
   474â†’):
   475â†’    """
   476â†’    å–æ¶ˆè®¢é˜… Skill
   477â†’
   478â†’    v7.5: ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆåŠ è½½
   479â†’
   480â†’    Args:
   481â†’        skill_id: Skill ID
   482â†’
   483â†’    Returns:
   484â†’        success: æ˜¯å¦æˆåŠŸ
   485â†’        subscription: è®¢é˜…çŠ¶æ€
   486â†’        message: æç¤ºæ¶ˆæ¯
   487â†’    """
   488â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°
   489â†’    metadata = await load_skill_metadata_async(skill_id)
   490â†’    if not metadata:
   491â†’        raise HTTPException(status_code=404, detail="Skill not found")
   492â†’
   493â†’    # Core Skill ä¸å¯å–æ¶ˆ
   494â†’    if not metadata.subscription.can_unsubscribe:
   495â†’        raise HTTPException(status_code=400, detail="This skill cannot be unsubscribed")
   496â†’
   497â†’    # æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
   498â†’    existing = await UnifiedProfileRepository.get_skill_subscription(current_user.user_id, skill_id)
   499â†’    if not existing or existing.status != "subscribed":
   500â†’        raise HTTPException(status_code=400, detail="Not subscribed")
   501â†’
   502â†’    # å–æ¶ˆè®¢é˜…
   503â†’    subscription = await UnifiedProfileRepository.unsubscribe(current_user.user_id, skill_id)
   504â†’
   505â†’    return {
   506â†’        "success": True,
   507â†’        "subscription": subscription.to_dict(),
   508â†’        "message": f"å·²å–æ¶ˆè®¢é˜…ã€Œ{metadata.name}ã€",
   509â†’    }
   510â†’
   511â†’
   512â†’@router.post("/{skill_id}/push")
   513â†’async def toggle_push(
   514â†’    skill_id: str,
   515â†’    request: PushToggleRequest,
   516â†’    current_user: CurrentUser = Depends(get_current_user),
   517â†’):
   518â†’    """
   519â†’    åˆ‡æ¢æ¨é€å¼€å…³
   520â†’
   521â†’    v7.5: ä½¿ç”¨æ•°æ®åº“ä¼˜å…ˆåŠ è½½
   522â†’
   523â†’    Args:
   524â†’        skill_id: Skill ID
   525â†’        request: æ¨é€å¼€å…³è¯·æ±‚
   526â†’
   527â†’    Returns:
   528â†’        success: æ˜¯å¦æˆåŠŸ
   529â†’        subscription: è®¢é˜…çŠ¶æ€
   530â†’        message: æç¤ºæ¶ˆæ¯
   531â†’    """
   532â†’    # v7.5: ä½¿ç”¨ async å‡½æ•°
   533â†’    metadata = await load_skill_metadata_async(skill_id)
   534â†’    if not metadata:
   535â†’        raise HTTPException(status_code=404, detail="Skill not found")
   536â†’
   537â†’    # æ£€æŸ¥æ˜¯å¦å·²è®¢é˜…
   538â†’    existing = await UnifiedProfileRepository.get_skill_subscription(current_user.user_id, skill_id)
   539â†’    if not existing or existing.status != "subscribed":
   540â†’        raise HTTPException(status_code=400, detail="Not subscribed")
   541â†’
   542â†’    # æ›´æ–°æ¨é€çŠ¶æ€
   543â†’    subscription = await UnifiedProfileRepository.update_push(
   544â†’        user_id=current_user.user_id,
   545â†’        skill_id=skill_id,
   546â†’        enabled=request.enabled,
   547â†’    )
   548â†’
   549â†’    action = "å¼€å¯" if request.enabled else "å…³é—­"
   550â†’    return {
   551â†’        "success": True,
   552â†’        "subscription": subscription.to_dict() if subscription else None,
   553â†’        "message": f"å·²{action}ã€Œ{metadata.name}ã€çš„æ¨é€é€šçŸ¥",
   554â†’    }
   555â†’
   556â†’
   557â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   558â†’# åŸæœ‰æœåŠ¡ç«¯ç‚¹
   559â†’# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   560â†’
   561â†’@router.get("/{skill_id}/services")
   562â†’async def list_skill_services(skill_id: str):
   563â†’    """
   564â†’    åˆ—å‡º Skill çš„æ‰€æœ‰æœåŠ¡
   565â†’
   566â†’    Args:
   567â†’        skill_id: Skill æ ‡è¯† (bazi, zodiac, tarot, career)
   568â†’
   569â†’    Returns:
   570â†’        services: æœåŠ¡åˆ—è¡¨
   571â†’    """
   572â†’    services = SkillServiceRegistry.list_services(skill_id)
   573â†’    if not services:
   574â†’        raise HTTPException(
   575â†’            status_code=404,
   576â†’            detail=f"No services found for skill: {skill_id}"
   577â†’        )
   578â†’    return {"skill_id": skill_id, "services": services}
   579â†’
   580â†’
   581â†’@router.post("/{skill_id}/{action}")
   582â†’async def execute_skill_service(
   583â†’    skill_id: str,
   584â†’    action: str,
   585â†’    request: SkillRequest,
   586â†’    current_user: Optional[CurrentUser] = Depends(get_optional_user),
   587â†’    x_test_tier: Optional[str] = Header(None, alias="x-test-tier")
   588â†’):
   589â†’    """
   590â†’    æ‰§è¡Œ Skill æœåŠ¡
   591â†’
   592â†’    Args:
   593â†’        skill_id: Skill æ ‡è¯† (bazi, zodiac, tarot, career)
   594â†’        action: æœåŠ¡åŠ¨ä½œ (chart, fortune, draw, etc.)
   595â†’        request: è¯·æ±‚å‚æ•°
   596â†’
   597â†’    Returns:
   598â†’        æœåŠ¡æ‰§è¡Œç»“æœ
   599â†’
   600â†’    Examples:
   601â†’        POST /api/v1/skills/bazi/chart
   602â†’        {"args": {"birth_date": "1990-01-01", "birth_time": "12:00"}}
   603â†’
   604â†’        POST /api/v1/skills/zodiac/fortune
   605â†’        {"args": {"date": "2026-01-15"}}
   606â†’    """
   607â†’    # æ£€æŸ¥æœåŠ¡æ˜¯å¦å­˜åœ¨
   608â†’    if not SkillServiceRegistry.has_service(skill_id, action):
   609â†’        raise HTTPException(
   610â†’            status_code=404,
   611â†’            detail=f"Service not found: {skill_id}/{action}"
   612â†’        )
   613â†’
   614â†’    # è·å–æœåŠ¡å®šä¹‰
   615â†’    service_def = SkillServiceRegistry.get_service(skill_id, action)
   616â†’
   617â†’    # æ£€æŸ¥è®¤è¯è¦æ±‚
   618â†’    if service_def.auth_required and not current_user:
   619â†’        raise HTTPException(
   620â†’            status_code=401,
   621â†’            detail="Authentication required"
   622â†’        )
   623â†’
   624â†’    # ç¡®å®šç”¨æˆ·ç­‰çº§
   625â†’    user_id = current_user.user_id if current_user else None
   626â†’    user_tier = "free"
   627â†’
   628â†’    # æµ‹è¯•æ¨¡å¼: å…è®¸é€šè¿‡ header è¦†ç›– tier
   629â†’    if x_test_tier and x_test_tier in ("free", "paid", "vip", "guest"):
   630â†’        user_tier = x_test_tier
   631â†’        logger.info(f"Test mode: using tier={x_test_tier}")
   632â†’    elif user_id:
   633â†’        try:
   634â†’            from services.entitlement import EntitlementService
   635â†’            entitlements = await EntitlementService.get_entitlements(user_id)
   636â†’            user_tier = entitlements.get("tier", "free")
   637â†’        except Exception as e:
   638â†’            logger.warning(f"Failed to get entitlements: {e}")
   639â†’
   640â†’    # æ£€æŸ¥æƒç›Šè¦æ±‚
   641â†’    if service_def.entitlement:
   642â†’        # TODO: å®ç°æƒç›Šæ£€æŸ¥
   643â†’        pass
   644â†’
   645â†’    # æ„å»ºä¸Šä¸‹æ–‡
   646â†’    context = await build_service_context(user_id, skill_id, user_tier)
   647â†’
   648â†’    # æ‰§è¡ŒæœåŠ¡
   649â†’    result = await SkillServiceRegistry.execute(skill_id, action, request.args, context)
   650â†’
   651â†’    # æ£€æŸ¥é”™è¯¯
   652â†’    if "error" in result and result.get("status") in ("error", "not_found"):
   653â†’        status_code = 404 if result.get("status") == "not_found" else 400
   654â†’        raise HTTPException(status_code=status_code, detail=result["error"])
   655â†’
   656â†’    return result
   657â†’
   658â†’
   659â†’@router.get("/{skill_id}/{action}")
   660â†’async def get_skill_service_info(skill_id: str, action: str):
   661â†’    """
   662â†’    è·å–æœåŠ¡ä¿¡æ¯
   663â†’
   664â†’    Args:
   665â†’        skill_id: Skill æ ‡è¯†
   666â†’        action: æœåŠ¡åŠ¨ä½œ
   667â†’
   668â†’    Returns:
   669â†’        æœåŠ¡å®šä¹‰ä¿¡æ¯
   670â†’    """
   671â†’    service_def = SkillServiceRegistry.get_service(skill_id, action)
   672â†’    if not service_def:
   673â†’        raise HTTPException(
   674â†’            status_code=404,
   675â†’            detail=f"Service not found: {skill_id}/{action}"
   676â†’        )
   677â†’
   678â†’    return {
   679â†’        "skill_id": service_def.skill_id,
   680â†’        "action": service_def.action,
   681â†’        "description": service_def.description,
   682â†’        "auth_required": service_def.auth_required,
   683â†’        "entitlement": service_def.entitlement
   684â†’    }
   685â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
