     1→"""
     2→Unified Profile Repository - 统一 Profile 数据访问层
     3→
     4→基于 unified_profiles 表，提供统一的 Profile 访问接口。
     5→使用 jsonb_set() 进行局部更新，避免重写整个 profile。
     6→
     7→v7.7 重构：添加 account 和 state 字段
     8→- account: 从 vibe_users 同步 (vibe_id, display_name, tier, status)
     9→- state: 用户当前状态 (focus)
    10→
    11→v7.6 重构：整合以下功能到统一 Profile:
    12→- Skill 订阅管理 (原 user_skill_subscriptions)
    13→- 推送偏好 (原 user_push_preferences)
    14→- 生活上下文 (原 user_data_store)
    15→- Skill 推荐屏蔽 (原 skill_recommendation_blocks)
    16→
    17→Profile 结构:
    18→{
    19→    "account": {
    20→        "vibe_id": "VB-A1B2C3D4",
    21→        "display_name": "用户昵称",
    22→        "tier": "free",
    23→        "status": "active"
    24→    },
    25→    "birth_info": {...},
    26→    "state": {
    27→        "focus": ["career", "health"],
    28→        "updated_at": "2026-01-19T10:00:00Z"
    29→    },
    30→    "life_context": {...},
    31→    "preferences": {
    32→        "voice_mode": "warm",
    33→        "language": "zh-CN",
    34→        "timezone": "Asia/Shanghai",
    35→        "subscribed_skills": {
    36→            "bazi": {"status": "subscribed", "push_enabled": true, ...},
    37→            ...
    38→        },
    39→        "push_settings": {
    40→            "default_push_hour": 8,
    41→            "max_daily_pushes": 5,
    42→            "quiet_start_hour": 22,
    43→            "quiet_end_hour": 7
    44→        },
    45→        "blocked_skills": ["skill_id_1", ...]
    46→    },
    47→    "skill_data": {...},
    48→    "extracted": {...}
    49→}
    50→"""
    51→import json
    52→import logging
    53→from dataclasses import dataclass
    54→from datetime import datetime
    55→from typing import Optional, Dict, Any, List
    56→from uuid import UUID
    57→
    58→from .db import get_connection, fetch, fetchrow, fetchval, execute
    59→
    60→logger = logging.getLogger(__name__)
    61→
    62→
    63→# ═══════════════════════════════════════════════════════════════════════════
    64→# Data Classes
    65→# ═══════════════════════════════════════════════════════════════════════════
    66→
    67→@dataclass
    68→class SkillSubscription:
    69→    """Skill 订阅数据类 (兼容旧接口)"""
    70→    skill_id: str
    71→    status: str  # subscribed | unsubscribed | not_subscribed
    72→    push_enabled: bool
    73→    subscribed_at: Optional[datetime]
    74→    unsubscribed_at: Optional[datetime]
    75→    trial_messages_used: int
    76→
    77→    def to_dict(self) -> Dict[str, Any]:
    78→        return {
    79→            "skill_id": self.skill_id,
    80→            "status": self.status,
    81→            "push_enabled": self.push_enabled,
    82→            "subscribed_at": self.subscribed_at.isoformat() if self.subscribed_at else None,
    83→            "unsubscribed_at": self.unsubscribed_at.isoformat() if self.unsubscribed_at else None,
    84→            "trial_messages_used": self.trial_messages_used,
    85→        }
    86→
    87→
    88→@dataclass
    89→class UserPushPreferences:
    90→    """用户推送偏好 (兼容旧接口)"""
    91→    user_id: UUID
    92→    default_push_hour: int = 8
    93→    max_daily_pushes: int = 5
    94→    quiet_start_hour: int = 22
    95→    quiet_end_hour: int = 7
    96→
    97→    def to_dict(self) -> Dict[str, Any]:
    98→        return {
    99→            "user_id": str(self.user_id),
   100→            "default_push_hour": self.default_push_hour,
   101→            "max_daily_pushes": self.max_daily_pushes,
   102→            "quiet_start_hour": self.quiet_start_hour,
   103→            "quiet_end_hour": self.quiet_end_hour,
   104→        }
   105→
   106→
   107→@dataclass
   108→class LifeContextData:
   109→    """生活上下文数据 (替代 UserData)"""
   110→    path: str
   111→    content: Dict[str, Any]
   112→    version: int = 1
   113→    updated_at: Optional[datetime] = None
   114→
   115→    def to_dict(self) -> Dict[str, Any]:
   116→        return {
   117→            "path": self.path,
   118→            "content": self.content,
   119→            "version": self.version,
   120→            "updated_at": self.updated_at.isoformat() if self.updated_at else None,
   121→        }
   122→
   123→
   124→def deep_merge(base: Dict, update: Dict) -> Dict:
   125→    """深度合并两个字典"""
   126→    result = base.copy()
   127→    for key, value in update.items():
   128→        if key in result and isinstance(result[key], dict) and isinstance(value, dict):
   129→            result[key] = deep_merge(result[key], value)
   130→        elif value is not None:
   131→            result[key] = value
   132→    return result
   133→
   134→
   135→class UnifiedProfileRepository:
   136→    """统一 Profile 数据访问层"""
   137→
   138→    # ═══════════════════════════════════════════════════════════════════════════
   139→    # 读取操作
   140→    # ═══════════════════════════════════════════════════════════════════════════
   141→
   142→    @staticmethod
   143→    async def get_profile(user_id: UUID) -> Optional[Dict[str, Any]]:
   144→        """获取完整 Profile"""
   145→        row = await fetchrow(
   146→            "SELECT profile FROM unified_profiles WHERE user_id = $1",
   147→            user_id
   148→        )
   149→        if not row:
   150→            return None
   151→
   152→        profile = row["profile"]
   153→        if isinstance(profile, str):
   154→            profile = json.loads(profile)
   155→        return profile
   156→
   157→    @staticmethod
   158→    async def get_birth_info(user_id: UUID) -> Dict[str, Any]:
   159→        """获取出生信息"""
   160→        profile = await UnifiedProfileRepository.get_profile(user_id)
   161→        return profile.get("birth_info", {}) if profile else {}
   162→
   163→    @staticmethod
   164→    async def get_skill_data(user_id: UUID, skill: str) -> Dict[str, Any]:
   165→        """获取 Skill 数据"""
   166→        profile = await UnifiedProfileRepository.get_profile(user_id)
   167→        if profile:
   168→            return profile.get("skill_data", {}).get(skill, {})
   169→        return {}
   170→
   171→    @staticmethod
   172→    async def get_all_skill_data(user_id: UUID) -> Dict[str, Any]:
   173→        """获取所有 Skill 数据"""
   174→        profile = await UnifiedProfileRepository.get_profile(user_id)
   175→        if profile:
   176→            return profile.get("skill_data", {})
   177→        return {}
   178→
   179→    @staticmethod
   180→    async def get_preferences(user_id: UUID) -> Dict[str, Any]:
   181→        """获取用户偏好"""
   182→        profile = await UnifiedProfileRepository.get_profile(user_id)
   183→        if profile:
   184→            return profile.get("preferences", {"voice_mode": "warm", "language": "zh-CN"})
   185→        return {"voice_mode": "warm", "language": "zh-CN"}
   186→
   187→    @staticmethod
   188→    async def get_life_context(user_id: UUID) -> Dict[str, Any]:
   189→        """获取生活上下文"""
   190→        profile = await UnifiedProfileRepository.get_profile(user_id)
   191→        if profile:
   192→            return profile.get("life_context", {})
   193→        return {}
   194→
   195→    @staticmethod
   196→    async def get_account(user_id: UUID) -> Dict[str, Any]:
   197→        """
   198→        获取账户信息 (从 vibe_users 同步)
   199→
   200→        Returns:
   201→            {
   202→                "vibe_id": "VB-A1B2C3D4",
   203→                "display_name": "用户昵称",
   204→                "tier": "free",
   205→                "status": "active"
   206→            }
   207→        """
   208→        profile = await UnifiedProfileRepository.get_profile(user_id)
   209→        if profile:
   210→            return profile.get("account", {})
   211→        return {}
   212→
   213→    @staticmethod
   214→    async def get_state(user_id: UUID) -> Dict[str, Any]:
   215→        """
   216→        获取用户状态
   217→
   218→        Returns:
   219→            {
   220→                "focus": ["career", "health"],
   221→                "updated_at": "2026-01-19T10:00:00Z"
   222→            }
   223→        """
   224→        profile = await UnifiedProfileRepository.get_profile(user_id)
   225→        if profile:
   226→            return profile.get("state", {"focus": [], "updated_at": None})
   227→        return {"focus": [], "updated_at": None}
   228→
   229→    @staticmethod
   230→    async def get_focus(user_id: UUID) -> List[str]:
   231→        """获取用户当前关注的话题"""
   232→        state = await UnifiedProfileRepository.get_state(user_id)
   233→        return state.get("focus", [])
   234→
   235→    @staticmethod
   236→    async def get_tier(user_id: UUID) -> str:
   237→        """获取用户等级 (free, basic, pro, enterprise)"""
   238→        account = await UnifiedProfileRepository.get_account(user_id)
   239→        return account.get("tier", "free")
   240→
   241→    # ═══════════════════════════════════════════════════════════════════════════
   242→    # 写入操作
   243→    # ═══════════════════════════════════════════════════════════════════════════
   244→
   245→    @staticmethod
   246→    async def create_profile(user_id: UUID, initial_profile: Dict[str, Any] = None) -> Dict[str, Any]:
   247→        """创建新的 Profile"""
   248→        profile = initial_profile or {
   249→            "account": {},  # Will be synced from vibe_users via trigger
   250→            "birth_info": {},
   251→            "state": {"focus": [], "updated_at": None},
   252→            "life_context": {},
   253→            "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   254→            "skill_data": {}
   255→        }
   256→
   257→        await execute(
   258→            """INSERT INTO unified_profiles (user_id, profile)
   259→               VALUES ($1, $2::jsonb)
   260→               ON CONFLICT (user_id) DO NOTHING""",
   261→            user_id, json.dumps(profile, ensure_ascii=False, default=str)
   262→        )
   263→
   264→        return profile
   265→
   266→    @staticmethod
   267→    async def update_profile(user_id: UUID, updates: Dict[str, Any]) -> None:
   268→        """
   269→        更新 Profile (全量合并更新)
   270→
   271→        Args:
   272→            user_id: 用户 ID
   273→            updates: 要更新的字段，会与现有数据深度合并
   274→        """
   275→        current = await UnifiedProfileRepository.get_profile(user_id)
   276→
   277→        if current:
   278→            merged = deep_merge(current, updates)
   279→            await execute(
   280→                """UPDATE unified_profiles
   281→                   SET profile = $2::jsonb, updated_at = NOW()
   282→                   WHERE user_id = $1""",
   283→                user_id, json.dumps(merged, ensure_ascii=False, default=str)
   284→            )
   285→        else:
   286→            # 不存在则创建
   287→            default_profile = {
   288→                "birth_info": {},
   289→                "life_context": {},
   290→                "preferences": {"voice_mode": "warm", "language": "zh-CN"},
   291→                "skill_data": {}
   292→            }
   293→            merged = deep_merge(default_profile, updates)
   294→            await execute(
   295→                """INSERT INTO unified_profiles (user_id, profile)
   296→                   VALUES ($1, $2::jsonb)""",
   297→                user_id, json.dumps(merged, ensure_ascii=False, default=str)
   298→            )
   299→
   300→        # 失效缓存
   301→        await UnifiedProfileRepository._invalidate_cache(user_id)
   302→
   303→    @staticmethod
   304→    async def update_birth_info(user_id: UUID, birth_info: Dict[str, Any]) -> None:
   305→        """
   306→        更新出生信息 (使用 jsonb_set 局部更新)
   307→
   308→        Args:
   309→            user_id: 用户 ID
   310→            birth_info: 出生信息 {date, time, place, gender, timezone}
   311→        """
   312→        # 确保记录存在
   313→        exists = await fetchval(
   314→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   315→            user_id
   316→        )
   317→
   318→        if exists:
   319→            await execute(
   320→                """UPDATE unified_profiles
   321→                   SET profile = jsonb_set(
   322→                       COALESCE(profile, '{}'::jsonb),
   323→                       '{birth_info}',
   324→                       $2::jsonb
   325→                   ),
   326→                   updated_at = NOW()
   327→                   WHERE user_id = $1""",
   328→                user_id, json.dumps(birth_info, ensure_ascii=False, default=str)
   329→            )
   330→        else:
   331→            await UnifiedProfileRepository.create_profile(user_id, {"birth_info": birth_info})
   332→
   333→        # 失效所有缓存 (birth_info 影响所有 skill)
   334→        await UnifiedProfileRepository._invalidate_cache(user_id)
   335→
   336→    @staticmethod
   337→    async def update_skill_data(user_id: UUID, skill: str, data: Dict[str, Any]) -> None:
   338→        """
   339→        更新 Skill 数据 (使用 jsonb_set 局部更新，避免重写整个 profile)
   340→
   341→        Args:
   342→            user_id: 用户 ID
   343→            skill: Skill 标识 (bazi, zodiac, tarot, career)
   344→            data: Skill 数据 (如命盘数据)
   345→        """
   346→        # 确保记录存在
   347→        exists = await fetchval(
   348→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   349→            user_id
   350→        )
   351→
   352→        if exists:
   353→            # 使用 jsonb_set 进行嵌套路径更新
   354→            # 先确保 skill_data 存在，再设置具体 skill
   355→            await execute(
   356→                """UPDATE unified_profiles
   357→                   SET profile = jsonb_set(
   358→                       jsonb_set(
   359→                           COALESCE(profile, '{}'::jsonb),
   360→                           '{skill_data}',
   361→                           COALESCE(profile -> 'skill_data', '{}'::jsonb)
   362→                       ),
   363→                       ARRAY['skill_data', $2],
   364→                       $3::jsonb
   365→                   ),
   366→                   updated_at = NOW()
   367→                   WHERE user_id = $1""",
   368→                user_id, skill, json.dumps(data, ensure_ascii=False, default=str)
   369→            )
   370→        else:
   371→            await UnifiedProfileRepository.create_profile(user_id, {"skill_data": {skill: data}})
   372→
   373→        # 只失效该 skill 的缓存
   374→        await UnifiedProfileRepository._invalidate_cache(user_id, skill)
   375→
   376→    @staticmethod
   377→    async def update_preferences(user_id: UUID, preferences: Dict[str, Any]) -> None:
   378→        """更新用户偏好 (使用 jsonb_set 局部更新)"""
   379→        exists = await fetchval(
   380→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   381→            user_id
   382→        )
   383→
   384→        if exists:
   385→            # 合并现有偏好
   386→            current_prefs = await UnifiedProfileRepository.get_preferences(user_id)
   387→            merged_prefs = {**current_prefs, **preferences}
   388→
   389→            await execute(
   390→                """UPDATE unified_profiles
   391→                   SET profile = jsonb_set(
   392→                       COALESCE(profile, '{}'::jsonb),
   393→                       '{preferences}',
   394→                       $2::jsonb
   395→                   ),
   396→                   updated_at = NOW()
   397→                   WHERE user_id = $1""",
   398→                user_id, json.dumps(merged_prefs, ensure_ascii=False)
   399→            )
   400→        else:
   401→            await UnifiedProfileRepository.create_profile(user_id, {"preferences": preferences})
   402→
   403→        await UnifiedProfileRepository._invalidate_cache(user_id)
   404→    @staticmethod
   405→    async def update_life_context(user_id: UUID, life_context: Dict[str, Any]) -> None:
   406→        """更新生活上下文 (使用 jsonb_set 局部更新)"""
   407→        exists = await fetchval(
   408→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   409→            user_id
   410→        )
   411→
   412→        if exists:
   413→            # 合并现有上下文
   414→            current_ctx = await UnifiedProfileRepository.get_life_context(user_id)
   415→            merged_ctx = deep_merge(current_ctx, life_context)
   416→
   417→            await execute(
   418→                """UPDATE unified_profiles
   419→                   SET profile = jsonb_set(
   420→                       COALESCE(profile, '{}'::jsonb),
   421→                       '{life_context}',
   422→                       $2::jsonb
   423→                   ),
   424→                   updated_at = NOW()
   425→                   WHERE user_id = $1""",
   426→                user_id, json.dumps(merged_ctx, ensure_ascii=False, default=str)
   427→            )
   428→        else:
   429→            await UnifiedProfileRepository.create_profile(user_id, {"life_context": life_context})
   430→
   431→        await UnifiedProfileRepository._invalidate_cache(user_id)
   432→
   433→    # ═══════════════════════════════════════════════════════════════════════════
   434→    # State 管理 (v7.7 新增)
   435→    # ═══════════════════════════════════════════════════════════════════════════
   436→
   437→    @staticmethod
   438→    async def update_state(user_id: UUID, state: Dict[str, Any]) -> None:
   439→        """
   440→        更新用户状态 (使用 jsonb_set 局部更新)
   441→
   442→        Args:
   443→            user_id: 用户 ID
   444→            state: 状态数据 {focus: [...], updated_at: ...}
   445→        """
   446→        # 自动添加更新时间
   447→        state["updated_at"] = datetime.utcnow().isoformat()
   448→
   449→        exists = await fetchval(
   450→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   451→            user_id
   452→        )
   453→
   454→        if exists:
   455→            await execute(
   456→                """UPDATE unified_profiles
   457→                   SET profile = jsonb_set(
   458→                       COALESCE(profile, '{}'::jsonb),
   459→                       '{state}',
   460→                       $2::jsonb
   461→                   ),
   462→                   updated_at = NOW()
   463→                   WHERE user_id = $1""",
   464→                user_id, json.dumps(state, ensure_ascii=False, default=str)
   465→            )
   466→        else:
   467→            await UnifiedProfileRepository.create_profile(user_id, {"state": state})
   468→
   469→        await UnifiedProfileRepository._invalidate_cache(user_id)
   470→
   471→    @staticmethod
   472→    async def update_focus(user_id: UUID, focus: List[str]) -> None:
   473→        """
   474→        更新用户关注的话题
   475→
   476→        Args:
   477→            user_id: 用户 ID
   478→            focus: 关注话题列表，如 ["career", "health", "relationship"]
   479→        """
   480→        await UnifiedProfileRepository.update_state(user_id, {"focus": focus})
   481→
   482→    @staticmethod
   483→    async def add_focus(user_id: UUID, topic: str) -> List[str]:
   484→        """
   485→        添加一个关注话题
   486→
   487→        Args:
   488→            user_id: 用户 ID
   489→            topic: 话题名称
   490→
   491→        Returns:
   492→            更新后的 focus 列表
   493→        """
   494→        current_focus = await UnifiedProfileRepository.get_focus(user_id)
   495→        if topic not in current_focus:
   496→            current_focus.append(topic)
   497→            await UnifiedProfileRepository.update_focus(user_id, current_focus)
   498→        return current_focus
   499→
   500→    @staticmethod
   501→    async def remove_focus(user_id: UUID, topic: str) -> List[str]:
   502→        """
   503→        移除一个关注话题
   504→
   505→        Args:
   506→            user_id: 用户 ID
   507→            topic: 话题名称
   508→
   509→        Returns:
   510→            更新后的 focus 列表
   511→        """
   512→        current_focus = await UnifiedProfileRepository.get_focus(user_id)
   513→        if topic in current_focus:
   514→            current_focus.remove(topic)
   515→            await UnifiedProfileRepository.update_focus(user_id, current_focus)
   516→        return current_focus
   517→
   518→    @staticmethod
   519→    async def update_extracted(user_id: UUID, extracted: Dict[str, Any]) -> None:
   520→        """
   521→        更新抽取的用户信息 (使用 jsonb_set 局部更新)
   522→
   523→        Args:
   524→            user_id: 用户 ID
   525→            extracted: 抽取的信息 {facts, concerns, goals, pain_points, life_events, patterns, ...}
   526→        """
   527→        exists = await fetchval(
   528→            "SELECT 1 FROM unified_profiles WHERE user_id = $1",
   529→            user_id
   530→        )
   531→
   532→        if exists:
   533→            await execute(
   534→                """UPDATE unified_profiles
   535→                   SET profile = jsonb_set(
   536→                       COALESCE(profile, '{}'::jsonb),
   537→                       '{extracted}',
   538→                       $2::jsonb
   539→                   ),
   540→                   updated_at = NOW()
   541→                   WHERE user_id = $1""",
   542→                user_id, json.dumps(extracted, ensure_ascii=False, default=str)
   543→            )
   544→        else:
   545→            await UnifiedProfileRepository.create_profile(user_id, {"extracted": extracted})
   546→
   547→        await UnifiedProfileRepository._invalidate_cache(user_id)
   548→
   549→    @staticmethod
   550→    async def get_extracted(user_id: UUID) -> Dict[str, Any]:
   551→        """获取抽取的用户信息"""
   552→        profile = await UnifiedProfileRepository.get_profile(user_id)
   553→        if profile:
   554→            return profile.get("extracted", {})
   555→        return {}
   556→
   557→    # ═══════════════════════════════════════════════════════════════════════════
   558→    # 删除操作
   559→    # ═══════════════════════════════════════════════════════════════════════════
   560→
   561→    @staticmethod
   562→    async def delete_profile(user_id: UUID) -> bool:
   563→        """删除用户 Profile"""
   564→        result = await execute(
   565→            "DELETE FROM unified_profiles WHERE user_id = $1",
   566→            user_id
   567→        )
   568→        await UnifiedProfileRepository._invalidate_cache(user_id)
   569→        return "DELETE 1" in str(result)
   570→
   571→    # ═══════════════════════════════════════════════════════════════════════════
   572→    # 历史归档
   573→    # ═══════════════════════════════════════════════════════════════════════════
   574→
   575→    @staticmethod
   576→    async def archive_profile(user_id: UUID) -> bool:
   577→        """归档当前 Profile 到历史表"""
   578→        profile = await UnifiedProfileRepository.get_profile(user_id)
   579→        if not profile:
   580→            return False
   581→
   582→        await execute(
   583→            """INSERT INTO unified_profiles_history (user_id, profile)
   584→               VALUES ($1, $2::jsonb)""",
   585→            user_id, json.dumps(profile, ensure_ascii=False, default=str)
   586→        )
   587→        return True
   588→
   589→    @staticmethod
   590→    async def get_profile_history(user_id: UUID, limit: int = 10) -> List[Dict[str, Any]]:
   591→        """获取 Profile 历史记录"""
   592→        rows = await fetch(
   593→            """SELECT profile, archived_at FROM unified_profiles_history
   594→               WHERE user_id = $1
   595→               ORDER BY archived_at DESC
   596→               LIMIT $2""",
   597→            user_id, limit
   598→        )
   599→        return [
   600→            {
   601→                "profile": row["profile"] if isinstance(row["profile"], dict) else json.loads(row["profile"]),
   602→                "archived_at": row["archived_at"]
   603→            }
   604→            for row in rows
   605→        ]
   606→
   607→    # ═══════════════════════════════════════════════════════════════════════════
   608→    # Skill 订阅管理 (v7.6 - 从 SkillSubscriptionRepository 迁移)
   609→    # ═══════════════════════════════════════════════════════════════════════════
   610→
   611→    @staticmethod
   612→    async def get_skill_subscription(user_id: UUID, skill_id: str) -> Optional[SkillSubscription]:
   613→        """获取单个 Skill 订阅状态"""
   614→        profile = await UnifiedProfileRepository.get_profile(user_id)
   615→        if not profile:
   616→            return None
   617→
   618→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   619→        sub_data = subscribed_skills.get(skill_id)
   620→
   621→        if not sub_data:
   622→            return None
   623→
   624→        return SkillSubscription(
   625→            skill_id=skill_id,
   626→            status=sub_data.get("status", "not_subscribed"),
   627→            push_enabled=sub_data.get("push_enabled", False),
   628→            subscribed_at=datetime.fromisoformat(sub_data["subscribed_at"]) if sub_data.get("subscribed_at") else None,
   629→            unsubscribed_at=datetime.fromisoformat(sub_data["unsubscribed_at"]) if sub_data.get("unsubscribed_at") else None,
   630→            trial_messages_used=sub_data.get("trial_messages_used", 0),
   631→        )
   632→
   633→    @staticmethod
   634→    async def get_user_subscriptions(user_id: UUID) -> List[SkillSubscription]:
   635→        """获取用户所有订阅"""
   636→        profile = await UnifiedProfileRepository.get_profile(user_id)
   637→        if not profile:
   638→            return []
   639→
   640→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   641→        subscriptions = []
   642→
   643→        for skill_id, sub_data in subscribed_skills.items():
   644→            subscriptions.append(SkillSubscription(
   645→                skill_id=skill_id,
   646→                status=sub_data.get("status", "not_subscribed"),
   647→                push_enabled=sub_data.get("push_enabled", False),
   648→                subscribed_at=datetime.fromisoformat(sub_data["subscribed_at"]) if sub_data.get("subscribed_at") else None,
   649→                unsubscribed_at=datetime.fromisoformat(sub_data["unsubscribed_at"]) if sub_data.get("unsubscribed_at") else None,
   650→                trial_messages_used=sub_data.get("trial_messages_used", 0),
   651→            ))
   652→
   653→        # 按订阅时间排序 (最新优先)
   654→        subscriptions.sort(key=lambda s: s.subscribed_at or datetime.min, reverse=True)
   655→        return subscriptions
   656→
   657→    @staticmethod
   658→    async def get_subscribed_skill_ids(user_id: UUID) -> List[str]:
   659→        """获取用户已订阅的 Skill ID 列表"""
   660→        profile = await UnifiedProfileRepository.get_profile(user_id)
   661→        if not profile:
   662→            return []
   663→
   664→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   665→        return [
   666→            skill_id for skill_id, sub_data in subscribed_skills.items()
   667→            if sub_data.get("status") == "subscribed"
   668→        ]
   669→
   670→    @staticmethod
   671→    async def subscribe(
   672→        user_id: UUID,
   673→        skill_id: str,
   674→        push_enabled: bool = True
   675→    ) -> SkillSubscription:
   676→        """订阅 Skill"""
   677→        profile = await UnifiedProfileRepository.get_profile(user_id)
   678→        if not profile:
   679→            profile = await UnifiedProfileRepository.create_profile(user_id)
   680→
   681→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   682→        existing = subscribed_skills.get(skill_id, {})
   683→
   684→        now = datetime.utcnow()
   685→        sub_data = {
   686→            "status": "subscribed",
   687→            "push_enabled": push_enabled,
   688→            "subscribed_at": now.isoformat(),
   689→            "unsubscribed_at": None,
   690→            "trial_messages_used": existing.get("trial_messages_used", 0),
   691→        }
   692→
   693→        subscribed_skills[skill_id] = sub_data
   694→
   695→        # 使用 jsonb_set 更新
   696→        await execute(
   697→            """UPDATE unified_profiles
   698→               SET profile = jsonb_set(
   699→                   jsonb_set(
   700→                       COALESCE(profile, '{}'::jsonb),
   701→                       '{preferences}',
   702→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   703→                   ),
   704→                   '{preferences, subscribed_skills}',
   705→                   $2::jsonb
   706→               ),
   707→               updated_at = NOW()
   708→               WHERE user_id = $1""",
   709→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
   710→        )
   711→
   712→        await UnifiedProfileRepository._invalidate_cache(user_id)
   713→
   714→        return SkillSubscription(
   715→            skill_id=skill_id,
   716→            status="subscribed",
   717→            push_enabled=push_enabled,
   718→            subscribed_at=now,
   719→            unsubscribed_at=None,
   720→            trial_messages_used=existing.get("trial_messages_used", 0),
   721→        )
   722→
   723→    @staticmethod
   724→    async def unsubscribe(user_id: UUID, skill_id: str) -> SkillSubscription:
   725→        """取消订阅 Skill"""
   726→        profile = await UnifiedProfileRepository.get_profile(user_id)
   727→        if not profile:
   728→            return SkillSubscription(
   729→                skill_id=skill_id,
   730→                status="unsubscribed",
   731→                push_enabled=False,
   732→                subscribed_at=None,
   733→                unsubscribed_at=datetime.utcnow(),
   734→                trial_messages_used=0,
   735→            )
   736→
   737→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   738→        existing = subscribed_skills.get(skill_id, {})
   739→
   740→        now = datetime.utcnow()
   741→        sub_data = {
   742→            "status": "unsubscribed",
   743→            "push_enabled": False,
   744→            "subscribed_at": existing.get("subscribed_at"),
   745→            "unsubscribed_at": now.isoformat(),
   746→            "trial_messages_used": existing.get("trial_messages_used", 0),
   747→        }
   748→
   749→        subscribed_skills[skill_id] = sub_data
   750→
   751→        await execute(
   752→            """UPDATE unified_profiles
   753→               SET profile = jsonb_set(
   754→                   jsonb_set(
   755→                       COALESCE(profile, '{}'::jsonb),
   756→                       '{preferences}',
   757→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   758→                   ),
   759→                   '{preferences, subscribed_skills}',
   760→                   $2::jsonb
   761→               ),
   762→               updated_at = NOW()
   763→               WHERE user_id = $1""",
   764→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
   765→        )
   766→
   767→        await UnifiedProfileRepository._invalidate_cache(user_id)
   768→
   769→        return SkillSubscription(
   770→            skill_id=skill_id,
   771→            status="unsubscribed",
   772→            push_enabled=False,
   773→            subscribed_at=datetime.fromisoformat(existing["subscribed_at"]) if existing.get("subscribed_at") else None,
   774→            unsubscribed_at=now,
   775→            trial_messages_used=existing.get("trial_messages_used", 0),
   776→        )
   777→
   778→    @staticmethod
   779→    async def update_push(
   780→        user_id: UUID,
   781→        skill_id: str,
   782→        enabled: bool
   783→    ) -> Optional[SkillSubscription]:
   784→        """更新推送状态"""
   785→        profile = await UnifiedProfileRepository.get_profile(user_id)
   786→        if not profile:
   787→            return None
   788→
   789→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   790→        existing = subscribed_skills.get(skill_id)
   791→
   792→        if not existing:
   793→            return None
   794→
   795→        existing["push_enabled"] = enabled
   796→        subscribed_skills[skill_id] = existing
   797→
   798→        await execute(
   799→            """UPDATE unified_profiles
   800→               SET profile = jsonb_set(
   801→                   jsonb_set(
   802→                       COALESCE(profile, '{}'::jsonb),
   803→                       '{preferences}',
   804→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   805→                   ),
   806→                   '{preferences, subscribed_skills}',
   807→                   $2::jsonb
   808→               ),
   809→               updated_at = NOW()
   810→               WHERE user_id = $1""",
   811→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
   812→        )
   813→
   814→        await UnifiedProfileRepository._invalidate_cache(user_id)
   815→
   816→        return SkillSubscription(
   817→            skill_id=skill_id,
   818→            status=existing.get("status", "not_subscribed"),
   819→            push_enabled=enabled,
   820→            subscribed_at=datetime.fromisoformat(existing["subscribed_at"]) if existing.get("subscribed_at") else None,
   821→            unsubscribed_at=datetime.fromisoformat(existing["unsubscribed_at"]) if existing.get("unsubscribed_at") else None,
   822→            trial_messages_used=existing.get("trial_messages_used", 0),
   823→        )
   824→
   825→    @staticmethod
   826→    async def is_push_enabled(user_id: UUID, skill_id: str) -> bool:
   827→        """检查推送是否开启"""
   828→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
   829→        if not subscription:
   830→            return False
   831→        return subscription.status == "subscribed" and subscription.push_enabled
   832→
   833→    @staticmethod
   834→    async def get_users_with_push_enabled(skill_id: str) -> List[UUID]:
   835→        """获取某 Skill 开启推送的所有用户 ID"""
   836→        query = """
   837→            SELECT user_id
   838→            FROM unified_profiles
   839→            WHERE profile -> 'preferences' -> 'subscribed_skills' -> $1 ->> 'status' = 'subscribed'
   840→            AND (profile -> 'preferences' -> 'subscribed_skills' -> $1 ->> 'push_enabled')::boolean = true
   841→        """
   842→        rows = await fetch(query, skill_id)
   843→        return [row["user_id"] for row in rows]
   844→
   845→    @staticmethod
   846→    async def increment_trial_usage(user_id: UUID, skill_id: str) -> int:
   847→        """增加试用次数，返回新的使用次数"""
   848→        profile = await UnifiedProfileRepository.get_profile(user_id)
   849→        if not profile:
   850→            profile = await UnifiedProfileRepository.create_profile(user_id)
   851→
   852→        subscribed_skills = profile.get("preferences", {}).get("subscribed_skills", {})
   853→        existing = subscribed_skills.get(skill_id, {
   854→            "status": "not_subscribed",
   855→            "push_enabled": False,
   856→            "subscribed_at": None,
   857→            "unsubscribed_at": None,
   858→            "trial_messages_used": 0,
   859→        })
   860→
   861→        existing["trial_messages_used"] = existing.get("trial_messages_used", 0) + 1
   862→        subscribed_skills[skill_id] = existing
   863→
   864→        await execute(
   865→            """UPDATE unified_profiles
   866→               SET profile = jsonb_set(
   867→                   jsonb_set(
   868→                       COALESCE(profile, '{}'::jsonb),
   869→                       '{preferences}',
   870→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   871→                   ),
   872→                   '{preferences, subscribed_skills}',
   873→                   $2::jsonb
   874→               ),
   875→               updated_at = NOW()
   876→               WHERE user_id = $1""",
   877→            user_id, json.dumps(subscribed_skills, ensure_ascii=False, default=str)
   878→        )
   879→
   880→        await UnifiedProfileRepository._invalidate_cache(user_id)
   881→        return existing["trial_messages_used"]
   882→
   883→    @staticmethod
   884→    async def get_trial_usage(user_id: UUID, skill_id: str) -> int:
   885→        """获取试用次数"""
   886→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
   887→        return subscription.trial_messages_used if subscription else 0
   888→
   889→    @staticmethod
   890→    async def is_subscribed(user_id: UUID, skill_id: str) -> bool:
   891→        """检查是否已订阅"""
   892→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
   893→        return subscription is not None and subscription.status == "subscribed"
   894→
   895→    @staticmethod
   896→    async def can_use_skill(
   897→        user_id: UUID,
   898→        skill_id: str,
   899→        skill_category: str,
   900→        trial_limit: int = 3
   901→    ) -> tuple:
   902→        """
   903→        检查用户是否可以使用 Skill
   904→
   905→        Returns:
   906→            (can_use, reason)
   907→            - (True, "subscribed") - 已订阅
   908→            - (True, "default") - 默认 Skill
   909→            - (True, "core") - Core Skill
   910→            - (True, "trial") - 试用中
   911→            - (False, "trial_exhausted") - 试用次数用完
   912→            - (False, "not_subscribed") - 未订阅
   913→        """
   914→        # Core Skill 始终可用
   915→        if skill_category == "core":
   916→            return True, "core"
   917→
   918→        subscription = await UnifiedProfileRepository.get_skill_subscription(user_id, skill_id)
   919→
   920→        # Default Skill: 如果没有订阅记录或已订阅，则可用
   921→        if skill_category == "default":
   922→            if not subscription or subscription.status == "subscribed":
   923→                return True, "default"
   924→            return False, "unsubscribed"
   925→
   926→        # Professional Skill: 需要订阅或在试用期内
   927→        if subscription and subscription.status == "subscribed":
   928→            return True, "subscribed"
   929→
   930→        # 检查试用
   931→        trial_used = subscription.trial_messages_used if subscription else 0
   932→        if trial_used < trial_limit:
   933→            return True, "trial"
   934→
   935→        return False, "trial_exhausted"
   936→
   937→    # ═══════════════════════════════════════════════════════════════════════════
   938→    # 推送偏好管理 (v7.6 - 从 UserPushPreferencesRepository 迁移)
   939→    # ═══════════════════════════════════════════════════════════════════════════
   940→
   941→    @staticmethod
   942→    async def get_push_settings(user_id: UUID) -> Optional[UserPushPreferences]:
   943→        """获取用户推送偏好"""
   944→        profile = await UnifiedProfileRepository.get_profile(user_id)
   945→        if not profile:
   946→            return None
   947→
   948→        push_settings = profile.get("preferences", {}).get("push_settings", {})
   949→        if not push_settings:
   950→            return None
   951→
   952→        return UserPushPreferences(
   953→            user_id=user_id,
   954→            default_push_hour=push_settings.get("default_push_hour", 8),
   955→            max_daily_pushes=push_settings.get("max_daily_pushes", 5),
   956→            quiet_start_hour=push_settings.get("quiet_start_hour", 22),
   957→            quiet_end_hour=push_settings.get("quiet_end_hour", 7),
   958→        )
   959→
   960→    @staticmethod
   961→    async def upsert_push_settings(
   962→        user_id: UUID,
   963→        default_push_hour: Optional[int] = None,
   964→        max_daily_pushes: Optional[int] = None,
   965→        quiet_start_hour: Optional[int] = None,
   966→        quiet_end_hour: Optional[int] = None,
   967→    ) -> UserPushPreferences:
   968→        """创建或更新用户推送偏好"""
   969→        profile = await UnifiedProfileRepository.get_profile(user_id)
   970→        if not profile:
   971→            profile = await UnifiedProfileRepository.create_profile(user_id)
   972→
   973→        current_settings = profile.get("preferences", {}).get("push_settings", {})
   974→        push_settings = {
   975→            "default_push_hour": default_push_hour if default_push_hour is not None else current_settings.get("default_push_hour", 8),
   976→            "max_daily_pushes": max_daily_pushes if max_daily_pushes is not None else current_settings.get("max_daily_pushes", 5),
   977→            "quiet_start_hour": quiet_start_hour if quiet_start_hour is not None else current_settings.get("quiet_start_hour", 22),
   978→            "quiet_end_hour": quiet_end_hour if quiet_end_hour is not None else current_settings.get("quiet_end_hour", 7),
   979→        }
   980→
   981→        await execute(
   982→            """UPDATE unified_profiles
   983→               SET profile = jsonb_set(
   984→                   jsonb_set(
   985→                       COALESCE(profile, '{}'::jsonb),
   986→                       '{preferences}',
   987→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
   988→                   ),
   989→                   '{preferences, push_settings}',
   990→                   $2::jsonb
   991→               ),
   992→               updated_at = NOW()
   993→               WHERE user_id = $1""",
   994→            user_id, json.dumps(push_settings, ensure_ascii=False)
   995→        )
   996→
   997→        await UnifiedProfileRepository._invalidate_cache(user_id)
   998→
   999→        return UserPushPreferences(
  1000→            user_id=user_id,
  1001→            default_push_hour=push_settings["default_push_hour"],
  1002→            max_daily_pushes=push_settings["max_daily_pushes"],
  1003→            quiet_start_hour=push_settings["quiet_start_hour"],
  1004→            quiet_end_hour=push_settings["quiet_end_hour"],
  1005→        )
  1006→
  1007→    @staticmethod
  1008→    async def get_push_hour(user_id: UUID, skill_id: Optional[str] = None) -> int:
  1009→        """
  1010→        获取用户的推送时间
  1011→
  1012→        优先级:
  1013→        1. 用户全局偏好 (preferences.push_settings.default_push_hour)
  1014→        2. 系统默认值 (8)
  1015→        """
  1016→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1017→        if profile:
  1018→            push_settings = profile.get("preferences", {}).get("push_settings", {})
  1019→            if "default_push_hour" in push_settings:
  1020→                return push_settings["default_push_hour"]
  1021→        return 8
  1022→
  1023→    @staticmethod
  1024→    async def is_in_quiet_hours(user_id: UUID, current_hour: int) -> bool:
  1025→        """检查当前是否在用户的静默时段"""
  1026→        prefs = await UnifiedProfileRepository.get_push_settings(user_id)
  1027→        if not prefs:
  1028→            # 默认静默时段 22:00 - 07:00
  1029→            return current_hour >= 22 or current_hour < 7
  1030→
  1031→        start = prefs.quiet_start_hour
  1032→        end = prefs.quiet_end_hour
  1033→
  1034→        # 处理跨午夜的情况
  1035→        if start > end:
  1036→            return current_hour >= start or current_hour < end
  1037→        else:
  1038→            return start <= current_hour < end
  1039→
  1040→    # ═══════════════════════════════════════════════════════════════════════════
  1041→    # Skill 推荐屏蔽 (v7.6 - 从 SkillRecommendationBlockRepository 迁移)
  1042→    # ═══════════════════════════════════════════════════════════════════════════
  1043→
  1044→    @staticmethod
  1045→    async def get_blocked_skills(user_id: UUID) -> List[str]:
  1046→        """获取用户屏蔽的 Skill 列表"""
  1047→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1048→        if not profile:
  1049→            return []
  1050→        return profile.get("preferences", {}).get("blocked_skills", [])
  1051→
  1052→    @staticmethod
  1053→    async def block_skill(user_id: UUID, skill_id: str) -> None:
  1054→        """屏蔽 Skill 推荐"""
  1055→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1056→        if not profile:
  1057→            profile = await UnifiedProfileRepository.create_profile(user_id)
  1058→
  1059→        blocked_skills = profile.get("preferences", {}).get("blocked_skills", [])
  1060→        if skill_id not in blocked_skills:
  1061→            blocked_skills.append(skill_id)
  1062→
  1063→        await execute(
  1064→            """UPDATE unified_profiles
  1065→               SET profile = jsonb_set(
  1066→                   jsonb_set(
  1067→                       COALESCE(profile, '{}'::jsonb),
  1068→                       '{preferences}',
  1069→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
  1070→                   ),
  1071→                   '{preferences, blocked_skills}',
  1072→                   $2::jsonb
  1073→               ),
  1074→               updated_at = NOW()
  1075→               WHERE user_id = $1""",
  1076→            user_id, json.dumps(blocked_skills, ensure_ascii=False)
  1077→        )
  1078→
  1079→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1080→
  1081→    @staticmethod
  1082→    async def unblock_skill(user_id: UUID, skill_id: str) -> None:
  1083→        """取消屏蔽 Skill 推荐"""
  1084→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1085→        if not profile:
  1086→            return
  1087→
  1088→        blocked_skills = profile.get("preferences", {}).get("blocked_skills", [])
  1089→        if skill_id in blocked_skills:
  1090→            blocked_skills.remove(skill_id)
  1091→
  1092→        await execute(
  1093→            """UPDATE unified_profiles
  1094→               SET profile = jsonb_set(
  1095→                   jsonb_set(
  1096→                       COALESCE(profile, '{}'::jsonb),
  1097→                       '{preferences}',
  1098→                       COALESCE(profile -> 'preferences', '{}'::jsonb)
  1099→                   ),
  1100→                   '{preferences, blocked_skills}',
  1101→                   $2::jsonb
  1102→               ),
  1103→               updated_at = NOW()
  1104→               WHERE user_id = $1""",
  1105→            user_id, json.dumps(blocked_skills, ensure_ascii=False)
  1106→        )
  1107→
  1108→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1109→
  1110→    @staticmethod
  1111→    async def is_skill_blocked(user_id: UUID, skill_id: str) -> bool:
  1112→        """检查 Skill 是否被屏蔽"""
  1113→        blocked_skills = await UnifiedProfileRepository.get_blocked_skills(user_id)
  1114→        return skill_id in blocked_skills
  1115→
  1116→    # ═══════════════════════════════════════════════════════════════════════════
  1117→    # 生活上下文路径操作 (v7.6 - 替代 UserDataService)
  1118→    # ═══════════════════════════════════════════════════════════════════════════
  1119→
  1120→    @staticmethod
  1121→    async def read_life_context_path(user_id: UUID, path: str) -> Optional[LifeContextData]:
  1122→        """
  1123→        读取生活上下文的指定路径
  1124→
  1125→        Args:
  1126→            user_id: 用户 ID
  1127→            path: 虚拟路径，如 "goals/2026/year"
  1128→
  1129→        Returns:
  1130→            LifeContextData 对象，不存在返回 None
  1131→        """
  1132→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1133→        if not profile:
  1134→            return None
  1135→
  1136→        life_context = profile.get("life_context", {})
  1137→        paths = life_context.get("_paths", {})
  1138→        path_data = paths.get(path)
  1139→
  1140→        if not path_data:
  1141→            return None
  1142→
  1143→        return LifeContextData(
  1144→            path=path,
  1145→            content=path_data.get("content", {}),
  1146→            version=path_data.get("version", 1),
  1147→            updated_at=datetime.fromisoformat(path_data["updated_at"]) if path_data.get("updated_at") else None,
  1148→        )
  1149→
  1150→    @staticmethod
  1151→    async def write_life_context_path(
  1152→        user_id: UUID,
  1153→        path: str,
  1154→        content: Dict[str, Any],
  1155→        expected_version: Optional[int] = None,
  1156→    ) -> LifeContextData:
  1157→        """
  1158→        写入生活上下文的指定路径
  1159→
  1160→        Args:
  1161→            user_id: 用户 ID
  1162→            path: 虚拟路径
  1163→            content: JSON 内容
  1164→            expected_version: 期望版本号（乐观锁）
  1165→
  1166→        Returns:
  1167→            更新后的 LifeContextData 对象
  1168→        """
  1169→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1170→        if not profile:
  1171→            profile = await UnifiedProfileRepository.create_profile(user_id)
  1172→
  1173→        life_context = profile.get("life_context", {})
  1174→        paths = life_context.get("_paths", {})
  1175→        existing = paths.get(path, {})
  1176→
  1177→        # 检查版本冲突
  1178→        if expected_version is not None:
  1179→            current_version = existing.get("version", 0)
  1180→            if current_version != expected_version:
  1181→                raise ValueError(f"Version conflict: expected {expected_version}, got {current_version}")
  1182→
  1183→        now = datetime.utcnow()
  1184→        new_version = existing.get("version", 0) + 1
  1185→
  1186→        paths[path] = {
  1187→            "content": content,
  1188→            "version": new_version,
  1189→            "updated_at": now.isoformat(),
  1190→        }
  1191→
  1192→        life_context["_paths"] = paths
  1193→
  1194→        await execute(
  1195→            """UPDATE unified_profiles
  1196→               SET profile = jsonb_set(
  1197→                   COALESCE(profile, '{}'::jsonb),
  1198→                   '{life_context}',
  1199→                   $2::jsonb
  1200→               ),
  1201→               updated_at = NOW()
  1202→               WHERE user_id = $1""",
  1203→            user_id, json.dumps(life_context, ensure_ascii=False, default=str)
  1204→        )
  1205→
  1206→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1207→
  1208→        return LifeContextData(
  1209→            path=path,
  1210→            content=content,
  1211→            version=new_version,
  1212→            updated_at=now,
  1213→        )
  1214→
  1215→    @staticmethod
  1216→    async def delete_life_context_path(user_id: UUID, path: str) -> bool:
  1217→        """删除生活上下文的指定路径"""
  1218→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1219→        if not profile:
  1220→            return False
  1221→
  1222→        life_context = profile.get("life_context", {})
  1223→        paths = life_context.get("_paths", {})
  1224→
  1225→        if path not in paths:
  1226→            return False
  1227→
  1228→        del paths[path]
  1229→        life_context["_paths"] = paths
  1230→
  1231→        await execute(
  1232→            """UPDATE unified_profiles
  1233→               SET profile = jsonb_set(
  1234→                   COALESCE(profile, '{}'::jsonb),
  1235→                   '{life_context}',
  1236→                   $2::jsonb
  1237→               ),
  1238→               updated_at = NOW()
  1239→               WHERE user_id = $1""",
  1240→            user_id, json.dumps(life_context, ensure_ascii=False, default=str)
  1241→        )
  1242→
  1243→        await UnifiedProfileRepository._invalidate_cache(user_id)
  1244→        return True
  1245→
  1246→    @staticmethod
  1247→    async def query_life_context(
  1248→        user_id: UUID,
  1249→        path_prefix: Optional[str] = None,
  1250→        limit: int = 100,
  1251→    ) -> List[LifeContextData]:
  1252→        """查询生活上下文"""
  1253→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1254→        if not profile:
  1255→            return []
  1256→
  1257→        life_context = profile.get("life_context", {})
  1258→        paths = life_context.get("_paths", {})
  1259→
  1260→        results = []
  1261→        for path, path_data in paths.items():
  1262→            if path_prefix and not path.startswith(path_prefix):
  1263→                continue
  1264→
  1265→            results.append(LifeContextData(
  1266→                path=path,
  1267→                content=path_data.get("content", {}),
  1268→                version=path_data.get("version", 1),
  1269→                updated_at=datetime.fromisoformat(path_data["updated_at"]) if path_data.get("updated_at") else None,
  1270→            ))
  1271→
  1272→            if len(results) >= limit:
  1273→                break
  1274→
  1275→        # 按更新时间排序
  1276→        results.sort(key=lambda x: x.updated_at or datetime.min, reverse=True)
  1277→        return results
  1278→
  1279→    @staticmethod
  1280→    async def list_life_context_paths(
  1281→        user_id: UUID,
  1282→        path_prefix: Optional[str] = None,
  1283→    ) -> List[str]:
  1284→        """列出生活上下文的所有路径"""
  1285→        profile = await UnifiedProfileRepository.get_profile(user_id)
  1286→        if not profile:
  1287→            return []
  1288→
  1289→        life_context = profile.get("life_context", {})
  1290→        paths = life_context.get("_paths", {})
  1291→
  1292→        result = []
  1293→        for path in paths.keys():
  1294→            if path_prefix and not path.startswith(path_prefix):
  1295→                continue
  1296→            result.append(path)
  1297→
  1298→        result.sort()
  1299→        return result
  1300→
  1301→    # ═══════════════════════════════════════════════════════════════════════════
  1302→    # 缓存管理
  1303→    # ═══════════════════════════════════════════════════════════════════════════
  1304→
  1305→    @staticmethod
  1306→    async def _invalidate_cache(user_id: UUID, skill: str = None) -> None:
  1307→        """
  1308→        失效缓存
  1309→
  1310→        Args:
  1311→            user_id: 用户 ID
  1312→            skill: 如果指定，只失效该 skill 的缓存；否则失效所有缓存
  1313→        """
  1314→        try:
  1315→            from stores.profile_cache import get_profile_cache
  1316→            cache = get_profile_cache()
  1317→
  1318→            if skill:
  1319→                # 只失效特定 skill 的缓存
  1320→                await cache.invalidate_by_key(f"{user_id}:{skill}")
  1321→                # 也失效 all 缓存
  1322→                await cache.invalidate_by_key(f"{user_id}:all")
  1323→            else:
  1324→                # 失效该用户所有缓存
  1325→                await cache.invalidate_by_prefix(str(user_id))
  1326→
  1327→            logger.debug(f"缓存已失效: user_id={user_id}, skill={skill}")
  1328→        except Exception as e:
  1329→            logger.warning(f"缓存失效失败: {e}")
  1330→
  1331→
  1332→# ═══════════════════════════════════════════════════════════════════════════
  1333→# 便捷函数 (兼容旧代码)
  1334→# ═══════════════════════════════════════════════════════════════════════════
  1335→
  1336→async def get_unified_profile(user_id: UUID) -> Optional[Dict[str, Any]]:
  1337→    """获取统一 Profile (便捷函数)"""
  1338→    return await UnifiedProfileRepository.get_profile(user_id)
  1339→
  1340→
  1341→async def get_unified_profile_with_skill(user_id: UUID, skill: str = None) -> Dict[str, Any]:
  1342→    """
  1343→    获取 Profile 和 Skill 数据 (兼容 profile_cache 接口)
  1344→
  1345→    Returns:
  1346→        {
  1347→            "profile": {...},
  1348→            "skill_data": {...}
  1349→        }
  1350→    """
  1351→    profile = await UnifiedProfileRepository.get_profile(user_id)
  1352→
  1353→    if profile:
  1354→        skill_data = profile.get("skill_data", {})
  1355→        return {
  1356→            "profile": profile,
  1357→            "skill_data": skill_data
  1358→        }
  1359→
  1360→    return {"profile": {}, "skill_data": {}}
  1361→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
