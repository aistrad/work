     1→"""
     2→VibeLife API - The Living Companion Backend
     3→
     4→v6.8 重构版本:
     5→- 统一 Skill Gateway (/api/v1/skills/*)
     6→- 统一 Account 路由 (/api/v1/account/*)
     7→- 统一 Commerce 路由 (/api/v1/commerce/*)
     8→"""
     9→import os
    10→import time
    11→import logging
    12→from pathlib import Path
    13→from contextlib import asynccontextmanager
    14→
    15→from fastapi import FastAPI, Request
    16→from fastapi.middleware.cors import CORSMiddleware
    17→
    18→# NOTE: Avoid importing asyncpg-backed DB layer at module import time.
    19→# In tests (VIBELIFE_ENV=test), we lazy-import in lifespan to avoid requiring asyncpg.
    20→
    21→# ─────────────────────────────────────────────────────────────────
    22→# Logging Configuration
    23→# ─────────────────────────────────────────────────────────────────
    24→
    25→# 配置 root logger 输出 INFO 级别日志到控制台
    26→logging.basicConfig(
    27→    level=logging.INFO,
    28→    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    29→    datefmt='%Y-%m-%d %H:%M:%S'
    30→)
    31→
    32→log_dir = Path(os.environ.get("VIBELIFE_LOGS_ROOT", "/tmp/vibelife/logs"))
    33→log_dir.mkdir(parents=True, exist_ok=True)
    34→
    35→request_logger = logging.getLogger("vibelife.requests")
    36→request_logger.setLevel(logging.INFO)
    37→
    38→file_handler = logging.FileHandler(log_dir / "api_requests.log")
    39→file_handler.setFormatter(logging.Formatter(
    40→    '%(asctime)s - %(message)s',
    41→    datefmt='%Y-%m-%d %H:%M:%S'
    42→))
    43→request_logger.addHandler(file_handler)
    44→
    45→# ─────────────────────────────────────────────────────────────────
    46→# Load environment (.env at repo root)
    47→# ─────────────────────────────────────────────────────────────────
    48→
    49→try:
    50→    from dotenv import load_dotenv
    51→except ImportError:
    52→    load_dotenv = None
    53→
    54→if load_dotenv:
    55→    env_path = Path(__file__).resolve().parents[2] / ".env"
    56→    if env_path.exists():
    57→        load_dotenv(env_path, override=False)
    58→
    59→# ─────────────────────────��───────────────────────────────────────
    60→# Lifespan (startup/shutdown)
    61→# ─────────────────────────────────────────────────────────────────
    62→
    63→@asynccontextmanager
    64→async def lifespan(app: FastAPI):
    65→    """Application lifespan handler"""
    66→    # Startup
    67→    print("Starting VibeLife API v7.0...")
    68→
    69→    TEST_MODE = os.getenv("VIBELIFE_ENV") == "test"
    70→
    71→    # Lazy import DB only when not running tests to avoid asyncpg requirement
    72→    if not TEST_MODE:
    73→        from stores.db import init_db  # type: ignore
    74→        await init_db()
    75→        print("Database connected")
    76→    else:
    77→        print("Test mode: skipping DB initialization")
    78→
    79→    # Initialize Tool Registry (v6.0)
    80→    if not TEST_MODE:
    81→        try:
    82→            from services.agent import ToolRegistry
    83→            import services.agent.global_handlers  # noqa: F401
    84→            ToolRegistry.initialize()
    85→            print(f"ToolRegistry initialized: {len(ToolRegistry._handlers)} handlers")
    86→        except Exception as e:
    87→            print(f"ToolRegistry init skipped/failed: {e}")
    88→
    89→    # Initialize Skill Service Registry (v6.8)
    90→    if not TEST_MODE:
    91→        try:
    92→            from services.agent.skill_service_registry import SkillServiceRegistry
    93→            SkillServiceRegistry.initialize()
    94→            print(f"SkillServiceRegistry initialized: {len(SkillServiceRegistry._services)} services")
    95→        except Exception as e:
    96→            print(f"SkillServiceRegistry init skipped/failed: {e}")
    97→
    98→    yield
    99→
   100→    # Shutdown
   101→    print("Shutting down VibeLife API...")
   102→
   103→    if not TEST_MODE:
   104→        try:
   105→            from stores.db import close_db  # type: ignore
   106→            await close_db()
   107→            print("Database closed")
   108→        except Exception as e:
   109→            print(f"DB close skipped/failed: {e}")
   110→
   111→
   112→# ─────────────────────────────────────────────────────────────────
   113→# App Creation
   114→# ─────────────────────────────────────────────────────────────────
   115→
   116→app = FastAPI(
   117→    title="VibeLife API",
   118→    description="The Living Companion - AI-powered personal growth platform",
   119→    version="7.0.0",
   120→    lifespan=lifespan,
   121→    docs_url=None,
   122→    redoc_url=None,
   123→)
   124→
   125→# ─────────────────────────────────────────────────────────────────
   126→# CORS Middleware
   127→# ─────────────────────────────────────────────────────────────────
   128→
   129→cors_origins = os.getenv("VIBELIFE_CORS_ORIGINS", "http://localhost:3000").split(",")
   130→
   131→app.add_middleware(
   132→    CORSMiddleware,
   133→    allow_origins=cors_origins,
   134→    allow_credentials=True,
   135→    allow_methods=["*"],
   136→    allow_headers=["*"],
   137→)
   138→
   139→
   140→# ─────────────────────────────────────────────────────────────────
   141→# Request Logging Middleware
   142→# ─────────────────────────────────────────────────────────────────
   143→
   144→@app.middleware("http")
   145→async def log_requests(request: Request, call_next):
   146→    """记录所有 HTTP 请求的详细信息"""
   147→    start_time = time.time()
   148→
   149→    client_ip = request.client.host if request.client else "unknown"
   150→    xff = request.headers.get("x-forwarded-for", "-")
   151→    x_real_ip = request.headers.get("x-real-ip", "-")
   152→    cf_ip = request.headers.get("cf-connecting-ip", "-")
   153→
   154→    response = await call_next(request)
   155→
   156→    process_time = (time.time() - start_time) * 1000
   157→
   158→    request_logger.info(
   159→        f'{client_ip} "{request.method} {request.url.path}" '
   160→        f'{response.status_code} {process_time:.2f}ms '
   161→        f'xff="{xff}" xrealip="{x_real_ip}" cf_ip="{cf_ip}" '
   162→        f'ua="{request.headers.get("user-agent", "-")}"'
   163→    )
   164→
   165→    return response
   166→
   167→
   168→# ─────────────────────────────────────────────────────────────────
   169→# Routes Import (v6.8 Simplified)
   170→# ─────────────────────────────────────────────────────────────────
   171→
   172→# Router imports
   173→# In test mode, import only the minimal routers to reduce heavy deps.
   174→from routes.health import router as health_router
   175→from routes.account import router as account_router
   176→
   177→TEST_MODE = os.getenv("VIBELIFE_ENV") == "test"
   178→
   179→if not TEST_MODE:
   180→    try:
   181→        from routes.chat_v5 import router as chat_v5_router  # type: ignore
   182→    except Exception as e:
   183→        chat_v5_router = None  # type: ignore
   184→        print(f"chat_v5 router import skipped: {e}")
   185→    try:
   186→        from routes.tools import router as tools_router  # type: ignore
   187→    except Exception as e:
   188→        tools_router = None  # type: ignore
   189→        print(f"tools router import skipped: {e}")
   190→    try:
   191→        from routes.skills import router as skills_router  # type: ignore
   192→    except Exception as e:
   193→        skills_router = None  # type: ignore
   194→        print(f"skills router import skipped: {e}")
   195→    try:
   196→        from routes.commerce import router as commerce_router  # type: ignore
   197→    except Exception as e:
   198→        commerce_router = None  # type: ignore
   199→        print(f"commerce router import skipped: {e}")
   200→    try:
   201→        from routes.notifications import router as notifications_router  # type: ignore
   202→    except Exception as e:
   203→        notifications_router = None  # type: ignore
   204→        print(f"notifications router import skipped: {e}")
   205→
   206→# ─────────────────────────────────────────────────────────────────
   207→# Register Routers (v6.8 Simplified - 7 routers total)
   208→# ─────────────────────────────────────────────────────────────────
   209→
   210→# Health check (no prefix)
   211→app.include_router(health_router, tags=["Health"])
   212→
   213→# Minimal routes for TEST_MODE
   214→if TEST_MODE:
   215→    app.include_router(account_router, prefix="/api/v1", tags=["Account"])
   216→    try:
   217→        from routes.chat_v5 import router as chat_v5_router  # type: ignore
   218→        app.include_router(chat_v5_router, prefix="/api/v1", tags=["Chat"])  # type: ignore[arg-type]
   219→    except Exception as e:
   220→        print(f"chat_v5 router import skipped in test: {e}")
   221→    try:
   222→        from routes.tools import router as tools_router  # type: ignore
   223→        app.include_router(tools_router, prefix="/api/v1", tags=["Tools"])  # type: ignore[arg-type]
   224→    except Exception as e:
   225→        print(f"tools router import skipped in test: {e}")
   226→    try:
   227→        from routes.skills import router as skills_router  # type: ignore
   228→        app.include_router(skills_router, prefix="/api/v1", tags=["Skills"])  # type: ignore[arg-type]
   229→    except Exception as e:
   230→        print(f"skills router import skipped in test: {e}")
   231→    try:
   232→        from routes.notifications import router as notifications_router  # type: ignore
   233→        app.include_router(notifications_router, prefix="/api/v1", tags=["Notifications"])  # type: ignore[arg-type]
   234→    except Exception as e:
   235→        print(f"notifications router import skipped in test: {e}")
   236→else:
   237→    # Core API
   238→    if chat_v5_router:
   239→        app.include_router(chat_v5_router, prefix="/api/v1", tags=["Chat"])  # type: ignore[arg-type]
   240→    if tools_router:
   241→        app.include_router(tools_router, prefix="/api/v1", tags=["Tools"])  # type: ignore[arg-type]
   242→
   243→    # v6.8 Unified routes
   244→    if skills_router:
   245→        app.include_router(skills_router, prefix="/api/v1", tags=["Skills"])  # type: ignore[arg-type]
   246→    app.include_router(account_router, prefix="/api/v1", tags=["Account"])
   247→    if commerce_router:
   248→        app.include_router(commerce_router, prefix="/api/v1", tags=["Commerce"])  # type: ignore[arg-type]
   249→
   250→    # Platform routes
   251→    if notifications_router:
   252→        app.include_router(notifications_router, prefix="/api/v1", tags=["Notifications"])  # type: ignore[arg-type]
   253→
   254→
   255→# ─────────────────────────────────────────────────────────────────
   256→# Config Reload Endpoint
   257→# ─────────────────────────────────────────────────────────────────
   258→
   259→@app.post("/api/v1/config/reload")
   260→async def reload_config_endpoint():
   261→    """热重载 LLM 模型配置 (无需重启服务)"""
   262→    try:
   263→        from services.model_router import reload_config, get_model_config
   264→        config = reload_config()
   265→        return {
   266→            "status": "ok",
   267→            "message": "配置已重新加载",
   268→            "providers": list(config.providers.keys()),
   269→            "models": list(config.models.keys()),
   270→            "defaults": {
   271→                cap: {"primary": route.primary, "fallback": route.fallback}
   272→                for cap, route in config.defaults.items()
   273→            },
   274→            "global_fallback": config.global_fallback,
   275→        }
   276→    except Exception as e:
   277→        from fastapi import HTTPException
   278→        raise HTTPException(status_code=500, detail=f"配置重载失败: {str(e)}")
   279→
   280→
   281→@app.get("/api/v1/config/current")
   282→async def get_current_config():
   283→    """获取当前 LLM 模型配置"""
   284→    try:
   285→        from services.model_router import get_model_config
   286→        config = get_model_config()
   287→        return {
   288→            "providers": {
   289→                pid: {"name": p.name, "enabled": p.enabled}
   290→                for pid, p in config.providers.items()
   291→            },
   292→            "models": {
   293→                mid: {"provider": m.provider, "model_name": m.model_name}
   294→                for mid, m in config.models.items()
   295→            },
   296→            "defaults": {
   297→                cap: {"primary": route.primary, "fallback": route.fallback}
   298→                for cap, route in config.defaults.items()
   299→            },
   300→            "global_fallback": config.global_fallback,
   301→        }
   302→    except Exception as e:
   303→        from fastapi import HTTPException
   304→        raise HTTPException(status_code=500, detail=f"获取配置失败: {str(e)}")
   305→
   306→
   307→# ─────────────────────────────────────────────────────────────────
   308→# Root Endpoint
   309→# ─────────────────────────────────────────────────────────────────
   310→
   311→@app.get("/")
   312→async def root():
   313→    """Root endpoint - return 404 to hide API info"""
   314→    from fastapi import HTTPException
   315→    raise HTTPException(status_code=404, detail="Not Found")
   316→
   317→
   318→# ─────────────────────────────────────────────────────────────────
   319→# Run with uvicorn (for development)
   320→# ─────────────────────────────────────────────────────────────────
   321→
   322→if __name__ == "__main__":
   323→    import uvicorn
   324→
   325→    port = int(os.getenv("VIBELIFE_API_PORT", 8000))
   326→    host = os.getenv("VIBELIFE_API_HOST", "0.0.0.0")
   327→
   328→    uvicorn.run(
   329→        "main:app",
   330→        host=host,
   331→        port=port,
   332→        reload=os.getenv("VIBELIFE_DEV", "0") == "1",
   333→    )
   334→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
