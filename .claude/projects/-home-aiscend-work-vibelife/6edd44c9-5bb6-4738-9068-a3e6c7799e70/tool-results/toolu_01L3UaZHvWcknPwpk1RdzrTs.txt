     1→"use client";
     2→
     3→/**
     4→ * LifeCoachProvider - V8 人生仪表盘状态管理
     5→ *
     6→ * 提供 LifeCoach 数据的全局状态管理:
     7→ * - 北极星愿景
     8→ * - 核心目标
     9→ * - 周大石头
    10→ * - 每日杠杆
    11→ * - 进度统计
    12→ */
    13→
    14→import {
    15→  createContext,
    16→  useContext,
    17→  useState,
    18→  useCallback,
    19→  useMemo,
    20→  useEffect,
    21→  type ReactNode,
    22→} from "react";
    23→import type {
    24→  LifeCoachState,
    25→  NorthStar,
    26→  Goal,
    27→  Role,
    28→  Identity,
    29→  WeeklyRocks,
    30→  DailyLevers,
    31→  MonthlyBoss,
    32→  Progress,
    33→  CheckinRequest,
    34→  LifeCoachSection,
    35→} from "@/types/lifecoach";
    36→import {
    37→  readDashboardState,
    38→  readState as apiReadState,
    39→  checkin as apiCheckin,
    40→  completeLever as apiCompleteLever,
    41→  completeRock as apiCompleteRock,
    42→  skipLever as apiSkipLever,
    43→} from "@/lib/lifecoach-api";
    44→import { useAuth } from "./AuthProvider";
    45→
    46→// ═══════════════════════════════════════════════════════════════════════════
    47→// Context Types
    48→// ═══════════════════════════════════════════════════════════════════════════
    49→
    50→interface LifeCoachContextValue extends LifeCoachState {
    51→  // Actions
    52→  loadLifeCoachData: () => Promise<void>;
    53→  updateSection: (section: LifeCoachSection, data: unknown) => Promise<boolean>;
    54→  checkin: (params?: CheckinRequest) => Promise<boolean>;
    55→  completeLever: (leverId: string, notes?: string) => Promise<boolean>;
    56→  completeRock: (rockId: string, reflection?: string) => Promise<boolean>;
    57→  skipLever: (leverId: string, reason?: string) => Promise<boolean>;
    58→  refresh: () => Promise<void>;
    59→  // Computed
    60→  todayCheckedIn: boolean;
    61→  hasNorthStar: boolean;
    62→  hasIdentity: boolean;
    63→  activeGoalsCount: number;
    64→  todayLeversCount: number;
    65→  todayLeversCompleted: number;
    66→}
    67→
    68→const LifeCoachContext = createContext<LifeCoachContextValue | null>(null);
    69→
    70→// ═══════════════════════════════════════════════════════════════════════════
    71→// Provider Component
    72→// ═══════════════════════════════════════════════════════════════════════════
    73→
    74→interface LifeCoachProviderProps {
    75→  children: ReactNode;
    76→}
    77→
    78→export function LifeCoachProvider({ children }: LifeCoachProviderProps) {
    79→  const { isAuthenticated } = useAuth();
    80→
    81→  // State
    82→  const [northStar, setNorthStar] = useState<NorthStar | null>(null);
    83→  const [goals, setGoals] = useState<Goal[]>([]);
    84→  const [roles, setRoles] = useState<Role[]>([]);
    85→  const [identity, setIdentity] = useState<Identity | null>(null);
    86→  const [currentWeek, setCurrentWeek] = useState<WeeklyRocks | null>(null);
    87→  const [currentDaily, setCurrentDaily] = useState<DailyLevers | null>(null);
    88→  const [currentMonth, setCurrentMonth] = useState<MonthlyBoss | null>(null);
    89→  const [progress, setProgress] = useState<Progress | null>(null);
    90→  const [isLoading, setIsLoading] = useState(false);
    91→  const [isInitialized, setIsInitialized] = useState(false);
    92→  const [error, setError] = useState<string | null>(null);
    93→
    94→  // Load data from API
    95→  const loadLifeCoachData = useCallback(async () => {
    96→    if (!isAuthenticated) {
    97→      setIsInitialized(true);
    98→      return;
    99→    }
   100→
   101→    setIsLoading(true);
   102→    setError(null);
   103→
   104→    try {
   105→      const data = await readDashboardState();
   106→
   107→      if (data.north_star) setNorthStar(data.north_star);
   108→      if (data.goals) setGoals(data.goals);
   109→      if (data.roles) setRoles(data.roles);
   110→      if (data.identity) setIdentity(data.identity);
   111→      if (data.weekly_rocks) setCurrentWeek(data.weekly_rocks);
   112→      if (data.daily_levers) setCurrentDaily(data.daily_levers);
   113→      if (data.monthly_boss) setCurrentMonth(data.monthly_boss);
   114→      if (data.progress) setProgress(data.progress);
   115→
   116→      setIsInitialized(true);
   117→    } catch (err) {
   118→      const message = err instanceof Error ? err.message : "Failed to load data";
   119→      setError(message);
   120→      console.error("LifeCoach data load error:", err);
   121→    } finally {
   122→      setIsLoading(false);
   123→    }
   124→  }, [isAuthenticated]);
   125→
   126→  // Checkin action
   127→  const checkin = useCallback(async (params?: CheckinRequest): Promise<boolean> => {
   128→    try {
   129→      const result = await apiCheckin(params);
   130→
   131→      if (result.success) {
   132→        // Update progress with new streak
   133→        setProgress((prev) =>
   134→          prev
   135→            ? {
   136→                ...prev,
   137→                current_streak: result.streak,
   138→                today_checked_in: true,
   139→                last_checkin_date: new Date().toISOString().split("T")[0],
   140→              }
   141→            : null
   142→        );
   143→
   144→        // Update daily levers if returned
   145→        if (result.daily_levers) {
   146→          setCurrentDaily(result.daily_levers);
   147→        }
   148→
   149→        return true;
   150→      }
   151→      return false;
   152→    } catch (err) {
   153→      console.error("Checkin error:", err);
   154→      return false;
   155→    }
   156→  }, []);
   157→
   158→  // Update section action - 通用更新方法
   159→  const updateSection = useCallback(
   160→    async (section: LifeCoachSection, data: unknown): Promise<boolean> => {
   161→      try {
   162→        // 根据 section 更新对应的本地状态
   163→        switch (section) {
   164→          case "north_star":
   165→            setNorthStar(data as NorthStar);
   166→            break;
   167→          case "goals":
   168→            setGoals(data as Goal[]);
   169→            break;
   170→          case "roles":
   171→            setRoles(data as Role[]);
   172→            break;
   173→          case "identity":
   174→            setIdentity(data as Identity);
   175→            break;
   176→          case "weekly_rocks":
   177→            setCurrentWeek(data as WeeklyRocks);
   178→            break;
   179→          case "daily_levers":
   180→            setCurrentDaily(data as DailyLevers);
   181→            break;
   182→          case "monthly_boss":
   183→            setCurrentMonth(data as MonthlyBoss);
   184→            break;
   185→          case "progress":
   186→            setProgress(data as Progress);
   187→            break;
   188→        }
   189→
   190→        // 重新从服务器获取最新数据以确保同步
   191→        const freshData = await apiReadState([section]);
   192→
   193→        // 更新对应状态
   194→        if (freshData.north_star && section === "north_star") setNorthStar(freshData.north_star);
   195→        if (freshData.goals && section === "goals") setGoals(freshData.goals);
   196→        if (freshData.roles && section === "roles") setRoles(freshData.roles);
   197→        if (freshData.identity && section === "identity") setIdentity(freshData.identity);
   198→        if (freshData.weekly_rocks && section === "weekly_rocks") setCurrentWeek(freshData.weekly_rocks);
   199→        if (freshData.daily_levers && section === "daily_levers") setCurrentDaily(freshData.daily_levers);
   200→        if (freshData.monthly_boss && section === "monthly_boss") setCurrentMonth(freshData.monthly_boss);
   201→        if (freshData.progress && section === "progress") setProgress(freshData.progress);
   202→
   203→        return true;
   204→      } catch (err) {
   205→        console.error("Update section error:", err);
   206→        return false;
   207→      }
   208→    },
   209→    []
   210→  );
   211→
   212→  // Complete lever action
   213→  const completeLever = useCallback(
   214→    async (leverId: string, notes?: string): Promise<boolean> => {
   215→      try {
   216→        const result = await apiCompleteLever({ lever_id: leverId, notes });
   217→
   218→        if (result.success) {
   219→          // Optimistically update local state
   220→          setCurrentDaily((prev) => {
   221→            if (!prev) return prev;
   222→            const updatedLevers = prev.levers.map((lever) =>
   223→              lever.id === leverId
   224→                ? { ...lever, status: "completed" as const, completed_at: new Date().toISOString() }
   225→                : lever
   226→            );
   227→            const completed = updatedLevers.filter((l) => l.status === "completed").length;
   228→            return {
   229→              ...prev,
   230→              levers: updatedLevers,
   231→              stats: {
   232→                total: updatedLevers.length,
   233→                completed,
   234→                completion_rate: Math.round((completed / updatedLevers.length) * 100),
   235→              },
   236→            };
   237→          });
   238→
   239→          // Update progress if returned
   240→          if (result.progress) {
   241→            setProgress(result.progress);
   242→          }
   243→
   244→          return true;
   245→        }
   246→        return false;
   247→      } catch (err) {
   248→        console.error("Complete lever error:", err);
   249→        return false;
   250→      }
   251→    },
   252→    []
   253→  );
   254→
   255→  // Complete rock action
   256→  const completeRock = useCallback(
   257→    async (rockId: string, reflection?: string): Promise<boolean> => {
   258→      try {
   259→        const result = await apiCompleteRock({ rock_id: rockId, reflection });
   260→
   261→        if (result.success) {
   262→          // Optimistically update local state
   263→          setCurrentWeek((prev) => {
   264→            if (!prev) return prev;
   265→            const updatedRocks = prev.rocks.map((rock) =>
   266→              rock.id === rockId
   267→                ? { ...rock, status: "completed" as const, progress: 100 }
   268→                : rock
   269→            );
   270→            const completed = updatedRocks.filter((r) => r.status === "completed").length;
   271→            const inProgress = updatedRocks.filter((r) => r.status === "in_progress").length;
   272→            return {
   273→              ...prev,
   274→              rocks: updatedRocks,
   275→              stats: {
   276→                total: updatedRocks.length,
   277→                completed,
   278→                in_progress: inProgress,
   279→                completion_rate: Math.round((completed / updatedRocks.length) * 100),
   280→              },
   281→            };
   282→          });
   283→
   284→          // Update progress if returned
   285→          if (result.progress) {
   286→            setProgress(result.progress);
   287→          }
   288→
   289→          return true;
   290→        }
   291→        return false;
   292→      } catch (err) {
   293→        console.error("Complete rock error:", err);
   294→        return false;
   295→      }
   296→    },
   297→    []
   298→  );
   299→
   300→  // Skip lever action
   301→  const skipLever = useCallback(
   302→    async (leverId: string, reason?: string): Promise<boolean> => {
   303→      try {
   304→        const result = await apiSkipLever(leverId, reason);
   305→
   306→        if (result.success) {
   307→          // Optimistically update local state
   308→          setCurrentDaily((prev) => {
   309→            if (!prev) return prev;
   310→            return {
   311→              ...prev,
   312→              levers: prev.levers.map((lever) =>
   313→                lever.id === leverId
   314→                  ? { ...lever, status: "skipped" as const }
   315→                  : lever
   316→              ),
   317→            };
   318→          });
   319→
   320→          return true;
   321→        }
   322→        return false;
   323→      } catch (err) {
   324→        console.error("Skip lever error:", err);
   325→        return false;
   326→      }
   327→    },
   328→    []
   329→  );
   330→
   331→  // Refresh data
   332→  const refresh = useCallback(async () => {
   333→    await loadLifeCoachData();
   334→  }, [loadLifeCoachData]);
   335→
   336→  // Auto-load on auth change
   337→  useEffect(() => {
   338→    if (isAuthenticated && !isInitialized) {
   339→      loadLifeCoachData();
   340→    }
   341→  }, [isAuthenticated, isInitialized, loadLifeCoachData]);
   342→
   343→  // Computed values
   344→  const todayCheckedIn = progress?.today_checked_in ?? false;
   345→  const hasNorthStar = Boolean(northStar?.vision_scene || northStar?.identity_statement);
   346→  const hasIdentity = Boolean(identity?.target);
   347→  const activeGoalsCount = goals.filter((g) => g.status === "active").length;
   348→  const todayLeversCount = currentDaily?.levers.length ?? 0;
   349→  const todayLeversCompleted =
   350→    currentDaily?.levers.filter((l) => l.status === "completed").length ?? 0;
   351→
   352→  // Memoized context value
   353→  const contextValue = useMemo<LifeCoachContextValue>(
   354→    () => ({
   355→      // State
   356→      northStar,
   357→      goals,
   358→      roles,
   359→      identity,
   360→      currentWeek,
   361→      currentDaily,
   362→      currentMonth,
   363→      progress,
   364→      isLoading,
   365→      isInitialized,
   366→      error,
   367→      // Actions
   368→      loadLifeCoachData,
   369→      updateSection,
   370→      checkin,
   371→      completeLever,
   372→      completeRock,
   373→      skipLever,
   374→      refresh,
   375→      // Computed
   376→      todayCheckedIn,
   377→      hasNorthStar,
   378→      hasIdentity,
   379→      activeGoalsCount,
   380→      todayLeversCount,
   381→      todayLeversCompleted,
   382→    }),
   383→    [
   384→      northStar,
   385→      goals,
   386→      roles,
   387→      identity,
   388→      currentWeek,
   389→      currentDaily,
   390→      currentMonth,
   391→      progress,
   392→      isLoading,
   393→      isInitialized,
   394→      error,
   395→      loadLifeCoachData,
   396→      updateSection,
   397→      checkin,
   398→      completeLever,
   399→      completeRock,
   400→      skipLever,
   401→      refresh,
   402→      todayCheckedIn,
   403→      hasNorthStar,
   404→      hasIdentity,
   405→      activeGoalsCount,
   406→      todayLeversCount,
   407→      todayLeversCompleted,
   408→    ]
   409→  );
   410→
   411→  return (
   412→    <LifeCoachContext.Provider value={contextValue}>
   413→      {children}
   414→    </LifeCoachContext.Provider>
   415→  );
   416→}
   417→
   418→// ═══════════════════════════��═══════════════════════════════════════════════
   419→// Hook
   420→// ═══════════════════════════════════════════════════════════════════════════
   421→
   422→export function useLifeCoach(): LifeCoachContextValue {
   423→  const context = useContext(LifeCoachContext);
   424→  if (!context) {
   425→    throw new Error("useLifeCoach must be used within LifeCoachProvider");
   426→  }
   427→  return context;
   428→}
   429→
   430→// Convenience hooks for specific data
   431→export function useNorthStar() {
   432→  const { northStar, hasNorthStar, isLoading } = useLifeCoach();
   433→  return { northStar, hasNorthStar, isLoading };
   434→}
   435→
   436→export function useGoals() {
   437→  const { goals, activeGoalsCount, isLoading } = useLifeCoach();
   438→  return { goals, activeGoalsCount, isLoading };
   439→}
   440→
   441→export function useWeeklyRocks() {
   442→  const { currentWeek, completeRock, isLoading } = useLifeCoach();
   443→  return { currentWeek, completeRock, isLoading };
   444→}
   445→
   446→export function useDailyLevers() {
   447→  const { currentDaily, completeLever, skipLever, isLoading } = useLifeCoach();
   448→  return { currentDaily, completeLever, skipLever, isLoading };
   449→}
   450→
   451→export function useProgress() {
   452→  const { progress, todayCheckedIn, checkin, isLoading } = useLifeCoach();
   453→  return { progress, todayCheckedIn, checkin, isLoading };
   454→}
   455→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
