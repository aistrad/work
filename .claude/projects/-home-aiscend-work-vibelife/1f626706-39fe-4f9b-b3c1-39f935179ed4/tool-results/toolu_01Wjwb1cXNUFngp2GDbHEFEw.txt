The file /home/aiscend/work/vibelife/docs/archive/v4/core-algo-review.md has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   826→| `components/chat/ChatContainer.tsx` | 对话主容器 | ~300 |
   827→| `hooks/useVibeChat.ts` | AI SDK 6 封装 | ~150 |
   828→| `providers/SkillProvider.tsx` | Skill 上下文管理 | ~100 |
   829→
   830→---
   831→
   832→# 七、深度报告生成 - 修复方案设计
   833→
   834→> **决策日期**: 2026-01-09
   835→> **方案选择**: A+ 折中方案 (最小修复 + Gemini Imagen 真实 AI 生图)
   836→
   837→## 7.1 修复范围
   838→
   839→| 修复项 | 原状态 | 目标状态 | 实现方式 |
   840→|--------|--------|---------|---------|
   841→| 报告持久化 | ❌ 未保存 | ✅ 保存到 DB | `generate_report()` 末尾调用 `report_repo.create_report()` |
   842→| 访谈强制性 | ❌ 可跳过无警告 | ⚠️ 可跳过+警告 | 保留 skip，添加 `skipped_warning` 字段 |
   843→| 升级流程 | ❌ NotImplementedError | ✅ 状态更新 | `report_repo.update_report_status(is_paid=True)` |
   844→| AI 生图 | ❌ Placeholder | ✅ Gemini Imagen 3 | 集成 Google Generative AI SDK |
   845→
   846→## 7.2 AI 生图集成设计
   847→
   848→```
   849→┌────────────────────────────────────────────────────────────────────────────┐
   850→│                  Gemini Imagen 3 集成方案                                    │
   851→├────────────────────────────────────────────────────────────────────────────┤
   852→│                                                                            │
   853→│  环境变量:                                                                  │
   854→│  ├─ GOOGLE_API_KEY: Gemini API Key                                         │
   855→│  └─ IMAGE_STORAGE_BUCKET: GCS/R2/S3 存储桶                                 │
   856→│                                                                            │
   857→│  调用流程:                                                                  │
   858→│  1. 根据 profile + skill 构建 prompt                                       │
   859→│  2. 调用 Gemini Imagen 3 API 生成图片                                      │
   860→│  3. 上传到云存储获取 URL                                                    │
   861→│  4. 生成缩略图 (加/不加水印)                                                │
   862→│  5. 返回 url + thumbnail_url                                               │
   863→│                                                                            │
   864→│  降级策略:                                                                  │
   865→│  ├─ API 失败 → 使用静态占位图                                              │
   866→│  └─ 超时 → 异步生成，报告先返回                                            │
   867→│                                                                            │
   868→└────────────────────────────────────────────────────────────────────────────┘
   869→```
   870→
   871→## 7.3 数据流变更
   872→
   873→```
   874→修复前:
   875→─────────────────────────────────────────────────────────────────────────────
   876→ReportService.generate_report()
   877→├─ PrologueGenerator.generate()
   878→├─ _generate_section() × 4
   879→├─ ImageGenerator.generate_poster() → placeholder
   880→└─ return Report  ← 直接返回，未持久化
   881→
   882→修复后:
   883→─────────────────────────────────────────────────────────────────────────────
   884→ReportService.generate_report()
   885→├─ PrologueGenerator.generate()
   886→├─ _generate_section() × 4
   887→├─ ImageGenerator.generate_poster() → Gemini Imagen 3
   888→├─ report_repo.create_report()  ← 新增: 持久化到 DB
   889→└─ return Report
   890→
   891→升级流程:
   892→─────────────────────────────────────────────────────────────────────────────
   893→ReportService.upgrade_report(report_id, user_id)
   894→├─ report_repo.get_report(report_id)
   895→├─ 验证 user_id 匹配
   896→├─ report_repo.update_report_status(is_paid=True, report_type="full")
   897→└─ 如需要: 补充生成 premium 章节 + AI 海报
   898→```
   899→
   900→## 7.4 关键代码修改清单
   901→
   902→| 文件 | 修改内容 |
   903→|------|---------|
   904→| `report_service.py` | 添加 `_save_to_db()`, 修改 `generate_report()`, 实现 `upgrade_report()` |
   905→| `image_generator.py` | 集成 Gemini Imagen 3 API, 添加云存储上传 |
   906→| `interview_service.py` | `skip_session()` 添加 `skipped_warning` 标记 |
   907→
   908→---
   909→
   910→# 附录: 关键文件清单
   911→
   912→| 模块 | 文件路径 | 行数 |
   913→|------|----------|------|
   914→| Context 构建 | `apps/api/services/vibe_engine/context.py` | 410 |
   915→| RAG 检索 | `apps/api/services/knowledge/retrieval.py` | 213 |
   916→| 知识库存储 | `apps/api/stores/knowledge_repo.py` | 276 |
   917→| Chat 路由 | `apps/api/routes/chat.py` | 790 |
   918→| 报告服务 | `apps/api/services/report/report_service.py` | 411 |