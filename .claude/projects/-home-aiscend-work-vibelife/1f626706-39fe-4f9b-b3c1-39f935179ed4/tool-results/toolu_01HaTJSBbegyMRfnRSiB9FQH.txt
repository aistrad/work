     1→# VibeLife 核心算法流程 Review
     2→
     3→> **版本**: v4.0
     4→> **日期**: 2026-01-09
     5→> **对比基准**: `vibelife spec v3.0.md` + `architecture-decisions.md`
     6→> **分析深度**: 架构级 + 关键路径代码级
     7→
     8→---
     9→
    10→# 一、核心流程总览 (9 个流程)
    11→
    12→| # | 流程名称 | 设计文档位置 | 代码实现位置 | 实现状态 |
    13→|---|---------|-------------|--------------|---------|
    14→| 1 | **Context 构建** | Spec 4.5 | `context.py` | ✅ 基本完成 |
    15→| 2 | **深度报告生成** | Spec 2.2.1 | `report_service.py` + `prologue_generator.py` | ⚠️ 部分实现 |
    16→| 3 | **RAG 知识库检索** | Spec 4.5 | `retrieval.py` + `knowledge_repo.py` | ✅ 基本完成 |
    17→| 4 | **AI 强制访谈** | Spec 4.2 | `interview_service.py` | ✅ 基本完成 |
    18→| 5 | **智能信息采集** | Spec 4.3 | `extraction_service.py` | ✅ 基本完成 |
    19→| 6 | **Identity Prism** | Spec 2.2.3 + 4.6 | `portrait.py` | ⚠️ 数据结构有，算法缺失 |
    20→| 7 | **对话流式响应** | Spec 2.2.2 | `chat.py` | ✅ 完成 |
    21→| 8 | **用户 Profile 累积** | Spec 4.4 | `portrait.py` + `profile_repo.py` | ⚠️ 结构有，更新逻辑弱 |
    22→| 9 | **关系模拟器/人生K线** | Spec 2.2.4 + 2.2.5 | 前端 tools + 后端计算 | ⚠️ 前端有，后端计算存根 |
    23→
    24→---
    25→
    26→# 二、重点流程深度对比
    27→
    28→## 2.1 Context 构建流程
    29→
    30→### 设计规格 (Spec 4.5)
    31→
    32→```
    33→┌────────────────────────────────────────────────────────────────┐
    34→│                 设计中的 Context 构建流程                       │
    35→├────────────────────────────────────────────────────────────────┤
    36→│                                                                │
    37→│  1. 话题分类 (classify_topic)                                  │
    38→│     └─ 根据消息内容识别: CAREER / RELATIONSHIP / FORTUNE / SELF│
    39→│                                                                │
    40→│  2. Profile 动态选择 (select_profile_sections)                 │
    41→│     ├─ 总是包含: basic, identity_prism                         │
    42→│     ├─ career 话题: career, growth_areas                       │
    43→│     ├─ relationship 话题: relationship, relationship_patterns  │
    44→│     ├─ fortune 话题: current_focus, recent_events              │
    45→│     └─ self 话题: 全部 ai_insights                             │
    46→│                                                                │
    47→│  3. 知识库检索 (retrieve_knowledge)                            │
    48→│     └─ 根据 skill + query 检索相关内容                         │
    49→│                                                                │
    50→│  4. System Prompt 构建                                         │
    51→│     └─ Persona + Voice Mode + Skill Context + 额外上下文       │
    52→│                                                                │
    53→│  5. 对话历史 (原始保留，不摘要)                                 │
    54→│     └─ 最近 N 轮对话                                           │
    55→│                                                                │
    56→│  6. 组装并返回                                                  │
    57→│     └─ (system_prompt, messages)                               │
    58→│                                                                │
    59→└────────────────────────────────────────────────────────────────┘
    60→```
    61→
    62→### 实际实现 (context.py)
    63→
    64→```python
    65→# 文件: apps/api/services/vibe_engine/context.py
    66→
    67→async def build(
    68→    self,
    69→    skill: Skill,
    70→    voice_mode: VoiceMode,
    71→    current_message: str,
    72→    profile: Optional[Dict[str, Any]] = None,
    73→    history: Optional[List[Dict[str, str]]] = None,
    74→    knowledge_chunks: Optional[List[Dict]] = None,  # 来自外部传入
    75→    extra_context: Optional[str] = None
    76→) -> Tuple[str, List[LLMMessage]]:
    77→
    78→    # 1. 构建 System Prompt ✅
    79→    system_prompt = self.build_system_prompt(skill, voice_mode, extra_context)
    80→
    81→    # 2. 话题分类 ✅ (关键词匹配)
    82→    topic = self.classify_topic(current_message)
    83→
    84→    # 3. Profile 选择 ✅
    85→    if profile:
    86→        profile_sections = self.select_profile_sections(profile, topic)
    87→        profile_context = self.format_profile_context(profile_sections)
    88→        # ...
    89→
    90→    # 4. 知识库结果格式化 ✅ (注意: 检索在外部完成)
    91→    if knowledge_chunks:
    92→        knowledge_context = self.format_knowledge_context(knowledge_chunks)
    93→        # ...
    94→
    95→    # 5. 拼接到 system_prompt
    96→    if context_parts:
    97→        system_prompt = system_prompt + "\n\n" + "\n\n".join(context_parts)
    98→
    99→    # 6. 构建消息列表 ✅
   100→    messages = [create_system_message(system_prompt)]
   101→    if history:
   102→        history_messages = self.format_history(history)  # 原始保留
   103→        messages.extend(history_messages)
   104→    messages.append(create_user_message(current_message))
   105→
   106→    return system_prompt, messages
   107→```
   108→
   109→### 差异分析
   110→
   111→| 设计点 | 设计规格 | 实际实现 | 差异 |
   112→|--------|---------|---------|------|
   113→| **话题分类** | LLM 分类 + 关键词回落 | 仅关键词匹配 | ⚠️ 精度不足 |
   114→| **Profile 选择** | 动态选择相关部分 | ✅ 按话题选择 | 一致 |
   115→| **知识库检索** | 在 Context 内部调用 | 在 chat.py 外部调用后传入 | ✅ 职责分离更清晰 |
   116→| **Token 预算管理** | 8000 token 预算 + 动态调整 | 定义了 ContextConfig 但未强制执行 | ⚠️ 无实际 token 计数 |
   117→| **对话历史** | 原始保留，不摘要 | ✅ 原始保留 | 一致 |
   118→| **Voice Mode** | 温暖/吐槽切换 | ✅ 两种模式 Suffix | 一致 |
   119→
   120→### 关键代码路径
   121→
   122→```
   123→chat_stream() (chat.py:150)
   124→    ├─ get_user_profile(user_id)        # L177
   125→    ├─ get_conversation_history(conv_id) # L180
   126→    ├─ RetrievalService.search()        # L185-189 ← RAG 检索
   127→    └─ context_builder.build()          # L195-202 ← Context 组装
   128→        ├─ build_system_prompt()        # context.py:143
   129→        ├─ classify_topic()             # context.py:172 ← 关键词匹配
   130→        ├─ select_profile_sections()    # context.py:214
   131→        ├─ format_profile_context()     # context.py:271
   132→        ├─ format_knowledge_context()   # context.py:299
   133→        └─ format_history()             # context.py:316
   134→```
   135→
   136→---
   137→
   138→## 2.2 深度报告生成流程
   139→
   140→### 设计规格 (Spec 2.2.1)
   141→
   142→```
   143→┌────────────────────────────────────────────────────────────────┐
   144→│                 设计中的报告生成流程                            │
   145→├────────────────────────────────────────────────────────────────┤
   146→│                                                                │
   147→│  1. 基础信息采集                                                │
   148→│     ├─ 必填: 生日（年/月/日）                                  │
   149→│     └─ 选填: 时辰、性别、出生地                                │
   150→│                                                                │
   151→│  2. AI 强制访谈 ★（必须完成，不可跳过）                        │
   152→│     ├─ 2-3 个核心问题                                          │
   153→│     ├─ 采集: 当前困境、目标、关注点                            │
   154→│     └─ 这是报告质量的关键保障                                  │
   155→│                                                                │
   156→│  3. 用户上传资料（可选）                                       │
   157→│     ├─ 其他 App 排盘截图                                       │
   158→│     └─ AI 自动抽取关键信息融入分析                             │
   159→│                                                                │
   160→│  4. 生成报告                                                    │
   161→│     ├─ 综合判断卷首语 (第一人称叙事，10+ 句)                   │
   162→│     └─ 标准报告 (4 个章节)                                     │
   163→│                                                                │
   164→│  5. AI 生图海报 (付费版)                                       │
   165→│     └─ 调用 gemini_tool API                                    │
   166→│                                                                │
   167→│  报告形态:                                                      │
   168→│  ├─ 简版 (免费): 卷首语 + 2 章节 + 预览图带水印                │
   169→│  └─ 完整版 (¥19.9): 全部内容 + 高清海报                        │
   170→│                                                                │
   171→└────────────────────────────────────────────────────────────────┘
   172→```
   173→
   174→### 实际实现 (report_service.py)
   175→
   176→```python
   177→# 文件: apps/api/services/report/report_service.py
   178→
   179→async def generate_report(
   180→    self,
   181→    user_id: UUID,
   182→    skill: str,
   183→    report_type: str,       # "lite" or "full"
   184→    profile: Dict[str, Any],
   185→    interview_result: Optional[Dict[str, Any]] = None,
   186→) -> Report:
   187→
   188→    report = Report(
   189→        id=report_id,
   190→        user_id=user_id,
   191→        skill=skill_enum,
   192→        report_type=type_enum,
   193→        status=ReportStatus.GENERATING,
   194→        # ...
   195→    )
   196→
   197→    # Step 1: 生成卷首语 ✅
   198→    from .prologue_generator import PrologueGenerator
   199→    prologue_gen = PrologueGenerator()
   200→    report.prologue = await prologue_gen.generate(
   201→        profile=profile,
   202→        skill=skill,
   203→        interview_summary=report.interview_summary,
   204→    )
   205→
   206→    # Step 2: 生成章节 ✅ (4 个章节)
   207→    sections = BAZI_SECTIONS if skill == "bazi" else ZODIAC_SECTIONS
   208→
   209→    for i, (section_id, title, subtitle) in enumerate(sections):
   210→        # 简版只生成前 2 章节
   211→        is_premium = type_enum == ReportType.LITE and i >= 2
   212→
   213→        if is_premium and type_enum == ReportType.LITE:
   214→            section = ReportSection(
   215→                id=section_id,
   216→                title=title,
   217→                subtitle=subtitle,
   218→                content="解锁完整报告查看更多内容...",  # 占位
   219→                is_premium=True,
   220→            )
   221→        else:
   222→            section = await self._generate_section(...)  # LLM 生成
   223→
   224→        report.sections.append(section)
   225→
   226→    # Step 3: 生成 AI 海报 (仅完整版) ⚠️
   227→    if type_enum == ReportType.FULL:
   228→        from .image_generator import ImageGenerator
   229→        img_gen = ImageGenerator()
   230→        image_result = await img_gen.generate_poster(...)  # ← 可能是存根
   231→        # ...
   232→
   233→    return report
   234→```
   235→
   236→### 差异分析
   237→
   238→| 设计点 | 设计规格 | 实际实现 | 差异 |
   239→|--------|---------|---------|------|
   240→| **AI 访谈** | 必须完成，不可跳过 | interview_service 支持跳过 | ⚠️ 可跳过，与设计不符 |
   241→| **卷首语** | 第一人称，10+ 句，融合多源数据 | 有实现，风格参数化 | ✅ 基本一致 |
   242→| **章节结构** | 4 章节 (命盘/性格/运势/建议) | ✅ 4 章节定义一致 | 一致 |
   243→| **lite/full 区分** | 前 2 章节免费 | ✅ is_premium 标记 | 一致 |
   244→| **AI 生图** | 调用 gemini_tool API | ImageGenerator 存在，需验证实际调用 | ⚠️ 需确认是否真实调用 |
   245→| **报告持久化** | 保存到数据库 | 生成后未保存到 DB | ❌ 缺失持久化 |
   246→
   247→### 关键缺失
   248→
   249→1. **报告持久化**: `report_service.py` 生成报告后直接返回，未调用 `report_repo` 保存
   250→2. **访谈强制性**: 设计要求"不可跳过"，但 `skip_session()` 允许跳过
   251→3. **升级流程**: `upgrade_report()` 抛出 `NotImplementedError`
   252→
   253→### 关键代码路径
   254→
   255→```
   256→POST /report/generate (假设存在)
   257→    ├─ InterviewService.start_session()   # 开始访谈
   258→    ├─ InterviewService.submit_answer()   # 提交答案 (循环)
   259→    ├─ InterviewService.get_result()      # 获取抽取结果
   260→    └─ ReportService.generate_report()    # 生成报告
   261→        ├─ PrologueGenerator.generate()   # 卷首语
   262→        ├─ _generate_section() × 4        # 4 个章节
   263→        └─ ImageGenerator.generate_poster() # AI 海报
   264→```
   265→
   266→---
   267→
   268→## 2.3 RAG 知识库检索流程
   269→
   270→### 设计规格 (Spec 4.5 + Architecture Decisions)
   271→
   272→```
   273→┌────────────────────────────────────────────────────────────────┐
   274→│                 设计中的知识库检索流程                          │
   275→├────────────────────────────────────────────────────────────────┤
   276→│                                                                │
   277→│  1. 查询预处理                                                  │
   278→│     └─ Jieba 分词 (中文处理)                                   │
   279→│                                                                │
   280→│  2. 混合检索 (Hybrid Search)                                   │
   281→│     ├─ 向量检索: embedding → cosine similarity                 │
   282→│     ├─ 全文检索: FTS → ts_rank                                 │
   283→│     └─ RRF 融合: Reciprocal Rank Fusion                        │
   284→│                                                                │
   285→│  3. 权重配置                                                    │
   286→│     ├─ 向量权重: 0.7                                           │
   287→│     └─ 文本权重: 0.3                                           │
   288→│                                                                │
   289→│  4. 返回 Top-K 结果 (默认 3 条)                                │
   290→│     └─ 注入到 Context 的 <knowledge> 标签                      │
   291→│                                                                │
   292→└────────────────────────────────────────────────────────────────┘
   293→```
   294→
   295→### 实际实现 (retrieval.py + knowledge_repo.py)
   296→
   297→```python
   298→# 文件: apps/api/services/knowledge/retrieval.py
   299→
   300→@classmethod
   301→async def search(
   302→    cls,
   303→    query: str,
   304→    skill_id: str,
   305→    top_k: int = 5,
   306→    use_hybrid: bool = True,
   307→    vector_weight: float = 0.7,
   308→    text_weight: float = 0.3
   309→) -> List[Dict[str, Any]]:
   310→
   311→    # 1. 生成 query embedding ✅
   312→    query_embedding = await EmbeddingService.embed_query(query)
   313→
   314→    if use_hybrid:
   315→        # 2. Jieba 分词预处理 ✅
   316→        query_preprocessed = cls.preprocess_query(query)
   317→
   318→        # 3. 调用 SQL 函数进行混合检索 ✅
   319→        results = await KnowledgeRepository.hybrid_search(
   320→            query_preprocessed=query_preprocessed,
   321→            embedding=query_embedding,
   322→            skill_id=skill_id,
   323→            top_k=top_k,
   324→            vector_weight=vector_weight,
   325→            text_weight=text_weight
   326→        )
   327→    else:
   328→        # 仅向量检索
   329→        results = await KnowledgeRepository.vector_search(...)
   330→
   331→    return results
   332→
   333→# ──────────────────────────────────────────────────────────
   334→
   335→# 文件: apps/api/stores/knowledge_repo.py
   336→
   337→@staticmethod
   338→async def hybrid_search(...) -> List[dict]:
   339→    """调用 PostgreSQL SQL 函数 hybrid_search_v2()"""
   340→    async with get_connection() as conn:
   341→        rows = await conn.fetch(
   342→            """
   343→            SELECT * FROM hybrid_search_v2($1, $2::vector, $3, $4, 60, $5, $6)
   344→            """,
   345→            query_preprocessed,  # Jieba 分词后的查询
   346→            embedding,           # 向量
   347→            skill_id,
   348→            top_k,
   349→            vector_weight,
   350→            text_weight
   351→        )
   352→        return [dict(row) for row in rows]
   353→```
   354→
   355→### 差异分析
   356→
   357→| 设计点 | 设计规格 | 实际实现 | 差异 |
   358→|--------|---------|---------|------|
   359→| **Jieba 分词** | 应用层分词 | ✅ `preprocess_query()` | 一致 |
   360→| **混合检索** | Vector + FTS + RRF | ✅ SQL 函数 `hybrid_search_v2()` | 一致 |
   361→| **权重** | 向量 0.7, 文本 0.3 | ✅ 默认参数一致 | 一致 |
   362→| **Top-K** | 默认 3 条 | 默认 5 条，chat.py 传 3 | ✅ 灵活配置 |
   363→| **结果注入** | `<knowledge>` 标签 | ✅ `format_knowledge_context()` | 一致 |
   364→
   365→### SQL 函数依赖
   366→
   367→```sql
   368→-- 需要在 PostgreSQL 中创建:
   369→-- hybrid_search_v2(query_text, embedding::vector, skill_id, top_k, k_param, vec_weight, text_weight)
   370→-- vector_search_v2(embedding::vector, skill_id, top_k)
   371→-- 表: knowledge_chunks_v2 (含 search_vector tsvector 列)
   372→```
   373→
   374→### 关键代码路径
   375→
   376→```
   377→chat_stream() (chat.py:150)
   378→    └─ RetrievalService.search(query, skill_id, top_k=3)  # L185
   379→        ├─ EmbeddingService.embed_query(query)            # 生成向量
   380→        ├─ preprocess_query(query)                        # Jieba 分词
   381→        └─ KnowledgeRepository.hybrid_search(...)         # SQL 函数
   382→            └─ hybrid_search_v2()                         # PostgreSQL
   383→```
   384→
   385→---
   386→
   387→# 三、其他流程实现状态简表
   388→
   389→## 3.1 AI 强制访谈 (interview_service.py)
   390→
   391→| 设计点 | 实现状态 |
   392→|--------|---------|
   393→| 3 个核心问题 | ✅ `CORE_QUESTIONS` 定义 |
   394→| 问题: 当前困境 | ✅ `q1_concerns` |
   395→| 问题: 生活状态 | ✅ `q2_life_status` |
   396→| 问题: 期望目标 | ✅ `q3_expectations` |
   397→| 答案结构化抽取 | ✅ `_extract_answer_info()` LLM 抽取 |
   398→| Profile 合并 | ✅ `_merge_extracted()` |
   399→| 会话持久化 | ✅ `interview_sessions` 表 |
   400→| **不可跳过** | ❌ `skip_session()` 允许跳过 |
   401→
   402→## 3.2 智能信息采集 (extraction_service.py)
   403→
   404→| 设计点 | 实现状态 |
   405→|--------|---------|
   406→| 图片 OCR + Vision LLM | ✅ 支持 |
   407→| PDF/DOCX 解析 | ✅ 支持 |
   408→| 排盘截图识别 | ✅ `content_type: bazi_screenshot` |
   409→| 聊天记录分析 | ✅ `content_type: chat_history` |
   410→| Profile 更新建议 | ✅ `profile_updates` 字段 |
   411→
   412→## 3.3 Identity Prism (portrait.py)
   413→
   414→| 设计点 | 实现状态 |
   415→|--------|---------|
   416→| Core/Inner/Outer 三层结构 | ✅ `DEFAULT_PROFILE` 包含 `identity_prism` |
   417→| 八字 → Core 映射算法 | ❌ 未实现计算逻辑 |
   418→| 星座 → Inner/Outer 映射 | ❌ 未实现计算逻辑 |
   419→| AI 洞察 → Inner 推断 | ❌ 未实现 |
   420→| 自然语言生成 | ❌ 只有数据结构，无生成逻辑 |
   421→
   422→**核心差异**: Identity Prism 在设计中是核心差异化功能 (Spec 2.2.3 + 4.6)，但代码中只定义了数据结构，没有实现计算/生成算法。
   423→
   424→## 3.4 对话流式响应 (chat.py)
   425→
   426→| 设计点 | 实现状态 |
   427→|--------|---------|
   428→| SSE 流式响应 | ✅ `EventSourceResponse` |
   429→| AI SDK 格式 (`text-delta`) | ⚠️ 使用自定义格式 `{"type": "chunk"}` |
   430→| Tool Calling | ✅ 支持工具调用 |
   431→| 消息持久化 | ✅ `save_message()` |
   432→| Voice Mode 切换 | ✅ `/chat/voice-mode` 端点 |
   433→| 会话列表 | ❌ `/conversations` 返回空数组 |
   434→
   435→**格式差异**:
   436→```
   437→设计 (AI SDK):  {"type": "text-delta", "textDelta": "你好"}
   438→实际实现:       {"type": "chunk", "content": "你好"}
   439→```
   440→
   441→## 3.5 用户 Profile 累积 (portrait.py + profile_repo.py)
   442→
   443→| 设计点 | 实现状态 |
   444→|--------|---------|
   445→| 4 层 Profile 结构 | ✅ basic / life_context / ai_insights / identity_prism |
   446→| 对话洞察抽取 | ⚠️ portrait.py 有 `UPDATE_INTERVAL_MESSAGES = 10`，但未在 chat 中调用 |
   447→| deep_merge | ✅ 存在，但在 portrait.py 和 profile_repo.py 中重复 |
   448→| 版本化存储 | ❌ 未实现版本快照 |
   449→
   450→## 3.6 关系模拟器 / 人生 K 线
   451→
   452→| 设计点 | 实现状态 |
   453→|--------|---------|
   454→| 关系模拟器 UI | ✅ 前端 tools 定义 |
   455→| 合盘计算算法 | ⚠️ 依赖外部命理计算库，未见核心算法 |
   456→| 人生 K 线 UI | ✅ 前端 KLinePanel 组件 |
   457→| 大运流年计算 | ⚠️ 需确认后端计算服务 |
   458→
   459→---
   460→
   461→# 四、差异汇总与优先级建议
   462→
   463→## 4.1 Critical 差异 (P0)
   464→
   465→| 问题 | 设计 | 实现 | 影响 | 修复建议 |
   466→|------|------|------|------|---------|
   467→| **SSE 格式不兼容** | AI SDK 6 `text-delta` | 自定义 `chunk` | 前端 useChat 可能不工作 | 修改 chat.py SSE 事件格式 |
   468→| **报告无持久化** | 保存到数据库 | 生成后未保存 | 报告丢失 | 调用 report_repo 保存 |
   469→| **会话列表空** | 返回历史会话 | 返回空数组 | 用户无法查看历史 | 实现 conversation_repo 查询 |
   470→
   471→## 4.2 High 差异 (P1)
   472→
   473→| 问题 | 设计 | 实现 | 影响 | 修复建议 |
   474→|------|------|------|------|---------|
   475→| **访谈可跳过** | 必须完成 | 允许跳过 | 报告质量下降 | 移除 skip 或添加强制逻辑 |
   476→| **Identity Prism 算法缺失** | 八字→三元视角计算 | 只有数据结构 | 核心功能空壳 | 实现 PrismCalculator |
   477→| **Profile 不自动更新** | 对话中抽取洞察 | 未在 chat 中调用 | 用户画像不成长 | 在 chat 中集成 portrait.update |
   478→| **Token 预算未执行** | 8000 token 限制 | 无实际计数 | 可能超限报错 | 实现 tiktoken 计数 |
   479→
   480→## 4.3 Medium 差异 (P2)
   481→
   482→| 问题 | 设计 | 实现 | 影响 | 修复建议 |
   483→|------|------|------|------|---------|
   484→| **话题分类精度** | LLM + 关键词 | 仅关键词 | 分类不准 | 可选: 添加 LLM 回落 |
   485→| **Profile 版本化** | 保留 10 个版本 | 无版本快照 | 无法回溯 | 添加 profile_versions 表 |
   486→| **deep_merge 重复** | 统一函数 | portrait.py + profile_repo.py 各一份 | 维护问题 | 提取到 utils |
   487→
   488→---
   489→
   490→# 五、后续 Review 任务清单
   491→
   492→本次完成了 **架构级对比** 和 **3 个重点流程的代码级分析**。后续可分次深入：
   493→
   494→- [ ] **Identity Prism 算法设计**: 设计八字/星座→三元视角的映射算法
   495→- [ ] **SSE 格式适配**: 修改后端 SSE 格式兼容 AI SDK 6
   496→- [ ] **报告持久化完善**: 完成 report_repo CRUD
   497→- [ ] **人生 K 线后端计算**: 确认大运/流年计算服务实现状态
   498→- [ ] **关系模拟器合盘算法**: 确认八字/星座合盘计算实现状态
   499→- [ ] **前端集成验证**: 验证 useVibeChat 与后端 SSE 兼容性
   500→
   501→---
   502→
   503→# 附录: 关键文件清单
   504→
   505→| 模块 | 文件路径 | 行数 |
   506→|------|----------|------|
   507→| Context 构建 | `apps/api/services/vibe_engine/context.py` | 410 |
   508→| RAG 检索 | `apps/api/services/knowledge/retrieval.py` | 213 |
   509→| 知识库存储 | `apps/api/stores/knowledge_repo.py` | 276 |
   510→| Chat 路由 | `apps/api/routes/chat.py` | 790 |
   511→| 报告服务 | `apps/api/services/report/report_service.py` | 411 |
   512→| 访谈服务 | `apps/api/services/interview/interview_service.py` | 587 |
   513→| Portrait 服务 | `apps/api/services/vibe_engine/portrait.py` | 541 |
   514→| Profile 存储 | `apps/api/stores/profile_repo.py` | 11765 |
   515→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
