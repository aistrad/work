     1→"""
     2→Image Generator - AI-generated posters for reports
     3→Based on: vibelife spec v3.0
     4→
     5→Uses Nano Banana (or similar AI image generation service) to create:
     6→- Report poster images
     7→- Relationship cards
     8→- Social sharing images
     9→
    10→Image Types:
    11→- Full resolution (for paid users)
    12→- Thumbnail with watermark (for lite/preview)
    13→"""
    14→
    15→import os
    16→import json
    17→import logging
    18→import httpx
    19→from dataclasses import dataclass
    20→from typing import Optional, Dict, Any
    21→from enum import Enum
    22→from uuid import uuid4
    23→
    24→logger = logging.getLogger(__name__)
    25→
    26→
    27→class PosterStyle(str, Enum):
    28→    MINIMAL = "minimal"      # 极简风格
    29→    ARTISTIC = "artistic"    # 艺术风格
    30→    VINTAGE = "vintage"      # 复古风格
    31→    MODERN = "modern"        # 现代风格
    32→
    33→
    34→@dataclass
    35→class GeneratedImage:
    36→    """Result of image generation"""
    37→    id: str
    38→    url: str
    39→    thumbnail_url: Optional[str] = None
    40→    width: int = 1080
    41→    height: int = 1920
    42→    style: PosterStyle = PosterStyle.MINIMAL
    43→    has_watermark: bool = False
    44→    prompt_used: Optional[str] = None
    45→
    46→    def to_dict(self) -> dict:
    47→        return {
    48→            "id": self.id,
    49→            "url": self.url,
    50→            "thumbnail_url": self.thumbnail_url,
    51→            "width": self.width,
    52→            "height": self.height,
    53→            "style": self.style.value,
    54→            "has_watermark": self.has_watermark,
    55→        }
    56→
    57→
    58→# ═══════════════════════════════════════════════════════════════════════════
    59→# Prompt Templates
    60→# ═══════════════════════════════════════════════════════════════════════════
    61→
    62→POSTER_PROMPT_TEMPLATES = {
    63→    "bazi": {
    64→        PosterStyle.MINIMAL: """Minimalist Chinese fortune telling poster,
    65→elegant calligraphy of "{element}" element symbol,
    66→soft watercolor wash background in {color} tones,
    67→subtle gold accent lines,
    68→negative space, zen aesthetic,
    69→high quality, 4k""",
    70→
    71→        PosterStyle.ARTISTIC: """Artistic Chinese Bazi destiny poster,
    72→flowing ink painting style,
    73→{element} element represented as {symbol},
    74→dreamy ethereal atmosphere in {color} palette,
    75→traditional meets modern aesthetic,
    76→high quality, detailed, 4k""",
    77→
    78→        PosterStyle.VINTAGE: """Vintage Chinese almanac style poster,
    79→aged paper texture,
    80→traditional {element} element iconography,
    81→muted {color} color scheme,
    82→subtle typography, classic composition,
    83→high quality, textured, 4k""",
    84→    },
    85→
    86→    "zodiac": {
    87→        PosterStyle.MINIMAL: """Minimalist astrology poster,
    88→elegant constellation of {sign},
    89→deep space background with subtle stars,
    90→{color} accent glow,
    91→clean lines, modern aesthetic,
    92→high quality, 4k""",
    93→
    94→        PosterStyle.ARTISTIC: """Artistic zodiac poster,
    95→ethereal {sign} constellation visualization,
    96→cosmic nebula swirls in {color} tones,
    97→mystical yet sophisticated,
    98→high quality, detailed, 4k""",
    99→
   100→        PosterStyle.MODERN: """Modern astrology poster design,
   101→geometric {sign} symbol,
   102→gradient background in {color} spectrum,
   103→bold typography elements,
   104→contemporary minimalist style,
   105→high quality, 4k""",
   106→    },
   107→}
   108→
   109→# Element to visual mapping (for bazi)
   110→ELEMENT_VISUALS = {
   111→    "wood": {"symbol": "bamboo forest", "color": "green and brown"},
   112→    "fire": {"symbol": "rising flames", "color": "red and orange"},
   113→    "earth": {"symbol": "mountain peaks", "color": "yellow and brown"},
   114→    "metal": {"symbol": "geometric crystals", "color": "white and silver"},
   115→    "water": {"symbol": "flowing waves", "color": "blue and black"},
   116→}
   117→
   118→# Zodiac to visual mapping
   119→ZODIAC_VISUALS = {
   120→    "aries": {"symbol": "ram horns", "color": "red"},
   121→    "taurus": {"symbol": "bull", "color": "green"},
   122→    "gemini": {"symbol": "twins", "color": "yellow"},
   123→    "cancer": {"symbol": "crab", "color": "silver"},
   124→    "leo": {"symbol": "lion", "color": "gold"},
   125→    "virgo": {"symbol": "maiden", "color": "brown"},
   126→    "libra": {"symbol": "scales", "color": "pink"},
   127→    "scorpio": {"symbol": "scorpion", "color": "crimson"},
   128→    "sagittarius": {"symbol": "archer", "color": "purple"},
   129→    "capricorn": {"symbol": "goat", "color": "dark green"},
   130→    "aquarius": {"symbol": "water bearer", "color": "electric blue"},
   131→    "pisces": {"symbol": "fish", "color": "sea green"},
   132→}
   133→
   134→
   135→# ═══════════════════════════════════════════════════════════════════════════
   136→# Image Generator
   137→# ═══════════════════════════════════════════════════════════════════════════
   138→
   139→class ImageGenerator:
   140→    """AI Image generation service"""
   141→
   142→    def __init__(self):
   143→        # Get API configuration from environment
   144→        self.api_key = os.getenv("IMAGE_GEN_API_KEY", "")
   145→        self.api_url = os.getenv("IMAGE_GEN_API_URL", "https://api.example.com/generate")
   146→        self.storage_url = os.getenv("IMAGE_STORAGE_URL", "/static/generated")
   147→
   148→    async def generate_poster(
   149→        self,
   150→        profile: Dict[str, Any],
   151→        skill: str,
   152→        prologue: str,
   153→        style: PosterStyle = PosterStyle.MINIMAL,
   154→        add_watermark: bool = False,
   155→    ) -> Optional[GeneratedImage]:
   156→        """
   157→        Generate a poster image for a report.
   158→
   159→        Args:
   160→            profile: User profile data
   161→            skill: "bazi" or "zodiac"
   162→            prologue: Report prologue text (for context)
   163→            style: Visual style for the poster
   164→            add_watermark: Whether to add VibeLife watermark
   165→
   166→        Returns:
   167→            GeneratedImage or None if generation fails
   168→        """
   169→        try:
   170→            # Build prompt based on skill and profile
   171→            prompt = self._build_prompt(profile, skill, style)
   172→
   173→            # Generate image
   174→            if self.api_key:
   175→                # Call external API
   176→                image_url = await self._call_generation_api(prompt)
   177→            else:
   178→                # Use placeholder in development
   179→                image_url = self._get_placeholder_url(skill, style)
   180→
   181→            if not image_url:
   182→                return None
   183→
   184→            # Generate thumbnail
   185→            thumbnail_url = await self._generate_thumbnail(image_url, add_watermark)
   186→
   187→            return GeneratedImage(
   188→                id=str(uuid4()),
   189→                url=image_url,
   190→                thumbnail_url=thumbnail_url,
   191→                style=style,
   192→                has_watermark=add_watermark,
   193→                prompt_used=prompt,
   194→            )
   195→
   196→        except Exception as e:
   197→            logger.error(f"Image generation failed: {e}")
   198→            return None
   199→
   200→    def _build_prompt(
   201→        self,
   202→        profile: Dict[str, Any],
   203→        skill: str,
   204→        style: PosterStyle,
   205→    ) -> str:
   206→        """Build image generation prompt based on profile"""
   207→
   208→        basic = profile.get("basic", {})
   209→
   210→        if skill == "bazi":
   211→            # Get day master element from profile
   212→            element = basic.get("day_master_element", "wood")
   213→            visuals = ELEMENT_VISUALS.get(element, ELEMENT_VISUALS["wood"])
   214→
   215→            template = POSTER_PROMPT_TEMPLATES["bazi"].get(
   216→                style,
   217→                POSTER_PROMPT_TEMPLATES["bazi"][PosterStyle.MINIMAL]
   218→            )
   219→
   220→            return template.format(
   221→                element=element,
   222→                symbol=visuals["symbol"],
   223→                color=visuals["color"],
   224→            )
   225→        else:
   226→            # Get zodiac sign from profile
   227→            sign = basic.get("zodiac_sign", "aries").lower()
   228→            visuals = ZODIAC_VISUALS.get(sign, ZODIAC_VISUALS["aries"])
   229→
   230→            template = POSTER_PROMPT_TEMPLATES["zodiac"].get(
   231→                style,
   232→                POSTER_PROMPT_TEMPLATES["zodiac"][PosterStyle.MINIMAL]
   233→            )
   234→
   235→            return template.format(
   236→                sign=sign,
   237→                symbol=visuals["symbol"],
   238→                color=visuals["color"],
   239→            )
   240→
   241→    async def _call_generation_api(self, prompt: str) -> Optional[str]:
   242→        """Call external image generation API"""
   243→        try:
   244→            async with httpx.AsyncClient(timeout=60.0) as client:
   245→                response = await client.post(
   246→                    self.api_url,
   247→                    headers={"Authorization": f"Bearer {self.api_key}"},
   248→                    json={
   249→                        "prompt": prompt,
   250→                        "width": 1080,
   251→                        "height": 1920,
   252→                        "num_images": 1,
   253→                    }
   254→                )
   255→
   256→                if response.status_code == 200:
   257→                    data = response.json()
   258→                    return data.get("images", [{}])[0].get("url")
   259→                else:
   260→                    logger.error(f"Image API error: {response.status_code}")
   261→                    return None
   262→
   263→        except Exception as e:
   264→            logger.error(f"Image API call failed: {e}")
   265→            return None
   266→
   267→    def _get_placeholder_url(self, skill: str, style: PosterStyle) -> str:
   268→        """Get placeholder image URL for development"""
   269→        # Use a placeholder service or local static file
   270→        return f"{self.storage_url}/placeholder_{skill}_{style.value}.png"
   271→
   272→    async def _generate_thumbnail(
   273→        self,
   274→        image_url: str,
   275→        add_watermark: bool = False,
   276→    ) -> str:
   277→        """Generate thumbnail version of image"""
   278→        # In production, this would resize the image and add watermark
   279→        # For now, return the same URL with a thumbnail suffix
   280→        if image_url.endswith(".png"):
   281→            return image_url.replace(".png", "_thumb.png")
   282→        return f"{image_url}?thumb=true"
   283→
   284→    async def generate_relationship_card(
   285→        self,
   286→        user1_profile: Dict[str, Any],
   287→        user2_profile: Dict[str, Any],
   288→        relationship_summary: str,
   289→        style: PosterStyle = PosterStyle.MINIMAL,
   290→    ) -> Optional[GeneratedImage]:
   291→        """Generate a shareable relationship card image"""
   292→        # Build combined prompt for relationship
   293→        prompt = f"""Elegant relationship compatibility card,
   294→two intertwined abstract shapes representing connection,
   295→harmonious color palette,
   296→minimalist design, subtle patterns,
   297→high quality, 4k"""
   298→
   299→        if self.api_key:
   300→            image_url = await self._call_generation_api(prompt)
   301→        else:
   302→            image_url = f"{self.storage_url}/placeholder_relationship.png"
   303→
   304→        if not image_url:
   305→            return None
   306→
   307→        return GeneratedImage(
   308→            id=str(uuid4()),
   309→            url=image_url,
   310→            thumbnail_url=await self._generate_thumbnail(image_url, True),
   311→            width=1080,
   312→            height=1080,  # Square for relationship cards
   313→            style=style,
   314→            prompt_used=prompt,
   315→        )
   316→
   317→
   318→# ═══════════════════════════════════════════════════════════════════════════
   319→# Convenience Function
   320→# ═══════════════════════════════════════════════════════════════════════════
   321→
   322→async def generate_poster(
   323→    profile: Dict[str, Any],
   324→    skill: str,
   325→    prologue: str = "",
   326→    style: str = "minimal",
   327→    add_watermark: bool = False,
   328→) -> Optional[GeneratedImage]:
   329→    """
   330→    Convenience function to generate poster.
   331→
   332→    Args:
   333→        profile: User profile data
   334→        skill: "bazi" or "zodiac"
   335→        prologue: Report prologue text
   336→        style: "minimal", "artistic", "vintage", or "modern"
   337→        add_watermark: Whether to add watermark
   338→
   339→    Returns:
   340→        GeneratedImage or None
   341→    """
   342→    generator = ImageGenerator()
   343→    style_enum = PosterStyle(style)
   344→    return await generator.generate_poster(profile, skill, prologue, style_enum, add_watermark)
   345→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
