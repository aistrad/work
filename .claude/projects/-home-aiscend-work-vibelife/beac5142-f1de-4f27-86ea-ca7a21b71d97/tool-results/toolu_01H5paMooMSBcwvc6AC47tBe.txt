     1â†’"use client";
     2â†’
     3â†’/**
     4â†’ * AppShell - ä¸‰æ å¸ƒå±€å®¹å™¨ v8.0
     5â†’ * Based on: vibelife spec v8.0 - LifeCoach Dashboard
     6â†’ *
     7â†’ * V8 å˜æ›´:
     8â†’ * - å¯¼èˆªå…¥å£ä» 4 ä¸ªæ”¹ä¸º 3 ä¸ª: Dashboard / Chat / Me
     9â†’ * - é»˜è®¤é¦–é¡µä» Chat æ”¹ä¸º Dashboard
    10â†’ * - å³ä¾§è¾¹æ æ ¹æ®ä¸»èˆå°æ™ºèƒ½åˆ‡æ¢å†…å®¹
    11â†’ *
    12â†’ * å“åº”å¼æ–­ç‚¹ï¼ˆä¸ tailwind.config.ts ä¿æŒä¸€è‡´ï¼‰ï¼š
    13â†’ * - PC â‰¥1024px (lg): ä¸‰æ å¸ƒå±€
    14â†’ * - Tablet+Mobile <1024px: å•æ  + TabBar
    15â†’ *
    16â†’ * PCç«¯å¸ƒå±€ (â‰¥1024px):
    17â†’ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    18â†’ * â”‚ NavBar â”‚         ä¸»å†…å®¹åŒºåŸŸ             â”‚   Insight Panel        â”‚
    19â†’ * â”‚ (64px) â”‚       (flex-1, å·¦å¯¹é½)         â”‚    (320-600px å¯è°ƒ)    â”‚
    20â†’ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    21â†’ *
    22â†’ * Tablet+ç§»åŠ¨ç«¯å¸ƒå±€ (<1024px):
    23â†’ * â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    24â†’ * â”‚  Header                                  â”‚
    25â†’ * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    26â†’ * â”‚  å†…å®¹åŒºåŸŸ (æ ¹æ®Tabå®Œå…¨åˆ‡æ¢)              â”‚
    27â†’ * â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    28â†’ * â”‚  ğŸ  Dashboard â”‚ ğŸ’¬ Chat â”‚ ğŸ‘¤ Me          â”‚
    29â†’ * â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    30â†’ */
    31â†’
    32â†’import { useState, useEffect, useCallback, createContext, useContext, ReactNode } from "react";
    33â†’import { useSearchParams, useRouter } from "next/navigation";
    34â†’import { apiClient } from "@/lib/api";
    35â†’import { cn } from "@/lib/utils";
    36â†’import { type SkillType } from "@/components/core";
    37â†’import { NavBar } from "./NavBar";
    38â†’import { MobileTabBar } from "./MobileTabBar";
    39â†’import { MobileHeader } from "./MobileHeader";
    40â†’import { ResizablePanel } from "./ResizablePanel";
    41â†’import { MobileConversationDrawer } from "@/components/chat/ConversationSidebar";
    42â†’
    43â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    44â†’// Types
    45â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    46â†’
    47â†’// V9.1: 4 entry points - Chat / Journey / Discover / Me
    48â†’export type TabType = "chat" | "journey" | "discover" | "me";
    49â†’
    50â†’interface AppShellContextValue {
    51â†’  skill: SkillType;
    52â†’  activeTab: TabType;
    53â†’  setActiveTab: (tab: TabType) => void;
    54â†’  voiceMode: "warm" | "sarcastic" | "wise";
    55â†’  setVoiceMode: (mode: "warm" | "sarcastic" | "wise") => void;
    56â†’  // Conversation history management
    57â†’  activeConversationId: string | null;
    58â†’  setActiveConversationId: (id: string | null) => void;
    59â†’  isMobileDrawerOpen: boolean;
    60â†’  setMobileDrawerOpen: (open: boolean) => void;
    61â†’}
    62â†’
    63â†’const AppShellContext = createContext<AppShellContextValue | null>(null);
    64â†’
    65â†’export function useAppShell() {
    66â†’  const context = useContext(AppShellContext);
    67â†’  if (!context) {
    68â†’    throw new Error("useAppShell must be used within AppShell");
    69â†’  }
    70â†’  return context;
    71â†’}
    72â†’
    73â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    74â†’// AppShell Component
    75â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    76â†’
    77â†’interface AppShellProps {
    78â†’  skill: SkillType;
    79â†’  children: ReactNode;
    80â†’  /** Journey å†…å®¹ */
    81â†’  journeyContent?: ReactNode;
    82â†’  /** Discover å†…å®¹ - V9.1 æ–°å¢ */
    83â†’  discoverContent?: ReactNode;
    84â†’  /** Me é¡µé¢å†…å®¹ */
    85â†’  meContent?: ReactNode;
    86â†’  /** åˆå§‹æ¿€æ´»çš„ Tab - V9 é»˜è®¤ä¸º chat */
    87â†’  defaultTab?: TabType;
    88â†’}
    89â†’
    90â†’export function AppShell({
    91â†’  skill,
    92â†’  children,
    93â†’  journeyContent,
    94â†’  discoverContent,
    95â†’  meContent,
    96â†’  defaultTab = "chat",
    97â†’}: AppShellProps) {
    98â†’  const searchParams = useSearchParams();
    99â†’  const router = useRouter();
   100â†’
   101â†’  // ä» URL å‚æ•°è¯»å– tabï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ defaultTab
   102â†’  const urlTab = searchParams?.get("tab") as TabType | null;
   103â†’  const initialTab = (urlTab && ["chat", "journey", "discover", "me"].includes(urlTab))
   104â†’    ? urlTab
   105â†’    : defaultTab;
   106â†’
   107â†’  // ä» URL å‚æ•°è¯»å– conversation_id
   108â†’  const urlConversationId = searchParams?.get("conversation_id");
   109â†’
   110â†’  const [activeTab, setActiveTab] = useState<TabType>(initialTab);
   111â†’  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic" | "wise">("warm");
   112â†’  const [activeConversationId, setActiveConversationIdState] = useState<string | null>(
   113â†’    urlConversationId || null
   114â†’  );
   115â†’  const [isMobileDrawerOpen, setMobileDrawerOpen] = useState(false);
   116â†’
   117â†’  // ç›‘å¬ URL å‚æ•°å˜åŒ–ï¼ŒåŒæ­¥ activeTab
   118â†’  useEffect(() => {
   119â†’    if (urlTab && ["chat", "journey", "discover", "me"].includes(urlTab)) {
   120â†’      setActiveTab(urlTab);
   121â†’    }
   122â†’  }, [urlTab]);
   123â†’
   124â†’  // ç›‘å¬ URL å‚æ•°å˜åŒ–ï¼ŒåŒæ­¥ conversation_id
   125â†’  useEffect(() => {
   126â†’    setActiveConversationIdState(urlConversationId || null);
   127â†’  }, [urlConversationId]);
   128â†’
   129â†’  // è®¾ç½® conversation_id å¹¶æ›´æ–° URL
   130â†’  const setActiveConversationId = useCallback((id: string | null) => {
   131â†’    setActiveConversationIdState(id);
   132â†’    // Update URL without full page reload
   133â†’    const url = new URL(window.location.href);
   134â†’    if (id) {
   135â†’      url.searchParams.set("conversation_id", id);
   136â†’    } else {
   137â†’      url.searchParams.delete("conversation_id");
   138â†’    }
   139â†’    router.replace(url.pathname + url.search, { scroll: false });
   140â†’  }, [router]);
   141â†’
   142â†’  // Load voice_mode from backend on mount (only if authenticated)
   143â†’  useEffect(() => {
   144â†’    const loadPreferences = async () => {
   145â†’      try {
   146â†’        // Check if user is authenticated before making the request
   147â†’        const token = document.cookie.split(';').find(c => c.trim().startsWith('auth-token='));
   148â†’        if (!token) {
   149â†’          return; // Skip if not authenticated
   150â†’        }
   151â†’
   152â†’        const response = await apiClient.get<{ voice_mode: string; language: string }>("/preferences");
   153â†’        if (response.data?.voice_mode) {
   154â†’          setVoiceModeState(response.data.voice_mode as "warm" | "sarcastic" | "wise");
   155â†’        }
   156â†’      } catch (error) {
   157â†’        // Silently fail for 401 errors, log others
   158â†’        if (error && typeof error === 'object' && 'response' in error) {
   159â†’          const resp = error.response as { status?: number };
   160â†’          if (resp.status !== 401) {
   161â†’            console.error("Failed to load preferences:", error);
   162â†’          }
   163â†’        }
   164â†’      }
   165â†’    };
   166â†’    loadPreferences();
   167â†’  }, []);
   168â†’
   169â†’  // Save voice_mode to backend when changed
   170â†’  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic" | "wise") => {
   171â†’    setVoiceModeState(mode);
   172â†’    try {
   173â†’      await apiClient.put("/preferences", { voice_mode: mode });
   174â†’    } catch (error) {
   175â†’      console.error("Failed to save voice_mode:", error);
   176â†’    }
   177â†’  }, []);
   178â†’
   179â†’  // Handle new chat creation
   180â†’  const handleNewChat = useCallback(() => {
   181â†’    setActiveConversationId(null);
   182â†’  }, [setActiveConversationId]);
   183â†’
   184â†’  const contextValue: AppShellContextValue = {
   185â†’    skill,
   186â†’    activeTab,
   187â†’    setActiveTab,
   188â†’    voiceMode,
   189â†’    setVoiceMode,
   190â†’    activeConversationId,
   191â†’    setActiveConversationId,
   192â†’    isMobileDrawerOpen,
   193â†’    setMobileDrawerOpen,
   194â†’  };
   195â†’
   196â†’  return (
   197â†’    <AppShellContext.Provider value={contextValue}>
   198â†’      <div className="h-screen flex flex-col bg-background">
   199â†’        {/* Mobile Header - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
   200â†’        <div className="lg:hidden">
   201â†’          <MobileHeader skill={skill} />
   202â†’        </div>
   203â†’
   204â†’        {/* Main Content Area */}
   205â†’        <div className="flex-1 flex overflow-hidden">
   206â†’          {/* Left NavBar - ä»… PC ç«¯æ˜¾ç¤ºï¼ˆå«å¯¹è¯å†å²ï¼‰ */}
   207â†’          <div className="hidden lg:block">
   208â†’            <NavBar
   209â†’              skill={skill}
   210â†’              activeTab={activeTab}
   211â†’              onTabChange={setActiveTab}
   212â†’              activeConversationId={activeConversationId}
   213â†’              onSelectConversation={setActiveConversationId}
   214â†’              onNewChat={handleNewChat}
   215â†’            />
   216â†’          </div>
   217â†’
   218â†’          {/* Center - ä¸»å†…å®¹åŒºåŸŸ (å…¨å®½) */}
   219â†’          <main className="flex-1 min-h-0 flex flex-col">
   220â†’            {/* PCç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
   221â†’            <div className="hidden lg:flex lg:flex-col h-full min-h-0">
   222â†’              <PCContent
   223â†’                activeTab={activeTab}
   224â†’                chatContent={children}
   225â†’                journeyContent={journeyContent}
   226â†’                discoverContent={discoverContent}
   227â†’                meContent={meContent}
   228â†’              />
   229â†’            </div>
   230â†’
   231â†’            {/* ç§»åŠ¨ç«¯: æ ¹æ® Tab åˆ‡æ¢å†…å®¹ */}
   232â†’            <div className="lg:hidden h-full min-h-0 flex flex-col">
   233â†’              <MobileContent
   234â†’                activeTab={activeTab}
   235â†’                chatContent={children}
   236â†’                journeyContent={journeyContent}
   237â†’                discoverContent={discoverContent}
   238â†’                meContent={meContent}
   239â†’              />
   240â†’            </div>
   241â†’          </main>
   242â†’        </div>
   243â†’
   244â†’        {/* Mobile TabBar - ä»…ç§»åŠ¨ç«¯æ˜¾ç¤º */}
   245â†’        <div className="lg:hidden">
   246â†’          <MobileTabBar activeTab={activeTab} onTabChange={setActiveTab} />
   247â†’        </div>
   248â†’
   249â†’        {/* Mobile Conversation Drawer */}
   250â†’        <MobileConversationDrawer
   251â†’          isOpen={isMobileDrawerOpen}
   252â†’          onClose={() => setMobileDrawerOpen(false)}
   253â†’          activeConversationId={activeConversationId}
   254â†’          onSelectConversation={setActiveConversationId}
   255â†’          onNewChat={handleNewChat}
   256â†’        />
   257â†’      </div>
   258â†’    </AppShellContext.Provider>
   259â†’  );
   260â†’}
   261â†’
   262â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   263â†’// PCContent - PCç«¯å†…å®¹åˆ‡æ¢
   264â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   265â†’
   266â†’interface ContentProps {
   267â†’  activeTab: TabType;
   268â†’  chatContent: ReactNode;
   269â†’  journeyContent?: ReactNode;
   270â†’  discoverContent?: ReactNode;
   271â†’  meContent?: ReactNode;
   272â†’}
   273â†’
   274â†’function PCContent({ activeTab, chatContent, journeyContent, discoverContent, meContent }: ContentProps) {
   275â†’  switch (activeTab) {
   276â†’    case "chat":
   277â†’      return <div className="h-full min-h-0 flex flex-col">{chatContent}</div>;
   278â†’    case "journey":
   279â†’      return (
   280â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   281â†’          {journeyContent || (
   282â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   283â†’              æˆ‘çš„æ—…ç¨‹
   284â†’            </div>
   285â†’          )}
   286â†’        </div>
   287â†’      );
   288â†’    case "discover":
   289â†’      return (
   290â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   291â†’          {discoverContent || (
   292â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   293â†’              æ¢ç´¢ Skills
   294â†’            </div>
   295â†’          )}
   296â†’        </div>
   297â†’      );
   298â†’    case "me":
   299â†’      return (
   300â†’        <div className="h-full overflow-y-auto">
   301â†’          {meContent || (
   302â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   303â†’              ä¸ªäººè®¾ç½®
   304â†’            </div>
   305â†’          )}
   306â†’        </div>
   307â†’      );
   308â†’    default:
   309â†’      return null;
   310â†’  }
   311â†’}
   312â†’
   313â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   314â†’// MobileContent - ç§»åŠ¨ç«¯å†…å®¹åˆ‡æ¢
   315â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   316â†’
   317â†’function MobileContent({ activeTab, chatContent, journeyContent, discoverContent, meContent }: ContentProps) {
   318â†’  switch (activeTab) {
   319â†’    case "chat":
   320â†’      return <div className="h-full min-h-0 flex flex-col">{chatContent}</div>;
   321â†’    case "journey":
   322â†’      return (
   323â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   324â†’          {journeyContent || (
   325â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   326â†’              æˆ‘çš„æ—…ç¨‹
   327â†’            </div>
   328â†’          )}
   329â†’        </div>
   330â†’      );
   331â†’    case "discover":
   332â†’      return (
   333â†’        <div className="h-full min-h-0 flex flex-col overflow-y-auto">
   334â†’          {discoverContent || (
   335â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   336â†’              æ¢ç´¢ Skills
   337â†’            </div>
   338â†’          )}
   339â†’        </div>
   340â†’      );
   341â†’    case "me":
   342â†’      return (
   343â†’        <div className="h-full overflow-y-auto">
   344â†’          {meContent || (
   345â†’            <div className="flex items-center justify-center h-full text-muted-foreground">
   346â†’              ä¸ªäººè®¾ç½®
   347â†’            </div>
   348â†’          )}
   349â†’        </div>
   350â†’      );
   351â†’    default:
   352â†’      return null;
   353â†’  }
   354â†’}
   355â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
