     1→"use client";
     2→
     3→/**
     4→ * NavBar - PC端左侧导航栏 v10.0
     5→ *
     6→ * V10 变更:
     7→ * - 对话历史整合到 NavBar 中
     8→ * - "对话"按钮 = 开始新对话
     9→ * - 历史对话列表显示在导航链接下方
    10→ */
    11→
    12→import { useState, useEffect } from "react";
    13→import { motion, AnimatePresence } from "framer-motion";
    14→import { cn } from "@/lib/utils";
    15→import {
    16→  MessageSquare,
    17→  Compass,
    18→  Sparkles,
    19→  User,
    20→  PanelLeftClose,
    21→  PanelLeft,
    22→  Settings,
    23→  Plus,
    24→  MoreHorizontal,
    25→  Pencil,
    26→  Trash2,
    27→} from "lucide-react";
    28→import Link from "next/link";
    29→import type { LucideIcon } from "lucide-react";
    30→import { VibeGlyph, type SkillType } from "@/components/core";
    31→import { type TabType } from "./AppShell";
    32→import { useConversations, type ConversationItem } from "@/hooks/useConversations";
    33→
    34→// ═══════════════════════════════════════════════════════════════════════════
    35→// Types & Config
    36→// ═══════════════════════════════════════════════════════════════════════════
    37→
    38→interface NavBarProps {
    39→  skill: SkillType;
    40→  activeTab: TabType;
    41→  onTabChange: (tab: TabType) => void;
    42→  activeConversationId: string | null;
    43→  onSelectConversation: (id: string | null) => void;
    44→  onNewChat: () => void;
    45→  className?: string;
    46→}
    47→
    48→interface NavItem {
    49→  id: TabType;
    50→  icon: LucideIcon;
    51→  label: string;
    52→  description?: string;
    53→}
    54→
    55→// V10: 4 navigation items
    56→const NAV_ITEMS: NavItem[] = [
    57→  {
    58→    id: "journey",
    59→    icon: Compass,
    60→    label: "旅程",
    61→    description: "我的旅程",
    62→  },
    63→  {
    64→    id: "discover",
    65→    icon: Sparkles,
    66→    label: "探索",
    67→    description: "发现更多 Skills",
    68→  },
    69→  {
    70→    id: "me",
    71→    icon: User,
    72→    label: "我的",
    73→    description: "设置/订阅",
    74→  },
    75→];
    76→
    77→const STORAGE_KEY = "vibelife-navbar-expanded";
    78→
    79→// ═══════════════════════════════════════════════════════════════════════════
    80→// NavBar Component
    81→// ═══════════════════════════════════════════════════════════════════════════
    82→
    83→export function NavBar({
    84→  skill,
    85→  activeTab,
    86→  onTabChange,
    87→  activeConversationId,
    88→  onSelectConversation,
    89→  onNewChat,
    90→  className,
    91→}: NavBarProps) {
    92→  const [isExpanded, setIsExpanded] = useState(true); // 默认展开
    93→  const [hoveredItem, setHoveredItem] = useState<string | null>(null);
    94→  const [isMounted, setIsMounted] = useState(false);
    95→  const [menuOpenId, setMenuOpenId] = useState<string | null>(null);
    96→  const [editingId, setEditingId] = useState<string | null>(null);
    97→  const [editTitle, setEditTitle] = useState("");
    98→
    99→  const { conversations, isLoading, renameConversation, deleteConversation } = useConversations();
   100→
   101→  // 从 localStorage 恢复状态
   102→  useEffect(() => {
   103→    setIsMounted(true);
   104→    const saved = localStorage.getItem(STORAGE_KEY);
   105→    if (saved !== null) {
   106→      setIsExpanded(saved === "true");
   107→    }
   108→  }, []);
   109→
   110→  const toggleExpanded = () => {
   111→    setIsExpanded((prev) => {
   112→      const newValue = !prev;
   113→      if (typeof window !== "undefined") {
   114→        localStorage.setItem(STORAGE_KEY, String(newValue));
   115→      }
   116→      return newValue;
   117→    });
   118→  };
   119→
   120→  // 开始新对话
   121→  const handleNewChat = () => {
   122→    onNewChat();
   123→    onTabChange("chat");
   124→  };
   125→
   126→  // 选择对话
   127→  const handleSelectConversation = (id: string) => {
   128→    onSelectConversation(id);
   129→    onTabChange("chat");
   130→    setMenuOpenId(null);
   131→  };
   132→
   133→  // 重命名对话
   134→  const handleRename = async (id: string) => {
   135→    if (editTitle.trim()) {
   136→      await renameConversation(id, editTitle.trim());
   137→    }
   138→    setEditingId(null);
   139→    setEditTitle("");
   140→  };
   141→
   142→  // 删除对话
   143→  const handleDelete = async (id: string) => {
   144→    await deleteConversation(id);
   145→    if (activeConversationId === id) {
   146→      onSelectConversation(null);
   147→    }
   148→    setMenuOpenId(null);
   149→  };
   150→
   151→  return (
   152→    <motion.nav
   153→      initial={false}
   154→      animate={{ width: isExpanded ? 260 : 64 }}
   155→      transition={{ duration: 0.2, ease: "easeInOut" }}
   156→      className={cn(
   157→        "h-full flex flex-col bg-card border-r border-border",
   158→        className
   159→      )}
   160→    >
   161→      {/* Logo Area + Collapse Toggle */}
   162→      <div className="h-14 flex items-center justify-between px-3 border-b border-border">
   163→        <div className="flex items-center gap-2">
   164→          <VibeGlyph size="sm" skill={skill} showAura={false} animate={false} />
   165→          {isExpanded && (
   166→            <span className="font-serif font-semibold text-foreground whitespace-nowrap">
   167→              VibeLife
   168→            </span>
   169→          )}
   170→        </div>
   171→        <button
   172→          onClick={toggleExpanded}
   173→          aria-label={isExpanded ? "收起侧边栏" : "展开侧边栏"}
   174→          className="p-1.5 rounded-md text-muted-foreground/60 hover:text-muted-foreground hover:bg-muted/50 transition-colors"
   175→        >
   176→          {isExpanded ? <PanelLeftClose className="w-4 h-4" /> : <PanelLeft className="w-4 h-4" />}
   177→        </button>
   178→      </div>
   179→
   180→      {/* New Chat Button */}
   181→      <div className="px-2 pt-3 pb-2">
   182→        <button
   183→          onClick={handleNewChat}
   184→          className={cn(
   185→            "w-full flex items-center gap-3 px-3 py-2.5 rounded-xl transition-all duration-200",
   186→            "bg-[var(--accent-primary)] text-white hover:bg-[var(--accent-hover)]",
   187→            "shadow-sm hover:shadow-md"
   188→          )}
   189→        >
   190→          <Plus className="w-5 h-5 flex-shrink-0" />
   191→          <AnimatePresence>
   192→            {isExpanded && (
   193→              <motion.span
   194→                initial={{ opacity: 0, width: 0 }}
   195→                animate={{ opacity: 1, width: "auto" }}
   196→                exit={{ opacity: 0, width: 0 }}
   197→                className="text-sm font-medium overflow-hidden whitespace-nowrap"
   198→              >
   199→                新对话
   200→              </motion.span>
   201→            )}
   202→          </AnimatePresence>
   203→        </button>
   204→      </div>
   205→
   206→      {/* Conversation History */}
   207→      {isExpanded && (
   208→        <div className="flex-1 overflow-y-auto px-2 pb-2">
   209→          <div className="text-xs text-muted-foreground px-3 py-2 font-medium">
   210→            对话历史
   211→          </div>
   212→          <div className="space-y-0.5">
   213→            {conversations.slice(0, 20).map((conv) => (
   214→              <ConversationItem
   215→                key={conv.id}
   216→                conversation={conv}
   217→                isActive={activeConversationId === conv.id}
   218→                isMenuOpen={menuOpenId === conv.id}
   219→                isEditing={editingId === conv.id}
   220→                editTitle={editTitle}
   221→                onSelect={() => handleSelectConversation(conv.id)}
   222→                onMenuToggle={() => setMenuOpenId(menuOpenId === conv.id ? null : conv.id)}
   223→                onStartEdit={() => {
   224→                  setEditingId(conv.id);
   225→                  setEditTitle(conv.title || "");
   226→                  setMenuOpenId(null);
   227→                }}
   228→                onEditChange={setEditTitle}
   229→                onEditSave={() => handleRename(conv.id)}
   230→                onEditCancel={() => {
   231→                  setEditingId(null);
   232→                  setEditTitle("");
   233→                }}
   234→                onDelete={() => handleDelete(conv.id)}
   235→              />
   236→            ))}
   237→            {isLoading && (
   238→              <div className="px-3 py-2 text-xs text-muted-foreground">加载中...</div>
   239→            )}
   240→            {!isLoading && conversations.length === 0 && (
   241→              <div className="px-3 py-2 text-xs text-muted-foreground">暂无对话</div>
   242→            )}
   243→          </div>
   244→        </div>
   245→      )}
   246→
   247→      {/* Nav Items - 收起态时显示 */}
   248→      {!isExpanded && (
   249→        <div className="flex-1 py-2 space-y-1">
   250→          {/* Chat icon for collapsed state */}
   251→          <div className="relative px-2">
   252→            <button
   253→              onClick={handleNewChat}
   254→              onMouseEnter={() => setHoveredItem("chat")}
   255→              onMouseLeave={() => setHoveredItem(null)}
   256→              className={cn(
   257→                "w-full flex items-center justify-center p-2.5 rounded-lg transition-all duration-200",
   258→                activeTab === "chat"
   259→                  ? "bg-skill-primary/10 text-skill-primary"
   260→                  : "text-muted-foreground hover:bg-muted hover:text-foreground"
   261→              )}
   262→            >
   263→              <MessageSquare className="w-5 h-5" />
   264→            </button>
   265→            {hoveredItem === "chat" && (
   266→              <motion.div
   267→                initial={{ opacity: 0, x: -4 }}
   268→                animate={{ opacity: 1, x: 0 }}
   269→                className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
   270→              >
   271→                <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
   272→                  新对话
   273→                  <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
   274→                </div>
   275→              </motion.div>
   276→            )}
   277→          </div>
   278→
   279→          {NAV_ITEMS.map((item) => {
   280→            const Icon = item.icon;
   281→            const isActive = activeTab === item.id;
   282→
   283→            return (
   284→              <div key={item.id} className="relative px-2">
   285→                <button
   286→                  onClick={() => onTabChange(item.id)}
   287→                  onMouseEnter={() => setHoveredItem(item.id)}
   288→                  onMouseLeave={() => setHoveredItem(null)}
   289→                  className={cn(
   290→                    "w-full flex items-center justify-center p-2.5 rounded-lg transition-all duration-200",
   291→                    isActive
   292→                      ? "bg-skill-primary/10 text-skill-primary"
   293→                      : "text-muted-foreground hover:bg-muted hover:text-foreground"
   294→                  )}
   295→                >
   296→                  <Icon className="w-5 h-5" />
   297→                </button>
   298→                {hoveredItem === item.id && (
   299→                  <motion.div
   300→                    initial={{ opacity: 0, x: -4 }}
   301→                    animate={{ opacity: 1, x: 0 }}
   302→                    className="absolute left-full top-1/2 -translate-y-1/2 ml-2 z-50"
   303→                  >
   304→                    <div className="bg-foreground text-background px-3 py-1.5 rounded-md text-sm whitespace-nowrap shadow-lg">
   305→                      {item.label}
   306→                      <div className="absolute left-0 top-1/2 -translate-y-1/2 -translate-x-1 w-2 h-2 bg-foreground rotate-45" />
   307→                    </div>
   308→                  </motion.div>
   309→                )}
   310→              </div>
   311→            );
   312→          })}
   313→        </div>
   314→      )}
   315→
   316→      {/* Other Nav Items - 展开态 */}
   317→      {isExpanded && (
   318→        <div className="border-t border-border py-2 space-y-1">
   319→          {NAV_ITEMS.map((item) => {
   320→            const Icon = item.icon;
   321→            const isActive = activeTab === item.id;
   322→
   323→            return (
   324→              <div key={item.id} className="px-2">
   325→                <button
   326→                  onClick={() => onTabChange(item.id)}
   327→                  className={cn(
   328→                    "w-full flex items-center gap-3 px-3 py-2 rounded-lg transition-all duration-200",
   329→                    isActive
   330→                      ? "bg-skill-primary/10 text-skill-primary"
   331→                      : "text-muted-foreground hover:bg-muted hover:text-foreground"
   332→                  )}
   333→                >
   334→                  <Icon className="w-5 h-5 flex-shrink-0" />
   335→                  <span className="text-sm font-medium">{item.label}</span>
   336→                </button>
   337→              </div>
   338→            );
   339→          })}
   340→        </div>
   341→      )}
   342→
   343→      {/* Settings Link */}
   344→      <div className="p-2 border-t border-border">
   345→        <Link
   346→          href="/settings"
   347→          className={cn(
   348→            "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200",
   349→            "text-muted-foreground hover:bg-muted hover:text-foreground"
   350→          )}
   351→        >
   352→          <Settings className="w-5 h-5 flex-shrink-0" />
   353→          <AnimatePresence>
   354→            {isExpanded && (
   355→              <motion.span
   356→                initial={{ opacity: 0, width: 0 }}
   357→                animate={{ opacity: 1, width: "auto" }}
   358→                exit={{ opacity: 0, width: 0 }}
   359→                className="text-sm font-medium overflow-hidden whitespace-nowrap"
   360→              >
   361→                设置
   362→              </motion.span>
   363→            )}
   364→          </AnimatePresence>
   365→        </Link>
   366→      </div>
   367→    </motion.nav>
   368→  );
   369→}
   370→
   371→// ═══════════════════════════════════════════════════════════════════════════
   372→// ConversationItem Component
   373→// ═══════════════════════════════════════════════════════════════════════════
   374→
   375→interface ConversationItemProps {
   376→  conversation: ConversationItem;
   377→  isActive: boolean;
   378→  isMenuOpen: boolean;
   379→  isEditing: boolean;
   380→  editTitle: string;
   381→  onSelect: () => void;
   382→  onMenuToggle: () => void;
   383→  onStartEdit: () => void;
   384→  onEditChange: (value: string) => void;
   385→  onEditSave: () => void;
   386→  onEditCancel: () => void;
   387→  onDelete: () => void;
   388→}
   389→
   390→function ConversationItem({
   391→  conversation,
   392→  isActive,
   393→  isMenuOpen,
   394→  isEditing,
   395→  editTitle,
   396→  onSelect,
   397→  onMenuToggle,
   398→  onStartEdit,
   399→  onEditChange,
   400→  onEditSave,
   401→  onEditCancel,
   402→  onDelete,
   403→}: ConversationItemProps) {
   404→  if (isEditing) {
   405→    return (
   406→      <div className="px-2 py-1">
   407→        <input
   408→          type="text"
   409→          value={editTitle}
   410→          onChange={(e) => onEditChange(e.target.value)}
   411→          onKeyDown={(e) => {
   412→            if (e.key === "Enter") onEditSave();
   413→            if (e.key === "Escape") onEditCancel();
   414→          }}
   415→          onBlur={onEditSave}
   416→          autoFocus
   417→          className="w-full px-2 py-1 text-sm bg-background border border-border rounded-md focus:outline-none focus:ring-1 focus:ring-[var(--accent-primary)]"
   418→        />
   419→      </div>
   420→    );
   421→  }
   422→
   423→  return (
   424→    <div className="relative group">
   425→      <button
   426→        onClick={onSelect}
   427→        className={cn(
   428→          "w-full flex items-center gap-2 px-3 py-2 rounded-lg text-left transition-all duration-200",
   429→          isActive
   430→            ? "bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]"
   431→            : "text-text-secondary hover:bg-muted hover:text-foreground"
   432→        )}
   433→      >
   434→        <MessageSquare className="w-4 h-4 flex-shrink-0 opacity-60" />
   435→        <span className="text-sm truncate flex-1">{conversation.title || "新对话"}</span>
   436→      </button>
   437→
   438→      {/* Menu Button */}
   439→      <button
   440→        onClick={(e) => {
   441→          e.stopPropagation();
   442→          onMenuToggle();
   443→        }}
   444→        className={cn(
   445→          "absolute right-1 top-1/2 -translate-y-1/2 p-1 rounded-md transition-opacity",
   446→          "opacity-0 group-hover:opacity-100",
   447→          isMenuOpen && "opacity-100",
   448→          "text-muted-foreground hover:text-foreground hover:bg-muted"
   449→        )}
   450→      >
   451→        <MoreHorizontal className="w-4 h-4" />
   452→      </button>
   453→
   454→      {/* Dropdown Menu */}
   455→      {isMenuOpen && (
   456→        <div className="absolute right-0 top-full mt-1 z-50 bg-card border border-border rounded-lg shadow-lg py-1 min-w-[120px]">
   457→          <button
   458→            onClick={(e) => {
   459→              e.stopPropagation();
   460→              onStartEdit();
   461→            }}
   462→            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left hover:bg-muted transition-colors"
   463→          >
   464→            <Pencil className="w-3.5 h-3.5" />
   465→            <span>重命名</span>
   466→          </button>
   467→          <button
   468→            onClick={(e) => {
   469→              e.stopPropagation();
   470→              onDelete();
   471→            }}
   472→            className="w-full flex items-center gap-2 px-3 py-1.5 text-sm text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-colors"
   473→          >
   474→            <Trash2 className="w-3.5 h-3.5" />
   475→            <span>删除</span>
   476→          </button>
   477→        </div>
   478→      )}
   479→    </div>
   480→  );
   481→}
   482→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
