     1â†’'use client'
     2â†’
     3â†’/**
     4â†’ * Settings Page - v6.0 ç»Ÿä¸€å¸ƒå±€ç‰ˆ
     5â†’ *
     6â†’ * v6.0 å˜æ›´:
     7â†’ * - ä½¿ç”¨ä¸ Chat é¡µç›¸åŒçš„ NavBar ç»„ä»¶ï¼Œä¿æŒå·¦ä¾§æ ä¸€è‡´æ€§
     8â†’ * - ç§»é™¤ PCLayoutï¼Œä½¿ç”¨è‡ªå®šä¹‰å¸ƒå±€
     9â†’ * - ä¿®å¤é€€å‡ºç™»å½•åŠŸèƒ½
    10â†’ *
    11â†’ * PCç«¯å¸ƒå±€: NavBar + è®¾ç½®èœå• + è®¾ç½®å†…å®¹
    12â†’ * ç§»åŠ¨ç«¯å¸ƒå±€: å•æ è®¾ç½®åˆ—è¡¨
    13â†’ */
    14â†’
    15â†’import { useState, useEffect, useCallback, memo, useMemo, useId, Suspense } from 'react'
    16â†’import { useRouter, useSearchParams } from 'next/navigation'
    17â†’import Link from 'next/link'
    18â†’import { NavBar } from '@/components/layout/NavBar'
    19â†’import { VibeGlyph } from '@/components/core'
    20â†’import { BirthDateInputs } from '@/components/ui/Input'
    21â†’import { getLocalStorageJSON, getAccessToken, setLocalStorageJSON, invalidateStorageCache } from '@/utils/storage'
    22â†’import { AccountDeletionSection } from '@/components/settings/AccountDeletionSection'
    23â†’import { useSkillSubscription, useSkills } from '@/hooks/useSkillSubscription'
    24â†’import { useAuth } from '@/providers/AuthProvider'
    25â†’import { cn } from '@/lib/utils'
    26â†’
    27â†’// Use Next.js API routes for server communication to avoid exposing backend URL
    28â†’const API_BASE = '/api'
    29â†’
    30â†’const SETTINGS_MENU = [
    31â†’  { id: 'profile', icon: 'ğŸ‘¤', label: 'ä¸ªäººèµ„æ–™' },
    32â†’  { id: 'skills', icon: 'ğŸ¯', label: 'Skill ç®¡ç†' },
    33â†’  { id: 'notifications', icon: 'ğŸ””', label: 'é€šçŸ¥è®¾ç½®' },
    34â†’  { id: 'membership', icon: 'ğŸ’', label: 'ä¼šå‘˜ç®¡ç†' },
    35â†’  { id: 'preferences', icon: 'âš™ï¸', label: 'åå¥½è®¾ç½®' },
    36â†’  { id: 'account', icon: 'âš ï¸', label: 'è´¦æˆ·ç®¡ç†' },
    37â†’  { id: 'help', icon: 'â“', label: 'å¸®åŠ©ä¸åé¦ˆ' },
    38â†’  { id: 'about', icon: 'ğŸ“„', label: 'å…³äº' },
    39â†’]
    40â†’
    41â†’interface UserProfile {
    42â†’  nickname: string
    43â†’  email: string
    44â†’  avatar: string
    45â†’  birthDate: string
    46â†’  birthTime: string
    47â†’  timezone: string
    48â†’}
    49â†’
    50â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    51â†’// Skill ç®¡ç†åŒºå—
    52â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    53â†’
    54â†’function SkillSettingsSection({ router }: { router: ReturnType<typeof useRouter> }) {
    55â†’  const { skills } = useSkills()
    56â†’  const { subscriptions, togglePush, unsubscribe, userStatuses } = useSkillSubscription()
    57â†’
    58â†’  // åˆ†ç»„
    59â†’  const { subscribed, available } = useMemo(() => {
    60â†’    const subscribedIds = new Set(
    61â†’      subscriptions.filter(s => s.status === 'subscribed').map(s => s.skill_id)
    62â†’    )
    63â†’    return {
    64â†’      subscribed: skills.filter(s => subscribedIds.has(s.id)),
    65â†’      available: skills.filter(s => !subscribedIds.has(s.id) && s.category !== 'core'),
    66â†’    }
    67â†’  }, [skills, subscriptions])
    68â†’
    69â†’  const handleTogglePush = async (skillId: string, enabled: boolean) => {
    70â†’    try {
    71â†’      await togglePush(skillId, enabled)
    72â†’    } catch (err) {
    73â†’      console.error('Toggle push failed:', err)
    74â†’    }
    75â†’  }
    76â†’
    77â†’  const handleUnsubscribe = async (skillId: string) => {
    78â†’    try {
    79â†’      await unsubscribe(skillId)
    80â†’    } catch (err) {
    81â†’      console.error('Unsubscribe failed:', err)
    82â†’    }
    83â†’  }
    84â†’
    85â†’  return (
    86â†’    <div className="space-y-6">
    87â†’      <div className="flex items-center justify-between">
    88â†’        <h2 className="font-serif text-xl text-text-primary">Skill ç®¡ç†</h2>
    89â†’        <button
    90â†’          onClick={() => router.push('/skills')}
    91â†’          className="text-sm text-accent hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 rounded"
    92â†’          aria-label="æ¢ç´¢æ›´å¤š Skill"
    93â†’        >
    94â†’          æ¢ç´¢æ›´å¤š â†’
    95â†’        </button>
    96â†’      </div>
    97â†’
    98â†’      {/* å·²è®¢é˜… */}
    99â†’      <div>
   100â†’        <h3 className="text-sm font-medium text-text-secondary mb-3">
   101â†’          å·²è®¢é˜… ({subscribed.length})
   102â†’        </h3>
   103â†’        <div className="space-y-2">
   104â†’          {subscribed.map((skill) => {
   105â†’            const sub = subscriptions.find(s => s.skill_id === skill.id)
   106â†’            const isCore = skill.category === 'core'
   107â†’            return (
   108â†’              <div key={skill.id} className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)]">
   109â†’                <Link
   110â†’                  href={`/chat?skill=${skill.id}`}
   111â†’                  className="flex items-center gap-3 flex-1 min-w-0 cursor-pointer hover:opacity-80 transition-opacity focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 rounded"
   112â†’                  aria-label={`ä½¿ç”¨ ${skill.name}`}
   113â†’                >
   114â†’                  <div
   115â†’                    className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
   116â†’                    style={{ backgroundColor: `${skill.color}20` }}
   117â†’                  >
   118â†’                    {skill.icon}
   119â†’                  </div>
   120â†’                  <div className="flex-1 min-w-0">
   121â†’                    <div className="flex items-center gap-2">
   122â†’                      <span className="font-medium text-text-primary">{skill.name}</span>
   123â†’                      {isCore && (
   124â†’                        <span className="px-1.5 py-0.5 text-xs rounded bg-accent/10 text-accent">
   125â†’                          å§‹ç»ˆæ¿€æ´»
   126â†’                        </span>
   127â†’                      )}
   128â†’                    </div>
   129â†’                    <p className="text-xs text-text-secondary truncate">
   130â†’                      {skill.features?.slice(0, 2).map(f => f.name).join(' Â· ')}
   131â†’                    </p>
   132â†’                  </div>
   133â†’                </Link>
   134â†’                {!isCore && (
   135â†’                  <div className="flex items-center gap-3">
   136â†’                    <div className="flex items-center gap-2">
   137â†’                      <label
   138â†’                        htmlFor={`push-${skill.id}`}
   139â†’                        className="text-xs text-text-tertiary cursor-pointer"
   140â†’                      >
   141â†’                        æ¨é€
   142â†’                      </label>
   143â†’                      <div className="relative inline-flex items-center">
   144â†’                        <input
   145â†’                          id={`push-${skill.id}`}
   146â†’                          type="checkbox"
   147â†’                          checked={sub?.push_enabled ?? false}
   148â†’                          onChange={(e) => handleTogglePush(skill.id, e.target.checked)}
   149â†’                          className="sr-only peer"
   150â†’                          aria-describedby={`push-desc-${skill.id}`}
   151â†’                        />
   152â†’                        <div className="w-9 h-5 bg-[var(--bg-secondary)] peer-focus-visible:ring-2 peer-focus-visible:ring-accent/50 peer-focus-visible:ring-offset-2 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-transform peer-checked:bg-accent cursor-pointer" />
   153â†’                        <span id={`push-desc-${skill.id}`} className="sr-only">
   154â†’                          {sub?.push_enabled ? 'å…³é—­' : 'å¼€å¯'} {skill.name} æ¨é€é€šçŸ¥
   155â†’                        </span>
   156â†’                      </div>
   157â†’                    </div>
   158â†’                    <button
   159â†’                      onClick={() => handleUnsubscribe(skill.id)}
   160â†’                      className="text-xs text-error hover:underline focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-error focus-visible:ring-offset-2 rounded"
   161â†’                      aria-label={`å–æ¶ˆè®¢é˜… ${skill.name}`}
   162â†’                    >
   163â†’                      å–æ¶ˆ
   164â†’                    </button>
   165â†’                  </div>
   166â†’                )}
   167â†’              </div>
   168â†’            )
   169â†’          })}
   170â†’        </div>
   171â†’      </div>
   172â†’
   173â†’      {/* å¯è®¢é˜… */}
   174â†’      {available.length > 0 && (
   175â†’        <div>
   176â†’          <h3 className="text-sm font-medium text-text-secondary mb-3">
   177â†’            å¯è®¢é˜… ({available.length})
   178â†’          </h3>
   179â†’          <div className="space-y-2">
   180â†’            {available.slice(0, 3).map((skill) => (
   181â†’              <Link
   182â†’                key={skill.id}
   183â†’                href={`/chat?skill=${skill.id}&intro=1`}
   184â†’                className="flex items-center gap-3 p-3 rounded-lg bg-[var(--bg-card-alt)] cursor-pointer hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   185â†’                aria-label={`æŸ¥çœ‹ ${skill.name} è¯¦æƒ…`}
   186â†’              >
   187â†’                <div
   188â†’                  className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
   189â†’                  style={{ backgroundColor: `${skill.color}20` }}
   190â†’                  aria-hidden="true"
   191â†’                >
   192â†’                  {skill.icon}
   193â†’                </div>
   194â†’                <div className="flex-1 min-w-0">
   195â†’                  <span className="font-medium text-text-primary">{skill.name}</span>
   196â†’                  <p className="text-xs text-text-secondary truncate">
   197â†’                    {skill.showcase?.tagline || skill.description}
   198â†’                  </p>
   199â†’                </div>
   200â†’                <span className="px-3 py-1 text-xs rounded-full bg-accent text-white" aria-hidden="true">
   201â†’                  è®¢é˜…
   202â†’                </span>
   203â†’              </Link>
   204â†’            ))}
   205â†’          </div>
   206â†’        </div>
   207â†’      )}
   208â†’    </div>
   209â†’  )
   210â†’}
   211â†’
   212â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   213â†’// é€šçŸ¥è®¾ç½®åŒºå— - ä½¿ç”¨ Skill çº§åˆ«çš„æ¨é€è®¾ç½®
   214â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   215â†’
   216â†’function NotificationSettingsSection() {
   217â†’  const { skills } = useSkills()
   218â†’  const { subscriptions, togglePush } = useSkillSubscription()
   219â†’
   220â†’  // åªæ˜¾ç¤ºå·²è®¢é˜…çš„ Skills çš„æ¨é€è®¾ç½®
   221â†’  const subscribedSkills = useMemo(() => {
   222â†’    const subscribedIds = new Set(
   223â†’      subscriptions.filter(s => s.status === 'subscribed').map(s => s.skill_id)
   224â†’    )
   225â†’    return skills.filter(s => subscribedIds.has(s.id))
   226â†’  }, [skills, subscriptions])
   227â†’
   228â†’  const handleTogglePush = async (skillId: string, enabled: boolean) => {
   229â†’    try {
   230â†’      await togglePush(skillId, enabled)
   231â†’    } catch (err) {
   232â†’      console.error('Toggle push failed:', err)
   233â†’    }
   234â†’  }
   235â†’
   236â†’  return (
   237â†’    <div className="space-y-6">
   238â†’      <h2 className="font-serif text-xl text-text-primary">é€šçŸ¥è®¾ç½®</h2>
   239â†’      <p className="text-sm text-text-secondary">
   240â†’        ç®¡ç†ä½ è®¢é˜…çš„ Skills çš„æ¨é€é€šçŸ¥ã€‚
   241â†’      </p>
   242â†’
   243â†’      {subscribedSkills.length === 0 ? (
   244â†’        <div className="text-center py-8 text-text-secondary">
   245â†’          <p>æš‚æ— å·²è®¢é˜…çš„ Skill</p>
   246â†’          <p className="text-sm mt-2">è®¢é˜… Skill åå¯åœ¨æ­¤ç®¡ç†æ¨é€é€šçŸ¥</p>
   247â†’        </div>
   248â†’      ) : (
   249â†’        <div className="space-y-3">
   250â†’          {subscribedSkills.map((skill) => {
   251â†’            const sub = subscriptions.find(s => s.skill_id === skill.id)
   252â†’            const toggleId = `notify-${skill.id}`
   253â†’            return (
   254â†’              <div key={skill.id} className="flex items-center justify-between p-4 bg-[var(--bg-card-alt)] rounded-lg">
   255â†’                <label htmlFor={toggleId} className="flex items-center gap-3 cursor-pointer flex-1">
   256â†’                  <div
   257â†’                    className="w-10 h-10 rounded-xl flex items-center justify-center text-xl"
   258â†’                    style={{ backgroundColor: `${skill.color}20` }}
   259â†’                    aria-hidden="true"
   260â†’                  >
   261â†’                    {skill.icon}
   262â†’                  </div>
   263â†’                  <div>
   264â†’                    <p className="text-text-primary font-medium">{skill.name}</p>
   265â†’                    <p className="text-sm text-text-secondary">æ¥æ”¶ {skill.name} ç›¸å…³æ¨é€</p>
   266â†’                  </div>
   267â†’                </label>
   268â†’                <div className="relative inline-flex items-center">
   269â†’                  <input
   270â†’                    id={toggleId}
   271â†’                    type="checkbox"
   272â†’                    checked={sub?.push_enabled ?? false}
   273â†’                    onChange={(e) => handleTogglePush(skill.id, e.target.checked)}
   274â†’                    className="sr-only peer"
   275â†’                    aria-label={`${sub?.push_enabled ? 'å…³é—­' : 'å¼€å¯'} ${skill.name} æ¨é€é€šçŸ¥`}
   276â†’                  />
   277â†’                  <div className="w-11 h-6 bg-[var(--bg-secondary)] peer-focus-visible:ring-2 peer-focus-visible:ring-accent peer-focus-visible:ring-offset-2 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-transform peer-checked:bg-accent cursor-pointer"></div>
   278â†’                </div>
   279â†’              </div>
   280â†’            )
   281â†’          })}
   282â†’        </div>
   283â†’      )}
   284â†’
   285â†’      <div className="pt-4 border-t border-[var(--border-light)]">
   286â†’        <p className="text-xs text-text-tertiary">
   287â†’          æ¨é€é€šçŸ¥ç”¨äºæé†’ä½ é‡è¦çš„è¿åŠ¿å˜åŒ–å’Œä¸ªæ€§åŒ–å»ºè®®ã€‚ä½ å¯ä»¥éšæ—¶åœ¨è¿™é‡Œè°ƒæ•´è®¾ç½®ã€‚
   288â†’        </p>
   289â†’      </div>
   290â†’    </div>
   291â†’  )
   292â†’}
   293â†’
   294â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   295â†’// è®°å¿†ç®¡ç†åŒºå— - æ˜¾ç¤ºç”¨æˆ·æ´å¯Ÿ
   296â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   297â†’// å¸®åŠ©ä¸åé¦ˆåŒºå—
   298â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   299â†’
   300â†’function HelpFeedbackSection() {
   301â†’  return (
   302â†’    <div className="space-y-6">
   303â†’      <h2 className="font-serif text-xl text-text-primary">å¸®åŠ©ä¸åé¦ˆ</h2>
   304â†’
   305â†’      <div className="space-y-4">
   306â†’        <a
   307â†’          href="mailto:support@vibelife.app"
   308â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   309â†’        >
   310â†’          <div className="flex items-center gap-3">
   311â†’            <span className="text-xl" aria-hidden="true">ğŸ“§</span>
   312â†’            <div>
   313â†’              <p className="text-text-primary font-medium">è”ç³»å®¢æœ</p>
   314â†’              <p className="text-sm text-text-secondary">support@vibelife.app</p>
   315â†’            </div>
   316â†’          </div>
   317â†’        </a>
   318â†’
   319â†’        <a
   320â†’          href="https://vibelife.app/faq"
   321â†’          target="_blank"
   322â†’          rel="noopener noreferrer"
   323â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   324â†’        >
   325â†’          <div className="flex items-center gap-3">
   326â†’            <span className="text-xl" aria-hidden="true">â“</span>
   327â†’            <div>
   328â†’              <p className="text-text-primary font-medium">å¸¸è§é—®é¢˜</p>
   329â†’              <p className="text-sm text-text-secondary">æŸ¥çœ‹å¸¸è§é—®é¢˜è§£ç­”</p>
   330â†’            </div>
   331â†’          </div>
   332â†’        </a>
   333â†’
   334â†’        <a
   335â†’          href="https://vibelife.app/feedback"
   336â†’          target="_blank"
   337â†’          rel="noopener noreferrer"
   338â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   339â†’        >
   340â†’          <div className="flex items-center gap-3">
   341â†’            <span className="text-xl" aria-hidden="true">ğŸ’¡</span>
   342â†’            <div>
   343â†’              <p className="text-text-primary font-medium">åŠŸèƒ½å»ºè®®</p>
   344â†’              <p className="text-sm text-text-secondary">å‘Šè¯‰æˆ‘ä»¬ä½ å¸Œæœ›çœ‹åˆ°çš„åŠŸèƒ½</p>
   345â†’            </div>
   346â†’          </div>
   347â†’        </a>
   348â†’
   349â†’        <a
   350â†’          href="https://vibelife.app/bug-report"
   351â†’          target="_blank"
   352â†’          rel="noopener noreferrer"
   353â†’          className="block p-4 bg-[var(--bg-card-alt)] rounded-lg hover:bg-[var(--bg-secondary)] transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   354â†’        >
   355â†’          <div className="flex items-center gap-3">
   356â†’            <span className="text-xl" aria-hidden="true">ğŸ›</span>
   357â†’            <div>
   358â†’              <p className="text-text-primary font-medium">æŠ¥å‘Šé—®é¢˜</p>
   359â†’              <p className="text-sm text-text-secondary">å‘ç°é—®é¢˜ï¼Ÿå‘Šè¯‰æˆ‘ä»¬</p>
   360â†’            </div>
   361â†’          </div>
   362â†’        </a>
   363â†’      </div>
   364â†’    </div>
   365â†’  )
   366â†’}
   367â†’
   368â†’// ç™»å½•æ£€æŸ¥ Wrapper
   369â†’function SettingsAuthGuard({ children }: { children: React.ReactNode }) {
   370â†’  const router = useRouter()
   371â†’  const { user, isLoaded: authLoaded } = useAuth()
   372â†’
   373â†’  if (!authLoaded) {
   374â†’    return (
   375â†’      <div className="h-screen flex items-center justify-center bg-background">
   376â†’        <div className="animate-pulse text-muted-foreground">åŠ è½½ä¸­...</div>
   377â†’      </div>
   378â†’    )
   379â†’  }
   380â†’
   381â†’  if (!user) {
   382â†’    return (
   383â†’      <div className="h-screen flex flex-col bg-background">
   384â†’        <div className="flex-1 flex flex-col items-center justify-center p-8">
   385â†’          <div className="w-20 h-20 rounded-2xl bg-gradient-to-br from-vellum-200 to-vellum-300 flex items-center justify-center mb-6">
   386â†’            <span className="text-4xl">âš™ï¸</span>
   387â†’          </div>
   388â†’          <h2 className="text-2xl font-bold text-foreground mb-2">è®¾ç½®</h2>
   389â†’          <p className="text-muted-foreground text-center max-w-md mb-6">
   390â†’            ç™»å½•åå³å¯ç®¡ç†ä½ çš„ä¸ªäººèµ„æ–™ã€è®¢é˜…å’Œåå¥½è®¾ç½®ã€‚
   391â†’          </p>
   392â†’          <button
   393â†’            onClick={() => router.push('/auth/login?redirect=/settings')}
   394â†’            className="px-6 py-3 rounded-full bg-accent-primary text-white font-medium hover:bg-accent-primary/90 transition-colors"
   395â†’          >
   396â†’            ç™»å½•
   397â†’          </button>
   398â†’        </div>
   399â†’      </div>
   400â†’    )
   401â†’  }
   402â†’
   403â†’  return <>{children}</>
   404â†’}
   405â†’
   406â†’function SettingsPageContent() {
   407â†’  const router = useRouter()
   408â†’  const searchParams = useSearchParams()
   409â†’
   410â†’  // URL çŠ¶æ€åŒæ­¥ - ä» URL è¯»å– section å‚æ•°
   411â†’  const sectionFromUrl = searchParams.get('section')
   412â†’  const validSections = SETTINGS_MENU.map(m => m.id)
   413â†’  const initialSection = sectionFromUrl && validSections.includes(sectionFromUrl) ? sectionFromUrl : 'profile'
   414â†’
   415â†’  const [activeSection, setActiveSection] = useState(initialSection)
   416â†’
   417â†’  // åŒæ­¥ activeSection åˆ° URL
   418â†’  const handleSectionChange = useCallback((sectionId: string) => {
   419â†’    setActiveSection(sectionId)
   420â†’    const url = new URL(window.location.href)
   421â†’    url.searchParams.set('section', sectionId)
   422â†’    router.replace(url.pathname + url.search, { scroll: false })
   423â†’  }, [router])
   424â†’  const [loading, setLoading] = useState(false)
   425â†’  const [voiceMode, setVoiceModeState] = useState<"warm" | "sarcastic" | "wise">("warm")
   426â†’  const [profile, setProfile] = useState<UserProfile>(() => ({
   427â†’    nickname: 'ç”¨æˆ·',
   428â†’    email: 'user@example.com',
   429â†’    avatar: 'ğŸ‘¤',
   430â†’    // Do not prefill with fake defaults; leave empty until loaded
   431â†’    birthDate: '',
   432â†’    birthTime: '',
   433â†’    timezone: 'Asia/Shanghai',
   434â†’  }))
   435â†’  // Local Y/M/D states for better date UX (year select solves typing issue)
   436â†’  const [birthYear, setBirthYear] = useState('')
   437â†’  const [birthMonth, setBirthMonth] = useState('')
   438â†’  const [birthDay, setBirthDay] = useState('')
   439â†’
   440â†’  useEffect(() => {
   441â†’    // Prefer authoritative profile from API; fall back to cached localStorage
   442â†’    const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
   443â†’    if (user) {
   444â†’      setProfile(prev => ({
   445â†’        ...prev,
   446â†’        nickname: user.nickname || user.display_name || 'ç”¨æˆ·',
   447â†’        email: user.email || '',
   448â†’        avatar: user.avatar || 'ğŸ‘¤',
   449â†’        timezone: user.timezone || 'Asia/Shanghai',
   450â†’      }))
   451â†’    }
   452â†’
   453â†’    const token = getAccessToken()
   454â†’    if (!token) return
   455â†’
   456â†’    // Fetch current profile to populate birth date/time accurately
   457â†’    fetch(`${API_BASE}/profile`, {
   458â†’      headers: { 'Authorization': `Bearer ${token}` }
   459â†’    })
   460â†’      .then(async (res) => {
   461â†’        if (!res.ok) return null
   462â†’        return res.json()
   463â†’      })
   464â†’      .then((data) => {
   465â†’        if (!data) return
   466â†’        // Parse ISO like "YYYY-MM-DDTHH:MM:SS" without TZ shift
   467â†’        const iso: string | undefined = data.birth_datetime
   468â†’        let birthDate = ''
   469â†’        let birthTime = ''
   470â†’        if (iso && typeof iso === 'string') {
   471â†’          const [d, t] = iso.split('T')
   472â†’          birthDate = d || ''
   473â†’          if (t) birthTime = t.slice(0, 5) // HH:MM
   474â†’        }
   475â†’
   476â†’        setProfile(prev => ({
   477â†’          ...prev,
   478â†’          nickname: data.display_name ?? prev.nickname,
   479â†’          avatar: data.avatar_url ? 'ğŸ‘¤' : prev.avatar,
   480â†’          birthDate,
   481â†’          birthTime,
   482â†’          timezone: data.timezone || prev.timezone,
   483â†’        }))
   484â†’      })
   485â†’      .catch(() => {})
   486â†’
   487â†’    // Load voice mode preference
   488â†’    fetch(`${API_BASE}/preferences`, {
   489â†’      headers: { 'Authorization': `Bearer ${token}` }
   490â†’    })
   491â†’      .then(res => res.ok ? res.json() : null)
   492â†’      .then(data => {
   493â†’        if (data?.voice_mode) {
   494â†’          setVoiceModeState(data.voice_mode as "warm" | "sarcastic" | "wise")
   495â†’        }
   496â†’      })
   497â†’      .catch(() => {})
   498â†’  }, [])
   499â†’
   500â†’  // Save voice mode to API
   501â†’  const setVoiceMode = useCallback(async (mode: "warm" | "sarcastic" | "wise") => {
   502â†’    setVoiceModeState(mode)
   503â†’    const token = getAccessToken()
   504â†’    if (!token) return
   505â†’    try {
   506â†’      await fetch(`${API_BASE}/preferences`, {
   507â†’        method: 'PUT',
   508â†’        headers: {
   509â†’          'Authorization': `Bearer ${token}`,
   510â†’          'Content-Type': 'application/json'
   511â†’        },
   512â†’        body: JSON.stringify({ voice_mode: mode })
   513â†’      })
   514â†’    } catch (error) {
   515â†’      console.error('Failed to save voice mode:', error)
   516â†’    }
   517â†’  }, [])
   518â†’
   519â†’  // Keep local Y/M/D in sync when profile.birthDate changes (e.g., loaded from API)
   520â†’  useEffect(() => {
   521â†’    const [y, m, d] = (profile.birthDate || '').split('-')
   522â†’    setBirthYear(y || '')
   523â†’    setBirthMonth(m || '')
   524â†’    setBirthDay(d || '')
   525â†’  }, [profile.birthDate])
   526â†’
   527â†’  // Use useCallback for stable reference (Vercel rule: rerender-functional-setstate)
   528â†’  const handleProfileChange = useCallback((field: keyof UserProfile, value: string) => {
   529â†’    setProfile(prev => ({ ...prev, [field]: value }))
   530â†’  }, [])
   531â†’
   532â†’  const handleSaveProfile = useCallback(async () => {
   533â†’    setLoading(true)
   534â†’    try {
   535â†’      const user = getLocalStorageJSON<Record<string, string> | null>('user', null)
   536â†’      const token = getAccessToken()
   537â†’
   538â†’      if (user?.user_id && token) {
   539â†’        const body: any = {
   540â†’          display_name: profile.nickname,
   541â†’          timezone: profile.timezone,
   542â†’        }
   543â†’        // When both date and time present -> set; otherwise explicitly clear on server
   544â†’        if (profile.birthDate && profile.birthTime) {
   545â†’          body.birth_datetime = `${profile.birthDate}T${profile.birthTime}:00`
   546â†’        } else {
   547â†’          body.birth_datetime = null
   548â†’        }
   549â†’
   550â†’        const res = await fetch(`${API_BASE}/profile`, {
   551â†’          method: 'PUT',
   552â†’          headers: {
   553â†’            'Content-Type': 'application/json',
   554â†’            'Authorization': `Bearer ${token}`
   555â†’          },
   556â†’          body: JSON.stringify(body),
   557â†’        })
   558â†’
   559â†’        if (res.ok) {
   560â†’          // Update local cache with normalized values
   561â†’          setLocalStorageJSON('user', {
   562â†’            ...user,
   563â†’            nickname: profile.nickname,
   564â†’            display_name: profile.nickname,
   565â†’            birth_date: profile.birthDate || undefined,
   566â†’            birth_time: profile.birthTime || undefined,
   567â†’            timezone: profile.timezone,
   568â†’          })
   569â†’        }
   570â†’      }
   571â†’    } catch (err) {
   572â†’      console.error('Failed to save profile:', err)
   573â†’    } finally {
   574â†’      setLoading(false)
   575â†’    }
   576â†’  }, [profile])
   577â†’
   578â†’  // è®¾ç½®å†…å®¹åŒºåŸŸ
   579â†’  const SettingsContent = () => {
   580â†’    switch (activeSection) {
   581â†’      case 'profile':
   582â†’        return (
   583â†’          <div className="space-y-6">
   584â†’            <h2 className="font-serif text-xl text-text-primary">ä¸ªäººèµ„æ–™</h2>
   585â†’            <div className="space-y-4">
   586â†’              <div>
   587â†’                <label className="block text-sm text-text-secondary mb-2">å¤´åƒ</label>
   588â†’                <div className="flex items-center gap-4">
   589â†’                  <div className="w-16 h-16 rounded-full bg-[var(--bg-secondary)] flex items-center justify-center text-3xl">
   590â†’                    {profile.avatar}
   591â†’                  </div>
   592â†’                  <button className="btn btn-secondary">æ›´æ¢å¤´åƒ</button>
   593â†’                </div>
   594â†’              </div>
   595â†’              <div>
   596â†’                <label htmlFor="nickname" className="block text-sm text-text-secondary mb-2">æ˜µç§°</label>
   597â†’                <input
   598â†’                  id="nickname"
   599â†’                  type="text"
   600â†’                  value={profile.nickname}
   601â†’                  onChange={(e) => handleProfileChange('nickname', e.target.value)}
   602â†’                  className="input"
   603â†’                  autoComplete="nickname"
   604â†’                />
   605â†’              </div>
   606â†’              <div>
   607â†’                <label htmlFor="email" className="block text-sm text-text-secondary mb-2">é‚®ç®±</label>
   608â†’                <input
   609â†’                  id="email"
   610â†’                  type="email"
   611â†’                  value={profile.email}
   612â†’                  disabled
   613â†’                  className="input bg-[var(--bg-secondary)]"
   614â†’                  autoComplete="email"
   615â†’                  aria-describedby="email-hint"
   616â†’                />
   617â†’                <p id="email-hint" className="sr-only">é‚®ç®±åœ°å€ä¸å¯ä¿®æ”¹</p>
   618â†’              </div>
   619â†’              <div>
   620â†’                <label className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¥æœŸ</label>
   621â†’                <BirthDateInputs
   622â†’                  year={birthYear}
   623â†’                  month={birthMonth}
   624â†’                  day={birthDay}
   625â†’                  onYearChange={(v) => {
   626â†’                    setBirthYear(v)
   627â†’                    const dateStr = v && birthMonth && birthDay ? `${v}-${birthMonth}-${birthDay}` : ''
   628â†’                    handleProfileChange('birthDate', dateStr)
   629â†’                  }}
   630â†’                  onMonthChange={(v) => {
   631â†’                    setBirthMonth(v)
   632â†’                    const dateStr = birthYear && v && birthDay ? `${birthYear}-${v}-${birthDay}` : ''
   633â†’                    handleProfileChange('birthDate', dateStr)
   634â†’                  }}
   635â†’                  onDayChange={(v) => {
   636â†’                    setBirthDay(v)
   637â†’                    const dateStr = birthYear && birthMonth && v ? `${birthYear}-${birthMonth}-${v}` : ''
   638â†’                    handleProfileChange('birthDate', dateStr)
   639â†’                  }}
   640â†’                  showHour={false}
   641â†’                />
   642â†’              </div>
   643â†’              <div>
   644â†’                <label htmlFor="birthTime" className="block text-sm text-text-secondary mb-2">å‡ºç”Ÿæ—¶é—´</label>
   645â†’                <div className="flex items-center gap-3">
   646â†’                  <input
   647â†’                    id="birthTime"
   648â†’                    type="time"
   649â†’                    step={60}
   650â†’                    value={profile.birthTime}
   651â†’                    onChange={(e) => handleProfileChange('birthTime', e.target.value)}
   652â†’                    className="input"
   653â†’                    placeholder="--:--"
   654â†’                    autoComplete="off"
   655â†’                  />
   656â†’                  <label htmlFor="birthTimeUnknown" className="inline-flex items-center gap-2 text-sm text-text-secondary cursor-pointer">
   657â†’                    <input
   658â†’                      id="birthTimeUnknown"
   659â†’                      type="checkbox"
   660â†’                      checked={!profile.birthTime}
   661â†’                      onChange={(e) => handleProfileChange('birthTime', e.target.checked ? '' : '12:00')}
   662â†’                      className="rounded border-gray-300 focus:ring-accent"
   663â†’                    />
   664â†’                    ä¸ç¡®å®š
   665â†’                  </label>
   666â†’                </div>
   667â†’              </div>
   668â†’              <div>
   669â†’                <label htmlFor="timezone" className="block text-sm text-text-secondary mb-2">æ—¶åŒº</label>
   670â†’                <select
   671â†’                  id="timezone"
   672â†’                  value={profile.timezone}
   673â†’                  onChange={(e) => handleProfileChange('timezone', e.target.value)}
   674â†’                  className="input"
   675â†’                >
   676â†’                  <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
   677â†’                  <option value="Asia/Hong_Kong">Asia/Hong_Kong (UTC+8)</option>
   678â†’                  <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
   679â†’                  <option value="America/New_York">America/New_York (UTC-5)</option>
   680â†’                  <option value="America/Los_Angeles">America/Los_Angeles (UTC-8)</option>
   681â†’                  <option value="Europe/London">Europe/London (UTC+0)</option>
   682â†’                </select>
   683â†’              </div>
   684â†’              <button onClick={handleSaveProfile} disabled={loading} className="btn btn-primary">
   685â†’                {loading ? 'ä¿å­˜ä¸­â€¦' : 'ä¿å­˜æ›´æ”¹'}
   686â†’              </button>
   687â†’            </div>
   688â†’          </div>
   689â†’        )
   690â†’      case 'skills':
   691â†’        return <SkillSettingsSection router={router} />
   692â†’      case 'notifications':
   693â†’        return <NotificationSettingsSection />
   694â†’      case 'membership':
   695â†’        return (
   696â†’          <div className="space-y-6">
   697â†’            <h2 className="font-serif text-xl text-text-primary">ä¼šå‘˜ç®¡ç†</h2>
   698â†’            <div className="card p-6">
   699â†’              <div className="flex items-center justify-between mb-4">
   700â†’                <div>
   701â†’                  <p className="text-text-primary font-medium">å½“å‰çŠ¶æ€</p>
   702â†’                  <p className="text-sm text-text-secondary">å…è´¹ç”¨æˆ·</p>
   703â†’                </div>
   704â†’                <span className="px-3 py-1 bg-[var(--bg-secondary)] rounded-full text-sm text-text-secondary">Free</span>
   705â†’              </div>
   706â†’              <button onClick={() => router.push('/membership')} className="btn btn-premium w-full">
   707â†’                âœ¨ å‡çº§ Premium
   708â†’              </button>
   709â†’            </div>
   710â†’            <div className="space-y-3">
   711â†’              <p className="text-sm text-text-secondary">Premium ä¼šå‘˜æƒç›Šï¼š</p>
   712â†’              <ul className="space-y-2 text-sm text-text-secondary">
   713â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´æ¯æ—¥è¿åŠ¿</li>
   714â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> 30&#x00A0;æ¬¡/å¤© AIå¯¹è¯</li>
   715â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> å®Œæ•´å¤§è¿/æµå¹´åˆ†æ</li>
   716â†’                <li className="flex items-center gap-2"><span className="text-success">âœ“</span> Identity Prism æ·±åº¦è§£è¯»</li>
   717â†’              </ul>
   718â†’            </div>
   719â†’          </div>
   720â†’        )
   721â†’      case 'account':
   722â†’        return (
   723â†’          <div className="space-y-6">
   724â†’            <h2 className="font-serif text-xl text-text-primary">è´¦æˆ·ç®¡ç†</h2>
   725â†’            <AccountDeletionSection />
   726â†’          </div>
   727â†’        )
   728â†’      case 'preferences':
   729â†’        return (
   730â†’          <div className="space-y-6">
   731â†’            <h2 className="font-serif text-xl text-text-primary">åå¥½è®¾ç½®</h2>
   732â†’            <div className="space-y-4">
   733â†’              {/* è¯­æ°”æ¨¡å¼ */}
   734â†’              <div className="p-4 bg-[var(--bg-card-alt)] rounded-lg">
   735â†’                <div className="mb-3">
   736â†’                  <h3 className="text-text-primary font-medium mb-1">è¯­æ°”æ¨¡å¼</h3>
   737â†’                  <p className="text-sm text-text-secondary">é€‰æ‹© AI çš„å¯¹è¯é£æ ¼</p>
   738â†’                </div>
   739â†’                <div className="flex gap-3" role="radiogroup" aria-label="é€‰æ‹©è¯­æ°”æ¨¡å¼">
   740â†’                  <button
   741â†’                    role="radio"
   742â†’                    aria-checked={voiceMode === 'warm'}
   743â†’                    onClick={() => setVoiceMode('warm')}
   744â†’                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 ${
   745â†’                      voiceMode === 'warm'
   746â†’                        ? 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 shadow-sm'
   747â†’                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
   748â†’                    }`}
   749â†’                  >
   750â†’                    <div className="text-2xl mb-1" aria-hidden="true">ğŸŒ</div>
   751â†’                    <div>æ¸©æš–æ”¯æŒ</div>
   752â†’                  </button>
   753â†’                  <button
   754â†’                    role="radio"
   755â†’                    aria-checked={voiceMode === 'sarcastic'}
   756â†’                    onClick={() => setVoiceMode('sarcastic')}
   757â†’                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 ${
   758â†’                      voiceMode === 'sarcastic'
   759â†’                        ? 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 shadow-sm'
   760â†’                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
   761â†’                    }`}
   762â†’                  >
   763â†’                    <div className="text-2xl mb-1" aria-hidden="true">ğŸ˜ˆ</div>
   764â†’                    <div>ç›´æ¥æŒ‘æˆ˜</div>
   765â†’                  </button>
   766â†’                  <button
   767â†’                    role="radio"
   768â†’                    aria-checked={voiceMode === 'wise'}
   769â†’                    onClick={() => setVoiceMode('wise')}
   770â†’                    className={`flex-1 px-4 py-3 rounded-lg text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 ${
   771â†’                      voiceMode === 'wise'
   772â†’                        ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 shadow-sm'
   773â†’                        : 'bg-[var(--bg-secondary)] text-text-secondary hover:bg-[var(--bg-tertiary)]'
   774â†’                    }`}
   775â†’                  >
   776â†’                    <div className="text-2xl mb-1" aria-hidden="true">ğŸ§™</div>
   777â†’                    <div>ç¿æ™ºå¯¼å¸ˆ</div>
   778â†’                  </button>
   779â†’                </div>
   780â†’                <div className="mt-3 p-3 bg-[var(--bg-callout)] rounded text-xs text-text-secondary">
   781â†’                  {voiceMode === 'warm' && 'ğŸ’­ åƒä¸€ä¸ªç†è§£ä½ çš„è€æœ‹å‹ï¼Œæ¸©æš–ä½†ä¸å¤±æ´å¯Ÿ'}
   782â†’                  {voiceMode === 'sarcastic' && 'ğŸ’­ ç”¨å¹½é»˜å’ŒçŠ€åˆ©çš„æ–¹å¼æˆ³ç ´ä½ çš„è‡ªæ¬ºæ¬ºäººï¼Œæ¨åŠ¨ä½ é¢å¯¹çœŸç›¸'}
   783â†’                  {voiceMode === 'wise' && 'ğŸ’­ åƒä¸€ä½ç»å†ä¸°å¯Œçš„é•¿è¾ˆï¼Œç”¨æ·±åº¦å’Œç†æ€§å¼•å¯¼æ€è€ƒ'}
   784â†’                </div>
   785â†’              </div>
   786â†’            </div>
   787â†’          </div>
   788â†’        )
   789â†’      case 'help':
   790â†’        return <HelpFeedbackSection />
   791â†’      case 'about':
   792â†’        return (
   793â†’          <div className="space-y-6">
   794â†’            <h2 className="font-serif text-xl text-text-primary">å…³äº VibeLife</h2>
   795â†’            <div className="text-center py-8">
   796â†’              <span className="text-5xl mb-4 block">ğŸŒŸ</span>
   797â†’              <h3 className="font-serif text-2xl text-text-primary mb-2">VibeLife</h3>
   798â†’              <p className="text-text-secondary mb-4">æ¢ç´¢å†…å¿ƒä¸–ç•Œ</p>
   799â†’              <p className="text-sm text-text-secondary">ç‰ˆæœ¬&#x00A0;6.0.0</p>
   800â†’            </div>
   801â†’            <div className="space-y-2 text-sm text-text-secondary">
   802â†’              <a href="/terms" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">ç”¨æˆ·åè®®</a>
   803â†’              <a href="/privacy" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">éšç§æ”¿ç­–</a>
   804â†’              <a href="mailto:support@vibelife.app" className="block w-full p-3 text-left hover:bg-[var(--bg-secondary)] rounded-lg">è”ç³»æˆ‘ä»¬</a>
   805â†’            </div>
   806â†’          </div>
   807â†’        )
   808â†’      default:
   809â†’        return (
   810â†’          <div className="text-center py-8 text-text-secondary">
   811â†’            <p>è¯¥åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...</p>
   812â†’          </div>
   813â†’        )
   814â†’    }
   815â†’  }
   816â†’
   817â†’  // ä½¿ç”¨ AuthProvider çš„ logout åŠŸèƒ½
   818â†’  const { logout } = useAuth()
   819â†’
   820â†’  // å¤„ç†é€€å‡ºç™»å½•
   821â†’  const handleLogout = useCallback(async () => {
   822â†’    try {
   823â†’      await logout()
   824â†’      router.push('/auth/login')
   825â†’    } catch (err) {
   826â†’      console.error('Logout failed:', err)
   827â†’    }
   828â†’  }, [logout, router])
   829â†’
   830â†’  // PCç«¯è®¾ç½®èœå•åŒºå— - V10 æ¸å˜èƒŒæ™¯ emoji å›¾æ ‡é£æ ¼
   831â†’  const SettingsMenuSection = () => (
   832â†’    <div className="w-64 flex-shrink-0 bg-card border-r border-border h-full overflow-y-auto">
   833â†’      <div className="p-4 border-b border-border">
   834â†’        <h2 className="font-semibold text-foreground">è®¾ç½®</h2>
   835â†’      </div>
   836â†’      <nav className="p-2 space-y-1" aria-label="è®¾ç½®èœå•">
   837â†’        {SETTINGS_MENU.map((item) => (
   838â†’          <button
   839â†’            key={item.id}
   840â†’            onClick={() => handleSectionChange(item.id)}
   841â†’            aria-current={activeSection === item.id ? 'page' : undefined}
   842â†’            className={cn(
   843â†’              "w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2",
   844â†’              activeSection === item.id
   845â†’                ? 'bg-[var(--accent-primary)]/10 text-[var(--accent-primary)]'
   846â†’                : 'text-muted-foreground hover:bg-muted hover:text-foreground'
   847â†’            )}
   848â†’          >
   849â†’            <div className={cn(
   850â†’              "w-7 h-7 rounded-lg flex items-center justify-center flex-shrink-0 transition-all",
   851â†’              activeSection === item.id
   852â†’                ? "bg-gradient-to-br from-vellum-200 to-vellum-300"
   853â†’                : "bg-gradient-to-br from-vellum-100 to-vellum-200"
   854â†’            )}>
   855â†’              <span className="text-base" aria-hidden="true">{item.icon}</span>
   856â†’            </div>
   857â†’            <span className="text-sm font-medium">{item.label}</span>
   858â†’          </button>
   859â†’        ))}
   860â†’      </nav>
   861â†’      <div className="p-2 border-t border-border mt-2">
   862â†’        <button
   863â†’          onClick={handleLogout}
   864â†’          className="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-red-500 hover:bg-red-50 dark:hover:bg-red-950/20 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2"
   865â†’          aria-label="é€€å‡ºç™»å½•å½“å‰è´¦æˆ·"
   866â†’        >
   867â†’          <div className="w-7 h-7 rounded-lg bg-gradient-to-br from-red-100 to-red-200 flex items-center justify-center flex-shrink-0">
   868â†’            <span className="text-base" aria-hidden="true">ğŸšª</span>
   869â†’          </div>
   870â†’          <span className="text-sm font-medium">é€€å‡ºç™»å½•</span>
   871â†’        </button>
   872â†’      </div>
   873â†’    </div>
   874â†’  )
   875â†’
   876â†’  // PCç«¯ä¸»å†…å®¹
   877â†’  const PCMainContent = () => (
   878â†’    <div className="flex-1 overflow-y-auto p-6">
   879â†’      <div className="max-w-2xl">
   880â†’        <div className="bg-card rounded-xl p-6 shadow-sm">
   881â†’          <SettingsContent />
   882â†’        </div>
   883â†’      </div>
   884â†’    </div>
   885â†’  )
   886â†’
   887â†’  // ç§»åŠ¨ç«¯å†…å®¹
   888â†’  const MobileContentView = () => (
   889â†’    <div className="min-h-screen bg-background lg:hidden">
   890â†’      {/* ç®€åŒ–ç‰ˆ headerï¼Œä¸ä¾èµ– AppShell */}
   891â†’      <header className="h-14 flex items-center justify-between px-4 bg-card/80 backdrop-blur-sm border-b border-border safe-area-pt">
   892â†’        <div className="flex items-center gap-2">
   893â†’          <VibeGlyph size="sm" skill="bazi" showAura={false} animate={false} />
   894â†’          <span className="font-serif font-semibold text-foreground">è®¾ç½®</span>
   895â†’        </div>
   896â†’      </header>
   897â†’
   898â†’      <main className="max-w-lg mx-auto px-4 py-6">
   899â†’        <h1 className="font-serif text-xl text-foreground mb-4">è®¾ç½®</h1>
   900â†’        <nav className="space-y-2" aria-label="è®¾ç½®èœå•">
   901â†’          {SETTINGS_MENU.map((item) => (
   902â†’            <button
   903â†’              key={item.id}
   904â†’              onClick={() => {
   905â†’                if (item.id === 'membership') {
   906â†’                  router.push('/membership')
   907â†’                } else {
   908â†’                  handleSectionChange(item.id)
   909â†’                }
   910â†’              }}
   911â†’              aria-current={activeSection === item.id ? 'page' : undefined}
   912â†’              className="w-full bg-card p-4 flex items-center gap-3 rounded-lg shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2"
   913â†’            >
   914â†’              <div className="w-9 h-9 rounded-lg bg-gradient-to-br from-vellum-100 to-vellum-200 flex items-center justify-center flex-shrink-0">
   915â†’                <span className="text-lg" aria-hidden="true">{item.icon}</span>
   916â†’              </div>
   917â†’              <span className="text-foreground">{item.label}</span>
   918â†’              <span className="ml-auto text-muted-foreground" aria-hidden="true">â€º</span>
   919â†’            </button>
   920â†’          ))}
   921â†’        </nav>
   922â†’
   923â†’        <div className="mt-8">
   924â†’          <button
   925â†’            onClick={handleLogout}
   926â†’            className="w-full p-4 text-center text-red-500 bg-card rounded-lg shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-red-500 focus-visible:ring-offset-2"
   927â†’            aria-label="é€€å‡ºç™»å½•å½“å‰è´¦æˆ·"
   928â†’          >
   929â†’            é€€å‡ºç™»å½•
   930â†’          </button>
   931â†’        </div>
   932â†’
   933â†’        <div className="mt-8 text-center text-sm text-muted-foreground">
   934â†’          <p>VibeLife v&#x00A0;6.0.0</p>
   935â†’        </div>
   936â†’      </main>
   937â†’    </div>
   938â†’  )
   939â†’
   940â†’  return (
   941â†’    <div className="h-screen flex flex-col bg-background">
   942â†’      {/* PCç«¯å¸ƒå±€ */}
   943â†’      <div className="hidden lg:flex h-full">
   944â†’        {/* å·¦ä¾§ NavBar - ä¸ Chat é¡µä¿æŒä¸€è‡´ */}
   945â†’        <NavBar
   946â†’          skill="bazi"
   947â†’          activeTab="me"
   948â†’          onTabChange={(tab) => {
   949â†’            if (tab === 'chat') router.push('/chat')
   950â†’            else if (tab === 'journey') router.push('/chat?tab=journey')
   951â†’            else if (tab === 'discover') router.push('/chat?tab=discover')
   952â†’            else if (tab === 'me') router.push('/chat?tab=me')
   953â†’          }}
   954â†’          activeConversationId={null}
   955â†’          onSelectConversation={() => {}}
   956â†’          onNewChat={() => router.push('/chat')}
   957â†’        />
   958â†’
   959â†’        {/* è®¾ç½®èœå•åŒºå— */}
   960â†’        <SettingsMenuSection />
   961â†’
   962â†’        {/* ä¸»å†…å®¹åŒºåŸŸ */}
   963â†’        <PCMainContent />
   964â†’      </div>
   965â†’
   966â†’      {/* ç§»åŠ¨ç«¯å¸ƒå±€ */}
   967â†’      <MobileContentView />
   968â†’    </div>
   969â†’  )
   970â†’}
   971â†’
   972â†’// ä½¿ç”¨ Suspense åŒ…è£¹ï¼Œå› ä¸ºä½¿ç”¨äº† useSearchParams
   973â†’export default function SettingsPage() {
   974â†’  return (
   975â†’    <Suspense fallback={
   976â†’      <div className="h-screen flex items-center justify-center bg-background">
   977â†’        <div className="animate-pulse text-muted-foreground">åŠ è½½ä¸­...</div>
   978â†’      </div>
   979â†’    }>
   980â†’      <SettingsAuthGuard>
   981â†’        <SettingsPageContent />
   982â†’      </SettingsAuthGuard>
   983â†’    </Suspense>
   984â†’  )
   985â†’}
   986â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
