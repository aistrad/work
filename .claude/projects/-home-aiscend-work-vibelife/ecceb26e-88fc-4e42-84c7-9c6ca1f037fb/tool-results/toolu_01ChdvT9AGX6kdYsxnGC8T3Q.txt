   210→# 订阅管理端点 (v7.4)
   211→# ═══════════════════════════════════════════════════════════════════════════
   212→
   213→@router.get("/subscriptions")
   214→async def get_subscriptions(current_user: CurrentUser = Depends(get_current_user)):
   215→    """
   216→    获取用户订阅列表
   217→
   218→    v7.5: 使用数据库优先加载
   219→
   220→    Returns:
   221→        subscriptions: 所有 Skill 的订阅状态列表
   222→        summary: 统计摘要
   223→    """
   224→    subscriptions = await UnifiedProfileRepository.get_user_subscriptions(current_user.user_id)
   225→    # v7.5: 使用 async 函数
   226→    all_skills = await get_all_skill_metadata_async()
   227→
   228→    result = []
   229→    for skill in all_skills:
   230→        sub = next((s for s in subscriptions if s.skill_id == skill.id), None)
   231→        result.append({
   232→            "skill_id": skill.id,
   233→            "skill_name": skill.name,
   234→            "status": sub.status if sub else "not_subscribed",
   235→            "push_enabled": sub.push_enabled if sub else False,
   236→            "subscribed_at": sub.subscribed_at.isoformat() if sub and sub.subscribed_at else None,
   237→            "can_unsubscribe": skill.subscription.can_unsubscribe,
   238→            "trial_messages_used": sub.trial_messages_used if sub else 0,
   239→        })
   240→
   241→    return {
   242→        "subscriptions": result,
   243→        "summary": {
   244→            "total_subscribed": len([s for s in result if s["status"] == "subscribed"]),
   245→            "total_available": len(all_skills),
   246→            "push_enabled_count": len([s for s in result if s["push_enabled"]]),
   247→        }
   248→    }
   249→
   250→
   251→@router.get("/recommendations")
   252→async def get_recommendations(
   253→    limit: int = Query(default=3, le=10, description="返回数量"),
   254→    context: Optional[str] = Query(None, description="当前对话上下文"),
   255→    current_user: CurrentUser = Depends(get_current_user),
   256→):
   257→    """
   258→    获取推荐 Skill
   259→
   260→    v7.5: 使用数据库优先加载
   261→
   262→    基于用户档案、使用历史和对话上下文推荐 Skill。
   263→
   264→    Args:
   265→        limit: 返回数量，默认 3，最大 10
   266→        context: 当前对话上下文（关键词）
   267→
   268→    Returns:
   269→        recommendations: 推荐 Skill 列表
   270→    """
   271→    # 获取用户已订阅和已屏蔽的 Skill
   272→    subscribed_ids = await UnifiedProfileRepository.get_subscribed_skill_ids(current_user.user_id)
   273→    blocked_ids = await UnifiedProfileRepository.get_blocked_skills(current_user.user_id)
   274→
   275→    # v7.5: 使用 async 函数
   276→    all_skills = await get_all_skill_metadata_async()
   277→
   278→    # 过滤：未订阅 + 未屏蔽 + 非 core
   279→    candidates = [
   280→        s for s in all_skills
   281→        if s.id not in subscribed_ids
   282→        and s.id not in blocked_ids
   283→        and s.category != "core"
   284→    ]
   285→
   286→    recommendations = []
   287→    for skill in candidates[:limit]:
   288→        # 简单推荐逻辑：基于触发词匹配
   289→        reason = "featured"
   290→        context_text = f"试试「{skill.name}」，{skill.showcase.tagline or skill.description}"
   291→
   292→        if context:
   293→            # 检查上下文是否匹配触发词
   294→            for trigger in skill.triggers:
   295→                if trigger in context:
   296→                    reason = "based_on_conversation"
   297→                    context_text = f"你提到了「{trigger}」，{skill.name} 可以帮助你。"
   298→                    break
   299→
   300→        # 获取试用次数
   301→        trial_used = await UnifiedProfileRepository.get_trial_usage(current_user.user_id, skill.id)
   302→        trial_remaining = skill.pricing.trial_messages - trial_used if skill.pricing.type != "free" else None
   303→
   304→        recommendations.append({
   305→            "skill_id": skill.id,
   306→            "skill": {
   307→                "id": skill.id,
   308→                "name": skill.name,
   309→                "icon": skill.icon,
   310→                "color": skill.color,
   311→                "tagline": skill.showcase.tagline,
   312→            },
   313→            "reason": reason,
   314→            "context": context_text,
   315→            "score": 0.8,
   316→            "trial_messages_remaining": trial_remaining,
   317→        })
   318→
   319→    return {
   320→        "recommendations": recommendations,
   321→        "generated_at": datetime.now(timezone.utc).isoformat(),
   322→    }
   323→
   324→
   325→@router.get("/featured")
   326→async def get_featured():
   327→    """
   328→    获取精选 Skill（用于首页轮播等）
   329→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
