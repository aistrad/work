   455→# ═══════════════════════════════════════════════════════════════════════════
   456→
   457→@router.get("/profile", response_model=ProfileResponse)
   458→async def get_profile(current_user: CurrentUser = Depends(get_current_user)):
   459→    """Get current user's full profile"""
   460→    from stores.unified_profile_repo import UnifiedProfileRepository
   461→
   462→    # Week 3: Read from unified_profiles instead of vibe_users
   463→    account = await UnifiedProfileRepository.get_account_full(current_user.user_id)
   464→    birth_info = await UnifiedProfileRepository.get_birth_info(current_user.user_id)
   465→
   466→    # Construct birth_datetime from birth_info
   467→    birth_datetime = None
   468→    if birth_info and birth_info.get("date"):
   469→        time_str = birth_info.get("time", "12:00:00")
   470→        birth_datetime_str = f"{birth_info['date']} {time_str}"
   471→        try:
   472→            from datetime import datetime
   473→            birth_datetime = datetime.fromisoformat(birth_datetime_str)
   474→        except:
   475→            pass
   476→
   477→    # created_at still from vibe_users (account-level immutable field)
   478→    user = await UserRepository.get_by_id(current_user.user_id)
   479→    if not user:
   480→        raise HTTPException(status_code=404, detail="User not found")
   481→
   482→    return ProfileResponse(
   483→        user_id=str(current_user.user_id),
   484→        vibe_id=account.get("vibe_id") or current_user.vibe_id,
   485→        display_name=account.get("display_name"),
   486→        avatar_url=account.get("avatar_url"),
   487→        birth_datetime=birth_datetime,
   488→        birth_location=birth_info.get("place") if birth_info else None,
   489→        timezone=account.get("timezone", "Asia/Shanghai"),
   490→        language=account.get("language", "zh-CN"),
   491→        created_at=user["created_at"]
   492→    )
   493→
   494→
   495→@router.put("/profile", response_model=ProfileResponse)
   496→async def update_profile(
   497→    request: ProfileUpdateRequest,
   498→    current_user: CurrentUser = Depends(get_current_user)
   499→):
   500→    """Update current user's profile"""
   501→    from stores.unified_profile_repo import UnifiedProfileRepository
   502→
   503→    update_data = request.model_dump(exclude_unset=True)
   504→
   505→    # Week 3: Split updates by data type
   506→    # 1. Account info (display_name, avatar_url)
   507→    if "display_name" in update_data or "avatar_url" in update_data:
   508→        await UnifiedProfileRepository.update_account_info(
   509→            current_user.user_id,
   510→            display_name=update_data.get("display_name"),
   511→            avatar_url=update_data.get("avatar_url")
   512→        )
   513→
   514→    # 2. Birth info (birth_datetime, birth_location + gender if provided)
   515→    if "birth_datetime" in update_data or "birth_location" in update_data:
   516→        birth_info = {}
   517→        if "birth_datetime" in update_data:
   518→            dt = update_data["birth_datetime"]
   519→            if dt:
   520→                birth_info["date"] = dt.date().isoformat()
   521→                birth_info["time"] = dt.time().isoformat()
   522→            else:
   523→                birth_info["date"] = None
   524→                birth_info["time"] = None
   525→
   526→        if "birth_location" in update_data:
   527→            birth_info["place"] = update_data["birth_location"]
   528→
   529→        if birth_info:
   530→            await UnifiedProfileRepository.update_birth_info(
   531→                current_user.user_id,
   532→                birth_info
   533→            )
   534→
   535→    # 3. Preferences (timezone, language)
   536→    if "timezone" in update_data or "language" in update_data:
   537→        prefs_update = {}
   538→        if "timezone" in update_data:
   539→            prefs_update["timezone"] = update_data["timezone"]
   540→        if "language" in update_data:
   541→            prefs_update["language"] = update_data["language"]
   542→
   543→        await UnifiedProfileRepository.update_preferences(
   544→            current_user.user_id,
   545→            prefs_update
   546→        )
   547→
   548→    # Return updated profile
   549→    return await get_profile(current_user)
   550→
   551→
   552→# --- Preferences Endpoints ---
   553→
   554→@router.get("/preferences", response_model=PreferencesResponse)

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
