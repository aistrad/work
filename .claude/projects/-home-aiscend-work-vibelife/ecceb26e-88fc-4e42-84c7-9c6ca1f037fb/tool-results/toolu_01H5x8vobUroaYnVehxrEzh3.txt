     1â†’"use client";
     2â†’
     3â†’/**
     4â†’ * ChatContainer - v5.2 æ€§èƒ½ä¼˜åŒ–ç‰ˆ
     5â†’ *
     6â†’ * ä¼˜åŒ–ç‚¹:
     7â†’ * 1. ä½¿ç”¨ content-visibility ä¼˜åŒ–é•¿æ¶ˆæ¯åˆ—è¡¨ (Vercel rule: rendering-content-visibility)
     8â†’ * 2. Memoize ChatEmptyState ç»„ä»¶ (Vercel rule: rerender-extract-component)
     9â†’ * 3. ä½¿ç”¨ç¼“å­˜çš„ localStorage å·¥å…· (Vercel rule: js-cache-storage)
    10â†’ */
    11â†’
    12â†’import { useRef, useEffect, useMemo, useCallback, useState, memo } from "react";
    13â†’import type { Message } from "ai/react";
    14â†’import { toast } from "sonner";
    15â†’import { ChatMessage } from "./ChatMessage";
    16â†’import { ChatInput } from "./ChatInput";
    17â†’import { InsightCard, InsightType } from "@/components/insight/InsightCard";
    18â†’import { VibeGlyph, BreathAura, type SkillType } from "@/components/core";
    19â†’import { DailyGreeting } from "@/components/greeting/DailyGreeting";
    20â†’import { ChatWelcomeMessage } from "./ChatWelcomeMessage";
    21â†’import { useVibeChat, type SkillId } from "@/hooks/useVibeChat";
    22â†’import { getLocalStorageJSON, getLocalStorage, setLocalStorage } from "@/utils/storage";
    23â†’import { useDashboardWelcomeData } from "@/hooks/useDashboardWelcomeData";
    24â†’import SkillIntroCard from "@/skills/shared/SkillIntroCard";
    25â†’import { useSkillIntro, useMarkFirstUse } from "@/skills/shared/SkillIntroCard/hooks/useSkillIntro";
    26â†’import type { IntroCardAction } from "@/skills/shared/SkillIntroCard/types";
    27â†’import type { DashboardDTO } from "@/types/dashboard";
    28â†’
    29â†’interface InsightData {
    30â†’  id: string;
    31â†’  insight_type: InsightType;
    32â†’  title: string;
    33â†’  content: string;
    34â†’}
    35â†’
    36â†’/**
    37â†’ * Extract text content from AI SDK Message
    38â†’ */
    39â†’function getMessageContent(message: Message): string {
    40â†’  return message.content || '';
    41â†’}
    42â†’
    43â†’/**
    44â†’ * UUID ç”Ÿæˆå‡½æ•°ï¼ˆå…¼å®¹ SSR å’Œä¸æ”¯æŒ crypto.randomUUID çš„ç¯å¢ƒï¼‰
    45â†’ */
    46â†’function generateUUID(): string {
    47â†’  if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
    48â†’    return crypto.randomUUID();
    49â†’  }
    50â†’  // Fallback: ä½¿ç”¨ crypto.getRandomValues
    51â†’  if (typeof crypto !== "undefined" && typeof crypto.getRandomValues === "function") {
    52â†’    return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    53â†’      const r = (crypto.getRandomValues(new Uint8Array(1))[0] & 15) >> (c === "x" ? 0 : 3);
    54â†’      return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
    55â†’    });
    56â†’  }
    57â†’  // Fallback: Math.random
    58â†’  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
    59â†’    const r = (Math.random() * 16) | 0;
    60â†’    return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
    61â†’  });
    62â†’}
    63â†’
    64â†’export type VoiceMode = "warm" | "sarcastic" | "wise";
    65â†’
    66â†’export interface ChatContainerProps {
    67â†’  /**
    68â†’   * Skill ID - å¯é€‰
    69â†’   * - ä¼ å…¥æ—¶ï¼šåç«¯ç›´æ¥ä½¿ç”¨è¯¥ skill
    70â†’   * - ä¸ä¼ æ—¶ï¼šåç«¯ CoreAgent é€šè¿‡ LLM è‡ªåŠ¨è·¯ç”±
    71â†’   */
    72â†’  skillId?: string;
    73â†’  /**
    74â†’   * Scenario/Rule ID - å¯é€‰
    75â†’   * - ä¼ å…¥æ—¶ï¼šåç«¯ç›´æ¥åŠ è½½å¯¹åº”çš„ Rule æ–‡ä»¶
    76â†’   * - ä¸ä¼ æ—¶ï¼šåç«¯æ ¹æ® tags åŒ¹é…æˆ–ä½¿ç”¨é»˜è®¤ scenario
    77â†’   */
    78â†’  scenario?: string;
    79â†’  /**
    80â†’   * ç”¨äº UI å±•ç¤ºçš„ skillï¼ˆä¸»é¢˜ã€ç©ºçŠ¶æ€ç­‰ï¼‰
    81â†’   * å½“ skillId ä¸ä¼ æ—¶ï¼Œæ­¤å­—æ®µä»å¯ç”¨äº UI å±•ç¤º
    82â†’   */
    83â†’  skill?: SkillType;
    84â†’  conversationId?: string;
    85â†’  voiceMode?: VoiceMode;
    86â†’  onConversationStart?: (id: string) => void;
    87â†’  /**
    88â†’   * ä» URL ä¼ å…¥çš„åˆå§‹æ¶ˆæ¯ï¼ˆå¦‚ä»é€šçŸ¥è·³è½¬ï¼‰
    89â†’   */
    90â†’  initialPrompt?: string | null;
    91â†’  /**
    92â†’   * åˆå§‹æ¶ˆæ¯å‘é€åçš„å›è°ƒ
    93â†’   */
    94â†’  onInitialPromptSent?: () => void;
    95â†’  /**
    96â†’   * Dashboard æ•°æ®ï¼ˆç”¨äºç©ºçŠ¶æ€ï¼‰
    97â†’   */
    98â†’  dashboardData?: DashboardDTO | null;
    99â†’  /**
   100â†’   * Dashboard æ•°æ®åŠ è½½çŠ¶æ€
   101â†’   */
   102â†’  isDashboardLoading?: boolean;
   103â†’  /**
   104â†’   * ç­¾åˆ°å›è°ƒ
   105â†’   */
   106â†’  onCheckIn?: () => Promise<void>;
   107â†’  /**
   108â†’   * æ æ†æ‰“å‹¾å›è°ƒ
   109â†’   */
   110â†’  onToggleLever?: (leverId: string) => Promise<void>;
   111â†’  /**
   112â†’   * å¤§çŸ³å¤´æ‰“å‹¾å›è°ƒ
   113â†’   */
   114â†’  onToggleRock?: (rockId: string) => Promise<void>;
   115â†’}
   116â†’
   117â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   118â†’// ChatEmptyState - LUMINOUS PAPER Design System
   119â†’// ç©ºçŠ¶æ€ï¼šå±…ä¸­ VibeGlyph + æŠ€èƒ½æ„ŸçŸ¥æ–‡æ¡ˆ + å‘¼å¸å…‰æ™•
   120â†’// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   121â†’
   122â†’const SKILL_EMPTY_STATE: Record<SkillType, { title: string; subtitle: string }> = {
   123â†’  bazi: {
   124â†’    title: "æ¢ç´¢ä½ çš„å‘½ç†",
   125â†’    subtitle: "åˆ†äº«ä½ çš„ç”Ÿè¾°ï¼Œå¼€å¯å…«å­—è§£è¯»ä¹‹æ—…",
   126â†’  },
   127â†’  zodiac: {
   128â†’    title: "å€¾å¬æ˜Ÿè¾°çš„å£°éŸ³",
   129â†’    subtitle: "è®©æ˜Ÿç›˜ä¸ºä½ æ­ç¤ºå®‡å®™çš„å¯†è¯­",
   130â†’  },
   131â†’  mbti: {
   132â†’    title: "å‘ç°çœŸå®çš„è‡ªå·±",
   133â†’    subtitle: "é€šè¿‡å¯¹è¯ï¼Œæ¢ç´¢ä½ çš„äººæ ¼ç‰¹è´¨",
   134â†’  },
   135â†’  attach: {
   136â†’    title: "ç†è§£ä½ çš„ä¾æ‹æ¨¡å¼",
   137â†’    subtitle: "æ¢ç´¢äº²å¯†å…³ç³»ä¸­çš„è‡ªæˆ‘",
   138â†’  },
   139â†’  career: {
   140â†’    title: "è§„åˆ’ä½ çš„èŒä¸šè“å›¾",
   141â†’    subtitle: "è®©æˆ‘ä»¬ä¸€èµ·æ¢ç´¢ä½ çš„èŒä¸šå‘å±•æ–¹å‘",
   142â†’  },
   143â†’  lifecoach: {
   144â†’    title: "å¼€å¯äººç”Ÿæ•™ç»ƒä¹‹æ—…",
   145â†’    subtitle: "ç§‘å­¦æ–¹æ³•ï¼ŒåŠ©ä½ çªç ´ç“¶é¢ˆï¼Œé‡å¡‘äººç”Ÿ",
   146â†’  },
   147â†’};
   148â†’
   149â†’// Quick prompts for each skill with icons and categories
   150â†’interface QuickPromptItem {
   151â†’  icon: string;
   152â†’  category: string;
   153â†’  question: string;
   154â†’  gradient: string;
   155â†’}
   156â†’
   157â†’const SKILL_QUICK_PROMPTS: Record<SkillType, QuickPromptItem[]> = {
   158â†’  bazi: [
   159â†’    { icon: "ğŸ‚", category: "ç”Ÿè¾°ä¿¡æ¯", question: "æˆ‘æ˜¯1990å¹´5æœˆ15æ—¥æ—©ä¸Š8ç‚¹å‡ºç”Ÿçš„", gradient: "from-blue-500/10 to-cyan-500/10" },
   160â†’    { icon: "ğŸ“ˆ", category: "è¿åŠ¿åˆ†æ", question: "å¸®æˆ‘åˆ†æä»Šå¹´çš„è¿åŠ¿", gradient: "from-purple-500/10 to-pink-500/10" },
   161â†’    { icon: "ğŸ’¼", category: "äº‹ä¸šå‘å±•", question: "æˆ‘çš„äº‹ä¸šè¿å¦‚ä½•ï¼Ÿ", gradient: "from-orange-500/10 to-red-500/10" },
   162â†’    { icon: "â°", category: "æ—¶æœºé€‰æ‹©", question: "ä»€ä¹ˆæ—¶å€™é€‚åˆåšé‡å¤§å†³å®šï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   163â†’  ],
   164â†’  zodiac: [
   165â†’    { icon: "â­", category: "è¿åŠ¿æŸ¥è¯¢", question: "æˆ‘æ˜¯åŒå­åº§ï¼Œå¸®æˆ‘çœ‹çœ‹æœ¬å‘¨è¿åŠ¿", gradient: "from-purple-500/10 to-pink-500/10" },
   166â†’    { icon: "ğŸŒ™", category: "æ˜Ÿç›˜è§£è¯»", question: "æˆ‘çš„å¤ªé˜³æ˜Ÿåº§å’Œä¸Šå‡æ˜Ÿåº§æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ", gradient: "from-indigo-500/10 to-purple-500/10" },
   167â†’    { icon: "ğŸ’•", category: "å…³ç³»åŒ¹é…", question: "åŒå­åº§å’Œä»€ä¹ˆæ˜Ÿåº§æœ€é…ï¼Ÿ", gradient: "from-rose-500/10 to-pink-500/10" },
   168â†’    { icon: "ğŸŒ€", category: "æ˜Ÿè±¡å½±å“", question: "æ°´é€†å¯¹æˆ‘æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ", gradient: "from-blue-500/10 to-cyan-500/10" },
   169â†’  ],
   170â†’  mbti: [
   171â†’    { icon: "ğŸ”", category: "ç±»å‹æµ‹è¯•", question: "å¸®æˆ‘æµ‹æµ‹æˆ‘çš„MBTIç±»å‹", gradient: "from-blue-500/10 to-cyan-500/10" },
   172â†’    { icon: "ğŸ’¼", category: "èŒä¸šå»ºè®®", question: "INFPé€‚åˆä»€ä¹ˆèŒä¸šï¼Ÿ", gradient: "from-orange-500/10 to-amber-500/10" },
   173â†’    { icon: "ğŸ‘¥", category: "äººé™…å…³ç³»", question: "æˆ‘æ˜¯INTJï¼Œå¦‚ä½•æ”¹å–„äººé™…å…³ç³»ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   174â†’    { icon: "âš¡", category: "ç±»å‹å¯¹æ¯”", question: "Eäººå’ŒIäººæœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Ÿ", gradient: "from-purple-500/10 to-pink-500/10" },
   175â†’  ],
   176â†’  attach: [
   177â†’    { icon: "ğŸ”", category: "ç±»å‹åˆ†æ", question: "å¸®æˆ‘åˆ†ææˆ‘çš„ä¾æ‹ç±»å‹", gradient: "from-blue-500/10 to-cyan-500/10" },
   178â†’    { icon: "ğŸ’‘", category: "å…³ç³»å»ºè®¾", question: "å›é¿å‹ä¾æ‹å¦‚ä½•å»ºç«‹äº²å¯†å…³ç³»ï¼Ÿ", gradient: "from-rose-500/10 to-pink-500/10" },
   179â†’    { icon: "ğŸ›¡ï¸", category: "å†…å¿ƒæ¢ç´¢", question: "ä¸ºä»€ä¹ˆæˆ‘æ€»æ˜¯å®³æ€•è¢«æŠ›å¼ƒï¼Ÿ", gradient: "from-amber-500/10 to-orange-500/10" },
   180â†’    { icon: "ğŸ’š", category: "è‡ªæˆ‘ç–—æ„ˆ", question: "å¦‚ä½•æ²»æ„ˆç«¥å¹´çš„æƒ…æ„Ÿåˆ›ä¼¤ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   181â†’  ],
   182â†’  career: [
   183â†’    { icon: "ğŸ¯", category: "èŒä¸šè§„åˆ’", question: "æˆ‘è¯¥å¦‚ä½•è§„åˆ’èŒä¸šå‘å±•ï¼Ÿ", gradient: "from-blue-500/10 to-cyan-500/10" },
   184â†’    { icon: "ğŸš€", category: "æ–¹å‘é€‰æ‹©", question: "æˆ‘é€‚åˆåˆ›ä¸šè¿˜æ˜¯æ‰“å·¥ï¼Ÿ", gradient: "from-orange-500/10 to-red-500/10" },
   185â†’    { icon: "ğŸ’ª", category: "é¢è¯•æŠ€å·§", question: "å¦‚ä½•åœ¨é¢è¯•ä¸­å±•ç°è‡ªå·±ï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   186â†’    { icon: "ğŸ”„", category: "èŒä¸šè½¬å‹", question: "è½¬è¡Œéœ€è¦è€ƒè™‘ä»€ä¹ˆï¼Ÿ", gradient: "from-purple-500/10 to-pink-500/10" },
   187â†’  ],
   188â†’  lifecoach: [
   189â†’    { icon: "ğŸ¯", category: "ç›®æ ‡è®¾å®š", question: "æˆ‘æƒ³æ‰¾åˆ°äººç”Ÿæ–¹å‘ï¼Œä½†ä¸çŸ¥é“ä»å“ªå¼€å§‹", gradient: "from-red-500/10 to-pink-500/10" },
   190â†’    { icon: "ğŸ”„", category: "çªç ´ç“¶é¢ˆ", question: "æˆ‘æ„Ÿè§‰å¡ä½äº†ï¼Œæƒ³è¦çªç ´ç°çŠ¶", gradient: "from-purple-500/10 to-indigo-500/10" },
   191â†’    { icon: "âš¡", category: "ä¹ æƒ¯å…»æˆ", question: "å¦‚ä½•å»ºç«‹é«˜æ•ˆçš„æ—¥å¸¸ä¹ æƒ¯ï¼Ÿ", gradient: "from-orange-500/10 to-amber-500/10" },
   192â†’    { icon: "ğŸ’¡", category: "ä»·å€¼åˆ›é€ ", question: "å¦‚ä½•æŠŠå…´è¶£å˜æˆäº‹ä¸šï¼Ÿ", gradient: "from-green-500/10 to-teal-500/10" },
   193â†’  ],
   194â†’};
   195â†’
   196â†’// API calls now go through Next.js API routes
   197â†’
   198â†’// æœ¬åœ° fallback æ•°æ®ç”Ÿæˆ
   199â†’function getLocalGreetingData(skill: SkillType) {
   200â†’  const now = new Date();
   201â†’  const hour = now.getHours();
   202â†’  const month = now.getMonth();
   203â†’  const day = now.getDate();
   204â†’  const isoDate = now.toISOString().slice(0, 10);
   205â†’
   206â†’  // ç¡®å®šæ—¶æ®µ
   207â†’  type TimeOfDay = "dawn" | "morning" | "afternoon" | "evening" | "night";
   208â†’  let timeOfDay: TimeOfDay = "morning";
   209â†’  let greeting = "æ–°çš„ä¸€å¤©å¼€å§‹äº†";
   210â†’
   211â†’  if (hour >= 5 && hour < 7) {
   212â†’    timeOfDay = "dawn";
   213â†’    greeting = "æ™¨å…‰ç†¹å¾®";
   214â†’  } else if (hour >= 7 && hour < 12) {
   215â†’    timeOfDay = "morning";
   216â†’    greeting = "æ„¿ä½ èƒ½é‡æ»¡æ»¡";
   217â†’  } else if (hour >= 12 && hour < 18) {
   218â†’    timeOfDay = "afternoon";
   219â†’    greeting = "ä¿æŒä¸“æ³¨";
   220â†’  } else if (hour >= 18 && hour < 21) {
   221â†’    timeOfDay = "evening";
   222â†’    greeting = "è¾›è‹¦ä¸€å¤©äº†";
   223â†’  } else {
   224â†’    timeOfDay = "night";
   225â†’    greeting = "å¤œæ·±äº†ï¼Œæ—©ç‚¹ä¼‘æ¯";
   226â†’  }
   227â†’
   228â†’  const solarTerms = [
   229â†’    "å°å¯’", "å¤§å¯’", "ç«‹æ˜¥", "é›¨æ°´", "æƒŠè›°", "æ˜¥åˆ†",
   230â†’    "æ¸…æ˜", "è°·é›¨", "ç«‹å¤", "å°æ»¡", "èŠ’ç§", "å¤è‡³",
   231â†’    "å°æš‘", "å¤§æš‘", "ç«‹ç§‹", "å¤„æš‘", "ç™½éœ²", "ç§‹åˆ†",
   232â†’    "å¯’éœ²", "éœœé™", "ç«‹å†¬", "å°é›ª", "å¤§é›ª", "å†¬è‡³",
   233â†’  ];
   234â†’  const termIdx = month * 2 + (day >= 15 ? 1 : 0);
   235â†’  const solarTerm = solarTerms[termIdx % 24];
   236â†’
   237â†’  const seasonTips: Record<string, string> = {
   238â†’    å°å¯’: "å†¬è—æ—¶èŠ‚ï¼Œåˆ©äºå›é¡¾ä¸è§„åˆ’", å¤§å¯’: "ä¸¥å¯’ä¹‹é™…ï¼Œè“„åŠ›å¾…å‘",
   239â†’    ç«‹æ˜¥: "ä¸‡ç‰©å¤è‹ï¼Œé€‚åˆå¯åŠ¨æ–°è®¡åˆ’", é›¨æ°´: "æ¶¦ç‰©æ— å£°ï¼Œé™å¿ƒæ»‹å…»",
   240â†’    æƒŠè›°: "æ˜¥é›·æƒŠé†’ï¼Œè¡ŒåŠ¨èµ·æ¥", æ˜¥åˆ†: "æ˜¼å¤œå¹³åˆ†ï¼Œè°ƒå’Œèº«å¿ƒ",
   241â†’    æ¸…æ˜: "å¤©æ¸…åœ°æ˜ï¼Œæ•´ç†æ€ç»ª", è°·é›¨: "é›¨ç”Ÿç™¾è°·ï¼Œæ’­ç§å¸Œæœ›",
   242â†’    ç«‹å¤: "å¤æ°”æ¸ç››ï¼Œä¿æŒæ´»åŠ›", å°æ»¡: "å°æœ‰æ‰€æˆï¼Œç»§ç»­åŠªåŠ›",
   243â†’    èŠ’ç§: "æ’­ç§æ”¶è·ï¼Œå‹¤å‹‰ä¸æ‡ˆ", å¤è‡³: "é˜³æ°”é¼ç››ï¼Œé€‚åº¦ä¼‘æ¯",
   244â†’    å°æš‘: "æš‘æ°”åˆå‡ï¼Œæ¸…å¿ƒå®ç¥", å¤§æš‘: "é…·æš‘éš¾è€ï¼Œé™ä»¥å…»å¿ƒ",
   245â†’    ç«‹ç§‹: "ç§‹æ„æ¸èµ·ï¼Œæ”¶è·æ—¶èŠ‚", å¤„æš‘: "æš‘æ°”æ¸æ¶ˆï¼Œè°ƒæ•´èŠ‚å¥",
   246â†’    ç™½éœ²: "ç§‹å‡‰æ¸æµ“ï¼Œæ”¶æ•›å¿ƒç¥", ç§‹åˆ†: "ç§‹é«˜æ°”çˆ½ï¼Œå¹³è¡¡å·¥ä½œä¸ç”Ÿæ´»",
   247â†’    å¯’éœ²: "éœ²æ°´æ¸å¯’ï¼Œæ³¨æ„ä¿å…»", éœœé™: "éœœé™æ°´æ³½ï¼Œæ²‰æ·€ç§¯ç´¯",
   248â†’    ç«‹å†¬: "å†¬å­£æ¥ä¸´ï¼Œå‚¨å¤‡èƒ½é‡", å°é›ª: "é›ªèŠ±åˆé™ï¼Œå†…çœæ—¶åˆ»",
   249â†’    å¤§é›ª: "ç‘é›ªå…†ä¸°ï¼Œé™å¾…æ¥å¹´", å†¬è‡³: "ä¸€é˜³åˆç”Ÿï¼Œå¦ææ³°æ¥",
   250â†’  };
   251â†’
   252â†’  const baziHints: Record<string, string> = {
   253â†’    å°å¯’: "æ°´æ—ºä¹‹å­£ï¼Œåˆ©äºæ€è€ƒä¸è§„åˆ’", å¤§å¯’: "æ°´æ°”æœ€ç››ï¼Œé€‚åˆå†…çœæ²‰æ·€",
   254â†’    ç«‹æ˜¥: "æœ¨æ°”åˆç”Ÿï¼Œå®œå¼€å¯æ–°äº‹ä¸š", æ˜¥åˆ†: "æœ¨æ°”æ—ºç››ï¼Œé€‚åˆæ‹“å±•äººè„‰",
   255â†’    ç«‹å¤: "ç«æ°”æ¸å‡ï¼Œåˆ©äºè¡¨è¾¾å±•ç°", å¤è‡³: "ç«æ°”æ­£ç››ï¼Œæ³¨æ„å¹³è¡¡",
   256â†’    ç«‹ç§‹: "é‡‘æ°”åˆç”Ÿï¼Œé€‚åˆå†³æ–­å–èˆ", ç§‹åˆ†: "é‡‘æ°”æ—ºç››ï¼Œåˆ©äºæ”¶è·æˆæœ",
   257â†’    ç«‹å†¬: "æ°´æ°”åˆç”Ÿï¼Œå®œä¼‘å…»ç”Ÿæ¯", å†¬è‡³: "ä¸€é˜³å¤å§‹ï¼Œåšç§¯è–„å‘",
   258â†’  };
   259â†’
   260â†’  const dateStr = `${month + 1}æœˆ${day}æ—¥`;
   261â†’  const seedStr = `${isoDate}:${skill}:${solarTerm}:${timeOfDay}`;
   262â†’  let hash = 0;
   263â†’  for (let i = 0; i < seedStr.length; i += 1) {
   264â†’    hash = (hash * 31 + seedStr.charCodeAt(i)) % 100000;
   265â†’  }
   266â†’  const fortuneScore = Math.max(32, Math.min(92, 42 + (hash % 51)));
   267â†’  const fortuneHint = skill === "bazi"
   268â†’    ? (baziHints[solarTerm] || "ä»Šå¤©é€‚åˆç¨³ä½èŠ‚å¥ï¼ŒæŠŠåŠ›æ°”ç”¨åœ¨å…³é”®å¤„ã€‚")
   269â†’    : (seasonTips[solarTerm] || "ä»Šå¤©é€‚åˆæŠŠæ³¨æ„åŠ›æ”¶å›åˆ°è‡ªå·±èº«ä¸Šã€‚");
   270â†’
   271â†’  const actionText =
   272â†’    timeOfDay === "dawn" || timeOfDay === "morning"
   273â†’      ? "å†™ä¸‹ä»Šå¤©æœ€é‡è¦çš„ä¸€ä»¶äº‹ï¼Œå¹¶ç”¨ 25 åˆ†é’Ÿå¯åŠ¨å®ƒ"
   274â†’      : timeOfDay === "afternoon"
   275â†’        ? "æŠŠä¸€ä»¶æ‚¬è€Œæœªå†³çš„å°äº‹æ”¶å°¾ï¼Œç»™è‡ªå·±ä¸€ä¸ªç¡®å®šæ„Ÿ"
   276â†’        : timeOfDay === "evening"
   277â†’          ? "ç”¨ 10 åˆ†é’Ÿå¤ç›˜ä»Šå¤©ï¼šåšå¯¹äº†ä»€ä¹ˆã€ä¸‹ä¸€æ­¥æ˜¯ä»€ä¹ˆ"
   278â†’          : "å…³æœºå‰å†™ä¸€å¥æ„Ÿè°¢ï¼Œç»™å¤§è„‘ä¸€ä¸ªæŸ”è½¯çš„ç»“å°¾";
   279â†’
   280â†’  return {
   281â†’    greeting, solarTerm, timeOfDay, date: dateStr, isoDate,
   282â†’    todayTip: seasonTips[solarTerm] || "ä¸“æ³¨å½“ä¸‹ï¼Œç¨³æ­¥å‰è¡Œ",
   283â†’    baziHint: skill === "bazi" ? (baziHints[solarTerm] || null) : null,
   284â†’    fortuneScore, fortuneHint, actionText, isFromApi: false,
   285â†’  };
   286â†’}
   287â†’
   288â†’// ç”Ÿæˆå½“æ—¥é—®å€™æ•°æ® - ä½¿ç”¨æœ¬åœ°ç®—æ³•ç”Ÿæˆ
   289â†’// NOTE: åŸ API è°ƒç”¨å·²ç§»é™¤ï¼Œå› åç«¯ /api/v1/fortune/greeting æœªå®ç°
   290â†’// æœ¬åœ°ç®—æ³•å·²æä¾›å®Œæ•´åŠŸèƒ½ï¼šèŠ‚æ°”ã€æ—¶è¾°ã€è¿åŠ¿è¯„åˆ†ç­‰
   291â†’function useDailyGreeting(skill: SkillType) {
   292â†’  // åˆå§‹çŠ¶æ€ä½¿ç”¨é»˜è®¤å€¼ï¼Œé¿å… hydration mismatch
   293â†’  const [data, setData] = useState(() => ({
   294â†’    greeting: "æ–°çš„ä¸€å¤©å¼€å§‹äº†",
   295â†’    timeOfDay: "morning" as "dawn" | "morning" | "afternoon" | "evening" | "night",
   296â†’    solarTerm: "ç«‹æ˜¥",
   297â†’    isoDate: new Date().toISOString().slice(0, 10),
   298â†’    todayTip: "ä¸“æ³¨å½“ä¸‹ï¼Œç¨³æ­¥å‰è¡Œ",
   299â†’    baziHint: null as string | null,
   300â†’    fortuneScore: 75,
   301â†’    fortuneHint: "è¿åŠ¿å¹³ç¨³",
   302â†’    actionText: "ä»Šæ—¥å®œ",
   303â†’    isFromApi: false,
   304â†’  }));
   305â†’  const [loading] = useState(false);
   306â†’
   307â†’  // åœ¨å®¢æˆ·ç«¯è®¡ç®—å®é™…çš„é—®å€™æ•°æ®
   308â†’  useEffect(() => {
   309â†’    setData(getLocalGreetingData(skill));
   310â†’  }, [skill]);
   311â†’
   312â†’  return { ...data, loading };
   313â†’}
   314â†’
   315â†’// Memoized ChatEmptyState (Vercel rule: rerender-extract-component)
   316â†’const ChatEmptyState = memo(function ChatEmptyState({ skill, onQuickPrompt }: { skill: SkillType; onQuickPrompt?: (prompt: string) => void }) {
   317â†’  const config = SKILL_EMPTY_STATE[skill] || SKILL_EMPTY_STATE.bazi;
   318â†’  const quickPrompts = SKILL_QUICK_PROMPTS[skill] || SKILL_QUICK_PROMPTS.bazi;
   319â†’  const dailyData = useDailyGreeting(skill);
   320â†’  const actionKey = useMemo(
   321â†’    () => `vibelife-daily-action:${skill}:${dailyData.isoDate}`,
   322â†’    [skill, dailyData.isoDate]
   323â†’  );
   324â†’  const [actionCompleted, setActionCompleted] = useState(false);
   325â†’
   326â†’  useEffect(() => {
   327â†’    if (typeof window === "undefined") return;
   328â†’    // Use cached localStorage (Vercel rule: js-cache-storage)
   329â†’    setActionCompleted(getLocalStorage(actionKey) === "1");
   330â†’  }, [actionKey]);
   331â†’
   332â†’  const toggleAction = useCallback(() => {
   333â†’    setActionCompleted((prev) => {
   334â†’      const next = !prev;
   335â†’      // Use cached localStorage (Vercel rule: js-cache-storage)
   336â†’      setLocalStorage(actionKey, next ? "1" : "0");
   337â†’      return next;
   338â†’    });
   339â†’  }, [actionKey]);
   340â†’
   341â†’  const shareText = useMemo(() => {
   342â†’    const term = dailyData.solarTerm ? ` Â· ${dailyData.solarTerm}` : "";
   343â†’    return [
   344â†’      `VibeLife${term} Â· ${dailyData.isoDate}`,
   345â†’      dailyData.greeting,
   346â†’      `è¿åŠ¿æŒ‡æ•°ï¼š${dailyData.fortuneScore}/100`,
   347â†’      `ä»Šæ—¥ä¸€æ­¥ï¼š${dailyData.actionText}`,
   348â†’      "#VibeLife",
   349â†’    ].join("\n");
   350â†’  }, [dailyData]);
   351â†’
   352â†’  return (
   353â†’    <div className="flex flex-col items-center justify-center w-full md:max-w-xl mx-auto px-4 py-6">
   354â†’      {/* Daily Greeting æ¯æ—¥é—®å€™ */}
   355â†’      <DailyGreeting
   356â†’        greeting={dailyData.greeting}
   357â†’        solarTerm={dailyData.solarTerm}
   358â†’        timeOfDay={dailyData.timeOfDay}
   359â†’        date={dailyData.isoDate}
   360â†’        todayTip={dailyData.todayTip}
   361â†’        baziHint={dailyData.baziHint || undefined}
   362â†’        fortuneScore={dailyData.fortuneScore}
   363â†’        fortuneHint={dailyData.fortuneHint}
   364â†’        actionItem={{ text: dailyData.actionText, completed: actionCompleted }}
   365â†’        onActionToggle={toggleAction}
   366â†’        shareText={shareText}
   367â†’        className="mb-6 w-full"
   368â†’      />
   369â†’
   370â†’      {/* Animated glyph with enhanced aura */}
   371â†’      <div className="relative flex items-center justify-center mb-4">
   372â†’        {/* Outer pulsing ring */}
   373â†’        <div className="absolute w-16 h-16 rounded-full border border-skill-primary/20 animate-pulse-slow" />
   374â†’        <div className="absolute w-24 h-24 rounded-full border border-skill-primary/10 animate-pulse-slower" />
   375â†’
   376â†’        {/* Breath aura */}
   377â†’        <BreathAura
   378â†’          skill={skill}
   379â†’          size="sm"
   380â†’          position="center"
   381â†’          intensity="medium"
   382â†’          className="opacity-40"
   383â†’        />
   384â†’
   385â†’        {/* Central glyph */}
   386â†’        <VibeGlyph
   387â†’          size="sm"
   388â†’          skill={skill}
   389â†’          showAura={true}
   390â†’          animate={true}
   391â†’          className="relative z-10"
   392â†’        />
   393â†’      </div>
   394â†’
   395â†’      {/* Title */}
   396â†’      <h3 className="text-base md:text-lg font-serif font-semibold text-foreground mb-1 text-center">
   397â†’        {config.title}
   398â†’      </h3>
   399â†’
   400â†’      {/* Subtitle */}
   401â†’      <p className="text-sm text-muted-foreground max-w-sm text-center mb-4">
   402â†’        {config.subtitle}
   403â†’      </p>
   404â†’
   405â†’      {/* Quick prompt suggestions */}
   406â†’      <div className="w-full space-y-3">
   407â†’        <p className="text-xs text-muted-foreground/60 text-center">
   408â†’          è¯•è¯•è¿™æ ·é—®
   409â†’        </p>
   410â†’        <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
   411â†’          {quickPrompts.slice(0, 4).map((prompt, index) => (
   412â†’            <button
   413â†’              key={index}
   414â†’              onClick={() => onQuickPrompt?.(prompt.question)}
   415â†’              className={`
   416â†’                group relative px-3 py-3 text-left
   417â†’                bg-gradient-to-br ${prompt.gradient}
   418â†’                border border-border/50 hover:border-skill-primary/30
   419â†’                rounded-xl transition-all duration-200
   420â†’                hover:shadow-md hover:-translate-y-0.5
   421â†’              `}
   422â†’            >
   423â†’              <div className="flex items-start gap-2.5">
   424â†’                <span className="text-lg flex-shrink-0">{prompt.icon}</span>
   425â†’                <div className="flex-1 min-w-0">
   426â†’                  <span className="text-[10px] font-medium text-muted-foreground/70 uppercase tracking-wide">
   427â†’                    {prompt.category}
   428â†’                  </span>
   429â†’                  <p className="text-sm text-foreground line-clamp-2 mt-0.5">
   430â†’                    {prompt.question}
   431â†’                  </p>
   432â†’                </div>
   433â†’              </div>
   434â†’            </button>
   435â†’          ))}
   436â†’        </div>
   437â†’      </div>
   438â†’    </div>
   439â†’  );
   440â†’});
   441â†’
   442â†’export function ChatContainer({
   443â†’  skillId,
   444â†’  scenario,
   445â†’  skill = "bazi",
   446â†’  conversationId: externalConversationId,
   447â†’  voiceMode = "warm",
   448â†’  onConversationStart,
   449â†’  initialPrompt,
   450â†’  onInitialPromptSent,
   451â†’  dashboardData,
   452â†’  isDashboardLoading,
   453â†’  onCheckIn,
   454â†’  onToggleLever,
   455â†’  onToggleRock,
   456â†’}: ChatContainerProps) {
   457â†’  const messagesEndRef = useRef<HTMLDivElement>(null);
   458â†’  const initialPromptSentRef = useRef(false);
   459â†’
   460â†’  // ç”Ÿæˆç¨³å®šçš„ conversationIdï¼ˆå¦‚æœå¤–éƒ¨æ²¡ä¼ å…¥ï¼‰
   461â†’  // ä½¿ç”¨ useRef ç¡®ä¿åœ¨ç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜
   462â†’  const generatedIdRef = useRef<string | null>(null);
   463â†’  if (!generatedIdRef.current) {
   464â†’    generatedIdRef.current = generateUUID();
   465â†’  }
   466â†’  const conversationId = externalConversationId || generatedIdRef.current;
   467â†’
   468â†’  // UI å±•ç¤ºç”¨çš„ skillï¼ˆä¸»é¢˜ã€ç©ºçŠ¶æ€ç­‰ï¼‰
   469â†’  const displaySkill: SkillType = skill || (skillId as SkillType) || "bazi";
   470â†’
   471â†’  // Skill Intro Card - é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤º
   472â†’  const [showIntroCard, setShowIntroCard] = useState(false);
   473â†’  const { data: introData } = useSkillIntro(displaySkill);
   474â†’  const { mark: doMarkFirstUse } = useMarkFirstUse(displaySkill);
   475â†’
   476â†’  // Use AI SDK powered chat hook
   477â†’  // skillId å¯é€‰ï¼šä¸ä¼ æ—¶åç«¯ LLM è‡ªåŠ¨è·¯ç”±
   478â†’  const {
   479â†’    messages,
   480â†’    isLoading,
   481â†’    sendMessage,
   482â†’    sendQuickPrompt,
   483â†’    error,
   484â†’  } = useVibeChat({
   485â†’    skillId: skillId as SkillId | undefined,
   486â†’    scenario,
   487â†’    voiceMode,
   488â†’    conversationId,
   489â†’    onConversationStart,
   490â†’    onError: (err) => {
   491â†’      console.error("Chat error:", err);
   492â†’      // Show user-friendly toast notification with retry option
   493â†’      const errorMessage = err instanceof Error ? err.message : "æœªçŸ¥é”™è¯¯";
   494â†’      const isNetworkError = errorMessage.includes("network") || errorMessage.includes("fetch");
   495â†’      const isTimeoutError = errorMessage.includes("timeout") || errorMessage.includes("è¶…æ—¶");
   496â†’
   497â†’      toast.error(
   498â†’        isNetworkError ? "ç½‘ç»œè¿æ¥å¤±è´¥" : isTimeoutError ? "è¯·æ±‚è¶…æ—¶" : "å‘é€å¤±è´¥",
   499â†’        {
   500â†’          description: isNetworkError
   501â†’            ? "è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè¿æ¥åé‡è¯•"
   502â†’            : isTimeoutError
   503â†’              ? "æœåŠ¡å™¨å“åº”æ—¶é—´è¿‡é•¿ï¼Œè¯·ç¨åé‡è¯•"
   504â†’              : "è¯·ç¨åé‡è¯•ï¼Œæˆ–åˆ·æ–°é¡µé¢",
   505â†’          duration: 5000,
   506â†’        }
   507â†’      );
   508â†’    },
   509â†’  });
   510â†’
   511â†’  // æ£€æµ‹æ˜¯å¦é¦–æ¬¡ä½¿ç”¨ï¼Œæ˜¾ç¤ºä»‹ç»å¡
   512â†’  useEffect(() => {
   513â†’    if (introData?.is_first_use) {
   514â†’      setShowIntroCard(true);
   515â†’    }
   516â†’  }, [introData?.is_first_use]);
   517â†’
   518â†’  // å¤„ç†ä»‹ç»å¡ç‰‡åŠ¨ä½œ
   519â†’  const handleIntroAction = useCallback((action: IntroCardAction) => {
   520â†’    if (action.type === 'dismiss') {
   521â†’      setShowIntroCard(false);
   522â†’      doMarkFirstUse();
   523â†’    } else if (action.type === 'send_prompt') {
   524â†’      setShowIntroCard(false);
   525â†’      doMarkFirstUse();
   526â†’      sendQuickPrompt(action.prompt);
   527â†’    }
   528â†’  }, [doMarkFirstUse, sendQuickPrompt]);
   529â†’
   530â†’  // Vercel rule: rerender-defer-reads - åªåœ¨ messages é•¿åº¦å˜åŒ–æ—¶æ»šåŠ¨
   531â†’  const messagesLength = messages.length;
   532â†’  const scrollToBottom = useCallback(() => {
   533â†’    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
   534â†’  }, []);
   535â†’
   536â†’  useEffect(() => {
   537â†’    scrollToBottom();
   538â†’  }, [messagesLength, scrollToBottom]);
   539â†’
   540â†’  // å¤„ç†ä» URL ä¼ å…¥çš„åˆå§‹æ¶ˆæ¯ï¼ˆå¦‚ä»é€šçŸ¥è·³è½¬ï¼‰
   541â†’  // Vercel rule: rerender-dependencies - ä½¿ç”¨ ref é¿å… sendMessage ä¾èµ–
   542â†’  const sendMessageRef = useRef(sendMessage);
   543â†’  sendMessageRef.current = sendMessage;
   544â†’
   545â†’  useEffect(() => {
   546â†’    if (initialPrompt && !initialPromptSentRef.current && !isLoading) {
   547â†’      initialPromptSentRef.current = true;
   548â†’      sendMessageRef.current(initialPrompt).then(() => {
   549â†’        onInitialPromptSent?.();
   550â†’      });
   551â†’    }
   552â†’  }, [initialPrompt, isLoading, onInitialPromptSent]);
   553â†’
   554â†’  // é‡ç½®æ ‡è®°å½“ initialPrompt å˜åŒ–æ—¶
   555â†’  useEffect(() => {
   556â†’    if (!initialPrompt) {
   557â†’      initialPromptSentRef.current = false;
   558â†’    }
   559â†’  }, [initialPrompt]);
   560â†’
   561â†’  // Handle send from ChatInput
   562â†’  const handleSend = useCallback(
   563â†’    async (content: string) => {
   564â†’      await sendMessage(content);
   565â†’    },
   566â†’    [sendMessage]
   567â†’  );
   568â†’
   569â†’  // Handle quick prompt from empty state
   570â†’  const handleQuickPrompt = useCallback(
   571â†’    async (content: string) => {
   572â†’      await sendQuickPrompt(content);
   573â†’    },
   574â†’    [sendQuickPrompt]
   575â†’  );
   576â†’
   577â†’  const hasMessages = messages.length > 0;
   578â†’
   579â†’  // DailyGreeting æ•°æ®
   580â†’  const dailyData = useDailyGreeting(displaySkill);
   581â†’  const actionKey = useMemo(
   582â†’    () => `vibelife-daily-action:${displaySkill}:${dailyData.isoDate}`,
   583â†’    [displaySkill, dailyData.isoDate]
   584â†’  );
   585â†’  const [actionCompleted, setActionCompleted] = useState(false);
   586â†’
   587â†’  useEffect(() => {
   588â†’    if (typeof window === "undefined") return;
   589â†’    setActionCompleted(getLocalStorage(actionKey) === "1");
   590â†’  }, [actionKey]);
   591â†’
   592â†’  const toggleAction = useCallback(() => {
   593â†’    setActionCompleted((prev) => {
   594â†’      const next = !prev;
   595â†’      setLocalStorage(actionKey, next ? "1" : "0");
   596â†’      return next;
   597â†’    });
   598â†’  }, [actionKey]);
   599â†’
   600â†’  const shareText = useMemo(() => {
   601â†’    const term = dailyData.solarTerm ? ` Â· ${dailyData.solarTerm}` : "";
   602â†’    return [
   603â†’      `VibeLife${term} Â· ${dailyData.isoDate}`,
   604â†’      dailyData.greeting,
   605â†’      `è¿åŠ¿æŒ‡æ•°ï¼š${dailyData.fortuneScore}/100`,
   606â†’      `ä»Šæ—¥ä¸€æ­¥ï¼š${dailyData.actionText}`,
   607â†’      "#VibeLife",
   608â†’    ].join("\n");
   609â†’  }, [dailyData]);
   610â†’
   611â†’  // é»˜è®¤å›è°ƒï¼ˆå¦‚æœæ²¡æœ‰ä¼ å…¥ï¼‰
   612â†’  const handleCheckIn = useCallback(async () => {
   613â†’    if (onCheckIn) {
   614â†’      await onCheckIn();
   615â†’    } else {
   616â†’      toast.success("ç­¾åˆ°æˆåŠŸï¼");
   617â†’    }
   618â†’  }, [onCheckIn]);
   619â†’
   620â†’  const handleToggleLever = useCallback(async (leverId: string) => {
   621â†’    if (onToggleLever) {
   622â†’      await onToggleLever(leverId);
   623â†’    }
   624â†’  }, [onToggleLever]);
   625â†’
   626â†’  const handleToggleRock = useCallback(async (rockId: string) => {
   627â†’    if (onToggleRock) {
   628â†’      await onToggleRock(rockId);
   629â†’    }
   630â†’  }, [onToggleRock]);
   631â†’
   632â†’  // è½¬æ¢ Dashboard æ•°æ®ä¸ºæ¬¢è¿æ¶ˆæ¯æ ¼å¼
   633â†’  const welcomeData = useDashboardWelcomeData(dashboardData);
   634â†’
   635â†’  return (
   636â†’    <div className="flex flex-col h-full" data-skill={displaySkill}>
   637â†’      {/* Messages area - always flex-1 to push input to bottom */}
   638â†’      <main
   639â†’        id="main-content"
   640â†’        className="flex-1 overflow-y-auto relative min-h-0"
   641â†’        role="log"
   642â†’        aria-label="å¯¹è¯æ¶ˆæ¯"
   643â†’        aria-live="polite"
   644â†’      >
   645â†’        {!hasMessages ? (
   646â†’          /* Empty state with Welcome Message or Skill Intro */
   647â†’          <div className="flex flex-col items-center justify-end h-full pb-4">
   648â†’            {/* é¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤º Skill ä»‹ç»å¡ */}
   649â†’            {showIntroCard && (
   650â†’              <div className="w-full max-w-3xl px-4 mb-4">
   651â†’                <SkillIntroCard
   652â†’                  skillId={displaySkill}
   653â†’                  variant="compact"
   654â†’                  dismissible
   655â†’                  onAction={handleIntroAction}
   656â†’                />
   657â†’              </div>
   658â†’            )}
   659â†’
   660â†’            {isDashboardLoading ? (
   661â†’              <div className="flex items-center justify-center">
   662â†’                <div className="text-sm text-muted-foreground">åŠ è½½ä¸­...</div>
   663â†’              </div>
   664â†’            ) : welcomeData ? (
   665â†’              <ChatWelcomeMessage
   666â†’                data={welcomeData}
   667â†’                onCheckIn={handleCheckIn}
   668â†’                onSendPrompt={handleQuickPrompt}
   669â†’                className="w-full max-w-3xl"
   670â†’              />
   671â†’            ) : (
   672â†’              <div className="flex items-center justify-center">
   673â†’                <div className="text-sm text-muted-foreground">æ¬¢è¿å›æ¥</div>
   674â†’              </div>
   675â†’            )}
   676â†’          </div>
   677â†’        ) : (
   678â†’          /* Messages list - æ‰€æœ‰è®¾å¤‡å±…ä¸­ï¼ŒPCç«¯å“åº”å¼å¢å®½ */
   679â†’          <div className="px-4 pt-4 pb-2 max-w-3xl xl:max-w-4xl 2xl:max-w-5xl mx-auto">
   680â†’            {messages.map((message) => (
   681â†’              // Use chat-message-item class for content-visibility optimization (Vercel rule: rendering-content-visibility)
   682â†’              <div key={message.id} className="chat-message-item">
   683â†’                <ChatMessage
   684â†’                  role={message.role as "user" | "assistant"}
   685â†’                  content={getMessageContent(message)}
   686â†’                  skill={displaySkill}
   687â†’                  isStreaming={isLoading && message.role === "assistant" && message === messages[messages.length - 1]}
   688â†’                  onSendMessage={sendMessage}
   689â†’                />
   690â†’              </div>
   691â†’            ))}
   692â†’            {/* Show loading indicator when waiting for first response chunk */}
   693â†’            {isLoading && messages.length > 0 && messages[messages.length - 1].role === "user" && (
   694â†’              <ChatMessage
   695â†’                role="assistant"
   696â†’                content=""
   697â†’                skill={displaySkill}
   698â†’                isStreaming
   699â†’              />
   700â†’            )}
   701â†’            {/* Error is now handled via toast notification in onError callback */}
   702â†’            <div ref={messagesEndRef} />
   703â†’          </div>
   704â†’        )}
   705â†’      </main>
   706â†’
   707â†’      {/* Input - fixed at bottom */}
   708â†’      <div className="flex-shrink-0">
   709â†’        <ChatInput onSend={handleSend} disabled={isLoading} />
   710â†’      </div>
   711â†’    </div>
   712â†’  );
   713â†’}
   714â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
