     1→# Soul OS 心理架构设计（合并优化版）
     2→
     3→**文档类型**：Operating System Psychological Architecture
     4→**版本**：Merged MVP v1.1
     5→**日期**：2025-12-31
     6→**定位**：基于深度心理学的精神数字孪生操作系统
     7→**理论框架**：荣格分析心理学 × 积极心理学 × 行为科学 × 自我决定理论
     8→**工程边界**：以 `system_design_final_mvp.md` 为准，不新增核心表
     9→
    10→---
    11→
    12→## 0. 设计哲学
    13→
    14→### 0.1 核心假设
    15→
    16→人类心理痛苦的根源在于**自我-自性轴线的断裂**（Ego-Self Axis Alienation）。
    17→
    18→现代人面临三重困境：
    19→1. **意义断裂**：事件发生但没有可承载的解释框架（"我是不是无缘无故有问题"）
    20→2. **效能断裂**：解释即便成立，也没有下一步行动（只能继续问、继续刷）
    21→3. **身份碎片化**：社交媒体塑造的多重"表演性自我"导致核心自我感的丧失
    22→
    23→### 0.2 OS 的一句话定义
    24→
    25→**Soul OS = 一个把"情绪—解释—行动—反馈"外部化的自我调节系统**
    26→
    27→让用户把混沌体验变成可执行承诺（Commitment），再用可审计反馈把"自我效能感"做出来，最终把依赖从"问答案"迁移到"做闭环"。
    28→
    29→### 0.3 MVP 的"最小但完整"交付
    30→
    31→1. **可重复闭环**：`Clarify → Insight → Prescription → Commitment → Action → Reflection → Memory Update`
    32→2. **两种交互形态**：Chat（咨询室）+ Bento（工作台/显化区）
    33→3. **反依赖护栏**：限制重复占卜式追问，强制回到现实实验与最小行动
    34→
    35→### 0.4 总原则（心理学约束）
    36→
    37→**"定数"只能作为先验，不得作为判决。**
    38→
    39→系统可以用 L0 提供叙事感与问题定位，但必须把输出收敛为用户可控变量（行为、环境、边界、练习），并在每次输出中显式邀请承诺。
    40→
    41→---
    42→
    43→## 1. 四层架构：意识的计算模型
    44→
    45→### 1.1 架构总览
    46→
    47→```
    48→┌─────────────────────────────────────────────────────────────────┐
    49→│                    L3: Synthesis (意识/自我)                     │
    50→│         元认知仲裁器 - GLM 对话 Agent + Guidance Card            │
    51→│         功能：整合、决策、承诺邀请                               │
    52→├─────────────────────────────────────────────────────────────────┤
    53→│                    L2: Agents (策略/超我)                        │
    54→│         多视角并行分析（Prompt模板参数化，不做Agent间通信）      │
    55→│         功能：提供多元视角、具象化内部声音                       │
    56→├─────────────────────────────────────────────────────────────────┤
    57→│                    L1: Schema (特质/图式)                        │
    58→│         现代心理学框架（PERMA/VIA/CBT 图式）+ 行为证据汇总       │
    59→│         功能：翻译 L0 为可操作心理语言                           │
    60→├─────────────────────────────────────────────────────────────────┤
    61→│                    L0: Firmware (定数/本我)                      │
    62→│         八字/星盘 + 用户档案（快照化、可追溯）                   │
    63→│         功能：提供先验概率与确定性约束                           │
    64→└─────────────────────────────────────────────────────────────────┘
    65→```
    66→
    67→### 1.2 心理学映射
    68→
    69→| 层级 | 计算功能 | 心理学对应 | 荣格术语 | MVP 落地 |
    70→|------|----------|------------|----------|----------|
    71→| L0 | 不可变参数 | 气质/体质/先天倾向 | Psychoid | `fortune_bazi_snapshot.facts` |
    72→| L1 | 静态图式 | 人格特质/认知图式 | Persona + Shadow | `fortune_user` + 行为汇总 |
    73→| L2 | 多视角分析 | 内化客体/超我声音 | Complexes | RAG + Prompt模板 |
    74→| L3 | 整合输出 | 执行自我/工作自我 | Ego | GLM A2UI 输出 |
    75→
    76→---
    77→
    78→## 2. L0 Firmware：定数层
    79→
    80→### 2.1 心理学原理
    81→
    82→在精神分析传统中，存在核心张力：**决定论 vs 自由意志**。
    83→
    84→L0 承认决定论的部分真理——人并非生而空白：
    85→- **生物决定论**：气质类型、神经递质基线、昼夜节律
    86→- **时空决定论**：出生时刻的天文配置作为隐喻性"出厂设置"
    87→- **环境决定论**：早年依附模式、核心信念的形成
    88→
    89→但承认定数不等于宿命论。L0 的功能是**设定边界条件**，而非预测结果。
    90→
    91→### 2.2 数据结构
    92→
    93→```json
    94→{
    95→  "profile": {
    96→    "name": "用户姓名",
    97→    "gender": "男|女",
    98→    "birthday_local": "YYYY-MM-DD HH:MM:SS",
    99→    "tz_offset_hours": 8.0,
   100→    "location": {"name": "城市", "longitude": 0.0, "latitude": 0.0}
   101→  },
   102→  "solar_time": {
   103→    "true_solar_time_local": "真太阳时校正后的出生时间"
   104→  },
   105→  "bazi": {
   106→    "pillars": {"year": "干支", "month": "干支", "day": "干支", "hour": "干支"},
   107→    "day_master": {"gan": "日干", "element": "五行"},
   108→    "wuxing_count": {"金": 0, "木": 0, "水": 0, "火": 0, "土": 0},
   109→    "strength": {"score": 0, "level": "strong|neutral|weak"},
   110→    "favorable_elements": ["喜用五行"],
   111→    "shensha": [{"name": "神煞名", "hit": true, "note": "说明"}],
   112→    "luck": {
   113→      "da_yun": [{"index": 1, "gan_zhi": "大运干支", "start_age": 0, "end_age": 10}],
   114→      "liu_nian_next5": [{"year": 2026, "gan_zhi": "流年干支"}]
   115→    }
   116→  },
   117→  "version": {
   118→    "compute_version": "bazi-tts-v1",
   119→    "facts_hash": "sha256:..."
   120→  }
   121→}
   122→```
   123→
   124→### 2.3 心理学翻译规则
   125→
   126→L0 数据**不直接**呈现给用户，经过心理学翻译：
   127→
   128→| 八字概念 | 心理学翻译 | 行动导向 |
   129→|----------|------------|----------|
   130→| 日主偏弱 | "你的能量更适合借力/合作" | "本周找一个支持者" |
   131→| 食伤重 | "你有强烈的表达欲和创造力" | "每天留 15 分钟自由书写" |
   132→| 官杀混杂 | "你可能感受到多重压力/权威冲突" | "写清哪些压力是你能控制的" |
   133→| 桃花星 | "你在关系中有天然的吸引力和敏感度" | "觉察关系中的边界需求" |
   134→| 驿马星 | "你有变动/探索的内在驱力" | "小范围实验胜过大规模改变" |
   135→
   136→### 2.4 工程映射
   137→
   138→- Profile：`fortune_user`
   139→- 事实快照：`fortune_bazi_snapshot(facts, facts_hash, compute_version)`
   140→- 读取规则：对话与 Bento 只能读取最新快照作为确定性事实来源
   141→- 更新必须可追溯（快照化），避免"系统自己改口"
   142→
   143→---
   144→
   145→## 3. L1 Schema：特质层
   146→
   147→### 3.1 定义与价值
   148→
   149→**定义**：用户相对稳定的"我是谁"模型——偏好、价值、边界、典型阻碍、常用优势、风险边界。
   150→
   151→**价值**：让系统输出更"像你"，让用户感觉"这是在帮我成长，而不是在给模板建议"。
   152→
   153→### 3.2 心理学框架
   154→
   155→#### 3.2.1 积极心理学 PERMA 模型
   156→
   157→| 维度 | 定义 | 数据来源 |
   158→|------|------|----------|
   159→| **P** Positive Emotion | 积极情绪的频率与强度 | `fortune_checkin.mood/intensity` |
   160→| **E** Engagement | 投入/心流体验 | 任务完成率 + 用户反馈 |
   161→| **R** Relationships | 关系满意度 | 复盘输入 + 对话分析 |
   162→| **M** Meaning | 意义感/目的感 | 计划参与 + 价值观对话 |
   163→| **A** Accomplishment | 成就感 | `fortune_commitment.status='done'` |
   164→
   165→#### 3.2.2 认知图式（CBT）
   166→
   167→从用户对话中提取的核心信念模式：
   168→- **无助图式**："我改变不了"
   169→- **不可爱图式**："我不值得被爱"
   170→- **失败图式**："我总是失败"
   171→- **控制图式**："我必须控制一切"
   172→
   173→### 3.3 MVP 最小实现（不新增表）
   174→
   175→| 数据类型 | 来源 | 更新时机 |
   176→|----------|------|----------|
   177→| 显式偏好 | `fortune_user_preferences` | 用户主动修改 |
   178→| 行为证据 | `fortune_commitment/plan_record/checkin/reflection` 汇总 | 后端计算，对话时注入 |
   179→| 会话语境 | 最近 N 条 `fortune_conversation_message` | 运行时计算 |
   180→
   181→### 3.4 Schema 快照（用于 LLM 输入）
   182→
   183→```json
   184→{
   185→  "perma_snapshot": {
   186→    "positive_emotion": {"score": 6.5, "trend": "up"},
   187→    "engagement": {"active_plans": 2, "completion_rate": 0.75},
   188→    "relationships": {"recent_note": "提到与同事关系改善"},
   189→    "meaning": {"core_value": "成长", "aligned_actions": 3},
   190→    "accomplishment": {"weekly_done": 5, "streak": 4}
   191→  },
   192→  "cognitive_patterns": {
   193→    "identified_schemas": ["控制图式"],
   194→    "reframe_count": 2
   195→  },
   196→  "strengths_in_use": ["组织", "洞察"]
   197→}
   198→```
   199→
   200→---
   201→
   202→## 4. L2 Agents：策略层
   203→
   204→### 4.1 心理学原理：内化客体与超我碎片
   205→
   206→在客体关系理论中，人的内心世界充满了"内化客体"——父母、导师、文化英雄的心理表征。这些内化客体构成了"内部顾问委员会"。
   207→
   208→L2 层的创新：**将内部声音外部化为可对话的策略视角**，让用户看到自己内在冲突的结构，把纠结从"我不行"变成"价值冲突/目标冲突/风险偏好冲突"。
   209→
   210→### 4.2 MVP 实现方式
   211→
   212→**不做"智能体互相辩论"，只做并行候选建议**：
   213→- 同一问题生成 2-4 个候选处方方向
   214→- 每个策略只输出：`assumption`（前提）+ `tradeoff`（代价）+ `next_step`（下一步实验）
   215→- 由 L3 仲裁整合
   216→
   217→### 4.3 四个原型顾问（Prompt 模板参数化）
   218→
   219→| 视角 | 优化函数 | 典型输出风格 | 适用场景 |
   220→|------|----------|--------------|----------|
   221→| 儒家/关系 | 和谐 + 秩序 | "考虑对方感受，先稳定关系" | 人际冲突 |
   222→| 第一性原理 | 真相 + 效率 | "问题的本质是什么？最小验证" | 决策困境 |
   223→| 系统思维 | 风险 + 概率 | "有哪些变量？因果链是什么" | 复杂问题 |
   224→| 效能整合 | 平衡 + 可持续 | "重要且不紧急的事优先" | 时间管理 |
   225→
   226→### 4.4 知识库支持（RAG）
   227→
   228→- **来源**：`bazi_kb_document` / `bazi_kb_chunk`（PostgreSQL FTS + pg_trgm）
   229→- **检索**：关键词匹配 + 相似度排序，top-k=12
   230→- **引用**：`kb_ref` 格式 `kb:doc:{doc_id}:page:{page_no}:chunk:{chunk_no}`
   231→- 所有引用写入 `evidence.kb_refs`，保证可追溯
   232→
   233→---
   234→
   235→## 5. L3 Synthesis：意识层
   236→
   237→### 5.1 心理学原理
   238→
   239→L3 是系统的"前台意识"，对应：
   240→- **执行自我**（Executive Ego）：整合信息、做出决策
   241→- **元认知**（Metacognition）：对思维过程的觉察与调节
   242→
   243→L3 的核心任务不是"给出正确答案"，而是**引导用户完成整合**。
   244→
   245→### 5.2 运行时闭环（7 步模型）
   246→
   247→| Step | 产物 | 心理学意图 | MVP 落点 |
   248→|------|------|------------|----------|
   249→| Clarify | 问题结构化（选项/约束/时间窗） | 降低不确定性焦虑 | `fortune_conversation_message` |
   250→| Insight | 可控/不可控拆分 + 解释 | 认知重评、归因修正 | A2UI `markdown_text` |
   251→| Prescription | ≤3 条处方（微行动优先） | 行为激活、启动摩擦最小化 | `fortune_commitment(status=suggested)` |
   252→| Commitment | 用户选一个并确认 | 建立承诺、形成自我效能 | `fortune_commitment.accepted_at` |
   253→| Action | 完成/跳过/延期 | 行为回路形成 | `fortune_commitment.status` |
   254→| Reflection | 一句话复盘 | 强化学习、复盘迁移 | `fortune_reflection` / `fortune_checkin` |
   255→| Memory Update | 更新可见变化 | 形成成长叙事与可追溯证据 | 各表汇总 |
   256→
   257→### 5.3 WOOP / If-Then 集成
   258→
   259→**心理学原理**：
   260→- **意向-行动鸿沟**：人们经常"想做"但"不做"
   261→- **实施意图**（Implementation Intention）："如果-那么"计划提高执行率 2-3 倍
   262→
   263→**MVP 集成点**：
   264→- 在 Clarify/Prescription 阶段，追加结构化追问：`wish` / `obstacle`
   265→- 在输出处方时，给出 1 条 `if_then`：`如果____发生 → 那么我就做____（≤2分钟版本优先）`
   266→
   267→**工程落点**：
   268→- 将 `wish/outcome/obstacle/if_then` 写入 `fortune_commitment.details`（JSONB）
   269→- 复用 `habit_30` 等轨道内置的 If-Then 训练日
   270→
   271→### 5.4 输出格式：Guidance Card + A2UI
   272→
   273→```json
   274→{
   275→  "card_id": "uuid",
   276→  "type": "daily_guidance|chat_response|checkin_response",
   277→  "conclusion": "≤50字结论",
   278→  "why": "依据（心理学语言）",
   279→  "prescriptions": [
   280→    {"task_id": "uuid", "content": "行动描述", "estimated_minutes": 5, "if_then": "如果想放弃→先做1分钟版本"}
   281→  ],
   282→  "time_window": {"type": "intervention", "value": "7天试行", "confidence": "high"},
   283→  "risk_boundary": "不替代医疗/法律/投资建议",
   284→  "commitment_ask": "你愿意先做哪一个？",
   285→  "actions": [
   286→    {"type": "start_task", "task_id": "uuid", "label": "开始行动"},
   287→    {"type": "schedule_task", "task_id": "uuid", "label": "加入计划"},
   288→    {"type": "opt_out", "label": "暂时不做"}
   289→  ],
   290→  "evidence": {
   291→    "facts_hash": "sha256:...",
   292→    "kb_refs": ["kb:doc:1:page:10:chunk:3"],
   293→    "rule_ids": ["RULE-STRENGTH-SCORE-V1"]
   294→  }
   295→}
   296→```
   297→
   298→---
   299→
   300→## 6. Commitment 心理学：闭环核心
   301→
   302→### 6.1 为什么 Commitment 是闭环核心
   303→
   304→心理学研究表明：
   305→- **承诺一致性**（Commitment-Consistency）：公开承诺显著提高行动概率
   306→- **实施意图**提高执行率 2-3 倍
   307→- **自我效能感**来自"说到做到"的累积证据
   308→
   309→因此，每次交互的目标不是"给建议"，而是**获得承诺**。
   310→
   311→### 6.2 Commitment 四类型
   312→
   313→| 类型 | 定义 | 心理学功能 |
   314→|------|------|------------|
   315→| `start_task` | 立刻开始（≤5 分钟优先） | 利用当下动机，避免延迟衰减 |
   316→| `schedule_task` | 加入今日/本周计划 | 形成实施意图 |
   317→| `ask_followup` | 选择一个澄清问题继续 | 减少开放式追问 |
   318→| `opt_out` | 暂停/关闭 | 尊重自主性，提供安全出口 |
   319→
   320→### 6.3 硬规则
   321→
   322→- 处方必须 ≤3 条
   323→- 每条必须能落到按钮（`start_task`/`schedule_task`/`opt_out`）
   324→- 任何"解释"后必须紧跟"你现在能做什么"
   325→
   326→---
   327→
   328→## 7. State Score：把"感觉"变成可训练变量
   329→
   330→### 7.1 设计原理
   331→
   332→**留存不来自解释，来自可感知进步。**
   333→
   334→State Score 必须满足三个约束：
   335→- **可解释**：用户知道分数怎么来的
   336→- **可被行动影响**：完成任务能提升
   337→- **不过度惩罚**：负面情绪不直接扣分，而是触发补救动作
   338→
   339→### 7.2 MVP 计算口径（不新增表）
   340→
   341→```python
   342→def calculate_state_score(user_id: int, window: str = "24h") -> dict:
   343→    """
   344→    三信号计算（0-100 分）
   345→    """
   346→    # 信号1: 情绪基线（40%权重）
   347→    checkin = get_latest_checkin(user_id, window)
   348→    if checkin:
   349→        # 反转：intensity 越高（负面越强）→ 分数越低
   350→        checkin_signal = max(0, 10 - checkin.intensity) * 4
   351→    else:
   352→        checkin_signal = 20  # 无打卡给中性分
   353→
   354→    # 信号2: 行动完成（40%权重）
   355→    done_count = count_done_commitments(user_id, window)
   356→    action_signal = min(done_count * 10, 40)
   357→
   358→    # 信号3: 连续记录（20%权重）
   359→    streak = get_streak_days(user_id)
   360→    streak_signal = min(streak * 4, 20)
   361→
   362→    score = checkin_signal + action_signal + streak_signal
   363→
   364→    return {
   365→        "score": score,
   366→        "breakdown": {
   367→            "emotion": checkin_signal,
   368→            "action": action_signal,
   369→            "streak": streak_signal
   370→        },
   371→        "recovery_action": get_recovery_action(score)  # 分数低时给补救动作
   372→    }
   373→```
   374→
   375→### 7.3 展示策略
   376→
   377→- 分数旁必须显示"你可以把分数拉回来的 1 个动作"
   378→- 连续追问同一问题时，不给更高分数，只给"最小实验"
   379→- 避免纯惩罚逻辑
   380→
   381→---
   382→
   383→## 8. 情绪打卡：即时适应性干预（JITAI）
   384→
   385→### 8.1 JITAI 原理
   386→
   387→Just-In-Time Adaptive Interventions 是健康心理学前沿范式：
   388→- **即时**：在情绪峰值时介入
   389→- **适应性**：根据当前状态调整干预
   390→- **最小剂量**：5 分钟以内的微干预
   391→
   392→### 8.2 打卡流程
   393→
   394→```
   395→1. 点击"情绪打卡"
   396→2. 选择情绪标签（焦虑/低落/平静/兴奋/愤怒/困惑）
   397→3. 滑动强度（0-10）
   398→4. 可选：写一句话备注
   399→5. 系统返回：
   400→   - 归因假设（"这可能与...有关"）
   401→   - 1 个调节动作（≤5 分钟）
   402→   - 承诺邀请
   403→```
   404→
   405→### 8.3 调节动作库
   406→
   407→| 情绪 | 强度 | 推荐动作 | 原理 |
   408→|------|------|----------|------|
   409→| 焦虑 | 7-10 | 3分钟呼吸降噪（4-7-8呼吸法） | 激活副交感神经 |
   410→| 焦虑 | 4-6 | 写下3个最坏情况并评估概率 | 认知解离 |
   411→| 低落 | 7-10 | 做一个最小行动（站起来倒杯水） | 行为激活 |
   412→| 低落 | 4-6 | 回忆一个小成就并写下来 | 反刍打断 |
   413→| 愤怒 | 7-10 | 用力握拳10秒再松开，重复3次 | 生理释放 |
   414→| 愤怒 | 4-6 | 写下"我需要的是___" | 需求识别 |
   415→| 困惑 | 任意 | 写下3个选项和1个约束 | 结构化决策 |
   416→| 兴奋 | 7-10 | 写下这个感觉的来源 | 积极情绪放大 |
   417→
   418→---
   419→
   420→## 9. 反依赖机制：心理学安全围栏
   421→
   422→### 9.1 设计原理
   423→
   424→任何心理干预系统都存在**依赖风险**——用户可能将系统作为"全能客体"，逃避现实行动。
   425→
   426→心理学基础：
   427→- **Winnicott 过渡客体理论**：好的过渡客体最终应被放弃，用户发展出独立能力
   428→- **依附理论安全基地**：安全依附的目标是支持探索，而非永久庇护
   429→- **自我决定理论**：过度外部控制会损害内在动机
   430→
   431→### 9.2 触发规则
   432→
   433→| 触发条件 | 系统响应 | 心理学目的 |
   434→|----------|----------|------------|
   435→| 连续 3 次问同一问题 | 强制给"现实行动实验"（5-15 分钟） | 打断反刍，转入行为激活 |
   436→| 当日咨询 > 5 次 | 温和截断：信息足够→先行动→给1个最小任务 | 防止把系统当"情绪止痛药" |
   437→| 轨道达标毕业 | 主动降频推送 + 强调自我掌控 | 让用户把控制权拿回去 |
   438→| 连续 7 天无行动 | 关心式询问 + 降低任务难度 | 维持联系但不施压 |
   439→
   440→### 9.3 温和出口
   441→
   442→所有反依赖干预都必须提供选项：
   443→- "我愿意执行"
   444→- "稍后再说"
   445→- "不再提示"（opt_out）
   446→
   447→**永远不强迫**——强迫本身就违反自主性原则。
   448→
   449→### 9.4 风险边界（合规与伦理）
   450→
   451→- 禁止确定性宿命论输出（尤其健康/法律/投资）
   452→- 抑郁/自伤关键词：触发危机提示与求助资源
   453→- 任何"负面解释"后必须紧接"可执行处方"
   454→
   455→---
   456→
   457→## 10. 语言风格：表达层设计
   458→
   459→### 10.1 三种人格风格
   460→
   461→| 风格 | 特点 | 适用用户 | 示例 |
   462→|------|------|----------|------|
   463→| `standard` | 清晰、中性、专业 | 偏好理性分析 | "根据你的情况，建议..." |
   464→| `warm` | 共情、支持性（默认） | 多数用户 | "听起来你现在感到...我理解这种感受" |
   465→| `roast` | 轻毒舌但不羞辱 | 偏好直接反馈 | "你又在逃避了？来，先做这个再说" |
   466→
   467→### 10.2 风格边界（所有风格共守）
   468→
   469→**禁止**：
   470→- 恐吓（"你会失败"）
   471→- 羞辱（"你太差了"）
   472→- 人格定性（"你就是懒"）
   473→- 宿命论断言（"你命中注定"）
   474→
   475→**必须**：
   476→- 负面后有出口（"但你可以..."）
   477→- 行动导向（每次输出有 commitment_ask）
   478→
   479→### 10.3 `roast` 风格的允许范围
   480→
   481→仅限于：
   482→- 指出逃避模式（"你又开始找借口了"）
   483→- 挑战不合理信念（"你真的没时间，还是不想面对？"）
   484→- 幽默化处理（"好吧，你的拖延症今天又赢了"）
   485→
   486→---
   487→
   488→## 11. 界面与对象：把"心灵结构"做成可操作 UI
   489→
   490→### 11.1 `/main` 两栏 = 轴线的可视化
   491→
   492→- **左栏（Chat Thread）**：自我的语言化，承接情绪与叙事
   493→- **右栏（Workbench/Bento）**：自性的结构化镜像，把冲突/任务/计划变成可点击对象
   494→
   495→### 11.2 Bento 组件
   496→
   497→| 组件 | 用户动作 | OS 作用 |
   498→|------|----------|---------|
   499→| Today | 看"今日指引卡"→点一个行动 | 把系统价值压缩成1张卡 |
   500→| Check-in | 选情绪/强度→得到1个调节动作 | 情绪调节先行 |
   501→| Commitment | 接受/完成/跳过任务 | 把"建议"变成"证据" |
   502→| Decision Brief | 填选项/约束→生成最小实验 | 承接"我要不要/该不该" |
   503→| Script | 生成短脚本 | 降低社交与执行摩擦 |
   504→| Plan | 加入轨道→每日记录 | 长程成长的节奏器 |
   505→
   506→### 11.3 数字孪生最小面板（MVP）
   507→
   508→**展示层（必做）**：在 Workbench 顶部显示：
   509→- 3 个指标：`energy`（精力）、`clarity`（清晰度）、`connection`（连接感）
   510→- State Score + 1 句解释
   511→- 1 个建议动作
   512→
   513→**资产层（后续）**：头像/皮肤/光环（与变现绑定）
   514→
   515→---
   516→
   517→## 12. 变现与增长
   518→
   519→### 12.1 订阅（MVP 最小版）
   520→
   521→| 层级 | 功能 |
   522→|------|------|
   523→| 免费 | 每日指引 + 有限对话额度 + 基础事实快照 |
   524→| 订阅 | 更高对话额度 + 更长历史回放 + 深度报告入口 |
   525→
   526→### 12.2 内购（先从深度报告开始）
   527→
   528→- **Deep Dives**：年度/职业/关系主题报告（PDF/阅读模式）
   529→- 对应 `POST /api/report/bazi/submit`（`backend=cli|gemini`）
   530→
   531→### 12.3 裂变（不做社区也能传播）
   532→
   533→- 可分享图片（今日指引 / State Score / 合盘摘要）+ 二维码深链
   534→- 注册后查看完整版
   535→
   536→---
   537→
   538→## 13. 路线图
   539→
   540→### 13.1 MVP（现在）
   541→
   542→- 闭环跑通：Commitment + Action + Feedback 可追溯
   543→- L0 快照化：`fortune_bazi_snapshot` 作为唯一确定性事实来源
   544→- L2 轻量化：策略模板并行候选 + L3 仲裁（不做 Agent 间通信）
   545→- 数字孪生最小面板：3 指标 + State Score + 1 动作
   546→- State Score 实时计算（不新增表）
   547→
   548→### 13.2 V1（可选）
   549→
   550→- State Score 时序化（新增日表/周表）+ 更明确的"练级"反馈
   551→- 微课程内容库（从纯文本 → 音频/交互式内容）
   552→- 合盘与关系动力学（先 1:1 生成报告）
   553→- L1 Schema 固化为可编辑"角色面板"
   554→
   555→### 13.3 V2（增长与变现重型）
   556→
   557→- 能量币/皮肤/补签卡等完整经济系统
   558→- 更丰富的分享模板与"任务副本"（双人挑战/群体仪式）
   559→- 多 Agent 并行/辩论机制
   560→
   561→---
   562→
   563→## 14. 数据流与工程映射
   564→
   565→### 14.1 完整数据流
   566→
   567→```
   568→用户输入
   569→    ↓
   570→┌─────────────────────────────────────────────────────────────────┐
   571→│                        API 层（FastAPI）                         │
   572→│  1. 验证登录态                                                   │
   573→│  2. 读取 L0（fortune_bazi_snapshot.facts）                       │
   574→│  3. 读取 L1（fortune_user_preferences + 行为汇总）               │
   575→│  4. 检索知识库（bazi_kb_chunk → kb_refs）                        │
   576→│  5. 计算 State Score                                            │
   577→│  6. 构建 GLM System Prompt + facts + evidence                    │
   578→└────────┬────────────────────────────────────────────────────────┘
   579→         ↓
   580→┌─────────────────┐
   581→│   GLM 调用       │ ← L2 + L3 整合
   582→└────────┬────────┘
   583→         ↓
   584→┌─────────────────────────────────────────────────────────────────┐
   585→│                        输出处理                                  │
   586→│  1. 解析 A2UI JSON                                               │
   587→│  2. 写入 fortune_conversation_message                            │
   588→│  3. 写入 fortune_commitment（status=suggested）                  │
   589→│  4. 返回前端渲染                                                 │
   590→└─────────────────────────────────────────────────────────────────┘
   591→```
   592→
   593→### 14.2 OS 概念 → 工程对象映射
   594→
   595→| OS 概念 | SSOT 表 | 关键 API |
   596→|---------|---------|----------|
   597→| Ego 对话 | `fortune_conversation_session/message` | `POST /api/chat/send` |
   598→| L0 先验 | `fortune_user` / `fortune_bazi_snapshot` | `PUT /api/user/profile` |
   599→| L1 图式 | `fortune_user_preferences` + 行为表汇总 | 运行时计算 |
   600→| Commitment | `fortune_commitment` | `POST /api/bento/commitment/*` |
   601→| 情绪反馈 | `fortune_checkin` | `POST /api/bento/checkin` |
   602→| 复盘反馈 | `fortune_reflection` | `POST /api/bento/reflect` |
   603→| 成长轨道 | `fortune_plan*` | `POST /api/plan/*` |
   604→| 今日指引 | `fortune_daily_guidance` | `GET /api/bento/today` |
   605→| State Score | 运行时计算（不落表） | 嵌入各 API 响应 |
   606→| 深度报告 | `fortune_external_job` | `POST /api/report/bazi/submit` |
   607→
   608→---
   609→
   610→## 附录 A：GLM System Prompt 完整版
   611→
   612→```text
   613→你是 Fortune AI 的对话 Agent，角色是积极心理学教练（Performance Coach）。
   614→
   615→【产品定位】
   616→人生导航 / 陪伴 / 提升。系统和交互保持"有效而极简"。
   617→
   618→【四层架构理解】
   619→- L0（定数）：用户的八字事实，作为先验约束，不做宿命论解读
   620→- L1（特质）：用户的心理图式和当前状态，作为个性化调节
   621→- L2（策略）：知识库和规则，作为专业依据
   622→- L3（意识）：你的输出，作为整合与行动引导
   623→
   624→【你的优先级（不可逆）】
   625→Coach > Teaching Assistant > Customer Support > Sales
   626→
   627→【硬性规则（必须遵守）】
   628→1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接"你可以做什么"的行动处方。
   629→2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。
   630→3) 每次输出必须包含：结论(conclusion) + 依据(why) + ≤3条处方(prescriptions) + 承诺邀请(commitment_ask)。
   631→4) 处方必须包含 if_then（如果____→那么____）。
   632→5) 时间窗口默认只给干预窗口（intervention）；forecast 只能条件句+低置信度。
   633→6) 输出必须是 A2UI JSON，且第一组件必须是 markdown_text。
   634→7) 必须给出可点击 actions（start_task / schedule_task / open_panel / opt_out）。
   635→
   636→【语言风格 persona_style】
   637→standard：清晰、中性、专业
   638→warm：共情、支持性（默认）
   639→roast：轻毒舌但不羞辱、不对人格做负面定性
   640→
   641→【输入】
   642→- persona_style：standard / warm / roast
   643→- user_context：用户基础信息与偏好
   644→- facts：L0 八字确定性事实
   645→- schema：L1 PERMA 快照 + 行为证据
   646→- evidence：rule_ids + kb_refs + facts_hash
   647→- state_score：当前状态分数与breakdown
   648→- user_message：用户本轮输入
   649→
   650→【输出（A2UI JSON）】
   651→- meta.summary：一句话摘要
   652→- ui_components[0]：markdown_text（必须，包含：结论要点/依据/处方/if_then/时间窗口/边界/承诺邀请）
   653→- ui_components[1]：action_buttons（必须，包含：开始行动/加入计划/暂不执行）
   654→```
   655→
   656→---
   657→
   658→## 附录 B：验收标准
   659→
   660→### B.1 心理学验收
   661→
   662→| 维度 | 标准 | 验证方法 |
   663→|------|------|----------|
   664→| 安全性 | 无恐吓/羞辱/宿命论 | 输出审计 + 用户反馈 |
   665→| 行动导向 | 每次输出都有 commitment_ask | A2UI 结构校验 |
   666→| 反依赖 | 触发规则正常执行 | 日志 + 事件统计 |
   667→| 可追溯 | 所有输出关联 evidence | facts_hash + kb_refs 校验 |
   668→
   669→### B.2 业务验收（WCG）
   670→
   671→Weekly Closed-loop Guidance：用户在一周内完成 ≥1 次"触发 → 指引 → 行动 → 反馈"闭环。
   672→
   673→```sql
   674→WITH weekly_loop AS (
   675→  SELECT
   676→    user_id,
   677→    DATE_TRUNC('week', created_at) AS week,
   678→    BOOL_OR(accepted_at IS NOT NULL) AS has_commitment,
   679→    BOOL_OR(status = 'done') AS has_action
   680→  FROM fortune_commitment
   681→  GROUP BY user_id, DATE_TRUNC('week', created_at)
   682→)
   683→SELECT
   684→  user_id,
   685→  week,
   686→  (has_commitment AND has_action) AS wcg_achieved
   687→FROM weekly_loop;
   688→```
   689→
   690→---
   691→
   692→## 附录 C：参考文献
   693→
   694→1. Jung, C.G. (1959). *Aion: Researches into the Phenomenology of the Self*. Collected Works, Vol. 9ii.
   695→2. Seligman, M.E.P. (2011). *Flourish: A Visionary New Understanding of Happiness and Well-being*.
   696→3. Oettingen, G. (2014). *Rethinking Positive Thinking: Inside the New Science of Motivation*. (WOOP)
   697→4. Gollwitzer, P.M. (1999). Implementation intentions: Strong effects of simple plans. *American Psychologist*.
   698→5. Fogg, B.J. (2020). *Tiny Habits: The Small Changes That Change Everything*.
   699→6. Clear, J. (2018). *Atomic Habits: An Easy & Proven Way to Build Good Habits & Break Bad Ones*.
   700→7. Ryan, R.M. & Deci, E.L. (2017). *Self-Determination Theory: Basic Psychological Needs in Motivation, Development, and Wellness*.
   701→8. Nahum-Shani, I. et al. (2018). Just-in-Time Adaptive Interventions (JITAIs) in Mobile Health. *Annals of Behavioral Medicine*.
   702→9. Beck, A.T. (1979). *Cognitive Therapy and the Emotional Disorders*.
   703→10. Winnicott, D.W. (1971). *Playing and Reality*.
   704→
   705→---
   706→
   707→*本文档综合 Codex MVP 工程约束与 Claude MVP 心理学深度，与 Fortune AI Final MVP 技术架构完全对齐。*
   708→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
