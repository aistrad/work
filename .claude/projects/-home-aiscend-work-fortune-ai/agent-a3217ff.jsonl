{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":"Review the FastAPI internal_routes.py implementation against the backend_refactoring_plan_v42.md specification.\n\nCheck:\n1. `/home/aiscend/work/fortune_ai/api/internal_routes.py` - The new internal routes\n2. `/home/aiscend/work/fortune_ai/api/main.py` - Router registration\n\nVerify against plan sections:\n- §2.4 Internal Contract APIs (Context API + Chat Persistence API)\n- §2.4.1 Context API schema\n- §2.4.2 Chat Persistence API (run/start, run/finalize)\n\nCheck if:\n1. Endpoints match the planned routes (/internal/context, /internal/chat/run/start, /internal/chat/run/finalize)\n2. Request/Response schemas match the plan\n3. Security rules are implemented (require_auth, userId from session)\n4. Tool logs and commitments are handled correctly\n\nReport any discrepancies or missing functionality."},"uuid":"2ab6a353-3a96-464d-911c-7f26071da262","timestamp":"2026-01-01T15:29:25.796Z"}
{"parentUuid":"2ab6a353-3a96-464d-911c-7f26071da262","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QkRwNkshsub27F9PhVmQdz","type":"message","role":"assistant","content":[{"type":"text","text":"I'll systematically review the FastAPI implementation against the specification. Let me start by examining the key files."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21030,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21030,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWgtvxRxCZJ5xCzRzt79h","type":"assistant","uuid":"d27b07ae-2d9d-4bf1-8a59-76b0a26d9dfb","timestamp":"2026-01-01T15:29:28.342Z"}
{"parentUuid":"d27b07ae-2d9d-4bf1-8a59-76b0a26d9dfb","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QkRwNkshsub27F9PhVmQdz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014qz7VF9DFVmT5Hy1ugjUw5","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/api/internal_routes.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21030,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21030,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWgtvxRxCZJ5xCzRzt79h","type":"assistant","uuid":"bcc27f44-f5b8-4851-b32d-a3df3922c387","timestamp":"2026-01-01T15:29:28.828Z"}
{"parentUuid":"bcc27f44-f5b8-4851-b32d-a3df3922c387","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QkRwNkshsub27F9PhVmQdz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01VzKhnGbrTRK7rhjUb1bPCS","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/api/main.py"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21030,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21030,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"}},"requestId":"req_011CWgtvxRxCZJ5xCzRzt79h","type":"assistant","uuid":"c9bfb94d-7a13-46b0-8ae0-6a825512299d","timestamp":"2026-01-01T15:29:28.834Z"}
{"parentUuid":"c9bfb94d-7a13-46b0-8ae0-6a825512299d","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01QkRwNkshsub27F9PhVmQdz","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SbQUrnvM6zJj37wowzPAXw","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/docs/backend_refactoring_plan_v42.md"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":21030,"cache_read_input_tokens":0,"cache_creation":{"ephemeral_5m_input_tokens":21030,"ephemeral_1h_input_tokens":0},"output_tokens":210,"service_tier":"standard"}},"requestId":"req_011CWgtvxRxCZJ5xCzRzt79h","type":"assistant","uuid":"1da690a2-23c8-4ae2-b01c-ba82d2d4405a","timestamp":"2026-01-01T15:29:29.123Z"}
{"parentUuid":"1da690a2-23c8-4ae2-b01c-ba82d2d4405a","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"<tool_use_error>File does not exist. Current working directory: /home/aiscend/work/fortune_ai/web-app</tool_use_error>","is_error":true,"tool_use_id":"toolu_01SbQUrnvM6zJj37wowzPAXw"}]},"uuid":"b2d1c777-94c2-4f0e-982e-0d8a62d2ac32","timestamp":"2026-01-01T15:29:29.154Z","toolUseResult":"Error: File does not exist. Current working directory: /home/aiscend/work/fortune_ai/web-app"}
{"parentUuid":"b2d1c777-94c2-4f0e-982e-0d8a62d2ac32","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014qz7VF9DFVmT5Hy1ugjUw5","type":"tool_result","content":"     1→\"\"\"\n     2→Internal API Routes for Next.js Agent Runtime\n     3→\n     4→These endpoints are called by the Next.js server-side only (not exposed to browser).\n     5→Trust boundary: userId is extracted from Cookie session, never passed from request body.\n     6→\n     7→Endpoints:\n     8→- GET  /internal/context         - Aggregate user context (L0+L1+history)\n     9→- POST /internal/chat/run/start  - Record run_id + user message\n    10→- POST /internal/chat/run/finalize - Transaction commit all side effects\n    11→\"\"\"\n    12→from __future__ import annotations\n    13→\n    14→import json\n    15→import uuid\n    16→from typing import Any, Dict, List, Optional\n    17→\n    18→from fastapi import APIRouter, HTTPException, Request\n    19→from pydantic import BaseModel, Field\n    20→\n    21→from api.deps import require_auth\n    22→from services import chat_service\n    23→from services.soul_os import get_full_context_for_chat\n    24→\n    25→router = APIRouter(prefix=\"/internal\", tags=[\"internal\"])\n    26→\n    27→\n    28→# =============================================================================\n    29→# Request/Response Models\n    30→# =============================================================================\n    31→\n    32→\n    33→class ContextResponse(BaseModel):\n    34→    \"\"\"Response for /internal/context\"\"\"\n    35→    user_id: int\n    36→    system_prompt: str\n    37→    persona_style: str\n    38→    user_context: Dict[str, Any]\n    39→    evidence: Dict[str, Any]\n    40→    anti_dependency: Dict[str, Any]\n    41→    history: List[Dict[str, Any]]\n    42→\n    43→\n    44→class RunStartRequest(BaseModel):\n    45→    \"\"\"Request for /internal/chat/run/start\"\"\"\n    46→    session_id: Optional[str] = Field(None, description=\"Existing session ID or null to create new\")\n    47→    message: str = Field(..., min_length=1, max_length=10000)\n    48→    model: str = Field(default=\"glm-4.7-flash\")\n    49→    correlation_id: Optional[str] = Field(None, description=\"Frontend correlation ID for tracing\")\n    50→\n    51→\n    52→class RunStartResponse(BaseModel):\n    53→    \"\"\"Response for /internal/chat/run/start\"\"\"\n    54→    run_id: str\n    55→    session_id: str\n    56→    user_message_id: int\n    57→\n    58→\n    59→class RunFinalizeRequest(BaseModel):\n    60→    \"\"\"Request for /internal/chat/run/finalize\"\"\"\n    61→    run_id: str = Field(..., description=\"Run ID from start\")\n    62→    session_id: str = Field(...)\n    63→    assistant_content: str = Field(..., description=\"Final assistant message text\")\n    64→    tool_calls: Optional[List[Dict[str, Any]]] = Field(default=None, description=\"Tool calls made during stream\")\n    65→    a2ui_cards: Optional[List[Dict[str, Any]]] = Field(default=None, description=\"A2UI cards to store\")\n    66→    prompt_tokens: int = Field(default=0)\n    67→    completion_tokens: int = Field(default=0)\n    68→    model: str = Field(default=\"glm-4.7-flash\")\n    69→    error: Optional[str] = Field(default=None, description=\"Error message if stream failed\")\n    70→\n    71→\n    72→class RunFinalizeResponse(BaseModel):\n    73→    \"\"\"Response for /internal/chat/run/finalize\"\"\"\n    74→    success: bool\n    75→    assistant_message_id: Optional[int] = None\n    76→    side_effects: List[str] = Field(default_factory=list)\n    77→\n    78→\n    79→# =============================================================================\n    80→# Endpoints\n    81→# =============================================================================\n    82→\n    83→\n    84→@router.get(\"/context\", response_model=ContextResponse)\n    85→async def get_context(\n    86→    request: Request,\n    87→    session_id: Optional[str] = None,\n    88→    query: Optional[str] = None,\n    89→):\n    90→    \"\"\"\n    91→    Get aggregated user context for chat.\n    92→\n    93→    Includes:\n    94→    - System prompt (based on persona style)\n    95→    - User context (L0 profile + L1 data)\n    96→    - Evidence (relevant knowledge)\n    97→    - Anti-dependency check\n    98→    - Recent chat history (if session_id provided)\n    99→    \"\"\"\n   100→    auth = require_auth(request)\n   101→    user_id = int(auth[\"user_id\"])\n   102→\n   103→    # Get full context from Soul OS\n   104→    ctx = get_full_context_for_chat(user_id, query or \"\")\n   105→\n   106→    # Get chat history if session provided\n   107→    history: List[Dict[str, Any]] = []\n   108→    if session_id:\n   109→        history = chat_service.get_recent_messages_for_llm(user_id, session_id, limit=10)\n   110→\n   111→    return ContextResponse(\n   112→        user_id=user_id,\n   113→        system_prompt=ctx[\"system_prompt\"],\n   114→        persona_style=ctx[\"persona_style\"],\n   115→        user_context=ctx[\"user_context\"],\n   116→        evidence=ctx[\"evidence\"],\n   117→        anti_dependency=ctx[\"anti_dependency\"],\n   118→        history=history,\n   119→    )\n   120→\n   121→\n   122→@router.post(\"/chat/run/start\", response_model=RunStartResponse)\n   123→async def start_run(request: Request, body: RunStartRequest):\n   124→    \"\"\"\n   125→    Start a new chat run.\n   126→\n   127→    Actions:\n   128→    1. Create or validate session\n   129→    2. Generate run_id\n   130→    3. Record user message\n   131→    4. Return run_id for finalization\n   132→    \"\"\"\n   133→    auth = require_auth(request)\n   134→    user_id = int(auth[\"user_id\"])\n   135→\n   136→    # Session handling\n   137→    session_id = body.session_id\n   138→    if not session_id:\n   139→        # Create new session\n   140→        session = chat_service.create_session(user_id)\n   141→        session_id = session[\"session_id\"]\n   142→    else:\n   143→        # Validate existing session\n   144→        existing = chat_service.get_session(user_id, session_id)\n   145→        if not existing:\n   146→            raise HTTPException(status_code=404, detail=\"session_not_found\")\n   147→\n   148→    # Generate run_id\n   149→    run_id = str(uuid.uuid4())\n   150→\n   151→    # Record user message\n   152→    msg_result = chat_service.append_message(\n   153→        session_id=session_id,\n   154→        user_id=user_id,\n   155→        role=\"user\",\n   156→        content=body.message,\n   157→        model=body.model,\n   158→    )\n   159→\n   160→    # Set session title from first message\n   161→    chat_service.set_title_if_empty(session_id, body.message[:24])\n   162→\n   163→    return RunStartResponse(\n   164→        run_id=run_id,\n   165→        session_id=session_id,\n   166→        user_message_id=msg_result[\"message_id\"],\n   167→    )\n   168→\n   169→\n   170→@router.post(\"/chat/run/finalize\", response_model=RunFinalizeResponse)\n   171→async def finalize_run(request: Request, body: RunFinalizeRequest):\n   172→    \"\"\"\n   173→    Finalize a chat run after streaming completes.\n   174→\n   175→    Actions:\n   176→    1. Record assistant message with a2ui cards\n   177→    2. Execute any pending side effects from tool calls\n   178→    3. Update session timestamp\n   179→\n   180→    This ensures atomic commit of all changes.\n   181→    \"\"\"\n   182→    auth = require_auth(request)\n   183→    user_id = int(auth[\"user_id\"])\n   184→\n   185→    # Validate session ownership\n   186→    existing = chat_service.get_session(user_id, body.session_id)\n   187→    if not existing:\n   188→        raise HTTPException(status_code=404, detail=\"session_not_found\")\n   189→\n   190→    # If there was an error, record it but don't store assistant message\n   191→    if body.error:\n   192→        # Log error but don't fail - we want the conversation to continue\n   193→        # TODO: Add error logging table\n   194→        return RunFinalizeResponse(\n   195→            success=False,\n   196→            assistant_message_id=None,\n   197→            side_effects=[f\"error_logged:{body.run_id}\"],\n   198→        )\n   199→\n   200→    # Build a2ui object from cards\n   201→    a2ui = None\n   202→    if body.a2ui_cards:\n   203→        a2ui = {\"cards\": body.a2ui_cards}\n   204→\n   205→    # Record assistant message\n   206→    msg_result = chat_service.append_message(\n   207→        session_id=body.session_id,\n   208→        user_id=user_id,\n   209→        role=\"assistant\",\n   210→        content=body.assistant_content,\n   211→        model=body.model,\n   212→        a2ui=a2ui,\n   213→        prompt_tokens=body.prompt_tokens,\n   214→        completion_tokens=body.completion_tokens,\n   215→    )\n   216→\n   217→    side_effects: List[str] = [f\"message_stored:{msg_result['message_id']}\"]\n   218→\n   219→    # Process tool calls for side effects (if any pending writes)\n   220→    # Tool calls that create commitments, log mood, etc. are already executed\n   221→    # during the stream via Skills. Here we just record what was done.\n   222→    if body.tool_calls:\n   223→        for tc in body.tool_calls:\n   224→            tool_name = tc.get(\"toolName\", tc.get(\"name\", \"unknown\"))\n   225→            side_effects.append(f\"tool_executed:{tool_name}\")\n   226→\n   227→    return RunFinalizeResponse(\n   228→        success=True,\n   229→        assistant_message_id=msg_result[\"message_id\"],\n   230→        side_effects=side_effects,\n   231→    )\n   232→\n   233→\n   234→# =============================================================================\n   235→# Health check (useful for debugging internal connectivity)\n   236→# =============================================================================\n   237→\n   238→\n   239→@router.get(\"/health\")\n   240→async def internal_health():\n   241→    \"\"\"Health check for internal API.\"\"\"\n   242→    return {\"status\": \"ok\", \"service\": \"internal_api\"}\n   243→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ed01e4fd-2bc1-4d31-a553-57610df77372","timestamp":"2026-01-01T15:29:29.305Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/api/internal_routes.py","content":"\"\"\"\nInternal API Routes for Next.js Agent Runtime\n\nThese endpoints are called by the Next.js server-side only (not exposed to browser).\nTrust boundary: userId is extracted from Cookie session, never passed from request body.\n\nEndpoints:\n- GET  /internal/context         - Aggregate user context (L0+L1+history)\n- POST /internal/chat/run/start  - Record run_id + user message\n- POST /internal/chat/run/finalize - Transaction commit all side effects\n\"\"\"\nfrom __future__ import annotations\n\nimport json\nimport uuid\nfrom typing import Any, Dict, List, Optional\n\nfrom fastapi import APIRouter, HTTPException, Request\nfrom pydantic import BaseModel, Field\n\nfrom api.deps import require_auth\nfrom services import chat_service\nfrom services.soul_os import get_full_context_for_chat\n\nrouter = APIRouter(prefix=\"/internal\", tags=[\"internal\"])\n\n\n# =============================================================================\n# Request/Response Models\n# =============================================================================\n\n\nclass ContextResponse(BaseModel):\n    \"\"\"Response for /internal/context\"\"\"\n    user_id: int\n    system_prompt: str\n    persona_style: str\n    user_context: Dict[str, Any]\n    evidence: Dict[str, Any]\n    anti_dependency: Dict[str, Any]\n    history: List[Dict[str, Any]]\n\n\nclass RunStartRequest(BaseModel):\n    \"\"\"Request for /internal/chat/run/start\"\"\"\n    session_id: Optional[str] = Field(None, description=\"Existing session ID or null to create new\")\n    message: str = Field(..., min_length=1, max_length=10000)\n    model: str = Field(default=\"glm-4.7-flash\")\n    correlation_id: Optional[str] = Field(None, description=\"Frontend correlation ID for tracing\")\n\n\nclass RunStartResponse(BaseModel):\n    \"\"\"Response for /internal/chat/run/start\"\"\"\n    run_id: str\n    session_id: str\n    user_message_id: int\n\n\nclass RunFinalizeRequest(BaseModel):\n    \"\"\"Request for /internal/chat/run/finalize\"\"\"\n    run_id: str = Field(..., description=\"Run ID from start\")\n    session_id: str = Field(...)\n    assistant_content: str = Field(..., description=\"Final assistant message text\")\n    tool_calls: Optional[List[Dict[str, Any]]] = Field(default=None, description=\"Tool calls made during stream\")\n    a2ui_cards: Optional[List[Dict[str, Any]]] = Field(default=None, description=\"A2UI cards to store\")\n    prompt_tokens: int = Field(default=0)\n    completion_tokens: int = Field(default=0)\n    model: str = Field(default=\"glm-4.7-flash\")\n    error: Optional[str] = Field(default=None, description=\"Error message if stream failed\")\n\n\nclass RunFinalizeResponse(BaseModel):\n    \"\"\"Response for /internal/chat/run/finalize\"\"\"\n    success: bool\n    assistant_message_id: Optional[int] = None\n    side_effects: List[str] = Field(default_factory=list)\n\n\n# =============================================================================\n# Endpoints\n# =============================================================================\n\n\n@router.get(\"/context\", response_model=ContextResponse)\nasync def get_context(\n    request: Request,\n    session_id: Optional[str] = None,\n    query: Optional[str] = None,\n):\n    \"\"\"\n    Get aggregated user context for chat.\n\n    Includes:\n    - System prompt (based on persona style)\n    - User context (L0 profile + L1 data)\n    - Evidence (relevant knowledge)\n    - Anti-dependency check\n    - Recent chat history (if session_id provided)\n    \"\"\"\n    auth = require_auth(request)\n    user_id = int(auth[\"user_id\"])\n\n    # Get full context from Soul OS\n    ctx = get_full_context_for_chat(user_id, query or \"\")\n\n    # Get chat history if session provided\n    history: List[Dict[str, Any]] = []\n    if session_id:\n        history = chat_service.get_recent_messages_for_llm(user_id, session_id, limit=10)\n\n    return ContextResponse(\n        user_id=user_id,\n        system_prompt=ctx[\"system_prompt\"],\n        persona_style=ctx[\"persona_style\"],\n        user_context=ctx[\"user_context\"],\n        evidence=ctx[\"evidence\"],\n        anti_dependency=ctx[\"anti_dependency\"],\n        history=history,\n    )\n\n\n@router.post(\"/chat/run/start\", response_model=RunStartResponse)\nasync def start_run(request: Request, body: RunStartRequest):\n    \"\"\"\n    Start a new chat run.\n\n    Actions:\n    1. Create or validate session\n    2. Generate run_id\n    3. Record user message\n    4. Return run_id for finalization\n    \"\"\"\n    auth = require_auth(request)\n    user_id = int(auth[\"user_id\"])\n\n    # Session handling\n    session_id = body.session_id\n    if not session_id:\n        # Create new session\n        session = chat_service.create_session(user_id)\n        session_id = session[\"session_id\"]\n    else:\n        # Validate existing session\n        existing = chat_service.get_session(user_id, session_id)\n        if not existing:\n            raise HTTPException(status_code=404, detail=\"session_not_found\")\n\n    # Generate run_id\n    run_id = str(uuid.uuid4())\n\n    # Record user message\n    msg_result = chat_service.append_message(\n        session_id=session_id,\n        user_id=user_id,\n        role=\"user\",\n        content=body.message,\n        model=body.model,\n    )\n\n    # Set session title from first message\n    chat_service.set_title_if_empty(session_id, body.message[:24])\n\n    return RunStartResponse(\n        run_id=run_id,\n        session_id=session_id,\n        user_message_id=msg_result[\"message_id\"],\n    )\n\n\n@router.post(\"/chat/run/finalize\", response_model=RunFinalizeResponse)\nasync def finalize_run(request: Request, body: RunFinalizeRequest):\n    \"\"\"\n    Finalize a chat run after streaming completes.\n\n    Actions:\n    1. Record assistant message with a2ui cards\n    2. Execute any pending side effects from tool calls\n    3. Update session timestamp\n\n    This ensures atomic commit of all changes.\n    \"\"\"\n    auth = require_auth(request)\n    user_id = int(auth[\"user_id\"])\n\n    # Validate session ownership\n    existing = chat_service.get_session(user_id, body.session_id)\n    if not existing:\n        raise HTTPException(status_code=404, detail=\"session_not_found\")\n\n    # If there was an error, record it but don't store assistant message\n    if body.error:\n        # Log error but don't fail - we want the conversation to continue\n        # TODO: Add error logging table\n        return RunFinalizeResponse(\n            success=False,\n            assistant_message_id=None,\n            side_effects=[f\"error_logged:{body.run_id}\"],\n        )\n\n    # Build a2ui object from cards\n    a2ui = None\n    if body.a2ui_cards:\n        a2ui = {\"cards\": body.a2ui_cards}\n\n    # Record assistant message\n    msg_result = chat_service.append_message(\n        session_id=body.session_id,\n        user_id=user_id,\n        role=\"assistant\",\n        content=body.assistant_content,\n        model=body.model,\n        a2ui=a2ui,\n        prompt_tokens=body.prompt_tokens,\n        completion_tokens=body.completion_tokens,\n    )\n\n    side_effects: List[str] = [f\"message_stored:{msg_result['message_id']}\"]\n\n    # Process tool calls for side effects (if any pending writes)\n    # Tool calls that create commitments, log mood, etc. are already executed\n    # during the stream via Skills. Here we just record what was done.\n    if body.tool_calls:\n        for tc in body.tool_calls:\n            tool_name = tc.get(\"toolName\", tc.get(\"name\", \"unknown\"))\n            side_effects.append(f\"tool_executed:{tool_name}\")\n\n    return RunFinalizeResponse(\n        success=True,\n        assistant_message_id=msg_result[\"message_id\"],\n        side_effects=side_effects,\n    )\n\n\n# =============================================================================\n# Health check (useful for debugging internal connectivity)\n# =============================================================================\n\n\n@router.get(\"/health\")\nasync def internal_health():\n    \"\"\"Health check for internal API.\"\"\"\n    return {\"status\": \"ok\", \"service\": \"internal_api\"}\n","numLines":243,"startLine":1,"totalLines":243}}}
{"parentUuid":"ed01e4fd-2bc1-4d31-a553-57610df77372","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01VzKhnGbrTRK7rhjUb1bPCS","type":"tool_result","content":"     1→from fastapi import FastAPI, HTTPException, Request\n     2→from fastapi.responses import HTMLResponse, StreamingResponse, RedirectResponse\n     3→from starlette.middleware.gzip import GZipMiddleware\n     4→from fastapi.middleware.cors import CORSMiddleware\n     5→from fastapi.staticfiles import StaticFiles\n     6→from fastapi.templating import Jinja2Templates\n     7→from pydantic import BaseModel, Field, validator\n     8→from typing import Optional, Dict, Any, Tuple, List\n     9→from uuid import uuid4\n    10→import os\n    11→import urllib.parse\n    12→import json\n    13→import re\n    14→import time\n    15→from datetime import datetime\n    16→\n    17→from common.logging import get_logger\n    18→from services import task_service\n    19→from services.rectification import rectify_birth_time_v2, rectify_birth_time_v2_iter\n    20→from services import rectification_v3\n    21→from user_store import update_fortune_user_rectification_by_name, get_fortune_user_by_name, create_fortune_user\n    22→from services.bazi_engine import calculate_bazi\n    23→from services.bazi_engine import DEFAULT_LOCATION\n    24→from services import prompt_store\n    25→import os as _os\n    26→from integrations import backend_router as be\n    27→from services.conversation_store import append_output, append_prompt, find_user_by_job, save_job_index\n    28→from common.a2ui import validate_a2ui, ValidationError\n    29→import httpx\n    30→from services.task_service import sync_job_gemini_url_to_user\n    31→from services import rectification_store\n    32→from services.tieban import service as tieban_service\n    33→from api.auth_routes import router as auth_router\n    34→from api.deps import get_current_auth\n    35→from api.user_routes import router as user_router\n    36→from api.session_routes import router as session_router\n    37→from api.chat_routes import router as chat_router\n    38→from api.bento_routes import router as bento_router\n    39→from api.dashboard_routes import router as dashboard_router\n    40→from api.bazi_routes import router as bazi_router\n    41→from api.kb_routes import router as kb_router\n    42→from api.plan_routes import router as plan_router\n    43→from api.report_routes import router as report_router\n    44→from api.push_routes import router as push_router\n    45→from api.twin_routes import router as twin_router\n    46→from api.agent_tool import router as agent_tool_router\n    47→from api.social_routes import router as social_router\n    48→from api.jitai_routes import router as jitai_router\n    49→from api.currency_routes import router as currency_router\n    50→from api.goal_routes import router as goal_router\n    51→from api.reflection_routes import router as reflection_router\n    52→from api.yunshi_routes import router as yunshi_router\n    53→from api.poster_routes import router as poster_router\n    54→from api.internal_routes import router as internal_router\n    55→\n    56→logger = get_logger(__name__)\n    57→\n    58→\n    59→def _patch_anyio_threading_for_tests() -> None:\n    60→    \"\"\"\n    61→    Work around threadpool hangs in the sandboxed test runtime.\n    62→\n    63→    FastAPI runs sync endpoints via `anyio.to_thread.run_sync()`. In this\n    64→    environment it can deadlock; for tests/stub mode we run sync callables inline.\n    65→    \"\"\"\n    66→    if os.getenv(\"STUB_DB\") != \"1\" and not os.getenv(\"PYTEST_CURRENT_TEST\"):\n    67→        return\n    68→\n    69→    try:\n    70→        import anyio.to_thread\n    71→\n    72→        async def _run_sync_inline(func, *args, **kwargs):  # type: ignore[no-untyped-def]\n    73→            kwargs.pop(\"abandon_on_cancel\", None)\n    74→            kwargs.pop(\"cancellable\", None)\n    75→            kwargs.pop(\"limiter\", None)\n    76→            return func(*args, **kwargs)\n    77→\n    78→        anyio.to_thread.run_sync = _run_sync_inline  # type: ignore[assignment]\n    79→    except Exception:\n    80→        return\n    81→\n    82→\n    83→_patch_anyio_threading_for_tests()\n    84→app = FastAPI(title=\"Fortune AI API\")\n    85→app.add_middleware(GZipMiddleware, minimum_size=1024)\n    86→\n    87→# CORS middleware for frontend (port 8231) accessing backend (port 8230)\n    88→app.add_middleware(\n    89→    CORSMiddleware,\n    90→    allow_origins=[\n    91→        \"http://106.37.170.238:8231\",\n    92→        \"http://localhost:8231\",\n    93→        \"http://127.0.0.1:8231\",\n    94→    ],\n    95→    allow_credentials=True,\n    96→    allow_methods=[\"*\"],\n    97→    allow_headers=[\"*\"],\n    98→)\n    99→\n   100→# Strong cache for static files to speed up repeat loads\n   101→@app.middleware(\"http\")\n   102→async def _static_cache_mw(request: Request, call_next):\n   103→    response = await call_next(request)\n   104→    try:\n   105→        path = request.url.path\n   106→        if path.startswith(\"/static/\"):\n   107→            # 1 year immutable cache; files are content-addressed by deploy hash only via manual bumps\n   108→            response.headers.setdefault(\"Cache-Control\", \"public, max-age=31536000, immutable\")\n   109→    except Exception:\n   110→        pass\n   111→    return response\n   112→app.mount(\"/static\", StaticFiles(directory=\"api/static\"), name=\"static\")\n   113→templates = Jinja2Templates(directory=\"api/templates\")\n   114→\n   115→app.include_router(auth_router)\n   116→app.include_router(user_router)\n   117→app.include_router(session_router)\n   118→app.include_router(chat_router)\n   119→app.include_router(bento_router)  # 保持向后兼容\n   120→app.include_router(dashboard_router)  # 新 Dashboard API（Zone B）\n   121→app.include_router(bazi_router)\n   122→app.include_router(kb_router)\n   123→app.include_router(plan_router)\n   124→app.include_router(report_router)\n   125→app.include_router(push_router)\n   126→app.include_router(twin_router)\n   127→app.include_router(agent_tool_router)\n   128→app.include_router(social_router)\n   129→app.include_router(jitai_router)\n   130→app.include_router(currency_router)\n   131→app.include_router(goal_router)\n   132→app.include_router(reflection_router)\n   133→app.include_router(yunshi_router)\n   134→app.include_router(poster_router)\n   135→app.include_router(internal_router)  # Internal APIs for Next.js Agent Runtime\n   136→\n   137→\n   138→class BaziRequest(BaseModel):\n   139→    name: str = Field(..., min_length=1)\n   140→    gender: str = Field(..., min_length=1)\n   141→    year: int\n   142→    month: int\n   143→    day: int\n   144→    hour: int\n   145→    minute: int\n   146→    longitude: Optional[float] = None\n   147→    latitude: Optional[float] = None\n   148→    location_name: Optional[str] = None\n   149→    system_prompt: Optional[str] = None\n   150→\n   151→    @validator(\"longitude\")\n   152→    def longitude_range(cls, v):\n   153→        if v is None:\n   154→            return v\n   155→        if v < -180 or v > 180:\n   156→            raise ValueError(\"longitude out of range\")\n   157→        return v\n   158→\n   159→\n   160→class AskRequest(BaseModel):\n   161→    \"\"\"Ask on Bazi (sync) request payload (REQ-003).\"\"\"\n   162→    name: str = Field(..., min_length=1)\n   163→    gender: str = Field(..., min_length=1)\n   164→    date: str = Field(..., description=\"YYYY-MM-DD\")\n   165→    time: str = Field(..., description=\"HH:MM[:SS]\")\n   166→    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n   167→    longitude: Optional[float] = None\n   168→    latitude: Optional[float] = None\n   169→    location_name: Optional[str] = None\n   170→    question: str = Field(\"\", description=\"User question text\")\n   171→    model: Optional[str] = Field(\"standard\", description=\"Model hint\")\n   172→\n   173→\n   174→class ChatMessage(BaseModel):\n   175→    role: str = Field(..., description=\"user|assistant\")\n   176→    text: str = Field(..., min_length=1)\n   177→\n   178→\n   179→class ChatAskRequest(BaseModel):\n   180→    name: Optional[str] = None\n   181→    session_id: Optional[str] = None\n   182→    system_prompt: Optional[str] = None\n   183→    messages: List[ChatMessage]\n   184→    model: Optional[str] = Field(\"standard\", description=\"Model hint\")\n   185→\n   186→\n   187→def _parse_date_time(date_str: str, time_str: str) -> Tuple[int, int, int, int, int]:\n   188→    \"\"\"Parse 'YYYY-MM-DD' and 'HH:MM[:SS]' into ints.\n   189→\n   190→    Returns: year, month, day, hour, minute\n   191→    \"\"\"\n   192→    try:\n   193→        y, m, d = [int(x) for x in date_str.split(\"-\")]\n   194→        parts = time_str.split(\":\")\n   195→        hh = int(parts[0]); mm = int(parts[1]);\n   196→        return y, m, d, hh, mm\n   197→    except Exception:\n   198→        raise HTTPException(status_code=400, detail=\"invalid_date_time\")\n   199→\n   200→\n   201→def _wuxing_counts(wuxing: Optional[str]) -> Dict[str, int]:\n   202→    counts = {\"金\": 0, \"木\": 0, \"水\": 0, \"火\": 0, \"土\": 0}\n   203→    if not wuxing:\n   204→        return counts\n   205→    for ch in counts:\n   206→        counts[ch] = wuxing.count(ch)\n   207→    return counts\n   208→\n   209→\n   210→def _build_chat_prompt(system_prompt: Optional[str], messages: List[ChatMessage]) -> str:\n   211→    lines: List[str] = []\n   212→    if system_prompt and system_prompt.strip():\n   213→        lines.append(system_prompt.strip())\n   214→    lines.append(\"【对话】\")\n   215→    for m in messages:\n   216→        role = \"用户\" if m.role == \"user\" else \"助手\"\n   217→        lines.append(f\"{role}: {m.text}\")\n   218→    lines.append(\"助手:\")\n   219→    return \"\\n\".join(lines)\n   220→\n   221→\n   222→def _latest_report_summary_for_user(name: str) -> Tuple[Optional[str], Optional[str]]:\n   223→    \"\"\"Find latest assistant text for a user name from local conversation logs.\n   224→\n   225→    Returns (summary_text, doc_url)\n   226→    \"\"\"\n   227→    try:\n   228→        from user_store import get_fortune_user_by_name\n   229→    except Exception:\n   230→        return None, None\n   231→    u = get_fortune_user_by_name(name)\n   232→    if not u or u.get(\"user_id\") is None:\n   233→        return None, None\n   234→    uid = int(u[\"user_id\"])  # type: ignore\n   235→    conv_dir = os.path.join(\"user\", str(uid), \"conversations\")\n   236→    if not os.path.isdir(conv_dir):\n   237→        return None, None\n   238→    latest_path = None\n   239→    latest_mtime = 0.0\n   240→    for fn in os.listdir(conv_dir):\n   241→        if not fn.endswith(\".jsonl\"):\n   242→            continue\n   243→        p = os.path.join(conv_dir, fn)\n   244→        try:\n   245→            mt = os.path.getmtime(p)\n   246→        except Exception:\n   247→            continue\n   248→        if mt > latest_mtime:\n   249→            latest_mtime = mt\n   250→            latest_path = p\n   251→    if not latest_path:\n   252→        return None, None\n   253→    last_text = None\n   254→    doc_url = None\n   255→    try:\n   256→        with open(latest_path, \"r\", encoding=\"utf-8\") as f:\n   257→            for line in f:\n   258→                line = line.strip()\n   259→                if not line:\n   260→                    continue\n   261→                try:\n   262→                    rec = json.loads(line)\n   263→                except Exception:\n   264→                    continue\n   265→                if rec.get(\"role\") == \"assistant\":\n   266→                    last_text = rec.get(\"content\") or last_text\n   267→                    if rec.get(\"doc_url\"):\n   268→                        doc_url = rec.get(\"doc_url\")\n   269→    except Exception:\n   270→        return None, None\n   271→    if not last_text:\n   272→        return None, None\n   273→    # 300–600 字摘要（简单截断作为占位）\n   274→    summary = str(last_text).strip()\n   275→    if len(summary) > 600:\n   276→        summary = summary[:600] + \"…\"\n   277→    return summary, doc_url\n   278→\n   279→\n   280→class AskRequest(BaseModel):\n   281→    \"\"\"Ask on Bazi (sync) request payload (REQ-003).\"\"\"\n   282→    name: str = Field(..., min_length=1)\n   283→    gender: str = Field(..., min_length=1)\n   284→    date: str = Field(..., description=\"YYYY-MM-DD\")\n   285→    time: str = Field(..., description=\"HH:MM[:SS]\")\n   286→    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n   287→    longitude: Optional[float] = None\n   288→    latitude: Optional[float] = None\n   289→    location_name: Optional[str] = None\n   290→    question: str = Field(\"\", description=\"User question text\")\n   291→    model: Optional[str] = Field(\"standard\", description=\"Model hint\")\n   292→\n   293→\n   294→class RectifyEvent(BaseModel):\n   295→    date: str\n   296→    type: str\n   297→    impact: Optional[str] = None\n   298→\n   299→\n   300→class RectifyRequest(BaseModel):\n   301→    name: str = Field(..., min_length=1)\n   302→    birthday: str = Field(..., description=\"YYYY-MM-DD\")\n   303→    latitude: Optional[float] = None\n   304→    longitude: Optional[float] = None\n   305→    window_start: str = Field(..., description=\"HH:MM or HH:MM:SS\")\n   306→    window_end: str = Field(..., description=\"HH:MM or HH:MM:SS\")\n   307→    events: list[RectifyEvent]\n   308→    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n   309→    debug: Optional[bool] = Field(False, description=\"Return debug breakdown when true\")\n   310→\n   311→\n   312→class SystemPromptSaveRequest(BaseModel):\n   313→    openid: str = Field(\"web\", description=\"User identifier for prompt history grouping\")\n   314→    text: str = Field(..., min_length=1, description=\"System prompt text\")\n   315→    model: Optional[str] = Field(\"standard\", description=\"Associated model suggestion\")\n   316→\n   317→class BaziAskRequest(BaseModel):\n   318→    question: str\n   319→    name: Optional[str] = None\n   320→    gender: Optional[str] = None\n   321→    date: Optional[str] = None\n   322→    time: Optional[str] = None\n   323→    tz_offset_hours: Optional[float] = 8.0\n   324→    location_name: Optional[str] = None\n   325→    longitude: Optional[float] = None\n   326→    latitude: Optional[float] = None\n   327→\n   328→\n   329→class TiebanInitRequest(BaseModel):\n   330→    name: str = Field(..., min_length=1)\n   331→    gender: str = Field(..., min_length=1)\n   332→    date: str = Field(..., description=\"YYYY-MM-DD\")\n   333→    time: str = Field(..., description=\"HH:MM or HH:MM:SS\")\n   334→    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n   335→    location_name: Optional[str] = None\n   336→    longitude: Optional[float] = None\n   337→    latitude: Optional[float] = None\n   338→    known_facts: Optional[Dict[str, Any]] = None\n   339→    ruleset_names: Optional[list[str]] = None\n   340→    debug: Optional[bool] = False\n   341→\n   342→\n   343→class TiebanVerifyRequest(BaseModel):\n   344→    run_id: str\n   345→    answers: Dict[str, Any]\n   346→    state_version: Optional[str] = None\n   347→\n   348→\n   349→class TiebanLockRequest(BaseModel):\n   350→    run_id: str\n   351→    state_version: Optional[str] = None\n   352→\n   353→\n   354→class TiebanSelectRequest(BaseModel):\n   355→    run_id: str\n   356→    candidate_id: str\n   357→    state_version: Optional[str] = None\n   358→\n   359→\n   360→def _persist_rectification_result(req: RectifyRequest, result, lat: float, lon: float) -> None:\n   361→    \"\"\"Best-effort persistence of rectification results to fortune_user.\"\"\"\n   362→    user_id: Optional[int] = None\n   363→    used_default_location = (req.latitude is None) or (req.longitude is None)\n   364→    try:\n   365→        user = get_fortune_user_by_name(req.name)\n   366→        if not user:\n   367→            bt_local = result.best_time_local\n   368→            bazi = calculate_bazi(\n   369→                bt_local.year,\n   370→                bt_local.month,\n   371→                bt_local.day,\n   372→                bt_local.hour,\n   373→                bt_local.minute,\n   374→                {\"longitude\": lon, \"latitude\": lat, \"name\": req.name},\n   375→            )\n   376→            base_url = os.getenv(\"GEMINI_BASE_URL\", \"https://gemini.local/user\")\n   377→            create_fortune_user(\n   378→                name=req.name,\n   379→                birthday=f\"{bt_local.year:04d}-{bt_local.month:02d}-{bt_local.day:02d} {bt_local.hour:02d}:{bt_local.minute:02d}:{bt_local.second:02d}\",\n   380→                location={\"longitude\": lon, \"latitude\": lat, \"name\": req.name},\n   381→                bazi_digest=f\"{bazi.year_pillar}-{bazi.month_pillar}-{bazi.day_pillar}-{bazi.hour_pillar}\",\n   382→                gemini_url=f\"{base_url}/{os.getenv('ENV','dev')}-{int(result.best_time_utc.timestamp())}\",\n   383→                notes=\"created by rectify\",\n   384→            )\n   385→            user = get_fortune_user_by_name(req.name)\n   386→        if user and user.get(\"user_id\") is not None:\n   387→            try:\n   388→                user_id = int(user[\"user_id\"])\n   389→            except Exception:\n   390→                user_id = None\n   391→    except Exception:\n   392→        user_id = None\n   393→\n   394→    # DB persistence (may fail if columns not yet migrated).\n   395→    try:\n   396→        update_fortune_user_rectification_by_name(\n   397→            name=req.name,\n   398→            rectified_time=result.best_time_utc.isoformat(),\n   399→            birth_window={\n   400→                \"start\": result.window_start_utc.isoformat(),\n   401→                \"end\": result.window_end_utc.isoformat(),\n   402→                \"start_local\": result.window_start_local.isoformat(),\n   403→                \"end_local\": result.window_end_local.isoformat(),\n   404→                \"tz_offset_hours\": req.tz_offset_hours or 8.0,\n   405→                \"step_seconds\": 30,\n   406→                \"location\": {\"longitude\": lon, \"latitude\": lat, \"used_default\": used_default_location},\n   407→            },\n   408→            life_events=[e.dict() for e in req.events],\n   409→        )\n   410→    except Exception as e:\n   411→        logger.warning(\"rectify persist db failed\", extra={\"operation\": \"rectify_persist_db\", \"error\": str(e)[:200]})\n   412→\n   413→    # Local persistence (always attempt) for audit/debug without exposing via API.\n   414→    if user_id is not None:\n   415→        try:\n   416→            req_payload = {\n   417→                \"birthday\": req.birthday,\n   418→                \"tz_offset_hours\": req.tz_offset_hours or 8.0,\n   419→                \"latitude\": lat,\n   420→                \"longitude\": lon,\n   421→                \"used_default_location\": used_default_location,\n   422→                \"window_start\": req.window_start,\n   423→                \"window_end\": req.window_end,\n   424→                \"events\": [e.dict() for e in req.events],\n   425→            }\n   426→            result_payload = _rectify_response_payload(result, received_events=req_payload[\"events\"])\n   427→            rec = rectification_store.make_rectification_record(name=req.name, req_payload=req_payload, result_payload=result_payload)\n   428→            rectification_store.save_rectification_run(user_id, rec)\n   429→        except Exception:\n   430→            return\n   431→\n   432→\n   433→def _rectify_response_payload(result, received_events: Optional[list] = None) -> Dict[str, Any]:\n   434→    payload: Dict[str, Any] = {\n   435→        \"status\": \"ok\",\n   436→        \"best_time\": result.best_time_utc.isoformat(),\n   437→        \"best_local_time\": result.best_time_local.isoformat(),\n   438→        \"candidates\": [\n   439→            {\n   440→                \"time\": c.time_utc.isoformat(),\n   441→                \"local_time\": c.time_local.isoformat(),\n   442→                \"score\": round(float(c.score), 3),\n   443→                **({\"breakdown\": c.breakdown} if c.breakdown is not None else {}),\n   444→            }\n   445→            for c in result.candidates\n   446→        ],\n   447→        \"window\": {\n   448→            \"start\": result.window_start_utc.isoformat(),\n   449→            \"end\": result.window_end_utc.isoformat(),\n   450→            \"start_local\": result.window_start_local.isoformat(),\n   451→            \"end_local\": result.window_end_local.isoformat(),\n   452→            \"location\": getattr(result, \"window_location\", None) or None,\n   453→        },\n   454→        \"used_swisseph\": result.used_swisseph,\n   455→    }\n   456→    if result.debug is not None:\n   457→        payload[\"debug\"] = result.debug\n   458→    if received_events is not None:\n   459→        payload[\"received_events\"] = received_events\n   460→    return payload\n   461→\n   462→\n   463→@app.on_event(\"startup\")\n   464→def startup():\n   465→    if os.getenv(\"STUB_DB\") == \"1\":\n   466→        return\n   467→    # 初始化保留给 gemini 后端；cli 后端无需池化\n   468→    if os.getenv(\"GEMINI_BACKEND\", \"gemini\").lower() != \"cli\":\n   469→        try:\n   470→            from integrations.gemini_repo import init_connection_pool\n   471→            init_connection_pool()\n   472→        except Exception:\n   473→            pass\n   474→\n   475→\n   476→@app.get(\"/healthz\")\n   477→def healthz():\n   478→    return {\"status\": \"ok\"}\n   479→\n   480→\n   481→@app.get(\"/\", include_in_schema=False)\n   482→def root_redirect():\n   483→    # Redirect root to /new frontend\n   484→    return RedirectResponse(url=\"/new\", status_code=307)\n   485→\n   486→\n   487→@app.get(\"/login\", response_class=HTMLResponse, include_in_schema=False)\n   488→def page_login(request: Request):\n   489→    # Redirect to new frontend login\n   490→    return RedirectResponse(url=\"/new/login\", status_code=307)\n   491→\n   492→\n   493→@app.get(\"/register\", response_class=HTMLResponse, include_in_schema=False)\n   494→def page_register(request: Request):\n   495→    # Redirect to new frontend register\n   496→    return RedirectResponse(url=\"/new/register\", status_code=307)\n   497→\n   498→\n   499→@app.get(\"/bazi\", response_class=HTMLResponse)\n   500→def page_bazi(request: Request):\n   501→    # 使用新版页面（视觉风格与 /tieban 对齐，复用 tieban.css）\n   502→    return templates.TemplateResponse(\"bazi.html\", {\"request\": request})\n   503→\n   504→\n   505→@app.get(\"/tieban\", response_class=HTMLResponse)\n   506→def tieban_page(request: Request):\n   507→    asset_version = os.getenv(\"ASSET_VER\") or str(int(time.time() // 3600))\n   508→    return templates.TemplateResponse(\"tieban.html\", {\"request\": request, \"asset_version\": asset_version})\n   509→\n   510→@app.get(\"/bazi2\", response_class=HTMLResponse)\n   511→def bazi2_page(request: Request):\n   512→    # 兼容旧链接：跳转到 /new\n   513→    return RedirectResponse(url=\"/new\", status_code=307)\n   514→\n   515→@app.get(\"/main\", response_class=HTMLResponse)\n   516→def bazi_main_page(request: Request):\n   517→    \"\"\"Legacy /main page - redirect to /new frontend.\"\"\"\n   518→    # Redirect to new frontend\n   519→    return RedirectResponse(url=\"/new\", status_code=307)\n   520→\n   521→\n   522→@app.get(\"/zone-b\")\n   523→@app.get(\"/dashboard\")\n   524→def page_dashboard():\n   525→    \"\"\"Zone B Dashboard → 重定向到新前端 /new\"\"\"\n   526→    from fastapi.responses import RedirectResponse\n   527→    return RedirectResponse(url=\"/new\", status_code=307)\n   528→\n   529→\n   530→# ------------------------------ Ask on Bazi (sync + SSE) ------------------------------\n   531→\n   532→\n   533→@app.post(\"/api/bazi/ask\")\n   534→def api_bazi_ask(req: AskRequest):\n   535→    \"\"\"Synchronous Ask endpoint (REQ-003).\"\"\"\n   536→    audit_id = str(uuid4())\n   537→    try:\n   538→        y, m, d, hh, mm = _parse_date_time(req.date, req.time)\n   539→        bazi = calculate_bazi(\n   540→            y, m, d, hh, mm,\n   541→            {\"longitude\": req.longitude or DEFAULT_LOCATION[\"longitude\"],\n   542→             \"latitude\": req.latitude or DEFAULT_LOCATION[\"latitude\"],\n   543→             \"name\": req.location_name or DEFAULT_LOCATION.get(\"name\", \"\")},\n   544→        )\n   545→        counts = _wuxing_counts(bazi.wuxing)\n   546→        report_summary, doc_url = _latest_report_summary_for_user(req.name)\n   547→\n   548→        # Build structured markdown per spec\n   549→        lines = []\n   550→        lines.append(\"### 结论要点\")\n   551→        trend = \", \".join([f\"{k}{v}\" for k, v in counts.items() if v > 0]) or \"暂无\"\n   552→        lines.append(f\"- 五行倾向：{trend}\")\n   553→        lines.append(\"- 近期关注：事业/健康/情绪（结合个人上下文自检）\")\n   554→        lines.append(\"\")\n   555→        lines.append(\"### 依据与引用\")\n   556→        lines.append(f\"- 四柱：{bazi.year_pillar}・{bazi.month_pillar}・{bazi.day_pillar}・{bazi.hour_pillar}\")\n   557→        lines.append(f\"- 五行：{bazi.wuxing or '未知'}\")\n   558→        if report_summary:\n   559→            lines.append(\"- 历史报告摘要：\")\n   560→            lines.append(report_summary)\n   561→        else:\n   562→            lines.append(\"- 历史报告：未找到，已仅基于八字作答\")\n   563→        lines.append(\"\")\n   564→        lines.append(\"### 不确定性与下一步\")\n   565→        lines.append(\"- 若存在校准结果，请补充校准时间以提升准确度。\")\n   566→        lines.append(\"- 可提供近三年关键事件以获得更个性化建议。\")\n   567→\n   568→        answer_md = \"\\n\".join(lines)\n   569→\n   570→        # Best-effort: append conversation snapshot to local logs\n   571→        try:\n   572→            u = get_fortune_user_by_name(req.name)\n   573→            user_id = int(u.get(\"user_id\")) if u and u.get(\"user_id\") is not None else None\n   574→        except Exception:\n   575→            user_id = None\n   576→        try:\n   577→            if user_id is not None:\n   578→                session_id = int(time.time())\n   579→                if req.question:\n   580→                    append_prompt(user_id, session_id, req.question, req.model or \"standard\")\n   581→                append_output(user_id, session_id, answer_md, url=doc_url)\n   582→        except Exception:\n   583→            pass\n   584→\n   585→        return {\n   586→            \"status\": \"ok\",\n   587→            \"answer_md\": answer_md,\n   588→            \"used_context\": {\n   589→                \"bazi_used\": {\n   590→                    \"year_pillar\": bazi.year_pillar,\n   591→                    \"month_pillar\": bazi.month_pillar,\n   592→                    \"day_pillar\": bazi.day_pillar,\n   593→                    \"hour_pillar\": bazi.hour_pillar,\n   594→                    \"wuxing\": bazi.wuxing,\n   595→                    \"counts\": counts,\n   596→                },\n   597→                \"report_used\": bool(report_summary),\n   598→                \"doc_url\": doc_url,\n   599→            },\n   600→            \"audit_id\": audit_id,\n   601→        }\n   602→    except HTTPException:\n   603→        raise\n   604→    except Exception as e:\n   605→        logger.error(\"ask sync failed\", extra={\"operation\": \"bazi_ask_sync\", \"error\": str(e), \"audit_id\": audit_id})\n   606→        raise HTTPException(status_code=500, detail=\"ask_failed\")\n   607→\n   608→\n   609→@app.get(\"/api/bazi/ask/stream\")\n   610→def api_bazi_ask_stream(\n   611→    name: str,\n   612→    gender: str,\n   613→    date: str,\n   614→    time: str,\n   615→    tz_offset_hours: float = 8.0,\n   616→    longitude: Optional[float] = None,\n   617→    latitude: Optional[float] = None,\n   618→    location_name: Optional[str] = None,\n   619→    question: str = \"\",\n   620→    model: str = \"standard\",\n   621→):\n   622→    audit_id = str(uuid4())\n   623→\n   624→    def _sse(obj: Dict[str, Any]) -> bytes:\n   625→        return (f\"data: {json.dumps(obj, ensure_ascii=False)}\\n\\n\").encode(\"utf-8\")\n   626→\n   627→    def _gen():\n   628→        try:\n   629→            y, m, d, hh, mm = _parse_date_time(date, time)\n   630→            bazi = calculate_bazi(\n   631→                y, m, d, hh, mm,\n   632→                {\"longitude\": longitude or DEFAULT_LOCATION[\"longitude\"],\n   633→                 \"latitude\": latitude or DEFAULT_LOCATION[\"latitude\"],\n   634→                 \"name\": location_name or DEFAULT_LOCATION.get(\"name\", \"\")},\n   635→            )\n   636→            counts = _wuxing_counts(bazi.wuxing)\n   637→            report_summary, _doc_url = _latest_report_summary_for_user(name)\n   638→\n   639→            chunks = [\n   640→                {\"type\": \"chunk\", \"text\": \"### 结论要点\\n\"},\n   641→                {\"type\": \"chunk\", \"text\": f\"- 五行倾向：{', '.join([f'{k}{v}' for k,v in counts.items() if v>0]) or '暂无'}\\n\"},\n   642→                {\"type\": \"chunk\", \"text\": \"\\n### 依据与引用\\n\"},\n   643→                {\"type\": \"chunk\", \"text\": f\"- 四柱：{bazi.year_pillar}・{bazi.month_pillar}・{bazi.day_pillar}・{bazi.hour_pillar}\\n\"},\n   644→                {\"type\": \"chunk\", \"text\": f\"- 五行：{bazi.wuxing or '未知'}\\n\"},\n   645→            ]\n   646→            if report_summary:\n   647→                chunks.append({\"type\": \"chunk\", \"text\": \"- 历史报告摘要：\\n\" + report_summary + \"\\n\"})\n   648→            else:\n   649→                chunks.append({\"type\": \"chunk\", \"text\": \"- 历史报告：未找到，已仅基于八字作答\\n\"})\n   650→            chunks.extend([\n   651→                {\"type\": \"chunk\", \"text\": \"\\n### 不确定性与下一步\\n\"},\n   652→                {\"type\": \"chunk\", \"text\": \"- 若存在校准结果，请补充校准时间以提升准确度。\\n\"},\n   653→                {\"type\": \"chunk\", \"text\": \"- 可提供近三年关键事件以获得更个性化建议。\\n\"},\n   654→            ])\n   655→\n   656→            for c in chunks:\n   657→                yield _sse({**c, \"audit_id\": audit_id})\n   658→                time.sleep(0.05)\n   659→\n   660→            yield _sse({\n   661→                \"type\": \"done\",\n   662→                \"audit_id\": audit_id,\n   663→            })\n   664→        except Exception as e:\n   665→            logger.error(\"ask stream failed\", extra={\"operation\": \"bazi_ask_stream\", \"error\": str(e), \"audit_id\": audit_id})\n   666→            yield _sse({\"type\": \"error\", \"detail\": \"ask_failed\", \"audit_id\": audit_id})\n   667→\n   668→    return StreamingResponse(\n   669→        _gen(),\n   670→        media_type=\"text/event-stream\",\n   671→        headers={\"Cache-Control\": \"no-cache\", \"X-Accel-Buffering\": \"no\"},\n   672→    )\n   673→\n   674→\n   675→@app.get(\"/h5/a2ui\", response_class=HTMLResponse)\n   676→def h5_a2ui(request: Request):\n   677→    # Legacy page - redirect to new frontend\n   678→    return RedirectResponse(url=\"/new\", status_code=307)\n   679→\n   680→\n   681→@app.get(\"/fortune\", response_class=HTMLResponse)\n   682→def fortune(request: Request):\n   683→    \"\"\"Legacy page - redirect to new frontend.\"\"\"\n   684→    return RedirectResponse(url=\"/new\", status_code=307)\n   685→\n   686→\n   687→@app.get(\"/api/system-prompts\")\n   688→def api_system_prompts(openid: str = \"web\"):\n   689→    # Legacy API - disabled for security\n   690→    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n   691→\n   692→\n   693→@app.post(\"/api/system-prompts\")\n   694→def api_save_system_prompt(req: SystemPromptSaveRequest):\n   695→    # Legacy API - disabled for security\n   696→    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n   697→\n   698→\n   699→@app.post(\"/api/tieban/init\")\n   700→def api_tieban_init(req: TiebanInitRequest):\n   701→    try:\n   702→        payload = req.dict()\n   703→        result = tieban_service.init_tieban(payload)\n   704→        return result\n   705→    except Exception as e:\n   706→        logger.error(\"tieban init failed\", extra={\"operation\": \"tieban_init\", \"error\": str(e)[:200]})\n   707→        raise HTTPException(status_code=500, detail=\"tieban_init_error\")\n   708→\n   709→\n   710→@app.post(\"/api/tieban/verify\")\n   711→def api_tieban_verify(req: TiebanVerifyRequest):\n   712→    try:\n   713→        result = tieban_service.verify_tieban(req.run_id, req.answers, req.state_version)\n   714→        return result\n   715→    except Exception as e:\n   716→        if str(e) == \"state_version_conflict\":\n   717→            raise HTTPException(status_code=409, detail=\"state_version_conflict\")\n   718→        logger.error(\"tieban verify failed\", extra={\"operation\": \"tieban_verify\", \"error\": str(e)[:200]})\n   719→        raise HTTPException(status_code=500, detail=\"tieban_verify_error\")\n   720→\n   721→\n   722→@app.post(\"/api/tieban/select\")\n   723→def api_tieban_select(req: TiebanSelectRequest):\n   724→    try:\n   725→        result = tieban_service.select_tieban(req.run_id, req.candidate_id, req.state_version)\n   726→        return result\n   727→    except Exception as e:\n   728→        if str(e) == \"state_version_conflict\":\n   729→            raise HTTPException(status_code=409, detail=\"state_version_conflict\")\n   730→        if str(e) in (\"missing_required_facts\", \"required_fact_not_matched\", \"candidate_not_found\"):\n   731→            raise HTTPException(status_code=400, detail=str(e))\n   732→        logger.error(\"tieban select failed\", extra={\"operation\": \"tieban_select\", \"error\": str(e)[:200]})\n   733→        raise HTTPException(status_code=500, detail=\"tieban_select_error\")\n   734→\n   735→\n   736→@app.post(\"/api/tieban/lock\")\n   737→def api_tieban_lock(req: TiebanLockRequest):\n   738→    try:\n   739→        result = tieban_service.lock_tieban(req.run_id, req.state_version)\n   740→        return result\n   741→    except Exception as e:\n   742→        if str(e) == \"state_version_conflict\":\n   743→            raise HTTPException(status_code=409, detail=\"state_version_conflict\")\n   744→        if str(e) == \"deprecated_use_select\":\n   745→            raise HTTPException(status_code=400, detail=\"deprecated_use_select\")\n   746→        logger.error(\"tieban lock failed\", extra={\"operation\": \"tieban_lock\", \"error\": str(e)[:200]})\n   747→        raise HTTPException(status_code=500, detail=\"tieban_lock_error\")\n   748→\n   749→\n   750→@app.get(\"/api/tieban/report\")\n   751→def api_tieban_report(run_id: str):\n   752→    try:\n   753→        return tieban_service.get_report(run_id)\n   754→    except Exception as e:\n   755→        logger.error(\"tieban report failed\", extra={\"operation\": \"tieban_report\", \"error\": str(e)[:200]})\n   756→        raise HTTPException(status_code=404, detail=\"tieban_report_error\")\n   757→\n   758→\n   759→@app.post(\"/api/calculate\")\n   760→def create_report(req: BaziRequest, backend: str | None = None):\n   761→    # Legacy API - deprecated, use authenticated /api/chat endpoints instead\n   762→    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n   763→    correlation_id = str(uuid4())\n   764→    try:\n   765→        # 先计算八字命盘并即时返回；后台另起 v2 任务走“standard”模型\n   766→        base = req.dict()\n   767→        from time import time as _now\n   768→        job_id, user_id, used_default, bazi = task_service.submit_bazi_task_v2(\n   769→            {\n   770→                \"openid\": \"web\",\n   771→                \"src\": \"web\",\n   772→                \"model\": \"standard\",\n   773→                **base,\n   774→            },\n   775→            correlation_id=correlation_id,\n   776→            backend_hint=backend,\n   777→            force_nonce=str(int(_now())),\n   778→        )\n   779→        try:\n   780→            if req.system_prompt:\n   781→                prompt_store.append_for_openid(\"web\", req.system_prompt, \"standard\")\n   782→        except Exception:\n   783→            pass\n   784→        return {\n   785→            \"job_id\": job_id,\n   786→            \"user_id\": user_id,\n   787→            \"status\": \"processing\",\n   788→            \"used_default_location\": used_default,\n   789→            \"default_location\": DEFAULT_LOCATION if used_default else None,\n   790→            \"bazi\": {\n   791→                \"year_pillar\": bazi.year_pillar,\n   792→                \"month_pillar\": bazi.month_pillar,\n   793→                \"day_pillar\": bazi.day_pillar,\n   794→                \"hour_pillar\": bazi.hour_pillar,\n   795→                \"wuxing\": bazi.wuxing,\n   796→                \"location\": bazi.location,\n   797→            },\n   798→        }\n   799→    except ValueError as ve:\n   800→        logger.warning(\"validation failed\", extra={\"operation\": \"api_calculate\", \"error\": str(ve), \"correlation_id\": correlation_id})\n   801→        raise HTTPException(status_code=400, detail=str(ve))\n   802→    except Exception as e:\n   803→        msg = str(e)\n   804→        logger.error(\"calculate failed\", extra={\"operation\": \"api_calculate\", \"error\": msg, \"correlation_id\": correlation_id})\n   805→        if msg in (\"empty_prompt\", \"no_tasks\", \"no_tasks_built\"):\n   806→            raise HTTPException(status_code=400, detail=msg)\n   807→        raise HTTPException(status_code=500, detail=\"internal_error\")\n   808→\n   809→\n   810→@app.get(\"/api/report/{job_id}\")\n   811→def get_report(job_id: int, backend: str | None = None):\n   812→    # Legacy API - deprecated, use authenticated /api/chat endpoints instead\n   813→    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n   814→    tasks = be.get_tasks_by_job_id(job_id, backend=backend)\n   815→    if not tasks:\n   816→        return {\"status\": \"error\", \"message\": \"no_tasks\"}\n   817→\n   818→    main_task = tasks[0]\n   819→    status_val = main_task.get(\"status\", 0)\n   820→    if status_val < 99:\n   821→        return {\"status\": \"processing\", \"progress\": status_val}\n   822→    if not main_task.get(\"output_text\") and not main_task.get(\"output_url\"):\n   823→        # For CLI backend, try expose the first inline file as a download link\n   824→        if (backend or os.getenv(\"GEMINI_BACKEND\", \"gemini\")).strip().lower() == \"cli\":\n   825→            try:\n   826→                from integrations.cli_worker_repo import list_output_files_by_job_id\n   827→                files = list_output_files_by_job_id(job_id)\n   828→                if files:\n   829→                    # choose the first file; if it has content, we can stream it via /api/files\n   830→                    dl = f\"/api/files/{job_id}?backend=cli\"\n   831→                    return {\"status\": \"completed\", \"content\": None, \"doc_url\": dl}\n   832→            except Exception:\n   833→                pass\n   834→        return {\"status\": \"error\", \"message\": \"task_missing_output\"}\n   835→\n   836→    content = main_task.get(\"output_text\")\n   837→    doc_url = main_task.get(\"output_url\")\n   838→    # persist conversation output if user is known\n   839→    try:\n   840→        uid = find_user_by_job(job_id)\n   841→        if uid is not None and (content or doc_url):\n   842→            append_output(uid, job_id, content or \"\", doc_url)\n   843→    except Exception:\n   844→        pass\n   845→\n   846→    # best-effort: sync gemini_url to fortune_user when job is done\n   847→    try:\n   848→        sync_job_gemini_url_to_user(job_id)\n   849→    except Exception:\n   850→        pass\n   851→\n   852→    return {\n   853→        \"status\": \"completed\",\n   854→        \"content\": content,\n   855→        \"doc_url\": doc_url,\n   856→    }\n   857→\n   858→\n   859→@app.post(\"/api/rectify\")\n   860→def api_rectify(req: RectifyRequest):\n   861→    try:\n   862→        # 对于未提供经纬度的情况，使用默认北京经纬度（与八字计算一致）\n   863→        lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n   864→        lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n   865→        result = rectify_birth_time_v2(\n   866→            name=req.name,\n   867→            birthday=req.birthday,\n   868→            lat=lat,\n   869→            lon=lon,\n   870→            window_start_hms=req.window_start,\n   871→            window_end_hms=req.window_end,\n   872→            events_raw=[e.dict() for e in req.events],\n   873→            tz_offset_hours=req.tz_offset_hours or 8.0,\n   874→            step_seconds=30,\n   875→            debug=bool(req.debug),\n   876→        )\n   877→        _persist_rectification_result(req, result, lat=lat, lon=lon)\n   878→        return _rectify_response_payload(result, received_events=[e.dict() for e in req.events])\n   879→    except Exception as e:\n   880→        logger.error(\"rectify failed\", extra={\"operation\": \"api_rectify\", \"error\": str(e)})\n   881→        raise HTTPException(status_code=400, detail=\"rectify_failed\")\n   882→\n   883→\n   884→@app.post(\"/api/rectify/stream\")\n   885→def api_rectify_stream(req: RectifyRequest):\n   886→    lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n   887→    lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n   888→    correlation_id = str(uuid4())\n   889→\n   890→    def _sse(obj: Dict[str, Any]) -> bytes:\n   891→        return (f\"data: {json.dumps(obj, ensure_ascii=False)}\\n\\n\").encode(\"utf-8\")\n   892→\n   893→    def _gen():\n   894→        try:\n   895→            received_events = [e.dict() for e in req.events]\n   896→            for msg in rectify_birth_time_v2_iter(\n   897→                name=req.name,\n   898→                birthday=req.birthday,\n   899→                lat=lat,\n   900→                lon=lon,\n   901→                window_start_hms=req.window_start,\n   902→                window_end_hms=req.window_end,\n   903→                events_raw=[e.dict() for e in req.events],\n   904→                tz_offset_hours=req.tz_offset_hours or 8.0,\n   905→                step_seconds=30,\n   906→                debug=bool(req.debug),\n   907→            ):\n   908→                if msg.get(\"type\") == \"result\":\n   909→                    result = msg[\"result\"]\n   910→                    _persist_rectification_result(req, result, lat=lat, lon=lon)\n   911→                    yield _sse({\"type\": \"done\", **_rectify_response_payload(result, received_events=received_events)})\n   912→                else:\n   913→                    out = dict(msg)\n   914→                    out.setdefault(\"correlation_id\", correlation_id)\n   915→                    yield _sse(out)\n   916→        except Exception as e:\n   917→            logger.error(\n   918→                \"rectify stream failed\",\n   919→                extra={\"operation\": \"api_rectify_stream\", \"error\": str(e), \"correlation_id\": correlation_id},\n   920→            )\n   921→            yield _sse({\"type\": \"error\", \"detail\": \"rectify_failed\", \"correlation_id\": correlation_id})\n   922→\n   923→    return StreamingResponse(\n   924→        _gen(),\n   925→        media_type=\"text/event-stream\",\n   926→        headers={\"Cache-Control\": \"no-cache\", \"X-Accel-Buffering\": \"no\"},\n   927→    )\n   928→\n   929→\n   930→# ------------------------------ v3 (interval + fuzzy distribution) ------------------------------\n   931→\n   932→\n   933→@app.post(\"/api/rectify/v3\")\n   934→def api_rectify_v3(req: RectifyRequest):\n   935→    try:\n   936→        lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n   937→        lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n   938→        result = rectification_v3.rectify_birth_time_v3(\n   939→            name=req.name,\n   940→            birthday=req.birthday,\n   941→            lat=lat,\n   942→            lon=lon,\n   943→            window_start_hms=req.window_start,\n   944→            window_end_hms=req.window_end,\n   945→            events_raw=[e.dict() for e in req.events],\n   946→            tz_offset_hours=req.tz_offset_hours or 8.0,\n   947→            step_seconds=30,\n   948→        )\n   949→        _persist_rectification_result(req, result, lat=lat, lon=lon)\n   950→        result[\"received_events\"] = [e.dict() for e in req.events]\n   951→        return result\n   952→    except Exception as e:\n   953→        logger.error(\"rectify v3 failed\", extra={\"operation\": \"api_rectify_v3\", \"error\": str(e)})\n   954→        raise HTTPException(status_code=400, detail=\"rectify_failed\")\n   955→\n   956→\n   957→@app.post(\"/api/rectify/v3/stream\")\n   958→def api_rectify_v3_stream(req: RectifyRequest):\n   959→    lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n   960→    lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n   961→    correlation_id = str(uuid4())\n   962→\n   963→    def _sse(obj: Dict[str, Any]) -> bytes:\n   964→        return (f\"data: {json.dumps(obj, ensure_ascii=False)}\\n\\n\").encode(\"utf-8\")\n   965→\n   966→    def _gen():\n   967→        try:\n   968→            received_events = [e.dict() for e in req.events]\n   969→            for msg in rectification_v3.rectify_birth_time_v3_iter(\n   970→                name=req.name,\n   971→                birthday=req.birthday,\n   972→                lat=lat,\n   973→                lon=lon,\n   974→                window_start_hms=req.window_start,\n   975→                window_end_hms=req.window_end,\n   976→                events_raw=received_events,\n   977→                tz_offset_hours=req.tz_offset_hours or 8.0,\n   978→                step_seconds=30,\n   979→            ):\n   980→                if msg.get(\"type\") == \"result\":\n   981→                    res = msg[\"result\"]\n   982→                    res[\"received_events\"] = received_events\n   983→                    _persist_rectification_result(req, res, lat=lat, lon=lon)\n   984→                    yield _sse({\"type\": \"done\", **res})\n   985→                else:\n   986→                    out = dict(msg)\n   987→                    out.setdefault(\"correlation_id\", correlation_id)\n   988→                    yield _sse(out)\n   989→        except Exception as e:\n   990→            logger.error(\n   991→                \"rectify v3 stream failed\",\n   992→                extra={\"operation\": \"api_rectify_v3_stream\", \"error\": str(e), \"correlation_id\": correlation_id},\n   993→            )\n   994→            yield _sse({\"type\": \"error\", \"detail\": \"rectify_failed\", \"correlation_id\": correlation_id})\n   995→\n   996→    return StreamingResponse(\n   997→        _gen(),\n   998→        media_type=\"text/event-stream\",\n   999→        headers={\"Cache-Control\": \"no-cache\", \"X-Accel-Buffering\": \"no\"},\n  1000→    )\n  1001→\n  1002→\n  1003→# ------------------------------\n  1004→# v2 API per docs/design v2.md\n  1005→# ------------------------------\n  1006→\n  1007→class V2SubmitBirthData(BaseModel):\n  1008→    name: str\n  1009→    gender: str\n  1010→    year: int\n  1011→    month: int\n  1012→    day: int\n  1013→    hour: int\n  1014→    minute: int\n  1015→    longitude: Optional[float] = None\n  1016→    latitude: Optional[float] = None\n  1017→    location_name: Optional[str] = None\n  1018→\n  1019→\n  1020→class V2SubmitRequest(BaseModel):\n  1021→    openid: str = Field(..., min_length=3)\n  1022→    src: str = Field(\"wechat\", description=\"来源渠道\")\n  1023→    model: str = Field(\"standard\", description=\"Gemini 模型：standard | deep_research\")\n  1024→    system_prompt: Optional[str] = Field(None, description=\"可选 system prompt，拼接在八字前作为提示\")\n  1025→    birth_data: V2SubmitBirthData\n  1026→\n  1027→\n  1028→@app.post(\"/api/v2/submit\")\n  1029→def v2_submit(req: V2SubmitRequest, backend: str | None = None):\n  1030→    # Legacy v2 API - deprecated, use authenticated /api/chat endpoints instead\n  1031→    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n  1032→    correlation_id = str(uuid4())\n  1033→    try:\n  1034→        if os.getenv(\"DEMO_MODE\") == \"1\":\n  1035→            # 极简演示：不依赖 DB，直接返回一个模拟 job_id\n  1036→            return {\n  1037→                \"job_id\": 101,\n  1038→                \"user_id\": 1,\n  1039→                \"status\": \"processing\",\n  1040→                \"eta_seconds\": 2,\n  1041→                \"used_default_location\": False,\n  1042→                \"default_location\": None,\n  1043→            }\n  1044→        # 为降低 CLI 后端的幂等去重概率，这里在 v2 提交强制注入一次性 nonce\n  1045→        from time import time as _now\n  1046→        job_id, user_id, used_default, bazi = task_service.submit_bazi_task_v2(\n  1047→            {\n  1048→                \"openid\": req.openid,\n  1049→                \"src\": req.src,\n  1050→                \"model\": req.model,\n  1051→                \"system_prompt\": req.system_prompt,\n  1052→                **req.birth_data.dict(),\n  1053→            },\n  1054→            correlation_id=correlation_id,\n  1055→            backend_hint=backend,\n  1056→            force_nonce=str(int(_now())),\n  1057→        )\n  1058→        # 记录 prompt 历史（本地 user/prompts/openid_xxx/prompts.json），不写 gemini 表\n  1059→        try:\n  1060→            if req.system_prompt:\n  1061→                prompt_store.append_for_openid(req.openid, req.system_prompt, req.model)\n  1062→        except Exception as _:\n  1063→            pass\n  1064→        return {\n  1065→            \"job_id\": job_id,\n  1066→            \"user_id\": user_id,\n  1067→            \"status\": \"processing\",\n  1068→            \"eta_seconds\": 120,\n  1069→            \"used_default_location\": used_default,\n  1070→            \"default_location\": DEFAULT_LOCATION if used_default else None,\n  1071→            \"bazi\": {\n  1072→                \"year_pillar\": bazi.year_pillar,\n  1073→                \"month_pillar\": bazi.month_pillar,\n  1074→                \"day_pillar\": bazi.day_pillar,\n  1075→                \"hour_pillar\": bazi.hour_pillar,\n  1076→                \"wuxing\": bazi.wuxing,\n  1077→                \"location\": bazi.location,\n  1078→            },\n  1079→        }\n  1080→    except ValueError as ve:\n  1081→        logger.warning(\"v2 submit validation failed\", extra={\"operation\": \"api_v2_submit\", \"error\": str(ve), \"correlation_id\": correlation_id})\n  1082→        raise HTTPException(status_code=400, detail=str(ve))\n  1083→    except Exception as e:\n  1084→        msg = str(e)\n  1085→        logger.error(\"v2 submit failed\", extra={\"operation\": \"api_v2_submit\", \"error\": msg, \"correlation_id\": correlation_id})\n  1086→        if msg in (\"empty_prompt\", \"no_tasks\", \"no_tasks_built\"):\n  1087→            raise HTTPException(status_code=400, detail=msg)\n  1088→        raise HTTPException(status_code=500, detail=\"internal_error\")\n  1089→\n  1090→\n  1091→@app.get(\"/api/v2/report/{job_id}\")\n  1092→def v2_report(job_id: int, backend: str | None = None) -> Dict[str, Any]:\n  1093→    # Legacy v2 API - deprecated, use authenticated /api/chat endpoints instead\n  1094→    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n  1095→    if os.getenv(\"DEMO_MODE\") == \"1\":\n  1096→        # 极简演示：不再返回写库示例，仅提示处理中\n  1097→        return {\"status\": \"processing\", \"progress\": 0}\n  1098→\n  1099→    tasks = be.get_tasks_by_job_id(job_id, backend=backend)\n  1100→    if not tasks:\n  1101→        return {\"status\": \"error\", \"message\": \"no_tasks\"}\n  1102→\n  1103→    main_task = tasks[0]\n  1104→    status_val = int(main_task.get(\"status\", 0) or 0)\n  1105→    if status_val < 10:\n  1106→        return {\"status\": \"processing\", \"progress\": status_val}\n  1107→\n  1108→    output_text = main_task.get(\"output_text\")\n  1109→    output_url = main_task.get(\"output_url\")\n  1110→    if not output_text:\n  1111→        # 兼容仅有文档链接（output_url）而无内嵌文本的情况\n  1112→        if output_url:\n  1113→            # best-effort: persist conversation output (url only)\n  1114→            try:\n  1115→                uid = find_user_by_job(job_id)\n  1116→                if uid is not None:\n  1117→                    append_output(uid, job_id, \"\", output_url)\n  1118→            except Exception:\n  1119→                pass\n  1120→            # best-effort: sync gemini_url when job is done\n  1121→            try:\n  1122→                sync_job_gemini_url_to_user(job_id)\n  1123→            except Exception:\n  1124→                pass\n  1125→            # 返回可阅读的占位 A2UI（Markdown 组件 + 下载链接）\n  1126→            md = f\"报告已生成，但未返回内嵌文本。请点击下载文档：\\n\\n[下载报告]({output_url})\"\n  1127→            return {\"status\": \"completed\", \"a2ui_data\": {\"meta\": {\"summary\": \"报告已生成（文档链接）\"}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": md}]}}\n  1128→        return {\"status\": \"error\", \"message\": \"task_missing_output\"}\n  1129→\n  1130→    try:\n  1131→        import json\n  1132→\n  1133→        a2ui = json.loads(output_text)\n  1134→        validate_a2ui(a2ui)\n  1135→        # persist conversation output for v2 as well\n  1136→        try:\n  1137→            uid = find_user_by_job(job_id)\n  1138→            if uid is not None:\n  1139→                append_output(uid, job_id, output_text)\n  1140→        except Exception:\n  1141→            pass\n  1142→        # best-effort: sync gemini_url to fortune_user when job is done or parsable\n  1143→        try:\n  1144→            sync_job_gemini_url_to_user(job_id)\n  1145→        except Exception:\n  1146→            pass\n  1147→        return {\"status\": \"completed\", \"a2ui_data\": a2ui}\n  1148→    except ValidationError as ve:\n  1149→        # 若为合法 JSON 但不符合 A2UI，按 Markdown 文本回退\n  1150→        return {\"status\": \"completed\", \"a2ui_data\": {\"meta\": {\"summary\": \"模型返回非规范 A2UI，已按 Markdown 展示\"}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": output_text}]}}\n  1151→    except Exception:\n  1152→        # 非 JSON：按 Markdown 文本回退\n  1153→        return {\"status\": \"completed\", \"a2ui_data\": {\"meta\": {\"summary\": output_text[:60]}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": output_text}]}}\n  1154→\n  1155→\n  1156→# ------------------------------\n  1157→# Files API (CLI backend output streaming)\n  1158→# ------------------------------\n  1159→\n  1160→\n  1161→@app.get(\"/api/files/{job_id}\")\n  1162→def api_files(job_id: int, backend: str | None = None, filename: str | None = None):\n  1163→    # Legacy API - disabled for security, use authenticated endpoints\n  1164→    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n  1165→    b = (backend or os.getenv(\"GEMINI_BACKEND\", \"gemini\")).strip().lower()\n  1166→    if b != \"cli\":\n  1167→        raise HTTPException(status_code=400, detail=\"files_only_available_for_cli\")\n  1168→    try:\n  1169→        from integrations.cli_worker_repo import fetch_output_file_content, list_output_files_by_job_id\n  1170→        fname, content = fetch_output_file_content(job_id, filename)\n  1171→        if content is None:\n  1172→            # return a lightweight index for UX when nothing inline\n  1173→            files = list_output_files_by_job_id(job_id)\n  1174→            return {\"files\": files}\n  1175→        media = \"text/plain\"\n  1176→        # simple heuristic: .md/.txt → text/plain; otherwise octet-stream\n  1177→        if fname and (str(fname).endswith(\".md\") or str(fname).endswith(\".txt\")):\n  1178→            media = \"text/plain; charset=utf-8\"\n  1179→        headers = {\"Content-Disposition\": f\"inline; filename={fname or 'output.txt'}\"}\n  1180→        return StreamingResponse(iter([content]), media_type=media, headers=headers)\n  1181→    except HTTPException:\n  1182→        raise\n  1183→    except Exception as e:\n  1184→        logger.error(\"files endpoint failed\", extra={\"operation\": \"api_files\", \"error\": str(e)[:200]})\n  1185→        raise HTTPException(status_code=500, detail=\"files_error\")\n  1186→\n  1187→\n  1188→# ------------------------------\n  1189→# WeCom OAuth (Tencent Cloud friendly)\n  1190→# ------------------------------\n  1191→\n  1192→\n  1193→@app.get(\"/qy/oauth/redirect\")\n  1194→def qy_oauth_redirect():\n  1195→    corp_id = os.getenv(\"QY_CORP_ID\")\n  1196→    agent_id = os.getenv(\"QY_AGENT_ID\")\n  1197→    redirect_uri = os.getenv(\"QY_REDIRECT_URI\")\n  1198→    if not (corp_id and agent_id and redirect_uri):\n  1199→        raise HTTPException(status_code=500, detail=\"missing_qy_env\")\n  1200→    auth_url = (\n  1201→        \"https://open.weixin.qq.com/connect/oauth2/authorize?\"\n  1202→        + urllib.parse.urlencode(\n  1203→            {\n  1204→                \"appid\": corp_id,\n  1205→                \"redirect_uri\": redirect_uri,\n  1206→                \"response_type\": \"code\",\n  1207→                \"scope\": \"snsapi_base\",\n  1208→                \"state\": \"a2ui\",\n  1209→                \"agentid\": agent_id,\n  1210→            }\n  1211→        )\n  1212→        + \"#wechat_redirect\"\n  1213→    )\n  1214→    return {\"auth_url\": auth_url}\n  1215→\n  1216→\n  1217→@app.get(\"/qy/oauth/callback\")\n  1218→def qy_oauth_callback(code: str, request: Request):\n  1219→    corp_id = os.getenv(\"QY_CORP_ID\")\n  1220→    corp_secret = os.getenv(\"QY_CORP_SECRET\")\n  1221→    if not (corp_id and corp_secret):\n  1222→        raise HTTPException(status_code=500, detail=\"missing_qy_env\")\n  1223→\n  1224→    # 1) get access token\n  1225→    token_url = \"https://qyapi.weixin.qq.com/cgi-bin/gettoken\"\n  1226→    user_url = \"https://qyapi.weixin.qq.com/cgi-bin/auth/getuserinfo\"\n  1227→    with httpx.Client(timeout=10.0) as client:\n  1228→        r1 = client.get(token_url, params={\"corpid\": corp_id, \"corpsecret\": corp_secret})\n  1229→        r1.raise_for_status()\n  1230→        tok = r1.json()\n  1231→        access_token = tok.get(\"access_token\")\n  1232→        if not access_token:\n  1233→            raise HTTPException(status_code=502, detail=\"qy_token_error\")\n  1234→        r2 = client.get(user_url, params={\"access_token\": access_token, \"code\": code})\n  1235→        r2.raise_for_status()\n  1236→        info = r2.json()\n  1237→\n  1238→    userid = info.get(\"UserId\") or info.get(\"userid\") or info.get(\"external_userid\")\n  1239→    if not userid:\n  1240→        raise HTTPException(status_code=400, detail=\"qy_no_user\")\n  1241→\n  1242→    # Put userid in query and bounce to H5\n  1243→    h5_path = os.getenv(\"QY_H5_PATH\", \"/h5/a2ui\")\n  1244→    target = f\"{h5_path}?userid={urllib.parse.quote(userid)}\"\n  1245→    return templates.TemplateResponse(\n  1246→        \"redirect.html\",\n  1247→        {\"request\": request, \"target\": target},\n  1248→    )\n  1249→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"03795b7a-1cce-4fea-93ab-16d6696624f1","timestamp":"2026-01-01T15:29:30.321Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/api/main.py","content":"from fastapi import FastAPI, HTTPException, Request\nfrom fastapi.responses import HTMLResponse, StreamingResponse, RedirectResponse\nfrom starlette.middleware.gzip import GZipMiddleware\nfrom fastapi.middleware.cors import CORSMiddleware\nfrom fastapi.staticfiles import StaticFiles\nfrom fastapi.templating import Jinja2Templates\nfrom pydantic import BaseModel, Field, validator\nfrom typing import Optional, Dict, Any, Tuple, List\nfrom uuid import uuid4\nimport os\nimport urllib.parse\nimport json\nimport re\nimport time\nfrom datetime import datetime\n\nfrom common.logging import get_logger\nfrom services import task_service\nfrom services.rectification import rectify_birth_time_v2, rectify_birth_time_v2_iter\nfrom services import rectification_v3\nfrom user_store import update_fortune_user_rectification_by_name, get_fortune_user_by_name, create_fortune_user\nfrom services.bazi_engine import calculate_bazi\nfrom services.bazi_engine import DEFAULT_LOCATION\nfrom services import prompt_store\nimport os as _os\nfrom integrations import backend_router as be\nfrom services.conversation_store import append_output, append_prompt, find_user_by_job, save_job_index\nfrom common.a2ui import validate_a2ui, ValidationError\nimport httpx\nfrom services.task_service import sync_job_gemini_url_to_user\nfrom services import rectification_store\nfrom services.tieban import service as tieban_service\nfrom api.auth_routes import router as auth_router\nfrom api.deps import get_current_auth\nfrom api.user_routes import router as user_router\nfrom api.session_routes import router as session_router\nfrom api.chat_routes import router as chat_router\nfrom api.bento_routes import router as bento_router\nfrom api.dashboard_routes import router as dashboard_router\nfrom api.bazi_routes import router as bazi_router\nfrom api.kb_routes import router as kb_router\nfrom api.plan_routes import router as plan_router\nfrom api.report_routes import router as report_router\nfrom api.push_routes import router as push_router\nfrom api.twin_routes import router as twin_router\nfrom api.agent_tool import router as agent_tool_router\nfrom api.social_routes import router as social_router\nfrom api.jitai_routes import router as jitai_router\nfrom api.currency_routes import router as currency_router\nfrom api.goal_routes import router as goal_router\nfrom api.reflection_routes import router as reflection_router\nfrom api.yunshi_routes import router as yunshi_router\nfrom api.poster_routes import router as poster_router\nfrom api.internal_routes import router as internal_router\n\nlogger = get_logger(__name__)\n\n\ndef _patch_anyio_threading_for_tests() -> None:\n    \"\"\"\n    Work around threadpool hangs in the sandboxed test runtime.\n\n    FastAPI runs sync endpoints via `anyio.to_thread.run_sync()`. In this\n    environment it can deadlock; for tests/stub mode we run sync callables inline.\n    \"\"\"\n    if os.getenv(\"STUB_DB\") != \"1\" and not os.getenv(\"PYTEST_CURRENT_TEST\"):\n        return\n\n    try:\n        import anyio.to_thread\n\n        async def _run_sync_inline(func, *args, **kwargs):  # type: ignore[no-untyped-def]\n            kwargs.pop(\"abandon_on_cancel\", None)\n            kwargs.pop(\"cancellable\", None)\n            kwargs.pop(\"limiter\", None)\n            return func(*args, **kwargs)\n\n        anyio.to_thread.run_sync = _run_sync_inline  # type: ignore[assignment]\n    except Exception:\n        return\n\n\n_patch_anyio_threading_for_tests()\napp = FastAPI(title=\"Fortune AI API\")\napp.add_middleware(GZipMiddleware, minimum_size=1024)\n\n# CORS middleware for frontend (port 8231) accessing backend (port 8230)\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=[\n        \"http://106.37.170.238:8231\",\n        \"http://localhost:8231\",\n        \"http://127.0.0.1:8231\",\n    ],\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\n# Strong cache for static files to speed up repeat loads\n@app.middleware(\"http\")\nasync def _static_cache_mw(request: Request, call_next):\n    response = await call_next(request)\n    try:\n        path = request.url.path\n        if path.startswith(\"/static/\"):\n            # 1 year immutable cache; files are content-addressed by deploy hash only via manual bumps\n            response.headers.setdefault(\"Cache-Control\", \"public, max-age=31536000, immutable\")\n    except Exception:\n        pass\n    return response\napp.mount(\"/static\", StaticFiles(directory=\"api/static\"), name=\"static\")\ntemplates = Jinja2Templates(directory=\"api/templates\")\n\napp.include_router(auth_router)\napp.include_router(user_router)\napp.include_router(session_router)\napp.include_router(chat_router)\napp.include_router(bento_router)  # 保持向后兼容\napp.include_router(dashboard_router)  # 新 Dashboard API（Zone B）\napp.include_router(bazi_router)\napp.include_router(kb_router)\napp.include_router(plan_router)\napp.include_router(report_router)\napp.include_router(push_router)\napp.include_router(twin_router)\napp.include_router(agent_tool_router)\napp.include_router(social_router)\napp.include_router(jitai_router)\napp.include_router(currency_router)\napp.include_router(goal_router)\napp.include_router(reflection_router)\napp.include_router(yunshi_router)\napp.include_router(poster_router)\napp.include_router(internal_router)  # Internal APIs for Next.js Agent Runtime\n\n\nclass BaziRequest(BaseModel):\n    name: str = Field(..., min_length=1)\n    gender: str = Field(..., min_length=1)\n    year: int\n    month: int\n    day: int\n    hour: int\n    minute: int\n    longitude: Optional[float] = None\n    latitude: Optional[float] = None\n    location_name: Optional[str] = None\n    system_prompt: Optional[str] = None\n\n    @validator(\"longitude\")\n    def longitude_range(cls, v):\n        if v is None:\n            return v\n        if v < -180 or v > 180:\n            raise ValueError(\"longitude out of range\")\n        return v\n\n\nclass AskRequest(BaseModel):\n    \"\"\"Ask on Bazi (sync) request payload (REQ-003).\"\"\"\n    name: str = Field(..., min_length=1)\n    gender: str = Field(..., min_length=1)\n    date: str = Field(..., description=\"YYYY-MM-DD\")\n    time: str = Field(..., description=\"HH:MM[:SS]\")\n    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n    longitude: Optional[float] = None\n    latitude: Optional[float] = None\n    location_name: Optional[str] = None\n    question: str = Field(\"\", description=\"User question text\")\n    model: Optional[str] = Field(\"standard\", description=\"Model hint\")\n\n\nclass ChatMessage(BaseModel):\n    role: str = Field(..., description=\"user|assistant\")\n    text: str = Field(..., min_length=1)\n\n\nclass ChatAskRequest(BaseModel):\n    name: Optional[str] = None\n    session_id: Optional[str] = None\n    system_prompt: Optional[str] = None\n    messages: List[ChatMessage]\n    model: Optional[str] = Field(\"standard\", description=\"Model hint\")\n\n\ndef _parse_date_time(date_str: str, time_str: str) -> Tuple[int, int, int, int, int]:\n    \"\"\"Parse 'YYYY-MM-DD' and 'HH:MM[:SS]' into ints.\n\n    Returns: year, month, day, hour, minute\n    \"\"\"\n    try:\n        y, m, d = [int(x) for x in date_str.split(\"-\")]\n        parts = time_str.split(\":\")\n        hh = int(parts[0]); mm = int(parts[1]);\n        return y, m, d, hh, mm\n    except Exception:\n        raise HTTPException(status_code=400, detail=\"invalid_date_time\")\n\n\ndef _wuxing_counts(wuxing: Optional[str]) -> Dict[str, int]:\n    counts = {\"金\": 0, \"木\": 0, \"水\": 0, \"火\": 0, \"土\": 0}\n    if not wuxing:\n        return counts\n    for ch in counts:\n        counts[ch] = wuxing.count(ch)\n    return counts\n\n\ndef _build_chat_prompt(system_prompt: Optional[str], messages: List[ChatMessage]) -> str:\n    lines: List[str] = []\n    if system_prompt and system_prompt.strip():\n        lines.append(system_prompt.strip())\n    lines.append(\"【对话】\")\n    for m in messages:\n        role = \"用户\" if m.role == \"user\" else \"助手\"\n        lines.append(f\"{role}: {m.text}\")\n    lines.append(\"助手:\")\n    return \"\\n\".join(lines)\n\n\ndef _latest_report_summary_for_user(name: str) -> Tuple[Optional[str], Optional[str]]:\n    \"\"\"Find latest assistant text for a user name from local conversation logs.\n\n    Returns (summary_text, doc_url)\n    \"\"\"\n    try:\n        from user_store import get_fortune_user_by_name\n    except Exception:\n        return None, None\n    u = get_fortune_user_by_name(name)\n    if not u or u.get(\"user_id\") is None:\n        return None, None\n    uid = int(u[\"user_id\"])  # type: ignore\n    conv_dir = os.path.join(\"user\", str(uid), \"conversations\")\n    if not os.path.isdir(conv_dir):\n        return None, None\n    latest_path = None\n    latest_mtime = 0.0\n    for fn in os.listdir(conv_dir):\n        if not fn.endswith(\".jsonl\"):\n            continue\n        p = os.path.join(conv_dir, fn)\n        try:\n            mt = os.path.getmtime(p)\n        except Exception:\n            continue\n        if mt > latest_mtime:\n            latest_mtime = mt\n            latest_path = p\n    if not latest_path:\n        return None, None\n    last_text = None\n    doc_url = None\n    try:\n        with open(latest_path, \"r\", encoding=\"utf-8\") as f:\n            for line in f:\n                line = line.strip()\n                if not line:\n                    continue\n                try:\n                    rec = json.loads(line)\n                except Exception:\n                    continue\n                if rec.get(\"role\") == \"assistant\":\n                    last_text = rec.get(\"content\") or last_text\n                    if rec.get(\"doc_url\"):\n                        doc_url = rec.get(\"doc_url\")\n    except Exception:\n        return None, None\n    if not last_text:\n        return None, None\n    # 300–600 字摘要（简单截断作为占位）\n    summary = str(last_text).strip()\n    if len(summary) > 600:\n        summary = summary[:600] + \"…\"\n    return summary, doc_url\n\n\nclass AskRequest(BaseModel):\n    \"\"\"Ask on Bazi (sync) request payload (REQ-003).\"\"\"\n    name: str = Field(..., min_length=1)\n    gender: str = Field(..., min_length=1)\n    date: str = Field(..., description=\"YYYY-MM-DD\")\n    time: str = Field(..., description=\"HH:MM[:SS]\")\n    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n    longitude: Optional[float] = None\n    latitude: Optional[float] = None\n    location_name: Optional[str] = None\n    question: str = Field(\"\", description=\"User question text\")\n    model: Optional[str] = Field(\"standard\", description=\"Model hint\")\n\n\nclass RectifyEvent(BaseModel):\n    date: str\n    type: str\n    impact: Optional[str] = None\n\n\nclass RectifyRequest(BaseModel):\n    name: str = Field(..., min_length=1)\n    birthday: str = Field(..., description=\"YYYY-MM-DD\")\n    latitude: Optional[float] = None\n    longitude: Optional[float] = None\n    window_start: str = Field(..., description=\"HH:MM or HH:MM:SS\")\n    window_end: str = Field(..., description=\"HH:MM or HH:MM:SS\")\n    events: list[RectifyEvent]\n    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n    debug: Optional[bool] = Field(False, description=\"Return debug breakdown when true\")\n\n\nclass SystemPromptSaveRequest(BaseModel):\n    openid: str = Field(\"web\", description=\"User identifier for prompt history grouping\")\n    text: str = Field(..., min_length=1, description=\"System prompt text\")\n    model: Optional[str] = Field(\"standard\", description=\"Associated model suggestion\")\n\nclass BaziAskRequest(BaseModel):\n    question: str\n    name: Optional[str] = None\n    gender: Optional[str] = None\n    date: Optional[str] = None\n    time: Optional[str] = None\n    tz_offset_hours: Optional[float] = 8.0\n    location_name: Optional[str] = None\n    longitude: Optional[float] = None\n    latitude: Optional[float] = None\n\n\nclass TiebanInitRequest(BaseModel):\n    name: str = Field(..., min_length=1)\n    gender: str = Field(..., min_length=1)\n    date: str = Field(..., description=\"YYYY-MM-DD\")\n    time: str = Field(..., description=\"HH:MM or HH:MM:SS\")\n    tz_offset_hours: Optional[float] = Field(8.0, description=\"Local time offset from UTC in hours, default +8\")\n    location_name: Optional[str] = None\n    longitude: Optional[float] = None\n    latitude: Optional[float] = None\n    known_facts: Optional[Dict[str, Any]] = None\n    ruleset_names: Optional[list[str]] = None\n    debug: Optional[bool] = False\n\n\nclass TiebanVerifyRequest(BaseModel):\n    run_id: str\n    answers: Dict[str, Any]\n    state_version: Optional[str] = None\n\n\nclass TiebanLockRequest(BaseModel):\n    run_id: str\n    state_version: Optional[str] = None\n\n\nclass TiebanSelectRequest(BaseModel):\n    run_id: str\n    candidate_id: str\n    state_version: Optional[str] = None\n\n\ndef _persist_rectification_result(req: RectifyRequest, result, lat: float, lon: float) -> None:\n    \"\"\"Best-effort persistence of rectification results to fortune_user.\"\"\"\n    user_id: Optional[int] = None\n    used_default_location = (req.latitude is None) or (req.longitude is None)\n    try:\n        user = get_fortune_user_by_name(req.name)\n        if not user:\n            bt_local = result.best_time_local\n            bazi = calculate_bazi(\n                bt_local.year,\n                bt_local.month,\n                bt_local.day,\n                bt_local.hour,\n                bt_local.minute,\n                {\"longitude\": lon, \"latitude\": lat, \"name\": req.name},\n            )\n            base_url = os.getenv(\"GEMINI_BASE_URL\", \"https://gemini.local/user\")\n            create_fortune_user(\n                name=req.name,\n                birthday=f\"{bt_local.year:04d}-{bt_local.month:02d}-{bt_local.day:02d} {bt_local.hour:02d}:{bt_local.minute:02d}:{bt_local.second:02d}\",\n                location={\"longitude\": lon, \"latitude\": lat, \"name\": req.name},\n                bazi_digest=f\"{bazi.year_pillar}-{bazi.month_pillar}-{bazi.day_pillar}-{bazi.hour_pillar}\",\n                gemini_url=f\"{base_url}/{os.getenv('ENV','dev')}-{int(result.best_time_utc.timestamp())}\",\n                notes=\"created by rectify\",\n            )\n            user = get_fortune_user_by_name(req.name)\n        if user and user.get(\"user_id\") is not None:\n            try:\n                user_id = int(user[\"user_id\"])\n            except Exception:\n                user_id = None\n    except Exception:\n        user_id = None\n\n    # DB persistence (may fail if columns not yet migrated).\n    try:\n        update_fortune_user_rectification_by_name(\n            name=req.name,\n            rectified_time=result.best_time_utc.isoformat(),\n            birth_window={\n                \"start\": result.window_start_utc.isoformat(),\n                \"end\": result.window_end_utc.isoformat(),\n                \"start_local\": result.window_start_local.isoformat(),\n                \"end_local\": result.window_end_local.isoformat(),\n                \"tz_offset_hours\": req.tz_offset_hours or 8.0,\n                \"step_seconds\": 30,\n                \"location\": {\"longitude\": lon, \"latitude\": lat, \"used_default\": used_default_location},\n            },\n            life_events=[e.dict() for e in req.events],\n        )\n    except Exception as e:\n        logger.warning(\"rectify persist db failed\", extra={\"operation\": \"rectify_persist_db\", \"error\": str(e)[:200]})\n\n    # Local persistence (always attempt) for audit/debug without exposing via API.\n    if user_id is not None:\n        try:\n            req_payload = {\n                \"birthday\": req.birthday,\n                \"tz_offset_hours\": req.tz_offset_hours or 8.0,\n                \"latitude\": lat,\n                \"longitude\": lon,\n                \"used_default_location\": used_default_location,\n                \"window_start\": req.window_start,\n                \"window_end\": req.window_end,\n                \"events\": [e.dict() for e in req.events],\n            }\n            result_payload = _rectify_response_payload(result, received_events=req_payload[\"events\"])\n            rec = rectification_store.make_rectification_record(name=req.name, req_payload=req_payload, result_payload=result_payload)\n            rectification_store.save_rectification_run(user_id, rec)\n        except Exception:\n            return\n\n\ndef _rectify_response_payload(result, received_events: Optional[list] = None) -> Dict[str, Any]:\n    payload: Dict[str, Any] = {\n        \"status\": \"ok\",\n        \"best_time\": result.best_time_utc.isoformat(),\n        \"best_local_time\": result.best_time_local.isoformat(),\n        \"candidates\": [\n            {\n                \"time\": c.time_utc.isoformat(),\n                \"local_time\": c.time_local.isoformat(),\n                \"score\": round(float(c.score), 3),\n                **({\"breakdown\": c.breakdown} if c.breakdown is not None else {}),\n            }\n            for c in result.candidates\n        ],\n        \"window\": {\n            \"start\": result.window_start_utc.isoformat(),\n            \"end\": result.window_end_utc.isoformat(),\n            \"start_local\": result.window_start_local.isoformat(),\n            \"end_local\": result.window_end_local.isoformat(),\n            \"location\": getattr(result, \"window_location\", None) or None,\n        },\n        \"used_swisseph\": result.used_swisseph,\n    }\n    if result.debug is not None:\n        payload[\"debug\"] = result.debug\n    if received_events is not None:\n        payload[\"received_events\"] = received_events\n    return payload\n\n\n@app.on_event(\"startup\")\ndef startup():\n    if os.getenv(\"STUB_DB\") == \"1\":\n        return\n    # 初始化保留给 gemini 后端；cli 后端无需池化\n    if os.getenv(\"GEMINI_BACKEND\", \"gemini\").lower() != \"cli\":\n        try:\n            from integrations.gemini_repo import init_connection_pool\n            init_connection_pool()\n        except Exception:\n            pass\n\n\n@app.get(\"/healthz\")\ndef healthz():\n    return {\"status\": \"ok\"}\n\n\n@app.get(\"/\", include_in_schema=False)\ndef root_redirect():\n    # Redirect root to /new frontend\n    return RedirectResponse(url=\"/new\", status_code=307)\n\n\n@app.get(\"/login\", response_class=HTMLResponse, include_in_schema=False)\ndef page_login(request: Request):\n    # Redirect to new frontend login\n    return RedirectResponse(url=\"/new/login\", status_code=307)\n\n\n@app.get(\"/register\", response_class=HTMLResponse, include_in_schema=False)\ndef page_register(request: Request):\n    # Redirect to new frontend register\n    return RedirectResponse(url=\"/new/register\", status_code=307)\n\n\n@app.get(\"/bazi\", response_class=HTMLResponse)\ndef page_bazi(request: Request):\n    # 使用新版页面（视觉风格与 /tieban 对齐，复用 tieban.css）\n    return templates.TemplateResponse(\"bazi.html\", {\"request\": request})\n\n\n@app.get(\"/tieban\", response_class=HTMLResponse)\ndef tieban_page(request: Request):\n    asset_version = os.getenv(\"ASSET_VER\") or str(int(time.time() // 3600))\n    return templates.TemplateResponse(\"tieban.html\", {\"request\": request, \"asset_version\": asset_version})\n\n@app.get(\"/bazi2\", response_class=HTMLResponse)\ndef bazi2_page(request: Request):\n    # 兼容旧链接：跳转到 /new\n    return RedirectResponse(url=\"/new\", status_code=307)\n\n@app.get(\"/main\", response_class=HTMLResponse)\ndef bazi_main_page(request: Request):\n    \"\"\"Legacy /main page - redirect to /new frontend.\"\"\"\n    # Redirect to new frontend\n    return RedirectResponse(url=\"/new\", status_code=307)\n\n\n@app.get(\"/zone-b\")\n@app.get(\"/dashboard\")\ndef page_dashboard():\n    \"\"\"Zone B Dashboard → 重定向到新前端 /new\"\"\"\n    from fastapi.responses import RedirectResponse\n    return RedirectResponse(url=\"/new\", status_code=307)\n\n\n# ------------------------------ Ask on Bazi (sync + SSE) ------------------------------\n\n\n@app.post(\"/api/bazi/ask\")\ndef api_bazi_ask(req: AskRequest):\n    \"\"\"Synchronous Ask endpoint (REQ-003).\"\"\"\n    audit_id = str(uuid4())\n    try:\n        y, m, d, hh, mm = _parse_date_time(req.date, req.time)\n        bazi = calculate_bazi(\n            y, m, d, hh, mm,\n            {\"longitude\": req.longitude or DEFAULT_LOCATION[\"longitude\"],\n             \"latitude\": req.latitude or DEFAULT_LOCATION[\"latitude\"],\n             \"name\": req.location_name or DEFAULT_LOCATION.get(\"name\", \"\")},\n        )\n        counts = _wuxing_counts(bazi.wuxing)\n        report_summary, doc_url = _latest_report_summary_for_user(req.name)\n\n        # Build structured markdown per spec\n        lines = []\n        lines.append(\"### 结论要点\")\n        trend = \", \".join([f\"{k}{v}\" for k, v in counts.items() if v > 0]) or \"暂无\"\n        lines.append(f\"- 五行倾向：{trend}\")\n        lines.append(\"- 近期关注：事业/健康/情绪（结合个人上下文自检）\")\n        lines.append(\"\")\n        lines.append(\"### 依据与引用\")\n        lines.append(f\"- 四柱：{bazi.year_pillar}・{bazi.month_pillar}・{bazi.day_pillar}・{bazi.hour_pillar}\")\n        lines.append(f\"- 五行：{bazi.wuxing or '未知'}\")\n        if report_summary:\n            lines.append(\"- 历史报告摘要：\")\n            lines.append(report_summary)\n        else:\n            lines.append(\"- 历史报告：未找到，已仅基于八字作答\")\n        lines.append(\"\")\n        lines.append(\"### 不确定性与下一步\")\n        lines.append(\"- 若存在校准结果，请补充校准时间以提升准确度。\")\n        lines.append(\"- 可提供近三年关键事件以获得更个性化建议。\")\n\n        answer_md = \"\\n\".join(lines)\n\n        # Best-effort: append conversation snapshot to local logs\n        try:\n            u = get_fortune_user_by_name(req.name)\n            user_id = int(u.get(\"user_id\")) if u and u.get(\"user_id\") is not None else None\n        except Exception:\n            user_id = None\n        try:\n            if user_id is not None:\n                session_id = int(time.time())\n                if req.question:\n                    append_prompt(user_id, session_id, req.question, req.model or \"standard\")\n                append_output(user_id, session_id, answer_md, url=doc_url)\n        except Exception:\n            pass\n\n        return {\n            \"status\": \"ok\",\n            \"answer_md\": answer_md,\n            \"used_context\": {\n                \"bazi_used\": {\n                    \"year_pillar\": bazi.year_pillar,\n                    \"month_pillar\": bazi.month_pillar,\n                    \"day_pillar\": bazi.day_pillar,\n                    \"hour_pillar\": bazi.hour_pillar,\n                    \"wuxing\": bazi.wuxing,\n                    \"counts\": counts,\n                },\n                \"report_used\": bool(report_summary),\n                \"doc_url\": doc_url,\n            },\n            \"audit_id\": audit_id,\n        }\n    except HTTPException:\n        raise\n    except Exception as e:\n        logger.error(\"ask sync failed\", extra={\"operation\": \"bazi_ask_sync\", \"error\": str(e), \"audit_id\": audit_id})\n        raise HTTPException(status_code=500, detail=\"ask_failed\")\n\n\n@app.get(\"/api/bazi/ask/stream\")\ndef api_bazi_ask_stream(\n    name: str,\n    gender: str,\n    date: str,\n    time: str,\n    tz_offset_hours: float = 8.0,\n    longitude: Optional[float] = None,\n    latitude: Optional[float] = None,\n    location_name: Optional[str] = None,\n    question: str = \"\",\n    model: str = \"standard\",\n):\n    audit_id = str(uuid4())\n\n    def _sse(obj: Dict[str, Any]) -> bytes:\n        return (f\"data: {json.dumps(obj, ensure_ascii=False)}\\n\\n\").encode(\"utf-8\")\n\n    def _gen():\n        try:\n            y, m, d, hh, mm = _parse_date_time(date, time)\n            bazi = calculate_bazi(\n                y, m, d, hh, mm,\n                {\"longitude\": longitude or DEFAULT_LOCATION[\"longitude\"],\n                 \"latitude\": latitude or DEFAULT_LOCATION[\"latitude\"],\n                 \"name\": location_name or DEFAULT_LOCATION.get(\"name\", \"\")},\n            )\n            counts = _wuxing_counts(bazi.wuxing)\n            report_summary, _doc_url = _latest_report_summary_for_user(name)\n\n            chunks = [\n                {\"type\": \"chunk\", \"text\": \"### 结论要点\\n\"},\n                {\"type\": \"chunk\", \"text\": f\"- 五行倾向：{', '.join([f'{k}{v}' for k,v in counts.items() if v>0]) or '暂无'}\\n\"},\n                {\"type\": \"chunk\", \"text\": \"\\n### 依据与引用\\n\"},\n                {\"type\": \"chunk\", \"text\": f\"- 四柱：{bazi.year_pillar}・{bazi.month_pillar}・{bazi.day_pillar}・{bazi.hour_pillar}\\n\"},\n                {\"type\": \"chunk\", \"text\": f\"- 五行：{bazi.wuxing or '未知'}\\n\"},\n            ]\n            if report_summary:\n                chunks.append({\"type\": \"chunk\", \"text\": \"- 历史报告摘要：\\n\" + report_summary + \"\\n\"})\n            else:\n                chunks.append({\"type\": \"chunk\", \"text\": \"- 历史报告：未找到，已仅基于八字作答\\n\"})\n            chunks.extend([\n                {\"type\": \"chunk\", \"text\": \"\\n### 不确定性与下一步\\n\"},\n                {\"type\": \"chunk\", \"text\": \"- 若存在校准结果，请补充校准时间以提升准确度。\\n\"},\n                {\"type\": \"chunk\", \"text\": \"- 可提供近三年关键事件以获得更个性化建议。\\n\"},\n            ])\n\n            for c in chunks:\n                yield _sse({**c, \"audit_id\": audit_id})\n                time.sleep(0.05)\n\n            yield _sse({\n                \"type\": \"done\",\n                \"audit_id\": audit_id,\n            })\n        except Exception as e:\n            logger.error(\"ask stream failed\", extra={\"operation\": \"bazi_ask_stream\", \"error\": str(e), \"audit_id\": audit_id})\n            yield _sse({\"type\": \"error\", \"detail\": \"ask_failed\", \"audit_id\": audit_id})\n\n    return StreamingResponse(\n        _gen(),\n        media_type=\"text/event-stream\",\n        headers={\"Cache-Control\": \"no-cache\", \"X-Accel-Buffering\": \"no\"},\n    )\n\n\n@app.get(\"/h5/a2ui\", response_class=HTMLResponse)\ndef h5_a2ui(request: Request):\n    # Legacy page - redirect to new frontend\n    return RedirectResponse(url=\"/new\", status_code=307)\n\n\n@app.get(\"/fortune\", response_class=HTMLResponse)\ndef fortune(request: Request):\n    \"\"\"Legacy page - redirect to new frontend.\"\"\"\n    return RedirectResponse(url=\"/new\", status_code=307)\n\n\n@app.get(\"/api/system-prompts\")\ndef api_system_prompts(openid: str = \"web\"):\n    # Legacy API - disabled for security\n    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n\n\n@app.post(\"/api/system-prompts\")\ndef api_save_system_prompt(req: SystemPromptSaveRequest):\n    # Legacy API - disabled for security\n    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n\n\n@app.post(\"/api/tieban/init\")\ndef api_tieban_init(req: TiebanInitRequest):\n    try:\n        payload = req.dict()\n        result = tieban_service.init_tieban(payload)\n        return result\n    except Exception as e:\n        logger.error(\"tieban init failed\", extra={\"operation\": \"tieban_init\", \"error\": str(e)[:200]})\n        raise HTTPException(status_code=500, detail=\"tieban_init_error\")\n\n\n@app.post(\"/api/tieban/verify\")\ndef api_tieban_verify(req: TiebanVerifyRequest):\n    try:\n        result = tieban_service.verify_tieban(req.run_id, req.answers, req.state_version)\n        return result\n    except Exception as e:\n        if str(e) == \"state_version_conflict\":\n            raise HTTPException(status_code=409, detail=\"state_version_conflict\")\n        logger.error(\"tieban verify failed\", extra={\"operation\": \"tieban_verify\", \"error\": str(e)[:200]})\n        raise HTTPException(status_code=500, detail=\"tieban_verify_error\")\n\n\n@app.post(\"/api/tieban/select\")\ndef api_tieban_select(req: TiebanSelectRequest):\n    try:\n        result = tieban_service.select_tieban(req.run_id, req.candidate_id, req.state_version)\n        return result\n    except Exception as e:\n        if str(e) == \"state_version_conflict\":\n            raise HTTPException(status_code=409, detail=\"state_version_conflict\")\n        if str(e) in (\"missing_required_facts\", \"required_fact_not_matched\", \"candidate_not_found\"):\n            raise HTTPException(status_code=400, detail=str(e))\n        logger.error(\"tieban select failed\", extra={\"operation\": \"tieban_select\", \"error\": str(e)[:200]})\n        raise HTTPException(status_code=500, detail=\"tieban_select_error\")\n\n\n@app.post(\"/api/tieban/lock\")\ndef api_tieban_lock(req: TiebanLockRequest):\n    try:\n        result = tieban_service.lock_tieban(req.run_id, req.state_version)\n        return result\n    except Exception as e:\n        if str(e) == \"state_version_conflict\":\n            raise HTTPException(status_code=409, detail=\"state_version_conflict\")\n        if str(e) == \"deprecated_use_select\":\n            raise HTTPException(status_code=400, detail=\"deprecated_use_select\")\n        logger.error(\"tieban lock failed\", extra={\"operation\": \"tieban_lock\", \"error\": str(e)[:200]})\n        raise HTTPException(status_code=500, detail=\"tieban_lock_error\")\n\n\n@app.get(\"/api/tieban/report\")\ndef api_tieban_report(run_id: str):\n    try:\n        return tieban_service.get_report(run_id)\n    except Exception as e:\n        logger.error(\"tieban report failed\", extra={\"operation\": \"tieban_report\", \"error\": str(e)[:200]})\n        raise HTTPException(status_code=404, detail=\"tieban_report_error\")\n\n\n@app.post(\"/api/calculate\")\ndef create_report(req: BaziRequest, backend: str | None = None):\n    # Legacy API - deprecated, use authenticated /api/chat endpoints instead\n    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n    correlation_id = str(uuid4())\n    try:\n        # 先计算八字命盘并即时返回；后台另起 v2 任务走“standard”模型\n        base = req.dict()\n        from time import time as _now\n        job_id, user_id, used_default, bazi = task_service.submit_bazi_task_v2(\n            {\n                \"openid\": \"web\",\n                \"src\": \"web\",\n                \"model\": \"standard\",\n                **base,\n            },\n            correlation_id=correlation_id,\n            backend_hint=backend,\n            force_nonce=str(int(_now())),\n        )\n        try:\n            if req.system_prompt:\n                prompt_store.append_for_openid(\"web\", req.system_prompt, \"standard\")\n        except Exception:\n            pass\n        return {\n            \"job_id\": job_id,\n            \"user_id\": user_id,\n            \"status\": \"processing\",\n            \"used_default_location\": used_default,\n            \"default_location\": DEFAULT_LOCATION if used_default else None,\n            \"bazi\": {\n                \"year_pillar\": bazi.year_pillar,\n                \"month_pillar\": bazi.month_pillar,\n                \"day_pillar\": bazi.day_pillar,\n                \"hour_pillar\": bazi.hour_pillar,\n                \"wuxing\": bazi.wuxing,\n                \"location\": bazi.location,\n            },\n        }\n    except ValueError as ve:\n        logger.warning(\"validation failed\", extra={\"operation\": \"api_calculate\", \"error\": str(ve), \"correlation_id\": correlation_id})\n        raise HTTPException(status_code=400, detail=str(ve))\n    except Exception as e:\n        msg = str(e)\n        logger.error(\"calculate failed\", extra={\"operation\": \"api_calculate\", \"error\": msg, \"correlation_id\": correlation_id})\n        if msg in (\"empty_prompt\", \"no_tasks\", \"no_tasks_built\"):\n            raise HTTPException(status_code=400, detail=msg)\n        raise HTTPException(status_code=500, detail=\"internal_error\")\n\n\n@app.get(\"/api/report/{job_id}\")\ndef get_report(job_id: int, backend: str | None = None):\n    # Legacy API - deprecated, use authenticated /api/chat endpoints instead\n    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n    tasks = be.get_tasks_by_job_id(job_id, backend=backend)\n    if not tasks:\n        return {\"status\": \"error\", \"message\": \"no_tasks\"}\n\n    main_task = tasks[0]\n    status_val = main_task.get(\"status\", 0)\n    if status_val < 99:\n        return {\"status\": \"processing\", \"progress\": status_val}\n    if not main_task.get(\"output_text\") and not main_task.get(\"output_url\"):\n        # For CLI backend, try expose the first inline file as a download link\n        if (backend or os.getenv(\"GEMINI_BACKEND\", \"gemini\")).strip().lower() == \"cli\":\n            try:\n                from integrations.cli_worker_repo import list_output_files_by_job_id\n                files = list_output_files_by_job_id(job_id)\n                if files:\n                    # choose the first file; if it has content, we can stream it via /api/files\n                    dl = f\"/api/files/{job_id}?backend=cli\"\n                    return {\"status\": \"completed\", \"content\": None, \"doc_url\": dl}\n            except Exception:\n                pass\n        return {\"status\": \"error\", \"message\": \"task_missing_output\"}\n\n    content = main_task.get(\"output_text\")\n    doc_url = main_task.get(\"output_url\")\n    # persist conversation output if user is known\n    try:\n        uid = find_user_by_job(job_id)\n        if uid is not None and (content or doc_url):\n            append_output(uid, job_id, content or \"\", doc_url)\n    except Exception:\n        pass\n\n    # best-effort: sync gemini_url to fortune_user when job is done\n    try:\n        sync_job_gemini_url_to_user(job_id)\n    except Exception:\n        pass\n\n    return {\n        \"status\": \"completed\",\n        \"content\": content,\n        \"doc_url\": doc_url,\n    }\n\n\n@app.post(\"/api/rectify\")\ndef api_rectify(req: RectifyRequest):\n    try:\n        # 对于未提供经纬度的情况，使用默认北京经纬度（与八字计算一致）\n        lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n        lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n        result = rectify_birth_time_v2(\n            name=req.name,\n            birthday=req.birthday,\n            lat=lat,\n            lon=lon,\n            window_start_hms=req.window_start,\n            window_end_hms=req.window_end,\n            events_raw=[e.dict() for e in req.events],\n            tz_offset_hours=req.tz_offset_hours or 8.0,\n            step_seconds=30,\n            debug=bool(req.debug),\n        )\n        _persist_rectification_result(req, result, lat=lat, lon=lon)\n        return _rectify_response_payload(result, received_events=[e.dict() for e in req.events])\n    except Exception as e:\n        logger.error(\"rectify failed\", extra={\"operation\": \"api_rectify\", \"error\": str(e)})\n        raise HTTPException(status_code=400, detail=\"rectify_failed\")\n\n\n@app.post(\"/api/rectify/stream\")\ndef api_rectify_stream(req: RectifyRequest):\n    lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n    lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n    correlation_id = str(uuid4())\n\n    def _sse(obj: Dict[str, Any]) -> bytes:\n        return (f\"data: {json.dumps(obj, ensure_ascii=False)}\\n\\n\").encode(\"utf-8\")\n\n    def _gen():\n        try:\n            received_events = [e.dict() for e in req.events]\n            for msg in rectify_birth_time_v2_iter(\n                name=req.name,\n                birthday=req.birthday,\n                lat=lat,\n                lon=lon,\n                window_start_hms=req.window_start,\n                window_end_hms=req.window_end,\n                events_raw=[e.dict() for e in req.events],\n                tz_offset_hours=req.tz_offset_hours or 8.0,\n                step_seconds=30,\n                debug=bool(req.debug),\n            ):\n                if msg.get(\"type\") == \"result\":\n                    result = msg[\"result\"]\n                    _persist_rectification_result(req, result, lat=lat, lon=lon)\n                    yield _sse({\"type\": \"done\", **_rectify_response_payload(result, received_events=received_events)})\n                else:\n                    out = dict(msg)\n                    out.setdefault(\"correlation_id\", correlation_id)\n                    yield _sse(out)\n        except Exception as e:\n            logger.error(\n                \"rectify stream failed\",\n                extra={\"operation\": \"api_rectify_stream\", \"error\": str(e), \"correlation_id\": correlation_id},\n            )\n            yield _sse({\"type\": \"error\", \"detail\": \"rectify_failed\", \"correlation_id\": correlation_id})\n\n    return StreamingResponse(\n        _gen(),\n        media_type=\"text/event-stream\",\n        headers={\"Cache-Control\": \"no-cache\", \"X-Accel-Buffering\": \"no\"},\n    )\n\n\n# ------------------------------ v3 (interval + fuzzy distribution) ------------------------------\n\n\n@app.post(\"/api/rectify/v3\")\ndef api_rectify_v3(req: RectifyRequest):\n    try:\n        lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n        lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n        result = rectification_v3.rectify_birth_time_v3(\n            name=req.name,\n            birthday=req.birthday,\n            lat=lat,\n            lon=lon,\n            window_start_hms=req.window_start,\n            window_end_hms=req.window_end,\n            events_raw=[e.dict() for e in req.events],\n            tz_offset_hours=req.tz_offset_hours or 8.0,\n            step_seconds=30,\n        )\n        _persist_rectification_result(req, result, lat=lat, lon=lon)\n        result[\"received_events\"] = [e.dict() for e in req.events]\n        return result\n    except Exception as e:\n        logger.error(\"rectify v3 failed\", extra={\"operation\": \"api_rectify_v3\", \"error\": str(e)})\n        raise HTTPException(status_code=400, detail=\"rectify_failed\")\n\n\n@app.post(\"/api/rectify/v3/stream\")\ndef api_rectify_v3_stream(req: RectifyRequest):\n    lat = req.latitude if req.latitude is not None else DEFAULT_LOCATION[\"latitude\"]\n    lon = req.longitude if req.longitude is not None else DEFAULT_LOCATION[\"longitude\"]\n    correlation_id = str(uuid4())\n\n    def _sse(obj: Dict[str, Any]) -> bytes:\n        return (f\"data: {json.dumps(obj, ensure_ascii=False)}\\n\\n\").encode(\"utf-8\")\n\n    def _gen():\n        try:\n            received_events = [e.dict() for e in req.events]\n            for msg in rectification_v3.rectify_birth_time_v3_iter(\n                name=req.name,\n                birthday=req.birthday,\n                lat=lat,\n                lon=lon,\n                window_start_hms=req.window_start,\n                window_end_hms=req.window_end,\n                events_raw=received_events,\n                tz_offset_hours=req.tz_offset_hours or 8.0,\n                step_seconds=30,\n            ):\n                if msg.get(\"type\") == \"result\":\n                    res = msg[\"result\"]\n                    res[\"received_events\"] = received_events\n                    _persist_rectification_result(req, res, lat=lat, lon=lon)\n                    yield _sse({\"type\": \"done\", **res})\n                else:\n                    out = dict(msg)\n                    out.setdefault(\"correlation_id\", correlation_id)\n                    yield _sse(out)\n        except Exception as e:\n            logger.error(\n                \"rectify v3 stream failed\",\n                extra={\"operation\": \"api_rectify_v3_stream\", \"error\": str(e), \"correlation_id\": correlation_id},\n            )\n            yield _sse({\"type\": \"error\", \"detail\": \"rectify_failed\", \"correlation_id\": correlation_id})\n\n    return StreamingResponse(\n        _gen(),\n        media_type=\"text/event-stream\",\n        headers={\"Cache-Control\": \"no-cache\", \"X-Accel-Buffering\": \"no\"},\n    )\n\n\n# ------------------------------\n# v2 API per docs/design v2.md\n# ------------------------------\n\nclass V2SubmitBirthData(BaseModel):\n    name: str\n    gender: str\n    year: int\n    month: int\n    day: int\n    hour: int\n    minute: int\n    longitude: Optional[float] = None\n    latitude: Optional[float] = None\n    location_name: Optional[str] = None\n\n\nclass V2SubmitRequest(BaseModel):\n    openid: str = Field(..., min_length=3)\n    src: str = Field(\"wechat\", description=\"来源渠道\")\n    model: str = Field(\"standard\", description=\"Gemini 模型：standard | deep_research\")\n    system_prompt: Optional[str] = Field(None, description=\"可选 system prompt，拼接在八字前作为提示\")\n    birth_data: V2SubmitBirthData\n\n\n@app.post(\"/api/v2/submit\")\ndef v2_submit(req: V2SubmitRequest, backend: str | None = None):\n    # Legacy v2 API - deprecated, use authenticated /api/chat endpoints instead\n    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n    correlation_id = str(uuid4())\n    try:\n        if os.getenv(\"DEMO_MODE\") == \"1\":\n            # 极简演示：不依赖 DB，直接返回一个模拟 job_id\n            return {\n                \"job_id\": 101,\n                \"user_id\": 1,\n                \"status\": \"processing\",\n                \"eta_seconds\": 2,\n                \"used_default_location\": False,\n                \"default_location\": None,\n            }\n        # 为降低 CLI 后端的幂等去重概率，这里在 v2 提交强制注入一次性 nonce\n        from time import time as _now\n        job_id, user_id, used_default, bazi = task_service.submit_bazi_task_v2(\n            {\n                \"openid\": req.openid,\n                \"src\": req.src,\n                \"model\": req.model,\n                \"system_prompt\": req.system_prompt,\n                **req.birth_data.dict(),\n            },\n            correlation_id=correlation_id,\n            backend_hint=backend,\n            force_nonce=str(int(_now())),\n        )\n        # 记录 prompt 历史（本地 user/prompts/openid_xxx/prompts.json），不写 gemini 表\n        try:\n            if req.system_prompt:\n                prompt_store.append_for_openid(req.openid, req.system_prompt, req.model)\n        except Exception as _:\n            pass\n        return {\n            \"job_id\": job_id,\n            \"user_id\": user_id,\n            \"status\": \"processing\",\n            \"eta_seconds\": 120,\n            \"used_default_location\": used_default,\n            \"default_location\": DEFAULT_LOCATION if used_default else None,\n            \"bazi\": {\n                \"year_pillar\": bazi.year_pillar,\n                \"month_pillar\": bazi.month_pillar,\n                \"day_pillar\": bazi.day_pillar,\n                \"hour_pillar\": bazi.hour_pillar,\n                \"wuxing\": bazi.wuxing,\n                \"location\": bazi.location,\n            },\n        }\n    except ValueError as ve:\n        logger.warning(\"v2 submit validation failed\", extra={\"operation\": \"api_v2_submit\", \"error\": str(ve), \"correlation_id\": correlation_id})\n        raise HTTPException(status_code=400, detail=str(ve))\n    except Exception as e:\n        msg = str(e)\n        logger.error(\"v2 submit failed\", extra={\"operation\": \"api_v2_submit\", \"error\": msg, \"correlation_id\": correlation_id})\n        if msg in (\"empty_prompt\", \"no_tasks\", \"no_tasks_built\"):\n            raise HTTPException(status_code=400, detail=msg)\n        raise HTTPException(status_code=500, detail=\"internal_error\")\n\n\n@app.get(\"/api/v2/report/{job_id}\")\ndef v2_report(job_id: int, backend: str | None = None) -> Dict[str, Any]:\n    # Legacy v2 API - deprecated, use authenticated /api/chat endpoints instead\n    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n    if os.getenv(\"DEMO_MODE\") == \"1\":\n        # 极简演示：不再返回写库示例，仅提示处理中\n        return {\"status\": \"processing\", \"progress\": 0}\n\n    tasks = be.get_tasks_by_job_id(job_id, backend=backend)\n    if not tasks:\n        return {\"status\": \"error\", \"message\": \"no_tasks\"}\n\n    main_task = tasks[0]\n    status_val = int(main_task.get(\"status\", 0) or 0)\n    if status_val < 10:\n        return {\"status\": \"processing\", \"progress\": status_val}\n\n    output_text = main_task.get(\"output_text\")\n    output_url = main_task.get(\"output_url\")\n    if not output_text:\n        # 兼容仅有文档链接（output_url）而无内嵌文本的情况\n        if output_url:\n            # best-effort: persist conversation output (url only)\n            try:\n                uid = find_user_by_job(job_id)\n                if uid is not None:\n                    append_output(uid, job_id, \"\", output_url)\n            except Exception:\n                pass\n            # best-effort: sync gemini_url when job is done\n            try:\n                sync_job_gemini_url_to_user(job_id)\n            except Exception:\n                pass\n            # 返回可阅读的占位 A2UI（Markdown 组件 + 下载链接）\n            md = f\"报告已生成，但未返回内嵌文本。请点击下载文档：\\n\\n[下载报告]({output_url})\"\n            return {\"status\": \"completed\", \"a2ui_data\": {\"meta\": {\"summary\": \"报告已生成（文档链接）\"}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": md}]}}\n        return {\"status\": \"error\", \"message\": \"task_missing_output\"}\n\n    try:\n        import json\n\n        a2ui = json.loads(output_text)\n        validate_a2ui(a2ui)\n        # persist conversation output for v2 as well\n        try:\n            uid = find_user_by_job(job_id)\n            if uid is not None:\n                append_output(uid, job_id, output_text)\n        except Exception:\n            pass\n        # best-effort: sync gemini_url to fortune_user when job is done or parsable\n        try:\n            sync_job_gemini_url_to_user(job_id)\n        except Exception:\n            pass\n        return {\"status\": \"completed\", \"a2ui_data\": a2ui}\n    except ValidationError as ve:\n        # 若为合法 JSON 但不符合 A2UI，按 Markdown 文本回退\n        return {\"status\": \"completed\", \"a2ui_data\": {\"meta\": {\"summary\": \"模型返回非规范 A2UI，已按 Markdown 展示\"}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": output_text}]}}\n    except Exception:\n        # 非 JSON：按 Markdown 文本回退\n        return {\"status\": \"completed\", \"a2ui_data\": {\"meta\": {\"summary\": output_text[:60]}, \"ui_components\": [{\"type\": \"markdown_text\", \"title\": \"模型输出\", \"data\": output_text}]}}\n\n\n# ------------------------------\n# Files API (CLI backend output streaming)\n# ------------------------------\n\n\n@app.get(\"/api/files/{job_id}\")\ndef api_files(job_id: int, backend: str | None = None, filename: str | None = None):\n    # Legacy API - disabled for security, use authenticated endpoints\n    raise HTTPException(status_code=410, detail=\"deprecated_use_new_api\")\n    b = (backend or os.getenv(\"GEMINI_BACKEND\", \"gemini\")).strip().lower()\n    if b != \"cli\":\n        raise HTTPException(status_code=400, detail=\"files_only_available_for_cli\")\n    try:\n        from integrations.cli_worker_repo import fetch_output_file_content, list_output_files_by_job_id\n        fname, content = fetch_output_file_content(job_id, filename)\n        if content is None:\n            # return a lightweight index for UX when nothing inline\n            files = list_output_files_by_job_id(job_id)\n            return {\"files\": files}\n        media = \"text/plain\"\n        # simple heuristic: .md/.txt → text/plain; otherwise octet-stream\n        if fname and (str(fname).endswith(\".md\") or str(fname).endswith(\".txt\")):\n            media = \"text/plain; charset=utf-8\"\n        headers = {\"Content-Disposition\": f\"inline; filename={fname or 'output.txt'}\"}\n        return StreamingResponse(iter([content]), media_type=media, headers=headers)\n    except HTTPException:\n        raise\n    except Exception as e:\n        logger.error(\"files endpoint failed\", extra={\"operation\": \"api_files\", \"error\": str(e)[:200]})\n        raise HTTPException(status_code=500, detail=\"files_error\")\n\n\n# ------------------------------\n# WeCom OAuth (Tencent Cloud friendly)\n# ------------------------------\n\n\n@app.get(\"/qy/oauth/redirect\")\ndef qy_oauth_redirect():\n    corp_id = os.getenv(\"QY_CORP_ID\")\n    agent_id = os.getenv(\"QY_AGENT_ID\")\n    redirect_uri = os.getenv(\"QY_REDIRECT_URI\")\n    if not (corp_id and agent_id and redirect_uri):\n        raise HTTPException(status_code=500, detail=\"missing_qy_env\")\n    auth_url = (\n        \"https://open.weixin.qq.com/connect/oauth2/authorize?\"\n        + urllib.parse.urlencode(\n            {\n                \"appid\": corp_id,\n                \"redirect_uri\": redirect_uri,\n                \"response_type\": \"code\",\n                \"scope\": \"snsapi_base\",\n                \"state\": \"a2ui\",\n                \"agentid\": agent_id,\n            }\n        )\n        + \"#wechat_redirect\"\n    )\n    return {\"auth_url\": auth_url}\n\n\n@app.get(\"/qy/oauth/callback\")\ndef qy_oauth_callback(code: str, request: Request):\n    corp_id = os.getenv(\"QY_CORP_ID\")\n    corp_secret = os.getenv(\"QY_CORP_SECRET\")\n    if not (corp_id and corp_secret):\n        raise HTTPException(status_code=500, detail=\"missing_qy_env\")\n\n    # 1) get access token\n    token_url = \"https://qyapi.weixin.qq.com/cgi-bin/gettoken\"\n    user_url = \"https://qyapi.weixin.qq.com/cgi-bin/auth/getuserinfo\"\n    with httpx.Client(timeout=10.0) as client:\n        r1 = client.get(token_url, params={\"corpid\": corp_id, \"corpsecret\": corp_secret})\n        r1.raise_for_status()\n        tok = r1.json()\n        access_token = tok.get(\"access_token\")\n        if not access_token:\n            raise HTTPException(status_code=502, detail=\"qy_token_error\")\n        r2 = client.get(user_url, params={\"access_token\": access_token, \"code\": code})\n        r2.raise_for_status()\n        info = r2.json()\n\n    userid = info.get(\"UserId\") or info.get(\"userid\") or info.get(\"external_userid\")\n    if not userid:\n        raise HTTPException(status_code=400, detail=\"qy_no_user\")\n\n    # Put userid in query and bounce to H5\n    h5_path = os.getenv(\"QY_H5_PATH\", \"/h5/a2ui\")\n    target = f\"{h5_path}?userid={urllib.parse.quote(userid)}\"\n    return templates.TemplateResponse(\n        \"redirect.html\",\n        {\"request\": request, \"target\": target},\n    )\n","numLines":1249,"startLine":1,"totalLines":1249}}}
{"parentUuid":"03795b7a-1cce-4fea-93ab-16d6696624f1","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014Pvf7vZqZ6kWx4eSfnyHie","type":"message","role":"assistant","content":[{"type":"text","text":"The specification file wasn't found at that path. Let me search for it:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":67,"cache_creation_input_tokens":22896,"cache_read_input_tokens":21030,"cache_creation":{"ephemeral_5m_input_tokens":22896,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWgtwLaTUb5EWWHpq5kRR","type":"assistant","uuid":"96485a97-9352-4920-b2e4-5ca33e0c18d0","timestamp":"2026-01-01T15:29:33.594Z"}
{"parentUuid":"96485a97-9352-4920-b2e4-5ca33e0c18d0","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014Pvf7vZqZ6kWx4eSfnyHie","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012Cpqr3dYa6R1vgio2pHtPK","name":"Glob","input":{"pattern":"**/backend_refactoring_plan_v42.md","path":"/home/aiscend/work/fortune_ai"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":67,"cache_creation_input_tokens":22896,"cache_read_input_tokens":21030,"cache_creation":{"ephemeral_5m_input_tokens":22896,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWgtwLaTUb5EWWHpq5kRR","type":"assistant","uuid":"c3abaa2c-d500-46fb-bdaa-32829451387d","timestamp":"2026-01-01T15:29:33.877Z"}
{"parentUuid":"c3abaa2c-d500-46fb-bdaa-32829451387d","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_014Pvf7vZqZ6kWx4eSfnyHie","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018vyoMd8dGWhTqsXtqieYiH","name":"Glob","input":{"pattern":"**/*refactoring*plan*.md","path":"/home/aiscend/work/fortune_ai"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":67,"cache_creation_input_tokens":22896,"cache_read_input_tokens":21030,"cache_creation":{"ephemeral_5m_input_tokens":22896,"ephemeral_1h_input_tokens":0},"output_tokens":181,"service_tier":"standard"}},"requestId":"req_011CWgtwLaTUb5EWWHpq5kRR","type":"assistant","uuid":"07537623-46ad-4592-91a1-b39606daf120","timestamp":"2026-01-01T15:29:34.875Z"}
{"parentUuid":"07537623-46ad-4592-91a1-b39606daf120","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012Cpqr3dYa6R1vgio2pHtPK","type":"tool_result","content":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md"}]},"uuid":"b087a416-fb51-45f9-8a75-85430dbbd0fb","timestamp":"2026-01-01T15:29:35.911Z","toolUseResult":{"filenames":["/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md"],"durationMs":833,"numFiles":1,"truncated":false}}
{"parentUuid":"b087a416-fb51-45f9-8a75-85430dbbd0fb","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018vyoMd8dGWhTqsXtqieYiH","type":"tool_result","content":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md"}]},"uuid":"7ddbdcd4-f641-41ad-823f-5376f926d227","timestamp":"2026-01-01T15:29:35.945Z","toolUseResult":{"filenames":["/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md"],"durationMs":867,"numFiles":1,"truncated":false}}
{"parentUuid":"7ddbdcd4-f641-41ad-823f-5376f926d227","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01EBSEFByHPZFM2tF1Qid3m4","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the specification:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":497,"cache_read_input_tokens":43926,"cache_creation":{"ephemeral_5m_input_tokens":497,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWgtwiZJ7hzXNGqe6wuYW","type":"assistant","uuid":"59534006-c22b-400e-8538-c4fb22bdfb33","timestamp":"2026-01-01T15:29:38.510Z"}
{"parentUuid":"59534006-c22b-400e-8538-c4fb22bdfb33","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01EBSEFByHPZFM2tF1Qid3m4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WNQJgzqGtpwUfZSenvWNFo","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":497,"cache_read_input_tokens":43926,"cache_creation":{"ephemeral_5m_input_tokens":497,"ephemeral_1h_input_tokens":0},"output_tokens":89,"service_tier":"standard"}},"requestId":"req_011CWgtwiZJ7hzXNGqe6wuYW","type":"assistant","uuid":"d6023107-51e0-4cf3-8ff3-7388659e25e7","timestamp":"2026-01-01T15:29:38.973Z"}
{"parentUuid":"d6023107-51e0-4cf3-8ff3-7388659e25e7","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WNQJgzqGtpwUfZSenvWNFo","type":"tool_result","content":"     1→# Fortune AI 后端重构计划 (v4.2 Vercel AI SDK Edition)\n     2→\n     3→**文档类型**: Backend Refactoring Plan\n     4→**版本**: v4.2\n     5→**日期**: 2026-01-01\n     6→**目标**: 将后端架构从 Python-centric 迁移到 Vercel AI SDK Driven 架构\n     7→\n     8→---\n     9→\n    10→## 0. 执行摘要\n    11→\n    12→### 0.1 重构目标\n    13→\n    14→将 Fortune AI 后端从当前的 **Python FastAPI 全栈架构** 重构为 **Vercel AI SDK Driven 分层架构**：\n    15→\n    16→| 当前状态 | 目标状态 |\n    17→|----------|----------|\n    18→| FastAPI 承载 AI 推理 + 数据服务 | Next.js API Route 承载 AI 推理 |\n    19→| `glm_client.py` 直接调用 LLM | `streamText()` + Multi-Model Provider |\n    20→| 自定义 SSE 格式 | `toDataStreamResponse()` 标准流 |\n    21→| Python L2 Agents | TypeScript `tool()` Skills |\n    22→| agent_service 辅助角色 | Agent Runtime 核心角色 |\n    23→\n    24→### 0.2 核心收益\n    25→\n    26→1. **端到端流式渲染**: `useChat()` → `streamText()` → `toDataStreamResponse()`\n    27→2. **多模型热切换**: GLM-4.5 / Gemini / Claude 通过 Vercel AI Gateway 动态切换\n    28→3. **Skills 可插拔**: Tool Calling 标准化，新增 Expert Agent 只需添加 `tool()` 定义\n    29→4. **maxSteps 多步推理**: 单次请求可多次 Tool 调用后综合输出\n    30→5. **类型安全**: Zod Schema 参数验证\n    31→\n    32→### 0.3 风险评估\n    33→\n    34→| 风险 | 等级 | 缓解措施 |\n    35→|------|:----:|----------|\n    36→| API 兼容性破坏 | 🔴 高 | 双路由并行期，逐步迁移 |\n    37→| 前端 CSRF 问题 | 🟡 中 | Next.js API Route 同源，无跨域 |\n    38→| 数据服务调用延迟 | 🟡 中 | Tool execute 批量聚合，缓存热点数据 |\n    39→| 团队 TypeScript 熟练度 | 🟢 低 | 现有 agent_service 已有 TS 基础 |\n    40→| maxSteps 重复写入 | 🔴 高 | 幂等性设计 + finalize 机制 |\n    41→| 流式中断数据不一致 | 🔴 高 | 流式与事务解耦，finalize 统一提交 |\n    42→\n    43→### 0.4 目标后端形态（三运行单元）\n    44→\n    45→重构后的后端拆分为 **3 个可独立演进的运行单元**：\n    46→\n    47→```\n    48→┌─────────────────────────────────────────────────────────────────────────────┐\n    49→│                         目标架构 (v4.2)                                       │\n    50→└─────────────────────────────────────────────────────────────────────────────┘\n    51→\n    52→Browser\n    53→    │\n    54→    │ HTTP\n    55→    ▼\n    56→┌─────────────────────────────────────────────────────────────────────────────┐\n    57→│  Reverse Proxy (Nginx/Caddy :80/:443)                                        │\n    58→│  ┌─────────────────────────────────────────────────────────────────────────┐│\n    59→│  │  路由规则:                                                               ││\n    60→│  │  /api/chat          → Next.js (:8231)  # Agent Runtime                  ││\n    61→│  │  /api/landing/*     → Next.js (:8231)  # Landing Page API               ││\n    62→│  │  /api/*             → FastAPI (:8230)  # Data Service                   ││\n    63→│  │  /new/*             → Next.js (:8231)  # Frontend                       ││\n    64→│  │  /admin/*           → Next.js (:8231)  # Admin System                   ││\n    65→│  └─────────────────────────────────────────────────────────────────────────┘│\n    66→└─────────────────────────────────────────────────────────────────────────────┘\n    67→        │                           │                           │\n    68→        ▼                           ▼                           ▼\n    69→┌───────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐\n    70→│ Next.js Agent     │  │ FastAPI Data Service    │  │ Python Cold Path Worker │\n    71→│ Runtime (:8231)   │  │ (:8230)                 │  │ (Cron/Queue)            │\n    72→├───────────────────┤  ├─────────────────────────┤  ├─────────────────────────┤\n    73→│ • streamText()    │  │ • Auth/Session          │  │ • Insight Agent         │\n    74→│ • tool() Skills   │  │ • 领域写入 (SSOT)       │  │ • Memory 沉淀           │\n    75→│ • useChat() 流式  │  │ • 确定性计算            │  │ • 异步报告生成          │\n    76→│ • Multi-Model Hub │  │ • Internal APIs         │  │ • 数据清洗              │\n    77→└───────────────────┘  └─────────────────────────┘  └─────────────────────────┘\n    78→        │                           │                           │\n    79→        │     fetch() / gRPC        │                           │\n    80→        └───────────────────────────┴───────────────────────────┘\n    81→                                    │\n    82→                                    ▼\n    83→                          PostgreSQL (fortune_ai)\n    84→```\n    85→\n    86→| 运行单元 | 职责 | 技术栈 | 部署 |\n    87→|----------|------|--------|------|\n    88→| **Agent Runtime** | AI 推理、流式响应、Tool Calling | Next.js + Vercel AI SDK | 可独立扩缩 |\n    89→| **Data Service** | Auth、SSOT 写入、确定性计算 | FastAPI + PostgreSQL | 有状态，单实例优先 |\n    90→| **Cold Path Worker** | 后台分析、Memory 沉淀 | Python + Celery/Cron | 异步，失败不阻塞 |\n    91→\n    92→### 0.5 信任边界与安全原则\n    93→\n    94→```\n    95→┌─────────────────────────────────────────────────────────────────────────────┐\n    96→│                         信任边界 (Trust Boundary)                            │\n    97→└─────────────────────────────────────────────────────────────────────────────┘\n    98→\n    99→                  ┌─────────────────────────────────────────┐\n   100→                  │            Untrusted Zone               │\n   101→                  │                                         │\n   102→                  │   Browser / Mobile App / Third Party    │\n   103→                  │                                         │\n   104→                  │   ⚠️ 永远不能信任来自这里的:             │\n   105→                  │      • userId                           │\n   106→                  │      • role / permissions               │\n   107→                  │      • 任何敏感标识                      │\n   108→                  └───────────────────┬─────────────────────┘\n   109→                                      │\n   110→                    Cookie (fortune_session) + HTTPS Only\n   111→                                      │\n   112→                                      ▼\n   113→                  ┌─────────────────────────────────────────┐\n   114→                  │            Trusted Zone                 │\n   115→                  │                                         │\n   116→                  │   Next.js API Route / FastAPI           │\n   117→                  │                                         │\n   118→                  │   ✅ userId 只能从 Session 解出          │\n   119→                  │   ✅ session_id 可由前端传但必须校验归属 │\n   120→                  │   ✅ Internal API 需 service token       │\n   121→                  └─────────────────────────────────────────┘\n   122→```\n   123→\n   124→**关键规则**：\n   125→\n   126→1. **userId 不传**: 前端请求体永远不包含 `userId`，由服务端从 Cookie Session 解出\n   127→2. **session_id 校验**: 如前端传 `session_id`，后端必须校验该 session 归属当前用户\n   128→3. **Internal API 隔离**: `/internal/*` 端点不暴露给浏览器，需 service token 或 IP 白名单\n   129→\n   130→### 0.6 工程化原则（决定重构成败）\n   131→\n   132→#### 0.6.1 流式与事务解耦\n   133→\n   134→```\n   135→┌─────────────────────────────────────────────────────────────────────────────┐\n   136→│                    Chat Run Lifecycle (流式生命周期)                          │\n   137→└─────────────────────────────────────────────────────────────────────────────┘\n   138→\n   139→用户消息 ──▶ run/start ──▶ streamText() ──▶ Tool调用(N次) ──▶ run/finalize\n   140→   │            │              │                │                  │\n   141→   │            │              │                │                  │\n   142→   ▼            ▼              ▼                ▼                  ▼\n   143→┌────────┐ ┌─────────┐   ┌──────────┐    ┌───────────┐      ┌─────────────┐\n   144→│用户消息│ │ run_id  │   │ 流式输出 │    │ 工具结果  │      │ 统一提交    │\n   145→│ 入库  │ │ 记录    │   │ (不落库) │    │ (内存暂存)│      │ 事务写入    │\n   146→└────────┘ └─────────┘   └──────────┘    └───────────┘      └─────────────┘\n   147→\n   148→                                                                   │\n   149→                                                                   ▼\n   150→                                                          ┌─────────────────┐\n   151→                                                          │ 一次事务包含:   │\n   152→                                                          │ • assistant msg │\n   153→                                                          │ • commitments   │\n   154→                                                          │ • tool_log      │\n   155→                                                          │ • twin updates  │\n   156→                                                          └─────────────────┘\n   157→```\n   158→\n   159→**规则**：\n   160→- 流式过程中只做\"可重放\"记录（run_id、用户消息）\n   161→- Tool 执行结果暂存内存，不直接写 DB\n   162→- `finalize` 时统一事务提交\n   163→- 中断则标记 `aborted`，避免半条消息进 SSOT\n   164→\n   165→#### 0.6.2 全链路 correlation_id\n   166→\n   167→```typescript\n   168→// Next.js API Route 入口生成\n   169→export async function POST(req: Request) {\n   170→  const correlationId = req.headers.get('x-correlation-id')\n   171→    || `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n   172→\n   173→  // 透传到 FastAPI\n   174→  const context = await fetch(`${FASTAPI_URL}/internal/context`, {\n   175→    headers: { 'X-Correlation-ID': correlationId },\n   176→  });\n   177→\n   178→  // 透传到 Tool 执行\n   179→  const result = streamText({\n   180→    // ...\n   181→    onStepFinish({ toolCalls }) {\n   182→      logger.info({ correlationId, toolCalls }, 'Step finished');\n   183→    },\n   184→  });\n   185→}\n   186→```\n   187→\n   188→**用途**：串联\"对话 → Tool 调用 → 写入 → 失败原因\"，便于 debug 和审计。\n   189→\n   190→#### 0.6.3 统一错误语义\n   191→\n   192→```typescript\n   193→// Public API 响应格式\n   194→interface ApiResponse<T> {\n   195→  ok: boolean;\n   196→  data?: T;\n   197→  error?: {\n   198→    code: string;        // 'AUTH_REQUIRED' | 'RATE_LIMITED' | 'TOOL_FAILED' | ...\n   199→    message: string;     // 用户可读消息\n   200→    detail?: unknown;    // 调试信息（仅 dev 环境）\n   201→    correlation_id?: string;\n   202→  };\n   203→}\n   204→\n   205→// Tool 执行失败返回（可渲染为 Toast 或 ErrorCard）\n   206→interface ToolError {\n   207→  type: 'tool_error';\n   208→  tool_name: string;\n   209→  error_code: string;\n   210→  user_message: string;  // \"八字计算服务暂时不可用\"\n   211→}\n   212→```\n   213→\n   214→---\n   215→\n   216→## 1. 现状分析\n   217→\n   218→### 1.1 当前架构\n   219→\n   220→```\n   221→┌─────────────────────────────────────────────────────────────────────────────┐\n   222→│                         当前架构 (v4.0/v4.1)                                  │\n   223→└─────────────────────────────────────────────────────────────────────────────┘\n   224→\n   225→Browser (:8231/new)\n   226→    │\n   227→    │ HTTP (fetch + SSE)\n   228→    ▼\n   229→┌──────────────────────────────────────────────────────────────────────────┐\n   230→│  FastAPI (:8230)                                                          │\n   231→│  ┌────────────────────────────────────────────────────────────────────┐  │\n   232→│  │  19 Route Files                                                     │  │\n   233→│  │  auth_routes / chat_routes / dashboard_routes / bazi_routes ...    │  │\n   234→│  └────────────────────────────────────────────────────────────────────┘  │\n   235→│                              │                                            │\n   236→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   237→│  │  Services Layer           ▼                                        │  │\n   238→│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │  │\n   239→│  │  │glm_client.py│ │bazi_engine  │ │twin_service │ │goal_service │  │  │\n   240→│  │  │ (LLM 调用)  │ │  (L0 计算) │ │ (状态管理) │ │ (目标管理) │  │  │\n   241→│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │  │\n   242→│  └───────────────────────────────────────────────────────────────────┘  │\n   243→│                              │                                            │\n   244→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   245→│  │  Agent Service Client     │ (HTTP 调用 TypeScript Agent)          │  │\n   246→│  └───────────────────────────┼───────────────────────────────────────┘  │\n   247→└──────────────────────────────┼───────────────────────────────────────────┘\n   248→                               │\n   249→                               ▼\n   250→┌──────────────────────────────────────────────────────────────────────────┐\n   251→│  Agent Service (:3000) - Express + Vercel AI SDK                          │\n   252→│  ┌─────────────────────────────────────────────────────────────────────┐ │\n   253→│  │  coach.ts: runCoachAgent() - 但仅作为辅助，主流量仍走 Python         │ │\n   254→│  └─────────────────────────────────────────────────────────────────────┘ │\n   255→└──────────────────────────────────────────────────────────────────────────┘\n   256→                               │\n   257→                               ▼\n   258→                        PostgreSQL (fortune_ai)\n   259→```\n   260→\n   261→### 1.2 现有文件清单\n   262→\n   263→**API Routes (19 个)**:\n   264→```\n   265→api/\n   266→├── auth_routes.py        # 认证 (register/login/logout)\n   267→├── chat_routes.py        # 对话 (send/stream) ⚠️ 核心重构对象\n   268→├── dashboard_routes.py   # Dashboard Zone B\n   269→├── bazi_routes.py        # 八字计算\n   270→├── bento_routes.py       # Bento 6 卡片 (legacy)\n   271→├── twin_routes.py        # 数字孪生\n   272→├── goal_routes.py        # 目标管理\n   273→├── reflection_routes.py  # 复盘\n   274→├── report_routes.py      # 深度报告\n   275→├── poster_routes.py      # 海报生成\n   276→├── yunshi_routes.py      # 运势\n   277→├── plan_routes.py        # 计划\n   278→├── kb_routes.py          # 知识库\n   279→├── session_routes.py     # 会话管理\n   280→├── user_routes.py        # 用户资料\n   281→├── social_routes.py      # 社交\n   282→├── push_routes.py        # 推送\n   283→├── currency_routes.py    # 货币\n   284→├── jitai_routes.py       # 吉台\n   285→├── agent_tool.py         # Agent 工具 API\n   286→├── deps.py               # 依赖注入\n   287→└── main.py               # 入口\n   288→```\n   289→\n   290→**Services (核心)**:\n   291→```\n   292→services/\n   293→├── glm_client.py          # ⚠️ 待删除：直接 LLM 调用\n   294→├── chat_service.py        # 会话消息管理\n   295→├── bazi_engine.py         # L0 八字计算 ✅ 保留\n   296→├── bazi_facts.py          # 事实提取 ✅ 保留\n   297→├── twin_service.py        # 数字孪生 ✅ 保留\n   298→├── goal_service.py        # 目标管理 ✅ 保留\n   299→├── reflection_service.py  # 复盘 ✅ 保留\n   300→├── soul_os.py             # 上下文组装 ⚠️ 重构\n   301→├── agent_service_client.py # ⚠️ 待删除：改为 Next.js 内部调用\n   302→└── ...\n   303→```\n   304→\n   305→### 1.3 关键痛点\n   306→\n   307→| 痛点 | 影响 | 根因 |\n   308→|------|------|------|\n   309→| 双语言交互复杂 | 维护成本高 | Python/TS 边界不清晰 |\n   310→| 流式渲染非标准 | 前端适配困难 | 自定义 SSE 格式 |\n   311→| LLM 调用分散 | 难以统一管理 | glm_client + agent_service 并存 |\n   312→| Tool Calling 手动 | 扩展困难 | 无标准化 Skills 框架 |\n   313→| A2UI 非流式 | 首字延迟高 | JSON 整体返回 |\n   314→\n   315→---\n   316→\n   317→## 2. 目标架构\n   318→\n   319→### 2.1 架构图\n   320→\n   321→```\n   322→┌─────────────────────────────────────────────────────────────────────────────┐\n   323→│                         目标架构 (v4.2 Vercel AI SDK)                         │\n   324→└─────────────────────────────────────────────────────────────────────────────┘\n   325→\n   326→Browser\n   327→    │\n   328→    │ useChat() Hook\n   329→    ▼\n   330→┌──────────────────────────────────────────────────────────────────────────┐\n   331→│  Next.js (:8231)                                                          │\n   332→│  ┌────────────────────────────────────────────────────────────────────┐  │\n   333→│  │  app/api/chat/route.ts   ← Agent Runtime (核心)                     │  │\n   334→│  │  ┌──────────────────────────────────────────────────────────────┐ │  │\n   335→│  │  │  streamText({                                                 │ │  │\n   336→│  │  │    model: selectModel(),     // GLM / Gemini / Claude         │ │  │\n   337→│  │  │    system: buildSystemPrompt(context),                        │ │  │\n   338→│  │  │    tools: getToolsForMode(mode),                              │ │  │\n   339→│  │  │    maxSteps: 5,                                               │ │  │\n   340→│  │  │  }) → toDataStreamResponse()                                  │ │  │\n   341→│  │  └──────────────────────────────────────────────────────────────┘ │  │\n   342→│  └────────────────────────────────────────────────────────────────────┘  │\n   343→│                              │                                            │\n   344→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   345→│  │  Skills Registry          ▼                                        │  │\n   346→│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │  │\n   347→│  │  │Divine Skills│ │ Heal Skills │ │ Grow Skills │                  │  │\n   348→│  │  │calculate_   │ │log_perma    │ │covey_matrix │                  │  │\n   349→│  │  │  bazi/ziwei │ │cbt_reframe  │ │goal_setting │                  │  │\n   350→│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                  │  │\n   351→│  └─────────┼───────────────┼───────────────┼─────────────────────────┘  │\n   352→└────────────┼───────────────┼───────────────┼────────────────────────────┘\n   353→             │               │               │\n   354→             │ fetch()       │ fetch()       │ fetch()\n   355→             ▼               ▼               ▼\n   356→┌──────────────────────────────────────────────────────────────────────────┐\n   357→│  FastAPI (:8230) - 纯数据服务层                                            │\n   358→│  ┌────────────────────────────────────────────────────────────────────┐  │\n   359→│  │  Data Service APIs (无 LLM 调用)                                    │  │\n   360→│  │  /api/bazi/calculate     /api/perma/log      /api/goals/create     │  │\n   361→│  │  /api/user/context       /api/twin/update    /api/tasks/create     │  │\n   362→│  │  /api/landing/insight    /api/kb/search      /api/checkin/mood     │  │\n   363→│  └────────────────────────────────────────────────────────────────────┘  │\n   364→│                              │                                            │\n   365→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   366→│  │  Services Layer (保留)    │                                        │  │\n   367→│  │  bazi_engine / twin_service / goal_service / reflection_service   │  │\n   368→│  └───────────────────────────────────────────────────────────────────┘  │\n   369→└──────────────────────────────────────────────────────────────────────────┘\n   370→                               │\n   371→                               ▼\n   372→                        PostgreSQL (fortune_ai)\n   373→```\n   374→\n   375→### 2.2 职责边界\n   376→\n   377→| 层级 | 运行环境 | 职责 | 技术栈 |\n   378→|------|----------|------|--------|\n   379→| **Frontend** | Browser | UI 渲染、流式展示、Command 输入 | React + `useChat()` |\n   380→| **Agent Runtime** | Next.js API Route | AI 推理、Tool Calling、流式输出 | `streamText()` + `tool()` |\n   381→| **Skills Registry** | Next.js | 可插拔技能定义 | Zod Schema + execute |\n   382→| **Data Service** | FastAPI | L0/L1 数据 CRUD、计算逻辑 | Python + PostgreSQL |\n   383→| **Insight Agent** | Cron Worker | Cold Path 数据沉淀 | Python |\n   384→\n   385→### 2.3 API 端点规划\n   386→\n   387→**Next.js API Routes (新增)**:\n   388→```typescript\n   389→// Agent Runtime\n   390→POST /api/chat           // streamText() 主入口\n   391→POST /api/command        // /divine /heal /grow 指令路由\n   392→\n   393→// Landing Page (可选迁移)\n   394→POST /api/landing/insight  // 即时洞察 (无需登录)\n   395→```\n   396→\n   397→**FastAPI Data Service (重构)**:\n   398→```python\n   399→# L0 Base Data\n   400→GET  /api/user/context        # 聚合用户上下文\n   401→GET  /api/user/profile        # 用户资料\n   402→PUT  /api/user/profile        # 更新资料\n   403→\n   404→# L1 Module Data - Divine\n   405→POST /api/bazi/calculate      # 八字计算\n   406→POST /api/ziwei/calculate     # 紫微计算\n   407→GET  /api/bazi/facts/{user_id}  # 获取事实\n   408→\n   409→# L1 Module Data - Heal\n   410→POST /api/perma/log           # PERMA 记录\n   411→GET  /api/perma/query         # PERMA 查询\n   412→POST /api/checkin/mood        # 情绪打卡\n   413→\n   414→# L1 Module Data - Grow\n   415→POST /api/goals/create        # 创建目标\n   416→GET  /api/goals/active        # 活跃目标\n   417→POST /api/tasks/create        # 创建任务\n   418→PUT  /api/tasks/{id}/complete # 完成任务\n   419→\n   420→# Twin\n   421→GET  /api/twin/{user_id}      # 获取孪生数据\n   422→PUT  /api/twin/update         # 更新孪生\n   423→\n   424→# KB\n   425→POST /api/kb/search           # 知识库检索\n   426→\n   427→# 保留 (暂不迁移)\n   428→/api/auth/*                   # 认证\n   429→/api/report/*                 # 深度报告\n   430→/api/poster/*                 # 海报\n   431→/api/dashboard/*              # Dashboard\n   432→```\n   433→\n   434→### 2.4 Internal Contract APIs（内部契约）\n   435→\n   436→为 Agent Runtime 与 FastAPI 之间的通信定义两个核心契约，比继续复用 `chat_routes.py` 更干净：\n   437→\n   438→#### 2.4.1 Context API（上下文聚合）\n   439→\n   440→```python\n   441→# FastAPI: api/internal_routes.py\n   442→# 只对内部调用开放，需 X-Service-Token 或 IP 白名单\n   443→\n   444→@router.get(\"/internal/context\")\n   445→async def get_context(\n   446→    session_id: str = Query(None),\n   447→    user: AuthUser = Depends(get_current_user_from_cookie),\n   448→    x_correlation_id: str = Header(None),\n   449→) -> ContextResponse:\n   450→    \"\"\"\n   451→    一次性聚合用户上下文，减少 Agent Runtime 的 fetch 次数\n   452→    \"\"\"\n   453→    return ContextResponse(\n   454→        l0=UserProfile(\n   455→            user_id=user.id,\n   456→            display_name=user.name,\n   457→            birth_info=get_birth_info(user.id),\n   458→            preferences=get_preferences(user.id),\n   459→        ),\n   460→        l1=ModuleData(\n   461→            bazi_chart=get_latest_bazi(user.id),\n   462→            perma_recent=get_perma_summary(user.id, days=7),\n   463→            active_goals=get_active_goals(user.id, limit=3),\n   464→            twin_status=get_twin_status(user.id),\n   465→        ),\n   466→        policy_flags=PolicyFlags(\n   467→            allow_roast=user.preferences.get('allow_roast', False),\n   468→            model_override=user.preferences.get('model'),\n   469→        ),\n   470→        history_excerpt=get_recent_messages(user.id, limit=10),\n   471→    )\n   472→```\n   473→\n   474→**Response Schema**:\n   475→```typescript\n   476→interface ContextResponse {\n   477→  l0: {\n   478→    user_id: string;\n   479→    display_name: string;\n   480→    birth_info: { year: number; month: number; day: number; hour?: number };\n   481→    preferences: Record<string, unknown>;\n   482→  };\n   483→  l1: {\n   484→    bazi_chart?: BaziChart;\n   485→    perma_recent?: PermaScore[];\n   486→    active_goals?: Goal[];\n   487→    twin_status?: TwinStatus;\n   488→  };\n   489→  policy_flags: {\n   490→    allow_roast: boolean;\n   491→    model_override?: 'glm' | 'gemini' | 'claude';\n   492→  };\n   493→  history_excerpt: Message[];\n   494→}\n   495→```\n   496→\n   497→#### 2.4.2 Chat Persistence API（流式持久化）\n   498→\n   499→```python\n   500→# FastAPI: api/internal_routes.py\n   501→\n   502→@router.post(\"/internal/chat/run/start\")\n   503→async def start_chat_run(\n   504→    request: StartRunRequest,\n   505→    user: AuthUser = Depends(get_current_user_from_cookie),\n   506→) -> StartRunResponse:\n   507→    \"\"\"\n   508→    流式开始时调用：记录 run_id + 用户消息\n   509→    \"\"\"\n   510→    run_id = str(uuid4())\n   511→\n   512→    # 只写入用户消息（assistant 消息在 finalize 写入）\n   513→    await db.execute(\"\"\"\n   514→        INSERT INTO chat_runs (id, user_id, session_id, status, started_at)\n   515→        VALUES ($1, $2, $3, 'running', NOW())\n   516→    \"\"\", run_id, user.id, request.session_id)\n   517→\n   518→    await db.execute(\"\"\"\n   519→        INSERT INTO chat_messages (run_id, role, content, created_at)\n   520→        VALUES ($1, 'user', $2, NOW())\n   521→    \"\"\", run_id, request.user_message)\n   522→\n   523→    return StartRunResponse(run_id=run_id)\n   524→\n   525→@router.post(\"/internal/chat/run/finalize\")\n   526→async def finalize_chat_run(\n   527→    request: FinalizeRunRequest,\n   528→    user: AuthUser = Depends(get_current_user_from_cookie),\n   529→) -> FinalizeRunResponse:\n   530→    \"\"\"\n   531→    流式结束时调用：一次事务写入所有副作用\n   532→    \"\"\"\n   533→    async with db.transaction():\n   534→        # 1. 更新 run 状态\n   535→        await db.execute(\"\"\"\n   536→            UPDATE chat_runs\n   537→            SET status = $2, finished_at = NOW()\n   538→            WHERE id = $1\n   539→        \"\"\", request.run_id, 'completed' if request.success else 'aborted')\n   540→\n   541→        # 2. 写入 assistant 消息\n   542→        if request.assistant_message:\n   543→            await db.execute(\"\"\"\n   544→                INSERT INTO chat_messages (run_id, role, content, created_at)\n   545→                VALUES ($1, 'assistant', $2, NOW())\n   546→            \"\"\", request.run_id, request.assistant_message)\n   547→\n   548→        # 3. 写入 tool 调用日志\n   549→        for tool_log in request.tool_logs:\n   550→            await db.execute(\"\"\"\n   551→                INSERT INTO tool_invocations\n   552→                (run_id, tool_name, input, output, latency_ms, idempotency_key)\n   553→                VALUES ($1, $2, $3, $4, $5, $6)\n   554→                ON CONFLICT (idempotency_key) DO NOTHING\n   555→            \"\"\", request.run_id, tool_log.name, tool_log.input,\n   556→                tool_log.output, tool_log.latency_ms, tool_log.idempotency_key)\n   557→\n   558→        # 4. 写入 commitments（承诺/任务）\n   559→        for commitment in request.commitments:\n   560→            await create_commitment(user.id, commitment)\n   561→\n   562→        # 5. 更新 twin 状态\n   563→        if request.twin_updates:\n   564→            await update_twin(user.id, request.twin_updates)\n   565→\n   566→    return FinalizeRunResponse(ok=True)\n   567→```\n   568→\n   569→**Request/Response Schema**:\n   570→```typescript\n   571→interface StartRunRequest {\n   572→  session_id?: string;\n   573→  user_message: string;\n   574→  correlation_id: string;\n   575→}\n   576→\n   577→interface FinalizeRunRequest {\n   578→  run_id: string;\n   579→  success: boolean;\n   580→  assistant_message?: string;\n   581→  tool_logs: ToolLog[];\n   582→  commitments: Commitment[];\n   583→  twin_updates?: TwinUpdate;\n   584→}\n   585→\n   586→interface ToolLog {\n   587→  name: string;\n   588→  input: Record<string, unknown>;\n   589→  output: Record<string, unknown>;\n   590→  latency_ms: number;\n   591→  idempotency_key: string;  // 用于防止 maxSteps 重复写入\n   592→}\n   593→```\n   594→\n   595→### 2.5 A2UI 迁移方案（ToolResultCard）\n   596→\n   597→将 A2UI 从\"整段 JSON 作为 assistant content\"迁移为\"ToolResultCard + 教练表达\"模式：\n   598→\n   599→#### 2.5.1 现状 vs 目标\n   600→\n   601→```\n   602→【现状】A2UI 作为 assistant message content\n   603→┌─────────────────────────────────────────────────────────────────┐\n   604→│ { role: 'assistant',                                            │\n   605→│   content: '{\"type\":\"a2ui\",\"cards\":[{\"type\":\"bazi_chart\",...}]}'│\n   606→│ }                                                               │\n   607→└─────────────────────────────────────────────────────────────────┘\n   608→\n   609→【目标】ToolResultCard + assistant content 分离\n   610→┌─────────────────────────────────────────────────────────────────┐\n   611→│ {                                                               │\n   612→│   role: 'assistant',                                            │\n   613→│   content: '根据你的八字，你是一个...',  // 教练表达           │\n   614→│   toolInvocations: [                                            │\n   615→│     {                                                           │\n   616→│       toolName: 'calculate_bazi',                               │\n   617→│       state: 'result',                                          │\n   618→│       result: {                                                 │\n   619→│         type: 'a2ui_card',                                      │\n   620→│         card_type: 'bazi_chart',                                │\n   621→│         data: { ... }                                           │\n   622→│       }                                                         │\n   623→│     }                                                           │\n   624→│   ]                                                             │\n   625→│ }                                                               │\n   626→└─────────────────────────────────────────────────────────────────┘\n   627→```\n   628→\n   629→#### 2.5.2 ToolResultCard Schema\n   630→\n   631→```typescript\n   632→// lib/types/a2ui-card.ts\n   633→\n   634→interface ToolResultCard {\n   635→  type: 'a2ui_card';\n   636→  card_type: CardType;\n   637→  data: CardData;\n   638→  actions?: CardAction[];\n   639→}\n   640→\n   641→type CardType =\n   642→  | 'bazi_chart'      // 八字命盘\n   643→  | 'perma_radar'     // PERMA 雷达图\n   644→  | 'goal_progress'   // 目标进度\n   645→  | 'commitment_card' // 承诺卡片\n   646→  | 'insight_card'    // 洞察卡片\n   647→  | 'kline_chart'     // K线图\n   648→  | 'error_toast';    // 错误提示\n   649→\n   650→interface CardAction {\n   651→  type: 'accept' | 'done' | 'skip' | 'navigate' | 'share';\n   652→  label: string;\n   653→  endpoint?: string;   // 仅映射到 SSOT 状态机跃迁端点\n   654→  payload?: Record<string, unknown>;\n   655→}\n   656→\n   657→// 前端渲染\n   658→function ToolResultRenderer({ toolInvocation }) {\n   659→  if (toolInvocation.result?.type === 'a2ui_card') {\n   660→    const { card_type, data, actions } = toolInvocation.result;\n   661→    switch (card_type) {\n   662→      case 'bazi_chart':\n   663→        return <BaziChartCard data={data} actions={actions} />;\n   664→      case 'commitment_card':\n   665→        return <CommitmentCard data={data} actions={actions} />;\n   666→      // ...\n   667→    }\n   668→  }\n   669→  return null;\n   670→}\n   671→```\n   672→\n   673→#### 2.5.3 ActionButton 约束\n   674→\n   675→**关键规则**：ActionButton 的 `type` 只能映射到以下 SSOT 状态机跃迁端点，不允许组件私自定义写操作：\n   676→\n   677→| action.type | 映射端点 | 说明 |\n   678→|-------------|----------|------|\n   679→| `accept` | `POST /api/dashboard/task/accept` | 接受任务 |\n   680→| `done` | `POST /api/dashboard/task/done` | 完成任务 |\n   681→| `skip` | `POST /api/dashboard/task/skip` | 跳过任务 |\n   682→| `checkin` | `POST /api/dashboard/checkin` | 情绪打卡 |\n   683→| `navigate` | 前端路由 | 页面跳转（无写操作） |\n   684→| `share` | `POST /api/social/share` | 分享卡片 |\n   685→\n   686→### 2.6 幂等性设计\n   687→\n   688→防止 `maxSteps` 多步推理下的重复写入：\n   689→\n   690→#### 2.6.1 idempotency_key 策略\n   691→\n   692→```typescript\n   693→// lib/skills/divine-skills.ts\n   694→\n   695→export const calculateBazi = tool({\n   696→  description: '计算用户的八字命盘',\n   697→  parameters: z.object({\n   698→    birth_datetime: z.string(),\n   699→    timezone: z.string().default('Asia/Shanghai'),\n   700→  }),\n   701→  execute: async ({ birth_datetime, timezone }, { runId, stepIndex }) => {\n   702→    // 生成幂等键：run_id + step_index + tool_name + params_hash\n   703→    const idempotencyKey = `${runId}:${stepIndex}:calculate_bazi:${hash({ birth_datetime, timezone })}`;\n   704→\n   705→    const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n   706→      method: 'POST',\n   707→      headers: {\n   708→        'Content-Type': 'application/json',\n   709→        'X-Idempotency-Key': idempotencyKey,\n   710→      },\n   711→      body: JSON.stringify({ birth_datetime, timezone }),\n   712→    });\n   713→\n   714→    return res.json();\n   715→  },\n   716→});\n   717→```\n   718→\n   719→#### 2.6.2 FastAPI 幂等性处理\n   720→\n   721→```python\n   722→# api/middleware/idempotency.py\n   723→\n   724→@app.middleware(\"http\")\n   725→async def idempotency_middleware(request: Request, call_next):\n   726→    idempotency_key = request.headers.get(\"X-Idempotency-Key\")\n   727→\n   728→    if idempotency_key and request.method in (\"POST\", \"PUT\"):\n   729→        # 检查是否已执行\n   730→        cached = await redis.get(f\"idempotency:{idempotency_key}\")\n   731→        if cached:\n   732→            return JSONResponse(content=json.loads(cached))\n   733→\n   734→        response = await call_next(request)\n   735→\n   736→        # 缓存结果（TTL 24h）\n   737→        if response.status_code == 200:\n   738→            body = await response.body()\n   739→            await redis.setex(f\"idempotency:{idempotency_key}\", 86400, body)\n   740→\n   741→        return response\n   742→\n   743→    return await call_next(request)\n   744→```\n   745→\n   746→#### 2.6.3 自然唯一键\n   747→\n   748→对于某些业务写入，使用自然唯一键替代显式 idempotency_key：\n   749→\n   750→```sql\n   751→-- 承诺表：同一用户同一天同一描述只能有一条\n   752→CREATE UNIQUE INDEX uq_commitments_natural\n   753→ON commitments (user_id, date_trunc('day', created_at), description_hash)\n   754→WHERE status = 'active';\n   755→\n   756→-- PERMA 记录：同一用户同一小时只能有一条\n   757→CREATE UNIQUE INDEX uq_perma_hourly\n   758→ON perma_logs (user_id, date_trunc('hour', logged_at));\n   759→```\n   760→\n   761→---\n   762→\n   763→## 3. 重构阶段\n   764→\n   765→### Phase 1: 基础设施准备 (Week 1)\n   766→\n   767→**目标**: 建立 Next.js Agent Runtime 基础框架 + 双后端路由共存\n   768→\n   769→#### 1.0 反向代理路由配置（关键前置）\n   770→\n   771→配置 Nginx/Caddy 实现 Next.js 和 FastAPI 的路由共存：\n   772→\n   773→```nginx\n   774→# /etc/nginx/sites-available/fortune-ai\n   775→\n   776→upstream nextjs {\n   777→    server 127.0.0.1:8231;\n   778→}\n   779→\n   780→upstream fastapi {\n   781→    server 127.0.0.1:8230;\n   782→}\n   783→\n   784→server {\n   785→    listen 80;\n   786→    server_name fortune-ai.example.com;\n   787→\n   788→    # Agent Runtime (Next.js)\n   789→    location /api/chat {\n   790→        proxy_pass http://nextjs;\n   791→        proxy_http_version 1.1;\n   792→        proxy_set_header Upgrade $http_upgrade;\n   793→        proxy_set_header Connection 'upgrade';\n   794→        proxy_set_header Host $host;\n   795→        proxy_set_header X-Real-IP $remote_addr;\n   796→        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n   797→        proxy_buffering off;  # 流式响应必须\n   798→        proxy_read_timeout 300s;\n   799→    }\n   800→\n   801→    # Landing Page API (Next.js)\n   802→    location /api/landing/ {\n   803→        proxy_pass http://nextjs;\n   804→        proxy_set_header Host $host;\n   805→        # IP 级限流\n   806→        limit_req zone=landing_limit burst=5 nodelay;\n   807→    }\n   808→\n   809→    # Internal APIs (仅内部访问)\n   810→    location /internal/ {\n   811→        # 只允许内网访问\n   812→        allow 127.0.0.1;\n   813→        allow 10.0.0.0/8;\n   814→        deny all;\n   815→        proxy_pass http://fastapi;\n   816→        proxy_set_header Host $host;\n   817→    }\n   818→\n   819→    # Data Service APIs (FastAPI)\n   820→    location /api/ {\n   821→        proxy_pass http://fastapi;\n   822→        proxy_set_header Host $host;\n   823→        proxy_set_header X-Real-IP $remote_addr;\n   824→        proxy_set_header Cookie $http_cookie;\n   825→    }\n   826→\n   827→    # Frontend (Next.js)\n   828→    location /new/ {\n   829→        proxy_pass http://nextjs;\n   830→        proxy_set_header Host $host;\n   831→    }\n   832→\n   833→    # Admin System (Next.js)\n   834→    location /admin/ {\n   835→        proxy_pass http://nextjs;\n   836→        proxy_set_header Host $host;\n   837→    }\n   838→\n   839→    # Landing Page (Next.js)\n   840→    location / {\n   841→        proxy_pass http://nextjs;\n   842→        proxy_set_header Host $host;\n   843→    }\n   844→}\n   845→\n   846→# IP 限流配置\n   847→limit_req_zone $binary_remote_addr zone=landing_limit:10m rate=10r/m;\n   848→```\n   849→\n   850→**路由优先级**（顺序很重要）：\n   851→1. `/api/chat` → Next.js（Agent Runtime）\n   852→2. `/api/landing/*` → Next.js（Landing Page API）\n   853→3. `/internal/*` → FastAPI（内部 API，限内网）\n   854→4. `/api/*` → FastAPI（Data Service）\n   855→5. `/new/*` → Next.js（Frontend）\n   856→6. `/admin/*` → Next.js（Admin）\n   857→7. `/` → Next.js（Landing Page）\n   858→\n   859→#### 1.1 Next.js API Route 结构\n   860→\n   861→```bash\n   862→web-app/src/app/api/\n   863→├── chat/\n   864→│   └── route.ts              # 主 Agent Runtime\n   865→├── command/\n   866→│   └── route.ts              # 指令路由\n   867→└── landing/\n   868→    └── insight/\n   869→        └── route.ts          # Landing Page 洞察\n   870→```\n   871→\n   872→#### 1.2 Skills Registry 框架\n   873→\n   874→```bash\n   875→web-app/src/lib/\n   876→├── skills/\n   877→│   ├── index.ts              # Skills 统一导出\n   878→│   ├── divine-skills.ts      # 玄学技能\n   879→│   ├── heal-skills.ts        # 疗愈技能\n   880→│   └── grow-skills.ts        # 成长技能\n   881→├── models/\n   882→│   └── model-provider.ts     # Multi-Model 配置\n   883→└── context/\n   884→    └── context-builder.ts    # System Prompt 构建\n   885→```\n   886→\n   887→#### 1.3 配置 Multi-Model Provider\n   888→\n   889→```typescript\n   890→// lib/models/model-provider.ts\n   891→import { createGoogleGenerativeAI } from '@ai-sdk/google';\n   892→import { createAnthropic } from '@ai-sdk/anthropic';\n   893→\n   894→const google = createGoogleGenerativeAI({\n   895→  apiKey: process.env.GOOGLE_API_KEY,\n   896→});\n   897→\n   898→const anthropic = createAnthropic({\n   899→  apiKey: process.env.ANTHROPIC_API_KEY,\n   900→});\n   901→\n   902→// Vercel AI Gateway for GLM-4.5\n   903→const glm = createGoogleGenerativeAI({\n   904→  baseURL: 'https://gateway.ai.cloudflare.com/v1/...',\n   905→  apiKey: process.env.GLM_API_KEY,\n   906→});\n   907→\n   908→export function selectModel(preference?: string) {\n   909→  switch (preference) {\n   910→    case 'gemini': return google('gemini-2.0-flash-exp');\n   911→    case 'claude': return anthropic('claude-3-5-sonnet-20241022');\n   912→    case 'glm':\n   913→    default: return glm('glm-4.5');\n   914→  }\n   915→}\n   916→```\n   917→\n   918→#### 1.4 交付物\n   919→\n   920→- [ ] **Nginx/Caddy 双后端路由配置**（关键前置）\n   921→- [ ] FastAPI `/internal/*` 端点隔离（IP 白名单）\n   922→- [ ] Next.js `/api/chat/route.ts` 基础框架\n   923→- [ ] Skills Registry 目录结构\n   924→- [ ] Multi-Model Provider 配置\n   925→- [ ] 环境变量配置 (`.env.local`)\n   926→\n   927→---\n   928→\n   929→### Phase 2: Agent Runtime 迁移 (Week 2)\n   930→\n   931→**目标**: 将 AI 推理逻辑从 Python 迁移到 Next.js\n   932→\n   933→#### 2.1 实现 `/api/chat/route.ts`（含 Run Lifecycle）\n   934→\n   935→```typescript\n   936→// app/api/chat/route.ts\n   937→import { streamText } from 'ai';\n   938→import { cookies } from 'next/headers';\n   939→import { selectModel } from '@/lib/models/model-provider';\n   940→import { allSkills } from '@/lib/skills';\n   941→import { buildSystemPrompt } from '@/lib/context/context-builder';\n   942→\n   943→const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n   944→\n   945→// 请求体：不包含 userId（从 Cookie Session 解出）\n   946→interface ChatRequest {\n   947→  session_id?: string;   // 可选，用于会话续接\n   948→  message: string;       // 用户消息\n   949→  command?: string;      // /divine | /heal | /grow（来自 CommandPalette）\n   950→}\n   951→\n   952→export async function POST(req: Request) {\n   953→  const cookieStore = await cookies();\n   954→  const sessionCookie = cookieStore.get('fortune_session')?.value;\n   955→\n   956→  if (!sessionCookie) {\n   957→    return Response.json({ ok: false, error: { code: 'AUTH_REQUIRED' } }, { status: 401 });\n   958→  }\n   959→\n   960→  const { session_id, message, command }: ChatRequest = await req.json();\n   961→\n   962→  // 生成 correlation_id\n   963→  const correlationId = `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n   964→\n   965→  // 1. 调用 Internal Context API（Cookie 透传，userId 由 FastAPI 解出）\n   966→  const contextRes = await fetch(`${FASTAPI_URL}/internal/context`, {\n   967→    headers: {\n   968→      'Cookie': `fortune_session=${sessionCookie}`,\n   969→      'X-Correlation-ID': correlationId,\n   970→    },\n   971→  });\n   972→\n   973→  if (!contextRes.ok) {\n   974→    return Response.json({ ok: false, error: { code: 'CONTEXT_FETCH_FAILED' } }, { status: 500 });\n   975→  }\n   976→\n   977→  const context = await contextRes.json();\n   978→\n   979→  // 2. 调用 run/start（记录 run_id + 用户消息）\n   980→  const startRes = await fetch(`${FASTAPI_URL}/internal/chat/run/start`, {\n   981→    method: 'POST',\n   982→    headers: {\n   983→      'Content-Type': 'application/json',\n   984→      'Cookie': `fortune_session=${sessionCookie}`,\n   985→      'X-Correlation-ID': correlationId,\n   986→    },\n   987→    body: JSON.stringify({\n   988→      session_id,\n   989→      user_message: message,\n   990→      correlation_id: correlationId,\n   991→    }),\n   992→  });\n   993→\n   994→  const { run_id } = await startRes.json();\n   995→\n   996→  // 3. 根据 Command 筛选 Tools\n   997→  const tools = command\n   998→    ? getToolsForCommand(command)  // /divine → divineSkills only\n   999→    : allSkills;                   // Chat Mode: all tools\n  1000→\n  1001→  // 4. 暂存 Tool 调用记录（用于 finalize）\n  1002→  const toolLogs: ToolLog[] = [];\n  1003→  const commitments: Commitment[] = [];\n  1004→\n  1005→  // 5. streamText 流式推理\n  1006→  const result = streamText({\n  1007→    model: selectModel(context.policy_flags?.model_override),\n  1008→    system: buildSystemPrompt(context),\n  1009→    messages: [\n  1010→      ...context.history_excerpt,\n  1011→      { role: 'user', content: message },\n  1012→    ],\n  1013→    tools,\n  1014→    maxSteps: 5,\n  1015→\n  1016→    // 每步完成回调：记录 Tool 调用\n  1017→    onStepFinish({ stepType, toolCalls, toolResults }) {\n  1018→      if (stepType === 'tool-result' && toolCalls) {\n  1019→        for (let i = 0; i < toolCalls.length; i++) {\n  1020→          const call = toolCalls[i];\n  1021→          const result = toolResults?.[i];\n  1022→          toolLogs.push({\n  1023→            name: call.toolName,\n  1024→            input: call.args,\n  1025→            output: result,\n  1026→            latency_ms: 0, // TODO: 实际计时\n  1027→            idempotency_key: `${run_id}:${toolLogs.length}:${call.toolName}`,\n  1028→          });\n  1029→\n  1030→          // 收集 commitments\n  1031→          if (result?.commitments) {\n  1032→            commitments.push(...result.commitments);\n  1033→          }\n  1034→        }\n  1035→      }\n  1036→    },\n  1037→\n  1038→    // 流式完成回调：调用 finalize\n  1039→    async onFinish({ text, finishReason }) {\n  1040→      await fetch(`${FASTAPI_URL}/internal/chat/run/finalize`, {\n  1041→        method: 'POST',\n  1042→        headers: {\n  1043→          'Content-Type': 'application/json',\n  1044→          'Cookie': `fortune_session=${sessionCookie}`,\n  1045→          'X-Correlation-ID': correlationId,\n  1046→        },\n  1047→        body: JSON.stringify({\n  1048→          run_id,\n  1049→          success: finishReason !== 'error',\n  1050→          assistant_message: text,\n  1051→          tool_logs: toolLogs,\n  1052→          commitments,\n  1053→        }),\n  1054→      });\n  1055→    },\n  1056→  });\n  1057→\n  1058→  return result.toDataStreamResponse();\n  1059→}\n  1060→```\n  1061→\n  1062→**关键变化**：\n  1063→- 请求体只包含 `{ session_id?, message, command? }`，**不传 userId**\n  1064→- userId 从 Cookie Session 由 FastAPI 解出\n  1065→- 流式开始时调用 `run/start`，结束时调用 `run/finalize`\n  1066→- Tool 调用记录暂存内存，`finalize` 时统一写入\n  1067→\n  1068→#### 2.2 System Prompt 迁移\n  1069→\n  1070→将 `chat_routes.py:SYSTEM_PROMPT_TEMPLATE` 迁移到 TypeScript：\n  1071→\n  1072→```typescript\n  1073→// lib/context/context-builder.ts\n  1074→export function buildSystemPrompt(context: UserContext): string {\n  1075→  return `你是 Fortune AI 的对话 Agent，角色是积极心理学教练。\n  1076→\n  1077→【硬性规则】\n  1078→1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接\"你可以做什么\"的行动处方。\n  1079→2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。\n  1080→3) 每次输出必须包含：结论 + 依据 + ≤3条处方 + 承诺邀请。\n  1081→4) 每条处方必须包含 if_then：如果____→那么____。\n  1082→5) 必须给出可点击 actions。\n  1083→\n  1084→【用户上下文】\n  1085→persona_style: ${context.persona_style}\n  1086→facts: ${JSON.stringify(context.facts)}\n  1087→evidence: ${JSON.stringify(context.evidence)}\n  1088→active_goals: ${JSON.stringify(context.active_goals)}\n  1089→`;\n  1090→}\n  1091→```\n  1092→\n  1093→#### 2.3 双路由并行期\n  1094→\n  1095→**保留 Python `/api/chat/send`**，新增 Next.js `/api/chat`：\n  1096→\n  1097→```python\n  1098→# api/chat_routes.py - 添加 header 检测\n  1099→@router.post(\"/send\")\n  1100→async def chat_send(request: Request, body: ChatSendRequest, auth = Depends(require_auth)):\n  1101→    # 检查是否使用新架构\n  1102→    use_new_runtime = request.headers.get(\"X-Use-New-Runtime\") == \"true\"\n  1103→    if use_new_runtime:\n  1104→        # 转发到 Next.js\n  1105→        return RedirectResponse(url=\"/api/chat\", status_code=307)\n  1106→    # 原有逻辑...\n  1107→```\n  1108→\n  1109→#### 2.4 交付物\n  1110→\n  1111→- [ ] `/api/chat/route.ts` 完整实现\n  1112→- [ ] `buildSystemPrompt()` 迁移\n  1113→- [ ] 双路由并行配置\n  1114→- [ ] 前端 `useChat()` 集成测试\n  1115→\n  1116→---\n  1117→\n  1118→### Phase 3: Skills 实现 (Week 3)\n  1119→\n  1120→**目标**: 将 L2 Expert Agents 重构为 Vercel Tools\n  1121→\n  1122→#### 3.1 Divine Skills\n  1123→\n  1124→```typescript\n  1125→// lib/skills/divine-skills.ts\n  1126→import { tool } from 'ai';\n  1127→import { z } from 'zod';\n  1128→\n  1129→const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n  1130→\n  1131→export const divineSkills = {\n  1132→  calculate_bazi: tool({\n  1133→    description: '计算用户的八字命盘，返回四柱、五行、十神、神煞、大运等信息',\n  1134→    parameters: z.object({\n  1135→      birth_datetime: z.string().describe('出生日期时间 (ISO 8601)'),\n  1136→      timezone: z.string().default('Asia/Shanghai'),\n  1137→      include_dayun: z.boolean().default(true),\n  1138→    }),\n  1139→    execute: async ({ birth_datetime, timezone, include_dayun }) => {\n  1140→      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n  1141→        method: 'POST',\n  1142→        headers: { 'Content-Type': 'application/json' },\n  1143→        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),\n  1144→      });\n  1145→      if (!res.ok) throw new Error(`Bazi calculation failed: ${res.status}`);\n  1146→      return res.json();\n  1147→    },\n  1148→  }),\n  1149→\n  1150→  get_bazi_facts: tool({\n  1151→    description: '获取用户已计算的八字事实数据',\n  1152→    parameters: z.object({\n  1153→      user_id: z.number(),\n  1154→    }),\n  1155→    execute: async ({ user_id }) => {\n  1156→      const res = await fetch(`${FASTAPI_URL}/api/bazi/facts/${user_id}`);\n  1157→      return res.json();\n  1158→    },\n  1159→  }),\n  1160→\n  1161→  search_bazi_kb: tool({\n  1162→    description: '搜索八字知识库，获取相关命理解读',\n  1163→    parameters: z.object({\n  1164→      query: z.string().describe('搜索关键词'),\n  1165→      limit: z.number().default(3),\n  1166→    }),\n  1167→    execute: async ({ query, limit }) => {\n  1168→      const res = await fetch(`${FASTAPI_URL}/api/kb/search`, {\n  1169→        method: 'POST',\n  1170→        body: JSON.stringify({ query, limit, category: 'bazi' }),\n  1171→      });\n  1172→      return res.json();\n  1173→    },\n  1174→  }),\n  1175→};\n  1176→```\n  1177→\n  1178→#### 3.2 Heal Skills\n  1179→\n  1180→```typescript\n  1181→// lib/skills/heal-skills.ts\n  1182→export const healSkills = {\n  1183→  log_perma: tool({\n  1184→    description: '记录用户的 PERMA 五维心理状态分数',\n  1185→    parameters: z.object({\n  1186→      dimension: z.enum(['P', 'E', 'R', 'M', 'A']),\n  1187→      score: z.number().min(0).max(10),\n  1188→      note: z.string().optional(),\n  1189→    }),\n  1190→    execute: async ({ dimension, score, note }, { userId }) => {\n  1191→      const res = await fetch(`${FASTAPI_URL}/api/perma/log`, {\n  1192→        method: 'POST',\n  1193→        body: JSON.stringify({ user_id: userId, dimension, score, note }),\n  1194→      });\n  1195→      return res.json();\n  1196→    },\n  1197→  }),\n  1198→\n  1199→  mood_checkin: tool({\n  1200→    description: '快速情绪打卡',\n  1201→    parameters: z.object({\n  1202→      mood_score: z.number().min(1).max(10),\n  1203→      tags: z.array(z.string()).optional(),\n  1204→      note: z.string().optional(),\n  1205→    }),\n  1206→    execute: async (params, { userId }) => {\n  1207→      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {\n  1208→        method: 'POST',\n  1209→        body: JSON.stringify({ user_id: userId, ...params }),\n  1210→      });\n  1211→      return res.json();\n  1212→    },\n  1213→  }),\n  1214→\n  1215→  cbt_reframe: tool({\n  1216→    description: '使用 CBT ABC 模型进行认知重构',\n  1217→    parameters: z.object({\n  1218→      activating_event: z.string().describe('触发事件 (A)'),\n  1219→      belief: z.string().optional().describe('信念/想法 (B)'),\n  1220→      consequence: z.string().optional().describe('情绪/行为后果 (C)'),\n  1221→    }),\n  1222→    execute: async (params) => {\n  1223→      // CBT 引导框架，返回结构化提示让 LLM 继续引导\n  1224→      return {\n  1225→        framework: 'ABC',\n  1226→        current_state: params,\n  1227→        next_step: params.belief ? 'identify_distortion' : 'explore_belief',\n  1228→        guidance_prompt: params.belief\n  1229→          ? `用户的信念是\"${params.belief}\"，请帮助识别可能的认知扭曲...`\n  1230→          : `请引导用户探索触发事件背后的信念和想法...`,\n  1231→      };\n  1232→    },\n  1233→  }),\n  1234→};\n  1235→```\n  1236→\n  1237→#### 3.3 Grow Skills\n  1238→\n  1239→```typescript\n  1240→// lib/skills/grow-skills.ts\n  1241→export const growSkills = {\n  1242→  create_commitment: tool({\n  1243→    description: '创建行动承诺任务',\n  1244→    parameters: z.object({\n  1245→      content: z.string().describe('任务内容'),\n  1246→      category: z.enum(['energy_boost', 'reflection', 'practice', 'social', 'general']),\n  1247→      estimated_minutes: z.number().default(5),\n  1248→      if_then: z.string().optional().describe('If-Then 触发条件'),\n  1249→    }),\n  1250→    execute: async (params, { userId }) => {\n  1251→      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {\n  1252→        method: 'POST',\n  1253→        body: JSON.stringify({ user_id: userId, ...params }),\n  1254→      });\n  1255→      return res.json();\n  1256→    },\n  1257→  }),\n  1258→\n  1259→  goal_setting: tool({\n  1260→    description: '使用 WOOP 模型设定目标',\n  1261→    parameters: z.object({\n  1262→      wish: z.string().describe('愿望/目标'),\n  1263→      outcome: z.string().optional(),\n  1264→      obstacle: z.string().optional(),\n  1265→      plan: z.string().optional(),\n  1266→    }),\n  1267→    execute: async (params, { userId }) => {\n  1268→      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {\n  1269→        method: 'POST',\n  1270→        body: JSON.stringify({ user_id: userId, ...params }),\n  1271→      });\n  1272→      return res.json();\n  1273→    },\n  1274→  }),\n  1275→\n  1276→  update_twin: tool({\n  1277→    description: '更新用户数字孪生数据',\n  1278→    parameters: z.object({\n  1279→      layer: z.enum(['L1', 'L2', 'L3']),\n  1280→      path: z.string().describe('JSON 路径'),\n  1281→      value: z.any(),\n  1282→    }),\n  1283→    execute: async (params, { userId }) => {\n  1284→      const res = await fetch(`${FASTAPI_URL}/api/twin/update`, {\n  1285→        method: 'PUT',\n  1286→        body: JSON.stringify({ user_id: userId, ...params }),\n  1287→      });\n  1288→      return res.json();\n  1289→    },\n  1290→  }),\n  1291→};\n  1292→```\n  1293→\n  1294→#### 3.4 Skills Registry 统一导出\n  1295→\n  1296→```typescript\n  1297→// lib/skills/index.ts\n  1298→import { divineSkills } from './divine-skills';\n  1299→import { healSkills } from './heal-skills';\n  1300→import { growSkills } from './grow-skills';\n  1301→\n  1302→export const allSkills = {\n  1303→  ...divineSkills,\n  1304→  ...healSkills,\n  1305→  ...growSkills,\n  1306→};\n  1307→\n  1308→export function getToolsForCommand(command: string) {\n  1309→  switch (command) {\n  1310→    case '/divine': return divineSkills;\n  1311→    case '/heal': return healSkills;\n  1312→    case '/grow': return growSkills;\n  1313→    default: return allSkills;\n  1314→  }\n  1315→}\n  1316→\n  1317→export { divineSkills, healSkills, growSkills };\n  1318→```\n  1319→\n  1320→#### 3.5 交付物\n  1321→\n  1322→- [ ] `divine-skills.ts` 完整实现\n  1323→- [ ] `heal-skills.ts` 完整实现\n  1324→- [ ] `grow-skills.ts` 完整实现\n  1325→- [ ] Skills Registry 单元测试\n  1326→\n  1327→---\n  1328→\n  1329→### Phase 4: FastAPI 数据服务重构 (Week 4)\n  1330→\n  1331→**目标**: 将 FastAPI 精简为纯数据服务层\n  1332→\n  1333→#### 4.1 新增数据服务 API\n  1334→\n  1335→```python\n  1336→# api/data_routes.py (新文件)\n  1337→from fastapi import APIRouter, Depends\n  1338→from api.deps import require_auth\n  1339→\n  1340→router = APIRouter(prefix=\"/api\", tags=[\"data\"])\n  1341→\n  1342→@router.get(\"/user/context\")\n  1343→async def get_user_context(user_id: int, auth = Depends(require_auth)):\n  1344→    \"\"\"聚合用户上下文，供 Agent Runtime 调用\"\"\"\n  1345→    # 聚合 profile + preferences + facts + active_goals + recent_messages\n  1346→    profile = await _get_profile(user_id)\n  1347→    prefs = await _get_preferences(user_id)\n  1348→    facts = await _get_bazi_facts(user_id)\n  1349→    goals = await _get_active_goals(user_id)\n  1350→    messages = await _get_recent_messages(user_id, limit=10)\n  1351→\n  1352→    return {\n  1353→        \"ok\": True,\n  1354→        \"data\": {\n  1355→            \"profile\": profile,\n  1356→            \"persona_style\": prefs.get(\"persona_style\", \"warm\"),\n  1357→            \"facts\": facts,\n  1358→            \"evidence\": {\n  1359→                \"facts_hash\": facts.get(\"facts_hash\"),\n  1360→                \"kb_refs\": [],  # 后续填充\n  1361→            },\n  1362→            \"active_goals\": goals,\n  1363→            \"recent_messages\": messages,\n  1364→        }\n  1365→    }\n  1366→\n  1367→@router.post(\"/bazi/calculate\")\n  1368→async def calculate_bazi(body: BaziCalculateRequest):\n  1369→    \"\"\"八字计算 (无需登录，供 Landing Page 使用)\"\"\"\n  1370→    from services.bazi_engine import calculate_bazi\n  1371→    result = calculate_bazi(\n  1372→        body.birth_datetime,\n  1373→        body.timezone,\n  1374→        body.include_dayun,\n  1375→    )\n  1376→    return {\"ok\": True, \"data\": result}\n  1377→\n  1378→@router.post(\"/perma/log\")\n  1379→async def log_perma(body: PermaLogRequest, auth = Depends(require_auth)):\n  1380→    \"\"\"PERMA 状态记录\"\"\"\n  1381→    from services.twin_service import update_perma_score\n  1382→    result = await update_perma_score(\n  1383→        auth.user_id,\n  1384→        body.dimension,\n  1385→        body.score,\n  1386→        body.note,\n  1387→    )\n  1388→    return {\"ok\": True, \"data\": result}\n  1389→\n  1390→@router.post(\"/tasks/create\")\n  1391→async def create_task(body: TaskCreateRequest, auth = Depends(require_auth)):\n  1392→    \"\"\"创建承诺任务\"\"\"\n  1393→    from services.bento_service import create_commitment\n  1394→    result = await create_commitment(\n  1395→        auth.user_id,\n  1396→        body.content,\n  1397→        body.category,\n  1398→        body.estimated_minutes,\n  1399→        body.if_then,\n  1400→    )\n  1401→    return {\"ok\": True, \"data\": result}\n  1402→\n  1403→@router.post(\"/goals/create\")\n  1404→async def create_goal(body: GoalCreateRequest, auth = Depends(require_auth)):\n  1405→    \"\"\"创建 WOOP 目标\"\"\"\n  1406→    from services.goal_service import create_goal\n  1407→    result = await create_goal(auth.user_id, body.dict())\n  1408→    return {\"ok\": True, \"data\": result}\n  1409→\n  1410→@router.put(\"/twin/update\")\n  1411→async def update_twin(body: TwinUpdateRequest, auth = Depends(require_auth)):\n  1412→    \"\"\"更新数字孪生\"\"\"\n  1413→    from services.twin_service import update_twin\n  1414→    result = await update_twin(auth.user_id, body.layer, body.path, body.value)\n  1415→    return {\"ok\": True, \"data\": result}\n  1416→\n  1417→@router.post(\"/kb/search\")\n  1418→async def search_kb(body: KBSearchRequest, auth = Depends(require_auth)):\n  1419→    \"\"\"知识库检索\"\"\"\n  1420→    from services.kb_service import search\n  1421→    result = await search(body.query, body.limit, body.category)\n  1422→    return {\"ok\": True, \"data\": result}\n  1423→```\n  1424→\n  1425→#### 4.2 Landing Page API\n  1426→\n  1427→```python\n  1428→# api/landing_routes.py (新文件)\n  1429→from fastapi import APIRouter\n  1430→\n  1431→router = APIRouter(prefix=\"/api/landing\", tags=[\"landing\"])\n  1432→\n  1433→ELEMENT_COLORS = {\n  1434→    \"wood\": [\"#4ade80\", \"#22c55e\"],\n  1435→    \"fire\": [\"#f87171\", \"#ef4444\"],\n  1436→    \"earth\": [\"#fbbf24\", \"#f59e0b\"],\n  1437→    \"metal\": [\"#f5f5f4\", \"#d6d3d1\"],\n  1438→    \"water\": [\"#60a5fa\", \"#3b82f6\"],\n  1439→}\n  1440→\n  1441→ELEMENT_INSIGHTS = {\n  1442→    \"wood\": {\n  1443→        \"en\": \"A strong Wood energy detected. You seek growth, but feel restricted.\",\n  1444→        \"cn\": \"检测到强木能量。你渴望生长，但感到受限。\",\n  1445→    },\n  1446→    \"fire\": {\n  1447→        \"en\": \"Fire burns bright within you. Passion drives you forward.\",\n  1448→        \"cn\": \"火焰在你心中燃烧。热情驱动你前进。\",\n  1449→    },\n  1450→    # ... 其他五行\n  1451→}\n  1452→\n  1453→@router.post(\"/insight\")\n  1454→async def instant_insight(body: InsightRequest):\n  1455→    \"\"\"即时洞察 (无需登录)\"\"\"\n  1456→    if body.input_type == \"bazi\":\n  1457→        # 快速计算日主五行\n  1458→        from services.bazi_engine import quick_day_master\n  1459→        element = quick_day_master(body.value)\n  1460→        insight = ELEMENT_INSIGHTS.get(element, ELEMENT_INSIGHTS[\"wood\"])\n  1461→        return {\n  1462→            \"ok\": True,\n  1463→            \"data\": {\n  1464→                \"type\": \"bazi\",\n  1465→                \"element\": element,\n  1466→                \"insight\": insight[\"en\"],\n  1467→                \"insight_cn\": insight[\"cn\"],\n  1468→                \"orb_colors\": ELEMENT_COLORS.get(element),\n  1469→                \"cta\": \"Unlock Full Analysis →\",\n  1470→            }\n  1471→        }\n  1472→    elif body.input_type == \"emotion\":\n  1473→        # 调用 LLM 生成简短情绪洞察\n  1474→        from services.glm_client import quick_emotion_insight\n  1475→        insight = await quick_emotion_insight(body.value)\n  1476→        return {\n  1477→            \"ok\": True,\n  1478→            \"data\": {\n  1479→                \"type\": \"emotion\",\n  1480→                \"insight\": insight,\n  1481→                \"orb_colors\": [\"#a78bfa\", \"#8b5cf6\"],  # 紫色\n  1482→                \"cta\": \"Start Your Journey →\",\n  1483→            }\n  1484→        }\n  1485→```\n  1486→\n  1487→#### 4.3 删除/废弃的代码\n  1488→\n  1489→```python\n  1490→# 待删除文件\n  1491→services/glm_client.py          # LLM 调用迁移到 TypeScript\n  1492→services/agent_service_client.py # 不再需要\n  1493→\n  1494→# 待废弃端点 (chat_routes.py)\n  1495→# POST /api/chat/send  → 迁移到 Next.js /api/chat\n  1496→# GET  /api/chat/stream → 迁移到 Next.js /api/chat\n  1497→```\n  1498→\n  1499→#### 4.4 交付物\n  1500→\n  1501→- [ ] `api/data_routes.py` 完整实现\n  1502→- [ ] `api/landing_routes.py` 完整实现\n  1503→- [ ] 旧 chat 端点废弃标记\n  1504→- [ ] API 文档更新\n  1505→\n  1506→---\n  1507→\n  1508→### Phase 5: 前端适配 (Week 5)\n  1509→\n  1510→**目标**: 前端切换到 `useChat()` Hook\n  1511→\n  1512→#### 5.1 useChat 集成\n  1513→\n  1514→```typescript\n  1515→// components/chat/chat-panel.tsx\n  1516→'use client';\n  1517→\n  1518→import { useChat } from 'ai/react';\n  1519→import { useState } from 'react';\n  1520→\n  1521→export function ChatPanel({ userId }: { userId: number }) {\n  1522→  const [command, setCommand] = useState<string | null>(null);\n  1523→\n  1524→  const { messages, input, setInput, handleSubmit, isLoading, error } = useChat({\n  1525→    api: '/api/chat',\n  1526→    body: { userId, command },\n  1527→    onFinish: (message) => {\n  1528→      setCommand(null);\n  1529→      // 处理 Tool 调用结果\n  1530→      if (message.toolInvocations?.length) {\n  1531→        refreshDashboard(message.toolInvocations);\n  1532→      }\n  1533→    },\n  1534→  });\n  1535→\n  1536→  const handleCommandSubmit = (cmd: string, text: string) => {\n  1537→    setCommand(cmd);\n  1538→    setInput(text);\n  1539→    // useChat 会自动提交\n  1540→  };\n  1541→\n  1542→  return (\n  1543→    <div className=\"flex flex-col h-full\">\n  1544→      {/* Messages */}\n  1545→      <div className=\"flex-1 overflow-y-auto\">\n  1546→        {messages.map((m) => (\n  1547→          <MessageBubble key={m.id} message={m} />\n  1548→        ))}\n  1549→      </div>\n  1550→\n  1551→      {/* Input */}\n  1552→      <ChatInput\n  1553→        value={input}\n  1554→        onChange={setInput}\n  1555→        onSubmit={handleSubmit}\n  1556→        onCommand={handleCommandSubmit}\n  1557→        isLoading={isLoading}\n  1558→      />\n  1559→    </div>\n  1560→  );\n  1561→}\n  1562→```\n  1563→\n  1564→#### 5.2 CommandPalette 集成\n  1565→\n  1566→```typescript\n  1567→// components/chat/command-palette.tsx\n  1568→const COMMANDS = [\n  1569→  { cmd: '/divine', label: '玄学测算', icon: '🔮' },\n  1570→  { cmd: '/heal', label: '心理疗愈', icon: '💚' },\n  1571→  { cmd: '/grow', label: '成长教练', icon: '🌱' },\n  1572→  { cmd: '/status', label: '状态查看', icon: '📊' },\n  1573→];\n  1574→\n  1575→export function CommandPalette({ onSelect, visible }: CommandPaletteProps) {\n  1576→  if (!visible) return null;\n  1577→\n  1578→  return (\n  1579→    <div className=\"absolute bottom-full left-0 w-full bg-background border rounded-lg shadow-lg p-2\">\n  1580→      {COMMANDS.map((c) => (\n  1581→        <button\n  1582→          key={c.cmd}\n  1583→          onClick={() => onSelect(c.cmd)}\n  1584→          className=\"flex items-center gap-2 w-full p-2 hover:bg-accent rounded\"\n  1585→        >\n  1586→          <span>{c.icon}</span>\n  1587→          <span className=\"font-medium\">{c.cmd}</span>\n  1588→          <span className=\"text-muted-foreground\">{c.label}</span>\n  1589→        </button>\n  1590→      ))}\n  1591→    </div>\n  1592→  );\n  1593→}\n  1594→```\n  1595→\n  1596→#### 5.3 Tool Result 渲染\n  1597→\n  1598→```typescript\n  1599→// components/chat/tool-result-card.tsx\n  1600→export function ToolResultCard({ invocation }: { invocation: ToolInvocation }) {\n  1601→  const { toolName, result, state } = invocation;\n  1602→\n  1603→  if (state === 'partial-call') {\n  1604→    return <LoadingCard toolName={toolName} />;\n  1605→  }\n  1606→\n  1607→  switch (toolName) {\n  1608→    case 'calculate_bazi':\n  1609→      return <BaziResultCard data={result} />;\n  1610→    case 'mood_checkin':\n  1611→      return <MoodCheckinCard data={result} />;\n  1612→    case 'create_commitment':\n  1613→      return <CommitmentCard data={result} />;\n  1614→    default:\n  1615→      return <GenericResultCard data={result} />;\n  1616→  }\n  1617→}\n  1618→```\n  1619→\n  1620→#### 5.4 交付物\n  1621→\n  1622→- [ ] `useChat()` 集成\n  1623→- [ ] `CommandPalette` 组件\n  1624→- [ ] `ToolResultCard` 组件\n  1625→- [ ] 端到端测试\n  1626→\n  1627→---\n  1628→\n  1629→### Phase 6: 清理与优化 (Week 6)\n  1630→\n  1631→**目标**: 删除旧代码，性能优化\n  1632→\n  1633→#### 6.1 删除列表\n  1634→\n  1635→```bash\n  1636→# 删除文件\n  1637→rm services/glm_client.py\n  1638→rm services/agent_service_client.py\n  1639→\n  1640→# 删除 agent_service 目录 (已迁移到 Next.js)\n  1641→rm -rf agent_service/\n  1642→\n  1643→# 清理 chat_routes.py 中的旧端点\n  1644→# - /api/chat/send\n  1645→# - /api/chat/stream\n  1646→```\n  1647→\n  1648→#### 6.2 API 路由清理\n  1649→\n  1650→```python\n  1651→# api/main.py - 更新路由注册\n  1652→app.include_router(auth_routes.router)\n  1653→app.include_router(data_routes.router)      # 新增\n  1654→app.include_router(landing_routes.router)   # 新增\n  1655→app.include_router(dashboard_routes.router)\n  1656→app.include_router(report_routes.router)\n  1657→# 删除: app.include_router(chat_routes.router)\n  1658→```\n  1659→\n  1660→#### 6.3 性能优化\n  1661→\n  1662→1. **Context 缓存**: 用户上下文 Redis 缓存 (TTL 5min)\n  1663→2. **批量 Tool 调用**: 合并多个 fetch 请求\n  1664→3. **流式首字优化**: 减少 System Prompt 长度\n  1665→\n  1666→#### 6.4 监控与日志\n  1667→\n  1668→```typescript\n  1669→// 添加 Tool 调用监控\n  1670→const result = streamText({\n  1671→  // ...\n  1672→  onStepFinish({ stepType, toolCalls, toolResults }) {\n  1673→    // 记录 Tool 调用耗时\n  1674→    logger.info('Step finished', {\n  1675→      stepType,\n  1676→      toolCount: toolCalls?.length,\n  1677→      latency: Date.now() - startTime,\n  1678→    });\n  1679→  },\n  1680→});\n  1681→```\n  1682→\n  1683→#### 6.5 交付物\n  1684→\n  1685→- [ ] 旧文件删除\n  1686→- [ ] API 路由更新\n  1687→- [ ] Redis 缓存配置\n  1688→- [ ] 监控 Dashboard\n  1689→\n  1690→---\n  1691→\n  1692→## 4. 风险与缓解\n  1693→\n  1694→### 4.1 兼容性风险\n  1695→\n  1696→| 风险点 | 影响范围 | 缓解措施 |\n  1697→|--------|----------|----------|\n  1698→| API 签名变更 | 前端所有 Chat 调用 | 双路由并行，Feature Flag 控制 |\n  1699→| A2UI 格式变化 | 消息渲染组件 | 保持 JSON 结构兼容，仅改传输方式 |\n  1700→| CSRF 处理 | 所有 POST 请求 | Next.js API Route 同源，无需 CSRF |\n  1701→| Cookie 传递 | 认证流程 | `credentials: 'include'` 配置 |\n  1702→\n  1703→### 4.2 回滚方案\n  1704→\n  1705→```typescript\n  1706→// Feature Flag 控制\n  1707→const USE_NEW_RUNTIME = process.env.USE_NEW_RUNTIME === 'true';\n  1708→\n  1709→// 前端路由选择\n  1710→const chatEndpoint = USE_NEW_RUNTIME ? '/api/chat' : '/api/chat/send';\n  1711→```\n  1712→\n  1713→### 4.3 灰度发布\n  1714→\n  1715→1. **Week 1-4**: 内部测试环境验证\n  1716→2. **Week 5**: 10% 用户灰度\n  1717→3. **Week 6**: 50% 用户灰度\n  1718→4. **Week 7**: 全量发布\n  1719→\n  1720→---\n  1721→\n  1722→## 5. 验收标准\n  1723→\n  1724→### 5.1 功能验收\n  1725→\n  1726→| 功能 | 验收标准 |\n  1727→|------|----------|\n  1728→| Chat 对话 | 流式输出正常，首字 < 500ms |\n  1729→| `/divine` 指令 | 八字计算正确，结果渲染正常 |\n  1730→| `/heal` 指令 | PERMA 记录成功，CBT 引导完整 |\n  1731→| `/grow` 指令 | 目标/任务创建成功 |\n  1732→| Landing Page | Insight 生成 < 1s，Orb 颜色正确 |\n  1733→| Tool Calling | 多步推理 (maxSteps=5) 正常 |\n  1734→\n  1735→### 5.2 性能验收\n  1736→\n  1737→| 指标 | 目标值 | 当前值 |\n  1738→|------|--------|--------|\n  1739→| 首字延迟 (P50) | < 500ms | ~800ms |\n  1740→| 首字延迟 (P95) | < 1.5s | ~2s |\n  1741→| Tool 调用延迟 | < 200ms | N/A |\n  1742→| 端到端响应 (P50) | < 3s | ~4s |\n  1743→\n  1744→### 5.3 代码质量\n  1745→\n  1746→- [ ] TypeScript 严格模式\n  1747→- [ ] Zod Schema 100% 覆盖\n  1748→- [ ] 单元测试覆盖率 > 80%\n  1749→- [ ] E2E 测试通过\n  1750→\n  1751→---\n  1752→\n  1753→## 6. 附录\n  1754→\n  1755→### 6.1 环境变量\n  1756→\n  1757→```bash\n  1758→# .env.local (Next.js)\n  1759→FASTAPI_URL=http://localhost:8230\n  1760→GOOGLE_API_KEY=xxx\n  1761→ANTHROPIC_API_KEY=xxx\n  1762→GLM_API_KEY=xxx\n  1763→USE_NEW_RUNTIME=true\n  1764→```\n  1765→\n  1766→### 6.2 依赖更新\n  1767→\n  1768→```json\n  1769→// package.json\n  1770→{\n  1771→  \"dependencies\": {\n  1772→    \"ai\": \"^4.0.0\",\n  1773→    \"@ai-sdk/google\": \"^1.0.0\",\n  1774→    \"@ai-sdk/anthropic\": \"^1.0.0\",\n  1775→    \"zod\": \"^3.22.0\"\n  1776→  }\n  1777→}\n  1778→```\n  1779→\n  1780→### 6.3 参考文档\n  1781→\n  1782→- [Vercel AI SDK 文档](https://sdk.vercel.ai/docs)\n  1783→- [os_design_v3.md §1.4-1.5](./os_design_v3.md)\n  1784→- [frontend_final_v3.md §2.6](./frontend_final_v3.md)\n  1785→- [system_design_final_mvp_v3.md §7.0.1](./system_design_final_mvp_v3.md)\n  1786→- [admin_v3.md](./admin_v3.md) - Admin System 设计，可与本重构并行开发\n  1787→\n  1788→### 6.4 并行开发项\n  1789→\n  1790→| 项目 | 描述 | 技术栈 | 依赖关系 |\n  1791→|------|------|--------|----------|\n  1792→| **Admin System** | 后台管理驾驶舱 | Next.js App Router + shadcn/ui + Monaco | Phase 1 完成后可启动 |\n  1793→| **Landing Page** | Digital Mirror 首页 | Next.js + React Three Fiber | 独立开发 |\n  1794→\n  1795→> **注**: Admin System 的 Agent Studio 模块依赖本重构中的 `admin_prompts` 表和 Prompt 热加载机制（Phase 4），建议在 Phase 4 完成后进行 Admin 前端开发。\n  1796→\n  1797→---\n  1798→\n  1799→*文档版本: v1.0*\n  1800→*创建日期: 2026-01-01*\n  1801→*作者: Claude (Anthropic)*\n  1802→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"aaff29e3-d6ba-4317-88d7-35f7fc8dde92","timestamp":"2026-01-01T15:29:40.154Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md","content":"# Fortune AI 后端重构计划 (v4.2 Vercel AI SDK Edition)\n\n**文档类型**: Backend Refactoring Plan\n**版本**: v4.2\n**日期**: 2026-01-01\n**目标**: 将后端架构从 Python-centric 迁移到 Vercel AI SDK Driven 架构\n\n---\n\n## 0. 执行摘要\n\n### 0.1 重构目标\n\n将 Fortune AI 后端从当前的 **Python FastAPI 全栈架构** 重构为 **Vercel AI SDK Driven 分层架构**：\n\n| 当前状态 | 目标状态 |\n|----------|----------|\n| FastAPI 承载 AI 推理 + 数据服务 | Next.js API Route 承载 AI 推理 |\n| `glm_client.py` 直接调用 LLM | `streamText()` + Multi-Model Provider |\n| 自定义 SSE 格式 | `toDataStreamResponse()` 标准流 |\n| Python L2 Agents | TypeScript `tool()` Skills |\n| agent_service 辅助角色 | Agent Runtime 核心角色 |\n\n### 0.2 核心收益\n\n1. **端到端流式渲染**: `useChat()` → `streamText()` → `toDataStreamResponse()`\n2. **多模型热切换**: GLM-4.5 / Gemini / Claude 通过 Vercel AI Gateway 动态切换\n3. **Skills 可插拔**: Tool Calling 标准化，新增 Expert Agent 只需添加 `tool()` 定义\n4. **maxSteps 多步推理**: 单次请求可多次 Tool 调用后综合输出\n5. **类型安全**: Zod Schema 参数验证\n\n### 0.3 风险评估\n\n| 风险 | 等级 | 缓解措施 |\n|------|:----:|----------|\n| API 兼容性破坏 | 🔴 高 | 双路由并行期，逐步迁移 |\n| 前端 CSRF 问题 | 🟡 中 | Next.js API Route 同源，无跨域 |\n| 数据服务调用延迟 | 🟡 中 | Tool execute 批量聚合，缓存热点数据 |\n| 团队 TypeScript 熟练度 | 🟢 低 | 现有 agent_service 已有 TS 基础 |\n| maxSteps 重复写入 | 🔴 高 | 幂等性设计 + finalize 机制 |\n| 流式中断数据不一致 | 🔴 高 | 流式与事务解耦，finalize 统一提交 |\n\n### 0.4 目标后端形态（三运行单元）\n\n重构后的后端拆分为 **3 个可独立演进的运行单元**：\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         目标架构 (v4.2)                                       │\n└─────────────────────────────────────────────────────────────────────────────┘\n\nBrowser\n    │\n    │ HTTP\n    ▼\n┌─────────────────────────────────────────────────────────────────────────────┐\n│  Reverse Proxy (Nginx/Caddy :80/:443)                                        │\n│  ┌─────────────────────────────────────────────────────────────────────────┐│\n│  │  路由规则:                                                               ││\n│  │  /api/chat          → Next.js (:8231)  # Agent Runtime                  ││\n│  │  /api/landing/*     → Next.js (:8231)  # Landing Page API               ││\n│  │  /api/*             → FastAPI (:8230)  # Data Service                   ││\n│  │  /new/*             → Next.js (:8231)  # Frontend                       ││\n│  │  /admin/*           → Next.js (:8231)  # Admin System                   ││\n│  └─────────────────────────────────────────────────────────────────────────┘│\n└─────────────────────────────────────────────────────────────────────────────┘\n        │                           │                           │\n        ▼                           ▼                           ▼\n┌───────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐\n│ Next.js Agent     │  │ FastAPI Data Service    │  │ Python Cold Path Worker │\n│ Runtime (:8231)   │  │ (:8230)                 │  │ (Cron/Queue)            │\n├───────────────────┤  ├─────────────────────────┤  ├─────────────────────────┤\n│ • streamText()    │  │ • Auth/Session          │  │ • Insight Agent         │\n│ • tool() Skills   │  │ • 领域写入 (SSOT)       │  │ • Memory 沉淀           │\n│ • useChat() 流式  │  │ • 确定性计算            │  │ • 异步报告生成          │\n│ • Multi-Model Hub │  │ • Internal APIs         │  │ • 数据清洗              │\n└───────────────────┘  └─────────────────────────┘  └─────────────────────────┘\n        │                           │                           │\n        │     fetch() / gRPC        │                           │\n        └───────────────────────────┴───────────────────────────┘\n                                    │\n                                    ▼\n                          PostgreSQL (fortune_ai)\n```\n\n| 运行单元 | 职责 | 技术栈 | 部署 |\n|----------|------|--------|------|\n| **Agent Runtime** | AI 推理、流式响应、Tool Calling | Next.js + Vercel AI SDK | 可独立扩缩 |\n| **Data Service** | Auth、SSOT 写入、确定性计算 | FastAPI + PostgreSQL | 有状态，单实例优先 |\n| **Cold Path Worker** | 后台分析、Memory 沉淀 | Python + Celery/Cron | 异步，失败不阻塞 |\n\n### 0.5 信任边界与安全原则\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         信任边界 (Trust Boundary)                            │\n└─────────────────────────────────────────────────────────────────────────────┘\n\n                  ┌─────────────────────────────────────────┐\n                  │            Untrusted Zone               │\n                  │                                         │\n                  │   Browser / Mobile App / Third Party    │\n                  │                                         │\n                  │   ⚠️ 永远不能信任来自这里的:             │\n                  │      • userId                           │\n                  │      • role / permissions               │\n                  │      • 任何敏感标识                      │\n                  └───────────────────┬─────────────────────┘\n                                      │\n                    Cookie (fortune_session) + HTTPS Only\n                                      │\n                                      ▼\n                  ┌─────────────────────────────────────────┐\n                  │            Trusted Zone                 │\n                  │                                         │\n                  │   Next.js API Route / FastAPI           │\n                  │                                         │\n                  │   ✅ userId 只能从 Session 解出          │\n                  │   ✅ session_id 可由前端传但必须校验归属 │\n                  │   ✅ Internal API 需 service token       │\n                  └─────────────────────────────────────────┘\n```\n\n**关键规则**：\n\n1. **userId 不传**: 前端请求体永远不包含 `userId`，由服务端从 Cookie Session 解出\n2. **session_id 校验**: 如前端传 `session_id`，后端必须校验该 session 归属当前用户\n3. **Internal API 隔离**: `/internal/*` 端点不暴露给浏览器，需 service token 或 IP 白名单\n\n### 0.6 工程化原则（决定重构成败）\n\n#### 0.6.1 流式与事务解耦\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                    Chat Run Lifecycle (流式生命周期)                          │\n└─────────────────────────────────────────────────────────────────────────────┘\n\n用户消息 ──▶ run/start ──▶ streamText() ──▶ Tool调用(N次) ──▶ run/finalize\n   │            │              │                │                  │\n   │            │              │                │                  │\n   ▼            ▼              ▼                ▼                  ▼\n┌────────┐ ┌─────────┐   ┌──────────┐    ┌───────────┐      ┌─────────────┐\n│用户消息│ │ run_id  │   │ 流式输出 │    │ 工具结果  │      │ 统一提交    │\n│ 入库  │ │ 记录    │   │ (不落库) │    │ (内存暂存)│      │ 事务写入    │\n└────────┘ └─────────┘   └──────────┘    └───────────┘      └─────────────┘\n\n                                                                   │\n                                                                   ▼\n                                                          ┌─────────────────┐\n                                                          │ 一次事务包含:   │\n                                                          │ • assistant msg │\n                                                          │ • commitments   │\n                                                          │ • tool_log      │\n                                                          │ • twin updates  │\n                                                          └─────────────────┘\n```\n\n**规则**：\n- 流式过程中只做\"可重放\"记录（run_id、用户消息）\n- Tool 执行结果暂存内存，不直接写 DB\n- `finalize` 时统一事务提交\n- 中断则标记 `aborted`，避免半条消息进 SSOT\n\n#### 0.6.2 全链路 correlation_id\n\n```typescript\n// Next.js API Route 入口生成\nexport async function POST(req: Request) {\n  const correlationId = req.headers.get('x-correlation-id')\n    || `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n\n  // 透传到 FastAPI\n  const context = await fetch(`${FASTAPI_URL}/internal/context`, {\n    headers: { 'X-Correlation-ID': correlationId },\n  });\n\n  // 透传到 Tool 执行\n  const result = streamText({\n    // ...\n    onStepFinish({ toolCalls }) {\n      logger.info({ correlationId, toolCalls }, 'Step finished');\n    },\n  });\n}\n```\n\n**用途**：串联\"对话 → Tool 调用 → 写入 → 失败原因\"，便于 debug 和审计。\n\n#### 0.6.3 统一错误语义\n\n```typescript\n// Public API 响应格式\ninterface ApiResponse<T> {\n  ok: boolean;\n  data?: T;\n  error?: {\n    code: string;        // 'AUTH_REQUIRED' | 'RATE_LIMITED' | 'TOOL_FAILED' | ...\n    message: string;     // 用户可读消息\n    detail?: unknown;    // 调试信息（仅 dev 环境）\n    correlation_id?: string;\n  };\n}\n\n// Tool 执行失败返回（可渲染为 Toast 或 ErrorCard）\ninterface ToolError {\n  type: 'tool_error';\n  tool_name: string;\n  error_code: string;\n  user_message: string;  // \"八字计算服务暂时不可用\"\n}\n```\n\n---\n\n## 1. 现状分析\n\n### 1.1 当前架构\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         当前架构 (v4.0/v4.1)                                  │\n└─────────────────────────────────────────────────────────────────────────────┘\n\nBrowser (:8231/new)\n    │\n    │ HTTP (fetch + SSE)\n    ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  FastAPI (:8230)                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐  │\n│  │  19 Route Files                                                     │  │\n│  │  auth_routes / chat_routes / dashboard_routes / bazi_routes ...    │  │\n│  └────────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Services Layer           ▼                                        │  │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │  │\n│  │  │glm_client.py│ │bazi_engine  │ │twin_service │ │goal_service │  │  │\n│  │  │ (LLM 调用)  │ │  (L0 计算) │ │ (状态管理) │ │ (目标管理) │  │  │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │  │\n│  └───────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Agent Service Client     │ (HTTP 调用 TypeScript Agent)          │  │\n│  └───────────────────────────┼───────────────────────────────────────┘  │\n└──────────────────────────────┼───────────────────────────────────────────┘\n                               │\n                               ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  Agent Service (:3000) - Express + Vercel AI SDK                          │\n│  ┌─────────────────────────────────────────────────────────────────────┐ │\n│  │  coach.ts: runCoachAgent() - 但仅作为辅助，主流量仍走 Python         │ │\n│  └─────────────────────────────────────────────────────────────────────┘ │\n└──────────────────────────────────────────────────────────────────────────┘\n                               │\n                               ▼\n                        PostgreSQL (fortune_ai)\n```\n\n### 1.2 现有文件清单\n\n**API Routes (19 个)**:\n```\napi/\n├── auth_routes.py        # 认证 (register/login/logout)\n├── chat_routes.py        # 对话 (send/stream) ⚠️ 核心重构对象\n├── dashboard_routes.py   # Dashboard Zone B\n├── bazi_routes.py        # 八字计算\n├── bento_routes.py       # Bento 6 卡片 (legacy)\n├── twin_routes.py        # 数字孪生\n├── goal_routes.py        # 目标管理\n├── reflection_routes.py  # 复盘\n├── report_routes.py      # 深度报告\n├── poster_routes.py      # 海报生成\n├── yunshi_routes.py      # 运势\n├── plan_routes.py        # 计划\n├── kb_routes.py          # 知识库\n├── session_routes.py     # 会话管理\n├── user_routes.py        # 用户资料\n├── social_routes.py      # 社交\n├── push_routes.py        # 推送\n├── currency_routes.py    # 货币\n├── jitai_routes.py       # 吉台\n├── agent_tool.py         # Agent 工具 API\n├── deps.py               # 依赖注入\n└── main.py               # 入口\n```\n\n**Services (核心)**:\n```\nservices/\n├── glm_client.py          # ⚠️ 待删除：直接 LLM 调用\n├── chat_service.py        # 会话消息管理\n├── bazi_engine.py         # L0 八字计算 ✅ 保留\n├── bazi_facts.py          # 事实提取 ✅ 保留\n├── twin_service.py        # 数字孪生 ✅ 保留\n├── goal_service.py        # 目标管理 ✅ 保留\n├── reflection_service.py  # 复盘 ✅ 保留\n├── soul_os.py             # 上下文组装 ⚠️ 重构\n├── agent_service_client.py # ⚠️ 待删除：改为 Next.js 内部调用\n└── ...\n```\n\n### 1.3 关键痛点\n\n| 痛点 | 影响 | 根因 |\n|------|------|------|\n| 双语言交互复杂 | 维护成本高 | Python/TS 边界不清晰 |\n| 流式渲染非标准 | 前端适配困难 | 自定义 SSE 格式 |\n| LLM 调用分散 | 难以统一管理 | glm_client + agent_service 并存 |\n| Tool Calling 手动 | 扩展困难 | 无标准化 Skills 框架 |\n| A2UI 非流式 | 首字延迟高 | JSON 整体返回 |\n\n---\n\n## 2. 目标架构\n\n### 2.1 架构图\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         目标架构 (v4.2 Vercel AI SDK)                         │\n└─────────────────────────────────────────────────────────────────────────────┘\n\nBrowser\n    │\n    │ useChat() Hook\n    ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  Next.js (:8231)                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐  │\n│  │  app/api/chat/route.ts   ← Agent Runtime (核心)                     │  │\n│  │  ┌──────────────────────────────────────────────────────────────┐ │  │\n│  │  │  streamText({                                                 │ │  │\n│  │  │    model: selectModel(),     // GLM / Gemini / Claude         │ │  │\n│  │  │    system: buildSystemPrompt(context),                        │ │  │\n│  │  │    tools: getToolsForMode(mode),                              │ │  │\n│  │  │    maxSteps: 5,                                               │ │  │\n│  │  │  }) → toDataStreamResponse()                                  │ │  │\n│  │  └──────────────────────────────────────────────────────────────┘ │  │\n│  └────────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Skills Registry          ▼                                        │  │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │  │\n│  │  │Divine Skills│ │ Heal Skills │ │ Grow Skills │                  │  │\n│  │  │calculate_   │ │log_perma    │ │covey_matrix │                  │  │\n│  │  │  bazi/ziwei │ │cbt_reframe  │ │goal_setting │                  │  │\n│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                  │  │\n│  └─────────┼───────────────┼───────────────┼─────────────────────────┘  │\n└────────────┼───────────────┼───────────────┼────────────────────────────┘\n             │               │               │\n             │ fetch()       │ fetch()       │ fetch()\n             ▼               ▼               ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  FastAPI (:8230) - 纯数据服务层                                            │\n│  ┌────────────────────────────────────────────────────────────────────┐  │\n│  │  Data Service APIs (无 LLM 调用)                                    │  │\n│  │  /api/bazi/calculate     /api/perma/log      /api/goals/create     │  │\n│  │  /api/user/context       /api/twin/update    /api/tasks/create     │  │\n│  │  /api/landing/insight    /api/kb/search      /api/checkin/mood     │  │\n│  └────────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Services Layer (保留)    │                                        │  │\n│  │  bazi_engine / twin_service / goal_service / reflection_service   │  │\n│  └───────────────────────────────────────────────────────────────────┘  │\n└──────────────────────────────────────────────────────────────────────────┘\n                               │\n                               ▼\n                        PostgreSQL (fortune_ai)\n```\n\n### 2.2 职责边界\n\n| 层级 | 运行环境 | 职责 | 技术栈 |\n|------|----------|------|--------|\n| **Frontend** | Browser | UI 渲染、流式展示、Command 输入 | React + `useChat()` |\n| **Agent Runtime** | Next.js API Route | AI 推理、Tool Calling、流式输出 | `streamText()` + `tool()` |\n| **Skills Registry** | Next.js | 可插拔技能定义 | Zod Schema + execute |\n| **Data Service** | FastAPI | L0/L1 数据 CRUD、计算逻辑 | Python + PostgreSQL |\n| **Insight Agent** | Cron Worker | Cold Path 数据沉淀 | Python |\n\n### 2.3 API 端点规划\n\n**Next.js API Routes (新增)**:\n```typescript\n// Agent Runtime\nPOST /api/chat           // streamText() 主入口\nPOST /api/command        // /divine /heal /grow 指令路由\n\n// Landing Page (可选迁移)\nPOST /api/landing/insight  // 即时洞察 (无需登录)\n```\n\n**FastAPI Data Service (重构)**:\n```python\n# L0 Base Data\nGET  /api/user/context        # 聚合用户上下文\nGET  /api/user/profile        # 用户资料\nPUT  /api/user/profile        # 更新资料\n\n# L1 Module Data - Divine\nPOST /api/bazi/calculate      # 八字计算\nPOST /api/ziwei/calculate     # 紫微计算\nGET  /api/bazi/facts/{user_id}  # 获取事实\n\n# L1 Module Data - Heal\nPOST /api/perma/log           # PERMA 记录\nGET  /api/perma/query         # PERMA 查询\nPOST /api/checkin/mood        # 情绪打卡\n\n# L1 Module Data - Grow\nPOST /api/goals/create        # 创建目标\nGET  /api/goals/active        # 活跃目标\nPOST /api/tasks/create        # 创建任务\nPUT  /api/tasks/{id}/complete # 完成任务\n\n# Twin\nGET  /api/twin/{user_id}      # 获取孪生数据\nPUT  /api/twin/update         # 更新孪生\n\n# KB\nPOST /api/kb/search           # 知识库检索\n\n# 保留 (暂不迁移)\n/api/auth/*                   # 认证\n/api/report/*                 # 深度报告\n/api/poster/*                 # 海报\n/api/dashboard/*              # Dashboard\n```\n\n### 2.4 Internal Contract APIs（内部契约）\n\n为 Agent Runtime 与 FastAPI 之间的通信定义两个核心契约，比继续复用 `chat_routes.py` 更干净：\n\n#### 2.4.1 Context API（上下文聚合）\n\n```python\n# FastAPI: api/internal_routes.py\n# 只对内部调用开放，需 X-Service-Token 或 IP 白名单\n\n@router.get(\"/internal/context\")\nasync def get_context(\n    session_id: str = Query(None),\n    user: AuthUser = Depends(get_current_user_from_cookie),\n    x_correlation_id: str = Header(None),\n) -> ContextResponse:\n    \"\"\"\n    一次性聚合用户上下文，减少 Agent Runtime 的 fetch 次数\n    \"\"\"\n    return ContextResponse(\n        l0=UserProfile(\n            user_id=user.id,\n            display_name=user.name,\n            birth_info=get_birth_info(user.id),\n            preferences=get_preferences(user.id),\n        ),\n        l1=ModuleData(\n            bazi_chart=get_latest_bazi(user.id),\n            perma_recent=get_perma_summary(user.id, days=7),\n            active_goals=get_active_goals(user.id, limit=3),\n            twin_status=get_twin_status(user.id),\n        ),\n        policy_flags=PolicyFlags(\n            allow_roast=user.preferences.get('allow_roast', False),\n            model_override=user.preferences.get('model'),\n        ),\n        history_excerpt=get_recent_messages(user.id, limit=10),\n    )\n```\n\n**Response Schema**:\n```typescript\ninterface ContextResponse {\n  l0: {\n    user_id: string;\n    display_name: string;\n    birth_info: { year: number; month: number; day: number; hour?: number };\n    preferences: Record<string, unknown>;\n  };\n  l1: {\n    bazi_chart?: BaziChart;\n    perma_recent?: PermaScore[];\n    active_goals?: Goal[];\n    twin_status?: TwinStatus;\n  };\n  policy_flags: {\n    allow_roast: boolean;\n    model_override?: 'glm' | 'gemini' | 'claude';\n  };\n  history_excerpt: Message[];\n}\n```\n\n#### 2.4.2 Chat Persistence API（流式持久化）\n\n```python\n# FastAPI: api/internal_routes.py\n\n@router.post(\"/internal/chat/run/start\")\nasync def start_chat_run(\n    request: StartRunRequest,\n    user: AuthUser = Depends(get_current_user_from_cookie),\n) -> StartRunResponse:\n    \"\"\"\n    流式开始时调用：记录 run_id + 用户消息\n    \"\"\"\n    run_id = str(uuid4())\n\n    # 只写入用户消息（assistant 消息在 finalize 写入）\n    await db.execute(\"\"\"\n        INSERT INTO chat_runs (id, user_id, session_id, status, started_at)\n        VALUES ($1, $2, $3, 'running', NOW())\n    \"\"\", run_id, user.id, request.session_id)\n\n    await db.execute(\"\"\"\n        INSERT INTO chat_messages (run_id, role, content, created_at)\n        VALUES ($1, 'user', $2, NOW())\n    \"\"\", run_id, request.user_message)\n\n    return StartRunResponse(run_id=run_id)\n\n@router.post(\"/internal/chat/run/finalize\")\nasync def finalize_chat_run(\n    request: FinalizeRunRequest,\n    user: AuthUser = Depends(get_current_user_from_cookie),\n) -> FinalizeRunResponse:\n    \"\"\"\n    流式结束时调用：一次事务写入所有副作用\n    \"\"\"\n    async with db.transaction():\n        # 1. 更新 run 状态\n        await db.execute(\"\"\"\n            UPDATE chat_runs\n            SET status = $2, finished_at = NOW()\n            WHERE id = $1\n        \"\"\", request.run_id, 'completed' if request.success else 'aborted')\n\n        # 2. 写入 assistant 消息\n        if request.assistant_message:\n            await db.execute(\"\"\"\n                INSERT INTO chat_messages (run_id, role, content, created_at)\n                VALUES ($1, 'assistant', $2, NOW())\n            \"\"\", request.run_id, request.assistant_message)\n\n        # 3. 写入 tool 调用日志\n        for tool_log in request.tool_logs:\n            await db.execute(\"\"\"\n                INSERT INTO tool_invocations\n                (run_id, tool_name, input, output, latency_ms, idempotency_key)\n                VALUES ($1, $2, $3, $4, $5, $6)\n                ON CONFLICT (idempotency_key) DO NOTHING\n            \"\"\", request.run_id, tool_log.name, tool_log.input,\n                tool_log.output, tool_log.latency_ms, tool_log.idempotency_key)\n\n        # 4. 写入 commitments（承诺/任务）\n        for commitment in request.commitments:\n            await create_commitment(user.id, commitment)\n\n        # 5. 更新 twin 状态\n        if request.twin_updates:\n            await update_twin(user.id, request.twin_updates)\n\n    return FinalizeRunResponse(ok=True)\n```\n\n**Request/Response Schema**:\n```typescript\ninterface StartRunRequest {\n  session_id?: string;\n  user_message: string;\n  correlation_id: string;\n}\n\ninterface FinalizeRunRequest {\n  run_id: string;\n  success: boolean;\n  assistant_message?: string;\n  tool_logs: ToolLog[];\n  commitments: Commitment[];\n  twin_updates?: TwinUpdate;\n}\n\ninterface ToolLog {\n  name: string;\n  input: Record<string, unknown>;\n  output: Record<string, unknown>;\n  latency_ms: number;\n  idempotency_key: string;  // 用于防止 maxSteps 重复写入\n}\n```\n\n### 2.5 A2UI 迁移方案（ToolResultCard）\n\n将 A2UI 从\"整段 JSON 作为 assistant content\"迁移为\"ToolResultCard + 教练表达\"模式：\n\n#### 2.5.1 现状 vs 目标\n\n```\n【现状】A2UI 作为 assistant message content\n┌─────────────────────────────────────────────────────────────────┐\n│ { role: 'assistant',                                            │\n│   content: '{\"type\":\"a2ui\",\"cards\":[{\"type\":\"bazi_chart\",...}]}'│\n│ }                                                               │\n└─────────────────────────────────────────────────────────────────┘\n\n【目标】ToolResultCard + assistant content 分离\n┌─────────────────────────────────────────────────────────────────┐\n│ {                                                               │\n│   role: 'assistant',                                            │\n│   content: '根据你的八字，你是一个...',  // 教练表达           │\n│   toolInvocations: [                                            │\n│     {                                                           │\n│       toolName: 'calculate_bazi',                               │\n│       state: 'result',                                          │\n│       result: {                                                 │\n│         type: 'a2ui_card',                                      │\n│         card_type: 'bazi_chart',                                │\n│         data: { ... }                                           │\n│       }                                                         │\n│     }                                                           │\n│   ]                                                             │\n│ }                                                               │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n#### 2.5.2 ToolResultCard Schema\n\n```typescript\n// lib/types/a2ui-card.ts\n\ninterface ToolResultCard {\n  type: 'a2ui_card';\n  card_type: CardType;\n  data: CardData;\n  actions?: CardAction[];\n}\n\ntype CardType =\n  | 'bazi_chart'      // 八字命盘\n  | 'perma_radar'     // PERMA 雷达图\n  | 'goal_progress'   // 目标进度\n  | 'commitment_card' // 承诺卡片\n  | 'insight_card'    // 洞察卡片\n  | 'kline_chart'     // K线图\n  | 'error_toast';    // 错误提示\n\ninterface CardAction {\n  type: 'accept' | 'done' | 'skip' | 'navigate' | 'share';\n  label: string;\n  endpoint?: string;   // 仅映射到 SSOT 状态机跃迁端点\n  payload?: Record<string, unknown>;\n}\n\n// 前端渲染\nfunction ToolResultRenderer({ toolInvocation }) {\n  if (toolInvocation.result?.type === 'a2ui_card') {\n    const { card_type, data, actions } = toolInvocation.result;\n    switch (card_type) {\n      case 'bazi_chart':\n        return <BaziChartCard data={data} actions={actions} />;\n      case 'commitment_card':\n        return <CommitmentCard data={data} actions={actions} />;\n      // ...\n    }\n  }\n  return null;\n}\n```\n\n#### 2.5.3 ActionButton 约束\n\n**关键规则**：ActionButton 的 `type` 只能映射到以下 SSOT 状态机跃迁端点，不允许组件私自定义写操作：\n\n| action.type | 映射端点 | 说明 |\n|-------------|----------|------|\n| `accept` | `POST /api/dashboard/task/accept` | 接受任务 |\n| `done` | `POST /api/dashboard/task/done` | 完成任务 |\n| `skip` | `POST /api/dashboard/task/skip` | 跳过任务 |\n| `checkin` | `POST /api/dashboard/checkin` | 情绪打卡 |\n| `navigate` | 前端路由 | 页面跳转（无写操作） |\n| `share` | `POST /api/social/share` | 分享卡片 |\n\n### 2.6 幂等性设计\n\n防止 `maxSteps` 多步推理下的重复写入：\n\n#### 2.6.1 idempotency_key 策略\n\n```typescript\n// lib/skills/divine-skills.ts\n\nexport const calculateBazi = tool({\n  description: '计算用户的八字命盘',\n  parameters: z.object({\n    birth_datetime: z.string(),\n    timezone: z.string().default('Asia/Shanghai'),\n  }),\n  execute: async ({ birth_datetime, timezone }, { runId, stepIndex }) => {\n    // 生成幂等键：run_id + step_index + tool_name + params_hash\n    const idempotencyKey = `${runId}:${stepIndex}:calculate_bazi:${hash({ birth_datetime, timezone })}`;\n\n    const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Idempotency-Key': idempotencyKey,\n      },\n      body: JSON.stringify({ birth_datetime, timezone }),\n    });\n\n    return res.json();\n  },\n});\n```\n\n#### 2.6.2 FastAPI 幂等性处理\n\n```python\n# api/middleware/idempotency.py\n\n@app.middleware(\"http\")\nasync def idempotency_middleware(request: Request, call_next):\n    idempotency_key = request.headers.get(\"X-Idempotency-Key\")\n\n    if idempotency_key and request.method in (\"POST\", \"PUT\"):\n        # 检查是否已执行\n        cached = await redis.get(f\"idempotency:{idempotency_key}\")\n        if cached:\n            return JSONResponse(content=json.loads(cached))\n\n        response = await call_next(request)\n\n        # 缓存结果（TTL 24h）\n        if response.status_code == 200:\n            body = await response.body()\n            await redis.setex(f\"idempotency:{idempotency_key}\", 86400, body)\n\n        return response\n\n    return await call_next(request)\n```\n\n#### 2.6.3 自然唯一键\n\n对于某些业务写入，使用自然唯一键替代显式 idempotency_key：\n\n```sql\n-- 承诺表：同一用户同一天同一描述只能有一条\nCREATE UNIQUE INDEX uq_commitments_natural\nON commitments (user_id, date_trunc('day', created_at), description_hash)\nWHERE status = 'active';\n\n-- PERMA 记录：同一用户同一小时只能有一条\nCREATE UNIQUE INDEX uq_perma_hourly\nON perma_logs (user_id, date_trunc('hour', logged_at));\n```\n\n---\n\n## 3. 重构阶段\n\n### Phase 1: 基础设施准备 (Week 1)\n\n**目标**: 建立 Next.js Agent Runtime 基础框架 + 双后端路由共存\n\n#### 1.0 反向代理路由配置（关键前置）\n\n配置 Nginx/Caddy 实现 Next.js 和 FastAPI 的路由共存：\n\n```nginx\n# /etc/nginx/sites-available/fortune-ai\n\nupstream nextjs {\n    server 127.0.0.1:8231;\n}\n\nupstream fastapi {\n    server 127.0.0.1:8230;\n}\n\nserver {\n    listen 80;\n    server_name fortune-ai.example.com;\n\n    # Agent Runtime (Next.js)\n    location /api/chat {\n        proxy_pass http://nextjs;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_buffering off;  # 流式响应必须\n        proxy_read_timeout 300s;\n    }\n\n    # Landing Page API (Next.js)\n    location /api/landing/ {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n        # IP 级限流\n        limit_req zone=landing_limit burst=5 nodelay;\n    }\n\n    # Internal APIs (仅内部访问)\n    location /internal/ {\n        # 只允许内网访问\n        allow 127.0.0.1;\n        allow 10.0.0.0/8;\n        deny all;\n        proxy_pass http://fastapi;\n        proxy_set_header Host $host;\n    }\n\n    # Data Service APIs (FastAPI)\n    location /api/ {\n        proxy_pass http://fastapi;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header Cookie $http_cookie;\n    }\n\n    # Frontend (Next.js)\n    location /new/ {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n    }\n\n    # Admin System (Next.js)\n    location /admin/ {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n    }\n\n    # Landing Page (Next.js)\n    location / {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n    }\n}\n\n# IP 限流配置\nlimit_req_zone $binary_remote_addr zone=landing_limit:10m rate=10r/m;\n```\n\n**路由优先级**（顺序很重要）：\n1. `/api/chat` → Next.js（Agent Runtime）\n2. `/api/landing/*` → Next.js（Landing Page API）\n3. `/internal/*` → FastAPI（内部 API，限内网）\n4. `/api/*` → FastAPI（Data Service）\n5. `/new/*` → Next.js（Frontend）\n6. `/admin/*` → Next.js（Admin）\n7. `/` → Next.js（Landing Page）\n\n#### 1.1 Next.js API Route 结构\n\n```bash\nweb-app/src/app/api/\n├── chat/\n│   └── route.ts              # 主 Agent Runtime\n├── command/\n│   └── route.ts              # 指令路由\n└── landing/\n    └── insight/\n        └── route.ts          # Landing Page 洞察\n```\n\n#### 1.2 Skills Registry 框架\n\n```bash\nweb-app/src/lib/\n├── skills/\n│   ├── index.ts              # Skills 统一导出\n│   ├── divine-skills.ts      # 玄学技能\n│   ├── heal-skills.ts        # 疗愈技能\n│   └── grow-skills.ts        # 成长技能\n├── models/\n│   └── model-provider.ts     # Multi-Model 配置\n└── context/\n    └── context-builder.ts    # System Prompt 构建\n```\n\n#### 1.3 配置 Multi-Model Provider\n\n```typescript\n// lib/models/model-provider.ts\nimport { createGoogleGenerativeAI } from '@ai-sdk/google';\nimport { createAnthropic } from '@ai-sdk/anthropic';\n\nconst google = createGoogleGenerativeAI({\n  apiKey: process.env.GOOGLE_API_KEY,\n});\n\nconst anthropic = createAnthropic({\n  apiKey: process.env.ANTHROPIC_API_KEY,\n});\n\n// Vercel AI Gateway for GLM-4.5\nconst glm = createGoogleGenerativeAI({\n  baseURL: 'https://gateway.ai.cloudflare.com/v1/...',\n  apiKey: process.env.GLM_API_KEY,\n});\n\nexport function selectModel(preference?: string) {\n  switch (preference) {\n    case 'gemini': return google('gemini-2.0-flash-exp');\n    case 'claude': return anthropic('claude-3-5-sonnet-20241022');\n    case 'glm':\n    default: return glm('glm-4.5');\n  }\n}\n```\n\n#### 1.4 交付物\n\n- [ ] **Nginx/Caddy 双后端路由配置**（关键前置）\n- [ ] FastAPI `/internal/*` 端点隔离（IP 白名单）\n- [ ] Next.js `/api/chat/route.ts` 基础框架\n- [ ] Skills Registry 目录结构\n- [ ] Multi-Model Provider 配置\n- [ ] 环境变量配置 (`.env.local`)\n\n---\n\n### Phase 2: Agent Runtime 迁移 (Week 2)\n\n**目标**: 将 AI 推理逻辑从 Python 迁移到 Next.js\n\n#### 2.1 实现 `/api/chat/route.ts`（含 Run Lifecycle）\n\n```typescript\n// app/api/chat/route.ts\nimport { streamText } from 'ai';\nimport { cookies } from 'next/headers';\nimport { selectModel } from '@/lib/models/model-provider';\nimport { allSkills } from '@/lib/skills';\nimport { buildSystemPrompt } from '@/lib/context/context-builder';\n\nconst FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n\n// 请求体：不包含 userId（从 Cookie Session 解出）\ninterface ChatRequest {\n  session_id?: string;   // 可选，用于会话续接\n  message: string;       // 用户消息\n  command?: string;      // /divine | /heal | /grow（来自 CommandPalette）\n}\n\nexport async function POST(req: Request) {\n  const cookieStore = await cookies();\n  const sessionCookie = cookieStore.get('fortune_session')?.value;\n\n  if (!sessionCookie) {\n    return Response.json({ ok: false, error: { code: 'AUTH_REQUIRED' } }, { status: 401 });\n  }\n\n  const { session_id, message, command }: ChatRequest = await req.json();\n\n  // 生成 correlation_id\n  const correlationId = `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n\n  // 1. 调用 Internal Context API（Cookie 透传，userId 由 FastAPI 解出）\n  const contextRes = await fetch(`${FASTAPI_URL}/internal/context`, {\n    headers: {\n      'Cookie': `fortune_session=${sessionCookie}`,\n      'X-Correlation-ID': correlationId,\n    },\n  });\n\n  if (!contextRes.ok) {\n    return Response.json({ ok: false, error: { code: 'CONTEXT_FETCH_FAILED' } }, { status: 500 });\n  }\n\n  const context = await contextRes.json();\n\n  // 2. 调用 run/start（记录 run_id + 用户消息）\n  const startRes = await fetch(`${FASTAPI_URL}/internal/chat/run/start`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Cookie': `fortune_session=${sessionCookie}`,\n      'X-Correlation-ID': correlationId,\n    },\n    body: JSON.stringify({\n      session_id,\n      user_message: message,\n      correlation_id: correlationId,\n    }),\n  });\n\n  const { run_id } = await startRes.json();\n\n  // 3. 根据 Command 筛选 Tools\n  const tools = command\n    ? getToolsForCommand(command)  // /divine → divineSkills only\n    : allSkills;                   // Chat Mode: all tools\n\n  // 4. 暂存 Tool 调用记录（用于 finalize）\n  const toolLogs: ToolLog[] = [];\n  const commitments: Commitment[] = [];\n\n  // 5. streamText 流式推理\n  const result = streamText({\n    model: selectModel(context.policy_flags?.model_override),\n    system: buildSystemPrompt(context),\n    messages: [\n      ...context.history_excerpt,\n      { role: 'user', content: message },\n    ],\n    tools,\n    maxSteps: 5,\n\n    // 每步完成回调：记录 Tool 调用\n    onStepFinish({ stepType, toolCalls, toolResults }) {\n      if (stepType === 'tool-result' && toolCalls) {\n        for (let i = 0; i < toolCalls.length; i++) {\n          const call = toolCalls[i];\n          const result = toolResults?.[i];\n          toolLogs.push({\n            name: call.toolName,\n            input: call.args,\n            output: result,\n            latency_ms: 0, // TODO: 实际计时\n            idempotency_key: `${run_id}:${toolLogs.length}:${call.toolName}`,\n          });\n\n          // 收集 commitments\n          if (result?.commitments) {\n            commitments.push(...result.commitments);\n          }\n        }\n      }\n    },\n\n    // 流式完成回调：调用 finalize\n    async onFinish({ text, finishReason }) {\n      await fetch(`${FASTAPI_URL}/internal/chat/run/finalize`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Cookie': `fortune_session=${sessionCookie}`,\n          'X-Correlation-ID': correlationId,\n        },\n        body: JSON.stringify({\n          run_id,\n          success: finishReason !== 'error',\n          assistant_message: text,\n          tool_logs: toolLogs,\n          commitments,\n        }),\n      });\n    },\n  });\n\n  return result.toDataStreamResponse();\n}\n```\n\n**关键变化**：\n- 请求体只包含 `{ session_id?, message, command? }`，**不传 userId**\n- userId 从 Cookie Session 由 FastAPI 解出\n- 流式开始时调用 `run/start`，结束时调用 `run/finalize`\n- Tool 调用记录暂存内存，`finalize` 时统一写入\n\n#### 2.2 System Prompt 迁移\n\n将 `chat_routes.py:SYSTEM_PROMPT_TEMPLATE` 迁移到 TypeScript：\n\n```typescript\n// lib/context/context-builder.ts\nexport function buildSystemPrompt(context: UserContext): string {\n  return `你是 Fortune AI 的对话 Agent，角色是积极心理学教练。\n\n【硬性规则】\n1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接\"你可以做什么\"的行动处方。\n2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。\n3) 每次输出必须包含：结论 + 依据 + ≤3条处方 + 承诺邀请。\n4) 每条处方必须包含 if_then：如果____→那么____。\n5) 必须给出可点击 actions。\n\n【用户上下文】\npersona_style: ${context.persona_style}\nfacts: ${JSON.stringify(context.facts)}\nevidence: ${JSON.stringify(context.evidence)}\nactive_goals: ${JSON.stringify(context.active_goals)}\n`;\n}\n```\n\n#### 2.3 双路由并行期\n\n**保留 Python `/api/chat/send`**，新增 Next.js `/api/chat`：\n\n```python\n# api/chat_routes.py - 添加 header 检测\n@router.post(\"/send\")\nasync def chat_send(request: Request, body: ChatSendRequest, auth = Depends(require_auth)):\n    # 检查是否使用新架构\n    use_new_runtime = request.headers.get(\"X-Use-New-Runtime\") == \"true\"\n    if use_new_runtime:\n        # 转发到 Next.js\n        return RedirectResponse(url=\"/api/chat\", status_code=307)\n    # 原有逻辑...\n```\n\n#### 2.4 交付物\n\n- [ ] `/api/chat/route.ts` 完整实现\n- [ ] `buildSystemPrompt()` 迁移\n- [ ] 双路由并行配置\n- [ ] 前端 `useChat()` 集成测试\n\n---\n\n### Phase 3: Skills 实现 (Week 3)\n\n**目标**: 将 L2 Expert Agents 重构为 Vercel Tools\n\n#### 3.1 Divine Skills\n\n```typescript\n// lib/skills/divine-skills.ts\nimport { tool } from 'ai';\nimport { z } from 'zod';\n\nconst FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n\nexport const divineSkills = {\n  calculate_bazi: tool({\n    description: '计算用户的八字命盘，返回四柱、五行、十神、神煞、大运等信息',\n    parameters: z.object({\n      birth_datetime: z.string().describe('出生日期时间 (ISO 8601)'),\n      timezone: z.string().default('Asia/Shanghai'),\n      include_dayun: z.boolean().default(true),\n    }),\n    execute: async ({ birth_datetime, timezone, include_dayun }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),\n      });\n      if (!res.ok) throw new Error(`Bazi calculation failed: ${res.status}`);\n      return res.json();\n    },\n  }),\n\n  get_bazi_facts: tool({\n    description: '获取用户已计算的八字事实数据',\n    parameters: z.object({\n      user_id: z.number(),\n    }),\n    execute: async ({ user_id }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/bazi/facts/${user_id}`);\n      return res.json();\n    },\n  }),\n\n  search_bazi_kb: tool({\n    description: '搜索八字知识库，获取相关命理解读',\n    parameters: z.object({\n      query: z.string().describe('搜索关键词'),\n      limit: z.number().default(3),\n    }),\n    execute: async ({ query, limit }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/kb/search`, {\n        method: 'POST',\n        body: JSON.stringify({ query, limit, category: 'bazi' }),\n      });\n      return res.json();\n    },\n  }),\n};\n```\n\n#### 3.2 Heal Skills\n\n```typescript\n// lib/skills/heal-skills.ts\nexport const healSkills = {\n  log_perma: tool({\n    description: '记录用户的 PERMA 五维心理状态分数',\n    parameters: z.object({\n      dimension: z.enum(['P', 'E', 'R', 'M', 'A']),\n      score: z.number().min(0).max(10),\n      note: z.string().optional(),\n    }),\n    execute: async ({ dimension, score, note }, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/perma/log`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, dimension, score, note }),\n      });\n      return res.json();\n    },\n  }),\n\n  mood_checkin: tool({\n    description: '快速情绪打卡',\n    parameters: z.object({\n      mood_score: z.number().min(1).max(10),\n      tags: z.array(z.string()).optional(),\n      note: z.string().optional(),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n\n  cbt_reframe: tool({\n    description: '使用 CBT ABC 模型进行认知重构',\n    parameters: z.object({\n      activating_event: z.string().describe('触发事件 (A)'),\n      belief: z.string().optional().describe('信念/想法 (B)'),\n      consequence: z.string().optional().describe('情绪/行为后果 (C)'),\n    }),\n    execute: async (params) => {\n      // CBT 引导框架，返回结构化提示让 LLM 继续引导\n      return {\n        framework: 'ABC',\n        current_state: params,\n        next_step: params.belief ? 'identify_distortion' : 'explore_belief',\n        guidance_prompt: params.belief\n          ? `用户的信念是\"${params.belief}\"，请帮助识别可能的认知扭曲...`\n          : `请引导用户探索触发事件背后的信念和想法...`,\n      };\n    },\n  }),\n};\n```\n\n#### 3.3 Grow Skills\n\n```typescript\n// lib/skills/grow-skills.ts\nexport const growSkills = {\n  create_commitment: tool({\n    description: '创建行动承诺任务',\n    parameters: z.object({\n      content: z.string().describe('任务内容'),\n      category: z.enum(['energy_boost', 'reflection', 'practice', 'social', 'general']),\n      estimated_minutes: z.number().default(5),\n      if_then: z.string().optional().describe('If-Then 触发条件'),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n\n  goal_setting: tool({\n    description: '使用 WOOP 模型设定目标',\n    parameters: z.object({\n      wish: z.string().describe('愿望/目标'),\n      outcome: z.string().optional(),\n      obstacle: z.string().optional(),\n      plan: z.string().optional(),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n\n  update_twin: tool({\n    description: '更新用户数字孪生数据',\n    parameters: z.object({\n      layer: z.enum(['L1', 'L2', 'L3']),\n      path: z.string().describe('JSON 路径'),\n      value: z.any(),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/twin/update`, {\n        method: 'PUT',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n};\n```\n\n#### 3.4 Skills Registry 统一导出\n\n```typescript\n// lib/skills/index.ts\nimport { divineSkills } from './divine-skills';\nimport { healSkills } from './heal-skills';\nimport { growSkills } from './grow-skills';\n\nexport const allSkills = {\n  ...divineSkills,\n  ...healSkills,\n  ...growSkills,\n};\n\nexport function getToolsForCommand(command: string) {\n  switch (command) {\n    case '/divine': return divineSkills;\n    case '/heal': return healSkills;\n    case '/grow': return growSkills;\n    default: return allSkills;\n  }\n}\n\nexport { divineSkills, healSkills, growSkills };\n```\n\n#### 3.5 交付物\n\n- [ ] `divine-skills.ts` 完整实现\n- [ ] `heal-skills.ts` 完整实现\n- [ ] `grow-skills.ts` 完整实现\n- [ ] Skills Registry 单元测试\n\n---\n\n### Phase 4: FastAPI 数据服务重构 (Week 4)\n\n**目标**: 将 FastAPI 精简为纯数据服务层\n\n#### 4.1 新增数据服务 API\n\n```python\n# api/data_routes.py (新文件)\nfrom fastapi import APIRouter, Depends\nfrom api.deps import require_auth\n\nrouter = APIRouter(prefix=\"/api\", tags=[\"data\"])\n\n@router.get(\"/user/context\")\nasync def get_user_context(user_id: int, auth = Depends(require_auth)):\n    \"\"\"聚合用户上下文，供 Agent Runtime 调用\"\"\"\n    # 聚合 profile + preferences + facts + active_goals + recent_messages\n    profile = await _get_profile(user_id)\n    prefs = await _get_preferences(user_id)\n    facts = await _get_bazi_facts(user_id)\n    goals = await _get_active_goals(user_id)\n    messages = await _get_recent_messages(user_id, limit=10)\n\n    return {\n        \"ok\": True,\n        \"data\": {\n            \"profile\": profile,\n            \"persona_style\": prefs.get(\"persona_style\", \"warm\"),\n            \"facts\": facts,\n            \"evidence\": {\n                \"facts_hash\": facts.get(\"facts_hash\"),\n                \"kb_refs\": [],  # 后续填充\n            },\n            \"active_goals\": goals,\n            \"recent_messages\": messages,\n        }\n    }\n\n@router.post(\"/bazi/calculate\")\nasync def calculate_bazi(body: BaziCalculateRequest):\n    \"\"\"八字计算 (无需登录，供 Landing Page 使用)\"\"\"\n    from services.bazi_engine import calculate_bazi\n    result = calculate_bazi(\n        body.birth_datetime,\n        body.timezone,\n        body.include_dayun,\n    )\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/perma/log\")\nasync def log_perma(body: PermaLogRequest, auth = Depends(require_auth)):\n    \"\"\"PERMA 状态记录\"\"\"\n    from services.twin_service import update_perma_score\n    result = await update_perma_score(\n        auth.user_id,\n        body.dimension,\n        body.score,\n        body.note,\n    )\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/tasks/create\")\nasync def create_task(body: TaskCreateRequest, auth = Depends(require_auth)):\n    \"\"\"创建承诺任务\"\"\"\n    from services.bento_service import create_commitment\n    result = await create_commitment(\n        auth.user_id,\n        body.content,\n        body.category,\n        body.estimated_minutes,\n        body.if_then,\n    )\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/goals/create\")\nasync def create_goal(body: GoalCreateRequest, auth = Depends(require_auth)):\n    \"\"\"创建 WOOP 目标\"\"\"\n    from services.goal_service import create_goal\n    result = await create_goal(auth.user_id, body.dict())\n    return {\"ok\": True, \"data\": result}\n\n@router.put(\"/twin/update\")\nasync def update_twin(body: TwinUpdateRequest, auth = Depends(require_auth)):\n    \"\"\"更新数字孪生\"\"\"\n    from services.twin_service import update_twin\n    result = await update_twin(auth.user_id, body.layer, body.path, body.value)\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/kb/search\")\nasync def search_kb(body: KBSearchRequest, auth = Depends(require_auth)):\n    \"\"\"知识库检索\"\"\"\n    from services.kb_service import search\n    result = await search(body.query, body.limit, body.category)\n    return {\"ok\": True, \"data\": result}\n```\n\n#### 4.2 Landing Page API\n\n```python\n# api/landing_routes.py (新文件)\nfrom fastapi import APIRouter\n\nrouter = APIRouter(prefix=\"/api/landing\", tags=[\"landing\"])\n\nELEMENT_COLORS = {\n    \"wood\": [\"#4ade80\", \"#22c55e\"],\n    \"fire\": [\"#f87171\", \"#ef4444\"],\n    \"earth\": [\"#fbbf24\", \"#f59e0b\"],\n    \"metal\": [\"#f5f5f4\", \"#d6d3d1\"],\n    \"water\": [\"#60a5fa\", \"#3b82f6\"],\n}\n\nELEMENT_INSIGHTS = {\n    \"wood\": {\n        \"en\": \"A strong Wood energy detected. You seek growth, but feel restricted.\",\n        \"cn\": \"检测到强木能量。你渴望生长，但感到受限。\",\n    },\n    \"fire\": {\n        \"en\": \"Fire burns bright within you. Passion drives you forward.\",\n        \"cn\": \"火焰在你心中燃烧。热情驱动你前进。\",\n    },\n    # ... 其他五行\n}\n\n@router.post(\"/insight\")\nasync def instant_insight(body: InsightRequest):\n    \"\"\"即时洞察 (无需登录)\"\"\"\n    if body.input_type == \"bazi\":\n        # 快速计算日主五行\n        from services.bazi_engine import quick_day_master\n        element = quick_day_master(body.value)\n        insight = ELEMENT_INSIGHTS.get(element, ELEMENT_INSIGHTS[\"wood\"])\n        return {\n            \"ok\": True,\n            \"data\": {\n                \"type\": \"bazi\",\n                \"element\": element,\n                \"insight\": insight[\"en\"],\n                \"insight_cn\": insight[\"cn\"],\n                \"orb_colors\": ELEMENT_COLORS.get(element),\n                \"cta\": \"Unlock Full Analysis →\",\n            }\n        }\n    elif body.input_type == \"emotion\":\n        # 调用 LLM 生成简短情绪洞察\n        from services.glm_client import quick_emotion_insight\n        insight = await quick_emotion_insight(body.value)\n        return {\n            \"ok\": True,\n            \"data\": {\n                \"type\": \"emotion\",\n                \"insight\": insight,\n                \"orb_colors\": [\"#a78bfa\", \"#8b5cf6\"],  # 紫色\n                \"cta\": \"Start Your Journey →\",\n            }\n        }\n```\n\n#### 4.3 删除/废弃的代码\n\n```python\n# 待删除文件\nservices/glm_client.py          # LLM 调用迁移到 TypeScript\nservices/agent_service_client.py # 不再需要\n\n# 待废弃端点 (chat_routes.py)\n# POST /api/chat/send  → 迁移到 Next.js /api/chat\n# GET  /api/chat/stream → 迁移到 Next.js /api/chat\n```\n\n#### 4.4 交付物\n\n- [ ] `api/data_routes.py` 完整实现\n- [ ] `api/landing_routes.py` 完整实现\n- [ ] 旧 chat 端点废弃标记\n- [ ] API 文档更新\n\n---\n\n### Phase 5: 前端适配 (Week 5)\n\n**目标**: 前端切换到 `useChat()` Hook\n\n#### 5.1 useChat 集成\n\n```typescript\n// components/chat/chat-panel.tsx\n'use client';\n\nimport { useChat } from 'ai/react';\nimport { useState } from 'react';\n\nexport function ChatPanel({ userId }: { userId: number }) {\n  const [command, setCommand] = useState<string | null>(null);\n\n  const { messages, input, setInput, handleSubmit, isLoading, error } = useChat({\n    api: '/api/chat',\n    body: { userId, command },\n    onFinish: (message) => {\n      setCommand(null);\n      // 处理 Tool 调用结果\n      if (message.toolInvocations?.length) {\n        refreshDashboard(message.toolInvocations);\n      }\n    },\n  });\n\n  const handleCommandSubmit = (cmd: string, text: string) => {\n    setCommand(cmd);\n    setInput(text);\n    // useChat 会自动提交\n  };\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      {/* Messages */}\n      <div className=\"flex-1 overflow-y-auto\">\n        {messages.map((m) => (\n          <MessageBubble key={m.id} message={m} />\n        ))}\n      </div>\n\n      {/* Input */}\n      <ChatInput\n        value={input}\n        onChange={setInput}\n        onSubmit={handleSubmit}\n        onCommand={handleCommandSubmit}\n        isLoading={isLoading}\n      />\n    </div>\n  );\n}\n```\n\n#### 5.2 CommandPalette 集成\n\n```typescript\n// components/chat/command-palette.tsx\nconst COMMANDS = [\n  { cmd: '/divine', label: '玄学测算', icon: '🔮' },\n  { cmd: '/heal', label: '心理疗愈', icon: '💚' },\n  { cmd: '/grow', label: '成长教练', icon: '🌱' },\n  { cmd: '/status', label: '状态查看', icon: '📊' },\n];\n\nexport function CommandPalette({ onSelect, visible }: CommandPaletteProps) {\n  if (!visible) return null;\n\n  return (\n    <div className=\"absolute bottom-full left-0 w-full bg-background border rounded-lg shadow-lg p-2\">\n      {COMMANDS.map((c) => (\n        <button\n          key={c.cmd}\n          onClick={() => onSelect(c.cmd)}\n          className=\"flex items-center gap-2 w-full p-2 hover:bg-accent rounded\"\n        >\n          <span>{c.icon}</span>\n          <span className=\"font-medium\">{c.cmd}</span>\n          <span className=\"text-muted-foreground\">{c.label}</span>\n        </button>\n      ))}\n    </div>\n  );\n}\n```\n\n#### 5.3 Tool Result 渲染\n\n```typescript\n// components/chat/tool-result-card.tsx\nexport function ToolResultCard({ invocation }: { invocation: ToolInvocation }) {\n  const { toolName, result, state } = invocation;\n\n  if (state === 'partial-call') {\n    return <LoadingCard toolName={toolName} />;\n  }\n\n  switch (toolName) {\n    case 'calculate_bazi':\n      return <BaziResultCard data={result} />;\n    case 'mood_checkin':\n      return <MoodCheckinCard data={result} />;\n    case 'create_commitment':\n      return <CommitmentCard data={result} />;\n    default:\n      return <GenericResultCard data={result} />;\n  }\n}\n```\n\n#### 5.4 交付物\n\n- [ ] `useChat()` 集成\n- [ ] `CommandPalette` 组件\n- [ ] `ToolResultCard` 组件\n- [ ] 端到端测试\n\n---\n\n### Phase 6: 清理与优化 (Week 6)\n\n**目标**: 删除旧代码，性能优化\n\n#### 6.1 删除列表\n\n```bash\n# 删除文件\nrm services/glm_client.py\nrm services/agent_service_client.py\n\n# 删除 agent_service 目录 (已迁移到 Next.js)\nrm -rf agent_service/\n\n# 清理 chat_routes.py 中的旧端点\n# - /api/chat/send\n# - /api/chat/stream\n```\n\n#### 6.2 API 路由清理\n\n```python\n# api/main.py - 更新路由注册\napp.include_router(auth_routes.router)\napp.include_router(data_routes.router)      # 新增\napp.include_router(landing_routes.router)   # 新增\napp.include_router(dashboard_routes.router)\napp.include_router(report_routes.router)\n# 删除: app.include_router(chat_routes.router)\n```\n\n#### 6.3 性能优化\n\n1. **Context 缓存**: 用户上下文 Redis 缓存 (TTL 5min)\n2. **批量 Tool 调用**: 合并多个 fetch 请求\n3. **流式首字优化**: 减少 System Prompt 长度\n\n#### 6.4 监控与日志\n\n```typescript\n// 添加 Tool 调用监控\nconst result = streamText({\n  // ...\n  onStepFinish({ stepType, toolCalls, toolResults }) {\n    // 记录 Tool 调用耗时\n    logger.info('Step finished', {\n      stepType,\n      toolCount: toolCalls?.length,\n      latency: Date.now() - startTime,\n    });\n  },\n});\n```\n\n#### 6.5 交付物\n\n- [ ] 旧文件删除\n- [ ] API 路由更新\n- [ ] Redis 缓存配置\n- [ ] 监控 Dashboard\n\n---\n\n## 4. 风险与缓解\n\n### 4.1 兼容性风险\n\n| 风险点 | 影响范围 | 缓解措施 |\n|--------|----------|----------|\n| API 签名变更 | 前端所有 Chat 调用 | 双路由并行，Feature Flag 控制 |\n| A2UI 格式变化 | 消息渲染组件 | 保持 JSON 结构兼容，仅改传输方式 |\n| CSRF 处理 | 所有 POST 请求 | Next.js API Route 同源，无需 CSRF |\n| Cookie 传递 | 认证流程 | `credentials: 'include'` 配置 |\n\n### 4.2 回滚方案\n\n```typescript\n// Feature Flag 控制\nconst USE_NEW_RUNTIME = process.env.USE_NEW_RUNTIME === 'true';\n\n// 前端路由选择\nconst chatEndpoint = USE_NEW_RUNTIME ? '/api/chat' : '/api/chat/send';\n```\n\n### 4.3 灰度发布\n\n1. **Week 1-4**: 内部测试环境验证\n2. **Week 5**: 10% 用户灰度\n3. **Week 6**: 50% 用户灰度\n4. **Week 7**: 全量发布\n\n---\n\n## 5. 验收标准\n\n### 5.1 功能验收\n\n| 功能 | 验收标准 |\n|------|----------|\n| Chat 对话 | 流式输出正常，首字 < 500ms |\n| `/divine` 指令 | 八字计算正确，结果渲染正常 |\n| `/heal` 指令 | PERMA 记录成功，CBT 引导完整 |\n| `/grow` 指令 | 目标/任务创建成功 |\n| Landing Page | Insight 生成 < 1s，Orb 颜色正确 |\n| Tool Calling | 多步推理 (maxSteps=5) 正常 |\n\n### 5.2 性能验收\n\n| 指标 | 目标值 | 当前值 |\n|------|--------|--------|\n| 首字延迟 (P50) | < 500ms | ~800ms |\n| 首字延迟 (P95) | < 1.5s | ~2s |\n| Tool 调用延迟 | < 200ms | N/A |\n| 端到端响应 (P50) | < 3s | ~4s |\n\n### 5.3 代码质量\n\n- [ ] TypeScript 严格模式\n- [ ] Zod Schema 100% 覆盖\n- [ ] 单元测试覆盖率 > 80%\n- [ ] E2E 测试通过\n\n---\n\n## 6. 附录\n\n### 6.1 环境变量\n\n```bash\n# .env.local (Next.js)\nFASTAPI_URL=http://localhost:8230\nGOOGLE_API_KEY=xxx\nANTHROPIC_API_KEY=xxx\nGLM_API_KEY=xxx\nUSE_NEW_RUNTIME=true\n```\n\n### 6.2 依赖更新\n\n```json\n// package.json\n{\n  \"dependencies\": {\n    \"ai\": \"^4.0.0\",\n    \"@ai-sdk/google\": \"^1.0.0\",\n    \"@ai-sdk/anthropic\": \"^1.0.0\",\n    \"zod\": \"^3.22.0\"\n  }\n}\n```\n\n### 6.3 参考文档\n\n- [Vercel AI SDK 文档](https://sdk.vercel.ai/docs)\n- [os_design_v3.md §1.4-1.5](./os_design_v3.md)\n- [frontend_final_v3.md §2.6](./frontend_final_v3.md)\n- [system_design_final_mvp_v3.md §7.0.1](./system_design_final_mvp_v3.md)\n- [admin_v3.md](./admin_v3.md) - Admin System 设计，可与本重构并行开发\n\n### 6.4 并行开发项\n\n| 项目 | 描述 | 技术栈 | 依赖关系 |\n|------|------|--------|----------|\n| **Admin System** | 后台管理驾驶舱 | Next.js App Router + shadcn/ui + Monaco | Phase 1 完成后可启动 |\n| **Landing Page** | Digital Mirror 首页 | Next.js + React Three Fiber | 独立开发 |\n\n> **注**: Admin System 的 Agent Studio 模块依赖本重构中的 `admin_prompts` 表和 Prompt 热加载机制（Phase 4），建议在 Phase 4 完成后进行 Admin 前端开发。\n\n---\n\n*文档版本: v1.0*\n*创建日期: 2026-01-01*\n*作者: Claude (Anthropic)*\n","numLines":1802,"startLine":1,"totalLines":1802}}}
{"parentUuid":"aaff29e3-d6ba-4317-88d7-35f7fc8dde92","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"a3217ff","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01W3RbuvnUZSa1nqdhFnqNf9","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect! Now I have all the files. Let me analyze the implementation against the specification. I'll create a comprehensive review report.\n\n## FastAPI Internal Routes Review Report\n\nBased on my systematic review of `/home/aiscend/work/fortune_ai/api/internal_routes.py` against the specification in `/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md` (§2.4), here is my detailed findings:\n\n---\n\n### IMPLEMENTATION SUMMARY\n\nThe `internal_routes.py` file is a **strong implementation** that correctly realizes the Internal Contract APIs specification. However, there are **minor deviations** and **potential gaps** that need attention.\n\n---\n\n## 1. ENDPOINT COVERAGE\n\n### ✅ REQUIRED ENDPOINTS\n\n| Specification | Implementation | Status |\n|---------------|----------------|--------|\n| GET `/internal/context` | Lines 84-119 | ✅ IMPLEMENTED |\n| POST `/internal/chat/run/start` | Lines 122-167 | ✅ IMPLEMENTED |\n| POST `/internal/chat/run/finalize` | Lines 170-231 | ✅ IMPLEMENTED |\n\n**Additional endpoint**: GET `/internal/health` (Lines 239-242) - helpful but not in spec.\n\n---\n\n## 2. DETAILED COMPLIANCE ANALYSIS\n\n### 2.1 Context API (§2.4.1)\n\n**Specification Requirements** (lines 444-495 of plan):\n```python\n@router.get(\"/internal/context\")\nasync def get_context(\n    session_id: str = Query(None),\n    user: AuthUser = Depends(get_current_user_from_cookie),\n    x_correlation_id: str = Header(None),\n) -> ContextResponse:\n    \"\"\"Aggregates user context\"\"\"\n    return ContextResponse(\n        l0=UserProfile(...),\n        l1=ModuleData(...),\n        policy_flags=PolicyFlags(...),\n        history_excerpt=get_recent_messages(...),\n    )\n```\n\n**Implementation** (lines 84-119):\n```python\n@router.get(\"/context\", response_model=ContextResponse)\nasync def get_context(\n    request: Request,\n    session_id: Optional[str] = None,\n    query: Optional[str] = None,\n):\n```\n\n#### Issues Found:\n\n| # | Category | Specification | Implementation | Severity |\n|---|----------|---------------|-----------------|----------|\n| 1 | **Schema Structure** | Response should have nested `l0`, `l1`, `policy_flags` | Flat structure with top-level fields | 🔴 HIGH |\n| 2 | **Field Names** | `user_context` + `evidence` + `anti_dependency` | Uses `user_context`, `evidence`, `anti_dependency` | ✅ ACCEPTABLE |\n| 3 | **Auth Method** | `Depends(get_current_user_from_cookie)` | Uses `require_auth(request)` | ⚠️ MEDIUM |\n| 4 | **Correlation ID** | Should accept `X-Correlation-ID` header | Not captured | 🟡 LOW |\n\n**Detailed Schema Mismatch**:\n\nPlan specifies (lines 476-494):\n```typescript\ninterface ContextResponse {\n  l0: {\n    user_id: string;\n    display_name: string;\n    birth_info: { year: number; month: number; day: number; hour?: number };\n    preferences: Record<string, unknown>;\n  };\n  l1: {\n    bazi_chart?: BaziChart;\n    perma_recent?: PermaScore[];\n    active_goals?: Goal[];\n    twin_status?: TwinStatus;\n  };\n  policy_flags: {\n    allow_roast: boolean;\n    model_override?: 'glm' | 'gemini' | 'claude';\n  };\n  history_excerpt: Message[];\n}\n```\n\nImplementation provides (lines 33-41):\n```python\nclass ContextResponse(BaseModel):\n    user_id: int\n    system_prompt: str\n    persona_style: str\n    user_context: Dict[str, Any]\n    evidence: Dict[str, Any]\n    anti_dependency: Dict[str, Any]\n    history: List[Dict[str, Any]]\n```\n\n**Root Cause**: Implementation focuses on *operational readiness* (direct system_prompt, persona_style), while spec emphasizes *data layer separation* (l0/l1 hierarchy). The implementation is **semantically equivalent but structurally different**.\n\n---\n\n### 2.2 Chat Persistence API - Run Start (§2.4.2, lines 502-523)\n\n**Specification**:\n```python\n@router.post(\"/internal/chat/run/start\")\nasync def start_chat_run(\n    request: StartRunRequest,\n    user: AuthUser = Depends(get_current_user_from_cookie),\n) -> StartRunResponse:\n    \"\"\"Records run_id + user message\"\"\"\n    # 1. Create/validate session\n    # 2. Record run_id + user message\n    return StartRunResponse(run_id=run_id)\n```\n\n**Implementation** (lines 122-167):\n\n```python\n@router.post(\"/chat/run/start\", response_model=RunStartResponse)\nasync def start_run(request: Request, body: RunStartRequest):\n    auth = require_auth(request)\n    user_id = int(auth[\"user_id\"])\n    \n    # Session handling\n    session_id = body.session_id\n    if not session_id:\n        session = chat_service.create_session(user_id)\n        session_id = session[\"session_id\"]\n    else:\n        existing = chat_service.get_session(user_id, session_id)\n        if not existing:\n            raise HTTPException(status_code=404, detail=\"session_not_found\")\n    \n    # Generate run_id\n    run_id = str(uuid.uuid4())\n    \n    # Record user message\n    msg_result = chat_service.append_message(\n        session_id=session_id,\n        user_id=user_id,\n        role=\"user\",\n        content=body.message,\n        model=body.model,\n    )\n    \n    # Set session title\n    chat_service.set_title_if_empty(session_id, body.message[:24])\n    \n    return RunStartResponse(\n        run_id=run_id,\n        session_id=session_id,\n        user_message_id=msg_result[\"message_id\"],\n    )\n```\n\n#### Analysis:\n\n| Aspect | Spec | Implementation | Status |\n|--------|------|-----------------|--------|\n| **Session creation** | \"Create or validate session\" | ✅ Creates if missing, validates if provided | ✅ CORRECT |\n| **run_id generation** | `str(uuid4())` | ✅ `str(uuid.uuid4())` | ✅ CORRECT |\n| **User message recording** | \"Record run_id + user message\" | ✅ Uses `append_message()` | ✅ CORRECT |\n| **Response schema** | `{run_id: string}` | ✅ Plus `session_id` + `user_message_id` | ✅ ENHANCED |\n| **Auto title setting** | Not mentioned | ✅ Sets from first 24 chars | ✅ ENHANCEMENT |\n\n**Issues**:\n- **NONE CRITICAL** - Implementation exceeds spec expectations with additional fields and title auto-setting\n\n---\n\n### 2.3 Chat Persistence API - Run Finalize (§2.4.2, lines 525-567)\n\n**Specification** (lines 525-567):\n```python\n@router.post(\"/internal/chat/run/finalize\")\nasync def finalize_chat_run(\n    request: FinalizeRunRequest,\n    user: AuthUser = Depends(get_current_user_from_cookie),\n) -> FinalizeRunResponse:\n    \"\"\"Finalizes run: records all side effects in single transaction\"\"\"\n    # 1. Update run status\n    # 2. Write assistant message\n    # 3. Write tool call logs with idempotency\n    # 4. Write commitments\n    # 5. Update twin\n    return FinalizeRunResponse(ok=True)\n```\n\n**Implementation** (lines 170-231):\n\n```python\n@router.post(\"/chat/run/finalize\", response_model=RunFinalizeResponse)\nasync def finalize_run(request: Request, body: RunFinalizeRequest):\n    auth = require_auth(request)\n    user_id = int(auth[\"user_id\"])\n\n    # Validate session ownership\n    existing = chat_service.get_session(user_id, body.session_id)\n    if not existing:\n        raise HTTPException(status_code=404, detail=\"session_not_found\")\n\n    # If there was an error, record it but don't store assistant message\n    if body.error:\n        return RunFinalizeResponse(\n            success=False,\n            assistant_message_id=None,\n            side_effects=[f\"error_logged:{body.run_id}\"],\n        )\n\n    # Build a2ui object from cards\n    a2ui = None\n    if body.a2ui_cards:\n        a2ui = {\"cards\": body.a2ui_cards}\n\n    # Record assistant message\n    msg_result = chat_service.append_message(\n        session_id=body.session_id,\n        user_id=user_id,\n        role=\"assistant\",\n        content=body.assistant_content,\n        model=body.model,\n        a2ui=a2ui,\n        prompt_tokens=body.prompt_tokens,\n        completion_tokens=body.completion_tokens,\n    )\n\n    side_effects: List[str] = [f\"message_stored:{msg_result['message_id']}\"]\n\n    # Process tool calls\n    if body.tool_calls:\n        for tc in body.tool_calls:\n            tool_name = tc.get(\"toolName\", tc.get(\"name\", \"unknown\"))\n            side_effects.append(f\"tool_executed:{tool_name}\")\n\n    return RunFinalizeResponse(\n        success=True,\n        assistant_message_id=msg_result[\"message_id\"],\n        side_effects=side_effects,\n    )\n```\n\n#### Analysis:\n\n| Aspect | Spec | Implementation | Status |\n|--------|------|-----------------|--------|\n| **Session validation** | ✅ Check `user_id` ownership | ✅ `get_session(user_id, ...)` | ✅ CORRECT |\n| **Error handling** | \"If error, don't fail\" | ✅ Logs error, returns `success=False` | ✅ CORRECT |\n| **A2UI card handling** | Not in spec, defer | ✅ Wraps cards as `{\"cards\": [...]}` | ✅ ENHANCEMENT |\n| **Assistant message** | Store assistant content | ✅ Uses `append_message()` | ✅ CORRECT |\n| **Tool call logging** | Store with `idempotency_key` | 🔴 **MISSING** | 🔴 CRITICAL |\n| **Commitments write** | \"for commitment in...\" | 🔴 **MISSING** | 🔴 CRITICAL |\n| **Twin updates** | \"update_twin(user.id, ...)\" | 🔴 **MISSING** | 🔴 CRITICAL |\n| **Transaction wrapper** | `async with db.transaction()` | 🔴 **MISSING** | 🔴 CRITICAL |\n\n---\n\n## 3. CRITICAL GAPS\n\n### 🔴 Gap #1: Tool Call Logging Not Implemented\n\n**Specification** (lines 548-556):\n```python\n# 3. Write tool invocation logs\nfor tool_log in request.tool_logs:\n    await db.execute(\"\"\"\n        INSERT INTO tool_invocations\n        (run_id, tool_name, input, output, latency_ms, idempotency_key)\n        VALUES ($1, $2, $3, $4, $5, $6)\n        ON CONFLICT (idempotency_key) DO NOTHING\n    \"\"\", request.run_id, tool_log.name, ...)\n```\n\n**Current Implementation**:\n```python\n# Only accumulates side_effects strings, no actual DB writes\nif body.tool_calls:\n    for tc in body.tool_calls:\n        tool_name = tc.get(\"toolName\", tc.get(\"name\", \"unknown\"))\n        side_effects.append(f\"tool_executed:{tool_name}\")\n```\n\n**Impact**: \n- Tool invocations are **NOT persisted** to database\n- Idempotency protection (maxSteps protection) is **NOT enforced**\n- Audit trail of tool calls is **LOST**\n\n**Severity**: 🔴 **CRITICAL** - Violates §2.6.2 (idempotency_middleware) contract\n\n---\n\n### 🔴 Gap #2: Commitments Not Persisted\n\n**Specification** (lines 559-560):\n```python\n# 4. Write commitments\nfor commitment in request.commitments:\n    await create_commitment(user.id, commitment)\n```\n\n**Current Implementation**:\n```python\n# No commitment persistence logic\n# (Only mentioned in docstring, not implemented)\n```\n\n**Impact**:\n- Commitments from chat are **NOT saved**\n- Dashboard won't show user's action commitments\n- Core feature of `/heal` and `/grow` skills is broken\n\n**Severity**: 🔴 **CRITICAL**\n\n---\n\n### 🔴 Gap #3: Twin Updates Not Persisted\n\n**Specification** (lines 562-564):\n```python\n# 5. Update twin status\nif request.twin_updates:\n    await update_twin(user.id, request.twin_updates)\n```\n\n**Current Implementation**:\n```python\n# No twin update logic\n```\n\n**Impact**:\n- Digital twin state is **NOT updated** after chat\n- Persona/habits/patterns evolution is **NOT tracked**\n- L2 layer data freshness is **STALE**\n\n**Severity**: 🔴 **CRITICAL**\n\n---\n\n### 🔴 Gap #4: No Transaction Wrapper\n\n**Specification** (line 533):\n```python\nasync with db.transaction():\n    # All 5 writes inside single transaction\n```\n\n**Current Implementation**:\n```python\n# No transaction context\nmsg_result = chat_service.append_message(...)  # Write 1\nif body.tool_calls:\n    for tc in body.tool_calls:\n        side_effects.append(...)  # No write\nreturn RunFinalizeResponse(...)  # Partial success possible\n```\n\n**Impact**:\n- **Data consistency risk**: If assistant message writes but commitments fail, state is corrupted\n- **§0.6.1 (Streaming & Transaction Decoupling) violated**: \"流式与事务解耦\" means finalize should be ATOMIC\n- **Fail-safe broken**: Half-written state could cause cascading failures\n\n**Severity**: 🔴 **CRITICAL**\n\n---\n\n### 🟡 Gap #5: Deprecated A2UI Handling\n\n**Specification** (§2.5.1-2.5.2, lines 595-671):\n- A2UI should be in `toolInvocations[].result.a2ui_card`\n- NOT in `assistant.content`\n\n**Current Implementation** (lines 201-203):\n```python\na2ui = None\nif body.a2ui_cards:\n    a2ui = {\"cards\": body.a2ui_cards}\n\n# Then stored in assistant message\nchat_service.append_message(\n    ...\n    a2ui=a2ui,  # Stored separately ✅\n)\n```\n\n**Status**: ✅ **CORRECT** - Implementation stores a2ui separately, which is the migration path\n\n---\n\n### 🟡 Gap #6: Missing Request Schema Fields\n\n**Specification** (lines 570-593):\n```typescript\ninterface FinalizeRunRequest {\n  run_id: string;\n  success: boolean;\n  assistant_message?: string;\n  tool_logs: ToolLog[];           // ← Expected\n  commitments: Commitment[];      // ← Expected\n  twin_updates?: TwinUpdate;      // ← Expected\n}\n```\n\n**Implementation** (lines 59-69):\n```python\nclass RunFinalizeRequest(BaseModel):\n    run_id: str\n    session_id: str\n    assistant_content: str\n    tool_calls: Optional[List[Dict[str, Any]]] = None  # Not same as tool_logs\n    a2ui_cards: Optional[List[Dict[str, Any]]] = None\n    prompt_tokens: int = Field(default=0)\n    completion_tokens: int = Field(default=0)\n    model: str = Field(default=\"glm-4.7-flash\")\n    error: Optional[str] = Field(default=None)\n```\n\n**Mismatch**:\n- ❌ No `tool_logs` (has `tool_calls` but different schema)\n- ❌ No `commitments` field\n- ❌ No `twin_updates` field\n- ✅ Has `session_id` (spec doesn't require, but operationally necessary)\n- ✅ Has `a2ui_cards` (spec doesn't require, correct enhancement)\n\n**Severity**: 🟡 **MEDIUM** - API won't accept commitments/twin_updates from Next.js\n\n---\n\n## 4. SECURITY ANALYSIS\n\n### ✅ Trust Boundary Correctly Enforced (§0.5)\n\n1. **userId from Session** (Lines 100-101):\n   ```python\n   auth = require_auth(request)\n   user_id = int(auth[\"user_id\"])\n   ```\n   ✅ Correctly extracts from server-side session, never from request body\n\n2. **Session Ownership Validation** (Lines 186-188, 144-146):\n   ```python\n   existing = chat_service.get_session(user_id, body.session_id)\n   if not existing:\n       raise HTTPException(status_code=404, detail=\"session_not_found\")\n   ```\n   ✅ Validates that `session_id` belongs to authenticated user\n\n3. **Internal API Isolation** (Lines 25):\n   ```python\n   router = APIRouter(prefix=\"/internal\", tags=[\"internal\"])\n   ```\n   ✅ Prefix suggests internal-only, but **no IP whitelist/service token check** in code\n\n### ⚠️ Missing Security Controls\n\n**Gap**: No rate limiting or service token validation\n- Spec (line 442): \"只对内部调用开放，需 X-Service-Token 或 IP 白名单\"\n- Implementation: No token/IP checks\n\n**Mitigation**: Depends on Nginx reverse proxy (Phase 1, lines 809-816) to enforce access control\n\n---\n\n## 5. ROUTER REGISTRATION CHECK\n\n**File**: `/home/aiscend/work/fortune_ai/api/main.py`\n\n**Line 54** (confirmed):\n```python\nfrom api.internal_routes import router as internal_router\n```\n\n**Line 135** (confirmed):\n```python\napp.include_router(internal_router)  # Internal APIs for Next.js Agent Runtime\n```\n\n✅ **Router correctly registered**\n\n---\n\n## 6. SUMMARY TABLE\n\n| Requirement | Status | Priority | Notes |\n|-------------|--------|----------|-------|\n| **Endpoint: GET /internal/context** | ✅ Implemented | Must-have | Schema structure differs from spec |\n| **Endpoint: POST /internal/chat/run/start** | ✅ Implemented | Must-have | Enhanced with extra response fields |\n| **Endpoint: POST /internal/chat/run/finalize** | ⚠️ Partial | Must-have | Missing critical persistence logic |\n| **Request/Response Schemas** | 🔴 Mismatch | High | FinalizeRunRequest missing commitments/twin_updates |\n| **Tool Call Logging** | 🔴 Missing | Critical | No DB persistence, no idempotency |\n| **Commitments Persistence** | 🔴 Missing | Critical | Core /heal /grow skill feature broken |\n| **Twin Updates** | 🔴 Missing | Critical | L2 layer not updated |\n| **Transaction Atomicity** | 🔴 Missing | Critical | Data consistency risk |\n| **Security: userId from Session** | ✅ Correct | Must-have | Proper trust boundary |\n| **Security: Session Ownership** | ✅ Correct | Must-have | Validated before use |\n| **Security: Service Token/IP Check** | ⚠️ Missing | High | Should be in code or Nginx |\n| **Error Handling** | ✅ Correct | Medium | Graceful error responses |\n| **Correlation ID Support** | 🟡 Missing | Low | Not captured, helpful for debugging |\n\n---\n\n## 7. RECOMMENDED ACTIONS\n\n### Immediate (Before Next.js Integration):\n\n1. **Add Tool Call Logging** to finalize endpoint:\n   - Insert records to `tool_invocations` table\n   - Use idempotency_key for maxSteps protection\n\n2. **Add Commitments Persistence**:\n   - Accept `commitments` in RunFinalizeRequest\n   - Call `commitment_service.create()` for each\n\n3. **Add Twin Updates**:\n   - Accept `twin_updates` in RunFinalizeRequest\n   - Call `twin_service.update()` with L1/L2/L3 paths\n\n4. **Wrap in Transaction**:\n   - Use database transaction context for atomicity\n   - Rollback on any persistence failure\n\n5. **Update Request Schema**:\n   - Add `tool_logs` field (structured ToolLog array)\n   - Add `commitments` field\n   - Add `twin_updates` field\n   - Keep `tool_calls` for backward compatibility\n\n### Before Production:\n\n6. **Add Service Token Validation**:\n   - Check `X-Service-Token` header in `/internal/*` endpoints\n   - Or document that Nginx handles IP whitelist enforcement\n\n7. **Add Correlation ID Support**:\n   - Capture `X-Correlation-ID` header in Context API\n   - Pass through to logging for distributed tracing\n\n8. **Update Context API Response Schema**:\n   - Either adopt spec's nested l0/l1/policy_flags structure\n   - OR document intentional deviation with operational justification\n\n---\n\n## 8. CONCLUSION\n\nThe `internal_routes.py` implementation is **operationally functional** for basic chat flow but **incomplete for the full specification**. The three critical gaps (tool logging, commitments, twin updates) must be fixed before Next.js Agent Runtime can rely on this contract.\n\n**Risk Level**: 🔴 **HIGH** - Finalize endpoint is partially implemented; commitments and twin state won't persist.\n\n**Recommendation**: Return to development phase and complete the missing persistence logic before integration testing."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":27495,"cache_read_input_tokens":44423,"cache_creation":{"ephemeral_5m_input_tokens":27495,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWgtx7skocHSjMAdvvHrh","type":"assistant","uuid":"2749b68c-e6c1-4131-998c-0b9b1cc6f8b6","timestamp":"2026-01-01T15:30:28.103Z"}
