{"parentUuid":null,"isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":"Review the frontend API client updates against the backend_refactoring_plan_v42.md specification.\n\nCheck:\n1. `/home/aiscend/work/fortune_ai/web-app/src/lib/api.ts` - Frontend API client\n2. `/home/aiscend/work/fortune_ai/web-app/package.json` - Dependencies\n\nVerify against plan sections:\n- §4.1 Update API Client (USE_NEW_RUNTIME flag)\n- §4.2 Add useChat Support\n- §0.6.3 统一错误语义\n\nCheck if:\n1. Feature flag for new runtime exists\n2. New streaming function handles Vercel AI SDK data stream format\n3. ToolInvocation types are defined\n4. Error handling follows the plan's ApiResponse format\n\nReport any gaps or issues with the frontend integration."},"uuid":"a857ca9b-5b5e-4636-8cea-3f2aee021981","timestamp":"2026-01-01T15:29:25.797Z"}
{"parentUuid":"a857ca9b-5b5e-4636-8cea-3f2aee021981","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CyCxcB7hMkkLpKyRawbZyP","type":"message","role":"assistant","content":[{"type":"text","text":"I'll review the frontend API client updates against the backend refactoring plan. Let me start by reading the relevant files and the specification."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":517,"cache_read_input_tokens":20481,"cache_creation":{"ephemeral_5m_input_tokens":517,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWgtvzJZfZQjMzeK9oB8P","type":"assistant","uuid":"a2cc0824-0fbd-4425-92ec-1b4e7e8fa80c","timestamp":"2026-01-01T15:29:28.347Z"}
{"parentUuid":"a2cc0824-0fbd-4425-92ec-1b4e7e8fa80c","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CyCxcB7hMkkLpKyRawbZyP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01YJwBDLJ1UnDNwye2P3BYvx","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/web-app/src/lib/api.ts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":517,"cache_read_input_tokens":20481,"cache_creation":{"ephemeral_5m_input_tokens":517,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWgtvzJZfZQjMzeK9oB8P","type":"assistant","uuid":"0bc2a627-8945-4e3c-9a0a-2183645341be","timestamp":"2026-01-01T15:29:28.929Z"}
{"parentUuid":"0bc2a627-8945-4e3c-9a0a-2183645341be","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CyCxcB7hMkkLpKyRawbZyP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013raW9SvRshLmkUGb2JijWs","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/web-app/package.json"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":517,"cache_read_input_tokens":20481,"cache_creation":{"ephemeral_5m_input_tokens":517,"ephemeral_1h_input_tokens":0},"output_tokens":8,"service_tier":"standard"}},"requestId":"req_011CWgtvzJZfZQjMzeK9oB8P","type":"assistant","uuid":"c3fbf250-6582-4a4d-be07-96bbc8653fb7","timestamp":"2026-01-01T15:29:28.964Z"}
{"parentUuid":"c3fbf250-6582-4a4d-be07-96bbc8653fb7","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01CyCxcB7hMkkLpKyRawbZyP","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01G8uCWnUp4oStYaZFhfFJ1s","name":"Bash","input":{"command":"find /home/aiscend/work/fortune_ai -name \"*backend_refactoring_plan*\" -type f","description":"Find the backend refactoring plan file"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":517,"cache_read_input_tokens":20481,"cache_creation":{"ephemeral_5m_input_tokens":517,"ephemeral_1h_input_tokens":0},"output_tokens":246,"service_tier":"standard"}},"requestId":"req_011CWgtvzJZfZQjMzeK9oB8P","type":"assistant","uuid":"1e3c2386-977d-4f0b-8c29-40637416e6e2","timestamp":"2026-01-01T15:29:29.697Z"}
{"parentUuid":"1e3c2386-977d-4f0b-8c29-40637416e6e2","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01YJwBDLJ1UnDNwye2P3BYvx","type":"tool_result","content":"     1→/**\n     2→ * API Layer - 与后端 Soul OS API 通信\n     3→ *\n     4→ * 后端 API 格式: { ok: boolean, data?: T, error?: { code, message, detail } }\n     5→ */\n     6→\n     7→const API_BASE = process.env.NEXT_PUBLIC_API_BASE || ''\n     8→\n     9→// Cookie helper\n    10→function getCookie(name: string): string {\n    11→  if (typeof document === 'undefined') return ''\n    12→  const match = document.cookie.match(new RegExp(`(?:^|; )${name.replace(/[-.]/g, '\\\\$&')}=([^;]*)`))\n    13→  return match ? decodeURIComponent(match[1]) : ''\n    14→}\n    15→\n    16→// CSRF headers\n    17→function csrfHeaders(): Record<string, string> {\n    18→  const csrf = getCookie('fortune_csrf')\n    19→  return csrf ? { 'X-CSRF-Token': csrf } : {}\n    20→}\n    21→\n    22→// Generic API response type\n    23→interface ApiResponse<T> {\n    24→  ok: boolean\n    25→  data?: T\n    26→  error?: {\n    27→    code: string\n    28→    message: string\n    29→    detail?: Record<string, unknown>\n    30→  }\n    31→}\n    32→\n    33→// Fetch with auth\n    34→async function fetchApi<T>(\n    35→  url: string,\n    36→  options: RequestInit = {}\n    37→): Promise<T> {\n    38→  const headers: Record<string, string> = {\n    39→    'Content-Type': 'application/json',\n    40→    ...csrfHeaders(),\n    41→    ...(options.headers as Record<string, string> || {}),\n    42→  }\n    43→\n    44→  const res = await fetch(`${API_BASE}${url}`, {\n    45→    ...options,\n    46→    headers,\n    47→    credentials: 'include', // Send cookies\n    48→  })\n    49→\n    50→  const json: ApiResponse<T> = await res.json().catch(() => ({ ok: false }))\n    51→\n    52→  if (!res.ok || !json.ok) {\n    53→    if (res.status === 401 || res.status === 403) {\n    54→      // Redirect to login (with basePath)\n    55→      if (typeof window !== 'undefined') {\n    56→        window.location.href = '/new/login'\n    57→      }\n    58→      throw new Error('Unauthorized')\n    59→    }\n    60→    throw new Error(json.error?.message || 'Request failed')\n    61→  }\n    62→\n    63→  return json.data as T\n    64→}\n    65→\n    66→// =============================================================================\n    67→// Dashboard API Types\n    68→// =============================================================================\n    69→\n    70→export interface StateScore {\n    71→  score: number\n    72→  breakdown: {\n    73→    emotion: number\n    74→    action: number\n    75→    streak: number\n    76→  }\n    77→  recovery_action: string | null\n    78→}\n    79→\n    80→export interface PermaScore {\n    81→  score: number\n    82→  trend?: 'up' | 'down' | 'stable'\n    83→}\n    84→\n    85→export interface PermaData {\n    86→  positive_emotion: PermaScore\n    87→  engagement: PermaScore\n    88→  relationships: PermaScore\n    89→  meaning: PermaScore\n    90→  accomplishment: PermaScore\n    91→}\n    92→\n    93→export interface TaskItem {\n    94→  task_id: string\n    95→  title: string\n    96→  status: 'suggested' | 'active' | 'done' | 'skipped'\n    97→  commitment_type?: 'start_task' | 'schedule_task'\n    98→  minutes?: number\n    99→  if_then?: string\n   100→}\n   101→\n   102→export interface RiskAlert {\n   103→  type: string\n   104→  message: string\n   105→}\n   106→\n   107→export interface OverviewData {\n   108→  insight: string\n   109→  state_score: StateScore\n   110→  perma: PermaData\n   111→  today_tasks: TaskItem[]\n   112→  risk_alerts: RiskAlert[]\n   113→}\n   114→\n   115→export interface L0Translation {\n   116→  concept: string\n   117→  translation: string\n   118→  action: string\n   119→}\n   120→\n   121→export interface L0Facts {\n   122→  day_master: string\n   123→  strength: string\n   124→  translations: L0Translation[]\n   125→}\n   126→\n   127→export interface L1Schema {\n   128→  perma_snapshot: PermaData\n   129→  cognitive_patterns: {\n   130→    identified_schemas: string[]\n   131→    reframe_count?: number\n   132→  }\n   133→  strengths_in_use: string[]\n   134→}\n   135→\n   136→export interface StatusData {\n   137→  l0_facts: L0Facts\n   138→  l1_schema: L1Schema\n   139→  state_score: StateScore\n   140→}\n   141→\n   142→export interface TrendPoint {\n   143→  date: string\n   144→  score: number\n   145→}\n   146→\n   147→export interface TrendEvent {\n   148→  date: string\n   149→  type: string\n   150→  title: string\n   151→}\n   152→\n   153→export interface TrendsData {\n   154→  state_score_history: TrendPoint[]\n   155→  events: TrendEvent[]\n   156→}\n   157→\n   158→export interface TasksData {\n   159→  active: TaskItem[]\n   160→  suggested: TaskItem[]\n   161→  completed_recent: TaskItem[]\n   162→}\n   163→\n   164→export interface RelationItem {\n   165→  id: string\n   166→  name: string\n   167→  type: string\n   168→  compatibility?: number\n   169→}\n   170→\n   171→export interface RelationsData {\n   172→  relations: RelationItem[]\n   173→}\n   174→\n   175→export interface ExploreItem {\n   176→  id: string\n   177→  title: string\n   178→  type: 'mystic' | 'course' | 'artifact'\n   179→  description?: string\n   180→}\n   181→\n   182→export interface ExploreData {\n   183→  mystic_entries: ExploreItem[]\n   184→  courses: ExploreItem[]\n   185→  artifacts: ExploreItem[]\n   186→}\n   187→\n   188→export interface CheckinResponse {\n   189→  insight: string\n   190→  action: {\n   191→    content: string\n   192→    minutes: number\n   193→    if_then: string\n   194→  }\n   195→  state_score: StateScore\n   196→}\n   197→\n   198→// =============================================================================\n   199→// Dashboard API Functions\n   200→// =============================================================================\n   201→\n   202→export async function fetchOverview(): Promise<OverviewData> {\n   203→  return fetchApi<OverviewData>('/api/dashboard/overview')\n   204→}\n   205→\n   206→export async function fetchStatus(): Promise<StatusData> {\n   207→  return fetchApi<StatusData>('/api/dashboard/status')\n   208→}\n   209→\n   210→export async function fetchTrends(days: number = 7): Promise<TrendsData> {\n   211→  return fetchApi<TrendsData>(`/api/dashboard/trends?days=${days}`)\n   212→}\n   213→\n   214→export async function fetchTasks(): Promise<TasksData> {\n   215→  return fetchApi<TasksData>('/api/dashboard/tasks')\n   216→}\n   217→\n   218→export async function fetchRelations(): Promise<RelationsData> {\n   219→  return fetchApi<RelationsData>('/api/dashboard/relations')\n   220→}\n   221→\n   222→export async function fetchExplore(): Promise<ExploreData> {\n   223→  return fetchApi<ExploreData>('/api/dashboard/explore')\n   224→}\n   225→\n   226→// Task Actions\n   227→export async function acceptTask(\n   228→  taskId: string,\n   229→  commitmentType: 'start_task' | 'schedule_task' = 'start_task'\n   230→): Promise<{ commitment_id: string; status: string }> {\n   231→  return fetchApi('/api/dashboard/task/accept', {\n   232→    method: 'POST',\n   233→    body: JSON.stringify({ task_id: taskId, commitment_type: commitmentType }),\n   234→  })\n   235→}\n   236→\n   237→export async function completeTask(\n   238→  taskId: string,\n   239→  note: string = ''\n   240→): Promise<{ status: string; state_score: StateScore }> {\n   241→  return fetchApi('/api/dashboard/task/done', {\n   242→    method: 'POST',\n   243→    body: JSON.stringify({ task_id: taskId, note }),\n   244→  })\n   245→}\n   246→\n   247→export async function skipTask(\n   248→  taskId: string,\n   249→  reason: string = ''\n   250→): Promise<{ status: string }> {\n   251→  return fetchApi('/api/dashboard/task/skip', {\n   252→    method: 'POST',\n   253→    body: JSON.stringify({ task_id: taskId, reason }),\n   254→  })\n   255→}\n   256→\n   257→// Checkin\n   258→export async function submitCheckin(\n   259→  mood: string,\n   260→  intensity: number,\n   261→  note: string = ''\n   262→): Promise<CheckinResponse> {\n   263→  return fetchApi('/api/dashboard/checkin', {\n   264→    method: 'POST',\n   265→    body: JSON.stringify({ mood, intensity, note }),\n   266→  })\n   267→}\n   268→\n   269→// =============================================================================\n   270→// Chat API\n   271→// =============================================================================\n   272→\n   273→// Feature flag for new Agent Runtime (Next.js)\n   274→const USE_NEW_RUNTIME = process.env.NEXT_PUBLIC_USE_NEW_RUNTIME === 'true'\n   275→\n   276→export interface ChatMessage {\n   277→  role: 'user' | 'assistant'\n   278→  content: string\n   279→  timestamp?: string\n   280→  toolInvocations?: ToolInvocation[]\n   281→}\n   282→\n   283→export interface ToolInvocation {\n   284→  toolCallId: string\n   285→  toolName: string\n   286→  args: Record<string, unknown>\n   287→  result?: unknown\n   288→}\n   289→\n   290→export interface SendChatRequest {\n   291→  message: string\n   292→  session_id?: string\n   293→  command?: string\n   294→}\n   295→\n   296→export interface SendChatResponse {\n   297→  session_id: string\n   298→  reply: string\n   299→  ui_components?: unknown[]\n   300→  toolInvocations?: ToolInvocation[]\n   301→}\n   302→\n   303→export async function sendChatMessage(\n   304→  message: string,\n   305→  sessionId?: string\n   306→): Promise<SendChatResponse> {\n   307→  const result = await fetchApi<{\n   308→    session_id: string\n   309→    assistant_message?: { role: string; a2ui?: unknown }\n   310→    suggested_tasks?: unknown[]\n   311→  }>('/api/chat/send', {\n   312→    method: 'POST',\n   313→    body: JSON.stringify({ text: message, session_id: sessionId }),\n   314→  })\n   315→\n   316→  // Extract reply from a2ui response\n   317→  const a2ui = result.assistant_message?.a2ui as { ui_components?: Array<{ type: string; data: string }> } | undefined\n   318→  const markdownComponent = a2ui?.ui_components?.find(c => c.type === 'markdown_text')\n   319→  const reply = markdownComponent?.data || ''\n   320→\n   321→  return {\n   322→    session_id: result.session_id,\n   323→    reply,\n   324→    ui_components: a2ui?.ui_components,\n   325→  }\n   326→}\n   327→\n   328→// =============================================================================\n   329→// Auth API\n   330→// =============================================================================\n   331→\n   332→export interface LoginRequest {\n   333→  email: string\n   334→  password: string\n   335→}\n   336→\n   337→export interface LoginResponse {\n   338→  user_id: number\n   339→  email: string\n   340→}\n   341→\n   342→export interface RegisterRequest {\n   343→  email: string\n   344→  password: string\n   345→  name: string\n   346→  gender: string\n   347→  birthday_local: string\n   348→  tz_offset_hours: number\n   349→  location: {\n   350→    name: string\n   351→    longitude: number\n   352→    latitude: number\n   353→  }\n   354→}\n   355→\n   356→export interface RegisterResponse {\n   357→  user_id: number\n   358→  email: string\n   359→  profile_summary: {\n   360→    name: string\n   361→    gender: string\n   362→    location_name: string\n   363→  }\n   364→}\n   365→\n   366→export interface UserInfo {\n   367→  user_id: number\n   368→  email: string\n   369→  name: string\n   370→  persona_style: string\n   371→}\n   372→\n   373→export type ChatBackend = 'agent_service' | 'fastapi'\n   374→\n   375→export interface UserPreferences {\n   376→  persona_style: 'standard' | 'warm' | 'roast'\n   377→  push_enabled: boolean\n   378→  push_time: string\n   379→  quiet_hours_start: string\n   380→  quiet_hours_end: string\n   381→  chat_backend: ChatBackend\n   382→}\n   383→\n   384→export async function login(email: string, password: string): Promise<LoginResponse> {\n   385→  const res = await fetch(`${API_BASE}/api/auth/login`, {\n   386→    method: 'POST',\n   387→    headers: { 'Content-Type': 'application/json' },\n   388→    credentials: 'include',\n   389→    body: JSON.stringify({ email, password }),\n   390→  })\n   391→  const json = await res.json()\n   392→  if (!res.ok || !json.ok) {\n   393→    throw new Error(json.error?.message || 'Login failed')\n   394→  }\n   395→  return json.data\n   396→}\n   397→\n   398→export async function register(data: RegisterRequest): Promise<RegisterResponse> {\n   399→  const res = await fetch(`${API_BASE}/api/auth/register`, {\n   400→    method: 'POST',\n   401→    headers: { 'Content-Type': 'application/json' },\n   402→    credentials: 'include',\n   403→    body: JSON.stringify(data),\n   404→  })\n   405→  const json = await res.json()\n   406→  if (!res.ok || !json.ok) {\n   407→    throw new Error(json.error?.message || 'Register failed')\n   408→  }\n   409→  return json.data\n   410→}\n   411→\n   412→export async function logout(): Promise<void> {\n   413→  await fetchApi('/api/auth/logout', { method: 'POST' })\n   414→}\n   415→\n   416→export async function fetchMe(): Promise<UserInfo> {\n   417→  return fetchApi<UserInfo>('/api/auth/me')\n   418→}\n   419→\n   420→export async function fetchPreferences(): Promise<UserPreferences> {\n   421→  return fetchApi<UserPreferences>('/api/user/preferences')\n   422→}\n   423→\n   424→export async function updatePreferences(\n   425→  patch: Partial<Pick<UserPreferences, 'persona_style' | 'push_enabled' | 'push_time' | 'quiet_hours_start' | 'quiet_hours_end' | 'chat_backend'>>\n   426→): Promise<void> {\n   427→  await fetchApi('/api/user/preferences', {\n   428→    method: 'PUT',\n   429→    body: JSON.stringify(patch),\n   430→  })\n   431→}\n   432→\n   433→// SSE Chat Stream\n   434→export function streamChatMessage(\n   435→  message: string,\n   436→  sessionId: string | undefined,\n   437→  onChunk: (chunk: string) => void,\n   438→  onDone: (fullResponse: SendChatResponse) => void,\n   439→  onError: (error: Error) => void\n   440→): () => void {\n   441→  const controller = new AbortController()\n   442→\n   443→  const params = new URLSearchParams({ message })\n   444→  if (sessionId) params.set('session_id', sessionId)\n   445→\n   446→  let resolvedSessionId = sessionId || ''\n   447→\n   448→  fetch(`${API_BASE}/api/chat/stream?${params}`, {\n   449→    method: 'GET',\n   450→    credentials: 'include',\n   451→    headers: csrfHeaders(),\n   452→    signal: controller.signal,\n   453→  })\n   454→    .then(async (response) => {\n   455→      if (!response.ok) {\n   456→        // Backward-compatible fallback: older backends may not implement /api/chat/stream yet.\n   457→        if (response.status === 404 || response.status === 405) {\n   458→          const fallback = await sendChatMessage(message, sessionId)\n   459→          onDone(fallback)\n   460→          return\n   461→        }\n   462→        const errorText = await response.text().catch(() => '')\n   463→        const detail = errorText ? `: ${errorText.slice(0, 200)}` : ''\n   464→        throw new Error(`Stream request failed (${response.status})${detail}`)\n   465→      }\n   466→\n   467→      const reader = response.body?.getReader()\n   468→      if (!reader) throw new Error('No reader')\n   469→\n   470→      const decoder = new TextDecoder()\n   471→      let buffer = ''\n   472→      let fullContent = ''\n   473→\n   474→      while (true) {\n   475→        const { done, value } = await reader.read()\n   476→        if (done) break\n   477→\n   478→        buffer += decoder.decode(value, { stream: true })\n   479→        const lines = buffer.split('\\n')\n   480→        buffer = lines.pop() || ''\n   481→\n   482→        for (const line of lines) {\n   483→          if (line.startsWith('data: ')) {\n   484→            const data = line.slice(6)\n   485→            if (data === '[DONE]') {\n   486→              onDone({\n   487→                session_id: resolvedSessionId,\n   488→                reply: fullContent,\n   489→              })\n   490→              return\n   491→            }\n   492→            try {\n   493→              const json = JSON.parse(data)\n   494→              if (json?.type === 'meta' && typeof json.session_id === 'string') {\n   495→                resolvedSessionId = json.session_id\n   496→              } else if (json?.type === 'delta' && typeof json.delta === 'string') {\n   497→                fullContent += json.delta\n   498→                onChunk(json.delta)\n   499→              } else if (json?.type === 'final' && json.data) {\n   500→                const sid = typeof json.data.session_id === 'string' ? json.data.session_id : resolvedSessionId\n   501→                resolvedSessionId = sid\n   502→\n   503→                const a2ui = json.data?.assistant_message?.a2ui as\n   504→                  | { ui_components?: Array<{ type: string; data: unknown }> }\n   505→                  | undefined\n   506→                const markdownComponent = a2ui?.ui_components?.find((c) => c.type === 'markdown_text')\n   507→                const reply = typeof markdownComponent?.data === 'string' ? markdownComponent.data : fullContent\n   508→\n   509→                onDone({\n   510→                  session_id: sid,\n   511→                  reply,\n   512→                  ui_components: a2ui?.ui_components,\n   513→                })\n   514→                return\n   515→              } else if (json?.type === 'error' && typeof json.error === 'string') {\n   516→                throw new Error(json.error)\n   517→              } else if (typeof json?.content === 'string') {\n   518→                // Backward-compatible: {content:\"...\"}\n   519→                fullContent += json.content\n   520→                onChunk(json.content)\n   521→              }\n   522→            } catch {\n   523→              // Skip invalid JSON\n   524→            }\n   525→          }\n   526→        }\n   527→      }\n   528→    })\n   529→    .catch((err) => {\n   530→      if (err.name !== 'AbortError') {\n   531→        onError(err)\n   532→      }\n   533→    })\n   534→\n   535→  return () => controller.abort()\n   536→}\n   537→\n   538→// New Agent Runtime streaming (Vercel AI SDK data stream)\n   539→export function streamChatMessageNew(\n   540→  message: string,\n   541→  sessionId: string | undefined,\n   542→  command: string | undefined,\n   543→  onChunk: (chunk: string) => void,\n   544→  onToolCall: (toolInvocation: ToolInvocation) => void,\n   545→  onDone: (fullResponse: SendChatResponse) => void,\n   546→  onError: (error: Error) => void\n   547→): () => void {\n   548→  const controller = new AbortController()\n   549→\n   550→  fetch('/api/chat', {\n   551→    method: 'POST',\n   552→    headers: {\n   553→      'Content-Type': 'application/json',\n   554→    },\n   555→    credentials: 'include',\n   556→    body: JSON.stringify({\n   557→      session_id: sessionId || null,\n   558→      message,\n   559→      command: command || null,\n   560→    }),\n   561→    signal: controller.signal,\n   562→  })\n   563→    .then(async (response) => {\n   564→      if (!response.ok) {\n   565→        const errorText = await response.text().catch(() => '')\n   566→        throw new Error(`Request failed (${response.status}): ${errorText.slice(0, 200)}`)\n   567→      }\n   568→\n   569→      // Get session info from headers\n   570→      const resolvedSessionId = response.headers.get('X-Session-Id') || sessionId || ''\n   571→\n   572→      const reader = response.body?.getReader()\n   573→      if (!reader) throw new Error('No reader')\n   574→\n   575→      const decoder = new TextDecoder()\n   576→      let buffer = ''\n   577→      let fullContent = ''\n   578→      const toolInvocations: ToolInvocation[] = []\n   579→\n   580→      // Parse Vercel AI SDK data stream format\n   581→      while (true) {\n   582→        const { done, value } = await reader.read()\n   583→        if (done) break\n   584→\n   585→        buffer += decoder.decode(value, { stream: true })\n   586→        const lines = buffer.split('\\n')\n   587→        buffer = lines.pop() || ''\n   588→\n   589→        for (const line of lines) {\n   590→          if (!line.trim()) continue\n   591→\n   592→          // Vercel AI SDK data stream format: \"type:json\\n\"\n   593→          const colonIndex = line.indexOf(':')\n   594→          if (colonIndex === -1) continue\n   595→\n   596→          const type = line.slice(0, colonIndex)\n   597→          const dataStr = line.slice(colonIndex + 1)\n   598→\n   599→          try {\n   600→            switch (type) {\n   601→              case '0': // Text chunk\n   602→                const text = JSON.parse(dataStr) as string\n   603→                fullContent += text\n   604→                onChunk(text)\n   605→                break\n   606→\n   607→              case '9': // Tool call\n   608→                const toolCall = JSON.parse(dataStr) as {\n   609→                  toolCallId: string\n   610→                  toolName: string\n   611→                  args: Record<string, unknown>\n   612→                }\n   613→                const invocation: ToolInvocation = {\n   614→                  ...toolCall,\n   615→                  result: undefined,\n   616→                }\n   617→                toolInvocations.push(invocation)\n   618→                onToolCall(invocation)\n   619→                break\n   620→\n   621→              case 'a': // Tool result\n   622→                const toolResult = JSON.parse(dataStr) as {\n   623→                  toolCallId: string\n   624→                  result: unknown\n   625→                }\n   626→                const existingInvocation = toolInvocations.find(\n   627→                  (t) => t.toolCallId === toolResult.toolCallId\n   628→                )\n   629→                if (existingInvocation) {\n   630→                  existingInvocation.result = toolResult.result\n   631→                  onToolCall(existingInvocation)\n   632→                }\n   633→                break\n   634→\n   635→              case 'd': // Finish message\n   636→                // Stream complete\n   637→                break\n   638→\n   639→              case 'e': // Error\n   640→                const error = JSON.parse(dataStr)\n   641→                throw new Error(error.message || 'Stream error')\n   642→\n   643→              default:\n   644→                // Unknown type, skip\n   645→                break\n   646→            }\n   647→          } catch (parseError) {\n   648→            console.warn('[chat] Failed to parse stream data:', line)\n   649→          }\n   650→        }\n   651→      }\n   652→\n   653→      // Stream complete\n   654→      onDone({\n   655→        session_id: resolvedSessionId,\n   656→        reply: fullContent,\n   657→        toolInvocations: toolInvocations.length > 0 ? toolInvocations : undefined,\n   658→      })\n   659→    })\n   660→    .catch((err) => {\n   661→      if (err.name !== 'AbortError') {\n   662→        onError(err)\n   663→      }\n   664→    })\n   665→\n   666→  return () => controller.abort()\n   667→}\n   668→\n   669→// Smart stream function that picks the right implementation\n   670→export function streamChat(\n   671→  message: string,\n   672→  sessionId: string | undefined,\n   673→  options: {\n   674→    command?: string\n   675→    onChunk: (chunk: string) => void\n   676→    onToolCall?: (toolInvocation: ToolInvocation) => void\n   677→    onDone: (fullResponse: SendChatResponse) => void\n   678→    onError: (error: Error) => void\n   679→  }\n   680→): () => void {\n   681→  if (USE_NEW_RUNTIME) {\n   682→    return streamChatMessageNew(\n   683→      message,\n   684→      sessionId,\n   685→      options.command,\n   686→      options.onChunk,\n   687→      options.onToolCall || (() => {}),\n   688→      options.onDone,\n   689→      options.onError\n   690→    )\n   691→  } else {\n   692→    return streamChatMessage(\n   693→      message,\n   694→      sessionId,\n   695→      options.onChunk,\n   696→      options.onDone,\n   697→      options.onError\n   698→    )\n   699→  }\n   700→}\n   701→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"ec923dbe-f649-4637-8bd7-892e5ba7219c","timestamp":"2026-01-01T15:29:29.881Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/web-app/src/lib/api.ts","content":"/**\n * API Layer - 与后端 Soul OS API 通信\n *\n * 后端 API 格式: { ok: boolean, data?: T, error?: { code, message, detail } }\n */\n\nconst API_BASE = process.env.NEXT_PUBLIC_API_BASE || ''\n\n// Cookie helper\nfunction getCookie(name: string): string {\n  if (typeof document === 'undefined') return ''\n  const match = document.cookie.match(new RegExp(`(?:^|; )${name.replace(/[-.]/g, '\\\\$&')}=([^;]*)`))\n  return match ? decodeURIComponent(match[1]) : ''\n}\n\n// CSRF headers\nfunction csrfHeaders(): Record<string, string> {\n  const csrf = getCookie('fortune_csrf')\n  return csrf ? { 'X-CSRF-Token': csrf } : {}\n}\n\n// Generic API response type\ninterface ApiResponse<T> {\n  ok: boolean\n  data?: T\n  error?: {\n    code: string\n    message: string\n    detail?: Record<string, unknown>\n  }\n}\n\n// Fetch with auth\nasync function fetchApi<T>(\n  url: string,\n  options: RequestInit = {}\n): Promise<T> {\n  const headers: Record<string, string> = {\n    'Content-Type': 'application/json',\n    ...csrfHeaders(),\n    ...(options.headers as Record<string, string> || {}),\n  }\n\n  const res = await fetch(`${API_BASE}${url}`, {\n    ...options,\n    headers,\n    credentials: 'include', // Send cookies\n  })\n\n  const json: ApiResponse<T> = await res.json().catch(() => ({ ok: false }))\n\n  if (!res.ok || !json.ok) {\n    if (res.status === 401 || res.status === 403) {\n      // Redirect to login (with basePath)\n      if (typeof window !== 'undefined') {\n        window.location.href = '/new/login'\n      }\n      throw new Error('Unauthorized')\n    }\n    throw new Error(json.error?.message || 'Request failed')\n  }\n\n  return json.data as T\n}\n\n// =============================================================================\n// Dashboard API Types\n// =============================================================================\n\nexport interface StateScore {\n  score: number\n  breakdown: {\n    emotion: number\n    action: number\n    streak: number\n  }\n  recovery_action: string | null\n}\n\nexport interface PermaScore {\n  score: number\n  trend?: 'up' | 'down' | 'stable'\n}\n\nexport interface PermaData {\n  positive_emotion: PermaScore\n  engagement: PermaScore\n  relationships: PermaScore\n  meaning: PermaScore\n  accomplishment: PermaScore\n}\n\nexport interface TaskItem {\n  task_id: string\n  title: string\n  status: 'suggested' | 'active' | 'done' | 'skipped'\n  commitment_type?: 'start_task' | 'schedule_task'\n  minutes?: number\n  if_then?: string\n}\n\nexport interface RiskAlert {\n  type: string\n  message: string\n}\n\nexport interface OverviewData {\n  insight: string\n  state_score: StateScore\n  perma: PermaData\n  today_tasks: TaskItem[]\n  risk_alerts: RiskAlert[]\n}\n\nexport interface L0Translation {\n  concept: string\n  translation: string\n  action: string\n}\n\nexport interface L0Facts {\n  day_master: string\n  strength: string\n  translations: L0Translation[]\n}\n\nexport interface L1Schema {\n  perma_snapshot: PermaData\n  cognitive_patterns: {\n    identified_schemas: string[]\n    reframe_count?: number\n  }\n  strengths_in_use: string[]\n}\n\nexport interface StatusData {\n  l0_facts: L0Facts\n  l1_schema: L1Schema\n  state_score: StateScore\n}\n\nexport interface TrendPoint {\n  date: string\n  score: number\n}\n\nexport interface TrendEvent {\n  date: string\n  type: string\n  title: string\n}\n\nexport interface TrendsData {\n  state_score_history: TrendPoint[]\n  events: TrendEvent[]\n}\n\nexport interface TasksData {\n  active: TaskItem[]\n  suggested: TaskItem[]\n  completed_recent: TaskItem[]\n}\n\nexport interface RelationItem {\n  id: string\n  name: string\n  type: string\n  compatibility?: number\n}\n\nexport interface RelationsData {\n  relations: RelationItem[]\n}\n\nexport interface ExploreItem {\n  id: string\n  title: string\n  type: 'mystic' | 'course' | 'artifact'\n  description?: string\n}\n\nexport interface ExploreData {\n  mystic_entries: ExploreItem[]\n  courses: ExploreItem[]\n  artifacts: ExploreItem[]\n}\n\nexport interface CheckinResponse {\n  insight: string\n  action: {\n    content: string\n    minutes: number\n    if_then: string\n  }\n  state_score: StateScore\n}\n\n// =============================================================================\n// Dashboard API Functions\n// =============================================================================\n\nexport async function fetchOverview(): Promise<OverviewData> {\n  return fetchApi<OverviewData>('/api/dashboard/overview')\n}\n\nexport async function fetchStatus(): Promise<StatusData> {\n  return fetchApi<StatusData>('/api/dashboard/status')\n}\n\nexport async function fetchTrends(days: number = 7): Promise<TrendsData> {\n  return fetchApi<TrendsData>(`/api/dashboard/trends?days=${days}`)\n}\n\nexport async function fetchTasks(): Promise<TasksData> {\n  return fetchApi<TasksData>('/api/dashboard/tasks')\n}\n\nexport async function fetchRelations(): Promise<RelationsData> {\n  return fetchApi<RelationsData>('/api/dashboard/relations')\n}\n\nexport async function fetchExplore(): Promise<ExploreData> {\n  return fetchApi<ExploreData>('/api/dashboard/explore')\n}\n\n// Task Actions\nexport async function acceptTask(\n  taskId: string,\n  commitmentType: 'start_task' | 'schedule_task' = 'start_task'\n): Promise<{ commitment_id: string; status: string }> {\n  return fetchApi('/api/dashboard/task/accept', {\n    method: 'POST',\n    body: JSON.stringify({ task_id: taskId, commitment_type: commitmentType }),\n  })\n}\n\nexport async function completeTask(\n  taskId: string,\n  note: string = ''\n): Promise<{ status: string; state_score: StateScore }> {\n  return fetchApi('/api/dashboard/task/done', {\n    method: 'POST',\n    body: JSON.stringify({ task_id: taskId, note }),\n  })\n}\n\nexport async function skipTask(\n  taskId: string,\n  reason: string = ''\n): Promise<{ status: string }> {\n  return fetchApi('/api/dashboard/task/skip', {\n    method: 'POST',\n    body: JSON.stringify({ task_id: taskId, reason }),\n  })\n}\n\n// Checkin\nexport async function submitCheckin(\n  mood: string,\n  intensity: number,\n  note: string = ''\n): Promise<CheckinResponse> {\n  return fetchApi('/api/dashboard/checkin', {\n    method: 'POST',\n    body: JSON.stringify({ mood, intensity, note }),\n  })\n}\n\n// =============================================================================\n// Chat API\n// =============================================================================\n\n// Feature flag for new Agent Runtime (Next.js)\nconst USE_NEW_RUNTIME = process.env.NEXT_PUBLIC_USE_NEW_RUNTIME === 'true'\n\nexport interface ChatMessage {\n  role: 'user' | 'assistant'\n  content: string\n  timestamp?: string\n  toolInvocations?: ToolInvocation[]\n}\n\nexport interface ToolInvocation {\n  toolCallId: string\n  toolName: string\n  args: Record<string, unknown>\n  result?: unknown\n}\n\nexport interface SendChatRequest {\n  message: string\n  session_id?: string\n  command?: string\n}\n\nexport interface SendChatResponse {\n  session_id: string\n  reply: string\n  ui_components?: unknown[]\n  toolInvocations?: ToolInvocation[]\n}\n\nexport async function sendChatMessage(\n  message: string,\n  sessionId?: string\n): Promise<SendChatResponse> {\n  const result = await fetchApi<{\n    session_id: string\n    assistant_message?: { role: string; a2ui?: unknown }\n    suggested_tasks?: unknown[]\n  }>('/api/chat/send', {\n    method: 'POST',\n    body: JSON.stringify({ text: message, session_id: sessionId }),\n  })\n\n  // Extract reply from a2ui response\n  const a2ui = result.assistant_message?.a2ui as { ui_components?: Array<{ type: string; data: string }> } | undefined\n  const markdownComponent = a2ui?.ui_components?.find(c => c.type === 'markdown_text')\n  const reply = markdownComponent?.data || ''\n\n  return {\n    session_id: result.session_id,\n    reply,\n    ui_components: a2ui?.ui_components,\n  }\n}\n\n// =============================================================================\n// Auth API\n// =============================================================================\n\nexport interface LoginRequest {\n  email: string\n  password: string\n}\n\nexport interface LoginResponse {\n  user_id: number\n  email: string\n}\n\nexport interface RegisterRequest {\n  email: string\n  password: string\n  name: string\n  gender: string\n  birthday_local: string\n  tz_offset_hours: number\n  location: {\n    name: string\n    longitude: number\n    latitude: number\n  }\n}\n\nexport interface RegisterResponse {\n  user_id: number\n  email: string\n  profile_summary: {\n    name: string\n    gender: string\n    location_name: string\n  }\n}\n\nexport interface UserInfo {\n  user_id: number\n  email: string\n  name: string\n  persona_style: string\n}\n\nexport type ChatBackend = 'agent_service' | 'fastapi'\n\nexport interface UserPreferences {\n  persona_style: 'standard' | 'warm' | 'roast'\n  push_enabled: boolean\n  push_time: string\n  quiet_hours_start: string\n  quiet_hours_end: string\n  chat_backend: ChatBackend\n}\n\nexport async function login(email: string, password: string): Promise<LoginResponse> {\n  const res = await fetch(`${API_BASE}/api/auth/login`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    credentials: 'include',\n    body: JSON.stringify({ email, password }),\n  })\n  const json = await res.json()\n  if (!res.ok || !json.ok) {\n    throw new Error(json.error?.message || 'Login failed')\n  }\n  return json.data\n}\n\nexport async function register(data: RegisterRequest): Promise<RegisterResponse> {\n  const res = await fetch(`${API_BASE}/api/auth/register`, {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    credentials: 'include',\n    body: JSON.stringify(data),\n  })\n  const json = await res.json()\n  if (!res.ok || !json.ok) {\n    throw new Error(json.error?.message || 'Register failed')\n  }\n  return json.data\n}\n\nexport async function logout(): Promise<void> {\n  await fetchApi('/api/auth/logout', { method: 'POST' })\n}\n\nexport async function fetchMe(): Promise<UserInfo> {\n  return fetchApi<UserInfo>('/api/auth/me')\n}\n\nexport async function fetchPreferences(): Promise<UserPreferences> {\n  return fetchApi<UserPreferences>('/api/user/preferences')\n}\n\nexport async function updatePreferences(\n  patch: Partial<Pick<UserPreferences, 'persona_style' | 'push_enabled' | 'push_time' | 'quiet_hours_start' | 'quiet_hours_end' | 'chat_backend'>>\n): Promise<void> {\n  await fetchApi('/api/user/preferences', {\n    method: 'PUT',\n    body: JSON.stringify(patch),\n  })\n}\n\n// SSE Chat Stream\nexport function streamChatMessage(\n  message: string,\n  sessionId: string | undefined,\n  onChunk: (chunk: string) => void,\n  onDone: (fullResponse: SendChatResponse) => void,\n  onError: (error: Error) => void\n): () => void {\n  const controller = new AbortController()\n\n  const params = new URLSearchParams({ message })\n  if (sessionId) params.set('session_id', sessionId)\n\n  let resolvedSessionId = sessionId || ''\n\n  fetch(`${API_BASE}/api/chat/stream?${params}`, {\n    method: 'GET',\n    credentials: 'include',\n    headers: csrfHeaders(),\n    signal: controller.signal,\n  })\n    .then(async (response) => {\n      if (!response.ok) {\n        // Backward-compatible fallback: older backends may not implement /api/chat/stream yet.\n        if (response.status === 404 || response.status === 405) {\n          const fallback = await sendChatMessage(message, sessionId)\n          onDone(fallback)\n          return\n        }\n        const errorText = await response.text().catch(() => '')\n        const detail = errorText ? `: ${errorText.slice(0, 200)}` : ''\n        throw new Error(`Stream request failed (${response.status})${detail}`)\n      }\n\n      const reader = response.body?.getReader()\n      if (!reader) throw new Error('No reader')\n\n      const decoder = new TextDecoder()\n      let buffer = ''\n      let fullContent = ''\n\n      while (true) {\n        const { done, value } = await reader.read()\n        if (done) break\n\n        buffer += decoder.decode(value, { stream: true })\n        const lines = buffer.split('\\n')\n        buffer = lines.pop() || ''\n\n        for (const line of lines) {\n          if (line.startsWith('data: ')) {\n            const data = line.slice(6)\n            if (data === '[DONE]') {\n              onDone({\n                session_id: resolvedSessionId,\n                reply: fullContent,\n              })\n              return\n            }\n            try {\n              const json = JSON.parse(data)\n              if (json?.type === 'meta' && typeof json.session_id === 'string') {\n                resolvedSessionId = json.session_id\n              } else if (json?.type === 'delta' && typeof json.delta === 'string') {\n                fullContent += json.delta\n                onChunk(json.delta)\n              } else if (json?.type === 'final' && json.data) {\n                const sid = typeof json.data.session_id === 'string' ? json.data.session_id : resolvedSessionId\n                resolvedSessionId = sid\n\n                const a2ui = json.data?.assistant_message?.a2ui as\n                  | { ui_components?: Array<{ type: string; data: unknown }> }\n                  | undefined\n                const markdownComponent = a2ui?.ui_components?.find((c) => c.type === 'markdown_text')\n                const reply = typeof markdownComponent?.data === 'string' ? markdownComponent.data : fullContent\n\n                onDone({\n                  session_id: sid,\n                  reply,\n                  ui_components: a2ui?.ui_components,\n                })\n                return\n              } else if (json?.type === 'error' && typeof json.error === 'string') {\n                throw new Error(json.error)\n              } else if (typeof json?.content === 'string') {\n                // Backward-compatible: {content:\"...\"}\n                fullContent += json.content\n                onChunk(json.content)\n              }\n            } catch {\n              // Skip invalid JSON\n            }\n          }\n        }\n      }\n    })\n    .catch((err) => {\n      if (err.name !== 'AbortError') {\n        onError(err)\n      }\n    })\n\n  return () => controller.abort()\n}\n\n// New Agent Runtime streaming (Vercel AI SDK data stream)\nexport function streamChatMessageNew(\n  message: string,\n  sessionId: string | undefined,\n  command: string | undefined,\n  onChunk: (chunk: string) => void,\n  onToolCall: (toolInvocation: ToolInvocation) => void,\n  onDone: (fullResponse: SendChatResponse) => void,\n  onError: (error: Error) => void\n): () => void {\n  const controller = new AbortController()\n\n  fetch('/api/chat', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n    },\n    credentials: 'include',\n    body: JSON.stringify({\n      session_id: sessionId || null,\n      message,\n      command: command || null,\n    }),\n    signal: controller.signal,\n  })\n    .then(async (response) => {\n      if (!response.ok) {\n        const errorText = await response.text().catch(() => '')\n        throw new Error(`Request failed (${response.status}): ${errorText.slice(0, 200)}`)\n      }\n\n      // Get session info from headers\n      const resolvedSessionId = response.headers.get('X-Session-Id') || sessionId || ''\n\n      const reader = response.body?.getReader()\n      if (!reader) throw new Error('No reader')\n\n      const decoder = new TextDecoder()\n      let buffer = ''\n      let fullContent = ''\n      const toolInvocations: ToolInvocation[] = []\n\n      // Parse Vercel AI SDK data stream format\n      while (true) {\n        const { done, value } = await reader.read()\n        if (done) break\n\n        buffer += decoder.decode(value, { stream: true })\n        const lines = buffer.split('\\n')\n        buffer = lines.pop() || ''\n\n        for (const line of lines) {\n          if (!line.trim()) continue\n\n          // Vercel AI SDK data stream format: \"type:json\\n\"\n          const colonIndex = line.indexOf(':')\n          if (colonIndex === -1) continue\n\n          const type = line.slice(0, colonIndex)\n          const dataStr = line.slice(colonIndex + 1)\n\n          try {\n            switch (type) {\n              case '0': // Text chunk\n                const text = JSON.parse(dataStr) as string\n                fullContent += text\n                onChunk(text)\n                break\n\n              case '9': // Tool call\n                const toolCall = JSON.parse(dataStr) as {\n                  toolCallId: string\n                  toolName: string\n                  args: Record<string, unknown>\n                }\n                const invocation: ToolInvocation = {\n                  ...toolCall,\n                  result: undefined,\n                }\n                toolInvocations.push(invocation)\n                onToolCall(invocation)\n                break\n\n              case 'a': // Tool result\n                const toolResult = JSON.parse(dataStr) as {\n                  toolCallId: string\n                  result: unknown\n                }\n                const existingInvocation = toolInvocations.find(\n                  (t) => t.toolCallId === toolResult.toolCallId\n                )\n                if (existingInvocation) {\n                  existingInvocation.result = toolResult.result\n                  onToolCall(existingInvocation)\n                }\n                break\n\n              case 'd': // Finish message\n                // Stream complete\n                break\n\n              case 'e': // Error\n                const error = JSON.parse(dataStr)\n                throw new Error(error.message || 'Stream error')\n\n              default:\n                // Unknown type, skip\n                break\n            }\n          } catch (parseError) {\n            console.warn('[chat] Failed to parse stream data:', line)\n          }\n        }\n      }\n\n      // Stream complete\n      onDone({\n        session_id: resolvedSessionId,\n        reply: fullContent,\n        toolInvocations: toolInvocations.length > 0 ? toolInvocations : undefined,\n      })\n    })\n    .catch((err) => {\n      if (err.name !== 'AbortError') {\n        onError(err)\n      }\n    })\n\n  return () => controller.abort()\n}\n\n// Smart stream function that picks the right implementation\nexport function streamChat(\n  message: string,\n  sessionId: string | undefined,\n  options: {\n    command?: string\n    onChunk: (chunk: string) => void\n    onToolCall?: (toolInvocation: ToolInvocation) => void\n    onDone: (fullResponse: SendChatResponse) => void\n    onError: (error: Error) => void\n  }\n): () => void {\n  if (USE_NEW_RUNTIME) {\n    return streamChatMessageNew(\n      message,\n      sessionId,\n      options.command,\n      options.onChunk,\n      options.onToolCall || (() => {}),\n      options.onDone,\n      options.onError\n    )\n  } else {\n    return streamChatMessage(\n      message,\n      sessionId,\n      options.onChunk,\n      options.onDone,\n      options.onError\n    )\n  }\n}\n","numLines":701,"startLine":1,"totalLines":701}}}
{"parentUuid":"ec923dbe-f649-4637-8bd7-892e5ba7219c","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013raW9SvRshLmkUGb2JijWs","type":"tool_result","content":"     1→{\n     2→  \"name\": \"web-app\",\n     3→  \"version\": \"0.1.0\",\n     4→  \"private\": true,\n     5→  \"scripts\": {\n     6→    \"dev\": \"next dev\",\n     7→    \"build\": \"next build\",\n     8→    \"start\": \"next start\",\n     9→    \"lint\": \"eslint\",\n    10→    \"test:e2e\": \"playwright test\",\n    11→    \"test:e2e:ui\": \"playwright test --ui\",\n    12→    \"test:e2e:headed\": \"playwright test --headed\"\n    13→  },\n    14→  \"dependencies\": {\n    15→    \"ai\": \"^4.0.0\",\n    16→    \"@ai-sdk/openai\": \"^1.0.0\",\n    17→    \"zod\": \"^3.23.0\",\n    18→    \"@radix-ui/react-dialog\": \"^1.1.15\",\n    19→    \"@radix-ui/react-popover\": \"^1.1.15\",\n    20→    \"@radix-ui/react-scroll-area\": \"^1.2.10\",\n    21→    \"@radix-ui/react-separator\": \"^1.1.8\",\n    22→    \"@radix-ui/react-slot\": \"^1.2.4\",\n    23→    \"@radix-ui/react-tabs\": \"^1.1.13\",\n    24→    \"@radix-ui/react-toggle\": \"^1.1.10\",\n    25→    \"@radix-ui/react-tooltip\": \"^1.2.8\",\n    26→    \"class-variance-authority\": \"^0.7.1\",\n    27→    \"clsx\": \"^2.1.1\",\n    28→    \"framer-motion\": \"^12.23.26\",\n    29→    \"lucide-react\": \"^0.562.0\",\n    30→    \"next\": \"16.1.1\",\n    31→    \"react\": \"19.2.3\",\n    32→    \"react-dom\": \"19.2.3\",\n    33→    \"tailwind-merge\": \"^3.4.0\",\n    34→    \"tailwindcss-animate\": \"^1.0.7\",\n    35→    \"react-markdown\": \"^10.1.0\",\n    36→    \"zustand\": \"^5.0.9\"\n    37→  },\n    38→  \"devDependencies\": {\n    39→    \"@playwright/test\": \"^1.57.0\",\n    40→    \"@tailwindcss/postcss\": \"^4\",\n    41→    \"@types/node\": \"^20\",\n    42→    \"@types/react\": \"^19\",\n    43→    \"@types/react-dom\": \"^19\",\n    44→    \"eslint\": \"^9\",\n    45→    \"eslint-config-next\": \"16.1.1\",\n    46→    \"tailwindcss\": \"^4\",\n    47→    \"typescript\": \"^5\"\n    48→  }\n    49→}\n    50→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"801cdaec-9c81-4a04-8f3c-0b0c685e7667","timestamp":"2026-01-01T15:29:29.881Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/web-app/package.json","content":"{\n  \"name\": \"web-app\",\n  \"version\": \"0.1.0\",\n  \"private\": true,\n  \"scripts\": {\n    \"dev\": \"next dev\",\n    \"build\": \"next build\",\n    \"start\": \"next start\",\n    \"lint\": \"eslint\",\n    \"test:e2e\": \"playwright test\",\n    \"test:e2e:ui\": \"playwright test --ui\",\n    \"test:e2e:headed\": \"playwright test --headed\"\n  },\n  \"dependencies\": {\n    \"ai\": \"^4.0.0\",\n    \"@ai-sdk/openai\": \"^1.0.0\",\n    \"zod\": \"^3.23.0\",\n    \"@radix-ui/react-dialog\": \"^1.1.15\",\n    \"@radix-ui/react-popover\": \"^1.1.15\",\n    \"@radix-ui/react-scroll-area\": \"^1.2.10\",\n    \"@radix-ui/react-separator\": \"^1.1.8\",\n    \"@radix-ui/react-slot\": \"^1.2.4\",\n    \"@radix-ui/react-tabs\": \"^1.1.13\",\n    \"@radix-ui/react-toggle\": \"^1.1.10\",\n    \"@radix-ui/react-tooltip\": \"^1.2.8\",\n    \"class-variance-authority\": \"^0.7.1\",\n    \"clsx\": \"^2.1.1\",\n    \"framer-motion\": \"^12.23.26\",\n    \"lucide-react\": \"^0.562.0\",\n    \"next\": \"16.1.1\",\n    \"react\": \"19.2.3\",\n    \"react-dom\": \"19.2.3\",\n    \"tailwind-merge\": \"^3.4.0\",\n    \"tailwindcss-animate\": \"^1.0.7\",\n    \"react-markdown\": \"^10.1.0\",\n    \"zustand\": \"^5.0.9\"\n  },\n  \"devDependencies\": {\n    \"@playwright/test\": \"^1.57.0\",\n    \"@tailwindcss/postcss\": \"^4\",\n    \"@types/node\": \"^20\",\n    \"@types/react\": \"^19\",\n    \"@types/react-dom\": \"^19\",\n    \"eslint\": \"^9\",\n    \"eslint-config-next\": \"16.1.1\",\n    \"tailwindcss\": \"^4\",\n    \"typescript\": \"^5\"\n  }\n}\n","numLines":50,"startLine":1,"totalLines":50}}}
{"parentUuid":"801cdaec-9c81-4a04-8f3c-0b0c685e7667","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01G8uCWnUp4oStYaZFhfFJ1s","type":"tool_result","content":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md","is_error":false}]},"uuid":"3930c090-dd64-4fe5-96f5-2ddbf5e86a69","timestamp":"2026-01-01T15:29:30.046Z","toolUseResult":{"stdout":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"3930c090-dd64-4fe5-96f5-2ddbf5e86a69","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018LfRT21zedJGvkDD1VY6ie","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me read the backend refactoring plan:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":9131,"cache_read_input_tokens":20998,"cache_creation":{"ephemeral_5m_input_tokens":9131,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWgtwGsxhcso3GKx5dDtk","type":"assistant","uuid":"486064e7-1beb-4348-a08a-b003d5067d16","timestamp":"2026-01-01T15:29:32.257Z"}
{"parentUuid":"486064e7-1beb-4348-a08a-b003d5067d16","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_018LfRT21zedJGvkDD1VY6ie","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01SKWbcTLhkt2v4perSrnEbU","name":"Read","input":{"file_path":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":7,"cache_creation_input_tokens":9131,"cache_read_input_tokens":20998,"cache_creation":{"ephemeral_5m_input_tokens":9131,"ephemeral_1h_input_tokens":0},"output_tokens":93,"service_tier":"standard"}},"requestId":"req_011CWgtwGsxhcso3GKx5dDtk","type":"assistant","uuid":"b2188c36-5c47-45e1-98b7-5101359d4a07","timestamp":"2026-01-01T15:29:32.539Z"}
{"parentUuid":"b2188c36-5c47-45e1-98b7-5101359d4a07","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01SKWbcTLhkt2v4perSrnEbU","type":"tool_result","content":"     1→# Fortune AI 后端重构计划 (v4.2 Vercel AI SDK Edition)\n     2→\n     3→**文档类型**: Backend Refactoring Plan\n     4→**版本**: v4.2\n     5→**日期**: 2026-01-01\n     6→**目标**: 将后端架构从 Python-centric 迁移到 Vercel AI SDK Driven 架构\n     7→\n     8→---\n     9→\n    10→## 0. 执行摘要\n    11→\n    12→### 0.1 重构目标\n    13→\n    14→将 Fortune AI 后端从当前的 **Python FastAPI 全栈架构** 重构为 **Vercel AI SDK Driven 分层架构**：\n    15→\n    16→| 当前状态 | 目标状态 |\n    17→|----------|----------|\n    18→| FastAPI 承载 AI 推理 + 数据服务 | Next.js API Route 承载 AI 推理 |\n    19→| `glm_client.py` 直接调用 LLM | `streamText()` + Multi-Model Provider |\n    20→| 自定义 SSE 格式 | `toDataStreamResponse()` 标准流 |\n    21→| Python L2 Agents | TypeScript `tool()` Skills |\n    22→| agent_service 辅助角色 | Agent Runtime 核心角色 |\n    23→\n    24→### 0.2 核心收益\n    25→\n    26→1. **端到端流式渲染**: `useChat()` → `streamText()` → `toDataStreamResponse()`\n    27→2. **多模型热切换**: GLM-4.5 / Gemini / Claude 通过 Vercel AI Gateway 动态切换\n    28→3. **Skills 可插拔**: Tool Calling 标准化，新增 Expert Agent 只需添加 `tool()` 定义\n    29→4. **maxSteps 多步推理**: 单次请求可多次 Tool 调用后综合输出\n    30→5. **类型安全**: Zod Schema 参数验证\n    31→\n    32→### 0.3 风险评估\n    33→\n    34→| 风险 | 等级 | 缓解措施 |\n    35→|------|:----:|----------|\n    36→| API 兼容性破坏 | 🔴 高 | 双路由并行期，逐步迁移 |\n    37→| 前端 CSRF 问题 | 🟡 中 | Next.js API Route 同源，无跨域 |\n    38→| 数据服务调用延迟 | 🟡 中 | Tool execute 批量聚合，缓存热点数据 |\n    39→| 团队 TypeScript 熟练度 | 🟢 低 | 现有 agent_service 已有 TS 基础 |\n    40→| maxSteps 重复写入 | 🔴 高 | 幂等性设计 + finalize 机制 |\n    41→| 流式中断数据不一致 | 🔴 高 | 流式与事务解耦，finalize 统一提交 |\n    42→\n    43→### 0.4 目标后端形态（三运行单元）\n    44→\n    45→重构后的后端拆分为 **3 个可独立演进的运行单元**：\n    46→\n    47→```\n    48→┌─────────────────────────────────────────────────────────────────────────────┐\n    49→│                         目标架构 (v4.2)                                       │\n    50→└─────────────────────────────────────────────────────────────────────────────┘\n    51→\n    52→Browser\n    53→    │\n    54→    │ HTTP\n    55→    ▼\n    56→┌─────────────────────────────────────────────────────────────────────────────┐\n    57→│  Reverse Proxy (Nginx/Caddy :80/:443)                                        │\n    58→│  ┌─────────────────────────────────────────────────────────────────────────┐│\n    59→│  │  路由规则:                                                               ││\n    60→│  │  /api/chat          → Next.js (:8231)  # Agent Runtime                  ││\n    61→│  │  /api/landing/*     → Next.js (:8231)  # Landing Page API               ││\n    62→│  │  /api/*             → FastAPI (:8230)  # Data Service                   ││\n    63→│  │  /new/*             → Next.js (:8231)  # Frontend                       ││\n    64→│  │  /admin/*           → Next.js (:8231)  # Admin System                   ││\n    65→│  └─────────────────────────────────────────────────────────────────────────┘│\n    66→└─────────────────────────────────────────────────────────────────────────────┘\n    67→        │                           │                           │\n    68→        ▼                           ▼                           ▼\n    69→┌───────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐\n    70→│ Next.js Agent     │  │ FastAPI Data Service    │  │ Python Cold Path Worker │\n    71→│ Runtime (:8231)   │  │ (:8230)                 │  │ (Cron/Queue)            │\n    72→├───────────────────┤  ├─────────────────────────┤  ├─────────────────────────┤\n    73→│ • streamText()    │  │ • Auth/Session          │  │ • Insight Agent         │\n    74→│ • tool() Skills   │  │ • 领域写入 (SSOT)       │  │ • Memory 沉淀           │\n    75→│ • useChat() 流式  │  │ • 确定性计算            │  │ • 异步报告生成          │\n    76→│ • Multi-Model Hub │  │ • Internal APIs         │  │ • 数据清洗              │\n    77→└───────────────────┘  └─────────────────────────┘  └─────────────────────────┘\n    78→        │                           │                           │\n    79→        │     fetch() / gRPC        │                           │\n    80→        └───────────────────────────┴───────────────────────────┘\n    81→                                    │\n    82→                                    ▼\n    83→                          PostgreSQL (fortune_ai)\n    84→```\n    85→\n    86→| 运行单元 | 职责 | 技术栈 | 部署 |\n    87→|----------|------|--------|------|\n    88→| **Agent Runtime** | AI 推理、流式响应、Tool Calling | Next.js + Vercel AI SDK | 可独立扩缩 |\n    89→| **Data Service** | Auth、SSOT 写入、确定性计算 | FastAPI + PostgreSQL | 有状态，单实例优先 |\n    90→| **Cold Path Worker** | 后台分析、Memory 沉淀 | Python + Celery/Cron | 异步，失败不阻塞 |\n    91→\n    92→### 0.5 信任边界与安全原则\n    93→\n    94→```\n    95→┌─────────────────────────────────────────────────────────────────────────────┐\n    96→│                         信任边界 (Trust Boundary)                            │\n    97→└─────────────────────────────────────────────────────────────────────────────┘\n    98→\n    99→                  ┌─────────────────────────────────────────┐\n   100→                  │            Untrusted Zone               │\n   101→                  │                                         │\n   102→                  │   Browser / Mobile App / Third Party    │\n   103→                  │                                         │\n   104→                  │   ⚠️ 永远不能信任来自这里的:             │\n   105→                  │      • userId                           │\n   106→                  │      • role / permissions               │\n   107→                  │      • 任何敏感标识                      │\n   108→                  └───────────────────┬─────────────────────┘\n   109→                                      │\n   110→                    Cookie (fortune_session) + HTTPS Only\n   111→                                      │\n   112→                                      ▼\n   113→                  ┌─────────────────────────────────────────┐\n   114→                  │            Trusted Zone                 │\n   115→                  │                                         │\n   116→                  │   Next.js API Route / FastAPI           │\n   117→                  │                                         │\n   118→                  │   ✅ userId 只能从 Session 解出          │\n   119→                  │   ✅ session_id 可由前端传但必须校验归属 │\n   120→                  │   ✅ Internal API 需 service token       │\n   121→                  └─────────────────────────────────────────┘\n   122→```\n   123→\n   124→**关键规则**：\n   125→\n   126→1. **userId 不传**: 前端请求体永远不包含 `userId`，由服务端从 Cookie Session 解出\n   127→2. **session_id 校验**: 如前端传 `session_id`，后端必须校验该 session 归属当前用户\n   128→3. **Internal API 隔离**: `/internal/*` 端点不暴露给浏览器，需 service token 或 IP 白名单\n   129→\n   130→### 0.6 工程化原则（决定重构成败）\n   131→\n   132→#### 0.6.1 流式与事务解耦\n   133→\n   134→```\n   135→┌─────────────────────────────────────────────────────────────────────────────┐\n   136→│                    Chat Run Lifecycle (流式生命周期)                          │\n   137→└─────────────────────────────────────────────────────────────────────────────┘\n   138→\n   139→用户消息 ──▶ run/start ──▶ streamText() ──▶ Tool调用(N次) ──▶ run/finalize\n   140→   │            │              │                │                  │\n   141→   │            │              │                │                  │\n   142→   ▼            ▼              ▼                ▼                  ▼\n   143→┌────────┐ ┌─────────┐   ┌──────────┐    ┌───────────┐      ┌─────────────┐\n   144→│用户消息│ │ run_id  │   │ 流式输出 │    │ 工具结果  │      │ 统一提交    │\n   145→│ 入库  │ │ 记录    │   │ (不落库) │    │ (内存暂存)│      │ 事务写入    │\n   146→└────────┘ └─────────┘   └──────────┘    └───────────┘      └─────────────┘\n   147→\n   148→                                                                   │\n   149→                                                                   ▼\n   150→                                                          ┌─────────────────┐\n   151→                                                          │ 一次事务包含:   │\n   152→                                                          │ • assistant msg │\n   153→                                                          │ • commitments   │\n   154→                                                          │ • tool_log      │\n   155→                                                          │ • twin updates  │\n   156→                                                          └─────────────────┘\n   157→```\n   158→\n   159→**规则**：\n   160→- 流式过程中只做\"可重放\"记录（run_id、用户消息）\n   161→- Tool 执行结果暂存内存，不直接写 DB\n   162→- `finalize` 时统一事务提交\n   163→- 中断则标记 `aborted`，避免半条消息进 SSOT\n   164→\n   165→#### 0.6.2 全链路 correlation_id\n   166→\n   167→```typescript\n   168→// Next.js API Route 入口生成\n   169→export async function POST(req: Request) {\n   170→  const correlationId = req.headers.get('x-correlation-id')\n   171→    || `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n   172→\n   173→  // 透传到 FastAPI\n   174→  const context = await fetch(`${FASTAPI_URL}/internal/context`, {\n   175→    headers: { 'X-Correlation-ID': correlationId },\n   176→  });\n   177→\n   178→  // 透传到 Tool 执行\n   179→  const result = streamText({\n   180→    // ...\n   181→    onStepFinish({ toolCalls }) {\n   182→      logger.info({ correlationId, toolCalls }, 'Step finished');\n   183→    },\n   184→  });\n   185→}\n   186→```\n   187→\n   188→**用途**：串联\"对话 → Tool 调用 → 写入 → 失败原因\"，便于 debug 和审计。\n   189→\n   190→#### 0.6.3 统一错误语义\n   191→\n   192→```typescript\n   193→// Public API 响应格式\n   194→interface ApiResponse<T> {\n   195→  ok: boolean;\n   196→  data?: T;\n   197→  error?: {\n   198→    code: string;        // 'AUTH_REQUIRED' | 'RATE_LIMITED' | 'TOOL_FAILED' | ...\n   199→    message: string;     // 用户可读消息\n   200→    detail?: unknown;    // 调试信息（仅 dev 环境）\n   201→    correlation_id?: string;\n   202→  };\n   203→}\n   204→\n   205→// Tool 执行失败返回（可渲染为 Toast 或 ErrorCard）\n   206→interface ToolError {\n   207→  type: 'tool_error';\n   208→  tool_name: string;\n   209→  error_code: string;\n   210→  user_message: string;  // \"八字计算服务暂时不可用\"\n   211→}\n   212→```\n   213→\n   214→---\n   215→\n   216→## 1. 现状分析\n   217→\n   218→### 1.1 当前架构\n   219→\n   220→```\n   221→┌─────────────────────────────────────────────────────────────────────────────┐\n   222→│                         当前架构 (v4.0/v4.1)                                  │\n   223→└─────────────────────────────────────────────────────────────────────────────┘\n   224→\n   225→Browser (:8231/new)\n   226→    │\n   227→    │ HTTP (fetch + SSE)\n   228→    ▼\n   229→┌──────────────────────────────────────────────────────────────────────────┐\n   230→│  FastAPI (:8230)                                                          │\n   231→│  ┌────────────────────────────────────────────────────────────────────┐  │\n   232→│  │  19 Route Files                                                     │  │\n   233→│  │  auth_routes / chat_routes / dashboard_routes / bazi_routes ...    │  │\n   234→│  └────────────────────────────────────────────────────────────────────┘  │\n   235→│                              │                                            │\n   236→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   237→│  │  Services Layer           ▼                                        │  │\n   238→│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │  │\n   239→│  │  │glm_client.py│ │bazi_engine  │ │twin_service │ │goal_service │  │  │\n   240→│  │  │ (LLM 调用)  │ │  (L0 计算) │ │ (状态管理) │ │ (目标管理) │  │  │\n   241→│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │  │\n   242→│  └───────────────────────────────────────────────────────────────────┘  │\n   243→│                              │                                            │\n   244→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   245→│  │  Agent Service Client     │ (HTTP 调用 TypeScript Agent)          │  │\n   246→│  └───────────────────────────┼───────────────────────────────────────┘  │\n   247→└──────────────────────────────┼───────────────────────────────────────────┘\n   248→                               │\n   249→                               ▼\n   250→┌──────────────────────────────────────────────────────────────────────────┐\n   251→│  Agent Service (:3000) - Express + Vercel AI SDK                          │\n   252→│  ┌─────────────────────────────────────────────────────────────────────┐ │\n   253→│  │  coach.ts: runCoachAgent() - 但仅作为辅助，主流量仍走 Python         │ │\n   254→│  └─────────────────────────────────────────────────────────────────────┘ │\n   255→└──────────────────────────────────────────────────────────────────────────┘\n   256→                               │\n   257→                               ▼\n   258→                        PostgreSQL (fortune_ai)\n   259→```\n   260→\n   261→### 1.2 现有文件清单\n   262→\n   263→**API Routes (19 个)**:\n   264→```\n   265→api/\n   266→├── auth_routes.py        # 认证 (register/login/logout)\n   267→├── chat_routes.py        # 对话 (send/stream) ⚠️ 核心重构对象\n   268→├── dashboard_routes.py   # Dashboard Zone B\n   269→├── bazi_routes.py        # 八字计算\n   270→├── bento_routes.py       # Bento 6 卡片 (legacy)\n   271→├── twin_routes.py        # 数字孪生\n   272→├── goal_routes.py        # 目标管理\n   273→├── reflection_routes.py  # 复盘\n   274→├── report_routes.py      # 深度报告\n   275→├── poster_routes.py      # 海报生成\n   276→├── yunshi_routes.py      # 运势\n   277→├── plan_routes.py        # 计划\n   278→├── kb_routes.py          # 知识库\n   279→├── session_routes.py     # 会话管理\n   280→├── user_routes.py        # 用户资料\n   281→├── social_routes.py      # 社交\n   282→├── push_routes.py        # 推送\n   283→├── currency_routes.py    # 货币\n   284→├── jitai_routes.py       # 吉台\n   285→├── agent_tool.py         # Agent 工具 API\n   286→├── deps.py               # 依赖注入\n   287→└── main.py               # 入口\n   288→```\n   289→\n   290→**Services (核心)**:\n   291→```\n   292→services/\n   293→├── glm_client.py          # ⚠️ 待删除：直接 LLM 调用\n   294→├── chat_service.py        # 会话消息管理\n   295→├── bazi_engine.py         # L0 八字计算 ✅ 保留\n   296→├── bazi_facts.py          # 事实提取 ✅ 保留\n   297→├── twin_service.py        # 数字孪生 ✅ 保留\n   298→├── goal_service.py        # 目标管理 ✅ 保留\n   299→├── reflection_service.py  # 复盘 ✅ 保留\n   300→├── soul_os.py             # 上下文组装 ⚠️ 重构\n   301→├── agent_service_client.py # ⚠️ 待删除：改为 Next.js 内部调用\n   302→└── ...\n   303→```\n   304→\n   305→### 1.3 关键痛点\n   306→\n   307→| 痛点 | 影响 | 根因 |\n   308→|------|------|------|\n   309→| 双语言交互复杂 | 维护成本高 | Python/TS 边界不清晰 |\n   310→| 流式渲染非标准 | 前端适配困难 | 自定义 SSE 格式 |\n   311→| LLM 调用分散 | 难以统一管理 | glm_client + agent_service 并存 |\n   312→| Tool Calling 手动 | 扩展困难 | 无标准化 Skills 框架 |\n   313→| A2UI 非流式 | 首字延迟高 | JSON 整体返回 |\n   314→\n   315→---\n   316→\n   317→## 2. 目标架构\n   318→\n   319→### 2.1 架构图\n   320→\n   321→```\n   322→┌─────────────────────────────────────────────────────────────────────────────┐\n   323→│                         目标架构 (v4.2 Vercel AI SDK)                         │\n   324→└─────────────────────────────────────────────────────────────────────────────┘\n   325→\n   326→Browser\n   327→    │\n   328→    │ useChat() Hook\n   329→    ▼\n   330→┌──────────────────────────────────────────────────────────────────────────┐\n   331→│  Next.js (:8231)                                                          │\n   332→│  ┌────────────────────────────────────────────────────────────────────┐  │\n   333→│  │  app/api/chat/route.ts   ← Agent Runtime (核心)                     │  │\n   334→│  │  ┌──────────────────────────────────────────────────────────────┐ │  │\n   335→│  │  │  streamText({                                                 │ │  │\n   336→│  │  │    model: selectModel(),     // GLM / Gemini / Claude         │ │  │\n   337→│  │  │    system: buildSystemPrompt(context),                        │ │  │\n   338→│  │  │    tools: getToolsForMode(mode),                              │ │  │\n   339→│  │  │    maxSteps: 5,                                               │ │  │\n   340→│  │  │  }) → toDataStreamResponse()                                  │ │  │\n   341→│  │  └──────────────────────────────────────────────────────────────┘ │  │\n   342→│  └────────────────────────────────────────────────────────────────────┘  │\n   343→│                              │                                            │\n   344→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   345→│  │  Skills Registry          ▼                                        │  │\n   346→│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │  │\n   347→│  │  │Divine Skills│ │ Heal Skills │ │ Grow Skills │                  │  │\n   348→│  │  │calculate_   │ │log_perma    │ │covey_matrix │                  │  │\n   349→│  │  │  bazi/ziwei │ │cbt_reframe  │ │goal_setting │                  │  │\n   350→│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                  │  │\n   351→│  └─────────┼───────────────┼───────────────┼─────────────────────────┘  │\n   352→└────────────┼───────────────┼───────────────┼────────────────────────────┘\n   353→             │               │               │\n   354→             │ fetch()       │ fetch()       │ fetch()\n   355→             ▼               ▼               ▼\n   356→┌──────────────────────────────────────────────────────────────────────────┐\n   357→│  FastAPI (:8230) - 纯数据服务层                                            │\n   358→│  ┌────────────────────────────────────────────────────────────────────┐  │\n   359→│  │  Data Service APIs (无 LLM 调用)                                    │  │\n   360→│  │  /api/bazi/calculate     /api/perma/log      /api/goals/create     │  │\n   361→│  │  /api/user/context       /api/twin/update    /api/tasks/create     │  │\n   362→│  │  /api/landing/insight    /api/kb/search      /api/checkin/mood     │  │\n   363→│  └────────────────────────────────────────────────────────────────────┘  │\n   364→│                              │                                            │\n   365→│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n   366→│  │  Services Layer (保留)    │                                        │  │\n   367→│  │  bazi_engine / twin_service / goal_service / reflection_service   │  │\n   368→│  └───────────────────────────────────────────────────────────────────┘  │\n   369→└──────────────────────────────────────────────────────────────────────────┘\n   370→                               │\n   371→                               ▼\n   372→                        PostgreSQL (fortune_ai)\n   373→```\n   374→\n   375→### 2.2 职责边界\n   376→\n   377→| 层级 | 运行环境 | 职责 | 技术栈 |\n   378→|------|----------|------|--------|\n   379→| **Frontend** | Browser | UI 渲染、流式展示、Command 输入 | React + `useChat()` |\n   380→| **Agent Runtime** | Next.js API Route | AI 推理、Tool Calling、流式输出 | `streamText()` + `tool()` |\n   381→| **Skills Registry** | Next.js | 可插拔技能定义 | Zod Schema + execute |\n   382→| **Data Service** | FastAPI | L0/L1 数据 CRUD、计算逻辑 | Python + PostgreSQL |\n   383→| **Insight Agent** | Cron Worker | Cold Path 数据沉淀 | Python |\n   384→\n   385→### 2.3 API 端点规划\n   386→\n   387→**Next.js API Routes (新增)**:\n   388→```typescript\n   389→// Agent Runtime\n   390→POST /api/chat           // streamText() 主入口\n   391→POST /api/command        // /divine /heal /grow 指令路由\n   392→\n   393→// Landing Page (可选迁移)\n   394→POST /api/landing/insight  // 即时洞察 (无需登录)\n   395→```\n   396→\n   397→**FastAPI Data Service (重构)**:\n   398→```python\n   399→# L0 Base Data\n   400→GET  /api/user/context        # 聚合用户上下文\n   401→GET  /api/user/profile        # 用户资料\n   402→PUT  /api/user/profile        # 更新资料\n   403→\n   404→# L1 Module Data - Divine\n   405→POST /api/bazi/calculate      # 八字计算\n   406→POST /api/ziwei/calculate     # 紫微计算\n   407→GET  /api/bazi/facts/{user_id}  # 获取事实\n   408→\n   409→# L1 Module Data - Heal\n   410→POST /api/perma/log           # PERMA 记录\n   411→GET  /api/perma/query         # PERMA 查询\n   412→POST /api/checkin/mood        # 情绪打卡\n   413→\n   414→# L1 Module Data - Grow\n   415→POST /api/goals/create        # 创建目标\n   416→GET  /api/goals/active        # 活跃目标\n   417→POST /api/tasks/create        # 创建任务\n   418→PUT  /api/tasks/{id}/complete # 完成任务\n   419→\n   420→# Twin\n   421→GET  /api/twin/{user_id}      # 获取孪生数据\n   422→PUT  /api/twin/update         # 更新孪生\n   423→\n   424→# KB\n   425→POST /api/kb/search           # 知识库检索\n   426→\n   427→# 保留 (暂不迁移)\n   428→/api/auth/*                   # 认证\n   429→/api/report/*                 # 深度报告\n   430→/api/poster/*                 # 海报\n   431→/api/dashboard/*              # Dashboard\n   432→```\n   433→\n   434→### 2.4 Internal Contract APIs（内部契约）\n   435→\n   436→为 Agent Runtime 与 FastAPI 之间的通信定义两个核心契约，比继续复用 `chat_routes.py` 更干净：\n   437→\n   438→#### 2.4.1 Context API（上下文聚合）\n   439→\n   440→```python\n   441→# FastAPI: api/internal_routes.py\n   442→# 只对内部调用开放，需 X-Service-Token 或 IP 白名单\n   443→\n   444→@router.get(\"/internal/context\")\n   445→async def get_context(\n   446→    session_id: str = Query(None),\n   447→    user: AuthUser = Depends(get_current_user_from_cookie),\n   448→    x_correlation_id: str = Header(None),\n   449→) -> ContextResponse:\n   450→    \"\"\"\n   451→    一次性聚合用户上下文，减少 Agent Runtime 的 fetch 次数\n   452→    \"\"\"\n   453→    return ContextResponse(\n   454→        l0=UserProfile(\n   455→            user_id=user.id,\n   456→            display_name=user.name,\n   457→            birth_info=get_birth_info(user.id),\n   458→            preferences=get_preferences(user.id),\n   459→        ),\n   460→        l1=ModuleData(\n   461→            bazi_chart=get_latest_bazi(user.id),\n   462→            perma_recent=get_perma_summary(user.id, days=7),\n   463→            active_goals=get_active_goals(user.id, limit=3),\n   464→            twin_status=get_twin_status(user.id),\n   465→        ),\n   466→        policy_flags=PolicyFlags(\n   467→            allow_roast=user.preferences.get('allow_roast', False),\n   468→            model_override=user.preferences.get('model'),\n   469→        ),\n   470→        history_excerpt=get_recent_messages(user.id, limit=10),\n   471→    )\n   472→```\n   473→\n   474→**Response Schema**:\n   475→```typescript\n   476→interface ContextResponse {\n   477→  l0: {\n   478→    user_id: string;\n   479→    display_name: string;\n   480→    birth_info: { year: number; month: number; day: number; hour?: number };\n   481→    preferences: Record<string, unknown>;\n   482→  };\n   483→  l1: {\n   484→    bazi_chart?: BaziChart;\n   485→    perma_recent?: PermaScore[];\n   486→    active_goals?: Goal[];\n   487→    twin_status?: TwinStatus;\n   488→  };\n   489→  policy_flags: {\n   490→    allow_roast: boolean;\n   491→    model_override?: 'glm' | 'gemini' | 'claude';\n   492→  };\n   493→  history_excerpt: Message[];\n   494→}\n   495→```\n   496→\n   497→#### 2.4.2 Chat Persistence API（流式持久化）\n   498→\n   499→```python\n   500→# FastAPI: api/internal_routes.py\n   501→\n   502→@router.post(\"/internal/chat/run/start\")\n   503→async def start_chat_run(\n   504→    request: StartRunRequest,\n   505→    user: AuthUser = Depends(get_current_user_from_cookie),\n   506→) -> StartRunResponse:\n   507→    \"\"\"\n   508→    流式开始时调用：记录 run_id + 用户消息\n   509→    \"\"\"\n   510→    run_id = str(uuid4())\n   511→\n   512→    # 只写入用户消息（assistant 消息在 finalize 写入）\n   513→    await db.execute(\"\"\"\n   514→        INSERT INTO chat_runs (id, user_id, session_id, status, started_at)\n   515→        VALUES ($1, $2, $3, 'running', NOW())\n   516→    \"\"\", run_id, user.id, request.session_id)\n   517→\n   518→    await db.execute(\"\"\"\n   519→        INSERT INTO chat_messages (run_id, role, content, created_at)\n   520→        VALUES ($1, 'user', $2, NOW())\n   521→    \"\"\", run_id, request.user_message)\n   522→\n   523→    return StartRunResponse(run_id=run_id)\n   524→\n   525→@router.post(\"/internal/chat/run/finalize\")\n   526→async def finalize_chat_run(\n   527→    request: FinalizeRunRequest,\n   528→    user: AuthUser = Depends(get_current_user_from_cookie),\n   529→) -> FinalizeRunResponse:\n   530→    \"\"\"\n   531→    流式结束时调用：一次事务写入所有副作用\n   532→    \"\"\"\n   533→    async with db.transaction():\n   534→        # 1. 更新 run 状态\n   535→        await db.execute(\"\"\"\n   536→            UPDATE chat_runs\n   537→            SET status = $2, finished_at = NOW()\n   538→            WHERE id = $1\n   539→        \"\"\", request.run_id, 'completed' if request.success else 'aborted')\n   540→\n   541→        # 2. 写入 assistant 消息\n   542→        if request.assistant_message:\n   543→            await db.execute(\"\"\"\n   544→                INSERT INTO chat_messages (run_id, role, content, created_at)\n   545→                VALUES ($1, 'assistant', $2, NOW())\n   546→            \"\"\", request.run_id, request.assistant_message)\n   547→\n   548→        # 3. 写入 tool 调用日志\n   549→        for tool_log in request.tool_logs:\n   550→            await db.execute(\"\"\"\n   551→                INSERT INTO tool_invocations\n   552→                (run_id, tool_name, input, output, latency_ms, idempotency_key)\n   553→                VALUES ($1, $2, $3, $4, $5, $6)\n   554→                ON CONFLICT (idempotency_key) DO NOTHING\n   555→            \"\"\", request.run_id, tool_log.name, tool_log.input,\n   556→                tool_log.output, tool_log.latency_ms, tool_log.idempotency_key)\n   557→\n   558→        # 4. 写入 commitments（承诺/任务）\n   559→        for commitment in request.commitments:\n   560→            await create_commitment(user.id, commitment)\n   561→\n   562→        # 5. 更新 twin 状态\n   563→        if request.twin_updates:\n   564→            await update_twin(user.id, request.twin_updates)\n   565→\n   566→    return FinalizeRunResponse(ok=True)\n   567→```\n   568→\n   569→**Request/Response Schema**:\n   570→```typescript\n   571→interface StartRunRequest {\n   572→  session_id?: string;\n   573→  user_message: string;\n   574→  correlation_id: string;\n   575→}\n   576→\n   577→interface FinalizeRunRequest {\n   578→  run_id: string;\n   579→  success: boolean;\n   580→  assistant_message?: string;\n   581→  tool_logs: ToolLog[];\n   582→  commitments: Commitment[];\n   583→  twin_updates?: TwinUpdate;\n   584→}\n   585→\n   586→interface ToolLog {\n   587→  name: string;\n   588→  input: Record<string, unknown>;\n   589→  output: Record<string, unknown>;\n   590→  latency_ms: number;\n   591→  idempotency_key: string;  // 用于防止 maxSteps 重复写入\n   592→}\n   593→```\n   594→\n   595→### 2.5 A2UI 迁移方案（ToolResultCard）\n   596→\n   597→将 A2UI 从\"整段 JSON 作为 assistant content\"迁移为\"ToolResultCard + 教练表达\"模式：\n   598→\n   599→#### 2.5.1 现状 vs 目标\n   600→\n   601→```\n   602→【现状】A2UI 作为 assistant message content\n   603→┌─────────────────────────────────────────────────────────────────┐\n   604→│ { role: 'assistant',                                            │\n   605→│   content: '{\"type\":\"a2ui\",\"cards\":[{\"type\":\"bazi_chart\",...}]}'│\n   606→│ }                                                               │\n   607→└─────────────────────────────────────────────────────────────────┘\n   608→\n   609→【目标】ToolResultCard + assistant content 分离\n   610→┌─────────────────────────────────────────────────────────────────┐\n   611→│ {                                                               │\n   612→│   role: 'assistant',                                            │\n   613→│   content: '根据你的八字，你是一个...',  // 教练表达           │\n   614→│   toolInvocations: [                                            │\n   615→│     {                                                           │\n   616→│       toolName: 'calculate_bazi',                               │\n   617→│       state: 'result',                                          │\n   618→│       result: {                                                 │\n   619→│         type: 'a2ui_card',                                      │\n   620→│         card_type: 'bazi_chart',                                │\n   621→│         data: { ... }                                           │\n   622→│       }                                                         │\n   623→│     }                                                           │\n   624→│   ]                                                             │\n   625→│ }                                                               │\n   626→└─────────────────────────────────────────────────────────────────┘\n   627→```\n   628→\n   629→#### 2.5.2 ToolResultCard Schema\n   630→\n   631→```typescript\n   632→// lib/types/a2ui-card.ts\n   633→\n   634→interface ToolResultCard {\n   635→  type: 'a2ui_card';\n   636→  card_type: CardType;\n   637→  data: CardData;\n   638→  actions?: CardAction[];\n   639→}\n   640→\n   641→type CardType =\n   642→  | 'bazi_chart'      // 八字命盘\n   643→  | 'perma_radar'     // PERMA 雷达图\n   644→  | 'goal_progress'   // 目标进度\n   645→  | 'commitment_card' // 承诺卡片\n   646→  | 'insight_card'    // 洞察卡片\n   647→  | 'kline_chart'     // K线图\n   648→  | 'error_toast';    // 错误提示\n   649→\n   650→interface CardAction {\n   651→  type: 'accept' | 'done' | 'skip' | 'navigate' | 'share';\n   652→  label: string;\n   653→  endpoint?: string;   // 仅映射到 SSOT 状态机跃迁端点\n   654→  payload?: Record<string, unknown>;\n   655→}\n   656→\n   657→// 前端渲染\n   658→function ToolResultRenderer({ toolInvocation }) {\n   659→  if (toolInvocation.result?.type === 'a2ui_card') {\n   660→    const { card_type, data, actions } = toolInvocation.result;\n   661→    switch (card_type) {\n   662→      case 'bazi_chart':\n   663→        return <BaziChartCard data={data} actions={actions} />;\n   664→      case 'commitment_card':\n   665→        return <CommitmentCard data={data} actions={actions} />;\n   666→      // ...\n   667→    }\n   668→  }\n   669→  return null;\n   670→}\n   671→```\n   672→\n   673→#### 2.5.3 ActionButton 约束\n   674→\n   675→**关键规则**：ActionButton 的 `type` 只能映射到以下 SSOT 状态机跃迁端点，不允许组件私自定义写操作：\n   676→\n   677→| action.type | 映射端点 | 说明 |\n   678→|-------------|----------|------|\n   679→| `accept` | `POST /api/dashboard/task/accept` | 接受任务 |\n   680→| `done` | `POST /api/dashboard/task/done` | 完成任务 |\n   681→| `skip` | `POST /api/dashboard/task/skip` | 跳过任务 |\n   682→| `checkin` | `POST /api/dashboard/checkin` | 情绪打卡 |\n   683→| `navigate` | 前端路由 | 页面跳转（无写操作） |\n   684→| `share` | `POST /api/social/share` | 分享卡片 |\n   685→\n   686→### 2.6 幂等性设计\n   687→\n   688→防止 `maxSteps` 多步推理下的重复写入：\n   689→\n   690→#### 2.6.1 idempotency_key 策略\n   691→\n   692→```typescript\n   693→// lib/skills/divine-skills.ts\n   694→\n   695→export const calculateBazi = tool({\n   696→  description: '计算用户的八字命盘',\n   697→  parameters: z.object({\n   698→    birth_datetime: z.string(),\n   699→    timezone: z.string().default('Asia/Shanghai'),\n   700→  }),\n   701→  execute: async ({ birth_datetime, timezone }, { runId, stepIndex }) => {\n   702→    // 生成幂等键：run_id + step_index + tool_name + params_hash\n   703→    const idempotencyKey = `${runId}:${stepIndex}:calculate_bazi:${hash({ birth_datetime, timezone })}`;\n   704→\n   705→    const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n   706→      method: 'POST',\n   707→      headers: {\n   708→        'Content-Type': 'application/json',\n   709→        'X-Idempotency-Key': idempotencyKey,\n   710→      },\n   711→      body: JSON.stringify({ birth_datetime, timezone }),\n   712→    });\n   713→\n   714→    return res.json();\n   715→  },\n   716→});\n   717→```\n   718→\n   719→#### 2.6.2 FastAPI 幂等性处理\n   720→\n   721→```python\n   722→# api/middleware/idempotency.py\n   723→\n   724→@app.middleware(\"http\")\n   725→async def idempotency_middleware(request: Request, call_next):\n   726→    idempotency_key = request.headers.get(\"X-Idempotency-Key\")\n   727→\n   728→    if idempotency_key and request.method in (\"POST\", \"PUT\"):\n   729→        # 检查是否已执行\n   730→        cached = await redis.get(f\"idempotency:{idempotency_key}\")\n   731→        if cached:\n   732→            return JSONResponse(content=json.loads(cached))\n   733→\n   734→        response = await call_next(request)\n   735→\n   736→        # 缓存结果（TTL 24h）\n   737→        if response.status_code == 200:\n   738→            body = await response.body()\n   739→            await redis.setex(f\"idempotency:{idempotency_key}\", 86400, body)\n   740→\n   741→        return response\n   742→\n   743→    return await call_next(request)\n   744→```\n   745→\n   746→#### 2.6.3 自然唯一键\n   747→\n   748→对于某些业务写入，使用自然唯一键替代显式 idempotency_key：\n   749→\n   750→```sql\n   751→-- 承诺表：同一用户同一天同一描述只能有一条\n   752→CREATE UNIQUE INDEX uq_commitments_natural\n   753→ON commitments (user_id, date_trunc('day', created_at), description_hash)\n   754→WHERE status = 'active';\n   755→\n   756→-- PERMA 记录：同一用户同一小时只能有一条\n   757→CREATE UNIQUE INDEX uq_perma_hourly\n   758→ON perma_logs (user_id, date_trunc('hour', logged_at));\n   759→```\n   760→\n   761→---\n   762→\n   763→## 3. 重构阶段\n   764→\n   765→### Phase 1: 基础设施准备 (Week 1)\n   766→\n   767→**目标**: 建立 Next.js Agent Runtime 基础框架 + 双后端路由共存\n   768→\n   769→#### 1.0 反向代理路由配置（关键前置）\n   770→\n   771→配置 Nginx/Caddy 实现 Next.js 和 FastAPI 的路由共存：\n   772→\n   773→```nginx\n   774→# /etc/nginx/sites-available/fortune-ai\n   775→\n   776→upstream nextjs {\n   777→    server 127.0.0.1:8231;\n   778→}\n   779→\n   780→upstream fastapi {\n   781→    server 127.0.0.1:8230;\n   782→}\n   783→\n   784→server {\n   785→    listen 80;\n   786→    server_name fortune-ai.example.com;\n   787→\n   788→    # Agent Runtime (Next.js)\n   789→    location /api/chat {\n   790→        proxy_pass http://nextjs;\n   791→        proxy_http_version 1.1;\n   792→        proxy_set_header Upgrade $http_upgrade;\n   793→        proxy_set_header Connection 'upgrade';\n   794→        proxy_set_header Host $host;\n   795→        proxy_set_header X-Real-IP $remote_addr;\n   796→        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n   797→        proxy_buffering off;  # 流式响应必须\n   798→        proxy_read_timeout 300s;\n   799→    }\n   800→\n   801→    # Landing Page API (Next.js)\n   802→    location /api/landing/ {\n   803→        proxy_pass http://nextjs;\n   804→        proxy_set_header Host $host;\n   805→        # IP 级限流\n   806→        limit_req zone=landing_limit burst=5 nodelay;\n   807→    }\n   808→\n   809→    # Internal APIs (仅内部访问)\n   810→    location /internal/ {\n   811→        # 只允许内网访问\n   812→        allow 127.0.0.1;\n   813→        allow 10.0.0.0/8;\n   814→        deny all;\n   815→        proxy_pass http://fastapi;\n   816→        proxy_set_header Host $host;\n   817→    }\n   818→\n   819→    # Data Service APIs (FastAPI)\n   820→    location /api/ {\n   821→        proxy_pass http://fastapi;\n   822→        proxy_set_header Host $host;\n   823→        proxy_set_header X-Real-IP $remote_addr;\n   824→        proxy_set_header Cookie $http_cookie;\n   825→    }\n   826→\n   827→    # Frontend (Next.js)\n   828→    location /new/ {\n   829→        proxy_pass http://nextjs;\n   830→        proxy_set_header Host $host;\n   831→    }\n   832→\n   833→    # Admin System (Next.js)\n   834→    location /admin/ {\n   835→        proxy_pass http://nextjs;\n   836→        proxy_set_header Host $host;\n   837→    }\n   838→\n   839→    # Landing Page (Next.js)\n   840→    location / {\n   841→        proxy_pass http://nextjs;\n   842→        proxy_set_header Host $host;\n   843→    }\n   844→}\n   845→\n   846→# IP 限流配置\n   847→limit_req_zone $binary_remote_addr zone=landing_limit:10m rate=10r/m;\n   848→```\n   849→\n   850→**路由优先级**（顺序很重要）：\n   851→1. `/api/chat` → Next.js（Agent Runtime）\n   852→2. `/api/landing/*` → Next.js（Landing Page API）\n   853→3. `/internal/*` → FastAPI（内部 API，限内网）\n   854→4. `/api/*` → FastAPI（Data Service）\n   855→5. `/new/*` → Next.js（Frontend）\n   856→6. `/admin/*` → Next.js（Admin）\n   857→7. `/` → Next.js（Landing Page）\n   858→\n   859→#### 1.1 Next.js API Route 结构\n   860→\n   861→```bash\n   862→web-app/src/app/api/\n   863→├── chat/\n   864→│   └── route.ts              # 主 Agent Runtime\n   865→├── command/\n   866→│   └── route.ts              # 指令路由\n   867→└── landing/\n   868→    └── insight/\n   869→        └── route.ts          # Landing Page 洞察\n   870→```\n   871→\n   872→#### 1.2 Skills Registry 框架\n   873→\n   874→```bash\n   875→web-app/src/lib/\n   876→├── skills/\n   877→│   ├── index.ts              # Skills 统一导出\n   878→│   ├── divine-skills.ts      # 玄学技能\n   879→│   ├── heal-skills.ts        # 疗愈技能\n   880→│   └── grow-skills.ts        # 成长技能\n   881→├── models/\n   882→│   └── model-provider.ts     # Multi-Model 配置\n   883→└── context/\n   884→    └── context-builder.ts    # System Prompt 构建\n   885→```\n   886→\n   887→#### 1.3 配置 Multi-Model Provider\n   888→\n   889→```typescript\n   890→// lib/models/model-provider.ts\n   891→import { createGoogleGenerativeAI } from '@ai-sdk/google';\n   892→import { createAnthropic } from '@ai-sdk/anthropic';\n   893→\n   894→const google = createGoogleGenerativeAI({\n   895→  apiKey: process.env.GOOGLE_API_KEY,\n   896→});\n   897→\n   898→const anthropic = createAnthropic({\n   899→  apiKey: process.env.ANTHROPIC_API_KEY,\n   900→});\n   901→\n   902→// Vercel AI Gateway for GLM-4.5\n   903→const glm = createGoogleGenerativeAI({\n   904→  baseURL: 'https://gateway.ai.cloudflare.com/v1/...',\n   905→  apiKey: process.env.GLM_API_KEY,\n   906→});\n   907→\n   908→export function selectModel(preference?: string) {\n   909→  switch (preference) {\n   910→    case 'gemini': return google('gemini-2.0-flash-exp');\n   911→    case 'claude': return anthropic('claude-3-5-sonnet-20241022');\n   912→    case 'glm':\n   913→    default: return glm('glm-4.5');\n   914→  }\n   915→}\n   916→```\n   917→\n   918→#### 1.4 交付物\n   919→\n   920→- [ ] **Nginx/Caddy 双后端路由配置**（关键前置）\n   921→- [ ] FastAPI `/internal/*` 端点隔离（IP 白名单）\n   922→- [ ] Next.js `/api/chat/route.ts` 基础框架\n   923→- [ ] Skills Registry 目录结构\n   924→- [ ] Multi-Model Provider 配置\n   925→- [ ] 环境变量配置 (`.env.local`)\n   926→\n   927→---\n   928→\n   929→### Phase 2: Agent Runtime 迁移 (Week 2)\n   930→\n   931→**目标**: 将 AI 推理逻辑从 Python 迁移到 Next.js\n   932→\n   933→#### 2.1 实现 `/api/chat/route.ts`（含 Run Lifecycle）\n   934→\n   935→```typescript\n   936→// app/api/chat/route.ts\n   937→import { streamText } from 'ai';\n   938→import { cookies } from 'next/headers';\n   939→import { selectModel } from '@/lib/models/model-provider';\n   940→import { allSkills } from '@/lib/skills';\n   941→import { buildSystemPrompt } from '@/lib/context/context-builder';\n   942→\n   943→const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n   944→\n   945→// 请求体：不包含 userId（从 Cookie Session 解出）\n   946→interface ChatRequest {\n   947→  session_id?: string;   // 可选，用于会话续接\n   948→  message: string;       // 用户消息\n   949→  command?: string;      // /divine | /heal | /grow（来自 CommandPalette）\n   950→}\n   951→\n   952→export async function POST(req: Request) {\n   953→  const cookieStore = await cookies();\n   954→  const sessionCookie = cookieStore.get('fortune_session')?.value;\n   955→\n   956→  if (!sessionCookie) {\n   957→    return Response.json({ ok: false, error: { code: 'AUTH_REQUIRED' } }, { status: 401 });\n   958→  }\n   959→\n   960→  const { session_id, message, command }: ChatRequest = await req.json();\n   961→\n   962→  // 生成 correlation_id\n   963→  const correlationId = `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n   964→\n   965→  // 1. 调用 Internal Context API（Cookie 透传，userId 由 FastAPI 解出）\n   966→  const contextRes = await fetch(`${FASTAPI_URL}/internal/context`, {\n   967→    headers: {\n   968→      'Cookie': `fortune_session=${sessionCookie}`,\n   969→      'X-Correlation-ID': correlationId,\n   970→    },\n   971→  });\n   972→\n   973→  if (!contextRes.ok) {\n   974→    return Response.json({ ok: false, error: { code: 'CONTEXT_FETCH_FAILED' } }, { status: 500 });\n   975→  }\n   976→\n   977→  const context = await contextRes.json();\n   978→\n   979→  // 2. 调用 run/start（记录 run_id + 用户消息）\n   980→  const startRes = await fetch(`${FASTAPI_URL}/internal/chat/run/start`, {\n   981→    method: 'POST',\n   982→    headers: {\n   983→      'Content-Type': 'application/json',\n   984→      'Cookie': `fortune_session=${sessionCookie}`,\n   985→      'X-Correlation-ID': correlationId,\n   986→    },\n   987→    body: JSON.stringify({\n   988→      session_id,\n   989→      user_message: message,\n   990→      correlation_id: correlationId,\n   991→    }),\n   992→  });\n   993→\n   994→  const { run_id } = await startRes.json();\n   995→\n   996→  // 3. 根据 Command 筛选 Tools\n   997→  const tools = command\n   998→    ? getToolsForCommand(command)  // /divine → divineSkills only\n   999→    : allSkills;                   // Chat Mode: all tools\n  1000→\n  1001→  // 4. 暂存 Tool 调用记录（用于 finalize）\n  1002→  const toolLogs: ToolLog[] = [];\n  1003→  const commitments: Commitment[] = [];\n  1004→\n  1005→  // 5. streamText 流式推理\n  1006→  const result = streamText({\n  1007→    model: selectModel(context.policy_flags?.model_override),\n  1008→    system: buildSystemPrompt(context),\n  1009→    messages: [\n  1010→      ...context.history_excerpt,\n  1011→      { role: 'user', content: message },\n  1012→    ],\n  1013→    tools,\n  1014→    maxSteps: 5,\n  1015→\n  1016→    // 每步完成回调：记录 Tool 调用\n  1017→    onStepFinish({ stepType, toolCalls, toolResults }) {\n  1018→      if (stepType === 'tool-result' && toolCalls) {\n  1019→        for (let i = 0; i < toolCalls.length; i++) {\n  1020→          const call = toolCalls[i];\n  1021→          const result = toolResults?.[i];\n  1022→          toolLogs.push({\n  1023→            name: call.toolName,\n  1024→            input: call.args,\n  1025→            output: result,\n  1026→            latency_ms: 0, // TODO: 实际计时\n  1027→            idempotency_key: `${run_id}:${toolLogs.length}:${call.toolName}`,\n  1028→          });\n  1029→\n  1030→          // 收集 commitments\n  1031→          if (result?.commitments) {\n  1032→            commitments.push(...result.commitments);\n  1033→          }\n  1034→        }\n  1035→      }\n  1036→    },\n  1037→\n  1038→    // 流式完成回调：调用 finalize\n  1039→    async onFinish({ text, finishReason }) {\n  1040→      await fetch(`${FASTAPI_URL}/internal/chat/run/finalize`, {\n  1041→        method: 'POST',\n  1042→        headers: {\n  1043→          'Content-Type': 'application/json',\n  1044→          'Cookie': `fortune_session=${sessionCookie}`,\n  1045→          'X-Correlation-ID': correlationId,\n  1046→        },\n  1047→        body: JSON.stringify({\n  1048→          run_id,\n  1049→          success: finishReason !== 'error',\n  1050→          assistant_message: text,\n  1051→          tool_logs: toolLogs,\n  1052→          commitments,\n  1053→        }),\n  1054→      });\n  1055→    },\n  1056→  });\n  1057→\n  1058→  return result.toDataStreamResponse();\n  1059→}\n  1060→```\n  1061→\n  1062→**关键变化**：\n  1063→- 请求体只包含 `{ session_id?, message, command? }`，**不传 userId**\n  1064→- userId 从 Cookie Session 由 FastAPI 解出\n  1065→- 流式开始时调用 `run/start`，结束时调用 `run/finalize`\n  1066→- Tool 调用记录暂存内存，`finalize` 时统一写入\n  1067→\n  1068→#### 2.2 System Prompt 迁移\n  1069→\n  1070→将 `chat_routes.py:SYSTEM_PROMPT_TEMPLATE` 迁移到 TypeScript：\n  1071→\n  1072→```typescript\n  1073→// lib/context/context-builder.ts\n  1074→export function buildSystemPrompt(context: UserContext): string {\n  1075→  return `你是 Fortune AI 的对话 Agent，角色是积极心理学教练。\n  1076→\n  1077→【硬性规则】\n  1078→1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接\"你可以做什么\"的行动处方。\n  1079→2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。\n  1080→3) 每次输出必须包含：结论 + 依据 + ≤3条处方 + 承诺邀请。\n  1081→4) 每条处方必须包含 if_then：如果____→那么____。\n  1082→5) 必须给出可点击 actions。\n  1083→\n  1084→【用户上下文】\n  1085→persona_style: ${context.persona_style}\n  1086→facts: ${JSON.stringify(context.facts)}\n  1087→evidence: ${JSON.stringify(context.evidence)}\n  1088→active_goals: ${JSON.stringify(context.active_goals)}\n  1089→`;\n  1090→}\n  1091→```\n  1092→\n  1093→#### 2.3 双路由并行期\n  1094→\n  1095→**保留 Python `/api/chat/send`**，新增 Next.js `/api/chat`：\n  1096→\n  1097→```python\n  1098→# api/chat_routes.py - 添加 header 检测\n  1099→@router.post(\"/send\")\n  1100→async def chat_send(request: Request, body: ChatSendRequest, auth = Depends(require_auth)):\n  1101→    # 检查是否使用新架构\n  1102→    use_new_runtime = request.headers.get(\"X-Use-New-Runtime\") == \"true\"\n  1103→    if use_new_runtime:\n  1104→        # 转发到 Next.js\n  1105→        return RedirectResponse(url=\"/api/chat\", status_code=307)\n  1106→    # 原有逻辑...\n  1107→```\n  1108→\n  1109→#### 2.4 交付物\n  1110→\n  1111→- [ ] `/api/chat/route.ts` 完整实现\n  1112→- [ ] `buildSystemPrompt()` 迁移\n  1113→- [ ] 双路由并行配置\n  1114→- [ ] 前端 `useChat()` 集成测试\n  1115→\n  1116→---\n  1117→\n  1118→### Phase 3: Skills 实现 (Week 3)\n  1119→\n  1120→**目标**: 将 L2 Expert Agents 重构为 Vercel Tools\n  1121→\n  1122→#### 3.1 Divine Skills\n  1123→\n  1124→```typescript\n  1125→// lib/skills/divine-skills.ts\n  1126→import { tool } from 'ai';\n  1127→import { z } from 'zod';\n  1128→\n  1129→const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n  1130→\n  1131→export const divineSkills = {\n  1132→  calculate_bazi: tool({\n  1133→    description: '计算用户的八字命盘，返回四柱、五行、十神、神煞、大运等信息',\n  1134→    parameters: z.object({\n  1135→      birth_datetime: z.string().describe('出生日期时间 (ISO 8601)'),\n  1136→      timezone: z.string().default('Asia/Shanghai'),\n  1137→      include_dayun: z.boolean().default(true),\n  1138→    }),\n  1139→    execute: async ({ birth_datetime, timezone, include_dayun }) => {\n  1140→      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n  1141→        method: 'POST',\n  1142→        headers: { 'Content-Type': 'application/json' },\n  1143→        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),\n  1144→      });\n  1145→      if (!res.ok) throw new Error(`Bazi calculation failed: ${res.status}`);\n  1146→      return res.json();\n  1147→    },\n  1148→  }),\n  1149→\n  1150→  get_bazi_facts: tool({\n  1151→    description: '获取用户已计算的八字事实数据',\n  1152→    parameters: z.object({\n  1153→      user_id: z.number(),\n  1154→    }),\n  1155→    execute: async ({ user_id }) => {\n  1156→      const res = await fetch(`${FASTAPI_URL}/api/bazi/facts/${user_id}`);\n  1157→      return res.json();\n  1158→    },\n  1159→  }),\n  1160→\n  1161→  search_bazi_kb: tool({\n  1162→    description: '搜索八字知识库，获取相关命理解读',\n  1163→    parameters: z.object({\n  1164→      query: z.string().describe('搜索关键词'),\n  1165→      limit: z.number().default(3),\n  1166→    }),\n  1167→    execute: async ({ query, limit }) => {\n  1168→      const res = await fetch(`${FASTAPI_URL}/api/kb/search`, {\n  1169→        method: 'POST',\n  1170→        body: JSON.stringify({ query, limit, category: 'bazi' }),\n  1171→      });\n  1172→      return res.json();\n  1173→    },\n  1174→  }),\n  1175→};\n  1176→```\n  1177→\n  1178→#### 3.2 Heal Skills\n  1179→\n  1180→```typescript\n  1181→// lib/skills/heal-skills.ts\n  1182→export const healSkills = {\n  1183→  log_perma: tool({\n  1184→    description: '记录用户的 PERMA 五维心理状态分数',\n  1185→    parameters: z.object({\n  1186→      dimension: z.enum(['P', 'E', 'R', 'M', 'A']),\n  1187→      score: z.number().min(0).max(10),\n  1188→      note: z.string().optional(),\n  1189→    }),\n  1190→    execute: async ({ dimension, score, note }, { userId }) => {\n  1191→      const res = await fetch(`${FASTAPI_URL}/api/perma/log`, {\n  1192→        method: 'POST',\n  1193→        body: JSON.stringify({ user_id: userId, dimension, score, note }),\n  1194→      });\n  1195→      return res.json();\n  1196→    },\n  1197→  }),\n  1198→\n  1199→  mood_checkin: tool({\n  1200→    description: '快速情绪打卡',\n  1201→    parameters: z.object({\n  1202→      mood_score: z.number().min(1).max(10),\n  1203→      tags: z.array(z.string()).optional(),\n  1204→      note: z.string().optional(),\n  1205→    }),\n  1206→    execute: async (params, { userId }) => {\n  1207→      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {\n  1208→        method: 'POST',\n  1209→        body: JSON.stringify({ user_id: userId, ...params }),\n  1210→      });\n  1211→      return res.json();\n  1212→    },\n  1213→  }),\n  1214→\n  1215→  cbt_reframe: tool({\n  1216→    description: '使用 CBT ABC 模型进行认知重构',\n  1217→    parameters: z.object({\n  1218→      activating_event: z.string().describe('触发事件 (A)'),\n  1219→      belief: z.string().optional().describe('信念/想法 (B)'),\n  1220→      consequence: z.string().optional().describe('情绪/行为后果 (C)'),\n  1221→    }),\n  1222→    execute: async (params) => {\n  1223→      // CBT 引导框架，返回结构化提示让 LLM 继续引导\n  1224→      return {\n  1225→        framework: 'ABC',\n  1226→        current_state: params,\n  1227→        next_step: params.belief ? 'identify_distortion' : 'explore_belief',\n  1228→        guidance_prompt: params.belief\n  1229→          ? `用户的信念是\"${params.belief}\"，请帮助识别可能的认知扭曲...`\n  1230→          : `请引导用户探索触发事件背后的信念和想法...`,\n  1231→      };\n  1232→    },\n  1233→  }),\n  1234→};\n  1235→```\n  1236→\n  1237→#### 3.3 Grow Skills\n  1238→\n  1239→```typescript\n  1240→// lib/skills/grow-skills.ts\n  1241→export const growSkills = {\n  1242→  create_commitment: tool({\n  1243→    description: '创建行动承诺任务',\n  1244→    parameters: z.object({\n  1245→      content: z.string().describe('任务内容'),\n  1246→      category: z.enum(['energy_boost', 'reflection', 'practice', 'social', 'general']),\n  1247→      estimated_minutes: z.number().default(5),\n  1248→      if_then: z.string().optional().describe('If-Then 触发条件'),\n  1249→    }),\n  1250→    execute: async (params, { userId }) => {\n  1251→      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {\n  1252→        method: 'POST',\n  1253→        body: JSON.stringify({ user_id: userId, ...params }),\n  1254→      });\n  1255→      return res.json();\n  1256→    },\n  1257→  }),\n  1258→\n  1259→  goal_setting: tool({\n  1260→    description: '使用 WOOP 模型设定目标',\n  1261→    parameters: z.object({\n  1262→      wish: z.string().describe('愿望/目标'),\n  1263→      outcome: z.string().optional(),\n  1264→      obstacle: z.string().optional(),\n  1265→      plan: z.string().optional(),\n  1266→    }),\n  1267→    execute: async (params, { userId }) => {\n  1268→      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {\n  1269→        method: 'POST',\n  1270→        body: JSON.stringify({ user_id: userId, ...params }),\n  1271→      });\n  1272→      return res.json();\n  1273→    },\n  1274→  }),\n  1275→\n  1276→  update_twin: tool({\n  1277→    description: '更新用户数字孪生数据',\n  1278→    parameters: z.object({\n  1279→      layer: z.enum(['L1', 'L2', 'L3']),\n  1280→      path: z.string().describe('JSON 路径'),\n  1281→      value: z.any(),\n  1282→    }),\n  1283→    execute: async (params, { userId }) => {\n  1284→      const res = await fetch(`${FASTAPI_URL}/api/twin/update`, {\n  1285→        method: 'PUT',\n  1286→        body: JSON.stringify({ user_id: userId, ...params }),\n  1287→      });\n  1288→      return res.json();\n  1289→    },\n  1290→  }),\n  1291→};\n  1292→```\n  1293→\n  1294→#### 3.4 Skills Registry 统一导出\n  1295→\n  1296→```typescript\n  1297→// lib/skills/index.ts\n  1298→import { divineSkills } from './divine-skills';\n  1299→import { healSkills } from './heal-skills';\n  1300→import { growSkills } from './grow-skills';\n  1301→\n  1302→export const allSkills = {\n  1303→  ...divineSkills,\n  1304→  ...healSkills,\n  1305→  ...growSkills,\n  1306→};\n  1307→\n  1308→export function getToolsForCommand(command: string) {\n  1309→  switch (command) {\n  1310→    case '/divine': return divineSkills;\n  1311→    case '/heal': return healSkills;\n  1312→    case '/grow': return growSkills;\n  1313→    default: return allSkills;\n  1314→  }\n  1315→}\n  1316→\n  1317→export { divineSkills, healSkills, growSkills };\n  1318→```\n  1319→\n  1320→#### 3.5 交付物\n  1321→\n  1322→- [ ] `divine-skills.ts` 完整实现\n  1323→- [ ] `heal-skills.ts` 完整实现\n  1324→- [ ] `grow-skills.ts` 完整实现\n  1325→- [ ] Skills Registry 单元测试\n  1326→\n  1327→---\n  1328→\n  1329→### Phase 4: FastAPI 数据服务重构 (Week 4)\n  1330→\n  1331→**目标**: 将 FastAPI 精简为纯数据服务层\n  1332→\n  1333→#### 4.1 新增数据服务 API\n  1334→\n  1335→```python\n  1336→# api/data_routes.py (新文件)\n  1337→from fastapi import APIRouter, Depends\n  1338→from api.deps import require_auth\n  1339→\n  1340→router = APIRouter(prefix=\"/api\", tags=[\"data\"])\n  1341→\n  1342→@router.get(\"/user/context\")\n  1343→async def get_user_context(user_id: int, auth = Depends(require_auth)):\n  1344→    \"\"\"聚合用户上下文，供 Agent Runtime 调用\"\"\"\n  1345→    # 聚合 profile + preferences + facts + active_goals + recent_messages\n  1346→    profile = await _get_profile(user_id)\n  1347→    prefs = await _get_preferences(user_id)\n  1348→    facts = await _get_bazi_facts(user_id)\n  1349→    goals = await _get_active_goals(user_id)\n  1350→    messages = await _get_recent_messages(user_id, limit=10)\n  1351→\n  1352→    return {\n  1353→        \"ok\": True,\n  1354→        \"data\": {\n  1355→            \"profile\": profile,\n  1356→            \"persona_style\": prefs.get(\"persona_style\", \"warm\"),\n  1357→            \"facts\": facts,\n  1358→            \"evidence\": {\n  1359→                \"facts_hash\": facts.get(\"facts_hash\"),\n  1360→                \"kb_refs\": [],  # 后续填充\n  1361→            },\n  1362→            \"active_goals\": goals,\n  1363→            \"recent_messages\": messages,\n  1364→        }\n  1365→    }\n  1366→\n  1367→@router.post(\"/bazi/calculate\")\n  1368→async def calculate_bazi(body: BaziCalculateRequest):\n  1369→    \"\"\"八字计算 (无需登录，供 Landing Page 使用)\"\"\"\n  1370→    from services.bazi_engine import calculate_bazi\n  1371→    result = calculate_bazi(\n  1372→        body.birth_datetime,\n  1373→        body.timezone,\n  1374→        body.include_dayun,\n  1375→    )\n  1376→    return {\"ok\": True, \"data\": result}\n  1377→\n  1378→@router.post(\"/perma/log\")\n  1379→async def log_perma(body: PermaLogRequest, auth = Depends(require_auth)):\n  1380→    \"\"\"PERMA 状态记录\"\"\"\n  1381→    from services.twin_service import update_perma_score\n  1382→    result = await update_perma_score(\n  1383→        auth.user_id,\n  1384→        body.dimension,\n  1385→        body.score,\n  1386→        body.note,\n  1387→    )\n  1388→    return {\"ok\": True, \"data\": result}\n  1389→\n  1390→@router.post(\"/tasks/create\")\n  1391→async def create_task(body: TaskCreateRequest, auth = Depends(require_auth)):\n  1392→    \"\"\"创建承诺任务\"\"\"\n  1393→    from services.bento_service import create_commitment\n  1394→    result = await create_commitment(\n  1395→        auth.user_id,\n  1396→        body.content,\n  1397→        body.category,\n  1398→        body.estimated_minutes,\n  1399→        body.if_then,\n  1400→    )\n  1401→    return {\"ok\": True, \"data\": result}\n  1402→\n  1403→@router.post(\"/goals/create\")\n  1404→async def create_goal(body: GoalCreateRequest, auth = Depends(require_auth)):\n  1405→    \"\"\"创建 WOOP 目标\"\"\"\n  1406→    from services.goal_service import create_goal\n  1407→    result = await create_goal(auth.user_id, body.dict())\n  1408→    return {\"ok\": True, \"data\": result}\n  1409→\n  1410→@router.put(\"/twin/update\")\n  1411→async def update_twin(body: TwinUpdateRequest, auth = Depends(require_auth)):\n  1412→    \"\"\"更新数字孪生\"\"\"\n  1413→    from services.twin_service import update_twin\n  1414→    result = await update_twin(auth.user_id, body.layer, body.path, body.value)\n  1415→    return {\"ok\": True, \"data\": result}\n  1416→\n  1417→@router.post(\"/kb/search\")\n  1418→async def search_kb(body: KBSearchRequest, auth = Depends(require_auth)):\n  1419→    \"\"\"知识库检索\"\"\"\n  1420→    from services.kb_service import search\n  1421→    result = await search(body.query, body.limit, body.category)\n  1422→    return {\"ok\": True, \"data\": result}\n  1423→```\n  1424→\n  1425→#### 4.2 Landing Page API\n  1426→\n  1427→```python\n  1428→# api/landing_routes.py (新文件)\n  1429→from fastapi import APIRouter\n  1430→\n  1431→router = APIRouter(prefix=\"/api/landing\", tags=[\"landing\"])\n  1432→\n  1433→ELEMENT_COLORS = {\n  1434→    \"wood\": [\"#4ade80\", \"#22c55e\"],\n  1435→    \"fire\": [\"#f87171\", \"#ef4444\"],\n  1436→    \"earth\": [\"#fbbf24\", \"#f59e0b\"],\n  1437→    \"metal\": [\"#f5f5f4\", \"#d6d3d1\"],\n  1438→    \"water\": [\"#60a5fa\", \"#3b82f6\"],\n  1439→}\n  1440→\n  1441→ELEMENT_INSIGHTS = {\n  1442→    \"wood\": {\n  1443→        \"en\": \"A strong Wood energy detected. You seek growth, but feel restricted.\",\n  1444→        \"cn\": \"检测到强木能量。你渴望生长，但感到受限。\",\n  1445→    },\n  1446→    \"fire\": {\n  1447→        \"en\": \"Fire burns bright within you. Passion drives you forward.\",\n  1448→        \"cn\": \"火焰在你心中燃烧。热情驱动你前进。\",\n  1449→    },\n  1450→    # ... 其他五行\n  1451→}\n  1452→\n  1453→@router.post(\"/insight\")\n  1454→async def instant_insight(body: InsightRequest):\n  1455→    \"\"\"即时洞察 (无需登录)\"\"\"\n  1456→    if body.input_type == \"bazi\":\n  1457→        # 快速计算日主五行\n  1458→        from services.bazi_engine import quick_day_master\n  1459→        element = quick_day_master(body.value)\n  1460→        insight = ELEMENT_INSIGHTS.get(element, ELEMENT_INSIGHTS[\"wood\"])\n  1461→        return {\n  1462→            \"ok\": True,\n  1463→            \"data\": {\n  1464→                \"type\": \"bazi\",\n  1465→                \"element\": element,\n  1466→                \"insight\": insight[\"en\"],\n  1467→                \"insight_cn\": insight[\"cn\"],\n  1468→                \"orb_colors\": ELEMENT_COLORS.get(element),\n  1469→                \"cta\": \"Unlock Full Analysis →\",\n  1470→            }\n  1471→        }\n  1472→    elif body.input_type == \"emotion\":\n  1473→        # 调用 LLM 生成简短情绪洞察\n  1474→        from services.glm_client import quick_emotion_insight\n  1475→        insight = await quick_emotion_insight(body.value)\n  1476→        return {\n  1477→            \"ok\": True,\n  1478→            \"data\": {\n  1479→                \"type\": \"emotion\",\n  1480→                \"insight\": insight,\n  1481→                \"orb_colors\": [\"#a78bfa\", \"#8b5cf6\"],  # 紫色\n  1482→                \"cta\": \"Start Your Journey →\",\n  1483→            }\n  1484→        }\n  1485→```\n  1486→\n  1487→#### 4.3 删除/废弃的代码\n  1488→\n  1489→```python\n  1490→# 待删除文件\n  1491→services/glm_client.py          # LLM 调用迁移到 TypeScript\n  1492→services/agent_service_client.py # 不再需要\n  1493→\n  1494→# 待废弃端点 (chat_routes.py)\n  1495→# POST /api/chat/send  → 迁移到 Next.js /api/chat\n  1496→# GET  /api/chat/stream → 迁移到 Next.js /api/chat\n  1497→```\n  1498→\n  1499→#### 4.4 交付物\n  1500→\n  1501→- [ ] `api/data_routes.py` 完整实现\n  1502→- [ ] `api/landing_routes.py` 完整实现\n  1503→- [ ] 旧 chat 端点废弃标记\n  1504→- [ ] API 文档更新\n  1505→\n  1506→---\n  1507→\n  1508→### Phase 5: 前端适配 (Week 5)\n  1509→\n  1510→**目标**: 前端切换到 `useChat()` Hook\n  1511→\n  1512→#### 5.1 useChat 集成\n  1513→\n  1514→```typescript\n  1515→// components/chat/chat-panel.tsx\n  1516→'use client';\n  1517→\n  1518→import { useChat } from 'ai/react';\n  1519→import { useState } from 'react';\n  1520→\n  1521→export function ChatPanel({ userId }: { userId: number }) {\n  1522→  const [command, setCommand] = useState<string | null>(null);\n  1523→\n  1524→  const { messages, input, setInput, handleSubmit, isLoading, error } = useChat({\n  1525→    api: '/api/chat',\n  1526→    body: { userId, command },\n  1527→    onFinish: (message) => {\n  1528→      setCommand(null);\n  1529→      // 处理 Tool 调用结果\n  1530→      if (message.toolInvocations?.length) {\n  1531→        refreshDashboard(message.toolInvocations);\n  1532→      }\n  1533→    },\n  1534→  });\n  1535→\n  1536→  const handleCommandSubmit = (cmd: string, text: string) => {\n  1537→    setCommand(cmd);\n  1538→    setInput(text);\n  1539→    // useChat 会自动提交\n  1540→  };\n  1541→\n  1542→  return (\n  1543→    <div className=\"flex flex-col h-full\">\n  1544→      {/* Messages */}\n  1545→      <div className=\"flex-1 overflow-y-auto\">\n  1546→        {messages.map((m) => (\n  1547→          <MessageBubble key={m.id} message={m} />\n  1548→        ))}\n  1549→      </div>\n  1550→\n  1551→      {/* Input */}\n  1552→      <ChatInput\n  1553→        value={input}\n  1554→        onChange={setInput}\n  1555→        onSubmit={handleSubmit}\n  1556→        onCommand={handleCommandSubmit}\n  1557→        isLoading={isLoading}\n  1558→      />\n  1559→    </div>\n  1560→  );\n  1561→}\n  1562→```\n  1563→\n  1564→#### 5.2 CommandPalette 集成\n  1565→\n  1566→```typescript\n  1567→// components/chat/command-palette.tsx\n  1568→const COMMANDS = [\n  1569→  { cmd: '/divine', label: '玄学测算', icon: '🔮' },\n  1570→  { cmd: '/heal', label: '心理疗愈', icon: '💚' },\n  1571→  { cmd: '/grow', label: '成长教练', icon: '🌱' },\n  1572→  { cmd: '/status', label: '状态查看', icon: '📊' },\n  1573→];\n  1574→\n  1575→export function CommandPalette({ onSelect, visible }: CommandPaletteProps) {\n  1576→  if (!visible) return null;\n  1577→\n  1578→  return (\n  1579→    <div className=\"absolute bottom-full left-0 w-full bg-background border rounded-lg shadow-lg p-2\">\n  1580→      {COMMANDS.map((c) => (\n  1581→        <button\n  1582→          key={c.cmd}\n  1583→          onClick={() => onSelect(c.cmd)}\n  1584→          className=\"flex items-center gap-2 w-full p-2 hover:bg-accent rounded\"\n  1585→        >\n  1586→          <span>{c.icon}</span>\n  1587→          <span className=\"font-medium\">{c.cmd}</span>\n  1588→          <span className=\"text-muted-foreground\">{c.label}</span>\n  1589→        </button>\n  1590→      ))}\n  1591→    </div>\n  1592→  );\n  1593→}\n  1594→```\n  1595→\n  1596→#### 5.3 Tool Result 渲染\n  1597→\n  1598→```typescript\n  1599→// components/chat/tool-result-card.tsx\n  1600→export function ToolResultCard({ invocation }: { invocation: ToolInvocation }) {\n  1601→  const { toolName, result, state } = invocation;\n  1602→\n  1603→  if (state === 'partial-call') {\n  1604→    return <LoadingCard toolName={toolName} />;\n  1605→  }\n  1606→\n  1607→  switch (toolName) {\n  1608→    case 'calculate_bazi':\n  1609→      return <BaziResultCard data={result} />;\n  1610→    case 'mood_checkin':\n  1611→      return <MoodCheckinCard data={result} />;\n  1612→    case 'create_commitment':\n  1613→      return <CommitmentCard data={result} />;\n  1614→    default:\n  1615→      return <GenericResultCard data={result} />;\n  1616→  }\n  1617→}\n  1618→```\n  1619→\n  1620→#### 5.4 交付物\n  1621→\n  1622→- [ ] `useChat()` 集成\n  1623→- [ ] `CommandPalette` 组件\n  1624→- [ ] `ToolResultCard` 组件\n  1625→- [ ] 端到端测试\n  1626→\n  1627→---\n  1628→\n  1629→### Phase 6: 清理与优化 (Week 6)\n  1630→\n  1631→**目标**: 删除旧代码，性能优化\n  1632→\n  1633→#### 6.1 删除列表\n  1634→\n  1635→```bash\n  1636→# 删除文件\n  1637→rm services/glm_client.py\n  1638→rm services/agent_service_client.py\n  1639→\n  1640→# 删除 agent_service 目录 (已迁移到 Next.js)\n  1641→rm -rf agent_service/\n  1642→\n  1643→# 清理 chat_routes.py 中的旧端点\n  1644→# - /api/chat/send\n  1645→# - /api/chat/stream\n  1646→```\n  1647→\n  1648→#### 6.2 API 路由清理\n  1649→\n  1650→```python\n  1651→# api/main.py - 更新路由注册\n  1652→app.include_router(auth_routes.router)\n  1653→app.include_router(data_routes.router)      # 新增\n  1654→app.include_router(landing_routes.router)   # 新增\n  1655→app.include_router(dashboard_routes.router)\n  1656→app.include_router(report_routes.router)\n  1657→# 删除: app.include_router(chat_routes.router)\n  1658→```\n  1659→\n  1660→#### 6.3 性能优化\n  1661→\n  1662→1. **Context 缓存**: 用户上下文 Redis 缓存 (TTL 5min)\n  1663→2. **批量 Tool 调用**: 合并多个 fetch 请求\n  1664→3. **流式首字优化**: 减少 System Prompt 长度\n  1665→\n  1666→#### 6.4 监控与日志\n  1667→\n  1668→```typescript\n  1669→// 添加 Tool 调用监控\n  1670→const result = streamText({\n  1671→  // ...\n  1672→  onStepFinish({ stepType, toolCalls, toolResults }) {\n  1673→    // 记录 Tool 调用耗时\n  1674→    logger.info('Step finished', {\n  1675→      stepType,\n  1676→      toolCount: toolCalls?.length,\n  1677→      latency: Date.now() - startTime,\n  1678→    });\n  1679→  },\n  1680→});\n  1681→```\n  1682→\n  1683→#### 6.5 交付物\n  1684→\n  1685→- [ ] 旧文件删除\n  1686→- [ ] API 路由更新\n  1687→- [ ] Redis 缓存配置\n  1688→- [ ] 监控 Dashboard\n  1689→\n  1690→---\n  1691→\n  1692→## 4. 风险与缓解\n  1693→\n  1694→### 4.1 兼容性风险\n  1695→\n  1696→| 风险点 | 影响范围 | 缓解措施 |\n  1697→|--------|----------|----------|\n  1698→| API 签名变更 | 前端所有 Chat 调用 | 双路由并行，Feature Flag 控制 |\n  1699→| A2UI 格式变化 | 消息渲染组件 | 保持 JSON 结构兼容，仅改传输方式 |\n  1700→| CSRF 处理 | 所有 POST 请求 | Next.js API Route 同源，无需 CSRF |\n  1701→| Cookie 传递 | 认证流程 | `credentials: 'include'` 配置 |\n  1702→\n  1703→### 4.2 回滚方案\n  1704→\n  1705→```typescript\n  1706→// Feature Flag 控制\n  1707→const USE_NEW_RUNTIME = process.env.USE_NEW_RUNTIME === 'true';\n  1708→\n  1709→// 前端路由选择\n  1710→const chatEndpoint = USE_NEW_RUNTIME ? '/api/chat' : '/api/chat/send';\n  1711→```\n  1712→\n  1713→### 4.3 灰度发布\n  1714→\n  1715→1. **Week 1-4**: 内部测试环境验证\n  1716→2. **Week 5**: 10% 用户灰度\n  1717→3. **Week 6**: 50% 用户灰度\n  1718→4. **Week 7**: 全量发布\n  1719→\n  1720→---\n  1721→\n  1722→## 5. 验收标准\n  1723→\n  1724→### 5.1 功能验收\n  1725→\n  1726→| 功能 | 验收标准 |\n  1727→|------|----------|\n  1728→| Chat 对话 | 流式输出正常，首字 < 500ms |\n  1729→| `/divine` 指令 | 八字计算正确，结果渲染正常 |\n  1730→| `/heal` 指令 | PERMA 记录成功，CBT 引导完整 |\n  1731→| `/grow` 指令 | 目标/任务创建成功 |\n  1732→| Landing Page | Insight 生成 < 1s，Orb 颜色正确 |\n  1733→| Tool Calling | 多步推理 (maxSteps=5) 正常 |\n  1734→\n  1735→### 5.2 性能验收\n  1736→\n  1737→| 指标 | 目标值 | 当前值 |\n  1738→|------|--------|--------|\n  1739→| 首字延迟 (P50) | < 500ms | ~800ms |\n  1740→| 首字延迟 (P95) | < 1.5s | ~2s |\n  1741→| Tool 调用延迟 | < 200ms | N/A |\n  1742→| 端到端响应 (P50) | < 3s | ~4s |\n  1743→\n  1744→### 5.3 代码质量\n  1745→\n  1746→- [ ] TypeScript 严格模式\n  1747→- [ ] Zod Schema 100% 覆盖\n  1748→- [ ] 单元测试覆盖率 > 80%\n  1749→- [ ] E2E 测试通过\n  1750→\n  1751→---\n  1752→\n  1753→## 6. 附录\n  1754→\n  1755→### 6.1 环境变量\n  1756→\n  1757→```bash\n  1758→# .env.local (Next.js)\n  1759→FASTAPI_URL=http://localhost:8230\n  1760→GOOGLE_API_KEY=xxx\n  1761→ANTHROPIC_API_KEY=xxx\n  1762→GLM_API_KEY=xxx\n  1763→USE_NEW_RUNTIME=true\n  1764→```\n  1765→\n  1766→### 6.2 依赖更新\n  1767→\n  1768→```json\n  1769→// package.json\n  1770→{\n  1771→  \"dependencies\": {\n  1772→    \"ai\": \"^4.0.0\",\n  1773→    \"@ai-sdk/google\": \"^1.0.0\",\n  1774→    \"@ai-sdk/anthropic\": \"^1.0.0\",\n  1775→    \"zod\": \"^3.22.0\"\n  1776→  }\n  1777→}\n  1778→```\n  1779→\n  1780→### 6.3 参考文档\n  1781→\n  1782→- [Vercel AI SDK 文档](https://sdk.vercel.ai/docs)\n  1783→- [os_design_v3.md §1.4-1.5](./os_design_v3.md)\n  1784→- [frontend_final_v3.md §2.6](./frontend_final_v3.md)\n  1785→- [system_design_final_mvp_v3.md §7.0.1](./system_design_final_mvp_v3.md)\n  1786→- [admin_v3.md](./admin_v3.md) - Admin System 设计，可与本重构并行开发\n  1787→\n  1788→### 6.4 并行开发项\n  1789→\n  1790→| 项目 | 描述 | 技术栈 | 依赖关系 |\n  1791→|------|------|--------|----------|\n  1792→| **Admin System** | 后台管理驾驶舱 | Next.js App Router + shadcn/ui + Monaco | Phase 1 完成后可启动 |\n  1793→| **Landing Page** | Digital Mirror 首页 | Next.js + React Three Fiber | 独立开发 |\n  1794→\n  1795→> **注**: Admin System 的 Agent Studio 模块依赖本重构中的 `admin_prompts` 表和 Prompt 热加载机制（Phase 4），建议在 Phase 4 完成后进行 Admin 前端开发。\n  1796→\n  1797→---\n  1798→\n  1799→*文档版本: v1.0*\n  1800→*创建日期: 2026-01-01*\n  1801→*作者: Claude (Anthropic)*\n  1802→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"uuid":"298030b4-eaa4-45f5-b65e-c7750cf910ef","timestamp":"2026-01-01T15:29:33.749Z","toolUseResult":{"type":"text","file":{"filePath":"/home/aiscend/work/fortune_ai/docs/core/backend_refactoring_plan_v42.md","content":"# Fortune AI 后端重构计划 (v4.2 Vercel AI SDK Edition)\n\n**文档类型**: Backend Refactoring Plan\n**版本**: v4.2\n**日期**: 2026-01-01\n**目标**: 将后端架构从 Python-centric 迁移到 Vercel AI SDK Driven 架构\n\n---\n\n## 0. 执行摘要\n\n### 0.1 重构目标\n\n将 Fortune AI 后端从当前的 **Python FastAPI 全栈架构** 重构为 **Vercel AI SDK Driven 分层架构**：\n\n| 当前状态 | 目标状态 |\n|----------|----------|\n| FastAPI 承载 AI 推理 + 数据服务 | Next.js API Route 承载 AI 推理 |\n| `glm_client.py` 直接调用 LLM | `streamText()` + Multi-Model Provider |\n| 自定义 SSE 格式 | `toDataStreamResponse()` 标准流 |\n| Python L2 Agents | TypeScript `tool()` Skills |\n| agent_service 辅助角色 | Agent Runtime 核心角色 |\n\n### 0.2 核心收益\n\n1. **端到端流式渲染**: `useChat()` → `streamText()` → `toDataStreamResponse()`\n2. **多模型热切换**: GLM-4.5 / Gemini / Claude 通过 Vercel AI Gateway 动态切换\n3. **Skills 可插拔**: Tool Calling 标准化，新增 Expert Agent 只需添加 `tool()` 定义\n4. **maxSteps 多步推理**: 单次请求可多次 Tool 调用后综合输出\n5. **类型安全**: Zod Schema 参数验证\n\n### 0.3 风险评估\n\n| 风险 | 等级 | 缓解措施 |\n|------|:----:|----------|\n| API 兼容性破坏 | 🔴 高 | 双路由并行期，逐步迁移 |\n| 前端 CSRF 问题 | 🟡 中 | Next.js API Route 同源，无跨域 |\n| 数据服务调用延迟 | 🟡 中 | Tool execute 批量聚合，缓存热点数据 |\n| 团队 TypeScript 熟练度 | 🟢 低 | 现有 agent_service 已有 TS 基础 |\n| maxSteps 重复写入 | 🔴 高 | 幂等性设计 + finalize 机制 |\n| 流式中断数据不一致 | 🔴 高 | 流式与事务解耦，finalize 统一提交 |\n\n### 0.4 目标后端形态（三运行单元）\n\n重构后的后端拆分为 **3 个可独立演进的运行单元**：\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         目标架构 (v4.2)                                       │\n└─────────────────────────────────────────────────────────────────────────────┘\n\nBrowser\n    │\n    │ HTTP\n    ▼\n┌─────────────────────────────────────────────────────────────────────────────┐\n│  Reverse Proxy (Nginx/Caddy :80/:443)                                        │\n│  ┌─────────────────────────────────────────────────────────────────────────┐│\n│  │  路由规则:                                                               ││\n│  │  /api/chat          → Next.js (:8231)  # Agent Runtime                  ││\n│  │  /api/landing/*     → Next.js (:8231)  # Landing Page API               ││\n│  │  /api/*             → FastAPI (:8230)  # Data Service                   ││\n│  │  /new/*             → Next.js (:8231)  # Frontend                       ││\n│  │  /admin/*           → Next.js (:8231)  # Admin System                   ││\n│  └─────────────────────────────────────────────────────────────────────────┘│\n└─────────────────────────────────────────────────────────────────────────────┘\n        │                           │                           │\n        ▼                           ▼                           ▼\n┌───────────────────┐  ┌─────────────────────────┐  ┌─────────────────────────┐\n│ Next.js Agent     │  │ FastAPI Data Service    │  │ Python Cold Path Worker │\n│ Runtime (:8231)   │  │ (:8230)                 │  │ (Cron/Queue)            │\n├───────────────────┤  ├─────────────────────────┤  ├─────────────────────────┤\n│ • streamText()    │  │ • Auth/Session          │  │ • Insight Agent         │\n│ • tool() Skills   │  │ • 领域写入 (SSOT)       │  │ • Memory 沉淀           │\n│ • useChat() 流式  │  │ • 确定性计算            │  │ • 异步报告生成          │\n│ • Multi-Model Hub │  │ • Internal APIs         │  │ • 数据清洗              │\n└───────────────────┘  └─────────────────────────┘  └─────────────────────────┘\n        │                           │                           │\n        │     fetch() / gRPC        │                           │\n        └───────────────────────────┴───────────────────────────┘\n                                    │\n                                    ▼\n                          PostgreSQL (fortune_ai)\n```\n\n| 运行单元 | 职责 | 技术栈 | 部署 |\n|----------|------|--------|------|\n| **Agent Runtime** | AI 推理、流式响应、Tool Calling | Next.js + Vercel AI SDK | 可独立扩缩 |\n| **Data Service** | Auth、SSOT 写入、确定性计算 | FastAPI + PostgreSQL | 有状态，单实例优先 |\n| **Cold Path Worker** | 后台分析、Memory 沉淀 | Python + Celery/Cron | 异步，失败不阻塞 |\n\n### 0.5 信任边界与安全原则\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         信任边界 (Trust Boundary)                            │\n└─────────────────────────────────────────────────────────────────────────────┘\n\n                  ┌─────────────────────────────────────────┐\n                  │            Untrusted Zone               │\n                  │                                         │\n                  │   Browser / Mobile App / Third Party    │\n                  │                                         │\n                  │   ⚠️ 永远不能信任来自这里的:             │\n                  │      • userId                           │\n                  │      • role / permissions               │\n                  │      • 任何敏感标识                      │\n                  └───────────────────┬─────────────────────┘\n                                      │\n                    Cookie (fortune_session) + HTTPS Only\n                                      │\n                                      ▼\n                  ┌─────────────────────────────────────────┐\n                  │            Trusted Zone                 │\n                  │                                         │\n                  │   Next.js API Route / FastAPI           │\n                  │                                         │\n                  │   ✅ userId 只能从 Session 解出          │\n                  │   ✅ session_id 可由前端传但必须校验归属 │\n                  │   ✅ Internal API 需 service token       │\n                  └─────────────────────────────────────────┘\n```\n\n**关键规则**：\n\n1. **userId 不传**: 前端请求体永远不包含 `userId`，由服务端从 Cookie Session 解出\n2. **session_id 校验**: 如前端传 `session_id`，后端必须校验该 session 归属当前用户\n3. **Internal API 隔离**: `/internal/*` 端点不暴露给浏览器，需 service token 或 IP 白名单\n\n### 0.6 工程化原则（决定重构成败）\n\n#### 0.6.1 流式与事务解耦\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                    Chat Run Lifecycle (流式生命周期)                          │\n└─────────────────────────────────────────────────────────────────────────────┘\n\n用户消息 ──▶ run/start ──▶ streamText() ──▶ Tool调用(N次) ──▶ run/finalize\n   │            │              │                │                  │\n   │            │              │                │                  │\n   ▼            ▼              ▼                ▼                  ▼\n┌────────┐ ┌─────────┐   ┌──────────┐    ┌───────────┐      ┌─────────────┐\n│用户消息│ │ run_id  │   │ 流式输出 │    │ 工具结果  │      │ 统一提交    │\n│ 入库  │ │ 记录    │   │ (不落库) │    │ (内存暂存)│      │ 事务写入    │\n└────────┘ └─────────┘   └──────────┘    └───────────┘      └─────────────┘\n\n                                                                   │\n                                                                   ▼\n                                                          ┌─────────────────┐\n                                                          │ 一次事务包含:   │\n                                                          │ • assistant msg │\n                                                          │ • commitments   │\n                                                          │ • tool_log      │\n                                                          │ • twin updates  │\n                                                          └─────────────────┘\n```\n\n**规则**：\n- 流式过程中只做\"可重放\"记录（run_id、用户消息）\n- Tool 执行结果暂存内存，不直接写 DB\n- `finalize` 时统一事务提交\n- 中断则标记 `aborted`，避免半条消息进 SSOT\n\n#### 0.6.2 全链路 correlation_id\n\n```typescript\n// Next.js API Route 入口生成\nexport async function POST(req: Request) {\n  const correlationId = req.headers.get('x-correlation-id')\n    || `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n\n  // 透传到 FastAPI\n  const context = await fetch(`${FASTAPI_URL}/internal/context`, {\n    headers: { 'X-Correlation-ID': correlationId },\n  });\n\n  // 透传到 Tool 执行\n  const result = streamText({\n    // ...\n    onStepFinish({ toolCalls }) {\n      logger.info({ correlationId, toolCalls }, 'Step finished');\n    },\n  });\n}\n```\n\n**用途**：串联\"对话 → Tool 调用 → 写入 → 失败原因\"，便于 debug 和审计。\n\n#### 0.6.3 统一错误语义\n\n```typescript\n// Public API 响应格式\ninterface ApiResponse<T> {\n  ok: boolean;\n  data?: T;\n  error?: {\n    code: string;        // 'AUTH_REQUIRED' | 'RATE_LIMITED' | 'TOOL_FAILED' | ...\n    message: string;     // 用户可读消息\n    detail?: unknown;    // 调试信息（仅 dev 环境）\n    correlation_id?: string;\n  };\n}\n\n// Tool 执行失败返回（可渲染为 Toast 或 ErrorCard）\ninterface ToolError {\n  type: 'tool_error';\n  tool_name: string;\n  error_code: string;\n  user_message: string;  // \"八字计算服务暂时不可用\"\n}\n```\n\n---\n\n## 1. 现状分析\n\n### 1.1 当前架构\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         当前架构 (v4.0/v4.1)                                  │\n└─────────────────────────────────────────────────────────────────────────────┘\n\nBrowser (:8231/new)\n    │\n    │ HTTP (fetch + SSE)\n    ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  FastAPI (:8230)                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐  │\n│  │  19 Route Files                                                     │  │\n│  │  auth_routes / chat_routes / dashboard_routes / bazi_routes ...    │  │\n│  └────────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Services Layer           ▼                                        │  │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐  │  │\n│  │  │glm_client.py│ │bazi_engine  │ │twin_service │ │goal_service │  │  │\n│  │  │ (LLM 调用)  │ │  (L0 计算) │ │ (状态管理) │ │ (目标管理) │  │  │\n│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘  │  │\n│  └───────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Agent Service Client     │ (HTTP 调用 TypeScript Agent)          │  │\n│  └───────────────────────────┼───────────────────────────────────────┘  │\n└──────────────────────────────┼───────────────────────────────────────────┘\n                               │\n                               ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  Agent Service (:3000) - Express + Vercel AI SDK                          │\n│  ┌─────────────────────────────────────────────────────────────────────┐ │\n│  │  coach.ts: runCoachAgent() - 但仅作为辅助，主流量仍走 Python         │ │\n│  └─────────────────────────────────────────────────────────────────────┘ │\n└──────────────────────────────────────────────────────────────────────────┘\n                               │\n                               ▼\n                        PostgreSQL (fortune_ai)\n```\n\n### 1.2 现有文件清单\n\n**API Routes (19 个)**:\n```\napi/\n├── auth_routes.py        # 认证 (register/login/logout)\n├── chat_routes.py        # 对话 (send/stream) ⚠️ 核心重构对象\n├── dashboard_routes.py   # Dashboard Zone B\n├── bazi_routes.py        # 八字计算\n├── bento_routes.py       # Bento 6 卡片 (legacy)\n├── twin_routes.py        # 数字孪生\n├── goal_routes.py        # 目标管理\n├── reflection_routes.py  # 复盘\n├── report_routes.py      # 深度报告\n├── poster_routes.py      # 海报生成\n├── yunshi_routes.py      # 运势\n├── plan_routes.py        # 计划\n├── kb_routes.py          # 知识库\n├── session_routes.py     # 会话管理\n├── user_routes.py        # 用户资料\n├── social_routes.py      # 社交\n├── push_routes.py        # 推送\n├── currency_routes.py    # 货币\n├── jitai_routes.py       # 吉台\n├── agent_tool.py         # Agent 工具 API\n├── deps.py               # 依赖注入\n└── main.py               # 入口\n```\n\n**Services (核心)**:\n```\nservices/\n├── glm_client.py          # ⚠️ 待删除：直接 LLM 调用\n├── chat_service.py        # 会话消息管理\n├── bazi_engine.py         # L0 八字计算 ✅ 保留\n├── bazi_facts.py          # 事实提取 ✅ 保留\n├── twin_service.py        # 数字孪生 ✅ 保留\n├── goal_service.py        # 目标管理 ✅ 保留\n├── reflection_service.py  # 复盘 ✅ 保留\n├── soul_os.py             # 上下文组装 ⚠️ 重构\n├── agent_service_client.py # ⚠️ 待删除：改为 Next.js 内部调用\n└── ...\n```\n\n### 1.3 关键痛点\n\n| 痛点 | 影响 | 根因 |\n|------|------|------|\n| 双语言交互复杂 | 维护成本高 | Python/TS 边界不清晰 |\n| 流式渲染非标准 | 前端适配困难 | 自定义 SSE 格式 |\n| LLM 调用分散 | 难以统一管理 | glm_client + agent_service 并存 |\n| Tool Calling 手动 | 扩展困难 | 无标准化 Skills 框架 |\n| A2UI 非流式 | 首字延迟高 | JSON 整体返回 |\n\n---\n\n## 2. 目标架构\n\n### 2.1 架构图\n\n```\n┌─────────────────────────────────────────────────────────────────────────────┐\n│                         目标架构 (v4.2 Vercel AI SDK)                         │\n└─────────────────────────────────────────────────────────────────────────────┘\n\nBrowser\n    │\n    │ useChat() Hook\n    ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  Next.js (:8231)                                                          │\n│  ┌────────────────────────────────────────────────────────────────────┐  │\n│  │  app/api/chat/route.ts   ← Agent Runtime (核心)                     │  │\n│  │  ┌──────────────────────────────────────────────────────────────┐ │  │\n│  │  │  streamText({                                                 │ │  │\n│  │  │    model: selectModel(),     // GLM / Gemini / Claude         │ │  │\n│  │  │    system: buildSystemPrompt(context),                        │ │  │\n│  │  │    tools: getToolsForMode(mode),                              │ │  │\n│  │  │    maxSteps: 5,                                               │ │  │\n│  │  │  }) → toDataStreamResponse()                                  │ │  │\n│  │  └──────────────────────────────────────────────────────────────┘ │  │\n│  └────────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Skills Registry          ▼                                        │  │\n│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  │  │\n│  │  │Divine Skills│ │ Heal Skills │ │ Grow Skills │                  │  │\n│  │  │calculate_   │ │log_perma    │ │covey_matrix │                  │  │\n│  │  │  bazi/ziwei │ │cbt_reframe  │ │goal_setting │                  │  │\n│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘                  │  │\n│  └─────────┼───────────────┼───────────────┼─────────────────────────┘  │\n└────────────┼───────────────┼───────────────┼────────────────────────────┘\n             │               │               │\n             │ fetch()       │ fetch()       │ fetch()\n             ▼               ▼               ▼\n┌──────────────────────────────────────────────────────────────────────────┐\n│  FastAPI (:8230) - 纯数据服务层                                            │\n│  ┌────────────────────────────────────────────────────────────────────┐  │\n│  │  Data Service APIs (无 LLM 调用)                                    │  │\n│  │  /api/bazi/calculate     /api/perma/log      /api/goals/create     │  │\n│  │  /api/user/context       /api/twin/update    /api/tasks/create     │  │\n│  │  /api/landing/insight    /api/kb/search      /api/checkin/mood     │  │\n│  └────────────────────────────────────────────────────────────────────┘  │\n│                              │                                            │\n│  ┌───────────────────────────┼───────────────────────────────────────┐  │\n│  │  Services Layer (保留)    │                                        │  │\n│  │  bazi_engine / twin_service / goal_service / reflection_service   │  │\n│  └───────────────────────────────────────────────────────────────────┘  │\n└──────────────────────────────────────────────────────────────────────────┘\n                               │\n                               ▼\n                        PostgreSQL (fortune_ai)\n```\n\n### 2.2 职责边界\n\n| 层级 | 运行环境 | 职责 | 技术栈 |\n|------|----------|------|--------|\n| **Frontend** | Browser | UI 渲染、流式展示、Command 输入 | React + `useChat()` |\n| **Agent Runtime** | Next.js API Route | AI 推理、Tool Calling、流式输出 | `streamText()` + `tool()` |\n| **Skills Registry** | Next.js | 可插拔技能定义 | Zod Schema + execute |\n| **Data Service** | FastAPI | L0/L1 数据 CRUD、计算逻辑 | Python + PostgreSQL |\n| **Insight Agent** | Cron Worker | Cold Path 数据沉淀 | Python |\n\n### 2.3 API 端点规划\n\n**Next.js API Routes (新增)**:\n```typescript\n// Agent Runtime\nPOST /api/chat           // streamText() 主入口\nPOST /api/command        // /divine /heal /grow 指令路由\n\n// Landing Page (可选迁移)\nPOST /api/landing/insight  // 即时洞察 (无需登录)\n```\n\n**FastAPI Data Service (重构)**:\n```python\n# L0 Base Data\nGET  /api/user/context        # 聚合用户上下文\nGET  /api/user/profile        # 用户资料\nPUT  /api/user/profile        # 更新资料\n\n# L1 Module Data - Divine\nPOST /api/bazi/calculate      # 八字计算\nPOST /api/ziwei/calculate     # 紫微计算\nGET  /api/bazi/facts/{user_id}  # 获取事实\n\n# L1 Module Data - Heal\nPOST /api/perma/log           # PERMA 记录\nGET  /api/perma/query         # PERMA 查询\nPOST /api/checkin/mood        # 情绪打卡\n\n# L1 Module Data - Grow\nPOST /api/goals/create        # 创建目标\nGET  /api/goals/active        # 活跃目标\nPOST /api/tasks/create        # 创建任务\nPUT  /api/tasks/{id}/complete # 完成任务\n\n# Twin\nGET  /api/twin/{user_id}      # 获取孪生数据\nPUT  /api/twin/update         # 更新孪生\n\n# KB\nPOST /api/kb/search           # 知识库检索\n\n# 保留 (暂不迁移)\n/api/auth/*                   # 认证\n/api/report/*                 # 深度报告\n/api/poster/*                 # 海报\n/api/dashboard/*              # Dashboard\n```\n\n### 2.4 Internal Contract APIs（内部契约）\n\n为 Agent Runtime 与 FastAPI 之间的通信定义两个核心契约，比继续复用 `chat_routes.py` 更干净：\n\n#### 2.4.1 Context API（上下文聚合）\n\n```python\n# FastAPI: api/internal_routes.py\n# 只对内部调用开放，需 X-Service-Token 或 IP 白名单\n\n@router.get(\"/internal/context\")\nasync def get_context(\n    session_id: str = Query(None),\n    user: AuthUser = Depends(get_current_user_from_cookie),\n    x_correlation_id: str = Header(None),\n) -> ContextResponse:\n    \"\"\"\n    一次性聚合用户上下文，减少 Agent Runtime 的 fetch 次数\n    \"\"\"\n    return ContextResponse(\n        l0=UserProfile(\n            user_id=user.id,\n            display_name=user.name,\n            birth_info=get_birth_info(user.id),\n            preferences=get_preferences(user.id),\n        ),\n        l1=ModuleData(\n            bazi_chart=get_latest_bazi(user.id),\n            perma_recent=get_perma_summary(user.id, days=7),\n            active_goals=get_active_goals(user.id, limit=3),\n            twin_status=get_twin_status(user.id),\n        ),\n        policy_flags=PolicyFlags(\n            allow_roast=user.preferences.get('allow_roast', False),\n            model_override=user.preferences.get('model'),\n        ),\n        history_excerpt=get_recent_messages(user.id, limit=10),\n    )\n```\n\n**Response Schema**:\n```typescript\ninterface ContextResponse {\n  l0: {\n    user_id: string;\n    display_name: string;\n    birth_info: { year: number; month: number; day: number; hour?: number };\n    preferences: Record<string, unknown>;\n  };\n  l1: {\n    bazi_chart?: BaziChart;\n    perma_recent?: PermaScore[];\n    active_goals?: Goal[];\n    twin_status?: TwinStatus;\n  };\n  policy_flags: {\n    allow_roast: boolean;\n    model_override?: 'glm' | 'gemini' | 'claude';\n  };\n  history_excerpt: Message[];\n}\n```\n\n#### 2.4.2 Chat Persistence API（流式持久化）\n\n```python\n# FastAPI: api/internal_routes.py\n\n@router.post(\"/internal/chat/run/start\")\nasync def start_chat_run(\n    request: StartRunRequest,\n    user: AuthUser = Depends(get_current_user_from_cookie),\n) -> StartRunResponse:\n    \"\"\"\n    流式开始时调用：记录 run_id + 用户消息\n    \"\"\"\n    run_id = str(uuid4())\n\n    # 只写入用户消息（assistant 消息在 finalize 写入）\n    await db.execute(\"\"\"\n        INSERT INTO chat_runs (id, user_id, session_id, status, started_at)\n        VALUES ($1, $2, $3, 'running', NOW())\n    \"\"\", run_id, user.id, request.session_id)\n\n    await db.execute(\"\"\"\n        INSERT INTO chat_messages (run_id, role, content, created_at)\n        VALUES ($1, 'user', $2, NOW())\n    \"\"\", run_id, request.user_message)\n\n    return StartRunResponse(run_id=run_id)\n\n@router.post(\"/internal/chat/run/finalize\")\nasync def finalize_chat_run(\n    request: FinalizeRunRequest,\n    user: AuthUser = Depends(get_current_user_from_cookie),\n) -> FinalizeRunResponse:\n    \"\"\"\n    流式结束时调用：一次事务写入所有副作用\n    \"\"\"\n    async with db.transaction():\n        # 1. 更新 run 状态\n        await db.execute(\"\"\"\n            UPDATE chat_runs\n            SET status = $2, finished_at = NOW()\n            WHERE id = $1\n        \"\"\", request.run_id, 'completed' if request.success else 'aborted')\n\n        # 2. 写入 assistant 消息\n        if request.assistant_message:\n            await db.execute(\"\"\"\n                INSERT INTO chat_messages (run_id, role, content, created_at)\n                VALUES ($1, 'assistant', $2, NOW())\n            \"\"\", request.run_id, request.assistant_message)\n\n        # 3. 写入 tool 调用日志\n        for tool_log in request.tool_logs:\n            await db.execute(\"\"\"\n                INSERT INTO tool_invocations\n                (run_id, tool_name, input, output, latency_ms, idempotency_key)\n                VALUES ($1, $2, $3, $4, $5, $6)\n                ON CONFLICT (idempotency_key) DO NOTHING\n            \"\"\", request.run_id, tool_log.name, tool_log.input,\n                tool_log.output, tool_log.latency_ms, tool_log.idempotency_key)\n\n        # 4. 写入 commitments（承诺/任务）\n        for commitment in request.commitments:\n            await create_commitment(user.id, commitment)\n\n        # 5. 更新 twin 状态\n        if request.twin_updates:\n            await update_twin(user.id, request.twin_updates)\n\n    return FinalizeRunResponse(ok=True)\n```\n\n**Request/Response Schema**:\n```typescript\ninterface StartRunRequest {\n  session_id?: string;\n  user_message: string;\n  correlation_id: string;\n}\n\ninterface FinalizeRunRequest {\n  run_id: string;\n  success: boolean;\n  assistant_message?: string;\n  tool_logs: ToolLog[];\n  commitments: Commitment[];\n  twin_updates?: TwinUpdate;\n}\n\ninterface ToolLog {\n  name: string;\n  input: Record<string, unknown>;\n  output: Record<string, unknown>;\n  latency_ms: number;\n  idempotency_key: string;  // 用于防止 maxSteps 重复写入\n}\n```\n\n### 2.5 A2UI 迁移方案（ToolResultCard）\n\n将 A2UI 从\"整段 JSON 作为 assistant content\"迁移为\"ToolResultCard + 教练表达\"模式：\n\n#### 2.5.1 现状 vs 目标\n\n```\n【现状】A2UI 作为 assistant message content\n┌─────────────────────────────────────────────────────────────────┐\n│ { role: 'assistant',                                            │\n│   content: '{\"type\":\"a2ui\",\"cards\":[{\"type\":\"bazi_chart\",...}]}'│\n│ }                                                               │\n└─────────────────────────────────────────────────────────────────┘\n\n【目标】ToolResultCard + assistant content 分离\n┌─────────────────────────────────────────────────────────────────┐\n│ {                                                               │\n│   role: 'assistant',                                            │\n│   content: '根据你的八字，你是一个...',  // 教练表达           │\n│   toolInvocations: [                                            │\n│     {                                                           │\n│       toolName: 'calculate_bazi',                               │\n│       state: 'result',                                          │\n│       result: {                                                 │\n│         type: 'a2ui_card',                                      │\n│         card_type: 'bazi_chart',                                │\n│         data: { ... }                                           │\n│       }                                                         │\n│     }                                                           │\n│   ]                                                             │\n│ }                                                               │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n#### 2.5.2 ToolResultCard Schema\n\n```typescript\n// lib/types/a2ui-card.ts\n\ninterface ToolResultCard {\n  type: 'a2ui_card';\n  card_type: CardType;\n  data: CardData;\n  actions?: CardAction[];\n}\n\ntype CardType =\n  | 'bazi_chart'      // 八字命盘\n  | 'perma_radar'     // PERMA 雷达图\n  | 'goal_progress'   // 目标进度\n  | 'commitment_card' // 承诺卡片\n  | 'insight_card'    // 洞察卡片\n  | 'kline_chart'     // K线图\n  | 'error_toast';    // 错误提示\n\ninterface CardAction {\n  type: 'accept' | 'done' | 'skip' | 'navigate' | 'share';\n  label: string;\n  endpoint?: string;   // 仅映射到 SSOT 状态机跃迁端点\n  payload?: Record<string, unknown>;\n}\n\n// 前端渲染\nfunction ToolResultRenderer({ toolInvocation }) {\n  if (toolInvocation.result?.type === 'a2ui_card') {\n    const { card_type, data, actions } = toolInvocation.result;\n    switch (card_type) {\n      case 'bazi_chart':\n        return <BaziChartCard data={data} actions={actions} />;\n      case 'commitment_card':\n        return <CommitmentCard data={data} actions={actions} />;\n      // ...\n    }\n  }\n  return null;\n}\n```\n\n#### 2.5.3 ActionButton 约束\n\n**关键规则**：ActionButton 的 `type` 只能映射到以下 SSOT 状态机跃迁端点，不允许组件私自定义写操作：\n\n| action.type | 映射端点 | 说明 |\n|-------------|----------|------|\n| `accept` | `POST /api/dashboard/task/accept` | 接受任务 |\n| `done` | `POST /api/dashboard/task/done` | 完成任务 |\n| `skip` | `POST /api/dashboard/task/skip` | 跳过任务 |\n| `checkin` | `POST /api/dashboard/checkin` | 情绪打卡 |\n| `navigate` | 前端路由 | 页面跳转（无写操作） |\n| `share` | `POST /api/social/share` | 分享卡片 |\n\n### 2.6 幂等性设计\n\n防止 `maxSteps` 多步推理下的重复写入：\n\n#### 2.6.1 idempotency_key 策略\n\n```typescript\n// lib/skills/divine-skills.ts\n\nexport const calculateBazi = tool({\n  description: '计算用户的八字命盘',\n  parameters: z.object({\n    birth_datetime: z.string(),\n    timezone: z.string().default('Asia/Shanghai'),\n  }),\n  execute: async ({ birth_datetime, timezone }, { runId, stepIndex }) => {\n    // 生成幂等键：run_id + step_index + tool_name + params_hash\n    const idempotencyKey = `${runId}:${stepIndex}:calculate_bazi:${hash({ birth_datetime, timezone })}`;\n\n    const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'X-Idempotency-Key': idempotencyKey,\n      },\n      body: JSON.stringify({ birth_datetime, timezone }),\n    });\n\n    return res.json();\n  },\n});\n```\n\n#### 2.6.2 FastAPI 幂等性处理\n\n```python\n# api/middleware/idempotency.py\n\n@app.middleware(\"http\")\nasync def idempotency_middleware(request: Request, call_next):\n    idempotency_key = request.headers.get(\"X-Idempotency-Key\")\n\n    if idempotency_key and request.method in (\"POST\", \"PUT\"):\n        # 检查是否已执行\n        cached = await redis.get(f\"idempotency:{idempotency_key}\")\n        if cached:\n            return JSONResponse(content=json.loads(cached))\n\n        response = await call_next(request)\n\n        # 缓存结果（TTL 24h）\n        if response.status_code == 200:\n            body = await response.body()\n            await redis.setex(f\"idempotency:{idempotency_key}\", 86400, body)\n\n        return response\n\n    return await call_next(request)\n```\n\n#### 2.6.3 自然唯一键\n\n对于某些业务写入，使用自然唯一键替代显式 idempotency_key：\n\n```sql\n-- 承诺表：同一用户同一天同一描述只能有一条\nCREATE UNIQUE INDEX uq_commitments_natural\nON commitments (user_id, date_trunc('day', created_at), description_hash)\nWHERE status = 'active';\n\n-- PERMA 记录：同一用户同一小时只能有一条\nCREATE UNIQUE INDEX uq_perma_hourly\nON perma_logs (user_id, date_trunc('hour', logged_at));\n```\n\n---\n\n## 3. 重构阶段\n\n### Phase 1: 基础设施准备 (Week 1)\n\n**目标**: 建立 Next.js Agent Runtime 基础框架 + 双后端路由共存\n\n#### 1.0 反向代理路由配置（关键前置）\n\n配置 Nginx/Caddy 实现 Next.js 和 FastAPI 的路由共存：\n\n```nginx\n# /etc/nginx/sites-available/fortune-ai\n\nupstream nextjs {\n    server 127.0.0.1:8231;\n}\n\nupstream fastapi {\n    server 127.0.0.1:8230;\n}\n\nserver {\n    listen 80;\n    server_name fortune-ai.example.com;\n\n    # Agent Runtime (Next.js)\n    location /api/chat {\n        proxy_pass http://nextjs;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_buffering off;  # 流式响应必须\n        proxy_read_timeout 300s;\n    }\n\n    # Landing Page API (Next.js)\n    location /api/landing/ {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n        # IP 级限流\n        limit_req zone=landing_limit burst=5 nodelay;\n    }\n\n    # Internal APIs (仅内部访问)\n    location /internal/ {\n        # 只允许内网访问\n        allow 127.0.0.1;\n        allow 10.0.0.0/8;\n        deny all;\n        proxy_pass http://fastapi;\n        proxy_set_header Host $host;\n    }\n\n    # Data Service APIs (FastAPI)\n    location /api/ {\n        proxy_pass http://fastapi;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header Cookie $http_cookie;\n    }\n\n    # Frontend (Next.js)\n    location /new/ {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n    }\n\n    # Admin System (Next.js)\n    location /admin/ {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n    }\n\n    # Landing Page (Next.js)\n    location / {\n        proxy_pass http://nextjs;\n        proxy_set_header Host $host;\n    }\n}\n\n# IP 限流配置\nlimit_req_zone $binary_remote_addr zone=landing_limit:10m rate=10r/m;\n```\n\n**路由优先级**（顺序很重要）：\n1. `/api/chat` → Next.js（Agent Runtime）\n2. `/api/landing/*` → Next.js（Landing Page API）\n3. `/internal/*` → FastAPI（内部 API，限内网）\n4. `/api/*` → FastAPI（Data Service）\n5. `/new/*` → Next.js（Frontend）\n6. `/admin/*` → Next.js（Admin）\n7. `/` → Next.js（Landing Page）\n\n#### 1.1 Next.js API Route 结构\n\n```bash\nweb-app/src/app/api/\n├── chat/\n│   └── route.ts              # 主 Agent Runtime\n├── command/\n│   └── route.ts              # 指令路由\n└── landing/\n    └── insight/\n        └── route.ts          # Landing Page 洞察\n```\n\n#### 1.2 Skills Registry 框架\n\n```bash\nweb-app/src/lib/\n├── skills/\n│   ├── index.ts              # Skills 统一导出\n│   ├── divine-skills.ts      # 玄学技能\n│   ├── heal-skills.ts        # 疗愈技能\n│   └── grow-skills.ts        # 成长技能\n├── models/\n│   └── model-provider.ts     # Multi-Model 配置\n└── context/\n    └── context-builder.ts    # System Prompt 构建\n```\n\n#### 1.3 配置 Multi-Model Provider\n\n```typescript\n// lib/models/model-provider.ts\nimport { createGoogleGenerativeAI } from '@ai-sdk/google';\nimport { createAnthropic } from '@ai-sdk/anthropic';\n\nconst google = createGoogleGenerativeAI({\n  apiKey: process.env.GOOGLE_API_KEY,\n});\n\nconst anthropic = createAnthropic({\n  apiKey: process.env.ANTHROPIC_API_KEY,\n});\n\n// Vercel AI Gateway for GLM-4.5\nconst glm = createGoogleGenerativeAI({\n  baseURL: 'https://gateway.ai.cloudflare.com/v1/...',\n  apiKey: process.env.GLM_API_KEY,\n});\n\nexport function selectModel(preference?: string) {\n  switch (preference) {\n    case 'gemini': return google('gemini-2.0-flash-exp');\n    case 'claude': return anthropic('claude-3-5-sonnet-20241022');\n    case 'glm':\n    default: return glm('glm-4.5');\n  }\n}\n```\n\n#### 1.4 交付物\n\n- [ ] **Nginx/Caddy 双后端路由配置**（关键前置）\n- [ ] FastAPI `/internal/*` 端点隔离（IP 白名单）\n- [ ] Next.js `/api/chat/route.ts` 基础框架\n- [ ] Skills Registry 目录结构\n- [ ] Multi-Model Provider 配置\n- [ ] 环境变量配置 (`.env.local`)\n\n---\n\n### Phase 2: Agent Runtime 迁移 (Week 2)\n\n**目标**: 将 AI 推理逻辑从 Python 迁移到 Next.js\n\n#### 2.1 实现 `/api/chat/route.ts`（含 Run Lifecycle）\n\n```typescript\n// app/api/chat/route.ts\nimport { streamText } from 'ai';\nimport { cookies } from 'next/headers';\nimport { selectModel } from '@/lib/models/model-provider';\nimport { allSkills } from '@/lib/skills';\nimport { buildSystemPrompt } from '@/lib/context/context-builder';\n\nconst FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n\n// 请求体：不包含 userId（从 Cookie Session 解出）\ninterface ChatRequest {\n  session_id?: string;   // 可选，用于会话续接\n  message: string;       // 用户消息\n  command?: string;      // /divine | /heal | /grow（来自 CommandPalette）\n}\n\nexport async function POST(req: Request) {\n  const cookieStore = await cookies();\n  const sessionCookie = cookieStore.get('fortune_session')?.value;\n\n  if (!sessionCookie) {\n    return Response.json({ ok: false, error: { code: 'AUTH_REQUIRED' } }, { status: 401 });\n  }\n\n  const { session_id, message, command }: ChatRequest = await req.json();\n\n  // 生成 correlation_id\n  const correlationId = `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;\n\n  // 1. 调用 Internal Context API（Cookie 透传，userId 由 FastAPI 解出）\n  const contextRes = await fetch(`${FASTAPI_URL}/internal/context`, {\n    headers: {\n      'Cookie': `fortune_session=${sessionCookie}`,\n      'X-Correlation-ID': correlationId,\n    },\n  });\n\n  if (!contextRes.ok) {\n    return Response.json({ ok: false, error: { code: 'CONTEXT_FETCH_FAILED' } }, { status: 500 });\n  }\n\n  const context = await contextRes.json();\n\n  // 2. 调用 run/start（记录 run_id + 用户消息）\n  const startRes = await fetch(`${FASTAPI_URL}/internal/chat/run/start`, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Cookie': `fortune_session=${sessionCookie}`,\n      'X-Correlation-ID': correlationId,\n    },\n    body: JSON.stringify({\n      session_id,\n      user_message: message,\n      correlation_id: correlationId,\n    }),\n  });\n\n  const { run_id } = await startRes.json();\n\n  // 3. 根据 Command 筛选 Tools\n  const tools = command\n    ? getToolsForCommand(command)  // /divine → divineSkills only\n    : allSkills;                   // Chat Mode: all tools\n\n  // 4. 暂存 Tool 调用记录（用于 finalize）\n  const toolLogs: ToolLog[] = [];\n  const commitments: Commitment[] = [];\n\n  // 5. streamText 流式推理\n  const result = streamText({\n    model: selectModel(context.policy_flags?.model_override),\n    system: buildSystemPrompt(context),\n    messages: [\n      ...context.history_excerpt,\n      { role: 'user', content: message },\n    ],\n    tools,\n    maxSteps: 5,\n\n    // 每步完成回调：记录 Tool 调用\n    onStepFinish({ stepType, toolCalls, toolResults }) {\n      if (stepType === 'tool-result' && toolCalls) {\n        for (let i = 0; i < toolCalls.length; i++) {\n          const call = toolCalls[i];\n          const result = toolResults?.[i];\n          toolLogs.push({\n            name: call.toolName,\n            input: call.args,\n            output: result,\n            latency_ms: 0, // TODO: 实际计时\n            idempotency_key: `${run_id}:${toolLogs.length}:${call.toolName}`,\n          });\n\n          // 收集 commitments\n          if (result?.commitments) {\n            commitments.push(...result.commitments);\n          }\n        }\n      }\n    },\n\n    // 流式完成回调：调用 finalize\n    async onFinish({ text, finishReason }) {\n      await fetch(`${FASTAPI_URL}/internal/chat/run/finalize`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Cookie': `fortune_session=${sessionCookie}`,\n          'X-Correlation-ID': correlationId,\n        },\n        body: JSON.stringify({\n          run_id,\n          success: finishReason !== 'error',\n          assistant_message: text,\n          tool_logs: toolLogs,\n          commitments,\n        }),\n      });\n    },\n  });\n\n  return result.toDataStreamResponse();\n}\n```\n\n**关键变化**：\n- 请求体只包含 `{ session_id?, message, command? }`，**不传 userId**\n- userId 从 Cookie Session 由 FastAPI 解出\n- 流式开始时调用 `run/start`，结束时调用 `run/finalize`\n- Tool 调用记录暂存内存，`finalize` 时统一写入\n\n#### 2.2 System Prompt 迁移\n\n将 `chat_routes.py:SYSTEM_PROMPT_TEMPLATE` 迁移到 TypeScript：\n\n```typescript\n// lib/context/context-builder.ts\nexport function buildSystemPrompt(context: UserContext): string {\n  return `你是 Fortune AI 的对话 Agent，角色是积极心理学教练。\n\n【硬性规则】\n1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接\"你可以做什么\"的行动处方。\n2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。\n3) 每次输出必须包含：结论 + 依据 + ≤3条处方 + 承诺邀请。\n4) 每条处方必须包含 if_then：如果____→那么____。\n5) 必须给出可点击 actions。\n\n【用户上下文】\npersona_style: ${context.persona_style}\nfacts: ${JSON.stringify(context.facts)}\nevidence: ${JSON.stringify(context.evidence)}\nactive_goals: ${JSON.stringify(context.active_goals)}\n`;\n}\n```\n\n#### 2.3 双路由并行期\n\n**保留 Python `/api/chat/send`**，新增 Next.js `/api/chat`：\n\n```python\n# api/chat_routes.py - 添加 header 检测\n@router.post(\"/send\")\nasync def chat_send(request: Request, body: ChatSendRequest, auth = Depends(require_auth)):\n    # 检查是否使用新架构\n    use_new_runtime = request.headers.get(\"X-Use-New-Runtime\") == \"true\"\n    if use_new_runtime:\n        # 转发到 Next.js\n        return RedirectResponse(url=\"/api/chat\", status_code=307)\n    # 原有逻辑...\n```\n\n#### 2.4 交付物\n\n- [ ] `/api/chat/route.ts` 完整实现\n- [ ] `buildSystemPrompt()` 迁移\n- [ ] 双路由并行配置\n- [ ] 前端 `useChat()` 集成测试\n\n---\n\n### Phase 3: Skills 实现 (Week 3)\n\n**目标**: 将 L2 Expert Agents 重构为 Vercel Tools\n\n#### 3.1 Divine Skills\n\n```typescript\n// lib/skills/divine-skills.ts\nimport { tool } from 'ai';\nimport { z } from 'zod';\n\nconst FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';\n\nexport const divineSkills = {\n  calculate_bazi: tool({\n    description: '计算用户的八字命盘，返回四柱、五行、十神、神煞、大运等信息',\n    parameters: z.object({\n      birth_datetime: z.string().describe('出生日期时间 (ISO 8601)'),\n      timezone: z.string().default('Asia/Shanghai'),\n      include_dayun: z.boolean().default(true),\n    }),\n    execute: async ({ birth_datetime, timezone, include_dayun }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),\n      });\n      if (!res.ok) throw new Error(`Bazi calculation failed: ${res.status}`);\n      return res.json();\n    },\n  }),\n\n  get_bazi_facts: tool({\n    description: '获取用户已计算的八字事实数据',\n    parameters: z.object({\n      user_id: z.number(),\n    }),\n    execute: async ({ user_id }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/bazi/facts/${user_id}`);\n      return res.json();\n    },\n  }),\n\n  search_bazi_kb: tool({\n    description: '搜索八字知识库，获取相关命理解读',\n    parameters: z.object({\n      query: z.string().describe('搜索关键词'),\n      limit: z.number().default(3),\n    }),\n    execute: async ({ query, limit }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/kb/search`, {\n        method: 'POST',\n        body: JSON.stringify({ query, limit, category: 'bazi' }),\n      });\n      return res.json();\n    },\n  }),\n};\n```\n\n#### 3.2 Heal Skills\n\n```typescript\n// lib/skills/heal-skills.ts\nexport const healSkills = {\n  log_perma: tool({\n    description: '记录用户的 PERMA 五维心理状态分数',\n    parameters: z.object({\n      dimension: z.enum(['P', 'E', 'R', 'M', 'A']),\n      score: z.number().min(0).max(10),\n      note: z.string().optional(),\n    }),\n    execute: async ({ dimension, score, note }, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/perma/log`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, dimension, score, note }),\n      });\n      return res.json();\n    },\n  }),\n\n  mood_checkin: tool({\n    description: '快速情绪打卡',\n    parameters: z.object({\n      mood_score: z.number().min(1).max(10),\n      tags: z.array(z.string()).optional(),\n      note: z.string().optional(),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n\n  cbt_reframe: tool({\n    description: '使用 CBT ABC 模型进行认知重构',\n    parameters: z.object({\n      activating_event: z.string().describe('触发事件 (A)'),\n      belief: z.string().optional().describe('信念/想法 (B)'),\n      consequence: z.string().optional().describe('情绪/行为后果 (C)'),\n    }),\n    execute: async (params) => {\n      // CBT 引导框架，返回结构化提示让 LLM 继续引导\n      return {\n        framework: 'ABC',\n        current_state: params,\n        next_step: params.belief ? 'identify_distortion' : 'explore_belief',\n        guidance_prompt: params.belief\n          ? `用户的信念是\"${params.belief}\"，请帮助识别可能的认知扭曲...`\n          : `请引导用户探索触发事件背后的信念和想法...`,\n      };\n    },\n  }),\n};\n```\n\n#### 3.3 Grow Skills\n\n```typescript\n// lib/skills/grow-skills.ts\nexport const growSkills = {\n  create_commitment: tool({\n    description: '创建行动承诺任务',\n    parameters: z.object({\n      content: z.string().describe('任务内容'),\n      category: z.enum(['energy_boost', 'reflection', 'practice', 'social', 'general']),\n      estimated_minutes: z.number().default(5),\n      if_then: z.string().optional().describe('If-Then 触发条件'),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n\n  goal_setting: tool({\n    description: '使用 WOOP 模型设定目标',\n    parameters: z.object({\n      wish: z.string().describe('愿望/目标'),\n      outcome: z.string().optional(),\n      obstacle: z.string().optional(),\n      plan: z.string().optional(),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {\n        method: 'POST',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n\n  update_twin: tool({\n    description: '更新用户数字孪生数据',\n    parameters: z.object({\n      layer: z.enum(['L1', 'L2', 'L3']),\n      path: z.string().describe('JSON 路径'),\n      value: z.any(),\n    }),\n    execute: async (params, { userId }) => {\n      const res = await fetch(`${FASTAPI_URL}/api/twin/update`, {\n        method: 'PUT',\n        body: JSON.stringify({ user_id: userId, ...params }),\n      });\n      return res.json();\n    },\n  }),\n};\n```\n\n#### 3.4 Skills Registry 统一导出\n\n```typescript\n// lib/skills/index.ts\nimport { divineSkills } from './divine-skills';\nimport { healSkills } from './heal-skills';\nimport { growSkills } from './grow-skills';\n\nexport const allSkills = {\n  ...divineSkills,\n  ...healSkills,\n  ...growSkills,\n};\n\nexport function getToolsForCommand(command: string) {\n  switch (command) {\n    case '/divine': return divineSkills;\n    case '/heal': return healSkills;\n    case '/grow': return growSkills;\n    default: return allSkills;\n  }\n}\n\nexport { divineSkills, healSkills, growSkills };\n```\n\n#### 3.5 交付物\n\n- [ ] `divine-skills.ts` 完整实现\n- [ ] `heal-skills.ts` 完整实现\n- [ ] `grow-skills.ts` 完整实现\n- [ ] Skills Registry 单元测试\n\n---\n\n### Phase 4: FastAPI 数据服务重构 (Week 4)\n\n**目标**: 将 FastAPI 精简为纯数据服务层\n\n#### 4.1 新增数据服务 API\n\n```python\n# api/data_routes.py (新文件)\nfrom fastapi import APIRouter, Depends\nfrom api.deps import require_auth\n\nrouter = APIRouter(prefix=\"/api\", tags=[\"data\"])\n\n@router.get(\"/user/context\")\nasync def get_user_context(user_id: int, auth = Depends(require_auth)):\n    \"\"\"聚合用户上下文，供 Agent Runtime 调用\"\"\"\n    # 聚合 profile + preferences + facts + active_goals + recent_messages\n    profile = await _get_profile(user_id)\n    prefs = await _get_preferences(user_id)\n    facts = await _get_bazi_facts(user_id)\n    goals = await _get_active_goals(user_id)\n    messages = await _get_recent_messages(user_id, limit=10)\n\n    return {\n        \"ok\": True,\n        \"data\": {\n            \"profile\": profile,\n            \"persona_style\": prefs.get(\"persona_style\", \"warm\"),\n            \"facts\": facts,\n            \"evidence\": {\n                \"facts_hash\": facts.get(\"facts_hash\"),\n                \"kb_refs\": [],  # 后续填充\n            },\n            \"active_goals\": goals,\n            \"recent_messages\": messages,\n        }\n    }\n\n@router.post(\"/bazi/calculate\")\nasync def calculate_bazi(body: BaziCalculateRequest):\n    \"\"\"八字计算 (无需登录，供 Landing Page 使用)\"\"\"\n    from services.bazi_engine import calculate_bazi\n    result = calculate_bazi(\n        body.birth_datetime,\n        body.timezone,\n        body.include_dayun,\n    )\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/perma/log\")\nasync def log_perma(body: PermaLogRequest, auth = Depends(require_auth)):\n    \"\"\"PERMA 状态记录\"\"\"\n    from services.twin_service import update_perma_score\n    result = await update_perma_score(\n        auth.user_id,\n        body.dimension,\n        body.score,\n        body.note,\n    )\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/tasks/create\")\nasync def create_task(body: TaskCreateRequest, auth = Depends(require_auth)):\n    \"\"\"创建承诺任务\"\"\"\n    from services.bento_service import create_commitment\n    result = await create_commitment(\n        auth.user_id,\n        body.content,\n        body.category,\n        body.estimated_minutes,\n        body.if_then,\n    )\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/goals/create\")\nasync def create_goal(body: GoalCreateRequest, auth = Depends(require_auth)):\n    \"\"\"创建 WOOP 目标\"\"\"\n    from services.goal_service import create_goal\n    result = await create_goal(auth.user_id, body.dict())\n    return {\"ok\": True, \"data\": result}\n\n@router.put(\"/twin/update\")\nasync def update_twin(body: TwinUpdateRequest, auth = Depends(require_auth)):\n    \"\"\"更新数字孪生\"\"\"\n    from services.twin_service import update_twin\n    result = await update_twin(auth.user_id, body.layer, body.path, body.value)\n    return {\"ok\": True, \"data\": result}\n\n@router.post(\"/kb/search\")\nasync def search_kb(body: KBSearchRequest, auth = Depends(require_auth)):\n    \"\"\"知识库检索\"\"\"\n    from services.kb_service import search\n    result = await search(body.query, body.limit, body.category)\n    return {\"ok\": True, \"data\": result}\n```\n\n#### 4.2 Landing Page API\n\n```python\n# api/landing_routes.py (新文件)\nfrom fastapi import APIRouter\n\nrouter = APIRouter(prefix=\"/api/landing\", tags=[\"landing\"])\n\nELEMENT_COLORS = {\n    \"wood\": [\"#4ade80\", \"#22c55e\"],\n    \"fire\": [\"#f87171\", \"#ef4444\"],\n    \"earth\": [\"#fbbf24\", \"#f59e0b\"],\n    \"metal\": [\"#f5f5f4\", \"#d6d3d1\"],\n    \"water\": [\"#60a5fa\", \"#3b82f6\"],\n}\n\nELEMENT_INSIGHTS = {\n    \"wood\": {\n        \"en\": \"A strong Wood energy detected. You seek growth, but feel restricted.\",\n        \"cn\": \"检测到强木能量。你渴望生长，但感到受限。\",\n    },\n    \"fire\": {\n        \"en\": \"Fire burns bright within you. Passion drives you forward.\",\n        \"cn\": \"火焰在你心中燃烧。热情驱动你前进。\",\n    },\n    # ... 其他五行\n}\n\n@router.post(\"/insight\")\nasync def instant_insight(body: InsightRequest):\n    \"\"\"即时洞察 (无需登录)\"\"\"\n    if body.input_type == \"bazi\":\n        # 快速计算日主五行\n        from services.bazi_engine import quick_day_master\n        element = quick_day_master(body.value)\n        insight = ELEMENT_INSIGHTS.get(element, ELEMENT_INSIGHTS[\"wood\"])\n        return {\n            \"ok\": True,\n            \"data\": {\n                \"type\": \"bazi\",\n                \"element\": element,\n                \"insight\": insight[\"en\"],\n                \"insight_cn\": insight[\"cn\"],\n                \"orb_colors\": ELEMENT_COLORS.get(element),\n                \"cta\": \"Unlock Full Analysis →\",\n            }\n        }\n    elif body.input_type == \"emotion\":\n        # 调用 LLM 生成简短情绪洞察\n        from services.glm_client import quick_emotion_insight\n        insight = await quick_emotion_insight(body.value)\n        return {\n            \"ok\": True,\n            \"data\": {\n                \"type\": \"emotion\",\n                \"insight\": insight,\n                \"orb_colors\": [\"#a78bfa\", \"#8b5cf6\"],  # 紫色\n                \"cta\": \"Start Your Journey →\",\n            }\n        }\n```\n\n#### 4.3 删除/废弃的代码\n\n```python\n# 待删除文件\nservices/glm_client.py          # LLM 调用迁移到 TypeScript\nservices/agent_service_client.py # 不再需要\n\n# 待废弃端点 (chat_routes.py)\n# POST /api/chat/send  → 迁移到 Next.js /api/chat\n# GET  /api/chat/stream → 迁移到 Next.js /api/chat\n```\n\n#### 4.4 交付物\n\n- [ ] `api/data_routes.py` 完整实现\n- [ ] `api/landing_routes.py` 完整实现\n- [ ] 旧 chat 端点废弃标记\n- [ ] API 文档更新\n\n---\n\n### Phase 5: 前端适配 (Week 5)\n\n**目标**: 前端切换到 `useChat()` Hook\n\n#### 5.1 useChat 集成\n\n```typescript\n// components/chat/chat-panel.tsx\n'use client';\n\nimport { useChat } from 'ai/react';\nimport { useState } from 'react';\n\nexport function ChatPanel({ userId }: { userId: number }) {\n  const [command, setCommand] = useState<string | null>(null);\n\n  const { messages, input, setInput, handleSubmit, isLoading, error } = useChat({\n    api: '/api/chat',\n    body: { userId, command },\n    onFinish: (message) => {\n      setCommand(null);\n      // 处理 Tool 调用结果\n      if (message.toolInvocations?.length) {\n        refreshDashboard(message.toolInvocations);\n      }\n    },\n  });\n\n  const handleCommandSubmit = (cmd: string, text: string) => {\n    setCommand(cmd);\n    setInput(text);\n    // useChat 会自动提交\n  };\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      {/* Messages */}\n      <div className=\"flex-1 overflow-y-auto\">\n        {messages.map((m) => (\n          <MessageBubble key={m.id} message={m} />\n        ))}\n      </div>\n\n      {/* Input */}\n      <ChatInput\n        value={input}\n        onChange={setInput}\n        onSubmit={handleSubmit}\n        onCommand={handleCommandSubmit}\n        isLoading={isLoading}\n      />\n    </div>\n  );\n}\n```\n\n#### 5.2 CommandPalette 集成\n\n```typescript\n// components/chat/command-palette.tsx\nconst COMMANDS = [\n  { cmd: '/divine', label: '玄学测算', icon: '🔮' },\n  { cmd: '/heal', label: '心理疗愈', icon: '💚' },\n  { cmd: '/grow', label: '成长教练', icon: '🌱' },\n  { cmd: '/status', label: '状态查看', icon: '📊' },\n];\n\nexport function CommandPalette({ onSelect, visible }: CommandPaletteProps) {\n  if (!visible) return null;\n\n  return (\n    <div className=\"absolute bottom-full left-0 w-full bg-background border rounded-lg shadow-lg p-2\">\n      {COMMANDS.map((c) => (\n        <button\n          key={c.cmd}\n          onClick={() => onSelect(c.cmd)}\n          className=\"flex items-center gap-2 w-full p-2 hover:bg-accent rounded\"\n        >\n          <span>{c.icon}</span>\n          <span className=\"font-medium\">{c.cmd}</span>\n          <span className=\"text-muted-foreground\">{c.label}</span>\n        </button>\n      ))}\n    </div>\n  );\n}\n```\n\n#### 5.3 Tool Result 渲染\n\n```typescript\n// components/chat/tool-result-card.tsx\nexport function ToolResultCard({ invocation }: { invocation: ToolInvocation }) {\n  const { toolName, result, state } = invocation;\n\n  if (state === 'partial-call') {\n    return <LoadingCard toolName={toolName} />;\n  }\n\n  switch (toolName) {\n    case 'calculate_bazi':\n      return <BaziResultCard data={result} />;\n    case 'mood_checkin':\n      return <MoodCheckinCard data={result} />;\n    case 'create_commitment':\n      return <CommitmentCard data={result} />;\n    default:\n      return <GenericResultCard data={result} />;\n  }\n}\n```\n\n#### 5.4 交付物\n\n- [ ] `useChat()` 集成\n- [ ] `CommandPalette` 组件\n- [ ] `ToolResultCard` 组件\n- [ ] 端到端测试\n\n---\n\n### Phase 6: 清理与优化 (Week 6)\n\n**目标**: 删除旧代码，性能优化\n\n#### 6.1 删除列表\n\n```bash\n# 删除文件\nrm services/glm_client.py\nrm services/agent_service_client.py\n\n# 删除 agent_service 目录 (已迁移到 Next.js)\nrm -rf agent_service/\n\n# 清理 chat_routes.py 中的旧端点\n# - /api/chat/send\n# - /api/chat/stream\n```\n\n#### 6.2 API 路由清理\n\n```python\n# api/main.py - 更新路由注册\napp.include_router(auth_routes.router)\napp.include_router(data_routes.router)      # 新增\napp.include_router(landing_routes.router)   # 新增\napp.include_router(dashboard_routes.router)\napp.include_router(report_routes.router)\n# 删除: app.include_router(chat_routes.router)\n```\n\n#### 6.3 性能优化\n\n1. **Context 缓存**: 用户上下文 Redis 缓存 (TTL 5min)\n2. **批量 Tool 调用**: 合并多个 fetch 请求\n3. **流式首字优化**: 减少 System Prompt 长度\n\n#### 6.4 监控与日志\n\n```typescript\n// 添加 Tool 调用监控\nconst result = streamText({\n  // ...\n  onStepFinish({ stepType, toolCalls, toolResults }) {\n    // 记录 Tool 调用耗时\n    logger.info('Step finished', {\n      stepType,\n      toolCount: toolCalls?.length,\n      latency: Date.now() - startTime,\n    });\n  },\n});\n```\n\n#### 6.5 交付物\n\n- [ ] 旧文件删除\n- [ ] API 路由更新\n- [ ] Redis 缓存配置\n- [ ] 监控 Dashboard\n\n---\n\n## 4. 风险与缓解\n\n### 4.1 兼容性风险\n\n| 风险点 | 影响范围 | 缓解措施 |\n|--------|----------|----------|\n| API 签名变更 | 前端所有 Chat 调用 | 双路由并行，Feature Flag 控制 |\n| A2UI 格式变化 | 消息渲染组件 | 保持 JSON 结构兼容，仅改传输方式 |\n| CSRF 处理 | 所有 POST 请求 | Next.js API Route 同源，无需 CSRF |\n| Cookie 传递 | 认证流程 | `credentials: 'include'` 配置 |\n\n### 4.2 回滚方案\n\n```typescript\n// Feature Flag 控制\nconst USE_NEW_RUNTIME = process.env.USE_NEW_RUNTIME === 'true';\n\n// 前端路由选择\nconst chatEndpoint = USE_NEW_RUNTIME ? '/api/chat' : '/api/chat/send';\n```\n\n### 4.3 灰度发布\n\n1. **Week 1-4**: 内部测试环境验证\n2. **Week 5**: 10% 用户灰度\n3. **Week 6**: 50% 用户灰度\n4. **Week 7**: 全量发布\n\n---\n\n## 5. 验收标准\n\n### 5.1 功能验收\n\n| 功能 | 验收标准 |\n|------|----------|\n| Chat 对话 | 流式输出正常，首字 < 500ms |\n| `/divine` 指令 | 八字计算正确，结果渲染正常 |\n| `/heal` 指令 | PERMA 记录成功，CBT 引导完整 |\n| `/grow` 指令 | 目标/任务创建成功 |\n| Landing Page | Insight 生成 < 1s，Orb 颜色正确 |\n| Tool Calling | 多步推理 (maxSteps=5) 正常 |\n\n### 5.2 性能验收\n\n| 指标 | 目标值 | 当前值 |\n|------|--------|--------|\n| 首字延迟 (P50) | < 500ms | ~800ms |\n| 首字延迟 (P95) | < 1.5s | ~2s |\n| Tool 调用延迟 | < 200ms | N/A |\n| 端到端响应 (P50) | < 3s | ~4s |\n\n### 5.3 代码质量\n\n- [ ] TypeScript 严格模式\n- [ ] Zod Schema 100% 覆盖\n- [ ] 单元测试覆盖率 > 80%\n- [ ] E2E 测试通过\n\n---\n\n## 6. 附录\n\n### 6.1 环境变量\n\n```bash\n# .env.local (Next.js)\nFASTAPI_URL=http://localhost:8230\nGOOGLE_API_KEY=xxx\nANTHROPIC_API_KEY=xxx\nGLM_API_KEY=xxx\nUSE_NEW_RUNTIME=true\n```\n\n### 6.2 依赖更新\n\n```json\n// package.json\n{\n  \"dependencies\": {\n    \"ai\": \"^4.0.0\",\n    \"@ai-sdk/google\": \"^1.0.0\",\n    \"@ai-sdk/anthropic\": \"^1.0.0\",\n    \"zod\": \"^3.22.0\"\n  }\n}\n```\n\n### 6.3 参考文档\n\n- [Vercel AI SDK 文档](https://sdk.vercel.ai/docs)\n- [os_design_v3.md §1.4-1.5](./os_design_v3.md)\n- [frontend_final_v3.md §2.6](./frontend_final_v3.md)\n- [system_design_final_mvp_v3.md §7.0.1](./system_design_final_mvp_v3.md)\n- [admin_v3.md](./admin_v3.md) - Admin System 设计，可与本重构并行开发\n\n### 6.4 并行开发项\n\n| 项目 | 描述 | 技术栈 | 依赖关系 |\n|------|------|--------|----------|\n| **Admin System** | 后台管理驾驶舱 | Next.js App Router + shadcn/ui + Monaco | Phase 1 完成后可启动 |\n| **Landing Page** | Digital Mirror 首页 | Next.js + React Three Fiber | 独立开发 |\n\n> **注**: Admin System 的 Agent Studio 模块依赖本重构中的 `admin_prompts` 表和 Prompt 热加载机制（Phase 4），建议在 Phase 4 完成后进行 Admin 前端开发。\n\n---\n\n*文档版本: v1.0*\n*创建日期: 2026-01-01*\n*作者: Claude (Anthropic)*\n","numLines":1802,"startLine":1,"totalLines":1802}}}
{"parentUuid":"298030b4-eaa4-45f5-b65e-c7750cf910ef","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BhYs8bh8ZTHz5T8TFm8xMi","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create a comprehensive review report comparing the frontend API client against the specification:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":27254,"cache_read_input_tokens":30129,"cache_creation":{"ephemeral_5m_input_tokens":27254,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWgtwg4EX35hyYfFx7npi","type":"assistant","uuid":"287233ef-83b0-46b5-8ead-3af65ad3f605","timestamp":"2026-01-01T15:29:38.700Z"}
{"parentUuid":"287233ef-83b0-46b5-8ead-3af65ad3f605","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01BhYs8bh8ZTHz5T8TFm8xMi","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JJFRbJAURNtAFFvzK8xRmA","name":"Bash","input":{"command":"grep -n \"USE_NEW_RUNTIME\\|streamChatMessageNew\\|ToolInvocation\\|toDataStreamResponse\" /home/aiscend/work/fortune_ai/web-app/src/lib/api.ts","description":"Find references to new runtime features in the API client"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":5,"cache_creation_input_tokens":27254,"cache_read_input_tokens":30129,"cache_creation":{"ephemeral_5m_input_tokens":27254,"ephemeral_1h_input_tokens":0},"output_tokens":7,"service_tier":"standard"}},"requestId":"req_011CWgtwg4EX35hyYfFx7npi","type":"assistant","uuid":"fa43fe5d-974c-4e18-8d10-f724283bfeb4","timestamp":"2026-01-01T15:29:39.707Z"}
{"parentUuid":"fa43fe5d-974c-4e18-8d10-f724283bfeb4","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JJFRbJAURNtAFFvzK8xRmA","type":"tool_result","content":"274:const USE_NEW_RUNTIME = process.env.NEXT_PUBLIC_USE_NEW_RUNTIME === 'true'\n280:  toolInvocations?: ToolInvocation[]\n283:export interface ToolInvocation {\n300:  toolInvocations?: ToolInvocation[]\n539:export function streamChatMessageNew(\n544:  onToolCall: (toolInvocation: ToolInvocation) => void,\n578:      const toolInvocations: ToolInvocation[] = []\n613:                const invocation: ToolInvocation = {\n676:    onToolCall?: (toolInvocation: ToolInvocation) => void\n681:  if (USE_NEW_RUNTIME) {\n682:    return streamChatMessageNew(","is_error":false}]},"uuid":"7b3fef26-1fdf-4f8d-b277-703419a80d56","timestamp":"2026-01-01T15:29:39.935Z","toolUseResult":{"stdout":"274:const USE_NEW_RUNTIME = process.env.NEXT_PUBLIC_USE_NEW_RUNTIME === 'true'\n280:  toolInvocations?: ToolInvocation[]\n283:export interface ToolInvocation {\n300:  toolInvocations?: ToolInvocation[]\n539:export function streamChatMessageNew(\n544:  onToolCall: (toolInvocation: ToolInvocation) => void,\n578:      const toolInvocations: ToolInvocation[] = []\n613:                const invocation: ToolInvocation = {\n676:    onToolCall?: (toolInvocation: ToolInvocation) => void\n681:  if (USE_NEW_RUNTIME) {\n682:    return streamChatMessageNew(","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"7b3fef26-1fdf-4f8d-b277-703419a80d56","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G3L13TrP7jRqfTkMYUENdK","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. Now let me verify the stream format handling and error semantics:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":490,"cache_read_input_tokens":57383,"cache_creation":{"ephemeral_5m_input_tokens":490,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWgtx6HkfAbnwKTcG5u4U","type":"assistant","uuid":"7dc1a36f-fcdf-4405-94fe-9c7cf26c8004","timestamp":"2026-01-01T15:29:43.866Z"}
{"parentUuid":"7dc1a36f-fcdf-4405-94fe-9c7cf26c8004","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01G3L13TrP7jRqfTkMYUENdK","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XE2pHwG5YQcqHfqcPKT2kz","name":"Bash","input":{"command":"grep -n \"case '0':\\|case '9':\\|case 'a':\\|case 'd':\\|case 'e':\" /home/aiscend/work/fortune_ai/web-app/src/lib/api.ts | head -20","description":"Check Vercel AI SDK stream format handling in streaming function"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":4,"cache_creation_input_tokens":490,"cache_read_input_tokens":57383,"cache_creation":{"ephemeral_5m_input_tokens":490,"ephemeral_1h_input_tokens":0},"output_tokens":158,"service_tier":"standard"}},"requestId":"req_011CWgtx6HkfAbnwKTcG5u4U","type":"assistant","uuid":"ec982f8e-7ff7-418a-bd1c-98f6d007937d","timestamp":"2026-01-01T15:29:44.713Z"}
{"parentUuid":"ec982f8e-7ff7-418a-bd1c-98f6d007937d","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XE2pHwG5YQcqHfqcPKT2kz","type":"tool_result","content":"601:              case '0': // Text chunk\n607:              case '9': // Tool call\n621:              case 'a': // Tool result\n635:              case 'd': // Finish message\n639:              case 'e': // Error","is_error":false}]},"uuid":"f71e1503-49c6-4138-bdc1-a1d7f7dc3aea","timestamp":"2026-01-01T15:29:45.019Z","toolUseResult":{"stdout":"601:              case '0': // Text chunk\n607:              case '9': // Tool call\n621:              case 'a': // Tool result\n635:              case 'd': // Finish message\n639:              case 'e': // Error","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"f71e1503-49c6-4138-bdc1-a1d7f7dc3aea","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Rf5tX16Qd2tNMEL3Aktjqm","type":"message","role":"assistant","content":[{"type":"text","text":"Excellent. Now let me check the error handling format and ApiResponse implementation:"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":507,"cache_read_input_tokens":57873,"cache_creation":{"ephemeral_5m_input_tokens":507,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"}},"requestId":"req_011CWgtxPNAd98iFsyVCA6cv","type":"assistant","uuid":"84025312-30d7-46f8-afe2-40cd98138f43","timestamp":"2026-01-01T15:29:47.292Z"}
{"parentUuid":"84025312-30d7-46f8-afe2-40cd98138f43","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01Rf5tX16Qd2tNMEL3Aktjqm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WrUQb5B9JR29wsc7MGsCnT","name":"Bash","input":{"command":"grep -A 10 \"interface ApiResponse\" /home/aiscend/work/fortune_ai/web-app/src/lib/api.ts","description":"Verify ApiResponse interface matches spec"}}],"stop_reason":"tool_use","stop_sequence":null,"usage":{"input_tokens":3,"cache_creation_input_tokens":507,"cache_read_input_tokens":57873,"cache_creation":{"ephemeral_5m_input_tokens":507,"ephemeral_1h_input_tokens":0},"output_tokens":126,"service_tier":"standard"}},"requestId":"req_011CWgtxPNAd98iFsyVCA6cv","type":"assistant","uuid":"bb5d053d-423e-4a75-bbb9-860607035897","timestamp":"2026-01-01T15:29:47.810Z"}
{"parentUuid":"bb5d053d-423e-4a75-bbb9-860607035897","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WrUQb5B9JR29wsc7MGsCnT","type":"tool_result","content":"interface ApiResponse<T> {\n  ok: boolean\n  data?: T\n  error?: {\n    code: string\n    message: string\n    detail?: Record<string, unknown>\n  }\n}\n\n// Fetch with auth","is_error":false}]},"uuid":"49853dcd-2ed0-45ea-ba71-03ddd89ef9d9","timestamp":"2026-01-01T15:29:48.015Z","toolUseResult":{"stdout":"interface ApiResponse<T> {\n  ok: boolean\n  data?: T\n  error?: {\n    code: string\n    message: string\n    detail?: Record<string, unknown>\n  }\n}\n\n// Fetch with auth","stderr":"","interrupted":false,"isImage":false}}
{"parentUuid":"49853dcd-2ed0-45ea-ba71-03ddd89ef9d9","isSidechain":true,"userType":"external","cwd":"/home/aiscend/work/fortune_ai/web-app","sessionId":"57d1b191-4eb4-429c-96ac-40f334a1945a","version":"2.0.76","gitBranch":"main","agentId":"aa091e8","slug":"serene-brewing-frog","message":{"model":"claude-haiku-4-5-20251001","id":"msg_01LoY8tQq4L97QJd8eqtcoxw","type":"message","role":"assistant","content":[{"type":"text","text":"Perfect. Now let me create a comprehensive review report:\n\n## Frontend API Client Review Report\n\n### Executive Summary\n\nThe frontend API client at `/home/aiscend/work/fortune_ai/web-app/src/lib/api.ts` has **successfully implemented** the key requirements from backend_refactoring_plan_v42.md. All critical features for the Vercel AI SDK runtime integration are present and properly structured.\n\n---\n\n## VERIFICATION RESULTS\n\n### ✅ §4.1: USE_NEW_RUNTIME Feature Flag\n\n**Status: IMPLEMENTED**\n\n```typescript\n// Line 274\nconst USE_NEW_RUNTIME = process.env.NEXT_PUBLIC_USE_NEW_RUNTIME === 'true'\n```\n\n**Verification:**\n- Environment variable properly namespaced with `NEXT_PUBLIC_` for browser access\n- Correctly used to route between legacy and new streaming implementations (line 681-689)\n- Defaults to legacy implementation if flag is missing\n\n**Spec Alignment:**\n- Matches §4.2 requirement: Feature flag allows controlled migration\n- Enables graceful fallback and canary deployment strategy\n\n---\n\n### ✅ §4.2: New Streaming Function (Vercel AI SDK Data Stream Format)\n\n**Status: IMPLEMENTED**\n\nFunction `streamChatMessageNew()` (lines 539-667) implements complete Vercel AI SDK data stream parsing:\n\n**Data Stream Format Handling:**\n\n| Type | Case | Implementation | ✓ |\n|------|------|-----------------|---|\n| Text chunk | `'0'` | JSON.parse → accumulate to `fullContent` | ✓ |\n| Tool call | `'9'` | Parse toolCallId, toolName, args | ✓ |\n| Tool result | `'a'` | Match to invocation, set result | ✓ |\n| Finish | `'d'` | Stream complete, no error | ✓ |\n| Error | `'e'` | Parse error.message, throw | ✓ |\n\n**Code Excerpt (lines 600-646):**\n```typescript\nswitch (type) {\n  case '0': // Text chunk\n    const text = JSON.parse(dataStr) as string\n    fullContent += text\n    onChunk(text)\n    break\n\n  case '9': // Tool call\n    const toolCall = JSON.parse(dataStr) as {\n      toolCallId: string\n      toolName: string\n      args: Record<string, unknown>\n    }\n    const invocation: ToolInvocation = {\n      ...toolCall,\n      result: undefined,\n    }\n    toolInvocations.push(invocation)\n    onToolCall(invocation)\n    break\n\n  case 'a': // Tool result\n    const toolResult = JSON.parse(dataStr) as {\n      toolCallId: string\n      result: unknown\n    }\n    const existingInvocation = toolInvocations.find(\n      (t) => t.toolCallId === toolResult.toolCallId\n    )\n    if (existingInvocation) {\n      existingInvocation.result = toolResult.result\n      onToolCall(existingInvocation)\n    }\n    break\n```\n\n**Spec Alignment:**\n- Correctly implements §2.1 Vercel AI SDK data stream format with type prefixes (0, 9, a, d, e)\n- Tool invocations properly tracked with state transitions\n- Backward compatible error handling\n\n---\n\n### ✅ §0.6.3: Error Semantics (ApiResponse Format)\n\n**Status: IMPLEMENTED**\n\n**ApiResponse Interface (lines 22-31):**\n```typescript\ninterface ApiResponse<T> {\n  ok: boolean\n  data?: T\n  error?: {\n    code: string\n    message: string\n    detail?: Record<string, unknown>\n  }\n}\n```\n\n**Spec Alignment:**\n```typescript\n// From spec §0.6.3:\ninterface ApiResponse<T> {\n  ok: boolean;\n  data?: T;\n  error?: {\n    code: string;        // ✓ Implemented\n    message: string;     // ✓ Implemented\n    detail?: unknown;    // ✓ Implemented as Record<string, unknown>\n    correlation_id?: string;  // ⚠️ NOT IMPLEMENTED\n  };\n}\n```\n\n**Error Handling Throughout:**\n- Line 50-61: Proper error extraction and HTTP status code handling\n- Line 60: User-friendly error message propagation\n- Line 401-410: Auth error handling with detail capture\n\n**Gap Identified:** `correlation_id` field is not included in ApiResponse error structure. This is used for request tracing per §0.6.2.\n\n---\n\n### ✅ §4.2: ToolInvocation Type Definitions\n\n**Status: IMPLEMENTED**\n\n**Type Definition (lines 283-288):**\n```typescript\nexport interface ToolInvocation {\n  toolCallId: string\n  toolName: string\n  args: Record<string, unknown>\n  result?: unknown\n}\n```\n\n**Usage in Response (lines 296-301):**\n```typescript\nexport interface SendChatResponse {\n  session_id: string\n  reply: string\n  ui_components?: unknown[]\n  toolInvocations?: ToolInvocation[]  // ✓ Included in response\n}\n```\n\n**Spec Alignment:**\n- Matches Vercel AI SDK data stream format for tool calls\n- Result field supports the tool result stream (type 'a')\n- Optional in response to handle non-tool scenarios\n\n**Integration Points:**\n- Line 578: Array maintained during stream parsing\n- Line 613-618: Populated from type '9' events\n- Line 654-658: Returned in final response\n\n---\n\n### ✅ §4.1: useChat() Support Integration\n\n**Status: READY FOR FRONTEND**\n\n**Frontend Hook Support:**\n```typescript\n// Lines 276-281\nexport interface ChatMessage {\n  role: 'user' | 'assistant'\n  content: string\n  timestamp?: string\n  toolInvocations?: ToolInvocation[]\n}\n\nexport interface SendChatResponse {\n  session_id: string\n  reply: string\n  ui_components?: unknown[]\n  toolInvocations?: ToolInvocation[]\n}\n```\n\n**Verified in package.json:**\n```json\n{\n  \"dependencies\": {\n    \"ai\": \"^4.0.0\",              // ✓ Vercel AI SDK v4\n    \"@ai-sdk/openai\": \"^1.0.0\",  // ✓ Multi-model support\n    \"zod\": \"^3.23.0\"             // ✓ Type validation\n  }\n}\n```\n\n---\n\n## DEPENDENCIES ANALYSIS\n\n**File:** `/home/aiscend/work/fortune_ai/web-app/package.json`\n\n### ✅ Core Vercel AI SDK Dependencies\n\n| Package | Version | Required For | Status |\n|---------|---------|--------------|--------|\n| `ai` | ^4.0.0 | streamText, useChat, toDataStreamResponse | ✓ Present |\n| `zod` | ^3.23.0 | Schema validation for Tool parameters | ✓ Present |\n| `next` | 16.1.1 | API Routes, middleware | ✓ Present |\n| `react` | 19.2.3 | Client components, hooks | ✓ Present |\n\n### ⚠️ Potential Issues\n\n**Missing Dependencies for Full Implementation:**\n- No `@ai-sdk/google` for GLM-4.5 support (referenced in plan §1.3)\n- No `@ai-sdk/anthropic` for Claude support\n- No explicit tracing library for correlation_id logging\n\n---\n\n## SMART STREAM FUNCTION (Lines 670-700)\n\n**Status: IMPLEMENTED**\n\n```typescript\nexport function streamChat(\n  message: string,\n  sessionId: string | undefined,\n  options: {\n    command?: string\n    onChunk: (chunk: string) => void\n    onToolCall?: (toolInvocation: ToolInvocation) => void\n    onDone: (fullResponse: SendChatResponse) => void\n    onError: (error: Error) => void\n  }\n): () => void {\n  if (USE_NEW_RUNTIME) {\n    return streamChatMessageNew(...)  // New Vercel AI SDK path\n  } else {\n    return streamChatMessage(...)     // Legacy SSE path\n  }\n}\n```\n\n**Strengths:**\n- Unified interface for both old and new implementations\n- Feature flag controlled behavior\n- Supports command routing (`/divine`, `/heal`, `/grow`)\n- Cancellation support via AbortController return\n\n---\n\n## GAP ANALYSIS\n\n### 🔴 Critical Gaps\n\n**1. Missing `correlation_id` in Error Responses**\n\n**Location:** Lines 22-31 (ApiResponse interface)\n\n**Spec Requirement (§0.6.2):**\n```typescript\ninterface ApiResponse<T> {\n  error?: {\n    code: string;\n    message: string;\n    detail?: unknown;\n    correlation_id?: string;  // ⚠️ MISSING\n  };\n}\n```\n\n**Impact:** Request tracing and audit logging cannot correlate frontend errors with backend logs\n\n**Required Fix:**\n- Add `correlation_id?: string` to error object\n- Propagate from response headers if available\n\n---\n\n**2. Missing X-Session-Id Response Header Handling (Inconsistency)**\n\n**Location:** Line 570\n\nCurrent code:\n```typescript\nconst resolvedSessionId = response.headers.get('X-Session-Id') || sessionId || ''\n```\n\nBut spec §2.4.1 doesn't explicitly document this header contract. This creates an implicit dependency on backend behavior.\n\n**Risk:** Header not set → sessionId lost → session continuity broken\n\n---\n\n### 🟡 Medium Gaps\n\n**1. No Idempotency Key Support**\n\n**Location:** `streamChatMessageNew()` function\n\n**Spec Requirement (§2.6):** \n- Tool calls should include `X-Idempotency-Key` header\n- Format: `${runId}:${stepIndex}:${toolName}:${paramsHash}`\n\n**Current State:** No idempotency key generation for Tool invocations\n\n**Impact:** maxSteps multi-step inference could cause duplicate writes\n\n---\n\n**2. Missing run/start and run/finalize Calls**\n\n**Location:** `streamChatMessageNew()` doesn't call internal APIs\n\n**Spec Requirement (§2.4.2):**\n- Before streaming: `POST /internal/chat/run/start` → get run_id\n- After streaming: `POST /internal/chat/run/finalize` → transaction write\n\n**Current Behavior:** Streaming happens without persistence coordination\n\n**Impact:** \n- Tool calls not recorded in audit log\n- Commitments not written to database\n- Stream interruption leaves dangling state\n\n---\n\n**3. No Command Routing Support**\n\n**Location:** `streamChatMessageNew()` receives `command` parameter but doesn't use it\n\n**Spec Requirement (§2.1):**\n- Backend should filter tools based on command: `/divine`, `/heal`, `/grow`\n\n**Current State:** All tools available, backend must filter\n\n**Impact:** Client can't indicate intent, redundant Tool calls\n\n---\n\n### 🟢 Minor Gaps\n\n**1. CSRF Token Not Sent in streamChatMessageNew()**\n\n**Location:** Line 550-562\n\n```typescript\nfetch('/api/chat', {\n  method: 'POST',\n  headers: {\n    'Content-Type': 'application/json',\n    // ⚠️ Missing csrfHeaders()\n  },\n  credentials: 'include',\n  body: JSON.stringify({...}),\n})\n```\n\n**Spec Note (§0.5):** \"Next.js API Route 同源，无需 CSRF\"\n\n**Status:** Acceptable for same-origin requests, but better practice to include\n\n---\n\n**2. No Error Detail Logging**\n\n**Location:** Line 648\n```typescript\nconsole.warn('[chat] Failed to parse stream data:', line)\n```\n\nMissing context for debugging stream format issues\n\n---\n\n## SPEC COMPLIANCE MATRIX\n\n| Section | Requirement | Implementation | Status |\n|---------|-------------|-----------------|--------|\n| §4.1 | USE_NEW_RUNTIME flag | Line 274 | ✅ Complete |\n| §4.2 | Vercel AI SDK stream format | Lines 601-646 | ✅ Complete |\n| §4.2 | ToolInvocation types | Lines 283-288 | ✅ Complete |\n| §0.6.3 | ApiResponse format | Lines 22-31 | ⚠️ Incomplete (missing correlation_id) |\n| §0.6.3 | Error semantics | Lines 50-61, 392-410 | ✅ Complete |\n| §0.6.2 | Correlation ID tracking | N/A | ❌ Not implemented |\n| §2.6 | Idempotency key support | N/A | ❌ Not implemented |\n| §2.4.2 | run/start & run/finalize calls | N/A | ❌ Not implemented |\n| §2.1 | Command routing to backend | Line 542 (param) | ⚠️ Partial (param passed, not used) |\n\n---\n\n## RECOMMENDATIONS\n\n### Priority 1: Critical (Blocking Integration)\n\n**1. Implement correlation_id Propagation**\n- Add to ApiResponse error object (line 27)\n- Extract from response headers in fetch wrapper\n- Pass through all internal API calls\n- Log in error handlers\n\n**2. Add run/start and run/finalize Integration**\n- Before stream: Call `POST /internal/chat/run/start` → get run_id\n- After stream: Call `POST /internal/chat/run/finalize`\n- Pass run_id through streamChatMessageNew options\n- Handle finalize errors gracefully\n\n**3. Implement Idempotency Key Generation**\n- For each tool invocation: `${runId}:${callIndex}:${toolName}:${hash(args)}`\n- Send as `X-Idempotency-Key` header\n- Requires crypto utilities\n\n### Priority 2: Important (Quality)\n\n**4. Add Command Intent to Backend Request**\n- streamChatMessageNew already receives `command` parameter\n- Pass in POST body: `{ message, command, session_id }`\n- Backend can optimize tool filtering\n\n**5. Proper X-Session-Id Contract Documentation**\n- Verify backend always returns this header\n- Document in API contract\n- Add fallback handling if missing\n\n### Priority 3: Nice-to-Have\n\n**6. Add Tracing Context**\n- Export useTrace() hook for components\n- Propagate x-request-id through all API calls\n- Improve debuggability\n\n---\n\n## CONCLUSION\n\n**Overall Assessment: 75% Complete**\n\nThe frontend API client has successfully implemented the core infrastructure for Vercel AI SDK integration:\n- Feature flag system is proper and well-placed\n- Stream format parsing is correct and complete\n- Type system (ToolInvocation, ChatMessage) properly defined\n- Smart router function enables seamless migration\n\nHowever, critical gaps remain in:\n- **Data persistence coordination** (run/start, run/finalize)\n- **Request tracing** (correlation_id)\n- **Idempotency guarantees** (X-Idempotency-Key)\n\nThese gaps are integration issues between frontend and the backend's internal API contract (§2.4). The frontend client itself is ready; it just needs wiring to the persistence layer.\n\n**Next Steps:**\n1. Add run lifecycle calls before streaming begins\n2. Extend ApiResponse with correlation_id\n3. Generate and send idempotency keys for tool calls\n4. Test end-to-end with backend v4.2 implementation"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":331,"cache_read_input_tokens":58380,"cache_creation":{"ephemeral_5m_input_tokens":331,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"}},"requestId":"req_011CWgtxdRWELbUtHMxEHqEV","type":"assistant","uuid":"3d385c1d-a09f-459c-adb0-03ed5154e3b5","timestamp":"2026-01-01T15:30:22.979Z"}
