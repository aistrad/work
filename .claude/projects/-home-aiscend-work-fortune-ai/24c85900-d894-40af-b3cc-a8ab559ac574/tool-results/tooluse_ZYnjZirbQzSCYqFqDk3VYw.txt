     1→"""
     2→太华派铁板神数引擎
     3→
     4→实现密传正统太华派铁板神数秘解中的完整算法流程:
     5→1. 先天命数 = (月命数 + 3 - 时命数) mod 12
     6→2. 五音命数 = 五音配数[lookup(先天命数, 年干)]
     7→3. 日命数 = lookup(日柱纳音五行, 求测时辰天干)
     8→4. 时运数 = lookup(求测时辰纳音五行)
     9→5. 考刻判断: 阳男阴女/阴男阳女 + 日命数+时运数是否>6
    10→6. 本命数 = (五音命数×5 + 日命数 + 时运数 - offset) × 30 + 农历日
    11→7. 十二辟卦 = lookup(本命数, 刻类型)
    12→8. 本命条文 = 辟卦基数 + 序数 + 预测项目数
    13→"""
    14→
    15→import json
    16→import os
    17→from typing import Dict, Any, List, Tuple, Optional
    18→
    19→from common.logging import get_logger
    20→
    21→logger = get_logger(__name__)
    22→
    23→# 加载数据表
    24→_DATA_PATH = os.path.join(os.path.dirname(__file__), "..", "..", "docs", "tieban", "taihua_data_tables.json")
    25→
    26→
    27→def _load_taihua_tables() -> Dict[str, Any]:
    28→    """加载太华派数据表"""
    29→    if not os.path.exists(_DATA_PATH):
    30→        raise FileNotFoundError(f"太华派数据表未找到: {_DATA_PATH}")
    31→    with open(_DATA_PATH, "r", encoding="utf-8") as f:
    32→        return json.load(f)
    33→
    34→
    35→# 缓存数据表
    36→_TABLES: Optional[Dict[str, Any]] = None
    37→
    38→
    39→def _get_tables() -> Dict[str, Any]:
    40→    global _TABLES
    41→    if _TABLES is None:
    42→        _TABLES = _load_taihua_tables()
    43→    return _TABLES
    44→
    45→
    46→# 常量
    47→HOUR_BRANCH_NUMBER = {
    48→    "子": 1, "丑": 2, "寅": 3, "卯": 4, "辰": 5, "巳": 6,
    49→    "午": 7, "未": 8, "申": 9, "酉": 10, "戌": 11, "亥": 12
    50→}
    51→
    52→WUYIN_VALUE = {"宫": 5, "商": 4, "角": 3, "徵": 2, "羽": 1}
    53→
    54→YANG_STEMS = {"甲", "丙", "戊", "庚", "壬"}
    55→
    56→
    57→def _split_pillar(pillar: str) -> Tuple[str, str]:
    58→    """拆分干支柱"""
    59→    if not pillar or len(pillar) < 2:
    60→        raise ValueError(f"无效的干支: {pillar}")
    61→    return pillar[0], pillar[1]
    62→
    63→
    64→def _is_yang_stem(stem: str) -> bool:
    65→    """判断天干是否为阳干"""
    66→    return stem in YANG_STEMS
    67→
    68→
    69→def _normalize_gender(gender: Optional[str]) -> str:
    70→    """标准化性别"""
    71→    if not gender:
    72→        return "male"
    73→    g = str(gender).strip().lower()
    74→    if g in ("m", "male", "man", "boy", "男", "阳男", "乾"):
    75→        return "male"
    76→    if g in ("f", "female", "woman", "girl", "女", "阴女", "坤"):
    77→        return "female"
    78→    return "male"
    79→
    80→
    81→def compute_xiantian_mingshu(lunar_month: int, hour_branch: str) -> int:
    82→    """
    83→    计算先天命数
    84→
    85→    公式: 先天命数 = 月命数 + 3 - 时命数
    86→    - 月命数: 农历月份 (1-12)
    87→    - 时命数: 时支对应数 (子=1, 丑=2, ..., 亥=12)
    88→
    89→    结果范围: 1-12 (负数+12, 0变12)
    90→    """
    91→    if hour_branch not in HOUR_BRANCH_NUMBER:
    92→        raise ValueError(f"无效的时支: {hour_branch}")
    93→
    94→    month_num = lunar_month
    95→    hour_num = HOUR_BRANCH_NUMBER[hour_branch]
    96→
    97→    result = month_num + 3 - hour_num
    98→
    99→    # 处理边界情况
   100→    while result <= 0:

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
