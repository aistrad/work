     1→# Mentis OS v3.0 全新构建计划
     2→
     3→> **核心决策:** 在 `/home/aiscend/work/mentis` 目录下**彻底独立重建** Mentis OS 项目，使用独立的 `mentis` 数据库；`fortune_ai` 项目**完整保留**，后续可作为参考或数据迁移源。
     4→
     5→---
     6→
     7→## 0. 一句话目标
     8→
     9→构建一个全新的 **Stream-Centric Agentic Personal OS**：
    10→**"Life is a Stream, not a Dashboard."** —— 生活流成为输入，进化成为输出；Dashboard 退居背景，Agent 主动干预成为灵魂。
    11→
    12→---
    13→
    14→## 1. 项目边界与决策
    15→
    16→| 决策项 | 选择 |
    17→|--------|------|
    18→| 项目位置 | `/home/aiscend/work/mentis` (全新独立) |
    19→| 数据库 | `mentis` (全新独立 PostgreSQL DB) |
    20→| fortune_ai | **完整保留**，不做任何修改 |
    21→| 规格对齐 | **严格对齐** Mentis OS v3.0 规格文档 |
    22→| 主 Runtime | **Next.js API Routes** (Vercel AI SDK) |
    23→| 向量存储 | **Pinecone** (DB 只存 embedding_id) |
    24→| LLM 主力 | **GLM-4** (国内优先) + 多模型降级 |
    25→
    26→---
    27→
    28→## 2. 三层交互模型 (Mentis OS 核心不可变)
    29→
    30→### Layer 1: THE STREAM (核心交互区，90% 时间)
    31→- **Vibe Diary**（碎碎念/情绪日记）是最高频入口
    32→- **Action Cards** 与 Chat 都"融入流中"
    33→- 每次输入必须产生**即时微反馈**：AI Tag / 能量变化 / Aura 变化
    34→
    35→### Layer 2: THE HUD (Ambient HUD，环境感知层)
    36→- Dashboard 不再是独立页面，而是**围绕 Stream 的背景环境层**
    37→- 常态隐形，以 Dynamic Aura、边缘微光、数字浮动等方式被动呈现
    38→- 仅在状态剧烈变化或用户呼出时显现
    39→
    40→### Layer 3: THE INTERVENTION (主动干预层)
    41→- Agent 不等待提问，基于 Stream + 模块数据 + 时间节点主动插入 Action Cards
    42→- 触发条件：时间节点 / 情绪阈值 / 能量变化 / 行为模式 / 运势窗口
    43→
    44→---
    45→
    46→## 3. 项目结构 (全新构建)
    47→
    48→```
    49→/home/aiscend/work/mentis/
    50→├── apps/
    51→│   └── web/                          # Next.js 16 (App Router)
    52→│       ├── src/
    53→│       │   ├── app/
    54→│       │   │   ├── (stream)/         # Stream 主页面
    55→│       │   │   │   ├── page.tsx      # StreamFeed + MagicInput + HUD
    56→│       │   │   │   └── layout.tsx
    57→│       │   │   ├── api/v3/           # Mentis v3 API (主 Runtime)
    58→│       │   │   │   ├── auth/         # JWT 认证
    59→│       │   │   │   ├── stream/       # POST (SSE) / GET
    60→│       │   │   │   ├── decode/       # BaZi/ZiWei/Fortune
    61→│       │   │   │   ├── evolve/       # Tasks/Checkin/Momentum
    62→│       │   │   │   └── user/         # Profile/State
    63→│       │   │   └── (landing)/        # 落地页
    64→│       │   ├── components/
    65→│       │   │   ├── stream/           # StreamFeed, StreamCard, MagicInput
    66→│       │   │   ├── hud/              # DynamicAura, TopStatusBar
    67→│       │   │   ├── intervention/     # ActionCard (Suggestion/Confirmation/Insight/Milestone)
    68→│       │   │   └── ui/               # Radix + shadcn/ui
    69→│       │   ├── lib/
    70→│       │   │   ├── mentis/           # 核心引擎
    71→│       │   │   │   ├── stream-processor.ts
    72→│       │   │   │   ├── emotion-engine.ts
    73→│       │   │   │   ├── behavior-matcher.ts
    74→│       │   │   │   └── intervention-agent.ts
    75→│       │   │   ├── db/               # Drizzle ORM
    76→│       │   │   │   ├── schema.ts
    77→│       │   │   │   └── client.ts
    78→│       │   │   ├── vector/           # Pinecone 客户端
    79→│       │   │   └── llm/              # 多模型路由
    80→│       │   └── stores/               # Zustand
    81→│       │       └── mentis-store.ts
    82→│       ├── drizzle/                  # Drizzle Migrations
    83→│       ├── public/
    84→│       └── package.json
    85→├── packages/
    86→│   ├── decode-modules/               # DECODE 层模块
    87→│   │   ├── bazi/                     # 八字 (可从 fortune_ai 迁移算法)
    88→│   │   └── ziwei/                    # 紫微斗数
    89→│   ├── reframe-modules/              # REFRAME 层模块
    90→│   │   ├── cbt/                      # 认知行为疗法
    91→│   │   └── act/                      # 接纳承诺疗法
    92→│   └── evolve-modules/               # EVOLVE 层模块
    93→│       ├── habit/                    # 习惯系统
    94→│       └── momentum/                 # 动量系统
    95→├── docs/
    96→│   └── specs/                        # 规格文档
    97→├── .env.example
    98→├── package.json                      # Monorepo root (pnpm workspace)
    99→├── pnpm-workspace.yaml
   100→└── turbo.json                        # Turborepo 配置
   101→```
   102→
   103→---
   104→
   105→## 4. 数据模型 (严格对齐 Mentis OS 规格)
   106→
   107→### 4.1 核心实体命名 (规格强制)
   108→
   109→| Mentis OS 规格实体 | 用途 |
   110→|-------------------|------|
   111→| `mentis_user` | 用户主表 |
   112→| `user_profile` | 用户档案 (生辰/命盘缓存/MBTI/偏好/通知设置) |
   113→| `user_state` | 用户实时状态 (energy/momentum/streak/mood/aura) |
   114→| `stream_entry` | Stream 条目 (Vibe Diary/Chat/Action Log) |
   115→| `action_task` | 任务卡片 (Suggestion/Confirmation/Insight/Milestone) |
   116→| `checkin_log` | 行为打卡日志 |
   117→| `insight_record` | 洞察沉淀 (Weekly Mirror/Pattern/Fortune) |
   118→
   119→### 4.2 数据库 Schema (Drizzle ORM)
   120→
   121→```typescript
   122→// apps/web/src/lib/db/schema.ts
   123→import { pgTable, uuid, text, integer, timestamp, jsonb, varchar, decimal, date, boolean } from 'drizzle-orm/pg-core';
   124→
   125→// ═══════════════════════════════════════════════════════════════
   126→// mentis_user - 用户主表
   127→// ═══════════════════════════════════════════════════════════════
   128→export const mentisUser = pgTable('mentis_user', {
   129→  id: uuid('id').primaryKey().defaultRandom(),
   130→  email: varchar('email', { length: 255 }).notNull().unique(),
   131→  name: varchar('name', { length: 100 }),
   132→  tier: varchar('tier', { length: 20 }).notNull().default('free'), // free/pro/premium
   133→  createdAt: timestamp('created_at').defaultNow(),
   134→  updatedAt: timestamp('updated_at').defaultNow(),
   135→});
   136→
   137→// ═══════════════════════════════════════════════════════════════
   138→// user_profile - 用户档案
   139→// ═══════════════════════════════════════════════════════════════
   140→export const userProfile = pgTable('user_profile', {
   141→  userId: uuid('user_id').primaryKey().references(() => mentisUser.id),
   142→  birthTime: timestamp('birth_time'),              // 生辰
   143→  birthLocation: jsonb('birth_location'),          // {lat, lng, timezone}
   144→  baziData: jsonb('bazi_data'),                    // 八字缓存
   145→  ziweiData: jsonb('ziwei_data'),                  // 紫微缓存
   146→  mbtiType: varchar('mbti_type', { length: 4 }),
   147→  jungArchetype: varchar('jung_archetype', { length: 50 }),
   148→  preferences: jsonb('preferences').default({}),
   149→  notificationSettings: jsonb('notification_settings').default({}),
   150→  createdAt: timestamp('created_at').defaultNow(),
   151→  updatedAt: timestamp('updated_at').defaultNow(),
   152→});
   153→
   154→// ═══════════════════════════════════════════════════════════════
   155→// user_state - 用户实时状态
   156→// ═══════════════════════════════════════════════════════════════
   157→export const userState = pgTable('user_state', {
   158→  userId: uuid('user_id').primaryKey().references(() => mentisUser.id),
   159→  energyScore: integer('energy_score').notNull().default(50),    // 0-100
   160→  momentum: integer('momentum').notNull().default(0),
   161→  streakDays: integer('streak_days').notNull().default(0),
   162→  currentMood: jsonb('current_mood'),               // {primary, intensity, detected_at}
   163→  auraState: varchar('aura_state', { length: 20 }).default('calm'), // calm/alert/happy/anxious/flow
   164→  todayStats: jsonb('today_stats').default({}),
   165→  lastActiveAt: timestamp('last_active_at').defaultNow(),
   166→  updatedAt: timestamp('updated_at').defaultNow(),
   167→});
   168→
   169→// ═══════════════════════════════════════════════════════════════
   170→// stream_entry - Stream 条目
   171→// ═══════════════════════════════════════════════════════════════
   172→export const streamEntry = pgTable('stream_entry', {
   173→  id: uuid('id').primaryKey().defaultRandom(),
   174→  userId: uuid('user_id').notNull().references(() => mentisUser.id),
   175→  type: varchar('type', { length: 20 }).notNull().default('vibe_diary'), // vibe_diary/chat/action_log
   176→  rawContent: text('raw_content').notNull(),
   177→  media: jsonb('media').default([]),               // [{type, url, transcription?}]
   178→
   179→  // 情绪提取结果
   180→  emotion: jsonb('emotion'),                        // {primary, intensity, secondary[], confidence}
   181→  context: jsonb('context'),                        // {scene, trigger, target, time_of_day}
   182→  tags: text('tags').array().default([]),
   183→  energyDelta: integer('energy_delta').default(0),
   184→
   185→  // 行为匹配
   186→  matchedBehavior: varchar('matched_behavior', { length: 50 }),
   187→  matchConfidence: decimal('match_confidence', { precision: 3, scale: 2 }),
   188→  autoCheckin: boolean('auto_checkin').default(false),
   189→
   190→  // 向量引用 (向量存 Pinecone，这里只存 ID)
   191→  embeddingId: varchar('embedding_id', { length: 100 }),
   192→
   193→  metadata: jsonb('metadata').default({}),
   194→  createdAt: timestamp('created_at').defaultNow(),
   195→  updatedAt: timestamp('updated_at').defaultNow(),
   196→});
   197→
   198→// ═══════════════════════════════════════════════════════════════
   199→// action_task - 任务卡片
   200→// ═══════════════════════════════════════════════════════════════
   201→export const actionTask = pgTable('action_task', {
   202→  id: uuid('id').primaryKey().defaultRandom(),
   203→  userId: uuid('user_id').notNull().references(() => mentisUser.id),
   204→  type: varchar('type', { length: 20 }).notNull(),  // suggestion/confirmation/insight/milestone
   205→  title: varchar('title', { length: 255 }).notNull(),
   206→  description: text('description'),
   207→  momentumReward: integer('momentum_reward').default(1),
   208→
   209→  status: varchar('status', { length: 20 }).default('pending'), // pending/completed/dismissed/expired
   210→  triggerType: varchar('trigger_type', { length: 20 }),         // time/state/behavior/fortune
   211→  triggerTime: timestamp('trigger_time'),
   212→  expiresAt: timestamp('expires_at'),
   213→
   214→  relatedStreamId: uuid('related_stream_id').references(() => streamEntry.id),
   215→  metadata: jsonb('metadata').default({}),
   216→  createdAt: timestamp('created_at').defaultNow(),
   217→  completedAt: timestamp('completed_at'),
   218→});
   219→
   220→// ═══════════════════════════════════════════════════════════════
   221→// checkin_log - 行为打卡日志
   222→// ═══════════════════════════════════════════════════════════════
   223→export const checkinLog = pgTable('checkin_log', {
   224→  id: uuid('id').primaryKey().defaultRandom(),
   225→  userId: uuid('user_id').notNull().references(() => mentisUser.id),
   226→  behaviorType: varchar('behavior_type', { length: 50 }).notNull(),
   227→  source: varchar('source', { length: 20 }).notNull(), // auto/manual/confirmation
   228→  momentumDelta: integer('momentum_delta').default(1),
   229→
   230→  relatedStreamId: uuid('related_stream_id').references(() => streamEntry.id),
   231→  relatedTaskId: uuid('related_task_id').references(() => actionTask.id),
   232→  metadata: jsonb('metadata').default({}),
   233→  createdAt: timestamp('created_at').defaultNow(),
   234→});
   235→
   236→// ═══════════════════════════════════════════════════════════════
   237→// insight_record - 洞察沉淀
   238→// ═══════════════════════════════════════════════════════════════
   239→export const insightRecord = pgTable('insight_record', {
   240→  id: uuid('id').primaryKey().defaultRandom(),
   241→  userId: uuid('user_id').notNull().references(() => mentisUser.id),
   242→  type: varchar('type', { length: 30 }).notNull(),  // weekly_mirror/pattern/fortune_insight/reflection
   243→  title: varchar('title', { length: 255 }),
   244→  content: text('content'),
   245→  data: jsonb('data'),                              // 结构化数据
   246→
   247→  periodStart: date('period_start'),
   248→  periodEnd: date('period_end'),
   249→  isRead: boolean('is_read').default(false),
   250→  createdAt: timestamp('created_at').defaultNow(),
   251→});
   252→
   253→// 索引
   254→// CREATE INDEX idx_stream_entry_user ON stream_entry(user_id, created_at DESC);
   255→// CREATE INDEX idx_action_task_user ON action_task(user_id, status, created_at DESC);
   256→// CREATE INDEX idx_checkin_log_user ON checkin_log(user_id, created_at DESC);
   257→```
   258→
   259→### 4.3 向量存储策略 (严格对齐规格)
   260→
   261→```
   262→Pinecone Namespaces:
   263→├── stream_embeddings     # Stream 条目向量
   264→├── behavior_library      # 行为库向量 (用于 NLU 匹配)
   265→└── knowledge_base        # 模块知识库向量
   266→
   267→PostgreSQL 只存引用:
   268→├── stream_entry.embedding_id  → Pinecone stream_embeddings
   269→└── 行为库元数据可选存 DB，向量必须在 Pinecone
   270→```
   271→
   272→---
   273→
   274→## 5. API 设计 (严格对齐 Mentis OS 规格)
   275→
   276→### 5.1 路由版本化
   277→
   278→```
   279→BASE URL: /api/v3
   280→
   281→PUBLIC:
   282→├── POST /auth/register
   283→├── POST /auth/login
   284→├── POST /auth/refresh
   285→└── POST /landing/quick-insight
   286→
   287→STREAM:
   288→├── POST /stream              → SSE 流式响应
   289→├── GET  /stream              → 历史列表
   290→├── GET  /stream/:id          → 单条详情
   291→└── DELETE /stream/:id        → 删除
   292→
   293→DECODE:
   294→├── POST /decode/bazi         → 八字计算
   295→├── POST /decode/ziwei        → 紫微计算
   296→├── GET  /decode/fortune/today
   297→└── GET  /decode/fortune/:date
   298→
   299→EVOLVE:
   300→├── GET  /tasks               → 待办列表
   301→├── POST /tasks/:id/complete
   302→├── POST /tasks/:id/dismiss
   303→├── POST /checkin             → 手动打卡
   304→└── GET  /momentum            → 动量历史
   305→
   306→USER:
   307→├── GET  /user/profile
   308→├── PUT  /user/profile
   309→├── GET  /user/state
   310→└── PUT  /user/preferences
   311→
   312→REALTIME:
   313→└── WS   /realtime            → WebSocket
   314→```
   315→
   316→### 5.2 `POST /v3/stream` SSE 事件契约 (规格强制)
   317→
   318→```typescript
   319→// apps/web/src/app/api/v3/stream/route.ts
   320→import { StreamingTextResponse } from 'ai';
   321→
   322→export async function POST(request: Request) {
   323→  const { content, type, media } = await request.json();
   324→  const userId = await getCurrentUserId(request);
   325→  const requestId = generateRequestId();
   326→
   327→  const encoder = new TextEncoder();
   328→  const stream = new ReadableStream({
   329→    async start(controller) {
   330→      const send = (event: string, data: any) => {
   331→        controller.enqueue(encoder.encode(`data: ${JSON.stringify({ event, data, request_id: requestId })}\n\n`));
   332→      };
   333→
   334→      try {
   335→        // Event 1: stream_created
   336→        const entry = await createStreamEntry(userId, { content, type, media });
   337→        send('stream_created', { id: entry.id, type, raw_content: content, created_at: entry.createdAt });
   338→
   339→        // Event 2: extraction_complete
   340→        const extraction = await extractEmotionAndContext(content);
   341→        await updateStreamEntry(entry.id, extraction);
   342→        send('extraction_complete', {
   343→          emotion: extraction.emotion,
   344→          context: extraction.context,
   345→          tags: extraction.tags,
   346→          energy_delta: extraction.energyDelta
   347→        });
   348→
   349→        // Event 3: state_update
   350→        const state = await updateUserState(userId, extraction.energyDelta, extraction.emotion);
   351→        send('state_update', {
   352→          energy_score: state.energyScore,
   353→          momentum: state.momentum,
   354→          aura_state: state.auraState
   355→        });
   356→
   357→        // Event 4: behavior_match (可选)
   358→        const match = await matchBehavior(content, userId);
   359→        if (match.matched) {
   360→          await recordCheckin(userId, match, entry.id);
   361→          send('behavior_match', {
   362→            matched: true,
   363→            behavior: match.behavior,
   364→            confidence: match.confidence,
   365→            auto_checkin: match.autoCheckin,
   366→            momentum_delta: match.momentumDelta
   367→          });
   368→        }
   369→
   370→        // Event 5: agent_response (可选)
   371→        const intervention = await evaluateIntervention(userId, extraction.emotion, state);
   372→        if (intervention) {
   373→          const task = await createActionTask(userId, intervention);
   374→          send('agent_response', {
   375→            type: 'action_card',
   376→            card: task
   377→          });
   378→        }
   379→
   380→        // Event 6: done
   381→        send('done', {});
   382→
   383→      } catch (error) {
   384→        send('error', { code: 'server/internal-error', message: error.message, request_id: requestId });
   385→      } finally {
   386→        controller.close();
   387→      }
   388→    }
   389→  });
   390→
   391→  return new Response(stream, {
   392→    headers: {
   393→      'Content-Type': 'text/event-stream',
   394→      'Cache-Control': 'no-cache',
   395→      'Connection': 'keep-alive',
   396→      'X-Request-Id': requestId,
   397→    }
   398→  });
   399→}
   400→```
   401→
   402→### 5.3 统一错误格式 (规格强制)
   403→
   404→```typescript
   405→interface ErrorResponse {
   406→  error: {
   407→    code: string;        // 错误代码
   408→    message: string;     // 用户友好信息
   409→    details?: any;       // 详细信息 (仅开发环境)
   410→    request_id: string;  // 必须携带
   411→  };
   412→}
   413→
   414→// Error Codes (规格定义)
   415→const ERROR_CODES = {
   416→  // Auth (401)
   417→  'auth/invalid-token': 'Token 无效',
   418→  'auth/token-expired': 'Token 已过期',
   419→  'auth/missing-token': '缺少 Token',
   420→
   421→  // Permission (403)
   422→  'permission/denied': '权限不足',
   423→  'permission/tier-required': '需要升级订阅',
   424→
   425→  // Resource (404)
   426→  'resource/user-not-found': '用户不存在',
   427→  'resource/stream-not-found': 'Stream 不存在',
   428→
   429→  // Validation (400)
   430→  'validation/error': '参数校验失败',
   431→  'validation/invalid-birth-time': '生辰格式错误',
   432→
   433→  // Rate Limit (429)
   434→  'rate-limit/exceeded': '请求过于频繁',
   435→
   436→  // Server (500)
   437→  'server/internal-error': '服务器内部错误',
   438→  'server/ai-service-error': 'AI 服务异常',
   439→};
   440→```
   441→
   442→### 5.4 认证策略 (规格对齐)
   443→
   444→```typescript
   445→// 认证方式
   446→Web:     NextAuth v5 → Cookie 会话 + JWT 签发
   447→API:     Bearer Token (JWT)
   448→Mobile:  直接 Bearer Token
   449→
   450→// JWT Payload
   451→interface JWTPayload {
   452→  sub: string;      // user_id
   453→  email: string;
   454→  tier: 'free' | 'pro' | 'premium';
   455→  iat: number;
   456→  exp: number;
   457→}
   458→
   459→// 权限控制
   460→const tierGating = {
   461→  free: ['bazi', 'fortune_today', 'vibe_diary', 'basic_emotion'],
   462→  pro: [...free, 'ziwei', 'weekly_mirror', 'photo_input', 'advanced_emotion'],
   463→  premium: [...pro, 'cbt', 'act', 'voice_persona', 'calendar_sync']
   464→};
   465→```
   466→
   467→---
   468→
   469→## 6. 核心引擎实现
   470→
   471→### 6.1 Stream Processor
   472→
   473→```typescript
   474→// apps/web/src/lib/mentis/stream-processor.ts
   475→interface StreamInput {
   476→  content: string;
   477→  type: 'vibe_diary' | 'chat';
   478→  media?: { type: 'image' | 'audio'; url: string }[];
   479→  metadata?: { location?: LatLng; device?: string };
   480→}
   481→
   482→interface ExtractionResult {
   483→  emotion: {
   484→    primary: string;      // joy/sadness/anger/fear/surprise/disgust/anxiety/calm
   485→    intensity: number;    // 1-10
   486→    secondary: string[];
   487→    confidence: number;
   488→  };
   489→  context: {
   490→    scene: string;        // work/home/social/outdoor/...
   491→    trigger: string;
   492→    target: string;
   493→    timeOfDay: string;
   494→  };
   495→  tags: string[];
   496→  energyDelta: number;
   497→}
   498→```
   499→
   500→### 6.2 Emotion Engine
   501→
   502→```typescript
   503→// apps/web/src/lib/mentis/emotion-engine.ts
   504→const EMOTION_TAXONOMY = {
   505→  primary: ['joy', 'sadness', 'anger', 'fear', 'surprise', 'disgust', 'anxiety', 'calm'],
   506→  secondary: ['frustration', 'helplessness', 'excitement', 'pride', 'guilt', 'shame',
   507→              'loneliness', 'gratitude', 'hope', 'relief', 'jealousy', 'contempt']
   508→};
   509→
   510→const ENERGY_MAP: Record<string, [number, number]> = {
   511→  joy: [2, 5],
   512→  sadness: [-4, -2],
   513→  anger: [-5, -3],
   514→  fear: [-4, -2],
   515→  surprise: [-1, 1],
   516→  disgust: [-3, -2],
   517→  anxiety: [-4, -2],
   518→  calm: [0, 1]
   519→};
   520→
   521→function calculateEnergyDelta(emotion: string, intensity: number): number {
   522→  const [min, max] = ENERGY_MAP[emotion] || [0, 0];
   523→  const ratio = intensity / 10;
   524→  return Math.round(max > 0 ? min + (max - min) * ratio : max + (min - max) * ratio);
   525→}
   526→```
   527→
   528→### 6.3 Behavior Matcher (NLU → Auto Checkin)
   529→
   530→```typescript
   531→// apps/web/src/lib/mentis/behavior-matcher.ts
   532→// 向量匹配阈值 (规格定义)
   533→const THRESHOLDS = {
   534→  PENDING_TASK_PRIORITY: 0.80,  // 待办任务优先匹配
   535→  AUTO_CHECKIN: 0.85,           // >= 0.85 自动确认
   536→  CONFIRM_CARD: 0.60,           // 0.60-0.85 弹确认卡
   537→  IGNORE: 0.60                  // < 0.60 忽略
   538→};
   539→
   540→async function matchBehavior(input: string, userId: string): Promise<BehaviorMatch> {
   541→  // 1. 生成 embedding
   542→  const embedding = await generateEmbedding(input);
   543→
   544→  // 2. 优先匹配待办任务
   545→  const pendingTasks = await getPendingTasks(userId);
   546→  if (pendingTasks.length > 0) {
   547→    const taskMatch = await matchAgainstTasks(embedding, pendingTasks);
   548→    if (taskMatch && taskMatch.score >= THRESHOLDS.PENDING_TASK_PRIORITY) {
   549→      return {
   550→        matched: true,
   551→        behavior: taskMatch.task.type,
   552→        confidence: taskMatch.score,
   553→        autoCheckin: taskMatch.score >= THRESHOLDS.AUTO_CHECKIN,
   554→        taskId: taskMatch.task.id,
   555→        momentumDelta: taskMatch.task.momentumReward
   556→      };
   557→    }
   558→  }
   559→
   560→  // 3. 匹配 Pinecone behavior_library
   561→  const libraryMatch = await pinecone.query({
   562→    namespace: 'behavior_library',
   563→    vector: embedding,
   564→    topK: 3
   565→  });
   566→
   567→  const top = libraryMatch.matches[0];
   568→  if (!top || top.score < THRESHOLDS.IGNORE) {
   569→    return { matched: false, confidence: top?.score || 0, autoCheckin: false };
   570→  }
   571→
   572→  return {
   573→    matched: true,
   574→    behavior: top.metadata.behaviorId,
   575→    confidence: top.score,
   576→    autoCheckin: top.score >= THRESHOLDS.AUTO_CHECKIN,
   577→    momentumDelta: top.metadata.momentumReward
   578→  };
   579→}
   580→```
   581→
   582→### 6.4 多模型路由 (降级策略)
   583→
   584→```typescript
   585→// apps/web/src/lib/llm/model-router.ts
   586→interface ModelConfig {
   587→  model: string;
   588→  provider: 'zhipu' | 'anthropic' | 'openai';
   589→  apiKey: string;
   590→}
   591→
   592→const MODEL_PRIORITY = [
   593→  { model: 'glm-4', provider: 'zhipu' },           // 主力 (国内)
   594→  { model: 'claude-3.5-sonnet', provider: 'anthropic' },  // 降级
   595→  { model: 'gpt-4-turbo', provider: 'openai' }    // 兜底
   596→];
   597→
   598→async function selectModel(tier: string, taskType: string): Promise<ModelConfig> {
   599→  for (const config of MODEL_PRIORITY) {
   600→    try {
   601→      await healthCheck(config);
   602→      return config;
   603→    } catch {
   604→      continue;
   605→    }
   606→  }
   607→  throw new Error('All LLM providers unavailable');
   608→}
   609→```
   610→
   611→---
   612→
   613→## 7. 前端实现
   614→
   615→### 7.1 Dynamic Aura System
   616→
   617→```typescript
   618→// apps/web/src/components/hud/DynamicAura.tsx
   619→const AURA_STATES = {
   620→  calm:    { gradient: ['#1a1a2e', '#2d3561'], particles: 'slow-rise', transition: '2s' },
   621→  alert:   { gradient: ['#2e1a1a', '#613535'], particles: 'fast-pulse', transition: '0.5s' },
   622→  happy:   { gradient: ['#2e2a1a', '#61553d'], particles: 'bounce', transition: '2s' },
   623→  anxious: { gradient: ['#1a1a2e', '#3d2d61'], particles: 'irregular', transition: '1s' },
   624→  flow:    { gradient: ['#1a2e1a', '#2d6135'], particles: 'focus', transition: '2s' }
   625→};
   626→
   627→// 状态转换逻辑
   628→function getAuraState(emotion: string, energyScore: number): AuraState {
   629→  if (emotion === 'anger' || energyScore < 30) return 'alert';
   630→  if (emotion === 'joy' && energyScore > 80) return 'happy';
   631→  if (emotion === 'anxiety') return 'anxious';
   632→  if (emotion === 'focus' && energyScore > 70) return 'flow';
   633→  return 'calm';
   634→}
   635→```
   636→
   637→### 7.2 状态管理
   638→
   639→```typescript
   640→// apps/web/src/stores/mentis-store.ts
   641→import { create } from 'zustand';
   642→
   643→interface MentisStore {
   644→  // Stream
   645→  streamEntries: StreamEntry[];
   646→  isStreaming: boolean;
   647→
   648→  // User State (实时同步)
   649→  userState: {
   650→    energyScore: number;
   651→    momentum: number;
   652→    streakDays: number;
   653→    currentMood: { primary: string; intensity: number } | null;
   654→    auraState: 'calm' | 'alert' | 'happy' | 'anxious' | 'flow';
   655→  };
   656→
   657→  // Action Tasks
   658→  pendingTasks: ActionTask[];
   659→
   660→  // Actions
   661→  sendStreamInput: (input: StreamInput) => Promise<void>;
   662→  completeTask: (taskId: string) => Promise<void>;
   663→  dismissTask: (taskId: string) => Promise<void>;
   664→
   665→  // SSE 事件处理
   666→  handleStreamEvent: (event: SSEEvent) => void;
   667→
   668→  // WebSocket
   669→  connectRealtime: () => void;
   670→  disconnectRealtime: () => void;
   671→}
   672→```
   673→
   674→---
   675→
   676→## 8. 可观测性 (规格 SLO/SLI)
   677→
   678→### 8.1 性能指标
   679→
   680→| 指标 | SLO |
   681→|------|-----|
   682→| Stream Input → First Response | < 500ms (P95) |
   683→| Stream Input → Complete | < 3000ms (P95) |
   684→| Emotion Detection | < 300ms (P95) |
   685→| Behavior Match | < 200ms (P95) |
   686→| State Broadcast (WebSocket) | < 100ms (P95) |
   687→| 5xx Error Rate | < 0.1% |
   688→| AI Service Failures | < 0.5% |
   689→
   690→### 8.2 落地手段
   691→
   692→```typescript
   693→// 所有请求/事件必须携带 request_id
   694→const requestId = `req_${nanoid()}`;
   695→
   696→// 结构化日志
   697→logger.info('stream_processed', {
   698→  request_id: requestId,
   699→  user_id: userId,
   700→  duration_ms: Date.now() - startTime,
   701→  emotion: emotion.primary,
   702→  energy_delta: energyDelta,
   703→  behavior_matched: match.matched
   704→});
   705→
   706→// Sentry 集成
   707→Sentry.captureException(error, {
   708→  extra: { request_id: requestId, user_id: userId }
   709→});
   710→```
   711→
   712→---
   713→
   714→## 9. 实施路线图
   715→
   716→### 第一周 TODO (最小闭环)
   717→
   718→```
   719→1. [ ] 初始化 /home/aiscend/work/mentis 项目结构 (pnpm + Turborepo)
   720→2. [ ] 创建 mentis 数据库 + Drizzle Schema (mentis_user/user_profile/user_state/stream_entry)
   721→3. [ ] 实现 POST /v3/stream (stream_created → extraction_complete → state_update → done)
   722→4. [ ] 前端 StreamFeed 原型 (消费 SSE 事件)
   723→5. [ ] HUD Aura 背景层 (calm/alert 两态)
   724→6. [ ] 打通最小动量闭环 (user_state.momentum 更新)
   725→```
   726→
   727→### Sprint 1: 基础架构 + Stream 核心 (Week 1-2)
   728→
   729→**目标:** 实现 Stream 输入闭环
   730→
   731→| 任务 | SSE 事件 | 数据表 | 前端交互 |
   732→|------|----------|--------|----------|
   733→| 项目初始化 | - | - | - |
   734→| 数据库创建 | - | mentis_user, user_profile, user_state, stream_entry | - |
   735→| Stream API | stream_created, extraction_complete, state_update, done | stream_entry 写入 | - |
   736→| Emotion Engine | extraction_complete | emotion/context 写入 | - |
   737→| 前端原型 | 消费全部事件 | - | StreamFeed, MagicInput |
   738→
   739→**验收:** 用户发送文字 → 情绪识别 → 状态更新 → SSE 完整响应
   740→
   741→**回滚策略:** Feature flag `ENABLE_V3_STREAM`
   742→
   743→### Sprint 2: Vibe Diary UI + 实时状态 (Week 3-4)
   744→
   745→**目标:** 完成前端 Stream 交互
   746→
   747→| 任务 | SSE 事件 | 数据表 | 前端交互 |
   748→|------|----------|--------|----------|
   749→| MagicInput 完整版 | - | - | 文字/语音/图片入口 |
   750→| StreamCard 组件 | - | - | Vibe Diary / Chat 卡片 |
   751→| TopStatusBar | - | - | 动量/连续天数/Aura 指示 |
   752→| WebSocket 连接 | - | - | Pusher 实时同步 |
   753→| user_state 实时更新 | state_update | user_state | Aura 变化 |
   754→
   755→**验收:** 完整 Vibe Diary 输入→展示流程 + 实时状态同步
   756→
   757→### Sprint 3: Dynamic Aura + 语音输入 (Week 5-6)
   758→
   759→**目标:** 增强视觉反馈
   760→
   761→| 任务 | SSE 事件 | 数据表 | 前端交互 |
   762→|------|----------|--------|----------|
   763→| Aura 5 种状态 | - | - | calm/alert/happy/anxious/flow |
   764→| Whisper STT | - | media 字段 | 语音输入 |
   765→| Vision API | - | media 字段 | 图片输入 |
   766→| 粒子效果 | - | - | 状态转换动画 |
   767→
   768→**验收:** 情绪变化触发 Aura 变换 + 三种输入方式
   769→
   770→### Sprint 4: Agent 主动干预 (Week 7-8)
   771→
   772→**目标:** 实现 Agent 推送能力
   773→
   774→| 任务 | SSE 事件 | 数据表 | 前端交互 |
   775→|------|----------|--------|----------|
   776→| Behavior Matcher | behavior_match | checkin_log | 自动打卡反馈 |
   777→| Intervention Agent | agent_response | action_task | Action Card 推送 |
   778→| Action Cards UI | - | - | Suggestion/Confirmation |
   779→| 长按完成交互 | - | action_task.status | 进度条 + 动量奖励 |
   780→| Pinecone 集成 | - | embedding_id | 向量匹配 |
   781→
   782→**验收:** Agent 主动推送卡片 + NLU 自动打卡
   783→
   784→### Sprint 5: DECODE 模块 (Week 9-10)
   785→
   786→**目标:** 迁移核心算法
   787→
   788→| 任务 | API | 数据表 | 前端交互 |
   789→|------|-----|--------|----------|
   790→| BaZi 模块 | /decode/bazi | user_profile.bazi_data | 命盘展示 |
   791→| Fortune 今日运势 | /decode/fortune/today | insight_record | 运势卡片 |
   792→| Momentum 系统 | /momentum | checkin_log, user_state | 动量历史 |
   793→| Weekly Mirror | - | insight_record | 周报卡片 |
   794→
   795→**验收:** 八字运势功能完整 + 动量/连续天数追踪
   796→
   797→### Sprint 6: 集成测试 + 上线 (Week 11-12)
   798→
   799→**目标:** 稳定性保障
   800→
   801→| 任务 | 验收标准 |
   802→|------|----------|
   803→| E2E 测试 | Playwright 覆盖核心链路 |
   804→| 性能测试 | 达成 SLO 指标 |
   805→| Sentry 监控 | 异常/性能/崩溃告警 |
   806→| 文档更新 | API 文档 + 部署文档 |
   807→| 灰度发布 | Feature flag 灰度 10% → 50% → 100% |
   808→
   809→**验收:** Mentis OS v3.0 MVP 完整可用
   810→
   811→---
   812→
   813→## 10. 技术栈总览
   814→
   815→| 层级 | 技术选型 |
   816→|------|----------|
   817→| **Monorepo** | pnpm workspace + Turborepo |
   818→| **Frontend** | Next.js 16 (App Router) + React 19 |
   819→| **Styling** | Tailwind CSS + Framer Motion |
   820→| **UI Components** | Radix UI + shadcn/ui |
   821→| **State** | Zustand + TanStack Query |
   822→| **Backend Runtime** | Next.js API Routes + Vercel AI SDK |
   823→| **ORM** | Drizzle ORM + Drizzle Kit |
   824→| **Database** | PostgreSQL (Neon Serverless) |
   825→| **Cache** | Upstash Redis |
   826→| **Vector Store** | Pinecone |
   827→| **Object Storage** | Cloudflare R2 |
   828→| **Realtime** | Pusher Channels |
   829→| **LLM** | GLM-4 (主) + Claude 3.5 (降级) + GPT-4 (兜底) |
   830→| **STT** | OpenAI Whisper |
   831→| **Embedding** | text-embedding-3-small |
   832→| **Auth** | NextAuth v5 + JWT |
   833→| **Monitoring** | Sentry + Vercel Analytics |
   834→
   835→---
   836→
   837→## 11. 环境变量
   838→
   839→```bash
   840→# Database
   841→DATABASE_URL="postgresql://..."
   842→DATABASE_URL_UNPOOLED="postgresql://..."
   843→
   844→# Redis
   845→UPSTASH_REDIS_REST_URL="https://..."
   846→UPSTASH_REDIS_REST_TOKEN="..."
   847→
   848→# Pinecone
   849→PINECONE_API_KEY="..."
   850→PINECONE_ENVIRONMENT="us-east-1-aws"
   851→PINECONE_INDEX="mentis-vectors"
   852→
   853→# Object Storage
   854→R2_ACCOUNT_ID="..."
   855→R2_ACCESS_KEY_ID="..."
   856→R2_SECRET_ACCESS_KEY="..."
   857→R2_BUCKET_NAME="mentis-media"
   858→
   859→# LLM
   860→ZHIPU_API_KEY="..."          # GLM-4
   861→ANTHROPIC_API_KEY="..."      # Claude
   862→OPENAI_API_KEY="..."         # GPT-4 + Whisper + Embedding
   863→
   864→# Auth
   865→NEXTAUTH_SECRET="..."
   866→NEXTAUTH_URL="https://mentis.ai"
   867→
   868→# Realtime
   869→PUSHER_APP_ID="..."
   870→PUSHER_KEY="..."
   871→PUSHER_SECRET="..."
   872→NEXT_PUBLIC_PUSHER_KEY="..."
   873→
   874→# Monitoring
   875→SENTRY_DSN="..."
   876→NEXT_PUBLIC_SENTRY_DSN="..."
   877→```
   878→
   879→---
   880→
   881→## 12. 与 fortune_ai 的关系
   882→
   883→| 项目 | 状态 | 用途 |
   884→|------|------|------|
   885→| `/home/aiscend/work/fortune_ai` | **完整保留** | 参考代码 + 数据迁移源 |
   886→| `/home/aiscend/work/mentis` | **全新构建** | Mentis OS v3.0 主项目 |
   887→
   888→**可复用资源:**
   889→- `fortune_ai/services/bazi_*.py` → 算法逻辑参考 (需用 TypeScript 重写)
   890→- `fortune_ai/web-app/src/app/globals.css` → 视觉 token 参考
   891→- `fortune_ai/web-app/src/components/brand/` → 品牌元素参考
   892→
   893→**数据迁移 (可选，后续):**
   894→```sql
   895→-- fortune_ai.fortune_user → mentis.mentis_user
   896→-- fortune_ai.fortune_commitment → mentis.action_task
   897→-- fortune_ai.fortune_checkin → mentis.checkin_log
   898→-- fortune_ai.fortune_conversation_* → mentis.stream_entry (type='chat')
   899→```
   900→
   901→---
   902→
   903→> 本文档严格对齐 Mentis OS v3.0 规格，在全新独立项目中构建，fortune_ai 完整保留。
   904→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
