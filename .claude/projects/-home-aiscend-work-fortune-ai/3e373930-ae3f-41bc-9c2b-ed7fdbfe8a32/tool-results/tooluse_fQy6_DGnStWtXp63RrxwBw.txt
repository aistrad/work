   330→        """
   331→        INSERT INTO fortune_energy_buff (
   332→            from_user_id, to_user_id, buff_type, amount, message, source, created_at
   333→        ) VALUES (%s, %s, %s, %s, %s, %s, %s)
   334→        RETURNING buff_id
   335→        """,
   336→        [from_user_id, to_user_id, buff_type.value, amount, message, "app", now],
   337→    )
   338→
   339→    buff_id = buff_row["buff_id"] if buff_row else 0
   340→
   341→    # 4. Update receiver's twin (increment buffs received)
   342→    try:
   343→        from services import twin_service
   344→        from models.twin import TwinLayer, TwinUpdateEvent
   345→
   346→        twin_service.update_twin(TwinUpdateEvent(
   347→            user_id=to_user_id,
   348→            layer=TwinLayer.L2,
   349→            path="dynamic_social.recent_buffs_received",
   350→            new_value=1,  # Will be incremented
   351→            confidence=1.0,
   352→            source="system",
   353→            trigger="social_event",
   354→        ))
   355→    except Exception as e:
   356→        logger.warning("Failed to update twin for buff: %s", str(e))
   357→
   358→    logger.info(
   359→        "energy_buff_sent from=%s to=%s type=%s amount=%s",
   360→        from_user_id, to_user_id, buff_type.value, amount
   361→    )
   362→
   363→    return EnergyBuff(
   364→        buff_id=buff_id,
   365→        from_user_id=from_user_id,
   366→        to_user_id=to_user_id,
   367→        buff_type=buff_type,
   368→        amount=amount,
   369→        message=message,
   370→        source="app",
   371→        created_at=now,
   372→    )
   373→
   374→
   375→def get_received_buffs(user_id: int, limit: int = 20) -> List[EnergyBuff]:
   376→    """Get buffs received by user."""
   377→    rows = fortune_db.fetch_all(
   378→        """
   379→        SELECT * FROM fortune_energy_buff
   380→        WHERE to_user_id = %s
   381→        ORDER BY created_at DESC
   382→        LIMIT %s
   383→        """,
   384→        [user_id, limit],
   385→    )
   386→
   387→    return [
   388→        EnergyBuff(
   389→            buff_id=row["buff_id"],

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
