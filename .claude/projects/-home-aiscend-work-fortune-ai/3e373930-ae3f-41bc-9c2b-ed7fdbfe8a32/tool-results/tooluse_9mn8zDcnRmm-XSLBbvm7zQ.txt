     1→# Fortune AI 系统架构设计（Claude MVP v1.1）
     2→
     3→**文档类型**：System Design
     4→**产品代号**：`Fortune AI - 精神数字孪生与人生智能OS`
     5→**版本**：`MVP v1.1`
     6→**日期**：2025-12-30
     7→**输入依据**：`bp v1.md`（商业计划书）、`system_design_codex_v5.md`（技术参考）
     8→**智能体框架**：Vercel AI SDK（独立编排服务）+ FastAPI（SSOT 后端）
     9→
    10→---
    11→
    12→## 0. 执行摘要
    13→
    14→### 0.1 产品定位（来自 bp v1.md）
    15→
    16→> **用AI智能体重构"心理成长"；智能体是你的"精神操作系统"，精神数字孪生是你的"角色面板"**
    17→
    18→### 0.2 架构目标
    19→
    20→本设计旨在实现商业计划书中的三大核心支柱：
    21→
    22→| 支柱 | 描述 | 技术映射 |
    23→|------|------|----------|
    24→| **实体数字化** | 把心理状态变成结构化数字孪生 Avatar | Multi-Layer Twin Model + PostgreSQL SSOT |
    25→| **深层次心理动机** | 把痛苦的"成长"变成爽感的"练级" | Gamification Engine + Social Graph |
    26→| **主动化推理** | 基于数据的智能体主动预判与干预 | Vercel AI SDK Multi-Agent + JITAI |
    27→
    28→### 0.3 技术选型决策（衔接现有代码）
    29→
    30→| 层面 | 选型 | 理由 |
    31→|------|------|------|
    32→| **业务后端** | FastAPI（现有） | SSOT 保障、复用现有认证/数据层、避免大规模重构 |
    33→| **智能体编排** | Vercel AI SDK（独立服务） | Tool Calling、Multi-Agent、流式输出 |
    34→| **数据库** | PostgreSQL + pgvector | 现有基础设施复用、SSOT、语义检索 |
    35→| **LLM Provider** | Multi-Provider (GLM-4/Claude/OpenAI) | Vercel AI SDK 统一接口、Provider 热切换 |
    36→| **前端** | Jinja2 + 原生 JS（现有） | 复用 bazi2.html + ui.js，渐进增强 |
    37→| **部署** | FastAPI + Agent Service 分离部署 | 独立扩缩、故障隔离 |
    38→
    39→### 0.4 架构总览（FastAPI + Agent Service 分离）
    40→
    41→```
    42→┌─────────────────────────────────────────────────────────────────────────────┐
    43→│                              用户层                                          │
    44→│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐         │
    45→│  │   Web UI        │    │   小程序/App    │    │   分享卡/QR     │         │
    46→│  │  (Jinja2+JS)    │    │   (可选)        │    │   (扫码入口)    │         │
    47→│  └────────┬────────┘    └────────┬────────┘    └────────┬────────┘         │
    48→│           │                      │                      │                   │
    49→└───────────┼──────────────────────┼──────────────────────┼───────────────────┘
    50→            │                      │                      │
    51→            ▼                      ▼                      ▼
    52→┌─────────────────────────────────────────────────────────────────────────────┐
    53→│                         FastAPI 业务后端（SSOT）                              │
    54→│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
    55→│  │   Auth      │  │   User      │  │   Twin      │  │   Social    │        │
    56→│  │   Routes    │  │   Routes    │  │   Routes    │  │   Routes    │        │
    57→│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
    58→│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
    59→│  │  Currency   │  │   Plan      │  │   KB        │  │  Tool API   │        │
    60→│  │   Routes    │  │   Routes    │  │   Routes    │  │  (Internal) │        │
    61→│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
    62→│                              │                                              │
    63→│                              ▼                                              │
    64→│                    ┌─────────────────┐                                      │
    65→│                    │   PostgreSQL    │                                      │
    66→│                    │     SSOT        │                                      │
    67→│                    └─────────────────┘                                      │
    68→└─────────────────────────────────────────────────────────────────────────────┘
    69→            │
    70→            │ Agent Call (HTTP/gRPC)
    71→            ▼
    72→┌─────────────────────────────────────────────────────────────────────────────┐
    73→│                    Agent Orchestrator（Vercel AI SDK）                       │
    74→│                                                                              │
    75→│  ┌────────────────────────────────────────────────────────────────────┐     │
    76→│  │                      Orchestrator Layer                             │     │
    77→│  │   • 意图识别    • 安全检查    • Agent 路由    • A2UI 组装          │     │
    78→│  └────────────────────────────────────────────────────────────────────┘     │
    79→│          │              │               │              │                    │
    80→│          ▼              ▼               ▼              ▼                    │
    81→│  ┌──────────────────────────────────────────────────────────────────┐      │
    82→│  │                   Agent Pool + Knowledge Base Registry            │      │
    83→│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐         │      │
    84→│  │  │  Coach   │  │ Analyst  │  │  Social  │  │  Expert  │         │      │
    85→│  │  │ Agent    │  │ Agent    │  │ Agent    │  │ Factory  │         │      │
    86→│  │  │ +KB[]    │  │ +KB[]    │  │ +KB[]    │  │ +KB[]    │         │      │
    87→│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘         │      │
    88→│  └──────────────────────────────────────────────────────────────────┘      │
    89→│                              │                                              │
    90→│                              ▼                                              │
    91→│  ┌──────────────────────────────────────────────────────────────────┐      │
    92→│  │              Pluggable Knowledge Base System                      │      │
    93→│  │  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐    │      │
    94→│  │  │ 八字KB │  │ 紫薇KB │  │ 星座KB │  │心理学KB│  │ 自定义 │    │      │
    95→│  │  └────────┘  └────────┘  └────────┘  └────────┘  └────────┘    │      │
    96→│  └──────────────────────────────────────────────────────────────────┘      │
    97→│                              │                                              │
    98→│                    Tool Calls (via SERVICE_TOKEN)                           │
    99→│                              │                                              │
   100→└──────────────────────────────┼──────────────────────────────────────────────┘
   101→                               │
   102→                               ▼
   103→                    ┌─────────────────┐
   104→                    │   LLM Provider  │
   105→                    │  GLM/Claude/GPT │
   106→                    └─────────────────┘
   107→```
   108→
   109→---
   110→
   111→## 1. 精神数字孪生模型（Spiritual Digital Twin）
   112→
   113→> **核心资产**：一个随状态实时变化的结构化"角色面板"
   114→
   115→### 1.1 三层孪生架构
   116→
   117→```
   118→┌─────────────────────────────────────────────────────────────────┐
   119→│                    L3 - 可视化展示层                              │
   120→│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
   121→│  │  数据看板    │  │  能量雷达图  │  │  时间序列    │           │
   122→│  │  Dashboard   │  │  Aura Radar  │  │  Timeline    │           │
   123→│  └──────────────┘  └──────────────┘  └──────────────┘           │
   124→├─────────────────────────────────────────────────────────────────┤
   125→│                    L2 - 动态状态层                               │
   126→│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
   127→│  │  玄学分析    │  │  生物数据    │  │  社交状态    │           │
   128→│  │  水逆/流年   │  │  睡眠/步数   │  │  关系图谱    │           │
   129→│  └──────────────┘  └──────────────┘  └──────────────┘           │
   130→│           ↑               ↑               ↑                     │
   131→│       智能体交互       外部API        社交系统                   │
   132→├─────────────────────────────────────────────────────────────────┤
   133→│                    L1 - 元数据层（出厂设置）                      │
   134→│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
   135→│  │  玄学元数据  │  │  心理学元数据 │  │  历史记忆    │           │
   136→│  │  八字/星盘   │  │  PERMA/VIA   │  │  对话摘要    │           │
   137→│  │  MBTI/紫薇   │  │  依附类型    │  │  关键事件    │           │
   138→│  └──────────────┘  └──────────────┘  └──────────────┘           │
   139→└─────────────────────────────────────────────────────────────────┘
   140→```
   141→
   142→### 1.2 数据模型定义
   143→
   144→```typescript
   145→// types/twin.ts
   146→interface SpiritualDigitalTwin {
   147→  // L1 - 元数据层（相对稳定）
   148→  metadata: {
   149→    astrology: {
   150→      bazi: BaziSnapshot;           // 八字四柱
   151→      zodiac: ZodiacProfile;        // 星座星盘
   152→      ziwei: ZiweiChart | null;     // 紫薇斗数（可选）
   153→    };
   154→    psychology: {
   155→      mbti: MBTIProfile | null;
   156→      perma: PERMAScores;           // 积极心理学五维度
   157→      via_strengths: string[];      // 品格优势
   158→      attachment_style: AttachmentType;
   159→    };
   160→    memory: {
   161→      key_events: KeyEvent[];       // 关键人生事件
   162→      conversation_summary: string; // 对话摘要（定期更新）
   163→      last_updated: Date;
   164→    };
   165→  };
   166→
   167→  // L2 - 动态状态层（实时变化）
   168→  dynamic_state: {
   169→    astro_context: {
   170→      current_transit: TransitInfo;   // 当前行星过境
   171→      retrograde_status: RetrogradeStatus[]; // 逆行状态
   172→      daily_theme: string;
   173→    };
   174→    bio_state: {
   175→      sleep_score: number | null;     // 0-100
   176→      activity_level: number | null;
   177→      stress_indicator: number | null;
   178→    };
   179→    social_state: {
   180→      active_relationships: number;
   181→      recent_interactions: number;
   182→      support_network_score: number;
   183→    };
   184→    emotional_state: {
   185→      current_mood: MoodType;
   186→      mood_intensity: number;         // 0-10
   187→      last_checkin: Date;
   188→    };
   189→  };
   190→
   191→  // L3 - 聚合指标层（展示用）
   192→  aggregated_metrics: {
   193→    aura_points: number;              // 能量积分
   194→    overall_wellbeing: number;        // 综合幸福指数 0-100
   195→    growth_streak: number;            // 连续成长天数
   196→    dimension_scores: {
   197→      energy: number;                 // 能量维度
   198→      clarity: number;                // 清晰度维度
   199→      connection: number;             // 连接维度
   200→      growth: number;                 // 成长维度
   201→      balance: number;                // 平衡维度
   202→    };
   203→  };
   204→}
   205→```
   206→
   207→### 1.3 孪生更新机制
   208→
   209→```typescript
   210→// services/twin-updater.ts
   211→type TwinUpdateTrigger =
   212→  | 'daily_refresh'      // 每日自动刷新
   213→  | 'checkin_completed'  // 情绪打卡后
   214→  | 'commitment_done'    // 完成承诺后
   215→  | 'chat_insight'       // 对话中提取洞察
   216→  | 'social_event'       // 社交事件发生
   217→  | 'external_sync';     // 外部数据同步
   218→
   219→interface TwinUpdateEvent {
   220→  trigger: TwinUpdateTrigger;
   221→  layer: 'L1' | 'L2' | 'L3';
   222→  path: string;           // e.g., 'dynamic_state.emotional_state.current_mood'
   223→  old_value: any;
   224→  new_value: any;
   225→  confidence: number;     // 0-1
   226→  source: string;         // 来源追溯
   227→  timestamp: Date;
   228→}
   229→```
   230→
   231→---
   232→
   233→## 2. AI 智能体系统架构（基于 Vercel AI SDK）
   234→
   235→### 2.1 多智能体架构总览
   236→
   237→```
   238→┌─────────────────────────────────────────────────────────────────────────┐
   239→│                         Soul OS - 灵魂操作系统                           │
   240→│                                                                          │
   241→│  ┌─────────────────────────────────────────────────────────────────┐    │
   242→│  │                    Orchestrator Agent（编排层）                   │    │
   243→│  │   • 意图识别与路由                                                │    │
   244→│  │   • 上下文聚合                                                    │    │
   245→│  │   • 多 Agent 协调                                                 │    │
   246→│  │   • A2UI 输出组装                                                 │    │
   247→│  └─────────────────────────────────────────────────────────────────┘    │
   248→│          │              │               │              │                 │
   249→│          ▼              ▼               ▼              ▼                 │
   250→│  ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐             │
   251→│  │  Coach   │   │ Analyst  │   │  Social  │   │  Expert  │             │
   252→│  │  Agent   │   │  Agent   │   │  Agent   │   │  Agents  │             │
   253→│  │          │   │          │   │          │   │          │             │
   254→│  │ 对话陪伴 │   │ 数据分析 │   │ 社交匹配 │   │ 专家知识 │             │
   255→│  │ 行动计划 │   │ 孪生更新 │   │ 群体机制 │   │ 可插拔   │             │
   256→│  └──────────┘   └──────────┘   └──────────┘   └──────────┘             │
   257→│                                                    │                     │
   258→│                                    ┌───────────────┼───────────────┐    │
   259→│                                    │               │               │    │
   260→│                               ┌────┴────┐   ┌────┴────┐   ┌────┴────┐  │
   261→│                               │  八字   │   │  紫薇   │   │  星座   │  │
   262→│                               │ Expert  │   │ Expert  │   │ Expert  │  │
   263→│                               └─────────┘   └─────────┘   └─────────┘  │
   264→│                                                                          │
   265→└─────────────────────────────────────────────────────────────────────────┘
   266→```
   267→
   268→### 2.2 Vercel AI SDK 实现架构
   269→
   270→```typescript
   271→// lib/ai/agents/index.ts
   272→import { experimental_createModelRegistry as createModelRegistry } from 'ai';
   273→import { openai } from '@ai-sdk/openai';
   274→import { anthropic } from '@ai-sdk/anthropic';
   275→
   276→// 模型注册（多 Provider 支持）
   277→export const modelRegistry = createModelRegistry({
   278→  openai,
   279→  anthropic,
   280→  // 自定义 GLM Provider
   281→  glm: createGLMProvider({
   282→    baseURL: process.env.GLM_BASE_URL,
   283→    apiKey: process.env.GLM_API_KEY,
   284→  }),
   285→});
   286→
   287→// Agent 基础配置
   288→interface AgentConfig {
   289→  id: string;
   290→  name: string;
   291→  model: string;                    // e.g., 'openai:gpt-4-turbo'
   292→  systemPrompt: string;
   293→  tools: Tool[];
   294→  maxTokens?: number;
   295→  temperature?: number;
   296→}
   297→```
   298→
   299→### 2.3 核心 Agent 定义
   300→
   301→#### 2.3.1 Coach Agent（教练智能体）
   302→
   303→```typescript
   304→// lib/ai/agents/coach-agent.ts
   305→import { generateText, streamText, tool } from 'ai';
   306→import { z } from 'zod';
   307→
   308→export const coachAgent: AgentConfig = {
   309→  id: 'coach',
   310→  name: 'Fortune Coach',
   311→  model: 'glm:glm-4',
   312→  systemPrompt: `你是 Fortune AI 的核心教练智能体，角色定位：
   313→
   314→【身份】
   315→- 积极心理学教练（Performance Coach）
   316→- 温暖而不讨好，直接而不冒犯
   317→- 永远站在用户的成长角度
   318→
   319→【核心职责】
   320→1. 情绪承接：先共情，再分析
   321→2. 洞察提供：基于孪生数据给出个性化解读
   322→3. 行动推动：每次对话必须产出可执行的最小行动
   323→4. 承诺邀请：引导用户做出承诺（commitment）
   324→
   325→【输出规范】
   326→- 必须使用 A2UI JSON 格式
   327→- 每次输出包含：结论 + 依据 + ≤3条处方 + 承诺邀请
   328→- 禁止恐吓、宿命论、绝对预测
   329→
   330→【可用工具】
   331→- query_twin: 查询用户数字孪生数据
   332→- create_commitment: 创建行动承诺
   333→- search_kb: 搜索知识库
   334→- schedule_task: 安排任务到计划`,
   335→
   336→  tools: [
   337→    tool({
   338→      name: 'query_twin',
   339→      description: '查询用户的精神数字孪生数据',
   340→      parameters: z.object({
   341→        layer: z.enum(['L1', 'L2', 'L3']),
   342→        path: z.string().optional(),
   343→      }),
   344→      execute: async ({ layer, path }) => {
   345→        // 实现：从数据库获取孪生数据
   346→      },
   347→    }),
   348→
   349→    tool({
   350→      name: 'create_commitment',
   351→      description: '为用户创建一个行动承诺',
   352→      parameters: z.object({
   353→        title: z.string(),
   354→        type: z.enum(['start_task', 'schedule_task', 'daily_habit']),
   355→        duration_minutes: z.number().optional(),
   356→        due_at: z.string().optional(),
   357→      }),
   358→      execute: async (params) => {
   359→        // 实现：写入 fortune_commitment 表
   360→      },
   361→    }),
   362→
   363→    tool({
   364→      name: 'search_kb',
   365→      description: '搜索知识库获取专业内容',
   366→      parameters: z.object({
   367→        query: z.string(),
   368→        domain: z.enum(['psychology', 'astrology', 'bazi', 'practice']),
   369→        limit: z.number().default(3),
   370→      }),
   371→      execute: async ({ query, domain, limit }) => {
   372→        // 实现：RAG 检索
   373→      },
   374→    }),
   375→  ],
   376→
   377→  temperature: 0.7,
   378→  maxTokens: 1500,
   379→};
   380→```
   381→
   382→#### 2.3.2 Analyst Agent（分析智能体）
   383→
   384→```typescript
   385→// lib/ai/agents/analyst-agent.ts
   386→export const analystAgent: AgentConfig = {
   387→  id: 'analyst',
   388→  name: 'Twin Analyst',
   389→  model: 'glm:glm-4',
   390→  systemPrompt: `你是数字孪生分析师，职责是从用户对话和行为中提取结构化信息。
   391→
   392→【核心任务】
   393→1. 情绪状态识别：从对话中识别情绪类型和强度
   394→2. 关键事件提取：识别影响用户状态的事件
   395→3. 模式识别：发现用户行为/思维模式
   396→4. 孪生更新建议：产出结构化的孪生更新指令
   397→
   398→【输出格式】
   399→{
   400→  "insights": [...],           // 洞察列表
   401→  "twin_updates": [...],       // 孪生更新指令
   402→  "risk_flags": [...],         // 风险标记（如自伤倾向）
   403→  "confidence": 0.0-1.0
   404→}
   405→
   406→【注意事项】
   407→- 只提取明确表达或强烈暗示的信息
   408→- 不做过度推断
   409→- 风险检测优先级最高`,
   410→
   411→  tools: [
   412→    tool({
   413→      name: 'update_twin',
   414→      description: '更新用户数字孪生的特定字段',
   415→      parameters: z.object({
   416→        layer: z.enum(['L1', 'L2', 'L3']),
   417→        path: z.string(),
   418→        value: z.any(),
   419→        confidence: z.number(),
   420→        reason: z.string(),
   421→      }),
   422→      execute: async (params) => {
   423→        // 实现：写入 twin_update_log 并触发更新
   424→      },
   425→    }),
   426→
   427→    tool({
   428→      name: 'flag_risk',
   429→      description: '标记风险信号',
   430→      parameters: z.object({
   431→        risk_type: z.enum(['self_harm', 'crisis', 'dependency', 'medical']),
   432→        severity: z.enum(['low', 'medium', 'high', 'critical']),
   433→        evidence: z.string(),
   434→      }),
   435→      execute: async (params) => {
   436→        // 实现：触发安全协议
   437→      },
   438→    }),
   439→  ],
   440→
   441→  temperature: 0.3,  // 低温度保证稳定性
   442→  maxTokens: 800,
   443→};
   444→```
   445→
   446→#### 2.3.3 Social Agent（社交智能体）
   447→
   448→```typescript
   449→// lib/ai/agents/social-agent.ts
   450→export const socialAgent: AgentConfig = {
   451→  id: 'social',
   452→  name: 'Connection Agent',
   453→  model: 'glm:glm-4',
   454→  systemPrompt: `你是社交连接智能体，负责处理用户间的深度连接。
   455→
   456→【核心功能】
   457→1. 合盘分析：基于双方孪生数据分析关系动力学
   458→2. 匹配推荐：基于深层特征而非表面兴趣
   459→3. 群体机制：能量打赏、好运接龙、吐槽大会
   460→4. 隐私保护：不泄露具体出生时间等敏感信息
   461→
   462→【社交玩法】
   463→- 能量打赏（Buff）：好友间的能量传递
   464→- 好运接龙：群体仪式感 + 裂变
   465→- 吐槽大会：安全宣泄 + 重评训练`,
   466→
   467→  tools: [
   468→    tool({
   469→      name: 'generate_compatibility',
   470→      description: '生成两人或多人合盘分析',
   471→      parameters: z.object({
   472→        user_ids: z.array(z.string()),
   473→        relationship_type: z.enum(['romantic', 'friendship', 'work', 'family']),
   474→        depth: z.enum(['quick', 'standard', 'deep']),
   475→      }),
   476→      execute: async (params) => {
   477→        // 实现：合盘算法
   478→      },
   479→    }),
   480→
   481→    tool({
   482→      name: 'send_energy_buff',
   483→      description: '发送能量打赏',
   484→      parameters: z.object({
   485→        from_user_id: z.string(),
   486→        to_user_id: z.string(),
   487→        buff_type: z.enum(['energy', 'luck', 'calm', 'focus']),
   488→        amount: z.number(),
   489→      }),
   490→      execute: async (params) => {
   491→        // 实现：写入 ledger + 触发通知
   492→      },
   493→    }),
   494→  ],
   495→};
   496→```
   497→
   498→#### 2.3.4 Expert Agent Factory（专家智能体工厂）
   499→
   500→```typescript

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
