   140→
   141→def ensure_balance_exists(user_id: int) -> None:
   142→    """Ensure user has a balance record."""
   143→    fortune_db.execute(
   144→        """
   145→        INSERT INTO fortune_user_balance (user_id, coins, aura, updated_at)
   146→        VALUES (%s, 0, 0, %s)
   147→        ON CONFLICT (user_id) DO NOTHING
   148→        """,
   149→        [user_id, _now_utc()],
   150→    )
   151→
   152→
   153→# =============================================================================
   154→# Add Currency (TASK-7.1.2)
   155→# =============================================================================
   156→
   157→def add_currency(
   158→    user_id: int,
   159→    currency_type: CurrencyType,
   160→    amount: int,
   161→    category: LedgerCategory,
   162→    reason: str,
   163→    ref_type: Optional[str] = None,
   164→    ref_id: Optional[str] = None,
   165→    description: Optional[str] = None,
   166→) -> CurrencyLedgerEntry:
   167→    """
   168→    Add currency to user's balance.
   169→
   170→    REQ: REQ-PAY-003
   171→    """
   172→    if amount <= 0:
   173→        raise CurrencyServiceError("Amount must be positive")
   174→
   175→    ensure_balance_exists(user_id)
   176→    now = _now_utc()
   177→
   178→    # Update balance
   179→    column = "coins" if currency_type == CurrencyType.COINS else "aura"
   180→    fortune_db.execute(
   181→        f"""
   182→        UPDATE fortune_user_balance
   183→        SET {column} = {column} + %s, updated_at = %s
   184→        WHERE user_id = %s
   185→        """,
   186→        [amount, now, user_id],
   187→    )
   188→
   189→    # Get new balance
   190→    balance = get_balance(user_id)
   191→    new_balance = balance.coins if currency_type == CurrencyType.COINS else balance.aura
   192→
   193→    # Record ledger entry
   194→    row = fortune_db.execute_returning_one(
   195→        """
   196→        INSERT INTO fortune_currency_ledger (
   197→            user_id, currency_type, amount, balance_after, category, reason,
   198→            ref_type, ref_id, description, created_at
   199→        ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
   200→        RETURNING entry_id
   201→        """,
   202→        [user_id, currency_type.value, amount, new_balance, category.value,
   203→         reason, ref_type, ref_id, description, now],
   204→    )
   205→
   206→    entry_id = row["entry_id"] if row else None
   207→
   208→    logger.info(
   209→        "currency_add user=%s type=%s amount=%s category=%s",
   210→        user_id, currency_type.value, amount, category.value
   211→    )
   212→
   213→    return CurrencyLedgerEntry(
   214→        entry_id=entry_id,
   215→        user_id=user_id,
   216→        currency_type=currency_type,
   217→        amount=amount,
   218→        balance_after=new_balance,
   219→        category=category,
   220→        reason=reason,
   221→        ref_type=ref_type,
   222→        ref_id=ref_id,
   223→        description=description,
   224→        created_at=now,
   225→    )
   226→
   227→
   228→# =============================================================================
   229→# Deduct Currency (TASK-7.1.3)
   230→# =============================================================================
   231→
   232→def deduct_currency(
   233→    user_id: int,
   234→    currency_type: CurrencyType,
   235→    amount: int,
   236→    category: LedgerCategory,
   237→    reason: str,
   238→    ref_type: Optional[str] = None,
   239→    ref_id: Optional[str] = None,

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
