The file /home/aiscend/work/fortune_ai/services/twin_service.py has been updated. Here's the result of running `cat -n` on a snippet of the edited file:
   311→    current[path_parts[-1]] = value
   312→    return result
   313→
   314→
   315→def update_twin(event: TwinUpdateEvent) -> TwinUpdateResult:
   316→    """
   317→    Update digital twin data.
   318→
   319→    REQ: REQ-TWIN-003
   320→    Design: §3.1.3 步骤 1-5
   321→
   322→    - Uses transaction for atomicity (FOR UPDATE lock held until commit)
   323→    - Supports nested path updates via jsonb_set
   324→    - Records old_value and new_value in log
   325→    - Triggers L3 recalculation if L2 is updated
   326→    """
   327→    user_id = event.user_id
   328→    column, path_parts = _parse_json_path(event.path)
   329→
   330→    # Use transaction to ensure atomicity: FOR UPDATE lock is held until commit
   331→    with fortune_db.transaction() as tx:
   332→        # Get current twin with row lock
   333→        row = tx.fetch_one(
   334→            "SELECT * FROM fortune_digital_twin WHERE user_id = %s FOR UPDATE",
   335→            [user_id],
   336→        )
   337→        if not row:
   338→            # Auto-create twin if not exists (outside transaction, then re-lock)
   339→            twin = create_twin(user_id)
   340→            row = tx.fetch_one(
   341→                "SELECT * FROM fortune_digital_twin WHERE user_id = %s FOR UPDATE",
   342→                [user_id],
   343→            )
   344→
   345→        twin_id = row["twin_id"]
   346→
   347→        # Get current column value
   348→        current_data = row.get(column) or {}
   349→        if isinstance(current_data, str):
   350→            current_data = json.loads(current_data)
   351→
   352→        # Get old value
   353→        old_value = _get_nested_value(current_data, path_parts) if path_parts else current_data
   354→
   355→        # Set new value
   356→        if path_parts:
   357→            new_data = _set_nested_value(current_data, path_parts, event.new_value)
   358→        else:
   359→            new_data = event.new_value if isinstance(event.new_value, dict) else current_data
   360→
   361→        # Update database (within same transaction)
   362→        tx.execute(
   363→            f"""
   364→            UPDATE fortune_digital_twin
   365→            SET {column} = %s, updated_at = %s
   366→            WHERE twin_id = %s
   367→            """,
   368→            [json.dumps(new_data), _now_utc(), twin_id],
   369→        )
   370→
   371→        # Write update log (within same transaction)
   372→        log_row = tx.execute_returning_one(
   373→            """
   374→            INSERT INTO fortune_twin_update_log (
   375→                twin_id, trigger_type, layer, path, old_value, new_value,
   376→                confidence, source, created_at
   377→            ) VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
   378→            RETURNING log_id
   379→            """,
   380→            [
   381→                twin_id,
   382→                event.trigger,
   383→                event.layer.value,
   384→                event.path,
   385→                json.dumps(old_value) if old_value is not None else None,
   386→                json.dumps(event.new_value),
   387→                event.confidence,
   388→                event.source,
   389→                _now_utc(),
   390→            ],
   391→        )
   392→
   393→        log_id = log_row["log_id"] if log_row else None
   394→    # Transaction commits here, lock released
   395→
   396→    # Trigger L3 recalculation if L2 was updated (outside transaction)
   397→    dimensions_recalculated = False
   398→    if event.layer == TwinLayer.L2:
   399→        recalculate_dimensions(user_id)
   400→        dimensions_recalculated = True
   401→
   402→    logger.info(
   403→        "twin_update user_id=%s twin_id=%s path=%s layer=%s trigger=%s",
   404→        user_id, twin_id, event.path, event.layer.value, event.trigger
   405→    )
   406→
   407→    return TwinUpdateResult(
   408→        updated=True,
   409→        log_id=log_id,
   410→        old_value=old_value,
   411→        new_value=event.new_value,
   412→        dimensions_recalculated=dimensions_recalculated,
   413→    )
   414→
   415→
   416→# =============================================================================
   417→# TASK-1.2.4: recalculate_dimensions