   440→        creator_user_id=creator_user_id,
   441→        title=title,
   442→        description=description,
   443→        ritual_type=ritual_type,
   444→        base_reward=base_reward,
   445→        participant_count=0,
   446→        status=ChainStatus.ACTIVE,
   447→        expires_at=expires_at,
   448→        created_at=now,
   449→    )
   450→
   451→
   452→def join_luck_chain(
   453→    chain_id: int,
   454→    user_id: int,
   455→    contribution: Optional[str] = None,
   456→) -> Dict[str, Any]:
   457→    """
   458→    Join a luck chain.
   459→
   460→    REQ: REQ-SOCIAL-004
   461→    Design: §3.4.2
   462→
   463→    Reward formula: floor(base_reward * log2(count + 2))
   464→    """
   465→    # 1. Get chain info
   466→    chain_row = fortune_db.fetch_one(
   467→        "SELECT * FROM fortune_luck_chain WHERE chain_id = %s FOR UPDATE",
   468→        [chain_id],
   469→    )
   470→
   471→    if not chain_row:
   472→        raise SocialServiceError("Chain not found")
   473→
   474→    if chain_row["status"] != "active":
   475→        raise ChainNotActiveError("Chain is not active")
   476→
   477→    if chain_row["expires_at"] and chain_row["expires_at"] < _now_utc():
   478→        # Mark as expired
   479→        fortune_db.execute(
   480→            "UPDATE fortune_luck_chain SET status = 'expired' WHERE chain_id = %s",
   481→            [chain_id],
   482→        )
   483→        raise ChainNotActiveError("Chain has expired")
   484→
   485→    # 2. Check if already joined
   486→    existing = fortune_db.fetch_one(
   487→        """
   488→        SELECT 1 FROM fortune_luck_chain_participant
   489→        WHERE chain_id = %s AND user_id = %s
   490→        """,
   491→        [chain_id, user_id],
   492→    )
   493→
   494→    if existing:
   495→        raise AlreadyJoinedError("Already joined this chain")
   496→
   497→    now = _now_utc()
   498→    current_count = chain_row["participant_count"]
   499→    new_position = current_count + 1
   500→
   501→    # 3. Calculate reward
   502→    base_reward = chain_row["base_reward"]
   503→    reward = int(base_reward * math.log2(new_position + 2))
   504→
   505→    # 4. Add participant
   506→    fortune_db.execute(
   507→        """
   508→        INSERT INTO fortune_luck_chain_participant (
   509→            chain_id, user_id, position, contribution, reward_earned, created_at
   510→        ) VALUES (%s, %s, %s, %s, %s, %s)
   511→        """,
   512→        [chain_id, user_id, new_position, contribution, reward, now],
   513→    )
   514→
   515→    # 5. Update chain participant count
   516→    fortune_db.execute(
   517→        """
   518→        UPDATE fortune_luck_chain
   519→        SET participant_count = participant_count + 1
   520→        WHERE chain_id = %s
   521→        """,
   522→        [chain_id],
   523→    )
   524→
   525→    # 6. Award Aura to all participants
   526→    participants = fortune_db.fetch_all(
   527→        "SELECT user_id FROM fortune_luck_chain_participant WHERE chain_id = %s",
   528→        [chain_id],
   529→    )
   530→
   531→    for p in participants:
   532→        # Add aura reward
   533→        fortune_db.execute(
   534→            """
   535→            INSERT INTO fortune_user_balance (user_id, coins, aura, updated_at)
   536→            VALUES (%s, 0, %s, %s)
   537→            ON CONFLICT (user_id) DO UPDATE SET
   538→                aura = fortune_user_balance.aura + %s,
   539→                updated_at = %s

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
