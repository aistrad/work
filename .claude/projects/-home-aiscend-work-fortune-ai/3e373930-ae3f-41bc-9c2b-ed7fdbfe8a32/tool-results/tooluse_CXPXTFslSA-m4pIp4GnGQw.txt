    95→          status = 'active',
    96→          accepted_at = COALESCE(accepted_at, now()),
    97→          commitment_type = COALESCE(%s, commitment_type),
    98→          due_at = COALESCE(%s, due_at)
    99→        WHERE task_id=%s AND user_id=%s AND status IN ('suggested','active')
   100→        RETURNING task_id, status, accepted_at
   101→        """,
   102→        (ctype, due_at, task_id, user_id),
   103→    )
   104→    if not row:
   105→        return _err(404, "not_found", "task_not_found")
   106→    return _ok({"task_id": str(row["task_id"]), "status": str(row["status"]), "accepted_at": str(row.get("accepted_at") or "")})
   107→
   108→
   109→@router.post("/commitment/done")
   110→def done_commitment(req: CommitmentDoneRequest, request: Request):
   111→    auth = require_auth(request)
   112→    require_csrf(request, auth)
   113→    user_id = int(auth["user_id"])
   114→    task_id = (req.task_id or "").strip()
   115→    if not _UUID_RE.match(task_id):
   116→        return _err(400, "invalid_request", "invalid_task_id")
   117→    row = fortune_db.execute_returning_one(
   118→        """
   119→        UPDATE fortune_commitment
   120→        SET
   121→          status = 'done',
   122→          done_at = now()
   123→        WHERE task_id=%s AND user_id=%s AND status IN ('active','suggested')
   124→        RETURNING task_id, status, done_at
   125→        """,
   126→        (task_id, user_id),
   127→    )
   128→    if not row:
   129→        return _err(404, "not_found", "task_not_found")
   130→    return _ok({"task_id": str(row["task_id"]), "status": str(row["status"]), "done_at": str(row.get("done_at") or "")})
   131→
   132→
   133→@router.post("/checkin")
   134→def checkin(req: CheckinRequest, request: Request):
   135→    auth = require_auth(request)
   136→    require_csrf(request, auth)
   137→    user_id = int(auth["user_id"])
   138→    data = bento_service.create_checkin(user_id, mood=req.mood, intensity=int(req.intensity), note=req.note)
   139→    md = f"### 情绪打卡\n- 情绪：{req.mood}（{int(req.intensity)}/10）\n\n### 推荐动作\n- {data['recommended_action']}\n\n你愿意现在开始吗？"
   140→    a2ui = {
   141→        "meta": {"summary": "情绪打卡"},
   142→        "ui_components": [
   143→            {"type": "markdown_text", "title": "情绪打卡", "data": md},
   144→            {
   145→                "type": "action_buttons",
   146→                "title": "下一步",
   147→                "data": [
   148→                    {"label": "开始这个动作", "action": {"type": "start_task", "task_id": data["task_id"]}},
   149→                    {"label": "加入今日计划", "action": {"type": "schedule_task", "task_id": data["task_id"]}},
   150→                    {"label": "先不需要", "action": {"type": "opt_out"}},
   151→                ],
   152→            },
   153→        ],
   154→    }

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
