     1→"""
     2→真太阳时八字计算封装。
     3→- 默认出生地：北京，经纬度 (116.4074, 39.9042)
     4→- 若缺经度/纬度则回落到默认，并在返回结果中标记 used_default_location=True
     5→"""
     6→from dataclasses import dataclass
     7→from datetime import datetime
     8→from typing import Dict, Optional, Tuple
     9→
    10→from common.logging import get_logger
    11→
    12→logger = get_logger(__name__)
    13→
    14→DEFAULT_LOCATION = {
    15→    "name": "北京",
    16→    "longitude": 116.4074,
    17→    "latitude": 39.9042,
    18→}
    19→
    20→
    21→@dataclass
    22→class BaziResult:
    23→    year_pillar: str
    24→    month_pillar: str
    25→    day_pillar: str
    26→    hour_pillar: str
    27→    wuxing: Optional[str]
    28→    used_default_location: bool
    29→    location: Dict[str, float]
    30→    calculated_at: datetime
    31→
    32→
    33→def ensure_location(location: Optional[Dict[str, float]]) -> Tuple[Dict[str, float], bool]:
    34→    if not location:
    35→        return DEFAULT_LOCATION, True
    36→    if "longitude" not in location or location.get("longitude") is None:
    37→        merged = {**DEFAULT_LOCATION, **location}
    38→        return merged, True
    39→    return location, False
    40→
    41→
    42→def calculate_bazi(
    43→    year: int,
    44→    month: int,
    45→    day: int,
    46→    hour: int,
    47→    minute: int,
    48→    location: Optional[Dict[str, float]] = None,
    49→) -> BaziResult:
    50→    """
    51→    计算真太阳时八字；需要经度。缺失时使用北京默认经纬度。
    52→    """
    53→    loc, used_default = ensure_location(location)
    54→    try:
    55→        from lunar_python import Solar
    56→    except ImportError as exc:
    57→        logger.error(
    58→            "lunar_python not installed; please `pip install lunar_python`",
    59→            extra={"operation": "bazi_calculate", "error": str(exc)},
    60→        )
    61→        raise
    62→
    63→    solar = Solar.fromYmdHms(year, month, day, hour, minute, 0)
    64→    lunar = solar.getLunar()
    65→    ba_zi = lunar.getEightChar()
    66→
    67→    try:
    68→        wuxing = (
    69→            ba_zi.getYearWuXing()
    70→            + ba_zi.getMonthWuXing()
    71→            + ba_zi.getDayWuXing()
    72→            + ba_zi.getTimeWuXing()
    73→        )
    74→    except Exception:
    75→        wuxing = None
    76→
    77→    result = BaziResult(
    78→        year_pillar=ba_zi.getYear(),
    79→        month_pillar=ba_zi.getMonth(),
    80→        day_pillar=ba_zi.getDay(),
    81→        hour_pillar=ba_zi.getTime(),
    82→        wuxing=wuxing,
    83→        used_default_location=used_default,
    84→        location={"name": loc.get("name", ""), "longitude": loc["longitude"], "latitude": loc.get("latitude", 0.0)},
    85→        calculated_at=datetime.utcnow(),
    86→    )
    87→    logger.info(
    88→        "calculated bazi",
    89→        extra={
    90→            "operation": "bazi_calculate",
    91→            "used_default_location": used_default,
    92→            "longitude": loc["longitude"],
    93→            "latitude": loc.get("latitude"),
    94→        },
    95→    )
    96→    return result
    97→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
