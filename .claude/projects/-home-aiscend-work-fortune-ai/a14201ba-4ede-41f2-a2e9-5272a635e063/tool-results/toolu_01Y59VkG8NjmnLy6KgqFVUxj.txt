1130:def get_full_context_for_chat(user_id: int, query: str = "") -> Dict[str, Any]:
1131-    """获取完整的对话上下文（用于 Chat API）"""
1132-    uid = int(user_id)
1133-
1134-    # 用户偏好
1135-    prefs = fortune_db.fetch_one(
1136-        "SELECT persona_style FROM fortune_user_preferences WHERE user_id = %s",
1137-        (uid,),
1138-    ) or {}
1139-    persona_style = prefs.get("persona_style", "warm")
1140-
1141-    # 用户上下文
1142-    user_context = build_user_context(uid)
1143-
1144-    # 证据
1145-    evidence = build_evidence(uid, query)
1146-
1147-    # 反依赖检查
1148-    anti_dep = check_anti_dependency(uid, query)
1149-
1150-    # System Prompt
1151-    system_prompt = build_system_prompt(uid, persona_style)
1152-
1153-    return {
1154-        "system_prompt": system_prompt,
1155-        "persona_style": persona_style,
1156-        "user_context": user_context,
1157-        "evidence": evidence,
1158-        "anti_dependency": {
1159-            "should_intervene": anti_dep.should_intervene,
1160-            "intervention_type": anti_dep.intervention_type,