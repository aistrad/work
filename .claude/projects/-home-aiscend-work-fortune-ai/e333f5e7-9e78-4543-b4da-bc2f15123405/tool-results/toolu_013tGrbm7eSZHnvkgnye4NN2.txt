from __future__ import annotations

import os
from contextlib import contextmanager
from typing import Any, Dict, Iterable, List, Optional, Sequence, Tuple

try:
    import psycopg2
    from psycopg2 import pool
    from psycopg2.extras import RealDictCursor
except ImportError:  # pragma: no cover
    psycopg2 = None  # type: ignore[assignment]
    pool = None  # type: ignore[assignment]
    RealDictCursor = None  # type: ignore[assignment]


class FortuneDbConfigError(RuntimeError):
    pass


_pool: Optional["pool.ThreadedConnectionPool"] = None


def _require_env(name: str) -> str:
    v = (os.getenv(name) or "").strip()
    if not v:
        raise FortuneDbConfigError(f"missing_env:{name}")
    return v


def _get_dsn() -> str:
    url = (os.getenv("FORTUNE_AI_DB_URL") or os.getenv("FORTUNE_DB_URL") or "").strip()
    if url:
        return url

    host = _require_env("FORTUNE_DB_HOST")
    port = _require_env("FORTUNE_DB_PORT")
    dbname = _require_env("FORTUNE_DB_NAME")
    user = _require_env("FORTUNE_DB_USER")
    password = _require_env("FORTUNE_DB_PASSWORD")
    sslmode = (os.getenv("FORTUNE_DB_SSLMODE") or "prefer").strip()
    return f"host={host} port={port} dbname={dbname} user={user} password={password} sslmode={sslmode}"


def init_pool(minconn: int = 1, maxconn: int = 10) -> None:
    global _pool
    if psycopg2 is None or pool is None:
        raise RuntimeError("psycopg2 not installed")
    if _pool is not None:
        return