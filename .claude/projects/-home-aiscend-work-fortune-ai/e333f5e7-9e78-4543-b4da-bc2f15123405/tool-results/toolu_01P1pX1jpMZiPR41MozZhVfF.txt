     1â†’# Fortune AI åç«¯é‡æ„è®¡åˆ’ (v4.2 Vercel AI SDK Edition)
     2â†’
     3â†’**æ–‡æ¡£ç±»å‹**: Backend Refactoring Plan
     4â†’**ç‰ˆæœ¬**: v4.2
     5â†’**æ—¥æœŸ**: 2026-01-01
     6â†’**ç›®æ ‡**: å°†åç«¯æ¶æ„ä» Python-centric è¿ç§»åˆ° Vercel AI SDK Driven æ¶æ„
     7â†’
     8â†’---
     9â†’
    10â†’## 0. æ‰§è¡Œæ‘˜è¦
    11â†’
    12â†’### 0.1 é‡æ„ç›®æ ‡
    13â†’
    14â†’å°† Fortune AI åç«¯ä»å½“å‰çš„ **Python FastAPI å…¨æ ˆæ¶æ„** é‡æ„ä¸º **Vercel AI SDK Driven åˆ†å±‚æ¶æ„**ï¼š
    15â†’
    16â†’| å½“å‰çŠ¶æ€ | ç›®æ ‡çŠ¶æ€ |
    17â†’|----------|----------|
    18â†’| FastAPI æ‰¿è½½ AI æ¨ç† + æ•°æ®æœåŠ¡ | Next.js API Route æ‰¿è½½ AI æ¨ç† |
    19â†’| `glm_client.py` ç›´æ¥è°ƒç”¨ LLM | `streamText()` + Multi-Model Provider |
    20â†’| è‡ªå®šä¹‰ SSE æ ¼å¼ | `toDataStreamResponse()` æ ‡å‡†æµ |
    21â†’| Python L2 Agents | TypeScript `tool()` Skills |
    22â†’| agent_service è¾…åŠ©è§’è‰² | Agent Runtime æ ¸å¿ƒè§’è‰² |
    23â†’
    24â†’### 0.2 æ ¸å¿ƒæ”¶ç›Š
    25â†’
    26â†’1. **ç«¯åˆ°ç«¯æµå¼æ¸²æŸ“**: `useChat()` â†’ `streamText()` â†’ `toDataStreamResponse()`
    27â†’2. **å¤šæ¨¡å‹çƒ­åˆ‡æ¢**: GLM-4.5 / Gemini / Claude é€šè¿‡ Vercel AI Gateway åŠ¨æ€åˆ‡æ¢
    28â†’3. **Skills å¯æ’æ‹”**: Tool Calling æ ‡å‡†åŒ–ï¼Œæ–°å¢ Expert Agent åªéœ€æ·»åŠ  `tool()` å®šä¹‰
    29â†’4. **maxSteps å¤šæ­¥æ¨ç†**: å•æ¬¡è¯·æ±‚å¯å¤šæ¬¡ Tool è°ƒç”¨åç»¼åˆè¾“å‡º
    30â†’5. **ç±»å‹å®‰å…¨**: Zod Schema å‚æ•°éªŒè¯
    31â†’
    32â†’### 0.3 é£é™©è¯„ä¼°
    33â†’
    34â†’| é£é™© | ç­‰çº§ | ç¼“è§£æªæ–½ |
    35â†’|------|:----:|----------|
    36â†’| API å…¼å®¹æ€§ç ´å | ğŸ”´ é«˜ | åŒè·¯ç”±å¹¶è¡ŒæœŸï¼Œé€æ­¥è¿ç§» |
    37â†’| å‰ç«¯ CSRF é—®é¢˜ | ğŸŸ¡ ä¸­ | Next.js API Route åŒæºï¼Œæ— è·¨åŸŸ |
    38â†’| æ•°æ®æœåŠ¡è°ƒç”¨å»¶è¿Ÿ | ğŸŸ¡ ä¸­ | Tool execute æ‰¹é‡èšåˆï¼Œç¼“å­˜çƒ­ç‚¹æ•°æ® |
    39â†’| å›¢é˜Ÿ TypeScript ç†Ÿç»ƒåº¦ | ğŸŸ¢ ä½ | ç°æœ‰ agent_service å·²æœ‰ TS åŸºç¡€ |
    40â†’| maxSteps é‡å¤å†™å…¥ | ğŸ”´ é«˜ | å¹‚ç­‰æ€§è®¾è®¡ + finalize æœºåˆ¶ |
    41â†’| æµå¼ä¸­æ–­æ•°æ®ä¸ä¸€è‡´ | ğŸ”´ é«˜ | æµå¼ä¸äº‹åŠ¡è§£è€¦ï¼Œfinalize ç»Ÿä¸€æäº¤ |
    42â†’
    43â†’### 0.4 ç›®æ ‡åç«¯å½¢æ€ï¼ˆä¸‰è¿è¡Œå•å…ƒï¼‰
    44â†’
    45â†’é‡æ„åçš„åç«¯æ‹†åˆ†ä¸º **3 ä¸ªå¯ç‹¬ç«‹æ¼”è¿›çš„è¿è¡Œå•å…ƒ**ï¼š
    46â†’
    47â†’```
    48â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    49â†’â”‚                         ç›®æ ‡æ¶æ„ (v4.2)                                       â”‚
    50â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    51â†’
    52â†’Browser
    53â†’    â”‚
    54â†’    â”‚ HTTP
    55â†’    â–¼
    56â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    57â†’â”‚  Reverse Proxy (Nginx/Caddy :80/:443)                                        â”‚
    58â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
    59â†’â”‚  â”‚  è·¯ç”±è§„åˆ™:                                                               â”‚â”‚
    60â†’â”‚  â”‚  /api/chat          â†’ Next.js (:8231)  # Agent Runtime                  â”‚â”‚
    61â†’â”‚  â”‚  /api/landing/*     â†’ Next.js (:8231)  # Landing Page API               â”‚â”‚
    62â†’â”‚  â”‚  /api/*             â†’ FastAPI (:8230)  # Data Service                   â”‚â”‚
    63â†’â”‚  â”‚  /new/*             â†’ Next.js (:8231)  # Frontend                       â”‚â”‚
    64â†’â”‚  â”‚  /admin/*           â†’ Next.js (:8231)  # Admin System                   â”‚â”‚
    65â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
    66â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    67â†’        â”‚                           â”‚                           â”‚
    68â†’        â–¼                           â–¼                           â–¼
    69â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    70â†’â”‚ Next.js Agent     â”‚  â”‚ FastAPI Data Service    â”‚  â”‚ Python Cold Path Worker â”‚
    71â†’â”‚ Runtime (:8231)   â”‚  â”‚ (:8230)                 â”‚  â”‚ (Cron/Queue)            â”‚
    72â†’â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    73â†’â”‚ â€¢ streamText()    â”‚  â”‚ â€¢ Auth/Session          â”‚  â”‚ â€¢ Insight Agent         â”‚
    74â†’â”‚ â€¢ tool() Skills   â”‚  â”‚ â€¢ é¢†åŸŸå†™å…¥ (SSOT)       â”‚  â”‚ â€¢ Memory æ²‰æ·€           â”‚
    75â†’â”‚ â€¢ useChat() æµå¼  â”‚  â”‚ â€¢ ç¡®å®šæ€§è®¡ç®—            â”‚  â”‚ â€¢ å¼‚æ­¥æŠ¥å‘Šç”Ÿæˆ          â”‚
    76â†’â”‚ â€¢ Multi-Model Hub â”‚  â”‚ â€¢ Internal APIs         â”‚  â”‚ â€¢ æ•°æ®æ¸…æ´—              â”‚
    77â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    78â†’        â”‚                           â”‚                           â”‚
    79â†’        â”‚     fetch() / gRPC        â”‚                           â”‚
    80â†’        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    81â†’                                    â”‚
    82â†’                                    â–¼
    83â†’                          PostgreSQL (fortune_ai)
    84â†’```
    85â†’
    86â†’| è¿è¡Œå•å…ƒ | èŒè´£ | æŠ€æœ¯æ ˆ | éƒ¨ç½² |
    87â†’|----------|------|--------|------|
    88â†’| **Agent Runtime** | AI æ¨ç†ã€æµå¼å“åº”ã€Tool Calling | Next.js + Vercel AI SDK | å¯ç‹¬ç«‹æ‰©ç¼© |
    89â†’| **Data Service** | Authã€SSOT å†™å…¥ã€ç¡®å®šæ€§è®¡ç®— | FastAPI + PostgreSQL | æœ‰çŠ¶æ€ï¼Œå•å®ä¾‹ä¼˜å…ˆ |
    90â†’| **Cold Path Worker** | åå°åˆ†æã€Memory æ²‰æ·€ | Python + Celery/Cron | å¼‚æ­¥ï¼Œå¤±è´¥ä¸é˜»å¡ |
    91â†’
    92â†’### 0.5 ä¿¡ä»»è¾¹ç•Œä¸å®‰å…¨åŸåˆ™
    93â†’
    94â†’```
    95â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    96â†’â”‚                         ä¿¡ä»»è¾¹ç•Œ (Trust Boundary)                            â”‚
    97â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    98â†’
    99â†’                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   100â†’                  â”‚            Untrusted Zone               â”‚
   101â†’                  â”‚                                         â”‚
   102â†’                  â”‚   Browser / Mobile App / Third Party    â”‚
   103â†’                  â”‚                                         â”‚
   104â†’                  â”‚   âš ï¸ æ°¸è¿œä¸èƒ½ä¿¡ä»»æ¥è‡ªè¿™é‡Œçš„:             â”‚
   105â†’                  â”‚      â€¢ userId                           â”‚
   106â†’                  â”‚      â€¢ role / permissions               â”‚
   107â†’                  â”‚      â€¢ ä»»ä½•æ•æ„Ÿæ ‡è¯†                      â”‚
   108â†’                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   109â†’                                      â”‚
   110â†’                    Cookie (fortune_session) + HTTPS Only
   111â†’                                      â”‚
   112â†’                                      â–¼
   113â†’                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   114â†’                  â”‚            Trusted Zone                 â”‚
   115â†’                  â”‚                                         â”‚
   116â†’                  â”‚   Next.js API Route / FastAPI           â”‚
   117â†’                  â”‚                                         â”‚
   118â†’                  â”‚   âœ… userId åªèƒ½ä» Session è§£å‡º          â”‚
   119â†’                  â”‚   âœ… session_id å¯ç”±å‰ç«¯ä¼ ä½†å¿…é¡»æ ¡éªŒå½’å± â”‚
   120â†’                  â”‚   âœ… Internal API éœ€ service token       â”‚
   121â†’                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   122â†’```
   123â†’
   124â†’**å…³é”®è§„åˆ™**ï¼š
   125â†’
   126â†’1. **userId ä¸ä¼ **: å‰ç«¯è¯·æ±‚ä½“æ°¸è¿œä¸åŒ…å« `userId`ï¼Œç”±æœåŠ¡ç«¯ä» Cookie Session è§£å‡º
   127â†’2. **session_id æ ¡éªŒ**: å¦‚å‰ç«¯ä¼  `session_id`ï¼Œåç«¯å¿…é¡»æ ¡éªŒè¯¥ session å½’å±å½“å‰ç”¨æˆ·
   128â†’3. **Internal API éš”ç¦»**: `/internal/*` ç«¯ç‚¹ä¸æš´éœ²ç»™æµè§ˆå™¨ï¼Œéœ€ service token æˆ– IP ç™½åå•
   129â†’
   130â†’### 0.6 å·¥ç¨‹åŒ–åŸåˆ™ï¼ˆå†³å®šé‡æ„æˆè´¥ï¼‰
   131â†’
   132â†’#### 0.6.1 æµå¼ä¸äº‹åŠ¡è§£è€¦
   133â†’
   134â†’```
   135â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   136â†’â”‚                    Chat Run Lifecycle (æµå¼ç”Ÿå‘½å‘¨æœŸ)                          â”‚
   137â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   138â†’
   139â†’ç”¨æˆ·æ¶ˆæ¯ â”€â”€â–¶ run/start â”€â”€â–¶ streamText() â”€â”€â–¶ Toolè°ƒç”¨(Næ¬¡) â”€â”€â–¶ run/finalize
   140â†’   â”‚            â”‚              â”‚                â”‚                  â”‚
   141â†’   â”‚            â”‚              â”‚                â”‚                  â”‚
   142â†’   â–¼            â–¼              â–¼                â–¼                  â–¼
   143â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   144â†’â”‚ç”¨æˆ·æ¶ˆæ¯â”‚ â”‚ run_id  â”‚   â”‚ æµå¼è¾“å‡º â”‚    â”‚ å·¥å…·ç»“æœ  â”‚      â”‚ ç»Ÿä¸€æäº¤    â”‚
   145â†’â”‚ å…¥åº“  â”‚ â”‚ è®°å½•    â”‚   â”‚ (ä¸è½åº“) â”‚    â”‚ (å†…å­˜æš‚å­˜)â”‚      â”‚ äº‹åŠ¡å†™å…¥    â”‚
   146â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   147â†’
   148â†’                                                                   â”‚
   149â†’                                                                   â–¼
   150â†’                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   151â†’                                                          â”‚ ä¸€æ¬¡äº‹åŠ¡åŒ…å«:   â”‚
   152â†’                                                          â”‚ â€¢ assistant msg â”‚
   153â†’                                                          â”‚ â€¢ commitments   â”‚
   154â†’                                                          â”‚ â€¢ tool_log      â”‚
   155â†’                                                          â”‚ â€¢ twin updates  â”‚
   156â†’                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   157â†’```
   158â†’
   159â†’**è§„åˆ™**ï¼š
   160â†’- æµå¼è¿‡ç¨‹ä¸­åªåš"å¯é‡æ”¾"è®°å½•ï¼ˆrun_idã€ç”¨æˆ·æ¶ˆæ¯ï¼‰
   161â†’- Tool æ‰§è¡Œç»“æœæš‚å­˜å†…å­˜ï¼Œä¸ç›´æ¥å†™ DB
   162â†’- `finalize` æ—¶ç»Ÿä¸€äº‹åŠ¡æäº¤
   163â†’- ä¸­æ–­åˆ™æ ‡è®° `aborted`ï¼Œé¿å…åŠæ¡æ¶ˆæ¯è¿› SSOT
   164â†’
   165â†’#### 0.6.2 å…¨é“¾è·¯ correlation_id
   166â†’
   167â†’```typescript
   168â†’// Next.js API Route å…¥å£ç”Ÿæˆ
   169â†’export async function POST(req: Request) {
   170â†’  const correlationId = req.headers.get('x-correlation-id')
   171â†’    || `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;
   172â†’
   173â†’  // é€ä¼ åˆ° FastAPI
   174â†’  const context = await fetch(`${FASTAPI_URL}/internal/context`, {
   175â†’    headers: { 'X-Correlation-ID': correlationId },
   176â†’  });
   177â†’
   178â†’  // é€ä¼ åˆ° Tool æ‰§è¡Œ
   179â†’  const result = streamText({
   180â†’    // ...
   181â†’    onStepFinish({ toolCalls }) {
   182â†’      logger.info({ correlationId, toolCalls }, 'Step finished');
   183â†’    },
   184â†’  });
   185â†’}
   186â†’```
   187â†’
   188â†’**ç”¨é€”**ï¼šä¸²è”"å¯¹è¯ â†’ Tool è°ƒç”¨ â†’ å†™å…¥ â†’ å¤±è´¥åŸå› "ï¼Œä¾¿äº debug å’Œå®¡è®¡ã€‚
   189â†’
   190â†’#### 0.6.3 ç»Ÿä¸€é”™è¯¯è¯­ä¹‰
   191â†’
   192â†’```typescript
   193â†’// Public API å“åº”æ ¼å¼
   194â†’interface ApiResponse<T> {
   195â†’  ok: boolean;
   196â†’  data?: T;
   197â†’  error?: {
   198â†’    code: string;        // 'AUTH_REQUIRED' | 'RATE_LIMITED' | 'TOOL_FAILED' | ...
   199â†’    message: string;     // ç”¨æˆ·å¯è¯»æ¶ˆæ¯
   200â†’    detail?: unknown;    // è°ƒè¯•ä¿¡æ¯ï¼ˆä»… dev ç¯å¢ƒï¼‰
   201â†’    correlation_id?: string;
   202â†’  };
   203â†’}
   204â†’
   205â†’// Tool æ‰§è¡Œå¤±è´¥è¿”å›ï¼ˆå¯æ¸²æŸ“ä¸º Toast æˆ– ErrorCardï¼‰
   206â†’interface ToolError {
   207â†’  type: 'tool_error';
   208â†’  tool_name: string;
   209â†’  error_code: string;
   210â†’  user_message: string;  // "å…«å­—è®¡ç®—æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
   211â†’}
   212â†’```
   213â†’
   214â†’---
   215â†’
   216â†’## 1. ç°çŠ¶åˆ†æ
   217â†’
   218â†’### 1.1 å½“å‰æ¶æ„
   219â†’
   220â†’```
   221â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   222â†’â”‚                         å½“å‰æ¶æ„ (v4.0/v4.1)                                  â”‚
   223â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   224â†’
   225â†’Browser (:8231/new)
   226â†’    â”‚
   227â†’    â”‚ HTTP (fetch + SSE)
   228â†’    â–¼
   229â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   230â†’â”‚  FastAPI (:8230)                                                          â”‚
   231â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   232â†’â”‚  â”‚  19 Route Files                                                     â”‚  â”‚
   233â†’â”‚  â”‚  auth_routes / chat_routes / dashboard_routes / bazi_routes ...    â”‚  â”‚
   234â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   235â†’â”‚                              â”‚                                            â”‚
   236â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   237â†’â”‚  â”‚  Services Layer           â–¼                                        â”‚  â”‚
   238â†’â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
   239â†’â”‚  â”‚  â”‚glm_client.pyâ”‚ â”‚bazi_engine  â”‚ â”‚twin_service â”‚ â”‚goal_service â”‚  â”‚  â”‚
   240â†’â”‚  â”‚  â”‚ (LLM è°ƒç”¨)  â”‚ â”‚  (L0 è®¡ç®—) â”‚ â”‚ (çŠ¶æ€ç®¡ç†) â”‚ â”‚ (ç›®æ ‡ç®¡ç†) â”‚  â”‚  â”‚
   241â†’â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
   242â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   243â†’â”‚                              â”‚                                            â”‚
   244â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   245â†’â”‚  â”‚  Agent Service Client     â”‚ (HTTP è°ƒç”¨ TypeScript Agent)          â”‚  â”‚
   246â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   247â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   248â†’                               â”‚
   249â†’                               â–¼
   250â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   251â†’â”‚  Agent Service (:3000) - Express + Vercel AI SDK                          â”‚
   252â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   253â†’â”‚  â”‚  coach.ts: runCoachAgent() - ä½†ä»…ä½œä¸ºè¾…åŠ©ï¼Œä¸»æµé‡ä»èµ° Python         â”‚ â”‚
   254â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   255â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   256â†’                               â”‚
   257â†’                               â–¼
   258â†’                        PostgreSQL (fortune_ai)
   259â†’```
   260â†’
   261â†’### 1.2 ç°æœ‰æ–‡ä»¶æ¸…å•
   262â†’
   263â†’**API Routes (19 ä¸ª)**:
   264â†’```
   265â†’api/
   266â†’â”œâ”€â”€ auth_routes.py        # è®¤è¯ (register/login/logout)
   267â†’â”œâ”€â”€ chat_routes.py        # å¯¹è¯ (send/stream) âš ï¸ æ ¸å¿ƒé‡æ„å¯¹è±¡
   268â†’â”œâ”€â”€ dashboard_routes.py   # Dashboard Zone B
   269â†’â”œâ”€â”€ bazi_routes.py        # å…«å­—è®¡ç®—
   270â†’â”œâ”€â”€ bento_routes.py       # Bento 6 å¡ç‰‡ (legacy)
   271â†’â”œâ”€â”€ twin_routes.py        # æ•°å­—å­ªç”Ÿ
   272â†’â”œâ”€â”€ goal_routes.py        # ç›®æ ‡ç®¡ç†
   273â†’â”œâ”€â”€ reflection_routes.py  # å¤ç›˜
   274â†’â”œâ”€â”€ report_routes.py      # æ·±åº¦æŠ¥å‘Š
   275â†’â”œâ”€â”€ poster_routes.py      # æµ·æŠ¥ç”Ÿæˆ
   276â†’â”œâ”€â”€ yunshi_routes.py      # è¿åŠ¿
   277â†’â”œâ”€â”€ plan_routes.py        # è®¡åˆ’
   278â†’â”œâ”€â”€ kb_routes.py          # çŸ¥è¯†åº“
   279â†’â”œâ”€â”€ session_routes.py     # ä¼šè¯ç®¡ç†
   280â†’â”œâ”€â”€ user_routes.py        # ç”¨æˆ·èµ„æ–™
   281â†’â”œâ”€â”€ social_routes.py      # ç¤¾äº¤
   282â†’â”œâ”€â”€ push_routes.py        # æ¨é€
   283â†’â”œâ”€â”€ currency_routes.py    # è´§å¸
   284â†’â”œâ”€â”€ jitai_routes.py       # å‰å°
   285â†’â”œâ”€â”€ agent_tool.py         # Agent å·¥å…· API
   286â†’â”œâ”€â”€ deps.py               # ä¾èµ–æ³¨å…¥
   287â†’â””â”€â”€ main.py               # å…¥å£
   288â†’```
   289â†’
   290â†’**Services (æ ¸å¿ƒ)**:
   291â†’```
   292â†’services/
   293â†’â”œâ”€â”€ glm_client.py          # âš ï¸ å¾…åˆ é™¤ï¼šç›´æ¥ LLM è°ƒç”¨
   294â†’â”œâ”€â”€ chat_service.py        # ä¼šè¯æ¶ˆæ¯ç®¡ç†
   295â†’â”œâ”€â”€ bazi_engine.py         # L0 å…«å­—è®¡ç®— âœ… ä¿ç•™
   296â†’â”œâ”€â”€ bazi_facts.py          # äº‹å®æå– âœ… ä¿ç•™
   297â†’â”œâ”€â”€ twin_service.py        # æ•°å­—å­ªç”Ÿ âœ… ä¿ç•™
   298â†’â”œâ”€â”€ goal_service.py        # ç›®æ ‡ç®¡ç† âœ… ä¿ç•™
   299â†’â”œâ”€â”€ reflection_service.py  # å¤ç›˜ âœ… ä¿ç•™
   300â†’â”œâ”€â”€ soul_os.py             # ä¸Šä¸‹æ–‡ç»„è£… âš ï¸ é‡æ„
   301â†’â”œâ”€â”€ agent_service_client.py # âš ï¸ å¾…åˆ é™¤ï¼šæ”¹ä¸º Next.js å†…éƒ¨è°ƒç”¨
   302â†’â””â”€â”€ ...
   303â†’```
   304â†’
   305â†’### 1.3 å…³é”®ç—›ç‚¹
   306â†’
   307â†’| ç—›ç‚¹ | å½±å“ | æ ¹å›  |
   308â†’|------|------|------|
   309â†’| åŒè¯­è¨€äº¤äº’å¤æ‚ | ç»´æŠ¤æˆæœ¬é«˜ | Python/TS è¾¹ç•Œä¸æ¸…æ™° |
   310â†’| æµå¼æ¸²æŸ“éæ ‡å‡† | å‰ç«¯é€‚é…å›°éš¾ | è‡ªå®šä¹‰ SSE æ ¼å¼ |
   311â†’| LLM è°ƒç”¨åˆ†æ•£ | éš¾ä»¥ç»Ÿä¸€ç®¡ç† | glm_client + agent_service å¹¶å­˜ |
   312â†’| Tool Calling æ‰‹åŠ¨ | æ‰©å±•å›°éš¾ | æ— æ ‡å‡†åŒ– Skills æ¡†æ¶ |
   313â†’| A2UI éæµå¼ | é¦–å­—å»¶è¿Ÿé«˜ | JSON æ•´ä½“è¿”å› |
   314â†’
   315â†’---
   316â†’
   317â†’## 2. ç›®æ ‡æ¶æ„
   318â†’
   319â†’### 2.1 æ¶æ„å›¾
   320â†’
   321â†’```
   322â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   323â†’â”‚                         ç›®æ ‡æ¶æ„ (v4.2 Vercel AI SDK)                         â”‚
   324â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   325â†’
   326â†’Browser
   327â†’    â”‚
   328â†’    â”‚ useChat() Hook
   329â†’    â–¼
   330â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   331â†’â”‚  Next.js (:8231)                                                          â”‚
   332â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   333â†’â”‚  â”‚  app/api/chat/route.ts   â† Agent Runtime (æ ¸å¿ƒ)                     â”‚  â”‚
   334â†’â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
   335â†’â”‚  â”‚  â”‚  streamText({                                                 â”‚ â”‚  â”‚
   336â†’â”‚  â”‚  â”‚    model: selectModel(),     // GLM / Gemini / Claude         â”‚ â”‚  â”‚
   337â†’â”‚  â”‚  â”‚    system: buildSystemPrompt(context),                        â”‚ â”‚  â”‚
   338â†’â”‚  â”‚  â”‚    tools: getToolsForMode(mode),                              â”‚ â”‚  â”‚
   339â†’â”‚  â”‚  â”‚    maxSteps: 5,                                               â”‚ â”‚  â”‚
   340â†’â”‚  â”‚  â”‚  }) â†’ toDataStreamResponse()                                  â”‚ â”‚  â”‚
   341â†’â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
   342â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   343â†’â”‚                              â”‚                                            â”‚
   344â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   345â†’â”‚  â”‚  Skills Registry          â–¼                                        â”‚  â”‚
   346â†’â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚  â”‚
   347â†’â”‚  â”‚  â”‚Divine Skillsâ”‚ â”‚ Heal Skills â”‚ â”‚ Grow Skills â”‚                  â”‚  â”‚
   348â†’â”‚  â”‚  â”‚calculate_   â”‚ â”‚log_perma    â”‚ â”‚covey_matrix â”‚                  â”‚  â”‚
   349â†’â”‚  â”‚  â”‚  bazi/ziwei â”‚ â”‚cbt_reframe  â”‚ â”‚goal_setting â”‚                  â”‚  â”‚
   350â†’â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚  â”‚
   351â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   352â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   353â†’             â”‚               â”‚               â”‚
   354â†’             â”‚ fetch()       â”‚ fetch()       â”‚ fetch()
   355â†’             â–¼               â–¼               â–¼
   356â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   357â†’â”‚  FastAPI (:8230) - çº¯æ•°æ®æœåŠ¡å±‚                                            â”‚
   358â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   359â†’â”‚  â”‚  Data Service APIs (æ—  LLM è°ƒç”¨)                                    â”‚  â”‚
   360â†’â”‚  â”‚  /api/bazi/calculate     /api/perma/log      /api/goals/create     â”‚  â”‚
   361â†’â”‚  â”‚  /api/user/context       /api/twin/update    /api/tasks/create     â”‚  â”‚
   362â†’â”‚  â”‚  /api/landing/insight    /api/kb/search      /api/checkin/mood     â”‚  â”‚
   363â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   364â†’â”‚                              â”‚                                            â”‚
   365â†’â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   366â†’â”‚  â”‚  Services Layer (ä¿ç•™)    â”‚                                        â”‚  â”‚
   367â†’â”‚  â”‚  bazi_engine / twin_service / goal_service / reflection_service   â”‚  â”‚
   368â†’â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   369â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   370â†’                               â”‚
   371â†’                               â–¼
   372â†’                        PostgreSQL (fortune_ai)
   373â†’```
   374â†’
   375â†’### 2.2 èŒè´£è¾¹ç•Œ
   376â†’
   377â†’| å±‚çº§ | è¿è¡Œç¯å¢ƒ | èŒè´£ | æŠ€æœ¯æ ˆ |
   378â†’|------|----------|------|--------|
   379â†’| **Frontend** | Browser | UI æ¸²æŸ“ã€æµå¼å±•ç¤ºã€Command è¾“å…¥ | React + `useChat()` |
   380â†’| **Agent Runtime** | Next.js API Route | AI æ¨ç†ã€Tool Callingã€æµå¼è¾“å‡º | `streamText()` + `tool()` |
   381â†’| **Skills Registry** | Next.js | å¯æ’æ‹”æŠ€èƒ½å®šä¹‰ | Zod Schema + execute |
   382â†’| **Data Service** | FastAPI | L0/L1 æ•°æ® CRUDã€è®¡ç®—é€»è¾‘ | Python + PostgreSQL |
   383â†’| **Insight Agent** | Cron Worker | Cold Path æ•°æ®æ²‰æ·€ | Python |
   384â†’
   385â†’### 2.3 API ç«¯ç‚¹è§„åˆ’
   386â†’
   387â†’**Next.js API Routes (æ–°å¢)**:
   388â†’```typescript
   389â†’// Agent Runtime
   390â†’POST /api/chat           // streamText() ä¸»å…¥å£
   391â†’POST /api/command        // /divine /heal /grow æŒ‡ä»¤è·¯ç”±
   392â†’
   393â†’// Landing Page (å¯é€‰è¿ç§»)
   394â†’POST /api/landing/insight  // å³æ—¶æ´å¯Ÿ (æ— éœ€ç™»å½•)
   395â†’```
   396â†’
   397â†’**FastAPI Data Service (é‡æ„)**:
   398â†’```python
   399â†’# L0 Base Data
   400â†’GET  /api/user/context        # èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡
   401â†’GET  /api/user/profile        # ç”¨æˆ·èµ„æ–™
   402â†’PUT  /api/user/profile        # æ›´æ–°èµ„æ–™
   403â†’
   404â†’# L1 Module Data - Divine
   405â†’POST /api/bazi/calculate      # å…«å­—è®¡ç®—
   406â†’POST /api/ziwei/calculate     # ç´«å¾®è®¡ç®—
   407â†’GET  /api/bazi/facts/{user_id}  # è·å–äº‹å®
   408â†’
   409â†’# L1 Module Data - Heal
   410â†’POST /api/perma/log           # PERMA è®°å½•
   411â†’GET  /api/perma/query         # PERMA æŸ¥è¯¢
   412â†’POST /api/checkin/mood        # æƒ…ç»ªæ‰“å¡
   413â†’
   414â†’# L1 Module Data - Grow
   415â†’POST /api/goals/create        # åˆ›å»ºç›®æ ‡
   416â†’GET  /api/goals/active        # æ´»è·ƒç›®æ ‡
   417â†’POST /api/tasks/create        # åˆ›å»ºä»»åŠ¡
   418â†’PUT  /api/tasks/{id}/complete # å®Œæˆä»»åŠ¡
   419â†’
   420â†’# Twin
   421â†’GET  /api/twin/{user_id}      # è·å–å­ªç”Ÿæ•°æ®
   422â†’PUT  /api/twin/update         # æ›´æ–°å­ªç”Ÿ
   423â†’
   424â†’# KB
   425â†’POST /api/kb/search           # çŸ¥è¯†åº“æ£€ç´¢
   426â†’
   427â†’# ä¿ç•™ (æš‚ä¸è¿ç§»)
   428â†’/api/auth/*                   # è®¤è¯
   429â†’/api/report/*                 # æ·±åº¦æŠ¥å‘Š
   430â†’/api/poster/*                 # æµ·æŠ¥
   431â†’/api/dashboard/*              # Dashboard
   432â†’```
   433â†’
   434â†’### 2.4 Internal Contract APIsï¼ˆå†…éƒ¨å¥‘çº¦ï¼‰
   435â†’
   436â†’ä¸º Agent Runtime ä¸ FastAPI ä¹‹é—´çš„é€šä¿¡å®šä¹‰ä¸¤ä¸ªæ ¸å¿ƒå¥‘çº¦ï¼Œæ¯”ç»§ç»­å¤ç”¨ `chat_routes.py` æ›´å¹²å‡€ï¼š
   437â†’
   438â†’#### 2.4.1 Context APIï¼ˆä¸Šä¸‹æ–‡èšåˆï¼‰
   439â†’
   440â†’```python
   441â†’# FastAPI: api/internal_routes.py
   442â†’# åªå¯¹å†…éƒ¨è°ƒç”¨å¼€æ”¾ï¼Œéœ€ X-Service-Token æˆ– IP ç™½åå•
   443â†’
   444â†’@router.get("/internal/context")
   445â†’async def get_context(
   446â†’    session_id: str = Query(None),
   447â†’    user: AuthUser = Depends(get_current_user_from_cookie),
   448â†’    x_correlation_id: str = Header(None),
   449â†’) -> ContextResponse:
   450â†’    """
   451â†’    ä¸€æ¬¡æ€§èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œå‡å°‘ Agent Runtime çš„ fetch æ¬¡æ•°
   452â†’    """
   453â†’    return ContextResponse(
   454â†’        l0=UserProfile(
   455â†’            user_id=user.id,
   456â†’            display_name=user.name,
   457â†’            birth_info=get_birth_info(user.id),
   458â†’            preferences=get_preferences(user.id),
   459â†’        ),
   460â†’        l1=ModuleData(
   461â†’            bazi_chart=get_latest_bazi(user.id),
   462â†’            perma_recent=get_perma_summary(user.id, days=7),
   463â†’            active_goals=get_active_goals(user.id, limit=3),
   464â†’            twin_status=get_twin_status(user.id),
   465â†’        ),
   466â†’        policy_flags=PolicyFlags(
   467â†’            allow_roast=user.preferences.get('allow_roast', False),
   468â†’            model_override=user.preferences.get('model'),
   469â†’        ),
   470â†’        history_excerpt=get_recent_messages(user.id, limit=10),
   471â†’    )
   472â†’```
   473â†’
   474â†’**Response Schema**:
   475â†’```typescript
   476â†’interface ContextResponse {
   477â†’  l0: {
   478â†’    user_id: string;
   479â†’    display_name: string;
   480â†’    birth_info: { year: number; month: number; day: number; hour?: number };
   481â†’    preferences: Record<string, unknown>;
   482â†’  };
   483â†’  l1: {
   484â†’    bazi_chart?: BaziChart;
   485â†’    perma_recent?: PermaScore[];
   486â†’    active_goals?: Goal[];
   487â†’    twin_status?: TwinStatus;
   488â†’  };
   489â†’  policy_flags: {
   490â†’    allow_roast: boolean;
   491â†’    model_override?: 'glm' | 'gemini' | 'claude';
   492â†’  };
   493â†’  history_excerpt: Message[];
   494â†’}
   495â†’```
   496â†’
   497â†’#### 2.4.2 Chat Persistence APIï¼ˆæµå¼æŒä¹…åŒ–ï¼‰
   498â†’
   499â†’```python
   500â†’# FastAPI: api/internal_routes.py
   501â†’
   502â†’@router.post("/internal/chat/run/start")
   503â†’async def start_chat_run(
   504â†’    request: StartRunRequest,
   505â†’    user: AuthUser = Depends(get_current_user_from_cookie),
   506â†’) -> StartRunResponse:
   507â†’    """
   508â†’    æµå¼å¼€å§‹æ—¶è°ƒç”¨ï¼šè®°å½• run_id + ç”¨æˆ·æ¶ˆæ¯
   509â†’    """
   510â†’    run_id = str(uuid4())
   511â†’
   512â†’    # åªå†™å…¥ç”¨æˆ·æ¶ˆæ¯ï¼ˆassistant æ¶ˆæ¯åœ¨ finalize å†™å…¥ï¼‰
   513â†’    await db.execute("""
   514â†’        INSERT INTO chat_runs (id, user_id, session_id, status, started_at)
   515â†’        VALUES ($1, $2, $3, 'running', NOW())
   516â†’    """, run_id, user.id, request.session_id)
   517â†’
   518â†’    await db.execute("""
   519â†’        INSERT INTO chat_messages (run_id, role, content, created_at)
   520â†’        VALUES ($1, 'user', $2, NOW())
   521â†’    """, run_id, request.user_message)
   522â†’
   523â†’    return StartRunResponse(run_id=run_id)
   524â†’
   525â†’@router.post("/internal/chat/run/finalize")
   526â†’async def finalize_chat_run(
   527â†’    request: FinalizeRunRequest,
   528â†’    user: AuthUser = Depends(get_current_user_from_cookie),
   529â†’) -> FinalizeRunResponse:
   530â†’    """
   531â†’    æµå¼ç»“æŸæ—¶è°ƒç”¨ï¼šä¸€æ¬¡äº‹åŠ¡å†™å…¥æ‰€æœ‰å‰¯ä½œç”¨
   532â†’    """
   533â†’    async with db.transaction():
   534â†’        # 1. æ›´æ–° run çŠ¶æ€
   535â†’        await db.execute("""
   536â†’            UPDATE chat_runs
   537â†’            SET status = $2, finished_at = NOW()
   538â†’            WHERE id = $1
   539â†’        """, request.run_id, 'completed' if request.success else 'aborted')
   540â†’
   541â†’        # 2. å†™å…¥ assistant æ¶ˆæ¯
   542â†’        if request.assistant_message:
   543â†’            await db.execute("""
   544â†’                INSERT INTO chat_messages (run_id, role, content, created_at)
   545â†’                VALUES ($1, 'assistant', $2, NOW())
   546â†’            """, request.run_id, request.assistant_message)
   547â†’
   548â†’        # 3. å†™å…¥ tool è°ƒç”¨æ—¥å¿—
   549â†’        for tool_log in request.tool_logs:
   550â†’            await db.execute("""
   551â†’                INSERT INTO tool_invocations
   552â†’                (run_id, tool_name, input, output, latency_ms, idempotency_key)
   553â†’                VALUES ($1, $2, $3, $4, $5, $6)
   554â†’                ON CONFLICT (idempotency_key) DO NOTHING
   555â†’            """, request.run_id, tool_log.name, tool_log.input,
   556â†’                tool_log.output, tool_log.latency_ms, tool_log.idempotency_key)
   557â†’
   558â†’        # 4. å†™å…¥ commitmentsï¼ˆæ‰¿è¯º/ä»»åŠ¡ï¼‰
   559â†’        for commitment in request.commitments:
   560â†’            await create_commitment(user.id, commitment)
   561â†’
   562â†’        # 5. æ›´æ–° twin çŠ¶æ€
   563â†’        if request.twin_updates:
   564â†’            await update_twin(user.id, request.twin_updates)
   565â†’
   566â†’    return FinalizeRunResponse(ok=True)
   567â†’```
   568â†’
   569â†’**Request/Response Schema**:
   570â†’```typescript
   571â†’interface StartRunRequest {
   572â†’  session_id?: string;
   573â†’  user_message: string;
   574â†’  correlation_id: string;
   575â†’}
   576â†’
   577â†’interface FinalizeRunRequest {
   578â†’  run_id: string;
   579â†’  success: boolean;
   580â†’  assistant_message?: string;
   581â†’  tool_logs: ToolLog[];
   582â†’  commitments: Commitment[];
   583â†’  twin_updates?: TwinUpdate;
   584â†’}
   585â†’
   586â†’interface ToolLog {
   587â†’  name: string;
   588â†’  input: Record<string, unknown>;
   589â†’  output: Record<string, unknown>;
   590â†’  latency_ms: number;
   591â†’  idempotency_key: string;  // ç”¨äºé˜²æ­¢ maxSteps é‡å¤å†™å…¥
   592â†’}
   593â†’```
   594â†’
   595â†’### 2.5 A2UI è¿ç§»æ–¹æ¡ˆï¼ˆToolResultCardï¼‰
   596â†’
   597â†’å°† A2UI ä»"æ•´æ®µ JSON ä½œä¸º assistant content"è¿ç§»ä¸º"ToolResultCard + æ•™ç»ƒè¡¨è¾¾"æ¨¡å¼ï¼š
   598â†’
   599â†’#### 2.5.1 ç°çŠ¶ vs ç›®æ ‡
   600â†’
   601â†’```
   602â†’ã€ç°çŠ¶ã€‘A2UI ä½œä¸º assistant message content
   603â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   604â†’â”‚ { role: 'assistant',                                            â”‚
   605â†’â”‚   content: '{"type":"a2ui","cards":[{"type":"bazi_chart",...}]}'â”‚
   606â†’â”‚ }                                                               â”‚
   607â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   608â†’
   609â†’ã€ç›®æ ‡ã€‘ToolResultCard + assistant content åˆ†ç¦»
   610â†’â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   611â†’â”‚ {                                                               â”‚
   612â†’â”‚   role: 'assistant',                                            â”‚
   613â†’â”‚   content: 'æ ¹æ®ä½ çš„å…«å­—ï¼Œä½ æ˜¯ä¸€ä¸ª...',  // æ•™ç»ƒè¡¨è¾¾           â”‚
   614â†’â”‚   toolInvocations: [                                            â”‚
   615â†’â”‚     {                                                           â”‚
   616â†’â”‚       toolName: 'calculate_bazi',                               â”‚
   617â†’â”‚       state: 'result',                                          â”‚
   618â†’â”‚       result: {                                                 â”‚
   619â†’â”‚         type: 'a2ui_card',                                      â”‚
   620â†’â”‚         card_type: 'bazi_chart',                                â”‚
   621â†’â”‚         data: { ... }                                           â”‚
   622â†’â”‚       }                                                         â”‚
   623â†’â”‚     }                                                           â”‚
   624â†’â”‚   ]                                                             â”‚
   625â†’â”‚ }                                                               â”‚
   626â†’â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   627â†’```
   628â†’
   629â†’#### 2.5.2 ToolResultCard Schema
   630â†’
   631â†’```typescript
   632â†’// lib/types/a2ui-card.ts
   633â†’
   634â†’interface ToolResultCard {
   635â†’  type: 'a2ui_card';
   636â†’  card_type: CardType;
   637â†’  data: CardData;
   638â†’  actions?: CardAction[];
   639â†’}
   640â†’
   641â†’type CardType =
   642â†’  | 'bazi_chart'      // å…«å­—å‘½ç›˜
   643â†’  | 'perma_radar'     // PERMA é›·è¾¾å›¾
   644â†’  | 'goal_progress'   // ç›®æ ‡è¿›åº¦
   645â†’  | 'commitment_card' // æ‰¿è¯ºå¡ç‰‡
   646â†’  | 'insight_card'    // æ´å¯Ÿå¡ç‰‡
   647â†’  | 'kline_chart'     // Kçº¿å›¾
   648â†’  | 'error_toast';    // é”™è¯¯æç¤º
   649â†’
   650â†’interface CardAction {
   651â†’  type: 'accept' | 'done' | 'skip' | 'navigate' | 'share';
   652â†’  label: string;
   653â†’  endpoint?: string;   // ä»…æ˜ å°„åˆ° SSOT çŠ¶æ€æœºè·ƒè¿ç«¯ç‚¹
   654â†’  payload?: Record<string, unknown>;
   655â†’}
   656â†’
   657â†’// å‰ç«¯æ¸²æŸ“
   658â†’function ToolResultRenderer({ toolInvocation }) {
   659â†’  if (toolInvocation.result?.type === 'a2ui_card') {
   660â†’    const { card_type, data, actions } = toolInvocation.result;
   661â†’    switch (card_type) {
   662â†’      case 'bazi_chart':
   663â†’        return <BaziChartCard data={data} actions={actions} />;
   664â†’      case 'commitment_card':
   665â†’        return <CommitmentCard data={data} actions={actions} />;
   666â†’      // ...
   667â†’    }
   668â†’  }
   669â†’  return null;
   670â†’}
   671â†’```
   672â†’
   673â†’#### 2.5.3 ActionButton çº¦æŸ
   674â†’
   675â†’**å…³é”®è§„åˆ™**ï¼šActionButton çš„ `type` åªèƒ½æ˜ å°„åˆ°ä»¥ä¸‹ SSOT çŠ¶æ€æœºè·ƒè¿ç«¯ç‚¹ï¼Œä¸å…è®¸ç»„ä»¶ç§è‡ªå®šä¹‰å†™æ“ä½œï¼š
   676â†’
   677â†’| action.type | æ˜ å°„ç«¯ç‚¹ | è¯´æ˜ |
   678â†’|-------------|----------|------|
   679â†’| `accept` | `POST /api/dashboard/task/accept` | æ¥å—ä»»åŠ¡ |
   680â†’| `done` | `POST /api/dashboard/task/done` | å®Œæˆä»»åŠ¡ |
   681â†’| `skip` | `POST /api/dashboard/task/skip` | è·³è¿‡ä»»åŠ¡ |
   682â†’| `checkin` | `POST /api/dashboard/checkin` | æƒ…ç»ªæ‰“å¡ |
   683â†’| `navigate` | å‰ç«¯è·¯ç”± | é¡µé¢è·³è½¬ï¼ˆæ— å†™æ“ä½œï¼‰ |
   684â†’| `share` | `POST /api/social/share` | åˆ†äº«å¡ç‰‡ |
   685â†’
   686â†’### 2.6 å¹‚ç­‰æ€§è®¾è®¡
   687â†’
   688â†’é˜²æ­¢ `maxSteps` å¤šæ­¥æ¨ç†ä¸‹çš„é‡å¤å†™å…¥ï¼š
   689â†’
   690â†’#### 2.6.1 idempotency_key ç­–ç•¥
   691â†’
   692â†’```typescript
   693â†’// lib/skills/divine-skills.ts
   694â†’
   695â†’export const calculateBazi = tool({
   696â†’  description: 'è®¡ç®—ç”¨æˆ·çš„å…«å­—å‘½ç›˜',
   697â†’  parameters: z.object({
   698â†’    birth_datetime: z.string(),
   699â†’    timezone: z.string().default('Asia/Shanghai'),
   700â†’  }),
   701â†’  execute: async ({ birth_datetime, timezone }, { runId, stepIndex }) => {
   702â†’    // ç”Ÿæˆå¹‚ç­‰é”®ï¼šrun_id + step_index + tool_name + params_hash
   703â†’    const idempotencyKey = `${runId}:${stepIndex}:calculate_bazi:${hash({ birth_datetime, timezone })}`;
   704â†’
   705â†’    const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
   706â†’      method: 'POST',
   707â†’      headers: {
   708â†’        'Content-Type': 'application/json',
   709â†’        'X-Idempotency-Key': idempotencyKey,
   710â†’      },
   711â†’      body: JSON.stringify({ birth_datetime, timezone }),
   712â†’    });
   713â†’
   714â†’    return res.json();
   715â†’  },
   716â†’});
   717â†’```
   718â†’
   719â†’#### 2.6.2 FastAPI å¹‚ç­‰æ€§å¤„ç†
   720â†’
   721â†’```python
   722â†’# api/middleware/idempotency.py
   723â†’
   724â†’@app.middleware("http")
   725â†’async def idempotency_middleware(request: Request, call_next):
   726â†’    idempotency_key = request.headers.get("X-Idempotency-Key")
   727â†’
   728â†’    if idempotency_key and request.method in ("POST", "PUT"):
   729â†’        # æ£€æŸ¥æ˜¯å¦å·²æ‰§è¡Œ
   730â†’        cached = await redis.get(f"idempotency:{idempotency_key}")
   731â†’        if cached:
   732â†’            return JSONResponse(content=json.loads(cached))
   733â†’
   734â†’        response = await call_next(request)
   735â†’
   736â†’        # ç¼“å­˜ç»“æœï¼ˆTTL 24hï¼‰
   737â†’        if response.status_code == 200:
   738â†’            body = await response.body()
   739â†’            await redis.setex(f"idempotency:{idempotency_key}", 86400, body)
   740â†’
   741â†’        return response
   742â†’
   743â†’    return await call_next(request)
   744â†’```
   745â†’
   746â†’#### 2.6.3 è‡ªç„¶å”¯ä¸€é”®
   747â†’
   748â†’å¯¹äºæŸäº›ä¸šåŠ¡å†™å…¥ï¼Œä½¿ç”¨è‡ªç„¶å”¯ä¸€é”®æ›¿ä»£æ˜¾å¼ idempotency_keyï¼š
   749â†’
   750â†’```sql
   751â†’-- æ‰¿è¯ºè¡¨ï¼šåŒä¸€ç”¨æˆ·åŒä¸€å¤©åŒä¸€æè¿°åªèƒ½æœ‰ä¸€æ¡
   752â†’CREATE UNIQUE INDEX uq_commitments_natural
   753â†’ON commitments (user_id, date_trunc('day', created_at), description_hash)
   754â†’WHERE status = 'active';
   755â†’
   756â†’-- PERMA è®°å½•ï¼šåŒä¸€ç”¨æˆ·åŒä¸€å°æ—¶åªèƒ½æœ‰ä¸€æ¡
   757â†’CREATE UNIQUE INDEX uq_perma_hourly
   758â†’ON perma_logs (user_id, date_trunc('hour', logged_at));
   759â†’```
   760â†’
   761â†’---
   762â†’
   763â†’## 3. é‡æ„é˜¶æ®µ
   764â†’
   765â†’### Phase 1: åŸºç¡€è®¾æ–½å‡†å¤‡ (Week 1)
   766â†’
   767â†’**ç›®æ ‡**: å»ºç«‹ Next.js Agent Runtime åŸºç¡€æ¡†æ¶ + åŒåç«¯è·¯ç”±å…±å­˜
   768â†’
   769â†’#### 1.0 åå‘ä»£ç†è·¯ç”±é…ç½®ï¼ˆå…³é”®å‰ç½®ï¼‰
   770â†’
   771â†’é…ç½® Nginx/Caddy å®ç° Next.js å’Œ FastAPI çš„è·¯ç”±å…±å­˜ï¼š
   772â†’
   773â†’```nginx
   774â†’# /etc/nginx/sites-available/fortune-ai
   775â†’
   776â†’upstream nextjs {
   777â†’    server 127.0.0.1:8231;
   778â†’}
   779â†’
   780â†’upstream fastapi {
   781â†’    server 127.0.0.1:8230;
   782â†’}
   783â†’
   784â†’server {
   785â†’    listen 80;
   786â†’    server_name fortune-ai.example.com;
   787â†’
   788â†’    # Agent Runtime (Next.js)
   789â†’    location /api/chat {
   790â†’        proxy_pass http://nextjs;
   791â†’        proxy_http_version 1.1;
   792â†’        proxy_set_header Upgrade $http_upgrade;
   793â†’        proxy_set_header Connection 'upgrade';
   794â†’        proxy_set_header Host $host;
   795â†’        proxy_set_header X-Real-IP $remote_addr;
   796â†’        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
   797â†’        proxy_buffering off;  # æµå¼å“åº”å¿…é¡»
   798â†’        proxy_read_timeout 300s;
   799â†’    }
   800â†’
   801â†’    # Landing Page API (Next.js)
   802â†’    location /api/landing/ {
   803â†’        proxy_pass http://nextjs;
   804â†’        proxy_set_header Host $host;
   805â†’        # IP çº§é™æµ
   806â†’        limit_req zone=landing_limit burst=5 nodelay;
   807â†’    }
   808â†’
   809â†’    # Internal APIs (ä»…å†…éƒ¨è®¿é—®)
   810â†’    location /internal/ {
   811â†’        # åªå…è®¸å†…ç½‘è®¿é—®
   812â†’        allow 127.0.0.1;
   813â†’        allow 10.0.0.0/8;
   814â†’        deny all;
   815â†’        proxy_pass http://fastapi;
   816â†’        proxy_set_header Host $host;
   817â†’    }
   818â†’
   819â†’    # Data Service APIs (FastAPI)
   820â†’    location /api/ {
   821â†’        proxy_pass http://fastapi;
   822â†’        proxy_set_header Host $host;
   823â†’        proxy_set_header X-Real-IP $remote_addr;
   824â†’        proxy_set_header Cookie $http_cookie;
   825â†’    }
   826â†’
   827â†’    # Frontend (Next.js)
   828â†’    location /new/ {
   829â†’        proxy_pass http://nextjs;
   830â†’        proxy_set_header Host $host;
   831â†’    }
   832â†’
   833â†’    # Admin System (Next.js)
   834â†’    location /admin/ {
   835â†’        proxy_pass http://nextjs;
   836â†’        proxy_set_header Host $host;
   837â†’    }
   838â†’
   839â†’    # Landing Page (Next.js)
   840â†’    location / {
   841â†’        proxy_pass http://nextjs;
   842â†’        proxy_set_header Host $host;
   843â†’    }
   844â†’}
   845â†’
   846â†’# IP é™æµé…ç½®
   847â†’limit_req_zone $binary_remote_addr zone=landing_limit:10m rate=10r/m;
   848â†’```
   849â†’
   850â†’**è·¯ç”±ä¼˜å…ˆçº§**ï¼ˆé¡ºåºå¾ˆé‡è¦ï¼‰ï¼š
   851â†’1. `/api/chat` â†’ Next.jsï¼ˆAgent Runtimeï¼‰
   852â†’2. `/api/landing/*` â†’ Next.jsï¼ˆLanding Page APIï¼‰
   853â†’3. `/internal/*` â†’ FastAPIï¼ˆå†…éƒ¨ APIï¼Œé™å†…ç½‘ï¼‰
   854â†’4. `/api/*` â†’ FastAPIï¼ˆData Serviceï¼‰
   855â†’5. `/new/*` â†’ Next.jsï¼ˆFrontendï¼‰
   856â†’6. `/admin/*` â†’ Next.jsï¼ˆAdminï¼‰
   857â†’7. `/` â†’ Next.jsï¼ˆLanding Pageï¼‰
   858â†’
   859â†’#### 1.1 Next.js API Route ç»“æ„
   860â†’
   861â†’```bash
   862â†’web-app/src/app/api/
   863â†’â”œâ”€â”€ chat/
   864â†’â”‚   â””â”€â”€ route.ts              # ä¸» Agent Runtime
   865â†’â”œâ”€â”€ command/
   866â†’â”‚   â””â”€â”€ route.ts              # æŒ‡ä»¤è·¯ç”±
   867â†’â””â”€â”€ landing/
   868â†’    â””â”€â”€ insight/
   869â†’        â””â”€â”€ route.ts          # Landing Page æ´å¯Ÿ
   870â†’```
   871â†’
   872â†’#### 1.2 Skills Registry æ¡†æ¶
   873â†’
   874â†’```bash
   875â†’web-app/src/lib/
   876â†’â”œâ”€â”€ skills/
   877â†’â”‚   â”œâ”€â”€ index.ts              # Skills ç»Ÿä¸€å¯¼å‡º
   878â†’â”‚   â”œâ”€â”€ divine-skills.ts      # ç„å­¦æŠ€èƒ½
   879â†’â”‚   â”œâ”€â”€ heal-skills.ts        # ç–—æ„ˆæŠ€èƒ½
   880â†’â”‚   â””â”€â”€ grow-skills.ts        # æˆé•¿æŠ€èƒ½
   881â†’â”œâ”€â”€ models/
   882â†’â”‚   â””â”€â”€ model-provider.ts     # Multi-Model é…ç½®
   883â†’â””â”€â”€ context/
   884â†’    â””â”€â”€ context-builder.ts    # System Prompt æ„å»º
   885â†’```
   886â†’
   887â†’#### 1.3 é…ç½® Multi-Model Provider
   888â†’
   889â†’```typescript
   890â†’// lib/models/model-provider.ts
   891â†’import { createGoogleGenerativeAI } from '@ai-sdk/google';
   892â†’import { createAnthropic } from '@ai-sdk/anthropic';
   893â†’
   894â†’const google = createGoogleGenerativeAI({
   895â†’  apiKey: process.env.GOOGLE_API_KEY,
   896â†’});
   897â†’
   898â†’const anthropic = createAnthropic({
   899â†’  apiKey: process.env.ANTHROPIC_API_KEY,
   900â†’});
   901â†’
   902â†’// Vercel AI Gateway for GLM-4.5
   903â†’const glm = createGoogleGenerativeAI({
   904â†’  baseURL: 'https://gateway.ai.cloudflare.com/v1/...',
   905â†’  apiKey: process.env.GLM_API_KEY,
   906â†’});
   907â†’
   908â†’export function selectModel(preference?: string) {
   909â†’  switch (preference) {
   910â†’    case 'gemini': return google('gemini-2.0-flash-exp');
   911â†’    case 'claude': return anthropic('claude-3-5-sonnet-20241022');
   912â†’    case 'glm':
   913â†’    default: return glm('glm-4.5');
   914â†’  }
   915â†’}
   916â†’```
   917â†’
   918â†’#### 1.4 äº¤ä»˜ç‰©
   919â†’
   920â†’- [ ] **Nginx/Caddy åŒåç«¯è·¯ç”±é…ç½®**ï¼ˆå…³é”®å‰ç½®ï¼‰
   921â†’- [ ] FastAPI `/internal/*` ç«¯ç‚¹éš”ç¦»ï¼ˆIP ç™½åå•ï¼‰
   922â†’- [ ] Next.js `/api/chat/route.ts` åŸºç¡€æ¡†æ¶
   923â†’- [ ] Skills Registry ç›®å½•ç»“æ„
   924â†’- [ ] Multi-Model Provider é…ç½®
   925â†’- [ ] ç¯å¢ƒå˜é‡é…ç½® (`.env.local`)
   926â†’
   927â†’---
   928â†’
   929â†’### Phase 2: Agent Runtime è¿ç§» (Week 2)
   930â†’
   931â†’**ç›®æ ‡**: å°† AI æ¨ç†é€»è¾‘ä» Python è¿ç§»åˆ° Next.js
   932â†’
   933â†’#### 2.1 å®ç° `/api/chat/route.ts`ï¼ˆå« Run Lifecycleï¼‰
   934â†’
   935â†’```typescript
   936â†’// app/api/chat/route.ts
   937â†’import { streamText } from 'ai';
   938â†’import { cookies } from 'next/headers';
   939â†’import { selectModel } from '@/lib/models/model-provider';
   940â†’import { allSkills } from '@/lib/skills';
   941â†’import { buildSystemPrompt } from '@/lib/context/context-builder';
   942â†’
   943â†’const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';
   944â†’
   945â†’// è¯·æ±‚ä½“ï¼šä¸åŒ…å« userIdï¼ˆä» Cookie Session è§£å‡ºï¼‰
   946â†’interface ChatRequest {
   947â†’  session_id?: string;   // å¯é€‰ï¼Œç”¨äºä¼šè¯ç»­æ¥
   948â†’  message: string;       // ç”¨æˆ·æ¶ˆæ¯
   949â†’  command?: string;      // /divine | /heal | /growï¼ˆæ¥è‡ª CommandPaletteï¼‰
   950â†’}
   951â†’
   952â†’export async function POST(req: Request) {
   953â†’  const cookieStore = await cookies();
   954â†’  const sessionCookie = cookieStore.get('fortune_session')?.value;
   955â†’
   956â†’  if (!sessionCookie) {
   957â†’    return Response.json({ ok: false, error: { code: 'AUTH_REQUIRED' } }, { status: 401 });
   958â†’  }
   959â†’
   960â†’  const { session_id, message, command }: ChatRequest = await req.json();
   961â†’
   962â†’  // ç”Ÿæˆ correlation_id
   963â†’  const correlationId = `chat-${Date.now()}-${crypto.randomUUID().slice(0, 8)}`;
   964â†’
   965â†’  // 1. è°ƒç”¨ Internal Context APIï¼ˆCookie é€ä¼ ï¼ŒuserId ç”± FastAPI è§£å‡ºï¼‰
   966â†’  const contextRes = await fetch(`${FASTAPI_URL}/internal/context`, {
   967â†’    headers: {
   968â†’      'Cookie': `fortune_session=${sessionCookie}`,
   969â†’      'X-Correlation-ID': correlationId,
   970â†’    },
   971â†’  });
   972â†’
   973â†’  if (!contextRes.ok) {
   974â†’    return Response.json({ ok: false, error: { code: 'CONTEXT_FETCH_FAILED' } }, { status: 500 });
   975â†’  }
   976â†’
   977â†’  const context = await contextRes.json();
   978â†’
   979â†’  // 2. è°ƒç”¨ run/startï¼ˆè®°å½• run_id + ç”¨æˆ·æ¶ˆæ¯ï¼‰
   980â†’  const startRes = await fetch(`${FASTAPI_URL}/internal/chat/run/start`, {
   981â†’    method: 'POST',
   982â†’    headers: {
   983â†’      'Content-Type': 'application/json',
   984â†’      'Cookie': `fortune_session=${sessionCookie}`,
   985â†’      'X-Correlation-ID': correlationId,
   986â†’    },
   987â†’    body: JSON.stringify({
   988â†’      session_id,
   989â†’      user_message: message,
   990â†’      correlation_id: correlationId,
   991â†’    }),
   992â†’  });
   993â†’
   994â†’  const { run_id } = await startRes.json();
   995â†’
   996â†’  // 3. æ ¹æ® Command ç­›é€‰ Tools
   997â†’  const tools = command
   998â†’    ? getToolsForCommand(command)  // /divine â†’ divineSkills only
   999â†’    : allSkills;                   // Chat Mode: all tools
  1000â†’
  1001â†’  // 4. æš‚å­˜ Tool è°ƒç”¨è®°å½•ï¼ˆç”¨äº finalizeï¼‰
  1002â†’  const toolLogs: ToolLog[] = [];
  1003â†’  const commitments: Commitment[] = [];
  1004â†’
  1005â†’  // 5. streamText æµå¼æ¨ç†
  1006â†’  const result = streamText({
  1007â†’    model: selectModel(context.policy_flags?.model_override),
  1008â†’    system: buildSystemPrompt(context),
  1009â†’    messages: [
  1010â†’      ...context.history_excerpt,
  1011â†’      { role: 'user', content: message },
  1012â†’    ],
  1013â†’    tools,
  1014â†’    maxSteps: 5,
  1015â†’
  1016â†’    // æ¯æ­¥å®Œæˆå›è°ƒï¼šè®°å½• Tool è°ƒç”¨
  1017â†’    onStepFinish({ stepType, toolCalls, toolResults }) {
  1018â†’      if (stepType === 'tool-result' && toolCalls) {
  1019â†’        for (let i = 0; i < toolCalls.length; i++) {
  1020â†’          const call = toolCalls[i];
  1021â†’          const result = toolResults?.[i];
  1022â†’          toolLogs.push({
  1023â†’            name: call.toolName,
  1024â†’            input: call.args,
  1025â†’            output: result,
  1026â†’            latency_ms: 0, // TODO: å®é™…è®¡æ—¶
  1027â†’            idempotency_key: `${run_id}:${toolLogs.length}:${call.toolName}`,
  1028â†’          });
  1029â†’
  1030â†’          // æ”¶é›† commitments
  1031â†’          if (result?.commitments) {
  1032â†’            commitments.push(...result.commitments);
  1033â†’          }
  1034â†’        }
  1035â†’      }
  1036â†’    },
  1037â†’
  1038â†’    // æµå¼å®Œæˆå›è°ƒï¼šè°ƒç”¨ finalize
  1039â†’    async onFinish({ text, finishReason }) {
  1040â†’      await fetch(`${FASTAPI_URL}/internal/chat/run/finalize`, {
  1041â†’        method: 'POST',
  1042â†’        headers: {
  1043â†’          'Content-Type': 'application/json',
  1044â†’          'Cookie': `fortune_session=${sessionCookie}`,
  1045â†’          'X-Correlation-ID': correlationId,
  1046â†’        },
  1047â†’        body: JSON.stringify({
  1048â†’          run_id,
  1049â†’          success: finishReason !== 'error',
  1050â†’          assistant_message: text,
  1051â†’          tool_logs: toolLogs,
  1052â†’          commitments,
  1053â†’        }),
  1054â†’      });
  1055â†’    },
  1056â†’  });
  1057â†’
  1058â†’  return result.toDataStreamResponse();
  1059â†’}
  1060â†’```
  1061â†’
  1062â†’**å…³é”®å˜åŒ–**ï¼š
  1063â†’- è¯·æ±‚ä½“åªåŒ…å« `{ session_id?, message, command? }`ï¼Œ**ä¸ä¼  userId**
  1064â†’- userId ä» Cookie Session ç”± FastAPI è§£å‡º
  1065â†’- æµå¼å¼€å§‹æ—¶è°ƒç”¨ `run/start`ï¼Œç»“æŸæ—¶è°ƒç”¨ `run/finalize`
  1066â†’- Tool è°ƒç”¨è®°å½•æš‚å­˜å†…å­˜ï¼Œ`finalize` æ—¶ç»Ÿä¸€å†™å…¥
  1067â†’
  1068â†’#### 2.2 System Prompt è¿ç§»
  1069â†’
  1070â†’å°† `chat_routes.py:SYSTEM_PROMPT_TEMPLATE` è¿ç§»åˆ° TypeScriptï¼š
  1071â†’
  1072â†’```typescript
  1073â†’// lib/context/context-builder.ts
  1074â†’export function buildSystemPrompt(context: UserContext): string {
  1075â†’  return `ä½ æ˜¯ Fortune AI çš„å¯¹è¯ Agentï¼Œè§’è‰²æ˜¯ç§¯æå¿ƒç†å­¦æ•™ç»ƒã€‚
  1076â†’
  1077â†’ã€ç¡¬æ€§è§„åˆ™ã€‘
  1078â†’1) ç¦æ­¢æå“ã€ç¾è¾±ã€å®¿å‘½è®ºæ–­è¨€ï¼›è´Ÿé¢ä¿¡æ¯å¿…é¡»ç´§æ¥"ä½ å¯ä»¥åšä»€ä¹ˆ"çš„è¡ŒåŠ¨å¤„æ–¹ã€‚
  1079â†’2) ç¦æ­¢è‡ªè¡Œè®¡ç®—å…«å­—äº‹å®ï¼›åªèƒ½åŸºäºæä¾›çš„ facts + evidence è¾“å‡ºã€‚
  1080â†’3) æ¯æ¬¡è¾“å‡ºå¿…é¡»åŒ…å«ï¼šç»“è®º + ä¾æ® + â‰¤3æ¡å¤„æ–¹ + æ‰¿è¯ºé‚€è¯·ã€‚
  1081â†’4) æ¯æ¡å¤„æ–¹å¿…é¡»åŒ…å« if_thenï¼šå¦‚æœ____â†’é‚£ä¹ˆ____ã€‚
  1082â†’5) å¿…é¡»ç»™å‡ºå¯ç‚¹å‡» actionsã€‚
  1083â†’
  1084â†’ã€ç”¨æˆ·ä¸Šä¸‹æ–‡ã€‘
  1085â†’persona_style: ${context.persona_style}
  1086â†’facts: ${JSON.stringify(context.facts)}
  1087â†’evidence: ${JSON.stringify(context.evidence)}
  1088â†’active_goals: ${JSON.stringify(context.active_goals)}
  1089â†’`;
  1090â†’}
  1091â†’```
  1092â†’
  1093â†’#### 2.3 åŒè·¯ç”±å¹¶è¡ŒæœŸ
  1094â†’
  1095â†’**ä¿ç•™ Python `/api/chat/send`**ï¼Œæ–°å¢ Next.js `/api/chat`ï¼š
  1096â†’
  1097â†’```python
  1098â†’# api/chat_routes.py - æ·»åŠ  header æ£€æµ‹
  1099â†’@router.post("/send")
  1100â†’async def chat_send(request: Request, body: ChatSendRequest, auth = Depends(require_auth)):
  1101â†’    # æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ–°æ¶æ„
  1102â†’    use_new_runtime = request.headers.get("X-Use-New-Runtime") == "true"
  1103â†’    if use_new_runtime:
  1104â†’        # è½¬å‘åˆ° Next.js
  1105â†’        return RedirectResponse(url="/api/chat", status_code=307)
  1106â†’    # åŸæœ‰é€»è¾‘...
  1107â†’```
  1108â†’
  1109â†’#### 2.4 äº¤ä»˜ç‰©
  1110â†’
  1111â†’- [ ] `/api/chat/route.ts` å®Œæ•´å®ç°
  1112â†’- [ ] `buildSystemPrompt()` è¿ç§»
  1113â†’- [ ] åŒè·¯ç”±å¹¶è¡Œé…ç½®
  1114â†’- [ ] å‰ç«¯ `useChat()` é›†æˆæµ‹è¯•
  1115â†’
  1116â†’---
  1117â†’
  1118â†’### Phase 3: Skills å®ç° (Week 3)
  1119â†’
  1120â†’**ç›®æ ‡**: å°† L2 Expert Agents é‡æ„ä¸º Vercel Tools
  1121â†’
  1122â†’#### 3.1 Divine Skills
  1123â†’
  1124â†’```typescript
  1125â†’// lib/skills/divine-skills.ts
  1126â†’import { tool } from 'ai';
  1127â†’import { z } from 'zod';
  1128â†’
  1129â†’const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';
  1130â†’
  1131â†’export const divineSkills = {
  1132â†’  calculate_bazi: tool({
  1133â†’    description: 'è®¡ç®—ç”¨æˆ·çš„å…«å­—å‘½ç›˜ï¼Œè¿”å›å››æŸ±ã€äº”è¡Œã€åç¥ã€ç¥ç…ã€å¤§è¿ç­‰ä¿¡æ¯',
  1134â†’    parameters: z.object({
  1135â†’      birth_datetime: z.string().describe('å‡ºç”Ÿæ—¥æœŸæ—¶é—´ (ISO 8601)'),
  1136â†’      timezone: z.string().default('Asia/Shanghai'),
  1137â†’      include_dayun: z.boolean().default(true),
  1138â†’    }),
  1139â†’    execute: async ({ birth_datetime, timezone, include_dayun }) => {
  1140â†’      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
  1141â†’        method: 'POST',
  1142â†’        headers: { 'Content-Type': 'application/json' },
  1143â†’        body: JSON.stringify({ birth_datetime, timezone, include_dayun }),
  1144â†’      });
  1145â†’      if (!res.ok) throw new Error(`Bazi calculation failed: ${res.status}`);
  1146â†’      return res.json();
  1147â†’    },
  1148â†’  }),
  1149â†’
  1150â†’  get_bazi_facts: tool({
  1151â†’    description: 'è·å–ç”¨æˆ·å·²è®¡ç®—çš„å…«å­—äº‹å®æ•°æ®',
  1152â†’    parameters: z.object({
  1153â†’      user_id: z.number(),
  1154â†’    }),
  1155â†’    execute: async ({ user_id }) => {
  1156â†’      const res = await fetch(`${FASTAPI_URL}/api/bazi/facts/${user_id}`);
  1157â†’      return res.json();
  1158â†’    },
  1159â†’  }),
  1160â†’
  1161â†’  search_bazi_kb: tool({
  1162â†’    description: 'æœç´¢å…«å­—çŸ¥è¯†åº“ï¼Œè·å–ç›¸å…³å‘½ç†è§£è¯»',
  1163â†’    parameters: z.object({
  1164â†’      query: z.string().describe('æœç´¢å…³é”®è¯'),
  1165â†’      limit: z.number().default(3),
  1166â†’    }),
  1167â†’    execute: async ({ query, limit }) => {
  1168â†’      const res = await fetch(`${FASTAPI_URL}/api/kb/search`, {
  1169â†’        method: 'POST',
  1170â†’        body: JSON.stringify({ query, limit, category: 'bazi' }),
  1171â†’      });
  1172â†’      return res.json();
  1173â†’    },
  1174â†’  }),
  1175â†’};
  1176â†’```
  1177â†’
  1178â†’#### 3.2 Heal Skills
  1179â†’
  1180â†’```typescript
  1181â†’// lib/skills/heal-skills.ts
  1182â†’export const healSkills = {
  1183â†’  log_perma: tool({
  1184â†’    description: 'è®°å½•ç”¨æˆ·çš„ PERMA äº”ç»´å¿ƒç†çŠ¶æ€åˆ†æ•°',
  1185â†’    parameters: z.object({
  1186â†’      dimension: z.enum(['P', 'E', 'R', 'M', 'A']),
  1187â†’      score: z.number().min(0).max(10),
  1188â†’      note: z.string().optional(),
  1189â†’    }),
  1190â†’    execute: async ({ dimension, score, note }, { userId }) => {
  1191â†’      const res = await fetch(`${FASTAPI_URL}/api/perma/log`, {
  1192â†’        method: 'POST',
  1193â†’        body: JSON.stringify({ user_id: userId, dimension, score, note }),
  1194â†’      });
  1195â†’      return res.json();
  1196â†’    },
  1197â†’  }),
  1198â†’
  1199â†’  mood_checkin: tool({
  1200â†’    description: 'å¿«é€Ÿæƒ…ç»ªæ‰“å¡',
  1201â†’    parameters: z.object({
  1202â†’      mood_score: z.number().min(1).max(10),
  1203â†’      tags: z.array(z.string()).optional(),
  1204â†’      note: z.string().optional(),
  1205â†’    }),
  1206â†’    execute: async (params, { userId }) => {
  1207â†’      const res = await fetch(`${FASTAPI_URL}/api/checkin/mood`, {
  1208â†’        method: 'POST',
  1209â†’        body: JSON.stringify({ user_id: userId, ...params }),
  1210â†’      });
  1211â†’      return res.json();
  1212â†’    },
  1213â†’  }),
  1214â†’
  1215â†’  cbt_reframe: tool({
  1216â†’    description: 'ä½¿ç”¨ CBT ABC æ¨¡å‹è¿›è¡Œè®¤çŸ¥é‡æ„',
  1217â†’    parameters: z.object({
  1218â†’      activating_event: z.string().describe('è§¦å‘äº‹ä»¶ (A)'),
  1219â†’      belief: z.string().optional().describe('ä¿¡å¿µ/æƒ³æ³• (B)'),
  1220â†’      consequence: z.string().optional().describe('æƒ…ç»ª/è¡Œä¸ºåæœ (C)'),
  1221â†’    }),
  1222â†’    execute: async (params) => {
  1223â†’      // CBT å¼•å¯¼æ¡†æ¶ï¼Œè¿”å›ç»“æ„åŒ–æç¤ºè®© LLM ç»§ç»­å¼•å¯¼
  1224â†’      return {
  1225â†’        framework: 'ABC',
  1226â†’        current_state: params,
  1227â†’        next_step: params.belief ? 'identify_distortion' : 'explore_belief',
  1228â†’        guidance_prompt: params.belief
  1229â†’          ? `ç”¨æˆ·çš„ä¿¡å¿µæ˜¯"${params.belief}"ï¼Œè¯·å¸®åŠ©è¯†åˆ«å¯èƒ½çš„è®¤çŸ¥æ‰­æ›²...`
  1230â†’          : `è¯·å¼•å¯¼ç”¨æˆ·æ¢ç´¢è§¦å‘äº‹ä»¶èƒŒåçš„ä¿¡å¿µå’Œæƒ³æ³•...`,
  1231â†’      };
  1232â†’    },
  1233â†’  }),
  1234â†’};
  1235â†’```
  1236â†’
  1237â†’#### 3.3 Grow Skills
  1238â†’
  1239â†’```typescript
  1240â†’// lib/skills/grow-skills.ts
  1241â†’export const growSkills = {
  1242â†’  create_commitment: tool({
  1243â†’    description: 'åˆ›å»ºè¡ŒåŠ¨æ‰¿è¯ºä»»åŠ¡',
  1244â†’    parameters: z.object({
  1245â†’      content: z.string().describe('ä»»åŠ¡å†…å®¹'),
  1246â†’      category: z.enum(['energy_boost', 'reflection', 'practice', 'social', 'general']),
  1247â†’      estimated_minutes: z.number().default(5),
  1248â†’      if_then: z.string().optional().describe('If-Then è§¦å‘æ¡ä»¶'),
  1249â†’    }),
  1250â†’    execute: async (params, { userId }) => {
  1251â†’      const res = await fetch(`${FASTAPI_URL}/api/tasks/create`, {
  1252â†’        method: 'POST',
  1253â†’        body: JSON.stringify({ user_id: userId, ...params }),
  1254â†’      });
  1255â†’      return res.json();
  1256â†’    },
  1257â†’  }),
  1258â†’
  1259â†’  goal_setting: tool({
  1260â†’    description: 'ä½¿ç”¨ WOOP æ¨¡å‹è®¾å®šç›®æ ‡',
  1261â†’    parameters: z.object({
  1262â†’      wish: z.string().describe('æ„¿æœ›/ç›®æ ‡'),
  1263â†’      outcome: z.string().optional(),
  1264â†’      obstacle: z.string().optional(),
  1265â†’      plan: z.string().optional(),
  1266â†’    }),
  1267â†’    execute: async (params, { userId }) => {
  1268â†’      const res = await fetch(`${FASTAPI_URL}/api/goals/create`, {
  1269â†’        method: 'POST',
  1270â†’        body: JSON.stringify({ user_id: userId, ...params }),
  1271â†’      });
  1272â†’      return res.json();
  1273â†’    },
  1274â†’  }),
  1275â†’
  1276â†’  update_twin: tool({
  1277â†’    description: 'æ›´æ–°ç”¨æˆ·æ•°å­—å­ªç”Ÿæ•°æ®',
  1278â†’    parameters: z.object({
  1279â†’      layer: z.enum(['L1', 'L2', 'L3']),
  1280â†’      path: z.string().describe('JSON è·¯å¾„'),
  1281â†’      value: z.any(),
  1282â†’    }),
  1283â†’    execute: async (params, { userId }) => {
  1284â†’      const res = await fetch(`${FASTAPI_URL}/api/twin/update`, {
  1285â†’        method: 'PUT',
  1286â†’        body: JSON.stringify({ user_id: userId, ...params }),
  1287â†’      });
  1288â†’      return res.json();
  1289â†’    },
  1290â†’  }),
  1291â†’};
  1292â†’```
  1293â†’
  1294â†’#### 3.4 Skills Registry ç»Ÿä¸€å¯¼å‡º
  1295â†’
  1296â†’```typescript
  1297â†’// lib/skills/index.ts
  1298â†’import { divineSkills } from './divine-skills';
  1299â†’import { healSkills } from './heal-skills';
  1300â†’import { growSkills } from './grow-skills';
  1301â†’
  1302â†’export const allSkills = {
  1303â†’  ...divineSkills,
  1304â†’  ...healSkills,
  1305â†’  ...growSkills,
  1306â†’};
  1307â†’
  1308â†’export function getToolsForCommand(command: string) {
  1309â†’  switch (command) {
  1310â†’    case '/divine': return divineSkills;
  1311â†’    case '/heal': return healSkills;
  1312â†’    case '/grow': return growSkills;
  1313â†’    default: return allSkills;
  1314â†’  }
  1315â†’}
  1316â†’
  1317â†’export { divineSkills, healSkills, growSkills };
  1318â†’```
  1319â†’
  1320â†’#### 3.5 äº¤ä»˜ç‰©
  1321â†’
  1322â†’- [ ] `divine-skills.ts` å®Œæ•´å®ç°
  1323â†’- [ ] `heal-skills.ts` å®Œæ•´å®ç°
  1324â†’- [ ] `grow-skills.ts` å®Œæ•´å®ç°
  1325â†’- [ ] Skills Registry å•å…ƒæµ‹è¯•
  1326â†’
  1327â†’---
  1328â†’
  1329â†’### Phase 4: FastAPI æ•°æ®æœåŠ¡é‡æ„ (Week 4)
  1330â†’
  1331â†’**ç›®æ ‡**: å°† FastAPI ç²¾ç®€ä¸ºçº¯æ•°æ®æœåŠ¡å±‚
  1332â†’
  1333â†’#### 4.1 æ–°å¢æ•°æ®æœåŠ¡ API
  1334â†’
  1335â†’```python
  1336â†’# api/data_routes.py (æ–°æ–‡ä»¶)
  1337â†’from fastapi import APIRouter, Depends
  1338â†’from api.deps import require_auth
  1339â†’
  1340â†’router = APIRouter(prefix="/api", tags=["data"])
  1341â†’
  1342â†’@router.get("/user/context")
  1343â†’async def get_user_context(user_id: int, auth = Depends(require_auth)):
  1344â†’    """èšåˆç”¨æˆ·ä¸Šä¸‹æ–‡ï¼Œä¾› Agent Runtime è°ƒç”¨"""
  1345â†’    # èšåˆ profile + preferences + facts + active_goals + recent_messages
  1346â†’    profile = await _get_profile(user_id)
  1347â†’    prefs = await _get_preferences(user_id)
  1348â†’    facts = await _get_bazi_facts(user_id)
  1349â†’    goals = await _get_active_goals(user_id)
  1350â†’    messages = await _get_recent_messages(user_id, limit=10)
  1351â†’
  1352â†’    return {
  1353â†’        "ok": True,
  1354â†’        "data": {
  1355â†’            "profile": profile,
  1356â†’            "persona_style": prefs.get("persona_style", "warm"),
  1357â†’            "facts": facts,
  1358â†’            "evidence": {
  1359â†’                "facts_hash": facts.get("facts_hash"),
  1360â†’                "kb_refs": [],  # åç»­å¡«å……
  1361â†’            },
  1362â†’            "active_goals": goals,
  1363â†’            "recent_messages": messages,
  1364â†’        }
  1365â†’    }
  1366â†’
  1367â†’@router.post("/bazi/calculate")
  1368â†’async def calculate_bazi(body: BaziCalculateRequest):
  1369â†’    """å…«å­—è®¡ç®— (æ— éœ€ç™»å½•ï¼Œä¾› Landing Page ä½¿ç”¨)"""
  1370â†’    from services.bazi_engine import calculate_bazi
  1371â†’    result = calculate_bazi(
  1372â†’        body.birth_datetime,
  1373â†’        body.timezone,
  1374â†’        body.include_dayun,
  1375â†’    )
  1376â†’    return {"ok": True, "data": result}
  1377â†’
  1378â†’@router.post("/perma/log")
  1379â†’async def log_perma(body: PermaLogRequest, auth = Depends(require_auth)):
  1380â†’    """PERMA çŠ¶æ€è®°å½•"""
  1381â†’    from services.twin_service import update_perma_score
  1382â†’    result = await update_perma_score(
  1383â†’        auth.user_id,
  1384â†’        body.dimension,
  1385â†’        body.score,
  1386â†’        body.note,
  1387â†’    )
  1388â†’    return {"ok": True, "data": result}
  1389â†’
  1390â†’@router.post("/tasks/create")
  1391â†’async def create_task(body: TaskCreateRequest, auth = Depends(require_auth)):
  1392â†’    """åˆ›å»ºæ‰¿è¯ºä»»åŠ¡"""
  1393â†’    from services.bento_service import create_commitment
  1394â†’    result = await create_commitment(
  1395â†’        auth.user_id,
  1396â†’        body.content,
  1397â†’        body.category,
  1398â†’        body.estimated_minutes,
  1399â†’        body.if_then,
  1400â†’    )
  1401â†’    return {"ok": True, "data": result}
  1402â†’
  1403â†’@router.post("/goals/create")
  1404â†’async def create_goal(body: GoalCreateRequest, auth = Depends(require_auth)):
  1405â†’    """åˆ›å»º WOOP ç›®æ ‡"""
  1406â†’    from services.goal_service import create_goal
  1407â†’    result = await create_goal(auth.user_id, body.dict())
  1408â†’    return {"ok": True, "data": result}
  1409â†’
  1410â†’@router.put("/twin/update")
  1411â†’async def update_twin(body: TwinUpdateRequest, auth = Depends(require_auth)):
  1412â†’    """æ›´æ–°æ•°å­—å­ªç”Ÿ"""
  1413â†’    from services.twin_service import update_twin
  1414â†’    result = await update_twin(auth.user_id, body.layer, body.path, body.value)
  1415â†’    return {"ok": True, "data": result}
  1416â†’
  1417â†’@router.post("/kb/search")
  1418â†’async def search_kb(body: KBSearchRequest, auth = Depends(require_auth)):
  1419â†’    """çŸ¥è¯†åº“æ£€ç´¢"""
  1420â†’    from services.kb_service import search
  1421â†’    result = await search(body.query, body.limit, body.category)
  1422â†’    return {"ok": True, "data": result}
  1423â†’```
  1424â†’
  1425â†’#### 4.2 Landing Page API
  1426â†’
  1427â†’```python
  1428â†’# api/landing_routes.py (æ–°æ–‡ä»¶)
  1429â†’from fastapi import APIRouter
  1430â†’
  1431â†’router = APIRouter(prefix="/api/landing", tags=["landing"])
  1432â†’
  1433â†’ELEMENT_COLORS = {
  1434â†’    "wood": ["#4ade80", "#22c55e"],
  1435â†’    "fire": ["#f87171", "#ef4444"],
  1436â†’    "earth": ["#fbbf24", "#f59e0b"],
  1437â†’    "metal": ["#f5f5f4", "#d6d3d1"],
  1438â†’    "water": ["#60a5fa", "#3b82f6"],
  1439â†’}
  1440â†’
  1441â†’ELEMENT_INSIGHTS = {
  1442â†’    "wood": {
  1443â†’        "en": "A strong Wood energy detected. You seek growth, but feel restricted.",
  1444â†’        "cn": "æ£€æµ‹åˆ°å¼ºæœ¨èƒ½é‡ã€‚ä½ æ¸´æœ›ç”Ÿé•¿ï¼Œä½†æ„Ÿåˆ°å—é™ã€‚",
  1445â†’    },
  1446â†’    "fire": {
  1447â†’        "en": "Fire burns bright within you. Passion drives you forward.",
  1448â†’        "cn": "ç«ç„°åœ¨ä½ å¿ƒä¸­ç‡ƒçƒ§ã€‚çƒ­æƒ…é©±åŠ¨ä½ å‰è¿›ã€‚",
  1449â†’    },
  1450â†’    # ... å…¶ä»–äº”è¡Œ
  1451â†’}
  1452â†’
  1453â†’@router.post("/insight")
  1454â†’async def instant_insight(body: InsightRequest):
  1455â†’    """å³æ—¶æ´å¯Ÿ (æ— éœ€ç™»å½•)"""
  1456â†’    if body.input_type == "bazi":
  1457â†’        # å¿«é€Ÿè®¡ç®—æ—¥ä¸»äº”è¡Œ
  1458â†’        from services.bazi_engine import quick_day_master
  1459â†’        element = quick_day_master(body.value)
  1460â†’        insight = ELEMENT_INSIGHTS.get(element, ELEMENT_INSIGHTS["wood"])
  1461â†’        return {
  1462â†’            "ok": True,
  1463â†’            "data": {
  1464â†’                "type": "bazi",
  1465â†’                "element": element,
  1466â†’                "insight": insight["en"],
  1467â†’                "insight_cn": insight["cn"],
  1468â†’                "orb_colors": ELEMENT_COLORS.get(element),
  1469â†’                "cta": "Unlock Full Analysis â†’",
  1470â†’            }
  1471â†’        }
  1472â†’    elif body.input_type == "emotion":
  1473â†’        # è°ƒç”¨ LLM ç”Ÿæˆç®€çŸ­æƒ…ç»ªæ´å¯Ÿ
  1474â†’        from services.glm_client import quick_emotion_insight
  1475â†’        insight = await quick_emotion_insight(body.value)
  1476â†’        return {
  1477â†’            "ok": True,
  1478â†’            "data": {
  1479â†’                "type": "emotion",
  1480â†’                "insight": insight,
  1481â†’                "orb_colors": ["#a78bfa", "#8b5cf6"],  # ç´«è‰²
  1482â†’                "cta": "Start Your Journey â†’",
  1483â†’            }
  1484â†’        }
  1485â†’```
  1486â†’
  1487â†’#### 4.3 åˆ é™¤/åºŸå¼ƒçš„ä»£ç 
  1488â†’
  1489â†’```python
  1490â†’# å¾…åˆ é™¤æ–‡ä»¶
  1491â†’services/glm_client.py          # LLM è°ƒç”¨è¿ç§»åˆ° TypeScript
  1492â†’services/agent_service_client.py # ä¸å†éœ€è¦
  1493â†’
  1494â†’# å¾…åºŸå¼ƒç«¯ç‚¹ (chat_routes.py)
  1495â†’# POST /api/chat/send  â†’ è¿ç§»åˆ° Next.js /api/chat
  1496â†’# GET  /api/chat/stream â†’ è¿ç§»åˆ° Next.js /api/chat
  1497â†’```
  1498â†’
  1499â†’#### 4.4 äº¤ä»˜ç‰©
  1500â†’
  1501â†’- [ ] `api/data_routes.py` å®Œæ•´å®ç°
  1502â†’- [ ] `api/landing_routes.py` å®Œæ•´å®ç°
  1503â†’- [ ] æ—§ chat ç«¯ç‚¹åºŸå¼ƒæ ‡è®°
  1504â†’- [ ] API æ–‡æ¡£æ›´æ–°
  1505â†’
  1506â†’---
  1507â†’
  1508â†’### Phase 5: å‰ç«¯é€‚é… (Week 5)
  1509â†’
  1510â†’**ç›®æ ‡**: å‰ç«¯åˆ‡æ¢åˆ° `useChat()` Hook
  1511â†’
  1512â†’#### 5.1 useChat é›†æˆ
  1513â†’
  1514â†’```typescript
  1515â†’// components/chat/chat-panel.tsx
  1516â†’'use client';
  1517â†’
  1518â†’import { useChat } from 'ai/react';
  1519â†’import { useState } from 'react';
  1520â†’
  1521â†’export function ChatPanel({ userId }: { userId: number }) {
  1522â†’  const [command, setCommand] = useState<string | null>(null);
  1523â†’
  1524â†’  const { messages, input, setInput, handleSubmit, isLoading, error } = useChat({
  1525â†’    api: '/api/chat',
  1526â†’    body: { userId, command },
  1527â†’    onFinish: (message) => {
  1528â†’      setCommand(null);
  1529â†’      // å¤„ç† Tool è°ƒç”¨ç»“æœ
  1530â†’      if (message.toolInvocations?.length) {
  1531â†’        refreshDashboard(message.toolInvocations);
  1532â†’      }
  1533â†’    },
  1534â†’  });
  1535â†’
  1536â†’  const handleCommandSubmit = (cmd: string, text: string) => {
  1537â†’    setCommand(cmd);
  1538â†’    setInput(text);
  1539â†’    // useChat ä¼šè‡ªåŠ¨æäº¤
  1540â†’  };
  1541â†’
  1542â†’  return (
  1543â†’    <div className="flex flex-col h-full">
  1544â†’      {/* Messages */}
  1545â†’      <div className="flex-1 overflow-y-auto">
  1546â†’        {messages.map((m) => (
  1547â†’          <MessageBubble key={m.id} message={m} />
  1548â†’        ))}
  1549â†’      </div>
  1550â†’
  1551â†’      {/* Input */}
  1552â†’      <ChatInput
  1553â†’        value={input}
  1554â†’        onChange={setInput}
  1555â†’        onSubmit={handleSubmit}
  1556â†’        onCommand={handleCommandSubmit}
  1557â†’        isLoading={isLoading}
  1558â†’      />
  1559â†’    </div>
  1560â†’  );
  1561â†’}
  1562â†’```
  1563â†’
  1564â†’#### 5.2 CommandPalette é›†æˆ
  1565â†’
  1566â†’```typescript
  1567â†’// components/chat/command-palette.tsx
  1568â†’const COMMANDS = [
  1569â†’  { cmd: '/divine', label: 'ç„å­¦æµ‹ç®—', icon: 'ğŸ”®' },
  1570â†’  { cmd: '/heal', label: 'å¿ƒç†ç–—æ„ˆ', icon: 'ğŸ’š' },
  1571â†’  { cmd: '/grow', label: 'æˆé•¿æ•™ç»ƒ', icon: 'ğŸŒ±' },
  1572â†’  { cmd: '/status', label: 'çŠ¶æ€æŸ¥çœ‹', icon: 'ğŸ“Š' },
  1573â†’];
  1574â†’
  1575â†’export function CommandPalette({ onSelect, visible }: CommandPaletteProps) {
  1576â†’  if (!visible) return null;
  1577â†’
  1578â†’  return (
  1579â†’    <div className="absolute bottom-full left-0 w-full bg-background border rounded-lg shadow-lg p-2">
  1580â†’      {COMMANDS.map((c) => (
  1581â†’        <button
  1582â†’          key={c.cmd}
  1583â†’          onClick={() => onSelect(c.cmd)}
  1584â†’          className="flex items-center gap-2 w-full p-2 hover:bg-accent rounded"
  1585â†’        >
  1586â†’          <span>{c.icon}</span>
  1587â†’          <span className="font-medium">{c.cmd}</span>
  1588â†’          <span className="text-muted-foreground">{c.label}</span>
  1589â†’        </button>
  1590â†’      ))}
  1591â†’    </div>
  1592â†’  );
  1593â†’}
  1594â†’```
  1595â†’
  1596â†’#### 5.3 Tool Result æ¸²æŸ“
  1597â†’
  1598â†’```typescript
  1599â†’// components/chat/tool-result-card.tsx
  1600â†’export function ToolResultCard({ invocation }: { invocation: ToolInvocation }) {
  1601â†’  const { toolName, result, state } = invocation;
  1602â†’
  1603â†’  if (state === 'partial-call') {
  1604â†’    return <LoadingCard toolName={toolName} />;
  1605â†’  }
  1606â†’
  1607â†’  switch (toolName) {
  1608â†’    case 'calculate_bazi':
  1609â†’      return <BaziResultCard data={result} />;
  1610â†’    case 'mood_checkin':
  1611â†’      return <MoodCheckinCard data={result} />;
  1612â†’    case 'create_commitment':
  1613â†’      return <CommitmentCard data={result} />;
  1614â†’    default:
  1615â†’      return <GenericResultCard data={result} />;
  1616â†’  }
  1617â†’}
  1618â†’```
  1619â†’
  1620â†’#### 5.4 äº¤ä»˜ç‰©
  1621â†’
  1622â†’- [ ] `useChat()` é›†æˆ
  1623â†’- [ ] `CommandPalette` ç»„ä»¶
  1624â†’- [ ] `ToolResultCard` ç»„ä»¶
  1625â†’- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
  1626â†’
  1627â†’---
  1628â†’
  1629â†’### Phase 6: æ¸…ç†ä¸ä¼˜åŒ– (Week 6)
  1630â†’
  1631â†’**ç›®æ ‡**: åˆ é™¤æ—§ä»£ç ï¼Œæ€§èƒ½ä¼˜åŒ–
  1632â†’
  1633â†’#### 6.1 åˆ é™¤åˆ—è¡¨
  1634â†’
  1635â†’```bash
  1636â†’# åˆ é™¤æ–‡ä»¶
  1637â†’rm services/glm_client.py
  1638â†’rm services/agent_service_client.py
  1639â†’
  1640â†’# åˆ é™¤ agent_service ç›®å½• (å·²è¿ç§»åˆ° Next.js)
  1641â†’rm -rf agent_service/
  1642â†’
  1643â†’# æ¸…ç† chat_routes.py ä¸­çš„æ—§ç«¯ç‚¹
  1644â†’# - /api/chat/send
  1645â†’# - /api/chat/stream
  1646â†’```
  1647â†’
  1648â†’#### 6.2 API è·¯ç”±æ¸…ç†
  1649â†’
  1650â†’```python
  1651â†’# api/main.py - æ›´æ–°è·¯ç”±æ³¨å†Œ
  1652â†’app.include_router(auth_routes.router)
  1653â†’app.include_router(data_routes.router)      # æ–°å¢
  1654â†’app.include_router(landing_routes.router)   # æ–°å¢
  1655â†’app.include_router(dashboard_routes.router)
  1656â†’app.include_router(report_routes.router)
  1657â†’# åˆ é™¤: app.include_router(chat_routes.router)
  1658â†’```
  1659â†’
  1660â†’#### 6.3 æ€§èƒ½ä¼˜åŒ–
  1661â†’
  1662â†’1. **Context ç¼“å­˜**: ç”¨æˆ·ä¸Šä¸‹æ–‡ Redis ç¼“å­˜ (TTL 5min)
  1663â†’2. **æ‰¹é‡ Tool è°ƒç”¨**: åˆå¹¶å¤šä¸ª fetch è¯·æ±‚
  1664â†’3. **æµå¼é¦–å­—ä¼˜åŒ–**: å‡å°‘ System Prompt é•¿åº¦
  1665â†’
  1666â†’#### 6.4 ç›‘æ§ä¸æ—¥å¿—
  1667â†’
  1668â†’```typescript
  1669â†’// æ·»åŠ  Tool è°ƒç”¨ç›‘æ§
  1670â†’const result = streamText({
  1671â†’  // ...
  1672â†’  onStepFinish({ stepType, toolCalls, toolResults }) {
  1673â†’    // è®°å½• Tool è°ƒç”¨è€—æ—¶
  1674â†’    logger.info('Step finished', {
  1675â†’      stepType,
  1676â†’      toolCount: toolCalls?.length,
  1677â†’      latency: Date.now() - startTime,
  1678â†’    });
  1679â†’  },
  1680â†’});
  1681â†’```
  1682â†’
  1683â†’#### 6.5 äº¤ä»˜ç‰©
  1684â†’
  1685â†’- [ ] æ—§æ–‡ä»¶åˆ é™¤
  1686â†’- [ ] API è·¯ç”±æ›´æ–°
  1687â†’- [ ] Redis ç¼“å­˜é…ç½®
  1688â†’- [ ] ç›‘æ§ Dashboard
  1689â†’
  1690â†’---
  1691â†’
  1692â†’## 4. é£é™©ä¸ç¼“è§£
  1693â†’
  1694â†’### 4.1 å…¼å®¹æ€§é£é™©
  1695â†’
  1696â†’| é£é™©ç‚¹ | å½±å“èŒƒå›´ | ç¼“è§£æªæ–½ |
  1697â†’|--------|----------|----------|
  1698â†’| API ç­¾åå˜æ›´ | å‰ç«¯æ‰€æœ‰ Chat è°ƒç”¨ | åŒè·¯ç”±å¹¶è¡Œï¼ŒFeature Flag æ§åˆ¶ |
  1699â†’| A2UI æ ¼å¼å˜åŒ– | æ¶ˆæ¯æ¸²æŸ“ç»„ä»¶ | ä¿æŒ JSON ç»“æ„å…¼å®¹ï¼Œä»…æ”¹ä¼ è¾“æ–¹å¼ |
  1700â†’| CSRF å¤„ç† | æ‰€æœ‰ POST è¯·æ±‚ | Next.js API Route åŒæºï¼Œæ— éœ€ CSRF |
  1701â†’| Cookie ä¼ é€’ | è®¤è¯æµç¨‹ | `credentials: 'include'` é…ç½® |
  1702â†’
  1703â†’### 4.2 å›æ»šæ–¹æ¡ˆ
  1704â†’
  1705â†’```typescript
  1706â†’// Feature Flag æ§åˆ¶
  1707â†’const USE_NEW_RUNTIME = process.env.USE_NEW_RUNTIME === 'true';
  1708â†’
  1709â†’// å‰ç«¯è·¯ç”±é€‰æ‹©
  1710â†’const chatEndpoint = USE_NEW_RUNTIME ? '/api/chat' : '/api/chat/send';
  1711â†’```
  1712â†’
  1713â†’### 4.3 ç°åº¦å‘å¸ƒ
  1714â†’
  1715â†’1. **Week 1-4**: å†…éƒ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
  1716â†’2. **Week 5**: 10% ç”¨æˆ·ç°åº¦
  1717â†’3. **Week 6**: 50% ç”¨æˆ·ç°åº¦
  1718â†’4. **Week 7**: å…¨é‡å‘å¸ƒ
  1719â†’
  1720â†’---
  1721â†’
  1722â†’## 5. éªŒæ”¶æ ‡å‡†
  1723â†’
  1724â†’### 5.1 åŠŸèƒ½éªŒæ”¶
  1725â†’
  1726â†’| åŠŸèƒ½ | éªŒæ”¶æ ‡å‡† |
  1727â†’|------|----------|
  1728â†’| Chat å¯¹è¯ | æµå¼è¾“å‡ºæ­£å¸¸ï¼Œé¦–å­— < 500ms |
  1729â†’| `/divine` æŒ‡ä»¤ | å…«å­—è®¡ç®—æ­£ç¡®ï¼Œç»“æœæ¸²æŸ“æ­£å¸¸ |
  1730â†’| `/heal` æŒ‡ä»¤ | PERMA è®°å½•æˆåŠŸï¼ŒCBT å¼•å¯¼å®Œæ•´ |
  1731â†’| `/grow` æŒ‡ä»¤ | ç›®æ ‡/ä»»åŠ¡åˆ›å»ºæˆåŠŸ |
  1732â†’| Landing Page | Insight ç”Ÿæˆ < 1sï¼ŒOrb é¢œè‰²æ­£ç¡® |
  1733â†’| Tool Calling | å¤šæ­¥æ¨ç† (maxSteps=5) æ­£å¸¸ |
  1734â†’
  1735â†’### 5.2 æ€§èƒ½éªŒæ”¶
  1736â†’
  1737â†’| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ |
  1738â†’|------|--------|--------|
  1739â†’| é¦–å­—å»¶è¿Ÿ (P50) | < 500ms | ~800ms |
  1740â†’| é¦–å­—å»¶è¿Ÿ (P95) | < 1.5s | ~2s |
  1741â†’| Tool è°ƒç”¨å»¶è¿Ÿ | < 200ms | N/A |
  1742â†’| ç«¯åˆ°ç«¯å“åº” (P50) | < 3s | ~4s |
  1743â†’
  1744â†’### 5.3 ä»£ç è´¨é‡
  1745â†’
  1746â†’- [ ] TypeScript ä¸¥æ ¼æ¨¡å¼
  1747â†’- [ ] Zod Schema 100% è¦†ç›–
  1748â†’- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%
  1749â†’- [ ] E2E æµ‹è¯•é€šè¿‡
  1750â†’
  1751â†’---
  1752â†’
  1753â†’## 6. é™„å½•
  1754â†’
  1755â†’### 6.1 ç¯å¢ƒå˜é‡
  1756â†’
  1757â†’```bash
  1758â†’# .env.local (Next.js)
  1759â†’FASTAPI_URL=http://localhost:8230
  1760â†’GOOGLE_API_KEY=xxx
  1761â†’ANTHROPIC_API_KEY=xxx
  1762â†’GLM_API_KEY=xxx
  1763â†’USE_NEW_RUNTIME=true
  1764â†’```
  1765â†’
  1766â†’### 6.2 ä¾èµ–æ›´æ–°
  1767â†’
  1768â†’```json
  1769â†’// package.json
  1770â†’{
  1771â†’  "dependencies": {
  1772â†’    "ai": "^4.0.0",
  1773â†’    "@ai-sdk/google": "^1.0.0",
  1774â†’    "@ai-sdk/anthropic": "^1.0.0",
  1775â†’    "zod": "^3.22.0"
  1776â†’  }
  1777â†’}
  1778â†’```
  1779â†’
  1780â†’### 6.3 å‚è€ƒæ–‡æ¡£
  1781â†’
  1782â†’- [Vercel AI SDK æ–‡æ¡£](https://sdk.vercel.ai/docs)
  1783â†’- [os_design_v3.md Â§1.4-1.5](./os_design_v3.md)
  1784â†’- [frontend_final_v3.md Â§2.6](./frontend_final_v3.md)
  1785â†’- [system_design_final_mvp_v3.md Â§7.0.1](./system_design_final_mvp_v3.md)
  1786â†’- [admin_v3.md](./admin_v3.md) - Admin System è®¾è®¡ï¼Œå¯ä¸æœ¬é‡æ„å¹¶è¡Œå¼€å‘
  1787â†’
  1788â†’### 6.4 å¹¶è¡Œå¼€å‘é¡¹
  1789â†’
  1790â†’| é¡¹ç›® | æè¿° | æŠ€æœ¯æ ˆ | ä¾èµ–å…³ç³» |
  1791â†’|------|------|--------|----------|
  1792â†’| **Admin System** | åå°ç®¡ç†é©¾é©¶èˆ± | Next.js App Router + shadcn/ui + Monaco | Phase 1 å®Œæˆåå¯å¯åŠ¨ |
  1793â†’| **Landing Page** | Digital Mirror é¦–é¡µ | Next.js + React Three Fiber | ç‹¬ç«‹å¼€å‘ |
  1794â†’
  1795â†’> **æ³¨**: Admin System çš„ Agent Studio æ¨¡å—ä¾èµ–æœ¬é‡æ„ä¸­çš„ `admin_prompts` è¡¨å’Œ Prompt çƒ­åŠ è½½æœºåˆ¶ï¼ˆPhase 4ï¼‰ï¼Œå»ºè®®åœ¨ Phase 4 å®Œæˆåè¿›è¡Œ Admin å‰ç«¯å¼€å‘ã€‚
  1796â†’
  1797â†’---
  1798â†’
  1799â†’*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
  1800â†’*åˆ›å»ºæ—¥æœŸ: 2026-01-01*
  1801â†’*ä½œè€…: Claude (Anthropic)*
  1802â†’

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
