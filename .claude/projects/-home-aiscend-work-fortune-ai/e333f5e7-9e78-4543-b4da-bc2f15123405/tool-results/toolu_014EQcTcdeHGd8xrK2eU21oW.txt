73-@dataclass(frozen=True)
74-class SessionTokens:
75:    session_token: str
76-    csrf_token: str
77-    session_id: str
--
80-
81-def create_session(user_id: int, ip: str = "", user_agent: str = "") -> SessionTokens:
82:    session_token = new_base64url_token(32)
83-    csrf_token = new_base64url_token(32)
84:    token_hash = sha256_hex(session_token)
85-    csrf_hash = sha256_hex(csrf_token)
86-
87-    row = fortune_db.execute_returning_one(
88-        """
89:        INSERT INTO fortune_user_session (user_id, token_hash, csrf_token_hash, ip, user_agent, expires_at)
90-        VALUES (%s, %s, %s, %s, %s, now() + interval '30 days')
91-        RETURNING session_id, expires_at
92-        """,
93:        (user_id, token_hash, csrf_hash, (ip or "")[:200], (user_agent or "")[:500]),
94-    )
95-    if not row:
96-        raise AuthError("session_create_failed")
97-    return SessionTokens(
98:        session_token=session_token,
99-        csrf_token=csrf_token,
100-        session_id=str(row["session_id"]),
--
220-
221-
222:def get_user_by_session_token(session_token: str) -> Optional[Dict[str, Any]]:
223:    tok = (session_token or "").strip()
224-    if not tok:
225-        return None
226:    token_hash = sha256_hex(tok)
227-    return fortune_db.fetch_one(
228-        """
--
230-          s.session_id,
231-          s.user_id,
232:          s.csrf_token_hash,
233-          s.expires_at,
234-          u.email,
--
239-        JOIN fortune_user u ON u.user_id = s.user_id
240-        LEFT JOIN fortune_user_preferences p ON p.user_id = u.user_id
241:        WHERE s.token_hash = %s
242-          AND s.revoked_at IS NULL
243-          AND s.expires_at > now()
--
245-        LIMIT 1
246-        """,
247:        (token_hash,),
248-    )
249-