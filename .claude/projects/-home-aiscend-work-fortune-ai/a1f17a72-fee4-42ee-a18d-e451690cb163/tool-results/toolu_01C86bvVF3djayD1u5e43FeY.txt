     1→window.fortuneAuth = (() => {
     2→  const $ = (s, r=document) => r.querySelector(s);
     3→  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
     4→
     5→  function resolveErrEl(scope){
     6→    if (scope && scope.classList && scope.classList.contains('error')) return scope;
     7→    return scope?.querySelector?.('.error') || $('#err') || $('#err-login');
     8→  }
     9→
    10→  function escapeHtml(text){
    11→    return String(text ?? "")
    12→      .replaceAll("&","&amp;")
    13→      .replaceAll("<","&lt;")
    14→      .replaceAll(">","&gt;")
    15→      .replaceAll("\"","&quot;")
    16→      .replaceAll("'","&#39;");
    17→  }
    18→
    19→  function safeJsonParse(text){
    20→    try { return JSON.parse(text); } catch { return null; }
    21→  }
    22→
    23→  function clamp(n, a, b){
    24→    if (!Number.isFinite(n)) return a;
    25→    return Math.max(a, Math.min(b, n));
    26→  }
    27→
    28→  function showErrIn(scope, msg){
    29→    const el = resolveErrEl(scope);
    30→    if(!el) return;
    31→    el.style.display = 'block';
    32→    el.textContent = String(msg || '请求失败');
    33→  }
    34→  function hideErrIn(scope){
    35→    const el = resolveErrEl(scope);
    36→    if(!el) return;
    37→    el.style.display = 'none';
    38→    el.textContent = '';
    39→  }
    40→
    41→  async function postJson(url, body){
    42→    const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
    43→    const data = await res.json().catch(()=>null);
    44→    if(!res.ok || !data || data.ok !== true){
    45→      const msg = data?.error?.message || data?.detail || 'request_failed';
    46→      throw new Error(msg);
    47→    }
    48→    return data.data;
    49→  }
    50→
    51→  function parseTzOffsetHours(raw){
    52→    const s = String(raw ?? '').trim().replace(/^UTC/i,'').replace(/^GMT/i,'').trim();
    53→    if (!s) return null;
    54→    const v = Number(s);
    55→    if (!Number.isFinite(v)) return null;
    56→    if (v < -12 || v > 14) return null;
    57→    return v;
    58→  }
    59→
    60→  function parseFiniteNumber(raw){
    61→    const v = Number(String(raw ?? '').trim());
    62→    return Number.isFinite(v) ? v : null;
    63→  }
    64→
    65→  function normalizeDateInput(raw){
    66→    const digits = String(raw ?? '').replace(/\D/g,'').slice(0,8);
    67→    if (digits.length <= 4) return digits;
    68→    if (digits.length <= 6) return `${digits.slice(0,4)}-${digits.slice(4)}`;
    69→    return `${digits.slice(0,4)}-${digits.slice(4,6)}-${digits.slice(6,8)}`;
    70→  }
    71→
    72→  function normalizeTimeInput(raw){
    73→    const s = String(raw ?? '').trim();
    74→    if (s.includes(':')){
    75→      // keep as-is but normalize digits
    76→      const parts = s.split(':').slice(0,2);
    77→      const hh = (parts[0] || '').replace(/\D/g,'').slice(0,2);
    78→      const mm = (parts[1] || '').replace(/\D/g,'').slice(0,2);
    79→      if (!hh && !mm) return '';
    80→      if (hh && !mm) return hh;
    81→      return `${hh}:${mm}`;
    82→    }
    83→    const digits = s.replace(/\D/g,'').slice(0,4);
    84→    if (digits.length <= 2) return digits;
    85→    if (digits.length === 3) return `0${digits.slice(0,1)}:${digits.slice(1)}`;
    86→    return `${digits.slice(0,2)}:${digits.slice(2)}`;
    87→  }
    88→
    89→  function normalizeTimeComplete(raw){
    90→    const s = String(raw ?? '').trim();
    91→    if (s.includes(':')){
    92→      const parts = s.split(':').slice(0,2);
    93→      let hh = String(parts[0] || '').replace(/\D/g,'').slice(0,2);
    94→      let mm = String(parts[1] || '').replace(/\D/g,'').slice(0,2);
    95→      if (!hh && !mm) return '';
    96→      if (hh.length === 1) hh = `0${hh}`;
    97→      if (!mm) mm = '00';
    98→      if (mm.length === 1) mm = `0${mm}`;
    99→      return `${hh}:${mm}`;
   100→    }
   101→
   102→    const digits = s.replace(/\D/g,'').slice(0,4);
   103→    if (!digits) return '';
   104→    if (digits.length === 1) return `0${digits}:00`;
   105→    if (digits.length === 2) return `${digits}:00`;
   106→    if (digits.length === 3) return `0${digits.slice(0,1)}:${digits.slice(1)}`;
   107→    return `${digits.slice(0,2)}:${digits.slice(2)}`;
   108→  }
   109→
   110→  function isValidDateYmd(text){
   111→    const m = String(text ?? '').match(/^(\d{4})-(\d{2})-(\d{2})$/);
   112→    if(!m) return false;
   113→    const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]);
   114→    if(!Number.isFinite(y) || !Number.isFinite(mo) || !Number.isFinite(d)) return false;
   115→    if(mo < 1 || mo > 12) return false;
   116→    if(d < 1 || d > 31) return false;
   117→    const dt = new Date(Date.UTC(y, mo-1, d));
   118→    return dt.getUTCFullYear() === y && (dt.getUTCMonth()+1) === mo && dt.getUTCDate() === d;
   119→  }
   120→
   121→  function isValidTimeHm(text){
   122→    const m = String(text ?? '').match(/^(\d{2}):(\d{2})$/);
   123→    if(!m) return false;
   124→    const h = Number(m[1]), mm = Number(m[2]);
   125→    if(!Number.isFinite(h) || !Number.isFinite(mm)) return false;
   126→    return h >= 0 && h <= 23 && mm >= 0 && mm <= 59;
   127→  }
   128→
   129→  function toBirthdayLocal(dateYmd, timeHm){
   130→    // Backend expects "YYYY-MM-DD HH:MM:SS"
   131→    const t = String(timeHm ?? '');
   132→    const withSeconds = t.length === 5 ? `${t}:00` : t;
   133→    return `${dateYmd} ${withSeconds}`;
   134→  }
   135→
   136→  function getDefaultTz(){
   137→    // JS offset minutes west of UTC; want +8 etc.
   138→    const raw = -new Date().getTimezoneOffset() / 60;
   139→    // limit to half-hour increments (avoid 1.999999)
   140→    const v = Math.round(raw * 2) / 2;
   141→    return clamp(v, -12, 14);
   142→  }
   143→
   144→  function defaultLocation(){
   145→    return { name: '北京', longitude: 116.4074, latitude: 39.9042 };
   146→  }
   147→
   148→  function buildPreviewHtml(preview){
   149→    const p = preview?.pillars || {};
   150→    const dm = preview?.day_master || {};
   151→    const wc = preview?.wuxing_count || {};
   152→    const strength = preview?.strength || '';
   153→    const favorable = Array.isArray(preview?.favorable_elements) ? preview.favorable_elements.filter(Boolean).map(String) : [];
   154→    const luck = preview?.luck || {};
   155→
   156→    const max = Math.max(1, ...Object.values(wc).map(v => Number(v) || 0));
   157→    const items = [
   158→      ['金', wc['金'] ?? 0],
   159→      ['木', wc['木'] ?? 0],
   160→      ['水', wc['水'] ?? 0],
   161→      ['火', wc['火'] ?? 0],
   162→      ['土', wc['土'] ?? 0],
   163→    ];
   164→
   165→    const bars = items.map(([k, v]) => {
   166→      const n = Number(v) || 0;
   167→      const pct = Math.round((n / max) * 100);
   168→      return `
   169→        <div class="bar">
   170→          <div class="name">${escapeHtml(k)}</div>
   171→          <div class="track"><div class="fill" style="width:${pct}%"></div></div>
   172→          <div class="count">${escapeHtml(String(n))}</div>
   173→        </div>
   174→      `;
   175→    }).join('');
   176→
   177→    const forward = typeof luck.forward === 'boolean' ? (luck.forward ? '顺行' : '逆行') : '';
   178→    const startAge = Number.isFinite(Number(luck.start_age_year)) ? String(Number(luck.start_age_year)) : '';
   179→
   180→    const usedDefaultLoc = preview?.used_default_location ? '（使用默认经纬度）' : '';
   181→
   182→    return `
   183→      <div class="pillars">
   184→        <div class="pillar"><div class="k">year</div><div class="v">${escapeHtml(p.year || '—')}</div></div>
   185→        <div class="pillar"><div class="k">month</div><div class="v">${escapeHtml(p.month || '—')}</div></div>
   186→        <div class="pillar"><div class="k">day</div><div class="v">${escapeHtml(p.day || '—')}</div></div>
   187→        <div class="pillar"><div class="k">hour</div><div class="v">${escapeHtml(p.hour || '—')}</div></div>
   188→      </div>
   189→
   190→      <div class="meta-line">
   191→        <span class="tag">日主：${escapeHtml(dm.gan || '—')}${escapeHtml(dm.element || '')}</span>
   192→        ${strength ? `<span class="tag">强弱：${escapeHtml(String(strength))}</span>` : ''}
   193→        ${favorable.length ? `<span class="tag">有利：${escapeHtml(favorable.join(' '))}</span>` : ''}
   194→        ${(forward && startAge) ? `<span class="tag">起运：${escapeHtml(startAge)} 岁 · ${escapeHtml(forward)}</span>` : ''}
   195→      </div>
   196→
   197→      <div class="bars">${bars}</div>
   198→      <div class="preview__note">此为即时预览${usedDefaultLoc}；点击“保存并进入工作台”后才会写入并用于个性化。</div>
   199→    `;
   200→  }
   201→
   202→  function initLogin(){
   203→    const form = $('#login-form');
   204→    if(!form) return;
   205→    form.addEventListener('submit', async (e)=>{
   206→      e.preventDefault();
   207→      hideErrIn(form);
   208→      const q = (sel) => form.querySelector(sel);
   209→      const email = (q('input[type=email]')?.value || '').trim();
   210→      const password = (q('input[type=password]')?.value || '');
   211→      try{
   212→        await postJson('/api/auth/login', {email, password});
   213→        location.href = '/main';
   214→      }catch(err){
   215→        showErrIn(form, String(err?.message || err));
   216→      }
   217→    });
   218→  }
   219→
   220→  function initRegister(){
   221→    const form = $('#register-form');
   222→    if(!form) return;
   223→    form.addEventListener('submit', async (e)=>{
   224→      e.preventDefault();
   225→      hideErrIn(form);
   226→      const q = (sel) => form.querySelector(sel);
   227→      const email = (q('input[type=email]')?.value || '').trim();
   228→      const password = (q('input[type=password]')?.value || '');
   229→      const name = (q('#name')?.value || '').trim();
   230→      const gender = (q('#gender')?.value || '').trim();
   231→      const birthDate = (q('#birth-date')?.value || '').trim();
   232→      const birthTime = (q('#birth-time')?.value || '').trim();
   233→      const tz = parseFloat(((q('#tz')?.value || '8')+'').trim());
   234→      const locName = (q('#loc-name')?.value || '').trim();
   235→      const lon = parseFloat(((q('#lon')?.value || '')+'').trim());
   236→      const lat = parseFloat(((q('#lat')?.value || '')+'').trim());
   237→      if(!birthDate || !birthTime){
   238→        showErrIn(form, 'missing_birthday');
   239→        return;
   240→      }
   241→      const birthday_local = `${birthDate} ${birthTime.length===5 ? birthTime+':00' : birthTime}`;
   242→      try{
   243→        await postJson('/api/auth/register', {
   244→          email,
   245→          password,
   246→          name,
   247→          gender,
   248→          birthday_local,
   249→          tz_offset_hours: tz,
   250→          location: {name: locName, longitude: lon, latitude: lat},
   251→        });
   252→        location.href = '/main';
   253→      }catch(err){
   254→        showErrIn(form, String(err?.message || err));
   255→      }
   256→    });
   257→  }
   258→
   259→  function initAuthExperience(){
   260→    const root = document.querySelector('[data-auth-root]');
   261→    if(!root) return;
   262→
   263→    const expForm = $('#experience-form', root);
   264→    const errExp = $('#err-exp', root);
   265→    const previewCard = $('#preview-card', root);
   266→    const previewBody = $('#preview-body', root);
   267→    const previewStamp = $('#preview-stamp', root);
   268→
   269→    const genderEl = $('#exp-gender', root);
   270→    const tzEl = $('#exp-tz', root);
   271→    const dateEl = $('#exp-birth-date', root);
   272→    const timeEl = $('#exp-birth-time', root);
   273→    const locNameEl = $('#exp-loc-name', root);
   274→    const lonEl = $('#exp-lon', root);
   275→    const latEl = $('#exp-lat', root);
   276→
   277→    // Mode tabs (八字/紫微/星座)
   278→    const modeTabs = $$('.mode-tab', root);
   279→    let currentMode = 'bazi';
   280→
   281→    // Validation points
   282→    const validationCard = $('#validation-card', root);
   283→    const validationPoints = $('#validation-points', root);
   284→
   285→    // Inline auth (非弹窗)
   286→    const authInline = $('#auth-inline', root);
   287→    const errInline = $('#err-inline', root);
   288→    const toggleRegister = $('#toggle-register', root);
   289→    const toggleLogin = $('#toggle-login', root);
   290→    const inlineRegister = $('#inline-register', root);
   291→    const inlineLogin = $('#inline-login', root);
   292→    const inlineRegisterForm = $('#inline-register-form', root);
   293→    const inlineLoginForm = $('#inline-login-form', root);
   294→    const btnInlineRegister = $('#btn-inline-register', root);
   295→
   296→    // Modal sheet (保留兼容)
   297→    const sheet = $('#account-sheet');
   298→    const errAuth = $('#err-auth');
   299→    const segRegister = $('#seg-register');
   300→    const segLogin = $('#seg-login');
   301→    const paneRegister = $('#pane-register');
   302→    const paneLogin = $('#pane-login');
   303→    const regForm = $('#register-form');
   304→    const loginForm = $('#login-form');
   305→
   306→    if(!expForm || !previewCard || !previewBody || !previewStamp || !genderEl || !tzEl || !dateEl || !timeEl || !locNameEl || !lonEl || !latEl){
   307→      return;
   308→    }
   309→
   310→    let lastPreviewKey = '';
   311→    let previewTimer = null;
   312→    let inflight = 0;
   313→    let lastPreviewOk = false;
   314→    let validationInflight = 0;
   315→
   316→    function setStamp(text){
   317→      previewStamp.textContent = String(text || '').trim() || '—';
   318→    }
   319→
   320→    function setPreviewState(state){
   321→      previewCard.dataset.state = state;
   322→      if (state === 'idle') setStamp('waiting');
   323→      if (state === 'loading') setStamp('generating');
   324→      if (state === 'ready') setStamp('ready');
   325→      if (state === 'error') setStamp('error');
   326→    }
   327→
   328→    function saveDraft(){
   329→      const draft = readExperienceDraft();
   330→      try{ sessionStorage.setItem('fortune_auth_draft_v1', JSON.stringify(draft)); }catch{}
   331→    }
   332→
   333→    function loadDraft(){
   334→      try{
   335→        const raw = sessionStorage.getItem('fortune_auth_draft_v1');
   336→        const d = safeJsonParse(raw);
   337→        if(!d) return;
   338→        if (d.gender) genderEl.value = String(d.gender);
   339→        if (d.tz !== undefined && d.tz !== null && d.tz !== '') tzEl.value = String(d.tz);
   340→        if (d.birth_date) dateEl.value = String(d.birth_date);
   341→        if (d.birth_time) timeEl.value = String(d.birth_time);
   342→        if (d.loc_name) locNameEl.value = String(d.loc_name);
   343→        if (d.lon !== undefined && d.lon !== null) lonEl.value = String(d.lon);
   344→        if (d.lat !== undefined && d.lat !== null) latEl.value = String(d.lat);
   345→      } catch {}
   346→    }
   347→
   348→    function readExperienceDraft(){
   349→      return {
   350→        gender: genderEl.value,
   351→        tz: tzEl.value,
   352→        birth_date: dateEl.value,
   353→        birth_time: timeEl.value,
   354→        loc_name: locNameEl.value,
   355→        lon: lonEl.value,
   356→        lat: latEl.value,
   357→      };
   358→    }
   359→
   360→    function readBirthInfo(){
   361→      const gender = String(genderEl.value || '').trim();
   362→      const birthDate = String(dateEl.value || '').trim();
   363→      const birthTime = String(timeEl.value || '').trim();
   364→      const tz = parseTzOffsetHours(tzEl.value);
   365→      const locName = String(locNameEl.value || '').trim();
   366→      const lon = parseFiniteNumber(lonEl.value);
   367→      const lat = parseFiniteNumber(latEl.value);
   368→      const locDefault = defaultLocation();
   369→
   370→      const validDate = isValidDateYmd(birthDate);
   371→      const validTime = isValidTimeHm(birthTime);
   372→
   373→      const loc = (() => {
   374→        const haveLon = Number.isFinite(lon) && lon >= -180 && lon <= 180;
   375→        const haveLat = Number.isFinite(lat) && lat >= -90 && lat <= 90;
   376→        if (haveLon && haveLat){
   377→          return { name: locName || locDefault.name, longitude: lon, latitude: lat, used_default_location: false };
   378→        }
   379→        return { ...locDefault, name: locName || locDefault.name, used_default_location: true };
   380→      })();
   381→
   382→      const ok = (gender === '男' || gender === '女') && validDate && validTime;
   383→
   384→      return {
   385→        ok,
   386→        gender,
   387→        birthDate,
   388→        birthTime,
   389→        tz: tz ?? getDefaultTz(),
   390→        location: { name: loc.name, longitude: loc.longitude, latitude: loc.latitude },
   391→        used_default_location: loc.used_default_location,
   392→      };
   393→    }
   394→
   395→    async function runPreview(reason='auto'){
   396→      const birth = readBirthInfo();
   397→      hideErrIn(errExp);
   398→      if (!birth.ok){
   399→        lastPreviewOk = false;
   400→        btnSave.disabled = true;
   401→        setPreviewState('idle');
   402→        previewBody.innerHTML = `<div class="preview__note">填写出生日期/时间后将自动生成；或点击“生成预览”。</div>`;
   403→        if (reason === 'manual'){
   404→          showErrIn(errExp, '请先补全：性别 / 出生日期 / 出生时间');
   405→        }
   406→        return;
   407→      }
   408→
   409→      const key = JSON.stringify({
   410→        gender: birth.gender,
   411→        birthday_local: toBirthdayLocal(birth.birthDate, birth.birthTime),
   412→        tz_offset_hours: birth.tz,
   413→        location: birth.location,
   414→      });
   415→      if (key === lastPreviewKey && lastPreviewOk) {
   416→        btnSave.disabled = false;
   417→        return;
   418→      }
   419→      lastPreviewKey = key;
   420→
   421→      setPreviewState('loading');
   422→      previewBody.innerHTML = `<div class="preview__note">正在生成预览…</div>`;
   423→      btnSave.disabled = true;
   424→
   425→      const ticket = ++inflight;
   426→      try{
   427→        const payload = JSON.parse(key);
   428→        const data = await postJson('/api/auth/preview', payload);
   429→        if (ticket !== inflight) return;
   430→        lastPreviewOk = true;
   431→        setPreviewState('ready');
   432→        previewBody.innerHTML = buildPreviewHtml(data);
   433→        btnSave.disabled = false;
   434→      }catch(err){
   435→        if (ticket !== inflight) return;
   436→        lastPreviewOk = false;
   437→        setPreviewState('error');
   438→        previewBody.innerHTML = `<div class="preview__note">预览失败：${escapeHtml(String(err?.message || err))}</div>`;
   439→        btnSave.disabled = false; // allow saving even if preview fails; birth info might still be valid
   440→      }
   441→    }
   442→
   443→    function schedulePreview(){
   444→      if (previewTimer) window.clearTimeout(previewTimer);
   445→      previewTimer = window.setTimeout(() => runPreview('auto'), 420);
   446→    }
   447→
   448→    // Masks
   449→    dateEl.addEventListener('input', () => {
   450→      const next = normalizeDateInput(dateEl.value);
   451→      if (next !== dateEl.value) dateEl.value = next;
   452→      saveDraft();
   453→      schedulePreview();
   454→    });
   455→    timeEl.addEventListener('input', () => {
   456→      const next = normalizeTimeInput(timeEl.value);
   457→      if (next !== timeEl.value) timeEl.value = next;
   458→      saveDraft();
   459→      schedulePreview();
   460→    });
   461→    timeEl.addEventListener('blur', () => {
   462→      const next = normalizeTimeComplete(timeEl.value);
   463→      if (next && next !== timeEl.value) timeEl.value = next;
   464→      saveDraft();
   465→      schedulePreview();
   466→    });
   467→    [genderEl, tzEl, locNameEl, lonEl, latEl].forEach((el) => {
   468→      el.addEventListener('input', () => { saveDraft(); schedulePreview(); });
   469→      el.addEventListener('change', () => { saveDraft(); schedulePreview(); });
   470→    });
   471→
   472→    // Actions
   473→    root.addEventListener('click', (e) => {
   474→      const btn = e.target?.closest?.('[data-action]');
   475→      const action = btn?.getAttribute?.('data-action');
   476→      if (!action) return;
   477→      if (action === 'set-noon'){
   478→        timeEl.value = '12:00';
   479→        saveDraft();
   480→        schedulePreview();
   481→      }
   482→      if (action === 'preview'){
   483→        runPreview('manual');
   484→      }
   485→    });
   486→
   487→    // Sheet controls
   488→    function showSheet(mode){
   489→      if (!sheet) return;
   490→      sheet.classList.add('show');
   491→      sheet.setAttribute('aria-hidden','false');
   492→      document.body.style.overflow = 'hidden';
   493→      switchAuthMode(mode);
   494→      window.setTimeout(() => {
   495→        const focusEl = mode === 'login' ? $('#login-email') : $('#reg-email');
   496→        focusEl?.focus?.();
   497→      }, 0);
   498→    }
   499→    function hideSheet(){
   500→      if (!sheet) return;
   501→      sheet.classList.remove('show');
   502→      sheet.setAttribute('aria-hidden','true');
   503→      document.body.style.overflow = '';
   504→      hideErrIn(errAuth);
   505→    }
   506→    function switchAuthMode(mode){
   507→      const login = mode === 'login';
   508→      if (segLogin && segRegister){
   509→        segLogin.classList.toggle('active', login);
   510→        segRegister.classList.toggle('active', !login);
   511→        segLogin.setAttribute('aria-selected', String(login));
   512→        segRegister.setAttribute('aria-selected', String(!login));
   513→      }
   514→      paneLogin?.classList.toggle('hidden', !login);
   515→      paneRegister?.classList.toggle('hidden', login);
   516→    }
   517→
   518→    btnSave.addEventListener('click', () => showSheet('register'));
   519→
   520→    document.addEventListener('click', (e) => {
   521→      const el = e.target?.closest?.('[data-action]');
   522→      const action = el?.getAttribute?.('data-action');
   523→      if (!action) return;
   524→      if (action === 'open-login'){
   525→        showSheet('login');
   526→      }
   527→      if (action === 'close-sheet'){
   528→        hideSheet();
   529→      }
   530→      if (action === 'switch-login'){
   531→        showSheet('login');
   532→      }
   533→      if (action === 'switch-register'){
   534→        showSheet('register');
   535→      }
   536→    });
   537→
   538→    document.addEventListener('keydown', (e) => {
   539→      if (e.key === 'Escape') hideSheet();
   540→    });
   541→
   542→    segRegister?.addEventListener('click', () => switchAuthMode('register'));
   543→    segLogin?.addEventListener('click', () => switchAuthMode('login'));
   544→
   545→    // Register / login submit (reuse preview birth info)
   546→    regForm?.addEventListener('submit', async (e) => {
   547→      e.preventDefault();
   548→      hideErrIn(errAuth);
   549→
   550→      const birth = readBirthInfo();
   551→      if (!birth.ok){
   552→        hideSheet();
   553→        showErrIn(errExp, '请先补全出生信息（性别/日期/时间），生成预览后再保存。');
   554→        dateEl.focus();
   555→        return;
   556→      }
   557→
   558→      const fd = new FormData(regForm);
   559→      const email = String(fd.get('email') || '').trim();
   560→      const password = String(fd.get('password') || '');
   561→      const name = String(fd.get('name') || '').trim();
   562→      if (!name){
   563→        showErrIn(errAuth, '昵称为必填项');
   564→        return;
   565→      }
   566→
   567→      try{
   568→        await postJson('/api/auth/register', {
   569→          email,
   570→          password,
   571→          name,
   572→          gender: birth.gender,
   573→          birthday_local: toBirthdayLocal(birth.birthDate, birth.birthTime),
   574→          tz_offset_hours: birth.tz,
   575→          location: birth.location,
   576→        });
   577→        try { sessionStorage.removeItem('fortune_auth_draft_v1'); } catch {}
   578→        location.href = '/main';
   579→      }catch(err){
   580→        showErrIn(errAuth, String(err?.message || err));
   581→      }
   582→    });
   583→
   584→    loginForm?.addEventListener('submit', async (e) => {
   585→      e.preventDefault();
   586→      hideErrIn(errAuth);
   587→      const fd = new FormData(loginForm);
   588→      const email = String(fd.get('email') || '').trim();
   589→      const password = String(fd.get('password') || '');
   590→      try{
   591→        await postJson('/api/auth/login', { email, password });
   592→        location.href = '/main';
   593→      }catch(err){
   594→        showErrIn(errAuth, String(err?.message || err));
   595→      }
   596→    });
   597→
   598→    // init defaults
   599→    loadDraft();
   600→    if (!String(tzEl.value || '').trim()) tzEl.value = String(getDefaultTz());
   601→
   602→    // Handle mode from URL
   603→    const url = new URL(location.href);
   604→    const mode = url.searchParams.get('mode') || '';
   605→    const pathname = location.pathname || '';
   606→    if (mode === 'register' || pathname === '/register'){
   607→      // Encourage preview first; but open the save sheet so users can "save" immediately after preview.
   608→      showSheet('register');
   609→    } else if (mode === 'login'){
   610→      showSheet('login');
   611→    }
   612→
   613→    // kick off preview if possible
   614→    schedulePreview();
   615→  }
   616→
   617→  return { initLogin, initRegister, initAuthExperience };
   618→})();
   619→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
