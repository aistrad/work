     1→/**
     2→ * Context Builder for Fortune AI Agent Runtime
     3→ *
     4→ * Builds the system prompt from context fetched from FastAPI internal API.
     5→ * The context includes user profile, preferences, evidence, and anti-dependency check.
     6→ */
     7→
     8→export interface UserContext {
     9→  user_id: number;
    10→  system_prompt: string;
    11→  persona_style: string;
    12→  user_context: Record<string, unknown>;
    13→  evidence: Record<string, unknown>;
    14→  anti_dependency: {
    15→    should_intervene: boolean;
    16→    intervention_type: string | null;
    17→    intervention_message: string | null;
    18→  };
    19→  history: Array<{ role: string; content: string }>;
    20→}
    21→
    22→// System prompt template for streaming (Markdown output)
    23→const SYSTEM_PROMPT_STREAM_TEMPLATE = `你是 Fortune AI 的对话 Agent，角色是积极心理学教练（Performance Coach）。
    24→
    25→【产品定位】
    26→人生导航 / 陪伴 / 提升。系统和交互保持"有效而极简"。
    27→
    28→【你的优先级（不可逆）】
    29→Coach > Teaching Assistant > Customer Support > Sales
    30→
    31→【硬性规则（必须遵守）】
    32→1) 禁止恐吓、羞辱、宿命论断言；负面信息必须紧接"你可以做什么"的行动处方。
    33→2) 禁止自行计算八字事实；只能基于提供的 facts + evidence 输出。
    34→3) 每次输出必须包含：结论(conclusion) + 依据(why) + ≤3条处方(prescriptions) + 承诺邀请(commitment_ask)。
    35→4) 每条处方必须包含 if_then：如果____→那么____；并优先给 2–5 分钟可启动版本。
    36→5) 只输出 Markdown 文本，不要 JSON/代码块/额外说明。
    37→6) 当需要查询八字、运势、心理等功能时，使用提供的 tools 来获取数据。
    38→
    39→【语言风格 persona_style】
    40→standard：清晰、中性、专业
    41→warm：共情、支持性（默认）
    42→roast：轻毒舌但不羞辱、不对人格做负面定性
    43→
    44→【输入（系统已注入）】
    45→persona_style: {{persona_style}}
    46→user_context: {{user_context_json}}
    47→evidence: {{evidence_json}}
    48→
    49→【输出（Markdown）】
    50→用如下结构输出（标题可省略但必须包含"处方"一节）：
    51→
    52→结论：...
    53→依据：...
    54→处方：
    55→1) ...（包含 if_then）
    56→2) ...（包含 if_then）
    57→3) ...（包含 if_then）
    58→承诺邀请：...（一句话，邀请用户选择一个处方开始）
    59→`;
    60→
    61→// Build system prompt from context
    62→export function buildSystemPrompt(context: UserContext): string {
    63→  // Start with the template
    64→  let prompt = SYSTEM_PROMPT_STREAM_TEMPLATE;
    65→
    66→  // Replace placeholders
    67→  prompt = prompt.replace('{{persona_style}}', context.persona_style || 'warm');
    68→  prompt = prompt.replace(
    69→    '{{user_context_json}}',
    70→    JSON.stringify(context.user_context, null, 2)
    71→  );
    72→  prompt = prompt.replace(
    73→    '{{evidence_json}}',
    74→    JSON.stringify(context.evidence, null, 2)
    75→  );
    76→
    77→  // Add anti-dependency intervention if needed
    78→  if (context.anti_dependency?.should_intervene) {
    79→    prompt += `\n\n【反依赖干预 - 必须首先处理】
    80→类型: ${context.anti_dependency.intervention_type}
    81→消息: ${context.anti_dependency.intervention_message}
    82→
    83→请在回复开头温和地提醒用户上述内容，然后正常回答问题。
    84→`;
    85→  }
    86→
    87→  return prompt;
    88→}
    89→
    90→// Convert chat history to Vercel AI SDK format
    91→export function buildMessages(
    92→  context: UserContext,
    93→  userMessage: string
    94→): Array<{ role: 'user' | 'assistant'; content: string }> {
    95→  const messages: Array<{ role: 'user' | 'assistant'; content: string }> = [];
    96→
    97→  // Add history
    98→  for (const msg of context.history) {
    99→    if (msg.role === 'user' || msg.role === 'assistant') {
   100→      messages.push({
   101→        role: msg.role as 'user' | 'assistant',
   102→        content: msg.content,
   103→      });
   104→    }
   105→  }
   106→
   107→  // Add current message
   108→  messages.push({
   109→    role: 'user',
   110→    content: userMessage,
   111→  });
   112→
   113→  return messages;
   114→}
   115→
   116→// Fetch context from FastAPI internal API
   117→export async function fetchContext(
   118→  sessionId: string | null,
   119→  query: string,
   120→  sessionCookie: string
   121→): Promise<UserContext> {
   122→  const fastApiUrl = process.env.FASTAPI_URL || 'http://localhost:8230';
   123→
   124→  const params = new URLSearchParams();
   125→  if (sessionId) params.set('session_id', sessionId);
   126→  if (query) params.set('query', query);
   127→
   128→  const res = await fetch(`${fastApiUrl}/internal/context?${params.toString()}`, {
   129→    headers: {
   130→      Cookie: `fortune_session=${sessionCookie}`,
   131→    },
   132→  });
   133→
   134→  if (!res.ok) {
   135→    throw new Error(`Failed to fetch context: ${res.status}`);
   136→  }
   137→
   138→  return res.json();
   139→}
   140→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
