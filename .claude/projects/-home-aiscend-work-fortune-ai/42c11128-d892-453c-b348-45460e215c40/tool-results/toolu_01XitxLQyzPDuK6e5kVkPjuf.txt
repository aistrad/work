     1→/**
     2→ * API Layer - 与后端 Soul OS API 通信
     3→ *
     4→ * 后端 API 格式: { ok: boolean, data?: T, error?: { code, message, detail } }
     5→ */
     6→
     7→const API_BASE = process.env.NEXT_PUBLIC_API_BASE || ''
     8→
     9→// Cookie helper
    10→function getCookie(name: string): string {
    11→  if (typeof document === 'undefined') return ''
    12→  const match = document.cookie.match(new RegExp(`(?:^|; )${name.replace(/[-.]/g, '\\$&')}=([^;]*)`))
    13→  return match ? decodeURIComponent(match[1]) : ''
    14→}
    15→
    16→// CSRF headers
    17→function csrfHeaders(): Record<string, string> {
    18→  const csrf = getCookie('fortune_csrf')
    19→  return csrf ? { 'X-CSRF-Token': csrf } : {}
    20→}
    21→
    22→// Generic API response type
    23→interface ApiResponse<T> {
    24→  ok: boolean
    25→  data?: T
    26→  error?: {
    27→    code: string
    28→    message: string
    29→    detail?: Record<string, unknown>
    30→  }
    31→}
    32→
    33→// Fetch with auth
    34→async function fetchApi<T>(
    35→  url: string,
    36→  options: RequestInit = {}
    37→): Promise<T> {
    38→  const headers: Record<string, string> = {
    39→    'Content-Type': 'application/json',
    40→    ...csrfHeaders(),
    41→    ...(options.headers as Record<string, string> || {}),
    42→  }
    43→
    44→  const res = await fetch(`${API_BASE}${url}`, {
    45→    ...options,
    46→    headers,
    47→    credentials: 'include', // Send cookies
    48→  })
    49→
    50→  const json: ApiResponse<T> = await res.json().catch(() => ({ ok: false }))
    51→
    52→  if (!res.ok || !json.ok) {
    53→    if (res.status === 401 || res.status === 403) {
    54→      // Redirect to login (with basePath)
    55→      if (typeof window !== 'undefined') {
    56→        window.location.href = '/new/login'
    57→      }
    58→      throw new Error('Unauthorized')
    59→    }
    60→    throw new Error(json.error?.message || 'Request failed')
    61→  }
    62→
    63→  return json.data as T
    64→}
    65→
    66→// =============================================================================
    67→// Dashboard API Types
    68→// =============================================================================
    69→
    70→export interface StateScore {
    71→  score: number
    72→  breakdown: {
    73→    emotion: number
    74→    action: number
    75→    streak: number
    76→  }
    77→  recovery_action: string | null
    78→}
    79→
    80→export interface PermaScore {
    81→  score: number
    82→  trend?: 'up' | 'down' | 'stable'
    83→}
    84→
    85→export interface PermaData {
    86→  positive_emotion: PermaScore
    87→  engagement: PermaScore
    88→  relationships: PermaScore
    89→  meaning: PermaScore
    90→  accomplishment: PermaScore
    91→}
    92→
    93→export interface TaskItem {
    94→  task_id: string
    95→  title: string
    96→  status: 'suggested' | 'active' | 'done' | 'skipped'
    97→  commitment_type?: 'start_task' | 'schedule_task'
    98→  minutes?: number
    99→  if_then?: string
   100→}
   101→
   102→export interface RiskAlert {
   103→  type: string
   104→  message: string
   105→}
   106→
   107→export interface OverviewData {
   108→  insight: string
   109→  state_score: StateScore
   110→  perma: PermaData
   111→  today_tasks: TaskItem[]
   112→  risk_alerts: RiskAlert[]
   113→}
   114→
   115→export interface L0Translation {
   116→  concept: string
   117→  translation: string
   118→  action: string
   119→}
   120→
   121→export interface L0Facts {
   122→  day_master: string
   123→  strength: string
   124→  translations: L0Translation[]
   125→}
   126→
   127→export interface L1Schema {
   128→  perma_snapshot: PermaData
   129→  cognitive_patterns: {
   130→    identified_schemas: string[]
   131→    reframe_count?: number
   132→  }
   133→  strengths_in_use: string[]
   134→}
   135→
   136→export interface StatusData {
   137→  l0_facts: L0Facts
   138→  l1_schema: L1Schema
   139→  state_score: StateScore
   140→}
   141→
   142→export interface TrendPoint {
   143→  date: string
   144→  score: number
   145→}
   146→
   147→export interface TrendEvent {
   148→  date: string
   149→  type: string
   150→  title: string
   151→}
   152→
   153→export interface TrendsData {
   154→  state_score_history: TrendPoint[]
   155→  events: TrendEvent[]
   156→}
   157→
   158→export interface TasksData {
   159→  active: TaskItem[]
   160→  suggested: TaskItem[]
   161→  completed_recent: TaskItem[]
   162→}
   163→
   164→export interface RelationItem {
   165→  id: string
   166→  name: string
   167→  type: string
   168→  compatibility?: number
   169→}
   170→
   171→export interface RelationsData {
   172→  relations: RelationItem[]
   173→}
   174→
   175→export interface ExploreItem {
   176→  id: string
   177→  title: string
   178→  type: 'mystic' | 'course' | 'artifact'
   179→  description?: string
   180→}
   181→
   182→export interface ExploreData {
   183→  mystic_entries: ExploreItem[]
   184→  courses: ExploreItem[]
   185→  artifacts: ExploreItem[]
   186→}
   187→
   188→export interface CheckinResponse {
   189→  insight: string
   190→  action: {
   191→    content: string
   192→    minutes: number
   193→    if_then: string
   194→  }
   195→  state_score: StateScore
   196→}
   197→
   198→// =============================================================================
   199→// Dashboard API Functions
   200→// =============================================================================
   201→
   202→export async function fetchOverview(): Promise<OverviewData> {
   203→  return fetchApi<OverviewData>('/api/dashboard/overview')
   204→}
   205→
   206→export async function fetchStatus(): Promise<StatusData> {
   207→  return fetchApi<StatusData>('/api/dashboard/status')
   208→}
   209→
   210→export async function fetchTrends(days: number = 7): Promise<TrendsData> {
   211→  return fetchApi<TrendsData>(`/api/dashboard/trends?days=${days}`)
   212→}
   213→
   214→export async function fetchTasks(): Promise<TasksData> {
   215→  return fetchApi<TasksData>('/api/dashboard/tasks')
   216→}
   217→
   218→export async function fetchRelations(): Promise<RelationsData> {
   219→  return fetchApi<RelationsData>('/api/dashboard/relations')
   220→}
   221→
   222→export async function fetchExplore(): Promise<ExploreData> {
   223→  return fetchApi<ExploreData>('/api/dashboard/explore')
   224→}
   225→
   226→// Task Actions
   227→export async function acceptTask(
   228→  taskId: string,
   229→  commitmentType: 'start_task' | 'schedule_task' = 'start_task'
   230→): Promise<{ commitment_id: string; status: string }> {
   231→  return fetchApi('/api/dashboard/task/accept', {
   232→    method: 'POST',
   233→    body: JSON.stringify({ task_id: taskId, commitment_type: commitmentType }),
   234→  })
   235→}
   236→
   237→export async function completeTask(
   238→  taskId: string,
   239→  note: string = ''
   240→): Promise<{ status: string; state_score: StateScore }> {
   241→  return fetchApi('/api/dashboard/task/done', {
   242→    method: 'POST',
   243→    body: JSON.stringify({ task_id: taskId, note }),
   244→  })
   245→}
   246→
   247→export async function skipTask(
   248→  taskId: string,
   249→  reason: string = ''
   250→): Promise<{ status: string }> {
   251→  return fetchApi('/api/dashboard/task/skip', {
   252→    method: 'POST',
   253→    body: JSON.stringify({ task_id: taskId, reason }),
   254→  })
   255→}
   256→
   257→// Checkin
   258→export async function submitCheckin(
   259→  mood: string,
   260→  intensity: number,
   261→  note: string = ''
   262→): Promise<CheckinResponse> {
   263→  return fetchApi('/api/dashboard/checkin', {
   264→    method: 'POST',
   265→    body: JSON.stringify({ mood, intensity, note }),
   266→  })
   267→}
   268→
   269→// =============================================================================
   270→// Chat API
   271→// =============================================================================
   272→
   273→// Feature flag for new Agent Runtime (Next.js)
   274→const USE_NEW_RUNTIME = process.env.NEXT_PUBLIC_USE_NEW_RUNTIME === 'true'
   275→
   276→export interface ChatMessage {
   277→  role: 'user' | 'assistant'
   278→  content: string
   279→  timestamp?: string
   280→  toolInvocations?: ToolInvocation[]
   281→}
   282→
   283→export interface ToolInvocation {
   284→  toolCallId: string
   285→  toolName: string
   286→  args: Record<string, unknown>
   287→  result?: unknown
   288→}
   289→
   290→export interface SendChatRequest {
   291→  message: string
   292→  session_id?: string
   293→  command?: string
   294→}
   295→
   296→export interface SendChatResponse {
   297→  session_id: string
   298→  reply: string
   299→  ui_components?: unknown[]
   300→  toolInvocations?: ToolInvocation[]

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
