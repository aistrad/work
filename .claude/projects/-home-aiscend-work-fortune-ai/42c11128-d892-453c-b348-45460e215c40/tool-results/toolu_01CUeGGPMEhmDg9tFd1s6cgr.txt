     1→/**
     2→ * Divine Skills (玄学技能)
     3→ *
     4→ * Tools for metaphysics calculations: Bazi, Tieban, Yunshi, etc.
     5→ * These tools call FastAPI backend for actual computation.
     6→ */
     7→import { tool } from 'ai';
     8→import { z } from 'zod';
     9→
    10→const FASTAPI_URL = process.env.FASTAPI_URL || 'http://localhost:8230';
    11→
    12→// Bazi calculation tool
    13→export const calculateBazi = tool({
    14→  description: '计算用户的八字命盘（四柱八字）。当用户询问八字、命理、生辰相关问题时使用。',
    15→  parameters: z.object({
    16→    birth_datetime: z.string().describe('出生日期时间，格式：YYYY-MM-DD HH:MM'),
    17→    location_name: z.string().optional().describe('出生地点名称'),
    18→    longitude: z.number().optional().describe('出生地经度'),
    19→    latitude: z.number().optional().describe('出生地纬度'),
    20→  }),
    21→  execute: async ({ birth_datetime, location_name, longitude, latitude }, { abortSignal }) => {
    22→    // Parse datetime
    23→    const [date, time] = birth_datetime.split(' ');
    24→    if (!date || !time) {
    25→      return {
    26→        type: 'a2ui_card' as const,
    27→        card_type: 'error',
    28→        data: { message: '日期时间格式错误，请使用 YYYY-MM-DD HH:MM 格式' },
    29→      };
    30→    }
    31→
    32→    const [year, month, day] = date.split('-').map(Number);
    33→    const [hour, minute] = time.split(':').map(Number);
    34→
    35→    try {
    36→      const res = await fetch(`${FASTAPI_URL}/api/bazi/calculate`, {
    37→        method: 'POST',
    38→        headers: { 'Content-Type': 'application/json' },
    39→        body: JSON.stringify({
    40→          year,
    41→          month,
    42→          day,
    43→          hour,
    44→          minute,
    45→          location_name,
    46→          longitude,
    47→          latitude,
    48→        }),
    49→        signal: abortSignal,
    50→      });
    51→
    52→      if (!res.ok) {
    53→        throw new Error(`Bazi calculation failed: ${res.status}`);
    54→      }
    55→
    56→      const result = await res.json();
    57→
    58→      return {
    59→        type: 'a2ui_card' as const,
    60→        card_type: 'bazi_pan',
    61→        data: {
    62→          birth_datetime,
    63→          solar_date: `${year}年${month}月${day}日`,
    64→          lunar_date: result.lunar_date || '',
    65→          four_pillars: {
    66→            year: { gan: result.year_gan, zhi: result.year_zhi },
    67→            month: { gan: result.month_gan, zhi: result.month_zhi },
    68→            day: { gan: result.day_gan, zhi: result.day_zhi },
    69→            hour: { gan: result.hour_gan, zhi: result.hour_zhi },
    70→          },
    71→          wu_xing_summary: result.wuxing_counts || {},
    72→          day_master: result.day_master || result.day_gan,
    73→          day_master_strength: result.day_master_strength || 'balanced',
    74→        },
    75→      };
    76→    } catch (error) {
    77→      return {
    78→        type: 'a2ui_card' as const,
    79→        card_type: 'error',
    80→        data: { message: `八字计算失败: ${error instanceof Error ? error.message : '未知错误'}` },
    81→      };
    82→    }
    83→  },
    84→});
    85→
    86→// Yunshi (daily fortune) tool
    87→export const getYunshi = tool({
    88→  description: '获取用户的每日运势。当用户询问今日运势、今天运气、当日运程时使用。',
    89→  parameters: z.object({
    90→    date: z.string().optional().describe('查询日期，格式：YYYY-MM-DD，默认今天'),
    91→  }),
    92→  execute: async ({ date }, { abortSignal }) => {
    93→    const targetDate = date || new Date().toISOString().split('T')[0];
    94→
    95→    try {
    96→      const res = await fetch(`${FASTAPI_URL}/api/yunshi/daily?date=${targetDate}`, {
    97→        signal: abortSignal,
    98→      });
    99→
   100→      if (!res.ok) {
   101→        throw new Error(`Yunshi fetch failed: ${res.status}`);
   102→      }
   103→
   104→      const result = await res.json();
   105→
   106→      return {
   107→        type: 'a2ui_card' as const,
   108→        card_type: 'yunshi_daily',
   109→        data: {
   110→          date: targetDate,
   111→          overall_score: result.overall_score || 70,
   112→          aspects: result.aspects || {
   113→            career: 70,
   114→            wealth: 70,
   115→            love: 70,
   116→            health: 70,
   117→          },
   118→          lucky_elements: result.lucky_elements || {
   119→            color: '蓝色',
   120→            number: 6,
   121→            direction: '东方',
   122→          },
   123→          advice: result.advice || '今日宜静心，勿躁。',
   124→        },
   125→      };
   126→    } catch (error) {
   127→      return {
   128→        type: 'a2ui_card' as const,
   129→        card_type: 'error',
   130→        data: { message: `运势获取失败: ${error instanceof Error ? error.message : '未知错误'}` },
   131→      };
   132→    }
   133→  },
   134→});
   135→
   136→// Tieban (Iron Plate) divination tool
   137→export const initTieban = tool({
   138→  description: '启动铁板神数推演。当用户想要进行精确的命理推算或验证生辰时使用。',
   139→  parameters: z.object({
   140→    birth_datetime: z.string().describe('出生日期时间，格式：YYYY-MM-DD HH:MM'),
   141→    gender: z.enum(['male', 'female']).describe('性别'),
   142→    name: z.string().describe('用户姓名'),
   143→  }),
   144→  execute: async ({ birth_datetime, gender, name }, { abortSignal }) => {
   145→    const [date, time] = birth_datetime.split(' ');
   146→    if (!date || !time) {
   147→      return {
   148→        type: 'a2ui_card' as const,
   149→        card_type: 'error',
   150→        data: { message: '日期时间格式错误' },
   151→      };
   152→    }
   153→
   154→    try {
   155→      const res = await fetch(`${FASTAPI_URL}/api/tieban/init`, {
   156→        method: 'POST',
   157→        headers: { 'Content-Type': 'application/json' },
   158→        body: JSON.stringify({
   159→          name,
   160→          gender,
   161→          date,
   162→          time,
   163→        }),
   164→        signal: abortSignal,
   165→      });
   166→
   167→      if (!res.ok) {
   168→        throw new Error(`Tieban init failed: ${res.status}`);
   169→      }
   170→
   171→      const result = await res.json();
   172→
   173→      return {
   174→        type: 'a2ui_card' as const,
   175→        card_type: 'tieban_init',
   176→        data: {
   177→          run_id: result.run_id,
   178→          status: result.status,
   179→          questions: result.questions || [],
   180→          message: '铁板神数推演已启动，请回答验证问题以确认生辰。',
   181→        },
   182→        actions: [
   183→          {
   184→            label: '开始验证',
   185→            action: 'navigate',
   186→            params: { path: `/tieban/${result.run_id}` },
   187→          },
   188→        ],
   189→      };
   190→    } catch (error) {
   191→      return {
   192→        type: 'a2ui_card' as const,
   193→        card_type: 'error',
   194→        data: { message: `铁板推演启动失败: ${error instanceof Error ? error.message : '未知错误'}` },
   195→      };
   196→    }
   197→  },
   198→});
   199→
   200→// Export all divine skills
   201→export const divineSkills = {
   202→  calculate_bazi: calculateBazi,
   203→  get_yunshi: getYunshi,
   204→  init_tieban: initTieban,
   205→};
   206→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
