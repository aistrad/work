     1→import { create } from "zustand"
     2→import type { Message, Artifact, Quest, DashboardTab, Relation, Block, ActionButton } from "@/types"
     3→import * as api from "@/lib/api"
     4→
     5→// Map API types to frontend types
     6→interface UserStatus {
     7→  energy: number
     8→  emotion: number
     9→  connection: number
    10→  growth: number
    11→  fortune: number
    12→}
    13→
    14→interface StateScore {
    15→  score: number
    16→  breakdown: {
    17→    emotion: number
    18→    action: number
    19→    streak: number
    20→  }
    21→  recoveryAction: string | null
    22→}
    23→
    24→interface PermaData {
    25→  positiveEmotion: { score: number; trend?: string }
    26→  engagement: { score: number; trend?: string }
    27→  relationships: { score: number; trend?: string }
    28→  meaning: { score: number; trend?: string }
    29→  accomplishment: { score: number; trend?: string }
    30→}
    31→
    32→interface L0Facts {
    33→  dayMaster: string
    34→  strength: string
    35→  translations: { concept: string; translation: string; action: string }[]
    36→}
    37→
    38→interface L1Schema {
    39→  permaSnapshot: PermaData
    40→  cognitivePatterns: { identifiedSchemas: string[]; reframeCount?: number }
    41→  strengthsInUse: string[]
    42→}
    43→
    44→interface RiskAlert {
    45→  type: string
    46→  message: string
    47→}
    48→
    49→interface TrendPoint {
    50→  date: string
    51→  score: number
    52→}
    53→
    54→interface TrendEvent {
    55→  date: string
    56→  type: string
    57→  title: string
    58→}
    59→
    60→interface AppState {
    61→  // UI State
    62→  isSidebarOpen: boolean
    63→  activeTab: DashboardTab
    64→  isMobile: boolean
    65→
    66→  // Preferences
    67→  chatBackend: api.ChatBackend
    68→
    69→  // Loading States
    70→  isLoading: boolean
    71→  loadingTab: DashboardTab | null
    72→
    73→  // Chat State
    74→  messages: Message[]
    75→  isStreaming: boolean
    76→  sessionId: string | null
    77→
    78→  // Artifacts
    79→  artifacts: Artifact[]
    80→  pinnedArtifacts: Artifact[]
    81→
    82→  // Overview Data
    83→  insight: string
    84→  stateScore: StateScore
    85→  perma: PermaData
    86→  todayTasks: api.TaskItem[]
    87→  riskAlerts: RiskAlert[]
    88→
    89→  // Status Data
    90→  l0Facts: L0Facts | null
    91→  l1Schema: L1Schema | null
    92→
    93→  // Trends Data
    94→  trendHistory: TrendPoint[]
    95→  trendEvents: TrendEvent[]
    96→
    97→  // Tasks Data
    98→  activeTasks: api.TaskItem[]
    99→  suggestedTasks: api.TaskItem[]
   100→  completedTasks: api.TaskItem[]
   101→
   102→  // Relations Data
   103→  relations: Relation[]
   104→
   105→  // Explore Data
   106→  mysticEntries: api.ExploreItem[]
   107→  courses: api.ExploreItem[]
   108→
   109→  // Legacy (for compatibility)
   110→  status: UserStatus
   111→  quests: Quest[]
   112→  todayQuests: Quest[]
   113→
   114→  // UI Actions
   115→  setSidebarOpen: (open: boolean) => void
   116→  setActiveTab: (tab: DashboardTab) => void
   117→  setIsMobile: (mobile: boolean) => void
   118→  setChatBackend: (backend: api.ChatBackend) => void
   119→
   120→  // Fetch Actions
   121→  fetchOverview: () => Promise<void>
   122→  fetchStatus: () => Promise<void>
   123→  fetchTrends: (days?: number) => Promise<void>
   124→  fetchTasks: () => Promise<void>
   125→  fetchRelations: () => Promise<void>
   126→  fetchExplore: () => Promise<void>
   127→  fetchPreferences: () => Promise<void>
   128→  updateChatBackend: (backend: api.ChatBackend) => Promise<void>
   129→
   130→  // Task Actions
   131→  acceptTask: (taskId: string, type?: 'start_task' | 'schedule_task') => Promise<void>
   132→  completeTask: (taskId: string, note?: string) => Promise<void>
   133→  skipTask: (taskId: string, reason?: string) => Promise<void>
   134→
   135→  // Checkin
   136→  submitCheckin: (mood: string, intensity: number, note?: string) => Promise<api.CheckinResponse>
   137→
   138→  // Chat Actions
   139→  sendMessage: (content: string) => Promise<void>
   140→  addMessage: (message: Message) => void
   141→  setStreaming: (streaming: boolean) => void
   142→  clearMessages: () => void
   143→
   144→  // Artifact Actions
   145→  addArtifact: (artifact: Artifact) => void
   146→  pinArtifact: (id: string) => void
   147→  unpinArtifact: (id: string) => void
   148→}
   149→
   150→// Helper to convert API perma to frontend format
   151→function convertPerma(perma: api.PermaData): PermaData {
   152→  return {
   153→    positiveEmotion: { score: perma.positive_emotion.score, trend: perma.positive_emotion.trend },
   154→    engagement: { score: perma.engagement.score, trend: perma.engagement.trend },
   155→    relationships: { score: perma.relationships.score, trend: perma.relationships.trend },
   156→    meaning: { score: perma.meaning.score, trend: perma.meaning.trend },
   157→    accomplishment: { score: perma.accomplishment.score, trend: perma.accomplishment.trend },
   158→  }
   159→}
   160→
   161→// Helper to convert PERMA to 5-dimension status
   162→function permaToStatus(perma: PermaData): UserStatus {
   163→  return {
   164→    energy: Math.round(perma.positiveEmotion.score * 10),
   165→    emotion: Math.round(perma.engagement.score * 10),
   166→    connection: Math.round(perma.relationships.score * 10),
   167→    growth: Math.round(perma.meaning.score * 10),
   168→    fortune: Math.round(perma.accomplishment.score * 10),
   169→  }
   170→}
   171→
   172→type A2UIComponent = {
   173→  type?: unknown
   174→  title?: unknown
   175→  data?: unknown
   176→}
   177→
   178→function a2uiToBlocks(uiComponents: unknown[] | undefined): Block[] | undefined {
   179→  if (!Array.isArray(uiComponents) || uiComponents.length === 0) return undefined
   180→
   181→  const now = Date.now()
   182→  const blocks: Block[] = []
   183→
   184→  uiComponents.forEach((raw, idx) => {
   185→    if (!raw || typeof raw !== 'object') return
   186→    const c = raw as A2UIComponent
   187→    const type = String(c.type || '')
   188→    const title = typeof c.title === 'string' ? c.title : undefined
   189→    const id = `${type || 'component'}-${now}-${idx}`
   190→
   191→    if (type === 'markdown_text') {
   192→      blocks.push({
   193→        id,
   194→        type: 'markdown_text',
   195→        content: typeof c.data === 'string' ? c.data : String(c.data ?? ''),
   196→        ...(title ? { title } : {}),
   197→      } as unknown as Block)
   198→      return
   199→    }
   200→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
