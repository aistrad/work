     1→import os
     2→import json
     3→from typing import List, Dict, Optional
     4→
     5→BASE_DIR = os.path.join("user", "prompts")
     6→
     7→
     8→def _safe_key(s: str) -> str:
     9→    # 简易安全键：过滤特殊字符
    10→    return "".join(ch for ch in s if ch.isalnum() or ch in ("-","_","@",".")).strip() or "anon"
    11→
    12→
    13→def _file_for_openid(openid: str) -> str:
    14→    key = _safe_key(openid)
    15→    d = os.path.join(BASE_DIR, f"openid_{key}")
    16→    os.makedirs(d, exist_ok=True)
    17→    return os.path.join(d, "prompts.json")
    18→
    19→
    20→def get_history_for_openid(openid: str, limit: int = 20) -> List[Dict]:
    21→    path = _file_for_openid(openid)
    22→    if not os.path.isfile(path):
    23→        return []
    24→    try:
    25→        with open(path, "r", encoding="utf-8") as f:
    26→            arr = json.load(f)
    27→            if not isinstance(arr, list):
    28→                return []
    29→            return arr[: max(1, min(limit, 100))]
    30→    except Exception:
    31→        return []
    32→
    33→
    34→def append_for_openid(openid: str, text: str, model: str) -> None:
    35→    text = (text or "").strip()
    36→    if not text:
    37→        return
    38→    path = _file_for_openid(openid)
    39→    try:
    40→        with open(path, "r", encoding="utf-8") as f:
    41→            arr = json.load(f)
    42→            if not isinstance(arr, list):
    43→                arr = []
    44→    except Exception:
    45→        arr = []
    46→
    47→    # 去重：相同文本靠前只保留一条
    48→    norm = text
    49→    arr = [it for it in arr if (it.get("text") or "") != norm]
    50→    from datetime import datetime
    51→
    52→    entry = {"text": text, "model": model, "created_at": datetime.utcnow().isoformat()}
    53→    arr.insert(0, entry)
    54→    # 限制长度
    55→    if len(arr) > 50:
    56→        arr = arr[:50]
    57→    with open(path, "w", encoding="utf-8") as f:
    58→        json.dump(arr, f, ensure_ascii=False, indent=2)
    59→
    60→
    61→def get_presets() -> list:
    62→    """返回内置的 system prompt 模板列表。
    63→    每项包含：label, text, model（建议模型，可为空）。
    64→    """
    65→    presets = [
    66→        {
    67→            "label": "标准·原典限定（严格只依三书）",
    68→            "model": "standard",
    69→            "text": (
    70→                "你是中国传统命理大师。仅可依据原典：《滴天髓》《三命通会》《穷通宝鉴》。"
    71→                "不得引用或臆造其他来源。若原典无明确定论，请据理推演并说明不确定性。"
    72→            ),
    73→        },
    74→        {
    75→            "label": "深研·结构化输出（仅依三书）",
    76→            "model": "deep_research",
    77→            "text": (
    78→                "你是中国传统命理研究专家。仅可依据《滴天髓》《三命通会》《穷通宝鉴》进行论证，"
    79→                "请先给出3-5条关键洞见，再分主题展开，并在末尾列出不确定性来源与可验证证据。"
    80→            ),
    81→        },
    82→        {
    83→            "label": "简洁·总论与建议（仅依三书）",
    84→            "model": "standard",
    85→            "text": (
    86→                "仅依《滴天髓》《三命通会》《穷通宝鉴》，先给3-5句总论，"
    87→                "再给事业/财运/健康三类可执行建议，避免迷信化承诺，并标注不确定性。"
    88→            ),
    89→        },
    90→    ]
    91→    return presets
    92→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
