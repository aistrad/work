     1→from __future__ import annotations
     2→
     3→from typing import Any, Dict, Optional
     4→
     5→from fastapi import HTTPException, Request
     6→
     7→from services import auth_service
     8→from services.security import sha256_hex
     9→
    10→
    11→def get_client_ip(request: Request) -> str:
    12→    try:
    13→        return request.client.host if request.client else ""
    14→    except Exception:
    15→        return ""
    16→
    17→
    18→def get_user_agent(request: Request) -> str:
    19→    return (request.headers.get("user-agent") or "")[:500]
    20→
    21→
    22→def get_current_auth(request: Request) -> Optional[Dict[str, Any]]:
    23→    session_token = request.cookies.get("fortune_session") or ""
    24→    return auth_service.get_user_by_session_token(session_token)
    25→
    26→
    27→def require_auth(request: Request) -> Dict[str, Any]:
    28→    auth = get_current_auth(request)
    29→    if not auth:
    30→        raise HTTPException(status_code=401, detail="unauthorized")
    31→    return auth
    32→
    33→
    34→def require_csrf(request: Request, auth: Dict[str, Any]) -> None:
    35→    token = (request.headers.get("X-CSRF-Token") or "").strip()
    36→    if not token:
    37→        raise HTTPException(status_code=403, detail="missing_csrf")
    38→    got = sha256_hex(token)
    39→    expected = str(auth.get("csrf_token_hash") or "")
    40→    if not expected or got != expected:
    41→        raise HTTPException(status_code=403, detail="invalid_csrf")
    42→
    43→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
