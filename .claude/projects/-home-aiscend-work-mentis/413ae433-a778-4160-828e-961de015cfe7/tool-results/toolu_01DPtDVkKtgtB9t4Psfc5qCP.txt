  1000→    description: 计算当前大运流年
  1001→    function: bazi.transit.calculate
  1002→    inputs:
  1003→      - name: chart
  1004→        type: BaziChart
  1005→      - name: target_date
  1006→        type: date
  1007→    outputs:
  1008→      - name: dayun
  1009→        type: DaYun
  1010→      - name: liunian
  1011→        type: LiuNian
  1012→        
  1013→  - id: analyze_pattern
  1014→    name: 格局分析
  1015→    description: 分析八字格局
  1016→    function: bazi.pattern.analyze
  1017→    inputs:
  1018→      - name: chart
  1019→        type: BaziChart
  1020→    outputs:
  1021→      - name: pattern
  1022→        type: Pattern
  1023→      - name: strength
  1024→        type: float
  1025→
  1026→# 洞察生成规则
  1027→insight_rules:
  1028→  - trigger: 
  1029→      pattern: "偏印运 + 木旺"
  1030→    insight:
  1031→      type: pattern_discovery
  1032→      template: |
  1033→        你现在走到偏印运了，这个阶段容易想太多、行动力下降。
  1034→        结合你八字木旺的特点，这种感觉会更明显。
  1035→        不是运气不好，是需要"慢下来"的信号。
  1036→
  1037→  - trigger:
  1038→      event: "decision_hesitation_detected"
  1039→    insight:
  1040→      type: behavior_pattern
  1041→      template: |
  1042→        我注意到你在决策时经常犹豫。
  1043→        从命理角度看，{reason}。
  1044→        建议：{suggestion}。
  1045→
  1046→# 输出模板
  1047→output_templates:
  1048→  chart_display:
  1049→    type: card
  1050→    components:
  1051→      - BaziChartVisual
  1052→      - PatternSummary
  1053→      - TransitInfo
  1054→      
  1055→  insight_card:
  1056→    type: card
  1057→    components:
  1058→      - InsightTitle
  1059→      - InsightBody
  1060→      - ActionSuggestion
  1061→      - QuickActions
  1062→
  1063→# 商业化配置
  1064→monetization:
  1065→  free_tier:
  1066→    - initial_chart_reading
  1067→    - 3_questions_per_day
  1068→    
  1069→  premium_tier:
  1070→    price: 29/month
  1071→    features:
  1072→      - unlimited_questions
  1073→      - monthly_transit_report
  1074→      - deep_pattern_analysis
  1075→      - cross_skill_insights
  1076→```
  1077→
  1078→## 4.3 Agent 处理流程
  1079→
  1080→```
  1081→┌─────────────────────────────────────────────────────────────────────────────┐
  1082→│                                                                             │
  1083→│   SKILL AGENT PROCESSING PIPELINE                                           │
  1084→│                                                                             │
  1085→│   ═══════════════════════════════════════════════════════════════════════   │
  1086→│                                                                             │
  1087→│   USER INPUT: "最近总觉得做事差一点点，是不是运势问题？"                    │
  1088→│                                                                             │
  1089→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1090→│   │                                                                     │   │
  1091→│   │   STEP 1: CONTEXT ASSEMBLY                                          │   │
  1092→│   │   ─────────────────────────────────────────────────────────         │   │
  1093→│   │                                                                     │   │
  1094→│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
  1095→│   │   │   User      │  │  Skill      │  │  Conversation│                │   │
  1096→│   │   │   Profile   │  │  Profile    │  │  History     │                │   │
  1097→│   │   │             │  │             │  │              │                │   │
  1098→│   │   │ • birth_info│  │ • chart     │  │ • last 10   │                │   │
  1099→│   │   │ • vibe_id   │  │ • dayun     │  │   messages  │                │   │
  1100→│   │   │             │  │ • patterns  │  │ • insights  │                │   │
  1101→│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
  1102→│   │                                                                     │   │
  1103→│   │   Assembled Context:                                                │   │
  1104→│   │   {                                                                 │   │
  1105→│   │     user: { name: "Alex", birth: "1990-03-15 08:30" },             │   │
  1106→│   │     skill_data: { chart: {...}, current_dayun: "壬午" },           │   │
  1107→│   │     conversation: [ ... ],                                         │   │
  1108→│   │     previous_insights: [ ... ]                                     │   │
  1109→│   │   }                                                                 │   │
  1110→│   │                                                                     │   │
  1111→│   └─────────────────────────────────────────────────────────────────────┘   │
  1112→│                                     │                                       │
  1113→│                                     ▼                                       │
  1114→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1115→│   │                                                                     │   │
  1116→│   │   STEP 2: INTENT CLASSIFICATION                                     │   │
  1117→│   │   ─────────────────────────────────────────────────────────         │   │
  1118→│   │                                                                     │   │
  1119→│   │   Detected Intents:                                                 │   │
  1120→│   │   • PRIMARY: transit_inquiry (运势询问) - confidence: 0.85         │   │
  1121→│   │   • SECONDARY: emotional_support (情绪支持) - confidence: 0.6      │   │
  1122→│   │                                                                     │   │
  1123→│   │   Workflow Selected: question_answering                             │   │
  1124→│   │                                                                     │   │
  1125→│   └─────────────────────────────────────────────────────────────────────┘   │
  1126→│                                     │                                       │
  1127→│                                     ▼                                       │
  1128→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1129→│   │                                                                     │   │
  1130→│   │   STEP 3: KNOWLEDGE RETRIEVAL                                       │   │
  1131→│   │   ─────────────────────────────────────────────────────────         │   │
  1132→│   │                                                                     │   │
  1133→│   │   Query Generation:                                                 │   │
  1134→│   │   • "偏印运 特点 行动力"                                            │   │
  1135→│   │   • "甲木日主 偏印运"                                               │   │
  1136→│   │   • "运势不顺 命理解释"                                             │   │
  1137→│   │                                                                     │   │
  1138→│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
  1139→│   │   │   Vector    │  │   Keyword   │  │   Graph     │                │   │
  1140→│   │   │   Search    │  │   Search    │  │   Traversal │                │   │
  1141→│   │   │             │  │             │  │             │                │   │
  1142→│   │   │ cos_sim:    │  │ BM25:       │  │ 偏印 →     │                │   │
  1143→│   │   │ 0.82        │  │ 15.3        │  │   特点     │                │   │
  1144→│   │   │             │  │             │  │   影响     │                │   │
  1145→│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
  1146→│   │                                                                     │   │
  1147→│   │   Retrieved Knowledge (Top 5, Re-ranked):                           │   │
  1148→│   │   1. 偏印运特点：思考增多，行动减少... (relevance: 0.91)           │   │
  1149→│   │   2. 甲木日主遇偏印：木旺需收敛... (relevance: 0.87)               │   │
  1150→│   │   3. 运势低迷期的解读方式：强调调整... (relevance: 0.75)           │   │
  1151→│   │                                                                     │   │
  1152→│   └─────────────────────────────────────────────────────────────────────┘   │
  1153→│                                     │                                       │
  1154→│                                     ▼                                       │
  1155→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1156→│   │                                                                     │   │
  1157→│   │   STEP 4: TOOL INVOCATION                                           │   │
  1158→│   │   ─────────────────────────────────────────────────────────         │   │
  1159→│   │                                                                     │   │
  1160→│   │   Tool: calculate_transit                                           │   │
  1161→│   │   Input: { chart: user.skill_data.chart, target_date: "2026-01-05" }│   │
  1162→│   │                                                                     │   │
  1163→│   │   Output:                                                           │   │
  1164→│   │   {                                                                 │   │
  1165→│   │     dayun: "壬午",                                                  │   │
  1166→│   │     liunian: "丙午",                                                │   │
  1167→│   │     current_energy: { fire: 2.5, water: 1.2 },                      │   │
  1168→│   │     interpretation: "火旺水弱，躁动难静"                            │   │
  1169→│   │   }                                                                 │   │
  1170→│   │                                                                     │   │
  1171→│   └─────────────────────────────────────────────────────────────────────┘   │
  1172→│                                     │                                       │
  1173→│                                     ▼                                       │
  1174→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1175→│   │                                                                     │   │
  1176→│   │   STEP 5: INSIGHT GENERATION                                        │   │
  1177→│   │   ─────────────────────────────────────────────────────────         │   │
  1178→│   │                                                                     │   │
  1179→│   │   Pattern Matching:                                                 │   │
  1180→│   │   • Rule: "偏印运 + 木旺" ✓ MATCHED                                 │   │
  1181→│   │                                                                     │   │
  1182→│   │   Generated Insight:                                                │   │
  1183→│   │   {                                                                 │   │
  1184→│   │     type: "pattern_discovery",                                      │   │
  1185→│   │     title: "偏印运的影响",                                          │   │
  1186→│   │     body: "你现在走到偏印运了，这个阶段...",                        │   │
  1187→│   │     confidence: 0.88,                                               │   │
  1188→│   │     evidence: ["当前大运: 壬午", "日主: 甲木", "偏印透出"]          │   │
  1189→│   │   }                                                                 │   │
  1190→│   │                                                                     │   │
  1191→│   └─────────────────────────────────────────────────────────────────────┘   │
  1192→│                                     │                                       │
  1193→│                                     ▼                                       │
  1194→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1195→│   │                                                                     │   │
  1196→│   │   STEP 6: RESPONSE COMPOSITION                                      │   │
  1197→│   │   ─────────────────────────────────────────────────────────         │   │
  1198→│   │                                                                     │   │
  1199→│   │   Persona Application:                                              │   │
  1200→│   │   • Tone: 沉稳智慧                                                  │   │
  1201→│   │   • Approach: 不预测事件，强调选择                                  │   │
  1202→│   │   • Style: 现代语言，温和但有分量                                   │   │
  1203→│   │                                                                     │   │
  1204→│   │   Response Structure:                                               │   │
  1205→│   │   1. Acknowledge feeling (共情)                                     │   │
  1206→│   │   2. Insight Card (洞察展示)                                        │   │
  1207→│   │   3. Context explanation (解释)                                     │   │
  1208→│   │   4. Follow-up question (延续对话)                                  │   │
  1209→│   │                                                                     │   │
  1210→│   │   Final Output:                                                     │   │
  1211→│   │   ────────────────────────────────────────────────────              │   │
  1212→│   │                                                                     │   │
  1213→│   │   "这个感觉很有意思。让我看看。                                     │   │
  1214→│   │                                                                     │   │
  1215→│   │   [INSIGHT CARD: 偏印运的影响]                                      │   │
  1216→│   │                                                                     │   │
  1217→│   │   而且你的八字本身木旺，遇到偏印运会放大"想"的特点。               │   │
  1218→│   │                                                                     │   │
  1219→│   │   最近有什么事让你特别着急想搞定的吗？"                             │   │
  1220→│   │                                                                     │   │
  1221→│   └─────────────────────────────────────────────────────────────────────┘   │
  1222→│                                                                             │
  1223→│   POST-PROCESSING                                                           │
  1224→│   ─────────────────────────────────────────────────────────────────────     │
  1225→│   • Update conversation history                                             │
  1226→│   • Store generated insight                                                 │
  1227→│   • Update user pattern tracking                                            │
  1228→│   • Trigger cross-skill sync (if authorized)                                │
  1229→│                                                                             │
  1230→└─────────────────────────────────────────────────────────────────────────────┘
  1231→```
  1232→
  1233→---
  1234→
  1235→# 第五部分：知识引擎系统
  1236→
  1237→## 5.1 知识库架构
  1238→
  1239→```
  1240→╔═══════════════════════════════════════════════════════════════════════════════╗
  1241→║                                                                               ║
  1242→║   KNOWLEDGE ENGINE ARCHITECTURE                                               ║
  1243→║   从原始知识到智能检索的完整管道                                              ║
  1244→║                                                                               ║
  1245→║   ─────────────────────────────────────────────────────────────────────────   ║
  1246→║                                                                               ║
  1247→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
  1248→║   │                                                                         │ ║
  1249→║   │   KNOWLEDGE SOURCES (原始知识来源)                                      │ ║
  1250→║   │                                                                         │ ║
  1251→║   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │ ║
  1252→║   │   │  Books    │  │  Expert   │  │  Academic │  │  Case     │          │ ║
  1253→║   │   │  古籍/书籍 │  │  Interviews│  │  Papers  │  │  Studies  │          │ ║
  1254→║   │   │           │  │  专家访谈  │  │  论文    │  │  案例库   │          │ ║
  1255→║   │   └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘          │ ║
  1256→║   │         │              │              │              │                 │ ║
  1257→║   │         └──────────────┴──────────────┴──────────────┘                 │ ║
  1258→║   │                                │                                        │ ║
  1259→║   └────────────────────────────────┼────────────────────────────────────────┘ ║
  1260→║                                    ▼                                          ║
  1261→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
  1262→║   │                                                                         │ ║
  1263→║   │   KNOWLEDGE PIPELINE (知识处理管道)                                     │ ║
  1264→║   │                                                                         │ ║
  1265→║   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │ ║
  1266→║   │   │  Extract  │  │ Structure │  │  Enrich   │  │   Index   │          │ ║
  1267→║   │   │  提取     │─▶│  结构化   │─▶│  增强    │─▶│  索引    │          │ ║
  1268→║   │   │           │  │           │  │           │  │           │          │ ║
  1269→║   │   │ • OCR     │  │ • Chunking│  │ • QA生成  │  │ • Vector  │          │ ║
  1270→║   │   │ • Parse   │  │ • Entity  │  │ • 关系抽取│  │ • Keyword │          │ ║
  1271→║   │   │ • Clean   │  │ • Taxonomy│  │ • 验证    │  │ • Graph   │          │ ║
  1272→║   │   └───────────┘  └───────────┘  └───────────┘  └───────────┘          │ ║
  1273→║   │                                                                         │ ║
  1274→║   └────────────────────────────────┬────────────────────────────────────────┘ ║
  1275→║                                    ▼                                          ║
  1276→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
  1277→║   │                                                                         │ ║
  1278→║   │   KNOWLEDGE STORES (知识存储)                                           │ ║
  1279→║   │                                                                         │ ║
  1280→║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
  1281→║   │   │                                                                 │   │ ║
  1282→║   │   │   VECTOR STORE (Pinecone)                                       │   │ ║
  1283→║   │   │   语义向量索引                                                  │   │ ║
  1284→║   │   │                                                                 │   │ ║
  1285→║   │   │   Namespaces:                                                   │   │ ║
  1286→║   │   │   • bazi-theory    (八字理论)                                   │   │ ║
  1287→║   │   │   • bazi-patterns  (格局模式)                                   │   │ ║
  1288→║   │   │   • bazi-transit   (运势解读)                                   │   │ ║
  1289→║   │   │   • bazi-cases     (案例库)                                     │   │ ║
  1290→║   │   │                                                                 │   │ ║
  1291→║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
  1292→║   │                                                                         │ ║
  1293→║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
  1294→║   │   │                                                                 │   │ ║
  1295→║   │   │   GRAPH STORE (Neo4j)                                           │   │ ║
  1296→║   │   │   知识图谱                                                      │   │ ║
  1297→║   │   │                                                                 │   │ ║
  1298→║   │   │   Nodes:                                                        │   │ ║
  1299→║   │   │   • Concept (概念: 偏印, 正官, 木...)                           │   │ ║
  1300→║   │   │   • Pattern (格局: 偏印格, 从强格...)                           │   │ ║
  1301→║   │   │   • Effect (效应: 思考多, 行动少...)                            │   │ ║
  1302→║   │   │                                                                 │   │ ║
  1303→║   │   │   Relationships:                                                │   │ ║
  1304→║   │   │   • CAUSES (导致)                                               │   │ ║
  1305→║   │   │   • ENHANCES (增强)                                             │   │ ║
  1306→║   │   │   • CONFLICTS_WITH (冲突)                                       │   │ ║
  1307→║   │   │   • SUGGESTS (建议)                                             │   │ ║
  1308→║   │   │                                                                 │   │ ║
  1309→║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
  1310→║   │                                                                         │ ║
  1311→║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
  1312→║   │   │                                                                 │   │ ║
  1313→║   │   │   DOCUMENT STORE (PostgreSQL + S3)                              │   │ ║
  1314→║   │   │   结构化文档存储                                                │   │ ║
  1315→║   │   │                                                                 │   │ ║
  1316→║   │   │   Tables:                                                       │   │ ║
  1317→║   │   │   • knowledge_chunks (知识块)                                   │   │ ║
  1318→║   │   │   • knowledge_metadata (元数据)                                 │   │ ║
  1319→║   │   │   • knowledge_sources (来源)                                    │   │ ║
  1320→║   │   │   • qa_pairs (问答对)                                           │   │ ║
  1321→║   │   │                                                                 │   │ ║
  1322→║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
  1323→║   │                                                                         │ ║
  1324→║   └─────────────────────────────────────────────────────────────────────────┘ ║
  1325→║                                                                               ║
  1326→╚═══════════════════════════════════════════════════════════════════════════════╝
  1327→```
  1328→
  1329→## 5.2 知识结构化流程
  1330→
  1331→```
  1332→┌─────────────────────────────────────────────────────────────────────────────┐
  1333→│                                                                             │
  1334→│   KNOWLEDGE STRUCTURING PIPELINE                                            │
  1335→│   以八字知识为例的完整处理流程                                              │
  1336→│                                                                             │
  1337→│   ═══════════════════════════════════════════════════════════════════════   │
  1338→│                                                                             │
  1339→│   STEP 1: RAW KNOWLEDGE EXTRACTION                                          │
  1340→│   ─────────────────────────────────────────────────────────────────────     │
  1341→│                                                                             │
  1342→│   Source: 《子平真诠》第三章 - 论十神                                       │
  1343→│                                                                             │
  1344→│   Raw Text:                                                                 │
  1345→│   "偏印者，生我之异类也。如阳木生阳火，阴木生阴火...                       │
  1346→│    偏印之性，聪明多疑，精明刻薄..."                                        │
  1347→│                                                                             │
  1348→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1349→│   │  EXTRACTOR                                                          │   │
  1350→│   │                                                                     │   │
  1351→│   │  {                                                                  │   │
  1352→│   │    source: "子平真诠",                                              │   │
  1353→│   │    chapter: "论十神",                                               │   │
  1354→│   │    topic: "偏印",                                                   │   │
  1355→│   │    raw_content: "...",                                              │   │
  1356→│   │    language: "classical_chinese"                                    │   │
  1357→│   │  }                                                                  │   │
  1358→│   └─────────────────────────────────────────────────────────────────────┘   │
  1359→│                                                                             │
  1360→│   ─────────────────────────────────────────────────────────────────────     │
  1361→│                                                                             │
  1362→│   STEP 2: SEMANTIC CHUNKING                                                 │
  1363→│   ─────────────────────────────────────────────────────────────────────     │
  1364→│                                                                             │
  1365→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1366→│   │  CHUNKER (LLM-assisted)                                             │   │
  1367→│   │                                                                     │   │
  1368→│   │  Chunks Generated:                                                  │   │
  1369→│   │                                                                     │   │
  1370→│   │  Chunk 1: {                                                         │   │
  1371→│   │    id: "bazi-theory-shenshen-01",                                   │   │
  1372→│   │    topic: "偏印定义",                                               │   │
  1373→│   │    content: "偏印者，生我之异类也...",                              │   │
  1374→│   │    modern_interpretation: "偏印是指与日主阴阳相同、生助日主的元素"  │   │
  1375→│   │  }                                                                  │   │
  1376→│   │                                                                     │   │
  1377→│   │  Chunk 2: {                                                         │   │
  1378→│   │    id: "bazi-theory-shenshen-02",                                   │   │
  1379→│   │    topic: "偏印性格特征",                                           │   │
  1380→│   │    content: "偏印之性，聪明多疑...",                                │   │
  1381→│   │    modern_interpretation: "偏印代表的性格特点包括：聪明、思虑多、   │   │
  1382→│   │                           容易想太多、精于分析但可能刻薄"            │   │
  1383→│   │  }                                                                  │   │
  1384→│   └─────────────────────────────────────────────────────────────────────┘   │
  1385→│                                                                             │
  1386→│   ─────────────────────────────────────────────────────────────────────     │
  1387→│                                                                             │
  1388→│   STEP 3: ENTITY & RELATION EXTRACTION                                      │
  1389→│   ─────────────────────────────────────────────────────────────────────     │
  1390→│                                                                             │
  1391→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1392→│   │  ENTITY EXTRACTOR                                                   │   │
  1393→│   │                                                                     │   │
  1394→│   │  Entities:                                                          │   │
  1395→│   │  • 偏印 (TenGod)                                                    │   │
  1396→│   │  • 聪明 (Trait)                                                     │   │
  1397→│   │  • 多疑 (Trait)                                                     │   │
  1398→│   │  • 思考过多 (Behavior)                                              │   │
  1399→│   │                                                                     │   │
  1400→│   │  Relations:                                                         │   │
  1401→│   │  • (偏印) --[MANIFESTS_AS]--> (聪明)                                │   │
  1402→│   │  • (偏印) --[MANIFESTS_AS]--> (多疑)                                │   │
  1403→│   │  • (多疑) --[LEADS_TO]--> (思考过多)                                │   │
  1404→│   │  • (思考过多) --[RESULTS_IN]--> (行动力下降)                        │   │
  1405→│   │                                                                     │   │
  1406→│   └─────────────────────────────────────────────────────────────────────┘   │
  1407→│                                                                             │
  1408→│   ─────────────────────────────────────────────────────────────────────     │
  1409→│                                                                             │
  1410→│   STEP 4: QA PAIR GENERATION                                                │
  1411→│   ─────────────────────────────────────────────────────────────────────     │
  1412→│                                                                             │
  1413→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1414→│   │  QA GENERATOR (LLM)                                                 │   │
  1415→│   │                                                                     │   │
  1416→│   │  Generated QA Pairs:                                                │   │
  1417→│   │                                                                     │   │
  1418→│   │  Q1: "什么是偏印？"                                                 │   │
  1419→│   │  A1: "偏印是八字十神之一，指与日主阴阳相同、生助日主的元素。       │   │
  1420→│   │       比如甲木日主，甲木属阳，壬水也属阳，壬水生甲木，               │   │
  1421→│   │       所以壬水对甲木就是偏印。"                                     │   │
  1422→│   │                                                                     │   │
  1423→│   │  Q2: "偏印代表什么性格？"                                           │   │
  1424→│   │  A2: "偏印代表的性格特点包括：聪明、善于思考、但容易想太多、        │   │
  1425→│   │       精于分析、可能有些挑剔。偏印旺的人通常很聪明，                 │   │
  1426→│   │       但可能因为想太多而犹豫不决。"                                 │   │
  1427→│   │                                                                     │   │
  1428→│   │  Q3: "偏印运会有什么影响？"                                         │   │
  1429→│   │  A3: "走偏印运时，人会变得更爱思考、学习能力增强，                   │   │
  1430→│   │       但同时行动力可能下降。这是一个适合学习、思考、                 │   │
  1431→│   │       调整方向的时期，不是大力推进的时期。"                         │   │
  1432→│   │                                                                     │   │
  1433→│   └─────────────────────────────────────────────────────────────────────┘   │
  1434→│                                                                             │
  1435→│   ─────────────────────────────────────────────────────────────────────     │
  1436→│                                                                             │
  1437→│   STEP 5: MULTI-INDEX STORAGE                                               │
  1438→│   ─────────────────────────────────────────────────────────────────────     │
  1439→│                                                                             │
  1440→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1441→│   │  INDEX BUILDER                                                      │   │
  1442→│   │                                                                     │   │
  1443→│   │  1. Vector Index (Pinecone):                                        │   │
  1444→│   │     • Embed chunk content                                           │   │
  1445→│   │     • Embed QA pairs                                                │   │
  1446→│   │     • Store with metadata                                           │   │
  1447→│   │                                                                     │   │
  1448→│   │  2. Keyword Index (PostgreSQL FTS):                                 │   │
  1449→│   │     • Index: 偏印, 性格, 聪明, 多疑, 思考, 运势...                  │   │
  1450→│   │     • Enable BM25 ranking                                           │   │
  1451→│   │                                                                     │   │
  1452→│   │  3. Graph Index (Neo4j):                                            │   │
  1453→│   │     • Create nodes for entities                                     │   │
  1454→│   │     • Create edges for relations                                    │   │
  1455→│   │     • Enable graph traversal queries                                │   │
  1456→│   │                                                                     │   │
  1457→│   └─────────────────────────────────────────────────────────────────────┘   │
  1458→│                                                                             │
  1459→└─────────────────────────────────────────────────────────────────────────────┘
  1460→```
  1461→
  1462→## 5.3 混合检索系统
  1463→
  1464→```
  1465→┌─────────────────────────────────────────────────────────────────────────────┐
  1466→│                                                                             │
  1467→│   HYBRID RETRIEVAL SYSTEM                                                   │
  1468→│   多路检索 + 智能融合 + 质量评估                                            │
  1469→│                                                                             │
  1470→│   ═══════════════════════════════════════════════════════════════════════   │
  1471→│                                                                             │
  1472→│   Query: "为什么我最近总是想太多，做事拖延？"                               │
  1473→│   User Context: { chart: {...}, current_dayun: "壬午", dayun_shenshen: "偏印" }│
  1474→│                                                                             │
  1475→│   ┌─────────────────────────────────────────────────────────────────────┐   │
  1476→│   │                                                                     │   │
  1477→│   │   QUERY UNDERSTANDING                                               │   │
  1478→│   │   ─────────────────────────────────────────────────────────         │   │
  1479→│   │                                                                     │   │
  1480→│   │   Intent: behavior_explanation                                      │   │
  1481→│   │   Entities: [想太多, 拖延]                                          │   │
  1482→│   │   Context Entities: [偏印运]                                        │   │
  1483→│   │                                                                     │   │
  1484→│   │   Generated Queries:                                                │   │
  1485→│   │   • Semantic: "思考过多 行动力下降 原因"                            │   │
  1486→│   │   • Keyword: "偏印 想太多 拖延"                                     │   │
  1487→│   │   • Graph: START FROM (偏印) TRAVERSE (MANIFESTS_AS, LEADS_TO)      │   │
  1488→│   │                                                                     │   │
  1489→│   └─────────────────────────────────────────────────────────────────────┘   │
  1490→│                                     │                                       │
  1491→│                   ┌─────────────────┼─────────────────┐                     │
  1492→│                   │                 │                 │                     │
  1493→│                   ▼                 ▼                 ▼                     │
  1494→│   ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐         │
  1495→│   │                   │ │                   │ │                   │         │
  1496→│   │   VECTOR SEARCH   │ │  KEYWORD SEARCH   │ │   GRAPH SEARCH    │         │
  1497→│   │                   │ │                   │ │                   │         │
  1498→│   │   Pinecone        │ │   PostgreSQL      │ │   Neo4j           │         │
  1499→│   │                   │ │                   │ │                   │         │

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
