     1→Mentis OS v3.0 part 2
     2→
     3→8. API 设计8.1 API 总览╔═══════════════════════════════════════════════════════════════════════════════╗
     4→║                              API OVERVIEW                                      ║
     5→╠═══════════════════════════════════════════════════════════════════════════════╣
     6→║                                                                               ║
     7→║   BASE URL: https://api.mentis.ai/v3                                          ║
     8→║                                                                               ║
     9→║   AUTHENTICATION: Bearer Token (JWT)                                          ║
    10→║   RATE LIMITS: Based on user tier (free/pro/premium)                          ║
    11→║                                                                               ║
    12→║   ┌─────────────────────────────────────────────────────────────────────────┐║
    13→║   │                          PUBLIC ENDPOINTS                               │║
    14→║   ├─────────────────────────────────────────────────────────────────────────┤║
    15→║   │                                                                         │║
    16→║   │  POST /auth/register          → 注册新用户                              │║
    17→║   │  POST /auth/login             → 用户登录                                │║
    18→║   │  POST /auth/refresh           → 刷新 Token                              │║
    19→║   │  POST /landing/quick-insight  → 快速命盘洞察 (无需登录)                 │║
    20→║   │                                                                         │║
    21→║   └─────────────────────────────────────────────────────────────────────────┘║
    22→║                                                                               ║
    23→║   ┌─────────────────────────────────────────────────────────────────────────┐║
    24→║   │                         STREAM ENDPOINTS                                │║
    25→║   ├─────────────────────────────────────────────────────────────────────────┤║
    26→║   │                                                                         │║
    27→║   │  POST /stream                 → 发送 Stream 条目 (SSE 流式响应)        │║
    28→║   │  GET  /stream                 → 获取 Stream 历史                        │║
    29→║   │  GET  /stream/:id             → 获取单条 Stream                         │║
    30→║   │  DELETE /stream/:id           → 删除 Stream 条目                        │║
    31→║   │                                                                         │║
    32→║   └─────────────────────────────────────────────────────────────────────────┘║
    33→║                                                                               ║
    34→║   ┌─────────────────────────────────────────────────────────────────────────┐║
    35→║   │                         DECODE ENDPOINTS                                │║
    36→║   ├─────────────────────────────────────────────────────────────────────────┤║
    37→║   │                                                                         │║
    38→║   │  POST /decode/bazi            → 八字计算                                │║
    39→║   │  POST /decode/ziwei           → 紫微斗数计算                            │║
    40→║   │  GET  /decode/fortune/today   → 今日运势                                │║
    41→║   │  GET  /decode/fortune/:date   → 指定日期运势                            │║
    42→║   │  GET  /decode/snapshot        → 获取命盘快照                            │║
    43→║   │                                                                         │║
    44→║   └─────────────────────────────────────────────────────────────────────────┘║
    45→║                                                                               ║
    46→║   ┌─────────────────────────────────────────────────────────────────────────┐║
    47→║   │                         EVOLVE ENDPOINTS                                │║
    48→║   ├─────────────────────────────────────────────────────────────────────────┤║
    49→║   │                                                                         │║
    50→║   │  GET  /tasks                  → 获取待办任务列表                        │║
    51→║   │  POST /tasks/:id/complete     → 完成任务                                │║
    52→║   │  POST /tasks/:id/dismiss      → 忽略任务                                │║
    53→║   │  POST /checkin                → 手动打卡                                │║
    54→║   │  GET  /momentum               → 获取动量历史                            │║
    55→║   │                                                                         │║
    56→║   └─────────────────────────────────────────────────────────────────────────┘║
    57→║                                                                               ║
    58→║   ┌─────────────────────────────────────────────────────────────────────────┐║
    59→║   │                         USER ENDPOINTS                                  │║
    60→║   ├─────────────────────────────────────────────────────────────────────────┤║
    61→║   │                                                                         │║
    62→║   │  GET  /user/profile           → 获取用户档案                            │║
    63→║   │  PUT  /user/profile           → 更新用户档案                            │║
    64→║   │  GET  /user/state             → 获取实时状态                            │║
    65→║   │  GET  /user/insights          → 获取洞察列表                            │║
    66→║   │  PUT  /user/preferences       → 更新偏好设置                            │║
    67→║   │                                                                         │║
    68→║   └─────────────────────────────────────────────────────────────────────────┘║
    69→║                                                                               ║
    70→║   ┌─────────────────────────────────────────────────────────────────────────┐║
    71→║   │                        WEBSOCKET ENDPOINT                               │║
    72→║   ├─────────────────────────────────────────────────────────────────────────┤║
    73→║   │                                                                         │║
    74→║   │  WS  /realtime                → 实时更新 (状态/Aura/任务推送)           │║
    75→║   │                                                                         │║
    76→║   └─────────────────────────────────────────────────────────────────────────┘║
    77→║                                                                               ║
    78→╚═══════════════════════════════════════════════════════════════════════════════╝8.2 核心 API 详细定义POST /stream (核心 Stream API)typescript// ═══════════════════════════════════════════════════════════════════════════
    79→// POST /stream - 发送 Stream 条目
    80→// ═══════════════════════════════════════════════════════════════════════════
    81→
    82→// Request
    83→interface StreamRequest {
    84→  content: string;                    // 文本内容
    85→  type?: 'vibe_diary' | 'chat';       // 类型，默认 vibe_diary
    86→  media?: {
    87→    type: 'image' | 'audio';
    88→    data: string;                     // base64 或 URL
    89→  }[];
    90→  metadata?: {
    91→    location?: { lat: number; lng: number };
    92→    device?: string;
    93→  };
    94→}
    95→
    96→// Response (Server-Sent Events)
    97→// Content-Type: text/event-stream
    98→
    99→// Event 1: stream_created
   100→data: {
   101→  "event": "stream_created",
   102→  "data": {
   103→    "id": "uuid",
   104→    "type": "vibe_diary",
   105→    "raw_content": "刚才开会真的气死我了",
   106→    "created_at": "2026-01-04T10:30:00Z"
   107→  }
   108→}
   109→
   110→// Event 2: extraction_complete
   111→data: {
   112→  "event": "extraction_complete",
   113→  "data": {
   114→    "emotion": {
   115→      "primary": "anger",
   116→      "intensity": 8,
   117→      "secondary": ["frustration"]
   118→    },
   119→    "context": {
   120→      "scene": "work",
   121→      "trigger": "meeting",
   122→      "target": "boss"
   123→    },
   124→    "tags": ["#Work", "#Anger"],
   125→    "energy_delta": -3
   126→  }
   127→}
   128→
   129→// Event 3: state_update
   130→data: {
   131→  "event": "state_update",
   132→  "data": {
   133→    "energy_score": 45,
   134→    "momentum": 12,
   135→    "aura_state": "alert"
   136→  }
   137→}
   138→
   139→// Event 4: behavior_match (可选)
   140→data: {
   141→  "event": "behavior_match",
   142→  "data": {
   143→    "matched": true,
   144→    "behavior": "meditation",
   145→    "confidence": 0.92,
   146→    "auto_checkin": true,
   147→    "momentum_delta": 1
   148→  }
   149→}
   150→
   151→// Event 5: agent_response (可选)
   152→data: {
   153→  "event": "agent_response",
   154→  "data": {
   155→    "type": "action_card",
   156→    "card": {
   157→      "id": "uuid",
   158→      "type": "suggestion",
   159→      "title": "3分钟呼吸法",
   160→      "description": "检测到情绪波动，建议做个简短的呼吸练习",
   161→      "momentum_reward": 1
   162→    }
   163→  }
   164→}
   165→
   166→// Event 6: done
   167→data: {
   168→  "event": "done"
   169→}GET /user/state (实时状态 API)typescript// ═══════════════════════════════════════════════════════════════════════════
   170→// GET /user/state - 获取用户实时状态
   171→// ═══════════════════════════════════════════════════════════════════════════
   172→
   173→// Response
   174→interface UserStateResponse {
   175→  energy_score: number;         // 0-100
   176→  momentum: number;             // 累计动量
   177→  streak_days: number;          // 连续天数
   178→  
   179→  current_mood: {
   180→    primary: string;            // anger, joy, sadness, etc.
   181→    intensity: number;          // 1-10
   182→    detected_at: string;        // ISO timestamp
   183→  };
   184→  
   185→  aura_state: 'calm' | 'alert' | 'happy' | 'anxious' | 'flow';
   186→  
   187→  today_stats: {
   188→    stream_count: number;
   189→    checkin_count: number;
   190→    energy_high: number;
   191→    energy_low: number;
   192→  };
   193→  
   194→  pending_tasks: number;
   195→  unread_insights: number;
   196→  
   197→  last_active_at: string;
   198→}WebSocket /realtime (实时推送)typescript// ═══════════════════════════════════════════════════════════════════════════
   199→// WebSocket /realtime - 实时更新订阅
   200→// ═══════════════════════════════════════════════════════════════════════════
   201→
   202→// Connection
   203→// wss://api.mentis.ai/v3/realtime?token={jwt_token}
   204→
   205→// Client → Server Messages
   206→interface ClientMessage {
   207→  type: 'subscribe' | 'unsubscribe' | 'ping';
   208→  channels?: string[];  // ['stream', 'state', 'tasks', 'insights']
   209→}
   210→
   211→// Server → Client Messages
   212→interface ServerMessage {
   213→  type: 'stream_new' | 'state_update' | 'aura_change' | 'task_push' | 'insight_ready' | 'pong';
   214→  data: any;
   215→  timestamp: string;
   216→}
   217→
   218→// Example: state_update
   219→{
   220→  "type": "state_update",
   221→  "data": {
   222→    "energy_score": 72,
   223→    "momentum": 15,
   224→    "aura_state": "calm"
   225→  },
   226→  "timestamp": "2026-01-04T10:30:00Z"
   227→}
   228→
   229→// Example: task_push
   230→{
   231→  "type": "task_push",
   232→  "data": {
   233→    "id": "uuid",
   234→    "type": "suggestion",
   235→    "title": "喝杯水",
   236→    "description": "已经2小时没有补水了",
   237→    "momentum_reward": 1,
   238→    "expires_at": "2026-01-04T11:30:00Z"
   239→  },
   240→  "timestamp": "2026-01-04T10:30:00Z"
   241→}8.3 错误处理规范typescript// ═══════════════════════════════════════════════════════════════════════════
   242→// ERROR RESPONSE FORMAT
   243→// ═══════════════════════════════════════════════════════════════════════════
   244→
   245→interface ErrorResponse {
   246→  error: {
   247→    code: string;           // 错误代码
   248→    message: string;        // 用户友好的错误信息
   249→    details?: any;          // 详细信息 (仅开发环境)
   250→    request_id: string;     // 请求追踪 ID
   251→  };
   252→}
   253→
   254→// Error Codes
   255→const ERROR_CODES = {
   256→  // 认证错误 (401)
   257→  AUTH_INVALID_TOKEN: 'auth/invalid-token',
   258→  AUTH_TOKEN_EXPIRED: 'auth/token-expired',
   259→  AUTH_MISSING_TOKEN: 'auth/missing-token',
   260→  
   261→  // 权限错误 (403)
   262→  PERMISSION_DENIED: 'permission/denied',
   263→  TIER_REQUIRED: 'permission/tier-required',
   264→  
   265→  // 资源错误 (404)
   266→  USER_NOT_FOUND: 'resource/user-not-found',
   267→  STREAM_NOT_FOUND: 'resource/stream-not-found',
   268→  TASK_NOT_FOUND: 'resource/task-not-found',
   269→  
   270→  // 验证错误 (400)
   271→  VALIDATION_ERROR: 'validation/error',
   272→  INVALID_BIRTH_TIME: 'validation/invalid-birth-time',
   273→  INVALID_CONTENT: 'validation/invalid-content',
   274→  
   275→  // 限流错误 (429)
   276→  RATE_LIMIT_EXCEEDED: 'rate-limit/exceeded',
   277→  
   278→  // 服务器错误 (500)
   279→  INTERNAL_ERROR: 'server/internal-error',
   280→  AI_SERVICE_ERROR: 'server/ai-service-error',
   281→  DATABASE_ERROR: 'server/database-error',
   282→};
   283→
   284→9. 核心算法9.1 情绪识别算法╔═══════════════════════════════════════════════════════════════════════════════╗
   285→║                        EMOTION RECOGNITION ALGORITHM                           ║
   286→╠═══════════════════════════════════════════════════════════════════════════════╣
   287→║                                                                               ║
   288→║   PIPELINE OVERVIEW                                                           ║
   289→║   ─────────────────────────────────────────────────────────────────────────   ║
   290→║                                                                               ║
   291→║   ┌─────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       ║
   292→║   │  Input  │ →  │ Preprocess  │ →  │  LLM Call   │ →  │  Validate   │       ║
   293→║   │  Text   │    │  & Clean    │    │  Structured │    │  & Score    │       ║
   294→║   └─────────┘    └─────────────┘    └─────────────┘    └─────────────┘       ║
   295→║                                                                               ║
   296→║   ─────────────────────────────────────────────────────────────────────────   ║
   297→║                                                                               ║
   298→║   EMOTION TAXONOMY                                                            ║
   299→║   ─────────────────────────────────────────────────────────────────────────   ║
   300→║                                                                               ║
   301→║   Primary Emotions (8 categories):                                            ║
   302→║   ├─ joy (喜悦)        → energy_delta: +2 to +5                              ║
   303→║   ├─ sadness (悲伤)    → energy_delta: -2 to -4                              ║
   304→║   ├─ anger (愤怒)      → energy_delta: -3 to -5                              ║
   305→║   ├─ fear (恐惧)       → energy_delta: -2 to -4                              ║
   306→║   ├─ surprise (惊讶)   → energy_delta: -1 to +1                              ║
   307→║   ├─ disgust (厌恶)    → energy_delta: -2 to -3                              ║
   308→║   ├─ anxiety (焦虑)    → energy_delta: -2 to -4                              ║
   309→║   └─ calm (平静)       → energy_delta: 0 to +1                               ║
   310→║                                                                               ║
   311→║   Secondary Emotions (contextual):                                            ║
   312→║   ├─ frustration, helplessness, excitement, pride, guilt, shame              ║
   313→║   └─ loneliness, gratitude, hope, relief, jealousy, contempt                 ║
   314→║                                                                               ║
   315→╚═══════════════════════════════════════════════════════════════════════════════╝typescript// 情绪识别实现
   316→
   317→interface EmotionResult {
   318→  primary: string;
   319→  intensity: number;  // 1-10
   320→  secondary: string[];
   321→  confidence: number;
   322→  energy_delta: number;
   323→}
   324→
   325→const EMOTION_PROMPT = `
   326→分析以下文本的情绪，返回JSON格式：
   327→
   328→文本: "{input}"
   329→
   330→返回格式:
   331→{
   332→  "primary": "主要情绪 (joy/sadness/anger/fear/surprise/disgust/anxiety/calm)",
   333→  "intensity": "强度 1-10",
   334→  "secondary": ["次要情绪列表"],
   335→  "reasoning": "简短分析"
   336→}
   337→
   338→注意:
   339→1. intensity 反映情绪强烈程度
   340→2. 考虑上下文和表达方式
   341→3. 中文语境下的委婉表达可能隐藏强烈情绪
   342→`;
   343→
   344→async function detectEmotion(input: string): Promise<EmotionResult> {
   345→  const response = await llm.complete({
   346→    model: 'gpt-4-turbo',
   347→    prompt: EMOTION_PROMPT.replace('{input}', input),
   348→    response_format: { type: 'json_object' },
   349→  });
   350→  
   351→  const parsed = JSON.parse(response);
   352→  
   353→  // 计算能量变化
   354→  const energy_delta = calculateEnergyDelta(parsed.primary, parsed.intensity);
   355→  
   356→  return {
   357→    primary: parsed.primary,
   358→    intensity: parsed.intensity,
   359→    secondary: parsed.secondary,
   360→    confidence: 0.9,  // 可基于模型置信度调整
   361→    energy_delta,
   362→  };
   363→}
   364→
   365→function calculateEnergyDelta(emotion: string, intensity: number): number {
   366→  const ENERGY_MAP: Record<string, [number, number]> = {
   367→    joy: [2, 5],
   368→    sadness: [-4, -2],
   369→    anger: [-5, -3],
   370→    fear: [-4, -2],
   371→    surprise: [-1, 1],
   372→    disgust: [-3, -2],
   373→    anxiety: [-4, -2],
   374→    calm: [0, 1],
   375→  };
   376→  
   377→  const [min, max] = ENERGY_MAP[emotion] || [0, 0];
   378→  const ratio = intensity / 10;
   379→  
   380→  if (max > 0) {
   381→    return Math.round(min + (max - min) * ratio);
   382→  } else {
   383→    return Math.round(max + (min - max) * ratio);
   384→  }
   385→}9.2 行为匹配算法╔═══════════════════════════════════════════════════════════════════════════════╗
   386→║                        BEHAVIOR MATCHING ALGORITHM                             ║
   387→║                        (NLU → Auto Checkin)                                    ║
   388→╠═══════════════════════════════════════════════════════════════════════════════╣
   389→║                                                                               ║
   390→║   MATCHING PIPELINE                                                           ║
   391→║   ─────────────────────────────────────────────────────────────────────────   ║
   392→║                                                                               ║
   393→║   User Input                                                                  ║
   394→║       │                                                                       ║
   395→║       ▼                                                                       ║
   396→║   ┌───────────────────────────────────────────────────────────────────────┐  ║
   397→║   │ Step 1: Embedding                                                      │  ║
   398→║   │ ─────────────────                                                      │  ║
   399→║   │ model: text-embedding-3-small                                          │  ║
   400→║   │ output: 1536-dim vector                                                │  ║
   401→║   └───────────────────────────────────────────────────────────────────────┘  ║
   402→║       │                                                                       ║
   403→║       ▼                                                                       ║
   404→║   ┌───────────────────────────────────────────────────────────────────────┐  ║
   405→║   │ Step 2: Pending Task Match (优先)                                      │  ║
   406→║   │ ─────────────────────────────                                          │  ║
   407→║   │ 如果用户有待完成任务，优先匹配这些任务                                 │  ║
   408→║   │ threshold: 0.80                                                        │  ║
   409→║   └───────────────────────────────────────────────────────────────────────┘  ║
   410→║       │                                                                       ║
   411→║       ▼                                                                       ║
   412→║   ┌───────────────────────────────────────────────────────────────────────┐  ║
   413→║   │ Step 3: Behavior Library Match                                         │  ║
   414→║   │ ─────────────────────────────                                          │  ║
   415→║   │ Pinecone namespace: behavior_library                                   │  ║
   416→║   │ top_k: 3                                                               │  ║
   417→║   │ threshold: 0.85 (auto), 0.60-0.85 (confirm card)                      │  ║
   418→║   └───────────────────────────────────────────────────────────────────────┘  ║
   419→║       │                                                                       ║
   420→║       ▼                                                                       ║
   421→║   ┌───────────────────────────────────────────────────────────────────────┐  ║
   422→║   │ Step 4: Decision                                                       │  ║
   423→║   │ ─────────────                                                          │  ║
   424→║   │ score >= 0.85 → Auto Checkin                                          │  ║
   425→║   │ score 0.60-0.85 → Generate Confirmation Card                          │  ║
   426→║   │ score < 0.60 → No Match                                               │  ║
   427→║   └───────────────────────────────────────────────────────────────────────┘  ║
   428→║                                                                               ║
   429→╚═══════════════════════════════════════════════════════════════════════════════╝typescript// 行为匹配实现
   430→
   431→interface BehaviorMatch {
   432→  matched: boolean;
   433→  behavior?: string;
   434→  confidence: number;
   435→  auto_checkin: boolean;
   436→  task_id?: string;
   437→}
   438→
   439→// 行为库定义
   440→const BEHAVIOR_LIBRARY = [
   441→  {
   442→    id: 'meditation',
   443→    name: '冥想',
   444→    aliases: ['打坐', '静心', '呼吸练习', '正念'],
   445→    examples: [
   446→      '刚才静下心来冥想了一会儿',
   447→      '做了十分钟的呼吸练习',
   448→      '今天冥想了',
   449→    ],
   450→    momentum_reward: 1,
   451→  },
   452→  {
   453→    id: 'hydration',
   454→    name: '补水',
   455→    aliases: ['喝水', '补充水分'],
   456→    examples: [
   457→      '喝了杯水',
   458→      '刚补了水',
   459→      '终于记得喝水了',
   460→    ],
   461→    momentum_reward: 1,
   462→  },
   463→  {
   464→    id: 'emotion_control',
   465→    name: '情绪控制',
   466→    aliases: ['忍住', '控制情绪', '没发火'],
   467→    examples: [
   468→      '忍住没发火',
   469→      '今天控制住情绪了',
   470→      '深呼吸让自己冷静下来了',
   471→    ],
   472→    momentum_reward: 2,
   473→  },
   474→  // ... more behaviors
   475→];
   476→
   477→async function matchBehavior(
   478→  input: string,
   479→  userId: string,
   480→  pendingTasks: Task[]
   481→): Promise<BehaviorMatch> {
   482→  
   483→  // Step 1: Generate embedding
   484→  const inputEmbedding = await embed(input);
   485→  
   486→  // Step 2: Check pending tasks first
   487→  if (pendingTasks.length > 0) {
   488→    const taskMatch = await matchPendingTasks(inputEmbedding, pendingTasks);
   489→    if (taskMatch && taskMatch.score >= 0.80) {
   490→      return {
   491→        matched: true,
   492→        behavior: taskMatch.task.type,
   493→        confidence: taskMatch.score,
   494→        auto_checkin: taskMatch.score >= 0.85,
   495→        task_id: taskMatch.task.id,
   496→      };
   497→    }
   498→  }
   499→  
   500→  // Step 3: Match against behavior library
   501→  const libraryMatch = await pinecone.query({
   502→    namespace: 'behavior_library',
   503→    vector: inputEmbedding,
   504→    topK: 3,
   505→    includeMetadata: true,
   506→  });
   507→  
   508→  const topMatch = libraryMatch.matches[0];
   509→  
   510→  if (!topMatch || topMatch.score < 0.60) {
   511→    return { matched: false, confidence: topMatch?.score || 0, auto_checkin: false };
   512→  }
   513→  
   514→  return {
   515→    matched: true,
   516→    behavior: topMatch.metadata.behavior_id,
   517→    confidence: topMatch.score,
   518→    auto_checkin: topMatch.score >= 0.85,
   519→  };
   520→}
   521→9.3 Agent 主动干预算法
   522→╔═══════════════════════════════════════════════════════════════════════════════╗
   523→║                     PROACTIVE INTERVENTION ALGORITHM                           ║
   524→║                     (Agent 主动推送决策)                                       ║
   525→╠═══════════════════════════════════════════════════════════════════════════════╣
   526→║                                                                               ║
   527→║   TRIGGER CONDITIONS                                                          ║
   528→║   ─────────────────────────────────────────────────────────────────────────   ║
   529→║                                                                               ║
   530→║   1. TIME-BASED TRIGGERS                                                      ║
   531→║   ──────────────────────                                                      ║
   532→║   ├─ Morning (7-9am): 每日运势 + 早间建议                                    ║
   533→║   ├─ Midday (12-1pm): 午休提醒 + 能量检查                                    ║
   534→║   ├─ Afternoon (3-4pm): 下午茶/补水提醒                                      ║
   535→║   └─ Evening (9-10pm): 今日回顾 + 明日准备                                   ║
   536→║                                                                               ║
   537→║   2. STATE-BASED TRIGGERS                                                     ║
   538→║   ────────────────────────                                                    ║
   539→║   ├─ energy_score < 30 → 紧急干预 (呼吸/休息建议)                            ║
   540→║   ├─ anger detected (intensity > 7) → 情绪调节建议                           ║
   541→║   ├─ anxiety detected (持续2小时+) → CBT 练习推送                            ║
   542→║   └─ flow detected → 正强化 (不打断，延后推送)                               ║
   543→║                                                                               ║
   544→║   3. BEHAVIOR-BASED TRIGGERS                                                  ║
   545→║   ──────────────────────────                                                  ║
   546→║   ├─ 2小时未补水 → 补水提醒                                                  ║
   547→║   ├─ 连续3天未冥想 → 习惯提醒                                                ║
   548→║   ├─ 连续完成7天 → 里程碑庆祝                                                ║
   549→║   └─ 发现负面模式 → 洞察分享                                                 ║
   550→║                                                                               ║
   551→║   4. FORTUNE-BASED TRIGGERS                                                   ║
   552→║   ──────────────────────────                                                  ║
   553→║   ├─ 运势特别好 → 建议积极行动                                               ║
   554→║   ├─ 运势警告日 → 提前预警 + 保守建议                                        ║
   555→║   └─ 特殊时间节点 (节气/月相) → 定制建议                                     ║
   556→║                                                                               ║
   557→╚═══════════════════════════════════════════════════════════════════════════════╝
   558→typescript// Agent 主动干预实现
   559→
   560→interface InterventionTrigger {
   561→  type: 'time' | 'state' | 'behavior' | 'fortune';
   562→  priority: 'high' | 'medium' | 'low';
   563→  action: ActionCard;
   564→}
   565→
   566→interface AgentContext {
   567→  user_state: UserState;
   568→  recent_streams: StreamEntry[];
   569→  pending_tasks: Task[];
   570→  fortune_today: Fortune;
   571→  last_intervention: Date;
   572→}
   573→
   574→async function evaluateInterventions(ctx: AgentContext): Promise<InterventionTrigger[]> {
   575→  const triggers: InterventionTrigger[] = [];
   576→  
   577→  // 1. State-based triggers (highest priority)
   578→  if (ctx.user_state.energy_score < 30) {
   579→    triggers.push({
   580→      type: 'state',
   581→      priority: 'high',
   582→      action: generateBreathingCard(),
   583→    });
   584→  }
   585→  
   586→  const recentAnger = ctx.recent_streams.find(
   587→    s => s.emotion?.primary === 'anger' && 
   588→         s.emotion.intensity > 7 &&
   589→         Date.now() - new Date(s.created_at).getTime() < 30 * 60 * 1000
   590→  );
   591→  if (recentAnger) {
   592→    triggers.push({
   593→      type: 'state',
   594→      priority: 'high',
   595→      action: generateEmotionRegulationCard(),
   596→    });
   597→  }
   598→  
   599→  // 2. Time-based triggers
   600→  const hour = new Date().getHours();
   601→  if (hour >= 7 && hour < 9 && !hasRecentTrigger(ctx, 'morning')) {
   602→    triggers.push({
   603→      type: 'time',
   604→      priority: 'medium',
   605→      action: generateMorningCard(ctx.fortune_today),
   606→    });
   607→  }
   608→  
   609→  // 3. Behavior-based triggers
   610→  const lastHydration = await getLastCheckin(ctx.user_state.user_id, 'hydration');
   611→  if (!lastHydration || Date.now() - lastHydration.getTime() > 2 * 60 * 60 * 1000) {
   612→    triggers.push({
   613→      type: 'behavior',
   614→      priority: 'low',
   615→      action: generateHydrationCard(),
   616→    });
   617→  }
   618→  
   619→  // 4. Fortune-based triggers
   620→  if (ctx.fortune_today.fortune_level === 'caution') {
   621→    triggers.push({
   622→      type: 'fortune',
   623→      priority: 'medium',
   624→      action: generateCautionCard(ctx.fortune_today),
   625→    });
   626→  }
   627→  
   628→  // Sort by priority and dedupe
   629→  return prioritizeAndDedupe(triggers);
   630→}
   631→
   632→// 干预节流：避免过度打扰
   633→function shouldIntervene(ctx: AgentContext, trigger: InterventionTrigger): boolean {
   634→  const minutesSinceLastIntervention = 
   635→    (Date.now() - ctx.last_intervention.getTime()) / (60 * 1000);
   636→  
   637→  const MIN_INTERVAL: Record<string, number> = {
   638→    high: 5,      // 高优先级最少间隔5分钟
   639→    medium: 30,   // 中优先级最少间隔30分钟
   640→    low: 120,     // 低优先级最少间隔2小时
   641→  };
   642→  
   643→  return minutesSinceLastIntervention >= MIN_INTERVAL[trigger.priority];
   644→}
   645→9.4 动量计算算法
   646→╔═══════════════════════════════════════════════════════════════════════════════╗
   647→║                        MOMENTUM CALCULATION ALGORITHM                          ║
   648→╠═══════════════════════════════════════════════════════════════════════════════╣
   649→║                                                                               ║
   650→║   MOMENTUM FORMULA                                                            ║
   651→║   ─────────────────────────────────────────────────────────────────────────   ║
   652→║                                                                               ║
   653→║   Daily Momentum = Σ(action_rewards) × streak_multiplier × consistency_bonus  ║
   654→║                                                                               ║
   655→║   Where:                                                                      ║
   656→║   ├─ action_rewards: 每个完成行为的奖励点数                                  ║
   657→║   ├─ streak_multiplier: 连续天数乘数                                         ║
   658→║   │   └─ days 1-3: 1.0x                                                      ║
   659→║   │   └─ days 4-7: 1.2x                                                      ║
   660→║   │   └─ days 8-14: 1.5x                                                     ║
   661→║   │   └─ days 15-21: 1.8x                                                    ║
   662→║   │   └─ days 22+: 2.0x                                                      ║
   663→║   └─ consistency_bonus: 本周完成率奖励                                       ║
   664→║       └─ 50-70%: +0%                                                         ║
   665→║       └─ 70-90%: +10%                                                        ║
   666→║       └─ 90%+: +20%                                                          ║
   667→║                                                                               ║
   668→║   ─────────────────────────────────────────────────────────────────────────   ║
   669→║                                                                               ║
   670→║   DECAY RULES                                                                 ║
   671→║   ─────────────────────────────────────────────────────────────────────────   ║
   672→║                                                                               ║
   673→║   ├─ 断签1天: streak_multiplier 重置为 1.0x                                  ║
   674→║   ├─ 断签2天: momentum × 0.9 (损失10%)                                       ║
   675→║   ├─ 断签3天+: momentum × 0.8 + streak 重置                                  ║
   676→║   └─ 断签7天+: momentum × 0.5 + 重新校准                                     ║
   677→║                                                                               ║
   678→╚═══════════════════════════════════════════════════════════════════════════════╝
   679→typescript// 动量计算实现
   680→
   681→interface MomentumConfig {
   682→  STREAK_MULTIPLIERS: Record<string, number>;
   683→  CONSISTENCY_BONUSES: Record<string, number>;
   684→  DECAY_RULES: Record<number, { momentum_factor: number; reset_streak: boolean }>;
   685→}
   686→
   687→const CONFIG: MomentumConfig = {
   688→  STREAK_MULTIPLIERS: {
   689→    '1-3': 1.0,
   690→    '4-7': 1.2,
   691→    '8-14': 1.5,
   692→    '15-21': 1.8,
   693→    '22+': 2.0,
   694→  },
   695→  CONSISTENCY_BONUSES: {
   696→    '50-70': 0,
   697→    '70-90': 0.10,
   698→    '90+': 0.20,
   699→  },
   700→  DECAY_RULES: {
   701→    1: { momentum_factor: 1.0, reset_streak: true },
   702→    2: { momentum_factor: 0.9, reset_streak: true },
   703→    3: { momentum_factor: 0.8, reset_streak: true },
   704→    7: { momentum_factor: 0.5, reset_streak: true },
   705→  },
   706→};
   707→
   708→function getStreakMultiplier(streakDays: number): number {
   709→  if (streakDays <= 3) return 1.0;
   710→  if (streakDays <= 7) return 1.2;
   711→  if (streakDays <= 14) return 1.5;
   712→  if (streakDays <= 21) return 1.8;
   713→  return 2.0;
   714→}
   715→
   716→function getConsistencyBonus(weeklyCompletionRate: number): number {
   717→  if (weeklyCompletionRate >= 0.9) return 0.20;
   718→  if (weeklyCompletionRate >= 0.7) return 0.10;
   719→  return 0;
   720→}
   721→
   722→function calculateDailyMomentum(
   723→  actionRewards: number[],
   724→  streakDays: number,
   725→  weeklyCompletionRate: number
   726→): number {
   727→  const baseReward = actionRewards.reduce((sum, r) => sum + r, 0);
   728→  const multiplier = getStreakMultiplier(streakDays);
   729→  const bonus = 1 + getConsistencyBonus(weeklyCompletionRate);
   730→  
   731→  return Math.round(baseReward * multiplier * bonus);
   732→}
   733→
   734→function applyMomentumDecay(
   735→  currentMomentum: number,
   736→  daysMissed: number
   737→): { newMomentum: number; resetStreak: boolean } {
   738→  if (daysMissed === 0) {
   739→    return { newMomentum: currentMomentum, resetStreak: false };
   740→  }
   741→  
   742→  const decayRule = CONFIG.DECAY_RULES[Math.min(daysMissed, 7)];
   743→  return {
   744→    newMomentum: Math.round(currentMomentum * decayRule.momentum_factor),
   745→    resetStreak: decayRule.reset_streak,
   746→  };
   747→}
   748→9.5 运势计算算法
   749→╔═══════════════════════════════════════════════════════════════════════════════╗
   750→║                        FORTUNE CALCULATION ALGORITHM                           ║
   751→║                        (八字日运 + 紫微流日)                                   ║
   752→╠═══════════════════════════════════════════════════════════════════════════════╣
   753→║                                                                               ║
   754→║   CALCULATION PIPELINE                                                        ║
   755→║   ─────────────────────────────────────────────────────────────────────────   ║
   756→║                                                                               ║
   757→║   ┌─────────────────┐                                                         ║
   758→║   │  User BirthTime │                                                         ║
   759→║   └────────┬────────┘                                                         ║
   760→║            │                                                                  ║
   761→║            ▼                                                                  ║
   762→║   ┌────────────────────────────────────────────────────────────────────────┐ ║
   763→║   │  Step 1: BaZi Calculation (八字排盘)                                    │ ║
   764→║   │  ────────────────────────────────────────────────────────────────────  │ ║
   765→║   │  • 计算年柱、月柱、日柱、时柱                                          │ ║
   766→║   │  • 确定日主 (日干)                                                     │ ║
   767→║   │  • 分析五行强弱                                                        │ ║
   768→║   │  • 确定用神、忌神                                                      │ ║
   769→║   └────────────────────────────────────────────────────────────────────────┘ ║
   770→║            │                                                                  ║
   771→║            ▼                                                                  ║
   772→║   ┌────────────────────────────────────────────────────────────────────────┐ ║
   773→║   │  Step 2: Daily Pillar Analysis (日柱分析)                               │ ║
   774→║   │  ────────────────────────────────────────────────────────────────────  │ ║
   775→║   │  • 今日干支与命局的关系                                                │ ║
   776→║   │  • 生克制化分析                                                        │ ║
   777→║   │  • 神煞影响                                                            │ ║
   778→║   └────────────────────────────────────────────────────────────────────────┘ ║
   779→║            │                                                                  ║
   780→║            ▼                                                                  ║
   781→║   ┌────────────────────────────────────────────────────────────────────────┐ ║
   782→║   │  Step 3: ZiWei Flow Day (紫微流日)                                      │ ║
   783→║   │  ────────────────────────────────────────────────────────────────────  │ ║
   784→║   │  • 流日宫位落点                                                        │ ║
   785→║   │  • 四化飞星影响                                                        │ ║
   786→║   │  • 吉凶星曜组合                                                        │ ║
   787→║   └────────────────────────────────────────────────────────────────────────┘ ║
   788→║            │                                                                  ║
   789→║            ▼                                                                  ║
   790→║   ┌────────────────────────────────────────────────────────────────────────┐ ║
   791→║   │  Step 4: Score Synthesis (综合评分)                                     │ ║
   792→║   │  ────────────────────────────────────────────────────────────────────  │ ║
   793→║   │  fortune_score = bazi_score × 0.4 + ziwei_score × 0.4 + special × 0.2 │ ║
   794→║   │                                                                        │ ║
   795→║   │  Levels:                                                               │ ║
   796→║   │  • 90-100: excellent (大吉)                                            │ ║
   797→║   │  • 70-89: good (吉)                                                    │ ║
   798→║   │  • 50-69: normal (平)                                                  │ ║
   799→║   │  • 30-49: caution (需注意)                                             │ ║
   800→║   │  • 0-29: difficult (不利)                                              │ ║
   801→║   └────────────────────────────────────────────────────────────────────────┘ ║
   802→║            │                                                                  ║
   803→║            ▼                                                                  ║
   804→║   ┌────────────────────────────────────────────────────────────────────────┐ ║
   805→║   │  Step 5: Suggestion Generation (建议生成)                               │ ║
   806→║   │  ────────────────────────────────────────────────────────────────────  │ ║
   807→║   │  • 基于运势等级生成行动建议                                            │ ║
   808→║   │  • 宜/忌事项                                                           │ ║
   809→║   │  • 幸运元素 (颜色/数字/方位)                                           │ ║
   810→║   └────────────────────────────────────────────────────────────────────────┘ ║
   811→║                                                                               ║
   812→╚═══════════════════════════════════════════════════════════════════════════════╝
   813→typescript// 运势计算实现 (简化版)
   814→
   815→interface FortuneResult {
   816→  fortune_score: number;        // 1-100
   817→  fortune_level: FortuneLevel;
   818→  analysis: {
   819→    overall: string;
   820→    career: string;
   821→    relationship: string;
   822→    health: string;
   823→    wealth: string;
   824→  };
   825→  suggestions: string[];
   826→  avoid_items: string[];
   827→  lucky_items: {
   828→    color: string;
   829→    number: number;
   830→    direction: string;
   831→  };
   832→}
   833→
   834→type FortuneLevel = 'excellent' | 'good' | 'normal' | 'caution' | 'difficult';
   835→
   836→async function calculateDailyFortune(
   837→  userId: string,
   838→  date: Date
   839→): Promise<FortuneResult> {
   840→  // 获取用户命盘数据
   841→  const userProfile = await getUserProfile(userId);
   842→  const baziChart = userProfile.bazi_data;
   843→  const ziweiChart = userProfile.ziwei_data;
   844→  
   845→  // 计算今日干支
   846→  const todayPillar = calculateDayPillar(date);
   847→  
   848→  // Step 1: 八字日运评分
   849→  const baziScore = calculateBaziDailyScore(baziChart, todayPillar);
   850→  
   851→  // Step 2: 紫微流日评分
   852→  const ziweiScore = calculateZiweiFlowDayScore(ziweiChart, date);
   853→  
   854→  // Step 3: 特殊因素 (节气、月相等)
   855→  const specialScore = calculateSpecialFactors(date);
   856→  
   857→  // Step 4: 综合评分
   858→  const fortune_score = Math.round(
   859→    baziScore * 0.4 + ziweiScore * 0.4 + specialScore * 0.2
   860→  );
   861→  
   862→  // Step 5: 确定等级
   863→  const fortune_level = getFortuneLevel(fortune_score);
   864→  
   865→  // Step 6: 生成分析和建议 (使用 LLM)
   866→  const analysisAndSuggestions = await generateFortuneAnalysis({
   867→    baziChart,
   868→    todayPillar,
   869→    fortune_score,
   870→    fortune_level,
   871→  });
   872→  
   873→  return {
   874→    fortune_score,
   875→    fortune_level,
   876→    ...analysisAndSuggestions,
   877→  };
   878→}
   879→
   880→function getFortuneLevel(score: number): FortuneLevel {
   881→  if (score >= 90) return 'excellent';
   882→  if (score >= 70) return 'good';
   883→  if (score >= 50) return 'normal';
   884→  if (score >= 30) return 'caution';
   885→  return 'difficult';
   886→}
   887→
   888→function calculateBaziDailyScore(baziChart: BaZiChart, todayPillar: Pillar): number {
   889→  let score = 50; // 基础分
   890→  
   891→  const dayMaster = baziChart.dayPillar.heavenlyStem;
   892→  const todayStem = todayPillar.heavenlyStem;
   893→  const todayBranch = todayPillar.earthlyBranch;
   894→  
   895→  // 判断今日天干与日主的关系
   896→  const stemRelation = getStemRelation(dayMaster, todayStem);
   897→  
   898→  // 用神得令加分，忌神当值减分
   899→  if (stemRelation === 'helps' && isUsefulGod(baziChart, todayStem)) {
   900→    score += 20;
   901→  } else if (stemRelation === 'hurts' || isHarmfulGod(baziChart, todayStem)) {
   902→    score -= 20;
   903→  }
   904→  
   905→  // 地支刑冲破害减分
   906→  const branchConflict = checkBranchConflicts(baziChart, todayBranch);
   907→  score -= branchConflict.penalty;
   908→  
   909→  // 神煞加减分
   910→  const shenShaEffect = calculateShenShaEffect(baziChart, todayPillar);
   911→  score += shenShaEffect;
   912→  
   913→  return Math.max(0, Math.min(100, score));
   914→}
   915→
   916→10. 部署架构
   917→10.1 云原生部署架构
   918→╔═══════════════════════════════════════════════════════════════════════════════╗
   919→║                        CLOUD-NATIVE DEPLOYMENT ARCHITECTURE                    ║
   920→╠═══════════════════════════════════════════════════════════════════════════════╣
   921→║                                                                               ║
   922→║   VERCEL (Frontend + Edge + API)                                              ║
   923→║   ─────────────────────────────────────────────────────────────────────────   ║
   924→║                                                                               ║
   925→║   ┌─────────────────────────────────────────────────────────────────────────┐║
   926→║   │                          VERCEL EDGE NETWORK                            │║
   927→║   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │║
   928→║   │  │ Edge Config │  │ Edge Cache  │  │Edge Function│  │ Edge KV     │    │║
   929→║   │  │ (A/B Test)  │  │ (Static)    │  │ (Auth/Rate) │  │ (Session)   │    │║
   930→║   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │║
   931→║   └─────────────────────────────────────────────────────────────────────────┘║
   932→║                                           │                                   ║
   933→║   ┌─────────────────────────────────────────────────────────────────────────┐║
   934→║   │                          VERCEL FUNCTIONS                               │║
   935→║   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │║
   936→║   │  │ /api/stream │  │ /api/decode │  │ /api/user   │  │ /api/tasks  │    │║
   937→║   │  │ (Streaming) │  │ (Standard)  │  │ (Standard)  │  │ (Standard)  │    │║
   938→║   │  │ Max 60s     │  │ Max 10s     │  │ Max 10s     │  │ Max 10s     │    │║
   939→║   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │║
   940→║   └─────────────────────────────────────────────────────────────────────────┘║
   941→║                                                                               ║
   942→║   EXTERNAL SERVICES                                                           ║
   943→║   ─────────────────────────────────────────────────────────────────────────   ║
   944→║                                                                               ║
   945→║   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        ║
   946→║   │  Neon       │  │  Upstash    │  │  Pinecone   │  │  Cloudflare │        ║
   947→║   │  PostgreSQL │  │  Redis      │  │  Vectors    │  │  R2 Storage │        ║
   948→║   │  (Serverless│  │  (Serverless│  │  (Serverless│  │  (S3 compat)│        ║
   949→║   │  Branching) │  │  QStash)    │  │  Index)     │  │             │        ║
   950→║   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        ║
   951→║                                                                               ║
   952→║   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        ║
   953→║   │  OpenAI     │  │  Anthropic  │  │  Pusher     │  │  Resend     │        ║
   954→║   │  GPT-4 +    │  │  Claude     │  │  WebSocket  │  │  Email      │        ║
   955→║   │  Whisper +  │  │  (Backup)   │  │  Realtime   │  │  (Transact) │        ║
   956→║   │  Embedding  │  │             │  │             │  │             │        ║
   957→║   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        ║
   958→║                                                                               ║
   959→╚═══════════════════════════════════════════════════════════════════════════════╝
   960→10.2 技术栈总览
   961→╔═══════════════════════════════════════════════════════════════════════════════╗
   962→║                              TECHNOLOGY STACK                                  ║
   963→╠═══════════════════════════════════════════════════════════════════════════════╣
   964→║                                                                               ║
   965→║   FRONTEND                                                                    ║
   966→║   ─────────────────────────────────────────────────────────────────────────   ║
   967→║   ├─ Framework: Next.js 14 (App Router)                                      ║
   968→║   ├─ Language: TypeScript 5.3                                                ║
   969→║   ├─ Styling: Tailwind CSS 3.4 + Framer Motion                               ║
   970→║   ├─ State: Zustand + React Query (TanStack Query)                           ║
   971→║   ├─ Forms: React Hook Form + Zod                                            ║
   972→║   ├─ UI Components: Radix UI + shadcn/ui                                     ║
   973→║   └─ Mobile: React Native (Expo) / Taro (WeChat Mini)                        ║
   974→║                                                                               ║
   975→║   BACKEND                                                                     ║
   976→║   ─────────────────────────────────────────────────────────────────────────   ║
   977→║   ├─ Runtime: Next.js API Routes + Vercel Functions                          ║
   978→║   ├─ AI SDK: Vercel AI SDK 4.0                                               ║
   979→║   ├─ ORM: Drizzle ORM                                                        ║
   980→║   ├─ Validation: Zod                                                         ║
   981→║   ├─ Auth: NextAuth.js v5 + JWT                                              ║
   982→║   └─ Background Jobs: Upstash QStash                                         ║
   983→║                                                                               ║
   984→║   DATABASE                                                                    ║
   985→║   ─────────────────────────────────────────────────────────────────────────   ║
   986→║   ├─ Primary: Neon PostgreSQL (Serverless, Auto-scaling)                     ║
   987→║   ├─ Cache: Upstash Redis (Serverless, Global)                               ║
   988→║   ├─ Vector: Pinecone (Serverless, Pod-based)                                ║
   989→║   └─ Media: Cloudflare R2 (S3 Compatible)                                    ║
   990→║                                                                               ║
   991→║   AI/ML SERVICES                                                              ║
   992→║   ─────────────────────────────────────────────────────────────────────────   ║
   993→║   ├─ Primary LLM: OpenAI GPT-4 Turbo                                         ║
   994→║   ├─ Backup LLM: Anthropic Claude 3.5 Sonnet                                 ║
   995→║   ├─ China Region: ZhiPu GLM-4                                               ║
   996→║   ├─ STT: OpenAI Whisper API                                                 ║
   997→║   ├─ Embedding: OpenAI text-embedding-3-small                                ║
   998→║   └─ Vision: OpenAI GPT-4 Vision                                             ║
   999→║                                                                               ║
  1000→║   INFRASTRUCTURE                                                              ║
  1001→║   ─────────────────────────────────────────────────────────────────────────   ║
  1002→║   ├─ Hosting: Vercel (Edge + Functions)                                      ║
  1003→║   ├─ CDN: Vercel Edge Network + Cloudflare                                   ║
  1004→║   ├─ DNS: Cloudflare                                                         ║
  1005→║   ├─ SSL: Automatic (Vercel + Cloudflare)                                    ║
  1006→║   └─ Monitoring: Vercel Analytics + Sentry                                   ║
  1007→║                                                                               ║
  1008→║   REALTIME & NOTIFICATIONS                                                    ║
  1009→║   ─────────────────────────────────────────────────────────────────────────   ║
  1010→║   ├─ WebSocket: Pusher Channels                                              ║
  1011→║   ├─ Push: Firebase Cloud Messaging (FCM)                                    ║
  1012→║   ├─ Email: Resend                                                           ║
  1013→║   └─ SMS: Twilio (Optional)                                                  ║
  1014→║                                                                               ║
  1015→╚═══════════════════════════════════════════════════════════════════════════════╝
  1016→10.3 环境配置
  1017→bash# ═══════════════════════════════════════════════════════════════════════════
  1018→# ENVIRONMENT VARIABLES
  1019→# ═══════════════════════════════════════════════════════════════════════════
  1020→
  1021→# ─────────────────────────────────────────────────────────────────────────────
  1022→# DATABASE
  1023→# ─────────────────────────────────────────────────────────────────────────────
  1024→DATABASE_URL="postgresql://user:pass@ep-xxx.us-east-1.aws.neon.tech/mentis?sslmode=require"
  1025→DATABASE_URL_UNPOOLED="postgresql://user:pass@ep-xxx.us-east-1.aws.neon.tech/mentis?sslmode=require"
  1026→
  1027→# ─────────────────────────────────────────────────────────────────────────────
  1028→# REDIS (Upstash)
  1029→# ─────────────────────────────────────────────────────────────────────────────
  1030→UPSTASH_REDIS_REST_URL="https://xxx.upstash.io"
  1031→UPSTASH_REDIS_REST_TOKEN="xxx"
  1032→
  1033→# ─────────────────────────────────────────────────────────────────────────────
  1034→# VECTOR DATABASE (Pinecone)
  1035→# ─────────────────────────────────────────────────────────────────────────────
  1036→PINECONE_API_KEY="xxx"
  1037→PINECONE_ENVIRONMENT="us-east-1-aws"
  1038→PINECONE_INDEX="mentis-vectors"
  1039→
  1040→# ─────────────────────────────────────────────────────────────────────────────
  1041→# OBJECT STORAGE (Cloudflare R2)
  1042→# ─────────────────────────────────────────────────────────────────────────────
  1043→R2_ACCOUNT_ID="xxx"
  1044→R2_ACCESS_KEY_ID="xxx"
  1045→R2_SECRET_ACCESS_KEY="xxx"
  1046→R2_BUCKET_NAME="mentis-media"
  1047→
  1048→# ─────────────────────────────────────────────────────────────────────────────
  1049→# AI SERVICES
  1050→# ─────────────────────────────────────────────────────────────────────────────
  1051→OPENAI_API_KEY="sk-xxx"
  1052→ANTHROPIC_API_KEY="sk-ant-xxx"
  1053→ZHIPU_API_KEY="xxx"  # 国内用户
  1054→
  1055→# ─────────────────────────────────────────────────────────────────────────────
  1056→# AUTH
  1057→# ─────────────────────────────────────────────────────────────────────────────
  1058→NEXTAUTH_SECRET="xxx"
  1059→NEXTAUTH_URL="https://mentis.ai"
  1060→
  1061→# ─────────────────────────────────────────────────────────────────────────────
  1062→# REALTIME (Pusher)
  1063→# ─────────────────────────────────────────────────────────────────────────────
  1064→PUSHER_APP_ID="xxx"
  1065→PUSHER_KEY="xxx"
  1066→PUSHER_SECRET="xxx"
  1067→PUSHER_CLUSTER="us2"
  1068→NEXT_PUBLIC_PUSHER_KEY="xxx"
  1069→
  1070→# ─────────────────────────────────────────────────────────────────────────────
  1071→# EMAIL (Resend)
  1072→# ─────────────────────────────────────────────────────────────────────────────
  1073→RESEND_API_KEY="re_xxx"
  1074→
  1075→# ─────────────────────────────────────────────────────────────────────────────
  1076→# MONITORING
  1077→# ─────────────────────────────────────────────────────────────────────────────
  1078→SENTRY_DSN="https://xxx@sentry.io/xxx"
  1079→NEXT_PUBLIC_SENTRY_DSN="https://xxx@sentry.io/xxx"
  1080→10.4 性能指标 (SLO/SLI)
  1081→╔═══════════════════════════════════════════════════════════════════════════════╗
  1082→║                        SERVICE LEVEL OBJECTIVES (SLO)                          ║
  1083→╠═══════════════════════════════════════════════════════════════════════════════╣
  1084→║                                                                               ║
  1085→║   AVAILABILITY                                                                ║
  1086→║   ─────────────────────────────────────────────────────────────────────────   ║
  1087→║   ├─ Overall System: 99.9% uptime (monthly)                                  ║
  1088→║   ├─ Core API: 99.95% uptime                                                 ║
  1089→║   └─ WebSocket: 99.5% uptime                                                 ║
  1090→║                                                                               ║
  1091→║   LATENCY (P95)                                                               ║
  1092→║   ─────────────────────────────────────────────────────────────────────────   ║
  1093→║   ├─ Stream Input → First Response: < 500ms                                  ║
  1094→║   ├─ Stream Input → Complete Processing: < 3000ms                            ║
  1095→║   ├─ Emotion Detection: < 300ms                                              ║
  1096→║   ├─ Behavior Match: < 200ms                                                 ║
  1097→║   ├─ State Update Broadcast: < 100ms                                         ║
  1098→║   ├─ Fortune Query: < 500ms (cached) / < 2000ms (computed)                   ║
  1099→║   └─ Page Load (TTFB): < 200ms                                               ║
  1100→║                                                                               ║
  1101→║   THROUGHPUT                                                                  ║
  1102→║   ─────────────────────────────────────────────────────────────────────────   ║
  1103→║   ├─ Concurrent Users: 10,000+                                               ║
  1104→║   ├─ Requests/Second: 1,000+ (API)                                           ║
  1105→║   └─ WebSocket Connections: 50,000+                                          ║
  1106→║                                                                               ║
  1107→║   ERROR RATES                                                                 ║
  1108→║   ─────────────────────────────────────────────────────────────────────────   ║
  1109→║   ├─ 5xx Errors: < 0.1%                                                      ║
  1110→║   ├─ AI Service Failures: < 0.5%                                             ║
  1111→║   └─ WebSocket Disconnects: < 1%/hour                                        ║
  1112→║                                                                               ║
  1113→╚═══════════════════════════════════════════════════════════════════════════════╝
  1114→
  1115→11. 演进路线图
  1116→11.1 版本演进计划
  1117→╔═══════════════════════════════════════════════════════════════════════════════╗
  1118→║                           VERSION ROADMAP                                      ║
  1119→╠═══════════════════════════════════════════════════════════════════════════════╣
  1120→║                                                                               ║
  1121→║   v3.0 MVP (Month 1-2)                                                        ║
  1122→║   ─────────────────────────────────────────────────────────────────────────   ║
  1123→║   ├─ Core Stream Architecture                                                ║
  1124→║   ├─ Vibe Diary Input (Voice + Text)                                         ║
  1125→║   ├─ Basic Emotion Detection                                                 ║
  1126→║   ├─ Dynamic Aura System                                                     ║
  1127→║   ├─ Simple Action Cards                                                     ║
  1128→║   ├─ BaZi Daily Fortune                                                      ║
  1129→║   └─ Momentum Tracking                                                       ║
  1130→║                                                                               ║
  1131→║   v3.1 Enhancement (Month 3-4)                                                ║
  1132→║   ─────────────────────────────────────────────────────────────────────────   ║
  1133→║   ├─ NLU Auto Checkin                                                        ║
  1134→║   ├─ Proactive Agent Intervention                                            ║
  1135→║   ├─ ZiWei Module Integration                                                ║
  1136→║   ├─ Weekly Mirror Report                                                    ║
  1137→║   ├─ Pattern Detection                                                       ║
  1138→║   └─ Photo Input + Vision                                                    ║
  1139→║                                                                               ║
  1140→║   v3.2 Intelligence (Month 5-6)                                               ║
  1141→║   ─────────────────────────────────────────────────────────────────────────   ║
  1142→║   ├─ CBT Module (Cognitive Reframe)                                          ║
  1143→║   ├─ MBTI Assessment Integration                                             ║
  1144→║   ├─ Advanced Behavior Matching                                              ║
  1145→║   ├─ Personalized Habit Prescription                                         ║
  1146→║   ├─ Cross-device Sync                                                       ║
  1147→║   └─ Notification Optimization                                               ║
  1148→║                                                                               ║
  1149→║   v3.3 Social & Advanced (Month 7-9)                                          ║
  1150→║   ─────────────────────────────────────────────────────────────────────────   ║
  1151→║   ├─ Social Features (Energy Boost)                                          ║
  1152→║   ├─ Couples/Team Mode                                                       ║
  1153→║   ├─ Voice Persona (TTS)                                                     ║
  1154→║   ├─ Advanced Analytics Dashboard                                            ║
  1155→║   ├─ Calendar Integration                                                    ║
  1156→║   └─ Third-party Wearable Integration                                        ║
  1157→║                                                                               ║
  1158→║   v4.0 Platform (Month 10-12)                                                 ║
  1159→║   ─────────────────────────────────────────────────────────────────────────   ║
  1160→║   ├─ Plugin Marketplace                                                      ║
  1161→║   ├─ Custom Module SDK                                                       ║
  1162→║   ├─ Enterprise Features                                                     ║
  1163→║   ├─ Advanced AI Persona                                                     ║
  1164→║   ├─ Multi-language Support                                                  ║
  1165→║   └─ White-label Solution                                                    ║
  1166→║                                                                               ║
  1167→╚═══════════════════════════════════════════════════════════════════════════════╝
  1168→11.2 MVP 功能优先级矩阵
  1169→╔═══════════════════════════════════════════════════════════════════════════════╗
  1170→║                        MVP FEATURE PRIORITY MATRIX                             ║
  1171→╠═══════════════════════════════════════════════════════════════════════════════╣
  1172→║                                                                               ║
  1173→║                           HIGH IMPACT                                         ║
  1174→║                              ▲                                                ║
  1175→║                              │                                                ║
  1176→║   ┌──────────────────────────┼──────────────────────────┐                    ║
  1177→║   │                          │                          │                    ║
  1178→║   │  P1: DO FIRST            │   P2: DO SECOND          │                    ║
  1179→║   │  ─────────────           │   ─────────────          │                    ║
  1180→║   │  • Stream Input          │   • NLU Auto Checkin     │                    ║
  1181→║   │  • Emotion Detection     │   • Weekly Report        │                    ║
  1182→║   │  • Dynamic Aura          │   • Pattern Detection    │                    ║
  1183→║   │  • Basic Action Cards    │   • Photo Input          │                    ║
  1184→║   │  • Real-time Sync        │   • Advanced Triggers    │                    ║
  1185→║   │                          │                          │                    ║
  1186→║ L ├──────────────────────────┼──────────────────────────┤ H                 ║
  1187→║ O │                          │                          │ I                 ║
  1188→║ W │  P4: DO LATER            │   P3: DO THIRD           │ G                 ║
  1189→║   │  ─────────────           │   ─────────────          │ H                 ║
  1190→║ E │  • Social Features       │   • CBT Module           │                    ║
  1191→║ F │  • Calendar Sync         │   • MBTI Integration     │ E                 ║
  1192→║ F │  • Voice Persona         │   • ZiWei Module         │ F                 ║
  1193→║ O │  • Wearable Integration  │   • Desktop App          │ F                 ║
  1194→║ R │  • Enterprise Features   │   • Advanced Analytics   │ O                 ║
  1195→║ T │                          │                          │ R                 ║
  1196→║   └──────────────────────────┼──────────────────────────┘ T                 ║
  1197→║                              │                                                ║
  1198→║                              ▼                                                ║
  1199→║                           LOW IMPACT                                          ║
  1200→║                                                                               ║
  1201→╚═══════════════════════════════════════════════════════════════════════════════╝
  1202→11.3 技术债务管理
  1203→╔═══════════════════════════════════════════════════════════════════════════════╗
  1204→║                        TECHNICAL DEBT MANAGEMENT                               ║
  1205→╠═══════════════════════════════════════════════════════════════════════════════╣
  1206→║                                                                               ║
  1207→║   MVP 阶段允许的技术债务                                                       ║
  1208→║   ─────────────────────────────────────────────────────────────────────────   ║
  1209→║   ├─ 简化的错误处理 → v3.1 统一错误框架                                      ║
  1210→║   ├─ 硬编码配置 → v3.1 配置中心                                              ║
  1211→║   ├─ 基础日志 → v3.1 结构化日志 + 追踪                                       ║
  1212→║   ├─ 简单缓存策略 → v3.2 多层缓存                                            ║
  1213→║   └─ 单一 AI 提供商 → v3.2 多模型路由                                        ║
  1214→║                                                                               ║
  1215→║   必须在 MVP 完成的基础设施                                                    ║
  1216→║   ─────────────────────────────────────────────────────────────────────────   ║
  1217→║   ├─ 数据库迁移系统 (Drizzle Migrations)                                     ║
  1218→║   ├─ API 版本控制 (/v3/...)                                                  ║
  1219→║   ├─ 认证/授权框架                                                           ║
  1220→║   ├─ CI/CD 流水线                                                            ║
  1221→║   ├─ 基础监控告警                                                            ║
  1222→║   └─ 数据备份策略                                                            ║
  1223→║                                                                               ║
  1224→║   技术债务偿还计划                                                            ║
  1225→║   ─────────────────────────────────────────────────────────────────────────   ║
  1226→║   • 每个 Sprint 预留 15% 时间处理技术债务                                     ║
  1227→║   • 大版本发布前进行技术债务审计                                              ║
  1228→║   • 保持测试覆盖率 > 70%                                                      ║
  1229→║   • 代码审查强制执行                                                          ║
  1230→║                                                                               ║
  1231→╚═══════════════════════════════════════════════════════════════════════════════╝
  1232→
  1233→12. 附录
  1234→12.1 术语表 (Glossary)
  1235→术语英文定义StreamStream用户生活流，所有输入和反馈的时间线Vibe DiaryVibe Diary情绪日记，用户的碎碎念输入Action CardAction Card可交互的任务卡片，由 Agent 推送Dynamic AuraDynamic Aura动态光环，根据情绪变化的背景效果MomentumMomentum动量，用户行为积累的成长指数DECODEDECODE解码层，包含八字、紫微等命理模块REFRAMEREFRAME重塑层，包含 CBT、ACT 等认知重构EVOLVEEVOLVE进化层，包含习惯、行为处方模块HUDHeads-Up Display抬头显示，环境感知层NLUNatural Language Understanding自然语言理解
  1236→12.2 参考资料
  1237→Architecture References:
  1238→├─ Vercel AI SDK Documentation
  1239→├─ Next.js App Router Best Practices
  1240→├─ Drizzle ORM Documentation
  1241→├─ Pinecone Vector Database Guide
  1242→└─ Pusher Channels Documentation
  1243→
  1244→Domain Knowledge:
  1245→├─ 八字命理基础理论
  1246→├─ 紫微斗数入门
  1247→├─ CBT 认知行为疗法
  1248→├─ ACT 接纳承诺疗法
  1249→└─ 微习惯理论 (BJ Fogg)
  1250→
  1251→Design Patterns:
  1252→├─ Event-Driven Architecture
  1253→├─ CQRS Pattern
  1254→├─ Saga Pattern
  1255→└─ Domain-Driven Design
  1256→12.3 变更日志
  1257→v3.0.0 (2026-01-04)
  1258→─────────────────────
  1259→- Initial v3.0 Architecture Document
  1260→- Stream-Centric Design Philosophy
  1261→- Three-Layer Interaction Model
  1262→- Complete Data Model Design
  1263→- API Specification
  1264→- Core Algorithm Documentation
  1265→- Deployment Architecture
  1266→- MVP Roadmap
  1267→
  1268→Based on v2.0 → v2.1 iterations:
  1269→- Dashboard → Ambient HUD transformation
  1270→- Chat-first → Stream-first paradigm shift
  1271→- Manual checkin → NLU auto-recognition
  1272→- Reactive → Proactive Agent model
  1273→
  1274→╔═══════════════════════════════════════════════════════════════════════════════╗
  1275→║                                                                               ║
  1276→║                              END OF DOCUMENT                                  ║
  1277→║                                                                               ║
  1278→║                          MENTIS v3.0 Architecture                             ║
  1279→║                      Stream-Centric Agentic Platform                          ║
  1280→║                                                                               ║
  1281→║                         Decode. Reframe. Evolve.                              ║
  1282→║                     解码命运 · 重塑认知 · 进化人生                            ║
  1283→║                                                                               ║
  1284→║  ─────────────────────────────────────────────────────────────────────────   ║
  1285→║                                                                               ║
  1286→║  Document Version: 3.0                                                        ║
  1287→║  Last Updated: 2026-01-04                                                     ║
  1288→║  Author: Silicon Valley Principal Architect                                   ║
  1289→║                                                                               ║
  1290→╚═══════════════════════════════════════════════════════════════════════════════╝

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
