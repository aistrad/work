=== API Route files ===
总计 120
drwxrwxr-x  3 aiscend aiscend  4096 Jan  7 05:07 .
drwxrwxr-x 13 aiscend aiscend  4096 Jan  7 05:08 ..
-rw-------  1 aiscend aiscend  5581 Jan  5 20:35 auth.py
-rw-------  1 aiscend aiscend 13854 Jan  5 21:13 billing.py
-rw-------  1 aiscend aiscend 21529 Jan  7 04:38 chat.py
-rw-------  1 aiscend aiscend  6694 Jan  7 05:07 fortune.py
-rw-------  1 aiscend aiscend  1047 Jan  5 20:01 health.py
-rw-------  1 aiscend aiscend    28 Jan  5 20:01 __init__.py
-rw-------  1 aiscend aiscend 11464 Jan  7 04:55 payment.py
drwxrwxr-x  2 aiscend aiscend  4096 Jan  7 05:07 __pycache__
-rw-------  1 aiscend aiscend 10419 Jan  7 05:07 relationship.py
-rw-------  1 aiscend aiscend  7720 Jan  7 05:07 report.py
-rw-------  1 aiscend aiscend 10648 Jan  5 20:35 users.py

=== Check chat route ===
"""
Chat Routes - Conversation endpoints for VibeLife v3.0
Based on: vibelife spec v3.0

Features:
- SSE streaming responses
- Voice mode toggle (warm / sarcastic)
- Skill-based conversations (bazi / zodiac)
- Guest mode for demo
- AI Interview endpoints
- File upload + extraction
"""
import json
from typing import Optional, List
from uuid import UUID, uuid4

from fastapi import APIRouter, HTTPException, Depends, Query, UploadFile, File
from fastapi.responses import StreamingResponse
from pydantic import BaseModel, Field
from sse_starlette.sse import EventSourceResponse

from services.vibe_engine import (
    get_llm_service,
    get_context_builder,
    get_portrait_service,
    VoiceMode,
    Skill,
    create_user_message,
)
from services.interview import get_interview_service, InterviewSession
from services.extraction import get_extraction_service
from stores import conversation_repo, message_repo, profile_repo

router = APIRouter(prefix="/chat", tags=["Chat"])


# ═══════════════════════════════════════════════════════════════════════════
# Request/Response Models
# ═══════════════════════════════════════════════════════════════════════════

class ChatRequest(BaseModel):
    """Chat request model"""
    message: str = Field(..., description="User message")
    skill: str = Field(..., description="Skill: bazi or zodiac")
    conversation_id: Optional[UUID] = Field(None, description="Existing conversation ID")
    voice_mode: Optional[str] = Field("warm", description="Voice mode: warm or sarcastic")


class ChatResponse(BaseModel):
    """Chat response model (for non-streaming)"""
    content: str
    conversation_id: UUID
    skill: str
    voice_mode: str
    metadata: Optional[dict] = None


class GuestChatRequest(BaseModel):
    """Guest chat request (no auth required)"""
    message: str
    skill: str = "bazi"


# ═══════════════════════════════════════════════════════════════════════════
# Helper Functions
# ═══════════════════════════════════════════════════════════════════════════

def parse_skill(skill_str: str) -> Skill:
    """Parse skill string to enum"""
    skill_lower = skill_str.lower()
    if skill_lower in ("bazi", "八字"):
        return Skill.BAZI
    elif skill_lower in ("zodiac", "星座"):
        return Skill.ZODIAC
    else:
        raise HTTPException(status_code=400, detail=f"Unknown skill: {skill_str}")


def parse_voice_mode(mode_str: str) -> VoiceMode:
    """Parse voice mode string to enum"""
    mode_lower = mode_str.lower()
    if mode_lower in ("warm", "温暖"):
        return VoiceMode.WARM
    elif mode_lower in ("sarcastic", "吐槽"):
        return VoiceMode.SARCASTIC
    else:
        return VoiceMode.WARM  # Default


async def get_user_profile(user_id: Optional[UUID]) -> dict:
    """Get user profile from database"""
    if user_id:
        try:
            profile_data = await profile_repo.get_profile_data(user_id)
            return profile_data
        except Exception:
            pass

    # Return default profile for guests
    from services.vibe_engine import DEFAULT_PROFILE