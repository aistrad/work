     1→"""
     2→VibeLife API - The Living Companion Backend
     3→"""
     4→import os
     5→from pathlib import Path
     6→from contextlib import asynccontextmanager
     7→
     8→from fastapi import FastAPI
     9→from fastapi.middleware.cors import CORSMiddleware
    10→
    11→from stores.db import init_db, close_db
    12→from workers import IngestionWorker
    13→
    14→# ─────────────────────────────────────────────────────────────────
    15→# Load environment (.env at repo root)
    16→# ─────────────────────────────────────────────────────────────────
    17→
    18→try:
    19→    from dotenv import load_dotenv
    20→except ImportError:  # pragma: no cover
    21→    load_dotenv = None
    22→
    23→if load_dotenv:
    24→    env_path = Path(__file__).resolve().parents[2] / ".env"
    25→    if env_path.exists():
    26→        load_dotenv(env_path, override=False)
    27→
    28→# ─────────────────────────────────────────────────────────────────
    29→# Lifespan (startup/shutdown)
    30→# ─────────────────────────────────────────────────────────────────
    31→
    32→@asynccontextmanager
    33→async def lifespan(app: FastAPI):
    34→    """Application lifespan handler"""
    35→    # Startup
    36→    print("Starting VibeLife API...")
    37→    await init_db()
    38→    print("Database connected")
    39→
    40→    # Start ingestion worker (if enabled)
    41→    ingestion_worker = None
    42→    if os.getenv("VIBELIFE_WORKER_ENABLED", "1") == "1":
    43→        ingestion_worker = IngestionWorker()
    44→        await ingestion_worker.start()
    45→        print("Ingestion worker started")
    46→
    47→    yield
    48→
    49→    # Shutdown
    50→    print("Shutting down VibeLife API...")
    51→
    52→    # Stop worker
    53→    if ingestion_worker:
    54→        await ingestion_worker.stop()
    55→        print("Ingestion worker stopped")
    56→
    57→    await close_db()
    58→    print("Database closed")
    59→
    60→
    61→# ─────────────────────────────────────────────────────────────────
    62→# App Creation
    63→# ─────────────────────────────────────────────────────────────────
    64→
    65→app = FastAPI(
    66→    title="VibeLife API",
    67→    description="The Living Companion - AI-powered personal growth platform",
    68→    version="1.0.0",
    69→    lifespan=lifespan,
    70→)
    71→
    72→# ─────────────────────────────────────────────────────────────────
    73→# CORS Middleware
    74→# ─────────────────────────────────────────────────────────────────
    75→
    76→cors_origins = os.getenv("VIBELIFE_CORS_ORIGINS", "http://localhost:3000").split(",")
    77→
    78→app.add_middleware(
    79→    CORSMiddleware,
    80→    allow_origins=cors_origins,
    81→    allow_credentials=True,
    82→    allow_methods=["*"],
    83→    allow_headers=["*"],
    84→)
    85→
    86→
    87→# ─────────────────────────────────────────────────────────────────
    88→# Routes Import
    89→# ─────────────────────────────────────────────────────────────────
    90→
    91→from routes.health import router as health_router
    92→from routes.auth import router as auth_router
    93→from routes.users import router as users_router
    94→from routes.chat import router as chat_router
    95→from routes.billing import router as billing_router
    96→
    97→# v3.0 new routes
    98→from routes.report import router as report_router
    99→from routes.relationship import router as relationship_router
   100→from routes.fortune import router as fortune_router
   101→from routes.payment import router as payment_router
   102→
   103→# Register routers
   104→app.include_router(health_router, tags=["Health"])
   105→app.include_router(auth_router, prefix="/api/v1", tags=["Authentication"])
   106→app.include_router(users_router, prefix="/api/v1", tags=["Users"])
   107→app.include_router(chat_router, prefix="/api/v1", tags=["Chat"])
   108→app.include_router(billing_router, prefix="/api/v1", tags=["Billing"])
   109→
   110→# v3.0 new routers
   111→app.include_router(report_router, prefix="/api/v1", tags=["Report"])
   112→app.include_router(relationship_router, prefix="/api/v1", tags=["Relationship"])
   113→app.include_router(fortune_router, prefix="/api/v1", tags=["Fortune"])
   114→app.include_router(payment_router, prefix="/api/v1", tags=["Payment"])
   115→
   116→
   117→# ─────────────────────────────────────────────────────────────────
   118→# Root Endpoint
   119→# ─────────────────────────────────────────────────────────────────
   120→
   121→@app.get("/")
   122→async def root():
   123→    """Root endpoint - API info"""
   124→    return {
   125→        "name": "VibeLife API",
   126→        "version": "1.0.0",
   127→        "description": "The Living Companion - AI-powered personal growth platform",
   128→        "docs": "/docs",
   129→        "health": "/health",
   130→    }
   131→
   132→
   133→# ─────────────────────────────────────────────────────────────────
   134→# Run with uvicorn (for development)
   135→# ─────────────────────────────────────────────────────────────────
   136→
   137→if __name__ == "__main__":
   138→    import uvicorn
   139→
   140→    port = int(os.getenv("VIBELIFE_API_PORT", 8000))
   141→    host = os.getenv("VIBELIFE_API_HOST", "0.0.0.0")
   142→
   143→    uvicorn.run(
   144→        "main:app",
   145→        host=host,
   146→        port=port,
   147→        reload=os.getenv("VIBELIFE_DEV", "0") == "1",
   148→    )
   149→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
