     1→"""
     2→Daily Greeting Service - Personalized daily greetings
     3→Based on: vibelife spec v3.0
     4→
     5→Content includes:
     6→- Today's fortune overview
     7→- Actionable suggestions
     8→- Relevant solar terms / celestial events
     9→- Emotional support based on chart
    10→
    11→Tone follows user's voice mode preference (warm/sarcastic)
    12→"""
    13→
    14→import json
    15→import logging
    16→from dataclasses import dataclass, field
    17→from typing import Optional, List, Dict, Any
    18→from datetime import datetime, date
    19→from enum import Enum
    20→from uuid import uuid4
    21→
    22→from ..vibe_engine import get_llm_service, create_system_message, create_user_message
    23→
    24→logger = logging.getLogger(__name__)
    25→
    26→
    27→# ═══════════════════════════════════════════════════════════════════════════
    28→# Enums and Constants
    29→# ═══════════════════════════════════════════════════════════════════════════
    30→
    31→class GreetingType(str, Enum):
    32→    MORNING = "morning"          # 早安问候
    33→    SOLAR_TERM = "solar_term"    # 节气问候
    34→    EVENT = "event"              # 事件问候
    35→    EVENING = "evening"          # 晚安问候
    36→
    37→
    38→class SolarTerm(str, Enum):
    39→    """24 Solar Terms (二十四节气)"""
    40→    LICHUN = "立春"
    41→    YUSHUI = "雨水"
    42→    JINGZHE = "惊蛰"
    43→    CHUNFEN = "春分"
    44→    QINGMING = "清明"
    45→    GUYU = "谷雨"
    46→    LIXIA = "立夏"
    47→    XIAOMAN = "小满"
    48→    MANGZHONG = "芒种"
    49→    XIAZHI = "夏至"
    50→    XIAOSHU = "小暑"
    51→    DASHU = "大暑"
    52→    LIQIU = "立秋"
    53→    CHUSHU = "处暑"
    54→    BAILU = "白露"
    55→    QIUFEN = "秋分"
    56→    HANLU = "寒露"
    57→    SHUANGJIANG = "霜降"
    58→    LIDONG = "立冬"
    59→    XIAOXUE = "小雪"
    60→    DAXUE = "大雪"
    61→    DONGZHI = "冬至"
    62→    XIAOHAN = "小寒"
    63→    DAHAN = "大寒"
    64→
    65→
    66→# Solar term dates (approximate, varies by year)
    67→# Format: (month, day_start, day_end)
    68→SOLAR_TERM_DATES = {
    69→    SolarTerm.LICHUN: (2, 3, 5),
    70→    SolarTerm.YUSHUI: (2, 18, 20),
    71→    SolarTerm.JINGZHE: (3, 5, 7),
    72→    SolarTerm.CHUNFEN: (3, 20, 22),
    73→    SolarTerm.QINGMING: (4, 4, 6),
    74→    SolarTerm.GUYU: (4, 19, 21),
    75→    SolarTerm.LIXIA: (5, 5, 7),
    76→    SolarTerm.XIAOMAN: (5, 20, 22),
    77→    SolarTerm.MANGZHONG: (6, 5, 7),
    78→    SolarTerm.XIAZHI: (6, 21, 22),
    79→    SolarTerm.XIAOSHU: (7, 6, 8),
    80→    SolarTerm.DASHU: (7, 22, 24),
    81→    SolarTerm.LIQIU: (8, 7, 9),
    82→    SolarTerm.CHUSHU: (8, 22, 24),
    83→    SolarTerm.BAILU: (9, 7, 9),
    84→    SolarTerm.QIUFEN: (9, 22, 24),
    85→    SolarTerm.HANLU: (10, 8, 9),
    86→    SolarTerm.SHUANGJIANG: (10, 23, 24),
    87→    SolarTerm.LIDONG: (11, 7, 8),
    88→    SolarTerm.XIAOXUE: (11, 22, 23),
    89→    SolarTerm.DAXUE: (12, 6, 8),
    90→    SolarTerm.DONGZHI: (12, 21, 23),
    91→    SolarTerm.XIAOHAN: (1, 5, 7),
    92→    SolarTerm.DAHAN: (1, 20, 21),
    93→}
    94→
    95→
    96→# ═══════════════════════════════════════════════════════════════════════════
    97→# Data Models
    98→# ═══════════════════════════════════════════════════════════════════════════
    99→
   100→@dataclass
   101→class DailyGreeting:
   102→    """A daily greeting message"""
   103→    id: str
   104→    type: GreetingType
   105→    date: date
   106→    greeting: str           # Main greeting text
   107→    fortune_hint: str       # Today's fortune hint
   108→    action_tip: str         # Actionable suggestion
   109→    solar_term: Optional[SolarTerm] = None
   110→    event: Optional[str] = None
   111→    voice_mode: str = "warm"
   112→
   113→    def to_dict(self) -> dict:
   114→        return {
   115→            "id": self.id,
   116→            "type": self.type.value,
   117→            "date": self.date.isoformat(),
   118→            "greeting": self.greeting,
   119→            "fortune_hint": self.fortune_hint,
   120→            "action_tip": self.action_tip,
   121→            "solar_term": self.solar_term.value if self.solar_term else None,
   122→            "event": self.event,
   123→            "voice_mode": self.voice_mode,
   124→        }
   125→
   126→
   127→# ═══════════════════════════════════════════════════════════════════════════
   128→# Prompts
   129→# ═══════════════════════════════════════════════════════════════════════════
   130→
   131→GREETING_SYSTEM_WARM = """你是 Vibe，VibeLife 的 AI 知己。现在要为用户生成一条温暖的每日问候。
   132→
   133→风格要求：
   134→- 温暖、关怀、有支持感
   135→- 简短有力，不超过100字
   136→- 包含今日运势提示
   137→- 包含一个具体可执行的小建议
   138→- 如果有节气/天象，自然融入
   139→
   140→输出 JSON 格式：
   141→{
   142→    "greeting": "问候语",
   143→    "fortune_hint": "今日运势提示",
   144→    "action_tip": "具体建议"
   145→}"""
   146→
   147→GREETING_SYSTEM_SARCASTIC = """你是 Vibe，VibeLife 的 AI 知己。现在要为用户生成一条毒舌但关心的每日问候。
   148→
   149→风格要求：
   150→- 毒舌但底层是关心
   151→- 直接、有趣、有点吐槽
   152→- 简短有力，不超过100字
   153→- 包含今日运势提示
   154→- 包含一个具体可执行的小建议
   155→
   156→输出 JSON 格式：
   157→{
   158→    "greeting": "问候语",
   159→    "fortune_hint": "今日运势提示",
   160→    "action_tip": "具体建议"
   161→}"""
   162→
   163→GREETING_USER_TEMPLATE = """为用户生成今日问候：
   164→
   165→用户特征：
   166→- 日主元素：{element}
   167→- 当前关注：{concerns}
   168→- 今日节气：{solar_term}
   169→
   170→日期：{date}
   171→问候类型：{greeting_type}"""
   172→
   173→
   174→# ═══════════════════════════════════════════════════════════════════════════
   175→# Greeting Service
   176→# ═══════════════════════════════════════════════════════════════════════════
   177→
   178→class GreetingService:
   179→    """Service for generating personalized daily greetings"""
   180→
   181→    def __init__(self):
   182→        self._llm = None
   183→
   184→    @property
   185→    def llm(self):
   186→        if self._llm is None:
   187→            self._llm = get_llm_service()
   188→        return self._llm
   189→
   190→    async def generate_greeting(
   191→        self,
   192→        profile: Dict[str, Any],
   193→        greeting_type: str = "morning",
   194→        voice_mode: str = "warm",
   195→        target_date: date = None,
   196→    ) -> DailyGreeting:
   197→        """
   198→        Generate a personalized daily greeting.
   199→
   200→        Args:
   201→            profile: User's profile data
   202→            greeting_type: Type of greeting
   203→            voice_mode: "warm" or "sarcastic"
   204→            target_date: Date for the greeting (default: today)
   205→
   206→        Returns:
   207→            DailyGreeting object
   208→        """
   209→        if target_date is None:
   210→            target_date = date.today()
   211→
   212→        greeting_type_enum = GreetingType(greeting_type)
   213→
   214→        # Check for solar term
   215→        solar_term = self._get_solar_term(target_date)
   216→
   217→        # Extract profile info
   218→        basic = profile.get("basic", {})
   219→        life_context = profile.get("life_context", {})
   220→
   221→        element = basic.get("day_master_element", "木")
   222→        concerns = life_context.get("main_concerns", ["日常"])
   223→
   224→        # Select system prompt based on voice mode
   225→        system_prompt = (
   226→            GREETING_SYSTEM_WARM if voice_mode == "warm"
   227→            else GREETING_SYSTEM_SARCASTIC
   228→        )
   229→
   230→        user_prompt = GREETING_USER_TEMPLATE.format(
   231→            element=element,
   232→            concerns=", ".join(concerns) if concerns else "日常",
   233→            solar_term=solar_term.value if solar_term else "无",
   234→            date=target_date.strftime("%Y年%m月%d日"),
   235→            greeting_type="早安" if greeting_type == "morning" else "问候",
   236→        )
   237→
   238→        messages = [
   239→            create_system_message(system_prompt),
   240→            create_user_message(user_prompt),
   241→        ]
   242→
   243→        try:
   244→            response = await self.llm.chat(messages)
   245→
   246→            # Parse response
   247→            content = response.content.strip()
   248→            if content.startswith("```"):
   249→                content = content.split("```")[1]
   250→                if content.startswith("json"):
   251→                    content = content[4:]
   252→
   253→            data = json.loads(content)
   254→
   255→            return DailyGreeting(
   256→                id=str(uuid4()),
   257→                type=greeting_type_enum,
   258→                date=target_date,
   259→                greeting=data.get("greeting", "早上好！"),
   260→                fortune_hint=data.get("fortune_hint", "今天是美好的一天"),
   261→                action_tip=data.get("action_tip", "保持好心情"),
   262→                solar_term=solar_term,
   263→                voice_mode=voice_mode,
   264→            )
   265→
   266→        except Exception as e:
   267→            logger.error(f"Greeting generation failed: {e}")
   268→            return self._get_fallback_greeting(target_date, greeting_type_enum, voice_mode)
   269→
   270→    def _get_solar_term(self, target_date: date) -> Optional[SolarTerm]:
   271→        """Check if target date is a solar term"""
   272→        month = target_date.month
   273→        day = target_date.day
   274→
   275→        for term, (m, d_start, d_end) in SOLAR_TERM_DATES.items():
   276→            if month == m and d_start <= day <= d_end:
   277→                return term
   278→
   279→        return None
   280→
   281→    def _get_fallback_greeting(
   282→        self,
   283→        target_date: date,
   284→        greeting_type: GreetingType,
   285→        voice_mode: str,
   286→    ) -> DailyGreeting:
   287→        """Generate fallback greeting when LLM fails"""
   288→        if voice_mode == "warm":
   289→            greeting = "早上好！新的一天，新的开始。"
   290→            fortune_hint = "今天的能量适合稳步推进计划中的事情。"
   291→            action_tip = "找一件你一直想做但没开始的事，今天就迈出第一步。"
   292→        else:
   293→            greeting = "起床了？行，那就开始吧。"
   294→            fortune_hint = "今天没什么特别的，正常发挥就行。"
   295→            action_tip = "别想太多，做就对了。"
   296→
   297→        return DailyGreeting(
   298→            id=str(uuid4()),
   299→            type=greeting_type,
   300→            date=target_date,
   301→            greeting=greeting,
   302→            fortune_hint=fortune_hint,
   303→            action_tip=action_tip,
   304→            voice_mode=voice_mode,
   305→        )
   306→
   307→    async def generate_solar_term_greeting(
   308→        self,
   309→        profile: Dict[str, Any],
   310→        solar_term: SolarTerm,
   311→        voice_mode: str = "warm",
   312→    ) -> DailyGreeting:
   313→        """Generate a special greeting for solar term"""
   314→        # Solar term specific prompts would go here
   315→        # For now, use the general greeting with solar term context
   316→        return await self.generate_greeting(
   317→            profile=profile,
   318→            greeting_type="solar_term",
   319→            voice_mode=voice_mode,
   320→        )
   321→
   322→
   323→# ═══════════════════════════════════════════════════════════════════════════
   324→# Singleton and Convenience Functions
   325→# ═══════════════════════════════════════════════════════════════════════════
   326→
   327→_greeting_service: Optional[GreetingService] = None
   328→
   329→
   330→def get_greeting_service() -> GreetingService:
   331→    """Get singleton greeting service"""
   332→    global _greeting_service
   333→    if _greeting_service is None:
   334→        _greeting_service = GreetingService()
   335→    return _greeting_service
   336→
   337→
   338→async def generate_daily_greeting(
   339→    profile: Dict[str, Any],
   340→    greeting_type: str = "morning",
   341→    voice_mode: str = "warm",
   342→) -> DailyGreeting:
   343→    """Convenience function to generate daily greeting"""
   344→    service = get_greeting_service()
   345→    return await service.generate_greeting(
   346→        profile=profile,
   347→        greeting_type=greeting_type,
   348→        voice_mode=voice_mode,
   349→    )
   350→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
