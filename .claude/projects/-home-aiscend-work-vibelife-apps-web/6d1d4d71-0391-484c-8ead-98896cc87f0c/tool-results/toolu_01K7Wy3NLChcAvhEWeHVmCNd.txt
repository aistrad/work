     1→/**
     2→ * Skill Registry - Central registration and management of all skills
     3→ *
     4→ * This is the single source of truth for skill configuration
     5→ */
     6→
     7→import type {
     8→  SkillId,
     9→  SkillPlugin,
    10→  SkillRegistry,
    11→  PanelDefinition,
    12→  ToolDefinition,
    13→} from "./types";
    14→
    15→// Import skill plugins
    16→import { baziPlugin } from "./bazi";
    17→import { zodiacPlugin } from "./zodiac";
    18→
    19→// Import shared tools
    20→import { sharedTools } from "./shared-tools";
    21→
    22→// Import shared panels
    23→import { sharedPanels } from "./shared-panels";
    24→
    25→// ═══════════════════════════════════════════════════════════════════════════
    26→// Skill Registration
    27→// ═══════════════════════════════════════════════════════════════════════════
    28→
    29→const skillsMap = new Map<SkillId, SkillPlugin>();
    30→
    31→// Register all skills
    32→function registerSkill(plugin: SkillPlugin) {
    33→  skillsMap.set(plugin.id, plugin);
    34→}
    35→
    36→// Register built-in skills
    37→registerSkill(baziPlugin);
    38→registerSkill(zodiacPlugin);
    39→
    40→// ═══════════════════════════════════════════════════════════════════════════
    41→// Registry Implementation
    42→// ═══════════════════════════════════════════════════════════════════════════
    43→
    44→export const skillRegistry: SkillRegistry = {
    45→  getAll() {
    46→    return Array.from(skillsMap.values());
    47→  },
    48→
    49→  get(id: SkillId) {
    50→    return skillsMap.get(id);
    51→  },
    52→
    53→  getEnabled() {
    54→    return Array.from(skillsMap.values()).filter((s) => s.enabled);
    55→  },
    56→
    57→  isEnabled(id: SkillId) {
    58→    const skill = skillsMap.get(id);
    59→    return skill?.enabled ?? false;
    60→  },
    61→
    62→  // ─── Panel Helpers ────────────────────────────────────────────────────────
    63→
    64→  getSkillPanels(skillId: SkillId): PanelDefinition[] {
    65→    const skill = skillsMap.get(skillId);
    66→    return skill?.panels ?? [];
    67→  },
    68→
    69→  getAllPanels(skillId: SkillId): PanelDefinition[] {
    70→    const skill = skillsMap.get(skillId);
    71→    if (!skill) return sharedPanels;
    72→
    73→    // Filter shared panels based on skill's sharedFeatures config
    74→    const filteredSharedPanels = sharedPanels.filter((panel) => {
    75→      const features = skill.sharedFeatures;
    76→      if (!features) return true; // Default: all enabled
    77→
    78→      switch (panel.id) {
    79→        case "report":
    80→          return features.report !== false;
    81→        case "relationship":
    82→          return features.relationship !== false;
    83→        case "kline":
    84→          return features.kline !== false;
    85→        default:
    86→          return true;
    87→      }
    88→    });
    89→
    90→    // Merge and sort
    91→    const allPanels = [...filteredSharedPanels, ...skill.panels];
    92→    return allPanels.sort((a, b) => (a.order ?? 50) - (b.order ?? 50));
    93→  },
    94→
    95→  // ─── Tool Helpers ─────────────────────────────────────────────────────────
    96→
    97→  getSkillTools(skillId: SkillId): ToolDefinition[] {
    98→    const skill = skillsMap.get(skillId);
    99→    return skill?.tools ?? [];
   100→  },
   101→
   102→  getAllTools(skillId: SkillId): ToolDefinition[] {
   103→    const skill = skillsMap.get(skillId);
   104→    if (!skill) return sharedTools;
   105→
   106→    // Filter shared tools based on skill's sharedFeatures config
   107→    const filteredSharedTools = sharedTools.filter((tool) => {
   108→      const features = skill.sharedFeatures;
   109→      if (!features) return true;
   110→
   111→      // Match tool names to features
   112→      if (tool.name.includes("report") && features.report === false) return false;
   113→      if (tool.name.includes("relationship") && features.relationship === false) return false;
   114→      if (tool.name.includes("interview") && features.interview === false) return false;
   115→
   116→      return true;
   117→    });
   118→
   119→    return [...filteredSharedTools, ...skill.tools];
   120→  },
   121→
   122→  getTool(name: string): ToolDefinition | undefined {
   123→    // Search in shared tools first
   124→    const sharedTool = sharedTools.find((t) => t.name === name);
   125→    if (sharedTool) return sharedTool;
   126→
   127→    // Search in all skill tools
   128→    for (const skill of skillsMap.values()) {
   129→      const skillTool = skill.tools.find((t) => t.name === name);
   130→      if (skillTool) return skillTool;
   131→    }
   132→
   133→    return undefined;
   134→  },
   135→};
   136→
   137→// ═══════════════════════════════════════════════════════════════════════════
   138→// Utility Exports
   139→// ═══════════════════════════════════════════════════════════════════════════
   140→
   141→export function getSkillConfig(skillId: SkillId) {
   142→  return skillRegistry.get(skillId);
   143→}
   144→
   145→export function getSkillTheme(skillId: SkillId) {
   146→  const skill = skillRegistry.get(skillId);
   147→  return skill?.theme;
   148→}
   149→
   150→export function getSkillTools(skillId: SkillId) {
   151→  return skillRegistry.getAllTools(skillId);
   152→}
   153→
   154→export function getSkillPanels(skillId: SkillId) {
   155→  return skillRegistry.getAllPanels(skillId);
   156→}
   157→
   158→// Export default
   159→export default skillRegistry;
   160→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
