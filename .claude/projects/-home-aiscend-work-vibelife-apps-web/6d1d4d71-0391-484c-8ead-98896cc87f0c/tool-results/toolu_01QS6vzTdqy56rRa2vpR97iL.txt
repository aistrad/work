     1→# VibeLife UI/UX 架构设计 V4
     2→
     3→> **版本**: 4.0
     4→> **日期**: 2026-01-08
     5→> **基于**: AI SDK 6 + Next.js 14 App Router
     6→> **定位**: 前端架构设计的唯一真理来源
     7→
     8→---
     9→
    10→# Part 1: 需求总结
    11→
    12→## 1.1 核心需求
    13→
    14→```
    15→┌─────────────────────────────────────────────────────────────────────────────┐
    16→│                                                                             │
    17→│   核心需求                                                                  │
    18→│                                                                             │
    19→│   1. 独立站矩阵：bazi/zodiac/mbti 各自独立子域名，但共享用户数据            │
    20→│   2. 单页全功能：所有功能在同一主界面，Chat 为核心 + Panel Tab 为辅         │
    21→│   3. Chat 小程序：Chat 内可嵌入完整交互组件（如塔罗抽牌、K线图）            │
    22→│   4. 深度定制：每个 Skill 需要 2-4 周开发专属组件和交互流程                 │
    23→│   5. 共享基础：Auth/Payment/ChatEngine/ReportEngine 100% 复用              │
    24→│                                                                             │
    25→└─────────────────────────────────────────────────────────────────────────────┘
    26→```
    27→
    28→## 1.2 关键决策
    29→
    30→| 决策点 | 方案 |
    31→|-------|------|
    32→| **页面模式** | 单页 AppShell：Chat 为核心 + 可扩展 Panel Tab |
    33→| **Skill 切换** | 子域名跳转（独立站矩阵） |
    34→| **共享功能** | Report/Relationship/Greeting/Interview 默认全部启用 |
    35→| **专属功能** | 作为 Skill Plugin 的 `panels[]` 和 `tools[]` 注册 |
    36→| **Chat 卡片** | 使用 AI SDK 6 Generative UI（Tool → React Component） |
    37→| **开发流程** | 2-4 周深度定制，Plugin 模式解耦 |
    38→
    39→---
    40→
    41→# Part 2: AI SDK 6 兼容架构
    42→
    43→## 2.1 AI SDK 6 核心特性
    44→
    45→基于 [AI SDK 6 官方文档](https://vercel.com/blog/ai-sdk-6)，核心特性包括：
    46→
    47→```
    48→┌─────────────────────────────────────────────────────────────────────────────┐
    49→│                                                                             │
    50→│   AI SDK 6 核心特性                                                         │
    51→│                                                                             │
    52→│   1. Generative UI                                                          │
    53→│      • 工具结果渲染为自定义 React 组件                                      │
    54→│      • streamUI API 支持流式 UI 生成                                        │
    55→│      • 与 React Server Components 深度集成                                  │
    56→│                                                                             │
    57→│   2. Enhanced Tool Calling                                                  │
    58→│      • needsApproval: 人类审批机制                                          │
    59→│      • strict mode: 更可靠的输入生成                                        │
    60→│      • toModelOutput: 分离工具结果与模型输入                                │
    61→│                                                                             │
    62→│   3. useChat Hook                                                           │
    63→│      • 消息流式传输                                                         │
    64→│      • 自动状态管理                                                         │
    65→│      • 原生工具调用支持                                                     │
    66→│      • addToolApprovalResponse: UI 审批响应                                 │
    67→│                                                                             │
    68→│   4. MCP Support                                                            │
    69→│      • OAuth 认证                                                           │
    70→│      • Resources, Prompts, Elicitation                                      │
    71→│                                                                             │
    72→└─────────────────────────────────────────────────────────────────────────────┘
    73→```
    74→
    75→## 2.2 架构映射：Chat Cards → Generative UI
    76→
    77→**原设计（自定义 CardRenderer）：**
    78→```
    79→用户消息 → 后端返回 JSON { type: "bazi.kline", data: {...} } → 前端 CardRenderer 渲染
    80→```
    81→
    82→**AI SDK 6 方式（Generative UI）：**
    83→```
    84→用户消息 → 后端 Tool Call → Tool 返回数据 → AI SDK 自动渲染对应 React 组件
    85→```
    86→
    87→### 关键改动
    88→
    89→| 组件 | 原设计 | AI SDK 6 兼容设计 |
    90→|------|--------|------------------|
    91→| Chat Cards | 自定义 `CardRenderer` | AI SDK `tools` + Generative UI |
    92→| 卡片注册 | `CardRegistry.ts` | 工具定义中的 `render` 函数 |
    93→| 交互状态 | `CardProps.onAction` | `addToolApprovalResponse` |
    94→| 渲染时机 | 消息解析后 | 流式生成中 |
    95→
    96→---
    97→
    98→# Part 3: 架构全景图
    99→
   100→```
   101→╔═══════════════════════════════════════════════════════════════════════════════╗
   102→║                                                                               ║
   103→║   VIBELIFE FRONTEND ARCHITECTURE (AI SDK 6 Compatible)                        ║
   104→║                                                                               ║
   105→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
   106→║   │                                                                         │ ║
   107→║   │                        Skill Plugin Layer                               │ ║
   108→║   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │ ║
   109→║   │   │  BaZi   │  │ Zodiac  │  │  MBTI   │  │  Tarot  │  │  ...    │     │ ║
   110→║   │   │ Plugin  │  │ Plugin  │  │ Plugin  │  │ Plugin  │  │ Plugins │     │ ║
   111→║   │   │         │  │         │  │         │  │         │  │         │     │ ║
   112→║   │   │• Panels │  │• Panels │  │• Panels │  │• Panels │  │         │     │ ║
   113→║   │   │• Tools  │  │• Tools  │  │• Tools  │  │• Tools  │  │         │     │ ║
   114→║   │   │• Theme  │  │• Theme  │  │• Theme  │  │• Theme  │  │         │     │ ║
   115→║   │   │• Config │  │• Config │  │• Config │  │• Config │  │         │     │ ║
   116→║   │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘     │ ║
   117→║   │                              │                                         │ ║
   118→║   └──────────────────────────────┼─────────────────────────────────────────┘ ║
   119→║                                  ▼                                           ║
   120→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
   121→║   │                                                                         │ ║
   122→║   │                        Shared App Shell                                 │ ║
   123→║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
   124→║   │   │  ┌────────┐  ┌──────────────────────┐  ┌───────────────────┐   │   │ ║
   125→║   │   │  │ NavBar │  │     ChatContainer    │  │   ResizablePanel  │   │   │ ║
   126→║   │   │  │        │  │                      │  │                   │   │   │ ║
   127→║   │   │  │ • Tab  │  │  ┌────────────────┐  │  │  Tab: Chat|Chart  │   │   │ ║
   128→║   │   │  │ • Skill│  │  │  Message Flow  │  │  │      |Journey|Me  │   │   │ ║
   129→║   │   │  │   Logo │  │  │  + Tool UIs    │  │  │      |Report|...  │   │   │ ║
   130→║   │   │  │        │  │  │ (Generative UI)│  │  │                   │   │   │ ║
   131→║   │   │  │        │  │  └────────────────┘  │  │  ┌─────────────┐  │   │   │ ║
   132→║   │   │  │        │  │                      │  │  │ Panel       │  │   │   │ ║
   133→║   │   │  │        │  │  ┌────────────────┐  │  │  │ Content     │  │   │   │ ║
   134→║   │   │  │        │  │  │   ChatInput    │  │  │  │ (Dynamic)   │  │   │   │ ║
   135→║   │   │  │        │  │  └────────────────┘  │  │  └─────────────┘  │   │   │ ║
   136→║   │   │  └────────┘  └──────────────────────┘  └───────────────────┘   │   │ ║
   137→║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
   138→║   │                                                                         │ ║
   139→║   └─────────────────────────────────────────────────────────────────────────┘ ║
   140→║                                  │                                           ║
   141→║                                  ▼                                           ║
   142→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
   143→║   │                                                                         │ ║
   144→║   │                      AI SDK 6 Integration Layer                         │ ║
   145→║   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │ ║
   146→║   │   │ useChat │  │ streamUI│  │  Tools  │  │ToolLoop │  │  MCP    │     │ ║
   147→║   │   │  Hook   │  │   API   │  │ Registry│  │  Agent  │  │ Support │     │ ║
   148→║   │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘     │ ║
   149→║   │                                                                         │ ║
   150→║   └─────────────────────────────────────────────────────────────────────────┘ ║
   151→║                                  │                                           ║
   152→║                                  ▼                                           ║
   153→║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
   154→║   │                                                                         │ ║
   155→║   │                        Platform Foundation                              │ ║
   156→║   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐     │ ║
   157→║   │   │  Auth   │  │ Payment │  │  Vibe   │  │ Report  │  │  User   │     │ ║
   158→║   │   │Provider │  │ Gateway │  │ Engine  │  │ Engine  │  │ Profile │     │ ║
   159→║   │   └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘     │ ║
   160→║   │                                                                         │ ║
   161→║   └─────────────────────────────────────────────────────────────────────────┘ ║
   162→║                                                                               ║
   163→╚═══════════════════════════════════════════════════════════════════════════════╝
   164→```
   165→
   166→---
   167→
   168→# Part 4: 目录结构设计
   169→
   170→```
   171→apps/web/src/
   172→│
   173→├── app/                              # Next.js App Router
   174→│   ├── (skill)/                      # Skill 路由组（动态）
   175→│   │   └── [skill]/                  # 动态 Skill 参数
   176→│   │       ├── layout.tsx            # Skill Layout（注入 theme + plugins）
   177→│   │       └── page.tsx              # 主页面（AppShell）
   178→│   │
   179→│   ├── (shared)/                     # 共享路由
   180→│   │   ├── auth/                     # 认证相关
   181→│   │   ├── payment/                  # 支付相关
   182→│   │   └── share/[token]/            # 分享链接
   183→│   │
   184→│   ├── api/                          # API Routes
   185→│   │   └── chat/
   186→│   │       └── route.ts              # AI SDK 6 streamUI endpoint
   187→│   │
   188→│   └── layout.tsx                    # 根 Layout
   189→│
   190→├── skills/                           # ⭐ Skill 插件系统
   191→│   ├── registry.ts                   # Skill 注册中心
   192→│   ├── types.ts                      # 类型定义
   193→│   │
   194→│   ├── bazi/                         # 八字 Skill 插件
   195→│   │   ├── index.ts                  # 导出入口
   196→│   │   ├── config.ts                 # 配置（主题、图标、快捷问题）
   197→│   │   ├── panels/                   # 专属 Panel
   198→│   │   │   ├── KLinePanel.tsx        # 人生 K 线 Panel
   199→│   │   │   ├── FortunePanel.tsx      # 大运流年 Panel
   200→│   │   │   └── index.ts
   201→│   │   ├── tools/                    # ⭐ AI SDK 6 Tools（Generative UI）
   202→│   │   │   ├── show-bazi-chart.tsx   # 命盘展示工具
   203→│   │   │   ├── show-kline.tsx        # K 线展示工具
   204→│   │   │   ├── show-fortune.tsx      # 大运流年工具
   205→│   │   │   └── index.ts
   206→│   │   ├── components/               # 专属组件（被 tools 使用）
   207→│   │   │   ├── BaziChart.tsx
   208→│   │   │   ├── KLineChart.tsx
   209→│   │   │   └── FortuneTimeline.tsx
   210→│   │   └── theme.css                 # Skill 主题变量
   211→│   │
   212→│   ├── zodiac/                       # 星座 Skill 插件
   213→│   │   ├── index.ts
   214→│   │   ├── config.ts
   215→│   │   ├── panels/
   216→│   │   │   ├── TransitPanel.tsx
   217→│   │   │   └── SynastryPanel.tsx
   218→│   │   ├── tools/
   219→│   │   │   ├── show-zodiac-chart.tsx
   220→│   │   │   ├── show-transit.tsx
   221→│   │   │   └── show-synastry.tsx
   222→│   │   └── components/
   223→│   │
   224→│   ├── tarot/                        # 塔罗 Skill 插件
   225→│   │   ├── panels/
   226→│   │   │   └── DrawPanel.tsx
   227→│   │   ├── tools/
   228→│   │   │   ├── start-tarot-draw.tsx  # ⭐ 交互式抽牌工具
   229→│   │   │   └── show-tarot-result.tsx
   230→│   │   └── components/
   231→│   │       ├── TarotDeck.tsx
   232→│   │       └── TarotSpread.tsx
   233→│   │
   234→│   └── mbti/                         # MBTI Skill 插件
   235→│       ├── panels/
   236→│       │   └── TestPanel.tsx
   237→│       ├── tools/
   238→│       │   ├── start-mbti-test.tsx   # ⭐ 交互式测试工具
   239→│       │   └── show-mbti-result.tsx
   240→│       └── components/
   241→│
   242→├── shell/                            # ⭐ 共享 App Shell
   243→│   ├── AppShell.tsx                  # 主壳体
   244→│   ├── NavBar.tsx                    # 左侧导航
   245→│   ├── ChatArea.tsx                  # 中间对话区
   246→│   ├── PanelArea.tsx                 # 右侧面板区
   247→│   ├── PanelTabs.tsx                 # 面板 Tab 切换
   248→│   └── hooks/
   249→│       ├── useSkillPanels.ts
   250→│       └── useActivePanel.ts
   251→│
   252→├── chat/                             # ⭐ Chat 引擎（AI SDK 6）
   253→│   ├── ChatContainer.tsx             # Chat 容器
   254→│   ├── ChatInput.tsx                 # 输入框
   255→│   ├── MessageList.tsx               # 消息列表
   256→│   ├── Message.tsx                   # 单条消息（支持 Tool UI）
   257→│   │
   258→│   ├── tools/                        # 共享 Tools（所有 Skill 可用）
   259→│   │   ├── show-report.tsx           # 报告展示
   260→│   │   ├── show-relationship.tsx     # 关系分析
   261→│   │   ├── show-insight.tsx          # 洞察卡片
   262→│   │   ├── request-info.tsx          # 信息采集
   263→│   │   └── index.ts
   264→│   │
   265→│   └── hooks/
   266→│       ├── useVibeChat.ts            # AI SDK 6 useChat wrapper
   267→│       └── useToolApproval.ts        # 工具审批 Hook
   268→│
   269→├── components/                       # 共享组件
   270→│   ├── core/                         # 核心视觉组件
   271→│   ├── ui/                           # 基础 UI 组件
   272→│   ├── chart/                        # 通用图表组件
   273→│   └── report/                       # 报告组件
   274→│
   275→├── providers/                        # 全局 Provider
   276→│   ├── SkillProvider.tsx             # Skill 上下文
   277→│   ├── AuthProvider.tsx              # 认证上下文
   278→│   └── ChatProvider.tsx              # Chat 状态
   279→│
   280→└── lib/
   281→    ├── api.ts                        # API 客户端
   282→    ├── skill-loader.ts               # Skill 动态加载
   283→    └── tools-registry.ts             # ⭐ AI SDK 6 工具注册
   284→```
   285→
   286→---
   287→
   288→# Part 5: AI SDK 6 集成详解
   289→
   290→## 5.1 工具定义类型
   291→
   292→```typescript
   293→// skills/types.ts
   294→
   295→import { ComponentType } from "react";
   296→import { LucideIcon } from "lucide-react";
   297→import { tool } from "ai";
   298→import { z } from "zod";
   299→
   300→// ═══════════════════════════════════════════════════════════════════════════
   301→// Skill ID
   302→// ═══════════════════════════════════════════════════════════════════════════
   303→
   304→export type SkillId = "bazi" | "zodiac" | "mbti" | "tarot" | "attach" | "career";
   305→
   306→// ═══════════════════════════════════════════════════════════════════════════
   307→// Panel 定义
   308→// ═══════════════════════════════════════════════════════════════════════════
   309→
   310→export interface PanelDefinition {
   311→  id: string;
   312→  label: string;
   313→  icon: LucideIcon;
   314→  component: ComponentType<PanelProps>;
   315→  order?: number;
   316→  badge?: () => string | number | null;
   317→  requireAuth?: boolean;
   318→  requirePaid?: boolean;
   319→}
   320→
   321→export interface PanelProps {
   322→  skill: SkillId;
   323→  isActive: boolean;
   324→}
   325→
   326→// ═══════════════════════════════════════════════════════════════════════════
   327→// AI SDK 6 Tool 定义
   328→// ═══════════════════════════════════════════════════════════════════════════
   329→
   330→export interface ToolDefinition<TParams = any, TResult = any> {
   331→  // 工具元信息
   332→  name: string;
   333→  description: string;
   334→
   335→  // Zod schema for parameters
   336→  parameters: z.ZodSchema<TParams>;
   337→
   338→  // 执行函数
   339→  execute: (params: TParams) => Promise<TResult>;
   340→
   341→  // ⭐ Generative UI: 渲染函数
   342→  render?: (result: TResult) => React.ReactNode;
   343→
   344→  // 审批配置
   345→  needsApproval?: boolean | ((params: TParams) => boolean);
   346→
   347→  // 模型输出转换（可选）
   348→  toModelOutput?: (result: TResult) => string;
   349→}
   350→
   351→// ═══════════════════════════════════════════════════════════════════════════
   352→// Skill Plugin 完整定义
   353→// ═══════════════════════════════════════════════════════════════════════════
   354→
   355→export interface SkillPlugin {
   356→  // 基础信息
   357→  id: SkillId;
   358→  name: string;
   359→  subtitle: string;
   360→  icon: LucideIcon;
   361→  enabled: boolean;
   362→  beta?: boolean;
   363→
   364→  // 主题配置
   365→  theme: {
   366→    primary: string;
   367→    secondary: string;
   368→    glow: string;
   369→    gradient: string;
   370→  };
   371→
   372→  // 功能配置
   373→  features: {
   374→    quickPrompts: string[];
   375→    emptyState: {
   376→      title: string;
   377→      subtitle: string;
   378→      image?: string;
   379→    };
   380→  };
   381→
   382→  // 共享功能开关
   383→  sharedFeatures?: {
   384→    report?: boolean;
   385→    relationship?: boolean;
   386→    greeting?: boolean;
   387→    interview?: boolean;
   388→  };
   389→
   390→  // ⭐ 专属 Panel 注册
   391→  panels: PanelDefinition[];
   392→
   393→  // ⭐ 专属 Tools 注册（AI SDK 6 Generative UI）
   394→  tools: ToolDefinition[];
   395→
   396→  // 输入表单配置
   397→  inputForm?: {
   398→    fields: FormFieldDefinition[];
   399→    required: string[];
   400→  };
   401→}
   402→```
   403→
   404→## 5.2 八字工具示例（Generative UI）
   405→
   406→```typescript
   407→// skills/bazi/tools/show-kline.tsx
   408→
   409→import { z } from "zod";
   410→import { ToolDefinition } from "@/skills/types";
   411→import { KLineChart } from "../components/KLineChart";
   412→
   413→// 参数 Schema
   414→const KLineParams = z.object({
   415→  userId: z.string().describe("用户 ID"),
   416→  startYear: z.number().optional().describe("起始年份"),
   417→  endYear: z.number().optional().describe("结束年份"),
   418→});
   419→
   420→type KLineParamsType = z.infer<typeof KLineParams>;
   421→
   422→// K 线数据结构
   423→interface KLineResult {
   424→  userId: string;
   425→  data: {
   426→    year: number;
   427→    score: number;
   428→    majorLuck: string;
   429→    events: string[];
   430→  }[];
   431→  currentYear: number;
   432→  highlights: {
   433→    bestYear: number;
   434→    worstYear: number;
   435→    turningPoints: number[];
   436→  };
   437→}
   438→
   439→export const showKLineTool: ToolDefinition<KLineParamsType, KLineResult> = {
   440→  name: "show_bazi_kline",
   441→  description: "展示用户的人生 K 线图，显示过去和未来的运势趋势",
   442→
   443→  parameters: KLineParams,
   444→
   445→  async execute({ userId, startYear, endYear }) {
   446→    // 调用后端 API 获取 K 线数据
   447→    const response = await fetch(`/api/v1/fortune/kline`, {
   448→      method: "POST",
   449→      headers: { "Content-Type": "application/json" },
   450→      body: JSON.stringify({ userId, startYear, endYear }),
   451→    });
   452→
   453→    if (!response.ok) {
   454→      throw new Error("Failed to fetch K-line data");
   455→    }
   456→
   457→    return response.json();
   458→  },
   459→
   460→  // ⭐ Generative UI: 渲染 K 线图组件
   461→  render(result) {
   462→    return (
   463→      <div className="kline-card bg-card rounded-xl p-4 border shadow-sm">
   464→        <h3 className="text-lg font-semibold mb-4">你的人生 K 线</h3>
   465→        <KLineChart
   466→          data={result.data}
   467→          currentYear={result.currentYear}
   468→          highlights={result.highlights}
   469→        />
   470→        <div className="mt-4 flex gap-4 text-sm text-muted-foreground">
   471→          <span>最佳年份: {result.highlights.bestYear}</span>
   472→          <span>低谷年份: {result.highlights.worstYear}</span>
   473→        </div>
   474→      </div>
   475→    );
   476→  },
   477→
   478→  // 返回给模型的摘要（减少 token）
   479→  toModelOutput(result) {
   480→    return `已展示用户的人生 K 线图。最佳年份: ${result.highlights.bestYear}，低谷年份: ${result.highlights.worstYear}，转折点: ${result.highlights.turningPoints.join(", ")}`;
   481→  },
   482→};
   483→```
   484→
   485→## 5.3 塔罗抽牌工具（交互式 Generative UI）
   486→
   487→```typescript
   488→// skills/tarot/tools/start-tarot-draw.tsx
   489→
   490→import { z } from "zod";
   491→import { ToolDefinition } from "@/skills/types";
   492→import { TarotDrawInteractive } from "../components/TarotDrawInteractive";
   493→
   494→const TarotDrawParams = z.object({
   495→  question: z.string().describe("用户的问题"),
   496→  spreadType: z.enum(["single", "three", "celtic"]).describe("牌阵类型"),
   497→});
   498→
   499→type TarotDrawParamsType = z.infer<typeof TarotDrawParams>;
   500→
   501→interface TarotDrawResult {
   502→  sessionId: string;
   503→  question: string;
   504→  spreadType: string;
   505→  // 初始状态，卡片在用户抽取后填充
   506→  cards: null;
   507→}
   508→
   509→export const startTarotDrawTool: ToolDefinition<TarotDrawParamsType, TarotDrawResult> = {
   510→  name: "start_tarot_draw",
   511→  description: "开始塔罗牌抽牌流程，用户可以交互式地抽取卡牌",
   512→
   513→  parameters: TarotDrawParams,
   514→
   515→  async execute({ question, spreadType }) {
   516→    // 创建抽牌会话
   517→    const response = await fetch(`/api/v1/tarot/session`, {
   518→      method: "POST",
   519→      headers: { "Content-Type": "application/json" },
   520→      body: JSON.stringify({ question, spreadType }),
   521→    });
   522→
   523→    const session = await response.json();
   524→
   525→    return {
   526→      sessionId: session.id,
   527→      question,
   528→      spreadType,
   529→      cards: null,
   530→    };
   531→  },
   532→
   533→  // ⭐ 渲染交互式抽牌组件
   534→  render(result) {
   535→    return (
   536→      <TarotDrawInteractive
   537→        sessionId={result.sessionId}
   538→        question={result.question}
   539→        spreadType={result.spreadType as "single" | "three" | "celtic"}
   540→        onComplete={(cards) => {
   541→          // 抽牌完成后，可以触发新的消息或工具调用
   542→          console.log("Tarot draw complete:", cards);
   543→        }}
   544→      />
   545→    );
   546→  },
   547→
   548→  // 抽牌开始时返回给模型的信息
   549→  toModelOutput(result) {
   550→    return `已开始塔罗抽牌流程。问题: "${result.question}"，牌阵: ${result.spreadType}。等待用户抽牌...`;
   551→  },
   552→
   553→  // 需要用户交互，不需要模型审批
   554→  needsApproval: false,
   555→};
   556→```
   557→
   558→## 5.4 工具注册中心
   559→
   560→```typescript
   561→// lib/tools-registry.ts
   562→
   563→import { ToolDefinition, SkillId } from "@/skills/types";
   564→
   565→// 共享工具（所有 Skill 可用）
   566→import { showReportTool } from "@/chat/tools/show-report";
   567→import { showRelationshipTool } from "@/chat/tools/show-relationship";
   568→import { showInsightTool } from "@/chat/tools/show-insight";
   569→import { requestInfoTool } from "@/chat/tools/request-info";
   570→
   571→// Skill 专属工具
   572→import { baziTools } from "@/skills/bazi/tools";
   573→import { zodiacTools } from "@/skills/zodiac/tools";
   574→import { tarotTools } from "@/skills/tarot/tools";
   575→import { mbtiTools } from "@/skills/mbti/tools";
   576→
   577→// 共享工具列表
   578→const SHARED_TOOLS: ToolDefinition[] = [
   579→  showReportTool,
   580→  showRelationshipTool,
   581→  showInsightTool,
   582→  requestInfoTool,
   583→];
   584→
   585→// Skill 工具映射
   586→const SKILL_TOOLS: Record<SkillId, ToolDefinition[]> = {
   587→  bazi: baziTools,
   588→  zodiac: zodiacTools,
   589→  tarot: tarotTools,
   590→  mbti: mbtiTools,
   591→  attach: [],
   592→  career: [],
   593→};
   594→
   595→/**
   596→ * 获取指定 Skill 的所有可用工具
   597→ */
   598→export function getToolsForSkill(skillId: SkillId): ToolDefinition[] {
   599→  const skillTools = SKILL_TOOLS[skillId] || [];
   600→  return [...SHARED_TOOLS, ...skillTools];
   601→}
   602→
   603→/**
   604→ * 将 ToolDefinition 转换为 AI SDK 6 tool() 格式
   605→ */
   606→export function createAISDKTools(skillId: SkillId) {
   607→  const tools = getToolsForSkill(skillId);
   608→
   609→  return tools.reduce((acc, toolDef) => {
   610→    acc[toolDef.name] = {
   611→      description: toolDef.description,
   612→      parameters: toolDef.parameters,
   613→      execute: toolDef.execute,
   614→      // AI SDK 6 需要 render 在 streamUI 中使用
   615→    };
   616→    return acc;
   617→  }, {} as Record<string, any>);
   618→}
   619→
   620→/**
   621→ * 获取工具的渲染函数
   622→ */
   623→export function getToolRenderer(toolName: string, skillId: SkillId) {
   624→  const tools = getToolsForSkill(skillId);
   625→  const tool = tools.find(t => t.name === toolName);
   626→  return tool?.render;
   627→}
   628→```
   629→
   630→## 5.5 streamUI API Route
   631→
   632→```typescript
   633→// app/api/chat/route.ts
   634→
   635→import { streamUI } from "ai/rsc";
   636→import { createAISDKTools, getToolRenderer } from "@/lib/tools-registry";
   637→import { SkillId } from "@/skills/types";
   638→
   639→export async function POST(request: Request) {
   640→  const { messages, skill, voice_mode, conversation_id } = await request.json();
   641→
   642→  const skillId = skill as SkillId;
   643→  const tools = createAISDKTools(skillId);
   644→
   645→  const result = await streamUI({
   646→    model: openai("gpt-4o"),
   647→    messages,
   648→    tools,
   649→
   650→    // 系统提示（注入 Skill 和语气）
   651→    system: buildSystemPrompt(skillId, voice_mode),
   652→
   653→    // 工具结果渲染
   654→    toolChoice: "auto",
   655→
   656→    // 文本流式输出
   657→    text: ({ content, done }) => {
   658→      return <div className="prose">{content}</div>;
   659→    },
   660→
   661→    // 工具调用渲染
   662→    tools: Object.fromEntries(
   663→      Object.entries(tools).map(([name, toolConfig]) => [
   664→        name,
   665→        {
   666→          ...toolConfig,
   667→          render: async function* (args) {
   668→            // 显示加载状态
   669→            yield <div className="animate-pulse">处理中...</div>;
   670→
   671→            // 执行工具
   672→            const result = await toolConfig.execute(args);
   673→
   674→            // 获取渲染函数
   675→            const render = getToolRenderer(name, skillId);
   676→
   677→            // 返回最终 UI
   678→            return render ? render(result) : <pre>{JSON.stringify(result, null, 2)}</pre>;
   679→          },
   680→        },
   681→      ])
   682→    ),
   683→  });
   684→
   685→  return result.toDataStreamResponse();
   686→}
   687→```
   688→
   689→## 5.6 更新后的 useVibeChat Hook
   690→
   691→```typescript
   692→// chat/hooks/useVibeChat.ts
   693→
   694→"use client";
   695→
   696→import { useChat } from "@ai-sdk/react";
   697→import { useCallback, useMemo } from "react";
   698→import { getTokens } from "@/lib/api";
   699→
   700→export type SkillId = "bazi" | "zodiac" | "mbti" | "tarot" | "attach" | "career";
   701→export type VoiceMode = "warm" | "sarcastic";
   702→
   703→export interface UseVibeChatOptions {
   704→  skillId: SkillId;
   705→  voiceMode?: VoiceMode;
   706→  conversationId?: string;
   707→  onConversationStart?: (id: string) => void;
   708→  onError?: (error: Error) => void;
   709→  onFinish?: () => void;
   710→  // ⭐ AI SDK 6: 工具审批回调
   711→  onToolCall?: (toolCall: ToolCallInfo) => void;
   712→}
   713→
   714→interface ToolCallInfo {
   715→  toolName: string;
   716→  args: any;
   717→  toolCallId: string;
   718→}
   719→
   720→export function useVibeChat({
   721→  skillId,
   722→  voiceMode = "warm",
   723→  conversationId,
   724→  onConversationStart,
   725→  onError,
   726→  onFinish,
   727→  onToolCall,
   728→}: UseVibeChatOptions) {
   729→  const { accessToken } = getTokens();
   730→
   731→  // AI SDK 6 useChat hook
   732→  const chat = useChat({
   733→    id: conversationId,
   734→    api: "/api/chat",
   735→    headers: accessToken ? { Authorization: `Bearer ${accessToken}` } : undefined,
   736→    body: {
   737→      skill: skillId,
   738→      voice_mode: voiceMode,
   739→      conversation_id: conversationId,
   740→    },
   741→
   742→    onFinish: (message) => {
   743→      const metadata = message?.experimental_providerMetadata;
   744→      if (metadata?.conversation_id && onConversationStart) {
   745→        onConversationStart(metadata.conversation_id as string);
   746→      }
   747→      onFinish?.();
   748→    },
   749→
   750→    onError: (error) => {
   751→      console.error("Chat error:", error);
   752→      onError?.(error);
   753→    },
   754→
   755→    // ⭐ AI SDK 6: 工具调用处理
   756→    onToolCall: ({ toolCall }) => {
   757→      onToolCall?.({
   758→        toolName: toolCall.toolName,
   759→        args: toolCall.args,
   760→        toolCallId: toolCall.toolCallId,
   761→      });
   762→    },
   763→  });
   764→
   765→  // ⭐ AI SDK 6: 添加工具审批响应
   766→  const approveToolCall = useCallback(
   767→    (toolCallId: string, approved: boolean, result?: any) => {
   768→      chat.addToolResult({
   769→        toolCallId,
   770→        result: approved ? result : { error: "User rejected" },
   771→      });
   772→    },
   773→    [chat]
   774→  );
   775→
   776→  // 发送消息
   777→  const sendVibeMessage = useCallback(
   778→    async (content: string) => {
   779→      return chat.append({
   780→        role: "user",
   781→        content,
   782→      });
   783→    },
   784→    [chat]
   785→  );
   786→
   787→  // 快捷提示
   788→  const sendQuickPrompt = useCallback(
   789→    async (content: string) => {
   790→      chat.setMessages([]);
   791→      return sendVibeMessage(content);
   792→    },
   793→    [chat, sendVibeMessage]
   794→  );
   795→
   796→  const isLoading = chat.isLoading;
   797→
   798→  return {
   799→    // Core state
   800→    messages: chat.messages,
   801→    isLoading,
   802→    error: chat.error,
   803→
   804→    // Actions
   805→    sendMessage: sendVibeMessage,
   806→    sendQuickPrompt,
   807→    stop: chat.stop,
   808→    reload: chat.reload,
   809→
   810→    // ⭐ AI SDK 6: 工具审批
   811→    approveToolCall,
   812→    addToolResult: chat.addToolResult,
   813→
   814→    // For advanced use
   815→    setMessages: chat.setMessages,
   816→
   817→    // Metadata
   818→    conversationId,
   819→    skillId,
   820→    voiceMode,
   821→  };
   822→}
   823→
   824→export default useVibeChat;
   825→```
   826→
   827→---
   828→
   829→# Part 6: 消息渲染（支持 Tool UI）
   830→
   831→```typescript
   832→// chat/Message.tsx
   833→
   834→"use client";
   835→
   836→import { Message as AIMessage } from "ai";
   837→import { cn } from "@/lib/utils";
   838→import { SkillId } from "@/skills/types";
   839→
   840→interface MessageProps {
   841→  message: AIMessage;
   842→  skill: SkillId;
   843→  isLast?: boolean;
   844→}
   845→
   846→export function Message({ message, skill, isLast }: MessageProps) {
   847→  const isUser = message.role === "user";
   848→  const isAssistant = message.role === "assistant";
   849→
   850→  return (
   851→    <div
   852→      className={cn(
   853→        "flex gap-3 p-4",
   854→        isUser && "flex-row-reverse"
   855→      )}
   856→    >
   857→      {/* Avatar */}
   858→      <div className={cn(
   859→        "w-8 h-8 rounded-full flex-shrink-0",
   860→        isUser ? "bg-primary" : "bg-skill-primary"
   861→      )}>
   862→        {/* Avatar content */}
   863→      </div>
   864→
   865→      {/* Content */}
   866→      <div className={cn(
   867→        "flex-1 max-w-[80%]",
   868→        isUser && "text-right"
   869→      )}>
   870→        {/* 文本内容 */}
   871→        {message.content && (
   872→          <div className={cn(
   873→            "prose prose-sm",
   874→            isUser && "bg-primary text-primary-foreground rounded-2xl px-4 py-2 inline-block"
   875→          )}>
   876→            {message.content}
   877→          </div>
   878→        )}
   879→
   880→        {/* ⭐ AI SDK 6: 工具调用 UI (Generative UI) */}
   881→        {message.toolInvocations?.map((toolInvocation) => (
   882→          <div key={toolInvocation.toolCallId} className="mt-3">
   883→            {toolInvocation.state === "pending" && (
   884→              <div className="animate-pulse bg-muted rounded-xl p-4">
   885→                正在处理...
   886→              </div>
   887→            )}
   888→
   889→            {toolInvocation.state === "result" && (
   890→              <div className="tool-result">
   891→                {/* 工具结果由 streamUI 的 render 函数生成 */}
   892→                {toolInvocation.result}
   893→              </div>
   894→            )}
   895→
   896→            {/* 需要审批的工具 */}
   897→            {toolInvocation.state === "call" && toolInvocation.toolName.startsWith("confirm_") && (
   898→              <ToolApprovalCard
   899→                toolName={toolInvocation.toolName}
   900→                args={toolInvocation.args}
   901→                toolCallId={toolInvocation.toolCallId}
   902→              />
   903→            )}
   904→          </div>
   905→        ))}
   906→      </div>
   907→    </div>
   908→  );
   909→}
   910→
   911→// 工具审批卡片
   912→function ToolApprovalCard({ toolName, args, toolCallId }: {
   913→  toolName: string;
   914→  args: any;
   915→  toolCallId: string;
   916→}) {
   917→  const { approveToolCall } = useVibeChat({ skillId: "bazi" }); // 从 context 获取
   918→
   919→  return (
   920→    <div className="bg-yellow-50 border border-yellow-200 rounded-xl p-4">
   921→      <p className="font-medium">需要确认操作</p>
   922→      <p className="text-sm text-muted-foreground mt-1">
   923→        {toolName}: {JSON.stringify(args)}
   924→      </p>
   925→      <div className="flex gap-2 mt-3">
   926→        <button
   927→          onClick={() => approveToolCall(toolCallId, true)}
   928→          className="px-3 py-1 bg-primary text-primary-foreground rounded"
   929→        >
   930→          确认
   931→        </button>
   932→        <button
   933→          onClick={() => approveToolCall(toolCallId, false)}
   934→          className="px-3 py-1 bg-muted rounded"
   935→        >
   936→          取消
   937→        </button>
   938→      </div>
   939→    </div>
   940→  );
   941→}
   942→```
   943→
   944→---
   945→
   946→# Part 7: Panel Tab 系统
   947→
   948→```typescript
   949→// shell/PanelTabs.tsx
   950→
   951→"use client";
   952→
   953→import { useMemo } from "react";
   954→import { cn } from "@/lib/utils";
   955→import { useSkillRegistry, useCurrentSkill } from "@/providers/SkillProvider";
   956→import { PanelDefinition } from "@/skills/types";
   957→import {
   958→  MessageSquare,
   959→  Target,
   960→  FileText,
   961→  Heart,
   962→  Map,
   963→  User,
   964→} from "lucide-react";
   965→
   966→// 共享 Panel
   967→import { ChatPanel } from "@/components/layout/panels/ChatPanel";
   968→import { ChartPanel } from "@/components/layout/panels/ChartPanel";
   969→import { JourneyPanel } from "@/components/layout/panels/JourneyPanel";
   970→import { MePanel } from "@/components/layout/panels/MePanel";
   971→import { ReportPanel } from "@/components/layout/panels/ReportPanel";
   972→import { RelationshipPanel } from "@/components/layout/panels/RelationshipPanel";
   973→
   974→const SHARED_PANELS: PanelDefinition[] = [
   975→  { id: "chat", label: "对话", icon: MessageSquare, component: ChatPanel, order: 0 },
   976→  { id: "chart", label: "命盘", icon: Target, component: ChartPanel, order: 1 },
   977→  { id: "report", label: "报告", icon: FileText, component: ReportPanel, order: 2 },
   978→  { id: "relationship", label: "关系", icon: Heart, component: RelationshipPanel, order: 3 },
   979→  { id: "journey", label: "旅程", icon: Map, component: JourneyPanel, order: 4 },
   980→  { id: "me", label: "我", icon: User, component: MePanel, order: 100 },
   981→];
   982→
   983→interface PanelTabsProps {
   984→  activePanel: string;
   985→  onPanelChange: (panelId: string) => void;
   986→}
   987→
   988→export function PanelTabs({ activePanel, onPanelChange }: PanelTabsProps) {
   989→  const registry = useSkillRegistry();
   990→  const currentSkill = useCurrentSkill();
   991→
   992→  // 合并共享 Panel 和 Skill 专属 Panel
   993→  const allPanels = useMemo(() => {
   994→    const skillPlugin = registry.get(currentSkill);
   995→    const skillPanels = skillPlugin?.panels || [];
   996→
   997→    // 过滤掉 Skill 禁用的共享功能
   998→    const enabledSharedPanels = SHARED_PANELS.filter(panel => {
   999→      if (panel.id === "report" && skillPlugin?.sharedFeatures?.report === false) {
  1000→        return false;
  1001→      }
  1002→      if (panel.id === "relationship" && skillPlugin?.sharedFeatures?.relationship === false) {
  1003→        return false;
  1004→      }
  1005→      return true;
  1006→    });
  1007→
  1008→    // 合并并排序
  1009→    return [...enabledSharedPanels, ...skillPanels].sort((a, b) =>
  1010→      (a.order ?? 50) - (b.order ?? 50)
  1011→    );
  1012→  }, [registry, currentSkill]);
  1013→
  1014→  return (
  1015→    <div className="flex items-center gap-1 p-1 bg-muted/50 rounded-lg overflow-x-auto">
  1016→      {allPanels.map(panel => (
  1017→        <button
  1018→          key={panel.id}
  1019→          onClick={() => onPanelChange(panel.id)}
  1020→          className={cn(
  1021→            "flex items-center gap-2 px-3 py-1.5 rounded-md text-sm transition-colors whitespace-nowrap",
  1022→            activePanel === panel.id
  1023→              ? "bg-background shadow-sm text-foreground"
  1024→              : "text-muted-foreground hover:text-foreground"
  1025→          )}
  1026→        >
  1027→          <panel.icon className="w-4 h-4" />
  1028→          <span className="hidden sm:inline">{panel.label}</span>
  1029→        </button>
  1030→      ))}
  1031→    </div>
  1032→  );
  1033→}
  1034→```
  1035→
  1036→---
  1037→
  1038→# Part 8: 新增 Skill 开发流程
  1039→
  1040→```
  1041→┌─────────────────────────────────────────────────────────────────────────────┐
  1042→│                                                                             │
  1043→│   新增 MBTI Skill 的开发步骤（2-4 周）                                      │
  1044→│                                                                             │
  1045→│   Week 1: 基础配置                                                          │
  1046→│   ─────────────────────────────────────────────────────────────────────     │
  1047→│   □ 创建 skills/mbti/ 目录                                                  │
  1048→│   □ 编写 config.ts（主题、图标、快捷问题）                                  │
  1049→│   □ 编写 theme.css（CSS 变量）                                              │
  1050→│   □ 在 registry.ts 注册                                                     │
  1051→│   □ 基础对话可用                                                            │
  1052→│                                                                             │
  1053→│   Week 2: 专属 Tools（Generative UI）                                       │
  1054→│   ─────────────────────────────────────────────────────────────────────     │
  1055→│   □ 开发 start-mbti-test.tsx（交互式测试工具）                              │
  1056→│   □ 开发 show-mbti-result.tsx（结果展示工具）                               │
  1057→│   □ 开发 show-cognitive-stack.tsx（认知功能栈）                             │
  1058→│   □ 在 tools/index.ts 导出                                                  │
  1059→│                                                                             │
  1060→│   Week 3: 专属 Panel + 组件                                                 │
  1061→│   ─────────────────────────────────────────────────────────────────────     │
  1062→│   □ 开发 TestPanel（完整测试流程面板）                                      │
  1063→│   □ 开发 CareerPanel（职业匹配面板）                                        │
  1064→│   □ 开发 MbtiRadarChart 组件                                                │
  1065→│   □ 开发 CognitiveStackChart 组件                                           │
  1066→│                                                                             │
  1067→│   Week 4: 联调测试                                                          │
  1068→│   ─────────────────────────────────────────────────────────────────────     │
  1069→│   □ 后端 API 联调                                                           │
  1070→│   □ 知识库 RAG 联调                                                         │
  1071→│   □ 端到端测试                                                              │
  1072→│   □ 上线 beta                                                               │
  1073→│                                                                             │
  1074→└─────────────────────────────────────────────────────────────────────────────┘
  1075→```
  1076→
  1077→---
  1078→
  1079→# Part 9: 兼容性检查清单
  1080→
  1081→## AI SDK 6 特性兼容性
  1082→
  1083→| AI SDK 6 特性 | 架构支持 | 说明 |
  1084→|--------------|---------|------|
  1085→| `useChat` Hook | ✅ | `useVibeChat` 基于 `useChat` |
  1086→| `streamUI` API | ✅ | `/api/chat/route.ts` 使用 `streamUI` |
  1087→| Tool Calling | ✅ | `ToolDefinition` 类型支持 |
  1088→| Generative UI | ✅ | `ToolDefinition.render` 渲染 React 组件 |
  1089→| `needsApproval` | ✅ | 工具定义支持审批配置 |
  1090→| `addToolResult` | ✅ | `useVibeChat.approveToolCall` 封装 |
  1091→| `toModelOutput` | ✅ | `ToolDefinition.toModelOutput` 支持 |
  1092→| Strict Mode | ✅ | Zod schema 自动严格 |
  1093→| MCP Support | ⚠️ | 需要后续扩展 |
  1094→
  1095→## 当前代码需要的调整
  1096→
  1097→| 文件 | 调整内容 |
  1098→|------|---------|
  1099→| `app/api/chat/route.ts` | 从自定义实现改为 `streamUI` |
  1100→| `useVibeChat.ts` | 添加 `addToolResult`、`approveToolCall` |
  1101→| `Message.tsx` | 支持 `toolInvocations` 渲染 |
  1102→| `skills/*/tools/` | 创建 Skill 专属工具目录 |
  1103→| `lib/tools-registry.ts` | 新增工具注册中心 |
  1104→
  1105→---
  1106→
  1107→# Part 10: 参考资源
  1108→
  1109→- [AI SDK 6 官方文档](https://ai-sdk.dev/docs/introduction)
  1110→- [AI SDK 6 发布博客](https://vercel.com/blog/ai-sdk-6)
  1111→- [Generative UI 教程](https://vercel.com/academy/ai-sdk/multi-step-and-generative-ui)
  1112→- [Tool Calling 文档](https://sdk.vercel.ai/docs/ai-sdk-ui/chatbot-with-tool-calling)
  1113→- [streamUI API 参考](https://ai-sdk.dev/docs/reference/ai-sdk-rsc/stream-ui)
  1114→
  1115→---
  1116→
  1117→> **文档版本**: 4.0
  1118→> **创建日期**: 2026-01-08
  1119→> **作者**: Architecture Team
  1120→> **下一步**: 按 Part 9 调整清单进行代码迁移
  1121→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
