     1→"""
     2→Report Service - Core report generation logic
     3→Based on: vibelife spec v3.0, section 4.6
     4→
     5→Report Types:
     6→1. 简版报告 (lite): Free, limited content
     7→2. 完整报告 (full): Paid, complete analysis
     8→
     9→Report Sections (八字):
    10→- 命盘结构: 天干地支、五行分布、十神关系
    11→- 性格解读: 日主特质、内外矛盾、核心驱动
    12→- 运势分析: 当前大运、流年影响、关键节点
    13→- 行动建议: 适合方向、注意事项、发展策略
    14→
    15→Report Sections (星座):
    16→- 星盘结构: 太阳/月亮/上升、行星分布、宫位
    17→- 性格解读: 核心特质、情绪模式、关系倾向
    18→- 周期分析: 当前天象、重要过境、关键时间
    19→- 行动建议: 成长方向、关系策略、时机把握
    20→"""
    21→
    22→import json
    23→import logging
    24→from dataclasses import dataclass, field, asdict
    25→from typing import Optional, List, Dict, Any
    26→from uuid import UUID, uuid4
    27→from datetime import datetime
    28→from enum import Enum
    29→
    30→from ..vibe_engine import get_llm_service, create_system_message, create_user_message
    31→
    32→logger = logging.getLogger(__name__)
    33→
    34→
    35→# ═══════════════════════════════════════════════════════════════════════════
    36→# Enums and Constants
    37→# ═══════════════════════════════════════════════════════════════════════════
    38→
    39→class ReportType(str, Enum):
    40→    LITE = "lite"      # 简版 (免费)
    41→    FULL = "full"      # 完整版 (付费)
    42→
    43→
    44→class ReportStatus(str, Enum):
    45→    PENDING = "pending"
    46→    GENERATING = "generating"
    47→    COMPLETED = "completed"
    48→    FAILED = "failed"
    49→
    50→
    51→class ReportSkill(str, Enum):
    52→    BAZI = "bazi"
    53→    ZODIAC = "zodiac"
    54→
    55→
    56→# Section definitions by skill
    57→BAZI_SECTIONS = [
    58→    ("chart_structure", "命盘结构", "天干地支、五行分布、十神关系"),
    59→    ("personality", "性格解读", "日主特质、内外矛盾、核心驱动"),
    60→    ("fortune", "运势分析", "当前大运、流年影响、关键节点"),
    61→    ("action", "行动建议", "适合方向、注意事项、发展策略"),
    62→]
    63→
    64→ZODIAC_SECTIONS = [
    65→    ("chart_structure", "星盘结构", "太阳/月亮/上升、行星分布、宫位"),
    66→    ("personality", "性格解读", "核心特质、情绪模式、关系倾向"),
    67→    ("cycle", "周期分析", "当前天象、重要过境、关键时间"),
    68→    ("action", "行动建议", "成长方向、关系策略、时机把握"),
    69→]
    70→
    71→
    72→# ═══════════════════════════════════════════════════════════════════════════
    73→# Data Models
    74→# ═══════════════════════════════════════════════════════════════════════════
    75→
    76→@dataclass
    77→class ReportSection:
    78→    """Single section of a report"""
    79→    id: str
    80→    title: str
    81→    subtitle: str
    82→    content: str
    83→    score: Optional[int] = None  # 0-100 for some sections
    84→    highlights: List[str] = field(default_factory=list)
    85→    is_premium: bool = False  # Whether this section is behind paywall
    86→
    87→    def to_dict(self) -> dict:
    88→        return asdict(self)
    89→
    90→
    91→@dataclass
    92→class Report:
    93→    """Complete report"""
    94→    id: UUID
    95→    user_id: UUID
    96→    skill: ReportSkill
    97→    report_type: ReportType
    98→    status: ReportStatus
    99→
   100→    # Content
   101→    prologue: str  # 综合判断卷首语 (always visible)
   102→    sections: List[ReportSection] = field(default_factory=list)
   103→
   104→    # Metadata
   105→    profile_snapshot: Dict[str, Any] = field(default_factory=dict)
   106→    interview_summary: Optional[str] = None
   107→
   108→    # AI Generated Image
   109→    poster_url: Optional[str] = None
   110→    poster_thumbnail_url: Optional[str] = None
   111→
   112→    # Timestamps
   113→    created_at: datetime = field(default_factory=datetime.now)
   114→    completed_at: Optional[datetime] = None
   115→
   116→    def to_dict(self) -> dict:
   117→        return {
   118→            "id": str(self.id),
   119→            "user_id": str(self.user_id),
   120→            "skill": self.skill.value,
   121→            "report_type": self.report_type.value,
   122→            "status": self.status.value,
   123→            "prologue": self.prologue,
   124→            "sections": [s.to_dict() for s in self.sections],
   125→            "profile_snapshot": self.profile_snapshot,
   126→            "interview_summary": self.interview_summary,
   127→            "poster_url": self.poster_url,
   128→            "poster_thumbnail_url": self.poster_thumbnail_url,
   129→            "created_at": self.created_at.isoformat(),
   130→            "completed_at": self.completed_at.isoformat() if self.completed_at else None,
   131→        }
   132→
   133→    def to_lite_dict(self) -> dict:
   134→        """Return lite version (hide premium sections)"""
   135→        visible_sections = []
   136→        for section in self.sections:
   137→            if section.is_premium:
   138→                # Show placeholder for premium content
   139→                visible_sections.append({
   140→                    "id": section.id,
   141→                    "title": section.title,
   142→                    "subtitle": section.subtitle,
   143→                    "content": "...",  # Hidden
   144→                    "is_premium": True,
   145→                    "locked": True,
   146→                })
   147→            else:
   148→                visible_sections.append(section.to_dict())
   149→
   150→        return {
   151→            "id": str(self.id),
   152→            "user_id": str(self.user_id),
   153→            "skill": self.skill.value,
   154→            "report_type": "lite",
   155→            "status": self.status.value,
   156→            "prologue": self.prologue,  # Always visible - this is the hook
   157→            "sections": visible_sections,
   158→            "poster_url": None,  # Watermarked or hidden for lite
   159→            "poster_thumbnail_url": self.poster_thumbnail_url,  # Show thumbnail with watermark
   160→            "created_at": self.created_at.isoformat(),
   161→        }
   162→
   163→
   164→# ═══════════════════════════════════════════════════════════════════════════
   165→# Prompts
   166→# ═══════════════════════════════════════════════════════════════════════════
   167→
   168→REPORT_SYSTEM_PROMPT = """你是 VibeLife 的报告生成专家。你需要基于用户的命理信息和访谈内容，生成深度、专业、有洞察力的分析报告。
   169→
   170→风格要求:
   171→- 专业但不晦涩，用通俗易懂的语言解释命理概念
   172→- 有洞察力，能看到表象背后的本质
   173→- 有温度，让用户感到被理解
   174→- 有行动力，给出具体可执行的建议
   175→
   176→输出格式:
   177→你的输出必须是有效的 JSON 格式。"""
   178→
   179→SECTION_PROMPT_TEMPLATE = """请为用户生成报告的「{section_title}」部分。
   180→
   181→用户信息:
   182→{user_profile}
   183→
   184→访谈摘要:
   185→{interview_summary}
   186→
   187→章节要求:
   188→- 标题: {section_title}
   189→- 副标题: {section_subtitle}
   190→- 内容长度: 300-500字
   191→- 需要包含 2-3 个核心洞察点 (highlights)
   192→- 如果适用，给出一个 0-100 的评分
   193→
   194→请以 JSON 格式输出:
   195→{{
   196→    "content": "章节正文内容...",
   197→    "highlights": ["核心洞察1", "核心洞察2", "核心洞察3"],
   198→    "score": 75
   199→}}"""
   200→
   201→
   202→# ═══════════════════════════════════════════════════════════════════════════
   203→# Report Service
   204→# ═══════════════════════════════════════════════════════════════════════════
   205→
   206→class ReportService:
   207→    """Main service for report generation"""
   208→
   209→    def __init__(self):
   210→        self._llm = None
   211→        self._prologue_generator = None
   212→        self._image_generator = None
   213→
   214→    @property
   215→    def llm(self):
   216→        if self._llm is None:
   217→            self._llm = get_llm_service()
   218→        return self._llm
   219→
   220→    async def generate_report(
   221→        self,
   222→        user_id: UUID,
   223→        skill: str,
   224→        report_type: str,
   225→        profile: Dict[str, Any],
   226→        interview_result: Optional[Dict[str, Any]] = None,
   227→    ) -> Report:
   228→        """
   229→        Generate a complete report.
   230→
   231→        Args:
   232→            user_id: User ID
   233→            skill: "bazi" or "zodiac"
   234→            report_type: "lite" or "full"
   235→            profile: User profile data
   236→            interview_result: Optional interview summary
   237→
   238→        Returns:
   239→            Generated Report
   240→        """
   241→        report_id = uuid4()
   242→        skill_enum = ReportSkill(skill)
   243→        type_enum = ReportType(report_type)
   244→
   245→        # Create initial report
   246→        report = Report(
   247→            id=report_id,
   248→            user_id=user_id,
   249→            skill=skill_enum,
   250→            report_type=type_enum,
   251→            status=ReportStatus.GENERATING,
   252→            prologue="",
   253→            sections=[],
   254→            profile_snapshot=profile,
   255→            interview_summary=interview_result.get("summary") if interview_result else None,
   256→        )
   257→
   258→        try:
   259→            # Step 1: Generate prologue (always included)
   260→            from .prologue_generator import PrologueGenerator
   261→            prologue_gen = PrologueGenerator()
   262→            report.prologue = await prologue_gen.generate(
   263→                profile=profile,
   264→                skill=skill,
   265→                interview_summary=report.interview_summary,
   266→            )
   267→
   268→            # Step 2: Generate sections
   269→            sections = BAZI_SECTIONS if skill == "bazi" else ZODIAC_SECTIONS
   270→
   271→            for i, (section_id, title, subtitle) in enumerate(sections):
   272→                # For lite reports, only generate first 2 sections fully
   273→                is_premium = type_enum == ReportType.LITE and i >= 2
   274→
   275→                if is_premium and type_enum == ReportType.LITE:
   276→                    # Placeholder for premium content
   277→                    section = ReportSection(
   278→                        id=section_id,
   279→                        title=title,
   280→                        subtitle=subtitle,
   281→                        content="解锁完整报告查看更多内容...",
   282→                        is_premium=True,
   283→                    )
   284→                else:
   285→                    # Generate actual content
   286→                    section = await self._generate_section(
   287→                        section_id=section_id,
   288→                        title=title,
   289→                        subtitle=subtitle,
   290→                        profile=profile,
   291→                        interview_summary=report.interview_summary,
   292→                        skill=skill,
   293→                    )
   294→                    section.is_premium = is_premium
   295→
   296→                report.sections.append(section)
   297→
   298→            # Step 3: Generate AI poster (for full reports)
   299→            if type_enum == ReportType.FULL:
   300→                from .image_generator import ImageGenerator
   301→                img_gen = ImageGenerator()
   302→                image_result = await img_gen.generate_poster(
   303→                    profile=profile,
   304→                    skill=skill,
   305→                    prologue=report.prologue,
   306→                )
   307→                if image_result:
   308→                    report.poster_url = image_result.url
   309→                    report.poster_thumbnail_url = image_result.thumbnail_url
   310→
   311→            report.status = ReportStatus.COMPLETED
   312→            report.completed_at = datetime.now()
   313→
   314→        except Exception as e:
   315→            logger.error(f"Report generation failed: {e}")
   316→            report.status = ReportStatus.FAILED
   317→            raise
   318→
   319→        return report
   320→
   321→    async def _generate_section(
   322→        self,
   323→        section_id: str,
   324→        title: str,
   325→        subtitle: str,
   326→        profile: Dict[str, Any],
   327→        interview_summary: Optional[str],
   328→        skill: str,
   329→    ) -> ReportSection:
   330→        """Generate a single report section"""
   331→
   332→        prompt = SECTION_PROMPT_TEMPLATE.format(
   333→            section_title=title,
   334→            section_subtitle=subtitle,
   335→            user_profile=json.dumps(profile, ensure_ascii=False, indent=2),
   336→            interview_summary=interview_summary or "无访谈内容",
   337→        )
   338→
   339→        messages = [
   340→            create_system_message(REPORT_SYSTEM_PROMPT),
   341→            create_user_message(prompt),
   342→        ]
   343→
   344→        try:
   345→            response = await self.llm.chat(messages)
   346→
   347→            # Parse JSON response
   348→            content_json = response.content.strip()
   349→            if content_json.startswith("```"):
   350→                # Remove markdown code blocks
   351→                content_json = content_json.split("```")[1]
   352→                if content_json.startswith("json"):
   353→                    content_json = content_json[4:]
   354→
   355→            data = json.loads(content_json)
   356→
   357→            return ReportSection(
   358→                id=section_id,
   359→                title=title,
   360→                subtitle=subtitle,
   361→                content=data.get("content", ""),
   362→                score=data.get("score"),
   363→                highlights=data.get("highlights", []),
   364→            )
   365→
   366→        except Exception as e:
   367→            logger.error(f"Section generation failed: {e}")
   368→            # Return fallback section
   369→            return ReportSection(
   370→                id=section_id,
   371→                title=title,
   372→                subtitle=subtitle,
   373→                content=f"正在生成{title}内容...",
   374→                highlights=[],
   375→            )
   376→
   377→    async def upgrade_report(
   378→        self,
   379→        report_id: UUID,
   380→        user_id: UUID,
   381→    ) -> Report:
   382→        """
   383→        Upgrade a lite report to full.
   384→        Called after payment is confirmed.
   385→        """
   386→        # TODO: Load existing report from database
   387→        # For now, regenerate full report
   388→        # In production, you'd unlock the existing content
   389→        raise NotImplementedError("Report upgrade requires database integration")
   390→
   391→    def get_sections_for_skill(self, skill: str) -> List[tuple]:
   392→        """Get section definitions for a skill"""
   393→        if skill == "bazi":
   394→            return BAZI_SECTIONS
   395→        return ZODIAC_SECTIONS
   396→
   397→
   398→# ═══════════════════════════════════════════════════════════════════════════
   399→# Singleton
   400→# ═══════════════════════════════════════════════════════════════════════════
   401→
   402→_report_service: Optional[ReportService] = None
   403→
   404→
   405→def get_report_service() -> ReportService:
   406→    """Get singleton report service instance"""
   407→    global _report_service
   408→    if _report_service is None:
   409→        _report_service = ReportService()
   410→    return _report_service
   411→

<system-reminder>
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
</system-reminder>
