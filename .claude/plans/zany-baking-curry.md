# Proactive æ¨¡å— v3.0 ä»£ç å®ç°å®¡æŸ¥æŠ¥å‘Š

> åŸºäºä»¥ä¸‹è§„èŒƒçš„å…¨é¢å¯¹æ¯”å®¡æŸ¥ï¼š
> - `/home/aiscend/work/vibelife/docs/components/proactive/LLM-FIRST-REFACTOR.md` - v3.0 è®¾è®¡æ–‡æ¡£
> - `/home/aiscend/work/vibelife/CLAUDE.md` - LLM-First æ¶æ„å¼ºåˆ¶è¦æ±‚
> - `/home/aiscend/work/vibelife/docs/archive/v9/ref/LLM_DRIVEN_V9.2_CLAUDE_SDK_CASE.md` - Claude SDK æ ‡å‡†æ¨¡å¼

---

## ã€‡ã€LLM-First åŸåˆ™ç¬¦åˆæ€§è¯„ä¼°

### CLAUDE.md æ ¸å¿ƒè¦æ±‚ vs å®é™…å®ç°

| LLM-First è¦æ±‚ | é¢„æœŸæ–¹å¼ | å®é™…å®ç° | ç¬¦åˆåº¦ |
|---------------|---------|---------|--------|
| **è·¯ç”±å†³ç­–** | LLM è¯»é…ç½®è§¦å‘ | âœ… ä» reminders.yaml è¯»å– | âœ… ç¬¦åˆ |
| **çŠ¶æ€è®¡ç®—** | LLM ä»å†å²æ¨æ–­ | âš ï¸ éƒ¨åˆ†ç¡®å®šæ€§è®¡ç®— | âš ï¸ éƒ¨åˆ†ç¬¦åˆ |
| **æµç¨‹æ§åˆ¶** | Rule æ–‡ä»¶ + LLM è‡ªæ¨è¿› | âœ… rules/proactive/*.md | âœ… ç¬¦åˆ |
| **é…ç½®å­˜å‚¨** | YAML/Markdown æ–‡ä»¶ | âœ… reminders.yaml + rules/*.md | âœ… ç¬¦åˆ |

### ä¸‰å±‚åˆ†å±‚åŸåˆ™ vs å®é™…å®ç°

æ ¹æ® CLAUDE.md çš„åˆ†å±‚åŸåˆ™ï¼š
- **å¹³å°å±‚**ï¼šç¡®å®šæ€§è®¡ç®—ï¼ˆcron åŒ¹é…ã€exists æ£€æŸ¥ã€æ•°å€¼æ¯”è¾ƒã€æ—¶åŒºè½¬æ¢ï¼‰
- **é…ç½®å±‚**ï¼šå£°æ˜å¼è§„åˆ™ï¼ˆconditionsã€rules/*.mdï¼‰
- **LLM å±‚**ï¼šè¯­ä¹‰æ¨ç†ï¼ˆå¤æ‚æ¡ä»¶ç»„åˆã€è‡ªç„¶è¯­è¨€ç†è§£ã€å†…å®¹ç”Ÿæˆï¼‰

| å±‚çº§ | é¢„æœŸèŒè´£ | å®é™…å®ç° | è¯„ä¼° |
|------|---------|---------|------|
| **å¹³å°å±‚** | cron/exists/æ•°å€¼/æ—¶åŒº | `_evaluate_cron()`, `_static_eval()` | âœ… æ­£ç¡® |
| **é…ç½®å±‚** | conditions, rules/*.md | `reminders.yaml`, `rules/proactive/*.md` | âœ… æ­£ç¡® |
| **LLM å±‚** | å¤æ‚æ¡ä»¶ã€å†…å®¹ç”Ÿæˆ | `_llm_eval_conditions()`, `CoreAgent.run()` | âœ… æ­£ç¡® |

### Claude SDK Agentic Loop å¯¹æ¯”

**æ ‡å‡†æ¨¡å¼**ï¼š
```
ç”¨æˆ·æ¶ˆæ¯ â†’ LLM æ€è€ƒ â†’ å·¥å…·è°ƒç”¨ â†’ ç¯å¢ƒåé¦ˆ â†’ LLM ç»§ç»­
```

**Proactive æ¨¡å¼**ï¼ˆå˜ä½“ï¼Œåˆç†ï¼‰ï¼š
```
å®šæ—¶è§¦å‘ â†’ æ¡ä»¶è¯„ä¼°(é™æ€+LLM) â†’ Agent å†…å®¹ç”Ÿæˆ â†’ é€šçŸ¥ä¿å­˜
           â†‘ å¹³å°å±‚               â†‘ LLM å±‚
```

**è¯„ä¼°**ï¼šProactive æ˜¯"ä¸»åŠ¨æ¨é€"åœºæ™¯è€Œé"ç”¨æˆ·å¯¹è¯"ï¼Œè¿™ç§å˜ä½“æ˜¯åˆç†çš„ã€‚å†…å®¹ç”Ÿæˆç¯èŠ‚å®Œå…¨ç¬¦åˆ Agentic Loopã€‚

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

Proactive ç³»ç»Ÿ v3.0 é‡æ„**å·²åŸºæœ¬å®Œæˆ**ï¼Œæ ¸å¿ƒæ¶æ„ç¬¦åˆè®¾è®¡æ–‡æ¡£è¦æ±‚ã€‚ä½†å­˜åœ¨ä»¥ä¸‹å…³é”®é—®é¢˜éœ€è¦å…³æ³¨ï¼š

| ç±»åˆ« | çŠ¶æ€ | ä¼˜å…ˆçº§ |
|------|------|--------|
| æ ¸å¿ƒç»„ä»¶å®ç° | âœ… å®Œæˆ | - |
| æ—§æ–‡ä»¶æ¸…ç† | âŒ æœªå®Œæˆ | ä¸­ |
| reminders.yaml å‡çº§ | âš ï¸ éƒ¨åˆ†å®Œæˆ | é«˜ |
| Solar term æ£€æµ‹ | âŒ æœªå®ç° | é«˜ |
| æµ‹è¯•è¦†ç›– | âœ… å®Œå–„ | - |

---

## äºŒã€è®¾è®¡æ–‡æ¡£ vs å®é™…å®ç°å¯¹æ¯”

### 2.1 æ–°å¢æ–‡ä»¶æ£€æŸ¥

| è®¾è®¡è¦æ±‚ | å®é™…çŠ¶æ€ | è¡Œæ•° | å¤‡æ³¨ |
|----------|----------|------|------|
| `trigger_evaluator.py` | âœ… å·²åˆ›å»º | 636 | å®Œæ•´å®ç°é™æ€ä¼˜å…ˆ+LLMå›é€€ |
| `orchestrator.py` | âœ… å·²åˆ›å»º | 437 | å®Œæ•´ç¼–æ’é€»è¾‘ |
| `agent_adapter.py` | âœ… å·²åˆ›å»º | 313 | Agent é›†æˆå®Œæ•´ |
| `models.py` | âœ… å·²åˆ›å»º | 67 | æ•°æ®æ¨¡å‹å®Œæ•´ |
| `test_trigger_evaluator.py` | âœ… å·²åˆ›å»º | 507 | 36ä¸ªæµ‹è¯•ç”¨ä¾‹ |
| `test_orchestrator.py` | âœ… å·²åˆ›å»º | 343 | 24ä¸ªæµ‹è¯•ç”¨ä¾‹ |

### 2.2 åº”åˆ é™¤æ–‡ä»¶æ£€æŸ¥

| è®¾è®¡è¦æ±‚åˆ é™¤ | å®é™…çŠ¶æ€ | è¡Œæ•° | é—®é¢˜ |
|--------------|----------|------|------|
| `trigger_detector.py` | âŒ ä»å­˜åœ¨ | 643 | ä»åœ¨ `__init__.py` å¯¼å‡º |
| `content_generator.py` | âŒ ä»å­˜åœ¨ | 1037 | ä»åœ¨ `__init__.py` å¯¼å‡º |
| `engine.py` | âŒ ä»å­˜åœ¨ | 418 | ä»åœ¨ `__init__.py` å¯¼å‡º |

**é—®é¢˜**ï¼šæ—§æ–‡ä»¶ä¿ç•™ç”¨äº"å‘åå…¼å®¹"ï¼Œä½†é€ æˆä»£ç é‡å¤å’Œç»´æŠ¤æ··ä¹±ã€‚

### 2.3 reminders.yaml å‡çº§çŠ¶æ€

| Skill | ç‰ˆæœ¬ | conditions æ ¼å¼ | content.rule | çŠ¶æ€ |
|-------|------|-----------------|--------------|------|
| bazi | v3.0 | âœ… å£°æ˜å¼ | âœ… rules/proactive/*.md | å®Œæˆ |
| zodiac | v3.0 | âœ… å£°æ˜å¼ | âœ… rules/proactive/*.md | å®Œæˆ |
| lifecoach | v3.0 | âœ… å£°æ˜å¼ | âœ… rules/proactive/*.md | å®Œæˆ |
| core | v2.0 | âŒ æ—§æ ¼å¼ `condition:` | âŒ ä½¿ç”¨ `generator:` | **æœªå‡çº§** |
| mindfulness | v2.0 | âŒ æ··åˆæ ¼å¼ | âŒ ä½¿ç”¨ `generator:` | **æœªå‡çº§** |

### 2.4 Proactive Rule æ–‡ä»¶

| Skill | é¢„æœŸæ•°é‡ | å®é™…æ•°é‡ | çŠ¶æ€ |
|-------|----------|----------|------|
| bazi | 5 | 5 | âœ… å®Œæˆ |
| zodiac | 6 | 6 | âœ… å®Œæˆ |
| lifecoach | 5 | 5 | âœ… å®Œæˆ |
| core | 8 | 1 (ä»…æ¨¡æ¿) | âŒ 8ä¸ªè§„åˆ™æ ‡è®°TODO |

---

## ä¸‰ã€æ ¸å¿ƒåŠŸèƒ½å®ç°è¯¦ç»†å®¡æŸ¥

### 3.1 TriggerEvaluator å®ç°è´¨é‡

**âœ… å·²æ­£ç¡®å®ç°çš„åŠŸèƒ½ï¼š**

1. **é™æ€æ“ä½œç¬¦æ”¯æŒ** (`trigger_evaluator.py:28`)
   ```python
   STATIC_OPERATORS = {"exists", "!exists", "==", "!=", ">", "<", ">=", "<=", "contains"}
   ```

2. **é™æ€ä¼˜å…ˆ + LLM å›é€€** (`_evaluate_conditions()` 142-183è¡Œ)
   - æ¡ä»¶åˆ†ç±»æ­£ç¡®
   - çŸ­è·¯ä¼˜åŒ–å®ç°
   - LLM ä»…åœ¨å¿…è¦æ—¶è°ƒç”¨

3. **å ä½ç¬¦é¢„å¤„ç†** (`_preprocess_condition()` 192-203è¡Œ)
   - æ”¯æŒ `{today}` æ›¿æ¢ä¸ºç”¨æˆ·æ—¶åŒºæ—¥æœŸ
   - æ”¯æŒ `{now}` æ›¿æ¢ä¸º ISO æ—¶é—´æˆ³

4. **Cron è¯„ä¼°** (`_evaluate_cron()` 105-140è¡Œ)
   - æ—¶åŒºæ„ŸçŸ¥ï¼ˆä½¿ç”¨ pytzï¼‰
   - å¹‚ç­‰é”®ç”Ÿæˆï¼ˆåˆ†é’Ÿçº§ç²¾åº¦ï¼‰
   - æ‰«æçª—å£å¯¹é½

5. **ç¡®å®šæ€§äº‹ä»¶æ£€æµ‹**
   - `_detect_birthday()` âœ… å®Œæ•´å®ç°
   - `_detect_new_year()` âœ… å®Œæ•´å®ç°
   - `_detect_streak_broken()` âœ… å®Œæ•´å®ç°

**âŒ æœªå®ç°çš„åŠŸèƒ½ï¼š**

1. **Solar Term æ£€æµ‹** (`_detect_solar_term()` 429-442è¡Œ)
   ```python
   def _detect_solar_term(self, advance_days: List[int]) -> Tuple[bool, Optional[Dict], Optional[str]]:
       """Solar term detection - TODO: Implement using lunarcalendar or ephem"""
       return False, None, None  # ç›´æ¥è¿”å› False
   ```
   **å½±å“**ï¼šæ‰€æœ‰ solar_term ç±»å‹çš„æé†’æ— æ³•è§¦å‘

### 3.2 ProactiveOrchestrator å®ç°è´¨é‡

**âœ… å·²æ­£ç¡®å®ç°çš„åŠŸèƒ½ï¼š**

| åŠŸèƒ½ | æ–¹æ³• | ä½ç½® | çŠ¶æ€ |
|------|------|------|------|
| ä¸»æ‰«æå…¥å£ | `run_scheduled_scan()` | 112-132 | âœ… |
| é™é»˜æ—¶æ®µæ£€æŸ¥ | `_is_quiet_hours()` | 278-308 | âœ… æ”¯æŒè·¨åˆå¤œ |
| æ¯æ—¥æ¨é€ä¸Šé™ | `_get_daily_push_count()` | 342-357 | âœ… |
| å¹‚ç­‰å»é‡ | `_is_duplicate()` / `_mark_sent()` | 310-341 | âœ… 48å°æ—¶TTL |
| å†·å´æ£€æŸ¥ | `_check_cooldown()` | 403-432 | âœ… æ”¯æŒè¦†ç›– |
| è®¢é˜…æ£€æŸ¥ | `_should_send_to_user()` | 359-401 | âœ… |

**âš ï¸ æ½œåœ¨é—®é¢˜ï¼š**

1. **æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡** (`_get_users_for_current_hour()` 134-167è¡Œ)
   - å½“å‰è·å–æ‰€æœ‰æ´»è·ƒç”¨æˆ·ååœ¨ Python ä¸­è¿‡æ»¤
   - å¤§ç”¨æˆ·é‡æ—¶å¯èƒ½æœ‰æ€§èƒ½é—®é¢˜

2. **å¼‚å¸¸å¤„ç†å®½æ¾** (`_should_send_to_user()` 400-401è¡Œ)
   - å¼‚å¸¸æ—¶é»˜è®¤è¿”å› `True`ï¼ˆå…è®¸å‘é€ï¼‰
   - å¯èƒ½å¯¼è‡´æ„å¤–æ¨é€

### 3.3 ProactiveAgentAdapter å®ç°è´¨é‡

**âœ… å·²æ­£ç¡®å®ç°çš„åŠŸèƒ½ï¼š**

1. **å†…å®¹ç”Ÿæˆ** (`generate_content()` 41-99è¡Œ)
   - æ­£ç¡®æ„å»º AgentContext
   - è°ƒç”¨ CoreAgent ç”Ÿæˆå†…å®¹
   - æ”¯æŒé™çº§æ¨¡æ¿

2. **Profile Summary æ„å»º** (`_build_profile_summary()` 160-202è¡Œ)
   - ä½¿ç”¨ v9 è·¯å¾„ï¼š`identity.*`, `vibe.target.*`, `preferences.*`
   - å®‰å…¨é™çº§å¤„ç†

3. **å†…å®¹æå–ä¸æ ¡éªŒ** (`_extract_content()` 216-285è¡Œ)
   - JSON æå– + regex å›é€€
   - Pydantic æ ¡éªŒ
   - å­—æ®µé•¿åº¦æˆªæ–­

**âš ï¸ æ½œåœ¨é—®é¢˜ï¼š**

1. **Rule ID è§£æç®€å•** (`_resolve_rule_id()` 204-214è¡Œ)
   - ä»…åšå­—ç¬¦ä¸²å¤„ç†ï¼Œä¸éªŒè¯è§„åˆ™æ–‡ä»¶å­˜åœ¨

2. **åµŒå¥—å­—å…¸è®¿é—®æ— ç©ºæ£€æŸ¥** (`_build_profile_summary()` 189-190è¡Œ)
   - å‡è®¾ `skills.lifecoach` æ˜¯å­—å…¸ï¼Œå¯èƒ½æŠ›å‡º AttributeError

---

## å››ã€æ•°æ®è·¯å¾„ä¸€è‡´æ€§æ£€æŸ¥

### 4.1 v9 Profile è·¯å¾„ä½¿ç”¨æƒ…å†µ

| è·¯å¾„ | é¢„æœŸ (v9) | TriggerEvaluator | AgentAdapter | çŠ¶æ€ |
|------|-----------|------------------|--------------|------|
| å‡ºç”Ÿä¿¡æ¯ | `identity.birth_info` | âœ… | âœ… | ä¸€è‡´ |
| å…³æ³¨é¢†åŸŸ | `vibe.target.focus` | âš ï¸ æœ‰è§„èŒƒåŒ– | âœ… | éœ€è§„èŒƒåŒ– |
| ç›®æ ‡ | `vibe.target.goals` | âš ï¸ æœ‰è§„èŒƒåŒ– | âœ… | éœ€è§„èŒƒåŒ– |
| æ—¶åŒº | `preferences.timezone` | âœ… | âœ… | ä¸€è‡´ |
| æ¨é€è®¾ç½® | `preferences.push_settings` | âœ… | N/A | - |
| è¯­æ°”æ¨¡å¼ | `preferences.voice_mode` | N/A | âœ… | - |

### 4.2 è·¯å¾„è§„èŒƒåŒ–é€»è¾‘

`trigger_evaluator.py` 566-571è¡Œå®ç°äº†æ—§è·¯å¾„åˆ°æ–°è·¯å¾„çš„è½¬æ¢ï¼š
```python
def _normalize_data_path(self, path: str) -> str:
    # vibe.profile.* -> identity.*
    # vibe.state.* -> vibe.target.*
    # vibe.preferences.* -> preferences.*
```

---

## äº”ã€æµ‹è¯•è¦†ç›–åˆ†æ

### 5.1 æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/services/proactive/
â”œâ”€â”€ test_trigger_evaluator.py  (507è¡Œ, 36ä¸ªç”¨ä¾‹)
â”œâ”€â”€ test_orchestrator.py       (343è¡Œ, 24ä¸ªç”¨ä¾‹)
â””â”€â”€ test_e2e_scenarios.py      (1063è¡Œ, 40+åœºæ™¯)
```

### 5.2 æµ‹è¯•è¦†ç›–è¯¦æƒ…

| æµ‹è¯•ç±»åˆ« | è¦†ç›–å†…å®¹ | ç”¨ä¾‹æ•° |
|----------|----------|--------|
| é™æ€æ¡ä»¶è¯„ä¼° | exists, ==, !=, >, <, contains | 9 |
| å ä½ç¬¦æ›¿æ¢ | {today}, {now} | 2 |
| Cron åŒ¹é… | æ—¶åŒºã€å¹‚ç­‰é”® | 4 |
| äº‹ä»¶æ£€æµ‹ | ç”Ÿæ—¥ã€èŠ‚æ°”ã€æœˆç›¸ | 4 |
| å¹³å°çº¦æŸ | é™é»˜ã€ä¸Šé™ã€å¹‚ç­‰ã€å†·å´ | 8 |
| E2E åœºæ™¯ | å¤šç”¨æˆ·ç±»å‹ã€å¤š Skill | 40+ |

### 5.3 æµ‹è¯•è¦†ç›–ç¼ºå£

- âŒ Solar term æ£€æµ‹ï¼ˆæœªå®ç°ï¼Œæ— æ³•æµ‹è¯•ï¼‰
- âš ï¸ LLM å›é€€è·¯å¾„ï¼ˆMock æµ‹è¯•ï¼ŒéçœŸå® LLM è°ƒç”¨ï¼‰
- âš ï¸ æ•°æ®åº“é›†æˆï¼ˆä½¿ç”¨ Mockï¼Œå»ºè®®è¡¥å……çœŸå®æ•°æ®åº“æµ‹è¯•ï¼‰

---

## å…­ã€å…³é”®é—®é¢˜æ±‡æ€»

### 6.1 é«˜ä¼˜å…ˆçº§é—®é¢˜

| # | é—®é¢˜ | ä½ç½® | å½±å“ | å»ºè®® |
|---|------|------|------|------|
| 1 | Solar term æœªå®ç° | `trigger_evaluator.py:429-442` | èŠ‚æ°”æé†’æ— æ³•è§¦å‘ | ä½¿ç”¨ lunarcalendar åº“å®ç° |
| 2 | core/mindfulness reminders.yaml æœªå‡çº§ | `skills/core/reminders.yaml` | 8ä¸ªæé†’ä½¿ç”¨æ—§æ ¼å¼ | å‡çº§åˆ° v3.0 æ ¼å¼ |
| 3 | core è§„åˆ™æ–‡ä»¶æœªåˆ›å»º | `skills/core/rules/proactive/` | ä»…æœ‰æ¨¡æ¿ï¼Œ8ä¸ªè§„åˆ™ TODO | åˆ›å»ºè§„åˆ™æ–‡ä»¶ |

### 6.2 ä¸­ä¼˜å…ˆçº§é—®é¢˜

| # | é—®é¢˜ | ä½ç½® | å½±å“ | å»ºè®® |
|---|------|------|------|------|
| 4 | æ—§æ–‡ä»¶æœªåˆ é™¤ | `trigger_detector.py` ç­‰ | ä»£ç é‡å¤ã€ç»´æŠ¤æ··ä¹± | åˆ é™¤æˆ–æ˜ç¡®åºŸå¼ƒ |
| 5 | æ•°æ®åº“æŸ¥è¯¢æ•ˆç‡ | `orchestrator.py:134-167` | å¤§ç”¨æˆ·é‡æ€§èƒ½é—®é¢˜ | ç§»åˆ° SQL è¿‡æ»¤ |
| 6 | å¼‚å¸¸å¤„ç†å®½æ¾ | `orchestrator.py:400-401` | æ„å¤–æ¨é€ | æ”¹ä¸ºé»˜è®¤ False |

### 6.3 ä½ä¼˜å…ˆçº§é—®é¢˜

| # | é—®é¢˜ | ä½ç½® | å½±å“ | å»ºè®® |
|---|------|------|------|------|
| 7 | Rule ID ä¸éªŒè¯å­˜åœ¨ | `agent_adapter.py:204-214` | è¿è¡Œæ—¶æŠ¥é”™ | æ·»åŠ å­˜åœ¨æ€§æ£€æŸ¥ |
| 8 | åµŒå¥—å­—å…¸æ— ç©ºæ£€æŸ¥ | `agent_adapter.py:189-190` | AttributeError | æ·»åŠ ç©ºå€¼æ£€æŸ¥ |
| 9 | Event info æœªä¼ å…¥ Context | `agent_adapter.py:72-77` | Agent æ— æ³•è·å–äº‹ä»¶ä¸Šä¸‹æ–‡ | æ·»åŠ åˆ° metadata |

---

## ä¸ƒã€æˆåŠŸæ ‡å‡†å¯¹ç…§

æ ¹æ®è®¾è®¡æ–‡æ¡£çš„æˆåŠŸæ ‡å‡†ï¼š

| æ ‡å‡† | çŠ¶æ€ | å¤‡æ³¨ |
|------|------|------|
| æ–°å¢è§¦å‘æ¡ä»¶åªéœ€ä¿®æ”¹ YAML | âœ… è¾¾æˆ | å£°æ˜å¼ conditions æ”¯æŒ |
| æ–°å¢æ¨é€å†…å®¹åªéœ€æ·»åŠ  Rule æ–‡ä»¶ | âœ… è¾¾æˆ | content.rule æœºåˆ¶å®Œå–„ |
| åˆ é™¤ trigger_detector.py (643è¡Œ) | âŒ æœªè¾¾æˆ | ä»ä¿ç•™ç”¨äº"å…¼å®¹" |
| åˆ é™¤ content_generator.py (1037è¡Œ) | âŒ æœªè¾¾æˆ | ä»ä¿ç•™ç”¨äº"å…¼å®¹" |
| æ‰€æœ‰ reminders.yaml è¿ç§»åˆ° v3.0 | âš ï¸ éƒ¨åˆ†è¾¾æˆ | core/mindfulness æœªè¿ç§» |
| æµ‹è¯•è¦†ç›–ç‡ 80%+ | âœ… è¾¾æˆ | 100+ æµ‹è¯•ç”¨ä¾‹ |
| æ¨é€å»¶è¿Ÿå¢åŠ  â‰¤2ç§’ | â“ æœªéªŒè¯ | éœ€æ€§èƒ½æµ‹è¯• |

---

## å…«ã€å»ºè®®çš„ä¿®å¤ä¼˜å…ˆçº§

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆé˜»å¡åŠŸèƒ½ï¼‰

1. **å®ç° Solar Term æ£€æµ‹**
   - æ–‡ä»¶ï¼š`trigger_evaluator.py`
   - æ–¹æ³•ï¼šä½¿ç”¨ `lunarcalendar` æˆ– `ephem` åº“
   - å·¥ä½œé‡ï¼šçº¦ 50 è¡Œä»£ç 

2. **å‡çº§ core/mindfulness reminders.yaml**
   - æ–‡ä»¶ï¼š`skills/core/reminders.yaml`, `skills/mindfulness/reminders.yaml`
   - å·¥ä½œé‡ï¼šé…ç½®è¿ç§»

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆä»£ç è´¨é‡ï¼‰

3. **åˆ é™¤æˆ–åºŸå¼ƒæ—§æ–‡ä»¶**
   - é€‰é¡¹ Aï¼šå®Œå…¨åˆ é™¤ trigger_detector.py, content_generator.py, engine.py
   - é€‰é¡¹ Bï¼šä¿ç•™ä½†ä» `__init__.py` ç§»é™¤å¯¼å‡ºï¼Œæ·»åŠ åºŸå¼ƒè­¦å‘Š

4. **åˆ›å»º core è§„åˆ™æ–‡ä»¶**
   - æ–‡ä»¶ï¼š8 ä¸ª `skills/core/rules/proactive/*.md`

### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆå¥å£®æ€§ï¼‰

5. **æ”¹è¿›é”™è¯¯å¤„ç†**
   - å¼‚å¸¸æ—¶é»˜è®¤æ‹’ç»æ¨é€
   - æ·»åŠ ç©ºå€¼æ£€æŸ¥

6. **ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢**
   - ç§»åŠ¨æ—¶åŒº/å°æ—¶è¿‡æ»¤åˆ° SQL å±‚

---

## ä¹ã€æ€»ä½“è¯„ä»·

**ä»£ç è´¨é‡**ï¼šâ­â­â­â­ (4/5)
- æ¶æ„æ¸…æ™°ï¼ŒèŒè´£åˆ†ç¦»è‰¯å¥½
- é™æ€ä¼˜å…ˆ + LLM å›é€€ç­–ç•¥æ­£ç¡®å®ç°
- æµ‹è¯•è¦†ç›–å®Œå–„

**è§„èŒƒç¬¦åˆåº¦**ï¼šâ­â­â­ (3/5)
- æ ¸å¿ƒç»„ä»¶å®Œæˆ
- ä½†æ—§æ–‡ä»¶æœªæ¸…ç†ã€éƒ¨åˆ†é…ç½®æœªè¿ç§»

**ç”Ÿäº§å°±ç»ªåº¦**ï¼šâ­â­â­â­ (4/5)
- ä¸»è¦åŠŸèƒ½å¯ç”¨
- Solar term æ˜¯å”¯ä¸€åŠŸèƒ½é˜»å¡ç‚¹
- å»ºè®®å®Œæˆé«˜ä¼˜å…ˆçº§é—®é¢˜åä¸Šçº¿

---

## åã€LLM-First åŸåˆ™è¿åç‚¹è¯¦ç»†åˆ†æ

### 10.1 æ—§ä»£ç ä¿ç•™é—®é¢˜ âŒ

**CLAUDE.md è¦æ±‚**ï¼š
> ä¸è¦ç”¨ä»£ç ç¡¬ç¼–ç å†³ç­–é€»è¾‘ï¼Œè®© LLM è‡ªå·±åˆ¤æ–­

**å½“å‰é—®é¢˜**ï¼š
```
trigger_detector.py (643è¡Œ) - 10+ ç¡¬ç¼–ç  _detect_* æ–¹æ³•
content_generator.py (1037è¡Œ) - 10+ ç¡¬ç¼–ç  _generate_* æ–¹æ³•
```

è¿™äº›æ–‡ä»¶ä»åœ¨ `__init__.py` å¯¼å‡ºï¼Œè¿å"ç¦æ­¢ç¡¬ç¼–ç "åŸåˆ™ã€‚

**å»ºè®®**ï¼šåˆ é™¤æˆ–å®Œå…¨åºŸå¼ƒè¿™äº›æ–‡ä»¶ã€‚

### 10.2 äº‹ä»¶æ£€æµ‹è®¾è®¡å·®å¼‚ âš ï¸

**è®¾è®¡æ–‡æ¡£è¦æ±‚**ï¼š
```yaml
# ç”¨ conditions + LLM è¯„ä¼°æ›¿ä»£ç¡¬ç¼–ç 
conditions:
  - description: "ç”¨æˆ·ç”Ÿæ—¥åœ¨è¿‘æœŸ"
    event: birthday
```

**å®é™…å®ç°**ï¼š
```python
# trigger_evaluator.py - ä»æ˜¯ç¡®å®šæ€§ä»£ç 
def _detect_birthday(self, profile, advance_days):
    birth_date_str = self._get_nested_value(profile, "...")
    # ... çº¯ Python è®¡ç®—
```

**è¯„ä¼°**ï¼šæŒ‰ LLM-First çš„"åˆ†å±‚åŸåˆ™"ï¼Œç”Ÿæ—¥æ£€æµ‹æ˜¯**ç¡®å®šæ€§è®¡ç®—**ï¼ˆç»™å®šæ—¥æœŸï¼Œå¯ç²¾ç¡®è®¡ç®—ï¼‰ï¼Œåº”ç”±å¹³å°å±‚å¤„ç†ã€‚è¿™ä¸ªè®¾è®¡æ˜¯**åˆç†çš„**ã€‚

ä½†è®¾è®¡æ–‡æ¡£è¯´è¦ç”¨ LLM è¯„ä¼°ï¼Œè¿™é‡Œå­˜åœ¨**è®¾è®¡ä¸å®ç°ä¸ä¸€è‡´**ã€‚

### 10.3 reminders.yaml æ ¼å¼ä¸ä¸€è‡´ âŒ

**CLAUDE.md è¦æ±‚**ï¼š
> é…ç½®: Python å¸¸é‡ï¼ˆç¦æ­¢ï¼‰ â†’ YAML/Markdown æ–‡ä»¶ï¼ˆæ­£ç¡®ï¼‰

**å½“å‰é—®é¢˜**ï¼š
```yaml
# core/reminders.yaml (v2.0 æ—§æ ¼å¼)
condition: has_active_goals  # å­—ç¬¦ä¸²ï¼Œéå£°æ˜å¼

# bazi/reminders.yaml (v3.0 æ–°æ ¼å¼)
conditions:
  - description: "ç”¨æˆ·å·²è®¾å®šå…«å­—ä¿¡æ¯"
    data_path: "identity.birth_info"
    operator: "exists"
```

**å½±å“**ï¼šcore å’Œ mindfulness çš„æé†’æ— æ³•ä½¿ç”¨æ–°çš„ TriggerEvaluatorã€‚

### 10.4 Agent é€‚é…å™¨æœªä¼ é€’äº‹ä»¶ä¸Šä¸‹æ–‡ âš ï¸

**Claude SDK æ¨¡å¼è¦æ±‚**ï¼š
> LLM é€šè¿‡ get_user_profile å†³å®šè·å–ä»€ä¹ˆ

**å½“å‰å®ç°**ï¼š
```python
# agent_adapter.py
context = AgentContext(
    user_id=user_id,
    profile=profile,
    skill=skill_id,
    scenario=rule_id,
    # ç¼ºå°‘: metadata={"event_info": event_info}
)
```

**å½±å“**ï¼šAgent æ— æ³•è·å–è§¦å‘äº‹ä»¶çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œåªèƒ½ä» Prompt ä¸­è§£æã€‚

---

## åä¸€ã€LLM-First æœ€ä½³å®è·µå¯¹ç…§

### ç¬¦åˆçš„æœ€ä½³å®è·µ âœ…

| å®è·µ | å®ç°ä½ç½® | è¯´æ˜ |
|------|---------|------|
| é…ç½®é©±åŠ¨è§¦å‘ | reminders.yaml | è§¦å‘æ¡ä»¶å£°æ˜å¼å®šä¹‰ |
| Rule æ–‡ä»¶å®šä¹‰å†…å®¹ | rules/proactive/*.md | ç”Ÿæˆè§„åˆ™é…ç½®åŒ– |
| é™æ€ä¼˜å…ˆ + LLM å›é€€ | TriggerEvaluator | ç¬¦åˆåˆ†å±‚åŸåˆ™ |
| Agent å†…å®¹ç”Ÿæˆ | ProactiveAgentAdapter â†’ CoreAgent | ç¬¦åˆ Agentic Loop |
| å ä½ç¬¦ç³»ç»Ÿ | {today}, {now} | ç¬¦åˆç³»ç»Ÿå ä½ç¬¦è§„èŒƒ |

### éœ€è¦æ”¹è¿›çš„å®è·µ âŒ

| é—®é¢˜ | å½“å‰çŠ¶æ€ | åº”æ”¹ä¸º |
|------|---------|--------|
| æ—§æ–‡ä»¶å…±å­˜ | trigger_detector.py ç­‰ä»å­˜åœ¨ | å®Œå…¨åˆ é™¤ |
| v2.0 é…ç½® | core/mindfulness æœªè¿ç§» | å‡çº§åˆ° v3.0 |
| äº‹ä»¶ä¸Šä¸‹æ–‡ | ä¸åœ¨ AgentContext ä¸­ | æ·»åŠ åˆ° metadata |

---

## åäºŒã€æ€»ç»“è¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **LLM-First ç¬¦åˆåº¦** | â­â­â­â­ (4/5) | æ ¸å¿ƒåŸåˆ™ç¬¦åˆï¼Œä½†æœ‰æ—§ä»£ç æ®‹ç•™ |
| **Claude SDK ç¬¦åˆåº¦** | â­â­â­â­â­ (5/5) | å†…å®¹ç”Ÿæˆå®Œå…¨ç¬¦åˆ Agentic Loop |
| **åˆ†å±‚åŸåˆ™ç¬¦åˆåº¦** | â­â­â­â­â­ (5/5) | å¹³å°å±‚/é…ç½®å±‚/LLMå±‚ åˆ’åˆ†æ­£ç¡® |
| **é…ç½®åŒ–ç¨‹åº¦** | â­â­â­â­ (4/5) | ä¸»è¦é…ç½®åŒ–ï¼Œä½† core/mindfulness æœªè¿ç§» |
| **ä»£ç è´¨é‡** | â­â­â­â­ (4/5) | æ¶æ„æ¸…æ™°ï¼Œæµ‹è¯•å®Œå–„ |

### æœ€ç»ˆç»“è®º

**æ•´ä½“è¯„ä¼°**ï¼šProactive v3.0 å®ç°**åŸºæœ¬ç¬¦åˆ** LLM-First åŸåˆ™å’Œ Claude SDK è§„èŒƒã€‚

**å…³é”®ä¼˜ç‚¹**ï¼š
- é™æ€ä¼˜å…ˆ + LLM å›é€€çš„åˆ†å±‚è®¾è®¡æ­£ç¡®
- é…ç½®é©±åŠ¨ï¼ˆreminders.yaml + rules/*.mdï¼‰
- å†…å®¹ç”Ÿæˆä½¿ç”¨ CoreAgentï¼ˆAgentic Loopï¼‰

**å¾…ä¿®å¤é—®é¢˜**ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ï¼š
1. ğŸ”´ åˆ é™¤æ—§ä»£ç ï¼ˆtrigger_detector.py, content_generator.pyï¼‰
2. ğŸ”´ è¿ç§» core/mindfulness åˆ° v3.0 æ ¼å¼
3. ğŸŸ¡ å®ç° solar_term æ£€æµ‹
4. ğŸŸ¡ å°† event_info ä¼ å…¥ AgentContext.metadata

---

## åä¸‰ã€å…³é”®æ–‡ä»¶ä½ç½®

| ç»„ä»¶ | è·¯å¾„ |
|------|------|
| TriggerEvaluator | `/home/aiscend/work/vibelife/apps/api/services/proactive/trigger_evaluator.py` |
| ProactiveOrchestrator | `/home/aiscend/work/vibelife/apps/api/services/proactive/orchestrator.py` |
| ProactiveAgentAdapter | `/home/aiscend/work/vibelife/apps/api/services/proactive/agent_adapter.py` |
| NotificationService | `/home/aiscend/work/vibelife/apps/api/services/reminder/notification.py` |
| è®¾è®¡æ–‡æ¡£ | `/home/aiscend/work/vibelife/docs/components/proactive/LLM-FIRST-REFACTOR.md` |
| LLM-First è§„èŒƒ | `/home/aiscend/work/vibelife/CLAUDE.md` |
| Claude SDK æ¡ˆä¾‹ | `/home/aiscend/work/vibelife/docs/archive/v9/ref/LLM_DRIVEN_V9.2_CLAUDE_SDK_CASE.md` |
