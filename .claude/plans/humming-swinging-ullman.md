# ProfileExtractor æ·±åº¦å®¡è®¡æŠ¥å‘Š

## 1. æ¶æ„æ¦‚è§ˆ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                CoreAgent v10                 â”‚
                    â”‚     (ContextManager, PromptBuilder, etc.)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚ è¯»å–
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              VibeProfile v9.0                â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚identity â”‚   skills   â”‚     vibe      â”‚   â”‚
                    â”‚  â”‚birth_infoâ”‚bazi/zodiacâ”‚insight/target â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚ å†™å…¥
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            ProfileExtractor V8               â”‚
                    â”‚      (æ¯æ—¥å‡Œæ™¨ 3 ç‚¹æ‰¹å¤„ç†)                     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. å½“å‰å®ç°è¯„ä¼°

### âœ… åšå¾—å¥½çš„åœ°æ–¹

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **å¢é‡å¤„ç†** | åªå¤„ç†è‡ªä¸Šæ¬¡æŠ½å–åçš„æ–°æ¶ˆæ¯ï¼Œé¿å…é‡å¤ LLM è°ƒç”¨ |
| **åˆå¹¶ç­–ç•¥** | åŒºåˆ†çŠ¶æ€å‹(è¦†ç›–)å’Œç´¯ç§¯å‹(è¿½åŠ )ï¼Œç¬¦åˆä¸šåŠ¡è¯­ä¹‰ |
| **å®¹é”™è®¾è®¡** | JSON è§£æå¤±è´¥æ—¶è¿”å›åŸæ•°æ®ï¼Œä¸ä¸¢å¤± |
| **ä½æ¸©åº¦æŠ½å–** | `temperature=0.3` ä¿è¯æŠ½å–ç»“æœç¨³å®šä¸€è‡´ |

### âš ï¸ å‘ç°çš„é—®é¢˜

| é—®é¢˜ | ä¸¥é‡åº¦ | ä½ç½® | è¯´æ˜ |
|------|--------|------|------|
| **Cold Layer ä»£ç ç¼ºå¤±** | ğŸŸ¡ | Line 7-8 | æ³¨é‡Šè¯´å†™å…¥ `vibe_profile_timeline`ï¼Œå®é™…æœªå®ç° |
| **æ—¶åŒºå¤„ç†é£é™©** | ğŸŸ¡ | Line 250 | ISO æ ¼å¼è§£æå¯èƒ½å› æ—¶åŒºæ ¼å¼å‡ºé”™ |
| **æ¶ˆæ¯æˆªæ–­è¿‡æ—©** | ğŸ”µ | Line 265 | æ¯æ¡æ¶ˆæ¯æˆªæ–­åˆ° 300 å­—ï¼Œå¯èƒ½ä¸¢å¤±å…³é”®ä¿¡æ¯ |
| **vibe.insight æ—  Skill åŒæ­¥** | ğŸŸ¡ | - | æŠ½å–çš„ archetype/traits æœªåŒæ­¥åˆ° bazi/zodiac insight |

### ğŸ” å…³é”®ä»£ç è·¯å¾„

**ProfileExtractor â†’ VibeProfile å†™å…¥é“¾è·¯**ï¼š
```
extract_user_profile()
  â†’ get_user_messages_since()      # Line 257
  â†’ chat(capability="analysis")    # Line 289
  â†’ merge_insight()                # Line 313
  â†’ UnifiedProfileRepository.update_vibe_insight()  # Line 314
```

**CoreAgent â†’ VibeProfile è¯»å–é“¾è·¯**ï¼š
```
PromptBuilder.build()
  â†’ _build_profile_context()       # Line 102
  â†’ profile.get("vibe", {})        # Line 200
  â†’ æ³¨å…¥åˆ° System Prompt
```

## 3. é—®é¢˜è¯¦ç»†åˆ†æ

### 3.1 Cold Layer æ³¨é‡Šä¸å®ç°ä¸ä¸€è‡´

**ä½ç½®**: `profile_extractor.py:7-8`

```python
# V8 æ¶æ„å‡çº§ï¼š
# - ä¿æŒ Cold Layer å†™å…¥ (vibe_profile_timeline + vibe_profile_insights)
```

**å®é™…æƒ…å†µ**ï¼šä»£ç ä¸­æ²¡æœ‰ä»»ä½•å†™å…¥ `vibe_profile_timeline` æˆ– `vibe_profile_insights` çš„é€»è¾‘ã€‚

**ç”¨æˆ·ç¡®è®¤**ï¼šCold Layer å·²åºŸå¼ƒï¼Œåº”ç§»é™¤æ­¤æ³¨é‡Šã€‚

### 3.2 æ—¶åŒºè§£æé£é™©

**ä½ç½®**: `profile_extractor.py:250`

```python
since = datetime.fromisoformat(last_extracted_at.replace("Z", "+00:00"))
```

**é£é™©**ï¼šå¦‚æœ `last_extracted_at` æ ¼å¼ä¸ç¬¦åˆé¢„æœŸï¼ˆå¦‚ `2026-01-19 03:00:00`ï¼‰ï¼Œä¼šå¯¼è‡´è§£æå¤±è´¥ã€‚

**å»ºè®®**ï¼šå¢åŠ æ›´å¥å£®çš„æ—¶é—´è§£æã€‚

### 3.3 Skill åŒæ­¥ä¸å®Œæ•´

**ç°æœ‰åŒæ­¥**ï¼ˆ`unified_profile_repo.py`ï¼‰ï¼š
- `sync_bazi_to_vibe_insight()`: bazi.chart â†’ vibe.insight.essence
- `sync_zodiac_to_vibe_insight()`: zodiac.chart â†’ vibe.insight.essence
- `sync_lifecoach_to_vibe_target()`: lifecoach.goals â†’ vibe.target

**ç¼ºå¤±**ï¼šProfileExtractor æŠ½å–çš„æ•°æ®æ²¡æœ‰åå‘åŒæ­¥åˆ° Skills å±‚ã€‚

**ç”¨æˆ·ç¡®è®¤**ï¼šä¿æŒå•å‘åŒæ­¥ï¼ˆSkills â†’ Vibeï¼‰ï¼Œä¸éœ€è¦åå‘å†™å…¥ã€‚

## 4. ä¼˜åŒ–å»ºè®®

### 4.1 ä»£ç æ¸…ç†ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

```python
# ç§»é™¤è¿‡æ—¶æ³¨é‡Š
"""
Profile Extractor Worker V8 - ä»ç”¨æˆ·äº¤äº’ä¸­æŠ½å–ä¿¡æ¯æ›´æ–° Profile

V8 æ¶æ„å‡çº§ï¼š
- è¾“å‡ºå†™å…¥ vibe.insight (æˆ‘æ˜¯è°) + vibe.target (æˆ‘è¦æˆä¸ºè°)
- åºŸå¼ƒ extracted å­—æ®µ
# - ä¿æŒ Cold Layer å†™å…¥ (...)  â† ç§»é™¤æ­¤è¡Œ
"""
```

### 4.2 æ—¶åŒºå¤„ç†å¢å¼º

```python
def parse_timestamp(ts: str) -> datetime:
    """å¥å£®çš„æ—¶é—´æˆ³è§£æ"""
    if not ts:
        return datetime.now() - timedelta(days=7)
    try:
        # å°è¯•å¤šç§æ ¼å¼
        for fmt in ["%Y-%m-%dT%H:%M:%S.%f%z", "%Y-%m-%dT%H:%M:%S%z", "%Y-%m-%d %H:%M:%S"]:
            try:
                return datetime.strptime(ts, fmt)
            except ValueError:
                continue
        # Fallback: fromisoformat with Z handling
        return datetime.fromisoformat(ts.replace("Z", "+00:00"))
    except Exception:
        return datetime.now() - timedelta(days=7)
```

### 4.3 æ¶ˆæ¯æˆªæ–­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

å½“å‰ï¼šæ¯æ¡æ¶ˆæ¯æˆªæ–­åˆ° 300 å­—
å»ºè®®ï¼šæ ¹æ®æ€» token é¢„ç®—åŠ¨æ€è°ƒæ•´ï¼Œä¿ç•™æ›´å¤šä¸Šä¸‹æ–‡

### 4.4 Prompt ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

å½“å‰ Prompt è¾“å‡ºç»“æ„è¾ƒå¤æ‚ï¼Œå¯è€ƒè™‘ï¼š
- ç®€åŒ– schemaï¼Œå‡å°‘ LLM æ¨ç†è´Ÿæ‹…
- å¢åŠ  few-shot examples æé«˜æŠ½å–å‡†ç¡®ç‡

## 5. æ•°æ®åˆ©ç”¨æƒ…å†µ

### CoreAgent å¦‚ä½•ä½¿ç”¨ ProfileExtractor æ•°æ®

| æ•°æ® | æ³¨å…¥ä½ç½® | ä½¿ç”¨æ–¹å¼ |
|------|----------|----------|
| `vibe.insight.essence.archetype` | PromptBuilder:211 | "ä¸»è¦åŸå‹ï¼š{primary}" |
| `vibe.insight.essence.traits` | PromptBuilder:214-216 | "æ ¸å¿ƒç‰¹è´¨ï¼š{traits}" |
| `vibe.insight.dynamic.emotion` | PromptBuilder:222-223 | "å½“å‰æƒ…ç»ªï¼š{current}" |
| `vibe.insight.pattern.insights` | PromptBuilder:231-233 | "æ´å¯Ÿï¼š{insights[0]}" |
| `vibe.target.north_star` | PromptBuilder:244-249 | "æ„¿æ™¯ï¼š{vision_scene}" |
| `vibe.target.goals` | PromptBuilder:252-257 | "å½“å‰ç›®æ ‡ï¼š{goals}" |
| `vibe.target.focus` | PromptBuilder:260-262 | "å…³æ³¨é¢†åŸŸï¼š{primary}" |

**ç»“è®º**ï¼šProfileExtractor æŠ½å–çš„æ•°æ®è¢«å®Œæ•´åœ°æ³¨å…¥åˆ° System Prompt ä¸­ï¼ŒCoreAgent èƒ½å¤Ÿåˆ©ç”¨è¿™äº›ä¿¡æ¯æä¾›ä¸ªæ€§åŒ–å“åº”ã€‚

## 6. æœªè§£å†³é—®é¢˜

1. **æŠ½å–è´¨é‡å¦‚ä½•è¯„ä¼°**ï¼Ÿå½“å‰æ²¡æœ‰æŒ‡æ ‡è¡¡é‡ LLM æŠ½å–çš„å‡†ç¡®æ€§
2. **ç”¨æˆ·åé¦ˆæœºåˆ¶**ï¼Ÿç”¨æˆ·æ— æ³•ç›´æ¥ä¿®æ­£é”™è¯¯çš„ç”»åƒä¿¡æ¯
3. **éšç§åˆè§„**ï¼ŸæŠ½å–çš„æ•æ„Ÿä¿¡æ¯ï¼ˆå…³ç³»ã€æŒ‘æˆ˜ï¼‰å¦‚ä½•å¤„ç†ç”¨æˆ·åˆ é™¤è¯·æ±‚

---

## æ‰§è¡Œå»ºè®®

**ä¸éœ€è¦ä¿®æ”¹**ï¼šæ¶æ„è®¾è®¡åˆç†ï¼Œæ•°æ®æµæ¸…æ™°ï¼Œä¸ CoreAgent é›†æˆè‰¯å¥½ã€‚

**å¯é€‰æ¸…ç†**ï¼š
- ç§»é™¤ Cold Layer ç›¸å…³æ³¨é‡Šï¼ˆå·²åºŸå¼ƒï¼‰
- å¢å¼ºæ—¶åŒºè§£æçš„å¥å£®æ€§
