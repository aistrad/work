 高优先级风险（P0）

  - 时间线 append 语义缺失：handler 对 vibe.* 一刀切为 update_by_path 会把 timeline 的“追加”降为“覆盖”，与“保留
    append_vibe_timeline”不一致（DESIGN.md:209,311）。建议：在 handler 中单独分支 vibe.timeline，当传入为单条/若干条时调用 append；当
    传入为整表时才覆盖。
  - 并发与竞态：当前“read→merge→save”是典型最后写入胜出，缺少版本/比较‑并设置（CAS）保护，可能丢变更（DESIGN.md:136）。建议：
    update_by_path 支持可选 expected_version 或文档级 updated_at 比较失败即返回冲突；或提供 patch/append 动作避免整数组覆盖。
  - SQL 参数类型与可移植性：jsonb_set 使用 $2 作为路径但未显式 ::text[]，在不同驱动/方言下易出类型推断问题（DESIGN.md:234）。建议在
    SQL 中对路径参数显式 ::text[]，并删除未使用的 pg_path 变量。

  中优先级问题（P1）

  - 白名单与工具参数不一致：Schema 有 life_stage、interests，但 save 的可写路径未覆盖它们（DESIGN.md:161 vs 35–61）。建议补齐：
      - vibe.profile.context.life_stage
      - vibe.profile.context.interests
  - 旧路径残留策略：迁移完成后仍允许 ^goals(\\..)*$、^state\\..*$ 等旧入口（DESIGN.md:188）。建议阶段性保留并加“弃用告警”，在 T+N 版
    本移除。
  - 目标与时间线条目缺少稳定标识：仅以 title 去重易冲突（DESIGN.md:416）。建议为 goals[]、timeline[] 引入 id（UUID）、created_at，并
    在 save 支持按 id 更新。
  - clean_none_values 只处理 dict，不处理 list 中的空值/空对象（DESIGN.md:446）。建议递归覆盖 list 分支。
  - 迁移脚本一次性拉全表，规模化时内存与锁竞争风险（DESIGN.md:458）。建议分批/游标式迁移，事务粒度降到“按用户”。

  低优先级改进（P2）

  - 枚举取值建议增加 unknown/other 后备值，避免丢弃非标准输入（DESIGN.md:35–61）。
  - state.focus 建议限制长度（如 ≤5）与去重/清洗规则，防止“标签爆炸”（DESIGN.md:57）。
  - LLM 侧读‑合并‑写的准则可加“参考提示模板”，提升一致性（DESIGN.md:136）。

  建议的具体修订

  - handler 针对 vibe.timeline 分支（文档位置：DESIGN.md:209）：
      - 若 data 为对象或对象数组，则调用 append_vibe_timeline(user_uuid, items)。
      - 若 data 为数组且带 __replace__=true 或通过工具参数声明 mode=replace，才整表覆盖。
  - validators.py 白名单（DESIGN.md:188）：
      - 补充：r"^vibe\\.profile\\.context\\.(occupation|life_stage|interests)$"。
      - 将 vibe.state 限定到键集合：r"^vibe\\.state\\.(emotion|energy|focus)$"。
      - 为过渡期旧路径添加“弃用日志”并标注移除计划。
  - update_by_path SQL 显式类型与清理（文档位置：DESIGN.md:234）：
      - 在两处 SQL 中将路径参数改为 $2::text[]。
      - 删除未使用的 pg_path 变量。
      - 可选：支持 expected_updated_at 比较，冲突返回 {status: conflict}。
  - clean_none_values 递归版（文档位置：DESIGN.md:446）：
      - 处理 list：过滤 None/{}/[]，并对子项递归。
  - 迁移脚本（文档位置：DESIGN.md:458）：
      - 使用 LIMIT/OFFSET 或游标（如 asyncpg cursor）分批。
      - 为 goals 构造 id 并按 title 仅在缺 id 时去重。
      - 增加 dry‑run 与统计输出（变更计数、跳过原因）。

  示例代码片段（对照文档行号）

  - update_by_path 中 SQL 强类型与父路径预建（DESIGN.md:234）：
      - profile #> $2 → profile #> $2::text[]
      - jsonb_set(..., $2, ... → jsonb_set(..., $2::text[], ...
  - clean_none_values 递归 list（DESIGN.md:446）：
      - 逻辑：若是 list → 逐项递归后过滤 None/{}/[]。

  验收与回归建议（扩充 DESIGN.md:530 验证清单）

  - 并发写入测试：两次并发追加 vibe.timeline 不丢条目。
  - 白名单回归：拒绝 vibe.profile.context.foo、vibe.state.mood 等无效路径。
  - 大小限制：长数组（>100）、大对象（>64KB）应被拒绝或截断并记录。
  - 迁移可恢复性：中断后可从最近 user_id 继续；重复执行幂等。

  开放问题（建议在文档补充）

  - 是否需要软删除/恢复机制（尤其是 goals/timeline）？
  - 是否需要审计日志与 PII 屏蔽策略？
  - 多代理协同写同一用户档案时的冲突策略（最终一致 or 强一致）？