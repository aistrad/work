Ultra Analysis Report: ÂÜÖËÅîÂµåÂÖ•ÂçèËÆÆÊµÅ - ÂêéÁ´ØËÆæËÆ°                                                                                              
                                                                                                                                                
  Âü∫‰∫é‰Ω†ÁöÑÂâçÁ´ØËßÑÂàíÔºåÊàëËøõË°å‰∫ÜÊ∑±Â∫¶ÂàÜÊûê„ÄÇÂú®ÁªôÂá∫ÊñπÊ°àÂâçÔºåÊàëÈúÄË¶ÅÂÖàÁ°ÆËÆ§Âá†‰∏™ÂÖ≥ÈîÆÈóÆÈ¢òÔºö                                                                  
                                                                                                                                                
  Ê∑±Â∫¶ËÆøË∞àÈóÆÈ¢ò                                                                                                                                  
                                                                                                                                                
  Q1: ÂçèËÆÆËß¶ÂèëÊú∫Âà∂                                                                                                                              
  ÂâçÁ´ØËÆæËÆ°‰∏≠ÊòæÁ§∫ [ÂºÄÂßãÈáçÁΩÆ] [Á®çÂêéÂÜçËØ¥] ÊåâÈíÆ„ÄÇËøô‰∏™ÊåâÈíÆÂ∫îËØ•Ôºö                                                                                     
  - A) Áî±ÂâçÁ´ØÁ°¨ÁºñÁ†ÅÔºàÂâçÁ´ØÂà§Êñ≠ÊòØÂê¶ÊòæÁ§∫Ôºâ                                                                                                         
  - B) Áî±ÂêéÁ´ØÈÄöËøáÂ∑•ÂÖ∑Ë∞ÉÁî®ËøîÂõûÔºàÂ¶Ç show_protocol_invitation Â∑•ÂÖ∑Ôºâ                                                                               
  - C) ‰Ωú‰∏∫ÊôÆÈÄöÊ∂àÊÅØ‰∏≠ÁöÑ‰∫§‰∫íÊåâÈíÆÔºàMarkdown Ê†ºÂºèÔºâ                                                                                                
                                                                                                                                                
  ‰Ω†ÂÄæÂêëÂì™ÁßçÔºüÊàëÂª∫ËÆÆ BÔºåÂõ†‰∏∫Âè™ÊúâÂêéÁ´ØÁü•ÈÅìÁî®Êà∑ÊòØÂê¶ÈÄÇÂêàËØ•ÂçèËÆÆ„ÄÇ                                                                                    
                                                                                                                                                
  Q2: ËøõÂ∫¶Êù°Êï∞ÊçÆÊù•Ê∫ê                                                                                                                            
  ËøõÂ∫¶Êù° üìä ËøõÂ∫¶ 2/6 - Phase 1: ËßâÈÜí [‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 33% Â∫îËØ•Ôºö                                                                           
  - A) ÂêéÁ´ØÊØèÊ¨°ÂõûÂ§çÊó∂Âú®Ê∂àÊÅØ‰∏≠ÂÜÖÂµåËøõÂ∫¶‰ø°ÊÅØÔºàÂ¶Ç MarkdownÔºâ                                                                                        
  - B) ÂêéÁ´ØÈÄöËøáËá™ÂÆö‰πâ SSE ‰∫ã‰ª∂ÂèëÈÄÅÔºàÂ¶Ç protocol_state ‰∫ã‰ª∂Ôºâ                                                                                    
  - C) ÂâçÁ´ØÊ†πÊçÆÂØπËØùËΩÆÊ¨°Ëá™Ë°åËÆ°ÁÆó                                                                                                                 
                                                                                                                                                
  ÊàëÂª∫ËÆÆ BÔºåÈÄöËøáÊâ©Â±ï AI SDK Data Stream Protocol Ê∑ªÂä†Ëá™ÂÆö‰πâ‰∫ã‰ª∂„ÄÇ                                                                               
                                                                                                                                                
  Q3: ÂçèËÆÆ‰∏≠Êñ≠ÊÅ¢Â§ç                                                                                                                              
  Áî®Êà∑Âú®Á¨¨3Ê≠•Êó∂Âà∑Êñ∞È°µÈù¢ÔºåÈáçÊñ∞ÊâìÂºÄËÅäÂ§©Ôºö                                                                                                         
  - A) Ëá™Âä®‰ªéÁ¨¨3Ê≠•ÁªßÁª≠ÔºàÂêéÁ´ØÊ£ÄÊµãÂà∞Êú™ÂÆåÊàêÁöÑÂçèËÆÆÁä∂ÊÄÅÔºâ                                                                                            
  - B) ÊèêÁ§∫Áî®Êà∑"Ê£ÄÊµãÂà∞Êú™ÂÆåÊàêÁöÑ Dan Koe ÂçèËÆÆÔºåË¶ÅÁªßÁª≠ÂêóÔºü"                                                                                        
  - C) ÂΩì‰ΩúÊñ∞ÂØπËØùÔºå‰ªéÂ§¥ÂºÄÂßã                                                                                                                     
                                                                                                                                                
  ÊàëÂª∫ËÆÆ AÔºàËá™Âä®ÁªßÁª≠Ôºâ+ Âú®È¶ñÊù°Ê∂àÊÅØ‰∏≠ÂèãÂ•ΩÊèêÁ§∫ËøõÂ∫¶„ÄÇ                                                                                              
                                                                                                                                                
  Q4: ÂçèËÆÆÂÆåÊàêÂêéÁöÑËøáÊ∏°                                                                                                                          
  ÂçèËÆÆ6Ê≠•ÂÆåÊàêÂêéÔºåÂ∫îËØ•Ôºö                                                                                                                         
  - A) ÊòæÁ§∫ÂÆåÊàêÂç°ÁâáÂêéÔºåÁ´ãÂç≥ÂõûÂà∞ÊôÆÈÄöÂØπËØùÔºàÊó†ÁºùÔºâ                                                                                                 
  - B) ÊòæÁ§∫ÂÆåÊàêÂç°ÁâáÔºåÁî®Êà∑ÁÇπÂáª"ÂºÄÂßãÊñ∞ÂØπËØù"ÂêéÊâçÊ∏ÖÁ©∫ÂçèËÆÆÁä∂ÊÄÅ                                                                                       
  - C) ÂçèËÆÆÂßãÁªà‰øùÊåÅÊøÄÊ¥ªÔºåÂêéÁª≠ÂØπËØùÈÉΩÂü∫‰∫éÂçèËÆÆÁªìÊûú                                                                                                 
                                                                                                                                                
  ÊàëÂª∫ËÆÆ AÔºàÊó†ÁºùËøáÊ∏°ÔºâÔºå‰ΩÜÂú® lifecoach_state ‰∏≠Ê∞∏‰πÖ‰øùÂ≠òÂçèËÆÆÁªìÊûú„ÄÇ                                                                               
                                                                                                                                                
  ---                                                                                                                                           
  Âü∫‰∫éÂâçÁ´ØËÆæËÆ°ÁöÑÂêéÁ´ØÊñπÊ°à                                                                                                                        
                                                                                                                                                
  ÂÅáËÆæ‰Ω†ÈÄâÊã©ÊàëÊé®ËçêÁöÑ B-B-A-A ÁªÑÂêàÔºåËøôÊòØÂÆåÊï¥ÁöÑÂêéÁ´ØËÆæËÆ°Ôºö                                                                                         
                                                                                                                                                
  Êû∂ÊûÑÔºöÂçèËÆÆÁä∂ÊÄÅÊµÅ                                                                                                                              
                                                                                                                                                
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                                               
  ‚îÇ  Áî®Êà∑: "ÊàëÊúÄËøëÂæàËø∑Ëå´"                                        ‚îÇ                                                                              
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  CoreAgent: Ê£ÄÊµãÂà∞Ëß¶ÂèëËØç ‚Üí Êé®ËçêÂçèËÆÆ                         ‚îÇ                                                                               
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  Tool Call: show_protocol_invitation({                      ‚îÇ                                                                               
  ‚îÇ    protocol_id: "dankoe",                                   ‚îÇ                                                                               
  ‚îÇ    title: "Dan Koe Âø´ÈÄüÈáçÁΩÆ",                               ‚îÇ                                                                               
  ‚îÇ    description: "10ÂàÜÈíüÂ∏Æ‰Ω†ÁêÜÊ∏ÖÊÄùË∑Ø",                        ‚îÇ                                                                              
  ‚îÇ    actions: [{label: "ÂºÄÂßãÈáçÁΩÆ", value: "start"}, ...]     ‚îÇ                                                                                
  ‚îÇ  })                                                         ‚îÇ                                                                               
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  SSE Event: 2:["protocol_invitation", {...}]                ‚îÇ                                                                               
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                                               
                                                                                                                                                
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                                               
  ‚îÇ  Áî®Êà∑: [ÁÇπÂáª"ÂºÄÂßãÈáçÁΩÆ"] ‚Üí ÂèëÈÄÅ "start"                      ‚îÇ                                                                               
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  CoreAgent: Ê£ÄÊµãÂà∞ÂçèËÆÆÂêØÂä®ËØ∑Ê±Ç                              ‚îÇ                                                                               
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  1. ÂàùÂßãÂåñÂçèËÆÆÁä∂ÊÄÅ:                                          ‚îÇ                                                                              
  ‚îÇ     lifecoach_state.protocol = {                            ‚îÇ                                                                               
  ‚îÇ       id: "dankoe",                                         ‚îÇ                                                                               
  ‚îÇ       step: 1,                                              ‚îÇ                                                                               
  ‚îÇ       started_at: "2026-01-20T10:00:00Z",                   ‚îÇ                                                                               
  ‚îÇ       data: {}                                              ‚îÇ                                                                               
  ‚îÇ     }                                                       ‚îÇ                                                                               
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  2. ÂèëÈÄÅÊ¨¢ËøéËØ≠ + ËøõÂ∫¶‰∫ã‰ª∂:                                   ‚îÇ                                                                              
  ‚îÇ     SSE: 0:"Â•ΩÁöÑÔºåÊàë‰ª¨Êù•ÂÅö‰∏ÄÊ¨°Âø´ÈÄüÈáçÁΩÆ..."                  ‚îÇ                                                                               
  ‚îÇ     SSE: 2:["protocol_progress", {                          ‚îÇ                                                                               
  ‚îÇ       protocol_id: "dankoe",                                ‚îÇ                                                                               
  ‚îÇ       step: 1,                                              ‚îÇ                                                                               
  ‚îÇ       total_steps: 6,                                       ‚îÇ                                                                               
  ‚îÇ       phase: "Phase 1: ËßâÈÜí",                               ‚îÇ                                                                               
  ‚îÇ       progress: 0.17                                        ‚îÇ                                                                               
  ‚îÇ     }]                                                      ‚îÇ                                                                               
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  3. ÊèêÂá∫Á¨¨‰∏Ä‰∏™ÈóÆÈ¢ò                                           ‚îÇ                                                                              
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                                               
                                                                                                                                                
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                                               
  ‚îÇ  Áî®Êà∑ÂõûÁ≠îÁ¨¨1‰∏™ÈóÆÈ¢ò                                           ‚îÇ                                                                              
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  CoreAgent (with protocol_prompt):                          ‚îÇ                                                                               
  ‚îÇ    - ËØÜÂà´ËøôÊòØÂçèËÆÆÁ¨¨1Ê≠•ÁöÑÂõûÁ≠î                                 ‚îÇ                                                                              
  ‚îÇ    - Ë∞ÉÁî® write_lifecoach_state ‰øùÂ≠òÊï∞ÊçÆ                    ‚îÇ                                                                               
  ‚îÇ    - Ëá™Âä®ËøáÊ∏°Âà∞Á¨¨2Ê≠•                                         ‚îÇ                                                                              
  ‚îÇ         ‚Üì                                                    ‚îÇ                                                                              
  ‚îÇ  SSE: 9:["tool_call_start", {name:"write_lifecoach_state"}] ‚îÇ                                                                               
  ‚îÇ  SSE: a:["tool_call_result", {...}]                         ‚îÇ                                                                               
  ‚îÇ  SSE: 2:["protocol_progress", {                             ‚îÇ                                                                               
  ‚îÇ       step: 2,                                              ‚îÇ                                                                               
  ‚îÇ       progress: 0.33,                                       ‚îÇ                                                                               
  ‚îÇ       ...                                                   ‚îÇ                                                                               
  ‚îÇ     }]                                                      ‚îÇ                                                                               
  ‚îÇ  SSE: 0:"Â•ΩÔºåÊé•‰∏ãÊù•..."                                     ‚îÇ                                                                               
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                                               
                                                                                                                                                
  Ê†∏ÂøÉÂÆûÁé∞ÔºöÊâ©Â±ï AI SDK Data Stream Protocol                                                                                                    
                                                                                                                                                
  1. Êñ∞Â¢ûÂçèËÆÆÁõ∏ÂÖ≥‰∫ã‰ª∂Á±ªÂûã                                                                                                                       
                                                                                                                                                
  # services/agent/stream_adapter.py                                                                                                            
                                                                                                                                                
  class AISDKv6Adapter(BaseStreamAdapter):                                                                                                      
      async def adapt(self, events: AsyncGenerator[AgentEvent, None]):                                                                          
          # Áé∞ÊúâÈÄªËæë...                                                                                                                         
                                                                                                                                                
          async for event in events:                                                                                                            
              # ...Áé∞Êúâ‰∫ã‰ª∂Â§ÑÁêÜ...                                                                                                              
                                                                                                                                                
              elif event.type == "protocol_invitation":                                                                                         
                  # ÂçèËÆÆÈÇÄËØ∑Âç°Áâá                                                                                                                
                  yield self._format({                                                                                                          
                      "type": "data",                                                                                                           
                      "data": ["protocol_invitation", event.data]                                                                               
                  })                                                                                                                            
                                                                                                                                                
              elif event.type == "protocol_progress":                                                                                           
                  # ÂçèËÆÆËøõÂ∫¶Êõ¥Êñ∞                                                                                                                
                  yield self._format({                                                                                                          
                      "type": "data",                                                                                                           
                      "data": ["protocol_progress", {                                                                                           
                          "protocol_id": event.data.get("protocol_id"),                                                                         
                          "step": event.data.get("step"),                                                                                       
                          "total_steps": event.data.get("total_steps"),                                                                         
                          "phase": event.data.get("phase"),                                                                                     
                          "progress": event.data.get("progress"),  # 0-1                                                                        
                          "step_name": event.data.get("step_name"),                                                                             
                      }]                                                                                                                        
                  })                                                                                                                            
                                                                                                                                                
              elif event.type == "protocol_completed":                                                                                          
                  # ÂçèËÆÆÂÆåÊàê                                                                                                                    
                  yield self._format({                                                                                                          
                      "type": "data",                                                                                                           
                      "data": ["protocol_completed", {                                                                                          
                          "protocol_id": event.data.get("protocol_id"),                                                                         
                          "summary": event.data.get("summary"),                                                                                 
                      }]                                                                                                                        
                  })                                                                                                                            
                                                                                                                                                
  2. CoreAgent ÂçèËÆÆÊÑüÁü•ÈÄªËæë                                                                                                                     
                                                                                                                                                
  # services/agent/core.py                                                                                                                      
                                                                                                                                                
  class CoreAgent:                                                                                                                              
      async def run(self, message: str, context: AgentContext):                                                                                 
          # Ê£ÄÊü•ÊòØÂê¶Âú®ÂçèËÆÆ‰∏≠                                                                                                                    
          protocol_state = await self._get_protocol_state(context)                                                                              
                                                                                                                                                
          if protocol_state:                                                                                                                    
              # ÂçèËÆÆÊ®°ÂºèÔºöÊ≥®ÂÖ• protocol_prompt                                                                                                  
              context.protocol_prompt = self._build_protocol_prompt(                                                                            
                  protocol_state, context                                                                                                       
              )                                                                                                                                 
              # ÂèëÈÄÅËøõÂ∫¶‰∫ã‰ª∂                                                                                                                    
              yield AgentEvent(                                                                                                                 
                  type="protocol_progress",                                                                                                     
                  data={                                                                                                                        
                      "protocol_id": protocol_state["id"],                                                                                      
                      "step": protocol_state["step"],                                                                                           
                      "total_steps": 6,  # ‰ªéÈÖçÁΩÆËØªÂèñ                                                                                           
                      "phase": "Phase 1: ËßâÈÜí",  # ‰ªéÈÖçÁΩÆËØªÂèñ                                                                                   
                      "progress": protocol_state["step"] / 6,                                                                                   
                      "step_name": "ÊåÅÁª≠ÁöÑ‰∏çÊª°",                                                                                                
                  }                                                                                                                             
              )                                                                                                                                 
                                                                                                                                                
          # ÊâßË°å LLM Ë∞ÉÁî®                                                                                                                       
          async for event in self._llm_stream(message, context):                                                                                
              yield event                                                                                                                       
                                                                                                                                                
              # Ê£ÄÊµãÂçèËÆÆÊ≠•È™§ÂÆåÊàêÔºàÈÄöËøáÂ∑•ÂÖ∑Ë∞ÉÁî®Ôºâ                                                                                                
              if event.type == "tool_result":                                                                                                   
                  if event.data.get("tool_name") == "write_lifecoach_state":                                                                    
                      # Ê≠•È™§ÂÆåÊàêÔºåÊõ¥Êñ∞ÂçèËÆÆÁä∂ÊÄÅ                                                                                                  
                      await self._advance_protocol_step(context, protocol_state)                                                                
                                                                                                                                                
                      # ÂèëÈÄÅËøõÂ∫¶Êõ¥Êñ∞                                                                                                            
                      yield AgentEvent(                                                                                                         
                          type="protocol_progress",                                                                                             
                          data={                                                                                                                
                              "step": protocol_state["step"] + 1,                                                                               
                              ...                                                                                                               
                          }                                                                                                                     
                      )                                                                                                                         
                                                                                                                                                
      async def _get_protocol_state(self, context: AgentContext) -> Optional[Dict]:                                                             
          """Ëé∑ÂèñÂΩìÂâçÂçèËÆÆÁä∂ÊÄÅ"""                                                                                                                
          if not context.user_id or context.skill != "lifecoach":                                                                               
              return None                                                                                                                       
                                                                                                                                                
          data = await UnifiedProfileRepository.read_life_context_path(                                                                         
              context.user_id, "lifecoach"                                                                                                      
          )                                                                                                                                     
          protocol = data.get("protocol", {})                                                                                                   
                                                                                                                                                
          # Âè™ËøîÂõûËøõË°å‰∏≠ÁöÑÂçèËÆÆ                                                                                                                  
          if protocol.get("id") and not protocol.get("completed"):                                                                              
              return protocol                                                                                                                   
          return None                                                                                                                           
                                                                                                                                                
      async def _advance_protocol_step(self, context: AgentContext, protocol_state: Dict):                                                      
          """Êé®ËøõÂçèËÆÆÊ≠•È™§"""                                                                                                                    
          current_step = protocol_state.get("step", 1)                                                                                          
          config = load_protocol_config(protocol_state["id"])                                                                                   
                                                                                                                                                
          if current_step >= config["total_steps"]:                                                                                             
              # ÂçèËÆÆÂÆåÊàê                                                                                                                        
              await UnifiedProfileRepository.write_life_context_path(                                                                           
                  context.user_id,                                                                                                              
                  "lifecoach.protocol.completed",                                                                                               
                  True                                                                                                                          
              )                                                                                                                                 
              yield AgentEvent(                                                                                                                 
                  type="protocol_completed",                                                                                                    
                  data={"protocol_id": protocol_state["id"]}                                                                                    
              )                                                                                                                                 
          else:                                                                                                                                 
              # Êõ¥Êñ∞Ê≠•È™§                                                                                                                        
              await UnifiedProfileRepository.write_life_context_path(                                                                           
                  context.user_id,                                                                                                              
                  "lifecoach.protocol.step",                                                                                                    
                  current_step + 1                                                                                                              
              )                                                                                                                                 
                                                                                                                                                
  3. ÂçèËÆÆËß¶ÂèëÂ∑•ÂÖ∑                                                                                                                               
                                                                                                                                                
  # skills/lifecoach/tools/tools.yaml                                                                                                           
                                                                                                                                                
  - name: show_protocol_invitation                                                                                                              
    description: ÂêëÁî®Êà∑Êé®ËçêÂºÄÂßã‰∏Ä‰∏™ÂçèËÆÆÔºàÂ¶Ç Dan Koe Âø´ÈÄüÈáçÁΩÆÔºâ                                                                                  
    tool_type: display                                                                                                                          
    parameters:                                                                                                                                 
      - name: protocol_id                                                                                                                       
        type: string                                                                                                                            
        required: true                                                                                                                          
      - name: title                                                                                                                             
        type: string                                                                                                                            
        required: true                                                                                                                          
      - name: description                                                                                                                       
        type: string                                                                                                                            
        required: true                                                                                                                          
      - name: estimated_time                                                                                                                    
        type: string                                                                                                                            
        required: false                                                                                                                         
      - name: actions                                                                                                                           
        type: array                                                                                                                             
        required: true                                                                                                                          
                                                                                                                                                
  # skills/lifecoach/tools/handlers.py                                                                                                          
                                                                                                                                                
  @tool_handler("show_protocol_invitation")                                                                                                     
  async def show_protocol_invitation(args: Dict, context: ToolContext) -> Dict:                                                                 
      """ÊòæÁ§∫ÂçèËÆÆÈÇÄËØ∑Âç°Áâá"""                                                                                                                    
      return {                                                                                                                                  
          "cardType": "protocol_invitation",                                                                                                    
          "protocol_id": args["protocol_id"],                                                                                                   
          "title": args["title"],                                                                                                               
          "description": args["description"],                                                                                                   
          "estimated_time": args.get("estimated_time"),                                                                                         
          "actions": args["actions"],  # [{label: "ÂºÄÂßãÈáçÁΩÆ", value: "start"}, ...]                                                             
      }                                                                                                                                         
                                                                                                                                                
  ÂâçÁ´ØÂØπÊé•                                                                                                                                      
                                                                                                                                                
  1. useVibeChat Êâ©Â±ï                                                                                                                           
                                                                                                                                                
  // hooks/useVibeChat.ts                                                                                                                       
                                                                                                                                                
  export interface ProtocolState {                                                                                                              
    id: string;                                                                                                                                 
    step: number;                                                                                                                               
    totalSteps: number;                                                                                                                         
    phase: string;                                                                                                                              
    progress: number; // 0-1                                                                                                                    
    stepName: string;                                                                                                                           
  }                                                                                                                                             
                                                                                                                                                
  export function useVibeChat(options) {                                                                                                        
    const [protocolState, setProtocolState] = useState<ProtocolState | null>(null);                                                             
                                                                                                                                                
    const chat = useChat({                                                                                                                      
      // ...Áé∞ÊúâÈÖçÁΩÆ...                                                                                                                         
                                                                                                                                                
      // AI SDK 4.x ÊîØÊåÅËá™ÂÆö‰πâ data Â§ÑÁêÜ                                                                                                        
      onToolCall: (toolCall) => {                                                                                                               
        // Â§ÑÁêÜÂ∑•ÂÖ∑Ë∞ÉÁî®                                                                                                                         
      },                                                                                                                                        
                                                                                                                                                
      // Êâ©Â±ïÔºöÁõëÂê¨Ëá™ÂÆö‰πâ‰∫ã‰ª∂                                                                                                                   
      experimental_onFunctionCall: async ({ messages }) => {                                                                                    
        // Ê£ÄÊµã protocol_progress ‰∫ã‰ª∂                                                                                                          
        const lastMessage = messages[messages.length - 1];                                                                                      
        if (lastMessage.data) {                                                                                                                 
          const [eventType, eventData] = lastMessage.data;                                                                                      
                                                                                                                                                
          if (eventType === "protocol_progress") {                                                                                              
            setProtocolState(eventData);                                                                                                        
          } else if (eventType === "protocol_completed") {                                                                                      
            setProtocolState(null); // Ê∏ÖÁ©∫ÂçèËÆÆÁä∂ÊÄÅ                                                                                             
          }                                                                                                                                     
        }                                                                                                                                       
      },                                                                                                                                        
    });                                                                                                                                         
                                                                                                                                                
    return {                                                                                                                                    
      ...chat,                                                                                                                                  
      protocolState, // Êñ∞Â¢ûÔºöÂçèËÆÆÁä∂ÊÄÅ                                                                                                          
    };                                                                                                                                          
  }                                                                                                                                             
                                                                                                                                                
  2. ChatContainer Â±ïÁ§∫ËøõÂ∫¶Êù°                                                                                                                   
                                                                                                                                                
  // components/chat/ChatContainer.tsx                                                                                                          
                                                                                                                                                
  export function ChatContainer({ skillId }: ChatContainerProps) {                                                                              
    const { messages, protocolState, sendMessage } = useVibeChat({ skillId });                                                                  
                                                                                                                                                
    return (                                                                                                                                    
      <div>                                                                                                                                     
        {/* ÂçèËÆÆËøõÂ∫¶Êù°ÔºàÂÜÖËÅîÂú®ÂØπËØùÊµÅ‰∏≠Ôºâ */}                                                                                                    
        {protocolState && (                                                                                                                     
          <ProtocolProgressCard                                                                                                                 
            protocol={protocolState.id}                                                                                                         
            step={protocolState.step}                                                                                                           
            totalSteps={protocolState.totalSteps}                                                                                               
            phase={protocolState.phase}                                                                                                         
            progress={protocolState.progress}                                                                                                   
            stepName={protocolState.stepName}                                                                                                   
          />                                                                                                                                    
        )}                                                                                                                                      
                                                                                                                                                
        {/* Ê∂àÊÅØÂàóË°® */}                                                                                                                        
        {messages.map(msg => <ChatMessage key={msg.id} message={msg} />)}                                                                       
      </div>                                                                                                                                    
    );                                                                                                                                          
  }                                                                                                                                             
                                                                                                                                                
  3. ProtocolProgressCard ÁªÑ‰ª∂                                                                                                                  
                                                                                                                                                
  // components/lifecoach/ProtocolProgressCard.tsx                                                                                              
                                                                                                                                                
  export function ProtocolProgressCard({                                                                                                        
    protocol,                                                                                                                                   
    step,                                                                                                                                       
    totalSteps,                                                                                                                                 
    phase,                                                                                                                                      
    progress,                                                                                                                                   
    stepName                                                                                                                                    
  }: ProtocolState) {                                                                                                                           
    return (                                                                                                                                    
      <div className="my-4 rounded-lg border border-primary/20 bg-primary/5 p-4">                                                               
        <div className="flex items-center justify-between mb-2">                                                                                
          <span className="text-sm font-medium">                                                                                                
            üìä {getProtocolName(protocol)} - ËøõÂ∫¶ {step}/{totalSteps}                                                                           
          </span>                                                                                                                               
          <span className="text-xs text-muted-foreground">{phase}</span>                                                                        
        </div>                                                                                                                                  
                                                                                                                                                
        {/* ËøõÂ∫¶Êù° */}                                                                                                                          
        <div className="h-2 bg-muted rounded-full overflow-hidden">                                                                             
          <div                                                                                                                                  
            className="h-full bg-primary transition-all duration-500"                                                                           
            style={{ width: `${progress * 100}%` }}                                                                                             
          />                                                                                                                                    
        </div>                                                                                                                                  
                                                                                                                                                
        {stepName && (                                                                                                                          
          <p className="text-xs text-muted-foreground mt-2">                                                                                    
            ÂΩìÂâçÊ≠•È™§Ôºö{stepName}                                                                                                                
          </p>                                                                                                                                  
        )}                                                                                                                                      
      </div>                                                                                                                                    
    );                                                                                                                                          
  }                                                                                                                                             
                                                                                                                                                
  Êï∞ÊçÆÊµÅÊÄªÁªì                                                                                                                                    
                                                                                                                                                
  Áî®Êà∑ËæìÂÖ•                                                                                                                                      
     ‚Üì                                                                                                                                          
  CoreAgent.run()                                                                                                                               
     ‚Üì                                                                                                                                          
  Ê£ÄÊµãÂçèËÆÆÁä∂ÊÄÅ                                                                                                                                  
     ‚îú‚îÄ Êó†ÂçèËÆÆ ‚Üí Ê≠£Â∏∏ÂØπËØùÊµÅ                                                                                                                     
     ‚îî‚îÄ ÊúâÂçèËÆÆ ‚Üí Ê≥®ÂÖ• protocol_prompt                                                                                                           
           ‚Üì                                                                                                                                    
        LLM ÁîüÊàêÂõûÂ§ç                                                                                                                            
           ‚îú‚îÄ ÂèëÈÄÅÊñáÊú¨ (0:"content")                                                                                                            
           ‚îú‚îÄ Ë∞ÉÁî®Â∑•ÂÖ∑ (9:, a:)                                                                                                                 
           ‚îî‚îÄ ÂèëÈÄÅËøõÂ∫¶ (2:["protocol_progress", {...}])                                                                                         
           ‚Üì                                                                                                                                    
        ÂâçÁ´Ø useVibeChat ÁõëÂê¨                                                                                                                   
           ‚îú‚îÄ ÊñáÊú¨ ‚Üí ÊòæÁ§∫Âú®Ê∂àÊÅØÂàóË°®                                                                                                             
           ‚îú‚îÄ Â∑•ÂÖ∑Ë∞ÉÁî® ‚Üí Ê∏≤ÊüìÂç°Áâá                                                                                                               
           ‚îî‚îÄ protocol_progress ‚Üí Êõ¥Êñ∞ËøõÂ∫¶Êù°                                                                                                    
                                                                                                                                                
  ---                                                                                                                                           
  ‰∏ã‰∏ÄÊ≠•Ë°åÂä®                                                                                                                                    
                                                                                                                                                
  ËØ∑Á°ÆËÆ§ÊàëÁöÑ4‰∏™ÈóÆÈ¢òÁöÑÁ≠îÊ°àÔºåÁÑ∂ÂêéÊàëÂ∞ÜÊèê‰æõÂÆåÊï¥ÁöÑÂÆûÁé∞‰ª£Á†ÅÔºö                                                                                         
                                                                                                                                                
  1. ÂçèËÆÆËß¶ÂèëÔºöB) ÂêéÁ´ØÂ∑•ÂÖ∑Ë∞ÉÁî®Ôºü                                                                                                                
  2. ËøõÂ∫¶Êï∞ÊçÆÔºöB) SSEËá™ÂÆö‰πâ‰∫ã‰ª∂Ôºü                                                                                                               
  3. ‰∏≠Êñ≠ÊÅ¢Â§çÔºöA) Ëá™Âä®ÁªßÁª≠Ôºü                                                                                                                    
  4. ÂÆåÊàêËøáÊ∏°ÔºöA) Êó†ÁºùËøáÊ∏°Ôºü                                                                                                                    
                                                                                                                                                
  Á°ÆËÆ§ÂêéÔºåÊàëÂ∞ÜÁ´ãÂç≥ÂºÄÂßãÂÆûÊñΩ„ÄÇÈ¢ÑËÆ°Â∑•‰ΩúÈáèÔºö                                                                                                        
  - P0 ÂêéÁ´ØÊ†∏ÂøÉÈÄªËæëÔºö3Â∞èÊó∂                                                                                                                      
  - P1 ÂâçÁ´ØËøõÂ∫¶Â±ïÁ§∫Ôºö2Â∞èÊó∂                                                                                                                      
  - P2 ÊµãËØïÂíåË∞É‰ºòÔºö2Â∞èÊó∂                                                                                                                        
                                                                                                                                                
  ÊÄªËÆ°Ôºö1‰∏™Â∑•‰ΩúÊó•ÂÆåÊàêÂÜÖËÅîÂµåÂÖ•ÂçèËÆÆÊµÅ„ÄÇ                                                                           