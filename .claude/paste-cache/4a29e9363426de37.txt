                        架构改进建议                                            │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                                                                                 │
  │  1. 订阅服务抽象层                                                               │
  │  ════════════════════════════════════════════════════════════════════════════  │
  │                                                                                 │
  │    现状: 订阅逻辑散落在 payment.py webhook handler 中                            │
  │    建议: 新建 services/subscription/subscription_service.py                      │
  │                                                                                 │
  │    ┌────────────────────────────────────────────────────────────────────────┐  │
  │    │  class SubscriptionService:                                            │  │
  │    │      async def create_prepaid(user_id, days, payment_id)              │  │
  │    │      async def create_subscription(user_id, stripe_sub_id)            │  │
  │    │      async def get_active(user_id) -> Subscription | None             │  │
  │    │      async def check_entitlement(user_id, feature) -> bool            │  │
  │    │      async def extend(user_id, days)                                  │  │
  │    │      async def cancel(user_id)                                        │  │
  │    │      async def get_expiring_soon(days_before=7) -> List[Subscription] │  │
  │    └────────────────────────────────────────────────────────────────────────┘  │
  │                                                                                 │
  │  2. 通知服务统一                                                                 │
  │  ════════════════════════════════════════════════════════════════════════════  │
  │                                                                                 │
  │    现状: 无统一通知出口                                                          │
  │    建议: 新建 services/notification/notification_service.py                      │
  │                                                                                 │
  │    ┌────────────────────────────────────────────────────────────────────────┐  │
  │    │  class NotificationService:                                            │  │
  │    │      async def send_email(to, template, data)                         │  │
  │    │      async def send_sms(phone, template, data)                        │  │
  │    │      async def send_push(user_id, title, body)                        │  │
  │    │      async def send_wechat(openid, template_id, data)  # 未来         │  │
  │    └────────────────────────────────────────────────────────────────────────┘  │
  │                                                                                 │
  │  3. 权限检查统一                                                                 │
  │  ════════════════════════════════════════════════════════════════════════════  │
  │                                                                                 │
  │    现状: get_current_user() 只返回身份，不含权限                                 │
  │    建议: 扩展 CurrentUser 或新增依赖                                             │
  │                                                                                 │
  │    ┌────────────────────────────────────────────────────────────────────────┐  │
  │    │  class CurrentUser:                                                    │  │
  │    │      user_id: UUID                                                    │  │
  │    │      vibe_id: str                                                     │  │
  │    │      tier: Literal["guest", "free", "premium"]  # 新增                │  │
  │    │      subscription: Optional[Subscription]       # 新增                │  │
  │    │                                                                        │  │
  │    │      def can(self, feature: str) -> bool:                             │  │
  │    │          if self.tier == "premium": return True                       │  │
  │    │          return feature in FREE_FEATURES                              │  │
  │    └────────────────────────────────────────────────────────────────────────┘  │
  │                                                                                 │