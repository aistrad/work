修复完成                                                                                                                                   
                                                                                                                                             
  修复的文件列表                                                                                                                             
  ┌─────────────────────────────────────────────────────┬────────────────────────────────────────────────────────────────┐                   
  │                        文件                         │                            修改内容                            │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ 核心数据层                                          │                                                                │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ stores/unified_profile_repo.py                      │ 添加 Vibe 层方法、兼容层读写                                   │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ stores/profile_cache.py                             │ 更新 get_cached_profile_with_skill 使用兼容层                  │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ Prompt 构建                                         │                                                                │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ services/agent/prompt_builder.py                    │ 三层架构注入（Identity + Skills + Vibe）                       │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ services/agent/skill_loader.py                      │ 更新 _build_persona_prompt 和 build_system_prompt              │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ services/agent/context_manager.py                   │ 更新 get_profile_context 和 get_shared_context                 │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ Lifecoach                                           │                                                                │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ skills/lifecoach/services/api.py                    │ 使用兼容层读写数据                                             │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ Proactive 服务                                      │                                                                │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ services/proactive/content_generator.py             │ 添加 get_skill_data_compat 和 get_user_context_compat 辅助函数 │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ services/proactive/trigger_detector.py              │ 更新 _get_lifecoach_data 方法                                  │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ 迁移脚本                                            │                                                                │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ stores/migrations/024_migrate_to_vibeprofile_v8.sql │ SQL 迁移脚本                                                   │                   
  ├─────────────────────────────────────────────────────┼────────────────────────────────────────────────────────────────┤                   
  │ scripts/run_migration_024.py                        │ Python 迁移运行脚本                                            │                   
  └─────────────────────────────────────────────────────┴────────────────────────────────────────────────────────────────┘                   
  兼容层策略                                                                                                                                 
                                                                                                                                             
  所有修改都使用渐进式迁移策略：                                                                                                             
                                                                                                                                             
  读取顺序：skills.{skill_id} → skill_data.{skill_id} → life_context._paths.{skill_id}                                                       
  写入位置：同时写入 skills + skill_data（迁移期）                                                                                           
                                                                                                                                             
  下一步                                                                                                                                     
                                                                                                                                             
  1. 运行迁移脚本：                                                                                                                          
  python apps/api/scripts/run_migration_024.py --dry-run  # 预览                                                                             
  python apps/api/scripts/run_migration_024.py            # 执行                                                                             
  2. 验证：测试 lifecoach、bazi、zodiac 等 Skill 功能正常                                                                                    
  3. 清理（后续）：迁移完成后，移除旧结构的回退逻辑                                       