❯ 文档输出到/home/aiscend/work/vibelife/docs/archive/v6 

● Write(docs/archive/v6/user-registration-payment-flow-analysis.md)
  ⎿  Wrote 648 lines to docs/archive/v6/user-registration-payment-flow-analysis.md
      1 # VibeLife 用户注册/管理/收费流程分析报告
      2 > **版本**: v1.0
      3 > **日期**: 2026-01-15
      4 > **类型**: Ultra Deep Analysis Report
      5 ---
      6 ## 一、用户全生命周期流程图
     … +638 lines (ctrl+o to expand)

● 已将完整分析报告输出到:

  /home/aiscend/work/vibelife/docs/archive/v6/user-registration-payment-flow-analysis.md

  文档内容包括:
  ┌──────────────┬────────────────────────────────────────────────────────┐
  │     章节     │                          内容                          │
  ├──────────────┼────────────────────────────────────────────────────────┤
  │ 一、流程图   │ 身份状态机、注册详图、支付双轨制、用户管理、数据表关系 │
  ├──────────────┼────────────────────────────────────────────────────────┤
  │ 二、现状评估 │ 5个优点 + 10个问题（按 P0/P1/P2 分级）                 │
  ├──────────────┼────────────────────────────────────────────────────────┤
  │ 三、优化方案 │ 3阶段路线图 + 3个架构改进建议 + 关键指标               │
  ├──────────────┼────────────────────────────────────────────────────────┤
  │ 四、行动建议 │ 立即/短期/中期/长期优先级排序                          │
  ├──────────────┼────────────────────────────────────────────────────────┤
  │ 附录         │ 相关文件索引                                           │
  └──────────────┴────────────────────────────────────────────────────────┘

✻ Sautéed for 3m 14s

❯ /ultra 设计架构。                        架构改进建议                                            │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                                                                                 │
  │  1. 订阅服务抽象层                                                               │
  │  ════════════════════════════════════════════════════════════════════════════  │
  │                                                                                 │
  │    现状: 订阅逻辑散落在 payment.py webhook handler 中                            │
  │    建议: 新建 services/subscription/subscription_service.py                      │
  │                                                                                 │
  │    ┌────────────────────────────────────────────────────────────────────────┐  │
  │    │  class SubscriptionService:                                            │  │
  │    │      async def create_prepaid(user_id, days, payment_id)              │  │
  │    │      async def create_subscription(user_id, stripe_sub_id)            │  │
  │    │      async def get_active(user_id) -> Subscription | None             │  │
  │    │      async def check_entitlement(user_id, feature) -> bool            │  │
  │    │      async def extend(user_id, days)                                  │  │
  │    │      async def cancel(user_id)                                        │  │
  │    │      async def get_expiring_soon(days_before=7) -> List[Subscription] │  │
  │    └────────────────────────────────────────────────────────────────────────┘  │
  │                                                                                 │
  │  2. 通知服务统一                                                                 │
  │  ════════════════════════════════════════════════════════════════════════════  │
  │                                                                                 │
  │    现状: 无统一通知出口                                                          │
  │    建议: 新建 services/notification/notification_service.py                      │
  │                                                                                 │
  │    ┌────────────────────────────────────────────────────────────────────────┐  │
  │    │  class NotificationService:                                            │  │
  │    │      async def send_email(to, template, data)                         │  │
  │    │      async def send_sms(phone, template, data)                        │  │
  │    │      async def send_push(user_id, title, body)                        │  │
  │    │      async def send_wechat(openid, template_id, data)  # 未来         │  │
  │    └────────────────────────────────────────────────────────────────────────┘  │
  │                                                                                 │
  │  3. 权限检查统一                                                                 │
  │  ════════════════════════════════════════════════════════════════════════════  │
  │                                                                                 │
  │    现状: get_current_user() 只返回身份，不含权限                                 │
  │    建议: 扩展 CurrentUser 或新增依赖                                             │
  │                                                                                 │
  │    ┌────────────────────────────────────────────────────────────────────────┐  │
  │    │  class CurrentUser:                                                    │  │
  │    │      user_id: UUID                                                    │  │
  │    │      vibe_id: str                                                     │  │
  │    │      tier: Literal["guest", "free", "premium"]  # 新增                │  │
  │    │      subscription: Optional[Subscription]       # 新增                │  │
  │    │                                                                        │  │
  │    │      def can(self, feature: str) -> bool:                             │  │
  │    │          if self.tier == "premium": return True                       │  │
  │    │          return feature in FREE_FEATURES                              │  │
  │    └────────────────────────────────────────────────────────────────────────┘  │
  │                                                                                 │ 

● 我将基于之前的分析，设计完整的架构方案。先让我深入阅读现有的相关代码结构。

● Read(apps/api/services/billing/subscription.py)
  ⎿  Read 480 lines

● Read(apps/api/services/entitlement/__init__.py)
  ⎿  Read 5 lines

● Search(pattern: "apps/api/services/entitlement/**/*.py")
  ⎿  Found 2 files (ctrl+o to expand)

● Search(pattern: "apps/api/stores/*_repo.py")
  ⎿  Found 13 files (ctrl+o to expand)

● 让我继续阅读相关文件以了解完整架构。

● Read(apps/api/services/entitlement/service.py)
  ⎿  Read 157 lines

● Read(apps/api/stores/subscription_repo.py)
  ⎿  Read 260 lines

● Read(apps/api/services/identity/usage_limits.py)
  ⎿  Read 137 lines

● 基于对现有代码的深度阅读，我发现：

  1. SubscriptionService 已存在但未被 webhook 使用
  2. EntitlementService 和 UsageLimitsService 有功能重叠
  3. CurrentUser 不含权限信息

  让我设计一个统一的架构方案并输出文档。

● Write(docs/archive/v6/subscription-architecture-design.md)
  ⎿  Wrote 1143 lines to docs/archive/v6/subscription-architecture-design.md
      1 # VibeLife 订阅与权限系统架构设计
      2 > **版本**: v1.0
      3 > **日期**: 2026-01-15
      4 > **状态**: 设计文档
      5 ---
      6 ## 一、现状分析
     … +1133 lines (ctrl+o to expand)