---                                                                                                                                            
  🔍 方案 B 分析报告评估                                                                                                                         
                                                                                                                                                 
  一、报告准确性验证                                                                                                                             
  ┌─────────────────────┬─────────────┬───────────────────────────────────────────────────────────────────┐                                      
  │       验证项        │    状态     │                               说明                                │                                      
  ├─────────────────────┼─────────────┼───────────────────────────────────────────────────────────────────┤                                      
  │ vibe_users 使用场景 │ ✅ 准确     │ OAuth.py:116/260, wechat.py:319 行号正确                          │                                      
  ├─────────────────────┼─────────────┼───────────────────────────────────────────────────────────────────┤                                      
  │ 字段迁移对照表      │ ⚠️ 有误     │ 报告写 profile.identity.birth_info，实际代码是 profile.birth_info │                                      
  ├─────────────────────┼─────────────┼───────────────────────────────────────────────────────────────────┤                                      
  │ 需修改的文件清单    │ ✅ 基本准确 │ 12个文件识别正确                                                  │                                      
  ├─────────────────────┼─────────────┼───────────────────────────────────────────────────────────────────┤                                      
  │ DB Trigger 范围     │ ✅ 准确     │ 确实只监听 vibe_id, display_name, status                          │                                      
  ├─────────────────────┼─────────────┼───────────────────────────────────────────────────────────────────┤                                      
  │ 工作量估算          │ ⚠️ 偏乐观   │ 29h/4天可能不够                                                   │                                      
  └─────────────────────┴─────────────┴───────────────────────────────────────────────────────────────────┘                                      
  二、关键发现：文档与代码不一致 🚨                                                                                                              
                                                                                                                                                 
  ARCHITECTURE.md (设计文档)        vs        unified_profile_repo.py (实际代码)                                                                 
  ───────────────────────────────         ─────────────────────────────────────                                                                  
  profile:                                profile:                                                                                               
    identity:                               birth_info: {...}  # ← 直接平铺                                                                      
      birth_info: {...}  # ← 有嵌套                                                                                                              
                                                                                                                                                 
  这意味着：方案 B 报告的字段映射表需要修正！                                                                                                    
                                                                                                                                                 
  正确的映射应该是：                                                                                                                             
  ┌─────────────────┬───────────────────────────┬──────────────────────────────────────────┐                                                     
  │ vibe_users 字段 │      正确的迁移路径       │             报告中的错误路径             │                                                     
  ├─────────────────┼───────────────────────────┼──────────────────────────────────────────┤                                                     
  │ birth_datetime  │ profile.birth_info.date   │ ~~profile.identity.birth_info.date~~     │                                                     
  ├─────────────────┼───────────────────────────┼──────────────────────────────────────────┤                                                     
  │ birth_location  │ profile.birth_info.place  │ ~~profile.identity.birth_info.location~~ │                                                     
  ├─────────────────┼───────────────────────────┼──────────────────────────────────────────┤                                                     
  │ gender          │ profile.birth_info.gender │ ~~profile.identity.birth_info.gender~~   │                                                     
  └─────────────────┴───────────────────────────┴──────────────────────────────────────────┘                                                     
  三、报告遗漏的问题                                                                                                                             
                                                                                                                                                 
  1. Skill Handlers 也在读数据                                                                                                                   
                                                                                                                                                 
  # apps/api/skills/jungastro/tools/handlers.py:45                                                                                               
  birth_info = profile.get("birth_info", {})  # ← 直接从 profile 读                                                                              
  其他 Skill（bazi, zodiac）也可能有类似读取，需要全面排查。                                                                                     
                                                                                                                                                 
  2. 没有讨论现有数据的实际状态                                                                                                                  
                                                                                                                                                 
  - 现有 unified_profiles 表里有多少记录？                                                                                                       
  - birth_info 字段的填充率是多少？                                                                                                              
  - 两表数据是否已经同步？                                                                                                                       
                                                                                                                                                 
  3. API 兼容性问题                                                                                                                              
                                                                                                                                                 
  - 前端期望的 response 格式是什么？                                                                                                             
  - 是否需要版本控制？                                                                                                                           
                                                                                                                                                 
  四、方案评估总结                                                                                                                               
                                                                                                                                                 
  ✅ 报告做得好的地方                                                                                                                            
                                                                                                                                                 
  1. 全面识别了影响范围 - 12个文件，分模块整理清晰                                                                                               
  2. 风险评估到位 - 数据迁移、注册中断、一致性问题                                                                                               
  3. 渐进式迁移策略正确 - 双写验证期 + 灰度切换                                                                                                  
  4. Feature Flag 思路 - 降低发布风险                                                                                                            
                                                                                                                                                 
  ⚠️ 需要修正的问题                                                                                                                              
                                                                                                                                                 
  1. 字段路径错误 - 不是 identity.birth_info，是直接 birth_info                                                                                  
  2. 工作量低估 - 建议增加 50% buffer，约 6 个工作日                                                                                             
  3. 缺少现状审计 - 需要先跑 SQL 查当前数据状态                                                                                                  
                                                                                                                                                 
  🔴 建议补充的步骤                                                                                                                              
                                                                                                                                                 
  -- 执行前先审计现状                                                                                                                            
  SELECT                                                                                                                                         
      COUNT(*) as total_users,                                                                                                                   
      COUNT(up.user_id) as has_unified_profile,                                                                                                  
      COUNT(CASE WHEN up.profile ? 'birth_info' THEN 1 END) as has_birth_info,                                                                   
      COUNT(CASE WHEN vu.birth_datetime IS NOT NULL THEN 1 END) as vibe_users_has_birth                                                          
  FROM vibe_users vu                                                                                                                             
  LEFT JOIN unified_profiles up ON vu.id = up.user_id                                                                                            
  WHERE vu.status != 'deleted';                                                                                                                  
                                                                                                                                                 
  五、最终建议                                                                                                                                   
  ┌────────────┬───────────┬──────────────────────────┐                                                                                          
  │    维度    │   评分    │           说明           │                                                                                          
  ├────────────┼───────────┼──────────────────────────┤                                                                                          
  │ 技术方向   │ ✅ 正确   │ 统一数据源是对的         │                                                                                          
  ├────────────┼───────────┼──────────────────────────┤                                                                                          
  │ 实施路径   │ ✅ 可行   │ 渐进式迁移策略合理       │                                                                                          
  ├────────────┼───────────┼──────────────────────────┤                                                                                          
  │ 影响评估   │ ⚠️ 80%    │ 核心场景覆盖，遗漏细节   │                                                                                          
  ├────────────┼───────────┼──────────────────────────┤                                                                                          
  │ 工作量估算 │ ⚠️ 偏乐观 │ 建议 6-7 工作日          │                                                                                          
  ├────────────┼───────────┼──────────────────────────┤                                                                                          
  │ 风险控制   │ ✅ 完善   │ 双写、灰度、回滚方案齐全 │                                                                                          
  └────────────┴───────────┴──────────────────────────┘                                                                                          
  ---                                                                                                                                            
  🚀 修正后的执行建议                                                                                                                            
                                                                                                                                                 
  在开始实施前，需要先做三件事：                                                                                                                 
                                                                                                                                                 
  1. 数据审计 - 跑上述 SQL，了解现状                                                                                                             
  2. 修正字段路径 - 报告中所有 identity.birth_info 改为 birth_info                                                                               
  3. 排查 Skill handlers - 确认所有读取 birth_info 的代码                                                                                        
                                                                                                                                                 
  总体评价：方案 B 方向正确，报告质量 85 分，修正数据结构路径后可执行。                                                                          
                                                                                                                                                 
  需要我帮你先执行数据审计，或者修正报告中的错误吗？                                       