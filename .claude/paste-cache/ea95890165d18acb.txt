结论概览

  - V9把“Core 常驻 + 其他技能渐进加载（frontmatter → full）”的两层体系说清了，且以7个原子工具统一交互面，非常可取（docs/archive/v9/
    ARCHITECTURE.md:31, 89, 129）。
  - 需要补全的一致性与落地细节主要集中在：工具类型与版本号统一、Phase 1/2 上下文构建与防注入策略、工具命名/冲突消解、时区/排程/删除语
    义等契约、Skill 装载与缓存/热更新、可观测性与验收测试矩阵。

  主要亮点

  - 渐进式 Skill 选择与加载，优化 token/冷启动（docs/archive/v9/ARCHITECTURE.md:21–29, 83–110）。
  - Core Skill 精简+全程激活，抽象7个原子工具覆盖绝大多数对话/操作路径（docs/archive/v9/ARCHITECTURE.md:89–127, 129–201）。
  - 将“工具合并/删除”与“场景验证/迁移路径”写成表格，降低迁移心智负担（docs/archive/v9/ARCHITECTURE.md:25–44, 45–71, 24–35）。
  - 给出 skill_loader/core 的最小关键接口，为实现落地留出清晰切入点（docs/archive/v9/ARCHITECTURE.md:118–155, 157–174）。

  关键风险与缺口（需尽快修正/明确）

  - 工具“类型/版本号”不一致
      - Core tools.yaml 用 version: "3.0"（docs/archive/v9/ARCHITECTURE.md:132），模板用 version: "2.0"（docs/archive/v9/
        ARCHITECTURE.md:191），且模板出现 type: compute，Core 未定义该类型（仅有 action/collect/search/display）。建议统一一份“工具
        DSL规范V3”，明确可选 type 枚举与字段语义。
  - “description 内嵌工具列表”可读性强但机器可解析性弱
      - 依赖 LLM 解析中文“工具：a,b,c”，在多语言/格式化差异时易脆（docs/archive/v9/ARCHITECTURE.md:75–83, 85）。建议保留人类可读描
        述，同时补充一个可选、机器可读的 tools_list: [..] 数组（或 exposed_tools），由构建器强校验生成。
  - Phase 1/2 上下文构建的“防注入/越权”策略未写清
      - Phase 1 包含所有非Core的 frontmatter 文本（docs/archive/v9/ARCHITECTURE.md:86–93），若其中存在提示词/越权指令，可能污染全局
        System。建议：将 frontmatter 以结构化清单形式注入（仅 id/name/desc/tools_list），并加“不可执行内容屏蔽/转义”策略；同时限制
        Phase 1 仅暴露 activate_skills。
  - 工具命名与冲突消解
      - 多Skill并行下，工具名冲突/相似语义可能发生（docs/archive/v9/ARCHITECTURE.md:15–17, 168–173）。建议规范唯一名：{skill_id}.
        {tool_name}，UI 展示再去前缀。ToolRegistry 侧去重+优先级（Core > 激活技能顺序）。
  - show/卡片协议与可视化 Schema 未落锤
      - show.type 与 card_type 双层枚举（docs/archive/v9/ARCHITECTURE.md:192–201, 1–7）但缺少卡片数据 Schema 与可扩展策略。建议在
        apps/api/services/cards/ 定义卡片注册表与 JSON Schema 校验，避免自由文本破版。
  - remind 计划字段欠严谨
      - schedule: string 不足以表达时区/重复/自然语言解析（docs/archive/v9/ARCHITECTURE.md:21–23）。建议：要求 ISO8601（含TZ），可选
        rrule/timezone/notes，并明确“静默期/冲突处理/去重策略”。
  - save(data=null) 删除语义需契约化
      - 文档有说明但未在工具Schema中声明可空（docs/archive/v9/ARCHITECTURE.md:41, 167–170）。建议 data 允许 null 且定义“幂等、级联、
        验证”规则，避免误删。
  - skill_loader 落地细节缺少缓存/热更新/错误恢复
      - 未定义：失败回退、磁盘缓存、内存上限、LRU策略、文件变更watch、版本校验（docs/archive/v9/ARCHITECTURE.md:139–155）。
  - 数据模型合规/边界
      - PII（birth_info）与行为数据同库（docs/archive/v9/ARCHITECTURE.md:8–20）。建议拆分：PII 区域加密/最小化访问、审计日志、可导出/
        删除权、TTL策略（state/extracted），并声明索引/查询策略。
  - Prompt 约束与执行护栏
      - 未明确“最大工具步数/回退策略/异常兜底文案/计费预算”（docs/archive/v9/ARCHITECTURE.md:113–116）。建议对话回合内设置 Tool
        Budget 与“最终回应超时保护”。

  文档内不一致/建议修订点（精确定位）

  - 统一工具DSL版本与类型枚举
      - Core version: "3.0"（docs/archive/v9/ARCHITECTURE.md:132） vs 模板 version: "2.0"（docs/archive/v9/ARCHITECTURE.md:191）→ 统
        一为 "3.0"。
      - 模板含 type: compute（docs/archive/v9/ARCHITECTURE.md:206–214），Core未定义。建议在规范中补充 compute 或替换为既有枚举。
  - 明确 save(data=null) 删除语义
      - 在工具定义处补充 nullable: true（docs/archive/v9/ARCHITECTURE.md:167–170, 40–43）。
  - show 的 type 与 card_type 的职责说明
      - type 用于用途层（card/skill_list/...），card_type 用于UI形态（table/chart/...）（docs/archive/v9/ARCHITECTURE.md:192–201, 1–
        7）。建议在工具描述中加“层级与示例”。
  - Phase 1 注入的 frontmatter 范围与格式
      - 明确仅注入结构化三元组 id/name/desc|tools_list，禁止规则正文（docs/archive/v9/ARCHITECTURE.md:86–93）。

  落地实现建议

  - 工具DSL（V3，统一规范）
      - 统一字段：version:"3.0" | skill_id | tools[]；tools[].name（唯一，用 {skill}.{tool}）、type（action|collect|display|search|
        compute）、parameters（required/enum/nullable/format），card_type 仅对 display 有效。
      - 增加 security.scopes（访问 profile/skill_data 的权限）与 rate_limit。
  - skill_loader 参考实现要点
      - 冷启动：仅 Core full + 其他 skills 的 frontmatter 索引（缓存到内存+磁盘）。
      - 按需：load_skill_full(id) 带 SHA 校验、大小&token预算门限、解析 rules/ 与 tools/，失败回滚至上一个可用版本（docs/archive/v9/
        ARCHITECTURE.md:141–155）。
      - 运行期：watchman/fsnotify 监听技能目录，热更新时做“结构化lint+schema校验+预编译Prompt段”。
      - 提供 SkillRegistry.list_metas() / get(id) / activate(ids, mode=append|replace)。
  - prompt_builder（Phase 1/2 模板）
      - Phase 1：系统提示 = Core 精简版 + 技能清单（仅结构化）+ 明确指令“只能用 activate_skills；不得擅自假设工具”。输出限制为一次
        activate_skills（docs/archive/v9/ARCHITECTURE.md:90–93）。
      - Phase 2：系统提示 = Core 全文 + 已激活技能全文 + 相关 rules 精选 + Profile 片段（最小必要）+ 可用工具清单。设置“工具步数上限/
        超时/预算提示”（docs/archive/v9/ARCHITECTURE.md:100–110）。
  - ToolRegistry
      - 注册：按 {skill}.{tool} 存储，拉平为展示名时做映射；返回工具清单时自动去重（docs/archive/v9/ARCHITECTURE.md:160–174）。
      - 权限：根据工具声明的 security.scopes 校验路径（save/read 的 path 白名单）。
  - remind 契约
      - schedule 使用 ISO8601；新增 timezone、rrule、silence_window；返回 id/status/next_fire_at。
  - search 契约
      - 增加 corpus/filters/return_fields，并规定结果含 source_id 与 confidence，便于溯源与 UI。

  迁移与发布计划（两周）

  - 第1周
      - 统一DSL与模板：修补 version/type/nullable/schedule 规范与校验脚本。
      - 实现 skill_loader 最小集（索引+按需加载+缓存+去抖热更）。
      - prompt_builder Phase 1/2 模板与“防注入/预算/步数上限”护栏。
  - 第2周
      - Core/tools 重构：落地7个原子工具与 save/read/show/remind 的新契约。
      - 现有技能批量迁移（zodiac/lifecoach 先行），模板化 description+rules 拆分。
      - 加可观测性：技能加载成功率、工具调用成功率/时延、卡片渲染失败率、提醒触发率。
      - 下线 routing.yaml includes 并提供回退兼容层（只记录告警）。

  验收与测试清单

  - 单测
      - skill_loader：frontmatter/全文解析错误回滚；重复激活幂等；缓存命中率。
      - ToolRegistry：命名冲突、去重、权限拒绝用例。
      - remind：时区/夏令时/重复规则/取消/列出；无效ISO8601拒绝。
      - save/read：路径白名单、data=null 删除、并发写入。
  - 集成/E2E
      - Phase 1 只能产出一次 activate_skills；Phase 2 工具步数上限与超时降级到自然语言应答。
      - 典型场景三例与失败场景三例（网络失败/工具异常/权限不足）。
  - 质量闸
      - Core SKILL.md < 500 tokens（CI 统计）；技能 frontmatter/工具DSL Schema 校验必须通过。
      - 回归：V8/V12技能在兼容层不崩（记录告警）。

  开放问题（需产品/工程共同确认）

  - 是否接受在 frontmatter 中加一个可选 tools_list（机器可读）来增强鲁棒性？（docs/archive/v9/ARCHITECTURE.md:85）
  - compute 类型是否纳入正式枚举？若不纳入，模板如何调整？（docs/archive/v9/ARCHITECTURE.md:206–214）
  - Phase 2 允许再次 activate_skills 的阈值与节流策略（避免频繁切换 thrashing）（docs/archive/v9/ARCHITECTURE.md:106–110）。
  - show 的卡片 Schema 是否以 JSON Schema 固化并在网关层校验？（docs/archive/v9/ARCHITECTURE.md:192–201）
  - 用户数据的加密/审计/删除请求（GDPR 风格）与日志保留策略（docs/archive/v9/ARCHITECTURE.md:8–20）。