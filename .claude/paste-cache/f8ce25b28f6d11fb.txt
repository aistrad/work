已验证实现 ✅                                                                                                                                 
  ┌──────────────┬───────────────────────────────┬─────────────────────────────────────────────────────────────────────┐                        
  │     模块     │             文件              │                                状态                                 │                        
  ├──────────────┼───────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                        
  │ 通用数据工具 │ global_handlers.py:323-488    │ ✅ read_state, write_state, append_to_list                          │                        
  ├──────────────┼───────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                        
  │ 协议管理工具 │ lifecoach/handlers.py:661-779 │ ✅ show_protocol_invitation, advance_protocol_step, cancel_protocol │                        
  ├──────────────┼───────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                        
  │ 协议状态恢复 │ chat_v5.py:385-427            │ ✅ get_protocol_state + build_protocol_prompt 注入                  │                        
  ├──────────────┼───────────────────────────────┼─────────────────────────────────────────────────────────────────────┤                        
  │ SSE 事件扩展 │ stream_adapter.py:398-404     │ ✅ protocol_progress, protocol_completed                            │                        
  └──────────────┴───────────────────────────────┴─────────────────────────────────────────────────────────────────────┘                        
  ---                                                                                                                                           
  发现的问题                                                                                                                                    
                                                                                                                                                
  1. 重复装饰器 (lifecoach/handlers.py:661-662)                                                                                                 
  @tool_handler("show_protocol_invitation")                                                                                                     
  @tool_handler("show_protocol_invitation")  # 重复了                                                                                           
  async def show_protocol_invitation(...):                                                                                                      
  需要删除重复的一行。                                                                                                                          
                                                                                                                                                
  2. SSE 事件发送时机不明确                                                                                                                     
                                                                                                                                                
  stream_adapter.py 已支持 protocol_progress 事件，但 chat_v5.py 中没有看到主动发送进度事件的代码。                                             
                                                                                                                                                
  当前流程：                                                                                                                                    
  chat_v5.py → CoreAgent.run() → stream_adapter.adapt()                                                                                         
                                                                                                                                                
  问题：谁负责发送 protocol_progress 事件？                                                                                                     
                                                                                                                                                
  - 方案 A：CoreAgent 发送（但 CoreAgent 不应感知协议）                                                                                         
  - 方案 B：chat_v5.py 在流开始前/后发送（需要额外逻辑）                                                                                        
  - 方案 C：工具调用时发送（如 advance_protocol_step 返回后）                                                                                   
                                                                                                                                                
  建议：在 chat_v5.py 的 generate() 函数中，协议恢复后立即发送一次进度事件：                                                                    
                                                                                                                                                
  # chat_v5.py:420 后添加                                                                                                                       
  if protocol_state and protocol_config:                                                                                                        
      # 发送初始进度事件                                                                                                                        
      progress_event = emit_protocol_progress_event(protocol_state, protocol_config)                                                            
      yield progress_event                                                                                                                      
                                                                                                                                                
  ---                                                                                                                                           
  总结                                                                                                                                          
  ┌──────────────┬────────────────────────────────┐                                                                                             
  │     项目     │              状态              │                                                                                             
  ├──────────────┼────────────────────────────────┤                                                                                             
  │ 后端工具系统 │ ✅ 100%                        │                                                                                             
  ├──────────────┼────────────────────────────────┤                                                                                             
  │ 后端路由集成 │ ⚠️ 95%（缺少主动发送进度事件） │                                                                                             
  ├──────────────┼────────────────────────────────┤                                                                                             
  │ SSE 事件流   │ ✅ 100%                        │                                                                                             
  ├──────────────┼────────────────────────────────┤                                                                                             
  │ 前端 Hook    │ ✅ 100%（据报告）              │                                                                                             
  └──────────────┴────────────────────────────────┘                                                                                             
  建议修复：                                                                                                                                    
  1. 删除重复的 @tool_handler 装饰器                                                                                                            
  2. 在 chat_v5.py 中添加协议进度事件的主动发送                                              