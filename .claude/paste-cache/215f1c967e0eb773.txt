Ultra Analysis Report: ÊñπÊ°à B ÂΩ±ÂìçËåÉÂõ¥ÂàÜÊûê                                                                                                    
                                                                                                                                                
  ‰∏Ä„ÄÅvibe_users Ë°®ÂΩìÂâç‰ΩøÁî®ËÄÖÊ∏ÖÂçï                                                                                                               
                                                                                                                                                
  üìä ÁªüËÆ°Ê¶ÇËßà                                                                                                                                   
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                                                  
  ‚îÇ     Ê®°Âùó     ‚îÇ Êñá‰ª∂Êï∞ ‚îÇ      ‰∏ªË¶ÅÊìç‰Ωú       ‚îÇ ÂΩ±Âìç‰∏•ÈáçÂ∫¶ ‚îÇ                                                                                  
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                                  
  ‚îÇ ËÆ§ËØÅÁ≥ªÁªü     ‚îÇ 5      ‚îÇ CREATE, UPDATE, GET ‚îÇ üî¥ È´ò      ‚îÇ                                                                                  
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                                  
  ‚îÇ Áî®Êà∑ÁÆ°ÁêÜ     ‚îÇ 2      ‚îÇ GET, UPDATE, DELETE ‚îÇ üî¥ È´ò      ‚îÇ                                                                                  
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                                  
  ‚îÇ Ë¥¶Êà∑Âà†Èô§     ‚îÇ 1      ‚îÇ UPDATE, DELETE      ‚îÇ üü° ‰∏≠      ‚îÇ                                                                                  
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                                  
  ‚îÇ ËÆøÂÆ¢Á≥ªÁªü     ‚îÇ 1      ‚îÇ UPDATE              ‚îÇ üü¢ ‰Ωé      ‚îÇ                                                                                  
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                                  
  ‚îÇ Êï∞ÊçÆÂ∫ìËß¶ÂèëÂô® ‚îÇ 3      ‚îÇ SELECT, UPDATE      ‚îÇ üü° ‰∏≠      ‚îÇ                                                                                  
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                                                  
  ---                                                                                                                                           
  üîç ËØ¶ÁªÜ‰ΩøÁî®Âú∫ÊôØÂàÜËß£                                                                                                                           
                                                                                                                                                
  1Ô∏è‚É£ ËÆ§ËØÅ‰∏éÊ≥®ÂÜåÁ≥ªÁªü (üî¥ Ê†∏ÂøÉ‰æùËµñ)                                                                                                               
                                                                                                                                                
  # Êñá‰ª∂: services/identity/oauth.py                                                                                                            
  # ÂäüËÉΩ: Google/Apple OAuth ÁôªÂΩïÊ≥®ÂÜå                                                                                                           
                                                                                                                                                
  UserRepository.create(                                                                                                                        
      display_name=...,                                                                                                                         
      birth_datetime=onboarding_data.get("birth_datetime"),  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ                                                                   
      birth_location=onboarding_data.get("birth_location"),  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ                                                                   
      gender=onboarding_data.get("gender")                                                                                                      
  )                                                                                                                                             
                                                                                                                                                
  # ÂΩ±Âìç: ÊâÄÊúâÊñ∞Áî®Êà∑Ê≥®ÂÜåÊµÅÁ®ã                                                                                                                    
                                                                                                                                                
  # Êñá‰ª∂: services/identity/wechat.py                                                                                                           
  # ÂäüËÉΩ: ÂæÆ‰ø° OAuth ÁôªÂΩï                                                                                                                       
                                                                                                                                                
  UserRepository.create(                                                                                                                        
      display_name=nickname,                                                                                                                    
      birth_datetime=onboarding_data.get("birth_datetime"),  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ                                                                   
      birth_location=onboarding_data.get("birth_location"),  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ                                                                   
      gender=onboarding_data.get("gender")                                                                                                      
  )                                                                                                                                             
                                                                                                                                                
  # ÂΩ±Âìç: ÂæÆ‰ø°ÁôªÂΩïÁî®Êà∑Ê≥®ÂÜå                                                                                                                      
                                                                                                                                                
  # Êñá‰ª∂: services/identity/auth.py                                                                                                             
  # ÂäüËÉΩ: JWT Token È™åËØÅ                                                                                                                        
                                                                                                                                                
  user = await UserRepository.get_by_id(UUID(user_id))  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ‰∏∫ËØª unified_profiles                                                   
                                                                                                                                                
  # ÂΩ±Âìç: ÊâÄÊúâÈúÄË¶ÅË∫´‰ªΩÈ™åËØÅÁöÑ API Á´ØÁÇπ                                                                                                           
                                                                                                                                                
  ---                                                                                                                                           
  2Ô∏è‚É£ Áî®Êà∑ËµÑÊñôÁÆ°ÁêÜ (üî¥ Ê†∏ÂøÉ‰æùËµñ)                                                                                                                 
                                                                                                                                                
  # Êñá‰ª∂: routes/account.py                                                                                                                     
                                                                                                                                                
  # GET /api/v1/account/profile                                                                                                                 
  user = await UserRepository.get_by_id(current_user.user_id)  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ                                                                 
  return ProfileResponse(                                                                                                                       
      birth_datetime=user.get("birth_datetime"),      # ‚ùå Áõ¥Êé•ËØª vibe_users                                                                    
      birth_location=user.get("birth_location"),      # ‚ùå Áõ¥Êé•ËØª vibe_users                                                                    
      timezone=user.get("timezone", "Asia/Shanghai"), # ‚ùå Áõ¥Êé•ËØª vibe_users                                                                    
      language=user.get("language", "zh-CN")          # ‚ùå Áõ¥Êé•ËØª vibe_users                                                                    
  )                                                                                                                                             
                                                                                                                                                
  # PUT /api/v1/account/profile                                                                                                                 
  user = await UserRepository.update(current_user.user_id, **update_data)  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ                                                     
                                                                                                                                                
  # ÂΩ±Âìç: Settings È°µÈù¢ÁöÑÊâÄÊúâËØªÂÜôÊìç‰Ωú                                                                                                           
                                                                                                                                                
  ---                                                                                                                                           
  3Ô∏è‚É£ Ë¥¶Êà∑Âà†Èô§Á≥ªÁªü (üü° ‰∏≠Á≠â‰æùËµñ)                                                                                                                 
                                                                                                                                                
  # Êñá‰ª∂: services/identity/account_deletion.py                                                                                                 
                                                                                                                                                
  # ËΩØÂà†Èô§                                                                                                                                      
  await UserRepository.update(                                                                                                                  
      user_id,                                                                                                                                  
      status="pending_deletion",           # ‚úÖ ‰øùÁïôÂú® vibe_users (Ë¥¶Êà∑Áä∂ÊÄÅ)                                                                    
      deletion_requested_at=now,                                                                                                                
      deletion_scheduled_at=scheduled_at                                                                                                        
  )                                                                                                                                             
                                                                                                                                                
  # Á°¨Âà†Èô§                                                                                                                                      
  UPDATE vibe_users                                                                                                                             
  SET status = 'deleted',                                                                                                                       
      display_name = NULL,                                                                                                                      
      birth_datetime = NULL,    # ‚ùå ÊñπÊ°à B ÂêéÊ≠§Â≠óÊÆµÂ∫îÂ∑≤Âú® unified_profiles                                                                     
      birth_location = NULL,    # ‚ùå ÊñπÊ°à B ÂêéÊ≠§Â≠óÊÆµÂ∫îÂ∑≤Âú® unified_profiles                                                                     
      ...                                                                                                                                       
                                                                                                                                                
  # ÂΩ±Âìç: Ë¥¶Êà∑Âà†Èô§ÊµÅÁ®ãÈúÄË¶ÅÂêåÊó∂Âà†Èô§ unified_profiles                                                                                             
                                                                                                                                                
  ---                                                                                                                                           
  4Ô∏è‚É£ ËÆøÂÆ¢ËΩ¨Ê≠£Áî®Êà∑ (üü¢ ‰Ωé‰æùËµñ)                                                                                                                   
                                                                                                                                                
  # Êñá‰ª∂: services/identity/guest_session.py                                                                                                    
                                                                                                                                                
  await UserRepository.update(user_id, **update_data)  # ‚ùå ÊñπÊ°à B ÈúÄÊîπ                                                                         
                                                                                                                                                
  # ÂΩ±Âìç: ËÆøÂÆ¢Ê≥®ÂÜå‰∏∫Ê≠£ÂºèÁî®Êà∑Êó∂ÁöÑÊï∞ÊçÆËøÅÁßª                                                                                                        
                                                                                                                                                
  ---                                                                                                                                           
  5Ô∏è‚É£ Êï∞ÊçÆÂ∫ìËß¶ÂèëÂô® (üü° Â∑≤ÈÉ®ÂàÜÂÆûÁé∞)                                                                                                               
                                                                                                                                                
  -- Êñá‰ª∂: stores/migrations/019_add_account_and_state.sql                                                                                      
                                                                                                                                                
  CREATE TRIGGER trigger_sync_account_to_profile                                                                                                
      AFTER INSERT OR UPDATE OF vibe_id, display_name, status  -- ‚ö†Ô∏è ËåÉÂõ¥‰∏çÂ§ü                                                                   
      ON vibe_users                                                                                                                             
                                                                                                                                                
  -- ÂΩìÂâçÂè™ÂêåÊ≠•:                                                                                                                                
  --   - vibe_id                                                                                                                                
  --   - display_name                                                                                                                           
  --   - status                                                                                                                                 
                                                                                                                                                
  -- ‚ùå Êú™ÂêåÊ≠•:                                                                                                                                 
  --   - birth_datetime                                                                                                                         
  --   - birth_location                                                                                                                         
  --   - timezone                                                                                                                               
  --   - language                                                                                                                               
                                                                                                                                                
  ---                                                                                                                                           
  ‰∫å„ÄÅÊñπÊ°à B ÂΩ±ÂìçÁöÑÊï∞ÊçÆÂ≠óÊÆµÊò†Â∞Ñ                                                                                                                 
                                                                                                                                                
  üìã Â≠óÊÆµËøÅÁßªÂØπÁÖßË°®                                                                                                                             
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                               
  ‚îÇ vibe_users Â≠óÊÆµ ‚îÇ       ËøÅÁßªÂà∞ unified_profiles        ‚îÇ              ÂΩìÂâç‰ΩøÁî®Âú∫ÊôØ               ‚îÇ ËøÅÁßªÈöæÂ∫¶ ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ birth_datetime  ‚îÇ profile.identity.birth_info.date     ‚îÇ OAuth Ê≥®ÂÜå, Settings, Skill ËÆ°ÁÆó        ‚îÇ üî¥ È´ò    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ birth_location  ‚îÇ profile.identity.birth_info.location ‚îÇ OAuth Ê≥®ÂÜå, Settings, Bazi/Zodiac Skill ‚îÇ üî¥ È´ò    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ gender          ‚îÇ profile.identity.birth_info.gender   ‚îÇ OAuth Ê≥®ÂÜå, Bazi Skill                  ‚îÇ üü° ‰∏≠    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ timezone        ‚îÇ profile.preferences.timezone         ‚îÇ Settings, Proactive Êé®ÈÄÅ                ‚îÇ üî¥ È´ò    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ language        ‚îÇ profile.preferences.language         ‚îÇ Settings, Â§öËØ≠Ë®Ä                        ‚îÇ üü° ‰∏≠    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ display_name    ‚îÇ profile.account.display_name         ‚îÇ ‚úÖ Â∑≤ÈÄöËøá Trigger ÂêåÊ≠•                  ‚îÇ üü¢ ‰Ωé    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ vibe_id         ‚îÇ profile.account.vibe_id              ‚îÇ ‚úÖ Â∑≤ÈÄöËøá Trigger ÂêåÊ≠•                  ‚îÇ üü¢ ‰Ωé    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ status          ‚îÇ profile.account.status               ‚îÇ ‚úÖ Â∑≤ÈÄöËøá Trigger ÂêåÊ≠•                  ‚îÇ üü¢ ‰Ωé    ‚îÇ                               
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                               
  ‚îÇ avatar_url      ‚îÇ ‚ùì ÂæÖÂÆö                              ‚îÇ OAuth, Settings                         ‚îÇ üü° ‰∏≠    ‚îÇ                               
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                               
  ---                                                                                                                                           
  ‰∏â„ÄÅÊñπÊ°à B ÈúÄË¶Å‰øÆÊîπÁöÑ‰ª£Á†ÅÊ∏ÖÂçï                                                                                                                 
                                                                                                                                                
  üõ†Ô∏è ‰øÆÊîπÂ∑•‰ΩúÂàÜËß£ (WBS)                                                                                                                         
                                                                                                                                                
  Phase 1: Ê†∏ÂøÉÂü∫Á°ÄËÆæÊñΩ (2Â§©)                                                                                                                   
                                                                                                                                                
  1.1 Êâ©Â±ï UnifiedProfileRepository (Â∑≤Â≠òÂú®)                                                                                                    
                                                                                                                                                
  # stores/unified_profile_repo.py                                                                                                              
                                                                                                                                                
  # ‚úÖ Â∑≤Êúâ:                                                                                                                                    
  - update_birth_info()                                                                                                                         
  - update_preferences()                                                                                                                        
  - get_birth_info()                                                                                                                            
  - get_preferences()                                                                                                                           
                                                                                                                                                
  # üÜï ÈúÄÊñ∞Â¢û:                                                                                                                                  
  - migrate_from_vibe_users()  # ÊâπÈáèËøÅÁßªÂ∑•ÂÖ∑                                                                                                   
                                                                                                                                                
  1.2 ‰øÆÊîπÊï∞ÊçÆÂ∫ì Trigger                                                                                                                        
                                                                                                                                                
  -- stores/migrations/021_extend_sync_trigger.sql                                                                                              
                                                                                                                                                
  DROP TRIGGER IF EXISTS trigger_sync_account_to_profile ON vibe_users;                                                                         
                                                                                                                                                
  CREATE TRIGGER trigger_sync_account_to_profile                                                                                                
      AFTER INSERT OR UPDATE OF                                                                                                                 
          vibe_id, display_name, status,                                                                                                        
          birth_datetime, birth_location, gender,  -- üÜï Êñ∞Â¢û                                                                                   
          timezone, language                        -- üÜï Êñ∞Â¢û                                                                                  
      ON vibe_users                                                                                                                             
      FOR EACH ROW                                                                                                                              
      EXECUTE FUNCTION sync_full_profile_to_unified();                                                                                          
                                                                                                                                                
  1.3 ÂàõÂª∫ÂÆåÊï¥ÂêåÊ≠•ÂáΩÊï∞                                                                                                                          
                                                                                                                                                
  CREATE OR REPLACE FUNCTION sync_full_profile_to_unified()                                                                                     
  RETURNS TRIGGER AS $$                                                                                                                         
  BEGIN                                                                                                                                         
      UPDATE unified_profiles                                                                                                                   
      SET profile = jsonb_set(                                                                                                                  
          jsonb_set(                                                                                                                            
              jsonb_set(                                                                                                                        
                  COALESCE(profile, '{}'::jsonb),                                                                                               
                  '{account}',                                                                                                                  
                  jsonb_build_object(                                                                                                           
                      'vibe_id', NEW.vibe_id,                                                                                                   
                      'display_name', COALESCE(NEW.display_name, ''),                                                                           
                      'tier', COALESCE(NEW.tier, 'free'),                                                                                       
                      'status', COALESCE(NEW.status, 'active')                                                                                  
                  )                                                                                                                             
              ),                                                                                                                                
              '{identity, birth_info}',                                                                                                         
              jsonb_build_object(                                                                                                               
                  'date', NEW.birth_datetime,                                                                                                   
                  'location', NEW.birth_location,                                                                                               
                  'gender', NEW.gender                                                                                                          
              )                                                                                                                                 
          ),                                                                                                                                    
          '{preferences}',                                                                                                                      
          jsonb_set(                                                                                                                            
              COALESCE(profile -> 'preferences', '{}'::jsonb),                                                                                  
              '{timezone}',                                                                                                                     
              to_jsonb(COALESCE(NEW.timezone, 'Asia/Shanghai'))                                                                                 
          ) || jsonb_build_object(                                                                                                              
              'language', COALESCE(NEW.language, 'zh-CN')                                                                                       
          )                                                                                                                                     
      ),                                                                                                                                        
      updated_at = NOW()                                                                                                                        
      WHERE user_id = NEW.id;                                                                                                                   
                                                                                                                                                
      RETURN NEW;                                                                                                                               
  END;                                                                                                                                          
  $$ LANGUAGE plpgsql;                                                                                                                          
                                                                                                                                                
  ---                                                                                                                                           
  Phase 2: ËÆ§ËØÅÁ≥ªÁªüÈáçÊûÑ (3Â§©)                                                                                                                   
                                                                                                                                                
  2.1 ‰øÆÊîπ OAuth Ê≥®ÂÜåÈÄªËæë                                                                                                                       
                                                                                                                                                
  # services/identity/oauth.py (116-141Ë°å)                                                                                                      
                                                                                                                                                
  # ‚ùå Êóß‰ª£Á†Å:                                                                                                                                  
  user = await UserRepository.create(                                                                                                           
      display_name=google_user.get("name"),                                                                                                     
      birth_datetime=onboarding_data.get("birth_datetime"),                                                                                     
      birth_location=onboarding_data.get("birth_location"),                                                                                     
      gender=onboarding_data.get("gender")                                                                                                      
  )                                                                                                                                             
                                                                                                                                                
  # ‚úÖ Êñ∞‰ª£Á†Å:                                                                                                                                  
  # 1. ÂÖàÂàõÂª∫Âü∫Á°ÄË¥¶Êà∑Ôºà‰ªÖ vibe_usersÔºâ                                                                                                          
  user = await UserRepository.create(                                                                                                           
      display_name=google_user.get("name")                                                                                                      
  )                                                                                                                                             
                                                                                                                                                
  # 2. ÂàõÂª∫ unified_profileÔºàÂåÖÂê´ identityÔºâ                                                                                                    
  if onboarding_data:                                                                                                                           
      await UnifiedProfileRepository.create_profile(user["id"], {                                                                               
          "identity": {                                                                                                                         
              "birth_info": {                                                                                                                   
                  "date": onboarding_data.get("birth_datetime"),                                                                                
                  "location": onboarding_data.get("birth_location"),                                                                            
                  "gender": onboarding_data.get("gender")                                                                                       
              }                                                                                                                                 
          }                                                                                                                                     
      })                                                                                                                                        
                                                                                                                                                
  ÂΩ±ÂìçÊñá‰ª∂Ê∏ÖÂçï:                                                                                                                                 
  - ‚úÖ services/identity/oauth.py (Google: 116-141Ë°å, Apple: 260-285Ë°å)                                                                         
  - ‚úÖ services/identity/wechat.py (319-348Ë°å)                                                                                                  
  - ‚úÖ services/identity/sso.py (Â¶ÇÊúâ)                                                                                                          
                                                                                                                                                
  ---                                                                                                                                           
  Phase 3: Profile API ÈáçÊûÑ (2Â§©)                                                                                                               
                                                                                                                                                
  3.1 ‰øÆÊîπ GET /profile ËØªÂèñÈÄªËæë                                                                                                                
                                                                                                                                                
  # routes/account.py:455                                                                                                                       
                                                                                                                                                
  @router.get("/profile", response_model=ProfileResponse)                                                                                       
  async def get_profile(current_user: CurrentUser = Depends(get_current_user)):                                                                 
      """Get current user's full profile"""                                                                                                     
                                                                                                                                                
      # üÜï ‰ºòÂÖà‰ªé unified_profiles ËØªÂèñ                                                                                                         
      profile = await UnifiedProfileRepository.get_profile(current_user.user_id)                                                                
                                                                                                                                                
      if not profile:                                                                                                                           
          # Fallback: ‰ªé vibe_users ËøÅÁßª                                                                                                        
          user = await UserRepository.get_by_id(current_user.user_id)                                                                           
          if user:                                                                                                                              
              await UnifiedProfileRepository.create_profile(current_user.user_id, {                                                             
                  "identity": {                                                                                                                 
                      "birth_info": {                                                                                                           
                          "date": user.get("birth_datetime"),                                                                                   
                          "location": user.get("birth_location"),                                                                               
                          "gender": user.get("gender")                                                                                          
                      }                                                                                                                         
                  },                                                                                                                            
                  "preferences": {                                                                                                              
                      "timezone": user.get("timezone", "Asia/Shanghai"),                                                                        
                      "language": user.get("language", "zh-CN")                                                                                 
                  }                                                                                                                             
              })                                                                                                                                
              profile = await UnifiedProfileRepository.get_profile(current_user.user_id)                                                        
                                                                                                                                                
      # ‰ªé unified_profiles ÊûÑÈÄ†ËøîÂõû                                                                                                            
      birth_info = profile.get("identity", {}).get("birth_info", {})                                                                            
      preferences = profile.get("preferences", {})                                                                                              
      account = profile.get("account", {})                                                                                                      
                                                                                                                                                
      return ProfileResponse(                                                                                                                   
          user_id=str(current_user.user_id),                                                                                                    
          vibe_id=account.get("vibe_id", ""),                                                                                                   
          display_name=account.get("display_name"),                                                                                             
          birth_datetime=birth_info.get("date"),                                                                                                
          birth_location=birth_info.get("location"),                                                                                            
          timezone=preferences.get("timezone", "Asia/Shanghai"),                                                                                
          language=preferences.get("language", "zh-CN"),                                                                                        
          created_at=datetime.utcnow()                                                                                                          
      )                                                                                                                                         
                                                                                                                                                
  3.2 ‰øÆÊîπ PUT /profile ÂÜôÂÖ•ÈÄªËæë                                                                                                                
                                                                                                                                                
  # routes/account.py:475                                                                                                                       
                                                                                                                                                
  @router.put("/profile", response_model=ProfileResponse)                                                                                       
  async def update_profile(                                                                                                                     
      request: ProfileUpdateRequest,                                                                                                            
      current_user: CurrentUser = Depends(get_current_user)                                                                                     
  ):                                                                                                                                            
      """Update current user's profile"""                                                                                                       
      update_data = request.model_dump(exclude_unset=True)                                                                                      
                                                                                                                                                
      # üÜï ÂàÜÁ¶ªÂ≠óÊÆµ                                                                                                                             
      if "birth_datetime" in update_data or "birth_location" in update_data:                                                                    
          await UnifiedProfileRepository.update_birth_info(                                                                                     
              current_user.user_id,                                                                                                             
              {                                                                                                                                 
                  "date": update_data.get("birth_datetime"),                                                                                    
                  "location": update_data.get("birth_location")                                                                                 
              }                                                                                                                                 
          )                                                                                                                                     
                                                                                                                                                
      if "timezone" in update_data or "language" in update_data:                                                                                
          await UnifiedProfileRepository.update_preferences(                                                                                    
              current_user.user_id,                                                                                                             
              {                                                                                                                                 
                  "timezone": update_data.get("timezone"),                                                                                      
                  "language": update_data.get("language")                                                                                       
              }                                                                                                                                 
          )                                                                                                                                     
                                                                                                                                                
      if "display_name" in update_data:                                                                                                         
          # ‰ªçÁÑ∂ÂÜôÂÖ• vibe_usersÔºàËß¶ÂèëÂô®‰ºöÂêåÊ≠•Âà∞ unified_profilesÔºâ                                                                              
          await UserRepository.update(                                                                                                          
              current_user.user_id,                                                                                                             
              display_name=update_data["display_name"]                                                                                          
          )                                                                                                                                     
                                                                                                                                                
      # ËøîÂõûÊõ¥Êñ∞ÂêéÁöÑ Profile                                                                                                                    
      return await get_profile(current_user)                                                                                                    
                                                                                                                                                
  ---                                                                                                                                           
  Phase 4: Ë¥¶Êà∑Âà†Èô§Á≥ªÁªüÈÄÇÈÖç (1Â§©)                                                                                                               
                                                                                                                                                
  # services/identity/account_deletion.py:192                                                                                                   
                                                                                                                                                
  @classmethod                                                                                                                                  
  async def _hard_delete_user(cls, conn, user_id: UUID) -> None:                                                                                
      """Permanently delete all user data"""                                                                                                    
                                                                                                                                                
      # ... Áé∞ÊúâÂà†Èô§ÈÄªËæë ...                                                                                                                    
                                                                                                                                                
      # üÜï Âà†Èô§ unified_profiles                                                                                                                
      await conn.execute(                                                                                                                       
          "DELETE FROM unified_profiles WHERE user_id = $1",                                                                                    
          user_id                                                                                                                               
      )                                                                                                                                         
                                                                                                                                                
      # üÜï Âà†Èô§ vibe_profile_insights                                                                                                           
      await conn.execute(                                                                                                                       
          "DELETE FROM vibe_profile_insights WHERE user_id = $1",                                                                               
          user_id                                                                                                                               
      )                                                                                                                                         
                                                                                                                                                
      # üÜï Âà†Èô§ vibe_profile_timeline                                                                                                           
      await conn.execute(                                                                                                                       
          "DELETE FROM vibe_profile_timeline WHERE user_id = $1",                                                                               
          user_id                                                                                                                               
      )                                                                                                                                         
                                                                                                                                                
      # ÊúÄÂêéÊ†áËÆ∞ vibe_users ‰∏∫Â∑≤Âà†Èô§ÔºàÁÆÄÂåñÁâàÔºâ                                                                                                  
      await conn.execute(                                                                                                                       
          """UPDATE vibe_users                                                                                                                  
             SET status = 'deleted',                                                                                                            
                 display_name = NULL,                                                                                                           
                 avatar_url = NULL,                                                                                                             
                 updated_at = NOW()                                                                                                             
             WHERE id = $1""",                                                                                                                  
          user_id                                                                                                                               
      )                                                                                                                                         
                                                                                                                                                
  ---                                                                                                                                           
  Phase 5: Êï∞ÊçÆËøÅÁßª (1Â§©)                                                                                                                       
                                                                                                                                                
  5.1 ÂàõÂª∫ËøÅÁßªËÑöÊú¨                                                                                                                              
                                                                                                                                                
  # scripts/migrate_to_unified_profiles.py                                                                                                      
                                                                                                                                                
  async def migrate_all_users():                                                                                                                
      """ËøÅÁßªÊâÄÊúâÁé∞ÊúâÁî®Êà∑Âà∞ unified_profiles"""                                                                                                 
                                                                                                                                                
      async with get_connection() as conn:                                                                                                      
          # Ëé∑ÂèñÊâÄÊúâÊú™ËøÅÁßªÁî®Êà∑                                                                                                                  
          users = await conn.fetch(                                                                                                             
              """SELECT u.id, u.vibe_id, u.display_name, u.birth_datetime,                                                                      
                        u.birth_location, u.gender, u.timezone, u.language                                                                      
                 FROM vibe_users u                                                                                                              
                 LEFT JOIN unified_profiles up ON u.id = up.user_id                                                                             
                 WHERE up.user_id IS NULL                                                                                                       
                 AND u.status != 'deleted'"""                                                                                                   
          )                                                                                                                                     
                                                                                                                                                
          migrated = 0                                                                                                                          
          for user in users:                                                                                                                    
              try:                                                                                                                              
                  await UnifiedProfileRepository.create_profile(user["id"], {                                                                   
                      "account": {                                                                                                              
                          "vibe_id": user["vibe_id"],                                                                                           
                          "display_name": user["display_name"],                                                                                 
                          "tier": "free",                                                                                                       
                          "status": "active"                                                                                                    
                      },                                                                                                                        
                      "identity": {                                                                                                             
                          "birth_info": {                                                                                                       
                              "date": user["birth_datetime"],                                                                                   
                              "location": user["birth_location"],                                                                               
                              "gender": user["gender"]                                                                                          
                          }                                                                                                                     
                      },                                                                                                                        
                      "preferences": {                                                                                                          
                          "timezone": user["timezone"] or "Asia/Shanghai",                                                                      
                          "language": user["language"] or "zh-CN"                                                                               
                      }                                                                                                                         
                  })                                                                                                                            
                  migrated += 1                                                                                                                 
              except Exception as e:                                                                                                            
                  logger.error(f"Failed to migrate user {user['vibe_id']}: {e}")                                                                
                                                                                                                                                
          logger.info(f"Migrated {migrated}/{len(users)} users")                                                                                
                                                                                                                                                
  ---                                                                                                                                           
  Âõõ„ÄÅ‰ª£Á†Å‰øÆÊîπÊ∏ÖÂçïÊÄªËßà                                                                                                                          
                                                                                                                                                
  üìù ÈúÄË¶Å‰øÆÊîπÁöÑÊñá‰ª∂ (ÂÖ± 12 ‰∏™)                                                                                                                  
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                                
  ‚îÇ                   Êñá‰ª∂Ë∑ØÂæÑ                    ‚îÇ ‰øÆÊîπÁ±ªÂûã ‚îÇ Â∑•‰ΩúÈáè ‚îÇ ‰ºòÂÖàÁ∫ß ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ Âü∫Á°ÄËÆæÊñΩ                                      ‚îÇ          ‚îÇ        ‚îÇ        ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ stores/migrations/021_extend_sync_trigger.sql ‚îÇ Êñ∞Âª∫     ‚îÇ 2h     ‚îÇ P0     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ stores/unified_profile_repo.py                ‚îÇ Êâ©Â±ï     ‚îÇ 1h     ‚îÇ P0     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ ËÆ§ËØÅÁ≥ªÁªü                                      ‚îÇ          ‚îÇ        ‚îÇ        ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ services/identity/oauth.py                    ‚îÇ ÈáçÊûÑ     ‚îÇ 3h     ‚îÇ P1     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ services/identity/wechat.py                   ‚îÇ ÈáçÊûÑ     ‚îÇ 2h     ‚îÇ P1     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ services/identity/auth.py                     ‚îÇ ÈÄÇÈÖç     ‚îÇ 1h     ‚îÇ P1     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ Áî®Êà∑ÁÆ°ÁêÜ                                      ‚îÇ          ‚îÇ        ‚îÇ        ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ routes/account.py                             ‚îÇ ÈáçÊûÑ     ‚îÇ 4h     ‚îÇ P0     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ Ë¥¶Êà∑Âà†Èô§                                      ‚îÇ          ‚îÇ        ‚îÇ        ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ services/identity/account_deletion.py         ‚îÇ Êâ©Â±ï     ‚îÇ 2h     ‚îÇ P2     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ Â∑•ÂÖ∑ËÑöÊú¨                                      ‚îÇ          ‚îÇ        ‚îÇ        ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ scripts/migrate_to_unified_profiles.py        ‚îÇ Êñ∞Âª∫     ‚îÇ 3h     ‚îÇ P0     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ scripts/verify_data_consistency.py            ‚îÇ Êñ∞Âª∫     ‚îÇ 2h     ‚îÇ P2     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ ÊµãËØï                                          ‚îÇ          ‚îÇ        ‚îÇ        ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ tests/test_profile_migration.py               ‚îÇ Êñ∞Âª∫     ‚îÇ 4h     ‚îÇ P1     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ tests/test_unified_profile_api.py             ‚îÇ Êñ∞Âª∫     ‚îÇ 3h     ‚îÇ P1     ‚îÇ                                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                                
  ‚îÇ tests/test_oauth_with_unified_profile.py      ‚îÇ Êñ∞Âª∫     ‚îÇ 2h     ‚îÇ P2     ‚îÇ                                                                
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                                
  ÊÄªÂ∑•‰ΩúÈáè‰º∞ÁÆó: 29Â∞èÊó∂ ‚âà 4‰∏™Â∑•‰ΩúÊó•                                                                                                              
                                                                                                                                                
  ---                                                                                                                                           
  ‰∫î„ÄÅÈ£éÈô©ËØÑ‰º∞‰∏éÁºìËß£Êé™ÊñΩ                                                                                                                        
                                                                                                                                                
  ‚ö†Ô∏è È´òÈ£éÈô©È°π                                                                                                                                   
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                                
  ‚îÇ       È£éÈô©       ‚îÇ      ÂΩ±Âìç       ‚îÇ                       ÁºìËß£Êé™ÊñΩ                        ‚îÇ                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                
  ‚îÇ Êï∞ÊçÆËøÅÁßªÂ§±Ë¥•     ‚îÇ üî¥ Áî®Êà∑Êó†Ê≥ïÁôªÂΩï ‚îÇ ‚úÖ 1. ‰øùÁïô Fallback ÈÄªËæë‚úÖ 2. ÂàÜÊâπËøÅÁßª‚úÖ 3. ÂõûÊªöËÑöÊú¨  ‚îÇ                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                
  ‚îÇ Êñ∞Áî®Êà∑Ê≥®ÂÜå‰∏≠Êñ≠   ‚îÇ üî¥ ‰∏öÂä°‰∏≠Êñ≠     ‚îÇ ‚úÖ 1. Èáë‰∏ùÈõÄÈÉ®ÁΩ≤‚úÖ 2. Feature Flag ÊéßÂà∂‚úÖ 3. ÁõëÊéßÂëäË≠¶ ‚îÇ                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                
  ‚îÇ Trigger ÊÄßËÉΩÈóÆÈ¢ò ‚îÇ üü° ÂÜôÂÖ•Âª∂Ëøü     ‚îÇ ‚úÖ 1. ÂºÇÊ≠•ÂêåÊ≠•ÈòüÂàó‚úÖ 2. ÊâπÈáèÊõ¥Êñ∞‰ºòÂåñ                  ‚îÇ                                                
  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§                                                
  ‚îÇ Êï∞ÊçÆ‰∏ç‰∏ÄËá¥       ‚îÇ üü° Áî®Êà∑‰ΩìÈ™åÂ∑Æ   ‚îÇ ‚úÖ 1. ÂÆöÊó∂‰∏ÄËá¥ÊÄßÊ£ÄÊü•‚úÖ 2. ÂèåÂÜôÈ™åËØÅÊúü                  ‚îÇ                                                
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                                
  ---                                                                                                                                           
  ÂÖ≠„ÄÅÊé®ËçêÂÆûÊñΩÊñπÊ°àÔºàÂü∫‰∫éÊñπÊ°à BÔºâ                                                                                                                
                                                                                                                                                
  üéØ ÂàÜÈò∂ÊÆµÊ∏êËøõÂºèËøÅÁßª                                                                                                                           
                                                                                                                                                
  Èò∂ÊÆµ 0: ÂáÜÂ§áÊúü (1Â§©)                                                                                                                          
                                                                                                                                                
  ‚úÖ ÂàõÂª∫ Feature Flag: ENABLE_UNIFIED_PROFILE_WRITE                                                                                            
  ‚úÖ ÈÉ®ÁΩ≤ÁõëÊéßÂëäË≠¶                                                                                                                               
  ‚úÖ ÁºñÂÜôÂõûÊªöËÑöÊú¨                                                                                                                               
                                                                                                                                                
  Èò∂ÊÆµ 1: ÂèåÂÜôÈ™åËØÅÊúü (1Âë®)                                                                                                                      
                                                                                                                                                
  # ÊâÄÊúâÂÜôÂÖ•ÂêåÊó∂ÂÜôÂÖ•‰∏§‰∏™Êï∞ÊçÆÊ∫ê                                                                                                                  
  async def update_profile(...):                                                                                                                
      # Êñ∞ÂÜôÊ≥ïÔºà‰∏ªÔºâ                                                                                                                            
      await UnifiedProfileRepository.update_birth_info(...)                                                                                     
                                                                                                                                                
      # ÊóßÂÜôÊ≥ïÔºàÂ§á‰ªΩÔºâ                                                                                                                          
      await UserRepository.update(...)                                                                                                          
                                                                                                                                                
      # È™åËØÅ‰∏ÄËá¥ÊÄß                                                                                                                              
      await verify_consistency(user_id)                                                                                                         
                                                                                                                                                
  ÁõÆÊ†á: Á°Æ‰øùÊñ∞ÈÄªËæëÊ≠£Á°ÆÊÄß                                                                                                                        
                                                                                                                                                
  Èò∂ÊÆµ 2: Ê∏êËøõÂºèÂàáÊç¢ (2Âë®)                                                                                                                      
                                                                                                                                                
  # Week 1: 10% ÊµÅÈáèËØªÂèñ unified_profiles                                                                                                       
  if random.random() < 0.1 or feature_flag("unified_profile_read"):                                                                             
      profile = await UnifiedProfileRepository.get_profile(user_id)                                                                             
  else:                                                                                                                                         
      user = await UserRepository.get_by_id(user_id)                                                                                            
                                                                                                                                                
  # Week 2: 50% ‚Üí 100%                                                                                                                          
                                                                                                                                                
  ÁõÆÊ†á: ÁÅ∞Â∫¶È™åËØÅËØªÂèñÈÄªËæë                                                                                                                        
                                                                                                                                                
  Èò∂ÊÆµ 3: Êï∞ÊçÆËøÅÁßª (3Â§©)                                                                                                                        
                                                                                                                                                
  # Day 1: ËøÅÁßª 10% Áî®Êà∑                                                                                                                        
  python scripts/migrate_to_unified_profiles.py --batch-size=1000 --dry-run=false --percentage=10                                               
                                                                                                                                                
  # Day 2: ËøÅÁßª 50% Áî®Êà∑                                                                                                                        
  python scripts/migrate_to_unified_profiles.py --percentage=50                                                                                 
                                                                                                                                                
  # Day 3: ËøÅÁßªÂâ©‰ΩôÁî®Êà∑                                                                                                                         
  python scripts/migrate_to_unified_profiles.py --percentage=100                                                                                
                                                                                                                                                
  Èò∂ÊÆµ 4: Â∫üÂºÉÊóßÂ≠óÊÆµ (1‰∏™ÊúàÂêé)                                                                                                                  
                                                                                                                                                
  -- Â∞Ü vibe_users ÁöÑ‰∏öÂä°Â≠óÊÆµÊ†áËÆ∞‰∏∫Â∫üÂºÉ                                                                                                         
  ALTER TABLE vibe_users                                                                                                                        
      ALTER COLUMN birth_datetime SET DEFAULT NULL,                                                                                             
      ALTER COLUMN birth_location SET DEFAULT NULL;                                                                                             
                                                                                                                                                
  -- Ê∑ªÂä†Ê≥®Èáä                                                                                                                                   
  COMMENT ON COLUMN vibe_users.birth_datetime IS                                                                                                
      'DEPRECATED: Use unified_profiles.profile.identity.birth_info.date';                                                                      
                                                                                                                                                
  ---                                                                                                                                           
  ‰∏É„ÄÅÁ´ãÂç≥Ë°åÂä®Âª∫ËÆÆ                                                                                                                              
                                                                                                                                                
  üöÄ Á¨¨‰∏ÄÂë®ÊâßË°åËÆ°Âàí                                                                                                                             
                                                                                                                                                
  Day 1: Âü∫Á°ÄËÆæÊñΩ                                                                                                                               
  1. ÂàõÂª∫ migration 021 (Êâ©Â±ï Trigger)                                                                                                          
  2. Ê∑ªÂä† UnifiedProfileRepository.migrate_from_vibe_users()                                                                                    
  3. ÁºñÂÜôÂçïÂÖÉÊµãËØï                                                                                                                               
                                                                                                                                                
  Day 2-3: Profile API ÈáçÊûÑ                                                                                                                     
  1. ‰øÆÊîπ routes/account.py (GET/PUT /profile)                                                                                                  
  2. Ê∑ªÂä† Fallback ÈÄªËæë                                                                                                                         
  3. ÈõÜÊàêÊµãËØï                                                                                                                                   
                                                                                                                                                
  Day 4: OAuth ÈáçÊûÑ                                                                                                                             
  1. ‰øÆÊîπ oauth.py, wechat.py                                                                                                                   
  2. ÊµãËØïÊñ∞Áî®Êà∑Ê≥®ÂÜåÊµÅÁ®ã                                                                                                                         
                                                                                                                                                
  Day 5: Êï∞ÊçÆËøÅÁßªÂáÜÂ§á                                                                                                                           
  1. ÁºñÂÜôËøÅÁßªËÑöÊú¨                                                                                                                               
  2. Âú®ÊµãËØïÁéØÂ¢ÉÈ™åËØÅ                                                                                                                             
  3. ÂáÜÂ§áÁõëÊéß‰ª™Ë°®Áõò                                                                                                                             
                                                                                                                                                
  ---                                                                                                                                           
  ÂÖ´„ÄÅÈúÄË¶ÅÁ´ãÂç≥ÂàõÂª∫ÁöÑÊñá‰ª∂                                                                                                                        
                                                                                                                                                
  # Migration                                                                                                                                   
  apps/api/stores/migrations/021_extend_sync_trigger.sql                                                                                        
                                                                                                                                                
  # Scripts                                                                                                                                     
  apps/api/scripts/migrate_to_unified_profiles.py                                                                                               
  apps/api/scripts/verify_profile_consistency.py                                                                                                
                                                                                                                                                
  # Tests                                                                                                                                       
  apps/api/tests/integration/test_unified_profile_migration.py                                                                                  
  apps/api/tests/unit/test_unified_profile_repo.py                                                                                              
                                                                                                                                                
  ---                                                                                                                                           
  ÊÄªÁªì: ÊñπÊ°à B ÊòØÊ≠£Á°ÆÁöÑÊû∂ÊûÑÊñπÂêëÔºåÂΩ±ÂìçËåÉÂõ¥ÂèØÊéßÔºà12‰∏™Êñá‰ª∂Ôºå4‰∏™Â∑•‰ΩúÊó•ÔºâÔºåÂª∫ËÆÆÈááÁî®Ê∏êËøõÂºèËøÅÁßª + ÂèåÂÜôÈ™åËØÅÁ≠ñÁï•Èôç‰ΩéÈ£éÈô©„ÄÇ                               
                                                                                                                                                
  ÈúÄË¶ÅÊàëÁ´ãÂç≥ÁîüÊàêËøô‰∫õËøÅÁßªÊñá‰ª∂ÂíåËÑöÊú¨ÂêóÔºü                                                         