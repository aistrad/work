# å‰ç«¯ä½“éªŒé‡æ„æ–¹æ¡ˆ

## æ¦‚è¿°

å°†å‰ç«¯ä»"æŠ€èƒ½å¯¼å‘"é‡æ„ä¸º"æ—…ç¨‹å¯¼å‘"ï¼Œå®ç°ç»Ÿä¸€å…¥å£ã€Identity Prism å¯è§†åŒ–ã€æ¯æ—¥ä»ªå¼ä½“éªŒã€‚

---

## 1. é¡µé¢ç»“æ„é‡æ„

### 1.1 ç°æœ‰ç»“æ„

```
app/
â”œâ”€â”€ page.tsx              # é¦–é¡µ
â”œâ”€â”€ auth/                 # è®¤è¯
â”œâ”€â”€ chat/                 # å¯¹è¯
â”œâ”€â”€ bazi/                 # å…«å­—
â”œâ”€â”€ zodiac/               # æ˜Ÿåº§
â”œâ”€â”€ interview/            # è®¿è°ˆ
â”œâ”€â”€ report/               # æŠ¥å‘Š
â”œâ”€â”€ relationship/         # å…³ç³»
â””â”€â”€ ...
```

### 1.2 ç›®æ ‡ç»“æ„

```
app/
â”œâ”€â”€ page.tsx              # é¦–é¡µ (é‡æ„ä¸ºæ—…ç¨‹å…¥å£)
â”œâ”€â”€ auth/                 # è®¤è¯ (ä¿æŒ)
â”œâ”€â”€ home/                 # ä¸»é¡µ (æ–°å¢ - æ¯æ—¥ä»ªå¼å…¥å£)
â”œâ”€â”€ identity/             # Identity Prism (æ–°å¢)
â”‚   â”œâ”€â”€ page.tsx          # æ£±é•œæ€»è§ˆ
â”‚   â””â”€â”€ [dimension]/      # å„ç»´åº¦è¯¦æƒ…
â”œâ”€â”€ chat/                 # ç»Ÿä¸€å¯¹è¯ (é‡æ„)
â”œâ”€â”€ journey/              # ç”¨æˆ·æ—…ç¨‹ (æ–°å¢)
â”œâ”€â”€ events/               # ç”Ÿæ´»äº‹ä»¶ (æ–°å¢)
â”œâ”€â”€ memories/             # è®°å¿†å›é¡¾ (æ–°å¢)
â””â”€â”€ settings/             # è®¾ç½® (å¢å¼º)
```

---

## 2. æ ¸å¿ƒé¡µé¢è®¾è®¡

### 2.1 ä¸»é¡µ (Home) - æ¯æ—¥ä»ªå¼å…¥å£

```tsx
// app/home/page.tsx

export default function HomePage() {
  const { user } = useAuth()
  const { ritual, isLoading } = useTodayRitual()
  const { events } = useUpcomingEvents()

  return (
    <div className="min-h-screen bg-gradient-to-b from-slate-900 to-slate-800">
      {/* é¡¶éƒ¨é—®å€™ */}
      <GreetingHeader user={user} />

      {/* ä»Šæ—¥ä»ªå¼å¡ç‰‡ */}
      <RitualCard ritual={ritual} />

      {/* å¿«é€Ÿå…¥å£ */}
      <QuickActions />

      {/* å³å°†å‘ç”Ÿçš„äº‹ä»¶ */}
      {events.length > 0 && <UpcomingEvents events={events} />}

      {/* æœ€è¿‘æ´å¯Ÿ */}
      <RecentInsights />

      {/* åº•éƒ¨å¯¼èˆª */}
      <BottomNav />
    </div>
  )
}
```

### 2.2 ä»ªå¼å¡ç‰‡ç»„ä»¶

```tsx
// components/ritual/RitualCard.tsx

interface RitualCardProps {
  ritual: DailyRitual
}

export function RitualCard({ ritual }: RitualCardProps) {
  const currentTime = useCurrentTime()
  const activeRitual = getActiveRitual(ritual, currentTime)

  return (
    <motion.div
      className="mx-4 rounded-2xl bg-gradient-to-br from-indigo-600 to-purple-700 p-6"
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
    >
      {activeRitual === 'morning' && (
        <MorningOracleCard oracle={ritual.morning_oracle} />
      )}
      {activeRitual === 'midday' && (
        <MiddayMirrorCard mirror={ritual.midday_mirror} />
      )}
      {activeRitual === 'night' && (
        <NightWhisperCard whisper={ritual.night_whisper} />
      )}
    </motion.div>
  )
}

function MorningOracleCard({ oracle }: { oracle: MorningOracle }) {
  return (
    <div className="space-y-4">
      <div className="flex items-center gap-2">
        <SunIcon className="h-6 w-6 text-amber-300" />
        <span className="text-amber-300 font-medium">æ™¨è°•</span>
      </div>

      <div className="text-center">
        <span className="text-3xl font-bold text-white">
          {oracle.energy_theme}
        </span>
      </div>

      <p className="text-white/90 text-sm leading-relaxed">
        {oracle.prediction}
      </p>

      <div className="bg-white/10 rounded-lg p-3">
        <p className="text-white/80 text-xs">
          ğŸ’¡ {oracle.advice}
        </p>
      </div>
    </div>
  )
}
```

### 2.3 Identity Prism é¡µé¢

```tsx
// app/identity/page.tsx

export default function IdentityPage() {
  const { prism, dimensions, isLoading } = useIdentityPrism()

  if (isLoading) return <PrismSkeleton />

  return (
    <div className="min-h-screen bg-slate-900 p-4">
      <header className="mb-6">
        <h1 className="text-2xl font-bold text-white">ä½ çš„èº«ä»½æ£±é•œ</h1>
        <p className="text-slate-400 text-sm">å¤šç»´åº¦èåˆçš„ä½ </p>
      </header>

      {/* 3D æ£±é•œå¯è§†åŒ– */}
      <PrismVisualization prism={prism} />

      {/* ä¸‰ç»´æ‘˜è¦ */}
      <div className="space-y-4 mt-6">
        <PrismDimension
          title="æ ¸å¿ƒæœ¬è´¨"
          subtitle="é©±åŠ¨ä½ çš„æ ¹æœ¬åŠ›é‡"
          content={prism.core_essence}
          icon={<CoreIcon />}
          color="amber"
        />
        <PrismDimension
          title="å†…åœ¨è‡ªæˆ‘"
          subtitle="ä½ å†…å¿ƒçœŸæ­£æƒ³è¦çš„"
          content={prism.inner_self}
          icon={<InnerIcon />}
          color="purple"
        />
        <PrismDimension
          title="å¤–åœ¨è¡¨ç°"
          subtitle="åˆ«äººçœ¼ä¸­çš„ä½ "
          content={prism.outer_expression}
          icon={<OuterIcon />}
          color="blue"
        />
      </div>

      {/* ç»´åº¦æ¥æº */}
      <section className="mt-8">
        <h2 className="text-lg font-semibold text-white mb-4">ç»´åº¦æ¥æº</h2>
        <div className="grid grid-cols-2 gap-3">
          {dimensions.map((dim) => (
            <DimensionCard
              key={dim.type}
              dimension={dim}
              isUnlocked={dim.is_unlocked}
            />
          ))}
        </div>
      </section>
    </div>
  )
}
```

### 2.4 æ£±é•œ 3D å¯è§†åŒ–

```tsx
// components/identity/PrismVisualization.tsx

import { Canvas } from '@react-three/fiber'
import { OrbitControls } from '@react-three/drei'

export function PrismVisualization({ prism }: { prism: IdentityPrism }) {
  return (
    <div className="h-64 rounded-2xl overflow-hidden bg-slate-800">
      <Canvas camera={{ position: [0, 0, 5] }}>
        <ambientLight intensity={0.5} />
        <pointLight position={[10, 10, 10]} />

        <Prism3D
          coreStrength={prism.core_essence?.confidence || 0}
          innerStrength={prism.inner_self?.confidence || 0}
          outerStrength={prism.outer_expression?.confidence || 0}
        />

        <OrbitControls enableZoom={false} />
      </Canvas>
    </div>
  )
}

function Prism3D({ coreStrength, innerStrength, outerStrength }) {
  return (
    <mesh rotation={[0.5, 0.5, 0]}>
      <octahedronGeometry args={[1.5, 0]} />
      <meshStandardMaterial
        color="#8b5cf6"
        transparent
        opacity={0.8}
        wireframe={false}
      />
    </mesh>
  )
}
```

---

## 3. ç»Ÿä¸€å¯¹è¯ä½“éªŒ

### 3.1 å¯¹è¯é¡µé¢é‡æ„

```tsx
// app/chat/page.tsx

export default function ChatPage() {
  const { conversation, messages, sendMessage } = useConversation()
  const { context } = useConversationContext()

  return (
    <div className="flex flex-col h-screen bg-slate-900">
      {/* ä¸Šä¸‹æ–‡é¢æ¿ (å¯æŠ˜å ) */}
      <ContextPanel context={context} />

      {/* æ¶ˆæ¯åˆ—è¡¨ */}
      <MessageList messages={messages} />

      {/* è¾“å…¥åŒºåŸŸ */}
      <ChatInput onSend={sendMessage} />
    </div>
  )
}
```

### 3.2 ä¸Šä¸‹æ–‡é¢æ¿

```tsx
// components/chat/ContextPanel.tsx

export function ContextPanel({ context }: { context: ConversationContext }) {
  const [isExpanded, setIsExpanded] = useState(false)

  return (
    <motion.div
      className="bg-slate-800 border-b border-slate-700"
      animate={{ height: isExpanded ? 'auto' : 48 }}
    >
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="w-full px-4 py-3 flex items-center justify-between"
      >
        <span className="text-slate-400 text-sm">
          {context.journey_stage} Â· {context.active_dimensions.length} ç»´åº¦å·²è§£é”
        </span>
        <ChevronIcon className={isExpanded ? 'rotate-180' : ''} />
      </button>

      {isExpanded && (
        <div className="px-4 pb-4 space-y-3">
          {/* ä»Šæ—¥è¿åŠ¿æ‘˜è¦ */}
          {context.current_fortune && (
            <div className="bg-slate-700/50 rounded-lg p-3">
              <span className="text-xs text-slate-400">ä»Šæ—¥èƒ½é‡</span>
              <p className="text-white text-sm">{context.current_fortune.theme}</p>
            </div>
          )}

          {/* ç›¸å…³è®°å¿† */}
          {context.recent_memories.length > 0 && (
            <div className="bg-slate-700/50 rounded-lg p-3">
              <span className="text-xs text-slate-400">ç›¸å…³è®°å¿†</span>
              {context.recent_memories.slice(0, 2).map((m, i) => (
                <p key={i} className="text-white/80 text-xs mt-1">â€¢ {m.content}</p>
              ))}
            </div>
          )}

          {/* å³å°†å‘ç”Ÿçš„äº‹ä»¶ */}
          {context.upcoming_events.length > 0 && (
            <div className="bg-slate-700/50 rounded-lg p-3">
              <span className="text-xs text-slate-400">è¿‘æœŸäº‹ä»¶</span>
              {context.upcoming_events.slice(0, 2).map((e, i) => (
                <p key={i} className="text-white/80 text-xs mt-1">
                  â€¢ {e.event_date}: {e.title}
                </p>
              ))}
            </div>
          )}
        </div>
      )}
    </motion.div>
  )
}
```

### 3.3 å¢å¼ºæ¶ˆæ¯ç»„ä»¶

```tsx
// components/chat/Message.tsx

export function Message({ message }: { message: ChatMessage }) {
  const isAI = message.role === 'assistant'

  return (
    <div className={`flex ${isAI ? 'justify-start' : 'justify-end'} mb-4`}>
      <div
        className={`max-w-[80%] rounded-2xl px-4 py-3 ${
          isAI
            ? 'bg-slate-700 text-white'
            : 'bg-indigo-600 text-white'
        }`}
      >
        <p className="text-sm leading-relaxed">{message.content}</p>

        {/* ç»´åº¦å¼•ç”¨æ ‡ç­¾ */}
        {message.dimensions_referenced?.length > 0 && (
          <div className="flex gap-1 mt-2">
            {message.dimensions_referenced.map((dim) => (
              <span
                key={dim}
                className="text-xs px-2 py-0.5 rounded-full bg-white/10"
              >
                {DIMENSION_LABELS[dim]}
              </span>
            ))}
          </div>
        )}

        {/* æƒ…ç»ªæŒ‡ç¤ºå™¨ */}
        {message.emotional_state && (
          <EmotionalIndicator state={message.emotional_state} />
        )}
      </div>
    </div>
  )
}
```

---

## 4. ç”Ÿæ´»äº‹ä»¶ç®¡ç†

### 4.1 äº‹ä»¶é¡µé¢

```tsx
// app/events/page.tsx

export default function EventsPage() {
  const { events, createEvent } = useLifeEvents()
  const [showCreate, setShowCreate] = useState(false)

  return (
    <div className="min-h-screen bg-slate-900 p-4">
      <header className="flex justify-between items-center mb-6">
        <h1 className="text-xl font-bold text-white">ç”Ÿæ´»äº‹ä»¶</h1>
        <button
          onClick={() => setShowCreate(true)}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm"
        >
          æ·»åŠ äº‹ä»¶
        </button>
      </header>

      {/* æ—¶é—´çº¿è§†å›¾ */}
      <EventTimeline events={events} />

      {/* åˆ›å»ºäº‹ä»¶å¼¹çª— */}
      <CreateEventModal
        isOpen={showCreate}
        onClose={() => setShowCreate(false)}
        onCreate={createEvent}
      />
    </div>
  )
}
```

### 4.2 äº‹ä»¶æ—¶é—´çº¿

```tsx
// components/events/EventTimeline.tsx

export function EventTimeline({ events }: { events: LifeEvent[] }) {
  const grouped = groupEventsByDate(events)

  return (
    <div className="space-y-6">
      {Object.entries(grouped).map(([date, dayEvents]) => (
        <div key={date}>
          <div className="flex items-center gap-2 mb-3">
            <div className="w-2 h-2 rounded-full bg-indigo-500" />
            <span className="text-slate-400 text-sm">{formatDate(date)}</span>
          </div>

          <div className="ml-4 border-l border-slate-700 pl-4 space-y-3">
            {dayEvents.map((event) => (
              <EventCard key={event.id} event={event} />
            ))}
          </div>
        </div>
      ))}
    </div>
  )
}

function EventCard({ event }: { event: LifeEvent }) {
  return (
    <motion.div
      className="bg-slate-800 rounded-lg p-4"
      whileHover={{ scale: 1.02 }}
    >
      <div className="flex items-start justify-between">
        <div>
          <span className="text-xs text-indigo-400">
            {EVENT_TYPE_LABELS[event.event_type]}
          </span>
          <h3 className="text-white font-medium mt-1">{event.title}</h3>
          {event.description && (
            <p className="text-slate-400 text-sm mt-1">{event.description}</p>
          )}
        </div>
        <EventStatusBadge status={event.status} />
      </div>

      {/* AI å…³æ€€æ¶ˆæ¯ */}
      {event.pre_event_message && (
        <div className="mt-3 bg-slate-700/50 rounded-lg p-3">
          <span className="text-xs text-slate-400">VibeLife è¯´</span>
          <p className="text-white/80 text-sm mt-1">{event.pre_event_message}</p>
        </div>
      )}
    </motion.div>
  )
}
```

---

## 5. çŠ¶æ€ç®¡ç†å‡çº§

### 5.1 å…¨å±€çŠ¶æ€ Store

```tsx
// stores/useVibeStore.ts

import { create } from 'zustand'
import { persist } from 'zustand/middleware'

interface VibeState {
  // ç”¨æˆ·
  user: VibeUser | null
  journeyStage: JourneyStage

  // Identity Prism
  prism: IdentityPrism | null
  dimensions: DimensionProfile[]

  // ä»ªå¼
  todayRitual: DailyRitual | null

  // è®°å¿†
  recentMemories: Memory[]

  // äº‹ä»¶
  upcomingEvents: LifeEvent[]

  // Actions
  setUser: (user: VibeUser) => void
  setPrism: (prism: IdentityPrism) => void
  setTodayRitual: (ritual: DailyRitual) => void
  addMemory: (memory: Memory) => void
  addEvent: (event: LifeEvent) => void
}

export const useVibeStore = create<VibeState>()(
  persist(
    (set) => ({
      user: null,
      journeyStage: 'encounter',
      prism: null,
      dimensions: [],
      todayRitual: null,
      recentMemories: [],
      upcomingEvents: [],

      setUser: (user) => set({ user, journeyStage: user.journey_stage }),
      setPrism: (prism) => set({ prism }),
      setTodayRitual: (ritual) => set({ todayRitual: ritual }),
      addMemory: (memory) =>
        set((state) => ({
          recentMemories: [memory, ...state.recentMemories].slice(0, 10)
        })),
      addEvent: (event) =>
        set((state) => ({
          upcomingEvents: [...state.upcomingEvents, event].sort(
            (a, b) => new Date(a.event_date).getTime() - new Date(b.event_date).getTime()
          )
        }))
    }),
    { name: 'vibe-storage' }
  )
)
```

### 5.2 API Hooks

```tsx
// hooks/useIdentityPrism.ts

export function useIdentityPrism() {
  const { prism, dimensions, setPrism } = useVibeStore()

  const { data, isLoading, error } = useSWR('/api/v1/identity/prism', fetcher, {
    onSuccess: (data) => setPrism(data.prism)
  })

  const regenerate = async () => {
    const result = await api.post('/api/v1/identity/prism/regenerate')
    setPrism(result.prism)
    return result
  }

  return {
    prism: prism || data?.prism,
    dimensions: dimensions || data?.dimensions || [],
    isLoading,
    error,
    regenerate
  }
}

// hooks/useTodayRitual.ts

export function useTodayRitual() {
  const { todayRitual, setTodayRitual } = useVibeStore()

  const { data, isLoading } = useSWR('/api/v1/rituals/today', fetcher, {
    onSuccess: (data) => setTodayRitual(data),
    refreshInterval: 60000 // æ¯åˆ†é’Ÿåˆ·æ–°
  })

  const respondToMidday = async (response: string) => {
    const result = await api.post('/api/v1/rituals/midday/respond', { response })
    setTodayRitual(result.ritual)
    return result
  }

  return {
    ritual: todayRitual || data,
    isLoading,
    respondToMidday
  }
}
```

---

## 6. æ¨é€é€šçŸ¥é›†æˆ

### 6.1 Service Worker

```typescript
// public/sw.js

self.addEventListener('push', (event) => {
  const data = event.data.json()

  const options = {
    body: data.body,
    icon: '/icons/vibe-icon-192.png',
    badge: '/icons/vibe-badge.png',
    tag: data.tag,
    data: data.url,
    actions: data.actions || []
  }

  event.waitUntil(
    self.registration.showNotification(data.title, options)
  )
})

self.addEventListener('notificationclick', (event) => {
  event.notification.close()

  if (event.action === 'respond') {
    event.waitUntil(clients.openWindow('/chat'))
  } else {
    event.waitUntil(clients.openWindow(event.notification.data || '/'))
  }
})
```

### 6.2 æ¨é€è®¢é˜…

```tsx
// hooks/usePushNotifications.ts

export function usePushNotifications() {
  const [isSubscribed, setIsSubscribed] = useState(false)

  const subscribe = async () => {
    const registration = await navigator.serviceWorker.ready

    const subscription = await registration.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: process.env.NEXT_PUBLIC_VAPID_PUBLIC_KEY
    })

    await api.post('/api/v1/push/subscribe', {
      subscription: subscription.toJSON()
    })

    setIsSubscribed(true)
  }

  const unsubscribe = async () => {
    const registration = await navigator.serviceWorker.ready
    const subscription = await registration.pushManager.getSubscription()

    if (subscription) {
      await subscription.unsubscribe()
      await api.post('/api/v1/push/unsubscribe')
    }

    setIsSubscribed(false)
  }

  return { isSubscribed, subscribe, unsubscribe }
}
```

---

## 7. åŠ¨ç”»ä¸è¿‡æ¸¡

### 7.1 é¡µé¢è¿‡æ¸¡

```tsx
// components/layout/PageTransition.tsx

import { motion, AnimatePresence } from 'framer-motion'

export function PageTransition({ children }: { children: React.ReactNode }) {
  return (
    <AnimatePresence mode="wait">
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        exit={{ opacity: 0, y: -10 }}
        transition={{ duration: 0.2 }}
      >
        {children}
      </motion.div>
    </AnimatePresence>
  )
}
```

### 7.2 ä»ªå¼åŠ¨ç”»

```tsx
// components/ritual/RitualAnimation.tsx

export function MorningOracleAnimation() {
  return (
    <motion.div
      className="absolute inset-0 pointer-events-none"
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
    >
      {/* æ—¥å‡ºå…‰èŠ’æ•ˆæœ */}
      <motion.div
        className="absolute bottom-0 left-1/2 -translate-x-1/2 w-96 h-48 bg-gradient-radial from-amber-500/30 to-transparent"
        animate={{
          scale: [1, 1.2, 1],
          opacity: [0.3, 0.5, 0.3]
        }}
        transition={{
          duration: 4,
          repeat: Infinity,
          ease: 'easeInOut'
        }}
      />
    </motion.div>
  )
}
```

---

## 8. å®æ–½æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º home é¡µé¢
- [ ] å®ç° RitualCard ç»„ä»¶
- [ ] åˆ›å»º identity é¡µé¢
- [ ] å®ç° PrismVisualization ç»„ä»¶
- [ ] é‡æ„ chat é¡µé¢
- [ ] å®ç° ContextPanel ç»„ä»¶
- [ ] åˆ›å»º events é¡µé¢
- [ ] å®ç° EventTimeline ç»„ä»¶
- [ ] å‡çº§ useVibeStore
- [ ] å®ç° API hooks
- [ ] é…ç½® Service Worker
- [ ] å®ç°æ¨é€è®¢é˜…
- [ ] æ·»åŠ é¡µé¢è¿‡æ¸¡åŠ¨ç”»
- [ ] æ·»åŠ ä»ªå¼åŠ¨ç”»æ•ˆæœ

---

*ä¸‹ä¸€æ­¥: [05-è®¢é˜…ç³»ç»Ÿè®¾è®¡](./05-è®¢é˜…ç³»ç»Ÿè®¾è®¡.md)*
