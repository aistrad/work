# 数据模型重构方案

## 概述

基于战略蓝图的"统一理解引擎"和"六阶段用户旅程"要求，需要对现有数据模型进行重大升级。

---

## 1. 用户身份模型升级

### 1.1 现有模型

```sql
-- 当前 vibe_users 表
CREATE TABLE vibe_users (
    vibe_id UUID PRIMARY KEY,
    email VARCHAR(255),
    phone VARCHAR(50),
    avatar_url TEXT,
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### 1.2 升级方案

```sql
-- 新增: 用户旅程阶段追踪
ALTER TABLE vibe_users ADD COLUMN journey_stage VARCHAR(20) DEFAULT 'encounter';
-- journey_stage: encounter(相遇) | first_sight(初见) | understanding(了解) | trust(信任) | dependence(依赖) | symbiosis(共生)

ALTER TABLE vibe_users ADD COLUMN journey_started_at TIMESTAMP;
ALTER TABLE vibe_users ADD COLUMN last_active_at TIMESTAMP;
ALTER TABLE vibe_users ADD COLUMN consecutive_active_days INTEGER DEFAULT 0;
ALTER TABLE vibe_users ADD COLUMN total_conversations INTEGER DEFAULT 0;

-- 新增: 用户偏好设置
CREATE TABLE user_preferences (
    user_id UUID PRIMARY KEY REFERENCES vibe_users(vibe_id),

    -- 对话风格偏好
    preferred_persona VARCHAR(50) DEFAULT 'warm_friend',  -- warm_friend | tough_friend | life_mentor

    -- 推送偏好
    morning_oracle_enabled BOOLEAN DEFAULT true,
    morning_oracle_time TIME DEFAULT '07:00',
    midday_mirror_enabled BOOLEAN DEFAULT true,
    midday_mirror_time TIME DEFAULT '12:30',
    night_whisper_enabled BOOLEAN DEFAULT true,
    night_whisper_time TIME DEFAULT '21:30',

    -- 隐私设置
    allow_memory_storage BOOLEAN DEFAULT true,
    allow_insight_extraction BOOLEAN DEFAULT true,

    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_users_journey_stage ON vibe_users(journey_stage);
CREATE INDEX idx_users_last_active ON vibe_users(last_active_at);
```

---

## 2. Identity Prism (身份棱镜) 模型

### 2.1 设计理念

将用户的多维度身份数据融合为三维视角：
- **Core (核心本质)**: 你的本质驱动力
- **Inner (内在自我)**: 你内心真正想要的
- **Outer (外在表现)**: 别人眼中的你

### 2.2 数据模型

```sql
-- Identity Prism 核心表
CREATE TABLE identity_prism (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),

    -- 三维身份摘要 (AI生成的融合洞察)
    core_essence JSONB,      -- {"summary": "...", "keywords": [...], "confidence": 0.85}
    inner_self JSONB,        -- {"summary": "...", "keywords": [...], "confidence": 0.80}
    outer_expression JSONB,  -- {"summary": "...", "keywords": [...], "confidence": 0.75}

    -- 融合来源追踪
    source_dimensions JSONB, -- ["bazi", "zodiac", "mbti"]

    -- 版本控制
    version INTEGER DEFAULT 1,
    generated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(user_id, version)
);

-- 维度档案表 (每个技能的详细数据)
CREATE TABLE dimension_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),
    dimension_type VARCHAR(20) NOT NULL,  -- bazi | zodiac | mbti | tarot | yijing | dream | face

    -- 原始数据
    raw_data JSONB NOT NULL,  -- 各维度的原始计算结果

    -- AI解读
    interpretation JSONB,     -- AI对该维度的解读

    -- 与Identity Prism的映射
    core_contribution JSONB,   -- 该维度对Core的贡献
    inner_contribution JSONB,  -- 该维度对Inner的贡献
    outer_contribution JSONB,  -- 该维度对Outer的贡献

    -- 状态
    is_unlocked BOOLEAN DEFAULT false,
    unlocked_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(user_id, dimension_type)
);

-- 索引
CREATE INDEX idx_prism_user ON identity_prism(user_id);
CREATE INDEX idx_dimension_user ON dimension_profiles(user_id);
CREATE INDEX idx_dimension_type ON dimension_profiles(dimension_type);
```

---

## 3. 记忆系统模型

### 3.1 设计理念

实现蓝图中的"Memory Layer"，让AI真正"记得"用户。

### 3.2 数据模型

```sql
-- 用户记忆表 (长期记忆)
CREATE TABLE user_memories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),

    -- 记忆类型
    memory_type VARCHAR(30) NOT NULL,
    -- life_event: 生活事件 (面试、搬家、分手等)
    -- personality_trait: 性格特征 (AI推断)
    -- emotional_pattern: 情绪模式
    -- preference: 偏好习惯
    -- concern: 关注点/困扰
    -- relationship: 人际关系
    -- growth_milestone: 成长里程碑

    -- 记忆内容
    content TEXT NOT NULL,           -- 记忆的核心内容
    context JSONB,                   -- 上下文信息

    -- 来源追踪
    source_conversation_id UUID,     -- 来源对话
    source_message_id UUID,          -- 来源消息
    extraction_confidence FLOAT,     -- 提取置信度 (0-1)

    -- 时间维度
    event_time TIMESTAMP,            -- 事件发生时间 (如果是事件)
    is_future_event BOOLEAN DEFAULT false,  -- 是否是未来事件
    follow_up_date DATE,             -- 需要跟进的日期

    -- 状态
    is_active BOOLEAN DEFAULT true,
    importance_score FLOAT DEFAULT 0.5,  -- 重要性评分 (0-1)

    -- 向量嵌入 (用于语义检索)
    embedding vector(1024),

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- AI洞察表 (AI对用户的累积理解)
CREATE TABLE ai_insights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),

    -- 洞察类型
    insight_type VARCHAR(30) NOT NULL,
    -- personality: 性格洞察
    -- communication: 沟通风格
    -- emotional: 情绪模式
    -- growth: 成长轨迹
    -- prediction: 预测性洞察

    -- 洞察内容
    insight TEXT NOT NULL,
    supporting_evidence JSONB,  -- 支持该洞察的证据 (记忆ID列表)
    confidence FLOAT,           -- 置信度

    -- 版本控制 (洞察会随时间更新)
    version INTEGER DEFAULT 1,
    supersedes_id UUID,         -- 替代的旧洞察ID

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_memories_user ON user_memories(user_id);
CREATE INDEX idx_memories_type ON user_memories(memory_type);
CREATE INDEX idx_memories_follow_up ON user_memories(follow_up_date) WHERE follow_up_date IS NOT NULL;
CREATE INDEX idx_memories_future ON user_memories(event_time) WHERE is_future_event = true;
CREATE INDEX idx_memories_embedding ON user_memories USING ivfflat (embedding vector_cosine_ops);

CREATE INDEX idx_insights_user ON ai_insights(user_id);
CREATE INDEX idx_insights_type ON ai_insights(insight_type);
```

---

## 4. 生活事件追踪模型

### 4.1 设计理念

实现蓝图中的"关键事件跟踪"功能，让AI能主动关心用户的重要事件。

### 4.2 数据模型

```sql
-- 生活事件表
CREATE TABLE life_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),

    -- 事件信息
    event_type VARCHAR(30) NOT NULL,
    -- interview: 面试
    -- date: 约会
    -- exam: 考试
    -- travel: 旅行
    -- move: 搬家
    -- birthday: 生日
    -- anniversary: 纪念日
    -- medical: 医疗
    -- work_deadline: 工作截止
    -- custom: 自定义

    title VARCHAR(255) NOT NULL,
    description TEXT,

    -- 时间
    event_date DATE NOT NULL,
    event_time TIME,
    is_all_day BOOLEAN DEFAULT true,

    -- AI关怀计划
    pre_event_message TEXT,      -- 事件前的关怀消息
    day_of_message TEXT,         -- 当天的关怀消息
    post_event_follow_up TEXT,   -- 事件后的跟进消息

    -- 状态追踪
    status VARCHAR(20) DEFAULT 'upcoming',  -- upcoming | in_progress | completed | cancelled
    user_feedback TEXT,          -- 用户反馈 (事件后)

    -- 来源
    source VARCHAR(20) DEFAULT 'user_input',  -- user_input | ai_extracted | calendar_sync
    source_memory_id UUID REFERENCES user_memories(id),

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- 事件提醒表
CREATE TABLE event_reminders (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    event_id UUID NOT NULL REFERENCES life_events(id),

    reminder_type VARCHAR(20) NOT NULL,  -- pre_event | day_of | post_event
    scheduled_at TIMESTAMP NOT NULL,

    -- 状态
    status VARCHAR(20) DEFAULT 'pending',  -- pending | sent | failed | skipped
    sent_at TIMESTAMP,

    created_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_events_user ON life_events(user_id);
CREATE INDEX idx_events_date ON life_events(event_date);
CREATE INDEX idx_events_upcoming ON life_events(event_date, status) WHERE status = 'upcoming';
CREATE INDEX idx_reminders_scheduled ON event_reminders(scheduled_at) WHERE status = 'pending';
```

---

## 5. 每日仪式模型

### 5.1 设计理念

实现蓝图中的"晨谕/午照/夜语"三仪式系统。

### 5.2 数据模型

```sql
-- 每日仪式表
CREATE TABLE daily_rituals (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES vibe_users(vibe_id),
    ritual_date DATE NOT NULL,

    -- 晨谕 (Morning Oracle)
    morning_oracle JSONB,
    -- {
    --   "energy_theme": "突破",
    --   "prediction": "你可能会遇到...",
    --   "advice": "如果发生了，记得...",
    --   "generated_at": "2026-01-10T07:00:00Z",
    --   "sent_at": "2026-01-10T07:05:00Z",
    --   "opened_at": "2026-01-10T07:30:00Z"
    -- }

    -- 午照 (Midday Mirror)
    midday_mirror JSONB,
    -- {
    --   "check_in_question": "上午过得怎么样？",
    --   "morning_reference": "有没有遇到我说的那个情况？",
    --   "user_response": "确实遇到了...",
    --   "ai_follow_up": "很高兴你处理得很好...",
    --   "generated_at": "...",
    --   "sent_at": "...",
    --   "responded_at": "..."
    -- }

    -- 夜语 (Night Whisper)
    night_whisper JSONB,
    -- {
    --   "day_summary": "今天辛苦了...",
    --   "tomorrow_preview": "明天...",
    --   "closing_message": "晚安，[名字]。",
    --   "generated_at": "...",
    --   "sent_at": "...",
    --   "opened_at": "..."
    -- }

    -- 当日运势数据 (用于生成仪式内容)
    daily_fortune JSONB,
    -- {
    --   "bazi_day_pillar": "丙辰",
    --   "zodiac_transits": [...],
    --   "overall_energy": 0.75,
    --   "focus_areas": ["career", "relationship"]
    -- }

    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),

    UNIQUE(user_id, ritual_date)
);

-- 索引
CREATE INDEX idx_rituals_user_date ON daily_rituals(user_id, ritual_date);
CREATE INDEX idx_rituals_date ON daily_rituals(ritual_date);
```

---

## 6. 订阅与付费模型升级

### 6.1 现有模型分析

当前系统已有 `subscription_plans`, `subscriptions`, `payments` 表，需要升级以支持 L0-L3 模型。

### 6.2 升级方案

```sql
-- 升级订阅计划表
ALTER TABLE subscription_plans ADD COLUMN tier VARCHAR(10);
-- tier: L0 | L1 | L2 | L3

-- 更新现有计划数据
UPDATE subscription_plans SET tier = 'L1' WHERE plan_type = 'one_time';
UPDATE subscription_plans SET tier = 'L2' WHERE plan_type = 'monthly';
UPDATE subscription_plans SET tier = 'L3' WHERE plan_type = 'yearly';

-- 新增计划配置
INSERT INTO subscription_plans (name, tier, plan_type, price, currency, features) VALUES
('免费体验', 'L0', 'free', 0, 'CNY', '{
    "full_letter": true,
    "trial_days": 3,
    "daily_conversations": 3,
    "dimensions": ["bazi"],
    "rituals": false
}'),
('The Letter', 'L1', 'one_time', 29, 'CNY', '{
    "full_report_pdf": true,
    "identity_prism": true,
    "deep_conversations": 10,
    "dimensions": ["bazi", "zodiac"],
    "rituals": false
}'),
('The Companion', 'L2', 'monthly', 39, 'CNY', '{
    "unlimited_conversations": true,
    "daily_rituals": true,
    "weekly_fortune": true,
    "relationship_analysis": 1,
    "dimensions": ["bazi", "zodiac", "mbti", "tarot"],
    "rituals": true
}'),
('The Sanctuary', 'L3', 'yearly', 299, 'CNY', '{
    "all_l2_features": true,
    "unlimited_relationship": true,
    "quarterly_report": true,
    "annual_review": true,
    "priority_features": true,
    "dimensions": "all",
    "rituals": true
}');

-- 用户权益表 (实时计算用户当前权益)
CREATE TABLE user_entitlements (
    user_id UUID PRIMARY KEY REFERENCES vibe_users(vibe_id),

    -- 当前层级
    current_tier VARCHAR(10) DEFAULT 'L0',

    -- 权益详情
    conversations_remaining INTEGER,  -- L1用户的剩余对话次数
    relationship_analyses_remaining INTEGER,  -- L2用户的剩余关系分析次数

    -- 解锁的维度
    unlocked_dimensions TEXT[] DEFAULT ARRAY['bazi'],

    -- 有效期
    tier_expires_at TIMESTAMP,

    updated_at TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX idx_entitlements_tier ON user_entitlements(current_tier);
CREATE INDEX idx_entitlements_expires ON user_entitlements(tier_expires_at);
```

---

## 7. 对话增强模型

### 7.1 升级现有对话表

```sql
-- 增强 conversations 表
ALTER TABLE conversations ADD COLUMN context_snapshot JSONB;
-- 存储对话开始时的上下文快照，用于Context Orchestrator

ALTER TABLE conversations ADD COLUMN dimensions_used TEXT[] DEFAULT ARRAY[]::TEXT[];
-- 记录对话中使用了哪些维度

ALTER TABLE conversations ADD COLUMN emotional_arc JSONB;
-- 记录对话的情绪变化轨迹

-- 增强 messages 表
ALTER TABLE messages ADD COLUMN extracted_memories UUID[];
-- 从该消息中提取的记忆ID列表

ALTER TABLE messages ADD COLUMN emotional_state JSONB;
-- {"detected_emotion": "anxious", "confidence": 0.8, "intensity": 0.6}

ALTER TABLE messages ADD COLUMN dimensions_referenced TEXT[];
-- 该消息中引用的维度
```

---

## 8. 数据迁移策略

### 8.1 迁移顺序

1. **Phase 1**: 创建新表 (不影响现有功能)
2. **Phase 2**: 添加新字段到现有表
3. **Phase 3**: 数据回填 (为现有用户生成初始数据)
4. **Phase 4**: 启用新功能

### 8.2 回填脚本示例

```python
# scripts/migrate_user_journey.py

async def migrate_user_journey_stages():
    """根据用户历史行为推断旅程阶段"""

    users = await db.fetch_all("SELECT * FROM vibe_users")

    for user in users:
        # 计算用户活跃天数
        active_days = await calculate_active_days(user['vibe_id'])

        # 检查是否有付费记录
        has_paid = await check_payment_history(user['vibe_id'])

        # 推断旅程阶段
        if active_days >= 60 and has_paid:
            stage = 'symbiosis'
        elif active_days >= 14 and has_paid:
            stage = 'dependence'
        elif active_days >= 3:
            stage = 'trust'
        elif active_days >= 1:
            stage = 'understanding'
        else:
            stage = 'first_sight'

        await db.execute(
            "UPDATE vibe_users SET journey_stage = $1 WHERE vibe_id = $2",
            stage, user['vibe_id']
        )
```

---

## 9. 性能考虑

### 9.1 索引策略

- 所有外键字段建立索引
- 高频查询字段建立复合索引
- 向量字段使用 IVFFlat 索引

### 9.2 分区策略

```sql
-- 对话消息表按月分区 (数据量大)
CREATE TABLE messages_partitioned (
    LIKE messages INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- 每日仪式表按月分区
CREATE TABLE daily_rituals_partitioned (
    LIKE daily_rituals INCLUDING ALL
) PARTITION BY RANGE (ritual_date);
```

### 9.3 缓存策略

- 用户权益 (user_entitlements): Redis 缓存，TTL 5分钟
- Identity Prism: Redis 缓存，TTL 1小时
- 每日仪式: Redis 缓存，TTL 到当天结束

---

## 10. 实施检查清单

- [ ] 创建 user_preferences 表
- [ ] 创建 identity_prism 表
- [ ] 创建 dimension_profiles 表
- [ ] 创建 user_memories 表
- [ ] 创建 ai_insights 表
- [ ] 创建 life_events 表
- [ ] 创建 event_reminders 表
- [ ] 创建 daily_rituals 表
- [ ] 升级 subscription_plans 表
- [ ] 创建 user_entitlements 表
- [ ] 增强 conversations 表
- [ ] 增强 messages 表
- [ ] 执行数据回填脚本
- [ ] 验证索引性能
- [ ] 配置缓存策略

---

*下一步: [02-后端服务重构](./02-后端服务重构.md)*
