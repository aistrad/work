# Tieban 12k 算法（以 `research tieban.md` 原文为准）

本文件目的：
1) 以原文出现内容为“可用/可实现”的边界，列出铁板 12k 的取数/考刻方法；
2) 对比外部方案/总结中与原文不一致处并校正；
3) 给出适配当前系统（候选展示 → 用户选择锁定 → 生成命书）的优化版算法（可直接映射到代码实现）。

---

## 0. 关键约束（来自原文的硬事实）

- `96` 是铁板体系的核心骨架：一日 `12` 时辰 × 一时 `8` 刻 = `96` 刻，且 `12000 / 96 = 125`（原文明确强调）。
- 原文存在多套门派/讲义体系（坤集、八卦滚、四门变、大定数等），细节不完全一致；系统应以“稳定可复现的参数表 + 明确算式 + 可审计输入输出”为主链路，把其余视为可选扩展。

---

## 1. 方法全量清单（按“考刻校准” vs “取数推演”）

### 1.1 考时定刻 / 考刻（校准输入，锁定真刻）

原文中，“考时定刻”的目的就是解决“八字相同命不同”，把 2 小时的时辰细分为刻/分。

1) **八刻 / 九十六局（八刻天干法 / 九十六刻天干数）**
- 粗分：一时辰 8 刻（15 分钟/刻），全天 96 刻。
- 操作：用四柱天干数（或其组合）求余/选刻，再以条文问答核验。
- 原文评价：常见，但若仅靠此类“余数选刻”，容易偏粗，仍需更多校验或与其它法共振。

2) **甲乙斗宫定刻分（坤集表）**
- 原文直接把它列为定刻口诀体系的一部分（“甲乙斗宫定刻分…八刻天干定”）。
- 特征：依赖“斗宫/甲乙宫”的固定表格序列（属于强数据依赖法）。

3) **乾坤宫 / 乾坤甲流度（父母生肖为锚点的考刻体系）**
- 原文出现“乾考父、坤考母”的明确说法，并给出父/母条文号序列（如 `9003/9053/...` 一路到 `9553` 等）。
- 作用：用“父/母生肖”这类最稳定的已知事实校正刻位/卦气（属于强约束校准）。

4) **套口风确认法（确认/校正，而非起算主引擎）**
- 原文把“套口风”定义为一种确认技巧：先算出一个位置（如父母条文），再通过“派生条文”去问当事人验证。
- 原文示例里提到“父退母进/父进母退”这类“位置扰动后再问”的思路，属于校验流程的一部分，但不应混同为某一种单独的取数引擎。

5) **四柱化卦十二地断（用卦直断六亲，尽量不依赖条文）**
- 原文明确说：该法“可以完全不需要利用铁板条文，它只需要用到卦”。
- 注意：原文同时强调“起刻点”的选择很关键（不同命盘需从三刻/四刻/…乃至反转一二刻去试），并非“一次算出唯一父母生肖”这么简单；它更像一套“基于卦的试探式校准”。

6) **紫微斗数辅助（变种体系，原文倾向否定其“正宗铁板”属性）**
- 原文把它描述为“紫微铁板/变种”，可参考但不应作为铁板主链路。

7) **扣入法（核心目标：用六亲数扣出真刻分）**
- 原文强调：扣入法是“动作/手段”，是把六亲数（父母/兄弟/配偶/子息等）化为数字后“扣入算盘”得到真刻分。
- 原文没有给出完整可复现的表与步骤细节，因此在系统里只能作为“概念层/可选扩展”对待，而不是当前可落地的主流程。

---

### 1.2 取数推演（生成输出，产出条文号集合）

1) **四柱天干取数（含合化）**
- 不传密数：天干 → 个位（例：`甲1 乙6 丙2 丁7 戊3 己8 庚4 辛9 壬5 癸0`）。
- 排列顺序：原文示例为“月→日→时→年”组成 4 位基数（如 `2521`）。
- `±96` 网格扩展：基数按 `+96*k` 扫描（对应 96 刻网格）。
- 合化：原文强调“只公布半套会导致准确率约 1/3”，必须补上“五行合化”（且带月份条件与夹字不化等规则）。

2) **八卦加则（核心，原文给出完整口诀与表格）**
- 原文同时给出两类可落地的输出：
  - **爻数法**（“爻从三十起…乾卦六为头…下卦作尾”）：得到类似 `1387` 的 4 位数。
  - **世应两同俦**（纳甲六爻干支合数，上三爻/下三爻分别求和）：得到类似 `2645` 的 4 位数。
- 原文还提供“八卦加则不传密数表”，本质是把上面两条路径预计算成查表（同一上卦/下卦组合会给出两个数）。

3) **日主变卦（Day Mutation）**
- 原文明确：在八卦加则里，日柱有独立的“日主化卦”起法，并对所得数做 `±96` 扩展若干次，以强化日柱权重、产出更多条文。

4) **16 组加减秘数 vs 质因数加减秘数（两套不同东西）**
- **16 组加减秘数**：一组 16 个数（原文列出 `1243...6057`），解释为 4×4 变化；常用于校验/确认，也可用于扩展搜索。
- **质因数加减秘数**：序列如 `1327/1543/5017/...` 两套链式加减；原文指出它更像“变种体系/紫微铁板”，但在工程上可作为“救援扩展”。

5) **前后卦取数（原文给出可复现示例：曹展硕《铁版神数总论》）**
- 原文给出可直接编码的示例流程：以“太玄数（干支各自有数）”为输入，求得**前卦（考六亲）**与**后卦（推运程）**，并进一步组合出可直接查条文的 4 位数（如示例中的 `3788`、`2664`）。
- 工程化要点：
  - 需要固化“太玄数（天干/地支）”与“去十不用/除八取余（余 0 视作 8）”规则；
  - 需要固化“上卦+6（乾卦六为头）→千位、互卦→十/个位”的取数拼装规则。

6) **八卦滚 / 四门变（原文给出完整算式：`tutorial-privacy.html` 段落）**
- 重大点：原文在 `tutorial-privacy.html` 段落披露了**可落地的生成公式与固定乘数**，足以形成“批量条文生成器”，不应简单归类为“门内功不可实现”。
- 核心结构（原文原话/算式要点）：
  - 由“基本卦/基本数序”推演出 4（四门变）或 8（八卦滚）个卦；
  - 将卦转换为“隐藏秘数”（如例子中的 `78、94、85、84`）；
  - 用固定乘数 `[19, 37, 53, 79, 103, 237]` 计算：`hidden * fixed - 7`；
  - 再用卦的“排列数序”计算：`verse_id = (arrange * 47) + (hidden * fixed - 7)`；
  - 归一化：若超出范围则 `±12000` 回到条文区间（原文明确写了 `+12000 / -12000` 的归一化规则）。
- 工程化结论：可作为“内容丰富度主力引擎”，但必须以 **Seed + 验收算例** 固化静态表与变体选择（否则不同门派差异会导致不一致）。

7) **十二消息卦（辟卦）/大定数/心易法门（保留但不作为 V1 主链路）**
- 原文信息量大，但“统一规范 + 可验收的全套表”在当前资料中仍不足；可作为后续研究与扩展模块。

---

## 2. 对比：当前 Algo（本文件旧版） vs IronPlate_Engine_V1 方案

本节目的：把 IronPlate_Engine_V1 里“成立且应提升优先级”的部分吸收进来，同时把“与原文不符或工程上仍缺口”的部分标注出来，避免过度承诺。

### 2.1 一致且应强化的点（我们采纳）

- **A. 四柱天干取数的位权顺序必须锁死**：原文示例清楚是“月千、日百、时十、年个”（如 `2521`），这是最易错但最关键的工程细节。
- **B. 八卦加则应优先查表（LUT）**：原文“不传密数表”可以视为计算结果缓存；工程上优先录入/固化该表，避免动态计算爻数时引入偏差。
- **C. 强制区分不同“数体系”**：原文同时出现
  - 不传密数（甲1乙6…）用于四柱天干网格；
  - 太玄数（天干/地支）用于前后卦与四门变/八卦滚；
  - 洛书取卦数（1..9 映射八卦）用于取卦；
  - “遇十不用/去十不用”规则。
  若不隔离，将导致不可解释的错配。
- **D. 四门变/八卦滚不应低估**：`tutorial-privacy.html` 段落提供了乘数与核心公式，足以作为 V1 的“批量生成器”（但要固化表与验收算例）。

### 2.2 与原文不符或需要修正的点（我们纠偏）

1) **“前后卦 = (年+月)%8 / (日+时)%8”不成立**
- 原文确实给出“前卦/后卦”的可复现示例，但算法是“干支→太玄数→求和→除八取余/去十不用→取卦”，并非简单对年份序号做模运算。

2) **“四柱化卦十二地断可以完全自动、无需试刻点”表述过强**
- 原文明确强调“起刻点的运用”“三刻不对推四刻…再反转一二刻…”，并牵涉命宫入卯等条件；可做方向，但需要补齐规则与表，才能成为可靠的自动化入口。

3) **“弃用甲乙斗宫/九十六刻”需要更精确的工程结论**
- 原文这些方法依赖诗词/口风确实不适合现代 UI 交互；
- 但作为离线 fallback/rescue（当已知事实极少、或候选分数接近）仍可保留在规则集中开关化使用。

---

## 3. 优化版算法（IronPlate_Engine_V1.1，面向当前系统实现）

### 3.1 输入与上下文

- 输入：出生日期时间（含时区/经纬可选）、性别、出生地（可选）、已知事实（父/母生肖、兄弟数、配偶生肖等）。
- 预处理：按系统时间模块计算真太阳时与边界分裂（节气/时辰边界），得到 `pillars_contexts[]`（每个 context 一套四柱）。

### 3.2 静态数据层（必须 Seed 化，禁止“散文反推”）

> 这部分是 IronPlate_Engine_V1 方案的核心优点：把所有不稳定的“口传表/口诀”固化为静态资产，确保可审计。

- `MAP_STEM_STD`：不传密数（四柱天干网格用）：`{甲:1, 乙:6, 丙:2, 丁:7, 戊:3, 己:8, 庚:4, 辛:9, 壬:5, 癸:0}`。
- `MAP_STEM_TAIXUAN` / `MAP_BRANCH_TAIXUAN`：太玄数（前后卦、四门变/八卦滚用）：来自原文“太玄配数诀/太玄数表”段落。
- `TABLE_HEX_SECRET`：八卦加则不传密数表（上卦×下卦 → 两数），建议 OCR 后写成 JSON Seed（与 DB 版本绑定）。
- `HEHUA_RULES`：五行合化规则（含月令条件与“夹字不化”）。
- `CONST_FOURMEN_FIXED = [19, 37, 53, 79, 103, 237]`，`CONST_FOURMEN_MUL = 47`，`CONST_FOURMEN_BIAS = -7`：来自 `tutorial-privacy.html` 段落。

### 3.2 候选生成（多引擎并行，统一映射到 12k 条文网格）

对每个 `pillars_context`：

1) **Stem Engine（四柱天干取数 + 合化备选）**
- 依据原文不传密数把天干转为个位。
- 按“月→日→时→年”形成 4 位基数 `base_stem`。
- 若命中合化条件，生成若干 `base_stem_alt`（作为备选分支，而非覆盖）。

2) **Hex Engine（八卦加则，查表优先）**
- 用“天干配卦/地支配卦”把每柱映射为上卦/下卦。
- 查“八卦加则不传密数表”得到该柱的 `base_values`（通常为两数）。
- 可选：保留“爻从三十起”的公式路径用于可解释性校验（参数常量化，避免从散文反推）。

3) **Day Mutation（对日柱进行 `±96` 扩展）**
- 默认使用“日柱八卦加则的第一数”，做 `±96` 多次扩展，生成额外 base 列表。

4) **刻（ke）展开：`ke ∈ [1..8]`**
- 对每个 `base`，扩展 8 个刻位候选。
- 核心映射：`verse_id = normalize(base + (ke-1))` 后按 `+96*k` 扫描，形成 125 条（对应 `12000/96=125`）。
- 可选规则：
  - `avoid_ten`（对应原文“遇十不用”的工程化近似：过滤末位为 0 的条文号）。
  - `linear_offsets`（如 `+7n/+21`）与 `secret_jump`（如 `±1327/±1543/...`）作为 rescue 扩展（配置化、可开关、可审计）。

输出：候选集合 `candidates[]`，每条包含 `{context_id, base, ke, engine, pillar, verse_ids[]}`。

### 3.3 证据抽取与评分（把“套口风”变成一次性证据展示）

1) **条文事实结构化**
- 通过 ETL 将 `content_raw` 抽取为 `fact_meta`（如 `father_zodiac/mother_zodiac/siblings_count/spouse_zodiac`），并做语义归一化（鼠→子→`ZI` 等）。

2) **证据计分**
- 对每个候选的 `verse_ids[]`：
  - 统计与用户已知事实一致的条文条数作为“命中证据”；
  - 若条文明示了其它事实且与用户已知事实矛盾，则该条不计入证据（避免“父鼠母猪”输入却展示“父龙母猪”为命中）。
- 输出每个候选的证据预览列表（用于 UI 展示与用户选择）。

### 3.4 用户选择锁定（替代多轮问答）

- UI 展示：按证据分数降序展示候选命盘（含四柱、基数、真刻、命中条文证据）。
- 用户选择 `candidate_id = context_id:base:ke`：
  - 锁定 `selected_candidate_id`、`true_ke` 与 `locked_context_id`；
  - 后续所有命书计算统一以该锁定结果为 SSOT。

### 3.5 命书生成（按 `mingshu spec.md` 组织）

命书输出建议由两层条文集合合并而成：

1) **网格条文（Grid Verses）**：来自锁定候选的 `verse_ids[]`（stem/hex/day_mut + 96 网格）。
2) **高阶生成条文（Generated Verses，可选但建议启用）**：来自原文已披露公式的“前后卦取数”与“四门变/八卦滚”。

#### 3.5.1 前后卦取数（曹展硕示例：生成 4 位条文号）

- 输入：四柱（干支），干支各取太玄数（原文示例中写成 `8庚寅7` 这类“干=8、支=7”）。
- 前卦（六亲）：
  - 年柱：`sum = stem_tx + branch_tx`，`r = sum % 8`（余 0 视作 8），得到上卦数；
  - 月柱同理得到下卦数；
  - 合成前卦（示例为“山地剥”）。
- 后卦（运程）：
  - 日柱：`sum = stem_tx + branch_tx`，去十不用（取个位）得到上卦数；
  - 时柱同理得到下卦数；
  - 合成后卦（示例为“天山遁”）。
- 拼装条文号（示例）：
  - 千位：`(上卦 + 6)` 去十不用；
  - 百位：上卦数；
  - 十/个位：互卦上下卦数拼装；
  - 得到可直接查条文的 4 位数（示例：`3788`、`2664`）。

> 备注：该法不依赖“真刻分”，适合作为命书的“补充条文来源”（增强内容密度），但不适合作为锁定刻分的唯一依据。

#### 3.5.2 四门变 / 八卦滚（tutorial-privacy：批量生成条文号）

该段落提供了“固定秘数 + 乘法 + 47 + -7”的明确公式。建议工程化为可选引擎 `engine_fourmen_roll()`：

1) 由八字求“基本卦”与“基本数序”（原文给出“奇偶数分组相加除以八取卦 + 八卦基本配数表”的流程）。
2) 推演出 4 个卦（四门变）或 8 个卦（八卦滚），并把每个卦转换成：
   - `arrange`：卦的“排列数序”（如示例里的 `57/13/42/86`）；
   - `hidden`：卦导引出来的“隐藏秘数”（如示例里的 `78/94/85/84`）。
3) 对每个 `hidden` 与每个 `fixed ∈ [19,37,53,79,103,237]` 计算：
   - `seq = hidden * fixed - 7`
   - `vid = arrange * 47 + seq`
4) 归一化到条文区间：
   - `while vid < range_min: vid += 12000`
   - `while vid > range_max: vid -= 12000`
5) 得到一批可直接查表的条文号集合（原文示例产出几十条以上）。

#### 3.5.3 输出组织（与现有 DB/ETL 对齐）

- 合并：`final_verse_ids = union(grid_verse_ids, generated_verse_ids)`。
- 回表取全文（必须展示原文）：`tieban_verses.content_raw`。
- 利用 `age_start/age_end` 将条文分为：
  - `general`（0,0 或性质类）
  - `kinship`（六亲/事实类）
  - `annual`（有明确岁段）
- 按 `mingshu spec.md` 的栏目框架输出；栏目内容建议“栏目框架固定 + 内容动态填充”，避免栏目随命中条文漂移导致前端不稳定。

---

## 4. 当前最适合的主链路（结论）

- **主链路（锁定刻分）**：`四柱天干（含合化） + 八卦加则（查表） + 日主变卦（±96） → 候选 → 证据评分 → 用户选择锁定`。
- **命书生成（增强内容密度，建议启用）**：在锁定后追加 `前后卦取数` 与 `四门变/八卦滚（tutorial-privacy）` 作为“高阶生成条文源”，与网格条文合并输出。
- **rescue（可选开关）**：`线性偏移（+7n/+21）`、`secret jump（±1327/±1543/...）`、`乾坤甲流度` 用于证据不足时扩展候选或提示用户补充事实。
- **暂不纳入主链路**：`扣入法完整闭环`、`十二消息卦/大定数/心易法门`（需先固化规则集与验收样例，否则不可审计也难稳定复现）。
