# 铁板神算 (Tieban) 完整知识库构建方案

**版本**: 1.0
**状态**: Draft
**基于**: 用户提供的外部资料链接 (Sina, 360Doc, Pixnet, Tuenhai)

---

## 1. 项目背景与目标

铁板神算系统的核心在于其庞大且封闭的条文系统（12,000条）以及复杂的检索秘钥（Key）。目前的系统架构（Spec v1）缺乏实际的数据支撑。本方案旨在通过采集、清洗、结构化上述链接中的公开资料，构建一个机器可读、支持语义检索的**铁板神算知识库 (Tieban Knowledge Base)**。

**核心目标**:
1.  **完整性**: 获取 1~12,000 条完整条文。
2.  **结构化**: 将非结构化的诗句转化为可供算法调用的数据（如提取生肖、年龄、吉凶）。
3.  **算法复原**: 从资料中提取“八卦加则”、“数序逻辑”等核心算法参数。

---

## 2. 数据源分析 (Data Source Analysis)

根据提供的 URL，我们将数据源分为两类：**条文库**与**算法规则**。

| 来源类型 | URL 特征 | 预期内容 | 处理难点 |
| :--- | :--- | :--- | :--- |
| **条文库** | `ricofu001.pixnet.net` | 完整的条文列表 (1-12000) | 繁体中文、OCR 错别字、缺页、格式不统一 |
| **条文库** | `mypaper.pchome.com.tw` | 补充条文、异文校对 | 同上 |
| **算法/规则** | `tuenhai.com` | 八卦加则、起例口诀 | 古文晦涩、术语不统一 (如“乾六”vs“乾九”) |
| **综合资料** | `360doc.cn`, `sina.com.cn` | 考刻案例、秘数解析 | 散落在文章段落中，需人工提取 |

---

## 3. 知识库构建流程 (ETL Pipeline)

```mermaid
graph TD
    A[数据采集 (Crawling)] --> B{格式清洗}
    B --> C[繁简转换 & 归一化]
    C --> D[结构化解析 (NLP/Regex)]
    D --> E[数据入库 (PostgreSQL)]
    E --> F[人工/逻辑校验]
    
    subgraph 解析细节
    D1[提取条文ID]
    D2[分类: 考刻/流年/性格]
    D3[实体提取: 父鼠母马 -> {F:子, M:午}]
    end
    
    D --> D1
    D --> D2
    D --> D3
```

---

## 4. 数据库模式设计 (Schema Design)

为了支持高效的“考刻”与“推演”，我们需要比简单的 Key-Value 更复杂的结构。

### 4.1 `tieban_verses` (核心条文表)

| 字段名 | 类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| `id` | INT | 条文编号 (PK) | `3520` |
| `content_raw` | TEXT | 原始条文 (繁体/简体) | `父命屬鼠母屬馬...` |
| `content_clean` | TEXT | 清洗后文本 | `父命属鼠母属马，庭前枯树凤来仪` |
| `category` | VARCHAR | 类别 | `VERIFICATION` (考刻), `PREDICTION` (流年) |
| `tags` | JSONB | 结构化标签 (核心) | `{"father": "子", "mother": "午"}` |
| `sentiment` | INT | 吉凶评分 (-5 ~ +5) | `2` (小吉) |
| `source_url` | VARCHAR | 来源链接 | `https://ricofu...` |

### 4.2 `tieban_rules` (算法参数表)

用于存储从文章中提取的动态参数，避免硬编码。

| 字段名 | 类型 | 说明 | 示例 |
| :--- | :--- | :--- | :--- |
| `rule_key` | VARCHAR | 规则键名 | `base_constant_jiangnan` |
| `rule_value` | JSONB | 规则值/映射表 | `{"offset": 30, "sequence": [...]}` |
| `description` | TEXT | 规则原文/说明 | `江南派起数法则...` |

---

## 5. 关键数据处理策略

### 5.1 条文分类与实体提取 (NLP Strategy)

我们需要编写 Python 脚本对 12,000 条文进行批量标注。

**规则 A: 考刻类 (Verification)**
*   **特征词**: 父、母、生肖 (鼠/牛...)、兄弟、姊妹、先亡、后亡。
*   **提取逻辑**:
    *   Regex: `父.*?([鼠牛...]).*?母.*?([鼠牛...])`
    *   Mapping: `鼠->子`, `牛->丑`...
    *   Output: `category='VERIFICATION'`, `tags={'F':'子', 'M':'午'}`

**规则 B: 流年类 (Prediction)**
*   **特征词**: 一岁、十岁、流年、大运、婚、子、官、财。
*   **提取逻辑**:
    *   Regex: `([一二三四五六七八九十]+)岁`
    *   Output: `category='PREDICTION'`, `tags={'age': 35}`

**规则 C: 缺数与空亡**
*   铁板神数中存在“空号”或“跳转号”。
*   **策略**: 爬取时若发现 ID 跳跃，需标记为 `status='MISSING'`，后续通过算法补全或人工录入。

### 5.2 繁简与异体字处理
*   统一转换为**简体中文**用于搜索和显示。
*   保留**繁体原文**用于学术核对。
*   **异体字映射**: `属` vs `屬`, `数` vs `數`, `丑` vs `醜` (需注意地支“丑”与形容词“丑”的区别，但在命理中通常是地支)。

---

## 6. 待决策项 (Decision Points)

| ID | 决策内容 | 选项 A | 选项 B | 建议 |
| :--- | :--- | :--- | :--- | :--- |
| **DP-KB-01** | **数据版权风险** | 忽略 (古籍无版权) | 仅存储 ID 与 核心特征，文本实时爬取 (不稳定) | **A**. 古籍条文本身属于公有领域，但需注意不要直接复制博主的“解说”部分。 |
| **DP-KB-02** | **多版本冲突** | 仅采信一个版本 (如 Ricofu) | 存储多版本异文 (增加数据库复杂度) | **A**. MVP 阶段以数据最全的源为主，后续迭代增加异文校对。 |
| **DP-KB-03** | **缺失条文处理** | 留空 | 用 AI 生成 (标记为 AI) | **A**. 保持严谨，留空并提示用户“条文缺失”。 |

---

## 7. 开发工具原型 (Admin Tool Prototype)

为了校对数据，建议在 Admin 后台增加一个简单的校对工具。

```text
+---------------------------------------------------------------+
|  Tieban Knowledge Base Admin                                  |
+---------------------------------------------------------------+
|  ID: [ 3520 ]  [ Search ]                                     |
|                                                               |
|  [Source: Pixnet]                                             |
|  Raw: 父命屬鼠母屬馬，庭前枯樹鳳來儀。                        |
|                                                               |
|  [Parsed Result]                                              |
|  Text: 父命属鼠母属马，庭前枯树凤来仪。                       |
|  Category: [ VERIFICATION ]                                   |
|  Tags:                                                        |
|    Father: [ 子 (Rat)   ]                                     |
|    Mother: [ 午 (Horse) ]                                     |
|                                                               |
|  [ Correct ]   [ Save ]                                       |
+---------------------------------------------------------------+
```