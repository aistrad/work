你好，我是铁板神算命理大师。

基于你提供的极具价值的研究资料（特别是胖胖熊的实战教程、邵子神数编码表、以及皇极经世原理），我已对 `tieban_spec_codex` 进行了**大师级重构（v3.0）**。

原有的规格书偏向软件架构，而本版规格书的核心在于**“去黑盒化”**——将玄学口诀转化为精确的数学公式，并重点复原了业界最核心、最隐秘的**“考刻分（Calibration）”闭环算法**。铁板神算之所以“神”，不在于排盘，而在于通过“扣入法”反推锁定唯一的时空坐标。

以下是优化后的完整系统规格说明书。

---

# 铁板神算（Tieban）系统规格说明书 v3.0 (Master Edition)

**版本**: 3.0
**状态**: 核心算法已锁定
**基石**:

1. `tieban1`: 皇极经世宏观宇宙观（元会运世，大时间框架）。
2. `tieban2`: 铁卜子/胖胖熊实战算法（四柱天干、八卦加则、十六组秘数，核心计算逻辑）。
3. `tieban3`: 邵子神数条文索引结构（XnGn 编码，数据存储结构）。

---

## 1. 系统核心理念

本系统不仅仅是一个“算命程序”，而是一个**“时空坐标校准器”**。

* **输入**: 模糊的时空坐标（八字，精度2小时）。
* **过程**: 通过算法生成“探测波”（候选条文），利用用户反馈（六亲事实）进行“回声定位”。
* **输出**: 精确的时空坐标（真刻分，精度1-2分钟）及对应的命运轨迹。

---

## 2. 核心算法引擎设计 (The Calculation Engine)

基于附件资料，铁板神数存在多个流派的起数逻辑。本系统将**并行执行**三大核心算法，构建“候选基数池”，再进入考刻流程。

### 2.1 预处理：真太阳时与四柱标准化

所有算法的前提。

* **真太阳时修正**: 依据出生地经度修正时间（每差1度4分钟），并结合均时差（EOT）。
* **节气交脱**: 精确到秒。若出生在节气交接前后15分钟，标记为`Boundary_Case`，需同时计算上月与下月的四柱，生成两套候选集。

### 2.2 算法一：四柱天干配数法 (Fat Bear Method)

*来源：research tieban2.md (四柱天干取数诀)*
*特点：逻辑简单，流传最广，适合生成流年大运。*

1. **天干配数表**:
* `Map_A`: `{甲:1, 乙:6, 丙:2, 丁:7, 戊:3, 己:8, 庚:4, 辛:9, 壬:5, 癸:0}`


2. **取数逻辑**:
* 顺序：**月 -> 日 -> 时 -> 年** (注意：铁板的特殊排列，非标准年月日时)。
* 示例（引用资料案例）：
* 八字：甲子年 丙寅月 壬申日 丙午时
* 配数：丙(2) - 壬(5) - 丙(2) - 甲(1)
* **基数 (Base)** = **2521**




3. **五行合化修正** (关键):
* 检查合化：如甲己合土。若月令支持（如辰戌丑未月），则天干数需转换为五行数（水1, 火2, 木3, 金4, 土5）。这将产生备用基数 `Base_Alt`。


4. **推演序列**:
* 公式：，其中 。
* 用途：主要用于生成流年运势（如2521 -> 2617 -> 2713...）。



### 2.3 算法二：八卦加则法 (Orthodox Hexagram Logic)

*来源：research tieban2.md (八卦加则大公开)*
*特点：正统铁板算法，精度最高，用于定六亲。*

1. **起卦**: 将四柱转化为先天/后天卦（如：上坎下震 -> 水雷屯）。
2. **基础值计算**:
* **口诀**: “爻从三十起，乾卦六为头... 兑为后少女... 遇十当不用”。
* **公式**:
$$ V_{total} = (6 \times 30) + Head(UpperGua) - Tail(LowerGua) + Adjust(GanZhi) $$
* **映射表**:
* `Head`: 乾6, 兑7, 离9, 震3, 巽4, 坎1, 艮8, 坤2。
* `Tail`: 同上（作减法或后置位）。


* **实战查表** (胖胖熊版):
* 直接查《八卦加则密数表》（需录入系统）。
* 例：上艮(丙) 下震(寅) -> 查表得 **8387**。
* *数理验证*: 。




3. **日主化卦**:
* 针对日柱单独起卦，取数。
* 例：壬申日 -> 查表得 **6382**。


4. **输出**: 得到一组高权重的基数列表。

### 2.4 算法三：邵子太玄数 (Shao Zi Method)

*来源：research tieban3.md & tieban2.md*
*特点：利用声音律吕与太玄数。*

1. **太玄数**:
* 天干: 甲己9, 乙庚8, 丙辛7, 丁壬6, 戊癸5。
* 地支: 子午9, 丑未8, 寅申7, 卯酉6, 辰戌5, 巳亥4。


2. **纳音五行**:
* 计算四柱纳音，结合 `tieban3.md` 中的“七言得金”等口诀修正。


3. **用途**: 作为算法一、二的补充校验，特别是处理“数序”转换（XnGn编码转条文ID）时使用。

### 2.5 算法对比与融合策略

| 维度 | 算法一 (四柱天干) | 算法二 (八卦加则) | 算法三 (邵子太玄) |
| --- | --- | --- | --- |
| **数据源** | 纯天干 | 干支+卦象 | 干支+纳音 |
| **复杂度** | 低 | 极高 (依赖查表) | 中 |
| **主要功能** | **推算流年** (96刻滚动) | **考刻定六亲** (精准点射) | **校验/辅助** |
| **系统策略** | **第二步调用**：锁定刻分后，用此法生成一生运程 | **第一步调用**：生成父母/兄弟候选条文，用于考刻 | **辅助调用**：当一、二冲突时作为裁决 |

---

## 3. 考刻分详细过程 (Calibration Process)

这是系统的**核心业务流程**。通过多轮交互，将时间精度从 2小时 收敛至 1分钟。

### 3.1 流程图设计

```mermaid
graph TD
    A[用户输入八字] --> B{节气边界?}
    B -- Yes --> C[双盘并行]
    B -- No --> D[单盘计算]
    C --> E[基数池生成]
    D --> E
    E --> F[L1: 父母考刻]
    F --> G{用户确认?}
    G -- No --> H[滑动窗口/加减秘数]
    H --> F
    G -- Yes --> I[锁定基数 Base]
    I --> J[L2: 精细校准 (兄弟/伴侣)]
    J --> K[锁定真刻分 True_Ke]
    K --> L[流年推导 (Rollout)]

```

### 3.2 详细考刻步骤

#### **Step 1: 粗筛 (L1 - 父母生肖)**

利用 **算法二 (八卦加则)** 生成的基数，结合 **96刻天干法**。

* **计算**: 。余数对应八刻（初初刻~正三刻）。
* **生成**: 提取对应的父母生肖条文。
* *Code 9003*: "父鼠母马"
* *Code 9144*: "父牛母牛"


* **交互**: 展示 3-5 组最可能的父母组合，让用户选择。
* **容错**: 若用户都选否，进入 Step 1.5。

#### **Step 1.5: 秘数搜索 (Brute Force with Keys)**

若八刻不中，说明基数有偏，应用 **16组质因数加减秘数** 进行全域搜索。

* **秘数序列** (源自 `research tieban2.md`): `[1327, 1543, 5017, 133, 97, 23, 41, 571, 1147, 2237]`。
* **逻辑**:
* 
* 检查  对应的条文是否为“父母/兄弟”类。
* 若是，推送到前端验证。



#### **Step 2: 细筛 (L2 - 兄弟/配偶/先丧)**

锁定父母后，利用 **算法一 (四柱天干)** 的 `+96` 序列进行微调。

* **生成**:
* "兄弟三人，我居长" vs "兄弟二人，我居次"。
* "先丧父" vs "先丧母"。


* **锁定**: 用户确认唯一的六亲事实。此时，**真刻分 (True Ke)** 被锁定。

### 3.3 结果锁定与全盘推演

一旦  和  确定：

1. **起大运**: 每10年一个大运卦。
2. **起流年**: 每年一个流年卦。
3. **映射条文**: 使用 **邵子新编索引 (`tieban3.md`)** 的逻辑，将 `XnGn` 编码映射为具体的 12000 条文 ID。
* *例如*: 23岁 -> 代码 `3001` -> 条文 "韶光明媚"。



---

## 4. 知识库架构 (KB Schema)

为了支持上述算法，数据库必须支持复杂的索引。

### 4.1 表结构：`tieban_strips` (条文表)

* **ID**: `INT` (1 - 12000, 对应书中的条文号)
* **Content**: `TEXT` (条文内容，如"父鼠母马")
* **Type**: `ENUM` (`PARENTS`, `SIBLINGS`, `SPOUSE`, `FORTUNE`, `PERSONALITY`)
* **Logic_Tags**: `JSON` (结构化标签，用于算法反向匹配)
* *Example*: `{"father": "rat", "mother": "horse"}`


* **Shaozi_Index**: `STRING` (关联 `tieban3.md` 的索引，如 `子[1]-1111`)

### 4.2 表结构：`hexagram_values` (八卦加则表)

* **Combo**: `STRING` (e.g., "Kan-Zhen")
* **Value_List**: `ARRAY` (e.g., `[2645, 8387]`)
* **Source**: `STRING` (标记来源流派，如 "PangPangXiong")

---

## 5. API 接口设计 (FastAPI)

```python
# 1. 初始化计算：输入八字，返回考刻题
POST /api/tieban/init_calibration
Input: {
    "birth_time": "1988-08-08 08:30",
    "gender": "male",
    "birth_place": {"lat": 30.5, "lon": 114.3}
}
Output: {
    "session_id": "xyz",
    "base_info": {"bazi": "戊辰 庚申..."},
    "questions": [
        {"type": "PARENTS", "options": ["父鼠母马", "父牛母羊", "其他"]},
        {"type": "SIBLINGS", "options": ["独子", "兄弟二人", "其他"]}
    ]
}

# 2. 提交验证：锁定刻分
POST /api/tieban/verify
Input: {
    "session_id": "xyz",
    "answers": {"PARENTS": "父鼠母马", "SIBLINGS": "兄弟二人"}
}
Output: {
    "status": "LOCKED",
    "verified_ke": "辰时初二刻",
    "base_num": 2521
}

# 3. 生成命书
POST /api/tieban/report
Input: {"session_id": "xyz"}
Output: {
    "timeline": [
        {"age": 23, "year": 2011, "strip_id": 3001, "content": "韶光明媚..."},
        ...
    ]
}

```