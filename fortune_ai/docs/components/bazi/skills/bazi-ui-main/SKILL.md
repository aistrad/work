---
name: bazi-ui-main
description: 基于 docs/bazi/bazi new spec.md 构建与演进全新的 Bazi 前端系统（/main），采用“左侧对话 SSOT + 右侧工作台/Artifacts 阅读模式 + 移动端 Bottom Sheet”的生成式 UI。覆盖提问（Ask on Bazi）、生成八字报告、校准出生时间、铁板神算的统一工作流与灰度上线策略。
version: 0.1.0
---

# Bazi UI Main · SKILL

> 目标：以“对话为真源（SSOT）”为核心，构建双栏工作台前端（/main），把传统排盘升级为“智能咨询顾问”。

## 使用方式（触发）
- 入口命令：`skill bazi-ui-main`
- 适用场景：前端系统重构、问答能力（Ask）、Artifacts 阅读模式、移动端抽屉交互落地、灰度发布。

## 前置条件
- 已存在规范文档：`docs/bazi/bazi new spec.md`（为设计真源）。
- 运行环境：`uvicorn api.main:app --host 0.0.0.0 --port 8230`。
- 不破坏现网：在 `/main` 新路由上灰度；必要时通过根路径或导航引导。

## 执行计划（阶段化）
1) 原型落地（P0 最小可用）
- 新建路由 `/main`（保留 `/bazi2` → 307 跳转）。
- 模板/样式/脚本：`api/templates/main.html`、`/static/ui.css`、`/static/ui.js`。
- 功能：
  - 左侧对话流消息追加（user/bot）。
  - 右侧工作台：生成报告表单、校准表单占位、Tieban 占位；阅读模式（Artifacts）面板骨架。
  - 提问（Ask）按钮：先打通最小链路，占位调用，后续切换到 `/api/bazi/ask`。

2) 提问能力（P1）
- 新增后端 `POST /api/bazi/ask`（或 `/ask/stream`），聚合“同名基本八字 + 最近报告摘要”，返回结构化答案。
- 前端接入：在对话流中渲染“摘要卡片（结论/依据/不确定）”，支持复制。
- 上下文胶囊：在输入框上方常驻姓名/生日/地点，右栏变更未提交时亮起“待应用”。

3) 深度生成与阅读（P2）
- 报告完成后：左侧落“报告摘要卡片”，支持“一键进入阅读模式（右栏）”查看全文；右栏与工作台互斥。
- 断线/续写：SSE 断链自动重连，失败提供“继续生成/从最后一段续写”。

4) 移动端体验（P3）
- Bottom Sheet 抽屉承载工作台；提交后抽屉收起，结果进入对话流。
- 触控适配、键盘弹出与安全区处理。

5) 灰度与回滚（P4）
- 按路径灰度：`/main` → 导航引导；稳定后再考虑 `/` 指向 `/main`。
- 回滚：保留旧页入口 `/bazi` 与 `/tieban`。

## 具体步骤（可执行）
- 路由与模板
  - [x] 新增 `/main` 路由与模板（本技能会创建）。
  - [x] `/bazi2` → 307 跳转至 `/main`（兼容旧链接）。
- 前端结构
  - [x] 左：会话列表 + 对话流 + 输入区。
  - [x] 右：Tabs（报告/校准/铁板/阅读模式），互斥显示。
  - [x] 上下文胶囊（姓名/出生/地点 + 待应用）。
- 对接与数据
  - [ ] `/api/bazi/ask`（待实现）→ 先以占位 API 验证 UI 流程。
  - [x] `/api/v2/submit` 提交生成八字报告。
- 体验与性能
  - [x] 强缓存 + gzip；延迟加载历史/预设。
  - [ ] 报告长文分节流式 + 骨架屏（后续）。

## 风险与缓解
- 长文渲染卡顿 → 分节渲染 + Memo 化组件。
- 上下文膨胀 → 先做“报告本地摘要 300–600 字”，仅携带摘要入模。
- 移动端操作路径长 → 抽屉 + 回填最近一次输入。

## 交付物
- 模板：`api/templates/main.html`
- 静态资源：`api/static/ui.css`、`api/static/ui.js`
- 文档：`docs/bazi/bazi new spec.md`（持续更新）

> 安全提示：本技能仅改动前端模板与静态资源及新增路由，不改动生产数据结构；上线前请在灰度路径 `/main` 完成验证。

