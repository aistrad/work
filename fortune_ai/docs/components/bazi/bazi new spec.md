# Bazi 模块新 UI/交互规范（Draft v0.1 / 2025-12-22）

> 本文仅为“思考结果/设计草案”，先落文档，不改现有代码与后端接口。

## 1. 背景与目标
- 目标：将 Bazi 模块升级为“对话为中心 + 工作台（功能区）”的双栏体验。
- 视觉参考：
  - thepattern（精致纹理/留白、可读性强的中性配色）
  - Co–Star（宇宙/星空元素、柔和对比与简洁网格）
  - Google Gemini（对话入口为主、卡片化工具与历史记录并置）
- 结构目标：
  - 左侧：对话主视图（类 Gemini）+ 历史记录/会话列表。
  - 右侧：功能工作台（生成八字报告、校准出生时间、铁板神算等模块）。
  - 交互遵循“对话优先，工具助攻”，所有结果以消息形式沉淀在左侧对话流。

## 2. 信息架构（IA）
- 顶部导航（可选）：Logo/返回、环境标识、设置入口、用户头像。
- 左栏（主视图，宽度 ≈ 60–66%）：
  - 历史会话区（可折叠）：最近 10–20 条会话，支持搜索/置顶/删除。
  - 对话消息流（主舞台）：
    - 用户消息（问题/意图）。
    - 系统消息（进度/告警/引用来源）。
    - 模块结果卡片（“八字报告摘要”“校准结果”“铁板·命书摘要”等）。
  - 输入区（底部）：
    - 文本框（占位文案：提出你的问题或想生成的分析）。
    - 操作按钮：发送/提问、附加工具菜单（可展开选择具体模块作为上下文）。
- 右栏（功能工作台，宽度 ≈ 34–40%）：
  - 模块卡片列表（互斥展开）：
    1) 生成八字报告（Bazi Report）
    2) 校准出生时间（Rectification）
    3) 铁板神算（Tieban）
    4) 其他（保留未来扩展位）
  - 每个模块卡片内包含：
    - 表单（基础信息、可选项）、
    - 运行状态（轻量）、
    - 主要操作按钮（生成/校准/锁定等）。
  - 模块结果不在右栏长驻，右栏只作为“操作面板”；结构化结果以“卡片消息”的形式落到左侧对话流，确保“对话是唯一真源（SSOT UI）”。
  - 长文“阅读模式（Artifacts）”：当生成深度报告时，左侧放摘要卡，右侧可切换为“阅读面板”以承载全文，提供返回按钮，与操作面板互斥。

## 3. 关键用户旅程（Flows）
- A. 直接对话式提问（Ask on Bazi）
  1) 用户在左侧输入框撰写问题；
  2) 点击“提问”或回车发送；
  3) 系统自动检索：同名用户的“基本八字 + 最近详细报告（若有）”；
  4) 大模型结合上下文深度回答，输出“结论要点 → 依据（八字与报告引用） → 不确定性/建议”。
- B. 生成八字报告（Bazi Report）
  1) 右栏展开“生成八字报告”，填写出生信息/模型/可选系统提示；
  2) 点击“生成”，右栏显示轻量状态，左侧对话流出现“进度消息”；
  3) 完成后在左侧生成“报告卡片”（文本/文档链接/保存路径），并可继续追问。
- C. 校准出生时间（Rectification）
  1) 右栏展开“校准”，填写事件列表与时间窗口；
  2) 进度以 SSE/增量形式在左侧消息中流式呈现；
  3) 生成“校准结果卡片”，可一键采纳并触发后续分析。
- D. 铁板神算（Tieban）
  1) 右栏展开“铁板”，提交事实；
  2) 结果以“命书摘要卡片”形式落到对话流，可点击查看全文与证据。

## 4. 组件与布局规范
- 网格与间距
  - 页面最大宽度 1280–1360px；两栏布局；栏间距 20–24px；卡片内边距 16–20px。
- 颜色（Light 主题示例，结合 thepattern/Co–Star/Gemini 气质）
  - 背景：`#F6F4EF`（温暖中性纸感）
  - 表面/卡片：`#FFFFFF`（投影轻、圆角 16–20）
  - 文字主色：`#1B1A16`（深墨色）
  - 强调色 Primary（对话/按钮）：蓝紫系渐变（Gemini 感）`#5A7BFF → #3F5FFF`
  - 功能金色（沿用 Tieban）：`#C6A15A`（少量用于章标题/强调）
  - 成功/告警/信息：`#1E854A` / `#B76E00` / `#1E4B8B`
  - 暗黑模式：降低对比，使用暖灰与深蓝紫（另行配表）。
- 字体（分平台策略）
  - Windows：正文优先无衬线（微软雅黑/Segoe UI）保证清晰，标题与长文可用衬线；
  - macOS/Android：可用系统衬线（Noto Serif SC/思源宋体）作为首选；
  - 仅在可控网络下加载 Web Font，默认采用系统字体回退。
- 对话消息
  - 用户消息：浅色卡片，右对齐；
  - 系统/助手消息：白底或轻纹理底，左对齐；
  - 结果卡片：有标题/摘要/操作（复制、展开、下载、查看证据）。
- 模块卡片（右栏）
  - 折叠/展开互斥；
  - 表单控件统一高度（40–44px）；
  - 主要按钮用 Primary 渐变；危险/删除用无填充描边按钮。
  - 阅读模式（Artifacts）：右栏进入“全文阅读”时覆盖工作台，提供返回按钮；桌面端最大宽度 720–840px，支持复制/下载。

## 5. “提问”能力（Ask on Bazi）设计
- 入口与语义
  - 左侧输入框右侧新增“提问”按钮；输入内容视为“问题”（与生成报告时作为 system prompt 的语义区隔）。
  - 上下文胶囊：在输入框上方常驻展示当前上下文（姓名/出生/地点）；右栏变更未应用时显示“待应用”提示。
  - 空文本校验与提示：引导填写具体问题。
- 上下文聚合
  - 基本八字：使用左栏已填数据即时计算；若缺失则尝试按姓名在本地档案中回放。
  - 历史报告：从最近一次同名报告中抽取摘要（300–600 字），并保留可展开全文/文档链接。
- 回答结构
  - 第一段：结论要点（3–5 条，直给答案）。
  - 第二段：依据与引用（八字四柱、五行倾向、报告摘要要点，必要时列出处段）。
  - 第三段：不确定性与可验证线索（需要的额外信息、建议的下一步）。
- 失败降级
  - 找不到报告：仅基于八字回答，并显式提示“未找到历史报告”。
  - 找不到八字：提示需要至少“出生日期/时间/地点”以保证回答质量。
- 速率与审计
  - 速率限制：按 IP+name 限制 10 次/分钟（默认值，可调）。
  - 审计落盘：对话问答以 jsonl 追加到 `user/<user_id>/conversations/<session>.jsonl`。
  - 上下文剪枝：仅携带最近摘要 + 本轮意图，报告超长先做 300–600 字离线摘要再回答。

## 6. 性能与可用性
- 首屏优化
  - 强缓存与 gzip/brotli；延迟加载“系统提示预设/历史”；
  - 资源粒度控制（JS 代码分块；右栏各模块按需加载）。
- 网络与并发
  - SSE/分块流用于长任务的进度；
  - 断线恢复与回退：重连提示、“继续生成/从最后一段续写”操作；模块提交使用幂等键。

## 7. 无障碍与国际化
- 键盘无障碍：Tab 次序、跳转锚点、ARIA 标注；
- 文本对比：满足 WCAG AA；
- 多语言：预留中英切换（文案资源文件）。

## 8. API 影子设计（仅文档，不改代码）
- POST `/api/bazi/ask`
  - 入参：`{ name, gender, date, time, tz_offset_hours, longitude?, latitude?, location_name?, question, model? }`
  - 出参：`{ status, answer_md, used_context: { bazi_used, report_used, doc_url?, report_meta? } }`
- SSE `/api/bazi/ask/stream`
  - 事件：`chunk/done/error`，前端流式渲染。

## 9. 响应式与适配
- ≥ 1280px：双栏；
- 1024–1279px：双栏但右栏最小 360px，超出收缩历史侧边；
- < 1024px：默认纯对话；“+”按钮唤起 Bottom Sheet 工作台；提交后收起，结果进入对话流。
- PWA 适配（可选）。

## 10. 上线节奏与回滚
- Phase 1：仅落 UI 骨架与“提问”同步版接口；
- Phase 2：SSE 流式 + 模块结果卡片化输出；
- Phase 3：历史会话管理与检索；
- 回滚策略：保留旧页入口，灰度切流量。

## 11. 风险与未决问题（Open Questions）
- 历史报告体积较大时的上下文截断策略（服务端摘要/分段检索）。
- 同名用户的歧义：是否需要“用户标识（手机号/ID）”来区分？
- 右栏模块并行提交的状态与互斥管理（队列/并发上限）。

---
（本文到此为草案，待确认后再拆分具体实现任务与代码变更。）
