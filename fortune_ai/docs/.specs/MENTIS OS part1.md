MENTIS v3.0 顶层设计文档╔═══════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                                                                                   ║
║    ███╗   ███╗███████╗███╗   ██╗████████╗██╗███████╗    ██╗   ██╗██████╗     ██████╗              ║
║    ████╗ ████║██╔════╝████╗  ██║╚══██╔══╝██║██╔════╝    ██║   ██║╚════██╗   ██╔═████╗             ║
║    ██╔████╔██║█████╗  ██╔██╗ ██║   ██║   ██║███████╗    ██║   ██║ █████╔╝   ██║██╔██║             ║
║    ██║╚██╔╝██║██╔══╝  ██║╚██╗██║   ██║   ██║╚════██║    ╚██╗ ██╔╝ ╚═══██╗   ████╔╝██║             ║
║    ██║ ╚═╝ ██║███████╗██║ ╚████║   ██║   ██║███████║     ╚████╔╝ ██████╔╝██╗╚██████╔╝             ║
║    ╚═╝     ╚═╝╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚═╝╚══════╝      ╚═══╝  ╚═════╝ ╚═╝ ╚═════╝              ║
║                                                                                                   ║
║                            STREAM-CENTRIC AGENTIC ARCHITECTURE                                    ║
║                                                                                                   ║
║                               Decode. Reframe. Evolve.                                            ║
║                         解码命运 · 重塑认知 · 进化人生                                            ║
║                                                                                                   ║
╚═══════════════════════════════════════════════════════════════════════════════════════════════════╝

Document Version: 3.0 (Stream-Centric Agentic Edition)
Author: Silicon Valley Principal Architect
Last Updated: 2026-01-04目录
Executive Summary
产品架构
系统架构
核心功能
数据采集
前端交互
数据模型
API 设计
核心算法
部署架构
演进路线图
1. Executive Summary1.1 产品定位MENTIS v3.0 是一个 Stream-Centric Agentic Personal OS（流核心智能体个人操作系统），将东方玄学洞察与西方行为科学融合，通过主动式 Agent 架构帮助用户实现认知升级和行为进化。┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MENTIS v3.0 POSITIONING                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   传统 Chat Bot          →        MENTIS v3.0 Agent                            │
│   ─────────────────────────────────────────────────────────────                │
│                                                                                 │
│   人找服务 (User → AI)    →        服务找人 (AI → User)                        │
│   填表汇报               →        自然流露                                      │
│   Dashboard 是主战场     →        Dashboard 是背景环境                          │
│   阅后即焚               →        阅后沉淀 → 数字孪生                           │
│   被动问答               →        主动干预 + 情境感知                           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘1.2 核心哲学╔═══════════════════════════════════════════════════════════════════════════════╗
║                         CORE PHILOSOPHY                                        ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   "Life is a Stream, not a Dashboard."                                        ║
║   "生活是一条流，而不是一个仪表盘。"                                           ║
║                                                                               ║
║   Design Goal: Making "Living" the input, and "Evolving" the output.          ║
║   设计目标：让"生活本身"成为输入，让"进化"成为输出。                           ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝1.3 v2.0 → v3.0 核心升级维度v2.0v3.0核心交互Chat + DashboardStream (一切皆流)Dashboard 定位用户主动操作区被动环境感知层 (Ambient HUD)行为记录手动打卡自然语言自动识别反馈机制延迟/批量毫秒级实时同步Agent 模式被动响应主动干预 (Proactive Intervention)数据来源静态 (生辰)Stream + Passive Tracking + Active Input情绪感知无Dynamic Aura System2. 产品架构2.1 三层交互模型 (Three-Layer Interaction Model)╔═══════════════════════════════════════════════════════════════════════════════╗
║                       THREE-LAYER INTERACTION MODEL                            ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────┐ ║
║  │  LAYER 1: THE STREAM (核心交互区)                           90% 时间   │ ║
║  │  ─────────────────────────────────────────────────────────────────────  │ ║
║  │                                                                         │ ║
║  │  • Vibe Diary (碎碎念 / 情绪日记)        ← 最高频入口                  │ ║
║  │  • Action Cards (Agent 主动推送的任务卡)                               │ ║
║  │  • Natural Feedback (自然汇报，非手动打卡)                             │ ║
║  │  • Chat (传统问答，融入流中)                                           │ ║
║  │                                                                         │ ║
║  │  INPUT: 语音 / 图片 / 文字（零摩擦）                                   │ ║
║  │  FEEDBACK: 每次 Input → 立即微反馈（AI Tag / 能量变化 / Aura）         │ ║
║  │                                                                         │ ║
║  └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────┐ ║
║  │  LAYER 2: THE HUD (环境感知区 / Ambient HUD)                被动展示   │ ║
║  │  ─────────────────────────────────────────────────────────────────────  │ ║
║  │                                                                         │ ║
║  │  • Dashboard 不再是独立页面，而是悬浮在 Stream 周围的"环境层"          │ ║
║  │  • 平时隐形，或以 Dynamic Aura (动态背景光晕) 形式存在                 │ ║
║  │  • 只有状态剧烈变化 或 用户主动呼出时才显现                            │ ║
║  │                                                                         │ ║
║  │  表现形式: 背景光晕 / 边缘微光 / 数字浮动 / 粒子效果                   │ ║
║  │                                                                         │ ║
║  └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
║  ┌─────────────────────────────────────────────────────────────────────────┐ ║
║  │  LAYER 3: THE INTERVENTION (主动干预层)                     Agent 灵魂 │ ║
║  │  ─────────────────────────────────────────────────────────────────────  │ ║
║  │                                                                         │ ║
║  │  • Agent 不等待用户提问，主动在 Stream 中插入 Action Cards             │ ║
║  │  • 基于 Stream 内容 + L1 模块数据 + 时间节点，智能触发                 │ ║
║  │  • 卡片可交互，完成后自动记录                                          │ ║
║  │                                                                         │ ║
║  │  触发条件: 时间节点 / 情绪阈值 / 能量变化 / 行为模式 / 运势窗口        │ ║
║  │                                                                         │ ║
║  └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝2.2 产品功能矩阵┌─────────────────────────────────────────────────────────────────────────────────┐
│                           PRODUCT FEATURE MATRIX                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                        ┌───────────────────────────────────────┐               │
│                        │          MENTIS v3.0 OS               │               │
│                        │     Stream-Centric Architecture       │               │
│                        └───────────────────────────────────────┘               │
│                                        │                                        │
│        ┌───────────────┬───────────────┼───────────────┬───────────────┐       │
│        │               │               │               │               │       │
│        ▼               ▼               ▼               ▼               ▼       │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐     │
│   │  STREAM │    │  DECODE │    │ REFRAME │    │  EVOLVE │    │ REFLECT │     │
│   │  INPUT  │    │  MODULE │    │  MODULE │    │  MODULE │    │  MODULE │     │
│   ├─────────┤    ├─────────┤    ├─────────┤    ├─────────┤    ├─────────┤     │
│   │Vibe Diary│   │ BaZi    │    │ CBT     │    │ Habit   │    │ Weekly  │     │
│   │Voice    │    │ ZiWei   │    │ ACT     │    │ If-Then │    │ Mirror  │     │
│   │Photo    │    │ MBTI    │    │ NLP     │    │Momentum │    │ Insight │     │
│   │Text     │    │ Jung    │    │ Reword  │    │ Streak  │    │ Pattern │     │
│   └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘2.3 用户旅程 (User Journey)╔═══════════════════════════════════════════════════════════════════════════════╗
║                           USER JOURNEY MAP                                     ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   STAGE 1: LANDING (落地页体验)                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║   输入生辰 → 快速命盘洞察 → "共鸣时刻" → 注册转化                            ║
║                                                                               ║
║   STAGE 2: ONBOARDING (入门校准)                                              ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║   Mirror Test (30秒校准游戏) → 生成初始 Digital Twin → 设置基础偏好           ║
║                                                                               ║
║   STAGE 3: DAILY STREAM (日常使用)                                            ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────┐    ║
║   │  MORNING                                                            │    ║
║   │  ──────────                                                         │    ║
║   │  Agent 推送: 🌅 今日运势 + 能量预测 + 早间微习惯                     │    ║
║   │  用户输入: "昨晚睡得不太好" → 自动识别 → 调整建议                   │    ║
║   └─────────────────────────────────────────────────────────────────────┘    ║
║                                  │                                            ║
║                                  ▼                                            ║
║   ┌─────────────────────────────────────────────────────────────────────┐    ║
║   │  THROUGHOUT DAY                                                     │    ║
║   │  ─────────────                                                      │    ║
║   │  用户发 Vibe Diary: "开会被老板骂了，心情很差"                       │    ║
║   │  → 情绪识别: Anger -3                                               │    ║
║   │  → Aura 变红                                                        │    ║
║   │  → Agent 插入 Action Card: [3分钟呼吸法]                            │    ║
║   │  → 用户完成 → 能量回升 → Aura 变蓝                                  │    ║
║   └─────────────────────────────────────────────────────────────────────┘    ║
║                                  │                                            ║
║                                  ▼                                            ║
║   ┌─────────────────────────────────────────────────────────────────────┐    ║
║   │  EVENING                                                            │    ║
║   │  ───────                                                            │    ║
║   │  Agent 推送: 📊 今日回顾 + 模式洞察 + 明日建议                       │    ║
║   │  用户输入: "今天还是控制住情绪了" → 自动打卡 +2                      │    ║
║   └─────────────────────────────────────────────────────────────────────┘    ║
║                                                                               ║
║   STAGE 4: WEEKLY REFLECTION (周期复盘)                                       ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║   Weekly Mirror Report → 模式识别 → 下周策略调整 → 解锁深度报告              ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝3. 系统架构3.1 全局系统架构图╔═══════════════════════════════════════════════════════════════════════════════════════════════════╗
║                                MENTIS v3.0 SYSTEM ARCHITECTURE                                     ║
║                                Stream-Centric Agentic Platform                                     ║
╠═══════════════════════════════════════════════════════════════════════════════════════════════════╣
║                                                                                                   ║
║  ┌─────────────────────────────────────────────────────────────────────────────────────────────┐ ║
║  │                                    🌐 CLIENT LAYER                                          │ ║
║  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │ ║
║  │  │   iOS App       │  │   Android App   │  │   Web App       │  │   WeChat Mini   │        │ ║
║  │  │   (React Native)│  │   (React Native)│  │   (Next.js)     │  │   (Taro)        │        │ ║
║  │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘        │ ║
║  │           └────────────────────┴────────────────────┴────────────────────┘                  │ ║
║  └───────────────────────────────────────────┬─────────────────────────────────────────────────┘ ║
║                                              │                                                    ║
║                                              │ HTTPS / WebSocket                                  ║
║                                              ▼                                                    ║
║  ┌───────────────────────────────────────────────────────────────────────────────────────────┐   ║
║  │                                   🚪 API GATEWAY                                          │   ║
║  │                          (Vercel Edge / Cloudflare Workers)                               │   ║
║  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │   ║
║  │  │ Rate Limit  │  │   Auth      │  │   Routing   │  │   CORS      │  │   Logging   │     │   ║
║  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘     │   ║
║  └────────────────────────────────────────┬──────────────────────────────────────────────────┘   ║
║                                           │                                                       ║
║                                           ▼                                                       ║
║  ┌───────────────────────────────────────────────────────────────────────────────────────────┐   ║
║  │                              🧠 AGENT RUNTIME LAYER                                        │   ║
║  │                              (Next.js API Routes + Vercel AI SDK)                          │   ║
║  │                                                                                           │   ║
║  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐│   ║
║  │   │                           STREAM PROCESSOR                                          ││   ║
║  │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                ││   ║
║  │   │  │ STT Engine  │→ │ NLP Extract │→ │ Emotion Det │→ │ Action Match│                ││   ║
║  │   │  │ (Whisper)   │  │ (GPT-4)     │  │ (Custom)    │  │ (Embedding) │                ││   ║
║  │   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                ││   ║
║  │   └─────────────────────────────────────────────────────────────────────────────────────┘│   ║
║  │                                                                                           │   ║
║  │   ┌─────────────────────────────────────────────────────────────────────────────────────┐│   ║
║  │   │                           ORCHESTRATOR                                              ││   ║
║  │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                ││   ║
║  │   │  │Intent Class │  │Module Router│  │Context Build│  │A2UI Format  │                ││   ║
║  │   │  │意图分类器   │  │模块路由器   │  │上下文构建器 │  │输出格式化   │                ││   ║
║  │   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘                ││   ║
║  │   └─────────────────────────────────────────────────────────────────────────────────────┘│   ║
║  └────────────────────────────────────────┬──────────────────────────────────────────────────┘   ║
║                                           │                                                       ║
║                    ┌──────────────────────┼──────────────────────┐                               ║
║                    │                      │                      │                               ║
║                    ▼                      ▼                      ▼                               ║
║  ┌─────────────────────────┐ ┌─────────────────────────┐ ┌─────────────────────────┐            ║
║  │    🔮 DECODE LAYER      │ │    🧩 REFRAME LAYER     │ │    🎯 EVOLVE LAYER      │            ║
║  │    (Plug & Play)        │ │    (认知重塑)           │ │    (行为进化)           │            ║
║  │  ┌───────────────────┐  │ │  ┌───────────────────┐  │ │  ┌───────────────────┐  │            ║
║  │  │ Module: BaZi      │  │ │  │ Module: CBT       │  │ │  │ Module: Habit     │  │            ║
║  │  │ Module: ZiWei     │  │ │  │ Module: ACT       │  │ │  │ Module: If-Then   │  │            ║
║  │  │ Module: MBTI      │  │ │  │ Module: NLP-Rw    │  │ │  │ Module: Momentum  │  │            ║
║  │  │ Module: Jung      │  │ │  │ Module: Stoic     │  │ │  │ Module: Streak    │  │            ║
║  │  └───────────────────┘  │ │  └───────────────────┘  │ │  └───────────────────┘  │            ║
║  └─────────────────────────┘ └─────────────────────────┘ └─────────────────────────┘            ║
║                                           │                                                       ║
║                                           ▼                                                       ║
║  ┌───────────────────────────────────────────────────────────────────────────────────────────┐   ║
║  │                                   💾 DATA LAYER                                            │   ║
║  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │   ║
║  │  │  PostgreSQL     │  │  Redis          │  │  Pinecone       │  │  R2/S3          │       │   ║
║  │  │  (Primary DB)   │  │  (Session/Cache)│  │  (Vector Store) │  │  (Media Store)  │       │   ║
║  │  │  ─────────────  │  │  ─────────────  │  │  ─────────────  │  │  ─────────────  │       │   ║
║  │  │  User Data      │  │  Real-time State│  │  Embeddings     │  │  Voice/Image    │       │   ║
║  │  │  Stream Data    │  │  Emotion Score  │  │  Knowledge Base │  │  Attachments    │       │   ║
║  │  │  Module Data    │  │  Agent Queue    │  │  Behavior Match │  │  Reports        │       │   ║
║  │  └─────────────────┘  └─────────────────┘  └─────────────────┘  └─────────────────┘       │   ║
║  └───────────────────────────────────────────────────────────────────────────────────────────┘   ║
║                                                                                                   ║
╚═══════════════════════════════════════════════════════════════════════════════════════════════════╝3.2 Agent Runtime 详细架构╔═══════════════════════════════════════════════════════════════════════════════╗
║                           AGENT RUNTIME ARCHITECTURE                           ║
║                           (Vercel AI SDK 4.0 + Multi-Step)                     ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   POST /api/stream                                                            ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │  streamText({                                                           │║
║   │    model: selectModel(userTier),     // GLM-4.5 / Claude / GPT-4       │║
║   │    system: await buildContext(userId), // L0 + L1 + Biography + Current│║
║   │    messages: conversationHistory,                                       │║
║   │    tools: {                                                             │║
║   │      ...getDecodeTools(userId),      // 动态加载已激活的 DECODE 模块   │║
║   │      ...getReframeTools(userId),     // CBT / ACT / NLP 重构工具       │║
║   │      ...getEvolveTools(userId),      // 习惯 / 动量 / 打卡工具         │║
║   │      ...getSystemTools(),            // 系统级工具                      │║
║   │    },                                                                   │║
║   │    maxSteps: 5,                      // Multi-step reasoning           │║
║   │    onStepFinish: handleStepCallback, // 每步回调                       │║
║   │  })                                                                     │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                        TOOL DEFINITIONS                                 │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  // DECODE TOOLS                                                        │║
║   │  bazi_calculate: (birthTime) => BaZiChart                              │║
║   │  ziwei_calculate: (birthTime) => ZiWeiChart                            │║
║   │  fortune_today: (userId) => DailyFortune                               │║
║   │  mbti_assess: (answers) => MBTIProfile                                 │║
║   │                                                                         │║
║   │  // REFRAME TOOLS                                                       │║
║   │  cbt_identify: (thought) => CognitiveDistortion[]                      │║
║   │  reword_negative: (sentence) => PositiveReframe                        │║
║   │  act_exercise: (situation) => AcceptanceExercise                       │║
║   │                                                                         │║
║   │  // EVOLVE TOOLS                                                        │║
║   │  habit_suggest: (context) => MicroHabit[]                              │║
║   │  checkin_auto: (behavior) => CheckinResult                             │║
║   │  momentum_update: (action) => MomentumDelta                            │║
║   │  ifthen_create: (trigger, action) => IfThenPlan                        │║
║   │                                                                         │║
║   │  // SYSTEM TOOLS                                                        │║
║   │  user_state_update: (delta) => UserState                               │║
║   │  notification_push: (content) => void                                  │║
║   │  insight_generate: (data) => Insight                                   │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝3.3 实时同步架构 (Real-time Sync)╔═══════════════════════════════════════════════════════════════════════════════╗
║                        REAL-TIME SYNC ARCHITECTURE                             ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║                         ┌─────────────────┐                                   ║
║                         │   USER INPUT    │                                   ║
║                         │  (Voice/Text)   │                                   ║
║                         └────────┬────────┘                                   ║
║                                  │                                            ║
║                                  ▼                                            ║
║  ┌───────────────────────────────────────────────────────────────────────┐   ║
║  │                        STREAM PROCESSOR                               │   ║
║  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │   ║
║  │  │ Whisper STT │→ │ NLP Extract │→ │ Emotion Det │→ │ Action Match│  │   ║
║  │  │ <500ms      │  │ <200ms      │  │ <100ms      │  │ <100ms      │  │   ║
║  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘  │   ║
║  └───────────────────────────────────────────────────────────────────────┘   ║
║                                  │                                            ║
║                    ┌─────────────┼─────────────┐                             ║
║                    │             │             │                              ║
║                    ▼             ▼             ▼                              ║
║  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐     ║
║  │  UPDATE: Stream DB  │ │  UPDATE: User State │ │  TRIGGER: Agent     │     ║
║  │  (Append new entry) │ │  (Emotion, Energy)  │ │  (If threshold met) │     ║
║  │  PostgreSQL Write   │ │  Redis Update       │ │  Agent Queue Push   │     ║
║  └──────────┬──────────┘ └──────────┬──────────┘ └──────────┬──────────┘     ║
║             │                       │                       │                 ║
║             └───────────────────────┼───────────────────────┘                 ║
║                                     │                                         ║
║                                     ▼                                         ║
║                    ┌────────────────────────────────┐                         ║
║                    │       WEBSOCKET BROADCAST      │                         ║
║                    │  (毫秒级同步到所有客户端)      │                         ║
║                    │  Pusher / Socket.io / Ably     │                         ║
║                    └────────────────────────────────┘                         ║
║                                     │                                         ║
║                    ┌────────────────┼────────────────┐                       ║
║                    │                │                │                        ║
║                    ▼                ▼                ▼                        ║
║             ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                  ║
║             │ Stream Card │ │ Aura Change │ │ Score Update│                  ║
║             │ (New entry) │ │ (Background)│ │ (Top bar)   │                  ║
║             └─────────────┘ └─────────────┘ └─────────────┘                  ║
║                                                                               ║
║  ─────────────────────────────────────────────────────────────────────────   ║
║  关键指标:                                                                    ║
║  • 输入到反馈: < 1000ms (P95)                                                ║
║  • 情绪识别: < 300ms (P95)                                                   ║
║  • UI 更新: < 100ms (P95)                                                    ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝3.4 模块化插件架构╔═══════════════════════════════════════════════════════════════════════════════╗
║                        MODULAR PLUGIN ARCHITECTURE                             ║
║                        (Standard Module Interface)                             ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   interface MentisModule {                                                    ║
║     // 元数据                                                                 ║
║     meta: {                                                                   ║
║       id: string;                    // 唯一标识 'module_bazi'              ║
║       name: string;                  // 显示名称 '八字命理'                  ║
║       tier: 'free' | 'pro' | 'premium';  // 订阅等级                        ║
║       category: 'decode' | 'reframe' | 'evolve';  // 所属层                 ║
║     };                                                                        ║
║                                                                               ║
║     // 知识库                                                                 ║
║     knowledge_base: {                                                         ║
║       vector_namespace: string;      // Pinecone namespace                   ║
║       rules: Rule[];                 // 确定性规则                           ║
║     };                                                                        ║
║                                                                               ║
║     // 工具定义                                                               ║
║     tools: ToolDefinition[];         // 可被 Agent 调用的能力                ║
║                                                                               ║
║     // 上下文输出                                                             ║
║     context_output: (userId: string) => Promise<ContextFragment>;            ║
║   }                                                                           ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   // 示例: BaZi 模块                                                          ║
║   const BaZiModule: MentisModule = {                                          ║
║     meta: {                                                                   ║
║       id: 'module_bazi',                                                      ║
║       name: '八字命理',                                                       ║
║       tier: 'free',                                                           ║
║       category: 'decode',                                                     ║
║     },                                                                        ║
║     knowledge_base: {                                                         ║
║       vector_namespace: 'bazi_knowledge',                                     ║
║       rules: baziCalculationRules,                                            ║
║     },                                                                        ║
║     tools: [                                                                  ║
║       {                                                                       ║
║         name: 'bazi_calculate',                                               ║
║         description: '根据生辰计算八字命盘',                                  ║
║         parameters: { birthTime: 'ISO8601' },                                ║
║         execute: async (params) => calculateBaZi(params.birthTime),          ║
║       },                                                                      ║
║       {                                                                       ║
║         name: 'bazi_fortune_today',                                           ║
║         description: '获取今日运势',                                          ║
║         parameters: { userId: 'string' },                                    ║
║         execute: async (params) => getTodayFortune(params.userId),           ║
║       },                                                                      ║
║     ],                                                                        ║
║     context_output: async (userId) => ({                                      ║
║       type: 'bazi',                                                           ║
║       data: await getBaZiSnapshot(userId),                                    ║
║     }),                                                                       ║
║   };                                                                          ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝4. 核心功能4.1 Vibe Diary (情绪日记)╔═══════════════════════════════════════════════════════════════════════════════╗
║                           VIBE DIARY SYSTEM                                    ║
║                           (最高频交互入口)                                     ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   核心理念: 用户不需要"记录"，只需要"表达"，系统负责理解和沉淀                ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                         INPUT MODES                                     │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  🎙️ VOICE (最低摩擦)                                                    │║
║   │  ──────────────────────────────────────────────────────────────────    │║
║   │  长按录音 → Whisper STT → NLP 理解 → 结构化存储                        │║
║   │  优势: 开车/做饭/走路时都能用                                          │║
║   │                                                                         │║
║   │  📝 TEXT (精确表达)                                                     │║
║   │  ──────────────────────────────────────────────────────────────────    │║
║   │  自由文本输入 → NLP 理解 → 结构化存储                                  │║
║   │                                                                         │║
║   │  📷 PHOTO (场景捕捉)                                                    │║
║   │  ──────────────────────────────────────────────────────────────────    │║
║   │  拍照 + 可选文字 → Vision API 理解 → 结构化存储                        │║
║   │  场景: 美食/运动/工作环境/心情照片                                     │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                       AUTOMATIC EXTRACTION                              │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  用户输入: "刚才开会真的气死我了，老板简直不可理喻"                     │║
║   │                                                                         │║
║   │  系统提取:                                                              │║
║   │  ├─ 情绪: Anger (愤怒)                                                 │║
║   │  ├─ 强度: 8/10                                                         │║
║   │  ├─ 场景: Work (工作)                                                  │║
║   │  ├─ 对象: Boss (上级)                                                  │║
║   │  ├─ 触发: Meeting (会议)                                               │║
║   │  └─ 能量变化: -3                                                       │║
║   │                                                                         │║
║   │  自动标签: #Work #Anger #Boss                                          │║
║   │  即时反馈: Aura 变红 + 能量条下降动画                                  │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝4.2 Action Cards (行动卡片)╔═══════════════════════════════════════════════════════════════════════════════╗
║                           ACTION CARDS SYSTEM                                  ║
║                           (Agent 主动干预载体)                                 ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   TYPE 1: 建议执行卡 (Suggestion Card)                                        ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║   ┌─────────────────────────────────────────────────────────────────────┐    ║
║   │ 🧘 建议: 3分钟呼吸法                                                │    ║
║   │ "检测到情绪波动，建议做个简短的呼吸练习"                            │    ║
║   │                                                                     │    ║
║   │ [ ▶ 开始 ]  [ ⏭ 稍后 ]  [ ✗ 跳过 ]                                  │    ║
║   │                                                                     │    ║
║   │ ████████████░░░░░░░░ 长按完成                                       │    ║
║   └─────────────────────────────────────────────────────────────────────┘    ║
║   交互: 长按充能 → 进度条填满 → 自动完成 → 动量 +1                           ║
║                                                                               ║
║   TYPE 2: 确认反馈卡 (Confirmation Card)                                      ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║   ┌─────────────────────────────────────────────────────────────────────┐    ║
║   │ ✓ 识别到行为                                                        │    ║
║   │ "你刚才说'静下心来冥想了一会儿'，是完成了冥想任务吗？"              │    ║
║   │                                                                     │    ║
║   │ [ ✓ 是的 ]  [ ✗ 不是 ]  [ 🔔 设置提醒 ]                             │    ║
║   └─────────────────────────────────────────────────────────────────────┘    ║
║   选择"是的": 自动打卡 + 动量 +1 + Aura 变亮                                 ║
║                                                                               ║
║   TYPE 3: 洞察分享卡 (Insight Card)                                           ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║   ┌─────────────────────────────────────────────────────────────────────┐    ║
║   │ 💡 模式发现                                                         │    ║
║   │ "我注意到你连续3个周二下午情绪都会崩溃。"                           │    ║
║   │ "这和周二的会议有关吗？"                                            │    ║
║   │                                                                     │    ║
║   │ [ 🔍 深入分析 ]  [ ✓ 确实如此 ]  [ ✗ 不太相关 ]                     │    ║
║   └─────────────────────────────────────────────────────────────────────┘    ║
║   选择"确实如此": 更新用户画像 + 下周二提前干预                              ║
║                                                                               ║
║   TYPE 4: 里程碑庆祝卡 (Milestone Card)                                       ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║   ┌─────────────────────────────────────────────────────────────────────┐    ║
║   │ 🎉 连续 7 天！                                                      │    ║
║   │ "你已经连续7天完成微习惯了！"                                       │    ║
║   │ "根据研究，21天可以形成习惯。继续加油！"                            │    ║
║   │                                                                     │    ║
║   │ [ 🔓 解锁: 本周深度报告 ]                                           │    ║
║   │ [ 📤 分享成就 ]                                                     │    ║
║   └─────────────────────────────────────────────────────────────────────┘    ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝4.3 Dynamic Aura System (动态光环系统)╔═══════════════════════════════════════════════════════════════════════════════╗
║                           DYNAMIC AURA SYSTEM                                  ║
║                           (情绪可视化 + 环境感知)                              ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                         AURA STATES                                     │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  🔵 CALM (平静)       →  蓝色渐变 + 缓慢粒子上升                       │║
║   │     Energy: 60-80                                                       │║
║   │     Background: linear-gradient(135deg, #1a1a2e, #2d3561)              │║
║   │                                                                         │║
║   │  🔴 ALERT (警觉)      →  红色脉冲 + 快速粒子                           │║
║   │     Energy: < 30 OR Anger detected                                      │║
║   │     Background: linear-gradient(135deg, #2e1a1a, #613535)              │║
║   │                                                                         │║
║   │  🟡 HAPPY (愉悦)      →  金色光晕 + 弹跳粒子                           │║
║   │     Energy: > 80 AND Joy detected                                       │║
║   │     Background: linear-gradient(135deg, #2e2a1a, #61553d)              │║
║   │                                                                         │║
║   │  🟣 ANXIOUS (焦虑)    →  紫色波动 + 不规则粒子                         │║
║   │     Energy: < 50 AND Anxiety detected                                   │║
║   │     Background: linear-gradient(135deg, #1a1a2e, #3d2d61)              │║
║   │                                                                         │║
║   │  🟢 FLOW (心流)       →  绿色稳定 + 聚焦光芒                           │║
║   │     Energy: > 70 AND Focus detected                                     │║
║   │     Background: linear-gradient(135deg, #1a2e1a, #2d6135)              │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                         AURA COMPONENTS                                 │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  Layer 1: Base Gradient (基础渐变)                                      │║
║   │  ─────────────────────────────────────────────────────────────────     │║
║   │  position: fixed; inset: 0; transition: 2s ease;                       │║
║   │                                                                         │║
║   │  Layer 2: Glow Orbs (光晕球体)                                          │║
║   │  ─────────────────────────────────────────────────────────────────     │║
║   │  3个绝对定位的模糊圆形，filter: blur(100px);                           │║
║   │  animation: float 8s ease-in-out infinite;                             │║
║   │                                                                         │║
║   │  Layer 3: Particles (粒子效果)                                          │║
║   │  ─────────────────────────────────────────────────────────────────     │║
║   │  15个上升的小圆点，opacity 渐变消失                                    │║
║   │  animation: rise 6s ease-in infinite;                                  │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                         TRANSITION LOGIC                                │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  const getAuraState = (emotion: Emotion, energy: number): AuraState => {│║
║   │    if (emotion === 'anger' || energy < 30) return 'alert';             │║
║   │    if (emotion === 'joy' && energy > 80) return 'happy';               │║
║   │    if (emotion === 'anxiety') return 'anxious';                        │║
║   │    if (emotion === 'focus' && energy > 70) return 'flow';              │║
║   │    return 'calm';                                                       │║
║   │  };                                                                     │║
║   │                                                                         │║
║   │  // 状态变化时触发 2 秒渐变动画                                         │║
║   │  // 用户每次输入后检测是否需要状态转换                                  │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝4.4 自然语言行为识别 (NLU Action Recognition)╔═══════════════════════════════════════════════════════════════════════════════╗
║                        NLU ACTION RECOGNITION                                  ║
║                        (自然语言 → 自动打卡)                                   ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   用户 Vibe Diary 输入          →    系统识别                →    自动动作    ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   "刚才静下心来冥想了一会儿"    →    冥想行为                →    打卡 +1     ║
║   "喝了杯水"                    →    补水行为                →    打卡 +1     ║
║   "忍住没发火"                  →    情绪控制成功            →    打卡 +2     ║
║   "今天早睡了"                  →    作息改善                →    打卡 +1     ║
║   "出去走了走"                  →    运动行为                →    打卡 +1     ║
║   "写了两页日记"                →    反思行为                →    打卡 +1     ║
║   "没有冲动消费"                →    财务自控                →    打卡 +2     ║
║   "主动道歉了"                  →    关系修复                →    打卡 +3     ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   实现架构:                                                                    ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                                                                         │║
║   │   User Input                                                            │║
║   │      │                                                                  │║
║   │      ▼                                                                  │║
║   │   ┌─────────────────┐                                                   │║
║   │   │ Text Embedding  │  OpenAI text-embedding-3-small                   │║
║   │   │ (用户输入向量化)│                                                   │║
║   │   └────────┬────────┘                                                   │║
║   │            │                                                            │║
║   │            ▼                                                            │║
║   │   ┌─────────────────┐    ┌─────────────────┐                           │║
║   │   │ Vector Search   │ ←─ │ Behavior Library │  预定义行为向量库        │║
║   │   │ (相似度匹配)    │    │ (冥想/运动/...)  │                           │║
║   │   └────────┬────────┘    └─────────────────┘                           │║
║   │            │                                                            │║
║   │            ▼                                                            │║
║   │   ┌─────────────────┐                                                   │║
║   │   │ Pending Tasks   │  如果有待完成任务，优先匹配该任务                │║
║   │   │ (任务上下文)    │                                                   │║
║   │   └────────┬────────┘                                                   │║
║   │            │                                                            │║
║   │            ▼                                                            │║
║   │   ┌─────────────────┐                                                   │║
║   │   │ Confidence Check│  相似度 > 0.85 → 自动确认                        │║
║   │   │ (置信度检查)    │  相似度 0.6-0.85 → 弹出确认卡片                   │║
║   │   └────────┬────────┘  相似度 < 0.6 → 忽略                             │║
║   │            │                                                            │║
║   │            ▼                                                            │║
║   │   ┌─────────────────┐                                                   │║
║   │   │ Auto Checkin    │  更新数据库 + 发送 WebSocket 通知                │║
║   │   │ (自动打卡)      │                                                   │║
║   │   └─────────────────┘                                                   │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝5. 数据采集5.1 数据采集架构╔═══════════════════════════════════════════════════════════════════════════════╗
║                        DATA COLLECTION ARCHITECTURE                            ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                        ACTIVE INPUT (主动输入)                           │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  🎙️ Voice Stream          语音输入 → Whisper STT → 文本                │║
║   │  ⌨️ Text Input            自由文本输入                                  │║
║   │  📷 Photo + Caption       图片 + 可选描述 → Vision API                  │║
║   │  📍 Location Share        位置共享 (可选)                               │║
║   │  🎯 Quick Mood            一键情绪选择 (5个表情)                        │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                        PASSIVE TRACKING (被动追踪)                       │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  ⏰ Time Patterns          App 使用时间、频率                           │║
║   │  📱 Device Sensors         屏幕亮度、步数 (需授权)                      │║
║   │  🌙 Sleep Inference        入睡/起床时间推断                            │║
║   │  📅 Calendar Integration   日历事件 (需授权)                            │║
║   │  🔔 Notification Response  通知响应时间                                 │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                        STATIC DATA (静态数据)                            │║
║   ├─────────────────────────────────────────────────────────────────────────┤║
║   │                                                                         │║
║   │  🎂 Birth Information      生辰八字 (一次性输入)                        │║
║   │  📝 Onboarding Survey      入门问卷 (Mirror Test)                       │║
║   │  ⚙️ Preferences            偏好设置                                     │║
║   │  🔗 Third-party Links      第三方账号关联                               │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝5.2 数据 ETL 流水线╔═══════════════════════════════════════════════════════════════════════════════╗
║                           ETL PIPELINE                                         ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐║
║   │                                                                         │║
║   │   Raw Input                                                             │║
║   │      │                                                                  │║
║   │      ├──────────────────────────────────────────────────────────────   │║
║   │      │                                                                  │║
║   │      │  EXTRACT (提取)                                                  │║
║   │      │  ─────────────────────────────────────────────────────────────  │║
║   │      ▼                                                                  │║
║   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │║
║   │   │   Whisper   │  │  GPT-4 NLP  │  │Vision Model│  │  Embedding  │   │║
║   │   │   (STT)     │  │  (Entity)   │  │  (Image)   │  │  (Vector)   │   │║
║   │   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │║
║   │          └─────────────────┴─────────────────┴─────────────────┘        │║
║   │                                  │                                      │║
║   │      ├──────────────────────────────────────────────────────────────   │║
║   │      │                                                                  │║
║   │      │  TRANSFORM (转换)                                                │║
║   │      │  ─────────────────────────────────────────────────────────────  │║
║   │      ▼                                                                  │║
║   │   ┌───────────────────────────────────────────────────────────────────┐│║
║   │   │  Structured Output Schema                                         ││║
║   │   │                                                                   ││║
║   │   │  {                                                                ││║
║   │   │    "raw_text": "刚才开会真的气死我了",                            ││║
║   │   │    "emotion": {                                                   ││║
║   │   │      "primary": "anger",                                          ││║
║   │   │      "intensity": 8,                                              ││║
║   │   │      "secondary": ["frustration", "helplessness"]                 ││║
║   │   │    },                                                             ││║
║   │   │    "context": {                                                   ││║
║   │   │      "scene": "work",                                             ││║
║   │   │      "trigger": "meeting",                                        ││║
║   │   │      "target": "boss"                                             ││║
║   │   │    },                                                             ││║
║   │   │    "energy_delta": -3,                                            ││║
║   │   │    "behavior_match": null,                                        ││║
║   │   │    "tags": ["#Work", "#Anger", "#Boss"],                          ││║
║   │   │    "embedding": [0.123, -0.456, ...]                              ││║
║   │   │  }                                                                ││║
║   │   │                                                                   ││║
║   │   └───────────────────────────────────────────────────────────────────┘│║
║   │                                  │                                      │║
║   │      ├──────────────────────────────────────────────────────────────   │║
║   │      │                                                                  │║
║   │      │  LOAD (加载)                                                     │║
║   │      │  ─────────────────────────────────────────────────────────────  │║
║   │      ▼                                                                  │║
║   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │║
║   │   │ PostgreSQL  │  │   Redis     │  │  Pinecone   │  │  R2/S3      │   │║
║   │   │ (Stream DB) │  │ (State)     │  │ (Vectors)   │  │ (Media)     │   │║
║   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │║
║   │                                                                         │║
║   └─────────────────────────────────────────────────────────────────────────┘║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝6. 前端交互6.1 响应式布局设计╔═══════════════════════════════════════════════════════════════════════════════╗
║                        RESPONSIVE LAYOUT DESIGN                                ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   MOBILE (<1024px): Full-Screen Stream                                        ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌───────────────────────────────────────────────────────────────────────┐  ║
║   │  [Top Status Bar]  🔥 72 动量  |  🌊 Day 7  |  ⚙️                      │  ║
║   ├───────────────────────────────────────────────────────────────────────┤  ║
║   │                                                                       │  ║
║   │  ┌─────────────────────────────────────────────────────────────────┐ │  ║
║   │  │ 🤖 MENTIS (Agent Card)                                          │ │  ║
║   │  │ "早上好！今天水星逆行进入尾声..."                                │ │  ║
║   │  │                                                                 │ │  ║
║   │  │ [ 🧘 3分钟呼吸法 ]  ← 可交互卡片                                │ │  ║
║   │  │ ████████░░░░░░░░ 长按完成                                       │ │  ║
║   │  └─────────────────────────────────────────────────────────────────┘ │  ║
║   │                                                                       │  ║
║   │  ┌─────────────────────────────────────────────────────────────────┐ │  ║
║   │  │ 👤 You (5 min ago)                              [VIBE DIARY]    │ │  ║
║   │  │ "刚才开会真的气死我了，老板简直不可理喻..."                     │ │  ║
║   │  │                                                                 │ │  ║
║   │  │ 🏷️ #Work #Anger  |  🔥 能量 -3                                 │ │  ║
║   │  └─────────────────────────────────────────────────────────────────┘ │  ║
║   │                                                                       │  ║
║   │  ┌─────────────────────────────────────────────────────────────────┐ │  ║
║   │  │ 👤 You (30 min ago)                             [VIBE DIARY]    │ │  ║
║   │  │ "静下心来写了会儿代码，效率还不错"                              │ │  ║
║   │  │                                                                 │ │  ║
║   │  │ 🏷️ #Work #Flow  |  ✨ 能量 +2                                  │ │  ║
║   │  │ └─ 🤖 AI 识别: 这是你本周第3次进入心流状态                     │ │  ║
║   │  └─────────────────────────────────────────────────────────────────┘ │  ║
║   │                                                                       │  ║
║   │                         ... more cards ...                            │  ║
║   │                                                                       │  ║
║   ├───────────────────────────────────────────────────────────────────────┤  ║
║   │  [Magic Input]                                                        │  ║
║   │  ┌─────────────────────────────────────────────────────────────────┐ │  ║
║   │  │  🎙️ (长按说话)   📷   |   有什么想告诉我的...                  │ │  ║
║   │  └─────────────────────────────────────────────────────────────────┘ │  ║
║   └───────────────────────────────────────────────────────────────────────┘  ║
║                                                                               ║
║   DESKTOP (≥1024px): Three-Column Layout                                      ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌────────────────┬─────────────────────────────┬────────────────────────┐  ║
║   │                │                             │                        │  ║
║   │  CONTEXT       │         STREAM              │      INSIGHT           │  ║
║   │  (左侧栏)      │         (中间主区)          │      (右侧栏)          │  ║
║   │                │                             │                        │  ║
║   │  ┌──────────┐  │                             │  ┌──────────────────┐  │  ║
║   │  │ 🔥 动量   │  │    [Stream Content]        │  │ 💡 今日洞察       │  │  ║
║   │  │ 72/100   │  │                             │  │                  │  │  ║
║   │  │ ████████ │  │                             │  │ "你本周的情绪   │  │  ║
║   │  └──────────┘  │                             │  │  波动主要集中   │  │  ║
║   │                │                             │  │  在工作场景..." │  │  ║
║   │  ┌──────────┐  │                             │  │                  │  │  ║
║   │  │ 📊 本周   │  │                             │  │ [ 深入分析 ]    │  │  ║
║   │  │ 能量趋势  │  │                             │  └──────────────────┘  │  ║
║   │  │   ╭──╮   │  │                             │                        │  ║
║   │  │ ╭─╯  ╰─ │  │                             │  ┌──────────────────┐  │  ║
║   │  └──────────┘  │                             │  │ 🎯 待完成任务    │  │  ║
║   │                │                             │  │                  │  │  ║
║   │  ┌──────────┐  │                             │  │ ☐ 冥想 3分钟    │  │  ║
║   │  │ 🌙 今日   │  │                             │  │ ☐ 补水 8杯     │  │  ║
║   │  │ 运势指数  │  │                             │  │ ✓ 早起         │  │  ║
║   │  │ ⭐⭐⭐⭐☆  │  │                             │  └──────────────────┘  │  ║
║   │  └──────────┘  │                             │                        │  ║
║   │                │                             │                        │  ║
║   └────────────────┴─────────────────────────────┴────────────────────────┘  ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝6.2 核心组件架构typescript// 前端组件架构 (React/Next.js)

interface ComponentArchitecture {
  
  // ════════════════════════════════════════════════════════════════════════
  // STREAM 核心组件
  // ════════════════════════════════════════════════════════════════════════
  
  StreamInput: {
    modes: ['voice', 'text', 'photo'];
    features: ['streaming_render', 'auto_tag', 'emotion_detect'];
    position: 'fixed_bottom';
    props: {
      onSend: (content: InputContent) => void;
      isRecording: boolean;
      placeholder: string;
    };
  };
  
  StreamCard: {
    types: ['vibe_diary', 'action_card', 'system_log', 'insight'];
    interactions: ['long_press', 'swipe_right', 'swipe_up'];
    animations: ['particle_burst', 'glow_pulse', 'slide_in'];
    props: {
      data: StreamEntry;
      onActionComplete: (id: string) => void;
      onSwipe: (direction: 'left' | 'right') => void;
    };
  };
  
  StreamContainer: {
    features: ['infinite_scroll', 'pull_to_refresh', 'optimistic_update'];
    props: {
      entries: StreamEntry[];
      isLoading: boolean;
      hasMore: boolean;
      onLoadMore: () => void;
    };
  };
  
  // ════════════════════════════════════════════════════════════════════════
  // HUD 环境组件
  // ════════════════════════════════════════════════════════════════════════
  
  DynamicAura: {
    states: ['calm', 'alert', 'happy', 'anxious', 'flow'];
    layers: ['base_gradient', 'glow_orbs', 'particles'];
    transitions: 'smooth_2s_ease';
    props: {
      mood: AuraState;
      energyScore: number;
    };
  };
  
  TopStatusBar: {
    displays: ['momentum_score', 'streak_count', 'settings_icon'];
    props: {
      momentum: number;
      streak: number;
      onSettingsClick: () => void;
    };
  };
  
  ContextPanel: {
    widgets: ['momentum_bar', 'weekly_trend', 'fortune_index'];
    visibility: 'desktop_only';
    props: {
      data: ContextData;
    };
  };
  
  InsightPanel: {
    types: ['daily_insight', 'pattern_detection', 'task_list'];
    trigger: 'agent_push';
    position: 'sidebar_right';
    props: {
      insights: Insight[];
      tasks: Task[];
    };
  };
  
  // ════════════════════════════════════════════════════════════════════════
  // ACTION 交互组件
  // ════════════════════════════════════════════════════════════════════════
  
  ActionCard: {
    variants: ['suggestion', 'confirmation', 'insight', 'milestone'];
    interactions: {
      long_press: 'progress_fill_complete';
      tap_button: 'instant_action';
      swipe_away: 'dismiss';
    };
    props: {
      type: ActionCardType;
      content: ActionContent;
      onComplete: () => void;
      onDismiss: () => void;
    };
  };
  
  ProgressHoldButton: {
    animation: 'circular_progress_fill';
    duration: 3000; // ms
    haptic_feedback: true;
    props: {
      onComplete: () => void;
      label: string;
    };
  };
}6.3 交互状态机╔═══════════════════════════════════════════════════════════════════════════════╗
║                        INTERACTION STATE MACHINE                               ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   STREAM INPUT STATE MACHINE                                                  ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────┐  tap_mic   ┌───────────┐  release   ┌────────────┐             ║
║   │  IDLE   │ ─────────→ │ RECORDING │ ─────────→ │ PROCESSING │             ║
║   └─────────┘            └───────────┘            └─────┬──────┘             ║
║        ↑                      │                         │                     ║
║        │                      │ cancel                  │ complete            ║
║        │                      ▼                         ▼                     ║
║        │                 ┌─────────┐              ┌─────────┐                 ║
║        └─────────────────│ CANCEL  │              │ SUCCESS │                 ║
║                          └─────────┘              └─────────┘                 ║
║                                                                               ║
║   ACTION CARD STATE MACHINE                                                   ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────┐  long_press_start  ┌───────────┐  progress_100%  ┌──────────┐  ║
║   │ PENDING │ ─────────────────→ │ FILLING   │ ──────────────→ │ COMPLETE │  ║
║   └─────────┘                    └───────────┘                 └──────────┘  ║
║        │                              │                                       ║
║        │ swipe_dismiss               │ release_early                          ║
║        ▼                              ▼                                       ║
║   ┌─────────┐                   ┌───────────┐                                ║
║   │DISMISSED│                   │  RESET    │ → back to PENDING              ║
║   └─────────┘                   └───────────┘                                ║
║                                                                               ║
║   AURA STATE MACHINE                                                          ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────┐                                                                 ║
║   │  CALM   │ ←────────────────────────────────────────┐                     ║
║   └────┬────┘                                          │                     ║
║        │ anger_detected                                │ energy > 60          ║
║        ▼                                               │                     ║
║   ┌─────────┐  energy_recovery   ┌───────────┐        │                     ║
║   │  ALERT  │ ─────────────────→ │ RECOVERING│ ───────┘                     ║
║   └─────────┘                    └───────────┘                               ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝

7. 数据模型7.1 核心实体关系图 (ERD)╔═══════════════════════════════════════════════════════════════════════════════╗
║                           ENTITY RELATIONSHIP DIAGRAM                          ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║                           ┌───────────────────┐                               ║
║                           │   mentis_user     │                               ║
║                           │   ═══════════════ │                               ║
║                           │   PK: id (UUID)   │                               ║
║                           │   email           │                               ║
║                           │   name            │                               ║
║                           │   tier            │                               ║
║                           │   created_at      │                               ║
║                           └─────────┬─────────┘                               ║
║                                     │                                         ║
║           ┌─────────────────────────┼─────────────────────────┐               ║
║           │                         │                         │               ║
║           ▼                         ▼                         ▼               ║
║   ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐      ║
║   │   user_profile    │   │   stream_entry    │   │   user_state      │      ║
║   │   ═══════════════ │   │   ═══════════════ │   │   ═══════════════ │      ║
║   │   PK: id          │   │   PK: id          │   │   PK: user_id     │      ║
║   │   FK: user_id     │   │   FK: user_id     │   │   energy_score    │      ║
║   │   birth_time      │   │   type            │   │   momentum        │      ║
║   │   birth_location  │   │   raw_content     │   │   streak_days     │      ║
║   │   bazi_data (JSON)│   │   emotion (JSON)  │   │   current_mood    │      ║
║   │   mbti_type       │   │   context (JSON)  │   │   aura_state      │      ║
║   │   preferences     │   │   tags[]          │   │   last_active     │      ║
║   └───────────────────┘   │   energy_delta    │   │   updated_at      │      ║
║                           │   embedding       │   └───────────────────┘      ║
║                           │   created_at      │                               ║
║                           └─────────┬─────────┘                               ║
║                                     │                                         ║
║           ┌─────────────────────────┼─────────────────────────┐               ║
║           │                         │                         │               ║
║           ▼                         ▼                         ▼               ║
║   ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐      ║
║   │   action_task     │   │   checkin_log     │   │   insight_record  │      ║
║   │   ═══════════════ │   │   ═══════════════ │   │   ═══════════════ │      ║
║   │   PK: id          │   │   PK: id          │   │   PK: id          │      ║
║   │   FK: user_id     │   │   FK: user_id     │   │   FK: user_id     │      ║
║   │   type            │   │   FK: task_id     │   │   type            │      ║
║   │   title           │   │   FK: stream_id   │   │   title           │      ║
║   │   description     │   │   source          │   │   content         │      ║
║   │   status          │   │   momentum_delta  │   │   data (JSON)     │      ║
║   │   trigger_time    │   │   created_at      │   │   read_at         │      ║
║   │   expires_at      │   └───────────────────┘   │   created_at      │      ║
║   │   created_at      │                           └───────────────────┘      ║
║   └───────────────────┘                                                       ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌───────────────────┐   ┌───────────────────┐   ┌───────────────────┐      ║
║   │  conversation     │   │  module_config    │   │  fortune_daily    │      ║
║   │  ═══════════════  │   │  ═══════════════  │   │  ═══════════════  │      ║
║   │  PK: id           │   │  PK: id           │   │  PK: id           │      ║
║   │  FK: user_id      │   │  FK: user_id      │   │  FK: user_id      │      ║
║   │  title            │   │  module_id        │   │  date             │      ║
║   │  mode             │   │  is_enabled       │   │  fortune_score    │      ║
║   │  messages (JSON)  │   │  settings (JSON)  │   │  analysis (JSON)  │      ║
║   │  created_at       │   │  updated_at       │   │  suggestions[]    │      ║
║   │  updated_at       │   └───────────────────┘   │  created_at       │      ║
║   └───────────────────┘                           └───────────────────┘      ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝7.2 核心表定义 (PostgreSQL DDL)sql-- ═══════════════════════════════════════════════════════════════════════════
-- MENTIS v3.0 DATABASE SCHEMA
-- PostgreSQL 15+ with JSONB support
-- ═══════════════════════════════════════════════════════════════════════════

-- 枚举类型
CREATE TYPE user_tier AS ENUM ('free', 'pro', 'premium');
CREATE TYPE stream_type AS ENUM ('vibe_diary', 'action_card', 'chat', 'system');
CREATE TYPE task_status AS ENUM ('pending', 'in_progress', 'completed', 'dismissed');
CREATE TYPE checkin_source AS ENUM ('manual', 'auto_nlu', 'action_card');
CREATE TYPE aura_state AS ENUM ('calm', 'alert', 'happy', 'anxious', 'flow');

-- ═══════════════════════════════════════════════════════════════════════════
-- 用户核心表
-- ═══════════════════════════════════════════════════════════════════════════

CREATE TABLE mentis_user (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100),
    avatar_url TEXT,
    tier user_tier DEFAULT 'free',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE user_profile (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE UNIQUE,
    
    -- 生辰信息
    birth_time TIMESTAMPTZ,
    birth_location JSONB,  -- {city, lat, lng, timezone}
    
    -- 命理数据
    bazi_data JSONB,       -- 八字计算结果缓存
    ziwei_data JSONB,      -- 紫微斗数结果缓存
    
    -- 心理测评
    mbti_type VARCHAR(4),
    mbti_raw_scores JSONB,
    jung_profile JSONB,
    
    -- 用户偏好
    preferences JSONB DEFAULT '{}',
    notification_settings JSONB DEFAULT '{}',
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE user_state (
    user_id UUID PRIMARY KEY REFERENCES mentis_user(id) ON DELETE CASCADE,
    
    -- 实时状态
    energy_score INTEGER DEFAULT 50 CHECK (energy_score >= 0 AND energy_score <= 100),
    momentum INTEGER DEFAULT 0,
    streak_days INTEGER DEFAULT 0,
    
    -- 当前情绪
    current_mood VARCHAR(50),
    mood_intensity INTEGER CHECK (mood_intensity >= 1 AND mood_intensity <= 10),
    aura_state aura_state DEFAULT 'calm',
    
    -- 时间戳
    last_active_at TIMESTAMPTZ DEFAULT NOW(),
    last_checkin_at TIMESTAMPTZ,
    streak_updated_at DATE,
    
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ═══════════════════════════════════════════════════════════════════════════
-- Stream 数据表
-- ═══════════════════════════════════════════════════════════════════════════

CREATE TABLE stream_entry (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE,
    
    -- 内容
    type stream_type NOT NULL,
    raw_content TEXT NOT NULL,
    media_urls TEXT[],
    
    -- 情绪提取
    emotion JSONB,  -- {primary, intensity, secondary[]}
    
    -- 上下文提取
    context JSONB,  -- {scene, trigger, target, time_of_day}
    
    -- 标签与分类
    tags TEXT[],
    
    -- 能量影响
    energy_delta INTEGER DEFAULT 0,
    
    -- 向量嵌入 (存储在 Pinecone，这里存引用)
    embedding_id VARCHAR(100),
    
    -- 行为匹配
    matched_behavior VARCHAR(100),
    matched_confidence FLOAT,
    
    -- 元数据
    source VARCHAR(50) DEFAULT 'app',  -- app, api, import
    client_metadata JSONB,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- 索引
    CONSTRAINT stream_entry_emotion_check CHECK (
        emotion IS NULL OR (
            emotion ? 'primary' AND
            emotion ? 'intensity'
        )
    )
);

CREATE INDEX idx_stream_user_created ON stream_entry(user_id, created_at DESC);
CREATE INDEX idx_stream_type ON stream_entry(type);
CREATE INDEX idx_stream_tags ON stream_entry USING GIN(tags);
CREATE INDEX idx_stream_emotion ON stream_entry USING GIN(emotion);

-- ═══════════════════════════════════════════════════════════════════════════
-- 任务与打卡表
-- ═══════════════════════════════════════════════════════════════════════════

CREATE TABLE action_task (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE,
    
    -- 任务内容
    type VARCHAR(50) NOT NULL,  -- meditation, hydration, exercise, custom
    title VARCHAR(200) NOT NULL,
    description TEXT,
    
    -- 状态
    status task_status DEFAULT 'pending',
    
    -- 时间控制
    trigger_time TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    
    -- 来源
    source VARCHAR(50) DEFAULT 'agent',  -- agent, user, schedule
    trigger_context JSONB,
    
    -- 奖励
    momentum_reward INTEGER DEFAULT 1,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_task_user_status ON action_task(user_id, status);
CREATE INDEX idx_task_trigger_time ON action_task(trigger_time);

CREATE TABLE checkin_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE,
    
    -- 关联
    task_id UUID REFERENCES action_task(id) ON DELETE SET NULL,
    stream_id UUID REFERENCES stream_entry(id) ON DELETE SET NULL,
    
    -- 打卡信息
    behavior_type VARCHAR(100) NOT NULL,
    source checkin_source NOT NULL,
    
    -- 影响
    momentum_delta INTEGER DEFAULT 1,
    
    -- 备注
    note TEXT,
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_checkin_user_created ON checkin_log(user_id, created_at DESC);

-- ═══════════════════════════════════════════════════════════════════════════
-- 洞察与报告表
-- ═══════════════════════════════════════════════════════════════════════════

CREATE TABLE insight_record (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE,
    
    -- 洞察内容
    type VARCHAR(50) NOT NULL,  -- pattern, daily, weekly, milestone
    title VARCHAR(200),
    content TEXT NOT NULL,
    
    -- 结构化数据
    data JSONB,
    
    -- 来源
    source_module VARCHAR(50),
    confidence FLOAT,
    
    -- 阅读状态
    is_read BOOLEAN DEFAULT FALSE,
    read_at TIMESTAMPTZ,
    
    -- 用户反馈
    user_feedback VARCHAR(20),  -- helpful, not_helpful, dismiss
    
    created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_insight_user_type ON insight_record(user_id, type);
CREATE INDEX idx_insight_unread ON insight_record(user_id, is_read) WHERE is_read = FALSE;

-- ═══════════════════════════════════════════════════════════════════════════
-- 运势与模块配置表
-- ═══════════════════════════════════════════════════════════════════════════

CREATE TABLE fortune_daily (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    
    -- 运势数据
    fortune_score INTEGER CHECK (fortune_score >= 1 AND fortune_score <= 100),
    fortune_level VARCHAR(20),  -- excellent, good, normal, caution, difficult
    
    -- 详细分析
    analysis JSONB,  -- {overall, career, relationship, health, wealth}
    
    -- 建议
    suggestions TEXT[],
    avoid_items TEXT[],
    lucky_items JSONB,
    
    -- 缓存控制
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, date)
);

CREATE INDEX idx_fortune_user_date ON fortune_daily(user_id, date DESC);

CREATE TABLE module_config (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE,
    module_id VARCHAR(50) NOT NULL,
    
    -- 状态
    is_enabled BOOLEAN DEFAULT TRUE,
    
    -- 模块特定设置
    settings JSONB DEFAULT '{}',
    
    -- 使用统计
    last_used_at TIMESTAMPTZ,
    usage_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(user_id, module_id)
);

-- ═══════════════════════════════════════════════════════════════════════════
-- 对话历史表
-- ═══════════════════════════════════════════════════════════════════════════

CREATE TABLE conversation (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES mentis_user(id) ON DELETE CASCADE,
    
    -- 会话信息
    title TEXT,
    mode VARCHAR(20) DEFAULT 'chat',  -- chat, command, stream
    
    -- 消息历史 (JSONB数组，适合中等长度对话)
    messages JSONB DEFAULT '[]',
    
    -- 摘要 (用于长对话压缩)
    summary TEXT,
    
    -- 元数据
    message_count INTEGER DEFAULT 0,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_conversation_user ON conversation(user_id, updated_at DESC);

-- ═══════════════════════════════════════════════════════════════════════════
-- 触发器: 自动更新 updated_at
-- ═══════════════════════════════════════════════════════════════════════════

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_mentis_user_updated_at
    BEFORE UPDATE ON mentis_user
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_profile_updated_at
    BEFORE UPDATE ON user_profile
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_user_state_updated_at
    BEFORE UPDATE ON user_state
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_action_task_updated_at
    BEFORE UPDATE ON action_task
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_module_config_updated_at
    BEFORE UPDATE ON module_config
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_conversation_updated_at
    BEFORE UPDATE ON conversation
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();7.3 Redis 数据结构╔═══════════════════════════════════════════════════════════════════════════════╗
║                           REDIS DATA STRUCTURES                                ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   REAL-TIME USER STATE                                                        ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   Key: user:state:{user_id}                                                   ║
║   Type: HASH                                                                  ║
║   TTL: 24 hours (refresh on activity)                                         ║
║                                                                               ║
║   Fields:                                                                     ║
║   ├─ energy_score: "72"                                                       ║
║   ├─ momentum: "15"                                                           ║
║   ├─ streak_days: "7"                                                         ║
║   ├─ current_mood: "calm"                                                     ║
║   ├─ mood_intensity: "5"                                                      ║
║   ├─ aura_state: "calm"                                                       ║
║   └─ last_active: "2026-01-04T10:30:00Z"                                     ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   AGENT TASK QUEUE                                                            ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   Key: agent:queue:{user_id}                                                  ║
║   Type: SORTED SET (score = trigger_timestamp)                                ║
║   TTL: None (managed by agent worker)                                         ║
║                                                                               ║
║   Members:                                                                    ║
║   ├─ {task_id}:{action_type} @ score: 1704365400                             ║
║   └─ {task_id}:{action_type} @ score: 1704368000                             ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   SESSION CACHE                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   Key: session:{session_id}                                                   ║
║   Type: STRING (JSON)                                                         ║
║   TTL: 7 days                                                                 ║
║                                                                               ║
║   Value: {                                                                    ║
║     "user_id": "uuid",                                                        ║
║     "created_at": "2026-01-04T08:00:00Z",                                     ║
║     "device_info": {...},                                                     ║
║     "permissions": ["basic", "stream", "decode"]                              ║
║   }                                                                           ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   RATE LIMITING                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   Key: rate:{user_id}:{action}                                                ║
║   Type: STRING (counter)                                                      ║
║   TTL: Window duration (e.g., 60s for per-minute limits)                      ║
║                                                                               ║
║   Actions: stream_input, fortune_query, ai_chat                               ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   WEBSOCKET CHANNELS                                                          ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   Pub/Sub Channel: user:{user_id}:updates                                     ║
║                                                                               ║
║   Message Types:                                                              ║
║   ├─ stream_new: 新 Stream 条目                                               ║
║   ├─ state_update: 用户状态变化                                               ║
║   ├─ aura_change: Aura 状态变化                                               ║
║   ├─ task_push: 新任务推送                                                    ║
║   └─ insight_ready: 洞察生成完成                                              ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝