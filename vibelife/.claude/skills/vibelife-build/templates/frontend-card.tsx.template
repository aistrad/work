/**
 * {{CARD_NAME}}Card - {{CARD_DESC_CN}}
 * æ–‡ä»¶ä½ç½®: apps/web/src/skills/{{SKILL_ID}}/cards/{{CARD_NAME}}Card.tsx
 *
 * ä» handlers.py çš„ show_{{CARD_TYPE}} å·¥å…·è§¦å‘
 * é€šè¿‡ CardRegistry æ³¨å†Œï¼Œç”± card_type: "{{CARD_TYPE}}" è§¦å‘
 */

"use client";

import { useState, useRef } from "react";
import { useRouter } from "next/navigation";
import { History, Share2, Image as ImageIcon, Link2 } from "lucide-react";
import { registerCard } from "@/skills/CardRegistry";
import { useImageShare } from "@/hooks/useImageShare";

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Types - åŒæ—¶æ”¯æŒ camelCase å’Œ snake_case
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

interface {{CARD_NAME}}Data {
  userId?: string;
  // è¾“å…¥ä¿¡æ¯ - æ”¯æŒä¸¤ç§å‘½åæ ¼å¼
  inputInfo?: { {{PARAM_1}}?: string; {{PARAM_2}}?: string };
  input_info?: { {{PARAM_1}}?: string; {{PARAM_2}}?: string };
  // ä¸»è¦ç»“æœ - æ”¯æŒä¸¤ç§å‘½åæ ¼å¼
  {{RESULT_FIELD_1_CAMEL}}?: string;
  {{RESULT_FIELD_1}}?: string;
  {{RESULT_FIELD_2_CAMEL}}?: string;
  {{RESULT_FIELD_2}}?: string;
  // å…¶ä»–å­—æ®µ...
}

interface {{CARD_NAME}}CardProps {
  data: {{CARD_NAME}}Data;
  cardProps?: Record<string, unknown>;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Constants - æ˜ å°„è¡¨é›†ä¸­å®šä¹‰ï¼Œæ”¯æŒå¤šç§æ ¼å¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ç¤ºä¾‹ï¼šç±»å‹ä¸­æ–‡åæ˜ å°„ï¼ˆæ”¯æŒå„ç§æ ¼å¼ï¼‰
const TYPE_CN: Record<string, string> = {
  type_a: "ç±»å‹A", TypeA: "ç±»å‹A", ç±»å‹A: "ç±»å‹A",
  type_b: "ç±»å‹B", TypeB: "ç±»å‹B", ç±»å‹B: "ç±»å‹B",
  // æ·»åŠ æ›´å¤šæ˜ å°„...
};

// ç¤ºä¾‹ï¼šæ ·å¼æ˜ å°„
const TYPE_STYLES: Record<string, { bg: string; text: string; border: string }> = {
  type_a: {
    bg: "bg-blue-50 dark:bg-blue-900/20",
    text: "text-blue-700 dark:text-blue-300",
    border: "border-blue-100 dark:border-blue-900/50",
  },
  type_b: {
    bg: "bg-green-50 dark:bg-green-900/20",
    text: "text-green-700 dark:text-green-300",
    border: "border-green-100 dark:border-green-900/50",
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getTypeCN(type: string): string {
  return TYPE_CN[type] || TYPE_CN[type.toLowerCase()] || type;
}

function getTypeStyle(type: string): { bg: string; text: string; border: string } {
  const normalizedType = type.toLowerCase().replace(/\s+/g, "_");
  return TYPE_STYLES[normalizedType] || TYPE_STYLES.type_a;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Component
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function {{CARD_NAME}}Card({ data }: {{CARD_NAME}}CardProps) {
  const [expanded, setExpanded] = useState<string | null>(null);
  const [showShareMenu, setShowShareMenu] = useState(false);
  const router = useRouter();
  const cardRef = useRef<HTMLDivElement>(null);
  const { openScreenshotMode, captureElement, downloadImage, state: imageState } = useImageShare();

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // æ•°æ®å…¼å®¹å¤„ç† - åŒæ—¶æ”¯æŒ camelCase å’Œ snake_case
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const inputInfo = data.inputInfo || data.input_info || {};
  const result1 = data.{{RESULT_FIELD_1_CAMEL}} || data.{{RESULT_FIELD_1}} || "";
  const result2 = data.{{RESULT_FIELD_2_CAMEL}} || data.{{RESULT_FIELD_2}} || "";

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Handlers
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  const handleImageShare = async () => {
    if (!cardRef.current) return;

    const blob = await captureElement(cardRef.current);
    if (blob) {
      downloadImage(blob, `{{SKILL_ID}}_${new Date().toISOString().slice(0, 10)}.png`);
    } else {
      openScreenshotMode(cardRef.current);
    }
    setShowShareMenu(false);
  };

  const handleLinkShare = async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert("é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼");
    } catch {
      alert("å¤åˆ¶é“¾æ¥å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶æµè§ˆå™¨åœ°å€æ ä¸­çš„é“¾æ¥");
    }
    setShowShareMenu(false);
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Render
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  return (
    <div
      ref={cardRef}
      className="{{SKILL_ID}}-card bg-gradient-to-br from-{{PRIMARY_COLOR}}-50/80 to-{{SECONDARY_COLOR}}-50/60 dark:from-{{PRIMARY_COLOR}}-950/20 dark:to-{{SECONDARY_COLOR}}-950/20 rounded-2xl border border-{{PRIMARY_COLOR}}-100 dark:border-{{PRIMARY_COLOR}}-900/50 p-5 my-2 overflow-hidden animate-fade-in shadow-[var(--shadow-card)]"
    >
      {/* Header */}
      <div className="flex items-center justify-between mb-4">
        <h3 className="text-lg font-semibold text-text-primary flex items-center gap-2">
          <span>{{ICON_EMOJI}}</span>
          <span>{{CARD_TITLE}}</span>
        </h3>
        <span className="text-sm text-text-secondary">
          {inputInfo.{{PARAM_1}} || ""}
        </span>
      </div>

      {/* Main Content */}
      <div className="grid grid-cols-2 gap-3 mb-4">
        <div className="text-center p-3 bg-white/60 dark:bg-black/30 rounded-lg">
          <div className="text-xs text-muted-foreground mb-1">ç»“æœ1</div>
          <div className="text-lg font-medium">{result1}</div>
        </div>
        <div className="text-center p-3 bg-white/60 dark:bg-black/30 rounded-lg">
          <div className="text-xs text-muted-foreground mb-1">ç»“æœ2</div>
          <div className="text-lg font-medium">{result2}</div>
        </div>
      </div>

      {/* Details Section */}
      <div className="bg-white/40 dark:bg-black/20 rounded-lg p-3 mb-3">
        <div className="text-sm font-medium mb-2">è¯¦ç»†ä¿¡æ¯</div>
        <div className="space-y-1">
          {/* å¯å±•å¼€çš„è¯¦ç»†å†…å®¹ */}
          <div
            onClick={() => setExpanded(expanded ? null : "details")}
            className={`flex items-center justify-between p-2 rounded-xl cursor-pointer transition-all ${
              expanded === "details"
                ? "bg-{{PRIMARY_COLOR}}-100/80 dark:bg-{{PRIMARY_COLOR}}-900/20"
                : "hover:bg-white/60 dark:hover:bg-black/30"
            }`}
          >
            <span className="text-sm">ç‚¹å‡»å±•å¼€è¯¦æƒ…</span>
            <span className="text-muted-foreground">{expanded ? "â–²" : "â–¼"}</span>
          </div>

          {expanded === "details" && (
            <div className="pl-4 pr-2 py-2 text-xs text-muted-foreground animate-fade-in">
              <div className="font-medium mb-1">æ›´å¤šä¿¡æ¯ï¼š</div>
              <div>è¾“å…¥å‚æ•°1: {inputInfo.{{PARAM_1}}}</div>
              <div>è¾“å…¥å‚æ•°2: {inputInfo.{{PARAM_2}}}</div>
            </div>
          )}
        </div>
      </div>

      {/* Hint */}
      <div className="mt-3 text-xs text-center text-muted-foreground">
        ğŸ’¡ {{HINT_TEXT}}
      </div>

      {/* Action Buttons */}
      <div className="mt-4 pt-3 border-t border-{{PRIMARY_COLOR}}-100 dark:border-{{PRIMARY_COLOR}}-900/30 flex items-center justify-center gap-4">
        <button
          onClick={() => router.push("/{{SKILL_ID}}/history")}
          className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-[var(--accent-primary)] hover:bg-{{PRIMARY_COLOR}}-100 dark:hover:bg-{{PRIMARY_COLOR}}-900/20 rounded-xl transition-colors"
        >
          <History className="w-4 h-4" />
          <span>æŸ¥çœ‹å†å²</span>
        </button>

        {/* Share Dropdown */}
        <div className="relative">
          <button
            onClick={() => setShowShareMenu(!showShareMenu)}
            className="flex items-center gap-1.5 px-3 py-1.5 text-sm text-[var(--accent-primary)] hover:bg-{{PRIMARY_COLOR}}-100 dark:hover:bg-{{PRIMARY_COLOR}}-900/20 rounded-xl transition-colors"
          >
            <Share2 className="w-4 h-4" />
            <span>åˆ†äº«</span>
          </button>

          {showShareMenu && (
            <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-40 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-{{PRIMARY_COLOR}}-100 dark:border-{{PRIMARY_COLOR}}-900/50 overflow-hidden z-10 animate-fade-in">
              <button
                onClick={handleLinkShare}
                className="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-{{PRIMARY_COLOR}}-50 dark:hover:bg-{{PRIMARY_COLOR}}-900/20 transition-colors"
              >
                <Link2 className="w-4 h-4" />
                <span>å¤åˆ¶é“¾æ¥</span>
              </button>
              <button
                onClick={handleImageShare}
                disabled={imageState.isGenerating}
                className="w-full flex items-center gap-2 px-3 py-2 text-sm hover:bg-{{PRIMARY_COLOR}}-50 dark:hover:bg-{{PRIMARY_COLOR}}-900/20 transition-colors disabled:opacity-50"
              >
                <ImageIcon className="w-4 h-4" />
                <span>{imageState.isGenerating ? "ç”Ÿæˆä¸­â€¦" : "ä¿å­˜å›¾ç‰‡"}</span>
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Register to CardRegistry
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

registerCard("{{CARD_TYPE}}", {{CARD_NAME}}Card);

export default {{CARD_NAME}}Card;
