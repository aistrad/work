"""
{{SKILL_NAME}} Tool Handlers - {{SKILL_NAME_CN}}工具执行器
文件位置: apps/api/skills/{{SKILL_ID}}/tools/handlers.py

使用 @tool_handler 装饰器注册，自动被 ToolRegistry 发现。
"""

import logging
from datetime import datetime
from typing import Dict, Any, List, Optional

from services.agent.tool_registry import tool_handler, ToolContext

logger = logging.getLogger(__name__)


# ═══════════════════════════════════════════════════════════════════════════
# 计算工具 (Compute Tools)
# ═══════════════════════════════════════════════════════════════════════════

@tool_handler("{{COMPUTE_TOOL}}")
async def execute_{{COMPUTE_TOOL}}(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """
    {{COMPUTE_DESCRIPTION}} - SOP P2 阶段核心工具

    这是 SOP P2 阶段的核心工具，负责：
    1. 从 args 或 profile 获取必要信息
    2. 调用计算服务
    3. 返回计算结果供后续分析使用
    """
    from services.agent.tool_registry import ToolRegistry
    # from skills.{{SKILL_ID}}.services import {{SERVICE_FUNCTION}}

    # ═══════════════════════════════════════════════════════════════════════
    # 1. 数据获取优先级链：args → profile → skill_data → default
    # ═══════════════════════════════════════════════════════════════════════
    profile = context.profile or {}
    identity = profile.get("identity", {})
    stored_info = identity.get("{{INFO_KEY}}", {})

    # 优先使用 args 中的参数，否则从 profile 读取
    {{PARAM_1}} = args.get("{{PARAM_1}}") or stored_info.get("{{PARAM_1}}")
    {{PARAM_2}} = args.get("{{PARAM_2}}") or stored_info.get("{{PARAM_2}}", "{{PARAM_2_DEFAULT}}")

    # ═══════════════════════════════════════════════════════════════════════
    # 2. 前置检查 - 快速失败
    # ═══════════════════════════════════════════════════════════════════════
    if not {{PARAM_1}}:
        return {
            "status": "error",
            "error": "需要{{PARAM_1_DESC}}才能计算",
            "action": "collect_{{SKILL_ID}}_info"
        }

    try:
        # 检查用户是否已有存储的信息
        user_has_info = bool(stored_info.get("{{PARAM_1}}"))

        # ═══════════════════════════════════════════════════════════════════
        # 3. 调用计算服务
        # ═══════════════════════════════════════════════════════════════════
        # result = {{SERVICE_FUNCTION}}(
        #     {{PARAM_1}}={{PARAM_1}},
        #     {{PARAM_2}}={{PARAM_2}},
        # )

        # TODO: 替换为实际计算逻辑
        result = {
            "{{RESULT_FIELD_1}}": "计算结果1",
            "{{RESULT_FIELD_2}}": "计算结果2",
        }

        logger.info(f"Calculated {{SKILL_ID}} for user {context.user_id}: {result}")

        # ═══════════════════════════════════════════════════════════════════
        # 4. 构建卡片数据 - 数据自包含原则
        # ═══════════════════════════════════════════════════════════════════
        card_data = {
            "userId": context.user_id,
            "inputInfo": {
                "{{PARAM_1}}": {{PARAM_1}},
                "{{PARAM_2}}": {{PARAM_2}},
            },
            # 主要结果 - 同时提供 camelCase 和 snake_case
            "{{RESULT_FIELD_1_CAMEL}}": result.get("{{RESULT_FIELD_1}}"),
            "{{RESULT_FIELD_1}}": result.get("{{RESULT_FIELD_1}}"),
            "{{RESULT_FIELD_2_CAMEL}}": result.get("{{RESULT_FIELD_2}}"),
            "{{RESULT_FIELD_2}}": result.get("{{RESULT_FIELD_2}}"),
            # 完整 result 数据供后续使用
            "_result": result,
        }

        # ═══════════════════════════════════════════════════════════════════
        # 5. _hint 内部通信 - 引导 AI 下一步动作
        # ═══════════════════════════════════════════════════════════════════
        if not user_has_info and context.user_id and context.user_id != "guest":
            card_data["_hint"] = {
                "action": "ask_save_info",
                "message": "用户尚未保存信息。请询问用户是否将此信息保存为个人档案，方便下次使用。",
                "info_to_save": {
                    "{{PARAM_1}}": {{PARAM_1}},
                    "{{PARAM_2}}": {{PARAM_2}},
                }
            }

        # ═══════════════════════════════════════════════════════════════════
        # 6. 展示卡片 - 统一委托 show_card
        # ═══════════════════════════════════════════════════════════════════
        return await ToolRegistry.execute(
            "show_card",
            {
                "card_type": "custom",
                "data_source": {"type": "inline", "data": card_data},
                "options": {"componentId": "{{CARD_TYPE_MAIN}}"}
            },
            context
        )

    except Exception as e:
        logger.error(f"{{COMPUTE_TOOL}} failed: {e}")
        return {
            "status": "error",
            "error": f"计算失败: {str(e)}",
        }


# ═══════════════════════════════════════════════════════════════════════════
# 收集工具 (Collect Tools)
# ═══════════════════════════════════════════════════════════════════════════

@tool_handler("collect_{{SKILL_ID}}_info")
async def execute_collect_{{SKILL_ID}}_info(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """收集用户必要信息"""
    fields = [
        {"id": "{{FIELD_1_ID}}", "label": "{{FIELD_1_LABEL}}", "type": "{{FIELD_1_TYPE}}", "required": True, "placeholder": ""},
        {"id": "{{FIELD_2_ID}}", "label": "{{FIELD_2_LABEL}}", "type": "{{FIELD_2_TYPE}}", "required": {{FIELD_2_REQUIRED}}, "placeholder": "{{FIELD_2_PLACEHOLDER}}"},
    ]

    return {
        "status": "collecting",
        "cardType": "collect_form",
        "formType": "{{SKILL_ID}}_info",
        "title": "请填写{{INFO_TYPE_DESC}}",
        "description": "{{FORM_DESCRIPTION}}",
        "fields": fields,
    }


# ═══════════════════════════════════════════════════════════════════════════
# 展示工具 (Display Tools)
# ═══════════════════════════════════════════════════════════════════════════

@tool_handler("show_{{CARD_TYPE_MAIN}}")
async def execute_show_{{CARD_TYPE_MAIN}}(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示主要结果 - V7 委托模式

    支持两种数据来源：
    1. args 参数直接传入（优先）- LLM 从 {{COMPUTE_TOOL}} 结果传递
    2. skill_data 缓存（备用）- 从用户数据读取
    """
    from services.agent.tool_registry import ToolRegistry

    profile = context.profile or {}
    skill_data = context.skill_data or {}
    identity = profile.get("identity", {})
    stored_info = identity.get("{{INFO_KEY}}", {})

    # ═══════════════════════════════════════════════════════════════════════
    # 优先从 args 获取数据（LLM 可以直接传递 {{COMPUTE_TOOL}} 的结果）
    # 支持 camelCase 和 snake_case 两种格式
    # ═══════════════════════════════════════════════════════════════════════
    result = {}
    if args.get("{{RESULT_FIELD_1}}") or args.get("{{RESULT_FIELD_1_CAMEL}}"):
        result = {
            "{{RESULT_FIELD_1}}": args.get("{{RESULT_FIELD_1}}") or args.get("{{RESULT_FIELD_1_CAMEL}}"),
            "{{RESULT_FIELD_2}}": args.get("{{RESULT_FIELD_2}}") or args.get("{{RESULT_FIELD_2_CAMEL}}"),
        }

    # 如果 args 没有，从 skill_data 读取
    if not result:
        cached_data = skill_data.get("{{SKILL_ID}}", {})
        result = cached_data.get("result", {}) if cached_data else {}

    # 如果仍然没有数据，提示先计算
    if not result or not result.get("{{RESULT_FIELD_1}}"):
        return {
            "status": "error",
            "error": "尚未计算，请先调用 {{COMPUTE_TOOL}}",
            "action": "{{COMPUTE_TOOL}}"
        }

    # 构建卡片数据
    card_data = {
        "userId": context.user_id,
        "inputInfo": {
            "{{PARAM_1}}": stored_info.get("{{PARAM_1}}"),
            "{{PARAM_2}}": stored_info.get("{{PARAM_2}}"),
        },
        "{{RESULT_FIELD_1_CAMEL}}": result.get("{{RESULT_FIELD_1}}"),
        "{{RESULT_FIELD_2_CAMEL}}": result.get("{{RESULT_FIELD_2}}"),
    }

    logger.info(f"Showing {{CARD_TYPE_MAIN}} via show_card for user {context.user_id}")

    return await ToolRegistry.execute(
        "show_card",
        {
            "card_type": "custom",
            "data_source": {"type": "inline", "data": card_data},
            "options": {"componentId": "{{CARD_TYPE_MAIN}}"}
        },
        context
    )


@tool_handler("show_{{CARD_TYPE_SECONDARY}}")
async def execute_show_{{CARD_TYPE_SECONDARY}}(args: Dict[str, Any], context: ToolContext) -> Dict[str, Any]:
    """展示次要结果 - V7 委托模式"""
    from services.agent.tool_registry import ToolRegistry
    # from skills.{{SKILL_ID}}.services import {{SECONDARY_SERVICE}}

    profile = context.profile or {}
    identity = profile.get("identity", {})
    stored_info = identity.get("{{INFO_KEY}}", {})

    # 获取必要信息
    {{PARAM_1}} = stored_info.get("{{PARAM_1}}")
    target_date = args.get("date") or datetime.now().strftime("%Y-%m-%d")

    # 如果没有必要信息，返回通用结果
    if not {{PARAM_1}}:
        card_data = {
            "date": target_date,
            "message": "请先提供必要信息以获取个性化分析。",
            "needInfo": True,
        }
        return await ToolRegistry.execute(
            "show_card",
            {
                "card_type": "custom",
                "data_source": {"type": "inline", "data": card_data},
                "options": {"componentId": "{{CARD_TYPE_SECONDARY}}"}
            },
            context
        )

    try:
        # TODO: 计算次要结果
        # result = {{SECONDARY_SERVICE}}({{PARAM_1}}={{PARAM_1}}, date=target_date)
        result = {"data": "次要结果数据"}

        card_data = {
            "date": target_date,
            "result": result,
        }

        logger.info(f"Showing {{CARD_TYPE_SECONDARY}} via show_card for user {context.user_id}")

        return await ToolRegistry.execute(
            "show_card",
            {
                "card_type": "custom",
                "data_source": {"type": "inline", "data": card_data},
                "options": {"componentId": "{{CARD_TYPE_SECONDARY}}"}
            },
            context
        )
    except Exception as e:
        logger.error(f"show_{{CARD_TYPE_SECONDARY}} failed: {e}")
        return {
            "status": "error",
            "error": str(e),
        }
