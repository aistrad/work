# VibeProfile 架构

## 1. UserDataSpace 全景

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            UserDataSpace                                     │
│                     (用户数据统一管理入口)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         VibeProfile (WHO)                              │  │
│  │                         用户画像数据                                   │  │
│  ├───────────────────────────────────────────────────────────────────────┤  │
│  │  unified_profiles.profile (JSONB)                                      │  │
│  │  ├── account      账户信息                                             │  │
│  │  ├── identity     身份信息 (出生信息)                                  │  │
│  │  ├── state        当前状态 (情绪、关注点)                              │  │
│  │  ├── preferences  偏好设置 (含 data_retention)                         │  │
│  │  ├── skill_data   Skill 专属数据                                       │  │
│  │  ├── extracted    对话抽取                                             │  │
│  │  └── life_context 生活上下文 (目标、任务、提醒)                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│  ┌──────────────────────┐  ┌──────────────────────┐  ┌─────────────────┐   │
│  │   Operational (WHAT) │  │    Content (WHAT)    │  │ Billing (WHAT)  │   │
│  │   操作数据           │  │    内容快照          │  │ 财务数据        │   │
│  ├──────────────────────┤  ├──────────────────────┤  ├─────────────────┤   │
│  │ conversations        │  │ reports              │  │ subscriptions   │   │
│  │ messages             │  │ relationships        │  │ payments        │   │
│  │ notifications        │  │                      │  │                 │   │
│  │ skill_usage_log      │  │                      │  │                 │   │
│  └──────────────────────┘  └──────────────────────┘  └─────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. VibeProfile 系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              VibeLife System                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│   │  Chat API   │  │ Settings API│  │ Proactive   │                         │
│   └──────┬──────┘  └──────┬──────┘  │ Worker      │                         │
│          │                │         └──────┬──────┘                         │
│          ▼                ▼                ▼                                │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                         CoreAgent                                │       │
│   │  ┌──────────────────────────────────────────────────────────┐   │       │
│   │  │                    Skill Services                         │   │       │
│   │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐  │   │       │
│   │  │  │  core  │ │lifecoach││  bazi  │ │ zodiac │ │ tarot  │  │   │       │
│   │  │  └────────┘ └────────┘ └────────┘ └────────┘ └────────┘  │   │       │
│   │  └──────────────────────────────────────────────────────────┘   │       │
│   └─────────────────────────────────┬───────────────────────────────┘       │
│                                     │                                        │
│                                     ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                     VibeProfileRepository                        │       │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │       │
│   │  │   get_*     │  │  update_*   │  │   Cache     │              │       │
│   │  └─────────────┘  └─────────────┘  │  (5min TTL) │              │       │
│   │                                     └─────────────┘              │       │
│   └─────────────────────────────────┬───────────────────────────────┘       │
│                                     │                                        │
│                                     ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────┐       │
│   │                       PostgreSQL                                 │       │
│   │  ┌───────────────────────┐  ┌───────────────┐  ┌────────────┐   │       │
│   │  │   unified_profiles    │  │   insights    │  │  timeline  │   │       │
│   │  │   (profile JSONB)     │  │   (Cold)      │  │  (Cold)    │   │       │
│   │  └───────────────────────┘  └───────────────┘  └────────────┘   │       │
│   └─────────────────────────────────────────────────────────────────┘       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3. 数据流

### 3.1 读取流程

```
请求 ──▶ VibeProfileRepository.get_*() ──▶ Cache命中? ──▶ 返回
                                              │
                                              ▼ miss
                                         SELECT from DB
                                              │
                                              ▼
                                         存入 Cache
                                              │
                                              ▼
                                            返回
```

### 3.2 写入流程

```
请求 ──▶ VibeProfileRepository.update_*() ──▶ jsonb_set() ──▶ 失效 Cache
```

## 4. Skill 访问矩阵

```
                        VibeProfile
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
   Core Layer         Professional         System
   (全量读/写)        (受限读/写)         (全量读/写)
        │                   │                   │
   ┌────┴────┐         ┌────┴────┐         ┌────┴────┐
   │  core   │         │  bazi   │         │Proactive│
   │lifecoach│         │ zodiac  │         │ Worker  │
   │mindful  │         │  tarot  │         │         │
   └─────────┘         │ career  │         └─────────┘
                       └─────────┘

Core Layer:    读 全部 / 写 state, extracted
Professional:  读 identity, state / 写 skill_data.{self}
System:        读/写 全部
```

## 5. Proactive 流程

```
每天 04:00
    │
    ▼
┌───────────────────────────────────────────────────────────────┐
│                    ProactiveWorker                             │
│                                                                │
│  1. SELECT * FROM unified_profiles                             │
│     WHERE profile->'preferences'->>'push_enabled' = 'true'     │
│                                                                │
│  2. for each user:                                             │
│       - 检查 subscribed_skills                                 │
│       - 为每个 skill 生成今日内容                              │
│       - 存入 notifications 表                                  │
│                                                                │
│  3. 按 push_hour 时间投递                                      │
│                                                                │
└───────────────────────────────────────────────────────────────┘
```

## 6. 时序图：对话场景

```
User        ChatAPI      CoreAgent     VibeProfile     BaziSkill     DB
  │            │             │              │              │          │
  │  发消息    │             │              │              │          │
  │ ──────────▶│             │              │              │          │
  │            │  处理       │              │              │          │
  │            │ ───────────▶│              │              │          │
  │            │             │ get_profile  │              │          │
  │            │             │ ────────────▶│              │          │
  │            │             │              │──▶ Cache/DB ─────────▶│
  │            │             │◀─────────────│              │          │
  │            │             │              │              │          │
  │            │             │ 路由到 Bazi  │              │          │
  │            │             │ ────────────────────────────▶│          │
  │            │             │              │              │ 生成回复 │
  │            │             │◀────────────────────────────│          │
  │            │             │              │              │          │
  │            │             │ update_state │              │          │
  │            │             │ ────────────▶│              │          │
  │            │             │              │──▶ UPDATE ───────────▶│
  │            │             │              │              │          │
  │            │◀────────────│              │              │          │
  │◀───────────│             │              │              │          │
```

## 7. 数据生命周期

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据生命周期管理                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  领域              默认保留    用户可选           清理规则                   │
│  ─────────────────────────────────────────────────────────────────────────  │
│  VibeProfile       永久        -                  checkins 保留 30 天        │
│  Conversations     1 年        1年 / 3年 / 永久   按 data_retention 设置     │
│  Content           永久        可手动删除         -                          │
│  Billing           7 年        不可更改           法规要求                   │
│  Logs              90 天       -                  滚动清理                   │
│  Notifications     30 天       -                  已读 30 天后清理           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘

用户设置路径: preferences.data_retention.conversations = "1y" | "3y" | "forever"
```
