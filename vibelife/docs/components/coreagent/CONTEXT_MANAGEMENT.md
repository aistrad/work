# CoreAgent Context 管理机制

> Version: 1.0 | 2026-01-20
> 基于 VibeLife V8 架构的 CoreAgent 上下文管理设计

---

## 1. 系统整体架构

### 1.1 请求处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           VibeLife V8 请求处理流程                                    │
└─────────────────────────────────────────────────────────────────────────────────────┘

                                    用户消息
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              chat_v5.py /stream                                      │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │ 1. 认证 & Quota 检查                                                         │    │
│  │    get_optional_user() → QuotaTracker.check()                               │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │ 2. Context 加载（分阶段）                                                     │    │
│  │                                                                              │    │
│  │    ┌──────────────────┐     ┌──────────────────┐                            │    │
│  │    │   Phase 1        │     │   Phase 2        │                            │    │
│  │    │   (无 skill)     │     │   (有 skill)     │                            │    │
│  │    ├──────────────────┤     ├──────────────────┤                            │    │
│  │    │ • profile: {}    │     │ • profile: 完整   │                            │    │
│  │    │ • skill_data: {} │     │ • skill_data: 当前│                            │    │
│  │    │ • history: 5条   │     │ • history: 10条  │                            │    │
│  │    └──────────────────┘     └──────────────────┘                            │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │ 3. 构建 AgentContext                                                         │    │
│  │    AgentContext(user_id, profile, skill_data, history, skill, ...)          │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              CoreAgent.run()                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │ 4. System Prompt 构建                                                        │    │
│  │                                                                              │    │
│  │    Phase 1 (无 skill):                    Phase 2 (有 skill):               │    │
│  │    ┌────────────────────┐                ┌────────────────────────────┐     │    │
│  │    │ • Core 人格 (精简)  │                │ • Skill 专家身份            │     │    │
│  │    │ • use_skill 工具   │                │ • Persona (lifecoach)      │     │    │
│  │    │ • 触发词参考       │                │ • Voice Mode               │     │    │
│  │    └────────────────────┘                │ • SOP 规则                 │     │    │
│  │                                          │ • 匹配的 Cases             │     │    │
│  │                                          │ • 用户上下文               │     │    │
│  │                                          │ • Skill Data               │     │    │
│  │                                          └────────────────────────────┘     │    │
│  └���────────────────────────────────────────────────────────────────────────────┘    │
│                                        │                                            │
│                                        ▼                                            │
│  ┌─────────────────────────────────────────────────────────────────────────────┐    │
│  │ 5. Agentic Loop (最多 10 轮)                                                 │    │
│  │                                                                              │    │
│  │    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐                │    │
│  │    │  LLM    │───▶│ Tool    │───▶│ Execute │───▶│ Result  │──┐             │    │
│  │    │ Stream  │    │ Calls?  │    │ Tools   │    │ Append  │  │             │    │
│  │    └─────────┘    └────┬────┘    └─────────┘    └─────────┘  │             │    │
│  │         ▲              │ No                                   │             │    │
│  │         │              ▼                                      │             │    │
│  │         │         ┌─────────┐                                 │             │    │
│  │         └─────────│  Done   │◀────────────────────────────────┘             │    │
│  │                   └─────────┘                                               │    │
│  └─────────────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
                              AI SDK 4.x SSE 输出
```

### 1.2 Context 管理时序图

```
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  Client  │  │ chat_v5  │  │CoreAgent │  │ProfileDB │  │ConvRepo  │  │  LLM     │
└────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │             │             │             │
     │ POST /stream│             │             │             │             │
     │ {message,   │             │             │             │             │
     │  conv_id}   │             │             │             │             │
     │────────────▶│             │             │             │             │
     │             │             │             │             │             │
     │             │ ════════════════════════════════════════════════════  │
     │             │ ║           PHASE 1: Skill 选择阶段                ║  │
     │             │ ════════════════════════════════��═══════════════════  │
     │             │             │             │             │             │
     │             │ get_user_context(skill=None)            │             │
     │             │─────────────────────────▶│             │             │
     │             │             │             │             │             │
     │             │ return {}, {}  (不加载)   │             │             │
     │             │◀─────────────────────────│             │             │
     │             │             │             │             │             │
     │             │ get_conversation(conv_id) │             │             │
     │             │─────────────────────────────────────────▶             │
     │             │             │             │             │             │
     │             │ return conv (检查是否有已激活 skill)     │             │
     │             │◀─────────────────────────────────────────│             │
     │             │             │             │             │             │
     │             │ get_history(conv_id, limit=5)           │             │
     │             │─────────────────────────────────────────▶             │
     │             │             │             │             │             │
     │             │ return messages[:5]       │             │             │
     │             │◀─────────────────────────────────────────│             │
     │             │             │             │             │             │
     │             │ AgentContext(profile={}, skill_data={}, history=5)    │
     │             │────────────▶│             │             │             │
     │             │             │             │             │             │
     │             │             │ _build_system_prompt()    │             │
     │             │             │ (Phase 1: 轻量 prompt)    │             │
     │             │             │─────────────────────────────────────────▶
     │             │             │             │             │             │
     │             │             │ LLM 决定调用 use_skill    │             │
     │             │             │◀─────────────────────────────────────────│
     │             │             │             │             │             │
     │             │ ════════════════════════════════════════════════════  │
     │             │ ║           use_skill 同轮重载                      ║  │
     │             │ ════════════════════════════════════════════════════  │
     │             │             │             │             │             │
     │             │             │ _handle_use_skill(skill="bazi")         │
     │             │             │             │             │             │
     │             │             │ update_conversation_skill │             │
     │             │             │──────────────────────────────���──────────▶
     │             │             │             │             │             │
     │             │             │ get_cached_profile_with_skill(skill)    │
     │             │             │────────────▶│             │             │
     │             │             │             │             │             │
     │             │             │ return {profile, skill_data}            │
     │             │             │◀────────────│             │             │
     │             │             │             │             │             │
     │             │             │ 更新 self._context.profile              │
     │             │             │ 更新 self._context.skill_data           │
     │             │             │             │             │             │
     │             │             │ _build_system_prompt()    │             │
     │             │             │ (Phase 2: 完整 prompt)    │             │
     │             │             │             │             │             │
     │             │             │ 更新 messages[0] (system) │             │
     │             │             │             │             │             │
     │             │ ════════════════════════════════════════════════════  │
     │             │ ║           PHASE 2: Skill 执行阶段                ║  │
     │             │ ════════════════════════════════════════════════════  │
     │             │             │             │             │             │
     │             │             │ 继续 Agentic Loop         │             │
     │             │             │─────────────────────────────────────────▶
     │             │             │             │             │             │
     │             │             │ Tool calls (calculate_bazi, show_chart) │
     │             │             │◀─────────────────────────────────────────│
     │             │             │             │             │             │
     │◀════════════════════════════════════════════════════════════════════│
     │             SSE Stream (AI SDK 4.x format)                          │
```

---

## 2. Context 数据流

### 2.1 数据来源与流向

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                           Context 数据来源与流向                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              数据存储层                                              │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    unified_profiles (JSONB)                                  │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │   │
│  │  │   account   │ │ birth_info  │ │    state    │ │ preferences │           │   │
│  │  │ (tier,name) │ │(date,place) │ │  (focus)    │ │(voice,lang) │           │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘           │   │
│  │  ┌─────────────┐ ┌─────────────┐                                           │   │
│  │  │ skill_data  │ │  extracted  │                                           │   │
│  │  │(bazi,zodiac)│ │(facts,goals)│                                           │   │
│  │  └─────────────┘ └─────────────┘                                           │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                    conversations + messages                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐    │   │
│  │  │ conversations: id, user_id, skill, voice_mode, created_at           │    │   │
│  │  │ messages: id, conversation_id, role, content, tool_calls            │    │   │
│  │  └─────────────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              缓存层 (ProfileCache)                                   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │  Key 格式: {user_id}:{skill} 或 {user_id}:all                               │   │
│  │  TTL: 5 分钟                                                                │   │
│  │  失效策略:                                                                   │   │
│  │    - profile 更新 → 失效所有 {user_id}:* 缓存                               │   │
│  │    - skill_data 更新 → 只失效 {user_id}:{skill} 和 {user_id}:all            │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              AgentContext (运行时)                                   │
│                                                                                     │
│  @dataclass                                                                         │
│  class AgentContext:                                                                │
│      user_id: str                    # 用户 ID                                      │
│      user_tier: str = "free"         # 用户等级                                     │
│      profile: Dict = None            # Phase 2 加载                                 │
│      skill_data: Dict = None         # Phase 2 加载，只含当前 skill                 │
│      history: List = None            # 从 DB 获取，Phase 1: 5条, Phase 2: 10条      │
│      skill: str = None               # 当前激活的 skill                             │
│      scenario: str = None            # 当前场景                                     │
│      conversation_id: str = None     # 会话 ID                                      │
│      voice_mode: str = "warm"        # 语气模式                                     │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              System Prompt 构建                                      │
│                                                                                     │
│  build_system_prompt(skill_id, scenario_id, user_context)                           │
│                                                                                     │
│  ┌─────────────────────────────────��───────────────────────────────────────────┐   │
│  │  组成部分:                                                                   │   │
│  │  1. Persona (lifecoach: future_self / coach)                                │   │
│  │  2. 专家身份 (SKILL.md → expert_persona)                                    │   │
│  │  3. Voice Mode (warm / direct / playful)                                    │   │
│  │  4. 规则/场景 (rules/*.md 或 scenarios/*.md)                                │   │
│  │  5. 伦理边界 (ethics.forbidden)                                             │   │
│  │  6. 能力边界 (固定模板)                                                      │   │
│  │  7. 用户上下文:                                                              │   │
│  │     - birth_info (已收集则跳过收集步骤)                                      │   │
│  │     - extracted (facts, concerns, goals, pain_points)                       │   │
│  │     - skill_data                                                            │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 AgentContext 数据类

```python
@dataclass
class AgentContext:
    """Agent 执行上下文"""
    user_id: str
    user_tier: str = "free"
    profile: Optional[Dict[str, Any]] = None      # Phase 2 才加载
    skill_data: Optional[Dict[str, Any]] = None   # Phase 2 才加载，只含当前 skill
    history: Optional[List[Dict[str, str]]] = None  # 从数据库获取
    skill: Optional[str] = None
    scenario: Optional[str] = None
    conversation_id: Optional[str] = None
    voice_mode: Optional[str] = "warm"
```

---

## 3. 当前架构优缺点

### 3.1 优点

| 优点 | 说明 |
|------|------|
| **分阶段加载** | Phase 1 不加载 profile，减少首次响应延迟 |
| **同轮重载** | use_skill 后立即重建 System Prompt，无需等下一轮 |
| **Skill 状态持久化** | conversation.skill 持久化，刷新页面可恢复 |
| **缓存策略** | ProfileCache 5分钟 TTL，减少 DB 查询 |
| **历史从 DB 获取** | 不依赖前端传入，数据一致性好 |

### 3.2 问题分析

#### 问题 1: Context 膨胀

```
System Prompt 组成（Phase 2 完整模式）:
┌────────────────────────────────────────────────────────────────┐
│ 1. Persona/专家身份           ~500 tokens                       │
│ 2. Voice Mode                 ~100 tokens                       │
│ 3. 规则/场景内容              ~1000-3000 tokens (变化大)        │
│ 4. SOP 规则                   ~500 tokens                       │
│ 5. 匹配的 Cases               ~500-2000 tokens (0-2个 case)     │
│ 6. 伦理边界                   ~200 tokens                       │
│ 7. 能力边界                   ~400 tokens                       │
│ 8. 用户上下文                 ~300-1000 tokens                  │
│ 9. Skill Data (JSON)          ~500-2000 tokens (命盘数据)       │
├────────────────────────────────────────────────────────────────┤
│ 总计: 4000-10000 tokens (System Prompt)                        │
│ + History: 5-10 条消息 ~1000-3000 tokens                       │
│ + 当前消息: ~100-500 tokens                                    │
├────────────────────────────────────────────────────────────────┤
│ 每轮请求: 5000-15000 tokens                                    │
└────────────────────────────────────────────────────────────────┘
```

#### 问题 2: 缓存粒度不够细

```
当前缓存 Key: {user_id}:{skill}

问题:
- profile 更新会失效所有缓存，但很多字段其实没变
- birth_info 更新应该只影响需要 birth_info 的 skill
- extracted 更新频繁（每次对话后抽取），导致缓存频繁失效
```

#### 问题 3: History 管理不够智能

```
当前策略:
- Phase 1: 取最近 5 条
- Phase 2: 取最近 10 条

问题:
- 固定条数，不考虑 token 数量
- 不区分消息重要性（工具调用 vs 普通对话）
- 长对话后期，早期重要信息可能丢失
```

---

## 4. 关键代码位置

| 模块 | 文件 | 说明 |
|------|------|------|
| 入口 | `routes/chat_v5.py` | Chat API 入口，Context 加载 |
| Agent | `services/agent/core.py` | CoreAgent 实现，Agentic Loop |
| Skill | `services/agent/skill_loader.py` | Skill 加载，System Prompt 构建 |
| Profile | `stores/unified_profile_repo.py` | Profile 数据访问 |
| Cache | `stores/profile_cache.py` | Profile 缓存 |
| Conversation | `stores/conversation_repo.py` | 会话管理 |
| Message | `stores/message_repo.py` | 消息管理 |
