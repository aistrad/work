# VibeLife 专家系统引擎构建方案
## 基于 Claude Code + Agentic 方法的知识服务基础设施

> Version: 1.0 | 2026-01-18
> 核心目标: 通过自动化流水线，将任何领域的专家知识转化为可运营的AI专家服务

---

## 一、核心理念

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   问题: 如何让AI具备真人专家的分析能力？                                      │
│                                                                             │
│   答案: 不是训练模型，而是构建"专家思维操作系统"                              │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   真人专家的三层能力                    VibeLife的技术实现            │   │
│   │   ══════════════════                   ══════════════════            │   │
│   │                                                                     │   │
│   │   1. 思维架构                          → 结构化知识图谱              │   │
│   │      (怎么看问题)                         (Thinking Frameworks)      │   │
│   │                                                                     │   │
│   │   2. 推理链条                          → 案例库 + 推理路径           │   │
│   │      (怎么想问题)                         (Reasoning Chains)         │   │
│   │                                                                     │   │
│   │   3. 指导模式                          → 可复用建议模板              │   │
│   │      (怎么给建议)                         (Guidance Patterns)        │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   关键洞察:                                                                 │
│   ────────                                                                  │
│   LLM已经有海量通用知识，我们要做的是:                                       │
│   1. 提供专业领域的"思维框架"让LLM知道怎么分析                              │
│   2. 提供真实案例的"推理过程"让LLM学习怎么思考                              │
│   3. 提供可复用的"指导模式"让LLM知道怎么给出有价值的建议                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    专家系统引擎构建架构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ════════════════════════ 构建时 (Build Time) ════════════════════════════  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │  原始知识源                                                          │  │
│   │  ────────────                                                        │  │
│   │  • 经典书籍 (PDF/EPUB)        如: 滴天髓、穷通宝鉴                   │  │
│   │  • 教学视频 (字幕)            如: 大师讲座、实战课程                  │  │
│   │  • 专家访谈 (文字稿)          如: 真实咨询案例记录                    │  │
│   │  • 网络文章 (结构化)          如: 知乎专栏、公众号精选                │  │
│   │                                                                     │  │
│   └──────────────────────────────┬──────────────────────────────────────┘  │
│                                  │                                         │
│                                  ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │                 Claude Code 智能构建引擎                              │  │
│   │                 ════════════════════════                              │  │
│   │                                                                     │  │
│   │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐          │  │
│   │   │   Stage 1     │  │   Stage 2     │  │   Stage 3     │          │  │
│   │   │   格式转换    │→│   智能切分    │→│   三要素抽取  │          │  │
│   │   │   PDF→MD     │  │   语义边界    │  │   思维+推理   │          │  │
│   │   └───────────────┘  └───────────────┘  │   +指导       │          │  │
│   │                                         └───────────────┘          │  │
│   │                                                │                    │  │
│   │                         ┌──────────────────────┼──────────────────┐ │  │
│   │                         ▼                      ▼                  ▼ │  │
│   │                   ┌──────────┐          ┌──────────┐      ┌────────┐│  │
│   │                   │ 思维架构 │          │ 推理链条 │      │指导模式││  │
│   │                   │ 知识图谱 │          │ 案例库   │      │ 模板库 ││  │
│   │                   └──────────┘          └──────────┘      └────────┘│  │
│   │                                                                     │  │
│   │   ┌───────────────┐  ┌───────────────┐                             │  │
│   │   │   Stage 4     │  │   Stage 5     │                             │  │
│   │   │   LLM审核     │→│   场景生成    │                             │  │
│   │   │   质量评分    │  │   SOP组装     │                             │  │
│   │   └───────────────┘  └───────────────┘                             │  │
│   │                                                                     │  │
│   └──────────────────────────────┬──────────────────────────────────────┘  │
│                                  │                                         │
│                                  ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │  输出产物                                                            │  │
│   │  ──────────                                                          │  │
│   │                                                                     │  │
│   │  /skills/{skill_id}/                                                │  │
│   │  ├── SKILL.md              # 专家身份 + 思维架构定义                 │  │
│   │  ├── scenarios/            # 服务场景 + SOP流程                     │  │
│   │  │   ├── basic_reading.md                                           │  │
│   │  │   ├── career.md                                                  │  │
│   │  │   └── ...                                                        │  │
│   │  └── tools/                # 计算工具 + 展示组件                    │  │
│   │                                                                     │  │
│   │  PostgreSQL:                                                        │  │
│   │  ├── knowledge_chunks      # 知识块 + 向量索引                      │  │
│   │  ├── cases                 # 案例库 (含推理链条+指导模式)            │  │
│   │  └── skill_metadata        # Skill元数据                            │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  ════════════════════════ 运行时 (Runtime) ════════════════════════════════ │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │                      CoreAgent 推理引擎                               │  │
│   │                      ═══════════════════                               │  │
│   │                                                                     │  │
│   │   用户问题 → 场景路由 → 加载SKILL.md → RAG检索 → 案例匹配            │  │
│   │                              ↓                                       │  │
│   │                    注入思维架构+推理链条+指导模式                       │  │
│   │                              ↓                                       │  │
│   │                    LLM生成专家级分析                                   │  │
│   │                              ↓                                       │  │
│   │                    工具调用(计算/展示)                                 │  │
│   │                              ↓                                       │  │
│   │                    交付用户                                           │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、Claude Code 智能构建引擎

### 3.1 为什么用 Claude Code？

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Claude Code 的核心优势                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  传统方法的问题:                                                             │
│  ────────────────                                                           │
│  • 手工整理知识 → 效率低、不可规模化                                         │
│  • 简单RAG → 只能检索，不能理解和重组                                        │
│  • 规则系统 → 无法处理知识的模糊性和复杂关联                                  │
│                                                                             │
│  Claude Code 解决方案:                                                       │
│  ─────────────────────                                                       │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  1. Agentic 工作流                                                   │   │
│  │     ─────────────────                                                │   │
│  │     Claude Code 可以自主规划、执行、验证                              │   │
│  │     不需要人工定义每个步骤                                            │   │
│  │                                                                     │   │
│  │  2. 代码生成能力                                                     │   │
│  │     ─────────────────                                                │   │
│  │     可以自动生成数据处理脚本、SQL查询、测试用例                        │   │
│  │     知识处理流程可以完全自动化                                        │   │
│  │                                                                     │   │
│  │  3. 深度语义理解                                                     │   │
│  │     ─────────────────                                                │   │
│  │     理解专业领域的术语、概念、关系                                    │   │
│  │     能够识别和提取"隐性知识"                                          │   │
│  │                                                                     │   │
│  │  4. 质量自检能力                                                     │   │
│  │     ─────────────────                                                │   │
│  │     可以审核自己生成的内容                                            │   │
│  │     发现问题后自动修正                                                │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 构建流水线详细设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Stage 1: 智能格式转换                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  输入: /data/vibelife/{skill}/source/*.pdf                                 │
│  输出: /data/vibelife/{skill}/converted/*.md                               │
│                                                                             │
│  Claude Code Agent 任务:                                                    │
│  ──────────────────────                                                     │
│                                                                             │
│  ```python                                                                  │
│  # 由 Claude Code 自动执行                                                  │
│                                                                             │
│  async def convert_source_to_markdown(source_file: Path) -> Path:          │
│      """                                                                    │
│      1. 识别文件类型 (PDF/EPUB/DOCX/SRT)                                    │
│      2. 提取文本内容                                                        │
│      3. 识别文档结构 (章节/标题/列表)                                       │
│      4. 处理特殊内容 (表格/图片/公式)                                       │
│      5. 生成结构化Markdown                                                  │
│      6. 保留原始引用信息                                                    │
│      """                                                                    │
│      pass                                                                   │
│  ```                                                                        │
│                                                                             │
│  关键能力:                                                                   │
│  • OCR + 结构识别 (处理扫描版古籍)                                          │
│  • 专业术语识别 (如八字中的"食神"、"七杀")                                  │
│  • 跨页内容连接                                                             │
│  • 脚注/引用处理                                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Stage 2: 语义智能切分                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  目标: 按语义边界切分，而不是固定长度                                         │
│                                                                             │
│  Claude Code Agent 任务:                                                    │
│  ──────────────────────                                                     │
│                                                                             │
│  ```python                                                                  │
│  async def semantic_chunking(markdown_file: Path) -> List[Chunk]:          │
│      """                                                                    │
│      切分策略 (由Claude动态决定):                                            │
│                                                                             │
│      1. 理论知识块 (theory)                                                 │
│         - 完整概念定义                                                      │
│         - 原理解释                                                          │
│         - 如: "食神是日主所生之物，代表才华、口福、子女..."                 │
│                                                                             │
│      2. 规则知识块 (rule)                                                   │
│         - 判断规则                                                          │
│         - 组合条件                                                          │
│         - 如: "食神见枭，谓之枭神夺食，主..."                               │
│                                                                             │
│      3. 案例知识块 (case)                                                   │
│         - 真实案例                                                          │
│         - 分析过程                                                          │
│         - 如: "乾造: 甲寅 丙寅 甲子 甲戌，此造..."                          │
│                                                                             │
│      4. 方法知识块 (method)                                                 │
│         - 分析步骤                                                          │
│         - 操作指南                                                          │
│         - 如: "论命先看月令，次看日主强弱..."                               │
│      """                                                                    │
│      pass                                                                   │
│  ```                                                                        │
│                                                                             │
│  输出结构:                                                                   │
│  ```json                                                                    │
│  {                                                                          │
│    "chunk_id": "CHK_bazi_ditianshui_001",                                  │
│    "chunk_type": "theory",                                                  │
│    "chunk_text": "食神者，日主所生之物也...",                               │
│    "source": {"book": "滴天髓", "chapter": "论食神"},                       │
│    "keywords": ["食神", "日主", "生"],                                      │
│    "related_concepts": ["伤官", "才华", "子女"]                             │
│  }                                                                          │
│  ```                                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│              Stage 3: 三要素抽取 (核心创新)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  这是整个系统的核心 — 从原始知识中抽取专家的"认知结构"                        │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  要素1: 思维架构 (Thinking Framework)                                │   │
│  │  ══════════════════════════════════════                              │   │
│  │                                                                     │   │
│  │  定义: 专家分析问题时使用的"视角"和"维度"                            │   │
│  │                                                                     │   │
│  │  抽取 Prompt:                                                        │   │
│  │  ```                                                                 │   │
│  │  分析这段文本，识别作者使用的分析框架:                                │   │
│  │                                                                     │   │
│  │  1. 他从哪些维度/角度来分析问题？                                     │   │
│  │  2. 这些维度之间的关系是什么？                                        │   │
│  │  3. 在什么场景下使用这个分析框架？                                    │   │
│  │                                                                     │   │
│  │  输出格式:                                                            │   │
│  │  {                                                                   │   │
│  │    "framework_name": "主体思维架构",                                  │   │
│  │    "dimensions": ["日主强弱", "格局定位", "用神喜忌"],                │   │
│  │    "dimension_relations": "先定强弱→再定格局→最后取用神",            │   │
│  │    "applicable_scenarios": ["基础命盘分析", "年度运势"]               │   │
│  │  }                                                                   │   │
│  │  ```                                                                 │   │
│  │                                                                     │   │
│  │  八字领域示例:                                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │ 架构名称         分析维度                 适用场景           │    │   │
│  │  │ ────────        ────────                ────────           │    │   │
│  │  │ 主体思维架构    日主强弱→格局→用神      基础分析、流年     │    │   │
│  │  │ 客体思维架构    六亲→十神→宫位          关系、事业         │    │   │
│  │  │ 时运思维架构    大运→流年→流月          时机选择           │    │   │
│  │  │ 象法思维架构    取象→类象→应象          具体事件预测       │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  要素2: 推理链条 (Reasoning Chain)                                   │   │
│  │  ══════════════════════════════════                                  │   │
│  │                                                                     │   │
│  │  定义: 专家从"观察"到"结论"的完整思维过程                            │   │
│  │                                                                     │   │
│  │  抽取 Prompt:                                                        │   │
│  │  ```                                                                 │   │
│  │  分析这个案例，还原专家的完整推理过程:                                │   │
│  │                                                                     │   │
│  │  1. 他首先观察到了什么？(Observation)                                │   │
│  │  2. 使用了什么分析框架？(Framework)                                  │   │
│  │  3. 中间推理步骤是什么？(Analysis)                                   │   │
│  │  4. 最终得出什么结论？(Conclusion)                                   │   │
│  │  5. 每一步的依据是什么？(Evidence)                                   │   │
│  │                                                                     │   │
│  │  输出格式:                                                            │   │
│  │  [                                                                   │   │
│  │    {                                                                 │   │
│  │      "step": 1,                                                      │   │
│  │      "type": "observation",                                          │   │
│  │      "content": "日主甲木，生于酉月",                                 │   │
│  │      "evidence": "命盘四柱"                                           │   │
│  │    },                                                                │   │
│  │    {                                                                 │   │
│  │      "step": 2,                                                      │   │
│  │      "type": "framework",                                            │   │
│  │      "framework": "主体思维架构",                                     │   │
│  │      "content": "酉月金旺，秋木凋零"                                   │   │
│  │    },                                                                │   │
│  │    {                                                                 │   │
│  │      "step": 3,                                                      │   │
│  │      "type": "analysis",                                             │   │
│  │      "content": "甲木无根，身弱无疑",                                 │   │
│  │      "evidence": "地支无寅卯木"                                       │   │
│  │    },                                                                │   │
│  │    {                                                                 │   │
│  │      "step": 4,                                                      │   │
│  │      "type": "conclusion",                                           │   │
│  │      "content": "身弱宜水木相助，忌金土克泄"                          │   │
│  │    }                                                                 │   │
│  │  ]                                                                   │   │
│  │  ```                                                                 │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │  要素3: 指导模式 (Guidance Pattern)                                  │   │
│  │  ══════════════════════════════════                                  │   │
│  │                                                                     │   │
│  │  定义: 可复用的建议模板，这是专家系统最有价值的输出                    │   │
│  │                                                                     │   │
│  │  抽取 Prompt:                                                        │   │
│  │  ```                                                                 │   │
│  │  从这段分析中提取可复用的指导建议:                                    │   │
│  │                                                                     │   │
│  │  1. 适用条件是什么？(在什么情况下给这个建议)                          │   │
│  │  2. 核心建议是什么？(具体建议内容)                                    │   │
│  │  3. 建议的依据是什么？(为什么这样建议)                                │   │
│  │  4. 建议的类型是什么？(时机/方向/策略/心态)                           │   │
│  │                                                                     │   │
│  │  输出格式:                                                            │   │
│  │  {                                                                   │   │
│  │    "pattern_name": "身弱逢水运事业建议",                              │   │
│  │    "condition": {                                                    │   │
│  │      "daymaster": "甲木",                                            │   │
│  │      "strength": "身弱",                                             │   │
│  │      "current_luck": "水运"                                          │   │
│  │    },                                                                │   │
│  │    "advice": "水为印星生身，此运贵人运，宜主动结交贵人，借力发展",    │   │
│  │    "advice_type": "策略",                                            │   │
│  │    "reason": "水生木，印星主贵人、学历、靠山",                        │   │
│  │    "source": "滴天髓·论印"                                           │   │
│  │  }                                                                   │   │
│  │  ```                                                                 │   │
│  │                                                                     │   │
│  │  指导模式类型:                                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │ 类型         说明                     示例                   │    │   │
│  │  │ ────        ────                     ────                   │    │   │
│  │  │ 时机建议    何时行动                 "今年下半年是换工作的   │    │   │
│  │  │                                      好时机"                 │    │   │
│  │  │ 方向建议    往哪里发展               "适合往北方发展"        │    │   │
│  │  │ 策略建议    怎么做                   "多借助团队力量"        │    │   │
│  │  │ 心态建议    如何调整心态             "保持耐心，厚积薄发"    │    │   │
│  │  │ 关系建议    如何处理关系             "与领导保持距离"        │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Stage 4: LLM自动审核                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Claude Code Agent 自动审核每个抽取结果:                                     │
│                                                                             │
│  ```python                                                                  │
│  async def auto_review(extracted_item: dict) -> ReviewResult:              │
│      """                                                                    │
│      审核维度:                                                               │
│      1. 完整性: 推理链条是否完整？指导模式是否有具体建议？                   │
│      2. 准确性: 是否符合领域知识？有无明显错误？                             │
│      3. 可用性: 在实际场景中是否可以直接使用？                               │
│      4. 独特性: 与现有内容是否重复？(相似度检查)                             │
│                                                                             │
│      评分规则:                                                               │
│      - score >= 0.8: 直接发布                                               │
│      - 0.6 <= score < 0.8: 需要人工review                                   │
│      - score < 0.6: 丢弃或重新抽取                                          │
│      """                                                                    │
│      pass                                                                   │
│  ```                                                                        │
│                                                                             │
│  审核 Prompt:                                                                │
│  ```                                                                        │
│  作为八字命理专家，审核以下抽取结果:                                         │
│                                                                             │
│  [推理链条]                                                                  │
│  {reasoning_chain}                                                          │
│                                                                             │
│  请评估:                                                                     │
│  1. 推理逻辑是否完整？(1-10分)                                              │
│  2. 专业术语使用是否准确？(1-10分)                                          │
│  3. 结论是否有足够依据？(1-10分)                                            │
│  4. 是否可以直接用于用户咨询？(1-10分)                                      │
│                                                                             │
│  如有问题请指出，并给出修改建议。                                            │
│  ```                                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Stage 5: 场景与SOP自动生成                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  基于抽取的三要素，自动生成服务场景:                                         │
│                                                                             │
│  ```python                                                                  │
│  async def generate_scenario(                                              │
│      frameworks: List[ThinkingFramework],                                  │
│      reasoning_chains: List[ReasoningChain],                               │
│      guidance_patterns: List[GuidancePattern]                              │
│  ) -> Scenario:                                                            │
│      """                                                                    │
│      1. 分析哪些框架+推理+指导可以组合成一个完整服务                        │
│      2. 生成服务流程 (SOP)                                                  │
│      3. 定义触发条件                                                        │
│      4. 设计工具调用序列                                                    │
│      """                                                                    │
│      pass                                                                   │
│  ```                                                                        │
│                                                                             │
│  生成 Prompt:                                                                │
│  ```                                                                        │
│  基于以下知识资产，设计一个"事业运势咨询"服务场景:                           │
│                                                                             │
│  可用的思维架构:                                                             │
│  - 主体思维架构: 分析日主强弱、格局                                          │
│  - 客体思维架构: 分析官星、财星                                              │
│  - 时运思维架构: 分析大运流年                                                │
│                                                                             │
│  可用的推理链条: [列出相关案例]                                              │
│  可用的指导模式: [列出相关建议模板]                                          │
│                                                                             │
│  请设计:                                                                     │
│  1. 服务流程 (SOP) - 从用户提问到给出建议的完整步骤                          │
│  2. 每个步骤使用什么框架/工具/知识                                           │
│  3. 如何组织输出让用户满意                                                   │
│  ```                                                                        │
│                                                                             │
│  输出示例 (scenarios/career.md):                                            │
│  ```markdown                                                                │
│  # 事业运势分析                                                              │
│                                                                             │
│  ## 触发条件                                                                 │
│  关键词: 事业, 工作, 升职, 跳槽, 创业, 职业发展                              │
│                                                                             │
│  ## 服务流程 (SOP)                                                           │
│                                                                             │
│  ### Phase 1: 信息确认                                                       │
│  - 确认用户出生信息                                                          │
│  - 询问当前职业状况                                                          │
│  - 了解具体关注点 (升职/跳槽/转行)                                           │
│                                                                             │
│  ### Phase 2: 基础分析 (使用:主体思维架构)                                   │
│  - 计算命盘，展示八字                                                        │
│  - 分析日主强弱                                                              │
│  - 定位格局                                                                  │
│                                                                             │
│  ### Phase 3: 事业分析 (使用:客体思维架构)                                   │
│  - 分析官星状态 (代表事业、地位)                                             │
│  - 分析财星状态 (代表收入、资源)                                             │
│  - 分析印星状态 (代表贵人、平台)                                             │
│                                                                             │
│  ### Phase 4: 时机分析 (使用:时运思维架构)                                   │
│  - 分析当前大运对事业的影响                                                  │
│  - 分析今年流年的事业机会                                                    │
│  - 找出最佳行动时间窗口                                                      │
│                                                                             │
│  ### Phase 5: 建议输出 (使用:指导模式)                                       │
│  - 匹配适用的指导模式                                                        │
│  - 给出时机建议                                                              │
│  - 给出策略建议                                                              │
│  - 给出心态建议                                                              │
│  ```                                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、Agentic 构建工作流

### 4.1 Claude Code Agent 配置

```yaml
# expert_builder_agent.yaml
# Claude Code 专家系统构建Agent配置

name: "Expert System Builder"
description: "自动构建知识服务专家系统"

# Agent 能力
capabilities:
  - file_operations      # 文件读写
  - code_execution       # 运行Python脚本
  - database_operations  # 数据库操作
  - web_search          # 搜索补充知识
  - self_reflection     # 自我审核

# 工作流定义
workflow:
  # 阶段1: 知识源处理
  stage_1_convert:
    trigger: "new files in /data/vibelife/{skill}/source/"
    actions:
      - detect_file_type
      - convert_to_markdown
      - validate_conversion
    output: "/data/vibelife/{skill}/converted/"
  
  # 阶段2: 智能切分
  stage_2_chunk:
    trigger: "stage_1 complete"
    actions:
      - analyze_document_structure
      - semantic_chunking
      - classify_chunk_types
      - extract_keywords
    output: "knowledge_chunks table"
  
  # 阶段3: 三要素抽取
  stage_3_extract:
    trigger: "stage_2 complete"
    actions:
      - extract_thinking_frameworks
      - extract_reasoning_chains  
      - extract_guidance_patterns
      - link_elements
    output: "cases table + frameworks metadata"
  
  # 阶段4: 质量审核
  stage_4_review:
    trigger: "stage_3 complete"
    actions:
      - self_review_quality
      - check_duplicates
      - validate_domain_accuracy
      - score_and_filter
    output: "approved items"
  
  # 阶段5: 场景生成
  stage_5_generate:
    trigger: "stage_4 complete"
    actions:
      - cluster_related_knowledge
      - generate_scenarios
      - create_sop_flows
      - generate_skill_md
    output: "/skills/{skill}/"

# 自主决策规则
decision_rules:
  # 切分粒度
  chunking:
    min_tokens: 100
    max_tokens: 2000
    prefer_semantic_boundary: true
  
  # 质量阈值
  quality:
    auto_approve_threshold: 0.8
    manual_review_threshold: 0.6
    reject_threshold: 0.4
  
  # 相似度检查
  similarity:
    duplicate_threshold: 0.9
    merge_threshold: 0.7
```

### 4.2 自动执行脚本

```python
# build_expert_system.py
# Claude Code 执行的主脚本

"""
专家系统自动构建脚本

使用方法:
    claude code run build_expert_system.py --skill bazi --source /data/vibelife/bazi/source/

功能:
    1. 自动处理所有源文件
    2. 智能抽取三要素
    3. 质量审核和过滤
    4. 生成完整的Skill定义
"""

import asyncio
from pathlib import Path
from typing import List, Dict, Any

# ============================================
# Stage 1: 格式转换
# ============================================

async def convert_all_sources(skill_id: str, source_dir: Path) -> List[Path]:
    """
    Claude Code 会自动:
    1. 扫描source_dir下的所有文件
    2. 根据文件类型选择合适的转换方法
    3. 生成结构化的Markdown
    """
    converted_files = []
    
    for source_file in source_dir.glob("*"):
        if source_file.suffix in ['.pdf', '.epub', '.docx', '.srt']:
            # Claude Code 自动处理转换
            output_path = await convert_file(source_file, skill_id)
            converted_files.append(output_path)
    
    return converted_files


# ============================================
# Stage 2: 语义切分
# ============================================

async def semantic_chunk(markdown_file: Path, skill_id: str) -> List[Dict]:
    """
    Claude Code 会自动:
    1. 分析文档结构
    2. 识别语义边界
    3. 分类chunk类型
    4. 提取关键词
    """
    chunks = []
    
    content = markdown_file.read_text()
    
    # Claude Code 动态决定如何切分
    # 不是固定规则，而是理解内容后智能切分
    
    return chunks


# ============================================
# Stage 3: 三要素抽取 (核心)
# ============================================

async def extract_thinking_framework(chunk: Dict) -> Dict:
    """
    从知识块中抽取思维架构
    
    Claude Code 会分析:
    - 作者使用了什么分析视角？
    - 分析维度之间的关系是什么？
    - 这个框架适用于什么场景？
    """
    # 抽取逻辑由Claude Code自主完成
    pass


async def extract_reasoning_chain(case_chunk: Dict) -> Dict:
    """
    从案例中抽取推理链条
    
    Claude Code 会还原:
    - 专家观察到了什么？
    - 使用了什么分析框架？
    - 推理步骤是什么？
    - 结论和依据是什么？
    """
    # 抽取逻辑由Claude Code自主完成
    pass


async def extract_guidance_pattern(analysis_chunk: Dict) -> Dict:
    """
    从分析中抽取指导模式
    
    Claude Code 会提取:
    - 适用条件
    - 具体建议
    - 建议依据
    - 建议类型
    """
    # 抽取逻辑由Claude Code自主完成
    pass


# ============================================
# Stage 4: 质量审核
# ============================================

async def auto_review(item: Dict, item_type: str) -> float:
    """
    Claude Code 自动审核抽取质量
    
    审核维度:
    - 完整性
    - 准确性
    - 可用性
    - 独特性
    """
    # 审核逻辑由Claude Code自主完成
    pass


# ============================================
# Stage 5: 场景生成
# ============================================

async def generate_scenario(
    skill_id: str,
    scenario_type: str,
    frameworks: List[Dict],
    reasoning_chains: List[Dict],
    guidance_patterns: List[Dict]
) -> str:
    """
    基于抽取的三要素，生成服务场景
    
    Claude Code 会:
    1. 分析哪些元素可以组合
    2. 设计服务流程 (SOP)
    3. 生成Markdown场景文件
    """
    # 生成逻辑由Claude Code自主完成
    pass


async def generate_skill_md(
    skill_id: str,
    frameworks: List[Dict],
    scenarios: List[str]
) -> str:
    """
    生成完整的SKILL.md文件
    
    包含:
    - 专家身份定义
    - 思维架构体系
    - 场景目录
    - 工具列表
    - 伦理边界
    """
    # 生成逻辑由Claude Code自主完成
    pass


# ============================================
# 主流程
# ============================================

async def build_expert_system(skill_id: str, source_dir: str):
    """
    完整构建流程
    """
    source_path = Path(source_dir)
    
    print(f"🚀 开始构建 {skill_id} 专家系统...")
    
    # Stage 1: 格式转换
    print("📄 Stage 1: 转换源文件...")
    converted_files = await convert_all_sources(skill_id, source_path)
    print(f"   完成: {len(converted_files)} 个文件")
    
    # Stage 2: 智能切分
    print("✂️ Stage 2: 语义切分...")
    all_chunks = []
    for md_file in converted_files:
        chunks = await semantic_chunk(md_file, skill_id)
        all_chunks.extend(chunks)
    print(f"   完成: {len(all_chunks)} 个知识块")
    
    # Stage 3: 三要素抽取
    print("🧠 Stage 3: 抽取三要素...")
    frameworks = []
    reasoning_chains = []
    guidance_patterns = []
    
    for chunk in all_chunks:
        if chunk['type'] == 'theory':
            fw = await extract_thinking_framework(chunk)
            if fw:
                frameworks.append(fw)
        elif chunk['type'] == 'case':
            rc = await extract_reasoning_chain(chunk)
            if rc:
                reasoning_chains.append(rc)
            gp = await extract_guidance_pattern(chunk)
            if gp:
                guidance_patterns.append(gp)
    
    print(f"   思维架构: {len(frameworks)} 个")
    print(f"   推理链条: {len(reasoning_chains)} 个")
    print(f"   指导模式: {len(guidance_patterns)} 个")
    
    # Stage 4: 质量审核
    print("✅ Stage 4: 质量审核...")
    approved_frameworks = [f for f in frameworks if await auto_review(f, 'framework') >= 0.8]
    approved_chains = [c for c in reasoning_chains if await auto_review(c, 'chain') >= 0.8]
    approved_patterns = [p for p in guidance_patterns if await auto_review(p, 'pattern') >= 0.8]
    
    print(f"   通过审核: {len(approved_frameworks)} 架构, {len(approved_chains)} 链条, {len(approved_patterns)} 模式")
    
    # Stage 5: 生成Skill
    print("📦 Stage 5: 生成Skill定义...")
    
    # 生成场景
    scenarios = []
    for scenario_type in ['basic_reading', 'career', 'relationship', 'yearly_report']:
        scenario = await generate_scenario(
            skill_id, scenario_type,
            approved_frameworks, approved_chains, approved_patterns
        )
        scenarios.append(scenario)
    
    # 生成SKILL.md
    skill_md = await generate_skill_md(skill_id, approved_frameworks, scenarios)
    
    print(f"✨ 完成! 输出到 /skills/{skill_id}/")


# 运行
if __name__ == "__main__":
    import sys
    skill_id = sys.argv[1] if len(sys.argv) > 1 else "bazi"
    source_dir = sys.argv[2] if len(sys.argv) > 2 else f"/data/vibelife/{skill_id}/source/"
    
    asyncio.run(build_expert_system(skill_id, source_dir))
```

---

## 五、运行时推理引擎

### 5.1 CoreAgent 如何使用三要素

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    CoreAgent 运行时推理流程                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  用户输入: "我今年想换工作，帮我看看运势"                                     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Step 1: 场景路由                                                     │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 触发词匹配: "换工作" → career 场景                                   │   │
│  │ 加载: scenarios/career.md                                           │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Step 2: 构建 System Prompt                                           │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ System Prompt 结构:                                                  │   │
│  │                                                                     │   │
│  │ ```                                                                  │   │
│  │ # 专家身份                                                           │   │
│  │ 你是一位专业的八字命理师，精通子平真诠、滴天髓等经典...              │   │
│  │                                                                     │   │
│  │ # 本次服务场景                                                       │   │
│  │ 用户想了解事业运势，请按以下流程分析:                                │   │
│  │ [SOP流程]                                                            │   │
│  │                                                                     │   │
│  │ # 可用的思维架构                                                     │   │
│  │ 1. 主体思维架构: 先看日主强弱，再定格局...                           │   │
│  │ 2. 客体思维架构: 官星代表事业，财星代表收入...                       │   │
│  │ 3. 时运思维架构: 大运流年的影响...                                   │   │
│  │                                                                     │   │
│  │ # 用户信息                                                           │   │
│  │ 命盘: [从profile获取]                                                │   │
│  │ 当前大运: [计算得出]                                                 │   │
│  │ 今年流年: 丙午年                                                     │   │
│  │ ```                                                                  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Step 3: RAG 检索相关知识                                             │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 查询: "甲木身弱 官星 事业 大运"                                      │   │
│  │                                                                     │   │
│  │ 检索结果:                                                            │   │
│  │ - [knowledge] 甲木见官，需要印星化杀...                              │   │
│  │ - [knowledge] 身弱官旺，宜走印运...                                  │   │
│  │                                                                     │   │
│  │ 注入到 Context                                                       │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Step 4: 案例匹配 (获取推理链条)                                       │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 匹配条件:                                                            │   │
│  │ - daymaster: 甲木                                                   │   │
│  │ - strength: 身弱                                                    │   │
│  │ - scenario: career                                                  │   │
│  │                                                                     │   │
│  │ 匹配到案例: CASE_BAZI_042                                            │   │
│  │                                                                     │   │
│  │ 推理链条:                                                            │   │
│  │ [1] 观察: 日主甲木，生于酉月，地支无根                               │   │
│  │ [2] 框架: 使用主体思维架构，判定身弱                                 │   │
│  │ [3] 分析: 官星透出，身弱难担官                                       │   │
│  │ [4] 结论: 需要印星来化官生身                                         │   │
│  │                                                                     │   │
│  │ 注入到 Context: "参考以下推理过程..."                                │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Step 5: 匹配指导模式                                                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ 匹配条件:                                                            │   │
│  │ - daymaster: 甲木                                                   │   │
│  │ - strength: 身弱                                                    │   │
│  │ - topic: career                                                     │   │
│  │ - current_luck: 水运 (印运)                                         │   │
│  │                                                                     │   │
│  │ 匹配到的指导模式:                                                    │   │
│  │                                                                     │   │
│  │ [时机建议] 今年下半年是换工作的好时机                                │   │
│  │   条件: 身弱逢印运 + 流年生大运                                      │   │
│  │   原因: 印星主贵人、平台，此时跳槽容易遇贵人                         │   │
│  │                                                                     │   │
│  │ [策略建议] 借助平台和团队力量，不要单打独斗                          │   │
│  │   条件: 身弱无根                                                     │   │
│  │   原因: 甲木无根难以独立支撑大事业                                   │   │
│  │                                                                     │   │
│  │ [方向建议] 适合往北方或水旺的行业发展                                │   │
│  │   条件: 喜水木                                                       │   │
│  │   原因: 水生木，北方属水                                             │   │
│  │                                                                     │   │
│  │ 注入到 Context: "根据你的情况，可以参考以下建议..."                  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ Step 6: LLM 生成回复                                                  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ LLM 收到的完整 Context:                                              │   │
│  │ - System: 专家身份 + SOP + 思维架构                                  │   │
│  │ - Context: RAG知识 + 推理链条示例 + 指导模式                         │   │
│  │ - User: 用户问题                                                     │   │
│  │                                                                     │   │
│  │ LLM 生成:                                                            │   │
│  │ 1. 按SOP流程逐步分析                                                 │   │
│  │ 2. 使用思维架构组织分析                                              │   │
│  │ 3. 参考推理链条的方式展示过程                                        │   │
│  │ 4. 输出匹配的指导建议                                                │   │
│  │                                                                     │   │
│  │ 调用工具:                                                            │   │
│  │ - show_bazi_chart: 展示命盘                                          │   │
│  │ - show_bazi_fortune: 展示运势分析                                    │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 最终输出                                                              │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │                                                                     │   │
│  │ "根据你的八字分析...                                                 │   │
│  │                                                                     │   │
│  │  [展示命盘卡片]                                                      │   │
│  │                                                                     │   │
│  │  从你的命盘来看，你是甲木日主，生于酉月金旺之时，                     │   │
│  │  日主偏弱。官星代表事业，你的官星透出但身弱难担，                     │   │
│  │  这意味着...                                                         │   │
│  │                                                                     │   │
│  │  好消息是，你目前正在走水运(印运)，水能生木，                         │   │
│  │  这步大运对你的事业发展是有利的...                                   │   │
│  │                                                                     │   │
│  │  [展示运势卡片]                                                      │   │
│  │                                                                     │   │
│  │  给你几个建议:                                                       │   │
│  │  1. 时机: 今年下半年是换工作的好时机...                              │   │
│  │  2. 策略: 建议借助平台和团队...                                      │   │
│  │  3. 方向: 北方或水旺的行业..."                                       │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 核心代码实现

```python
# services/agent/core.py
# CoreAgent 核心实现

class CoreAgent:
    """
    CoreAgent - 专家系统推理引擎
    
    核心职责:
    1. 加载SKILL.md和Scenario定义
    2. 注入思维架构到System Prompt
    3. RAG检索相关知识
    4. 匹配案例获取推理链条
    5. 匹配指导模式
    6. 编排工具调用
    """
    
    async def run(
        self, 
        message: str, 
        context: AgentContext
    ) -> AsyncGenerator[AgentEvent, None]:
        
        # 1. 场景路由
        scenario = await self._route_scenario(message, context.skill)
        
        # 2. 构建System Prompt (注入思维架构)
        system_prompt = await self._build_system_prompt(
            skill_id=context.skill,
            scenario=scenario,
            user_profile=context.profile
        )
        
        # 3. RAG检索相关知识
        knowledge_context = await self._retrieve_knowledge(
            query=message,
            skill_id=context.skill,
            scenario=scenario
        )
        
        # 4. 匹配案例 (获取推理链条)
        matched_cases = await self._match_cases(
            features=context.profile.get('skill_data', {}).get('features', {}),
            scenario=scenario
        )
        
        reasoning_examples = self._extract_reasoning_chains(matched_cases)
        
        # 5. 匹配指导模式
        guidance_patterns = await self._match_guidance_patterns(
            features=context.profile.get('skill_data', {}).get('features', {}),
            scenario=scenario,
            current_luck=context.profile.get('skill_data', {}).get('current_luck', {})
        )
        
        # 6. 构建完整Context
        full_context = self._build_context(
            knowledge=knowledge_context,
            reasoning_examples=reasoning_examples,
            guidance_patterns=guidance_patterns
        )
        
        # 7. LLM生成 + 工具调用
        async for event in self._generate_response(
            system_prompt=system_prompt,
            context=full_context,
            user_message=message,
            tools=await self._get_tools(context.skill)
        ):
            yield event
    
    
    async def _build_system_prompt(
        self,
        skill_id: str,
        scenario: str,
        user_profile: dict
    ) -> str:
        """
        构建System Prompt
        
        结构:
        1. 专家身份 (from SKILL.md)
        2. 思维架构 (from SKILL.md)
        3. 当前场景SOP (from scenario.md)
        4. 用户信息 (from profile)
        """
        
        # 加载SKILL.md
        skill_def = await SkillLoader.load_skill(skill_id)
        
        # 加载Scenario
        scenario_def = await SkillLoader.load_scenario(skill_id, scenario)
        
        # 构建Prompt
        prompt = f"""
# 专家身份
{skill_def.expert_persona}

# 知识来源优先级
{skill_def.knowledge_priority}

# 思维架构体系
你在分析问题时，请使用以下思维架构:

{self._format_thinking_frameworks(skill_def.thinking_frameworks)}

# 当前服务场景: {scenario_def.name}

## 服务流程 (请严格按此流程)
{scenario_def.sop}

# 用户信息
{self._format_user_info(user_profile)}

# 输出要求
1. 分析过程要展示你的思维路径，让用户理解你是怎么得出结论的
2. 建议要具体可行，不要泛泛而谈
3. 语气温和专业，不要故弄玄虚
"""
        return prompt
    
    
    async def _match_cases(
        self,
        features: dict,
        scenario: str
    ) -> List[Case]:
        """
        匹配相似案例
        
        匹配维度:
        - 日主类型
        - 强弱状态
        - 格局类型
        - 场景类型
        """
        
        query = """
        SELECT * FROM cases
        WHERE skill_id = $1
          AND $2 = ANY(scenario_ids)
          AND features->>'daymaster' = $3
          AND features->>'strength' = $4
        ORDER BY 
          -- 特征相似度
          similarity(features::text, $5::text) DESC
        LIMIT 3
        """
        
        return await self.db.fetch(query, ...)
    
    
    async def _match_guidance_patterns(
        self,
        features: dict,
        scenario: str,
        current_luck: dict
    ) -> List[GuidancePattern]:
        """
        匹配指导模式
        
        匹配条件:
        - 用户特征匹配
        - 当前运势匹配
        - 场景匹配
        """
        
        # 从cases表中提取guidance_patterns
        cases = await self._match_cases(features, scenario)
        
        patterns = []
        for case in cases:
            if case.guidance_patterns:
                for pattern in case.guidance_patterns:
                    if self._pattern_matches(pattern, features, current_luck):
                        patterns.append(pattern)
        
        # 去重和排序
        return self._dedupe_and_rank_patterns(patterns)
```

---

## 六、效果保证机制

### 6.1 质量闭环

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          专家系统质量保证闭环                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │                        构建时质量保证                                │   │
│  │                                                                     │   │
│  │  1. 多层审核                                                         │   │
│  │     ────────────                                                     │   │
│  │     • Claude Code 自动抽取                                           │   │
│  │     • Claude Code 自动审核 (第一道)                                  │   │
│  │     • 不同模型交叉验证 (第二道)                                      │   │
│  │     • 领域专家抽检 (第三道，高价值内容)                              │   │
│  │                                                                     │   │
│  │  2. 相似度检查                                                       │   │
│  │     ────────────                                                     │   │
│  │     • 新抽取内容 vs 现有内容                                         │   │
│  │     • similarity > 0.9: 丢弃 (重复)                                 │   │
│  │     • 0.7 < similarity < 0.9: 合并 (补充)                           │   │
│  │     • similarity < 0.7: 新增                                        │   │
│  │                                                                     │   │
│  │  3. 领域一致性检查                                                   │   │
│  │     ────────────────                                                 │   │
│  │     • 术语使用是否正确                                               │   │
│  │     • 逻辑是否符合领域规则                                           │   │
│  │     • 建议是否有依据                                                 │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │                        运行时质量保证                                │   │
│  │                                                                     │   │
│  │  1. 推理过程可验证                                                   │   │
│  │     ────────────────                                                 │   │
│  │     • 每个分析步骤都有依据                                           │   │
│  │     • 用户可以追问"为什么"                                           │   │
│  │     • 系统能展示推理链条                                             │   │
│  │                                                                     │   │
│  │  2. 建议有溯源                                                       │   │
│  │     ────────────                                                     │   │
│  │     • 每个建议来自哪个指导模式                                       │   │
│  │     • 指导模式的原始出处 (经典/案例)                                 │   │
│  │     • 用户可以查看详细解释                                           │   │
│  │                                                                     │   │
│  │  3. 用户反馈闭环                                                     │   │
│  │     ────────────────                                                 │   │
│  │     • 收集用户满意度                                                 │   │
│  │     • 分析不满意的案例                                               │   │
│  │     • 反馈到知识库迭代                                               │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                        │                                    │
│                                        ▼                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                     │   │
│  │                        持续迭代机制                                  │   │
│  │                                                                     │   │
│  │  1. 知识库持续扩充                                                   │   │
│  │     ────────────────                                                 │   │
│  │     • 定期处理新的知识源                                             │   │
│  │     • 从用户对话中学习                                               │   │
│  │     • 专家定期补充高价值内容                                         │   │
│  │                                                                     │   │
│  │  2. 指导模式进化                                                     │   │
│  │     ────────────────                                                 │   │
│  │     • 跟踪哪些建议被用户采纳                                         │   │
│  │     • 跟踪哪些建议用户反馈好                                         │   │
│  │     • 提升高效模式的权重                                             │   │
│  │                                                                     │   │
│  │  3. 场景优化                                                         │   │
│  │     ────────────                                                     │   │
│  │     • 分析用户最常问的问题                                           │   │
│  │     • 发现缺失的场景                                                 │   │
│  │     • 自动生成新场景                                                 │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、扩展到新领域

### 7.1 新Skill创建流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    创建新领域专家系统 (以心理咨询为例)                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Step 1: 准备知识源                                                          │
│  ══════════════════                                                         │
│                                                                             │
│  /data/vibelife/psychology/source/                                         │
│  ├── cbt_handbook.pdf           # 认知行为疗法手册                          │
│  ├── attachment_theory.epub     # 依恋理论                                  │
│  ├── counseling_cases/          # 咨询案例集                                │
│  │   ├── case_001.md                                                       │
│  │   ├── case_002.md                                                       │
│  │   └── ...                                                               │
│  └── expert_interviews/         # 专家访谈                                  │
│      └── ...                                                               │
│                                                                             │
│  ───────────────────────────────────────────────────────────────────────    │
│                                                                             │
│  Step 2: 运行 Claude Code 构建                                               │
│  ══════════════════════════════                                             │
│                                                                             │
│  ```bash                                                                    │
│  claude code run build_expert_system.py \                                  │
│      --skill psychology \                                                  │
│      --source /data/vibelife/psychology/source/                            │
│  ```                                                                        │
│                                                                             │
│  Claude Code 自动:                                                          │
│  • 识别心理学领域的特殊结构                                                 │
│  • 抽取心理学的思维架构 (如: 认知三角、ABC模型)                            │
│  • 抽取咨询案例的推理过程                                                   │
│  • 抽取干预建议模式                                                         │
│                                                                             │
│  ───────────────────────────────────────────────────────────────────────    │
│                                                                             │
│  Step 3: 验证和调优                                                          │
│  ══════════════════                                                         │
│                                                                             │
│  1. 检查 SKILL.md 中的思维架构是否正确                                      │
│  2. 验证 scenarios/ 中的SOP流程是否合理                                     │
│  3. 测试几个真实咨询场景                                                    │
│  4. 根据反馈调整                                                            │
│                                                                             │
│  ───────────────────────────────────────────────────────────────────────    │
│                                                                             │
│  Step 4: 上线                                                                │
│  ═════════                                                                  │
│                                                                             │
│  • 新Skill自动被 SkillServiceRegistry 发现                                  │
│  • 无需修改代码，重启服务即可                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 心理咨询领域示例

```markdown
# 心理咨询 Skill (自动生成示例)

## 专家身份

你是一位专业的心理咨询师，熟悉认知行为疗法(CBT)、人本主义疗法、
精神分析等多种流派。你的目标是帮助来访者觉察自己的情绪和认知模式，
找到更健康的应对方式。

## 思维架构体系

### 核心架构

| 架构名称 | 分析维度 | 适用场景 |
|---------|---------|---------|
| 认知三角架构 | 想法→情绪→行为 | 情绪困扰、行为问题 |
| ABC模型架构 | 事件→信念→结果 | 认知扭曲识别 |
| 依恋模式架构 | 安全/焦虑/回避/混乱 | 关系问题 |
| 需求层次架构 | 生理→安全→归属→尊重→自我实现 | 人生迷茫 |

## 场景目录

### 入门级

| 场景 | 触发词 | 描述 |
|-----|--------|------|
| 情绪疏导 | 焦虑、难过、压力 | 倾听和共情 |
| 自我觉察 | 不知道为什么、莫名其妙 | 帮助觉察情绪 |

### 标准级

| 场景 | 触发词 | 描述 |
|-----|--------|------|
| 认知重构 | 总是、一定、必须 | 识别和调整认知扭曲 |
| 关系探索 | 和父母、和伴侣、和朋友 | 探索关系模式 |

## 伦理边界

### 绝对禁止
- 诊断精神疾病
- 替代专业治疗
- 给出伤害性建议

### 必须转介
- 有自杀/自伤倾向
- 需要药物治疗
- 症状严重影响生活
```

---

## 八、总结

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│                    专家系统引擎: 技术护城河的核心                             │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  核心创新:                                                                   │
│  ══════════                                                                 │
│                                                                             │
│  1. 三要素抽取 (思维架构 + 推理链条 + 指导模式)                              │
│     不是简单的RAG，而是抽取专家的"认知结构"                                  │
│                                                                             │
│  2. Claude Code 自动构建                                                    │
│     知识处理完全自动化，可规模化扩展到任何领域                               │
│                                                                             │
│  3. 运行时动态注入                                                          │
│     根据用户情况实时匹配最相关的推理链条和指导模式                           │
│                                                                             │
│  ────────────────────────────────────────────────────────────────────────   │
│                                                                             │
│  竞争壁垒:                                                                   │
│  ══════════                                                                 │
│                                                                             │
│  • 知识资产: 结构化的东方智慧 + 西方心理学                                  │
│  • 抽取能力: Claude Code + 领域专家联合                                     │
│  • 积累效应: 越用越准的推理链条和指导模式                                   │
│                                                                             │
│  ────────────────────────────────────────────────────────────────────────   │
│                                                                             │
│  关键指标:                                                                   │
│  ══════════                                                                 │
│                                                                             │
│  构建效率: 1本书 → 1天自动处理 → 100+指导模式                              │
│  服务质量: 用户满意度 > 真人咨询师 (因为记忆完整、响应及时)                  │
│  扩展速度: 1个新领域 → 2周上线                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

*"The biggest risk is not taking any risk. In a world that's changing really quickly, the only strategy that is guaranteed to fail is not taking risks."*

*— Mark Zuckerberg*

**应用到VibeLife:**

*"最大的风险是不冒任何风险。用Claude Code自动化构建专家系统，这是最大胆也是最正确的选择。"*