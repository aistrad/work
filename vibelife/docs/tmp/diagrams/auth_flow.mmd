flowchart TD
  subgraph Browser[Web App]
    A[User clicks OAuth button]
    A -->|Google/Apple| B1[/POST /api/v1/account/auth/oauth/{provider}/]
    A -->|WeChat| B2[/POST /api/v1/account/auth/oauth/wechat/qrcode/]
  end

  subgraph API[FastAPI Backend]
    B1 --> C1{OAuthService.verify_{provider}_token}
    C1 -->|valid| D1[Check existing auth by provider_id]
    C1 -->|invalid| E1[401 Invalid token]

    D1 -->|exists| F1[Fetch user, ensure active]
    D1 -->|not exists| G1{Email bound elsewhere?}
    G1 -->|yes| E2[409 already registered via other method]
    G1 -->|no| H1[Create user + create_auth(provider)]

    F1 --> I1[JWTService.create_access/refresh]
    H1 --> I1
    I1 --> J1[200 TokenResponse]

    B2 --> K1[WechatService.generate_qrcode -> store scene_id in DB]
    K1 --> L1[Return qrcode_url + scene_id]
  end

  subgraph WeChat OAuth
    M1[Mobile WeChat scans QR]
    M1 --> N1[WeChat redirects user to redirect_uri?code&state=scene_id]
  end

  N1 --> O1[/POST /api/v1/account/auth/oauth/wechat/callback/]
  O1 --> P1[Exchange code for access_token + userinfo]
  P1 --> Q1[wechat_login(openid/unionid)]
  Q1 --> R1[Upsert user + JWT tokens]
  R1 --> S1[Persist confirmed status to wechat_login_sessions]
  S1 --> T1[200 TokenResponse]

  %% Single-login policy annotation
  classDef note fill:#fffbcc,stroke:#e0d58f,color:#4c3b00
  X1([Policy: one login method per account. Emails cannot link across providers.]):::note
