sequenceDiagram
  participant U as User (WeChat App)
  participant W as WeChat OAuth
  participant FE as Web (Next.js)
  participant API as API (/account)
  participant DB as DB (wechat_login_sessions)

  FE->>API: POST /auth/oauth/wechat/qrcode {redirect_uri}
  API->>DB: INSERT scene_id,status=pending,expires_at
  API-->>FE: {scene_id, qrcode_url, expires_at}
  U->>W: Scan QR and authorize
  W-->>FE: GET redirect_uri?code=...&state=scene_id
  FE->>API: POST /auth/oauth/wechat/callback {code,state, onboarding?}
  API->>W: GET access_token + userinfo
  API->>DB: UPDATE session status=confirmed, user_info, tokens (JSON)
  API-->>FE: 200 TokenResponse (JWTs + user)

  loop Poll until confirmed
    FE->>API: GET /auth/oauth/wechat/status/{scene_id}
    API->>DB: SELECT session by scene_id
    API-->>FE: {status: pending|scanned|confirmed|expired, tokens?}
  end
