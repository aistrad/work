# VibeLife v9 - Proactive Intelligence 设计文档

> Version: 9.0 | 2026-01-21
> 核心理念：让页面「活」起来，从用户交互中学习

---

## 一、核心问题

```
当前 Me/Journey 页面是「死的」：
- 静态展示，不会从用户对话中学习
- 没有与 CoreAgent 真正联动
- Proactive 推送是规则驱动，不是智能驱动
```

## 二、解决方案架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PROACTIVE INTELLIGENCE LOOP                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐ │
│   │   对话层    │───▶│   抽取层    │───▶│   存储层    │───▶│   触发层    │ │
│   │ CoreAgent   │    │  Extractor  │    │VibeProfile │    │  Proactive  │ │
│   └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘ │
│         │                  │                  │                  │         │
│         │                  ▼                  ▼                  ▼         │
│         │           ┌─────────────────────────────────────────────┐        │
│         │           │              活化数据流                      │        │
│         │           ├─────────────────────────────────────────────┤        │
│         │           │  • 行为模式 → VibeID 原型更新                │        │
│         │           │  • 话题热度 → Journey 优先级调整             │        │
│         │           │  • 情绪趋势 → 关怀推送触发                   │        │
│         │           │  • 洞察生成 → Me 页卡片刷新                  │        │
│         │           └─────────────────────────────────────────────┘        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 三、数据抽取协议

### 3.1 抽取时机

| 时机 | 触发条件 | 抽取内容 |
|------|----------|----------|
| **实时抽取** | 每轮对话结束 | 情绪状态、关键实体 |
| **会话抽取** | 对话结束时 | 话题摘要、行为模式 |
| **周期抽取** | 每日凌晨 | 趋势分析、原型更新 |

### 3.2 抽取数据结构

```yaml
extracted_data:
  # 实时层 - 每轮对话
  realtime:
    emotion_state: "anxious" | "calm" | "excited" | ...
    key_entities:
      - type: "person" | "goal" | "event"
        name: string
        sentiment: -1 to 1

  # 会话层 - 对话结束
  session:
    topics:
      - name: string
        weight: 0-1
        category: "career" | "relationship" | "health" | "growth"
    behavior_signals:
      - pattern: "seeking_validation" | "problem_solving" | "venting" | ...
        confidence: 0-1

  # 周期层 - 每日汇总
  periodic:
    archetype_shift:
      from: "creator" | "healer" | "pioneer" | ...
      to: string
      evidence: string[]
    journey_relevance:
      goal_id: string
      relevance_score: 0-1
      suggested_action: string
```

## 四、数据流向详解

### 4.1 → VibeID 原型更新

```
用户对话行为 → 行为信号抽取 → 原型匹配 → VibeID 演化

示例：
- 用户连续3次询问「如何影响他人」
- 抽取信号：leadership_seeking (0.85)
- 匹配原型：Pioneer 原型权重 +0.1
- VibeID 更新：主原型从 Healer 向 Pioneer 倾斜
```

### 4.2 → Journey 优先级调整

```
话题热度统计 → 目标相关性计算 → 优先级重排

示例：
- 用户本周80%对话关于「副业」
- 匹配 Journey 目标：「成为自由职业者」
- 优先级调整：该目标 priority +20%
- 推送建议：「你最近很关注副业，要不要聊聊进展？」
```

### 4.3 → 洞察卡片生成

```
多维数据融合 → 洞察生成 → 卡片渲染

示例：
- 八字：食神旺，适合表达创作
- 行为：最近频繁讨论写作
- 融合洞察：「你的命盘显示表达力强，而你最近也在践行写作，这是天赋与行动的合一」
```

### 4.4 → Proactive 触发

```
多源触发条件 → 优先级排序 → 推送决策

触发源：
1. 命盘运势（如今日适合沟通）
2. Journey 进度（如本周大石头剩余2个）
3. 情绪趋势（如连续3天情绪低落）
4. 行为模式（如用户习惯晚上10点聊天）

推送决策矩阵：
| 触发源 | 紧急度 | 个性化度 | 推送优先级 |
|--------|--------|----------|------------|
| 情绪低落 | 高 | 高 | P0 |
| Journey 进度 | 中 | 高 | P1 |
| 命盘运势 | 低 | 中 | P2 |
```

## 五、技术实现

### 5.1 Profile Extractor 扩展

```python
# apps/api/workers/profile_extractor.py

class IntelligentExtractor:
    """智能抽取器：从对话中学习"""

    async def extract_from_conversation(
        self,
        conversation_id: str,
        messages: List[Message]
    ) -> ExtractedData:
        """
        多维度抽取：
        1. 情绪分析
        2. 话题识别
        3. 行为模式识别
        4. 实体抽取
        """

    async def update_vibe_profile(
        self,
        user_id: str,
        extracted: ExtractedData
    ):
        """
        更新 VibeProfile：
        1. 原型权重调整
        2. 话题偏好更新
        3. 行为模式记录
        """

    async def generate_insights(
        self,
        user_id: str
    ) -> List[InsightCard]:
        """
        生成洞察卡片：
        融合 VibeID + 行为数据 + 命盘
        """
```

### 5.2 Proactive Trigger 扩展

```python
# apps/api/services/proactive/intelligent_trigger.py

class IntelligentTrigger:
    """智能触发器：基于抽取数据触发推送"""

    async def evaluate_triggers(
        self,
        user_id: str
    ) -> List[TriggerCandidate]:
        """
        评估所有触发条件：
        1. 情绪触发（低落关怀）
        2. 进度触发（Journey 提醒）
        3. 运势触发（命盘提示）
        4. 习惯触发（用户活跃时段）
        """

    async def prioritize_and_send(
        self,
        candidates: List[TriggerCandidate]
    ):
        """
        优先级排序 + 发送决策
        """
```

### 5.3 数据存储扩展

```sql
-- 新增表：extracted_signals
CREATE TABLE extracted_signals (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    conversation_id UUID,
    signal_type VARCHAR(50),  -- emotion, topic, behavior, entity
    signal_data JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 新增表：archetype_evolution
CREATE TABLE archetype_evolution (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    date DATE,
    archetype_weights JSONB,  -- {"creator": 0.3, "healer": 0.5, ...}
    evidence JSONB,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 新增表：intelligent_insights
CREATE TABLE intelligent_insights (
    id UUID PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    insight_type VARCHAR(50),  -- fusion, trend, milestone
    content TEXT,
    sources JSONB,  -- ["bazi", "behavior", "zodiac"]
    valid_until TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 六、Me/Journey 页面活化

### 6.1 Me 页面

```
┌─────────────────────────────────────────────────────────────────────┐
│                           ME 页面 v9                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  「融合洞察」卡片 - 每日刷新                                  │   │
│   │                                                             │   │
│   │  "你的八字食神旺盛，加上你最近频繁讨论写作，                  │   │
│   │   这说明表达创作是你当前的能量出口。"                        │   │
│   │                                                             │   │
│   │  来源: 八字 + 本周对话分析                                   │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  「原型演化」卡片 - 动态变化                                  │   │
│   │                                                             │   │
│   │  主原型: Healer (60%) → Pioneer (25%) → Creator (15%)       │   │
│   │                                                             │   │
│   │  近期变化: Pioneer +5% (因为你在探索领导力话题)              │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  「情绪轨迹」卡片 - 可视化                                    │   │
│   │                                                             │   │
│   │  [图表：近7天情绪曲线]                                       │   │
│   │                                                             │   │
│   │  洞察: 周三情绪最低，通常与工作压力相关                       │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 Journey 页面

```
┌─────────────────────────────────────────────────────────────────────┐
│                        JOURNEY 页面 v9                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  「智能排序」目标列表                                        │   │
│   │                                                             │   │
│   │  1. 🔥 成为自由职业者                                        │   │
│   │     热度: 本周80%对话相关 | 建议: 聊聊副业进展               │   │
│   │                                                             │   │
│   │  2. 📚 写一本书                                              │   │
│   │     热度: 本周15%对话相关 | 进度: 大纲完成                   │   │
│   │                                                             │   │
│   │  3. 💪 健康管理                                              │   │
│   │     热度: 本周5%对话相关 | 提醒: 已3天未讨论                 │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│   ┌─────────────────────────────────────────────────────────────┐   │
│   │  「本周大石头」进度追踪                                      │   │
│   │                                                             │   │
│   │  ✅ 完成副业方案初稿                                         │   │
│   │  ⬜ 联系3个潜在客户                                          │   │
│   │  ⬜ 更新个人作品集                                           │   │
│   │                                                             │   │
│   │  [基于对话自动识别进度]                                      │   │
│   └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 七、Proactive 推送策略

### 7.1 推送类型

| 类型 | 触发条件 | 推送内容示例 |
|------|----------|--------------|
| **情绪关怀** | 连续N天情绪低落 | "我注意到你最近似乎有些压力，要聊聊吗？" |
| **进度提醒** | Journey 目标停滞 | "你的副业目标本周还有2个大石头，现在是好时机" |
| **运势提示** | 命盘运势特殊 | "今天木星入相，适合沟通谈判" |
| **融合洞察** | 多源数据触发 | "你的八字显示今年财运旺，加上你最近在探索副业..." |
| **习惯提醒** | 用户活跃时段 | "你通常这个时候会和我聊聊，今天有什么想说的？" |

### 7.2 推送决策流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        推送决策流程                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   1. 触发条件检测                                                   │
│      │                                                             │
│      ▼                                                             │
│   2. 候选推送生成 (多个)                                            │
│      │                                                             │
│      ▼                                                             │
│   3. 优先级排序                                                     │
│      │  - 情绪关怀 > 进度提醒 > 运势提示                           │
│      │  - 个性化度高 > 通用                                        │
│      │  - 用户偏好匹配                                             │
│      ▼                                                             │
│   4. 频率控制                                                       │
│      │  - 每日最多3条                                              │
│      │  - 同类型间隔4小时                                          │
│      ▼                                                             │
│   5. 发送 + 记录                                                    │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 八、实施路线图

### Phase 1: 数据抽取基础 (Week 1-2)
- [ ] 扩展 profile_extractor 支持多维度抽取
- [ ] 新增 extracted_signals 表
- [ ] 实现实时/会话/周期三层抽取

### Phase 2: Me 页活化 (Week 3-4)
- [ ] 实现融合洞察生成
- [ ] 实现原型演化追踪
- [ ] Me 页前端卡片刷新

### Phase 3: Journey 页活化 (Week 5-6)
- [ ] 实现话题热度统计
- [ ] 实现目标优先级自动调整
- [ ] Journey 页前端智能排序

### Phase 4: Proactive 智能化 (Week 7-8)
- [ ] 实现多源触发检测
- [ ] 实现推送优先级排序
- [ ] 实现频率控制逻辑

---

## 附录：与现有系统的集成点

| 现有模块 | 集成方式 |
|----------|----------|
| CoreAgent | 对话结束时调用 Extractor |
| VibeProfile | 作为抽取数��的存储层 |
| Proactive Engine | 扩展触发源 |
| Me 页 API | 新增洞察卡片接口 |
| Journey 页 API | 新增智能排序接口 |
