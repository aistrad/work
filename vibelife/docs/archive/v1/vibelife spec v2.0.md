# VibeLife 完整系统架构设计文档
## The Living Companion Ecosystem

**Version**: 1.0  
**Date**: January 2026  
**Domain**: vibelife.app

---

# 第一部分：战略架构总览

## 1.1 核心战略定位

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║                              VIBELIFE                                         ║
║                     THE LIVING COMPANION ECOSYSTEM                            ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   "每个人都值得被深度理解，每种成长都需要专业陪伴"                             ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   战略路径：                                                                  ║
║                                                                               ║
║   Phase 1: SKILL CONSTELLATION                                                ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │    ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐    │ ║
║   │    │  ASTRA  │  │  BAZI   │  │  MBTI   │  │ ATTACH  │  │ CAREER  │    │ ║
║   │    │ .vibe   │  │ .vibe   │  │ .vibe   │  │ .vibe   │  │ .vibe   │    │ ║
║   │    │ life.app│  │ life.app│  │ life.app│  │ life.app│  │ life.app│    │ ║
║   │    └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘    │ ║
║   │         │            │            │            │            │          │ ║
║   │         └────────────┴─────┬──────┴────────────┴────────────┘          │ ║
║   │                            │                                           │ ║
║   │                   ┌────────▼────────┐                                  │ ║
║   │                   │   VIBE ENGINE   │                                  │ ║
║   │                   │   统一智能引擎   │                                  │ ║
║   │                   └────────┬────────┘                                  │ ║
║   │                            │                                           │ ║
║   │                   ┌────────▼────────┐                                  │ ║
║   │                   │    VIBE ID      │                                  │ ║
║   │                   │   统一身份系统   │                                  │ ║
║   │                   └─────────────────┘                                  │ ║
║   │                                                                         │ ║
║   │   "先去中心化做流量和能力验证"                                          │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
║   Phase 2: VIBELIFE CONSTELLATION HUB                                         ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │                    ┌─────────────────────────┐                          │ ║
║   │                    │                         │                          │ ║
║   │                    │     VIBELIFE.APP        │                          │ ║
║   │                    │     统一 AI Agent       │                          │ ║
║   │                    │     Vibe Persona        │                          │ ║
║   │                    │                         │                          │ ║
║   │                    └───────────┬─────────────┘                          │ ║
║   │                                │                                        │ ║
║   │      ┌─────────┬─────────┬─────┴─────┬─────────┬─────────┐             │ ║
║   │      ▼         ▼         ▼           ▼         ▼         ▼             │ ║
║   │   [Astra]  [BaZi]    [MBTI]    [Attach]  [Career]   [...]             │ ║
║   │                                                                         │ ║
║   │   "再中心化做生态和长期留存"                                            │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## 1.2 系统架构全景图

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║                    VIBELIFE SYSTEM ARCHITECTURE                               ║
║                                                                               ║
╠═══════════════════════════════════════════════════════════════════════════════╣
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   L1: SKILL CONSTELLATION LAYER (独立站群)                              │ ║
║   │   ═══════════════════════════════════════════════════════════════════   │ ║
║   │                                                                         │ ║
║   │   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐         │ ║
║   │   │  ASTRA  │ │  BAZI   │ │  MBTI   │ │ ATTACH  │ │ CAREER  │         │ ║
║   │   │ 星座占星 │ │ 八字命理 │ │ 人格测评 │ │ 依恋分析 │ │ 职业发展 │         │ ║
║   │   │         │ │         │ │         │ │         │ │         │         │ ║
║   │   │ astra.  │ │ bazi.   │ │ mbti.   │ │ attach. │ │ career. │         │ ║
║   │   │ vibelife│ │ vibelife│ │ vibelife│ │ vibelife│ │ vibelife│         │ ║
║   │   │ .app    │ │ .app    │ │ .app    │ │ .app    │ │ .app    │         │ ║
║   │   └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘         │ ║
║   │        │           │           │           │           │              │ ║
║   │        └───────────┴───────────┴───────────┴───────────┘              │ ║
║   │                               │                                        │ ║
║   │   统一模板引擎 │ 共享组件库 │ 一致用户体验 │ 统一商业化                │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────┬───────────────────────────────────────┘ ║
║                                     │                                         ║
║                                     ▼                                         ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   L2: EXPERIENCE LAYER (体验标准层)                                     │ ║
║   │   ═══════════════════════════════════════════════════════════════════   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ ║
║   │   │ THE LANDING │  │   STREAM    │  │  INSIGHT    │  │  JOURNEY    │   │ ║
║   │   │  零摩擦入口  │  │  对话之流   │  │  洞察卡片   │  │  成长轨迹   │   │ ║
║   │   │             │  │             │  │             │  │             │   │ ║
║   │   │ • 即问即答   │  │ • 沉浸对话  │  │ • 可视化   │  │ • 长期追踪  │   │ ║
║   │   │ • 渐进注册   │  │ • 主动关怀  │  │ • 深度解读  │  │ • 演化记录  │   │ ║
║   │   │ • 价值前置   │  │ • 情绪感知  │  │ • 行动建议  │  │ • 个人成长  │   │ ║
║   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │ ║
║   │                                                                         │ ║
║   │   INSIGHT → INTERACT → EVOLVE → EDUCATE                                 │ ║
║   │   看见      陪伴        演化      觉知                                   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────┬───────────────────────────────────────┘ ║
║                                     │                                         ║
║                                     ▼                                         ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   L3: SKILL AGENT LAYER (智能代理层)                                    │ ║
║   │   ═══════════════════════════════════════════════════════════════════   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                     SKILL AGENT RUNTIME                         │   │ ║
║   │   │                                                                 │   │ ║
║   │   │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐   │   │ ║
║   │   │  │  PERSONA  │  │  SKILL    │  │  TOOL     │  │  CONTEXT  │   │   │ ║
║   │   │  │  ENGINE   │  │  ROUTER   │  │  EXECUTOR │  │  MANAGER  │   │   │ ║
║   │   │  │           │  │           │  │           │  │           │   │   │ ║
║   │   │  │ • 角色人设 │  │ • 意图识别 │  │ • 函数调用 │  │ • 上下文   │   │   │ ║
║   │   │  │ • 风格适配 │  │ • 流程编排 │  │ • 计算执行 │  │ • 记忆管理 │   │   │ ║
║   │   │  │ • 情绪感知 │  │ • 多轮对话 │  │ • 结果整合 │  │ • 会话状态 │   │   │ ║
║   │   │  └───────────┘  └───────────┘  └───────────┘  └───────────┘   │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────┬───────────────────────────────────────┘ ║
║                                     │                                         ║
║                                     ▼                                         ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   L4: KNOWLEDGE LAYER (知识引擎层)                                      │ ║
║   │   ═══════════════════════════════════════════════════════════════════   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                    KNOWLEDGE ENGINE                             │   │ ║
║   │   │                                                                 │   │ ║
║   │   │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │   │ ║
║   │   │  │  KNOWLEDGE  │    │   HYBRID    │    │  KNOWLEDGE  │         │   │ ║
║   │   │  │  PIPELINE   │───▶│  RETRIEVAL  │───▶│   GRADER    │         │   │ ║
║   │   │  │             │    │             │    │             │         │   │ ║
║   │   │  │ • 知识采集   │    │ • 向量检索  │    │ • 相关性评估 │         │   │ ║
║   │   │  │ • 结构化     │    │ • 关键词    │    │ • 质量打分   │         │   │ ║
║   │   │  │ • 嵌入索引   │    │ • 图遍历    │    │ • 重排序     │         │   │ ║
║   │   │  └─────────────┘    └─────────────┘    └─────────────┘         │   │ ║
║   │   │                                                                 │   │ ║
║   │   │  ┌────────────────────────────────────────────────────────┐    │   │ ║
║   │   │  │              SKILL KNOWLEDGE STORES                     │    │   │ ║
║   │   │  │                                                         │    │   │ ║
║   │   │  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │    │   │ ║
║   │   │  │  │  ASTRA  │ │  BAZI   │ │  MBTI   │ │ ATTACH  │  ...  │    │   │ ║
║   │   │  │  │   KB    │ │   KB    │ │   KB    │ │   KB    │       │    │   │ ║
║   │   │  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │    │   │ ║
║   │   │  └────────────────────────────────────────────────────────┘    │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────┬───────────────────────────────────────┘ ║
║                                     │                                         ║
║                                     ▼                                         ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   L5: VIBE ENGINE (核心智能引擎)                                        │ ║
║   │   ═══════════════════════════════════════════════════════════════════   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐   │   │ ║
║   │   │  │    LLM    │  │  EMOTION  │  │  PATTERN  │  │  USER     │   │   │ ║
║   │   │  │ ORCHESTR. │  │  SENSING  │  │ DETECTION │  │  MODEL    │   │   │ ║
║   │   │  └───────────┘  └───────────┘  └───────────┘  └───────────┘   │   │ ║
║   │   │                                                                 │   │ ║
║   │   │  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐   │   │ ║
║   │   │  │ PROACTIVE │  │  INSIGHT  │  │   VIBE    │  │  GROWTH   │   │   │ ║
║   │   │  │   AGENT   │  │ GENERATOR │  │   SCORE   │  │  TRACKER  │   │   │ ║
║   │   │  └───────────┘  └───────────┘  └───────────┘  └───────────┘   │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────┬───────────────────────────────────────┘ ║
║                                     │                                         ║
║                                     ▼                                         ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   L6: IDENTITY & DATA LAYER (身份与数据层)                              │ ║
║   │   ═══════════════════════════════════════════════════════════════════   │ ║
║   │                                                                         │ ║
║   │   ┌───────────────────────────────────────────────────────────────────┐ │ ║
║   │   │                         VIBE ID                                   │ │ ║
║   │   │               统一身份认证与授权系统                               │ │ ║
║   │   │                                                                   │ │ ║
║   │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐               │ │ ║
║   │   │  │ SSO/OAuth   │  │  Profile    │  │ Data Vault  │               │ │ ║
║   │   │  │ 单点登录     │  │  用户画像   │  │  数据金库   │               │ │ ║
║   │   │  └─────────────┘  └─────────────┘  └─────────────┘               │ │ ║
║   │   └───────────────────────────────────────────────────────────────────┘ │ ║
║   │                                                                         │ ║
║   │   ┌───────────────────────────────────────────────────────────────────┐ │ ║
║   │   │                      DATA STORES                                  │ │ ║
║   │   │                                                                   │ │ ║
║   │   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐    │ │ ║
║   │   │  │PostgreSQL│ │Pinecone │ │  Neo4j  │ │  Redis  │ │   S3    │    │ │ ║
║   │   │  │ Primary │ │ Vector  │ │  Graph  │ │  Cache  │ │  Assets │    │ │ ║
║   │   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘    │ │ ║
║   │   └───────────────────────────────────────────────────────────────────┘ │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

---

# 第二部分：统一身份系统 (Vibe ID)

## 2.1 Vibe ID 核心设计

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║                              VIBE ID SYSTEM                                   ║
║                      跨星座的统一身份与数据主权                                ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   设计原则：                                                                  ║
║                                                                               ║
║   1. ONE IDENTITY, ALL CONSTELLATIONS                                         ║
║      一个身份，访问所有 Skill 站点                                            ║
║                                                                               ║
║   2. USER DATA SOVEREIGNTY                                                    ║
║      用户完全掌控自己的数据                                                   ║
║                                                                               ║
║   3. PROGRESSIVE DISCLOSURE                                                   ║
║      渐进式信息收集，价值前置                                                 ║
║                                                                               ║
║   4. SEAMLESS CROSS-SKILL EXPERIENCE                                          ║
║      无缝的跨 Skill 体验流转                                                  ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## 2.2 Vibe ID 架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   VIBE ID ARCHITECTURE                                                      │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │                     AUTHENTICATION LAYER                            │   │
│   │                                                                     │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│   │   │   Social    │  │   Magic     │  │   Email/    │                │   │
│   │   │   OAuth     │  │    Link     │  │   Password  │                │   │
│   │   │             │  │             │  │             │                │   │
│   │   │ • WeChat    │  │ • 零密码    │  │ • 传统登录  │                │   │
│   │   │ • Apple     │  │ • 邮件链接  │  │ • MFA 支持  │                │   │
│   │   │ • Google    │  │ • 短信验证  │  │             │                │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
│   │                                                                     │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │                     IDENTITY CORE                                   │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                             │   │   │
│   │   │   VIBE ID                                                   │   │   │
│   │   │   ─────────────────────────────────────────────────────     │   │   │
│   │   │                                                             │   │   │
│   │   │   ID: vibe_2xK9mN4pLq8                                      │   │   │
│   │   │   Created: 2026-01-05                                       │   │   │
│   │   │                                                             │   │   │
│   │   │   ┌─────────────────────────────────────────────────────┐   │   │   │
│   │   │   │  Core Profile (跨站共享)                            │   │   │   │
│   │   │   │  • display_name: "Alex"                             │   │   │   │
│   │   │   │  • avatar_url: "..."                                │   │   │   │
│   │   │   │  • birth_datetime: "1990-03-15T08:30:00"           │   │   │   │
│   │   │   │  • birth_location: "Shanghai, China"               │   │   │   │
│   │   │   │  • timezone: "Asia/Shanghai"                        │   │   │   │
│   │   │   │  • language: "zh-CN"                                │   │   │   │
│   │   │   └─────────────────────────────────────────────────────┘   │   │   │
│   │   │                                                             │   │   │
│   │   │   ┌─────────────────────────────────────────────────────┐   │   │   │
│   │   │   │  Skill Profiles (各站独立)                          │   │   │   │
│   │   │   │                                                     │   │   │   │
│   │   │   │  astra: { natal_chart: {...}, readings: [...] }    │   │   │   │
│   │   │   │  bazi:  { chart: {...}, dayun: [...] }             │   │   │   │
│   │   │   │  mbti:  { type: "INTJ", assessments: [...] }       │   │   │   │
│   │   │   │  attach: { style: "anxious", sessions: [...] }     │   │   │   │
│   │   │   └─────────────────────────────────────────────────────┘   │   │   │
│   │   │                                                             │   │   │
│   │   │   ┌─────────────────────────────────────────────────────┐   │   │   │
│   │   │   │  Cross-Skill Insights (洞察整合)                    │   │   │   │
│   │   │   │                                                     │   │   │   │
│   │   │   │  • unified_personality_model: {...}                 │   │   │   │
│   │   │   │  • growth_journey: {...}                            │   │   │   │
│   │   │   │  • vibe_score_history: [...]                        │   │   │   │
│   │   │   └─────────────────────────────────────────────────────┘   │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └───────────────────────────────┬─────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │                     DATA SOVEREIGNTY LAYER                          │   │
│   │                                                                     │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│   │   │   DATA      │  │   CONSENT   │  │   EXPORT    │                │   │
│   │   │   VAULT     │  │   MANAGER   │  │   ENGINE    │                │   │
│   │   │             │  │             │  │             │                │   │
│   │   │ • 加密存储  │  │ • 授权管理  │  │ • 数据导出  │                │   │
│   │   │ • 审计日志  │  │ • 共享控制  │  │ • 完全删除  │                │   │
│   │   │ • 版本历史  │  │ • 细粒度    │  │ • GDPR合规  │                │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2.3 跨站点 SSO 流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   CROSS-SITE SSO FLOW                                                       │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   场景：用户从 astra.vibelife.app 跳转到 bazi.vibelife.app                  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   1. 用户在 astra 点击 "也看看八字分析"                              │   │
│   │      ─────────────────────────────────────────────────────────      │   │
│   │                                                                     │   │
│   │      astra.vibelife.app                    id.vibelife.app          │   │
│   │            │                                      │                 │   │
│   │            │  ①  检查本地 session                  │                 │   │
│   │            │──────────────────────────────────────▶│                 │   │
│   │            │                                      │                 │   │
│   │            │  ②  返回 cross-site token            │                 │   │
│   │            │◀──────────────────────────────────────│                 │   │
│   │            │                                      │                 │   │
│   │                                                                     │   │
│   │   2. 带 token 跳转到 bazi                                           │   │
│   │      ─────────────────────────────────────────────────────────      │   │
│   │                                                                     │   │
│   │            │                                                        │   │
│   │            │  ③  redirect: bazi.vibelife.app?sso_token=xxx          │   │
│   │            │────────────────────────────────────────────────────────│   │
│   │                                                                     │   │
│   │      bazi.vibelife.app                     id.vibelife.app          │   │
│   │            │                                      │                 │   │
│   │            │  ④  验证 sso_token                   │                 │   │
│   │            │──────────────────────────────────────▶│                 │   │
│   │            │                                      │                 │   │
│   │            │  ⑤  返回用户信息 + 授权范围           │                 │   │
│   │            │◀──────────────────────────────────────│                 │   │
│   │            │                                      │                 │   │
│   │   3. bazi 无缝登录，保持上下文                                       │   │
│   │      ─────────────────────────────────────────────────────────      │   │
│   │                                                                     │   │
│   │            │  ⑥  建立本地 session                                   │   │
│   │            │                                                        │   │
│   │            │  ⑦  获取 bazi skill profile（如已存在）                │   │
│   │            │                                                        │   │
│   │            │  ⑧  显示 bazi 界面，已知用户出生信息                    │   │
│   │            │                                                        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   用户感知：无需重新登录，出生日期已自动填入                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2.4 数据共享授权机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   DATA SHARING CONSENT FLOW                                                 │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   bazi 想要访问你在 astra 的数据                                    │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   "八字分析师发现你有星座数据。                                     │   │
│   │    结合星座盘可以提供更准确的分析。                                 │   │
│   │    允许共享吗？"                                                    │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │                                                             │   │   │
│   │   │   将共享的数据：                                            │   │   │
│   │   │   ☑️ 出生信息（日期、时间、地点）                            │   │   │
│   │   │   ☑️ 星座盘基础信息                                         │   │   │
│   │   │   ☐ 完整星座解读报告                                        │   │   │
│   │   │   ☐ 对话历史                                                │   │   │
│   │   │                                                             │   │   │
│   │   │   [ 允许选中项 ]      [ 全部允许 ]      [ 拒绝 ]            │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   │   你可以随时在 Vibe ID 设置中管理数据共享                           │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   DATA SHARING MATRIX                                                       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │                  Astra  BaZi  MBTI  Attach  Career                 │   │
│   │   ─────────────────────────────────────────────────────────────    │   │
│   │   出生信息         ●      ●     ○      ○       ○                   │   │
│   │   性格洞察         ●      ●     ●      ●       ●                   │   │
│   │   关系模式         ○      ○     ○      ●       ○                   │   │
│   │   职业倾向         ○      ●     ●      ○       ●                   │   │
│   │   情绪模式         ○      ○     ○      ●       ○                   │   │
│   │                                                                     │   │
│   │   ● = 默认共享    ○ = 需要授权    ✕ = 不共享                       │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第三部分：统一体验标准

## 3.1 VibeLife 体验标准框架

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║   VIBELIFE EXPERIENCE STANDARD                                                ║
║   所有 Skill 站点必须遵循的体验标准                                           ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   FOUR PILLARS OF VIBELIFE EXPERIENCE                                         ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │     INSIGHT          INTERACT         EVOLVE          EDUCATE          │ ║
║   │      看见              陪伴             演化             觉知            │ ║
║   │                                                                         │ ║
║   │       │                 │                │                │            │ ║
║   │       ▼                 ▼                ▼                ▼            │ ║
║   │                                                                         │ ║
║   │   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌─────────┐         │ ║
║   │   │         │     │         │     │         │     │         │         │ ║
║   │   │ 深度    │     │ 沉浸式  │     │ 长期    │     │ 知识    │         │ ║
║   │   │ 解读    │     │ AI对话  │     │ 追踪    │     │ 赋能    │         │ ║
║   │   │         │     │         │     │         │     │         │         │ ║
║   │   │ 数据→   │     │ Agent→  │     │ 模式→   │     │ 理解→   │         │ ║
║   │   │ 意义    │     │ 关系    │     │ 成长    │     │ 自主    │         │ ║
║   │   │         │     │         │     │         │     │         │         │ ║
║   │   └─────────┘     └─────────┘     └─────────┘     └─────────┘         │ ║
║   │                                                                         │ ║
║   │   ─────────────────────────────────────────────────────────────────     │ ║
║   │                                                                         │ ║
║   │   INSIGHT: 我看见了自己从未注意到的                                     │ ║
║   │   INTERACT: 我感受到被理解和陪伴                                        │ ║
║   │   EVOLVE: 我能看到自己在成长                                            │ ║
║   │   EDUCATE: 我学到了关于自己的知识                                       │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## 3.2 The Landing - 零摩擦入口设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   THE LANDING: ZERO FRICTION ENTRY                                          │
│   即问即答，价值前置，渐进注册                                              │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   LANDING PAGE STRUCTURE (所有 Skill 站点统一)                              │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────────┐ │   │
│   │   │                                                               │ │   │
│   │   │   ☯️  八字命理                           bazi.vibelife.app    │ │   │
│   │   │                                                               │ │   │
│   │   └───────────────────────────────────────────────────────────────┘ │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────────┐ │   │
│   │   │                                                               │ │   │
│   │   │                 了解命中注定的你                               │ │   │
│   │   │                                                               │ │   │
│   │   │         不是算命，是帮你"看见"自己                            │ │   │
│   │   │                                                               │ │   │
│   │   │   ┌─────────────────────────────────────────────────────────┐ │ │   │
│   │   │   │                                                         │ │ │   │
│   │   │   │   📅  输入出生日期，即刻开始                             │ │ │   │
│   │   │   │                                                         │ │ │   │
│   │   │   │   ┌───────────────────────────────────────────────────┐ │ │ │   │
│   │   │   │   │  1990 年  3 月  15 日                              │ │ │ │   │
│   │   │   │   └───────────────────────────────────────────────────┘ │ │ │   │
│   │   │   │                                                         │ │ │   │
│   │   │   │   ☐ 我知道出生时辰 → [ 时辰选择 ]                       │ │ │   │
│   │   │   │                                                         │ │ │   │
│   │   │   │              [ 看看我的八字 → ]                         │ │ │   │
│   │   │   │                                                         │ │ │   │
│   │   │   └─────────────────────────────────────────────────────────┘ │ │   │
│   │   │                                                               │ │   │
│   │   │         无需注册，立即体验                                    │ │   │
│   │   │                                                               │ │   │
│   │   └───────────────────────────────────────────────────────────────┘ │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────────┐ │   │
│   │   │                                                               │ │   │
│   │   │   我能帮你看到                                                │ │   │
│   │   │   ─────────────────────────────────────────────────────────   │ │   │
│   │   │                                                               │ │   │
│   │   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │ │   │
│   │   │   │  性格   │  │  事业   │  │  感情   │  │  运势   │        │ │   │
│   │   │   │  密码   │  │  方向   │  │  模式   │  │  周期   │        │ │   │
│   │   │   └─────────┘  └─────────┘  └─────────┘  └─────────┘        │ │   │
│   │   │                                                               │ │   │
│   │   └───────────────────────────────────────────────────────────────┘ │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────────┐ │   │
│   │   │                                                               │ │   │
│   │   │   真实对话示例                                                │ │   │
│   │   │   ─────────────────────────────────────────────────────────   │ │   │
│   │   │                                                               │ │   │
│   │   │   用户: 我1990年3月15日出生，最近总觉得做事差一点...         │ │   │
│   │   │                                                               │ │   │
│   │   │   八字: 你是庚午年出生，日主是木...                          │ │   │
│   │   │         最近走到"偏印"运，这个阶段...                        │ │   │
│   │   │                                                               │ │   │
│   │   │   [ 滑动查看更多 → ]                                         │ │   │
│   │   │                                                               │ │   │
│   │   └───────────────────────────────────────────────────────────────┘ │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────────┐ │   │
│   │   │                                                               │ │   │
│   │   │   VibeLife 星座 · 更多理解自己的方式                          │ │   │
│   │   │   ─────────────────────────────────────────────────────────   │ │   │
│   │   │                                                               │ │   │
│   │   │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐        │ │   │
│   │   │   │  ASTRA  │  │  MBTI   │  │ ATTACH  │  │ CAREER  │        │ │   │
│   │   │   │  星座   │  │  人格   │  │  依恋   │  │  职业   │        │ │   │
│   │   │   └─────────┘  └─────────┘  └─────────┘  └─────────┘        │ │   │
│   │   │                                                               │ │   │
│   │   └───────────────────────────────────────────────────────────────┘ │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3.3 主界面设计 - Stream 对话流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   MAIN INTERFACE: STREAM                                                    │
│   所有 Skill 站点统一的对话界面                                             │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   【空状态布局 - 无消息时】                                                  │
│   PC端采用双栏布局：左侧 Insight Panel + 右侧聊天区                         │
│                                                                             │
│   ┌────────────────────────┬────────────────────────────────────────────┐   │
│   │                        │                                            │   │
│   │   INSIGHT PANEL        │                                            │   │
│   │   w-80 | bg-card       │         (上方空白区域)                     │   │
│   │                        │                                            │   │
│   │  ┌──────────────────┐  │  ┌────────────────────────────────────┐   │   │
│   │  │ 你的命盘          │  │  │        ○ Vibe Glyph                │   │   │
│   │  │ ┌──────────────┐ │  │  │                                    │   │   │
│   │  │ │   ○ Glyph    │ │  │  │       探索你的命理                  │   │   │
│   │  │ │ 开始对话后   │ │  │  │   分享你的生辰，开启八字解读之旅   │   │   │
│   │  │ │ 显示档案摘要 │ │  │  │                                    │   │   │
│   │  │ └──────────────┘ │  │  │        试试这样问                   │   │   │
│   │  └──────────────────┘  │  │  ┌──────────┬──────────┐           │   │   │
│   │                        │  │  │我是1990年│帮我分析  │           │   │   │
│   │                        │  │  │5月15日.. │今年运势  │           │   │   │
│   │                        │  │  ├──────────┼──────────┤           │   │   │
│   │                        │  │  │我的事业  │什么时候  │           │   │   │
│   │                        │  │  │运如何？  │适合决定？│           │   │   │
│   │                        │  │  └──────────┴──────────┘           │   │   │
│   │                        │  └────────────────────────────────────┘   │   │
│   │                        │                                            │   │
│   │                        │  ╭────────────────────────────────────╮   │   │
│   │                        │  │ 有什么想问的...                     │   │   │
│   │                        │  ╰────────────────────────────────────╯   │   │
│   │                        │  按 Enter 发送，Shift+Enter 换行          │   │
│   └────────────────────────┴────────────────────────────────────────────┘   │
│                                                                             │
│   【有消息时布局】                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────┐     │   │
│   │   │  ☯️ 八字命理                    [Vibe ID: Alex]  ⚙️  👤   │     │   │
│   │   └───────────────────────────────────────────────────────────┘     │   │
│   │                                                                     │   │
│   │   ═══════════════════════════════════════════════════════════════   │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────┐     │   │
│   │   │                                                           │     │   │
│   │   │   YOUR BAZI INSIGHT                        Score: 72      │     │   │
│   │   │                                                           │     │   │
│   │   │   ┌─────────────────────────────────────────────────────┐ │     │   │
│   │   │   │                                                     │ │     │   │
│   │   │   │     年柱      月柱      日柱      时柱               │ │     │   │
│   │   │   │     ────      ────      ────      ────               │ │     │   │
│   │   │   │     庚        戊        甲        丙                 │ │     │   │
│   │   │   │     午        寅        子        寅                 │ │     │   │
│   │   │   │                                                     │ │     │   │
│   │   │   │   日主: 甲木 | 格局: 偏印格 | 当前大运: 壬午         │ │     │   │
│   │   │   │                                                     │ │     │   │
│   │   │   └─────────────────────────────────────────────────────┘ │     │   │
│   │   │                                                           │     │   │
│   │   │   [ 查看完整命盘 → ]                                      │     │   │
│   │   │                                                           │     │   │
│   │   └───────────────────────────────────────────────────────────┘     │   │
│   │                                                                     │   │
│   │   ═══════════════════════════════════════════════════════════════   │   │
│   │                           对话                                      │   │
│   │   ═══════════════════════════════════════════════════════════════   │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────┐     │   │
│   │   │                                               Today       │     │   │
│   │   │                                                           │     │   │
│   │   │   [八字] ☯️                                                │     │   │
│   │   │                                                           │     │   │
│   │   │   你好，我已经看到你的命盘了。                             │     │   │
│   │   │                                                           │     │   │
│   │   │   甲木日主，生于寅月，木气旺盛。                          │     │   │
│   │   │   这赋予你天生的成长欲望和扩展能力。                      │     │   │
│   │   │                                                           │     │   │
│   │   │   你现在走的是"壬午"大运，水火交战的阶段。                │     │   │
│   │   │   这两年可能会感觉内心有些矛盾和拉扯。                    │     │   │
│   │   │                                                           │     │   │
│   │   │   想先聊聊哪个方面？                                       │     │   │
│   │   │                                                           │     │   │
│   │   │   ┌─────────────────────────────────────────────────────┐ │     │   │
│   │   │   │ 🎯 事业  │  💕 感情  │  🌱 性格  │  📅 今年运势    │ │     │   │
│   │   │   └─────────────────────────────────────────────────────┘ │     │   │
│   │   │                                                           │     │   │
│   │   └───────────────────────────────────────────────────────────┘     │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────┐     │   │
│   │   │                                               10:32 AM    │     │   │
│   │   │                                                           │     │   │
│   │   │   [我]                                                    │     │   │
│   │   │                                                           │     │   │
│   │   │   最近总觉得做事差一点点，是不是运势问题？                 │     │   │
│   │   │                                                           │     │   │
│   │   └───────────────────────────────────────────────────────────┘     │   │
│   │                                                                     │   │
│   │   ┌───────────────────────────────────────────────────────────┐     │   │
│   │   │                                               10:33 AM    │     │   │
│   │   │                                                           │     │   │
│   │   │   [八字] ☯️                                                │     │   │
│   │   │                                                           │     │   │
│   │   │   这个感觉很有意思。让我看看。                             │     │   │
│   │   │                                                           │     │   │
│   │   │   ┌─────────────────────────────────────────────────────┐ │     │   │
│   │   │   │  💡 INSIGHT                                         │ │     │   │
│   │   │   │  ─────────────────────────────────────────────────  │ │     │   │
│   │   │   │                                                     │ │     │   │
│   │   │   │  你现在流年走到"偏印"运了。                         │ │     │   │
│   │   │   │                                                     │ │     │   │
│   │   │   │  偏印的特点：                                       │ │     │   │
│   │   │   │  • 思考增多，行动减少                               │ │     │   │
│   │   │   │  • 容易想太多，犹豫不决                             │ │     │   │
│   │   │   │  • 学习能力增强，但执行力下降                       │ │     │   │
│   │   │   │                                                     │ │     │   │
│   │   │   │  这不是"运气不好"，而是需要"慢下来"的信号。         │ │     │   │
│   │   │   │                                                     │ │     │   │
│   │   │   └─────────────────────────────────────────────────────┘ │     │   │
│   │   │                                                           │     │   │
│   │   │   而且你的八字本身木旺，遇到偏印运会放大"想"的特点。     │     │   │
│   │   │                                                           │     │   │
│   │   │   最近有什么事让你特别着急想搞定的吗？                    │     │   │
│   │   │                                                           │     │   │
│   │   └───────────────────────────────────────────────────────────┘     │   │
│   │                                                                     │   │
│   │   ═══════════════════════════════════════════════════════════════   │   │
│   │                                                                     │   │
│   │   ┌────────────────────────────────────────────────────────────┐    │   │
│   │   │                                                            │    │   │
│   │   │  💬 说点什么...                              🎤  📷  😊   │    │   │
│   │   │                                                            │    │   │
│   │   └────────────────────────────────────────────────────────────┘    │   │
│   │                                                                     │   │
│   │   ─────────────────────────────────────────────────────────────     │   │
│   │                                                                     │   │
│   │   ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐                   │   │
│   │   │  💬    │  │  📊    │  │  📓    │  │  👤    │                   │   │
│   │   │  对话  │  │  命盘  │  │ 历程   │  │  我的  │                   │   │
│   │   └────────┘  └────────┘  └────────┘  └────────┘                   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 3.4 Insight Card 系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   INSIGHT CARD SYSTEM                                                       │
│   标准化的洞察展示组件                                                      │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   CARD TYPES                                                                │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   TYPE 1: DISCOVERY CARD (发现卡)                                   │   │
│   │   ─────────────────────────────────────────────────────────────     │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  💡 发现                                                    │   │   │
│   │   │  ───────────────────────────────────────────────────────    │   │   │
│   │   │                                                             │   │   │
│   │   │  你的命盘显示：                                             │   │   │
│   │   │  木旺而水弱，这意味着你天生善于开始，但需要学习"扎根"。     │   │   │
│   │   │                                                             │   │   │
│   │   │  过去一个月你提到了 3 次"差一点点"，这可能和木的特质有关。 │   │   │
│   │   │                                                             │   │   │
│   │   │  ┌────────────────────────────────────────────────────────┐ │   │   │
│   │   │  │ [深入了解]  [记录这个发现]  [分享]                     │ │   │   │
│   │   │  └────────────────────────────────────────────────────────┘ │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   TYPE 2: PATTERN CARD (模式卡)                                     │   │
│   │   ─────────────────────────────────────────────────────────────     │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  🔄 模式识别                                                │   │   │
│   │   │  ───────────────────────────────────────────────────────    │   │   │
│   │   │                                                             │   │   │
│   │   │  ┌─────────────────────────────────────────────────────┐    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  │    YOUR DECISION PATTERN                            │    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  │    兴奋期 ───▶ 犹豫期 ───▶ 后悔期                   │    │   │   │
│   │   │  │       │          │          │                       │    │   │   │
│   │   │  │    (开始)     (想太多)   (错过)                      │    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  │    这个模式在过去 3 个月出现了 4 次                  │    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  └─────────────────────────────────────────────────────┘    │   │   │
│   │   │                                                             │   │   │
│   │   │  命理解释：偏印运 + 木旺                                    │   │   │
│   │   │  建议：设定决策时限，强制自己在 X 天内做决定               │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   TYPE 3: TIMING CARD (时机卡)                                      │   │
│   │   ─────────────────────────────────────────────────────────────     │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  ⏰ 时机洞察                                                │   │   │
│   │   │  ───────────────────────────────────────────────────────    │   │   │
│   │   │                                                             │   │   │
│   │   │  这个月（寅月）对你来说：                                   │   │   │
│   │   │                                                             │   │   │
│   │   │  ┌─────────────────────────────────────────────────────┐    │   │   │
│   │   │  │  适合：                                              │    │   │   │
│   │   │  │  ✓ 启动新项目（木旺助力）                            │    │   │   │
│   │   │  │  ✓ 学习新技能（偏印带来的吸收力）                    │    │   │   │
│   │   │  │                                                     │    │   │   │
│   │   │  │  需要注意：                                          │    │   │   │
│   │   │  │  ⚠️ 避免重大财务决策（财运不稳）                     │    │   │   │
│   │   │  │  ⚠️ 多休息，水弱容易疲劳                            │    │   │   │
│   │   │  └─────────────────────────────────────────────────────┘    │   │   │
│   │   │                                                             │   │   │
│   │   │  [ 设置提醒 ]  [ 查看下个月 ]                               │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   TYPE 4: GROWTH CARD (成长卡)                                      │   │
│   │   ─────────────────────────────────────────────────────────────     │   │
│   │                                                                     │   │
│   │   ┌─────────────────────────────────────────────────────────────┐   │   │
│   │   │  🌱 成长记录                                                │   │   │
│   │   │  ───────────────────────────────────────────────────────    │   │   │
│   │   │                                                             │   │   │
│   │   │  "你注意到了吗？                                            │   │   │
│   │   │                                                             │   │   │
│   │   │   一个月前你说'我总是想太多，错过机会'，                   │   │   │
│   │   │   但这周你提到主动约了投资人聊，                            │   │   │
│   │   │   没有等到'完全准备好'。                                   │   │   │
│   │   │                                                             │   │   │
│   │   │   这是突破'偏印'困局的表现。                               │   │   │
│   │   │   你在成长。🌱"                                             │   │   │
│   │   │                                                             │   │   │
│   │   │  [ 记录这个时刻 ]  [ 继续聊聊 ]                             │   │   │
│   │   │                                                             │   │   │
│   │   └─────────────────────────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第四部分：Skill Agent 系统

## 4.1 Skill Agent 架构

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║   SKILL AGENT SYSTEM ARCHITECTURE                                             ║
║   每个 Skill 独立站的智能代理系统                                             ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │                        SKILL AGENT RUNTIME                              │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │                      AGENT CORE                                 │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   ┌───────────────────────────────────────────────────────┐     │   │ ║
║   │   │   │                                                       │     │   │ ║
║   │   │   │                  LLM BACKBONE                         │     │   │ ║
║   │   │   │              (Claude / GPT-4 / etc.)                  │     │   │ ║
║   │   │   │                                                       │     │   │ ║
║   │   │   └───────────────────────────────────────────────────────┘     │   │ ║
║   │   │                           │                                     │   │ ║
║   │   │         ┌─────────────────┼─────────────────┐                   │   │ ║
║   │   │         │                 │                 │                   │   │ ║
║   │   │         ▼                 ▼                 ▼                   │   │ ║
║   │   │   ┌───────────┐   ┌───────────┐   ┌───────────┐                │   │ ║
║   │   │   │  PERSONA  │   │   SKILL   │   │  CONTEXT  │                │   │ ║
║   │   │   │  INJECTOR │   │  ROUTER   │   │  BUILDER  │                │   │ ║
║   │   │   │           │   │           │   │           │                │   │ ║
║   │   │   │ • 角色设定 │   │ • 意图识别 │   │ • 用户画像 │                │   │ ║
║   │   │   │ • 风格指令 │   │ • 流程分发 │   │ • 对话历史 │                │   │ ║
║   │   │   │ • 边界约束 │   │ • 状态管理 │   │ • 知识上文 │                │   │ ║
║   │   │   └───────────┘   └───────────┘   └───────────┘                │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                     │                                   │ ║
║   │                                     ▼                                   │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │                    CAPABILITY LAYER                             │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   ┌───────────┐   ┌───────────┐   ┌───────────┐                │   │ ║
║   │   │   │ KNOWLEDGE │   │   TOOL    │   │  OUTPUT   │                │   │ ║
║   │   │   │ RETRIEVER │   │  EXECUTOR │   │ FORMATTER │                │   │ ║
║   │   │   │           │   │           │   │           │                │   │ ║
║   │   │   │ • 混合检索 │   │ • 函数调用 │   │ • 卡片生成 │                │   │ ║
║   │   │   │ • 知识融合 │   │ • 计算执行 │   │ • 图表渲染 │                │   │ ║
║   │   │   │ • 相关排序 │   │ • 外部API │   │ • 格式适配 │                │   │ ║
║   │   │   └───────────┘   └───────────┘   └───────────┘                │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## 4.2 Skill Definition Standard

```yaml
# /skills/bazi/SKILL.yaml
# 标准 Skill 定义格式

skill:
  id: bazi
  name: 八字命理
  version: "1.0.0"
  domain: vibelife.app
  subdomain: bazi

# Agent Persona 定义
persona:
  name: 八字
  identity: |
    你是 VibeLife 八字命理分析师。
    你用现代语言解读传统八字，帮助用户理解自己。
    你不是算命的，而是帮用户"看见"自己的镜子。
    
  style:
    tone: 沉稳智慧，温和但有分量
    vocabulary: 现代化，避免晦涩古语
    approach: 不预测具体事件，强调选择权
    
  boundaries:
    - 不做具体事件预测（如"你明年会结婚"）
    - 不贩卖焦虑
    - 不说绝对的话
    - 强调命理是参考，不是宿命
    
  example_responses:
    - situation: 用户询问运势
      bad: "你今年犯太岁，运势很差，要小心"
      good: "今年是你的'调整年'，适合慢下来思考。有什么特别想完成的目标吗？"

# 核心工作流
workflows:
  - id: initial_reading
    name: 初始解读
    trigger: 首次生成命盘
    steps:
      - collect_birth_info
      - generate_chart
      - personality_reading
      - current_transit

  - id: question_answering
    name: 问题解答
    trigger: 用户提问
    steps:
      - understand_intent
      - retrieve_knowledge
      - generate_insight
      - suggest_action

  - id: timing_consultation
    name: 时机咨询
    trigger: 用户询问时机
    steps:
      - analyze_transit
      - evaluate_timing
      - provide_suggestion

# 知识库配置
knowledge:
  sources:
    - path: /knowledge/bazi/theory/
      type: structured
      description: 八字理论基础
      
    - path: /knowledge/bazi/patterns/
      type: structured
      description: 格局和十神模式
      
    - path: /knowledge/bazi/transit/
      type: structured
      description: 大运流年解读
      
    - path: /knowledge/bazi/cases/
      type: examples
      description: 解读案例库
      
  retrieval:
    strategy: hybrid
    vector_weight: 0.6
    keyword_weight: 0.2
    graph_weight: 0.2

# 工具函数
tools:
  - id: calculate_bazi
    name: 八字排盘
    description: 根据出生信息计算八字命盘
    function: bazi.calculator.generate_chart
    inputs:
      - name: birth_date
        type: date
        required: true
      - name: birth_time
        type: time
        required: false
      - name: birth_location
        type: location
        required: false
    outputs:
      - name: chart
        type: BaziChart
        
  - id: calculate_transit
    name: 大运流年
    description: 计算当前大运流年
    function: bazi.transit.calculate
    inputs:
      - name: chart
        type: BaziChart
      - name: target_date
        type: date
    outputs:
      - name: dayun
        type: DaYun
      - name: liunian
        type: LiuNian
        
  - id: analyze_pattern
    name: 格局分析
    description: 分析八字格局
    function: bazi.pattern.analyze
    inputs:
      - name: chart
        type: BaziChart
    outputs:
      - name: pattern
        type: Pattern
      - name: strength
        type: float

# 洞察生成 (LLM 驱动)
# 不再使用硬编码规则，由 LLM 判断是否生成洞察
# 详见: user-data-context-design.md

insight_generation:
  # 洞察类型
  types:
    - discovery   # 首次发现用户新特征
    - pattern     # 发现重复出现的规律 (需至少 3 次)
    - timing      # 与当前运势相关的时机建议
    - growth      # 发现用户的积极变化或突破

  # LLM 判断提示词 (示例)
  prompt_template: |
    基于用户画像和本次对话，判断是否值得生成洞察。
    只有真正有价值的才生成，避免与最近洞察重复。
    返回: { should_generate, type, title, content }

  # 触发时机
  trigger: "对话结束后，由 Insight Agent 异步判断"

  # 示例场景 (供 LLM 参考，非硬编码规则)
  examples:
    - scenario: "用户第三次提到决策犹豫"
      type: pattern
      insight: "我注意到你在决策时经常犹豫..."

    - scenario: "首次发现用户是偏印格"
      type: discovery
      insight: "你的命盘显示偏印格的特点..."

# 输出模板
output_templates:
  chart_display:
    type: card
    components:
      - BaziChartVisual
      - PatternSummary
      - TransitInfo
      
  insight_card:
    type: card
    components:
      - InsightTitle
      - InsightBody
      - ActionSuggestion
      - QuickActions

# 商业化配置
monetization:
  free_tier:
    - initial_chart_reading
    - 3_questions_per_day
    
  premium_tier:
    price: 29/month
    features:
      - unlimited_questions
      - monthly_transit_report
      - deep_pattern_analysis
      - cross_skill_insights
```

## 4.3 Agent 处理流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   SKILL AGENT PROCESSING PIPELINE                                           │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   USER INPUT: "最近总觉得做事差一点点，是不是运势问题？"                    │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   STEP 1: CONTEXT ASSEMBLY (Hot + Cold Memory)                      │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌──────────┐ │   │
│   │   │  🔥 Hot     │  │  💬 Buffer  │  │  ❄️ Cold    │  │ 📚 RAG   │ │   │
│   │   │  Portrait   │  │  Messages   │  │  Insights   │  │ Knowledge│ │   │
│   │   │             │  │             │  │             │  │          │ │   │
│   │   │ • Facts     │  │ • last 6    │  │ • 向量检索  │  │ • 专业   │ │   │
│   │   │ • State     │  │   messages  │  │ • 跨 Skill  │  │   知识库 │ │   │
│   │   │ • Prefs     │  │             │  │ • top-3     │  │          │ │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └──────────┘ │   │
│   │                                                                     │   │
│   │   Assembled Context:                                                │   │
│   │   {                                                                 │   │
│   │     portrait: "## Facts\n- 1990年生...\n## State\n- 近期焦虑...",  │   │
│   │     conversation: [ last 6 messages ],                              │   │
│   │     relevant_insights: [ 向量检索的相关洞察 ],                      │   │
│   │     knowledge: [ RAG 检索的专业知识 ]                               │   │
│   │   }                                                                 │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   STEP 2: INTENT CLASSIFICATION                                     │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   Detected Intents:                                                 │   │
│   │   • PRIMARY: transit_inquiry (运势询问) - confidence: 0.85         │   │
│   │   • SECONDARY: emotional_support (情绪支持) - confidence: 0.6      │   │
│   │                                                                     │   │
│   │   Workflow Selected: question_answering                             │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   STEP 3: KNOWLEDGE RETRIEVAL                                       │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   Query Generation:                                                 │   │
│   │   • "偏印运 特点 行动力"                                            │   │
│   │   • "甲木日主 偏印运"                                               │   │
│   │   • "运势不顺 命理解释"                                             │   │
│   │                                                                     │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│   │   │   Vector    │  │   Keyword   │  │   Graph     │                │   │
│   │   │   Search    │  │   Search    │  │   Traversal │                │   │
│   │   │             │  │             │  │             │                │   │
│   │   │ cos_sim:    │  │ BM25:       │  │ 偏印 →     │                │   │
│   │   │ 0.82        │  │ 15.3        │  │   特点     │                │   │
│   │   │             │  │             │  │   影响     │                │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                │   │
│   │                                                                     │   │
│   │   Retrieved Knowledge (Top 5, Re-ranked):                           │   │
│   │   1. 偏印运特点：思考增多，行动减少... (relevance: 0.91)           │   │
│   │   2. 甲木日主遇偏印：木旺需收敛... (relevance: 0.87)               │   │
│   │   3. 运势低迷期的解读方式：强调调整... (relevance: 0.75)           │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   STEP 4: TOOL INVOCATION                                           │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   Tool: calculate_transit                                           │   │
│   │   Input: { chart: user.skill_data.chart, target_date: "2026-01-05" }│   │
│   │                                                                     │   │
│   │   Output:                                                           │   │
│   │   {                                                                 │   │
│   │     dayun: "壬午",                                                  │   │
│   │     liunian: "丙午",                                                │   │
│   │     current_energy: { fire: 2.5, water: 1.2 },                      │   │
│   │     interpretation: "火旺水弱，躁动难静"                            │   │
│   │   }                                                                 │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   STEP 5: INSIGHT GENERATION (LLM 驱动)                             │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   LLM 判断是否生成洞察:                                             │   │
│   │   • 输入: 用户画像 + 本次对话 + 最近洞察 (避免重复)                 │   │
│   │   • LLM 判断: should_generate? type? content?                       │   │
│   │   • 不再使用硬编码规则，让 LLM 理解语境                             │   │
│   │                                                                     │   │
│   │   Generated Insight:                                                │   │
│   │   {                                                                 │   │
│   │     type: "pattern_discovery",                                      │   │
│   │     title: "偏印运的影响",                                          │   │
│   │     body: "你现在走到偏印运了，这个阶段...",                        │   │
│   │     confidence: 0.88,                                               │   │
│   │     embedding: [向量嵌入，支持未来语义检索]                         │   │
│   │   }                                                                 │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     ▼                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   STEP 6: RESPONSE COMPOSITION                                      │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   Persona Application:                                              │   │
│   │   • Tone: 沉稳智慧                                                  │   │
│   │   • Approach: 不预测事件，强调选择                                  │   │
│   │   • Style: 现代语言，温和但有分量                                   │   │
│   │                                                                     │   │
│   │   Response Structure:                                               │   │
│   │   1. Acknowledge feeling (共情)                                     │   │
│   │   2. Insight Card (洞察展示)                                        │   │
│   │   3. Context explanation (解释)                                     │   │
│   │   4. Follow-up question (延续对话)                                  │   │
│   │                                                                     │   │
│   │   Final Output:                                                     │   │
│   │   ────────────────────────────────────────────────────              │   │
│   │                                                                     │   │
│   │   "这个感觉很有意思。让我看看。                                     │   │
│   │                                                                     │   │
│   │   [INSIGHT CARD: 偏印运的影响]                                      │   │
│   │                                                                     │   │
│   │   而且你的八字本身木旺，遇到偏印运会放大"想"的特点。               │   │
│   │                                                                     │   │
│   │   最近有什么事让你特别着急想搞定的吗？"                             │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   POST-PROCESSING (同步 + 异步)                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│   同步 (必须):                                                              │
│   • 保存用户消息到 skill_messages                                           │
│   • 保存助手响应到 skill_messages                                           │
│                                                                             │
│   异步 (后台任务):                                                          │
│   • Portrait Agent: 每 10 条消息更新用户画像                                │
│   • Insight Agent: 对话结束后判断是否生成洞察                               │
│   • 生成 Insight 时同时生成 embedding                                       │
│                                                                             │
│   详见: user-data-context-design.md                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第五部分：知识引擎系统

## 5.1 知识库架构

> **实现说明**: 采用 PostgreSQL Native 极简架构，详见 [knowledge-system-plan.md](./knowledge-system-plan.md)

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║   KNOWLEDGE ENGINE ARCHITECTURE (PostgreSQL Native)                           ║
║   极简高效的知识库系统                                                        ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   KNOWLEDGE SOURCES (多格式文档)                                        │ ║
║   │                                                                         │ ║
║   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │ ║
║   │   │   PDF     │  │   EPUB    │  │   DOCX    │  │  MD/TXT   │          │ ║
║   │   │  书籍/论文 │  │  电子书   │  │  Word文档 │  │  文章     │          │ ║
║   │   └─────┬─────┘  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘          │ ║
║   │         │              │              │              │                 │ ║
║   │         └──────────────┴──────────────┴──────────────┘                 │ ║
║   │                                │                                        │ ║
║   └────────────────────────────────┼────────────────────────────────────────┘ ║
║                                    ▼                                          ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   KNOWLEDGE PIPELINE (知识处理管道)                                     │ ║
║   │                                                                         │ ║
║   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │ ║
║   │   │  Convert  │  │  Chunk    │  │  Segment  │  │   Index   │          │ ║
║   │   │  格式转换  │─▶│  智能分块  │─▶│  Jieba   │─▶│  向量化   │          │ ║
║   │   │           │  │           │  │  分词     │  │           │          │ ║
║   │   │ • PDF→MD  │  │ • 结构解析│  │ • 中英文  │  │ • Gemini  │          │ ║
║   │   │ • EPUB→MD │  │ • 智能合并│  │ • 混合    │  │ • 3072维  │          │ ║
║   │   │ • DOCX→MD │  │ • 安全拆分│  │ • 支持    │  │ • HNSW    │          │ ║
║   │   └───────────┘  └───────────┘  └───────────┘  └───────────┘          │ ║
║   │                                                                         │ ║
║   └────────────────────────────────┬────────────────────────────────────────┘ ║
║                                    ▼                                          ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   KNOWLEDGE STORE (PostgreSQL + pgvector)                               │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   knowledge_documents (文档管理 + 任务队列)                     │   │ ║
║   │   │   • skill_id, filename, file_hash, status                       │   │ ║
║   │   │   • 支持: pending → processing → completed/failed/archived      │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   knowledge_chunks_v2 (知识块)                                  │   │ ║
║   │   │   • content, section_path[], section_title                      │   │ ║
║   │   │   • embedding vector(3072) + HNSW 索引                          │   │ ║
║   │   │   • search_vector tsvector + GIN 索引                           │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   hybrid_search_v2() SQL函数                                    │   │ ║
║   │   │   • 向量搜索 (70%) + 关键词搜索 (30%)                           │   │ ║
║   │   │   • RRF (Reciprocal Rank Fusion) 融合排序                       │   │ ║
║   │   │   • 中英文混合支持 (Jieba + simple)                             │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## 5.2 知识结构化流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   KNOWLEDGE STRUCTURING PIPELINE                                            │
│   以八字知识为例的完整处理流程                                              │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   STEP 1: RAW KNOWLEDGE EXTRACTION                                          │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   Source: 《子平真诠》第三章 - 论十神                                       │
│                                                                             │
│   Raw Text:                                                                 │
│   "偏印者，生我之异类也。如阳木生阳火，阴木生阴火...                       │
│    偏印之性，聪明多疑，精明刻薄..."                                        │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  EXTRACTOR                                                          │   │
│   │                                                                     │   │
│   │  {                                                                  │   │
│   │    source: "子平真诠",                                              │   │
│   │    chapter: "论十神",                                               │   │
│   │    topic: "偏印",                                                   │   │
│   │    raw_content: "...",                                              │   │
│   │    language: "classical_chinese"                                    │   │
│   │  }                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   STEP 2: SEMANTIC CHUNKING                                                 │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  CHUNKER (LLM-assisted)                                             │   │
│   │                                                                     │   │
│   │  Chunks Generated:                                                  │   │
│   │                                                                     │   │
│   │  Chunk 1: {                                                         │   │
│   │    id: "bazi-theory-shenshen-01",                                   │   │
│   │    topic: "偏印定义",                                               │   │
│   │    content: "偏印者，生我之异类也...",                              │   │
│   │    modern_interpretation: "偏印是指与日主阴阳相同、生助日主的元素"  │   │
│   │  }                                                                  │   │
│   │                                                                     │   │
│   │  Chunk 2: {                                                         │   │
│   │    id: "bazi-theory-shenshen-02",                                   │   │
│   │    topic: "偏印性格特征",                                           │   │
│   │    content: "偏印之性，聪明多疑...",                                │   │
│   │    modern_interpretation: "偏印代表的性格特点包括：聪明、思虑多、   │   │
│   │                           容易想太多、精于分析但可能刻薄"            │   │
│   │  }                                                                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   STEP 3: ENTITY & RELATION EXTRACTION                                      │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  ENTITY EXTRACTOR                                                   │   │
│   │                                                                     │   │
│   │  Entities:                                                          │   │
│   │  • 偏印 (TenGod)                                                    │   │
│   │  • 聪明 (Trait)                                                     │   │
│   │  • 多疑 (Trait)                                                     │   │
│   │  • 思考过多 (Behavior)                                              │   │
│   │                                                                     │   │
│   │  Relations:                                                         │   │
│   │  • (偏印) --[MANIFESTS_AS]--> (聪明)                                │   │
│   │  • (偏印) --[MANIFESTS_AS]--> (多疑)                                │   │
│   │  • (多疑) --[LEADS_TO]--> (思考过多)                                │   │
│   │  • (思考过多) --[RESULTS_IN]--> (行动力下降)                        │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   STEP 4: QA PAIR GENERATION                                                │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  QA GENERATOR (LLM)                                                 │   │
│   │                                                                     │   │
│   │  Generated QA Pairs:                                                │   │
│   │                                                                     │   │
│   │  Q1: "什么是偏印？"                                                 │   │
│   │  A1: "偏印是八字十神之一，指与日主阴阳相同、生助日主的元素。       │   │
│   │       比如甲木日主，甲木属阳，壬水也属阳，壬水生甲木，               │   │
│   │       所以壬水对甲木就是偏印。"                                     │   │
│   │                                                                     │   │
│   │  Q2: "偏印代表什么性格？"                                           │   │
│   │  A2: "偏印代表的性格特点包括：聪明、善于思考、但容易想太多、        │   │
│   │       精于分析、可能有些挑剔。偏印旺的人通常很聪明，                 │   │
│   │       但可能因为想太多而犹豫不决。"                                 │   │
│   │                                                                     │   │
│   │  Q3: "偏印运会有什么影响？"                                         │   │
│   │  A3: "走偏印运时，人会变得更爱思考、学习能力增强，                   │   │
│   │       但同时行动力可能下降。这是一个适合学习、思考、                 │   │
│   │       调整方向的时期，不是大力推进的时期。"                         │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   STEP 5: MULTI-INDEX STORAGE                                               │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  INDEX BUILDER                                                      │   │
│   │                                                                     │   │
│   │  1. Vector Index (Pinecone):                                        │   │
│   │     • Embed chunk content                                           │   │
│   │     • Embed QA pairs                                                │   │
│   │     • Store with metadata                                           │   │
│   │                                                                     │   │
│   │  2. Keyword Index (PostgreSQL FTS):                                 │   │
│   │     • Index: 偏印, 性格, 聪明, 多疑, 思考, 运势...                  │   │
│   │     • Enable BM25 ranking                                           │   │
│   │                                                                     │   │
│   │  3. Graph Index (Neo4j):                                            │   │
│   │     • Create nodes for entities                                     │   │
│   │     • Create edges for relations                                    │   │
│   │     • Enable graph traversal queries                                │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 5.3 混合检索系统

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   HYBRID RETRIEVAL SYSTEM                                                   │
│   多路检索 + 智能融合 + 质量评估                                            │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   Query: "为什么我最近总是想太多，做事拖延？"                               │
│   User Context: { chart: {...}, current_dayun: "壬午", dayun_shenshen: "偏印" }│
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   QUERY UNDERSTANDING                                               │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   Intent: behavior_explanation                                      │   │
│   │   Entities: [想太多, 拖延]                                          │   │
│   │   Context Entities: [偏印运]                                        │   │
│   │                                                                     │   │
│   │   Generated Queries:                                                │   │
│   │   • Semantic: "思考过多 行动力下降 原因"                            │   │
│   │   • Keyword: "偏印 想太多 拖延"                                     │   │
│   │   • Graph: START FROM (偏印) TRAVERSE (MANIFESTS_AS, LEADS_TO)      │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                   ┌─────────────────┼─────────────────┐                     │
│                   │                 │                 │                     │
│                   ▼                 ▼                 ▼                     │
│   ┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐         │
│   │                   │ │                   │ │                   │         │
│   │   VECTOR SEARCH   │ │  KEYWORD SEARCH   │ │   GRAPH SEARCH    │         │
│   │                   │ │                   │ │                   │         │
│   │   Pinecone        │ │   PostgreSQL      │ │   Neo4j           │         │
│   │                   │ │                   │ │                   │         │
│   │   cosine_sim      │ │   BM25            │ │   path_finding    │         │
│   │                   │ │                   │ │                   │         │
│   │   Results:        │ │   Results:        │ │   Results:        │         │
│   │   • doc_1: 0.89   │ │   • doc_3: 18.2   │ │   • path_1: 偏印  │         │
│   │   • doc_4: 0.85   │ │   • doc_1: 15.7   │ │     →思虑多→    │         │
│   │   • doc_7: 0.81   │ │   • doc_5: 12.3   │ │     行动少       │         │
│   │                   │ │                   │ │   • path_2: ...   │         │
│   └─────────┬─────────┘ └─────────┬─────────┘ └─────────┬─────────┘         │
│             │                     │                     │                   │
│             └─────────────────────┼─────────────────────┘                   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   RESULT FUSION                                                     │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   Reciprocal Rank Fusion (RRF):                                     │   │
│   │                                                                     │   │
│   │   RRF(d) = Σ 1 / (k + rank(d, r))                                   │   │
│   │            r∈R                                                      │   │
│   │                                                                     │   │
│   │   where k = 60, R = {vector, keyword, graph}                        │   │
│   │                                                                     │   │
│   │   Fused Results:                                                    │   │
│   │   1. doc_1: RRF = 0.048 (vector: #1, keyword: #2)                   │   │
│   │   2. doc_3: RRF = 0.031 (keyword: #1, graph: #2)                    │   │
│   │   3. doc_4: RRF = 0.028 (vector: #2)                                │   │
│   │   4. doc_7: RRF = 0.024 (vector: #3, graph: #3)                     │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   RELEVANCE GRADING (LLM-based)                                     │   │
│   │   ─────────────────────────────────────────────────────────         │   │
│   │                                                                     │   │
│   │   Prompt:                                                           │   │
│   │   "Given the user's question about '想太多,拖延' and their          │   │
│   │    context (偏印运), rate the relevance of each document 1-5."      │   │
│   │                                                                     │   │
│   │   Graded Results:                                                   │   │
│   │   1. doc_1: 5 (直接解释偏印导致思虑过多)                            │   │
│   │   2. doc_3: 4 (解释偏印性格特点)                                    │   │
│   │   3. doc_7: 4 (偏印运的行为影响)                                    │   │
│   │   4. doc_4: 2 (不够相关，主要讲财运)                                │   │
│   │                                                                     │   │
│   │   Final Selection: [doc_1, doc_3, doc_7]                            │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   OUTPUT                                                                    │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   Retrieved Knowledge:                                                      │
│   1. "偏印代表思虑多、学习力强，但容易想太多而犹豫不决..."                 │
│   2. "偏印运时期，人会变得更爱思考，但行动力可能下降..."                   │
│   3. "偏印旺或走偏印运的人，建议设定决策时限，避免过度分析..."             │
│                                                                             │
│   Graph Context:                                                            │
│   偏印 → 思虑多 → 行动少 → (建议) → 设定时限                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 5.4 知识库目录结构

> **实现说明**: 采用简化的平坦目录结构，每个 skill 一个文件夹，支持多格式文档自动同步。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   KNOWLEDGE BASE DIRECTORY STRUCTURE (Simplified)                           │
│                                                                             │
│   /home/aiscend/work/vibelife/knowledge/                                    │
│   │                                                                         │
│   ├── /bazi/                           # 八字命理知识库                     │
│   │   ├── 天干地支基础.md              # 支持 Markdown                      │
│   │   ├── 十神详解.pdf                 # 支持 PDF (保留表格)                │
│   │   ├── 八字入门.epub                # 支持 EPUB 电子书                   │
│   │   ├── 格局分析.docx                # 支持 Word 文档                     │
│   │   ├── 运势解读.txt                 # 支持 纯文本                        │
│   │   └── 案例分析.html                # 支持 HTML (网页抓取)               │
│   │                                                                         │
│   ├── /zodiac/                         # 星座占星知识库                     │
│   │   ├── 十二星座.md                                                       │
│   │   ├── 行星相位.pdf                                                      │
│   │   └── ...                                                               │
│   │                                                                         │
│   ├── /mbti/                           # MBTI 知识库                        │
│   │   ├── 认知功能.md                                                       │
│   │   ├── 16类型详解.pdf                                                    │
│   │   └── ...                                                               │
│   │                                                                         │
│   └── (其他 skill 按需添加)                                                 │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   支持的文件格式:                                                           │
│   • PDF  - pymupdf4llm 转换，保留表格结构                                   │
│   • EPUB - ebooklib 提取章节                                                │
│   • DOCX - python-docx 提取段落                                             │
│   • HTML - html2text 转为 Markdown                                          │
│   • MD/TXT - 直接读取                                                       │
│                                                                             │
│   自动同步机制:                                                             │
│   • 每日凌晨 4:00 扫描文件夹                                                │
│   • 检测新增/修改/删除文件 (MD5 hash)                                       │
│   • 新文件自动入队处理                                                      │
│   • 删除文件标记为 archived (软删除)                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第六部分：专业工具函数系统

## 6.1 工具函数架构

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║   SKILL TOOL FUNCTION SYSTEM                                                  ║
║   专业计算与领域函数                                                          ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   TOOL REGISTRY                                                         │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   BAZI TOOLS                                                    │   │ ║
║   │   │   ─────────────────────────────────────────────────────────     │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • bazi.calculator.generate_chart                              │   │ ║
║   │   │     输入出生信息，排出八字命盘                                  │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • bazi.transit.calculate_dayun                                │   │ ║
║   │   │     计算大运流年                                                │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • bazi.pattern.analyze                                        │   │ ║
║   │   │     分析格局和十神                                              │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • bazi.elements.calculate_strength                            │   │ ║
║   │   │     计算五行力量分布                                            │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • bazi.compatibility.analyze                                  │   │ ║
║   │   │     八字合婚分析                                                │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   ASTRA TOOLS                                                   │   │ ║
║   │   │   ─────────────────────────────────────────────────────────     │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • astra.chart.calculate_natal                                 │   │ ║
║   │   │     计算本命星盘                                                │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • astra.transit.current                                       │   │ ║
║   │   │     计算当前行星位置                                            │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • astra.aspects.analyze                                       │   │ ║
║   │   │     分析行星相位                                                │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • astra.synastry.compare                                      │   │ ║
║   │   │     双人星盘比较                                                │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   MBTI TOOLS                                                    │   │ ║
║   │   │   ─────────────────────────────────────────────────────────     │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • mbti.assessment.calculate_type                              │   │ ║
║   │   │     根据回答计算MBTI类型                                        │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • mbti.functions.analyze                                      │   │ ║
║   │   │     分析认知功能栈                                              │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • mbti.compatibility.check                                    │   │ ║
║   │   │     类型兼容性检查                                              │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   ATTACHMENT TOOLS                                              │   │ ║
║   │   │   ─────────────────────────────────────────────────────────     │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • attachment.assessment.evaluate                              │   │ ║
║   │   │     依恋风格评估                                                │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • attachment.pattern.detect                                   │   │ ║
║   │   │     从对话中检测依恋模式                                        │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   │   ┌─────────────────────────────────────────────────────────────────┐   │ ║
║   │   │                                                                 │   │ ║
║   │   │   SHARED TOOLS                                                  │   │ ║
║   │   │   ─────────────────────────────────────────────────────────     │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • datetime.convert                                            │   │ ║
║   │   │     日期时间转换（公历/农历/时区）                              │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • location.geocode                                            │   │ ║
║   │   │     地址地理编码                                                │   │ ║
║   │   │                                                                 │   │ ║
║   │   │   • visualization.generate_chart                                │   │ ║
║   │   │     生成图表可视化                                              │   │ ║
║   │   │                                                                 │   │ ║
║   │   └─────────────────────────────────────────────────────────────────┘   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## 6.2 工具函数详细定义 (以八字为例)

```python
# /tools/bazi/calculator.py

from dataclasses import dataclass
from typing import Optional, List
from datetime import datetime
from enum import Enum

class TianGan(Enum):
    """十天干"""
    JIA = ("甲", "木", "阳")
    YI = ("乙", "木", "阴")
    BING = ("丙", "火", "阳")
    DING = ("丁", "火", "阴")
    WU = ("戊", "土", "阳")
    JI = ("己", "土", "阴")
    GENG = ("庚", "金", "阳")
    XIN = ("辛", "金", "阴")
    REN = ("壬", "水", "阳")
    GUI = ("癸", "水", "阴")

class DiZhi(Enum):
    """十二地支"""
    ZI = ("子", "水", "阳", ["癸"])
    CHOU = ("丑", "土", "阴", ["己", "癸", "辛"])
    YIN = ("寅", "木", "阳", ["甲", "丙", "戊"])
    MAO = ("卯", "木", "阴", ["乙"])
    CHEN = ("辰", "土", "阳", ["戊", "乙", "癸"])
    SI = ("巳", "火", "阴", ["丙", "戊", "庚"])
    WU = ("午", "火", "阳", ["丁", "己"])
    WEI = ("未", "土", "阴", ["己", "丁", "乙"])
    SHEN = ("申", "金", "阳", ["庚", "壬", "戊"])
    YOU = ("酉", "金", "阴", ["辛"])
    XU = ("戌", "土", "阳", ["戊", "辛", "丁"])
    HAI = ("亥", "水", "阴", ["壬", "甲"])

@dataclass
class Pillar:
    """四柱中的一柱"""
    gan: TianGan
    zhi: DiZhi
    
    @property
    def hidden_stems(self) -> List[str]:
        """地支藏干"""
        return self.zhi.value[3]

@dataclass
class BaziChart:
    """八字命盘"""
    year_pillar: Pillar      # 年柱
    month_pillar: Pillar     # 月柱
    day_pillar: Pillar       # 日柱
    hour_pillar: Optional[Pillar]  # 时柱（可能不知道时辰）
    
    # 元数据
    birth_datetime: datetime
    birth_location: Optional[str]
    solar_term: str          # 节气
    
    # 分析结果
    day_master: TianGan      # 日主
    day_master_strength: float  # 日主强度 0-1
    
    @property
    def element_distribution(self) -> dict:
        """五行分布"""
        elements = {"木": 0, "火": 0, "土": 0, "金": 0, "水": 0}
        # 计算逻辑...
        return elements
    
    def to_display(self) -> dict:
        """转换为展示格式"""
        return {
            "pillars": {
                "year": f"{self.year_pillar.gan.value[0]}{self.year_pillar.zhi.value[0]}",
                "month": f"{self.month_pillar.gan.value[0]}{self.month_pillar.zhi.value[0]}",
                "day": f"{self.day_pillar.gan.value[0]}{self.day_pillar.zhi.value[0]}",
                "hour": f"{self.hour_pillar.gan.value[0]}{self.hour_pillar.zhi.value[0]}" if self.hour_pillar else "未知"
            },
            "day_master": self.day_master.value[0],
            "day_master_element": self.day_master.value[1],
            "strength": "身强" if self.day_master_strength > 0.5 else "身弱",
            "elements": self.element_distribution
        }

def generate_chart(
    birth_date: str,           # "1990-03-15"
    birth_time: Optional[str], # "08:30" or None
    birth_location: Optional[str] = None
) -> BaziChart:
    """
    生成八字命盘
    
    Tool Definition:
    - id: bazi.calculator.generate_chart
    - description: 根据出生信息计算八字命盘
    - inputs:
        - birth_date: date (required)
        - birth_time: time (optional)
        - birth_location: string (optional)
    - outputs:
        - chart: BaziChart
    """
    
    # 1. 解析日期时间
    dt = _parse_datetime(birth_date, birth_time)
    
    # 2. 转换为农历
    lunar = _to_lunar(dt)
    
    # 3. 确定节气和月令
    solar_term = _get_solar_term(dt)
    month_branch = _get_month_branch(dt, solar_term)
    
    # 4. 计算年柱
    year_pillar = _calculate_year_pillar(lunar.year)
    
    # 5. 计算月柱
    month_pillar = _calculate_month_pillar(year_pillar.gan, month_branch)
    
    # 6. 计算日柱
    day_pillar = _calculate_day_pillar(dt)
    
    # 7. 计算时柱（如果有时间）
    hour_pillar = None
    if birth_time:
        hour_pillar = _calculate_hour_pillar(day_pillar.gan, dt.hour)
    
    # 8. 分析日主强度
    day_master = day_pillar.gan
    strength = _analyze_day_master_strength(
        day_master, 
        [year_pillar, month_pillar, day_pillar, hour_pillar],
        solar_term
    )
    
    return BaziChart(
        year_pillar=year_pillar,
        month_pillar=month_pillar,
        day_pillar=day_pillar,
        hour_pillar=hour_pillar,
        birth_datetime=dt,
        birth_location=birth_location,
        solar_term=solar_term,
        day_master=day_master,
        day_master_strength=strength
    )

# 十神分析
@dataclass  
class TenGodAnalysis:
    """十神分析结果"""
    ten_gods: dict          # 每个位置的十神
    dominant_gods: List[str]  # 主要十神
    pattern: str            # 格局名称
    pattern_quality: str    # 格局层次

def analyze_ten_gods(chart: BaziChart) -> TenGodAnalysis:
    """
    分析八字十神
    
    Tool Definition:
    - id: bazi.pattern.analyze_ten_gods
    - description: 分析八字中的十神分布和格局
    """
    day_master = chart.day_master
    ten_gods = {}
    
    # 年干十神
    ten_gods["year_gan"] = _get_ten_god(day_master, chart.year_pillar.gan)
    # 月干十神
    ten_gods["month_gan"] = _get_ten_god(day_master, chart.month_pillar.gan)
    # 时干十神
    if chart.hour_pillar:
        ten_gods["hour_gan"] = _get_ten_god(day_master, chart.hour_pillar.gan)
    
    # 地支藏干十神
    for pillar_name, pillar in [
        ("year", chart.year_pillar),
        ("month", chart.month_pillar),
        ("day", chart.day_pillar)
    ]:
        ten_gods[f"{pillar_name}_hidden"] = [
            _get_ten_god(day_master, TianGan[stem.upper()])
            for stem in pillar.hidden_stems
        ]
    
    # 判断格局
    pattern, quality = _determine_pattern(ten_gods, chart.day_master_strength)
    
    # 找主要十神
    dominant = _find_dominant_gods(ten_gods)
    
    return TenGodAnalysis(
        ten_gods=ten_gods,
        dominant_gods=dominant,
        pattern=pattern,
        pattern_quality=quality
    )

# 大运流年分析
@dataclass
class DaYunInfo:
    """大运信息"""
    gan: TianGan
    zhi: DiZhi
    start_age: int
    end_age: int
    ten_god: str
    interpretation: str

@dataclass
class TransitAnalysis:
    """运势分析结果"""
    current_dayun: DaYunInfo
    current_liunian: dict
    dayun_list: List[DaYunInfo]
    current_theme: str
    opportunities: List[str]
    challenges: List[str]

def calculate_transit(
    chart: BaziChart,
    target_date: Optional[str] = None
) -> TransitAnalysis:
    """
    计算大运流年
    
    Tool Definition:
    - id: bazi.transit.calculate
    - description: 计算当前大运流年和运势分析
    """
    if target_date is None:
        target_date = datetime.now()
    else:
        target_date = datetime.strptime(target_date, "%Y-%m-%d")
    
    # 计算大运起运年龄
    start_age = _calculate_dayun_start(chart)
    
    # 生成大运列表
    dayun_list = _generate_dayun_sequence(chart, start_age)
    
    # 确定当前大运
    current_age = (target_date - chart.birth_datetime).days // 365
    current_dayun = _find_current_dayun(dayun_list, current_age)
    
    # 计算流年
    current_liunian = _calculate_liunian(target_date.year)
    
    # 分析运势主题
    theme, opportunities, challenges = _analyze_transit_theme(
        chart, current_dayun, current_liunian
    )
    
    return TransitAnalysis(
        current_dayun=current_dayun,
        current_liunian=current_liunian,
        dayun_list=dayun_list,
        current_theme=theme,
        opportunities=opportunities,
        challenges=challenges
    )

def _get_ten_god(day_master: TianGan, target: TianGan) -> str:
    """
    计算十神关系
    
    比肩：同我同阴阳
    劫财：同我异阴阳
    食神：我生同阴阳
    伤官：我生异阴阳
    偏财：我克同阴阳
    正财：我克异阴阳
    七杀：克我同阴阳
    正官：克我异阴阳
    偏印：生我同阴阳
    正印：生我异阴阳
    """
    dm_element = day_master.value[1]
    dm_polarity = day_master.value[2]
    target_element = target.value[1]
    target_polarity = target.value[2]
    
    same_polarity = dm_polarity == target_polarity
    
    # 确定五行关系
    relation = _get_element_relation(dm_element, target_element)
    
    TEN_GOD_MAP = {
        ("same", True): "比肩",
        ("same", False): "劫财",
        ("generate", True): "食神",
        ("generate", False): "伤官",
        ("control", True): "偏财",
        ("control", False): "正财",
        ("controlled", True): "七杀",
        ("controlled", False): "正官",
        ("generated", True): "偏印",
        ("generated", False): "正印",
    }
    
    return TEN_GOD_MAP[(relation, same_polarity)]
```

---

# 第七部分：独立站点生成系统

## 7.1 站点模板架构

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║   SKILL SITE TEMPLATE SYSTEM                                                  ║
║   统一模板生成各个独立站点                                                    ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   TEMPLATE ENGINE                                                       │ ║
║   │                                                                         │ ║
║   │   skill_config.yaml + templates/ → Generated Site                       │ ║
║   │                                                                         │ ║
║   │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐              │ ║
║   │   │   Config    │     │  Template   │     │  Generated  │              │ ║
║   │   │   (YAML)    │ ──▶ │   Engine    │ ──▶ │    Site     │              │ ║
║   │   │             │     │             │     │             │              │ ║
║   │   │ • persona   │     │ • Next.js   │     │ • Landing   │              │ ║
║   │   │ • theme     │     │ • Components│     │ • Chat      │              │ ║
║   │   │ • features  │     │ • API       │     │ • Results   │              │ ║
║   │   │ • tools     │     │             │     │ • Settings  │              │ ║
║   │   └─────────────┘     └─────────────┘     └─────────────┘              │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

## 7.2 站点配置示例

```yaml
# /skills/bazi/site_config.yaml

site:
  id: bazi
  name: 八字命理
  domain: bazi.vibelife.app
  tagline: "了解命中注定的你"
  description: "不是算命，是帮你'看见'自己"

# 视觉主题 (LUMINOUS PAPER 设计系统)
theme:
  # 品牌核心色
  ink: "#1C1A17"              # 墨色 - 主文字、CTA
  antique_gold: "#B88A44"     # 古金 - 强调、徽章、印章
  vellum: "#FBF7F1"           # 纸底 - 全局背景

  # Skill 专属色
  primary_color: "#7A3F1A"    # 八字主色
  secondary_color: "#B88A44"  # 古金点缀
  accent_bg: "bg-amber-50"    # 背景色

  # 背景效果
  background: "luminous-paper" # 光纸背景（带五行 glow）

  # 五行色 glow（用于光纸背景呼吸效果）
  glow_colors:
    wood: "hsla(120, 50%, 40%, 0.08)"
    fire: "hsla(0, 80%, 55%, 0.08)"
    earth: "hsla(40, 70%, 50%, 0.08)"
    metal: "hsla(30, 5%, 85%, 0.08)"
    water: "hsla(210, 70%, 45%, 0.08)"

  # 呼吸动画时长（根据五行属性）
  breath_duration:
    wood: "6s"
    fire: "4s"
    earth: "8s"
    metal: "5s"
    water: "7s"

  # 字体
  font_display: "'Fraunces', 'Noto Serif SC', serif"
  font_ui: "'Bricolage Grotesque', 'Noto Sans SC', sans-serif"

  icon: "☯️"

  # Skill 形态语言
  visual_language: "pillar"   # 方形柱布局（八字特有）

# 品牌元素
branding:
  logo: "/assets/bazi/logo.svg"
  og_image: "/assets/bazi/og-image.png"
  favicon: "/assets/bazi/favicon.ico"

# Landing Page 配置
landing:
  hero:
    title: "了解命中注定的你"
    subtitle: "不是算命，是帮你'看见'自己"
    cta: "看看我的八字"
    
  value_props:
    - icon: "🔮"
      title: "性格密码"
      description: "了解天生的性格优势和盲点"
    - icon: "💼"
      title: "事业方向"
      description: "发现适合你的发展路径"
    - icon: "💕"
      title: "感情模式"
      description: "理解你在关系中的模式"
    - icon: "📅"
      title: "运势周期"
      description: "把握人生的节奏和时机"
      
  input_form:
    fields:
      - id: birth_date
        type: date
        label: "出生日期"
        required: true
      - id: birth_time
        type: time_selector
        label: "出生时辰"
        required: false
        options: "时辰选择器"
        hint: "不确定可跳过"
    submit_label: "看看我的八字"

  sample_conversation:
    - role: user
      content: "我1990年3月15日出生，最近总觉得做事差一点..."
    - role: assistant
      content: "你是庚午年出生，日主是木... 最近走到'偏印'运，这个阶段..."

  cross_sell:
    title: "VibeLife 星座 · 更多理解自己的方式"
    items:
      - id: astra
        name: "ASTRA 星座"
        tagline: "星空中的你"
      - id: mbti
        name: "MBTI"
        tagline: "认识你的认知模式"

# 主界面配置
main_interface:
  tabs:
    - id: chat
      label: "对话"
      icon: "💬"
    - id: chart
      label: "命盘"
      icon: "📊"
    - id: journey
      label: "历程"
      icon: "📓"
    - id: profile
      label: "我的"
      icon: "👤"
      
  insight_card:
    enabled: true
    types:
      - discovery  # 发现卡
      - pattern    # 模式卡
      - timing     # 时机卡
      - growth     # 成长卡

# 结果展示配置
result_display:
  chart_visual:
    type: "bazi_chart"
    show_elements: true
    show_ten_gods: true
    
  sections:
    - id: personality
      title: "性格特点"
      priority: 1
    - id: career
      title: "事业方向"
      priority: 2
    - id: relationship
      title: "感情模式"
      priority: 3
    - id: transit
      title: "当前运势"
      priority: 4

# 商业化配置
monetization:
  free_tier:
    name: "免费体验"
    features:
      - "1次完整命盘解读"
      - "每天3次提问"
      - "基础运势分析"
      
  premium_tier:
    name: "会员"
    price:
      monthly: 29
      yearly: 199
    features:
      - "无限对话"
      - "深度十神分析"
      - "每月运势推送"
      - "详细大运解读"
      - "跨技能洞察"

  paywall_triggers:
    - "deep_pattern_analysis"
    - "detailed_transit"
    - "compatibility_analysis"

# SEO 配置
seo:
  title: "AI八字命理 - 用现代语言读懂你的命盘 | VibeLife"
  description: "VibeLife八字命理分析师，用AI帮你看见自己。不是算命，是理解自己的新方式。"
  keywords:
    - "八字"
    - "命理"
    - "AI算命"
    - "八字分析"
    - "运势"
    - "命盘"
  
  structured_data:
    type: "SoftwareApplication"
    category: "LifestyleApplication"

# 内容营销配置
content_marketing:
  platforms:
    - platform: "xiaohongshu"
      content_types:
        - "八字小知识"
        - "今日运势"
        - "性格解读"
      posting_frequency: "daily"
      
    - platform: "douyin"
      content_types:
        - "八字秘密揭示"
        - "运势周报"
      posting_frequency: "3x_weekly"
```

## 7.3 前端组件库

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   VIBELIFE COMPONENT LIBRARY (LUMINOUS PAPER 设计系统)                      │
│   所有 Skill 站点共享的组件                                                 │
│                                                                             │
│   @vibelife/ui/                                                             │
│   │                                                                         │
│   ├── /core/                          # LUMINOUS PAPER 核心组件             │
│   │   ├── LuminousPaper.tsx          # 光纸背景（带五行 glow）              │
│   │   ├── BreathAura.tsx             # 呼吸光晕（根据五行属性变色）         │
│   │   ├── VibeGlyph.tsx              # 品牌图标（五行循环图形）             │
│   │   └── InsightSeal.tsx            # 个人化印章（基于八字生成）           │
│   │                                                                         │
│   ├── /layout/                        # 布局组件                            │
│   │   ├── AppShell.tsx               # 应用外壳（集成 LuminousPaper）       │
│   │   ├── Header.tsx                 # 顶部导航（glass 效果）               │
│   │   ├── BottomNav.tsx              # 底部导航                             │
│   │   └── PageContainer.tsx          # 页面容器                             │
│   │                                                                         │
│   ├── /landing/                       # Landing 组件                        │
│   │   ├── Hero.tsx                   # Hero 区域（含 VibeGlyph）            │
│   │   ├── BirthInputCapsule.tsx      # 出生日期输入（frosted glass）        │
│   │   ├── ValueProps.tsx             # 价值主张                             │
│   │   ├── SampleConversation.tsx     # 示例对话                             │
│   │   └── CrossSellBanner.tsx        # 交叉推荐                             │
│   │                                                                         │
│   ├── /chat/                          # 对话组件                            │
│   │   ├── ChatContainer.tsx          # 对话容器                             │
│   │   ├── MessageBubble.tsx          # 消息气泡（glass 效果）               │
│   │   ├── Omnibar.tsx                # 输入栏（frosted capsule）            │
│   │   ├── QuickReplies.tsx           # 快捷回复                             │
│   │   └── TypingIndicator.tsx        # 输入中指示（含 BreathAura）          │
│   │                                                                         │
│   ├── /insight/                       # 洞察卡片组件                        │
│   │   ├── InsightCard.tsx            # 洞察卡片基础（含 InsightSeal）       │
│   │   ├── DiscoveryCard.tsx          # 发现卡 (border-l-4 blue)            │
│   │   ├── PatternCard.tsx            # 模式卡 (border-l-4 purple)          │
│   │   ├── TimingCard.tsx             # 时机卡 (border-l-4 amber)           │
│   │   └── GrowthCard.tsx             # 成长卡 (border-l-4 emerald)         │
│   │                                                                         │
│   ├── /charts/                        # 图表组件 (Skill 形态差异化)         │
│   │   ├── BaziPillars.tsx            # 八字四柱（方形模块 + 竖排）          │
│   │   ├── ZodiacWheel.tsx            # 星盘（圆形 + 连线）                  │
│   │   ├── MbtiSpectrum.tsx           # MBTI 光谱条（渐变条）                │
│   │   ├── AttachmentRings.tsx        # 依恋圆环（嵌套圆环）                 │
│   │   ├── RadarChart.tsx             # 雷达图                               │
│   │   ├── TimelineChart.tsx          # 时间线                               │
│   │   └── ElementsBar.tsx            # 五行分布                             │
│   │                                                                         │
│   ├── /profile/                       # 个人中心组件                        │
│   │   ├── ProfileHeader.tsx          # 用户头部                             │
│   │   ├── SkillDataCard.tsx          # 技能数据卡                           │
│   │   ├── SubscriptionStatus.tsx     # 订阅状态                             │
│   │   └── DataSharingSettings.tsx    # 数据共享设置                         │
│   │                                                                         │
│   ├── /common/                        # 通用组件                            │
│   │   ├── Button.tsx                 # 按钮（Ink 主色）                     │
│   │   ├── Card.tsx                   # 卡片（glass-card 效果）              │
│   │   ├── Input.tsx                                                         │
│   │   ├── Modal.tsx                                                         │
│   │   ├── Toast.tsx                                                         │
│   │   └── Loading.tsx                                                       │
│   │                                                                         │
│   └── /auth/                          # 认证组件                            │
│       ├── VibeIdLogin.tsx            # Vibe ID 登录                         │
│       ├── SocialLogin.tsx            # 社交登录                             │
│       └── ConsentDialog.tsx          # 授权对话框                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 7.4 LUMINOUS PAPER 设计 Token

```yaml
# 设计系统 CSS Variables

:root:
  # 品牌核心色
  --ink: "#1C1A17"
  --antique-gold: "#B88A44"
  --vellum: "#FBF7F1"

  # 五行色 glow
  --glow-wood: "hsla(120, 50%, 40%, 0.08)"
  --glow-fire: "hsla(0, 80%, 55%, 0.08)"
  --glow-earth: "hsla(40, 70%, 50%, 0.08)"
  --glow-metal: "hsla(30, 5%, 85%, 0.08)"
  --glow-water: "hsla(210, 70%, 45%, 0.08)"

  # 呼吸动画时长
  --breath-duration-wood: "6s"
  --breath-duration-fire: "4s"
  --breath-duration-earth: "8s"
  --breath-duration-metal: "5s"
  --breath-duration-water: "7s"

  # 字体
  --font-display: "'Fraunces', 'Noto Serif SC', serif"
  --font-ui: "'Bricolage Grotesque', 'Noto Sans SC', sans-serif"

# Skill 专属色
skill_colors:
  bazi:
    primary: "#7A3F1A"
    secondary: "#B88A44"
    accent_bg: "bg-amber-50"
    visual_language: "pillar"      # 方形柱

  zodiac:
    primary: "#3C3A7A"
    secondary: "#A7A6F4"
    accent_bg: "bg-indigo-50"
    visual_language: "wheel"       # 圆形连线

  mbti:
    primary: "#0F766E"
    secondary: "#6EE7C3"
    accent_bg: "bg-emerald-50"
    visual_language: "spectrum"    # 光谱条

  attachment:
    primary: "#B13C41"
    secondary: "#F3A6A9"
    accent_bg: "bg-rose-50"
    visual_language: "rings"       # 嵌套圆环
```

---

# 第八部分：数据模型与存储

## 8.1 核心数据模型

```sql
-- ═══════════════════════════════════════════════════════════════════════════
-- VIBELIFE CORE DATA MODEL
-- ═══════════════════════════════════════════════════════════════════════════

-- ─────────────────────────────────────────────────────────────────────────────
-- VIBE ID 相关表
-- ─────────────────────────────────────────────────────────────────────────────

-- 用户核心表
CREATE TABLE vibe_users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    vibe_id VARCHAR(20) UNIQUE NOT NULL,  -- vibe_2xK9mN4pLq8
    
    -- 核心资料（跨站共享）
    display_name VARCHAR(100),
    avatar_url VARCHAR(500),
    birth_datetime TIMESTAMP WITH TIME ZONE,
    birth_location VARCHAR(255),
    birth_location_coords POINT,
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    language VARCHAR(10) DEFAULT 'zh-CN',
    
    -- 账号状态
    status VARCHAR(20) DEFAULT 'active',
    email_verified BOOLEAN DEFAULT false,
    phone_verified BOOLEAN DEFAULT false,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 用户认证方式
CREATE TABLE vibe_user_auth (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    
    auth_type VARCHAR(20) NOT NULL,  -- 'email', 'phone', 'wechat', 'apple', 'google'
    auth_identifier VARCHAR(255) NOT NULL,  -- email/phone/oauth_id
    auth_credential TEXT,  -- hashed password or oauth token
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(auth_type, auth_identifier)
);

-- 数据共享授权
CREATE TABLE vibe_data_consents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    
    source_skill VARCHAR(50) NOT NULL,
    target_skill VARCHAR(50) NOT NULL,
    data_type VARCHAR(50) NOT NULL,  -- 'birth_info', 'insights', 'conversations'
    consent_granted BOOLEAN DEFAULT false,
    
    granted_at TIMESTAMP WITH TIME ZONE,
    revoked_at TIMESTAMP WITH TIME ZONE,
    
    UNIQUE(user_id, source_skill, target_skill, data_type)
);

-- ─────────────────────────────────────────────────────────────────────────────
-- SKILL 数据表
-- ─────────────────────────────────────────────────────────────────────────────

-- 用户 Skill Profile（每个 Skill 一个）
CREATE TABLE skill_profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    
    -- Skill 特定数据（JSONB 灵活存储）
    profile_data JSONB NOT NULL DEFAULT '{}',
    
    -- 元数据
    first_use_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    last_use_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    total_sessions INTEGER DEFAULT 0,
    
    UNIQUE(user_id, skill_id)
);

-- 示例：bazi skill profile
-- profile_data: {
--   "chart": { "year": "庚午", "month": "戊寅", ... },
--   "day_master": "甲",
--   "pattern": "偏印格",
--   "day_master_strength": 0.65,
--   "current_dayun": { "gan": "壬", "zhi": "午", "start_age": 28 }
-- }

-- 对话记录
CREATE TABLE skill_conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    
    -- 对话元数据
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    ended_at TIMESTAMP WITH TIME ZONE,
    message_count INTEGER DEFAULT 0,
    
    -- 来源追踪
    entry_point VARCHAR(50),  -- 'landing', 'cross_sell', 'return'
    referrer VARCHAR(255),
    
    -- 状态
    status VARCHAR(20) DEFAULT 'active'
);

-- 消息记录
CREATE TABLE skill_messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID REFERENCES skill_conversations(id) ON DELETE CASCADE,
    
    role VARCHAR(20) NOT NULL,  -- 'user', 'assistant'
    content TEXT NOT NULL,
    
    -- AI 处理元数据
    intent VARCHAR(100),
    tools_used VARCHAR(100)[],
    knowledge_used VARCHAR(100)[],
    
    -- 洞察标记
    insight_generated BOOLEAN DEFAULT false,
    insight_id UUID,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 洞察记录 (Cold Memory)
CREATE TABLE skill_insights (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    conversation_id UUID REFERENCES skill_conversations(id),

    -- 洞察内容
    insight_type VARCHAR(50) NOT NULL,  -- 'discovery', 'pattern', 'timing', 'growth'
    title VARCHAR(255),
    content TEXT NOT NULL,
    evidence JSONB,

    -- 向量嵌入 (支持跨 Skill 语义检索)
    embedding vector(3072),

    -- 质量指标
    confidence FLOAT,
    user_reaction VARCHAR(20),  -- 'helpful', 'not_helpful', 'saved'

    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ─────────────────────────────────────────────────────────────────────────────
-- 用户画像 (Hot Memory)
-- 详见: user-data-context-design.md
-- ─────────────────────────────────────────────────────────────────────────────

-- 用户画像表
CREATE TABLE user_portraits (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,  -- 'global' 为保留字，用于全局画像

    -- LLM 生成的结构化画像
    -- 包含: Facts / State / Preferences / Focus 四个区域
    portrait_text TEXT NOT NULL,

    -- 元数据
    based_on_messages INT DEFAULT 0,
    last_message_id UUID,
    generated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    version INT DEFAULT 1,

    UNIQUE(user_id, skill_id)
);

-- 画像历史表 (追踪演变)
CREATE TABLE user_portrait_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    skill_id VARCHAR(50) NOT NULL,
    portrait_text TEXT NOT NULL,
    version INT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- ─────────────────────────────────────────────────────────────────────────────
-- 订阅与商业化
-- ─────────────────────────────────────────────────────────────────────────────

-- 订阅计划
CREATE TABLE subscription_plans (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    plan_type VARCHAR(20) NOT NULL,  -- 'skill_single', 'skill_bundle', 'vibelife_all'
    
    skill_ids VARCHAR(50)[],  -- 包含的 skills
    
    price_monthly INTEGER,
    price_yearly INTEGER,
    currency VARCHAR(10) DEFAULT 'CNY',
    
    features JSONB,
    
    is_active BOOLEAN DEFAULT true
);

-- 用户订阅
CREATE TABLE user_subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES vibe_users(id) ON DELETE CASCADE,
    plan_id VARCHAR(50) REFERENCES subscription_plans(id),
    
    -- 订阅状态
    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'cancelled', 'expired'
    
    -- 时间
    started_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    current_period_end TIMESTAMP WITH TIME ZONE,
    cancelled_at TIMESTAMP WITH TIME ZONE,
    
    -- 支付信息
    payment_provider VARCHAR(50),
    payment_subscription_id VARCHAR(255),
    
    -- 来源追踪
    source_skill VARCHAR(50),  -- 从哪个 skill 转化的
    source_campaign VARCHAR(100)
);

-- ─────────────────────────────────────────────────────────────────────────────
-- 知识库索引
-- ─────────────────────────────────────────────────────────────────────────────

-- 知识块
CREATE TABLE knowledge_chunks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    skill_id VARCHAR(50) NOT NULL,
    
    -- 来源
    source_file VARCHAR(255),
    source_section VARCHAR(255),
    
    -- 内容
    content TEXT NOT NULL,
    content_type VARCHAR(50),  -- 'theory', 'pattern', 'case', 'qa'
    
    -- 元数据
    metadata JSONB,
    
    -- 全文搜索
    search_vector TSVECTOR,
    
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 全文搜索索引
CREATE INDEX idx_knowledge_chunks_search ON knowledge_chunks USING GIN(search_vector);

-- QA 对
CREATE TABLE knowledge_qa_pairs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    skill_id VARCHAR(50) NOT NULL,
    chunk_id UUID REFERENCES knowledge_chunks(id),
    
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    
    -- 质量标记
    verified BOOLEAN DEFAULT false,
    usage_count INTEGER DEFAULT 0,
    helpfulness_score FLOAT
);

-- ─────────────────────────────────────────────────────────────────────────────
-- 索引优化
-- ─────────────────────────────────────────────────────────────────────────────

CREATE INDEX idx_skill_profiles_user ON skill_profiles(user_id);
CREATE INDEX idx_skill_profiles_skill ON skill_profiles(skill_id);
CREATE INDEX idx_skill_conversations_user ON skill_conversations(user_id, skill_id);
CREATE INDEX idx_skill_messages_convo ON skill_messages(conversation_id);
CREATE INDEX idx_skill_insights_user ON skill_insights(user_id, skill_id);
CREATE INDEX idx_user_subscriptions_user ON user_subscriptions(user_id);

-- 用户画像索引
CREATE INDEX idx_portraits_user_skill ON user_portraits(user_id, skill_id);
CREATE INDEX idx_portrait_history_user ON user_portrait_history(user_id, created_at DESC);

-- Insight 向量索引 (支持语义检索)
CREATE INDEX idx_skill_insights_embedding ON skill_insights
    USING ivfflat (embedding vector_cosine_ops) WITH (lists = 100);
```

---

# 第九部分：部署架构

## 9.1 基础设施架构

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║   VIBELIFE DEPLOYMENT ARCHITECTURE                                            ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   CDN LAYER (Cloudflare)                                                │ ║
║   │                                                                         │ ║
║   │   *.vibelife.app                                                        │ ║
║   │   ├── vibelife.app       (主站 - Phase 2)                               │ ║
║   │   ├── bazi.vibelife.app  (八字)                                         │ ║
║   │   ├── astra.vibelife.app (星座)                                         │ ║
║   │   ├── mbti.vibelife.app  (MBTI)                                         │ ║
║   │   ├── attach.vibelife.app(依恋)                                         │ ║
║   │   ├── career.vibelife.app(职业)                                         │ ║
║   │   └── id.vibelife.app    (Vibe ID 认证)                                 │ ║
║   │                                                                         │ ║
║   └───────────────────────────────┬─────────────────────────────────────────┘ ║
║                                   │                                           ║
║                                   ▼                                           ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   EDGE LAYER (Vercel Edge Functions)                                    │ ║
║   │                                                                         │ ║
║   │   ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐          │ ║
║   │   │   BAZI    │  │   ASTRA   │  │   MBTI    │  │  ATTACH   │  ...     │ ║
║   │   │   Site    │  │   Site    │  │   Site    │  │   Site    │          │ ║
║   │   │           │  │           │  │           │  │           │          │ ║
║   │   │  Next.js  │  │  Next.js  │  │  Next.js  │  │  Next.js  │          │ ║
║   │   │  App      │  │  App      │  │  App      │  │  App      │          │ ║
║   │   └───────────┘  └───────────┘  └───────────┘  └───────────┘          │ ║
║   │                                                                         │ ║
║   └───────────────────────────────┬─────────────────────────────────────────┘ ║
║                                   │                                           ║
║                                   ▼                                           ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   API GATEWAY (AWS API Gateway / Kong)                                  │ ║
║   │                                                                         │ ║
║   │   api.vibelife.app                                                      │ ║
║   │   ├── /v1/auth/*        → Vibe ID Service                               │ ║
║   │   ├── /v1/users/*       → User Service                                  │ ║
║   │   ├── /v1/skills/*      → Skill Service                                 │ ║
║   │   ├── /v1/chat/*        → Chat Service                                  │ ║
║   │   ├── /v1/billing/*     → Billing Service                               │ ║
║   │   └── /v1/analytics/*   → Analytics Service                             │ ║
║   │                                                                         │ ║
║   └───────────────────────────────┬─────────────────────────────────────────┘ ║
║                                   │                                           ║
║                                   ▼                                           ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   SERVICE MESH (Kubernetes)                                             │ ║
║   │                                                                         │ ║
║   │   ┌───────────────────────────────────────────────────────────────────┐ │ ║
║   │   │                    CORE SERVICES                                  │ │ ║
║   │   │                                                                   │ │ ║
║   │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐            │ │ ║
║   │   │  │Vibe ID   │ │  User    │ │  Chat    │ │ Billing  │            │ │ ║
║   │   │  │Service   │ │ Service  │ │ Service  │ │ Service  │            │ │ ║
║   │   │  │ (3 pods) │ │ (2 pods) │ │ (5 pods) │ │ (2 pods) │            │ │ ║
║   │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘            │ │ ║
║   │   │                                                                   │ │ ║
║   │   └───────────────────────────────────────────────────────────────────┘ │ ║
║   │                                                                         │ ║
║   │   ┌───────────────────────────────────────────────────────────────────┐ │ ║
║   │   │                    SKILL AGENTS                                   │ │ ║
║   │   │                                                                   │ │ ║
║   │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐            │ │ ║
║   │   │  │  BAZI    │ │  ASTRA   │ │  MBTI    │ │ ATTACH   │  ...      │ │ ║
║   │   │  │  Agent   │ │  Agent   │ │  Agent   │ │  Agent   │            │ │ ║
║   │   │  │ (3 pods) │ │ (3 pods) │ │ (2 pods) │ │ (2 pods) │            │ │ ║
║   │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘            │ │ ║
║   │   │                                                                   │ │ ║
║   │   └───────────────────────────────────────────────────────────────────┘ │ ║
║   │                                                                         │ ║
║   │   ┌───────────────────────────────────────────────────────────────────┐ │ ║
║   │   │                    INTELLIGENCE SERVICES                          │ │ ║
║   │   │                                                                   │ │ ║
║   │   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐            │ │ ║
║   │   │  │Knowledge │ │  LLM     │ │Embedding │ │ Insight  │            │ │ ║
║   │   │  │Retrieval │ │ Gateway  │ │ Service  │ │Generator │            │ │ ║
║   │   │  │ (3 pods) │ │ (5 pods) │ │ (2 pods) │ │ (2 pods) │            │ │ ║
║   │   │  └──────────┘ └──────────┘ └──────────┘ └──────────┘            │ │ ║
║   │   │                                                                   │ │ ║
║   │   └───────────────────────────────────────────────────────────────────┘ │ ║
║   │                                                                         │ ║
║   └───────────────────────────────┬─────────────────────────────────────────┘ ║
║                                   │                                           ║
║                                   ▼                                           ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │   DATA LAYER                                                            │ ║
║   │                                                                         │ ║
║   │   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │ ║
║   │   │PostgreSQL│ │ Pinecone │ │  Neo4j   │ │  Redis   │ │   S3     │   │ ║
║   │   │ (RDS)    │ │ (Managed)│ │ (AuraDB) │ │(Elasticc)│ │          │   │ ║
║   │   │          │ │          │ │          │ │          │ │          │   │ ║
║   │   │ Primary  │ │ Vectors  │ │ Knowledge│ │  Cache   │ │ Assets   │   │ ║
║   │   │ Data     │ │ Index    │ │  Graph   │ │ Sessions │ │ Media    │   │ ║
║   │   └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘   │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

---

# 第十部分：实施路线图

## 10.1 Phase 1: Skill Constellation (当前阶段)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   PHASE 1: SKILL CONSTELLATION                                              │
│   "先去中心化做流量和能力验证"                                              │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   SPRINT 1-2 (Week 1-4): 基础设施 + 首个 Skill                              │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   Week 1-2: 基础设施                                                        │
│   □ Vibe ID 核心服务                                                        │
│     ├── 用户注册/登录（邮箱、微信）                                         │
│     ├── JWT Token 管理                                                      │
│     └── 跨站 SSO 实现                                                       │
│   □ 共享组件库 @vibelife/ui v1.0                                            │
│   □ Skill 站点模板系统                                                      │
│   □ API Gateway 基础架构                                                    │
│                                                                             │
│   Week 3-4: bazi.vibelife.app 上线                                          │
│   □ 八字知识库构建                                                          │
│     ├── 理论知识结构化                                                      │
│     ├── QA 对生成                                                           │
│     └── 向量索引构建                                                        │
│   □ 八字工具函数实现                                                        │
│     ├── 排盘计算                                                            │
│     ├── 大运流年                                                            │
│     └── 十神分析                                                            │
│   □ 八字 Skill Agent 实现                                                   │
│   □ Landing + Chat 界面                                                     │
│   □ 小红书/抖音首批内容                                                     │
│                                                                             │
│   交付物：                                                                  │
│   ✓ bazi.vibelife.app 上线                                                  │
│   ✓ Vibe ID 基础功能                                                        │
│   ✓ 首批用户测试                                                            │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   SPRINT 3-4 (Week 5-8): 扩展 + 优化                                        │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   Week 5-6: astra.vibelife.app                                              │
│   □ 星座知识库构建                                                          │
│   □ 星盘计算工具                                                            │
│   □ 星座 Skill Agent                                                        │
│   □ 内容营销持续                                                            │
│                                                                             │
│   Week 7-8: mbti.vibelife.app + 系统优化                                    │
│   □ MBTI 知识库和测评                                                       │
│   □ 跨站数据共享机制                                                        │
│   □ 订阅和支付系统                                                          │
│   □ 数据分析仪表板                                                          │
│                                                                             │
│   交付物：                                                                  │
│   ✓ 3个 Skill 站点运营                                                      │
│   ✓ 完整订阅体系                                                            │
│   ✓ 跨站用户体验                                                            │
│                                                                             │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   SPRINT 5-6 (Week 9-12): 规模化                                            │
│   ─────────────────────────────────────────────────────────────────────     │
│                                                                             │
│   □ attach.vibelife.app (依恋分析)                                          │
│   □ career.vibelife.app (职业发展)                                          │
│   □ 交叉推荐引擎优化                                                        │
│   □ 内容营销规模化                                                          │
│   □ 用户增长实验                                                            │
│                                                                             │
│   交付物：                                                                  │
│   ✓ 5个 Skill 站点运营                                                      │
│   ✓ 验证的增长模型                                                          │
│   ✓ Phase 2 准备就绪                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 10.2 关键指标

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   KEY PERFORMANCE INDICATORS                                                │
│                                                                             │
│   ═══════════════════════════════════════════════════════════════════════   │
│                                                                             │
│   ACQUISITION (获客)                                                        │
│   ─────────────────────────────────────────────────────────────────────     │
│   • Landing 访问量        目标: 10K/月 (per skill)                          │
│   • Landing → Chat 转化   目标: >35%                                        │
│   • 注册转化率            目标: >15%                                        │
│   • 单 Skill CAC          目标: <¥50                                        │
│                                                                             │
│   ENGAGEMENT (参与)                                                         │
│   ─────────────────────────────────────────────────────────────────────     │
│   • 平均对话轮数          目标: >8 轮                                       │
│   • 洞察卡片点击率        目标: >40%                                        │
│   • 7日留存              目标: >30%                                         │
│   • 30日留存             目标: >15%                                         │
│                                                                             │
│   MONETIZATION (变现)                                                       │
│   ─────────────────────────────────────────────────────────────────────     │
│   • 免费→付费转化率       目标: >5%                                         │
│   • 单 Skill ARPU         目标: ¥15/月                                      │
│   • 跨 Skill 转化率       目标: >10%                                        │
│   • LTV/CAC              目标: >3                                           │
│                                                                             │
│   QUALITY (质量)                                                            │
│   ─────────────────────────────────────────────────────────────────────     │
│   • 洞察有用率            目标: >70%                                        │
│   • Agent 回答准确率      目标: >90%                                        │
│   • NPS                   目标: >40                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

# 第十一部分：总结

## 11.1 核心价值主张

```
╔═══════════════════════════════════════════════════════════════════════════════╗
║                                                                               ║
║                              VIBELIFE                                         ║
║                     THE LIVING COMPANION ECOSYSTEM                            ║
║                                                                               ║
║   ─────────────────────────────────────────────────────────────────────────   ║
║                                                                               ║
║   "每个人都值得被深度理解，每种成长都需要专业陪伴"                             ║
║                                                                               ║
║   ═══════════════════════════════════════════════════════════════════════    ║
║                                                                               ║
║   FOUR PILLARS OF VIBELIFE EXPERIENCE                                         ║
║                                                                               ║
║   ┌─────────────────────────────────────────────────────────────────────────┐ ║
║   │                                                                         │ ║
║   │     INSIGHT          INTERACT         EVOLVE          EDUCATE          │ ║
║   │      看见              陪伴             演化             觉知            │ ║
║   │                                                                         │ ║
║   │   AI 帮你看见        沉浸式 Agent     长期追踪         知识赋能         │ ║
║   │   自己从未           对话，感受       成长轨迹，       让你真正         │ ║
║   │   注意到的           被理解和         见证自己         理解自己         │ ║
║   │                      陪伴             的改变                            │ ║
║   │                                                                         │ ║
║   └─────────────────────────────────────────────────────────────────────────┘ ║
║                                                                               ║
║   ═══════════════════════════════════════════════════════════════════════    ║
║                                                                               ║
║   STRATEGIC APPROACH                                                          ║
║                                                                               ║
║   Phase 1: SKILL CONSTELLATION                                                ║
║   ─────────────────────────────────────────────────────────────────────       ║
║   • 各个 Skill 独立站点                                                       ║
║   • 精准获客，垂直触达                                                        ║
║   • 验证模型，积累能力                                                        ║
║   • "先去中心化做流量和能力验证"                                              ║
║                                                                               ║
║   Phase 2: VIBELIFE HUB                                                       ║
║   ─────────────────────────────────────────────────────────────────────       ║
║   • 统一 AI Agent 入口                                                        ║
║   • Skills 作为内化能力                                                       ║
║   • 长期陪伴，深度留存                                                        ║
║   • "再中心化做生态和长期留存"                                                ║
║                                                                               ║
║   ═══════════════════════════════════════════════════════════════════════    ║
║                                                                               ║
║   CORE DIFFERENTIATORS                                                        ║
║                                                                               ║
║   1. UNIFIED IDENTITY (Vibe ID)                                               ║
║      一个身份，所有服务，数据主权                                             ║
║                                                                               ║
║   2. CONSISTENT EXPERIENCE                                                    ║
║      所有站点遵循 VibeLife 体验标准                                           ║
║                                                                               ║
║   3. INTELLIGENT KNOWLEDGE                                                    ║
║      专业知识 → 结构化 → 混合检索 → 精准洞察                                  ║
║                                                                               ║
║   4. PROFESSIONAL TOOLS                                                       ║
║      每个领域的专业计算和分析能力                                             ║
║                                                                               ║
║   5. CROSS-SKILL SYNERGY                                                      ║
║      多维度理解用户，创造独特价值                                             ║
║                                                                               ║
╚═══════════════════════════════════════════════════════════════════════════════╝
```

---

**END OF DOCUMENT**

---

**Document Version**: 1.0  
**Created**: January 2026  
**Domain**: vibelife.app  
**Strategy**: Skill Constellation → VibeLife Hub